<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: swp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>swp.c</h1><a href="../../d2/d8/swp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: swp.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Contains the xxxSetWindowPos API and related functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 20-Oct-1990 DarrinM   Created.</span>
00010 <span class="comment">* 25-Jan-1991 IanJa     added window revalidation</span>
00011 <span class="comment">* 11-Jul-1991 DarrinM   Replaced everything with re-ported Win 3.1 code.</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d2/d8/swp_8c.html#a0">00017</a> <span class="preprocessor">#define CTM_NOCHANGE        0</span>
<a name="l00018"></a><a class="code" href="../../d2/d8/swp_8c.html#a1">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define CTM_TOPMOST         1</span>
<a name="l00019"></a><a class="code" href="../../d2/d8/swp_8c.html#a2">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define CTM_NOTOPMOST       2</span>
00020 <span class="preprocessor"></span>
00021 <span class="keywordtype">void</span>
00022 <a class="code" href="../../d2/d8/swp_8c.html#a18">FixBogusSWP</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> * px, <span class="keywordtype">int</span> * py, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy, UINT flags);
00023 <span class="keywordtype">void</span> <a class="code" href="../../d2/d8/swp_8c.html#a19">PreventInterMonitorBlts</a>(<a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr);
00024 
00025 <span class="comment">/***************************************************************************\</span>
00026 <span class="comment">* DBGCheskSMWP</span>
00027 <span class="comment">*</span>
00028 <span class="comment">* SMWP can be a HM object, a cached structure or just a pool allocation</span>
00029 <span class="comment">*</span>
00030 <span class="comment">* History:</span>
00031 <span class="comment">* 05/21/98 GerardoB     Created.</span>
00032 <span class="comment">\***************************************************************************/</span>
00033 <span class="preprocessor">#if DBG</span>
00034 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d2/d8/swp_8c.html#a3">DBGCheskSMWP</a> (<a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp)
00035 {
00036     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o2">bHandle</a>) {
00037         UserAssert(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o0">head</a>.<a class="code" href="../../d4/d5/struct__HEAD.html#o0">h</a> != NULL);
00038         UserAssert(psmwp == <a class="code" href="../../d4/d1/userk_8h.html#a101">HtoPqCat</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(psmwp)));
00039         UserAssert(psmwp != &amp;gSMWP);
00040     } <span class="keywordflow">else</span> {
00041         UserAssert((psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o0">head</a>.<a class="code" href="../../d4/d5/struct__HEAD.html#o0">h</a> == NULL) &amp;&amp; (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o0">head</a>.<a class="code" href="../../d4/d5/struct__HEAD.html#o1">cLockObj</a> == 0));
00042         <span class="keywordflow">if</span> (psmwp == &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>) {
00043             UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(PUDF_GSMWPINUSE));
00044         }
00045     }
00046 
00047     UserAssert(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> &lt;= psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a>);
00048     UserAssert(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a> != NULL);
00049 
00050 }
00051 <span class="preprocessor">#else</span>
<a name="l00052"></a><a class="code" href="../../d2/d8/swp_8c.html#a3">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define DBGCheskSMWP(psmwp)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00054 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
00055 <span class="comment">* DestroySMWP</span>
00056 <span class="comment">*</span>
00057 <span class="comment">* Destroys an SMWP object.</span>
00058 <span class="comment">*</span>
00059 <span class="comment">* History:</span>
00060 <span class="comment">* 24-Feb-1997 adams     Created.</span>
00061 <span class="comment">\***************************************************************************/</span>
00062 
00063 <span class="keywordtype">void</span>
<a name="l00064"></a><a class="code" href="../../d4/d1/userk_8h.html#a1018">00064</a> <a class="code" href="../../d4/d1/userk_8h.html#a1018">DestroySMWP</a>(<a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp)
00065 {
00066     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFree;
00067 
00068     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00069 
00070     <a class="code" href="../../d2/d8/swp_8c.html#a3">DBGCheskSMWP</a>(psmwp);
00071     <span class="comment">/*</span>
00072 <span class="comment">     * First mark the object for destruction.  This tells the locking code</span>
00073 <span class="comment">     * that we want to destroy this object when the lock count goes to 0.</span>
00074 <span class="comment">     * If this returns FALSE, we can't destroy the object yet.</span>
00075 <span class="comment">     */</span>
00076     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o2">bHandle</a>) {
00077         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(psmwp)) {
00078             <span class="keywordflow">return</span>;
00079         }
00080         fFree = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00081     } <span class="keywordflow">else</span> {
00082         <span class="comment">/*</span>
00083 <span class="comment">         * Is this the global cached structure?</span>
00084 <span class="comment">         */</span>
00085         fFree = (psmwp != &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>);
00086     }
00087 
00088     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>) {
00089 
00090         <span class="comment">/*</span>
00091 <span class="comment">         * Free any hrgnInterMonitor stuff we accumulated.</span>
00092 <span class="comment">         */</span>
00093         <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr;
00094         <span class="keywordtype">int</span> ccvr;
00095 
00096         <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
00097             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00098                 GreDeleteObject(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a>);
00099             }
00100         }
00101 
00102         <span class="keywordflow">if</span> (fFree) {
00103             UserFreePool(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>);
00104         }
00105     }
00106 
00107     <span class="comment">/*</span>
00108 <span class="comment">     * Ok to destroy...  Free the handle (which will free the object</span>
00109 <span class="comment">     * and the handle).</span>
00110 <span class="comment">     */</span>
00111     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o2">bHandle</a>) {
00112         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(psmwp);
00113     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fFree) {
00114         UserFreePool(psmwp);
00115     } <span class="keywordflow">else</span> {
00116         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a650">PUDF_GSMWPINUSE</a>));
00117         <a class="code" href="../../d4/d1/userk_8h.html#a660">CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a650">PUDF_GSMWPINUSE</a>);
00118         <span class="comment">/*</span>
00119 <span class="comment">         * If acvr grew too much, shrink it.</span>
00120 <span class="comment">         * Don't use realloc since we don't care about the left over data</span>
00121 <span class="comment">         */</span>
00122         <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a> &gt; 8) {
00123             <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr = UserAllocPool(4 * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/structtagCVR.html">CVR</a>), TAG_SWP);
00124             <span class="keywordflow">if</span> (pcvr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00125                 UserFreePool(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>);
00126                 psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a> = pcvr;
00127                 psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a> = 4;
00128             }
00129         }
00130     }
00131 }
00132 
00133 <span class="comment">/***************************************************************************\</span>
00134 <span class="comment">* MoveWindow (API)</span>
00135 <span class="comment">*</span>
00136 <span class="comment">*</span>
00137 <span class="comment">* History:</span>
00138 <span class="comment">* 25-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00139 <span class="comment">\***************************************************************************/</span>
00140 
<a name="l00141"></a><a class="code" href="../../d2/d8/swp_8c.html#a4">00141</a> <span class="preprocessor">#define MW_FLAGS_REDRAW   (SWP_NOZORDER | SWP_NOACTIVATE)</span>
<a name="l00142"></a><a class="code" href="../../d2/d8/swp_8c.html#a5">00142</a> <span class="preprocessor"></span><span class="preprocessor">#define MW_FLAGS_NOREDRAW (SWP_NOZORDER | SWP_NOACTIVATE | SWP_NOREDRAW)</span>
00143 <span class="preprocessor"></span>
<a name="l00144"></a><a class="code" href="../../d4/d1/userk_8h.html#a1621">00144</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1621">xxxMoveWindow</a>(
00145     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00146     <span class="keywordtype">int</span>  x,
00147     <span class="keywordtype">int</span>  y,
00148     <span class="keywordtype">int</span>  cx,
00149     <span class="keywordtype">int</span>  cy,
00150     BOOL fRedraw)
00151 {
00152     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00153 
00154     <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) ||
00155         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) ||
00156         (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))) {
00157 
00158         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(
00159                 pwnd,
00160                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00161                 x,
00162                 y,
00163                 cx,
00164                 <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00165                 (fRedraw ? <a class="code" href="../../d2/d8/swp_8c.html#a4">MW_FLAGS_REDRAW</a> : <a class="code" href="../../d2/d8/swp_8c.html#a5">MW_FLAGS_NOREDRAW</a>));
00166     } <span class="keywordflow">else</span> {
00167 
00168         <span class="comment">/*</span>
00169 <span class="comment">         * BACKWARD COMPATIBILITY CODE FOR WIN 3.00 AND BELOW</span>
00170 <span class="comment">         *</span>
00171 <span class="comment">         * Everyone and their brother seems to depend on this behavior for</span>
00172 <span class="comment">         * top-level windows.  Specific examples are:</span>
00173 <span class="comment">         *</span>
00174 <span class="comment">         *  AfterDark help window animation</span>
00175 <span class="comment">         *  Finale Speedy Note Editing</span>
00176 <span class="comment">         *</span>
00177 <span class="comment">         * If the window is a top-level window and fRedraw is FALSE,</span>
00178 <span class="comment">         * we must call SetWindowPos with SWP_NOREDRAW CLEAR anyway so that</span>
00179 <span class="comment">         * the frame and window background get drawn.  We then validate the</span>
00180 <span class="comment">         * entire client rectangle to avoid repainting that.</span>
00181 <span class="comment">         */</span>
00182         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult = <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd,
00183                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00184                                        x,
00185                                        y,
00186                                        cx,
00187                                        <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00188                                        <a class="code" href="../../d2/d8/swp_8c.html#a4">MW_FLAGS_REDRAW</a>);
00189 
00190         <span class="keywordflow">if</span> (!fRedraw)
00191             <a class="code" href="../../d4/d1/userk_8h.html#a1670">xxxValidateRect</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00192 
00193         <span class="keywordflow">return</span> fResult;
00194     }
00195 }
00196 
00197 <span class="comment">/***************************************************************************\</span>
00198 <span class="comment">* AllocateCvr</span>
00199 <span class="comment">*</span>
00200 <span class="comment">* History:</span>
00201 <span class="comment">* 05/20/98  GerardoB    Extracted from old _BeginDeferWindowPos</span>
00202 <span class="comment">\***************************************************************************/</span>
<a name="l00203"></a><a class="code" href="../../d4/d1/userk_8h.html#a1617">00203</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1617">AllocateCvr</a> (<a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp, <span class="keywordtype">int</span> cwndHint)
00204 {
00205     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>  acvr;
00206 
00207     UserAssert(cwndHint != 0);
00208     acvr = (<a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/structtagCVR.html">CVR</a>) * cwndHint, TAG_SWP);
00209 
00210     <span class="keywordflow">if</span> (acvr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00211         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00212     }
00213 
00214     <span class="comment">/*</span>
00215 <span class="comment">     * Initialize psmwp related fields.</span>
00216 <span class="comment">     * CVR array is initialized by _DeferWindowPos</span>
00217 <span class="comment">     */</span>
00218 
00219     psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>      = acvr;
00220     psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a> = cwndHint;
00221     psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>      = 0;
00222     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00223 }
00224 <span class="comment">/***************************************************************************\</span>
00225 <span class="comment">* InternalBeginDeferWindowPos</span>
00226 <span class="comment">*</span>
00227 <span class="comment">* History:</span>
00228 <span class="comment">* 05/20/98  GerardoB    Created</span>
00229 <span class="comment">\***************************************************************************/</span>
00230 
<a name="l00231"></a><a class="code" href="../../d4/d1/userk_8h.html#a1616">00231</a> <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> <a class="code" href="../../d4/d1/userk_8h.html#a1616">InternalBeginDeferWindowPos</a>(<span class="keywordtype">int</span> cwndHint)
00232 {
00233     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp;
00234 
00235     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00236 
00237     <span class="comment">/*</span>
00238 <span class="comment">     * If gSMWP in being used, allocate one.</span>
00239 <span class="comment">     * Note that SMWP is zero init but CVR is not; _DeferWindowPos initializes it</span>
00240 <span class="comment">     */</span>
00241     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a650">PUDF_GSMWPINUSE</a>) || (cwndHint &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>.<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a>)) {
00242         psmwp = (<a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>)UserAllocPoolWithQuotaZInit(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/structtagSMWP.html">SMWP</a>), TAG_SWP);
00243         <span class="keywordflow">if</span> (psmwp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00244             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00245         }
00246         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1617">AllocateCvr</a>(psmwp, cwndHint)) {
00247             UserFreePool(psmwp);
00248             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00249         }
00250     } <span class="keywordflow">else</span> {
00251         <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a650">PUDF_GSMWPINUSE</a>);
00252         psmwp = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>;
00253         RtlZeroMemory(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>, FIELD_OFFSET(<a class="code" href="../../d8/d6/structtagSMWP.html">SMWP</a>, ccvrAlloc));
00254         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>.<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> == 0);
00255         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>.<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00256     }
00257 
00258     <a class="code" href="../../d2/d8/swp_8c.html#a3">DBGCheskSMWP</a>(psmwp);
00259     <span class="keywordflow">return</span> psmwp;
00260 }
00261 <span class="comment">/***************************************************************************\</span>
00262 <span class="comment">* BeginDeferWindowPos (API)</span>
00263 <span class="comment">*</span>
00264 <span class="comment">* This must be called from the client side only. Internally we should</span>
00265 <span class="comment">*  call InternalBeginDeferWindowPos to avoid going through the handle table</span>
00266 <span class="comment">*  and perhaps even use the cached strucuture.</span>
00267 <span class="comment">*</span>
00268 <span class="comment">* History:</span>
00269 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00270 <span class="comment">\***************************************************************************/</span>
00271 
<a name="l00272"></a><a class="code" href="../../d4/d1/userk_8h.html#a1618">00272</a> <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> <a class="code" href="../../d4/d1/userk_8h.html#a1618">_BeginDeferWindowPos</a>(<span class="keywordtype">int</span> cwndHint)
00273 {
00274     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp;
00275 
00276     psmwp = (<a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a240">TYPE_SETWINDOWPOS</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/structtagSMWP.html">SMWP</a>));
00277     <span class="keywordflow">if</span> (psmwp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00278         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00279     }
00280 
00281     <span class="keywordflow">if</span> (cwndHint == 0) {
00282         cwndHint = 8;
00283     }
00284 
00285     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1617">AllocateCvr</a>(psmwp, cwndHint)) {
00286         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(psmwp);
00287         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00288     }
00289 
00290     psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o2">bHandle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00291     <a class="code" href="../../d2/d8/swp_8c.html#a3">DBGCheskSMWP</a>(psmwp);
00292     <span class="keywordflow">return</span> psmwp;
00293 }
00294 
00295 <span class="comment">/***************************************************************************\</span>
00296 <span class="comment">* PWInsertAfter</span>
00297 <span class="comment">* HWInsertAfter</span>
00298 <span class="comment">* History:</span>
00299 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
00300 <span class="comment">\***************************************************************************/</span>
<a name="l00301"></a><a class="code" href="../../d2/d8/swp_8c.html#a25">00301</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d2/d8/swp_8c.html#a25">PWInsertAfter</a>(
00302    HWND hwnd)
00303 {
00304     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00305 
00306     <span class="comment">/*</span>
00307 <span class="comment">     * HWND_GROUPTOTOP and HWND_TOPMOST are the same thing.</span>
00308 <span class="comment">     */</span>
00309     <span class="keywordflow">switch</span> ((ULONG_PTR)hwnd) {
00310     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOP:
00311     <span class="keywordflow">case</span> (ULONG_PTR)HWND_BOTTOM:
00312     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOPMOST:
00313     <span class="keywordflow">case</span> (ULONG_PTR)HWND_NOTOPMOST:
00314         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)hwnd;
00315 
00316     <span class="keywordflow">default</span>:
00317 
00318         <span class="comment">/*</span>
00319 <span class="comment">         * Don't insert after a destroyed window!  It will cause the</span>
00320 <span class="comment">         * window being z-ordered to become unlinked from it's siblings.</span>
00321 <span class="comment">         */</span>
00322         <span class="keywordflow">if</span> (pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) {
00323 
00324             <span class="comment">/*</span>
00325 <span class="comment">             * Do not insert after a destroyed window.  Put it at the</span>
00326 <span class="comment">             * bottom of the list, if it is z-ordered at all.</span>
00327 <span class="comment">             */</span>
00328             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>) || pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00329                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00330 
00331             UserAssert(<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a5">_IsDescendant</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, pwnd));
00332             <span class="keywordflow">return</span> pwnd;
00333         }
00334 
00335         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00336     }
00337 }
00338 
<a name="l00339"></a><a class="code" href="../../d2/d8/swp_8c.html#a26">00339</a> HWND <a class="code" href="../../d2/d8/swp_8c.html#a26">HWInsertAfter</a>(
00340     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00341 {
00342     <span class="comment">/*</span>
00343 <span class="comment">     * HWND_GROUPTOTOP and HWND_TOPMOST are the same thing.</span>
00344 <span class="comment">     */</span>
00345     <span class="keywordflow">switch</span> ((ULONG_PTR)pwnd) {
00346     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOP:
00347     <span class="keywordflow">case</span> (ULONG_PTR)HWND_BOTTOM:
00348     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOPMOST:
00349     <span class="keywordflow">case</span> (ULONG_PTR)HWND_NOTOPMOST:
00350         <span class="keywordflow">return</span> (HWND)pwnd;
00351 
00352     <span class="keywordflow">default</span>:
00353         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
00354     }
00355 }
00356 
00357 <span class="comment">/***************************************************************************\</span>
00358 <span class="comment">* DeferWindowPos (API)</span>
00359 <span class="comment">*</span>
00360 <span class="comment">*</span>
00361 <span class="comment">* History:</span>
00362 <span class="comment">* 07-11-91 darrinm      Ported from Win 3.1 sources.</span>
00363 <span class="comment">\***************************************************************************/</span>
00364 
<a name="l00365"></a><a class="code" href="../../d4/d1/userk_8h.html#a1619">00365</a> <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> <a class="code" href="../../d4/d1/userk_8h.html#a1619">_DeferWindowPos</a>(
00366     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp,
00367     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00368     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndInsertAfter,
00369     <span class="keywordtype">int</span>   x,
00370     <span class="keywordtype">int</span>   y,
00371     <span class="keywordtype">int</span>   cx,
00372     <span class="keywordtype">int</span>   cy,
00373     UINT  flags)
00374 {
00375     PWINDOWPOS <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>;
00376     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>       pcvr;
00377 
00378     <a class="code" href="../../d2/d8/swp_8c.html#a3">DBGCheskSMWP</a>(psmwp);
00379     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> + 1 &gt; psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a>) {
00380 
00381         <span class="comment">/*</span>
00382 <span class="comment">         * Make space for 4 more windows</span>
00383 <span class="comment">         */</span>
00384         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNewAlloc = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a> + 4;
00385 
00386         pcvr = (<a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>)UserReAllocPoolWithQuota(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>,
00387                                               psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/structtagCVR.html">CVR</a>),
00388                                               <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a820">CVR</a>) * dwNewAlloc,
00389                                               TAG_SWP);
00390 
00391         <span class="keywordflow">if</span> (pcvr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00392             <a class="code" href="../../d4/d1/userk_8h.html#a1018">DestroySMWP</a>(psmwp);
00393             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00394         }
00395 
00396         psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a> = pcvr;
00397         psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o4">ccvrAlloc</a> = dwNewAlloc;
00398     }
00399 
00400     pcvr = &amp;psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>++];
00401     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> = &amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>;
00402 
00403     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd            = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00404     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>)) ?
00405                                 HWND_BOTTOM : <a class="code" href="../../d2/d8/swp_8c.html#a26">HWInsertAfter</a>(pwndInsertAfter);
00406     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;x               = x;
00407     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;y               = y;
00408     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;cx              = cx;
00409     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;cy              = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00410     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags           = flags;
00411 
00412     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00413     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00414 
00415     <span class="keywordflow">return</span> psmwp;
00416 }
00417 <span class="comment">/***************************************************************************\</span>
00418 <span class="comment">* ValidateWindowPos</span>
00419 <span class="comment">*</span>
00420 <span class="comment">* checks validity of SWP structure</span>
00421 <span class="comment">*</span>
00422 <span class="comment">* NOTE: For performance reasons, this routine is only called</span>
00423 <span class="comment">*       in the DEBUG version of USER.</span>
00424 <span class="comment">*</span>
00425 <span class="comment">* History:</span>
00426 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00427 <span class="comment">\***************************************************************************/</span>
00428 
<a name="l00429"></a><a class="code" href="../../d2/d8/swp_8c.html#a28">00429</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a28">ValidateWindowPos</a>(<a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent)
00430 {
00431     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00432     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsertAfter;
00433     HWND hwndInsertAfter;
00434 
00435     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00436         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00437 
00438     <span class="comment">/*</span>
00439 <span class="comment">     * Save the pti</span>
00440 <span class="comment">     */</span>
00441     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o10">pti</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00442 
00443 
00444     <span class="comment">/*</span>
00445 <span class="comment">     * If the SWP_NOZORDER bit is not set, validate the Insert behind window.</span>
00446 <span class="comment">     */</span>
00447     <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOZORDER)) {
00448         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fTopLevel = (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd));
00449         <span class="comment">/*</span>
00450 <span class="comment">         * Do not z-order destroyed windows</span>
00451 <span class="comment">         */</span>
00452         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>))
00453             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00454 
00455         hwndInsertAfter = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter;
00456         <span class="comment">/*</span>
00457 <span class="comment">         * If pwndParent is provided, we're about to link this window so we</span>
00458 <span class="comment">         *  need to validate LinkWindow assumptions.</span>
00459 <span class="comment">         * We have to do this since we callback after determining hwndInsertAfter.</span>
00460 <span class="comment">         */</span>
00461 
00462         <span class="keywordflow">if</span> ((hwndInsertAfter == HWND_TOPMOST) ||
00463             (hwndInsertAfter == HWND_NOTOPMOST)) {
00464 
00465             <span class="keywordflow">if</span> (!fTopLevel) {
00466                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00467             }
00468         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hwndInsertAfter == HWND_TOP) {
00469             <span class="comment">/*</span>
00470 <span class="comment">             * if pwnd is not topmost, the first child must not be topmost.</span>
00471 <span class="comment">             */</span>
00472             <span class="keywordflow">if</span> ((pwndParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; fTopLevel
00473                     &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a1613">FSwpTopmost</a>(pwnd)
00474                     &amp;&amp; (pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00475                     &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1613">FSwpTopmost</a>(pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>)) {
00476 
00477                 RIPMSG2(RIP_WARNING, <span class="stringliteral">"ValidateWindowPos: pwnd is not SWPTopMost."</span>
00478                                      <span class="stringliteral">" pwnd:%#p. hwndInsertAfter:%#p"</span>,
00479                                       pwnd, hwndInsertAfter);
00480                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00481             }
00482         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hwndInsertAfter != HWND_BOTTOM) {
00483 
00484             <span class="comment">/*</span>
00485 <span class="comment">             * Ensure pwndInsertAfter is valid</span>
00486 <span class="comment">             */</span>
00487             <span class="keywordflow">if</span> (((pwndInsertAfter = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndInsertAfter)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00488                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndInsertAfter, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
00489 
00490                 RIPERR1(ERROR_INVALID_HANDLE, RIP_WARNING, <span class="stringliteral">"Invalid hwndInsertAfter (%#p)"</span>, hwndInsertAfter);
00491 
00492                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00493             }
00494 
00495             <span class="comment">/*</span>
00496 <span class="comment">             * Ensure that pwndInsertAfter is a sibling of pwnd</span>
00497 <span class="comment">             */</span>
00498             <span class="keywordflow">if</span> (pwnd == pwndInsertAfter ||
00499                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != pwndInsertAfter-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00500                 RIPMSG2(RIP_WARNING, <span class="stringliteral">"hwndInsertAfter (%#p) is not a sibling "</span>
00501                         <span class="stringliteral">"of hwnd (%#p)"</span>, hwndInsertAfter, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
00502                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00503             }
00504             <span class="comment">/*</span>
00505 <span class="comment">             * Ensure proper topmost/nontopmost insert position</span>
00506 <span class="comment">             */</span>
00507             <span class="keywordflow">if</span> ((pwndParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; fTopLevel) {
00508                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1613">FSwpTopmost</a>(pwnd)) {
00509                     <span class="comment">/*</span>
00510 <span class="comment">                     * Check if we're trying to insert a topmost window after a non-topmost one.</span>
00511 <span class="comment">                     */</span>
00512                     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1613">FSwpTopmost</a>(pwndInsertAfter)) {
00513                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"ValidateWindowPos: pwndInsertAfter is not SWPTopMost."</span>
00514                                              <span class="stringliteral">" pwnd:%#p. pwndInsertAfter:%#p"</span>,
00515                                               pwnd, pwndInsertAfter);
00516                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00517                     }
00518                 } <span class="keywordflow">else</span> {
00519                     <span class="comment">/*</span>
00520 <span class="comment">                     * Check if we're trying to insert a non-top most window between two</span>
00521 <span class="comment">                     *  top-most ones.</span>
00522 <span class="comment">                     */</span>
00523                     <span class="keywordflow">if</span> ((pwndInsertAfter-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00524                             &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1613">FSwpTopmost</a>(pwndInsertAfter-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>)) {
00525 
00526                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"ValidateWindowPos: pwndInsertAfter-&gt;spwndNext is SWPTopMost."</span>
00527                                              <span class="stringliteral">" pwnd:%#p. pwndInsertAfter:%#p"</span>,
00528                                               pwnd, pwndInsertAfter);
00529                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00530                     }
00531                 }
00532 
00533             }
00534 
00535         } <span class="comment">/* if (hwndInsertAfter != HWND_TOP &amp;&amp; hwndInsertAfter != HWND_BOTTOM) */</span>
00536 
00537         <span class="comment">/*</span>
00538 <span class="comment">         * Check that the parent hasn't changed.</span>
00539 <span class="comment">         */</span>
00540         <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00541             <span class="keywordflow">if</span> (pwndParent != pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00542                 RIPMSG3(RIP_WARNING, <span class="stringliteral">"ValidateWindowPos: parent has changed."</span>
00543                                      <span class="stringliteral">" pwnd:%#p. Old Parent:%#p. Current Parent:%#p"</span>,
00544                                       pwnd, pwndParent, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>);
00545                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00546             }
00547         }
00548 
00549     } <span class="comment">/* if (!(pcvr-&gt;pos.flags &amp; SWP_NOZORDER)) */</span>
00550 
00551     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00552 }
00553 
00554 <span class="comment">/***************************************************************************\</span>
00555 <span class="comment">* IsStillWindowC</span>
00556 <span class="comment">*</span>
00557 <span class="comment">* Checks if window is valid HWNDC still, and child of proper dude.</span>
00558 <span class="comment">*</span>
00559 <span class="comment">* History:</span>
00560 <span class="comment">\***************************************************************************/</span>
00561 
<a name="l00562"></a><a class="code" href="../../d2/d8/swp_8c.html#a29">00562</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a29">IsStillWindowC</a>(
00563     HWND hwndc)
00564 {
00565     <span class="keywordflow">switch</span> ((ULONG_PTR)hwndc) {
00566     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOP:
00567     <span class="keywordflow">case</span> (ULONG_PTR)HWND_BOTTOM:
00568     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOPMOST:
00569     <span class="keywordflow">case</span> (ULONG_PTR)HWND_NOTOPMOST:
00570         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00571 
00572     <span class="keywordflow">default</span>:
00573         <span class="comment">/*</span>
00574 <span class="comment">         * Make sure we're going to insert after a window that's</span>
00575 <span class="comment">         *  (1) Valid</span>
00576 <span class="comment">         *  (2) Peer</span>
00577 <span class="comment">         */</span>
00578         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndc) != 0);
00579     }
00580 }
00581 
00582 <span class="comment">/***************************************************************************\</span>
00583 <span class="comment">* ValidateSmwp</span>
00584 <span class="comment">*</span>
00585 <span class="comment">* Validate the SMWP and figure out which window should get activated,</span>
00586 <span class="comment">*</span>
00587 <span class="comment">* History:</span>
00588 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00589 <span class="comment">\***************************************************************************/</span>
00590 
<a name="l00591"></a><a class="code" href="../../d2/d8/swp_8c.html#a30">00591</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a30">ValidateSmwp</a>(
00592     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp,
00593     BOOL  *pfSyncPaint)
00594 {
00595     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr;
00596     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
00597     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00598     <span class="keywordtype">int</span>  ccvr;
00599 
00600     *pfSyncPaint = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00601 
00602     pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
00603 
00604     <span class="keywordflow">if</span> (pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00605         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00606 
00607     pwndParent = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00608 
00609     <span class="comment">/*</span>
00610 <span class="comment">     * Validate the passed-in WINDOWPOS structs, and find a window to activate.</span>
00611 <span class="comment">     */</span>
00612     <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
00613 
00614         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/swp_8c.html#a28">ValidateWindowPos</a>(pcvr, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00615             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00616             <span class="keywordflow">continue</span>;
00617         }
00618 
00619         <span class="comment">/*</span>
00620 <span class="comment">         * All windows in the pos list must have the same parent.</span>
00621 <span class="comment">         * If not, yell and return FALSE.</span>
00622 <span class="comment">         */</span>
00623         UserAssert(<a class="code" href="../../d2/d8/swp_8c.html#a29">IsStillWindowC</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd));
00624 
00625         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd));
00626         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd)-&gt;spwndParent != pwndParent) {
00627             RIPERR0(ERROR_HWNDS_HAVE_DIFF_PARENT, RIP_VERBOSE, <span class="stringliteral">""</span>);
00628             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00629         }
00630 
00631         <span class="comment">/*</span>
00632 <span class="comment">         * If SWP_DEFERDRAWING is set for any of the windows, suppress</span>
00633 <span class="comment">         * DoSyncPaint() call later.</span>
00634 <span class="comment">         */</span>
00635         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_DEFERDRAWING)
00636             *pfSyncPaint = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00637     }
00638 
00639     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00640 }
00641 
00642 <span class="comment">/***************************************************************************\</span>
00643 <span class="comment">* FindValidWindowPos</span>
00644 <span class="comment">*</span>
00645 <span class="comment">* Some of the windows in the SMWP list may be NULL at ths point (removed</span>
00646 <span class="comment">* because they'll be handled by their creator's thread) so we've got to</span>
00647 <span class="comment">* look for the first non-NULL window and return it.</span>
00648 <span class="comment">*</span>
00649 <span class="comment">* History:</span>
00650 <span class="comment">* 10-Sep-1991 DarrinM    Created.</span>
00651 <span class="comment">\***************************************************************************/</span>
00652 
<a name="l00653"></a><a class="code" href="../../d2/d8/swp_8c.html#a31">00653</a> PWINDOWPOS <a class="code" href="../../d2/d8/swp_8c.html#a31">FindValidWindowPos</a>(
00654     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp)
00655 {
00656     <span class="keywordtype">int</span> i;
00657 
00658     <span class="keywordflow">for</span> (i = 0; i &lt; psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; i++) {
00659 
00660         <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00661             <span class="keywordflow">return</span> &amp;psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>;
00662     }
00663 
00664     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00665 }
00666 
00667 <span class="comment">/***************************************************************************\</span>
00668 <span class="comment">*</span>
00669 <span class="comment">*  GetLastNonBottomMostWindow()</span>
00670 <span class="comment">*</span>
00671 <span class="comment">*  Returns the last non bottom-most window in the z-order, NULL if</span>
00672 <span class="comment">*  there isn't one.  When figuring out whom to insert after, we want to</span>
00673 <span class="comment">*  skip ourself.  But when figuring out if we're already in place, we don't</span>
00674 <span class="comment">*  want to skip ourself on enum.</span>
00675 <span class="comment">*</span>
00676 <span class="comment">* History:</span>
00677 <span class="comment">\***************************************************************************/</span>
00678 
<a name="l00679"></a><a class="code" href="../../d2/d8/swp_8c.html#a32">00679</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d2/d8/swp_8c.html#a32">GetLastNonBottomMostWindow</a>(
00680     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00681     BOOL fSkipSelf)
00682 {
00683     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00684     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndLast = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00685 
00686     <span class="keywordflow">for</span> (pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00687          pwndT &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>);
00688          pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00689 
00690         <span class="keywordflow">if</span> (!fSkipSelf || (pwnd != pwndT))
00691             pwndLast = pwndT;
00692     }
00693 
00694     <span class="keywordflow">return</span> pwndLast;
00695 }
00696 
00697 <span class="comment">/***************************************************************************\</span>
00698 <span class="comment">* ValidateZorder</span>
00699 <span class="comment">*</span>
00700 <span class="comment">* Checks to see if the specified window is already in the specified Z order</span>
00701 <span class="comment">* position, by comparing the current Z position with the specified</span>
00702 <span class="comment">* pwndInsertAfter.</span>
00703 <span class="comment">*</span>
00704 <span class="comment">* History:</span>
00705 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00706 <span class="comment">\***************************************************************************/</span>
00707 
<a name="l00708"></a><a class="code" href="../../d2/d8/swp_8c.html#a33">00708</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a33">ValidateZorder</a>(
00709     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr)
00710 {
00711     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00712     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPrev;
00713     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsertAfter;
00714     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bTopmost;
00715 
00716     <span class="comment">/*</span>
00717 <span class="comment">     * Validate just to make sure this routine doesn't do anything bogus.</span>
00718 <span class="comment">     * Its caller will actually redetect and handle the error.</span>
00719 <span class="comment">     */</span>
00720     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a99">RevalidateCatHwnd</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd));
00721     pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a105">PWCat</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);      <span class="comment">// Known to be valid at this point.</span>
00722 
00723     <span class="comment">/*</span>
00724 <span class="comment">     * Don't z-order a destroyed window</span>
00725 <span class="comment">     */</span>
00726     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>))
00727         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00728 
00729     UserAssert((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pwnd)-&gt;bFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>) == 0);
00730 
00731     pwndInsertAfter = <a class="code" href="../../d2/d8/swp_8c.html#a25">PWInsertAfter</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter);
00732     <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwndInsertAfter == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00733         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00734 
00735     <span class="keywordflow">if</span> (pwndInsertAfter == <a class="code" href="../../d4/d1/userk_8h.html#a453">PWND_BOTTOM</a>) {
00736 
00737         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>))
00738             <span class="keywordflow">return</span>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00739         <span class="keywordflow">else</span>
00740             <span class="keywordflow">return</span>(pwnd == <a class="code" href="../../d2/d8/swp_8c.html#a32">GetLastNonBottomMostWindow</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
00741     }
00742 
00743     pwndPrev = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00744     <span class="keywordflow">if</span> (pwndInsertAfter == <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>)
00745         <span class="keywordflow">return</span> pwndPrev == pwnd;
00746 
00747     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndInsertAfter, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>))
00748         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00749 
00750     <span class="comment">/*</span>
00751 <span class="comment">     * When we compare the state of the window, we must use</span>
00752 <span class="comment">     * the EVENTUAL state of the window that is moving, but</span>
00753 <span class="comment">     * the CURRENT state of the window it's inserted behind.</span>
00754 <span class="comment">     *</span>
00755 <span class="comment">     * Prevent nonbottommost windows from going behind the bottommost one</span>
00756 <span class="comment">     */</span>
00757     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndInsertAfter, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>)) {
00758         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = <a class="code" href="../../d2/d8/swp_8c.html#a26">HWInsertAfter</a>(<a class="code" href="../../d2/d8/swp_8c.html#a32">GetLastNonBottomMostWindow</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00759         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00760     }
00761 
00762     <span class="comment">/*</span>
00763 <span class="comment">     * If we are not topmost, but pwndInsertAfter is, OR</span>
00764 <span class="comment">     * if we are topmost, but pwndInsertAfter is not,</span>
00765 <span class="comment">     * we need to adjust pwndInsertAfter to be the last of</span>
00766 <span class="comment">     * the topmost windows.</span>
00767 <span class="comment">     */</span>
00768     bTopmost = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
00769 
00770     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>))
00771         bTopmost ^= <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
00772 
00773     <span class="keywordflow">if</span> (bTopmost != (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndInsertAfter, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
00774 
00775         pwndInsertAfter = <a class="code" href="../../d2/d8/swp_8c.html#a35">GetLastTopMostWindow</a>();
00776 
00777         <span class="comment">/*</span>
00778 <span class="comment">         * We're correctly positioned if we're already at the bottom</span>
00779 <span class="comment">         */</span>
00780         <span class="keywordflow">if</span> (pwndInsertAfter == pwnd)
00781             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00782 
00783         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndInsertAfter);
00784     }
00785 
00786     <span class="comment">/*</span>
00787 <span class="comment">     * Look for our previous window in the list...</span>
00788 <span class="comment">     */</span>
00789     <span class="keywordflow">if</span> (pwndPrev != pwnd) {
00790 
00791         <span class="keywordflow">for</span> ( ; pwndPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndPrev = pwndPrev-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00792 
00793             <span class="keywordflow">if</span> (pwndPrev-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> == pwnd)
00794                 <span class="keywordflow">return</span> pwndInsertAfter == pwndPrev;
00795         }
00796 
00797         <span class="comment">/*</span>
00798 <span class="comment">         * If we get to here, pwnd is not in the sibling list.</span>
00799 <span class="comment">         * REALLY BAD NEWS!</span>
00800 <span class="comment">         */</span>
00801         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00802         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00803     }
00804 
00805     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00806 }
00807 
00808 <span class="comment">/***************************************************************************\</span>
00809 <span class="comment">* xxxCalcValidRects</span>
00810 <span class="comment">*</span>
00811 <span class="comment">* Based on the WINDOWPOS flags in the fs parameter in each WINDOWPOS structure,</span>
00812 <span class="comment">* this routine calcs the new position and size of each window, determines if</span>
00813 <span class="comment">* its changing Z order, or whether its showing or hiding.  Any redundant</span>
00814 <span class="comment">* flags are AND'ed out of the fs parameter.  If no redrawing is needed,</span>
00815 <span class="comment">* SWP_NOREDRAW is OR'ed into the flags.  This is called from EndDeferWindowPos.</span>
00816 <span class="comment">*</span>
00817 <span class="comment">* History:</span>
00818 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00819 <span class="comment">\***************************************************************************/</span>
00820 
<a name="l00821"></a><a class="code" href="../../d2/d8/swp_8c.html#a34">00821</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a34">xxxCalcValidRects</a>(
00822     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp,
00823     HWND  *phwndNewActive)
00824 {
00825     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>              pcvr;
00826     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>              pwnd;
00827     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>              pwndParent;
00828     HWND              hwnd;
00829     HWND              hwndNewActive = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00830     PWINDOWPOS        <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>;
00831     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>              fNoZorder;
00832     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>              fForceNCCalcSize;
00833     NCCALCSIZE_PARAMS params;
00834     <span class="keywordtype">int</span>               cxSrc;
00835     <span class="keywordtype">int</span>               cySrc;
00836     <span class="keywordtype">int</span>               cxDst;
00837     <span class="keywordtype">int</span>               cyDst;
00838     <span class="keywordtype">int</span>               cmd;
00839     <span class="keywordtype">int</span>               ccvr;
00840     <span class="keywordtype">int</span>               xClientOld;
00841     <span class="keywordtype">int</span>               yClientOld;
00842     <span class="keywordtype">int</span>               cxClientOld;
00843     <span class="keywordtype">int</span>               cyClientOld;
00844     <span class="keywordtype">int</span>               xWindowOld;
00845     <span class="keywordtype">int</span>               yWindowOld;
00846     <span class="keywordtype">int</span>               cxWindowOld;
00847     <span class="keywordtype">int</span>               cyWindowOld;
00848     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>                tlpwndParent;
00849     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>                tlpwnd;
00850 
00851     <span class="comment">/*</span>
00852 <span class="comment">     * Some of the windows in the SMWP list may be NULL at ths point</span>
00853 <span class="comment">     * (removed because they'll be handled by their creator's thread)</span>
00854 <span class="comment">     * so we've got to look for the first non-NULL window before we can</span>
00855 <span class="comment">     * execute some of the tests below.  FindValidWindowPos returns NULL if</span>
00856 <span class="comment">     * the list has no valid windows in it.</span>
00857 <span class="comment">     */</span>
00858     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> = <a class="code" href="../../d2/d8/swp_8c.html#a31">FindValidWindowPos</a>(psmwp)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00859         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00860 
00861     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd));
00862     pwndParent = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd)-&gt;spwndParent;
00863 
00864     UserAssert(<a class="code" href="../../d1/d0/inc_2user_8h.html#a429">HMRevalidateCatHandle</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndParent)));
00865 
00866     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndParent, &amp;tlpwndParent);
00867 
00868     fNoZorder = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00869 
00870     <span class="comment">/*</span>
00871 <span class="comment">     * Go through the SMWP list, enumerating each WINDOWPOS, and compute</span>
00872 <span class="comment">     * its new window and client rectangles.</span>
00873 <span class="comment">     */</span>
00874     <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
00875 
00876         <span class="comment">/*</span>
00877 <span class="comment">         * This loop may leave the critsect during each iteration so</span>
00878 <span class="comment">         * we revalidate pos.hwnd before use.</span>
00879 <span class="comment">         */</span>
00880         <span class="keywordflow">if</span> ((hwnd = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00881             <span class="keywordflow">continue</span>;
00882 
00883         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd);
00884 
00885         <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || !<a class="code" href="../../d2/d8/swp_8c.html#a29">IsStillWindowC</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter)) {
00886             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00887             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags = SWP_NOREDRAW | SWP_NOCHANGE;
00888             <span class="keywordflow">continue</span>;
00889         }
00890 
00891         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
00892 
00893         <span class="comment">/*</span>
00894 <span class="comment">         * Used for 3.0 compatibility.  3.0 sent the NCCALCSIZE message even if</span>
00895 <span class="comment">         * the size of the window wasn't changing.</span>
00896 <span class="comment">         */</span>
00897         fForceNCCalcSize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00898 
00899         <span class="keywordflow">if</span> (!hwndNewActive &amp;&amp; !(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOACTIVATE))
00900             hwndNewActive = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00901 
00902         <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOSENDCHANGING)) {
00903 
00904             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00905 
00906             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_WINDOWPOSCHANGING, 0, (LPARAM)&amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>);
00907 
00908 
00909             <span class="comment">/*</span>
00910 <span class="comment">             * Don't let them change pcvr-&gt;pos.hwnd. It doesn't make sense</span>
00911 <span class="comment">             *  plus it'll mess us up.</span>
00912 <span class="comment">             * I'm making this RIP_ERROR because we're too close to RTM (7/11/96)</span>
00913 <span class="comment">             *  just to make sure that we won't break anyone. This should be</span>
00914 <span class="comment">             *  changed to a RIP_WARNING after we ship. Use LOWORD to ignore</span>
00915 <span class="comment">             *  "changes" by NTVDM</span>
00916 <span class="comment">             */</span>
00917 <span class="preprocessor">#if DBG</span>
00918 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (LOWORD(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd) != LOWORD(hwnd)) {
00919                 RIPMSG0(RIP_ERROR,
00920                         <span class="stringliteral">"xxxCalcValidRects: Ignoring pcvr-&gt;pos.hwnd change by WM_WINDOWPOSCHANGING"</span>);
00921             }
00922 <span class="preprocessor">#endif</span>
00923 <span class="preprocessor"></span>            pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd = hwnd;
00924 
00925             <span class="comment">/*</span>
00926 <span class="comment">             * If the window sets again 'hwndInsertAfter' to HWND_NOTOPMOST</span>
00927 <span class="comment">             * or HWND_TOPMOST, we need to set this member appropriately.</span>
00928 <span class="comment">             * See CheckTopmost for details.</span>
00929 <span class="comment">             */</span>
00930             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter == HWND_NOTOPMOST) {
00931                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
00932 
00933                     pwndT = <a class="code" href="../../d2/d8/swp_8c.html#a35">GetLastTopMostWindow</a>();
00934                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
00935 
00936                     <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter == pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd) {
00937                         pwndT = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">_GetWindow</a>(pwnd, GW_HWNDPREV);
00938                         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
00939                     }
00940                 } <span class="keywordflow">else</span> {
00941                     pwndT = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">_GetWindow</a>(pwnd, GW_HWNDPREV);
00942                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
00943                 }
00944             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter == HWND_TOPMOST) {
00945                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = HWND_TOP;
00946             }
00947         }
00948         <span class="comment">/*</span>
00949 <span class="comment">         * make sure the rectangle still matches the window's region</span>
00950 <span class="comment">         *</span>
00951 <span class="comment">         * Remember the old window rectangle in parent coordinates</span>
00952 <span class="comment">         */</span>
00953         xWindowOld  = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00954         yWindowOld  = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00955         <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00956             xWindowOld -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
00957             yWindowOld -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
00958         }
00959 
00960 
00961         cxWindowOld = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00962         cyWindowOld = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00963 
00964         <span class="comment">/*</span>
00965 <span class="comment">         * Assume the client is not moving or sizing</span>
00966 <span class="comment">         */</span>
00967         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOCLIENTSIZE | SWP_NOCLIENTMOVE;
00968 
00969         <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOMOVE)) {
00970 
00971             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x == xWindowOld &amp;&amp; pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y == yWindowOld)
00972                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOMOVE;
00973 
00974 
00975 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00976 <span class="preprocessor"></span>            <span class="comment">/*</span>
00977 <span class="comment">             * Since we are comparing client coordinates to see whether</span>
00978 <span class="comment">             * to move the window or not :</span>
00979 <span class="comment">             * We've to check if the parent of the window-to-be-positioned is RTL</span>
00980 <span class="comment">             * mirrored, then let's measure the client old x-coordinate from</span>
00981 <span class="comment">             * the right visual edge. This is because the position of a window</span>
00982 <span class="comment">             * is mirrored in the parent client area if the parent is RTL mirrored.</span>
00983 <span class="comment">             */</span>
00984             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, WEFLAYOUTRTL) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd) &amp;&amp;
00985                 (pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right + 1) != pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x)
00986                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;= ~SWP_NOMOVE;
00987 <span class="preprocessor">#endif</span>
00988 <span class="preprocessor"></span>
00989             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp; <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) {
00990                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x = <a class="code" href="../../d4/d1/userk_8h.html#a608">WHERE_NOONE_CAN_SEE_ME</a>;
00991                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y = <a class="code" href="../../d4/d1/userk_8h.html#a608">WHERE_NOONE_CAN_SEE_ME</a>;
00992             }
00993 
00994         } <span class="keywordflow">else</span> {
00995             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x = xWindowOld;
00996             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y = yWindowOld;
00997         }
00998 
00999         <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOSIZE)) {
01000 
01001             <span class="comment">/*</span>
01002 <span class="comment">             * Don't allow an invalid window rectangle.</span>
01003 <span class="comment">             * BOGUS HACK: For Norton Antivirus, they call</span>
01004 <span class="comment">             * MoveWindow at WM_CREATE Time EVEN though</span>
01005 <span class="comment">             * the window is minimzed, but they assume its</span>
01006 <span class="comment">             * restored at WM_CREATE time.... B#11185, t-arthb</span>
01007 <span class="comment">             */</span>
01008             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp;
01009                 <a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a475">PROP_CHECKPOINT</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>)) {
01010 
01011                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED);
01012                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED);
01013 
01014             } <span class="keywordflow">else</span> {
01015                 <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx &lt; 0)
01016                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx = 0;
01017 
01018                 <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy &lt; 0)
01019                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy = 0;
01020             }
01021 
01022             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx == cxWindowOld &amp;&amp; pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy == cyWindowOld) {
01023                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOSIZE;
01024                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>))
01025                     fForceNCCalcSize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01026             }
01027         } <span class="keywordflow">else</span> {
01028             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx = cxWindowOld;
01029             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy = cyWindowOld;
01030         }
01031 
01032 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01033 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, WEFLAYOUTRTL) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd) &amp;&amp; (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))) {
01034             <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOMOVE)) {
01035                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x = (pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left) - (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx);
01036             } <span class="keywordflow">else</span> {
01037                 <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOSIZE)) {
01038                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x -= (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx - cxWindowOld);
01039                 }
01040             }
01041         }
01042 <span class="preprocessor">#endif</span>
01043 <span class="preprocessor"></span>
01044         <span class="comment">/*</span>
01045 <span class="comment">         * If showing and already visible, or hiding and already hidden,</span>
01046 <span class="comment">         * turn off the appropriate bit.</span>
01047 <span class="comment">         */</span>
01048         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
01049             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;= ~SWP_SHOWWINDOW;
01050         } <span class="keywordflow">else</span> {
01051             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;= ~SWP_HIDEWINDOW;
01052 
01053             <span class="comment">/*</span>
01054 <span class="comment">             * If hidden, and we're NOT showing, then we won't be drawing,</span>
01055 <span class="comment">             * no matter what else is going on.</span>
01056 <span class="comment">             */</span>
01057             <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_SHOWWINDOW))
01058                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOREDRAW;
01059         }
01060 
01061         <span class="comment">/*</span>
01062 <span class="comment">         * Muck with the zorder for bottommost windows, again</span>
01063 <span class="comment">         * See comment in DeferWindowPos</span>
01064 <span class="comment">         */</span>
01065         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>)) {
01066             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;= ~SWP_NOZORDER;
01067             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = HWND_BOTTOM;
01068         }
01069 
01070         <span class="comment">/*</span>
01071 <span class="comment">         * If we're Z-ordering, we can try to remove the Z order</span>
01072 <span class="comment">         * bit, as long as all previous windows in the WINDOWPOS list</span>
01073 <span class="comment">         * have SWP_NOZORDER set.</span>
01074 <span class="comment">         *</span>
01075 <span class="comment">         * The reason we don't do this for each window individually</span>
01076 <span class="comment">         * is that a window's eventual Z order depends on changes that</span>
01077 <span class="comment">         * may have occured on windows earlier in the WINDOWPOS list,</span>
01078 <span class="comment">         * so we can only call ValidateZorder if none of the previous</span>
01079 <span class="comment">         * windows have changed.</span>
01080 <span class="comment">         */</span>
01081         <span class="keywordflow">if</span> (fNoZorder &amp;&amp; !(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOZORDER)) {
01082 
01083             <span class="comment">/*</span>
01084 <span class="comment">             * If the TOPMOST bit is changing, the Z order is "changing",</span>
01085 <span class="comment">             * so don't clear the bit even if it's in the right place in the</span>
01086 <span class="comment">             * list.</span>
01087 <span class="comment">             */</span>
01088             fNoZorder = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01089             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>) &amp;&amp; <a class="code" href="../../d2/d8/swp_8c.html#a33">ValidateZorder</a>(pcvr)) {
01090                 fNoZorder = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01091                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOZORDER;
01092             }
01093         }
01094 
01095         <span class="comment">/*</span>
01096 <span class="comment">         * If no change is occuring, or if a parent is invisible,</span>
01097 <span class="comment">         * we won't be redrawing.</span>
01098 <span class="comment">         */</span>
01099         <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOREDRAW)) {
01100             <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_CHANGEMASK) == SWP_NOCHANGE ||
01101                     !<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a1">_FChildVisible</a>(pwnd)) {
01102                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOREDRAW;
01103             }
01104         }
01105 
01106         <span class="comment">/*</span>
01107 <span class="comment">         * BACKWARD COMPATIBILITY HACK</span>
01108 <span class="comment">         *</span>
01109 <span class="comment">         * In 3.0, if a window was moving but not sizing, we'd send the</span>
01110 <span class="comment">         * WM_NCCALCSIZE message anyhow.  Lotus Notes 2.1 depends on this</span>
01111 <span class="comment">         * in order to move its "navigation bar" when the main window moves.</span>
01112 <span class="comment">         */</span>
01113         <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOMOVE) &amp;&amp;
01114             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) &amp;&amp;
01115             (<a class="code" href="../../d6/d3/queue_8c.html#a34">GetAppCompatFlags</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp; GACF_NCCALCSIZEONMOVE)) {
01116 
01117             fForceNCCalcSize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01118         }
01119 
01120         <span class="comment">/*</span>
01121 <span class="comment">         * If the window rect is sizing, or if the frame has changed,</span>
01122 <span class="comment">         * send the WM_NCCALCSIZE message and deal with valid areas.</span>
01123 <span class="comment">         */</span>
01124         <span class="keywordflow">if</span> (((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; (SWP_NOSIZE | SWP_FRAMECHANGED)) != SWP_NOSIZE) ||
01125             fForceNCCalcSize) {
01126 
01127             WINDOWPOS pos;
01128 
01129             <span class="comment">/*</span>
01130 <span class="comment">             * check for full screen main app window</span>
01131 <span class="comment">             */</span>
01132             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
01133                 <a class="code" href="../../d4/d1/userk_8h.html#a1752">xxxCheckFullScreen</a>(pwnd, (<a class="code" href="../../d6/d6/structtagSIZERECT.html">PSIZERECT</a>)&amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x);
01134             }
01135 
01136             <span class="comment">/*</span>
01137 <span class="comment">             * Set up NCCALCSIZE message parameters (in parent coords)</span>
01138 <span class="comment">             * wParam = fClientOnly = TRUE</span>
01139 <span class="comment">             * lParam = &amp;params</span>
01140 <span class="comment">             */</span>
01141             pos = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>;     <span class="comment">// Make a local stack copy</span>
01142             params.lppos = &amp;pos;
01143 
01144             <span class="comment">/*</span>
01145 <span class="comment">             * params.rgrc[0] = rcWindowNew = New window rectangle</span>
01146 <span class="comment">             * params.rgrc[1] = rcWindowOld = Old window rectangle</span>
01147 <span class="comment">             * params.rgrc[2] = rcClientOld = Old client rectangle</span>
01148 <span class="comment">             */</span>
01149 <span class="preprocessor">            #define rcWindowNew params.rgrc[0]</span>
01150 <span class="preprocessor"></span><span class="preprocessor">            #define rcWindowOld params.rgrc[1]</span>
01151 <span class="preprocessor"></span><span class="preprocessor">            #define rcClientOld params.rgrc[2]</span>
01152 <span class="preprocessor"></span>
01153             <span class="comment">/*</span>
01154 <span class="comment">             * Set up rcWindowNew in parent relative coordinates</span>
01155 <span class="comment">             */</span>
01156             <a class="code" href="../../d2/d8/swp_8c.html#a6">rcWindowNew</a>.left   = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x;
01157             <a class="code" href="../../d2/d8/swp_8c.html#a6">rcWindowNew</a>.right  = <a class="code" href="../../d2/d8/swp_8c.html#a6">rcWindowNew</a>.left + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx;
01158             <a class="code" href="../../d2/d8/swp_8c.html#a6">rcWindowNew</a>.top    = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y;
01159             <a class="code" href="../../d2/d8/swp_8c.html#a6">rcWindowNew</a>.bottom = <a class="code" href="../../d2/d8/swp_8c.html#a6">rcWindowNew</a>.top + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy;
01160 
01161             <span class="comment">/*</span>
01162 <span class="comment">             * Set up rcWindowOld in parent relative coordinates</span>
01163 <span class="comment">             */</span>
01164             <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a12">GetRect</a>(pwnd, &amp;<a class="code" href="../../d2/d8/swp_8c.html#a7">rcWindowOld</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a903">GRECT_WINDOW</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a907">GRECT_PARENTCOORDS</a>);
01165 
01166             <span class="comment">/*</span>
01167 <span class="comment">             * Set up rcClientOld in parent relative coordinates</span>
01168 <span class="comment">             */</span>
01169             <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a12">GetRect</a>(pwnd, &amp;<a class="code" href="../../d2/d8/swp_8c.html#a8">rcClientOld</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a902">GRECT_CLIENT</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a907">GRECT_PARENTCOORDS</a>);
01170 
01171             <span class="comment">/*</span>
01172 <span class="comment">             * Keep around a copy of the old client position</span>
01173 <span class="comment">             */</span>
01174             xClientOld  = <a class="code" href="../../d2/d8/swp_8c.html#a8">rcClientOld</a>.left;
01175             cxClientOld = <a class="code" href="../../d2/d8/swp_8c.html#a8">rcClientOld</a>.right - <a class="code" href="../../d2/d8/swp_8c.html#a8">rcClientOld</a>.left;
01176             yClientOld  = <a class="code" href="../../d2/d8/swp_8c.html#a8">rcClientOld</a>.top;
01177             cyClientOld = <a class="code" href="../../d2/d8/swp_8c.html#a8">rcClientOld</a>.bottom - <a class="code" href="../../d2/d8/swp_8c.html#a8">rcClientOld</a>.top;
01178 
01179             cmd = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_NCCALCSIZE, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (LPARAM)&amp;params);
01180 
01181             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/swp_8c.html#a29">IsStillWindowC</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter)) {
01182                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01183                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01184                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01185             }
01186 
01187             <span class="comment">/*</span>
01188 <span class="comment">             * Upon return from NCCALCSIZE:</span>
01189 <span class="comment">             *</span>
01190 <span class="comment">             * params.rgrc[0] = rcClientNew = New client rect</span>
01191 <span class="comment">             * params.rgrc[1] = rcValidDst  = Destination valid rectangle</span>
01192 <span class="comment">             * params.rgrc[2] = rcValidSrc  = Source valid rectangle</span>
01193 <span class="comment">             */</span>
01194 <span class="preprocessor">            #undef rcWindowNew</span>
01195 <span class="preprocessor"></span><span class="preprocessor">            #undef rcWindowOld</span>
01196 <span class="preprocessor"></span><span class="preprocessor">            #undef rcClientOld</span>
01197 <span class="preprocessor"></span>
01198 <span class="preprocessor">            #define rcClientNew params.rgrc[0]</span>
01199 <span class="preprocessor"></span><span class="preprocessor">            #define rcValidDst  params.rgrc[1]</span>
01200 <span class="preprocessor"></span><span class="preprocessor">            #define rcValidSrc  params.rgrc[2]</span>
01201 <span class="preprocessor"></span>
01202             <span class="comment">/*</span>
01203 <span class="comment">             * Calculate the distance the window contents are</span>
01204 <span class="comment">             * moving.  If 0 or an invalid value was returned</span>
01205 <span class="comment">             * from the WM_NCCALCSIZE message, assume the</span>
01206 <span class="comment">             * entire client area is valid and top-left aligned.</span>
01207 <span class="comment">             */</span>
01208             <span class="keywordflow">if</span> (cmd &lt; WVR_MINVALID || cmd &gt; WVR_MAXVALID) {
01209 
01210                 <span class="comment">/*</span>
01211 <span class="comment">                 * We don't need to copy rcValidSrc to rcClientOld,</span>
01212 <span class="comment">                 * because it's already stored in rgrc[2].</span>
01213 <span class="comment">                 *</span>
01214 <span class="comment">                 * rcValidSrc = rcClientOld</span>
01215 <span class="comment">                 */</span>
01216                 <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a> = <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>;
01217 
01218                 cmd = WVR_ALIGNTOP | WVR_ALIGNLEFT;
01219             }
01220 
01221             <span class="comment">/*</span>
01222 <span class="comment">             * Calculate the distance we'll be shifting bits...</span>
01223 <span class="comment">             */</span>
01224 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01225 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
01226                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> = <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.right - <a class="code" href="../../d2/d8/swp_8c.html#a11">rcValidSrc</a>.right;
01227             } <span class="keywordflow">else</span>
01228 <span class="preprocessor">#endif</span>
01229 <span class="preprocessor"></span>            {
01230                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> = <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.left - <a class="code" href="../../d2/d8/swp_8c.html#a11">rcValidSrc</a>.left;
01231             }
01232             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a> = <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.top - <a class="code" href="../../d2/d8/swp_8c.html#a11">rcValidSrc</a>.top;
01233 
01234             <span class="comment">/*</span>
01235 <span class="comment">             * Calculate new client rect size and position</span>
01236 <span class="comment">             */</span>
01237             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o1">xClientNew</a> = <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>.left;
01238             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o2">yClientNew</a> = <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>.top;
01239 
01240             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o3">cxClientNew</a> = <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>.right - <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>.left;
01241             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o4">cyClientNew</a> = <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>.bottom - <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>.top;
01242 
01243             <span class="comment">/*</span>
01244 <span class="comment">             * Figure out whether the client rectangle is moving or sizing,</span>
01245 <span class="comment">             * and diddle the appropriate bit if not.</span>
01246 <span class="comment">             */</span>
01247             <span class="keywordflow">if</span> (xClientOld != <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>.left || yClientOld != <a class="code" href="../../d2/d8/swp_8c.html#a9">rcClientNew</a>.top)
01248                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;= ~SWP_NOCLIENTMOVE;
01249 
01250             <span class="keywordflow">if</span> (cxClientOld != pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o3">cxClientNew</a> || cyClientOld != pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o4">cyClientNew</a>) {
01251                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;= ~SWP_NOCLIENTSIZE;
01252             }
01253 
01254             <span class="comment">/*</span>
01255 <span class="comment">             * If the caller doesn't want us to save any bits, then don't.</span>
01256 <span class="comment">             */</span>
01257             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOCOPYBITS) {
01258 AllInvalid:
01259 
01260                 <span class="comment">/*</span>
01261 <span class="comment">                 * The entire window is invalid: Set the blt rectangle</span>
01262 <span class="comment">                 * to empty, to ensure nothing gets bltted.</span>
01263 <span class="comment">                 */</span>
01264                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>);
01265                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01266                 <span class="keywordflow">continue</span>;
01267             }
01268 
01269             <span class="comment">/*</span>
01270 <span class="comment">             * If this is a transparent window, be sure to invalidate</span>
01271 <span class="comment">             * everything, because only some of the window's bits are</span>
01272 <span class="comment">             * blittable.</span>
01273 <span class="comment">             */</span>
01274             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a617">WEFTRANSPARENT</a>))
01275                 <span class="keywordflow">goto</span> AllInvalid;
01276 
01277             <span class="comment">/*</span>
01278 <span class="comment">             * We never want to try to copy screen bits for a redirected or a</span>
01279 <span class="comment">             * layered window. For child windows we may be able to do the</span>
01280 <span class="comment">             * copy in our redirection bitmap, but that would add a bunch of</span>
01281 <span class="comment">             * work in zzzBltValidBits. We should consider that for later.</span>
01282 <span class="comment">             */</span>
01283             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1990">GetLayeredWindow</a>(pwnd) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01284                 <span class="keywordflow">goto</span> AllInvalid;
01285 
01286             <span class="comment">/*</span>
01287 <span class="comment">             * If both client and window did not change size, the frame didn't</span>
01288 <span class="comment">             * change, and the blt rectangle moved the same distance as the</span>
01289 <span class="comment">             * rectangle, then the entire window area is valid.</span>
01290 <span class="comment">             */</span>
01291             <span class="keywordflow">if</span> (((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;
01292                     (SWP_NOSIZE | SWP_NOCLIENTSIZE | SWP_FRAMECHANGED))
01293                     == (SWP_NOSIZE | SWP_NOCLIENTSIZE)) &amp;&amp;
01294                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> == (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x - xWindowOld) &amp;&amp;
01295                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a> == (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y - yWindowOld)) {
01296 
01297                 <span class="keywordflow">goto</span> AllValid;
01298             }
01299 
01300             <span class="comment">/*</span>
01301 <span class="comment">             * Now compute the valid blt rectangle.</span>
01302 <span class="comment">             *</span>
01303 <span class="comment">             * Check for horz or vert client size changes</span>
01304 <span class="comment">             *</span>
01305 <span class="comment">             * NOTE: Assumes WVR_REDRAW == WVR_HREDRAW | WVR_VREDRAW</span>
01306 <span class="comment">             */</span>
01307             <span class="keywordflow">if</span> (cxClientOld != pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o3">cxClientNew</a>) {
01308 
01309                 <span class="keywordflow">if</span> ((cmd &amp; WVR_HREDRAW) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a470">CFHREDRAW</a>))
01310                     <span class="keywordflow">goto</span> AllInvalid;
01311             }
01312 
01313             <span class="keywordflow">if</span> (cyClientOld != pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o4">cyClientNew</a>) {
01314 
01315                 <span class="keywordflow">if</span> ((cmd &amp; WVR_VREDRAW) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a469">CFVREDRAW</a>))
01316                     <span class="keywordflow">goto</span> AllInvalid;
01317             }
01318 
01319             cxSrc = <a class="code" href="../../d2/d8/swp_8c.html#a11">rcValidSrc</a>.right - <a class="code" href="../../d2/d8/swp_8c.html#a11">rcValidSrc</a>.left;
01320             cySrc = <a class="code" href="../../d2/d8/swp_8c.html#a11">rcValidSrc</a>.bottom - <a class="code" href="../../d2/d8/swp_8c.html#a11">rcValidSrc</a>.top;
01321 
01322             cxDst = <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.right - <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.left;
01323             cyDst = <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.bottom - <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.top;
01324 
01325 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01326 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((!!(cmd &amp; WVR_ALIGNRIGHT)) ^ (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)))
01327                 <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.left += ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL) &amp;&amp; (cxSrc &gt; cxDst)) ? (cxSrc-cxDst) : (cxDst - cxSrc));
01328 <span class="preprocessor">#else</span>
01329 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (cmd &amp; WVR_ALIGNRIGHT)
01330                 <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.left += (cxDst - cxSrc);
01331 <span class="preprocessor">#endif</span>
01332 <span class="preprocessor"></span>
01333             <span class="keywordflow">if</span> (cmd &amp; WVR_ALIGNBOTTOM)
01334                 <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.top += (cyDst - cySrc);
01335 
01336             <span class="comment">/*</span>
01337 <span class="comment">             * Superimpose the source on the destination, and intersect</span>
01338 <span class="comment">             * the rectangles.  This is done by looking at the</span>
01339 <span class="comment">             * extent of the rectangles, and pinning as appropriate.</span>
01340 <span class="comment">             */</span>
01341 
01342             <span class="keywordflow">if</span> (cxSrc &lt; cxDst)
01343                 <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.right = <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.left + cxSrc;
01344 
01345             <span class="keywordflow">if</span> (cySrc &lt; cyDst)
01346                 <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.bottom = <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>.top + cySrc;
01347 
01348             <span class="comment">/*</span>
01349 <span class="comment">             * Finally map the blt rectangle to screen coordinates.</span>
01350 <span class="comment">             */</span>
01351             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a> = <a class="code" href="../../d2/d8/swp_8c.html#a10">rcValidDst</a>;
01352             <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01353 
01354                 <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(
01355                         &amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>,
01356                         pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
01357                         pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
01358             }
01359         } <span class="keywordflow">else</span> {       <span class="comment">// if !SWP_NOSIZE or SWP_FRAMECHANGED</span>
01360 
01361 AllValid:
01362 
01363             <span class="comment">/*</span>
01364 <span class="comment">             * No client size change: Blt the entire window,</span>
01365 <span class="comment">             * including the frame.  Offset everything by</span>
01366 <span class="comment">             * the distance the window rect changed.</span>
01367 <span class="comment">             */</span>
01368             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOCOPYBITS) {
01369                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>);
01370             } <span class="keywordflow">else</span> {
01371                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left   = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x;
01372                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top    = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y;
01373 
01374                 <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01375                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left += pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
01376                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top += pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
01377                 }
01378 
01379                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.right  = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx;
01380                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.bottom = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy;
01381             }
01382 
01383             <span class="comment">/*</span>
01384 <span class="comment">             * Offset everything by the distance the window moved.</span>
01385 <span class="comment">             */</span>
01386 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01387 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
01388                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> = (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx) - (xWindowOld + cxWindowOld);
01389             } <span class="keywordflow">else</span>
01390 <span class="preprocessor">#endif</span>
01391 <span class="preprocessor"></span>            {
01392                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x - xWindowOld;
01393             }
01394 
01395             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a> = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y - yWindowOld;
01396 
01397             <span class="comment">/*</span>
01398 <span class="comment">             * If we're moving, we need to set up the client.</span>
01399 <span class="comment">             */</span>
01400             <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOMOVE)) {
01401                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;= ~SWP_NOCLIENTMOVE;
01402 
01403                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o1">xClientNew</a> = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>;
01404                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o2">yClientNew</a> = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>;
01405                 <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01406                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o1">xClientNew</a> -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
01407                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o2">yClientNew</a> -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
01408                 }
01409 
01410                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o3">cxClientNew</a> = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
01411                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o4">cyClientNew</a> = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
01412             }
01413         }
01414 
01415         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01416 
01417     }   <span class="comment">// for (... pcvr ...)</span>
01418 
01419     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01420     *phwndNewActive = hwndNewActive;
01421 
01422     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01423 }
01424 
01425 <span class="comment">/***************************************************************************\</span>
01426 <span class="comment">* GetLastTopMostWindow</span>
01427 <span class="comment">*</span>
01428 <span class="comment">* Returns the last topmost window in the window list.  Returns NULL if no</span>
01429 <span class="comment">* topmost windows.  Used so that we can fill in the pwndInsertAfter field</span>
01430 <span class="comment">* in various SWP calls.</span>
01431 <span class="comment">*</span>
01432 <span class="comment">* History:</span>
01433 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01434 <span class="comment">\***************************************************************************/</span>
01435 
<a name="l01436"></a><a class="code" href="../../d2/d8/swp_8c.html#a35">01436</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d2/d8/swp_8c.html#a35">GetLastTopMostWindow</a>(VOID)
01437 {
01438     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>     pwndT;
01439     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk;
01440 
01441     <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01442         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443 
01444     pwndT = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01445 
01446     <span class="keywordflow">if</span> (!pwndT || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>))
01447         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01448 
01449     <span class="keywordflow">while</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
01450 
01451         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>))
01452             <span class="keywordflow">break</span>;
01453 
01454         pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01455     }
01456 
01457     <span class="keywordflow">return</span> pwndT;
01458 }
01459 
01460 <span class="comment">/***************************************************************************\</span>
01461 <span class="comment">* SetWindowPos (API)</span>
01462 <span class="comment">*</span>
01463 <span class="comment">*</span>
01464 <span class="comment">* History:</span>
01465 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01466 <span class="comment">\***************************************************************************/</span>
01467 
<a name="l01468"></a><a class="code" href="../../d4/d1/userk_8h.html#a1615">01468</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(
01469     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01470     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndInsertAfter,
01471     <span class="keywordtype">int</span>  x,
01472     <span class="keywordtype">int</span>  y,
01473     <span class="keywordtype">int</span>  cx,
01474     <span class="keywordtype">int</span>  cy,
01475     UINT flags)
01476 {
01477     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp;
01478     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fInval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01479 
01480 <span class="preprocessor">#if DBG</span>
01481 <span class="preprocessor"></span>    <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01482 
01483     <span class="keywordflow">switch</span>((ULONG_PTR)pwndInsertAfter) {
01484     <span class="keywordflow">case</span> 0x0000FFFF:
01485     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOPMOST:
01486     <span class="keywordflow">case</span> (ULONG_PTR)HWND_NOTOPMOST:
01487     <span class="keywordflow">case</span> (ULONG_PTR)HWND_TOP:
01488     <span class="keywordflow">case</span> (ULONG_PTR)HWND_BOTTOM:
01489         <span class="keywordflow">break</span>;
01490 
01491     <span class="keywordflow">default</span>:
01492         <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndInsertAfter);
01493         <span class="keywordflow">break</span>;
01494     }
01495 <span class="preprocessor">#endif</span>
01496 <span class="preprocessor"></span>
01497     <span class="comment">/*</span>
01498 <span class="comment">     * BACKWARD COMPATIBILITY HACKS</span>
01499 <span class="comment">     *</span>
01500 <span class="comment">     * Hack 1: For Win 3.0 and below, SetWindowPos() must ignore the</span>
01501 <span class="comment">     * move and size flags if SWP_SHOWWINDOW or SWP_HIDEWINDOW</span>
01502 <span class="comment">     * is specified.  KnowledgePro is one application that depends on</span>
01503 <span class="comment">     * this behavior for the positioning of its MDI icons.</span>
01504 <span class="comment">     *</span>
01505 <span class="comment">     * Hack 2: In 3.0, if SetWindowPos() is called with SWP_SHOWWINDOW</span>
01506 <span class="comment">     * and the window is already visible, then the window was</span>
01507 <span class="comment">     * completely invalidated anyway.  So, we do that here too.</span>
01508 <span class="comment">     *</span>
01509 <span class="comment">     * NOTE: The placement of the invalidation AFTER the EndDeferWindowPos()</span>
01510 <span class="comment">     * call means that if the guy is Z-ordering and showing a 3.0 window,</span>
01511 <span class="comment">     * it may flash, because EndDefer calls DoSyncPaint, and we invalidate</span>
01512 <span class="comment">     * again after that.  Could be fixed with some major hackery in EndDefer,</span>
01513 <span class="comment">     * and it's probably not worth the trouble.</span>
01514 <span class="comment">     */</span>
01515     <span class="keywordflow">if</span> (flags &amp; (SWP_SHOWWINDOW | SWP_HIDEWINDOW)) {
01516 
01517         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>)) {
01518 
01519             flags |= SWP_NOMOVE | SWP_NOSIZE;
01520             <span class="keywordflow">if</span> ((flags &amp; SWP_SHOWWINDOW) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
01521                 fInval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01522         }
01523     }
01524 
01525     <span class="comment">/*</span>
01526 <span class="comment">     * MULTIMONITOR HACKS</span>
01527 <span class="comment">     *</span>
01528 <span class="comment">     * if a app is centering or cliping a hidden owned window</span>
01529 <span class="comment">     * to the primary monitor we should center the window to the owner</span>
01530 <span class="comment">     *</span>
01531 <span class="comment">     * this makes apps that center/position their own dialogs</span>
01532 <span class="comment">     * work when the app is on a secondary monitor.</span>
01533 <span class="comment">     */</span>
01534     <span class="keywordflow">if</span> (    !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a594">WFWIN50COMPAT</a>) &amp;&amp;
01535             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> &gt; 1 &amp;&amp;
01536             !(flags &amp; SWP_NOMOVE) &amp;&amp;
01537             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) &amp;&amp;
01538             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) &amp;&amp;
01539             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a645">WFBORDERMASK</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a646">WFCAPTION</a>)) &amp;&amp;
01540             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> &amp;&amp;
01541             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) &amp;&amp;
01542             !<a class="code" href="../../d3/d6/rect_8c.html#a4">IsRectEmpty</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>)) {
01543 
01544         <a class="code" href="../../d2/d8/swp_8c.html#a18">FixBogusSWP</a>(pwnd, &amp;x, &amp;y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, flags);
01545 
01546     }
01547 
01548     <span class="keywordflow">if</span> (!(psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1616">InternalBeginDeferWindowPos</a>(1)) ||
01549         !(psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1619">_DeferWindowPos</a>(psmwp,
01550                                   pwnd,
01551                                   pwndInsertAfter,
01552                                   x,
01553                                   y,
01554                                   cx,
01555                                   <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01556                                   flags))) {
01557 
01558         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01559     }
01560 
01561 
01562     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1620">xxxEndDeferWindowPosEx</a>(psmwp, flags &amp; SWP_ASYNCWINDOWPOS)) {
01563 
01564         <span class="keywordflow">if</span> (fInval) {
01565             <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
01566                     pwnd,
01567                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01568                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01569                     RDW_INVALIDATE | RDW_ERASE | RDW_FRAME | RDW_ALLCHILDREN);
01570         }
01571 
01572         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01573     }
01574 
01575     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01576 }
01577 
01578 <span class="comment">/***************************************************************************\</span>
01579 <span class="comment">* xxxSwpActivate</span>
01580 <span class="comment">*</span>
01581 <span class="comment">*</span>
01582 <span class="comment">* History:</span>
01583 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01584 <span class="comment">\***************************************************************************/</span>
01585 
<a name="l01586"></a><a class="code" href="../../d2/d8/swp_8c.html#a37">01586</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a37">xxxSwpActivate</a>(
01587     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNewActive)
01588 {
01589     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01590 
01591     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNewActive);
01592 
01593     <span class="keywordflow">if</span> (pwndNewActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01594         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01595 
01596     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01597 
01598     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndNewActive)) {
01599 
01600         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndNewActive, WM_CHILDACTIVATE, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01601 
01602     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != pwndNewActive) {
01603 
01604         <span class="comment">/*</span>
01605 <span class="comment">         * Remember if this window wants to be active. We are either setting</span>
01606 <span class="comment">         * our own window active (most likely), or setting a window of</span>
01607 <span class="comment">         * another thread active on purpose. If so that means this thread is</span>
01608 <span class="comment">         * controlling this window and will probably want to set itself</span>
01609 <span class="comment">         * active and foreground really soon (for example, a setup</span>
01610 <span class="comment">         * program doing dde to progman). Allow this thread and the target</span>
01611 <span class="comment">         * thread to do forground activates.</span>
01612 <span class="comment">         *</span>
01613 <span class="comment">         * Let's stop doing this for NT5 in an effort to close the number</span>
01614 <span class="comment">         *  of ways applications can force a foreground change. This is not</span>
01615 <span class="comment">         *  quite needed anyway, because:</span>
01616 <span class="comment">         * -If the current thread is already in the foreground, then it doesn't need</span>
01617 <span class="comment">         *  the TIF_ALLOWFOREGROUNDACTIVATE to make a foreground change.</span>
01618 <span class="comment">         * -Since FRemoveForegroundActive removes this bit, the current thread</span>
01619 <span class="comment">         *  will lose it anyway during the xxxActivateWindow call.</span>
01620 <span class="comment">         * -But xxxActivateWindow will set it back anyway because we're activating</span>
01621 <span class="comment">         *   a window from a different queue.</span>
01622 <span class="comment">         * -The destination window/thread will take the foreground</span>
01623 <span class="comment">         *  as a result of the xxxActivateWindow call, hence it doesn't</span>
01624 <span class="comment">         *  need the bit on (if you're in the foreground, you don't need it).</span>
01625 <span class="comment">         */</span>
01626 <span class="preprocessor">         #ifdef DONTDOTHISANYMORE</span>
01627 <span class="preprocessor"></span>         <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) &amp;&amp; (pti != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewActive))) {
01628             <span class="comment">/*</span>
01629 <span class="comment">             * Allow foreground activate on the source and dest.</span>
01630 <span class="comment">             */</span>
01631             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
01632             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxSwpActivate set TIF %#p"</span>, pti);
01633             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewActive)-&gt;TIF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
01634             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxSwpActivate set TIF %#p"</span>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewActive));
01635          }
01636 <span class="preprocessor">         #endif</span>
01637 <span class="preprocessor"></span>
01638         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1230">xxxActivateWindow</a>(pwndNewActive, <a class="code" href="../../d4/d1/userk_8h.html#a250">AW_USE</a>))
01639             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01640 
01641         <span class="comment">/*</span>
01642 <span class="comment">         * HACK ALERT: We set these bits to prevent</span>
01643 <span class="comment">         * the frames from redrawing themselves in</span>
01644 <span class="comment">         * the later call to DoSyncPaint().</span>
01645 <span class="comment">         *</span>
01646 <span class="comment">         * Prevent these captions from being repainted during</span>
01647 <span class="comment">         * the DoSyncPaint().  (bobgu 6/10/87)</span>
01648 <span class="comment">         */</span>
01649         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01650             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a559">WFNONCPAINT</a>);
01651 
01652         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01653             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a559">WFNONCPAINT</a>);
01654 
01655         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// Indicate that we diddled these bits</span>
01656     }
01657 
01658     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01659 }
01660 <span class="comment">/***************************************************************************\</span>
01661 <span class="comment">* xxxSendChangedMsgs</span>
01662 <span class="comment">*</span>
01663 <span class="comment">* Send WM_WINDOWPOSCHANGED messages as needed</span>
01664 <span class="comment">*</span>
01665 <span class="comment">* History:</span>
01666 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01667 <span class="comment">\***************************************************************************/</span>
01668 
<a name="l01669"></a><a class="code" href="../../d2/d8/swp_8c.html#a38">01669</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d8/swp_8c.html#a38">xxxSendChangedMsgs</a>(
01670     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp)
01671 {
01672     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01673     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr;
01674     <span class="keywordtype">int</span>  ccvr;
01675     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpwnd;
01676 
01677     <span class="comment">/*</span>
01678 <span class="comment">     * Send all the messages that need to be sent...</span>
01679 <span class="comment">     */</span>
01680     <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
01681 
01682         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01683             <span class="keywordflow">continue</span>;
01684 
01685         <span class="comment">/*</span>
01686 <span class="comment">         * If the window's state didn't change, don't send the message.</span>
01687 <span class="comment">         */</span>
01688         <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_CHANGEMASK) == SWP_NOCHANGE)
01689             <span class="keywordflow">continue</span>;
01690 
01691         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01692             RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxSendChangedMsgs: window went away in middle"</span>);
01693             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags = SWP_NOREDRAW | SWP_NOCHANGE;
01694             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01695             <span class="keywordflow">continue</span>;
01696         }
01697 
01698         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/swp_8c.html#a29">IsStillWindowC</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter)) {
01699             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01700             <span class="keywordflow">continue</span>;
01701         }
01702 
01703         <span class="comment">/*</span>
01704 <span class="comment">         * Send the WM_WINDOWPOSCHANGED message...</span>
01705 <span class="comment">         *</span>
01706 <span class="comment">         * Make a frame copy of the WINDOWPOS, because the pcvr</span>
01707 <span class="comment">         * info may get reused if SetWindowPos()</span>
01708 <span class="comment">         * is called by the message handler: see the comments in</span>
01709 <span class="comment">         * AllocSmwp().</span>
01710 <span class="comment">         *</span>
01711 <span class="comment">         * WM_SIZE, WM_MOVE and WM_SHOW messages are sent by the</span>
01712 <span class="comment">         * DefWindowProc() WM_WINDOWPOSCHANGED message processing.</span>
01713 <span class="comment">         *</span>
01714 <span class="comment">         * Note: It's okay to destroy the window while processing this</span>
01715 <span class="comment">         * message, since this is the last call made by the window manager</span>
01716 <span class="comment">         * with the window handle before returning from SetWindowPos().</span>
01717 <span class="comment">         * This also means we don't have to revalidate the pwnd.</span>
01718 <span class="comment">         */</span>
01719         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
01720         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_WINDOWPOSCHANGED, 0, (LPARAM)&amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>);
01721 
01722         <span class="comment">/*</span>
01723 <span class="comment">         * Only send a shape change when moving/sizing/minimizing/restoring/</span>
01724 <span class="comment">         * maximizing (or framechange for NetMeeting to detect SetWindowRgn)</span>
01725 <span class="comment">         */</span>
01726         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>() &amp;&amp;
01727             (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOCLIENTMOVE) ||
01728              !(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOCLIENTSIZE) ||
01729               (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_STATECHANGE) ||
01730               (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_FRAMECHANGED))) {
01731             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_LOCATIONCHANGE, pwnd, OBJID_WINDOW, INDEXID_CONTAINER, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
01732         }
01733         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01734     }   <span class="comment">// for (... pcvr ...)</span>
01735 
01736 
01737 }
01738 
01739 <span class="comment">/***************************************************************************\</span>
01740 <span class="comment">* AsyncWindowPos</span>
01741 <span class="comment">*</span>
01742 <span class="comment">* This functions pulls from the passed-in SMWP all windows not owned by the</span>
01743 <span class="comment">* current thread and passes them off to their owners to be handled.  This</span>
01744 <span class="comment">* eliminates synchronization where thread B won't get a chance to paint</span>
01745 <span class="comment">* until thread A has completed painting (or at least returned from handling</span>
01746 <span class="comment">* painting-related messages).  Such synchronizations are bad because they</span>
01747 <span class="comment">* can cause threads of unrelated process to hang each other.</span>
01748 <span class="comment">*</span>
01749 <span class="comment">* History:</span>
01750 <span class="comment">* 09-10-91 darrinm      Created.</span>
01751 <span class="comment">\***************************************************************************/</span>
01752 
<a name="l01753"></a><a class="code" href="../../d2/d8/swp_8c.html#a39">01753</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d8/swp_8c.html#a39">AsyncWindowPos</a>(
01754     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp)
01755 {
01756     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fFinished;
01757     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>        pcvrFirst;
01758     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>        pcvr;
01759     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>        pcvrT;
01760     <span class="keywordtype">int</span>         ccvrRemaining;
01761     <span class="keywordtype">int</span>         ccvr;
01762     <span class="keywordtype">int</span>         chwnd;
01763     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
01764     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01765     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>       psmwpNew;
01766 
01767     pcvrFirst = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>;
01768     ccvrRemaining = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>;
01769 
01770     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01771 
01772     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01773 
01774         fFinished = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01775 
01776         <span class="comment">/*</span>
01777 <span class="comment">         * Loop through all windows in the SMWP list searching for windows</span>
01778 <span class="comment">         * owned by other threads.  Return if none are found.</span>
01779 <span class="comment">         */</span>
01780         <span class="keywordflow">for</span> (; ccvrRemaining != 0; pcvrFirst++, ccvrRemaining--) {
01781 
01782             <span class="keywordflow">if</span> (pcvrFirst-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01783                 <span class="keywordflow">continue</span>;
01784 
01785             ptiT = pcvrFirst-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o10">pti</a>;
01786             <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01787                 fFinished = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01788                 <span class="keywordflow">break</span>;
01789             }
01790         }
01791 
01792         <span class="keywordflow">if</span> (fFinished) {
01793             <span class="keywordflow">return</span>;
01794         }
01795 
01796         <span class="comment">/*</span>
01797 <span class="comment">         * We've found a window of another thread.  Count how many other</span>
01798 <span class="comment">         * windows in the list are owned by the same thread so we can</span>
01799 <span class="comment">         * allocate a CVR array for them.</span>
01800 <span class="comment">         */</span>
01801         chwnd = 0;
01802 
01803         <span class="keywordflow">for</span> (pcvr = pcvrFirst, ccvr = ccvrRemaining; --ccvr &gt;= 0; pcvr++) {
01804 
01805             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01806                 <span class="keywordflow">continue</span>;
01807 
01808             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o10">pti</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)
01809                 chwnd++;
01810         }
01811 
01812         <span class="comment">/*</span>
01813 <span class="comment">         * Allocate temp SMWP/CVR structure to be passed to the other thread.</span>
01814 <span class="comment">         */</span>
01815         psmwpNew = (<a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/structtagSMWP.html">SMWP</a>) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/structtagCVR.html">CVR</a>) * chwnd),
01816                                         TAG_SWP);
01817 
01818         <span class="comment">/*</span>
01819 <span class="comment">         * Even if we can't allocate memory to pass the SMWP to another</span>
01820 <span class="comment">         * thread we still need to remove its windows from the current list.</span>
01821 <span class="comment">         */</span>
01822         <span class="keywordflow">if</span> (psmwpNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01823 
01824             <span class="keywordflow">for</span> (pcvr = pcvrFirst; chwnd != 0; pcvr++) {
01825 
01826                 <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o10">pti</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01827                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01828                     chwnd--;
01829                 }
01830             }
01831 
01832             <span class="keywordflow">continue</span>;
01833         }
01834 
01835         psmwpNew-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> = chwnd;
01836         psmwpNew-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a> = (<a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)psmwpNew + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a822">SMWP</a>));
01837 
01838         <span class="keywordflow">for</span> (pcvr = pcvrFirst, pcvrT = psmwpNew-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>; chwnd != 0; pcvr++) {
01839 
01840             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01841                 <span class="keywordflow">continue</span>;
01842 
01843             <span class="comment">/*</span>
01844 <span class="comment">             * Copy the appropriate CVR structs into our temp array.</span>
01845 <span class="comment">             */</span>
01846             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o10">pti</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01847 
01848                 *pcvrT++ = *pcvr;
01849                 chwnd--;
01850 
01851                 <span class="comment">/*</span>
01852 <span class="comment">                 * Remove this window from the list of windows to be handled</span>
01853 <span class="comment">                 * by the current thread.</span>
01854 <span class="comment">                 */</span>
01855                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01856             }
01857         }
01858 
01859         <span class="comment">/*</span>
01860 <span class="comment">         * This lets the other thread know it needs to do some windowposing.</span>
01861 <span class="comment">         * The other thread is responsible for freeing the temp SMWP/CVR array.</span>
01862 <span class="comment">         */</span>
01863         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(ptiT, ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, <a class="code" href="../../d4/d1/userk_8h.html#a336">QEVENT_SETWINDOWPOS</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
01864                 (WPARAM)psmwpNew, (LPARAM)ptiT)) {
01865             <span class="comment">// IANJA RIP only to catch what was previously a bug: psmwpNew not freed</span>
01866             RIPMSG1(RIP_WARNING, <span class="stringliteral">"PostEventMessage swp to pti %#p failed"</span>, ptiT);
01867             UserFreePool(psmwpNew);
01868         }
01869     }
01870 
01871 }
01872 
01873 <span class="comment">/***************************************************************************\</span>
01874 <span class="comment">* xxxProcessSetWindowPosEvent</span>
01875 <span class="comment">*</span>
01876 <span class="comment">* This function is called from xxxProcessEvent (QUEUE.C) to respond to</span>
01877 <span class="comment">* posted QEVENT_SETWINDOWPOS events which originate at the AsyncWindowPos</span>
01878 <span class="comment">* function above.</span>
01879 <span class="comment">*</span>
01880 <span class="comment">* History:</span>
01881 <span class="comment">* 10-Sep-1991 DarrinM   Created.</span>
01882 <span class="comment">\***************************************************************************/</span>
01883 
<a name="l01884"></a><a class="code" href="../../d4/d1/userk_8h.html#a1215">01884</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1215">xxxProcessSetWindowPosEvent</a>(
01885     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwpT)
01886 {
01887     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp;
01888 
01889     <span class="comment">/*</span>
01890 <span class="comment">     * Create a bonafide SMWP/CVR array that xxxEndDeferWindowPos can use</span>
01891 <span class="comment">     * and later free.</span>
01892 <span class="comment">     */</span>
01893     <span class="keywordflow">if</span> ((psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1616">InternalBeginDeferWindowPos</a>(psmwpT-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01894         UserFreePool(psmwpT);
01895         <span class="keywordflow">return</span>;
01896     }
01897 
01898     <span class="comment">/*</span>
01899 <span class="comment">     * Copy the contents of the temp SMWP/CVR array into the real one.</span>
01900 <span class="comment">     */</span>
01901     RtlCopyMemory(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, psmwpT-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/structtagCVR.html">CVR</a>) * psmwpT-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>);
01902     psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> = psmwpT-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>;
01903 
01904     <span class="comment">/*</span>
01905 <span class="comment">     * Complete the MultWindowPos operation now that we're on the correct</span>
01906 <span class="comment">     * context.</span>
01907 <span class="comment">     */</span>
01908     <a class="code" href="../../d4/d1/userk_8h.html#a1620">xxxEndDeferWindowPosEx</a>(psmwp, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01909 
01910     <span class="comment">/*</span>
01911 <span class="comment">     * Free the temp SMWP/CVR array.</span>
01912 <span class="comment">     */</span>
01913     UserFreePool(psmwpT);
01914 }
01915 
<a name="l01916"></a><a class="code" href="../../d2/d8/swp_8c.html#a12">01916</a> <span class="preprocessor">#define SWP_BOZO ( SWP_NOSIZE | SWP_NOMOVE | SWP_NOZORDER | SWP_NOREDRAW | SWP_NOACTIVATE )</span>
01917 <span class="preprocessor"></span>
01918 <span class="comment">/***************************************************************************\</span>
01919 <span class="comment">* DBGValidateSibblingZOrder</span>
01920 <span class="comment">*</span>
01921 <span class="comment">* History:</span>
01922 <span class="comment">* 04/01/98 GerardoB Created</span>
01923 <span class="comment">\***************************************************************************/</span>
01924 <span class="preprocessor">#if DBG</span>
01925 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d2/d8/swp_8c.html#a13">DBGValidateSibblingZOrder</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent)
01926 {
01927     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01928     <span class="comment">/*</span>
01929 <span class="comment">     * Check that the sibbling list looks OK right now</span>
01930 <span class="comment">     * We don't really care about the z-order of message windows.</span>
01931 <span class="comment">     */</span>
01932     <span class="keywordflow">if</span> ((pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a323">PWNDMESSAGE</a>(pwndParent))) {
01933         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFoundNonTopMost = !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
01934         <span class="keywordflow">while</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01935             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
01936                 UserAssert(!fFoundNonTopMost);
01937             } <span class="keywordflow">else</span> {
01938                 fFoundNonTopMost = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01939             }
01940             pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01941         }
01942     }
01943 }
01944 <span class="preprocessor">#else</span>
<a name="l01945"></a><a class="code" href="../../d2/d8/swp_8c.html#a13">01945</a> <span class="preprocessor"></span><span class="preprocessor">#define DBGValidateSibblingZOrder(pwndParent)</span>
01946 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01947 <span class="preprocessor"></span>
01948 <span class="comment">/***************************************************************************\</span>
01949 <span class="comment">* zzzChangeStates</span>
01950 <span class="comment">*</span>
01951 <span class="comment">* History:</span>
01952 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01953 <span class="comment">\***************************************************************************/</span>
01954 
<a name="l01955"></a><a class="code" href="../../d2/d8/swp_8c.html#a41">01955</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d8/swp_8c.html#a41">zzzChangeStates</a>(
01956     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>     pwndParent,
01957     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>    psmwp)
01958 {
01959     <span class="keywordtype">int</span>  ccvr;
01960     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr;
01961     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01962     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01963     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
01964     <span class="keywordtype">int</span> czorder = 0;
01965 
01966     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
01967     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndParent, &amp;tlpwndParent);
01968 
01969     <span class="comment">/*</span>
01970 <span class="comment">     * Check that the sibbling list looks OK right now</span>
01971 <span class="comment">     *</span>
01972 <span class="comment">     * Here's the reason why this DBG code is commented out:</span>
01973 <span class="comment">     * Owned windows are always expected to be on top of the owner.</span>
01974 <span class="comment">     * However, an app can call SetWindowPos and insert the ownee after</span>
01975 <span class="comment">     * the owner. IME somehow does this too.</span>
01976 <span class="comment">     * This causes us to have A to be inserted after B and later in the</span>
01977 <span class="comment">     *  windowpos array, B to be inserted somewhere else. Hence, A won't be in the</span>
01978 <span class="comment">     *  expected position, because B will be moved after A is inserted.</span>
01979 <span class="comment">     * In other words, a window in hwndInsertAfter must not appear later</span>
01980 <span class="comment">     * as a hwnd to be z-ordered. Ownees below owners cause this situation.</span>
01981 <span class="comment">     */</span>
01982   <span class="comment">//  DBGValidateSibblingZOrder(pwndParent);</span>
01983 
01984 
01985     <span class="comment">/*</span>
01986 <span class="comment">     * Now change the window states</span>
01987 <span class="comment">     */</span>
01988     <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
01989 
01990         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01991             <span class="keywordflow">continue</span>;
01992 
01993         UserAssert(0 == (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOTIFYALL));
01994 
01995         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
01996 
01997         <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || !<a class="code" href="../../d2/d8/swp_8c.html#a29">IsStillWindowC</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter)) {
01998             RIPMSG0(RIP_WARNING, <span class="stringliteral">"zzzChangeStates: Window went away in middle"</span>);
01999             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags = SWP_NOREDRAW | SWP_NOCHANGE;
02000             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02001         }
02002 
02003 <span class="preprocessor">#if DBG</span>
02004 <span class="preprocessor"></span>        <span class="comment">/*</span>
02005 <span class="comment">         * This can happen when we get re-entered during a callback or mulitple</span>
02006 <span class="comment">         *  threads are z-ordering the same window. The tray does stuff like this.</span>
02007 <span class="comment">         * We would need to keep the toggle state in the windowpos structure to</span>
02008 <span class="comment">         *  have each call have its own state.</span>
02009 <span class="comment">         */</span>
02010         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>) &amp;&amp; (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOZORDER))
02011             RIPMSG0(RIP_WARNING, <span class="stringliteral">"zzzChangeState: WFTOGGLETOPMOST should not be set"</span>);
02012 
02013 <span class="comment">//        UserAssert(!(TestWF(pwnd, WFTOGGLETOPMOST) &amp;&amp; (pcvr-&gt;pos.flags &amp; SWP_NOZORDER)));</span>
02014 <span class="preprocessor">#endif</span>
02015 <span class="preprocessor"></span>
02016         <span class="comment">/*</span>
02017 <span class="comment">         * Check to se if there is any state to change.  If not, just</span>
02018 <span class="comment">         * continue.</span>
02019 <span class="comment">         */</span>
02020         <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_CHANGEMASK) == SWP_NOCHANGE) {
02021 
02022             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOREDRAW;
02023             <span class="keywordflow">continue</span>;
02024         }
02025 
02026         <span class="comment">/*</span>
02027 <span class="comment">         * Change the window region if needed</span>
02028 <span class="comment">         *</span>
02029 <span class="comment">         * Before we do anything, check to see if we're only Z-ordering.</span>
02030 <span class="comment">         * If so, then check to see if we're already in the right place,</span>
02031 <span class="comment">         * and if so, clear the ZORDER flag.</span>
02032 <span class="comment">         *</span>
02033 <span class="comment">         * We have to make this test in the state-change loop if previous</span>
02034 <span class="comment">         * windows in the WINDOWPOS list were Z-ordered, since the test depends</span>
02035 <span class="comment">         * on any ordering that may have happened previously.</span>
02036 <span class="comment">         *</span>
02037 <span class="comment">         * We don't bother to do this redundancy check if there are</span>
02038 <span class="comment">         * other bits set, because the amount of time saved in that</span>
02039 <span class="comment">         * case is about as much as the amount of time it takes to</span>
02040 <span class="comment">         * test for redundancy.</span>
02041 <span class="comment">         */</span>
02042         <span class="keywordflow">if</span> (((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_CHANGEMASK) ==
02043              (SWP_NOCHANGE &amp; ~SWP_NOZORDER))) {
02044 
02045             <span class="comment">/*</span>
02046 <span class="comment">             * If the window's Z order won't be changing, then</span>
02047 <span class="comment">             * we can clear the ZORDER bit and set NOREDRAW.</span>
02048 <span class="comment">             */</span>
02049             <span class="keywordflow">if</span> ((!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>)) &amp;&amp; <a class="code" href="../../d2/d8/swp_8c.html#a33">ValidateZorder</a>(pcvr)) {
02050 
02051                 <span class="comment">/*</span>
02052 <span class="comment">                 * The window's already in the right place:</span>
02053 <span class="comment">                 * Set SWP_NOZORDER bit, set SWP_NOREDRAW,</span>
02054 <span class="comment">                 * and destroy the visrgn that we created earlier.</span>
02055 <span class="comment">                 */</span>
02056                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOZORDER | SWP_NOREDRAW;
02057 
02058                 <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>) {
02059                     GreDeleteObject(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>);
02060                     pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02061                 }
02062                 <span class="keywordflow">continue</span>;
02063             }
02064         }
02065 
02066         <span class="comment">/*</span>
02067 <span class="comment">         * Change the window state, as appropriate...</span>
02068 <span class="comment">         */</span>
02069         <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;
02070             (SWP_NOMOVE | SWP_NOSIZE | SWP_NOCLIENTSIZE | SWP_NOCLIENTMOVE)) !=
02071             (SWP_NOMOVE | SWP_NOSIZE | SWP_NOCLIENTSIZE | SWP_NOCLIENTMOVE)) {
02072 
02073             <a class="code" href="../../d6/d9/structtagCARET.html">PCARET</a> pcaret = &amp;<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;caret;
02074             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRecreateRedirectionBitmap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02075 
02076             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd)) {
02077                 <span class="keywordtype">int</span> cx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
02078                 <span class="keywordtype">int</span> <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
02079 
02080                 <span class="keywordflow">if</span> (cx != pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx || <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> != pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy) {
02081                     fRecreateRedirectionBitmap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02082                 }
02083             }
02084 
02085             <span class="comment">/*</span>
02086 <span class="comment">             * Set up the new window and client rectangles.</span>
02087 <span class="comment">             */</span>
02088             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left   = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x;
02089             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top    = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y;
02090             <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
02091                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left += pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
02092                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top += pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
02093             }
02094 
02095             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right  = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cx;
02096             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.cy;
02097 
02098             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right &lt; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left) {
02099                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"SWP: cx changed for pwnd %#p"</span>, pwnd);
02100                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
02101             }
02102 
02103             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom &lt; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top) {
02104                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"SWP: cy changed for pwnd %#p"</span>, pwnd);
02105                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
02106             }
02107 
02108             <span class="comment">/*</span>
02109 <span class="comment">             * If the client moved relative to its parent,</span>
02110 <span class="comment">             * offset the caret by the amount that rcBlt moved</span>
02111 <span class="comment">             * relative to the client rect.</span>
02112 <span class="comment">             */</span>
02113             <span class="keywordflow">if</span> (pwnd == pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a>) {
02114 
02115                 <span class="comment">/*</span>
02116 <span class="comment">                 * Calculate the distance the contents of the client area</span>
02117 <span class="comment">                 * is moving, in client-relative coordinates.</span>
02118 <span class="comment">                 *</span>
02119 <span class="comment">                 * Calculates dBlt + (old position - new position)</span>
02120 <span class="comment">                 */</span>
02121                 <span class="keywordtype">int</span> dx = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o1">xClientNew</a>;
02122                 <span class="keywordtype">int</span> dy = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a> + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o2">yClientNew</a>;
02123 
02124                 <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))
02125                 {
02126                     dx -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
02127                     dy -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
02128                 }
02129 
02130                 <span class="keywordflow">if</span> ((dx | dy) != 0) {
02131                     pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o4">x</a> += dx;
02132                     pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o5">y</a> += dy;
02133                 }
02134             }
02135 
02136             <span class="comment">/*</span>
02137 <span class="comment">             * Set up the new client rect</span>
02138 <span class="comment">             * coordinates provided.</span>
02139 <span class="comment">             */</span>
02140             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left   = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o1">xClientNew</a>;
02141             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top    = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o2">yClientNew</a>;
02142             <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))
02143             {
02144                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left += pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
02145                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top += pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
02146             }
02147 
02148             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right  = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o3">cxClientNew</a>;
02149             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.bottom = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top + pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o4">cyClientNew</a>;
02150 
02151             <span class="comment">/*</span>
02152 <span class="comment">             * If the window becomes smaller than the monitor, the system</span>
02153 <span class="comment">             * allows it to be moved (see SetSysMenu) and so we must remove</span>
02154 <span class="comment">             * the monitor region.</span>
02155 <span class="comment">             */</span>
02156             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1109">IsSmallerThanScreen</a>(pwnd)) {
02157                 <a class="code" href="../../d4/d1/userk_8h.html#a1611">SelectWindowRgn</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02158             }
02159 
02160             <span class="comment">/*</span>
02161 <span class="comment">             * If the layered window is resizing, try to resize the</span>
02162 <span class="comment">             * redirection bitmap associated with it.</span>
02163 <span class="comment">             */</span>
02164             <span class="keywordflow">if</span> (fRecreateRedirectionBitmap) {
02165                 <a class="code" href="../../d4/d1/userk_8h.html#a1989">RecreateRedirectionBitmap</a>(pwnd);
02166             }
02167 
02168             <span class="comment">/*</span>
02169 <span class="comment">             * Offset the absolute positions of the window's update region,</span>
02170 <span class="comment">             * and the position and update regions of its children.</span>
02171 <span class="comment">             */</span>
02172             <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> | pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>) != 0) {
02173                 <span class="comment">/*</span>
02174 <span class="comment">                 * Change position of window region, if it has one</span>
02175 <span class="comment">                 * and it isn't a monitor region for a maximized window</span>
02176 <span class="comment">                 */</span>
02177                 <span class="keywordflow">if</span> (    pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a> &amp;&amp;
02178                         !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>)) {
02179                     GreOffsetRgn(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>);
02180                 }
02181 
02182                 <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
02183                     GreOffsetRgn(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>);
02184                 }
02185                 <a class="code" href="../../d4/d1/userk_8h.html#a1507">OffsetChildren</a>(pwnd, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02186 
02187                 <span class="comment">/*</span>
02188 <span class="comment">                 * Change the position of the sprite associated with</span>
02189 <span class="comment">                 * this window.</span>
02190 <span class="comment">                 */</span>
02191                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>)) {
02192                     POINT ptPos = {pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.x, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.y};
02193 
02194                     GreUpdateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02195                             &amp;ptPos, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02196                 }
02197             }
02198         }
02199 
02200         <span class="comment">/*</span>
02201 <span class="comment">         * Change the Z order if the flag is set.  Revalidate</span>
02202 <span class="comment">         * hwndInsertAfter to make sure that it is still valid</span>
02203 <span class="comment">         */</span>
02204         <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOZORDER)) {
02205 
02206             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a28">ValidateWindowPos</a>(pcvr, pwndParent)) {
02207 
02208                 <a class="code" href="../../d4/d1/userk_8h.html#a1458">UnlinkWindow</a>(pwnd, pwndParent);
02209 
02210                 <a class="code" href="../../d4/d1/userk_8h.html#a1457">LinkWindow</a>(pwnd,
02211                            <a class="code" href="../../d2/d8/swp_8c.html#a25">PWInsertAfter</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter),
02212                            pwndParent);
02213                 czorder++;
02214 
02215                 <span class="comment">/*</span>
02216 <span class="comment">                 * HACK ALERT MERGE</span>
02217 <span class="comment">                 *</span>
02218 <span class="comment">                 * ValidateZOrder() depends on rational, consistent setting of the</span>
02219 <span class="comment">                 * WEFTOPMOST bit in order for it to work properly.  What this means</span>
02220 <span class="comment">                 * is that we can't set or clear these bits ahead of time based on</span>
02221 <span class="comment">                 * where the window is moving to: instead we have to change the bit</span>
02222 <span class="comment">                 * after we've moved it.  Enter the WFTOGGLETOPMOST bit: that bit</span>
02223 <span class="comment">                 * is set in ZOrderByOwner() based on what the topmost bit will</span>
02224 <span class="comment">                 * eventually be set to.  To maintain a consistent state, we make</span>
02225 <span class="comment">                 * any changes AFTER the window has been Z-ordered.</span>
02226 <span class="comment">                 */</span>
02227                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>)) {
02228                     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pb;
02229 
02230                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>);
02231                     pb = ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)&amp;pwnd-&gt;state);
02232                     pb[<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)] ^= <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>);
02233                 }
02234             } <span class="keywordflow">else</span> {
02235                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOZORDER;
02236                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>);
02237             }
02238         }
02239 
02240 
02241         <span class="comment">/*</span>
02242 <span class="comment">         * Handle SWP_HIDEWINDOW and SWP_SHOWWINDOW, by clearing or setting</span>
02243 <span class="comment">         * the WS_VISIBLE bit.</span>
02244 <span class="comment">         */</span>
02245         UserAssert(pwndParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02246         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
02247         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_SHOWWINDOW) {
02248 
02249             <span class="comment">/*</span>
02250 <span class="comment">             * Window is showing. If this app is still in startup mode,</span>
02251 <span class="comment">             * (still starting), give the the app starting cursor 5 more</span>
02252 <span class="comment">             * seconds.</span>
02253 <span class="comment">             */</span>
02254             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi-&gt;W32PF_Flags &amp; W32PF_APPSTARTING)
02255                 <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>((PW32PROCESS)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi, 5000);
02256 
02257             <span class="comment">/*</span>
02258 <span class="comment">             * Set the WS_VISIBLE bit.</span>
02259 <span class="comment">             */</span>
02260             <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a751">SV_SET</a>);
02261 
02262             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>())
02263                 <a class="code" href="../../d4/d1/userk_8h.html#a619">zzzWindowEvent</a>(EVENT_OBJECT_SHOW, pwnd, OBJID_WINDOW, INDEXID_CONTAINER, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
02264 
02265             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) {
02266                 psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o1">bShellNotify</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02267                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a557">WFFRAMEON</a>) ? SWP_NOTIFYACTIVATE|SWP_NOTIFYCREATE: SWP_NOTIFYCREATE;
02268 
02269                 <span class="comment">/*</span>
02270 <span class="comment">                 * This Chicago code is replaced by the preceding code,</span>
02271 <span class="comment">                 * which exits the critical section only after the Gre</span>
02272 <span class="comment">                 * lock is removed.  Fritz</span>
02273 <span class="comment">                 *</span>
02274 <span class="comment">                 * xxxCallHook(HSHELL_WINDOWCREATED,</span>
02275 <span class="comment">                 *             (WPARAM)HWq(pwnd),</span>
02276 <span class="comment">                 *             (LPARAM)0,</span>
02277 <span class="comment">                 *             WH_SHELL);</span>
02278 <span class="comment">                 *</span>
02279 <span class="comment">                 * PostShellHookMessages(HSHELL_WINDOWCREATED, pwnd);</span>
02280 <span class="comment">                 *</span>
02281 <span class="comment">                 * if (TestWF(pwnd, WFFRAMEON)) {</span>
02282 <span class="comment">                 *</span>
02283 <span class="comment">                 * xxxSetTrayWindow(pwnd);</span>
02284 <span class="comment">                 */</span>
02285 
02286             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a590">WFFULLSCREEN</a>)) {
02287                 <span class="comment">/*</span>
02288 <span class="comment">                 * Wake up the tray so it can notice that there is now</span>
02289 <span class="comment">                 * a fullscreen visible window.  This deals with bugs</span>
02290 <span class="comment">                 * 32164, 141563, and 150217.  FritzS</span>
02291 <span class="comment">                 */</span>
02292                 psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o1">bShellNotify</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02293                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOTIFYFS;
02294             }
02295 
02296             <span class="comment">/*</span>
02297 <span class="comment">             * If we're redrawing, create an SPB for this window if</span>
02298 <span class="comment">             * needed.</span>
02299 <span class="comment">             */</span>
02300             <span class="keywordflow">if</span> (!(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOREDRAW) ||
02301                     (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_CREATESPB)) {
02302 
02303                 <span class="comment">/*</span>
02304 <span class="comment">                 * ONLY create an SPB if this window happens to be</span>
02305 <span class="comment">                 * on TOP of all others.  NOTE: We could optimize this by</span>
02306 <span class="comment">                 * passing in the new vis rgn to CreateSpb() so that the</span>
02307 <span class="comment">                 * non-visible part of the window is automatically</span>
02308 <span class="comment">                 * invalid in the SPB.</span>
02309 <span class="comment">                 */</span>
02310                 <span class="comment">/*</span>
02311 <span class="comment">                 * Make sure this window's desktop is on top !</span>
02312 <span class="comment">                 */</span>
02313                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a480">CFSAVEBITS</a>) &amp;&amp;
02314                         pwnd-&gt;head.rpdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
02315 
02316                     <span class="comment">/*</span>
02317 <span class="comment">                     * If this window is the topmost VISIBLE window,</span>
02318 <span class="comment">                     * then we can create an SPB.</span>
02319 <span class="comment">                     */</span>
02320                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
02321                     RECT rcT;
02322 
02323                     <span class="keywordflow">for</span> (pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> ;
02324                          pwndT;
02325                          pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
02326 
02327                         <span class="keywordflow">if</span> (pwndT == pwnd) {
02328                             <a class="code" href="../../d4/d1/userk_8h.html#a1768">CreateSpb</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>);
02329                             <span class="keywordflow">break</span>;
02330                         }
02331 
02332                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
02333 
02334                             <span class="comment">/*</span>
02335 <span class="comment">                             * Does this window intersect the SAVEBITS</span>
02336 <span class="comment">                             * window at all?  If so, bail out.</span>
02337 <span class="comment">                             */</span>
02338                             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcT,
02339                                               &amp;pwnd-&gt;rcWindow,
02340                                               &amp;pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>)) {
02341                                 <span class="keywordflow">break</span>;
02342                             }
02343                         }
02344                     }
02345                 }
02346             }
02347 
02348         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_HIDEWINDOW) {
02349 
02350             <span class="comment">/*</span>
02351 <span class="comment">             * for idiots like MS-Access 2.0 who SetWindowPos( SWP_BOZO</span>
02352 <span class="comment">             * and blow away themselves on the shell, then lets</span>
02353 <span class="comment">             * just ignore their plea to be removed from the tray</span>
02354 <span class="comment">             */</span>
02355             <span class="keywordflow">if</span> (((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; <a class="code" href="../../d2/d8/swp_8c.html#a12">SWP_BOZO</a> ) != <a class="code" href="../../d2/d8/swp_8c.html#a12">SWP_BOZO</a>) &amp;&amp;
02356                 <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) {
02357 
02358                 psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o1">bShellNotify</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02359                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags |= SWP_NOTIFYDESTROY;
02360 
02361                 <span class="comment">/*</span>
02362 <span class="comment">                 * This Chicago code is replaced by the preceding code,</span>
02363 <span class="comment">                 * which exits the critical section only after the Gre</span>
02364 <span class="comment">                 * lock is removed.  Fritz</span>
02365 <span class="comment">                 *</span>
02366 <span class="comment">                 * xxxCallHook(HSHELL_WINDOWDESTROYED,</span>
02367 <span class="comment">                 *             (WPARAM)HWq(pwnd),</span>
02368 <span class="comment">                 *             (LPARAM)0,</span>
02369 <span class="comment">                 *             WH_SHELL);</span>
02370 <span class="comment">                 *</span>
02371 <span class="comment">                 * PostShellHookMessages(HSHELL_WINDOWDESTROYED, pwnd);</span>
02372 <span class="comment">                 */</span>
02373             }
02374 
02375             <span class="comment">/*</span>
02376 <span class="comment">             * Clear the WS_VISIBLE bit.</span>
02377 <span class="comment">             */</span>
02378             <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a750">SV_UNSET</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a752">SV_CLRFTRUEVIS</a>);
02379 
02380             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>())
02381                 <a class="code" href="../../d4/d1/userk_8h.html#a619">zzzWindowEvent</a>(EVENT_OBJECT_HIDE, pwnd, OBJID_WINDOW, INDEXID_CONTAINER, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
02382         }
02383 
02384         <span class="comment">/*</span>
02385 <span class="comment">         * BACKWARD COMPATIBILITY HACK</span>
02386 <span class="comment">         *</span>
02387 <span class="comment">         * Under 3.0, window frames were always redrawn, even if</span>
02388 <span class="comment">         * SWP_NOREDRAW was specified.  If we've gotten this far</span>
02389 <span class="comment">         * and we're visible, and SWP_NOREDRAW was specified, set</span>
02390 <span class="comment">         * the WFSENDNCPAINT bit.</span>
02391 <span class="comment">         *</span>
02392 <span class="comment">         * Apps such as ABC Flowcharter and 123W assume this.</span>
02393 <span class="comment">         * Typical offending code is MoveWindow(pwnd, ..., FALSE);</span>
02394 <span class="comment">         * followed by InvalidateRect(pwnd, NULL, TRUE);</span>
02395 <span class="comment">         */</span>
02396         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
02397             <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_STATECHANGE) ||
02398                 (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) &amp;&amp; (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOREDRAW))) {
02399 
02400                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>);
02401             }
02402         }
02403 
02404         <span class="comment">/*</span>
02405 <span class="comment">         * If this window has a clipping region set it now</span>
02406 <span class="comment">         */</span>
02407         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02408             <a class="code" href="../../d4/d1/userk_8h.html#a1611">SelectWindowRgn</a>(pwnd, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a>);
02409         }
02410         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02411     }
02412 
02413     <span class="comment">/*</span>
02414 <span class="comment">     * Check that the sibbling list looks OK now that we're done</span>
02415 <span class="comment">     */</span>
02416   <span class="comment">//  DBGValidateSibblingZOrder(pwndParent);</span>
02417 
02418     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>() &amp;&amp; czorder)
02419         <a class="code" href="../../d4/d1/userk_8h.html#a619">zzzWindowEvent</a>(EVENT_OBJECT_REORDER, pwndParent, OBJID_CLIENT, INDEXID_CONTAINER, 0);
02420     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
02421 
02422     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
02423 }
02424 
02425 <span class="comment">/***************************************************************************\</span>
02426 <span class="comment">* SwpCalcVisRgn</span>
02427 <span class="comment">*</span>
02428 <span class="comment">* This routine calculates a non-clipchildren visrgn for pwnd into hrgn.</span>
02429 <span class="comment">*</span>
02430 <span class="comment">* History:</span>
02431 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
02432 <span class="comment">\***************************************************************************/</span>
02433 
<a name="l02434"></a><a class="code" href="../../d2/d8/swp_8c.html#a42">02434</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a42">SwpCalcVisRgn</a>(
02435     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02436     HRGN hrgn)
02437 {
02438     <span class="comment">/*</span>
02439 <span class="comment">     * If this window is invisible, then</span>
02440 <span class="comment">     * the visrgn will be empty, so return FALSE.</span>
02441 <span class="comment">     */</span>
02442     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
02443         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02444 
02445     <span class="comment">/*</span>
02446 <span class="comment">     * Otherwise do it the hard way...</span>
02447 <span class="comment">     */</span>
02448     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(&amp;hrgn,
02449                       pwnd,
02450                       pwnd,
02451                       (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>) ?
02452                           (DCX_CLIPSIBLINGS | DCX_WINDOW) : (DCX_WINDOW)));
02453 }
02454 
02455 <span class="comment">/***************************************************************************\</span>
02456 <span class="comment">* CombineOldNewVis</span>
02457 <span class="comment">*</span>
02458 <span class="comment">* ORs or DIFFs hrgnOldVis and hrgnNewVis, depending on crgn, and the</span>
02459 <span class="comment">* RE_* bits of fsRgnEmpty.  Basically, this routine handles the optimization</span>
02460 <span class="comment">* where if either region is empty, the other can be copied.  Returns FALSE</span>
02461 <span class="comment">* if the result is empty.</span>
02462 <span class="comment">*</span>
02463 <span class="comment">* History:</span>
02464 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
02465 <span class="comment">\***************************************************************************/</span>
02466 
<a name="l02467"></a><a class="code" href="../../d2/d8/swp_8c.html#a43">02467</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a43">CombineOldNewVis</a>(
02468     HRGN hrgn,
02469     HRGN hrgnVisOld,
02470     HRGN hrgnVisNew,
02471     UINT crgn,
02472     UINT fsRgnEmpty)
02473 {
02474     <span class="keywordflow">switch</span> (fsRgnEmpty &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a269">RE_VISOLD</a> | <a class="code" href="../../d4/d1/userk_8h.html#a268">RE_VISNEW</a>)) {
02475     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a269">RE_VISOLD</a>:
02476 
02477         <span class="comment">/*</span>
02478 <span class="comment">         * If we're calculating old - new and old is empty, then result is</span>
02479 <span class="comment">         * empty.  Otherwise, result is new.</span>
02480 <span class="comment">         */</span>
02481         <span class="keywordflow">if</span> (crgn == RGN_DIFF)
02482             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02483 
02484         <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(hrgn, hrgnVisNew);
02485         <span class="keywordflow">break</span>;
02486 
02487     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a268">RE_VISNEW</a>:
02488 
02489         <span class="comment">/*</span>
02490 <span class="comment">         * New is empty: result will be the old.</span>
02491 <span class="comment">         */</span>
02492         <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(hrgn, hrgnVisOld);
02493         <span class="keywordflow">break</span>;
02494 
02495     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a268">RE_VISNEW</a> | <a class="code" href="../../d4/d1/userk_8h.html#a269">RE_VISOLD</a>:
02496 
02497         <span class="comment">/*</span>
02498 <span class="comment">         * Both empty: so's the result.</span>
02499 <span class="comment">         */</span>
02500         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02501 
02502     <span class="keywordflow">case</span> 0:
02503 
02504         <span class="comment">/*</span>
02505 <span class="comment">         * Neither are empty: do the real combine.</span>
02506 <span class="comment">         */</span>
02507         <span class="keywordflow">switch</span> (GreCombineRgn(hrgn, hrgnVisOld, hrgnVisNew, crgn)) {
02508         <span class="keywordflow">case</span> NULLREGION:
02509         <span class="keywordflow">case</span> ERROR:
02510             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02511 
02512         <span class="keywordflow">default</span>:
02513             <span class="keywordflow">break</span>;
02514         }
02515         <span class="keywordflow">break</span>;
02516     }
02517 
02518     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02519 }
02520 
02521 <span class="comment">/***************************************************************************\</span>
02522 <span class="comment">* BltValidInit</span>
02523 <span class="comment">*</span>
02524 <span class="comment">*</span>
02525 <span class="comment">* History:</span>
02526 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
02527 <span class="comment">\***************************************************************************/</span>
02528 
<a name="l02529"></a><a class="code" href="../../d2/d8/swp_8c.html#a44">02529</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d8/swp_8c.html#a44">BltValidInit</a>(
02530     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp)
02531 {
02532     <span class="keywordtype">int</span>  ccvr;
02533     <span class="keywordtype">int</span>  cIter = 0;
02534     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr;
02535     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02536     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fChangeState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02537 
02538     <span class="comment">/*</span>
02539 <span class="comment">     * Before we change any window state, calculate the old visrgn</span>
02540 <span class="comment">     */</span>
02541     <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
02542 
02543         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> flags = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags;
02544 
02545         <span class="comment">/*</span>
02546 <span class="comment">         * Make sure this is initialized to NULL; we may be sticking something</span>
02547 <span class="comment">         * in it, and we want to know later if we need to free that thing.</span>
02548 <span class="comment">         */</span>
02549         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02550 
02551         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02552             <span class="keywordflow">continue</span>;
02553 
02554         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
02555 
02556         <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || !<a class="code" href="../../d2/d8/swp_8c.html#a29">IsStillWindowC</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter)) {
02557             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02558             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags = SWP_NOREDRAW | SWP_NOCHANGE;
02559             <span class="keywordflow">continue</span>;
02560         }
02561 
02562         <span class="comment">/*</span>
02563 <span class="comment">         * Before we change any window's state, ensure that any SPBs</span>
02564 <span class="comment">         * over the window's old location are invalidated if necessary.</span>
02565 <span class="comment">         * This must be done because no WM_PAINT messages will be</span>
02566 <span class="comment">         * sent to anyone for the covered area if the area is obscured</span>
02567 <span class="comment">         * by other windows.</span>
02568 <span class="comment">         */</span>
02569         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>() &amp;&amp; !(flags &amp; SWP_NOREDRAW))
02570             <a class="code" href="../../d4/d1/userk_8h.html#a1763">SpbCheckRect</a>(pwnd, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, DCX_WINDOW);
02571 
02572         <span class="comment">/*</span>
02573 <span class="comment">         * Count the number of passes through the loop</span>
02574 <span class="comment">         */</span>
02575         cIter++;
02576 
02577         <span class="comment">/*</span>
02578 <span class="comment">         * Remember if any SWPs need their state changed.</span>
02579 <span class="comment">         */</span>
02580         <span class="keywordflow">if</span> ((flags &amp; SWP_CHANGEMASK) != SWP_NOCHANGE)
02581             fChangeState = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02582 
02583         <span class="comment">/*</span>
02584 <span class="comment">         * If we're not redrawing, no need to calculate visrgn</span>
02585 <span class="comment">         */</span>
02586         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOREDRAW)
02587             <span class="keywordflow">continue</span>;
02588 
02589         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SAMEDISPLAYFORMAT))
02590             <a class="code" href="../../d2/d8/swp_8c.html#a19">PreventInterMonitorBlts</a>(pcvr);
02591 
02592         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o8">fsRE</a>       = 0;
02593         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
02594 
02595         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
02596             !<a class="code" href="../../d2/d8/swp_8c.html#a42">SwpCalcVisRgn</a>(pwnd, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>)) {
02597 
02598             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o8">fsRE</a> = <a class="code" href="../../d4/d1/userk_8h.html#a269">RE_VISOLD</a>;
02599         }
02600     }
02601 
02602     <span class="keywordflow">return</span> (fChangeState ? cIter : 0);
02603 }
02604 
02605 <span class="comment">/***************************************************************************\</span>
02606 <span class="comment">* zzzBltValidBits</span>
02607 <span class="comment">*</span>
02608 <span class="comment">* NOTE: Although zzzBltValidBits calls 'xxxInternalInvalidate' it does not</span>
02609 <span class="comment">* specify any of the flags that will cause immediate updating.  This means</span>
02610 <span class="comment">* that it does not actually leave the critsect and therefore is not an 'xxx'</span>
02611 <span class="comment">* routine and doesn't have to bother with revalidation.</span>
02612 <span class="comment">*</span>
02613 <span class="comment">* This is the routine that blts the windows around on the screen, taking</span>
02614 <span class="comment">* into account SPBs.</span>
02615 <span class="comment">*</span>
02616 <span class="comment">* Here is the basic algebra going on here:</span>
02617 <span class="comment">*</span>
02618 <span class="comment">* ASSUMES: - rcBlt is aligned to the DESTINATION</span>
02619 <span class="comment">*          - offset() offsets from source to destination</span>
02620 <span class="comment">*</span>
02621 <span class="comment">* 1. hrgnSrc = offset(rcBlt) &amp; hrgnVisOld</span>
02622 <span class="comment">*</span>
02623 <span class="comment">*    Source region is the blt rectangle aligned with the old visrgn,</span>
02624 <span class="comment">*    intersected with the old visrgn.</span>
02625 <span class="comment">*</span>
02626 <span class="comment">* 2. hrgnDst = rcBlt &amp; hrgnVisNew</span>
02627 <span class="comment">*</span>
02628 <span class="comment">*    Dest region is the blt rectangle intersected with the new visrgn.</span>
02629 <span class="comment">*</span>
02630 <span class="comment">* 3. ghrgnValid = offset(hrgnSrc) &amp; hrgnDst</span>
02631 <span class="comment">*</span>
02632 <span class="comment">*    Valid area is the intersection of the destination with the source</span>
02633 <span class="comment">*    superimposed on the destination.</span>
02634 <span class="comment">*</span>
02635 <span class="comment">* 3.1 ghrgnValid = ghrgnValid - hrgnInterMonitor</span>
02636 <span class="comment">*</span>
02637 <span class="comment">*    Subtract out any pieces that are moving across monitors.</span>
02638 <span class="comment">*</span>
02639 <span class="comment">* 4. ghrgnValid -= ghrgnValidSum</span>
02640 <span class="comment">*</span>
02641 <span class="comment">*    This step takes into account the possibility that another window's</span>
02642 <span class="comment">*    valid bits were bltted on top of this windows valid bits.  So, as we</span>
02643 <span class="comment">*    blt a window's bits, we accumulate where it went, and subtract it</span>
02644 <span class="comment">*    from subsequent window's valid area.</span>
02645 <span class="comment">*</span>
02646 <span class="comment">* 5. ghrgnInvalid = (hrgnSrc | hrgnDst) - ghrgnValid</span>
02647 <span class="comment">*</span>
02648 <span class="comment">* 6. ghrgnInvalid += RestoreSpb(ghrgnInvalid) (sort of)</span>
02649 <span class="comment">*</span>
02650 <span class="comment">*    This is the wild part, because of the grungy way that the device</span>
02651 <span class="comment">*    driver SaveBits() routine works.  We call RestoreSpb() with</span>
02652 <span class="comment">*    a copy of ghrgnInvalid.  If the SPB valid region doesn't intersect</span>
02653 <span class="comment">*    ghrgnInvalid, RestoreSpb() does nothing.  But if it DOES intersect,</span>
02654 <span class="comment">*    it blts down the ENTIRE saved SPB bitmap, which may include area</span>
02655 <span class="comment">*    of the old window position that IS NOT part of ghrgnValid!</span>
02656 <span class="comment">*</span>
02657 <span class="comment">*    To correct for this, ghrgnValid is adjusted by subtracting off</span>
02658 <span class="comment">*    the ghrgnInvalid computed by RestoreSpb, if it modified it.</span>
02659 <span class="comment">*</span>
02660 <span class="comment">* 7. ghrgnInvalidSum |= ghrgnInvalid</span>
02661 <span class="comment">*</span>
02662 <span class="comment">*    We save up the sum of all the invalid areas, and invalidate the</span>
02663 <span class="comment">*    whole schmear in one fell swoop at the end.</span>
02664 <span class="comment">*</span>
02665 <span class="comment">* 8. ghrgnValidSum |= ghrgnValid</span>
02666 <span class="comment">*</span>
02667 <span class="comment">*    We keep track of the valid areas so far, which are subtracted</span>
02668 <span class="comment">*    in step 4.</span>
02669 <span class="comment">*</span>
02670 <span class="comment">* The actual steps occur in a slightly different order than above, and</span>
02671 <span class="comment">* there are numerous optimizations that are taken advantage of (the</span>
02672 <span class="comment">* most important having to do with hiding and showing, and complete</span>
02673 <span class="comment">* SPB restoration).</span>
02674 <span class="comment">*</span>
02675 <span class="comment">* Returns TRUE if some drawing was done, FALSE otherwise.</span>
02676 <span class="comment">*</span>
02677 <span class="comment">* History:</span>
02678 <span class="comment">* 10-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
02679 <span class="comment">\***************************************************************************/</span>
02680 
<a name="l02681"></a><a class="code" href="../../d2/d8/swp_8c.html#a45">02681</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a45">zzzBltValidBits</a>(
02682     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>    psmwp)
02683 {
02684     <span class="keywordtype">int</span>        ccvr;
02685     <span class="keywordtype">int</span>        cIter;
02686     <a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a>       pcvr;
02687     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>       pwnd;
02688     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>       pwndParent;
02689     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>       pwndT;
02690     PWINDOWPOS <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>;
02691     HRGN       hrgnInvalidate;
02692     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>       fsRgnEmpty;
02693     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>       fsSumEmpty;
02694     <span class="keywordtype">int</span>        cwndShowing;
02695     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       fSyncPaint = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02696     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       fInvalidateLayers = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02697     HDC        hdcScreen = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02698 
02699     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
02700     GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
02701 
02702     <span class="comment">/*</span>
02703 <span class="comment">     * Compute old visrgns and count total CVRs in list.  A side-effect of</span>
02704 <span class="comment">     * BltValidInit is that revalidates all the windows in the SMWP array.</span>
02705 <span class="comment">     */</span>
02706 
02707 
02708     <span class="keywordflow">if</span> ((cIter = <a class="code" href="../../d2/d8/swp_8c.html#a44">BltValidInit</a>(psmwp)) == 0) {
02709 
02710 CleanupAndExit:
02711 
02712         <span class="comment">/*</span>
02713 <span class="comment">         * Go through the cvr list and free the regions that BltValidInit()</span>
02714 <span class="comment">         * created.</span>
02715 <span class="comment">         */</span>
02716         <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
02717 
02718             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>) {
02719                 GreDeleteObject(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>);
02720                 pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02721             }
02722         }
02723 
02724         <span class="keywordflow">goto</span> UnlockAndExit;
02725     }
02726 
02727     <span class="comment">/*</span>
02728 <span class="comment">     * We left the crit sect since last time we validated the smwp. Validate</span>
02729 <span class="comment">     * it again, and find the first WINDOWPOS structure with a non-NULL</span>
02730 <span class="comment">     * hwnd in it.</span>
02731 <span class="comment">     */</span>
02732     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02733     <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
02734 
02735         <span class="comment">/*</span>
02736 <span class="comment">         * Revalidate window and if it's invalid, NULL it out in the WINDOWPOS</span>
02737 <span class="comment">         * struct.</span>
02738 <span class="comment">         */</span>
02739         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
02740 
02741         <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)              ||
02742             (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02743             !<a class="code" href="../../d2/d8/swp_8c.html#a29">IsStillWindowC</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter)) {
02744 
02745             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02746             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags = SWP_NOREDRAW | SWP_NOCHANGE;
02747             <span class="keywordflow">continue</span>;
02748         }
02749 
02750         <span class="comment">/*</span>
02751 <span class="comment">         * Remember the first WINDOWPOS structure that has a non-NULL</span>
02752 <span class="comment">         * hwnd.</span>
02753 <span class="comment">         */</span>
02754         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02755             <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> = &amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>;
02756     }
02757 
02758     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02759         <span class="keywordflow">goto</span> CleanupAndExit;
02760 
02761     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd));
02762     pwndParent = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd)-&gt;spwndParent;
02763     UserAssert(pwndParent);
02764 
02765     <span class="comment">/*</span>
02766 <span class="comment">     * Go account for any dirty DCs at this point, to ensure that:</span>
02767 <span class="comment">     *      - any drawing done before we create an SPB will not</span>
02768 <span class="comment">     *        later invalidate that SPB</span>
02769 <span class="comment">     *      - the SPB regions reflect the true state of the screen,</span>
02770 <span class="comment">     *        so that we don't validate parts of windows that are dirty.</span>
02771 <span class="comment">     *</span>
02772 <span class="comment">     * We must make this call before we change any window state.</span>
02773 <span class="comment">     */</span>
02774     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>())
02775         <a class="code" href="../../d4/d1/userk_8h.html#a1764">SpbCheck</a>();
02776 
02777     <span class="comment">/*</span>
02778 <span class="comment">     * Change the window states</span>
02779 <span class="comment">     */</span>
02780     <a class="code" href="../../d2/d8/swp_8c.html#a41">zzzChangeStates</a>(pwndParent, psmwp);
02781 
02782     <span class="comment">/*</span>
02783 <span class="comment">     * move window bits around</span>
02784 <span class="comment">     *</span>
02785 <span class="comment">     * Invalidate the DCs for the siblings of this window.</span>
02786 <span class="comment">     *</span>
02787 <span class="comment">     * If our parent is not clipchildren, then we don't need to</span>
02788 <span class="comment">     * invalidate its DCs.  If it IS clipchildren, its client visrgn</span>
02789 <span class="comment">     * will be changing, so we must invalidate it too.</span>
02790 <span class="comment">     *</span>
02791 <span class="comment">     * Note, because IDC_MOVEBLT is set, final completion of WNDOBJ</span>
02792 <span class="comment">     * notification is delayed until GreClientRgnDone is called.</span>
02793 <span class="comment">     * This final notification does not happen until after the</span>
02794 <span class="comment">     * window move blts have completed.</span>
02795 <span class="comment">     */</span>
02796     <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwndParent,
02797                       <a class="code" href="../../d4/d1/userk_8h.html#a235">IDC_MOVEBLT</a> |
02798                       (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>) ?
02799                           <a class="code" href="../../d4/d1/userk_8h.html#a234">IDC_CLIENTONLY</a> : <a class="code" href="../../d4/d1/userk_8h.html#a233">IDC_CHILDRENONLY</a>));
02800 
02801     <span class="comment">/*</span>
02802 <span class="comment">     * Now, do the bltting or whatever that is required.</span>
02803 <span class="comment">     */</span>
02804     fsSumEmpty = <a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a> | <a class="code" href="../../d4/d1/userk_8h.html#a274">RE_INVALIDSUM</a>;
02805     hrgnInvalidate = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a183">ghrgnInvalidSum</a>;
02806 
02807     <span class="comment">/*</span>
02808 <span class="comment">     * Init count of windows being shown with SWP_SHOWWINDOW</span>
02809 <span class="comment">     * for our backward compatibility hack later.</span>
02810 <span class="comment">     */</span>
02811     cwndShowing = 0;
02812 
02813     <span class="keywordflow">for</span> (pcvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>, ccvr = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; --ccvr &gt;= 0; pcvr++) {
02814 
02815         <span class="comment">/*</span>
02816 <span class="comment">         * Decrement loop count.  When cIter is 0, then</span>
02817 <span class="comment">         * we're on the last pass through the loop.</span>
02818 <span class="comment">         */</span>
02819         cIter--;
02820 
02821         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02822             <span class="keywordflow">continue</span>;
02823 
02824         <span class="comment">/*</span>
02825 <span class="comment">         * If we're not redrawing, try the next one.</span>
02826 <span class="comment">         */</span>
02827         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOREDRAW)
02828             <span class="keywordflow">continue</span>;
02829 
02830         <span class="comment">/*</span>
02831 <span class="comment">         * Some drawing has been done</span>
02832 <span class="comment">         */</span>
02833         fSyncPaint = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02834 
02835         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
02836 
02837         fsRgnEmpty = pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o8">fsRE</a>;
02838 
02839         <span class="comment">/*</span>
02840 <span class="comment">         * Sprites should not be invalidated or cause invalidation.</span>
02841 <span class="comment">         */</span>
02842         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd)) {
02843             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02844                 <span class="keywordflow">goto</span> InvalidEmpty;
02845 
02846             <span class="comment">/*</span>
02847 <span class="comment">             * Sizing or showing uncovers new bits for a window, so</span>
02848 <span class="comment">             * do the normal invalidation in this case. When sizing makes a</span>
02849 <span class="comment">             * window smaller setting fInvalidateLayers to TRUE has the side</span>
02850 <span class="comment">             * effect of allowing other layered windows to be invalidated.</span>
02851 <span class="comment">             * Ideally, it should only allow invlalidating just the windows</span>
02852 <span class="comment">             * that resized or showed. This would be a bunch of work, but we</span>
02853 <span class="comment">             * should consider it for later.</span>
02854 <span class="comment">             */</span>
02855             <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOSIZE) &amp;&amp;
02856                     !(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_SHOWWINDOW)) {
02857                 <span class="keywordflow">goto</span> InvalidEmpty;
02858             } <span class="keywordflow">else</span> {
02859                 fInvalidateLayers = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02860             }
02861         }
02862 
02863         <span class="comment">/*</span>
02864 <span class="comment">         * Calculate the new visrgn</span>
02865 <span class="comment">         */</span>
02866         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/swp_8c.html#a42">SwpCalcVisRgn</a>(pwnd, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a184">ghrgnVisNew</a>))
02867             fsRgnEmpty |= <a class="code" href="../../d4/d1/userk_8h.html#a268">RE_VISNEW</a>;
02868 
02869         <span class="comment">/*</span>
02870 <span class="comment">         * If the window is obscured by another window with an SPB,</span>
02871 <span class="comment">         * we have to ensure that that SPB gets invalidated properly</span>
02872 <span class="comment">         * since the app may not be getting a WM_PAINT msg or anything</span>
02873 <span class="comment">         * to invalidate the bits.</span>
02874 <span class="comment">         */</span>
02875         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>())
02876             <a class="code" href="../../d4/d1/userk_8h.html#a1763">SpbCheckRect</a>(pwnd, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, DCX_WINDOW);
02877 
02878         <span class="comment">/*</span>
02879 <span class="comment">         * Calculate ghrgnValid:</span>
02880 <span class="comment">         *</span>
02881 <span class="comment">         * ghrgnValid = OffsetRgn(rcBlt, -dxBlt, -dyBlt) &amp; hrgnVisOld</span>
02882 <span class="comment">         * ghrgnValid = ghrgnValid - ghrgnValidSum</span>
02883 <span class="comment">         * OffsetRgn(ghrgnValid, dxBlt, dyBlt);</span>
02884 <span class="comment">         * ghrgnValid = ghrgnValid - hrgnUpdate</span>
02885 <span class="comment">         * ghrgnValid = ghrgnValid &amp; hrgnVisNew;</span>
02886 <span class="comment">         *</span>
02887 <span class="comment">         * If either the old or new visrgns are empty, there</span>
02888 <span class="comment">         * can be no valid bits...</span>
02889 <span class="comment">         */</span>
02890         <span class="keywordflow">if</span> (fsRgnEmpty &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a269">RE_VISOLD</a> | <a class="code" href="../../d4/d1/userk_8h.html#a268">RE_VISNEW</a>))
02891             <span class="keywordflow">goto</span> ValidEmpty;
02892 
02893         <span class="comment">/*</span>
02894 <span class="comment">         * If the entire window is already completely invalid, blow out.</span>
02895 <span class="comment">         */</span>
02896         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>)
02897             <span class="keywordflow">goto</span> ValidEmpty;
02898 
02899         <span class="comment">/*</span>
02900 <span class="comment">         * If the blt rectangle is empty, there can be no valid bits.</span>
02901 <span class="comment">         */</span>
02902         <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.right &lt;= pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left) ||
02903             (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.bottom &lt;= pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top)) {
02904 
02905             <span class="keywordflow">goto</span> ValidEmpty;
02906         }
02907 
02908         GreSetRectRgn(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a185">ghrgnSWP1</a>,
02909                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>,
02910                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>,
02911                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.right - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>,
02912                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.bottom - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>);
02913 
02914         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a185">ghrgnSWP1</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>)) {
02915         <span class="keywordflow">case</span> NULLREGION:
02916         <span class="keywordflow">case</span> ERROR:
02917             <span class="keywordflow">goto</span> ValidEmpty;
02918             <span class="keywordflow">break</span>;
02919         }
02920 
02921         <span class="keywordflow">if</span> (!(fsSumEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a>)) {
02922             <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a187">ghrgnValidSum</a>)) {
02923             <span class="keywordflow">case</span> NULLREGION:
02924             <span class="keywordflow">case</span> ERROR:
02925                 <span class="keywordflow">goto</span> ValidEmpty;
02926                 <span class="keywordflow">break</span>;
02927             }
02928         }
02929 
02930         <span class="keywordflow">if</span> ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> | pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>) != 0)
02931             GreOffsetRgn(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>);
02932 
02933         <span class="comment">/*</span>
02934 <span class="comment">         * Now subtract off the update regions of ourself and any</span>
02935 <span class="comment">         * non-clipchildren parents...</span>
02936 <span class="comment">         */</span>
02937         pwndT = pwnd;
02938 
02939         <span class="keywordflow">do</span> {
02940 
02941             <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>)
02942                 <span class="keywordflow">goto</span> ValidEmpty;
02943 
02944             <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02945                 <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>)) {
02946                 <span class="keywordflow">case</span> NULLREGION:
02947                 <span class="keywordflow">case</span> ERROR:
02948                     <span class="keywordflow">goto</span> ValidEmpty;
02949                     <span class="keywordflow">break</span>;
02950                 }
02951             }
02952 
02953             pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
02954 
02955         } <span class="keywordflow">while</span> (pwndT &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>));
02956 
02957         <span class="comment">/*</span>
02958 <span class="comment">         * Subtract out the intermonitor blt pieces.</span>
02959 <span class="comment">         */</span>
02960         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02961             <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a>)) {
02962                 <span class="keywordflow">case</span> NULLREGION:
02963                 <span class="keywordflow">case</span> ERROR:
02964                     <span class="keywordflow">goto</span> ValidEmpty;
02965             }
02966         }
02967 
02968         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a184">ghrgnVisNew</a>)) {
02969         <span class="keywordflow">case</span> NULLREGION:
02970         <span class="keywordflow">case</span> ERROR:
02971 
02972 ValidEmpty:
02973 
02974             fsRgnEmpty |= <a class="code" href="../../d4/d1/userk_8h.html#a270">RE_VALID</a>;
02975             <span class="keywordflow">break</span>;
02976         }
02977 
02978         <span class="comment">/*</span>
02979 <span class="comment">         * Before we restore the restore bits over part of our</span>
02980 <span class="comment">         * image, we need to first copy any valid bits to their</span>
02981 <span class="comment">         * final destination.</span>
02982 <span class="comment">         */</span>
02983         <span class="keywordflow">if</span> (!(fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a270">RE_VALID</a>) &amp;&amp; ((pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a> | pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>) != 0)) {
02984 
02985             <span class="keywordflow">if</span> (hdcScreen == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02986                 hdcScreen = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>;
02987 
02988             GreSelectVisRgn(hdcScreen, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, SVR_COPYNEW);
02989 
02990 <span class="preprocessor">#ifdef _WINDOWBLT_NOTIFICATION_</span>
02991 <span class="preprocessor"></span><span class="comment">/*</span>
02992 <span class="comment"> * Define _WINDOWBLT_NOTIFICATION_ to turn on Window BLT notification.</span>
02993 <span class="comment"> * This notification will set a special flag in the SURFOBJ passed to</span>
02994 <span class="comment"> * drivers when the DrvCopyBits operation is called to move a window.</span>
02995 <span class="comment"> *</span>
02996 <span class="comment"> * See also:</span>
02997 <span class="comment"> *      ntgdi\gre\maskblt.cxx</span>
02998 <span class="comment"> */</span>
02999             NtGdiBitBlt(hdcScreen,
03000                         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left,
03001                         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top,
03002                         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.right - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left,
03003                         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.bottom - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top,
03004                         hdcScreen,
03005                         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>,
03006                         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>,
03007                         SRCCOPY,
03008                         0,
03009                         GBB_WINDOWBLT);
03010 <span class="preprocessor">#else</span>
03011 <span class="preprocessor"></span>            GreBitBlt(hdcScreen,
03012                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left,
03013                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top,
03014                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.right - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left,
03015                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.bottom - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top,
03016                       hdcScreen,
03017                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.left - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>,
03018                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>.top - pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>,
03019                       SRCCOPY,
03020                       0);
03021 <span class="preprocessor">#endif</span>
03022 <span class="preprocessor"></span>        }
03023 
03024         <span class="comment">/*</span>
03025 <span class="comment">         * Now take care of any SPB bit restoration we need to do.</span>
03026 <span class="comment">         *</span>
03027 <span class="comment">         * Calculate the region to clip the RestoreSpb() output to:</span>
03028 <span class="comment">         *</span>
03029 <span class="comment">         * ghrgnInvalid = hrgnVisOld - hrgnVisNew</span>
03030 <span class="comment">         */</span>
03031         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a558">WFHASSPB</a>)    &amp;&amp;
03032             !(fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a269">RE_VISOLD</a>) &amp;&amp;
03033             <a class="code" href="../../d2/d8/swp_8c.html#a43">CombineOldNewVis</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a184">ghrgnVisNew</a>, RGN_DIFF, fsRgnEmpty)) {
03034 
03035             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> retRSPB;
03036 
03037             <span class="comment">/*</span>
03038 <span class="comment">             * Perform SPB bits restore.  We pass RestoreSpb() the region of</span>
03039 <span class="comment">             * the part of the SPB that got uncovered by this window rearrangement.</span>
03040 <span class="comment">             * It tries to restore as much of this area as it can from the SPB,</span>
03041 <span class="comment">             * and returns the area that could not be restored from the SPB.</span>
03042 <span class="comment">             *</span>
03043 <span class="comment">             * The device driver's SaveBitmap() function does not clip at all</span>
03044 <span class="comment">             * when it restores bits, which means that it might write bits</span>
03045 <span class="comment">             * in an otherwise valid area.  This means that the invalid area</span>
03046 <span class="comment">             * returned by RestoreSpb() may actually be LARGER than the original</span>
03047 <span class="comment">             * hrgnSpb passed in.</span>
03048 <span class="comment">             *</span>
03049 <span class="comment">             * RestoreSpb() returns TRUE if some part of ghrgnInvalid needs</span>
03050 <span class="comment">             * to be invalidated.</span>
03051 <span class="comment">             */</span>
03052             <span class="keywordflow">if</span> ((retRSPB = <a class="code" href="../../d4/d1/userk_8h.html#a1769">RestoreSpb</a>(pwnd, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>, &amp;hdcScreen)) == <a class="code" href="../../d4/d1/userk_8h.html#a237">RSPB_NO_INVALIDATE</a>) {
03053 
03054                 <span class="comment">/*</span>
03055 <span class="comment">                 * If hrgnVisNew is empty, then we know the whole invalid</span>
03056 <span class="comment">                 * area is empty.</span>
03057 <span class="comment">                 */</span>
03058                 <span class="keywordflow">if</span> (fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a268">RE_VISNEW</a>)
03059                     <span class="keywordflow">goto</span> InvalidEmpty;
03060 
03061             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (retRSPB == <a class="code" href="../../d4/d1/userk_8h.html#a239">RSPB_INVALIDATE_SSB</a>) {
03062 
03063                 <span class="comment">/*</span>
03064 <span class="comment">                 * If RestoreSpb actually invalidated some area and we already</span>
03065 <span class="comment">                 * have a ghrgnValidSum then subtract the newly invalidated area</span>
03066 <span class="comment">                 * Warning this region subtract is not in the Win 3.1 code but</span>
03067 <span class="comment">                 * they probably did not have the problem as severe because their</span>
03068 <span class="comment">                 * drivers were limited to one level of SaveScreenBits</span>
03069 <span class="comment">                 */</span>
03070                 <span class="keywordflow">if</span> (!(fsSumEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a>))
03071                     <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a187">ghrgnValidSum</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a187">ghrgnValidSum</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>);
03072             }
03073 
03074             <span class="comment">/*</span>
03075 <span class="comment">             * ghrgnInvalid += hrgnVisNew</span>
03076 <span class="comment">             */</span>
03077             <span class="keywordflow">if</span> (!(fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a268">RE_VISNEW</a>))
03078                 <a class="code" href="../../d4/d1/userk_8h.html#a230">UnionRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a184">ghrgnVisNew</a>);
03079 
03080             <span class="comment">/*</span>
03081 <span class="comment">             * Some of the area we calculated as valid may have gotten</span>
03082 <span class="comment">             * obliterated by the SPB restore.  To ensure this isn't</span>
03083 <span class="comment">             * the case, subtract off the ghrgnInvalid returned by RestoreSpb.</span>
03084 <span class="comment">             */</span>
03085             <span class="comment">// LATER mikeke VALIDSUM / ghrgnValid mismatch</span>
03086             <span class="keywordflow">if</span> (!(fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a>)) {
03087                 <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>)) {
03088                 <span class="keywordflow">case</span> NULLREGION:
03089                 <span class="keywordflow">case</span> ERROR:
03090                     fsRgnEmpty |= <a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a>;
03091                     <span class="keywordflow">break</span>;
03092                 }
03093             }
03094 
03095         } <span class="keywordflow">else</span> {
03096 
03097             <span class="comment">/*</span>
03098 <span class="comment">             * No SPB.  Simple ghrgnInvalid calculation is:</span>
03099 <span class="comment">             *</span>
03100 <span class="comment">             * ghrgnInvalid = hrgnVisNew + hrgnVisOld;</span>
03101 <span class="comment">             */</span>
03102             <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03103 
03104                 <span class="comment">/*</span>
03105 <span class="comment">                 * If we couldn't create hrgnVisOld, then</span>
03106 <span class="comment">                 * invalidate the entire parent</span>
03107 <span class="comment">                 */</span>
03108                 <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>, &amp;pwndParent-&gt;rcWindow);
03109             } <span class="keywordflow">else</span> {
03110 
03111                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/swp_8c.html#a43">CombineOldNewVis</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>,
03112                                       pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>,
03113                                       <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a184">ghrgnVisNew</a>,
03114                                       RGN_OR,
03115                                       fsRgnEmpty)) {
03116 
03117                     <span class="keywordflow">goto</span> InvalidEmpty;
03118                 }
03119             }
03120         }
03121 
03122         <span class="comment">/*</span>
03123 <span class="comment">         * Update ghrgnValidSum</span>
03124 <span class="comment">         *</span>
03125 <span class="comment">         * ghrgnValidSum += ghrgnValid</span>
03126 <span class="comment">         */</span>
03127         <span class="keywordflow">if</span> (!(fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a270">RE_VALID</a>)) {
03128 
03129             <span class="comment">/*</span>
03130 <span class="comment">             * If the sum region is empty, then COPY instead of OR</span>
03131 <span class="comment">             */</span>
03132             <span class="keywordflow">if</span> (fsSumEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a>)
03133                 <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a187">ghrgnValidSum</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>);
03134             <span class="keywordflow">else</span>
03135                 <a class="code" href="../../d4/d1/userk_8h.html#a230">UnionRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a187">ghrgnValidSum</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a187">ghrgnValidSum</a>);
03136             fsSumEmpty &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a>;
03137         }
03138 
03139         <span class="comment">/*</span>
03140 <span class="comment">         * Subtract ghrgnValidSum from ghrgnInvalid if non-empty,</span>
03141 <span class="comment">         * otherwise use ghrgnValid.  Note, ghrgnValid has been OR'ed</span>
03142 <span class="comment">         * into ghrgnValidSum already.</span>
03143 <span class="comment">         */</span>
03144         <span class="keywordflow">if</span> (!(fsSumEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a>) || !(fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a270">RE_VALID</a>)) {
03145             <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>,
03146                     !(fsSumEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a273">RE_VALIDSUM</a>) ? <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a187">ghrgnValidSum</a> : <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>)) {
03147             <span class="keywordflow">case</span> NULLREGION:
03148             <span class="keywordflow">case</span> ERROR:
03149 InvalidEmpty:
03150                 fsRgnEmpty |= <a class="code" href="../../d4/d1/userk_8h.html#a271">RE_INVALID</a>;
03151                 <span class="keywordflow">break</span>;
03152             }
03153         }
03154 
03155         <span class="comment">/*</span>
03156 <span class="comment">         * If there are any SPB bits left over, it wasn't just created</span>
03157 <span class="comment">         * (SWP_SHOWWINDOW), and an operation occured that invalidates</span>
03158 <span class="comment">         * the spb bits, get rid of the spb.  A move, size, hide, or</span>
03159 <span class="comment">         * zorder operation will invalidate the bits.  Note that we do this</span>
03160 <span class="comment">         * outside of the SWP_NOREDRAW case in case the guy set that flag</span>
03161 <span class="comment">         * when he had some SPB bits lying around.</span>
03162 <span class="comment">         */</span>
03163         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a558">WFHASSPB</a>) &amp;&amp; !(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_SHOWWINDOW) &amp;&amp;
03164                 (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp;
03165                 (SWP_NOMOVE | SWP_NOSIZE | SWP_NOZORDER | SWP_HIDEWINDOW))
03166                 != (SWP_NOMOVE | SWP_NOSIZE | SWP_NOZORDER)) {
03167 
03168             <a class="code" href="../../d4/d1/userk_8h.html#a1766">FreeSpb</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1765">FindSpb</a>(pwnd));
03169         }
03170 
03171         <span class="comment">/*</span>
03172 <span class="comment">         * Finally, free up hrgnVisOld.</span>
03173 <span class="comment">         */</span>
03174         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>) {
03175             GreDeleteObject(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a>);
03176             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o9">hrgnVisOld</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03177         }
03178 
03179         <span class="comment">/*</span>
03180 <span class="comment">         * BACKWARD COMPATIBILITY HACK</span>
03181 <span class="comment">         *</span>
03182 <span class="comment">         * In 3.0, a ShowWindow() NEVER invalidated any of the children.</span>
03183 <span class="comment">         * It would invalidate the parent and the window being shown, but</span>
03184 <span class="comment">         * no others.</span>
03185 <span class="comment">         *</span>
03186 <span class="comment">         * We only apply hack (a) to 3.0 apps when all the windows involved</span>
03187 <span class="comment">         * are doing a SWP_SHOWWINDOW: if any aren't, then we have to make</span>
03188 <span class="comment">         * sure the siblings are invalidated too.  So, we count the windows</span>
03189 <span class="comment">         * doing a SHOWWINDOW and compare it to the total count in the CVR.</span>
03190 <span class="comment">         */</span>
03191         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) &amp;&amp; (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_SHOWWINDOW))
03192             cwndShowing++;
03193 
03194         <span class="comment">/*</span>
03195 <span class="comment">         * Update ghrgnInvalidSum:</span>
03196 <span class="comment">         *</span>
03197 <span class="comment">         * ghrgnInvalidSum += ghrgnInvalid</span>
03198 <span class="comment">         */</span>
03199         <span class="keywordflow">if</span> (!(fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a271">RE_INVALID</a>)) {
03200 
03201             <span class="comment">/*</span>
03202 <span class="comment">             * BACKWARD COMPATIBILITY HACK</span>
03203 <span class="comment">             *</span>
03204 <span class="comment">             * In many cases including ShowWindow, CS_V/HREDRAW,</span>
03205 <span class="comment">             * SWP_NOCOPYBITS, etc, 3.0 always invalidated the window with</span>
03206 <span class="comment">             * (HRGN)1, regardless of how it was clipped by children, siblings,</span>
03207 <span class="comment">             * or parents.  Besides being more efficient, this caused child</span>
03208 <span class="comment">             * windows that would otherwise not get update regions to get</span>
03209 <span class="comment">             * invalidated -- see the hack notes in InternalInvalidate2.</span>
03210 <span class="comment">             *</span>
03211 <span class="comment">             * This is a performance hack (usually) because (HRGN)1 can save</span>
03212 <span class="comment">             * a lot of region calculations in the normal case.  So, we do this</span>
03213 <span class="comment">             * for 3.1 apps as well as 3.0 apps.</span>
03214 <span class="comment">             *</span>
03215 <span class="comment">             * We detect the case as follows: invalid area not empty,</span>
03216 <span class="comment">             * valid area empty, and new visrgn not empty.</span>
03217 <span class="comment">             */</span>
03218             <span class="keywordflow">if</span> ((fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a270">RE_VALID</a>) &amp;&amp; !(fsRgnEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a268">RE_VISNEW</a>)) {
03219 
03220                 <span class="comment">/*</span>
03221 <span class="comment">                 * With the parameters we use InternalInvalidate() does</span>
03222 <span class="comment">                 * not leave the critical section</span>
03223 <span class="comment">                 */</span>
03224                 <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
03225                 <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(pwnd,
03226                                      <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>,
03227                                      RDW_INVALIDATE |
03228                                      RDW_FRAME      |
03229                                      RDW_ERASE      |
03230                                      RDW_ALLCHILDREN);
03231                 <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
03232             }
03233 
03234             <span class="comment">/*</span>
03235 <span class="comment">             * If the sum region is empty, then COPY instead of OR</span>
03236 <span class="comment">             */</span>
03237             <span class="keywordflow">if</span> (fsSumEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a274">RE_INVALIDSUM</a>) {
03238 
03239                 <span class="comment">/*</span>
03240 <span class="comment">                 * HACK ALERT:</span>
03241 <span class="comment">                 * If this is the last pass through the loop (cIter == 0)</span>
03242 <span class="comment">                 * and ghrgnInvalidSum is currently empty,</span>
03243 <span class="comment">                 * then instead of copying ghrgnInvalid to ghrgnInvalidSum,</span>
03244 <span class="comment">                 * just set hrgnInvalidate to ghrgnInvalid.  This saves</span>
03245 <span class="comment">                 * a region copy in the single-window case.</span>
03246 <span class="comment">                 */</span>
03247                 <span class="keywordflow">if</span> (cIter == 0) {
03248                     hrgnInvalidate = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>;
03249                 } <span class="keywordflow">else</span> {
03250                     <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a183">ghrgnInvalidSum</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>);
03251                 }
03252 
03253             } <span class="keywordflow">else</span> {
03254 
03255                 <a class="code" href="../../d4/d1/userk_8h.html#a230">UnionRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a183">ghrgnInvalidSum</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a183">ghrgnInvalidSum</a>);
03256             }
03257 
03258             fsSumEmpty &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a274">RE_INVALIDSUM</a>;
03259         }
03260     } <span class="comment">// for (... pcvr ...)</span>
03261 
03262     <span class="comment">/*</span>
03263 <span class="comment">     * Now, invalidate as needed.</span>
03264 <span class="comment">     */</span>
03265     <span class="keywordflow">if</span> (!(fsSumEmpty &amp; <a class="code" href="../../d4/d1/userk_8h.html#a274">RE_INVALIDSUM</a>)) {
03266 
03267         <span class="comment">/*</span>
03268 <span class="comment">         * BACKWARD COMPATIBILITY HACK (see above)</span>
03269 <span class="comment">         *</span>
03270 <span class="comment">         * If all the windows involved were being shown, then</span>
03271 <span class="comment">         * invalidate the parent ONLY -- don't enumerate any children.</span>
03272 <span class="comment">         * (the windows involved have already been invalidated above).</span>
03273 <span class="comment">         * This hack is only applied to 3.0 apps (see above).</span>
03274 <span class="comment">         */</span>
03275 
03276         <span class="comment">/*</span>
03277 <span class="comment">         * More hack-o-rama. On Win3.1, the desktop paint would only</span>
03278 <span class="comment">         * repaint those portions inside the rect returned from GetClipBox().</span>
03279 <span class="comment">         * Dialogs with spbs outside the rect returned from GetClipBox() would</span>
03280 <span class="comment">         * not get their spbs invalidated until later, when you clicked on</span>
03281 <span class="comment">         * them to make them active. The only dialog that wouldn't really loose</span>
03282 <span class="comment">         * its bits is the control panel desktop dialog, which would restore</span>
03283 <span class="comment">         * its bad bits when it went away (in certain configurations). On</span>
03284 <span class="comment">         * NT, the desktop would repaint and then the dialog would go away.</span>
03285 <span class="comment">         * On Win3.1, the dialog would go away and then the desktop would</span>
03286 <span class="comment">         * repaint. On NT, because of preemption and little differences in</span>
03287 <span class="comment">         * painting order between applications, there was an opportunity to</span>
03288 <span class="comment">         * put bad bits on the screen, on Win3.1 there wasn't.</span>
03289 <span class="comment">         *</span>
03290 <span class="comment">         * Now... the below code that passes RDW_NOCHILDREN only gets executed</span>
03291 <span class="comment">         * if the app is marked as a win3.0 app (latest CorelDraw, also wep</span>
03292 <span class="comment">         * freecell demonstrates the same problem). This code would get</span>
03293 <span class="comment">         * executed when a dialog got shown. So for a win3.0 app, spb would get</span>
03294 <span class="comment">         * saved, the dialog would get shown, the desktop invalidated, the</span>
03295 <span class="comment">         * desktop would paint, the spb would get clobbered. In short, when</span>
03296 <span class="comment">         * a win3.0 app would put up a dialog, all spbs would get freed because</span>
03297 <span class="comment">         * of the new (and correct) way the desktop repaints.</span>
03298 <span class="comment">         *</span>
03299 <span class="comment">         * So the desktop check hack will counter-act the invalidate</span>
03300 <span class="comment">         * RDW_NOCHILDREN case if all windows are hiding / showing and the</span>
03301 <span class="comment">         * desktop is being invalidated. Note that in the no RDW_NOCHILDREN</span>
03302 <span class="comment">         * case, the invalid area gets distributed to the children first (in</span>
03303 <span class="comment">         * this case, children of the desktop), so if the children cover the</span>
03304 <span class="comment">         * desktop, the desktop won't get any invalid region, which is what</span>
03305 <span class="comment">         * we want. - scottlu</span>
03306 <span class="comment">         */</span>
03307 
03308         <span class="comment">/*</span>
03309 <span class="comment">         * With the parameters we use InternalInvalidate() does not leave</span>
03310 <span class="comment">         * the critical section</span>
03311 <span class="comment">         */</span>
03312 
03313         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = RDW_INVALIDATE | RDW_ERASE;
03314         <span class="keywordflow">if</span> (cwndShowing == psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> &amp;&amp;
03315                 pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndParent)) {
03316             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= RDW_NOCHILDREN;
03317         } <span class="keywordflow">else</span> {
03318             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= RDW_ALLCHILDREN;
03319         }
03320         <span class="keywordflow">if</span> (fInvalidateLayers) {
03321             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= RDW_INVALIDATELAYERS;
03322         }
03323 
03324         <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
03325         <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(pwndParent, hrgnInvalidate, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
03326         <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
03327     }
03328 
03329     <span class="comment">/*</span>
03330 <span class="comment">     * Since zzzInvalidateDCCache was called with IDC_MOVEBLT specified,</span>
03331 <span class="comment">     * we must complete the WNDOBJ notification with a call to</span>
03332 <span class="comment">     * GreClientRgnDone.</span>
03333 <span class="comment">     *</span>
03334 <span class="comment">     * Note: in zzzInvalidateDCCache, it is necessary to call</span>
03335 <span class="comment">     * GreClientRgnUpdated even if gcountPWO is 0.  However,</span>
03336 <span class="comment">     * GreClientRgnDone only does something if gcountPWO is non-zero,</span>
03337 <span class="comment">     * so we can optimize slightly.</span>
03338 <span class="comment">     */</span>
03339     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a95">gcountPWO</a> != 0) {
03340         GreClientRgnDone(GCR_WNDOBJEXISTS);
03341     }
03342 
03343 UnlockAndExit:
03344 
03345     <span class="comment">/*</span>
03346 <span class="comment">     * If necessary, release the screen DC</span>
03347 <span class="comment">     */</span>
03348     <span class="keywordflow">if</span> (hdcScreen != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03349 
03350         <span class="comment">/*</span>
03351 <span class="comment">         * Reset the visrgn before we go...</span>
03352 <span class="comment">         */</span>
03353         GreSelectVisRgn(hdcScreen, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, SVR_DELETEOLD);
03354 
03355         <span class="comment">/*</span>
03356 <span class="comment">         * Make sure that the drawing we did in this DC does not affect</span>
03357 <span class="comment">         * any SPBs.  Clear the dirty rect.</span>
03358 <span class="comment">         */</span>
03359         GreGetBounds(hdcScreen, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);     <span class="comment">// NULL means reset</span>
03360     }
03361 
03362     <span class="comment">/*</span>
03363 <span class="comment">     * All the dirty work is done.  Ok to leave the critsects we entered</span>
03364 <span class="comment">     * earlier and dispatch any deferred Window Event notifications.</span>
03365 <span class="comment">     */</span>
03366     GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
03367     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
03368 
03369     <span class="keywordflow">return</span> fSyncPaint;
03370 }
03371 
03372 <span class="comment">/***************************************************************************\</span>
03373 <span class="comment">* xxxHandleWindowPosChanged</span>
03374 <span class="comment">*</span>
03375 <span class="comment">* DefWindowProc() HandleWindowPosChanged handler.</span>
03376 <span class="comment">*</span>
03377 <span class="comment">* History:</span>
03378 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
03379 <span class="comment">\***************************************************************************/</span>
03380 
<a name="l03381"></a><a class="code" href="../../d4/d1/userk_8h.html#a1622">03381</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1622">xxxHandleWindowPosChanged</a>(
03382     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
03383     PWINDOWPOS ppos)
03384 {
03385     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
03386 
03387     <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOCLIENTMOVE)) {
03388         POINT   pt;
03389         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndParent;
03390 
03391         pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
03392         pt.y = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
03393 
03394         pwndParent = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
03395         UserAssert(pwndParent);
03396 
03397         <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
03398             pt.x -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
03399             pt.y -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
03400         }
03401 
03402         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(
03403                 pwnd,
03404                 WM_MOVE,
03405                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03406                 MAKELONG(pt.x, pt.y));
03407     }
03408 
03409     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_STATECHANGE) || !(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOCLIENTSIZE)) {
03410 
03411         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
03412             <a class="code" href="../../d4/d1/userk_8h.html#a1505">xxxSendSizeMessage</a>(pwnd, SIZEICONIC);
03413         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>))
03414             <a class="code" href="../../d4/d1/userk_8h.html#a1505">xxxSendSizeMessage</a>(pwnd, SIZEFULLSCREEN);
03415         <span class="keywordflow">else</span>
03416             <a class="code" href="../../d4/d1/userk_8h.html#a1505">xxxSendSizeMessage</a>(pwnd, SIZENORMAL);
03417     }
03418 }
03419 
03420 <span class="comment">/***************************************************************************\</span>
03421 <span class="comment">* PWND GetRealOwner(pwnd)</span>
03422 <span class="comment">*</span>
03423 <span class="comment">* Returns the owner of pwnd, normalized so that it shares the same parent</span>
03424 <span class="comment">* of pwnd.</span>
03425 <span class="comment">*</span>
03426 <span class="comment">* History:</span>
03427 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
03428 <span class="comment">\***************************************************************************/</span>
03429 
<a name="l03430"></a><a class="code" href="../../d2/d8/swp_8c.html#a47">03430</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d2/d8/swp_8c.html#a47">GetRealOwner</a>(
03431     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
03432 {
03433     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
03434 
03435     <span class="comment">/*</span>
03436 <span class="comment">     * A frame window owned by itself is "unowned"</span>
03437 <span class="comment">     */</span>
03438     <span class="keywordflow">if</span> (pwnd != pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> &amp;&amp; (pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03439 
03440         <span class="comment">/*</span>
03441 <span class="comment">         * The NULL test is in case the owner is higher than the</span>
03442 <span class="comment">         * passed in window (e.g.  your owner IS your parent)</span>
03443 <span class="comment">         */</span>
03444         <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != pwndParent)
03445             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
03446     }
03447 
03448     <span class="keywordflow">return</span> pwnd;
03449 }
03450 
03451 <span class="comment">/***************************************************************************\</span>
03452 <span class="comment">*</span>
03453 <span class="comment">* Starting at pwnd (or pwndParent-&gt;spwndChild if pwnd == NULL), find</span>
03454 <span class="comment">* next window owned by pwndOwner</span>
03455 <span class="comment">*</span>
03456 <span class="comment">* History:</span>
03457 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
03458 <span class="comment">\***************************************************************************/</span>
03459 
<a name="l03460"></a><a class="code" href="../../d2/d8/swp_8c.html#a48">03460</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d2/d8/swp_8c.html#a48">NextOwnedWindow</a>(
03461     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
03462     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner,
03463     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent)
03464 {
03465     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03466         pwnd = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
03467         <span class="keywordflow">goto</span> loop;
03468     }
03469 
03470     <span class="keywordflow">while</span> ((pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03471 
03472 loop:
03473 
03474         <span class="comment">/*</span>
03475 <span class="comment">         * If owner of pwnd is pwndOwner, break out of here...</span>
03476 <span class="comment">         */</span>
03477         <span class="keywordflow">if</span> (pwndOwner == <a class="code" href="../../d2/d8/swp_8c.html#a47">GetRealOwner</a>(pwnd))
03478             <span class="keywordflow">break</span>;
03479     }
03480 
03481     <span class="keywordflow">return</span> pwnd;
03482 }
03483 
03484 <span class="comment">/***************************************************************************\</span>
03485 <span class="comment">*</span>
03486 <span class="comment">* Recursively enumerate owned windows starting from pwndRoot,</span>
03487 <span class="comment">* to set the state of WEFTOPMOST.  Doesn't actually diddle</span>
03488 <span class="comment">* this bit yet: the work gets done in zzzChangeStates():</span>
03489 <span class="comment">* instead we just set the WFTOGGLETOPMOST bit as appropriate.</span>
03490 <span class="comment">*</span>
03491 <span class="comment">* We can't diddle the state until the Z order changes are done,</span>
03492 <span class="comment">* or else GetTopMostWindow() and the like will do the wrong thing.</span>
03493 <span class="comment">*</span>
03494 <span class="comment">* History:</span>
03495 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
03496 <span class="comment">\***************************************************************************/</span>
03497 
<a name="l03498"></a><a class="code" href="../../d2/d8/swp_8c.html#a49">03498</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d8/swp_8c.html#a49">SetTopmost</a>(
03499     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndRoot,
03500     BOOL fTopmost)
03501 {
03502     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03503 
03504     <span class="comment">/*</span>
03505 <span class="comment">     * If the new state is different than the current state,</span>
03506 <span class="comment">     * then set the TOGGLETOPMOST bit, so it'll get toggled</span>
03507 <span class="comment">     * in ChangeStates().</span>
03508 <span class="comment">     */</span>
03509     UserAssert((fTopmost == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) || (fTopmost == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
03510     <span class="keywordflow">if</span> (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndRoot, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) ^ fTopmost) {
03511         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwndRoot, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>);
03512     } <span class="keywordflow">else</span> {
03513         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndRoot, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a577">WFTOGGLETOPMOST</a>);
03514     }
03515 
03516     pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03517     <span class="keywordflow">while</span> (pwnd = <a class="code" href="../../d2/d8/swp_8c.html#a48">NextOwnedWindow</a>(pwnd, pwndRoot, pwndRoot-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>)) {
03518                   <a class="code" href="../../d2/d8/swp_8c.html#a49">SetTopmost</a>(pwnd, fTopmost);
03519     }
03520 
03521 }
03522 
03523 <span class="comment">/*</span>
03524 <span class="comment"> * LATER: (hiroyama) #88810</span>
03525 <span class="comment"> * The IME code here broke the US regression test, so backing it up until we</span>
03526 <span class="comment"> * hit the problem on NT.</span>
03527 <span class="comment"> */</span>
03528 <span class="preprocessor">#ifdef LATER</span>
03529 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
03530 <span class="comment"> * IsBottomIMEWindow()</span>
03531 <span class="comment"> *</span>
03532 <span class="comment"> * returns TRUE if pwnd is IME window and its toplevel window is BOTTOMMOST</span>
03533 <span class="comment"> *</span>
03534 <span class="comment"> * Ported: 18-Apr-1997 Hiroyama     from Memphis</span>
03535 <span class="comment">\***************************************************************************/</span>
03536 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> IsBottomIMEWindow(
03537     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
03538 {
03539     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, CFIME) ||
03540             (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>])) {
03541         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT2 = pwnd;
03542         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTopOwner = pwnd;
03543         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesktop;
03544 
03545         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03546             <span class="comment">// Desktop is being created or not yet created</span>
03547             RIPMSG1(RIP_WARNING, <span class="stringliteral">"IsBottomIMEWindow: Desktop is being created or not yet created. pwnd=%#p\n"</span>,
03548                     pwnd);
03549             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03550         }
03551 
03552         pwndDesktop = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
03553 
03554         UserAssert(pwndDesktop);
03555 
03556         <span class="comment">/*</span>
03557 <span class="comment">         * search the toplevel owner window of the IME window.</span>
03558 <span class="comment">         */</span>
03559         <span class="keywordflow">while</span> (pwndT2 &amp;&amp; (pwndT2 != pwndDesktop)) {
03560             pwndTopOwner = pwndT2;
03561             pwndT2 = pwndT2-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
03562         }
03563         <span class="comment">/*</span>
03564 <span class="comment">         * TRUE if the toplevel owner window of the IME window is BOTTOMMOST</span>
03565 <span class="comment">         */</span>
03566         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTopOwner, WFBOTTOMMOST));
03567     }
03568     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03569 }
03570 
03571 <span class="comment">/***************************************************************************\</span>
03572 <span class="comment"> * ImeCheckBottomIMEWindow()</span>
03573 <span class="comment"> *</span>
03574 <span class="comment"> * returns TRUE if pwndT-&gt;spwndNext's owner is BOTTOMMOST</span>
03575 <span class="comment"> *</span>
03576 <span class="comment"> * Ported: 18-Apr-1997 Hiroyama     from Memphis</span>
03577 <span class="comment">\***************************************************************************/</span>
03578 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> ImeCheckBottomIMEWindow(
03579     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT)
03580 {
03581     <span class="comment">/*</span>
03582 <span class="comment">     * pwnd is IME window and its toplevel window is BOTTOMMOST</span>
03583 <span class="comment">     */</span>
03584     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesktop;
03585     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT2 = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
03586     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTopOwner = pwndT2;
03587 
03588     UserAssert(grpdeskRipInput != NULL &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> != NULL);
03589     pwndDesktop = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
03590 
03591     <span class="comment">/*</span>
03592 <span class="comment">     * check if toplevel owner window of pwnd-&gt;spwndNext is bottommost</span>
03593 <span class="comment">     */</span>
03594     <span class="keywordflow">while</span> (pwndT2 &amp;&amp; (pwndT2 != pwndDesktop)) {
03595         pwndTopOwner = pwndT2;
03596         pwndT2 = pwndT2-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
03597     }
03598 
03599     <span class="keywordflow">if</span> (pwndTopOwner &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTopOwner, WFBOTTOMMOST)) {
03600         <span class="comment">/*</span>
03601 <span class="comment">         * yes, pwndT is the last one whose toplevel window is *not* BOTTOMMOST</span>
03602 <span class="comment">         */</span>
03603         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03604     }
03605 
03606     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03607 }
03608 <span class="preprocessor">#endif  // LATER</span>
03609 <span class="preprocessor"></span>
03610 <span class="comment">/***************************************************************************\</span>
03611 <span class="comment">* CalcForegroundInsertAfter</span>
03612 <span class="comment">*</span>
03613 <span class="comment">* Calculates where to zorder a window that doesn't belong to the foreground</span>
03614 <span class="comment">* thread and is not topmost but wants to come to the top. This routine</span>
03615 <span class="comment">* calculates what "top" means under those conditions.</span>
03616 <span class="comment">*</span>
03617 <span class="comment">* 14-Sep-1992 ScottLu       Created.</span>
03618 <span class="comment">\***************************************************************************/</span>
03619 
<a name="l03620"></a><a class="code" href="../../d4/d1/userk_8h.html#a1614">03620</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1614">CalcForegroundInsertAfter</a>(
03621     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
03622 {
03623     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndInsertAfter, pwndInsertAfterSave;
03624     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndT;
03625     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiTop;
03626 <span class="preprocessor">#ifdef LATER    // see #88810</span>
03627 <span class="preprocessor"></span>    BOOLEAN     fImeOwnerIsBottom = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03628 <span class="preprocessor">#endif</span>
03629 <span class="preprocessor"></span>
03630     <span class="comment">/*</span>
03631 <span class="comment">     * If we're allowing this application to make this top</span>
03632 <span class="comment">     * level window foreground active, then this app may</span>
03633 <span class="comment">     * not be foreground yet, but we want any windows it</span>
03634 <span class="comment">     * zorders to appear on top because it is probably about</span>
03635 <span class="comment">     * to activate them (this is a guess!) If this is the case,</span>
03636 <span class="comment">     * let it do what it wants. A good example of this is an</span>
03637 <span class="comment">     * application like toolbook that creates a window without a</span>
03638 <span class="comment">     * caption, doesn't activate it, and wants that to appear on top.</span>
03639 <span class="comment">     */</span>
03640 
03641     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>)) {
03642         pwndInsertAfter = <a class="code" href="../../d2/d8/swp_8c.html#a32">GetLastNonBottomMostWindow</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03643     } <span class="keywordflow">else</span> {
03644         pwndInsertAfter = <a class="code" href="../../d2/d8/swp_8c.html#a35">GetLastTopMostWindow</a>();
03645 <span class="preprocessor">#ifdef LATER    // see #88810</span>
03646 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
03647             fImeOwnerIsBottom = IsBottomIMEWindow(pwnd);
03648             <span class="keywordflow">if</span> (fImeOwnerIsBottom) {
03649                 <span class="keywordflow">for</span> (pwndT = pwndInsertAfter; pwndT; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
03650                     <span class="keywordflow">if</span> (ImeCheckBottomIMEWindow(pwndT)) {
03651                         <span class="comment">/*</span>
03652 <span class="comment">                         * toplevel owner of pwndT-&gt;spwndNext is BOTTOMMOST</span>
03653 <span class="comment">                         */</span>
03654                         <span class="keywordflow">break</span>;
03655                     }
03656                     pwndInsertAfter = pwndT;
03657                 }
03658             }
03659         }
03660 <span class="preprocessor">#endif  // LATER</span>
03661 <span class="preprocessor"></span>    }
03662 
03663 
03664     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
03665 <span class="comment">//    if (hwnd-&gt;hwndParent == hwndDesktop)  -- Chicago conditional FritzS</span>
03666 
03667         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>) ||
03668                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi-&gt;W32PF_Flags &amp; W32PF_ALLOWFOREGROUNDACTIVATE)) {
03669 
03670             <span class="keywordflow">return</span> pwndInsertAfter;
03671         }
03672     }
03673 
03674     <span class="comment">/*</span>
03675 <span class="comment">     * If there is no foreground thread or this pwnd is of the foreground</span>
03676 <span class="comment">     * thread, then let it come to the top.</span>
03677 <span class="comment">     */</span>
03678     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03679         <span class="keywordflow">return</span> pwndInsertAfter;
03680 
03681     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)
03682         <span class="keywordflow">return</span> pwndInsertAfter;
03683 
03684     <span class="comment">/*</span>
03685 <span class="comment">     * This thread is not of the foreground queue, so search for a window</span>
03686 <span class="comment">     * of this thread to zorder above.</span>
03687 <span class="comment">     */</span>
03688     pwndT = ((pwndInsertAfter == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ?
03689             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> :
03690             pwndInsertAfter);
03691 
03692     <span class="comment">/*</span>
03693 <span class="comment">     * Remember the top insert after in case this first loop</span>
03694 <span class="comment">     *  fails to find a window</span>
03695 <span class="comment">     */</span>
03696     pwndInsertAfterSave = pwndInsertAfter;
03697 
03698     <span class="keywordflow">for</span> (; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
03699 
03700         <span class="comment">/*</span>
03701 <span class="comment">         * This window wants to come to the top if possible.</span>
03702 <span class="comment">         * If we're passing our own window, get out of this loop:</span>
03703 <span class="comment">         * by now we already have pwndInsertAfter set up to the</span>
03704 <span class="comment">         * last available window to insert after.</span>
03705 <span class="comment">         */</span>
03706         <span class="keywordflow">if</span> ((pwndT == pwnd) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>))
03707             <span class="keywordflow">break</span>;
03708 
03709         <span class="comment">/*</span>
03710 <span class="comment">         * If this window isn't owned by this thread, continue.</span>
03711 <span class="comment">         */</span>
03712         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) {
03713             pwndInsertAfter = pwndT;
03714             <span class="keywordflow">continue</span>;
03715         }
03716 
03717         <span class="comment">/*</span>
03718 <span class="comment">         * Don't want a window zordering below one of its top most windows</span>
03719 <span class="comment">         * if it isn't foreground.</span>
03720 <span class="comment">         */</span>
03721         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
03722             pwndInsertAfter = pwndT;
03723             <span class="keywordflow">continue</span>;
03724         }
03725 
03726 <span class="preprocessor">#ifdef LATER    // see #88810</span>
03727 <span class="preprocessor"></span>        <span class="comment">// FE_IME</span>
03728         <span class="keywordflow">if</span> (fImeOwnerIsBottom &amp;&amp; ImeCheckBottomIMEWindow(pwndT)) {
03729             <span class="comment">/*</span>
03730 <span class="comment">             * owner of pwndT-&gt;spwndNext is BOTTOMMOST</span>
03731 <span class="comment">             * so pwndT is the last one whose owner is not bottommost.</span>
03732 <span class="comment">             */</span>
03733             pwndInsertAfter = pwndT;
03734             <span class="keywordflow">continue</span>;
03735         }
03736         <span class="comment">// end FE_IME</span>
03737 <span class="preprocessor">#endif</span>
03738 <span class="preprocessor"></span>
03739         <span class="comment">/*</span>
03740 <span class="comment">         * Ok to change zorder of top level windows because of</span>
03741 <span class="comment">         * invisible windows laying around, but not children:</span>
03742 <span class="comment">         * applications would go nuts if we did this.</span>
03743 <span class="comment">         */</span>
03744         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndT)) {
03745             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
03746                 pwndInsertAfter = pwndT;
03747                 <span class="keywordflow">continue</span>;
03748             }
03749         }
03750 
03751         <span class="keywordflow">break</span>;
03752     }
03753 
03754     <span class="comment">/*</span>
03755 <span class="comment">     * If we didn't find a window in the previous loop,</span>
03756 <span class="comment">     * it means that the thread has no</span>
03757 <span class="comment">     * other sibling windows, so we need to put it after the</span>
03758 <span class="comment">     * foreground window (foreground thread). Search for the</span>
03759 <span class="comment">     * first unowned window of the foreground app to zorder</span>
03760 <span class="comment">     * after.</span>
03761 <span class="comment">     */</span>
03762     <span class="keywordflow">if</span> ((pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>)) {
03763         <span class="comment">/*</span>
03764 <span class="comment">         * This is our first guess in case nothing works out.</span>
03765 <span class="comment">         */</span>
03766         pwndInsertAfter = pwndInsertAfterSave;
03767 
03768         <span class="comment">/*</span>
03769 <span class="comment">         * Start below the last topmost or from the top if no</span>
03770 <span class="comment">         * topmost windows.</span>
03771 <span class="comment">         */</span>
03772         <span class="keywordflow">if</span> ((pwndT = pwndInsertAfter) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03773             pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
03774 
03775         <span class="comment">/*</span>
03776 <span class="comment">         * ptiTop is the pti of the active window in the foreground queue!</span>
03777 <span class="comment">         */</span>
03778         ptiTop = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03779         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03780             ptiTop = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
03781 
03782         <span class="keywordflow">for</span> (; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
03783 
03784             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>))
03785                 <span class="keywordflow">break</span>;
03786 
03787             <span class="comment">/*</span>
03788 <span class="comment">             * If not the top most thread, continue.</span>
03789 <span class="comment">             */</span>
03790             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT) != ptiTop)
03791                 <span class="keywordflow">continue</span>;
03792 
03793             <span class="comment">/*</span>
03794 <span class="comment">             * Found one of the foreground thread. Remember this</span>
03795 <span class="comment">             * as the next best guess. Try to find an unowned</span>
03796 <span class="comment">             * visible window, which would indicate the main</span>
03797 <span class="comment">             * window of the foreground thread. If owned,</span>
03798 <span class="comment">             * continue.</span>
03799 <span class="comment">             */</span>
03800             <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03801                 pwndInsertAfter = pwndT;
03802                 <span class="keywordflow">continue</span>;
03803             }
03804 
03805             <span class="comment">/*</span>
03806 <span class="comment">             * Unowned and of the foreground thread. Is it visible?</span>
03807 <span class="comment">             * If not, get out of here.</span>
03808 <span class="comment">             */</span>
03809             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
03810                 <span class="keywordflow">continue</span>;
03811 <span class="preprocessor">#ifdef LATER    // see #88810</span>
03812 <span class="preprocessor"></span>            <span class="comment">// FE_IME</span>
03813             <span class="keywordflow">if</span> (fImeOwnerIsBottom &amp;&amp; ImeCheckBottomIMEWindow(pwndT)) {
03814                 <span class="keywordflow">continue</span>;
03815             }
03816             <span class="comment">// end FE_IME</span>
03817 <span class="preprocessor">#endif</span>
03818 <span class="preprocessor"></span>
03819             <span class="comment">/*</span>
03820 <span class="comment">             * Best possible match so far: unowned visible window</span>
03821 <span class="comment">             * of the foreground thread.</span>
03822 <span class="comment">             */</span>
03823             pwndInsertAfter = pwndT;
03824         }
03825     }
03826 
03827     UserAssert(pwnd != pwndInsertAfter);
03828 
03829     <span class="keywordflow">return</span> pwndInsertAfter;
03830 }
03831 
03832 <span class="comment">/***************************************************************************\</span>
03833 <span class="comment">* GetTopMostInsertAfter</span>
03834 <span class="comment">*</span>
03835 <span class="comment">* We don't want any one to get in front of a hard error box, except menus,</span>
03836 <span class="comment">*  screen savers, etc.</span>
03837 <span class="comment">*</span>
03838 <span class="comment">* Don't call it directly, use the GETTOPMOSTINSERTAFTER macro to avoid</span>
03839 <span class="comment">*  the call when there is no hard error box up (gHardErrorHandler.pti == NULL).</span>
03840 <span class="comment">*</span>
03841 <span class="comment">* 04-25-96 GerardoB Created</span>
03842 <span class="comment">\***************************************************************************/</span>
<a name="l03843"></a><a class="code" href="../../d4/d1/userk_8h.html#a1612">03843</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1612">GetTopMostInsertAfter</a> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
03844 {
03845     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
03846     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
03847     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
03848     WORD wfnid;
03849 
03850     <span class="comment">/*</span>
03851 <span class="comment">     * If you hit this assertion, you're probably not using the</span>
03852 <span class="comment">     *  GETTOPMOSTINSERTAFTER macro to make this call.</span>
03853 <span class="comment">     */</span>
03854     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03855     <span class="comment">/*</span>
03856 <span class="comment">     * pwnd: Menu and switch (ALT-TAB) windows can go on top.</span>
03857 <span class="comment">     */</span>
03858     wfnid = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd);
03859     <span class="keywordflow">if</span> ((wfnid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>) || (wfnid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a221">FNID_SWITCH</a>)) {
03860         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03861     }
03862 
03863     <span class="comment">/*</span>
03864 <span class="comment">     * pti: If this is the error handler thread, don't bother any longer.</span>
03865 <span class="comment">     *      Screen saver can go on top too.</span>
03866 <span class="comment">     */</span>
03867     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03868     UserAssert(ptiCurrent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03869 
03870     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_SCREENSAVER)) {
03871         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03872     }
03873 
03874     <span class="comment">/*</span>
03875 <span class="comment">     * pdesk: Leave the logon desktop alone.</span>
03876 <span class="comment">     *        Make sure the hard error box is on this desktop</span>
03877 <span class="comment">     */</span>
03878     pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
03879     UserAssert(pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03880     UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>);
03881     UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>);
03882 
03883     <span class="keywordflow">if</span> ((pdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>)
03884             || (pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>)) {
03885         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03886     }
03887 
03888     <span class="comment">/*</span>
03889 <span class="comment">     * Walk the window list looking for the hard error box.</span>
03890 <span class="comment">     * Start searching from the current desktop's first child.</span>
03891 <span class="comment">     * Note that the harderror box migth not be created yet.</span>
03892 <span class="comment">     */</span>
03893     UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>);
03894     UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>);
03895 
03896     <span class="keywordflow">for</span> (pwndT = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
03897             pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
03898 
03899         <span class="comment">/*</span>
03900 <span class="comment">         * Hard error boxes are always top most.</span>
03901 <span class="comment">         */</span>
03902         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
03903             <span class="keywordflow">break</span>;
03904         }
03905 
03906         <span class="comment">/*</span>
03907 <span class="comment">         * If this window was created by the hard error handler thread,</span>
03908 <span class="comment">         *   then this is it</span>
03909 <span class="comment">         */</span>
03910         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)) {
03911             <span class="keywordflow">return</span> pwndT;
03912         }
03913     }
03914 
03915     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03916 }
03917 
03918 <span class="comment">/***************************************************************************\</span>
03919 <span class="comment">*</span>
03920 <span class="comment">* This routine maps the special HWND_* values of ppos-&gt;hwndInsertAfter,</span>
03921 <span class="comment">* and returns whether or not the window's owner group should be labelled</span>
03922 <span class="comment">* TOPMOST or not, or left alone.</span>
03923 <span class="comment">*</span>
03924 <span class="comment">* Here are the TOPMOST rules.  If pwndInsertAfter is:</span>
03925 <span class="comment">*</span>
03926 <span class="comment">* 1. HWND_BOTTOM == (HWND)1:</span>
03927 <span class="comment">*</span>
03928 <span class="comment">*    The group is made non-TOPMOST.</span>
03929 <span class="comment">*</span>
03930 <span class="comment">* 2. HWND_TOPMOST == (HWND)-1:</span>
03931 <span class="comment">*</span>
03932 <span class="comment">*    hwndInsertAfter is set to HWND_TOP, and the group is made TOPMOST.</span>
03933 <span class="comment">*</span>
03934 <span class="comment">* 3. HWND_NOTOPMOST == (HWND)-2:</span>
03935 <span class="comment">*</span>
03936 <span class="comment">*    Treated same as HWND_TOP, except that the TOPMOST bit is cleared.</span>
03937 <span class="comment">*    and the entire group is made non-topmost.</span>
03938 <span class="comment">*    Used to make a topmost window non-topmost, but still leave it at</span>
03939 <span class="comment">*    the top of the non-topmost pile.</span>
03940 <span class="comment">*    The group is not changed if the window is already non-topmost.</span>
03941 <span class="comment">*</span>
03942 <span class="comment">* 4. HWND_TOP == (HWND)NULL:</span>
03943 <span class="comment">*</span>
03944 <span class="comment">*    pwndInsertAfter is set to the last TOPMOST window if pwnd</span>
03945 <span class="comment">*    is not itself TOPMOST.  If pwnd IS TOPMOST, then pwndInsertAfter</span>
03946 <span class="comment">*    remains HWND_TOP.</span>
03947 <span class="comment">*</span>
03948 <span class="comment">* 5. A TOPMOST window:</span>
03949 <span class="comment">*</span>
03950 <span class="comment">*    If a window is being inserted among the TOPMOST windows, then</span>
03951 <span class="comment">*    the group becomes topmost too, EXCEPT if it's being inserted behind</span>
03952 <span class="comment">*    the bottom-most topmost window: in that case the window retains</span>
03953 <span class="comment">*    its current TOPMOST bit.</span>
03954 <span class="comment">*</span>
03955 <span class="comment">* 6. A non-TOPMOST window:</span>
03956 <span class="comment">*</span>
03957 <span class="comment">*    If a window is being inserted among non-TOPMOST windows, the group is made</span>
03958 <span class="comment">*    non-TOPMOST and inserted there.</span>
03959 <span class="comment">*</span>
03960 <span class="comment">* Whenever a group is made TOPMOST, only that window and its ownees are made</span>
03961 <span class="comment">* topmost.  When a group is made NOTOPMOST, the entire window is made non-topmost.</span>
03962 <span class="comment">*</span>
03963 <span class="comment">* This routine must NOT set SWP_NOZORDER if the topmost state is changing:</span>
03964 <span class="comment">* this would prevent the topmost bits from getting toggled in ChangeStates.</span>
03965 <span class="comment">*</span>
03966 <span class="comment">* History:</span>
03967 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
03968 <span class="comment">\***************************************************************************/</span>
03969 
<a name="l03970"></a><a class="code" href="../../d2/d8/swp_8c.html#a52">03970</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d8/swp_8c.html#a52">CheckTopmost</a>(
03971     PWINDOWPOS ppos)
03972 {
03973     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, pwndInsertAfter, pwndT;
03974 
03975     <span class="comment">/*</span>
03976 <span class="comment">     * BACKWARD COMPATIBILITY HACK</span>
03977 <span class="comment">     *</span>
03978 <span class="comment">     * If we're activating a window and Z-ordering too, we must ignore the</span>
03979 <span class="comment">     * specified Z order and bring the window to the top, EXCEPT in the</span>
03980 <span class="comment">     * following conditions:</span>
03981 <span class="comment">     *</span>
03982 <span class="comment">     * 1.  The window is already active (in which case, the activation code</span>
03983 <span class="comment">     *    will not be bringing the window to the top)</span>
03984 <span class="comment">     *</span>
03985 <span class="comment">     * 2.  HWND_TOP or HWND_NOTOPMOST is specified.  This allows us to</span>
03986 <span class="comment">     *    activate and move to topmost or nontopmost at the same time.</span>
03987 <span class="comment">     *</span>
03988 <span class="comment">     * NOTE: It would have been possible to modify ActivateWindow() to</span>
03989 <span class="comment">     * take a flag to prevent it from ever doing the BringWindowToTop,</span>
03990 <span class="comment">     * thus allowing SetWindowPos() to properly honor pwndInsertBehind</span>
03991 <span class="comment">     * AND activation, but this change was considered too late in the</span>
03992 <span class="comment">     * game -- there could be problems with existing 3.1 apps, such as</span>
03993 <span class="comment">     * PenWin, etc.</span>
03994 <span class="comment">     */</span>
03995     pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd);
03996     <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOACTIVATE) &amp;&amp;
03997             !(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOZORDER) &amp;&amp;
03998              (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter != HWND_TOPMOST &amp;&amp;
03999              <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter != HWND_NOTOPMOST) &amp;&amp;
04000              (pwnd != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq-&gt;spwndActive)) {
04001         <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = HWND_TOP;
04002     }
04003 
04004     <span class="comment">/*</span>
04005 <span class="comment">     * If we're not Z-ordering, don't do anything.</span>
04006 <span class="comment">     */</span>
04007     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOZORDER)
04008         <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a0">CTM_NOCHANGE</a>;
04009 
04010 
04011     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter == HWND_BOTTOM) {
04012 
04013         <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a2">CTM_NOTOPMOST</a>;
04014 
04015     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter == HWND_NOTOPMOST) {
04016 
04017         <span class="comment">/*</span>
04018 <span class="comment">         * If currently topmost, move to top of non-topmost list.</span>
04019 <span class="comment">         * Otherwise, no change.</span>
04020 <span class="comment">         *</span>
04021 <span class="comment">         * Note that we don't set SWP_NOZORDER -- we still need to</span>
04022 <span class="comment">         * check the TOGGLETOPMOST bits in ChangeStates()</span>
04023 <span class="comment">         */</span>
04024         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
04025 
04026             pwndT = <a class="code" href="../../d2/d8/swp_8c.html#a35">GetLastTopMostWindow</a>();
04027             <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
04028 
04029             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter == <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd) {
04030                 pwndT = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">_GetWindow</a>(pwnd, GW_HWNDPREV);
04031                 <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
04032             }
04033 
04034         } <span class="keywordflow">else</span> {
04035 
04036             pwndT = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">_GetWindow</a>(pwnd, GW_HWNDPREV);
04037             <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
04038         }
04039 
04040         <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a2">CTM_NOTOPMOST</a>;
04041 
04042     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter == HWND_TOPMOST) {
04043         pwndT = <a class="code" href="../../d4/d1/userk_8h.html#a573">GETTOPMOSTINSERTAFTER</a>(pwnd);
04044         <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04045             <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
04046         } <span class="keywordflow">else</span> {
04047             <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = HWND_TOP;
04048         }
04049 
04050         <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a1">CTM_TOPMOST</a>;
04051 
04052     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter == HWND_TOP) {
04053 
04054         <span class="comment">/*</span>
04055 <span class="comment">         * If we're not topmost, position ourself after</span>
04056 <span class="comment">         * the last topmost window.</span>
04057 <span class="comment">         * Otherwise, make sure that no one gets in front</span>
04058 <span class="comment">         *  of a hard error box.</span>
04059 <span class="comment">         */</span>
04060         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
04061             pwndT = <a class="code" href="../../d4/d1/userk_8h.html#a573">GETTOPMOSTINSERTAFTER</a>(pwnd);
04062             <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04063                 <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
04064             }
04065             <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a0">CTM_NOCHANGE</a>;
04066         }
04067 
04068         <span class="comment">/*</span>
04069 <span class="comment">         * Calculate the window to zorder after for this window, taking</span>
04070 <span class="comment">         * into account foreground status.</span>
04071 <span class="comment">         */</span>
04072         pwndInsertAfter = <a class="code" href="../../d4/d1/userk_8h.html#a1614">CalcForegroundInsertAfter</a>(pwnd);
04073         <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndInsertAfter);
04074 
04075         <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a0">CTM_NOCHANGE</a>;
04076     }
04077 
04078     <span class="comment">/*</span>
04079 <span class="comment">     * If we're being inserted after the last topmost window,</span>
04080 <span class="comment">     * then don't change the topmost status.</span>
04081 <span class="comment">     */</span>
04082     pwndT = <a class="code" href="../../d2/d8/swp_8c.html#a35">GetLastTopMostWindow</a>();
04083     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT))
04084         <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a0">CTM_NOCHANGE</a>;
04085 
04086     <span class="comment">/*</span>
04087 <span class="comment">     * Otherwise, if we're inserting a TOPMOST among non-TOPMOST,</span>
04088 <span class="comment">     * or vice versa, change the status appropriately.</span>
04089 <span class="comment">     */</span>
04090     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
04091 
04092         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
04093             <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a1">CTM_TOPMOST</a>;
04094         }
04095 
04096         pwndT = <a class="code" href="../../d4/d1/userk_8h.html#a573">GETTOPMOSTINSERTAFTER</a>(pwnd);
04097         <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04098             <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
04099         }
04100 
04101     } <span class="keywordflow">else</span> {
04102 
04103         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>))
04104             <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a2">CTM_NOTOPMOST</a>;
04105     }
04106 
04107     <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a0">CTM_NOCHANGE</a>;
04108 }
04109 
04110 <span class="comment">/***************************************************************************\</span>
04111 <span class="comment">* IsOwnee(pwndOwnee, pwndOwner)</span>
04112 <span class="comment">*</span>
04113 <span class="comment">* Returns TRUE if pwndOwnee is owned by pwndOwner</span>
04114 <span class="comment">*</span>
04115 <span class="comment">*</span>
04116 <span class="comment">* History:</span>
04117 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
04118 <span class="comment">\***************************************************************************/</span>
04119 
<a name="l04120"></a><a class="code" href="../../d2/d8/swp_8c.html#a53">04120</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a53">IsOwnee</a>(
04121     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwnee,
04122     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner)
04123 {
04124     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
04125 
04126     <span class="keywordflow">while</span> (pwndOwnee != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04127 
04128         <span class="comment">/*</span>
04129 <span class="comment">         * See if pwndOwnee is a child of pwndOwner...</span>
04130 <span class="comment">         */</span>
04131         <span class="keywordflow">for</span> (pwnd = pwndOwnee; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
04132             <span class="keywordflow">if</span> (pwnd == pwndOwner)
04133                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04134         }
04135 
04136         <span class="comment">/*</span>
04137 <span class="comment">         * If the window doesn't own itself, then set the owner</span>
04138 <span class="comment">         * to itself.</span>
04139 <span class="comment">         */</span>
04140         pwndOwnee = (pwndOwnee-&gt;spwndOwner != pwndOwnee ?
04141                 pwndOwnee-&gt;spwndOwner : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04142     }
04143 
04144     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04145 }
04146 
04147 <span class="comment">/***************************************************************************\</span>
04148 <span class="comment">*</span>
04149 <span class="comment">* History:</span>
04150 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
04151 <span class="comment">\***************************************************************************/</span>
04152 
<a name="l04153"></a><a class="code" href="../../d2/d8/swp_8c.html#a54">04153</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a54">IsBehind</a>(
04154     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
04155     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndReference)
04156 {
04157 
04158     <span class="comment">/*</span>
04159 <span class="comment">     * Starting at pwnd, move down until we reach the end of the window</span>
04160 <span class="comment">     * list, or until we reach pwndReference.  If we encounter pwndReference,</span>
04161 <span class="comment">     * then pwnd is above pwndReference, so return FALSE.  If we get to the</span>
04162 <span class="comment">     * end of the window list, pwnd is behind, so return TRUE.</span>
04163 <span class="comment">     */</span>
04164     <span class="keywordflow">if</span> (pwndReference == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_TOP)
04165         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04166 
04167     <span class="keywordflow">if</span> (pwndReference == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_BOTTOM)
04168         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04169 
04170     <span class="keywordflow">for</span> ( ; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
04171         <span class="keywordflow">if</span> (pwnd == pwndReference)
04172             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04173     }
04174 
04175     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04176 }
04177 
04178 <span class="comment">/***************************************************************************\</span>
04179 <span class="comment">*</span>
04180 <span class="comment">* Add pwnd to the SMWP.  pwndChange is the "real" pwnd being repositioned</span>
04181 <span class="comment">* and pwndInsertAfter is the place where it's being inserted.</span>
04182 <span class="comment">*</span>
04183 <span class="comment">* pwndTopInsert is the window handle where the top of the owner tree should be</span>
04184 <span class="comment">* inserted.  The special value of (HWND)-2 is used to indicate recursion, in</span>
04185 <span class="comment">* which case newly added SWPs are added to the previous element.</span>
04186 <span class="comment">*</span>
04187 <span class="comment">* History:</span>
04188 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
04189 <span class="comment">\***************************************************************************/</span>
04190 
<a name="l04191"></a><a class="code" href="../../d2/d8/swp_8c.html#a55">04191</a> <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> <a class="code" href="../../d2/d8/swp_8c.html#a55">AddSelfAndOwnees</a>(
04192     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp,
04193     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
04194     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndChange,
04195     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndInsertAfter,
04196     <span class="keywordtype">int</span>   iTop)
04197 {
04198     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndChgOwnee;
04199     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
04200     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fChgOwneeInserted;
04201     <a class="code" href="../../d2/d2/structtagCVR.html">CVR</a>  *pcvr;
04202 
04203     <span class="comment">/*</span>
04204 <span class="comment">     * The general idea here is to first add our ownees, then add ourself.</span>
04205 <span class="comment">     * When we add our ownees though, we add them as appropriate based</span>
04206 <span class="comment">     * on the pwndInsertAfter parameter.</span>
04207 <span class="comment">     *</span>
04208 <span class="comment">     * Find out if any of our ownees are on a direct path between pwndChange</span>
04209 <span class="comment">     * and the root of the owner tree.  If one is, then its Z order relative</span>
04210 <span class="comment">     * to its owner-siblings will be changing.  If none are, then</span>
04211 <span class="comment">     * we want to add our ownees to the list in their current order.</span>
04212 <span class="comment">     */</span>
04213     pwndChgOwnee = pwndChange;
04214     <span class="keywordflow">while</span> (pwndChgOwnee != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04215 
04216         pwndT = <a class="code" href="../../d2/d8/swp_8c.html#a47">GetRealOwner</a>(pwndChgOwnee);
04217 
04218         <span class="keywordflow">if</span> (pwnd == pwndT)
04219             <span class="keywordflow">break</span>;
04220 
04221         pwndChgOwnee = pwndT;
04222     }
04223 
04224     <span class="comment">/*</span>
04225 <span class="comment">     * Now enumerate all other ownees, and insert them in their</span>
04226 <span class="comment">     * current order.</span>
04227 <span class="comment">     */</span>
04228     fChgOwneeInserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04229     pwndT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04230     <span class="keywordflow">while</span> ((pwndT = <a class="code" href="../../d2/d8/swp_8c.html#a48">NextOwnedWindow</a>(pwndT, pwnd, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04231 
04232         <span class="comment">/*</span>
04233 <span class="comment">         * If these siblings are to be reordered, compare the sibling's</span>
04234 <span class="comment">         * current Z order with pwndInsertAfter.</span>
04235 <span class="comment">         */</span>
04236         <span class="keywordflow">if</span> (pwndChgOwnee == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04237 
04238             <span class="comment">/*</span>
04239 <span class="comment">             * No Z change for our ownees: just add them in their current order</span>
04240 <span class="comment">             */</span>
04241             psmwp = <a class="code" href="../../d2/d8/swp_8c.html#a55">AddSelfAndOwnees</a>(psmwp, pwndT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, iTop);
04242 
04243         } <span class="keywordflow">else</span> {
04244 
04245             <span class="comment">/*</span>
04246 <span class="comment">             * If we haven't already inserted the ChgOwnee, and the</span>
04247 <span class="comment">             * enumerated owner-sibling is behind pwndInsertAfter, then</span>
04248 <span class="comment">             * add ChgOwnee.</span>
04249 <span class="comment">             */</span>
04250             <span class="keywordflow">if</span> (!fChgOwneeInserted &amp;&amp; <a class="code" href="../../d2/d8/swp_8c.html#a54">IsBehind</a>(pwndT, pwndInsertAfter)) {
04251 
04252                 psmwp = <a class="code" href="../../d2/d8/swp_8c.html#a55">AddSelfAndOwnees</a>(psmwp,
04253                                          pwndChgOwnee,
04254                                          pwndChange,
04255                                          pwndInsertAfter,
04256                                          iTop);
04257 
04258                 <span class="keywordflow">if</span> (psmwp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04259                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04260 
04261                 fChgOwneeInserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04262             }
04263 
04264             <span class="keywordflow">if</span> (pwndT != pwndChgOwnee) {
04265 
04266                 <span class="comment">/*</span>
04267 <span class="comment">                 * Not the change ownee: add it in its current order.</span>
04268 <span class="comment">                 */</span>
04269                 psmwp = <a class="code" href="../../d2/d8/swp_8c.html#a55">AddSelfAndOwnees</a>(psmwp, pwndT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, iTop);
04270             }
04271         }
04272 
04273         <span class="keywordflow">if</span> (psmwp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04274             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04275     }
04276 
04277     <span class="comment">/*</span>
04278 <span class="comment">     * If we never added the change ownee in the loop, add it now.</span>
04279 <span class="comment">     */</span>
04280     <span class="keywordflow">if</span> ((pwndChgOwnee != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !fChgOwneeInserted) {
04281 
04282         psmwp = <a class="code" href="../../d2/d8/swp_8c.html#a55">AddSelfAndOwnees</a>(psmwp,
04283                                  pwndChgOwnee,
04284                                  pwndChange,
04285                                  pwndInsertAfter,
04286                                  iTop);
04287 
04288         <span class="keywordflow">if</span> (psmwp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04289             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04290     }
04291 
04292     <span class="comment">/*</span>
04293 <span class="comment">     * Finally, add this window to the list.</span>
04294 <span class="comment">     */</span>
04295     psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1619">_DeferWindowPos</a>(psmwp, pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04296             0, 0, 0, 0, SWP_NOSIZE | SWP_NOMOVE | SWP_NOACTIVATE);
04297 
04298     <span class="keywordflow">if</span> (psmwp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04299         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04300 
04301     <span class="comment">/*</span>
04302 <span class="comment">     * If we aren't inserting the topmost entry,</span>
04303 <span class="comment">     * link this entry to the previous one.</span>
04304 <span class="comment">     * The topmost entry will get set by our caller.</span>
04305 <span class="comment">     */</span>
04306     <span class="keywordflow">if</span> (iTop != psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> - 1) {
04307         pcvr = &amp;psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> - 1];
04308         pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = (pcvr - 1)-&gt;pos.hwnd;
04309     }
04310     <span class="keywordflow">return</span> psmwp;
04311 }
04312 
04313 <span class="comment">/***************************************************************************\</span>
04314 <span class="comment">*</span>
04315 <span class="comment">* ZOrderByOwner2 - Add the current window and all it owns to the SWP list,</span>
04316 <span class="comment">* and arrange them in the new Z ordering.  Called only if the Z order of the</span>
04317 <span class="comment">* window is changing.</span>
04318 <span class="comment">*</span>
04319 <span class="comment">* History:</span>
04320 <span class="comment">* 04-Mar-1992 MikeKe    From win31</span>
04321 <span class="comment">\***************************************************************************/</span>
04322 
<a name="l04323"></a><a class="code" href="../../d2/d8/swp_8c.html#a56">04323</a> <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> <a class="code" href="../../d2/d8/swp_8c.html#a56">ZOrderByOwner2</a>(
04324     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp,
04325     <span class="keywordtype">int</span>   iTop)
04326 {
04327     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>       pwndT;
04328     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>       pwndOwnerRoot;
04329     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>       pwndTopInsert;
04330     PWINDOWPOS <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>;
04331     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>       pwnd;
04332     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>       pwndInsertAfter;
04333     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       fHasOwnees;
04334 
04335     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> = &amp;psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[iTop].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>;
04336 
04337     <span class="comment">/*</span>
04338 <span class="comment">     * If inside message box processing, not Z ordering,</span>
04339 <span class="comment">     * or if SWP_NOOWNERZORDER specified, all done.</span>
04340 <span class="comment">     */</span>
04341     <span class="comment">// LATER 04-Mar-1992 MikeKe</span>
04342     <span class="comment">// do we have a substitue for fMessageBox</span>
04343     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOZORDER) ||
04344         (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOOWNERZORDER)) {
04345 
04346         <span class="keywordflow">return</span> psmwp;
04347     }
04348 
04349     pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd);
04350     pwndInsertAfter = <a class="code" href="../../d2/d8/swp_8c.html#a25">PWInsertAfter</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter);
04351 
04352     fHasOwnees = (<a class="code" href="../../d2/d8/swp_8c.html#a48">NextOwnedWindow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwnd, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04353 
04354     <span class="comment">/*</span>
04355 <span class="comment">     * If the window isn't owned, and it doesn't own any other window,</span>
04356 <span class="comment">     * do nothing.</span>
04357 <span class="comment">     */</span>
04358     <span class="keywordflow">if</span> (!pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> &amp;&amp; !fHasOwnees)
04359         <span class="keywordflow">return</span> psmwp;
04360 
04361     <span class="comment">/*</span>
04362 <span class="comment">     * Find the unowned window to start building the tree from.</span>
04363 <span class="comment">     * This is easy: just zip upwards until we find a window with no owner.</span>
04364 <span class="comment">     */</span>
04365     pwndOwnerRoot = pwndT = pwnd;
04366     <span class="keywordflow">while</span> ((pwndT = <a class="code" href="../../d2/d8/swp_8c.html#a47">GetRealOwner</a>(pwndT)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04367         pwndOwnerRoot = pwndT;
04368 
04369     <span class="comment">/*</span>
04370 <span class="comment">     * We need to calculate what pwndInsertAfter should be for</span>
04371 <span class="comment">     * the first (topmost) window of the SWP list.</span>
04372 <span class="comment">     *</span>
04373 <span class="comment">     * If pwndInsertAfter is part of the owner tree we'll be building,</span>
04374 <span class="comment">     * then we want to reorder windows within the owner group, so the</span>
04375 <span class="comment">     * entire group should maintain it's relative order.</span>
04376 <span class="comment">     *</span>
04377 <span class="comment">     * If pwndInsertAfter is part of another owner tree, then we want</span>
04378 <span class="comment">     * the whole group relative to that.</span>
04379 <span class="comment">     *</span>
04380 <span class="comment">     * If pwndInsertAfter is HWND_BOTTOM, then we want the whole</span>
04381 <span class="comment">     * group to go to the bottom, so we position it relative to</span>
04382 <span class="comment">     * the bottom most window that is not part of the tree.  We also</span>
04383 <span class="comment">     * want to put pwnd on the bottom relative to its owner siblings.</span>
04384 <span class="comment">     *</span>
04385 <span class="comment">     * If pwndInsertAfter is HWND_TOP, then bring the whole group</span>
04386 <span class="comment">     * to the top, as well as bringing pwnd to the top relative to its</span>
04387 <span class="comment">     * owner siblings.</span>
04388 <span class="comment">     *</span>
04389 <span class="comment">     * Assume the topmost of group is same as topmost</span>
04390 <span class="comment">     * (true for all cases except where rearranging subtree of group)</span>
04391 <span class="comment">     */</span>
04392     pwndTopInsert = pwndInsertAfter;
04393     <span class="keywordflow">if</span> (pwndInsertAfter == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_TOP) {
04394 
04395         <span class="comment">/*</span>
04396 <span class="comment">         * Bring the whole group to the top: nothing fancy to do.</span>
04397 <span class="comment">         */</span>
04398 
04399     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwndInsertAfter == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_BOTTOM) {
04400 
04401         <span class="comment">/*</span>
04402 <span class="comment">         * Put the whole group on the bottom.  pwndTopInsert should</span>
04403 <span class="comment">         * be the bottommost window unowned by pwndOwnerRoot.</span>
04404 <span class="comment">         */</span>
04405         <span class="keywordflow">for</span> (pwndT = pwnd-&gt;spwndParent-&gt;spwndChild;
04406                 (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>); pwndT = pwndT-&gt;spwndNext) {
04407 
04408             <span class="comment">/*</span>
04409 <span class="comment">             * If it's not owned, then this is the bottommost so far.</span>
04410 <span class="comment">             */</span>
04411             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/swp_8c.html#a53">IsOwnee</a>(pwndT, pwndOwnerRoot))
04412                 pwndTopInsert = pwndT;
04413         }
04414 
04415         <span class="comment">/*</span>
04416 <span class="comment">         * If there were no other windows not in our tree,</span>
04417 <span class="comment">         * then there is no Z ordering change to be done.</span>
04418 <span class="comment">         */</span>
04419         <span class="keywordflow">if</span> (pwndTopInsert == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_BOTTOM)
04420             <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags |= SWP_NOZORDER;
04421 
04422     } <span class="keywordflow">else</span> {
04423 
04424         <span class="comment">/*</span>
04425 <span class="comment">         * pwndInsertAfter is a window.  Compute pwndTopInsert</span>
04426 <span class="comment">         */</span>
04427         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a53">IsOwnee</a>(pwndInsertAfter, pwndOwnerRoot)) {
04428 
04429             <span class="comment">/*</span>
04430 <span class="comment">             * SPECIAL CASE: If we do not own any windows, and we're</span>
04431 <span class="comment">             * being moved within our owner group in such a way that</span>
04432 <span class="comment">             * we remain above our owner, then no other windows will</span>
04433 <span class="comment">             * be moving with us, and we can just exit</span>
04434 <span class="comment">             * without building our tree.  This can save a LOT of</span>
04435 <span class="comment">             * extra work, especially with the MS apps CBT tutorials,</span>
04436 <span class="comment">             * which do this kind of thing a lot.</span>
04437 <span class="comment">             */</span>
04438             <span class="keywordflow">if</span> (!fHasOwnees) {
04439 
04440                 <span class="comment">/*</span>
04441 <span class="comment">                 * Make sure we will still be above our owner by searching</span>
04442 <span class="comment">                 * for our owner starting from pwndInsertAfter.  If we</span>
04443 <span class="comment">                 * find our owner, then pwndInsertAfter is above it.</span>
04444 <span class="comment">                 */</span>
04445                 <span class="keywordflow">for</span> (pwndT = pwndInsertAfter; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04446                         pwndT = pwndT-&gt;spwndNext) {
04447 
04448                     <span class="keywordflow">if</span> (pwndT == pwnd-&gt;spwndOwner)
04449                         <span class="keywordflow">return</span> psmwp;
04450                 }
04451             }
04452 
04453             <span class="comment">/*</span>
04454 <span class="comment">             * Part of same group: Find out which window the topmost</span>
04455 <span class="comment">             * of the group is currently inserted behind.</span>
04456 <span class="comment">             */</span>
04457             pwndTopInsert = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_TOP;
04458             <span class="keywordflow">for</span> (pwndT = pwnd-&gt;spwndParent-&gt;spwndChild; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04459                     pwndT = pwndT-&gt;spwndNext) {
04460 
04461                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a53">IsOwnee</a>(pwndT, pwndOwnerRoot))
04462                     <span class="keywordflow">break</span>;
04463 
04464                 pwndTopInsert = pwndT;
04465             }
04466         }
04467     }
04468 
04469     <span class="comment">/*</span>
04470 <span class="comment">     * Okay, now go recursively build the owned window list...</span>
04471 <span class="comment">     */</span>
04472     <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOZORDER)) {
04473 
04474         <span class="comment">/*</span>
04475 <span class="comment">         * First "delete" the last entry (the one we're sorting with)</span>
04476 <span class="comment">         */</span>
04477         psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>--;
04478 
04479         psmwp = <a class="code" href="../../d2/d8/swp_8c.html#a55">AddSelfAndOwnees</a>(psmwp,
04480                                  pwndOwnerRoot,
04481                                  pwnd,
04482                                  pwndInsertAfter,
04483                                  iTop);
04484 
04485         <span class="comment">/*</span>
04486 <span class="comment">         * Now set the place where the whole group is going.</span>
04487 <span class="comment">         */</span>
04488         <span class="keywordflow">if</span> (psmwp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04489             psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[iTop].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndTopInsert);
04490     }
04491 
04492     <span class="keywordflow">return</span> psmwp;
04493 }
04494 
04495 <span class="comment">/***************************************************************************\</span>
04496 <span class="comment">* TrackBackground</span>
04497 <span class="comment">*</span>
04498 <span class="comment">* Adjust zorder if we're crossing a TOPMOST boundary. Make sure that a</span>
04499 <span class="comment">* non-topmost window in a background thread doesn't come in front of</span>
04500 <span class="comment">* non-topmost windows in the foreground thread.</span>
04501 <span class="comment">\***************************************************************************/</span>
04502 
<a name="l04503"></a><a class="code" href="../../d2/d8/swp_8c.html#a57">04503</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a57">TrackBackground</a>(WINDOWPOS *ppos, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPrev, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
04504 {
04505     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
04506 
04507     <span class="keywordflow">if</span> (pwndPrev == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04508         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04509 
04510     <span class="comment">/*</span>
04511 <span class="comment">     * Is this window foreground? If so, let it go. For wow apps,</span>
04512 <span class="comment">     * check to see if any thread of the process is foreground.</span>
04513 <span class="comment">     */</span>
04514     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
04515 
04516         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04517             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04518 
04519         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)
04520             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04521 
04522     } <span class="keywordflow">else</span> {
04523 
04524         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>)
04525             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04526     }
04527 
04528     <span class="comment">/*</span>
04529 <span class="comment">     * Make sure the previous window is either staying or becoming</span>
04530 <span class="comment">     * topmost. If not, continue: no top most boundary.</span>
04531 <span class="comment">     */</span>
04532     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1613">FSwpTopmost</a>(pwndPrev))
04533         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04534 
04535     <span class="comment">/*</span>
04536 <span class="comment">     * Is the current window already top-most? If so then don't</span>
04537 <span class="comment">     * calculate a special insert after. If we don't check for</span>
04538 <span class="comment">     * this, then pwnd's insert after may be calculated as what</span>
04539 <span class="comment">     * pwnd already is, if pwnd is the last top most window. That</span>
04540 <span class="comment">     * would cause window links to get corrupted.</span>
04541 <span class="comment">     */</span>
04542     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>))
04543         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04544 
04545     <span class="comment">/*</span>
04546 <span class="comment">     * Doing this assign prevents this routine from being called</span>
04547 <span class="comment">     * twice, since HW() is a conditional macro.</span>
04548 <span class="comment">     */</span>
04549     pwndT = <a class="code" href="../../d4/d1/userk_8h.html#a1614">CalcForegroundInsertAfter</a>(pwnd);
04550     <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
04551     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04552 }
04553 
04554 <span class="comment">/***************************************************************************\</span>
04555 <span class="comment">* TrackZorder, TrackZorderHelper</span>
04556 <span class="comment">*</span>
04557 <span class="comment">* Set up hwndInsertAfter links to point to the previous window in the</span>
04558 <span class="comment">* CVR array and partition them in TOPMOST and non-TOPMOST chains.</span>
04559 <span class="comment">*</span>
04560 <span class="comment">* 05/16/97      vadimg      created</span>
04561 <span class="comment">\***************************************************************************/</span>
04562 
<a name="l04563"></a><a class="code" href="../../d2/d8/swp_8c.html#a58">04563</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d8/swp_8c.html#a58">TrackZorderHelper</a>(WINDOWPOS *ppos, HWND *phwnd)
04564 {
04565     <span class="comment">/*</span>
04566 <span class="comment">     * phwnd (hwndTopmost or hwndRegular) have been initialized to NULL before</span>
04567 <span class="comment">     * the beginning of the scan. This way the first hwndInsertAfter that</span>
04568 <span class="comment">     * we process remains with the value that was previously calculated.</span>
04569 <span class="comment">     */</span>
04570     <span class="keywordflow">if</span> (*phwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04571 
04572 <span class="preprocessor">#if DBG</span>
04573 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter != *phwnd) {
04574         RIPMSG0(RIP_WARNING, <span class="stringliteral">"TrackZorder: modified hwndInsertAfter"</span>);
04575     }
04576 <span class="preprocessor">#endif</span>
04577 <span class="preprocessor"></span>
04578         <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwndInsertAfter = *phwnd;
04579     }
04580     *phwnd = <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd;
04581 }
04582 
<a name="l04583"></a><a class="code" href="../../d2/d8/swp_8c.html#a59">04583</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d2/d8/swp_8c.html#a59">TrackZorder</a>(WINDOWPOS* ppos, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPrev, HWND *phwndTop, HWND *phwndReg)
04584 {
04585     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd);
04586 
04587     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04588         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04589 
04590     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a57">TrackBackground</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>, pwndPrev, pwnd)) {
04591         *phwndReg = <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd;
04592     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1613">FSwpTopmost</a>(pwnd)) {
04593         <a class="code" href="../../d2/d8/swp_8c.html#a58">TrackZorderHelper</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>, phwndTop);
04594     } <span class="keywordflow">else</span> {
04595         <a class="code" href="../../d2/d8/swp_8c.html#a58">TrackZorderHelper</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>, phwndReg);
04596     }
04597 
04598     <span class="keywordflow">return</span> pwnd;
04599 }
04600 
04601 <span class="comment">/***************************************************************************\</span>
04602 <span class="comment">* ZOrderByOwner</span>
04603 <span class="comment">*</span>
04604 <span class="comment">* This routine Z-Orders windows by their owners.</span>
04605 <span class="comment">*</span>
04606 <span class="comment">* LATER</span>
04607 <span class="comment">* This code currently assumes that all of the window handles are valid</span>
04608 <span class="comment">*</span>
04609 <span class="comment">* History:</span>
04610 <span class="comment">* 04-Mar-1992 MikeKe      from win31</span>
04611 <span class="comment">\***************************************************************************/</span>
04612 
<a name="l04613"></a><a class="code" href="../../d2/d8/swp_8c.html#a60">04613</a> <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> <a class="code" href="../../d2/d8/swp_8c.html#a60">ZOrderByOwner</a>(
04614     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp)
04615 {
04616     <span class="keywordtype">int</span>         i;
04617     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd;
04618     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndT;
04619     WINDOWPOS   pos;
04620     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
04621     HRGN        hrgnClipSave;
04622 
04623     <span class="comment">/*</span>
04624 <span class="comment">     * Some of the windows in the SMWP list may be NULL at ths point</span>
04625 <span class="comment">     * (removed because they'll be handled by their creator's thread)</span>
04626 <span class="comment">     * so we've got to look for the first non-NULL window before we can</span>
04627 <span class="comment">     * execute some of the tests below.  FindValidWindowPos returns NULL if</span>
04628 <span class="comment">     * the list has no valid windows in it.</span>
04629 <span class="comment">     */</span>
04630     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a31">FindValidWindowPos</a>(psmwp) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04631         <span class="keywordflow">return</span> psmwp;
04632 
04633     <span class="comment">/*</span>
04634 <span class="comment">     * For each SWP in the array, move it to the end of the array</span>
04635 <span class="comment">     * and generate its entire owner tree in sorted order.</span>
04636 <span class="comment">     */</span>
04637     <span class="keywordflow">for</span> (i = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; i-- != 0; ) {
04638 
04639         <span class="keywordtype">int</span>       iScan;
04640         <span class="keywordtype">int</span>       iTop;
04641         <span class="keywordtype">int</span>       code;
04642         WINDOWPOS *<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>;
04643         HWND      hwndTopmost;
04644         HWND      hwndRegular;
04645 
04646         <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04647             <span class="keywordflow">continue</span>;
04648 
04649         code = <a class="code" href="../../d2/d8/swp_8c.html#a52">CheckTopmost</a>(&amp;psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>);
04650 
04651         <span class="comment">/*</span>
04652 <span class="comment">         * Make a local copy for later...</span>
04653 <span class="comment">         *</span>
04654 <span class="comment">         * Why don't we copy all CVR fields? This seems pretty hard to maintain.</span>
04655 <span class="comment">         * Perhaps because most of them haven't been used yet....</span>
04656 <span class="comment">         *</span>
04657 <span class="comment">         */</span>
04658         pos  = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>;
04659         ptiT = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o10">pti</a>;
04660         hrgnClipSave = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a>;
04661 
04662         <span class="comment">/*</span>
04663 <span class="comment">         * Move the CVR to the end (if it isn't already)</span>
04664 <span class="comment">         */</span>
04665         iTop = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> - 1;
04666 
04667         <span class="keywordflow">if</span> (iTop != 0) {
04668 
04669             RtlCopyMemory(&amp;psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0],
04670                           &amp;psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[1],
04671                           iTop * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/structtagCVR.html">CVR</a>));
04672 
04673             psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[iTop].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a> = pos;
04674             psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[iTop].<a class="code" href="../../d2/d2/structtagCVR.html#o10">pti</a> = ptiT;
04675             psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[iTop].<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a> = hrgnClipSave;
04676         }
04677 
04678         <span class="keywordflow">if</span> ((psmwp = <a class="code" href="../../d2/d8/swp_8c.html#a56">ZOrderByOwner2</a>(psmwp, iTop)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04679             <span class="keywordflow">break</span>;
04680 
04681         <span class="comment">/*</span>
04682 <span class="comment">         * Deal with WEFTOPMOST bits.  If we're SETTING the TOPMOST bits,</span>
04683 <span class="comment">         * we want to set them for this window and</span>
04684 <span class="comment">         * all its owned windows -- the owners stay unchanged.  If we're</span>
04685 <span class="comment">         * CLEARING, though, we need to enumerate ALL the windows, since</span>
04686 <span class="comment">         * they all need to lose the topmost bit when one loses it.</span>
04687 <span class="comment">         *</span>
04688 <span class="comment">         * Note that since a status change doesn't necessarily mean that</span>
04689 <span class="comment">         * the true Z order of the windows have changed, so ZOrderByOwner2</span>
04690 <span class="comment">         * may not have enumerated all of the owned and owner windows.</span>
04691 <span class="comment">         * So, we enumerate them separately here.</span>
04692 <span class="comment">         */</span>
04693         <span class="keywordflow">if</span> (code != <a class="code" href="../../d2/d8/swp_8c.html#a0">CTM_NOCHANGE</a>) {
04694             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndRoot = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(pos.hwnd);
04695 <span class="preprocessor">#if DBG</span>
04696 <span class="preprocessor"></span>            <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOriginal = pwndRoot;
04697 <span class="preprocessor">#endif</span>
04698 <span class="preprocessor"></span>
04699             <span class="comment">/*</span>
04700 <span class="comment">             * Make sure we're z-ordering this window. Or settting topmost</span>
04701 <span class="comment">             *  is bad.</span>
04702 <span class="comment">             */</span>
04703             UserAssert(!(pos.flags &amp; SWP_NOZORDER));
04704 
04705             <span class="comment">/*</span>
04706 <span class="comment">             * If we're CLEARING the topmost, then we want to enumerate</span>
04707 <span class="comment">             * the owners and ownees, so start our enumeration at the root.</span>
04708 <span class="comment">             */</span>
04709             <span class="keywordflow">if</span> (code == <a class="code" href="../../d2/d8/swp_8c.html#a2">CTM_NOTOPMOST</a>) {
04710 
04711                 <span class="keywordflow">while</span> (pwnd = <a class="code" href="../../d2/d8/swp_8c.html#a47">GetRealOwner</a>(pwndRoot))
04712                     pwndRoot = pwnd;
04713             }
04714 
04715 <span class="preprocessor">#if DBG</span>
04716 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((pos.flags &amp; SWP_NOOWNERZORDER)
04717                 &amp;&amp; ((pwndOriginal != pwndRoot)
04718                     || (<a class="code" href="../../d2/d8/swp_8c.html#a48">NextOwnedWindow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwndRoot, pwndRoot-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
04719                 <span class="comment">/*</span>
04720 <span class="comment">                 * We're not doing owner z-order but pwndOriginal has an owner and/or</span>
04721 <span class="comment">                 *  owns some windows. The problem is, SetTopMost always affects the whole</span>
04722 <span class="comment">                 *  owner/ownee group. So we might end up with WFTOGGLETOPMOST windows</span>
04723 <span class="comment">                 *  that won't be z-ordered. It has always been like that.</span>
04724 <span class="comment">                 */</span>
04725                 RIPMSG2(RIP_WARNING, <span class="stringliteral">"ZOrderByOwner: Topmost change while using SWP_NOOWNERZORDER."</span>
04726                                      <span class="stringliteral">" pwndRoot:%p  pwndOriginal:%p"</span>,
04727                                      pwndRoot, pwndOriginal);
04728             }
04729 <span class="preprocessor">#endif</span>
04730 <span class="preprocessor"></span>
04731             <a class="code" href="../../d2/d8/swp_8c.html#a49">SetTopmost</a>(pwndRoot, code == <a class="code" href="../../d2/d8/swp_8c.html#a1">CTM_TOPMOST</a>);
04732         }
04733 
04734         <span class="comment">/*</span>
04735 <span class="comment">         * Now scan the list forwards (from the bottom of the</span>
04736 <span class="comment">         * owner tree towards the root) looking for the window</span>
04737 <span class="comment">         * we were positioning originally (it may have been in</span>
04738 <span class="comment">         * the middle of the owner tree somewhere).  Update the</span>
04739 <span class="comment">         * window pos structure stored there with the original</span>
04740 <span class="comment">         * information (though the z-order info is retained from</span>
04741 <span class="comment">         * the sort).</span>
04742 <span class="comment">         */</span>
04743         pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04744         hwndTopmost = hwndRegular = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04745         <span class="keywordflow">for</span> (iScan = iTop; iScan != psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; iScan++) {
04746 
04747             <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> = &amp;psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[iScan].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>;
04748 
04749             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;hwnd == pos.hwnd) {
04750                 <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;x      = pos.x;
04751                 <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;y      = pos.y;
04752                 <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;cx     = pos.cx;
04753                 <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;cy     = pos.cy;
04754                 <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags ^= ((<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags ^ pos.flags) &amp; ~SWP_NOZORDER);
04755                 psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[iScan].<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a> = hrgnClipSave;
04756             }
04757 
04758             pwndT = pwnd;
04759             pwnd  = <a class="code" href="../../d2/d8/swp_8c.html#a59">TrackZorder</a>(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>, pwndT, &amp;hwndTopmost, &amp;hwndRegular);
04760         }
04761     }
04762 
04763     <span class="keywordflow">return</span> psmwp;
04764 }
04765 <span class="comment">/***************************************************************************\</span>
04766 <span class="comment">* xxxEndDeferWindowPosEx</span>
04767 <span class="comment">*</span>
04768 <span class="comment">*</span>
04769 <span class="comment">* History:</span>
04770 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
04771 <span class="comment">\***************************************************************************/</span>
04772 
<a name="l04773"></a><a class="code" href="../../d4/d1/userk_8h.html#a1620">04773</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1620">xxxEndDeferWindowPosEx</a>(
04774     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp,
04775     BOOL  fAsync)
04776 {
04777     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndNewActive;
04778     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndParent;
04779     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndActive;
04780     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndActivePrev;
04781     HWND        hwndNewActive;
04782     PWINDOWPOS  pwp;
04783     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fClearBits;
04784     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fSyncPaint;
04785     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        cVisWindowsPrev;
04786     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04787     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndNewActive;
04788     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndParent;
04789     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlcuSMWP;
04790     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fForegroundPrev;
04791 
04792     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
04793 
04794     <a class="code" href="../../d2/d8/swp_8c.html#a3">DBGCheskSMWP</a>(psmwp);
04795     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o2">bHandle</a>) {
04796         <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(psmwp);
04797     }
04798 
04799     <span class="comment">/*</span>
04800 <span class="comment">     * Validate the window pos structures and find a window to activate.</span>
04801 <span class="comment">     */</span>
04802     <span class="keywordflow">if</span> ((psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a> != 0) &amp;&amp; <a class="code" href="../../d2/d8/swp_8c.html#a30">ValidateSmwp</a>(psmwp, &amp;fSyncPaint)) {
04803 
04804         <span class="keywordflow">if</span> ((pwp = <a class="code" href="../../d2/d8/swp_8c.html#a31">FindValidWindowPos</a>(psmwp)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04805             <span class="keywordflow">goto</span> lbFinished;
04806 
04807         <span class="comment">/*</span>
04808 <span class="comment">         * Make sure to stop at the mother desktop window.  In Win95</span>
04809 <span class="comment">         * a SetWindowPos() on a desktop window will have a NULL parent</span>
04810 <span class="comment">         * window.  This is not true in NT, but our mother desktop</span>
04811 <span class="comment">         * window does have a NULL rpdesk, so check it too.</span>
04812 <span class="comment">         */</span>
04813         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(pwp-&gt;hwnd));
04814         pwndParent = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(pwp-&gt;hwnd)-&gt;spwndParent;
04815         <span class="keywordflow">if</span> (pwndParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04816             <span class="keywordflow">goto</span> lbFinished;
04817 
04818         <span class="comment">/*</span>
04819 <span class="comment">         * Usually all window positioning happens synchronously across threads.</span>
04820 <span class="comment">         * This is because apps expect that behavior now - if it was async,</span>
04821 <span class="comment">         * callers could not expect the state to be set once the api returned.</span>
04822 <span class="comment">         * This is not the semantics of SetWindowPos(). The downside of this</span>
04823 <span class="comment">         * synchronicity is that a SetWindowPos() on an hwnd created by another</span>
04824 <span class="comment">         * thread will cause the caller to wait for that thread - even if that</span>
04825 <span class="comment">         * thread is hung. That's what you get.</span>
04826 <span class="comment">         *</span>
04827 <span class="comment">         * We don't want task manager to hang though, no matter who else is</span>
04828 <span class="comment">         * hung, so when taskman calls, it calls a special entry point for</span>
04829 <span class="comment">         * tiling / cascading, which does SetWindowPos() asynchronously -</span>
04830 <span class="comment">         * by posting an event in each thread's queue that makes it set its</span>
04831 <span class="comment">         * own window position - that way if the thread is hung, who cares -</span>
04832 <span class="comment">         * it doesn't effect taskman.</span>
04833 <span class="comment">         *</span>
04834 <span class="comment">         * Do async window pos positioning before zorder by owner so that</span>
04835 <span class="comment">         * we retain any cross thread ownership relationships synchronously.</span>
04836 <span class="comment">         */</span>
04837         <span class="keywordflow">if</span> (fAsync) {
04838             <a class="code" href="../../d2/d8/swp_8c.html#a39">AsyncWindowPos</a>(psmwp);
04839         }
04840 
04841         <span class="comment">/*</span>
04842 <span class="comment">         * If needed, Z order the windows by owner.</span>
04843 <span class="comment">         * This may grow the SMWP, if new CVRs are added.</span>
04844 <span class="comment">         */</span>
04845         <span class="keywordflow">if</span> (pwndParent == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndParent)) {
04846 
04847             <span class="keywordflow">if</span> ((psmwp = <a class="code" href="../../d2/d8/swp_8c.html#a60">ZOrderByOwner</a>(psmwp)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04848                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04849             }
04850         }
04851 
04852         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndParent, &amp;tlpwndParent);
04853         <a class="code" href="../../d4/d1/userk_8h.html#a140">ThreadLockPoolCleanup</a>(ptiCurrent, psmwp, &amp;tlcuSMWP, <a class="code" href="../../d2/d8/swp_8c.html#a20">DestroySMWP</a>);
04854 
04855         <span class="comment">/*</span>
04856 <span class="comment">         * Calc new window positions.</span>
04857 <span class="comment">         */</span>
04858         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a34">xxxCalcValidRects</a>(psmwp, &amp;hwndNewActive)) {
04859 
04860             <span class="keywordtype">int</span> i;
04861 
04862             pwndNewActive = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndNewActive);
04863 
04864             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndNewActive, &amp;tlpwndNewActive);
04865 
04866             cVisWindowsPrev = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a>;
04867             fForegroundPrev = (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>);
04868 
04869             <span class="comment">/*</span>
04870 <span class="comment">             * The call to zzzBltValidBits will leave the critical section</span>
04871 <span class="comment">             * if there are any notifications to make.</span>
04872 <span class="comment">             */</span>
04873             UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
04874             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/swp_8c.html#a45">zzzBltValidBits</a>(psmwp))
04875                 fSyncPaint = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04876             UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
04877 
04878             <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o1">bShellNotify</a>) {
04879                 <span class="keywordflow">for</span> (i = psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o3">ccvr</a>; i-- != 0; ) {
04880                     <span class="comment">/*</span>
04881 <span class="comment">                     * Loop through the windows, looking for notifications.</span>
04882 <span class="comment">                     */</span>
04883 
04884                     <span class="keywordflow">if</span> (0 == (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOTIFYALL))
04885                         <span class="keywordflow">continue</span>;
04886 
04887                     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOTIFYCREATE) {
04888                           <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_WINDOWCREATED,
04889                                     (LPARAM)psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
04890 
04891                           <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_WINDOWCREATED,
04892                             (WPARAM)psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd,
04893                             (LPARAM)0,
04894                             WH_SHELL);
04895                     }
04896 
04897                     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOTIFYDESTROY) {
04898                         <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_WINDOWDESTROYED,
04899                                       (LPARAM)psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
04900 
04901                         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_WINDOWDESTROYED,
04902                             (WPARAM)psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd,
04903                             (LPARAM)0,
04904                             WH_SHELL);
04905                     }
04906 
04907                     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOTIFYACTIVATE) {
04908                         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.hwnd);
04909                         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
04910                             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
04911                             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
04912                             <a class="code" href="../../d8/d7/winloop2_8c.html#a3">xxxSetTrayWindow</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk, pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04913                             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
04914                         }
04915                     }
04916 
04917                     <span class="keywordflow">if</span> (psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[i].<a class="code" href="../../d2/d2/structtagCVR.html#o0">pos</a>.flags &amp; SWP_NOTIFYFS) {
04918                         <a class="code" href="../../d8/d7/winloop2_8c.html#a3">xxxSetTrayWindow</a>(ptiCurrent-&gt;rpdesk, <a class="code" href="../../d4/d1/userk_8h.html#a591">STW_SAME</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04919                     }
04920                 }
04921             }
04922 
04923 
04924             <span class="comment">/*</span>
04925 <span class="comment">             * If this process went from some windows to no windows visible</span>
04926 <span class="comment">             * and it was in the foreground, then let its next activate</span>
04927 <span class="comment">             * come to the foreground.</span>
04928 <span class="comment">             */</span>
04929             <span class="keywordflow">if</span> (fForegroundPrev &amp;&amp; cVisWindowsPrev &amp;&amp; !ptiCurrent-&gt;cVisWindows) {
04930 
04931                 ptiCurrent-&gt;TIF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
04932                 TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxEndDeferWindowPosEx set TIF %#p"</span>, ptiCurrent);
04933 
04934                 <span class="comment">/*</span>
04935 <span class="comment">                 * Also if any apps were in the middle of starting when</span>
04936 <span class="comment">                 * this happened, allow them to foreground activate again.</span>
04937 <span class="comment">                 */</span>
04938                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a34">RestoreForegroundActivate</a>();
04939             }
04940 
04941             <span class="comment">/*</span>
04942 <span class="comment">             * Deal with any activation...</span>
04943 <span class="comment">             */</span>
04944             fClearBits = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04945             <span class="keywordflow">if</span> (pwndNewActive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04946                 fClearBits = <a class="code" href="../../d2/d8/swp_8c.html#a37">xxxSwpActivate</a>(pwndNewActive);
04947 
04948             <span class="comment">/*</span>
04949 <span class="comment">             * Now draw frames and erase backgrounds of all the windows</span>
04950 <span class="comment">             * involved.</span>
04951 <span class="comment">             */</span>
04952             UserAssert(pwndParent);
04953             <span class="keywordflow">if</span> (fSyncPaint)
04954                 <a class="code" href="../../d4/d1/userk_8h.html#a1041">xxxDoSyncPaint</a>(pwndParent, <a class="code" href="../../d4/d1/userk_8h.html#a495">DSP_ENUMCLIPPEDCHILDREN</a>);
04955 
04956             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNewActive);
04957 
04958             <span class="comment">/*</span>
04959 <span class="comment">             * If SwpActivate() set the NONCPAINT bits, clear them now.</span>
04960 <span class="comment">             */</span>
04961             <span class="keywordflow">if</span> (fClearBits) {
04962 
04963                 <span class="keywordflow">if</span> (pwndActive = ptiCurrent-&gt;pq-&gt;spwndActive)
04964                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndActive, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a559">WFNONCPAINT</a>);
04965 
04966                 <span class="keywordflow">if</span> (pwndActivePrev = ptiCurrent-&gt;pq-&gt;spwndActivePrev)
04967                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndActivePrev, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a559">WFNONCPAINT</a>);
04968             }
04969 
04970             <span class="comment">/*</span>
04971 <span class="comment">             * Send WM_WINDOWPOSCHANGED messages</span>
04972 <span class="comment">             */</span>
04973             <a class="code" href="../../d2/d8/swp_8c.html#a38">xxxSendChangedMsgs</a>(psmwp);
04974         }
04975 
04976         <a class="code" href="../../d4/d1/userk_8h.html#a141">ThreadUnlockPoolCleanup</a>(ptiCurrent, &amp;tlcuSMWP);
04977         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
04978     }
04979 
04980 lbFinished:
04981 
04982     <span class="comment">/*</span>
04983 <span class="comment">     * All done.  Free everything up and return.</span>
04984 <span class="comment">     */</span>
04985     <a class="code" href="../../d4/d1/userk_8h.html#a1018">DestroySMWP</a>(psmwp);
04986     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04987 }
04988 
04989 
04990 <span class="comment">/***************************************************************************\</span>
04991 <span class="comment">* IncVisWindows</span>
04992 <span class="comment">* DecVisWindows</span>
04993 <span class="comment">*</span>
04994 <span class="comment">* These routines deal with incrementing/decrementing the visible windows</span>
04995 <span class="comment">* on the thread.</span>
04996 <span class="comment">*</span>
04997 <span class="comment">\***************************************************************************/</span>
04998 <span class="preprocessor">#if DBG</span>
04999 <span class="preprocessor"></span>
05000 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> gfVisVerify = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05001 
05002 <span class="keywordtype">void</span> VerifycVisWindows(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
05003 {
05004     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fShowMeTheWindows = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05005     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
05006     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNext;
05007     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uVisWindows = 0;
05008 
05009     <span class="keywordflow">if</span> (!gfVisVerify) {
05010         <span class="keywordflow">return</span>;
05011     }
05012 
05013     <span class="comment">/*</span>
05014 <span class="comment">     * Make sure the count makes sense</span>
05015 <span class="comment">     */</span>
05016     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a> &lt; 0) {
05017         RIPMSG0(RIP_ERROR, <span class="stringliteral">"VerifycVisWindows: pti-&gt;cVisWindows underflow!"</span>);
05018         fShowMeTheWindows = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05019     }
05020 
05021     <span class="comment">/*</span>
05022 <span class="comment">     * This window might be owned by a desktop-less service</span>
05023 <span class="comment">     */</span>
05024     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)) {
05025         <span class="keywordflow">return</span>;
05026     }
05027 
05028     <span class="comment">/*</span>
05029 <span class="comment">     * Child windows don't affect cVisWindows</span>
05030 <span class="comment">     */</span>
05031     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a596">FTopLevel</a>(pwnd)) {
05032         <span class="keywordflow">return</span>;
05033     }
05034 
05035 ShowMeTheWindows:
05036     <span class="comment">/*</span>
05037 <span class="comment">     * We're going to count all the windows owned by this pti</span>
05038 <span class="comment">     *  that should be included in cVisWindows</span>
05039 <span class="comment">     */</span>
05040     pwndNext = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
05041     <span class="comment">/*</span>
05042 <span class="comment">     * If this is a top level window, start with the first child.</span>
05043 <span class="comment">     * If not, it should be a desktop thread window</span>
05044 <span class="comment">     */</span>
05045     <span class="keywordflow">if</span> (pwndNext == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
05046         pwndNext = pwndNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
05047     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwndNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
05048         RIPMSG1(RIP_WARNING, <span class="stringliteral">"VerifycVisWindows: Non top level window:%#p"</span>, pwnd);
05049         <span class="keywordflow">return</span>;
05050     }
05051 
05052     <span class="keywordflow">if</span> (fShowMeTheWindows) {
05053         RIPMSG1(RIP_WARNING, <span class="stringliteral">"VerifycVisWindows: Start window walk at:%#p"</span>, pwndNext);
05054     }
05055 
05056     <span class="comment">/*</span>
05057 <span class="comment">     * Count the visble-not-minimized windows owned by this pti</span>
05058 <span class="comment">     */</span>
05059     <span class="keywordflow">while</span> (pwndNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05060         <span class="keywordflow">if</span> (pti == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNext)) {
05061             <span class="keywordflow">if</span> (fShowMeTheWindows) {
05062                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"VerifycVisWindows: pwndNext:%#p"</span>, pwndNext);
05063             }
05064             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext, WFMINIMIZED)
05065                     &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext, WFVISIBLE)) {
05066 
05067                 uVisWindows++;
05068 
05069                 <span class="keywordflow">if</span> (fShowMeTheWindows) {
05070                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"VerifycVisWindows: Counted:%#p"</span>, pwndNext);
05071                 }
05072             }
05073         }
05074         pwndNext = pwndNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
05075     }
05076 
05077     <span class="comment">/*</span>
05078 <span class="comment">     * It must match.</span>
05079 <span class="comment">     */</span>
05080     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a> != uVisWindows) {
05081         RIPMSG2(RIP_WARNING, <span class="stringliteral">"VerifycVisWindows: pti-&gt;cVisWindows:%#lx. uVisWindows:%#lx"</span>,
05082                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a>, uVisWindows);
05083 
05084         <span class="comment">/*</span>
05085 <span class="comment">         * Disable going through the list and make the error into a warning.</span>
05086 <span class="comment">         * There are many loopholes as to how the cVisWindow count may get</span>
05087 <span class="comment">         * messed up. See bug 109807.</span>
05088 <span class="comment">         */</span>
05089         fShowMeTheWindows = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05090 
05091         <span class="keywordflow">if</span> (!fShowMeTheWindows) {
05092             fShowMeTheWindows = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05093             uVisWindows = 0;
05094             <span class="keywordflow">goto</span> ShowMeTheWindows;
05095         }
05096     }
05097 }
05098 <span class="preprocessor">#endif</span>
05099 <span class="preprocessor"></span>
05100 <span class="comment">/***************************************************************************\</span>
05101 <span class="comment">* FVisCountable</span>
05102 <span class="comment">*</span>
05103 <span class="comment">* Desktops and top-level i.e. whose parent is the desktop) non-minimized</span>
05104 <span class="comment">* windows should be counted in the per-thread visible window counts.</span>
05105 <span class="comment">\***************************************************************************/</span>
05106 
<a name="l05107"></a><a class="code" href="../../d4/d1/userk_8h.html#a1625">05107</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1625">FVisCountable</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
05108 {
05109     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
05110         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) ||
05111                 (<a class="code" href="../../d4/d1/userk_8h.html#a596">FTopLevel</a>(pwnd) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))) {
05112             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05113         }
05114     }
05115     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05116 }
05117 
05118 <span class="comment">/***************************************************************************\</span>
05119 <span class="comment">* IncVisWindows</span>
05120 <span class="comment">*</span>
05121 <span class="comment">\***************************************************************************/</span>
05122 
<a name="l05123"></a><a class="code" href="../../d4/d1/userk_8h.html#a1623">05123</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1623">IncVisWindows</a>(
05124     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
05125 {
05126     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1625">FVisCountable</a>(pwnd))
05127         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;cVisWindows++;
05128 
05129 <span class="preprocessor">#if DBG</span>
05130 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>())
05131         VerifycVisWindows(pwnd);
05132 <span class="preprocessor">#endif</span>
05133 <span class="preprocessor"></span>}
05134 
05135 <span class="comment">/***************************************************************************\</span>
05136 <span class="comment">* cDecVis</span>
05137 <span class="comment">*</span>
05138 <span class="comment">* An inline that allows debug code to decrement the vis window count</span>
05139 <span class="comment">* without doing verification right away.  Also alled by DecVisWindows</span>
05140 <span class="comment">* to do the actual work.</span>
05141 <span class="comment">\***************************************************************************/</span>
05142 
<a name="l05143"></a><a class="code" href="../../d2/d8/swp_8c.html#a64">05143</a> __inline <span class="keywordtype">void</span> <a class="code" href="../../d2/d8/swp_8c.html#a64">cDecVis</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
05144 {
05145     UserAssert(pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05146 
05147     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1625">FVisCountable</a>(pwnd))
05148         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;cVisWindows--;
05149 }
05150 
05151 <span class="comment">/***************************************************************************\</span>
05152 <span class="comment">* DecVisWindows</span>
05153 <span class="comment">*</span>
05154 <span class="comment">\***************************************************************************/</span>
05155 
<a name="l05156"></a><a class="code" href="../../d4/d1/userk_8h.html#a1624">05156</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1624">DecVisWindows</a>(
05157     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
05158 {
05159     <a class="code" href="../../d2/d8/swp_8c.html#a64">cDecVis</a>(pwnd);
05160 
05161 <span class="preprocessor">#if DBG</span>
05162 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>())
05163         VerifycVisWindows(pwnd);
05164 <span class="preprocessor">#endif</span>
05165 <span class="preprocessor"></span>}
05166 
05167 <span class="comment">/***************************************************************************\</span>
05168 <span class="comment">* SetMiminize</span>
05169 <span class="comment">*</span>
05170 <span class="comment">* This routine must be used to flip the WS_MIMIMIZE style bit.</span>
05171 <span class="comment">* It adjusts cVisWindows count if appropriate.</span>
05172 <span class="comment">*</span>
05173 <span class="comment">* 06/06/96  GerardoB Created</span>
05174 <span class="comment">\***************************************************************************/</span>
05175 
<a name="l05176"></a><a class="code" href="../../d4/d1/userk_8h.html#a1631">05176</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1631">SetMinimize</a>(
05177     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
05178     UINT uFlags)
05179 {
05180     <span class="comment">/*</span>
05181 <span class="comment">     * Note that Dec and IncVisWindows check the WFMINIMIZED flag, so the order</span>
05182 <span class="comment">     *  in which we set/clear the flag and call these functions is important</span>
05183 <span class="comment">     * If the window is not WFVISIBLE, cVisWindows must not change.</span>
05184 <span class="comment">     */</span>
05185     <span class="keywordflow">if</span> (uFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a575">SMIN_SET</a>) {
05186         UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>));
05187         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
05188             <span class="comment">/*</span>
05189 <span class="comment">             * Decrement the count because the window is not minimized</span>
05190 <span class="comment">             *  and visible, and we're about to mark it as minimized</span>
05191 <span class="comment">             */</span>
05192 
05193 <span class="preprocessor">#if DBG</span>
05194 <span class="preprocessor"></span>            <a class="code" href="../../d2/d8/swp_8c.html#a64">cDecVis</a>(pwnd);
05195 <span class="preprocessor">#else</span>
05196 <span class="preprocessor"></span>            <a class="code" href="../../d4/d1/userk_8h.html#a1624">DecVisWindows</a>(pwnd);
05197 <span class="preprocessor">#endif</span>
05198 <span class="preprocessor"></span>        }
05199         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>);
05200 
05201 <span class="preprocessor">#if DBG</span>
05202 <span class="preprocessor"></span>        VerifycVisWindows(pwnd);
05203 <span class="preprocessor">#endif</span>
05204 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
05205 
05206         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>));
05207         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>);
05208         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
05209             <span class="comment">/*</span>
05210 <span class="comment">             * Increment the count because the window is visible</span>
05211 <span class="comment">             *  and it's no longer marked as minimized</span>
05212 <span class="comment">             */</span>
05213             <a class="code" href="../../d4/d1/userk_8h.html#a1623">IncVisWindows</a>(pwnd);
05214         }
05215     }
05216 }
05217 <span class="comment">/***************************************************************************\</span>
05218 <span class="comment">* SetVisible</span>
05219 <span class="comment">*</span>
05220 <span class="comment">* This routine must be used to set or clear the WS_VISIBLE style bit.</span>
05221 <span class="comment">* It also handles the setting or clearing of the WF_TRUEVIS bit.</span>
05222 <span class="comment">*</span>
05223 <span class="comment">* Note that we don't check if the window is already in the (in)visible</span>
05224 <span class="comment">* state before setting/clearing the WFVISIBLE bit and calling</span>
05225 <span class="comment">* Inc/DecVisWindows. If the window is already in the given state and</span>
05226 <span class="comment">* someone calls SetVisible to change into the same state, the VisCount</span>
05227 <span class="comment">* will get out of sync. This could happen, for example, if someone</span>
05228 <span class="comment">* passed two SWP_SHOWWINDOW for the same hwnd CVR's in the same</span>
05229 <span class="comment">* EndDeferWindowPos call. It would be ideal to do the check here, but</span>
05230 <span class="comment">* most of the time the caller does the check and we don't want to</span>
05231 <span class="comment">* penalize everybody just because of the weird cases.</span>
05232 <span class="comment">*</span>
05233 <span class="comment">* History:</span>
05234 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
05235 <span class="comment">\***************************************************************************/</span>
05236 
<a name="l05237"></a><a class="code" href="../../d4/d1/userk_8h.html#a1626">05237</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(
05238     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
05239     UINT flags)
05240 {
05241     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a751">SV_SET</a>) {
05242 
05243 <span class="preprocessor">#if DBG</span>
05244 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
05245             RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetVisible: show INDESTROY %#p"</span>, pwnd);
05246         }
05247 <span class="preprocessor">#endif</span>
05248 <span class="preprocessor"></span>
05249         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
05250             RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetVisible: already visible %#p"</span>, pwnd);
05251         } <span class="keywordflow">else</span> {
05252             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>);
05253             <a class="code" href="../../d4/d1/userk_8h.html#a1623">IncVisWindows</a>(pwnd);
05254         }
05255     } <span class="keywordflow">else</span> {
05256 
05257         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a752">SV_CLRFTRUEVIS</a>)
05258             <a class="code" href="../../d4/d1/userk_8h.html#a1627">ClrFTrueVis</a>(pwnd);
05259 
05260 <span class="preprocessor">#if DBG</span>
05261 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
05262             RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetVisible: hide DESTROYED %#p"</span>, pwnd);
05263         }
05264 <span class="preprocessor">#endif</span>
05265 <span class="preprocessor"></span>
05266         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
05267             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>);
05268             <a class="code" href="../../d4/d1/userk_8h.html#a1624">DecVisWindows</a>(pwnd);
05269         } <span class="keywordflow">else</span> {
05270             RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetVisible: already hidden %#p"</span>, pwnd);
05271         }
05272     }
05273 }
05274 
05275 <span class="comment">/***************************************************************************\</span>
05276 <span class="comment">* IsMaxedRect</span>
05277 <span class="comment">*</span>
05278 <span class="comment">* Determines if a window is "maximizing" to a certain area</span>
05279 <span class="comment">*</span>
05280 <span class="comment">* History:</span>
05281 <span class="comment">\***************************************************************************/</span>
05282 
<a name="l05283"></a><a class="code" href="../../d2/d8/swp_8c.html#a68">05283</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/swp_8c.html#a68">IsMaxedRect</a>(
05284     LPRECT      lprcWithin,
05285     <a class="code" href="../../d6/d6/structtagSIZERECT.html">PCSIZERECT</a>  psrcMaybe)
05286 {
05287     <span class="keywordflow">return</span>(psrcMaybe-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o0">x</a> &lt;= lprcWithin-&gt;left                      &amp;&amp;
05288            psrcMaybe-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a> &lt;= lprcWithin-&gt;top                       &amp;&amp;
05289            psrcMaybe-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o2">cx</a> &gt;= lprcWithin-&gt;right - lprcWithin-&gt;left &amp;&amp;
05290            psrcMaybe-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a> &gt;= lprcWithin-&gt;bottom - lprcWithin-&gt;top);
05291 }
05292 
05293 <span class="comment">/***************************************************************************\</span>
05294 <span class="comment">* xxxCheckFullScreen</span>
05295 <span class="comment">*</span>
05296 <span class="comment">* Sees if a window is really fullscreen or just a maximized window in</span>
05297 <span class="comment">* disguise.  If the latter, it will be forced to the proper maximized</span>
05298 <span class="comment">* size.</span>
05299 <span class="comment">*</span>
05300 <span class="comment">* This is called from both CalcValidRects() and CreateWindowEx().</span>
05301 <span class="comment">*</span>
05302 <span class="comment">* History:</span>
05303 <span class="comment">\***************************************************************************/</span>
05304 
<a name="l05305"></a><a class="code" href="../../d4/d1/userk_8h.html#a1752">05305</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1752">xxxCheckFullScreen</a>(
05306     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd,
05307     <a class="code" href="../../d6/d6/structtagSIZERECT.html">PSIZERECT</a>   psrc)
05308 {
05309     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fYielded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05310     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor;
05311     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitorPrimary;
05312     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpMonitor;
05313     RECT            rc;
05314     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fIsPrimary;
05315 
05316 
05317     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
05318 
05319     <span class="comment">/*</span>
05320 <span class="comment">     * SINCE THIS IS ONLY CALLED IN 2 PLACES, make the checks there</span>
05321 <span class="comment">     * instead of the overhead of calling this function in time critical</span>
05322 <span class="comment">     * places.</span>
05323 <span class="comment">     *</span>
05324 <span class="comment">     * If 3 or more places call it, put the child/toolwindow checks here</span>
05325 <span class="comment">     */</span>
05326     UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>));
05327     UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>));
05328 
05329     pMonitorPrimary = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
05330     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> == 1) {
05331         pMonitor = pMonitorPrimary;
05332     } <span class="keywordflow">else</span> {
05333         <span class="comment">/*</span>
05334 <span class="comment">         * In multiple monitor mode, windows that take up the entire</span>
05335 <span class="comment">         * virtual screen are not considered 'full screen'.  'Full screen'</span>
05336 <span class="comment">         * means full single monitor only.  This detection is so that any</span>
05337 <span class="comment">         * docked bars--tray, office'95 tools--can get out of the way for</span>
05338 <span class="comment">         * the application.</span>
05339 <span class="comment">         *</span>
05340 <span class="comment">         * There are only three types of windows that ought to go full</span>
05341 <span class="comment">         * virtual screen.  None of them need the tray et al. to get out of</span>
05342 <span class="comment">         * the way:</span>
05343 <span class="comment">         *      (1) Normal app windows that want a lot of space</span>
05344 <span class="comment">         *          * Those guys just activate and deactivate normally.</span>
05345 <span class="comment">         *      (2) Desktop windows</span>
05346 <span class="comment">         *          * Shell, User desktop sit behind everything else.</span>
05347 <span class="comment">         *      (3) Screen savers, demos, etc.</span>
05348 <span class="comment">         *          * These guys should be WS_EX_TOPMOST to ensure they sit</span>
05349 <span class="comment">         *            over everybody.</span>
05350 <span class="comment">         */</span>
05351         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a68">IsMaxedRect</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>, psrc))
05352             <span class="keywordflow">return</span> fYielded;
05353 
05354         <a class="code" href="../../d3/d6/rect_8c.html#a14">RECTFromSIZERECT</a>(&amp;rc, psrc);
05355         pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;rc, MONITOR_DEFAULTTOPRIMARY);
05356     }
05357 
05358     fIsPrimary = (pMonitor == pMonitorPrimary);
05359     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pMonitor, &amp;tlpMonitor);
05360 
05361     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a68">IsMaxedRect</a>(&amp;pMonitor-&gt;rcWork, psrc)) {
05362         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
05363             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a582">WFREALLYMAXIMIZABLE</a>);
05364 
05365             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> &gt; 1) {
05366                 <span class="comment">/*</span>
05367 <span class="comment">                 * BUGBUG: Check if app is before 4.1?</span>
05368 <span class="comment">                 */</span>
05369 
05370                 <span class="comment">/*</span>
05371 <span class="comment">                 * This is for XL '95 going fullscreen when already maxed.  It</span>
05372 <span class="comment">                 * always uses the primary display.  Let's hack them, and any</span>
05373 <span class="comment">                 * other old app that tries to move its truly maximized window.</span>
05374 <span class="comment">                 * They will be clipped otherwise by our fake regional stuff.</span>
05375 <span class="comment">                 */</span>
05376                 <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitorReal;
05377 
05378                 pMonitorReal = <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(pwnd, MONITOR_DEFAULTTOPRIMARY);
05379                 <span class="keywordflow">if</span> (pMonitorReal != pMonitor &amp;&amp; fIsPrimary) {
05380                     <span class="comment">/*</span>
05381 <span class="comment">                     * Transfer over the shape to the REAL monitor.</span>
05382 <span class="comment">                     */</span>
05383                     psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o0">x</a> += pMonitorReal-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left;
05384                     psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a>  += pMonitorReal-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top;
05385                     psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o2">cx</a> -= (pMonitor-&gt;rcMonitor.right - pMonitor-&gt;rcMonitor.left) +
05386                         (pMonitorReal-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - pMonitorReal-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left);
05387 
05388                     psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a> -= (pMonitor-&gt;rcMonitor.bottom - pMonitor-&gt;rcMonitor.top) +
05389                         (pMonitorReal-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - pMonitorReal-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
05390 
05391                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMonitor);
05392                     pMonitor = pMonitorReal;
05393                     fIsPrimary = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05394                     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pMonitor, &amp;tlpMonitor);
05395                 }
05396             }
05397         }
05398 
05399         <span class="keywordflow">if</span> (    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>) &amp;&amp;
05400                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a634">WFMAXBOX</a>)    &amp;&amp;
05401                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a645">WFBORDERMASK</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a646">WFCAPTION</a>))) {
05402 
05403             <span class="keywordflow">if</span> (    psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION) &lt;= pMonitor-&gt;rcMonitor.top &amp;&amp;
05404                     psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a> + psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a> &gt;= pMonitor-&gt;rcMonitor.bottom) {
05405 
05406                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a590">WFFULLSCREEN</a>)) {
05407                     <span class="comment">/*</span>
05408 <span class="comment">                     * Only want to do full screen stuff on the tray</span>
05409 <span class="comment">                     * monitor.</span>
05410 <span class="comment">                     */</span>
05411                     fYielded = <a class="code" href="../../d8/d7/winloop2_8c.html#a4">xxxAddFullScreen</a>(pwnd, pMonitor);
05412                 }
05413             } <span class="keywordflow">else</span> {
05414                 <span class="keywordtype">int</span> iRight;
05415                 <span class="keywordtype">int</span> iBottom;
05416                 <span class="keywordtype">int</span> dxy;
05417 
05418                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a590">WFFULLSCREEN</a>)) {
05419                     fYielded = <a class="code" href="../../d8/d7/winloop2_8c.html#a5">xxxRemoveFullScreen</a>(pwnd, pMonitor);
05420                 }
05421 
05422                 <span class="comment">/*</span>
05423 <span class="comment">                 * Despite the code in GetMinMaxInfo() to fix up</span>
05424 <span class="comment">                 * the max rect, we still have to hack old apps.</span>
05425 <span class="comment">                 * Word '95 &amp; XL '95 do weird things when going to/from</span>
05426 <span class="comment">                 * full screen when maximized already.</span>
05427 <span class="comment">                 *</span>
05428 <span class="comment">                 * NOTE:  you can have more than one docked bar on a</span>
05429 <span class="comment">                 * monitor.  Win '95 code doesn't work right in that</span>
05430 <span class="comment">                 * case.</span>
05431 <span class="comment">                 */</span>
05432                 dxy = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a7">GetWindowBorders</a>(pwnd-&gt;style, pwnd-&gt;ExStyle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05433                 dxy *= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
05434 
05435                 psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o0">x</a> = pMonitor-&gt;rcWork.left - dxy;
05436                 psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a> = pMonitor-&gt;rcWork.top - dxy;
05437 
05438                 dxy *= 2;
05439                 iRight =
05440                         pMonitor-&gt;rcWork.right - pMonitor-&gt;rcWork.left + dxy;
05441                 iBottom =
05442                         pMonitor-&gt;rcWork.bottom - pMonitor-&gt;rcWork.top + dxy;
05443 
05444                 <span class="comment">/*</span>
05445 <span class="comment">                 * Let console windows maximize smaller than defaults.</span>
05446 <span class="comment">                 */</span>
05447                 <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a281">gatomConsoleClass</a>) {
05448                     psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o2">cx</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iRight, psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o2">cx</a>);
05449                     psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iBottom, psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a>);
05450                 } <span class="keywordflow">else</span> {
05451                     psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o2">cx</a> = iRight;
05452 
05453                     <span class="comment">/*</span>
05454 <span class="comment">                     * B#14012 save QuickLink II that wants 4 pixels hanging off</span>
05455 <span class="comment">                     * the screen for every edge except the bottom edge, which</span>
05456 <span class="comment">                     * they only want to overhang by 2 pixels -- jeffbog 5/17/95</span>
05457 <span class="comment">                     *</span>
05458 <span class="comment">                     * BUT THIS CODE DOESN'T WORK FOR MULTIPLE MONITORS, so don't</span>
05459 <span class="comment">                     * do it on secondary dudes.  Else, XL '95 flakes out.</span>
05460 <span class="comment">                     */</span>
05461                     <span class="keywordflow">if</span> (fIsPrimary &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
05462                         psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iBottom, psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a>);
05463                     } <span class="keywordflow">else</span> {
05464                         psrc-&gt;<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a> = iBottom;
05465                     }
05466                 }
05467             }
05468 
05469         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a68">IsMaxedRect</a>(&amp;pMonitor-&gt;rcMonitor, psrc)) {
05470             fYielded = <a class="code" href="../../d8/d7/winloop2_8c.html#a4">xxxAddFullScreen</a>(pwnd, pMonitor);
05471         }
05472     } <span class="keywordflow">else</span> {
05473         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
05474             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a582">WFREALLYMAXIMIZABLE</a>);
05475         }
05476 
05477         fYielded = <a class="code" href="../../d8/d7/winloop2_8c.html#a5">xxxRemoveFullScreen</a>(pwnd, pMonitor);
05478     }
05479 
05480     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMonitor);
05481     <span class="keywordflow">return</span> fYielded;
05482 }
05483 
05484 <span class="comment">/***************************************************************************\</span>
05485 <span class="comment">* ClrFTrueVis</span>
05486 <span class="comment">*</span>
05487 <span class="comment">* Called when making a window invisible.  This routine destroys any update</span>
05488 <span class="comment">* regions that may exist, and clears the WF_TRUEVIS of all windows below</span>
05489 <span class="comment">* the passed in window.</span>
05490 <span class="comment">*</span>
05491 <span class="comment">* History:</span>
05492 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
05493 <span class="comment">\***************************************************************************/</span>
05494 
<a name="l05495"></a><a class="code" href="../../d4/d1/userk_8h.html#a1627">05495</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1627">ClrFTrueVis</a>(
05496     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
05497 {
05498     <span class="comment">/*</span>
05499 <span class="comment">     * Destroy pwnd and its children's update regions.</span>
05500 <span class="comment">     * We do this here to guarantee that a hidden window</span>
05501 <span class="comment">     * and its children don't have update regions.</span>
05502 <span class="comment">     *</span>
05503 <span class="comment">     * This fixes bugs when destroying windows that have</span>
05504 <span class="comment">     * update regions (SendDestroyMessages) among others</span>
05505 <span class="comment">     * and allows us to simplify SetParent().  This was</span>
05506 <span class="comment">     * deemed better than hacking DoPaint() and/or</span>
05507 <span class="comment">     * DestroyWindow().</span>
05508 <span class="comment">     *</span>
05509 <span class="comment">     * We can stop recursing when we find a window that doesn't</span>
05510 <span class="comment">     * have the visible bit set, because by definition it won't</span>
05511 <span class="comment">     * have any update regions below it (this routine will have been called)</span>
05512 <span class="comment">     */</span>
05513     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd)) {
05514 
05515         <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>);
05516 
05517         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>);
05518 
05519         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05520         <a class="code" href="../../d4/d1/userk_8h.html#a1470">DecPaintCount</a>(pwnd);
05521     }
05522 
05523     <span class="keywordflow">for</span> (pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
05524 
05525         <span class="comment">/*</span>
05526 <span class="comment">         * pwnd-&gt;fs &amp;= ~WF_TRUEVIS;</span>
05527 <span class="comment">         */</span>
05528         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
05529             <a class="code" href="../../d4/d1/userk_8h.html#a1627">ClrFTrueVis</a>(pwnd);
05530     }
05531 }
05532 
05533 <span class="comment">/***************************************************************************\</span>
05534 <span class="comment">* OffsetChildren</span>
05535 <span class="comment">*</span>
05536 <span class="comment">* Offsets the window and client rects of all children of hwnd.</span>
05537 <span class="comment">* Also deals with the children's update regions and SPB rects.</span>
05538 <span class="comment">*</span>
05539 <span class="comment">* History:</span>
05540 <span class="comment">* 22-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
05541 <span class="comment">\***************************************************************************/</span>
05542 
<a name="l05543"></a><a class="code" href="../../d4/d1/userk_8h.html#a1507">05543</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1507">OffsetChildren</a>(
05544     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
05545     <span class="keywordtype">int</span>    dx,
05546     <span class="keywordtype">int</span>    dy,
05547     LPRECT prcHitTest)
05548 {
05549     RECT    rc;
05550     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndStop;
05551 
05552     <span class="keywordflow">if</span> (!pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>)
05553         <span class="keywordflow">return</span>;
05554 
05555     pwndStop = pwnd;
05556     pwnd = pwndStop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
05557     <span class="keywordflow">for</span> (;;) {
05558         <span class="comment">/*</span>
05559 <span class="comment">         * Skip windows that don't intersect prcHitTest...</span>
05560 <span class="comment">         */</span>
05561         <span class="keywordflow">if</span> (prcHitTest &amp;&amp; !<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, prcHitTest, &amp;pwnd-&gt;rcWindow))
05562             <span class="keywordflow">goto</span> NextWindow;
05563 
05564         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left   += dx;
05565         pwnd-&gt;rcWindow.right  += dx;
05566         pwnd-&gt;rcWindow.top    += dy;
05567         pwnd-&gt;rcWindow.bottom += dy;
05568 
05569         pwnd-&gt;rcClient.left   += dx;
05570         pwnd-&gt;rcClient.right  += dx;
05571         pwnd-&gt;rcClient.top    += dy;
05572         pwnd-&gt;rcClient.bottom += dy;
05573 
05574         <span class="keywordflow">if</span> (pwnd-&gt;hrgnUpdate &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a> &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>)) {
05575             GreOffsetRgn(pwnd-&gt;hrgnUpdate, dx, dy);
05576         }
05577 
05578         <span class="comment">/*</span>
05579 <span class="comment">         * Change position of window region, if it has one</span>
05580 <span class="comment">         */</span>
05581         <span class="keywordflow">if</span> (pwnd-&gt;hrgnClip != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
05582             GreOffsetRgn(pwnd-&gt;hrgnClip, dx, dy);
05583 
05584         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a558">WFHASSPB</a>))
05585             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;(<a class="code" href="../../d4/d1/userk_8h.html#a1765">FindSpb</a>(pwnd))-&gt;rc, dx, dy);
05586 
05587 <span class="preprocessor">#ifdef CHILD_LAYERING</span>
05588 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a621">WEFLAYERED</a>)) {
05589             POINT ptPos = {pwnd-&gt;rcWindow.left, pwnd-&gt;rcWindow.top};
05590 
05591             GreUpdateSprite(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05592                     &amp;ptPos, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05593         }
05594 <span class="preprocessor">#endif // CHILD_LAYERING</span>
05595 <span class="preprocessor"></span>
05596         <span class="comment">/*</span>
05597 <span class="comment">         * Recurse into the child tree if there are children.</span>
05598 <span class="comment">         */</span>
05599         <span class="keywordflow">if</span> (pwnd-&gt;spwndChild) {
05600             pwnd = pwnd-&gt;spwndChild;
05601             <span class="keywordflow">continue</span>;
05602         }
05603 
05604 NextWindow:
05605         <span class="keywordflow">if</span> (pwnd-&gt;spwndNext) {
05606             <span class="comment">/*</span>
05607 <span class="comment">             * Recurse to the next sibling in the list.</span>
05608 <span class="comment">             */</span>
05609             pwnd = pwnd-&gt;spwndNext;
05610         } <span class="keywordflow">else</span> {
05611             <span class="keywordflow">for</span> (;;) {
05612                 <span class="comment">/*</span>
05613 <span class="comment">                 * We're at the end of the sibling window list.</span>
05614 <span class="comment">                 * Go to the parent's next window.</span>
05615 <span class="comment">                 */</span>
05616                 pwnd = pwnd-&gt;spwndParent;
05617                 <span class="keywordflow">if</span> (pwnd == pwndStop)
05618                     <span class="keywordflow">return</span>;
05619 
05620                 <span class="keywordflow">if</span> (pwnd-&gt;spwndNext) {
05621                     pwnd = pwnd-&gt;spwndNext;
05622                     <span class="keywordflow">break</span>;
05623                 }
05624             }
05625         }
05626     }
05627 }
05628 
05629 <span class="comment">/***************************************************************************\</span>
05630 <span class="comment">* SetWindowRgn</span>
05631 <span class="comment">*</span>
05632 <span class="comment">* Parameters:</span>
05633 <span class="comment">*     hwnd    --  Window handle</span>
05634 <span class="comment">*     hrgn    --  Region to set into window. NULL can be accepted.</span>
05635 <span class="comment">*     fRedraw --  TRUE to go through SetWindowPos() and calculate</span>
05636 <span class="comment">*                 update regions correctly. If the window is visible</span>
05637 <span class="comment">*                 this will usually be TRUE.</span>
05638 <span class="comment">*</span>
05639 <span class="comment">* Returns:</span>
05640 <span class="comment">*     TRUE for success, FALSE for failure</span>
05641 <span class="comment">*</span>
05642 <span class="comment">* Comments:</span>
05643 <span class="comment">*     This is a very simple routine to set a window region. It goes through</span>
05644 <span class="comment">*     SetWindowPos() to get perfect update region calculation, and to deal</span>
05645 <span class="comment">*     with other related issues like vis rgn change &amp; dc invalidation,</span>
05646 <span class="comment">*     display lock holding, spb invalidation, etc. Also since it sends</span>
05647 <span class="comment">*     WM_WINDOWPOSCHANGING &amp; WM_WINDOWPOSCHANGED, we'll be able to expand</span>
05648 <span class="comment">*     SetWindowPos() in the future to take hrgns directly for efficient</span>
05649 <span class="comment">*     window state change control (like setting the rect and region at</span>
05650 <span class="comment">*     the same time, among others) without harming compatibility.</span>
05651 <span class="comment">*</span>
05652 <span class="comment">*     hrgn is in window rect coordinates (not client rect coordinates).</span>
05653 <span class="comment">*     Once set, hrgn is owned by the system. A copy is not made!</span>
05654 <span class="comment">*</span>
05655 <span class="comment">* 30-Jul-1994 ScottLu   Created.</span>
05656 <span class="comment">\***************************************************************************/</span>
05657 
<a name="l05658"></a><a class="code" href="../../d2/d8/swp_8c.html#a14">05658</a> <span class="preprocessor">#define SWR_FLAGS_REDRAW   (SWP_NOCHANGE | SWP_FRAMECHANGED | SWP_NOACTIVATE)</span>
<a name="l05659"></a><a class="code" href="../../d2/d8/swp_8c.html#a15">05659</a> <span class="preprocessor"></span><span class="preprocessor">#define SWR_FLAGS_NOREDRAW (SWP_NOCHANGE | SWP_FRAMECHANGED | SWP_NOACTIVATE | SWP_NOREDRAW)</span>
05660 <span class="preprocessor"></span>
<a name="l05661"></a><a class="code" href="../../d4/d1/userk_8h.html#a1610">05661</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1610">xxxSetWindowRgn</a>(
05662     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
05663     HRGN hrgn,
05664     BOOL fRedraw)
05665 {
05666     <a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a> psmwp;
05667     HRGN  hrgnClip = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05668     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05669 
05670     <span class="comment">/*</span>
05671 <span class="comment">     * Validate the region handle.  We did this for 3.51, so</span>
05672 <span class="comment">     * we better do it for later versions.  Our validation will</span>
05673 <span class="comment">     * make a copy of the clip-rgn and send it through to the</span>
05674 <span class="comment">     * SetWIndowRgn code.  Once this is set in the kernel, we</span>
05675 <span class="comment">     * will return to the client and the old region will be deleted</span>
05676 <span class="comment">     * there.</span>
05677 <span class="comment">     *</span>
05678 <span class="comment">     * If the region passed in is NULL, then we get rid of the</span>
05679 <span class="comment">     * current retion.  Map it to HRGN_FULL so that SetWindowPos()</span>
05680 <span class="comment">     * can tell this is what the caller wants.</span>
05681 <span class="comment">     */</span>
05682     <span class="keywordflow">if</span> (hrgn) {
05683 
05684         <span class="keywordflow">if</span> ((hrgnClip = <a class="code" href="../../d7/d3/validate_8c.html#a8">UserValidateCopyRgn</a>(hrgn)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05685 
05686 <span class="preprocessor">#if DBG</span>
05687 <span class="preprocessor"></span>            RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxSetWindowRgn: Failed to create region!"</span>);
05688 <span class="preprocessor">#endif</span>
05689 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> swrClean;
05690         }
05691 <span class="preprocessor">#ifdef USE_MIRRORING</span>
05692 <span class="preprocessor"></span>        MirrorRegion(pwnd, hrgnClip, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05693 <span class="preprocessor">#endif</span>
05694 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
05695 
05696         hrgnClip = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
05697     }
05698 
05699     <span class="comment">/*</span>
05700 <span class="comment">     * Get a psmwp, and put the region in it, correctly offset.</span>
05701 <span class="comment">     * Use SWP_FRAMECHANGED with acts really as a "empty" SetWindowPos</span>
05702 <span class="comment">     * that still sends WM_WINDOWPOSCHANGING and CHANGED messages.</span>
05703 <span class="comment">     * SWP_NOCHANGE ensures that we don't size, move, activate, zorder.</span>
05704 <span class="comment">     */</span>
05705     <span class="keywordflow">if</span> (psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1616">InternalBeginDeferWindowPos</a>(1)) {
05706 
05707         <span class="comment">/*</span>
05708 <span class="comment">         * psmwp gets freed automatically if this routine fails.</span>
05709 <span class="comment">         */</span>
05710         <span class="keywordflow">if</span> (psmwp = <a class="code" href="../../d4/d1/userk_8h.html#a1619">_DeferWindowPos</a>(
05711                 psmwp,
05712                 pwnd,
05713                 <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
05714                 0,
05715                 0,
05716                 0,
05717                 0,
05718                 fRedraw ? <a class="code" href="../../d2/d8/swp_8c.html#a14">SWR_FLAGS_REDRAW</a> : <a class="code" href="../../d2/d8/swp_8c.html#a15">SWR_FLAGS_NOREDRAW</a>)) {
05719 
05720             <span class="comment">/*</span>
05721 <span class="comment">             * Do the operation. Note that hrgn is still in window coordinates.</span>
05722 <span class="comment">             * SetWindowPos() will change it to screen coordinates before</span>
05723 <span class="comment">             * selecting into the window.</span>
05724 <span class="comment">             */</span>
05725             psmwp-&gt;<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>[0].<a class="code" href="../../d2/d2/structtagCVR.html#o11">hrgnClip</a> = hrgnClip;
05726             bRet = <a class="code" href="../../d4/d1/userk_8h.html#a1620">xxxEndDeferWindowPosEx</a>(psmwp, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05727         }
05728     }
05729 
05730     <span class="comment">/*</span>
05731 <span class="comment">     * If the call failed, then delete our region we created.  A FALSE</span>
05732 <span class="comment">     * return means it should've never made it to the xxxSelectWindowRgn</span>
05733 <span class="comment">     * call, so everything should be as it was.</span>
05734 <span class="comment">     */</span>
05735     <span class="keywordflow">if</span> (!bRet &amp;&amp; (hrgnClip != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>)) {
05736 
05737 swrClean:
05738 
05739         GreDeleteObject(hrgnClip);
05740     }
05741 
05742     <span class="keywordflow">return</span> bRet;
05743 }
05744 
05745 <span class="comment">/***************************************************************************\</span>
05746 <span class="comment">* SelectWindowRgn</span>
05747 <span class="comment">*</span>
05748 <span class="comment">* This routine does the work of actually selecting in the window region.</span>
05749 <span class="comment">*</span>
05750 <span class="comment">* 30-Jul-1994 ScottLu   Created.</span>
05751 <span class="comment">\***************************************************************************/</span>
05752 
<a name="l05753"></a><a class="code" href="../../d4/d1/userk_8h.html#a1611">05753</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1611">SelectWindowRgn</a>(
05754     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
05755     HRGN hrgnClip)
05756 {
05757     <span class="comment">/*</span>
05758 <span class="comment">     * If there is a region already there, delete it because</span>
05759 <span class="comment">     * a new one is being set.  For maximized windows in multiple monitor</span>
05760 <span class="comment">     * mode, we always use the monitor HRGN.  We don't make a copy.  This</span>
05761 <span class="comment">     * way, when the hrgn changes because of monitor config, the window's</span>
05762 <span class="comment">     * monitor region automatically gets updated.  Clever huh?  Also saves</span>
05763 <span class="comment">     * memory.</span>
05764 <span class="comment">     */</span>
05765     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05766         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>)) {
05767             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>);
05768         } <span class="keywordflow">else</span> {
05769             <span class="comment">/*</span>
05770 <span class="comment">             * Do NOT select in a monitor region if the window is normally</span>
05771 <span class="comment">             * regional.  The MinMaximize code will always pass HRGN_MONITOR</span>
05772 <span class="comment">             * to us no matter what.  But when we get here, bail out and</span>
05773 <span class="comment">             * don't destroy the app's region if it has one.</span>
05774 <span class="comment">             */</span>
05775             <span class="keywordflow">if</span> (hrgnClip == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a878">HRGN_MONITOR</a>)
05776                 <span class="keywordflow">return</span>;
05777 
05778             GreDeleteObject(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>);
05779         }
05780 
05781         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05782     }
05783 
05784     <span class="comment">/*</span>
05785 <span class="comment">     * NULL or HRGN_FULL means "set to NULL". If we have a real region,</span>
05786 <span class="comment">     * use it. USER needs to own it, and it needs to be in screen</span>
05787 <span class="comment">     * coordinates.</span>
05788 <span class="comment">     */</span>
05789     <span class="keywordflow">if</span> (hrgnClip &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
05790 
05791         <span class="keywordflow">if</span> (hrgnClip == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a878">HRGN_MONITOR</a>) {
05792             <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor;
05793 
05794             <span class="comment">/*</span>
05795 <span class="comment">             * Use the monitor region if the window is really maxed</span>
05796 <span class="comment">             * on a monitor.  It's already happened by the time we get here,</span>
05797 <span class="comment">             * if so.  And xxxCheckFullScreen will clear the reallymaximed</span>
05798 <span class="comment">             * style for a maximized window if it doesn't cover the whole</span>
05799 <span class="comment">             * max area.</span>
05800 <span class="comment">             */</span>
05801             UserAssert(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd));
05802 
05803             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a582">WFREALLYMAXIMIZABLE</a>))
05804                 <span class="keywordflow">return</span>;
05805 
05806             <span class="comment">/*</span>
05807 <span class="comment">             * Do nothing for windows off screen.</span>
05808 <span class="comment">             */</span>
05809             pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(pwnd, MONITOR_DEFAULTTONULL);
05810             <span class="keywordflow">if</span> (!pMonitor)
05811                 <span class="keywordflow">return</span>;
05812 
05813             hrgnClip = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o5">hrgnMonitor</a>;
05814             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>);
05815         } <span class="keywordflow">else</span> {
05816             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
05817                 GreOffsetRgn(hrgnClip, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
05818             }
05819 
05820             GreSetRegionOwner(hrgnClip, OBJECT_OWNER_PUBLIC);
05821         }
05822 
05823         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> = hrgnClip;
05824     }
05825 }
05826 
05827 
05828 <span class="comment">/***************************************************************************\</span>
05829 <span class="comment">* TestRectBogus</span>
05830 <span class="comment">*</span>
05831 <span class="comment">* Returns TRUE if the window rect [x,y,cx,cy] is centered or</span>
05832 <span class="comment">* clipped to the monitor or work rect [prc], FALSE otherwise.</span>
05833 <span class="comment">*</span>
05834 <span class="comment">* History:</span>
05835 <span class="comment">* 26-Mar-1997 adams     Created.</span>
05836 <span class="comment">\***************************************************************************/</span>
05837 
<a name="l05838"></a><a class="code" href="../../d2/d8/swp_8c.html#a16">05838</a> <span class="preprocessor">#define SLOP_X 8</span>
<a name="l05839"></a><a class="code" href="../../d2/d8/swp_8c.html#a17">05839</a> <span class="preprocessor"></span><span class="preprocessor">#define SLOP_Y 8</span>
05840 <span class="preprocessor"></span>
05841 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l05842"></a><a class="code" href="../../d2/d8/swp_8c.html#a74">05842</a> <a class="code" href="../../d2/d8/swp_8c.html#a74">TestRectBogus</a>(RECT * prc, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy)
05843 {
05844     <span class="comment">//</span>
05845     <span class="comment">//  check for a fullscreen (or offscreen) window</span>
05846     <span class="comment">//</span>
05847     <span class="keywordflow">if</span> (    x  &lt;= prc-&gt;left &amp;&amp;
05848             y  &lt;= prc-&gt;top &amp;&amp;
05849             cx &gt;= (prc-&gt;right  - prc-&gt;left) &amp;&amp;
05850             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt;= (prc-&gt;bottom - prc-&gt;top)) {
05851 
05852         <span class="comment">// rect is fullscreen</span>
05853         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05854     }
05855 
05856     <span class="comment">//</span>
05857     <span class="comment">//  check for the window being centered to the work area</span>
05858     <span class="comment">//  use &lt;= for y to catch dialogs centered "high"</span>
05859     <span class="comment">//  (like the network logon dialog)</span>
05860     <span class="comment">//</span>
05861     <span class="keywordflow">if</span> (    <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(x - (prc-&gt;right + prc-&gt;left - cx) / 2) &lt;= <a class="code" href="../../d2/d8/swp_8c.html#a16">SLOP_X</a> &amp;&amp;
05862             <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(y - (prc-&gt;bottom + prc-&gt;top - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) / 2) &lt;= <a class="code" href="../../d2/d8/swp_8c.html#a17">SLOP_Y</a> ) {
05863 
05864         <span class="comment">// rect centered</span>
05865         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05866     }
05867 
05868     <span class="comment">//</span>
05869     <span class="comment">//  check for the window being cliped to the work area</span>
05870     <span class="comment">//</span>
05871     <span class="keywordflow">if</span> (    x == prc-&gt;left ||
05872             y == prc-&gt;top ||
05873             x == (prc-&gt;right - cx) ||
05874             y == (prc-&gt;bottom - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) {
05875 
05876         <span class="comment">// rect is clipped</span>
05877         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05878     }
05879 
05880     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05881 }
05882 
05883 
05884 <span class="comment">/***************************************************************************\</span>
05885 <span class="comment">* IsRectBogus</span>
05886 <span class="comment">*</span>
05887 <span class="comment">* Returns TRUE if the window rect [x,y,cx,cy] is centered or</span>
05888 <span class="comment">* clipped to the monitor or work rect of the primary monitor.</span>
05889 <span class="comment">*</span>
05890 <span class="comment">* History:</span>
05891 <span class="comment">* 26-Mar-1997 adams     Created.</span>
05892 <span class="comment">\***************************************************************************/</span>
05893 
05894 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l05895"></a><a class="code" href="../../d2/d8/swp_8c.html#a75">05895</a> <a class="code" href="../../d2/d8/swp_8c.html#a75">IsRectBogus</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy)
05896 {
05897     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitorPrimary = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
05898 
05899     <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/swp_8c.html#a74">TestRectBogus</a>(&amp;pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>, x, y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) ||
05900            <a class="code" href="../../d2/d8/swp_8c.html#a74">TestRectBogus</a>(&amp;pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>, x, y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
05901 }
05902 
05903 
05904 
05905 <span class="comment">/***************************************************************************\</span>
05906 <span class="comment">* FixBogusSWP</span>
05907 <span class="comment">*</span>
05908 <span class="comment">* Detects if a rect is being centered or clipped to the primary monitor,</span>
05909 <span class="comment">* and centers it in its owner's window if so. This prevents apps that</span>
05910 <span class="comment">* are not multimon aware from having their "main" window displayed on</span>
05911 <span class="comment">* one monitor but their dialogs moved to the primary monitor</span>
05912 <span class="comment">* because they believe the dialog is offscreen.</span>
05913 <span class="comment">*</span>
05914 <span class="comment">* History:</span>
05915 <span class="comment">* 26-Mar-1997 adams     Created.</span>
05916 <span class="comment">\***************************************************************************/</span>
05917 
05918 <span class="keywordtype">void</span>
<a name="l05919"></a><a class="code" href="../../d2/d8/swp_8c.html#a18">05919</a> <a class="code" href="../../d2/d8/swp_8c.html#a18">FixBogusSWP</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> * px, <span class="keywordtype">int</span> * py, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy, UINT flags)
05920 {
05921     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor;
05922 
05923     pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>, MONITOR_DEFAULTTONEAREST);
05924 
05925     <span class="comment">//</span>
05926     <span class="comment">// only check for a bogus SWP if the owner is not on the primary</span>
05927     <span class="comment">//</span>
05928     <span class="keywordflow">if</span> (pMonitor != <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>()) {
05929 
05930         <span class="comment">//</span>
05931         <span class="comment">// get the current size if SWP_NOSIZE is set</span>
05932         <span class="comment">//</span>
05933         <span class="keywordflow">if</span> (flags &amp; SWP_NOSIZE) {
05934             cx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right  - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
05935             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
05936         }
05937 
05938         <span class="comment">//</span>
05939         <span class="comment">// see if the app is trying to center or clip the window</span>
05940         <span class="comment">//</span>
05941         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/swp_8c.html#a75">IsRectBogus</a>(*px, *py, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>))
05942         {
05943             RECT rc;
05944 
05945 <span class="preprocessor">#if DBG</span>
05946 <span class="preprocessor"></span>            <span class="keywordtype">int</span> oldX = *px;
05947             <span class="keywordtype">int</span> oldY = *py;
05948 <span class="preprocessor">#endif</span>
05949 <span class="preprocessor"></span>
05950             <span class="comment">//</span>
05951             <span class="comment">// the app wants to center/clip the window</span>
05952             <span class="comment">// we will have to do it for them.</span>
05953             <span class="comment">//</span>
05954             <span class="comment">// get the window rect of the parent and</span>
05955             <span class="comment">// intersect that with the work area of</span>
05956             <span class="comment">// the owning monitor, then center the</span>
05957             <span class="comment">// window to this rect.</span>
05958             <span class="comment">//</span>
05959             <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
05960 
05961             <span class="comment">//</span>
05962             <span class="comment">// new multimonior friendly position.</span>
05963             <span class="comment">//</span>
05964             *px = rc.left + (rc.right  - rc.left - cx) / 2;
05965             *py = rc.top  + (rc.bottom - rc.top  - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) / 2;
05966 
05967             <span class="comment">//</span>
05968             <span class="comment">// now clip to the work area.</span>
05969             <span class="comment">//</span>
05970             <span class="keywordflow">if</span> (*px + cx &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right) {
05971                 *px = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right - cx;
05972             }
05973 
05974             <span class="keywordflow">if</span> (*py + <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom) {
05975                 *py = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
05976             }
05977 
05978             <span class="keywordflow">if</span> (*px &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left) {
05979                 *px = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left;
05980             }
05981 
05982             <span class="keywordflow">if</span> (*py &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top) {
05983                 *py = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top;
05984             }
05985 
05986             RIPMSG0(RIP_WARNING | RIP_THERESMORE,              <span class="stringliteral">"SetWindowPos detected that your app is centering or clipping"</span>);
05987             RIPMSG0(RIP_WARNING | RIP_THERESMORE | RIP_NONAME, <span class="stringliteral">"a window to the primary monitor when its owner is on a different monitor."</span>);
05988             RIPMSG0(RIP_WARNING | RIP_THERESMORE | RIP_NONAME, <span class="stringliteral">"Consider fixing your app to use the Window Manager Multimonitor APIs."</span>);
05989             RIPMSG4(RIP_WARNING | RIP_NONAME,                  <span class="stringliteral">"SetWindowPos moved the window from (%d,%d) to (%d,%d).\n"</span>,
05990                                                                oldX, oldY, *px, *py);
05991         }
05992     }
05993 }
05994 
05995 <span class="comment">/***************************************************************************\</span>
05996 <span class="comment">* PreventInterMonitorBlts()</span>
05997 <span class="comment">*</span>
05998 <span class="comment">* Prevents monitor-to-monitor blts when they are different caps.  This</span>
05999 <span class="comment">* way we redraw the part of a window that moves to a different monitor.</span>
06000 <span class="comment">* We try to blt as much as possible.</span>
06001 <span class="comment">*</span>
06002 <span class="comment">* We look at the source rect and what monitor owns it, and how much that</span>
06003 <span class="comment">* monitor also contains of the destination rect.  Then we compare that</span>
06004 <span class="comment">* with the destination rect and what monitor owns that, and how much it</span>
06005 <span class="comment">* contains of the source rect.  The larger wins.</span>
06006 <span class="comment">*</span>
06007 <span class="comment">* rcBlt is in screen coordinates and is the DESTINATION.</span>
06008 <span class="comment">*</span>
06009 <span class="comment">* History:</span>
06010 <span class="comment">* 11-11-1997    vadimg      ported from Memphis</span>
06011 <span class="comment">\***************************************************************************/</span>
06012 
<a name="l06013"></a><a class="code" href="../../d2/d8/swp_8c.html#a19">06013</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d8/swp_8c.html#a19">PreventInterMonitorBlts</a>(<a class="code" href="../../d2/d2/structtagCVR.html">PCVR</a> pcvr)
06014 {
06015     RECT        rcSrc;
06016     RECT        rcDst;
06017     RECT        rcSrcT;
06018     RECT        rcDstT;
06019     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
06020     <span class="comment">//</span>
06021     <span class="comment">// If the destination is empty do nothing.</span>
06022     <span class="comment">//</span>
06023     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a4">IsRectEmpty</a>(&amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>))
06024         <span class="keywordflow">return</span>;
06025 
06026     <span class="comment">//</span>
06027     <span class="comment">// Get the source rect (rcBlt is the destination, dxBlt/dyBlt are the</span>
06028     <span class="comment">// distance moved from the source).</span>
06029     <span class="comment">//</span>
06030     <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(&amp;rcSrc, &amp;pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o5">rcBlt</a>, -pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>, -pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>);
06031 
06032     <span class="comment">//</span>
06033     <span class="comment">// Split up the source into its monitor pieces.  If the source intersects</span>
06034     <span class="comment">// a monitor, then figure out where that part will be in the destination.</span>
06035     <span class="comment">// Intersect the destination part with the same monitor.  The result is</span>
06036     <span class="comment">// the amount we can blt from the source to the dest on that monitor.</span>
06037     <span class="comment">//</span>
06038     <span class="comment">// We do this for each monitor to find the biggest blt rect.  We want</span>
06039     <span class="comment">// the biggest because we want to repaint as little as possible.  We do</span>
06040     <span class="comment">// bail out if both the source and dest are fully contained on the same</span>
06041     <span class="comment">// monitor.</span>
06042     <span class="comment">//</span>
06043     <span class="keywordflow">for</span> (pMonitor = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a>;
06044             pMonitor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06045             pMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o1">pMonitorNext</a>) {
06046 
06047         <span class="comment">//</span>
06048         <span class="comment">// We're only interested in visible monitors</span>
06049         <span class="comment">//</span>
06050         <span class="keywordflow">if</span> (!(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o2">dwMONFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a525">MONF_VISIBLE</a>))
06051             <span class="keywordflow">continue</span>;
06052         <span class="comment">//</span>
06053         <span class="comment">// If this monitor doesn't contain a piece of the source, we don't</span>
06054         <span class="comment">// care about it.  We won't be doing a same monitor blt on it for sure.</span>
06055         <span class="comment">//</span>
06056         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcSrcT, &amp;rcSrc, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>))
06057             <span class="keywordflow">continue</span>;
06058 
06059         <span class="comment">//</span>
06060         <span class="comment">// See where this rect would be in the destination.</span>
06061         <span class="comment">//</span>
06062         <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(&amp;rcDst, &amp;rcSrcT, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o6">dxBlt</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o7">dyBlt</a>);
06063 
06064         <span class="comment">//</span>
06065         <span class="comment">// Intersect this rect with the same monitor rect to see what piece</span>
06066         <span class="comment">// can be safely blted on the same monitor.</span>
06067         <span class="comment">//</span>
06068         <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcDstT, &amp;rcDst, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>);
06069 
06070         <span class="comment">//</span>
06071         <span class="comment">// Is this piece of the source staying on this monitor?</span>
06072         <span class="comment">//</span>
06073         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rcDstT, &amp;rcDst)) {
06074             <span class="comment">//</span>
06075             <span class="comment">// This source piece is staying completely on this monitor when</span>
06076             <span class="comment">// it becomes the destination.  Hence there is nothing to add</span>
06077             <span class="comment">// to our invalid sum, hrgnInterMonitor.</span>
06078             <span class="comment">//</span>
06079             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rcSrcT, &amp;rcSrc)) {
06080                 <span class="comment">//</span>
06081                 <span class="comment">// The source is completely ON one monitor and moving to</span>
06082                 <span class="comment">// a location also completely ON this monitor. Great, no</span>
06083                 <span class="comment">// intermonitor blts whatsoever.  We are done.</span>
06084                 <span class="comment">//</span>
06085                 UserAssert(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06086                 <span class="keywordflow">return</span>;
06087             } <span class="keywordflow">else</span> {
06088                 <span class="keywordflow">continue</span>;
06089             }
06090         }
06091 
06092         <span class="comment">//</span>
06093         <span class="comment">// OK, some piece of the source is moving across monitors.  Figure</span>
06094         <span class="comment">// out what it is and where that piece is in the destination.  That</span>
06095         <span class="comment">// piece in the destination must be invalidated and not blted.</span>
06096         <span class="comment">//</span>
06097         <span class="keywordflow">if</span> (pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06098             pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
06099         }
06100 
06101         <span class="comment">//</span>
06102         <span class="comment">// The difference between the transposed source to the dest, and the</span>
06103         <span class="comment">// real part of the dest that lies on this monitor, is the amount</span>
06104         <span class="comment">// of the source that will move across a monitor boundary.  Add this</span>
06105         <span class="comment">// to our accumulated invalid region.</span>
06106         <span class="comment">//</span>
06107         <span class="comment">// rcDst is the whole source chunk, rcDstT is the part on the same</span>
06108         <span class="comment">// monitor as the source chunk.</span>
06109         <span class="comment">//</span>
06110         GreSetRectRgn(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, rcDst.left, rcDst.top, rcDst.right, rcDst.bottom);
06111         GreSetRectRgn(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>, rcDstT.left, rcDstT.top, rcDstT.right, rcDstT.bottom);
06112         <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>);
06113         <a class="code" href="../../d4/d1/userk_8h.html#a230">UnionRgn</a>(pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a>, pcvr-&gt;<a class="code" href="../../d2/d2/structtagCVR.html#o12">hrgnInterMonitor</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>);
06114     }
06115 <span class="preprocessor">#if DBG</span>
06116 <span class="preprocessor"></span>    VerifyVisibleMonitorCount();
06117 <span class="preprocessor">#endif</span>
06118 <span class="preprocessor"></span>}
06119 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:55 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
