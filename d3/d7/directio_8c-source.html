<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: directio.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>directio.c</h1><a href="../../d2/d8/directio_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    directio.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file implements the NT console direct I/O API</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 6-Nov-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00022 <span class="preprocessor">#pragma hdrstop</span>
00023 <span class="preprocessor"></span>
00024 
00025 <span class="preprocessor">#if defined(FE_SB)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#define WWSB_FE</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d6/d8/dispatch_8h.html">dispatch.h</a>"</span> <span class="comment">// get the FE_ prototypes</span>
00028 <span class="preprocessor">#undef  WWSB_FE</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_TranslateInputToOem)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_TranslateInputToUnicode)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_TranslateOutputToOem)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_TranslateOutputToOemUnicode)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_TranslateOutputToUnicode)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_TranslateOutputToAnsiUnicode)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 
00038 <span class="preprocessor">#if defined(FE_SB)</span>
00039 <span class="preprocessor"></span>ULONG
00040 <a class="code" href="../../d6/d8/dispatch_8h.html#a24">SB_TranslateInputToOem</a>
00041 <span class="preprocessor">#else</span>
00042 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00043 <a class="code" href="../../d2/d8/directio_8c.html#a0">TranslateInputToOem</a>
00044 <span class="preprocessor">#endif</span>
<a name="l00045"></a><a class="code" href="../../d2/d8/directio_8c.html#a0">00045</a> <span class="preprocessor"></span>    (
00046     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00047     IN OUT PINPUT_RECORD InputRecords,
00048     IN ULONG NumRecords
00049     )
00050 {
00051     ULONG i;
00052 
00053     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"TranslateInputToOem\n"</span>));
00054     <span class="keywordflow">for</span> (i=0;i&lt;NumRecords;i++) {
00055         <span class="keywordflow">if</span> (InputRecords[i].EventType == KEY_EVENT) {
00056             InputRecords[i].Event.KeyEvent.uChar.AsciiChar = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a40">WcharToChar</a>(
00057                     Console-&gt;CP, InputRecords[i].Event.KeyEvent.uChar.UnicodeChar);
00058         }
00059     }
00060 <span class="preprocessor">#if defined(FE_SB)</span>
00061 <span class="preprocessor"></span>    <span class="keywordflow">return</span> NumRecords;
00062 <span class="preprocessor">#else</span>
00063 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00064 <span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>}
00066 
00067 <span class="preprocessor">#if defined(FE_SB)</span>
00068 <span class="preprocessor"></span>ULONG
00069 <a class="code" href="../../d6/d8/dispatch_8h.html#a23">FE_TranslateInputToOem</a>(
00070     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00071     IN OUT PINPUT_RECORD InputRecords,
00072     IN ULONG NumRecords,    <span class="comment">// in : ASCII byte count</span>
00073     IN ULONG UnicodeLength, <span class="comment">// in : Number of events (char count)</span>
00074     OUT PINPUT_RECORD DbcsLeadInpRec
00075     )
00076 {
00077     ULONG i,j;
00078     PINPUT_RECORD TmpInpRec;
00079     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> AsciiDbcs[2];
00080     ULONG NumBytes;
00081 
00082     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NumRecords &gt;= UnicodeLength);
00083 
00084     TmpInpRec = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),NumRecords*<span class="keyword">sizeof</span>(INPUT_RECORD));
00085     <span class="keywordflow">if</span> (TmpInpRec == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00086         <span class="keywordflow">return</span> 0;
00087 
00088     memcpy(TmpInpRec,InputRecords,NumRecords*<span class="keyword">sizeof</span>(INPUT_RECORD));
00089     AsciiDbcs[1] = 0;
00090     <span class="keywordflow">for</span> (i=0,j=0; i&lt;UnicodeLength; i++,j++) {
00091         <span class="keywordflow">if</span> (TmpInpRec[i].EventType == KEY_EVENT) {
00092             <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,
00093                                    Console-&gt;CP,TmpInpRec[i].Event.KeyEvent.uChar.UnicodeChar)) {
00094                 NumBytes = <span class="keyword">sizeof</span>(AsciiDbcs);
00095                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;CP,
00096                        &amp;TmpInpRec[i].Event.KeyEvent.uChar.UnicodeChar,
00097                        1,
00098                        &amp;AsciiDbcs[0],
00099                        NumBytes
00100                        );
00101                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>(AsciiDbcs[0],&amp;Console-&gt;CPInfo)) {
00102                     <span class="keywordflow">if</span> (j &lt; NumRecords-1) {  <span class="comment">// -1 is safe DBCS in buffer</span>
00103                         InputRecords[j] = TmpInpRec[i];
00104                         InputRecords[j].Event.KeyEvent.uChar.UnicodeChar = 0;
00105                         InputRecords[j].Event.KeyEvent.uChar.AsciiChar = AsciiDbcs[0];
00106                         j++;
00107                         InputRecords[j] = TmpInpRec[i];
00108                         InputRecords[j].Event.KeyEvent.uChar.UnicodeChar = 0;
00109                         InputRecords[j].Event.KeyEvent.uChar.AsciiChar = AsciiDbcs[1];
00110                         AsciiDbcs[1] = 0;
00111                     }
00112                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j == NumRecords-1) {
00113                         InputRecords[j] = TmpInpRec[i];
00114                         InputRecords[j].Event.KeyEvent.uChar.UnicodeChar = 0;
00115                         InputRecords[j].Event.KeyEvent.uChar.AsciiChar = AsciiDbcs[0];
00116                         j++;
00117                         <span class="keywordflow">break</span>;
00118                     }
00119                     <span class="keywordflow">else</span> {
00120                         AsciiDbcs[1] = 0;
00121                         <span class="keywordflow">break</span>;
00122                     }
00123                 }
00124                 <span class="keywordflow">else</span> {
00125                     InputRecords[j] = TmpInpRec[i];
00126                     InputRecords[j].Event.KeyEvent.uChar.UnicodeChar = 0;
00127                     InputRecords[j].Event.KeyEvent.uChar.AsciiChar = AsciiDbcs[0];
00128                     AsciiDbcs[1] = 0;
00129                 }
00130             }
00131             <span class="keywordflow">else</span> {
00132                 InputRecords[j] = TmpInpRec[i];
00133                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;CP,
00134                        &amp;InputRecords[j].Event.KeyEvent.uChar.UnicodeChar,
00135                        1,
00136                        &amp;InputRecords[j].Event.KeyEvent.uChar.AsciiChar,
00137                        1
00138                        );
00139             }
00140         }
00141     }
00142     <span class="keywordflow">if</span> (DbcsLeadInpRec) {
00143         <span class="keywordflow">if</span> (AsciiDbcs[1]) {
00144             *DbcsLeadInpRec = TmpInpRec[i];
00145             DbcsLeadInpRec-&gt;Event.KeyEvent.uChar.AsciiChar = AsciiDbcs[1];
00146         }
00147         <span class="keywordflow">else</span> {
00148             RtlZeroMemory(DbcsLeadInpRec,<span class="keyword">sizeof</span>(INPUT_RECORD));
00149         }
00150     }
00151     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TmpInpRec);
00152     <span class="keywordflow">return</span> j;
00153 }
00154 <span class="preprocessor">#endif</span>
00155 <span class="preprocessor"></span>
00156 
00157 
00158 <span class="preprocessor">#if defined(FE_SB)</span>
00159 <span class="preprocessor"></span>ULONG
00160 <a class="code" href="../../d6/d8/dispatch_8h.html#a21">SB_TranslateInputToUnicode</a>
00161 <span class="preprocessor">#else</span>
00162 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00163 <a class="code" href="../../d2/d8/directio_8c.html#a1">TranslateInputToUnicode</a>
00164 <span class="preprocessor">#endif</span>
<a name="l00165"></a><a class="code" href="../../d2/d8/directio_8c.html#a1">00165</a> <span class="preprocessor"></span>    (
00166     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00167     IN OUT PINPUT_RECORD InputRecords,
00168     IN ULONG NumRecords
00169     )
00170 {
00171     ULONG i;
00172     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"TranslateInputToUnicode\n"</span>));
00173     <span class="keywordflow">for</span> (i=0;i&lt;NumRecords;i++) {
00174         <span class="keywordflow">if</span> (InputRecords[i].EventType == KEY_EVENT) {
00175 <span class="preprocessor">#if defined(FE_SB)</span>
00176 <span class="preprocessor"></span>            InputRecords[i].Event.KeyEvent.uChar.UnicodeChar = SB_CharToWchar(
00177                     Console-&gt;CP, InputRecords[i].Event.KeyEvent.uChar.AsciiChar);
00178 <span class="preprocessor">#else</span>
00179 <span class="preprocessor"></span>            InputRecords[i].Event.KeyEvent.uChar.UnicodeChar = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a39">CharToWchar</a>(
00180                     Console-&gt;CP, InputRecords[i].Event.KeyEvent.uChar.AsciiChar);
00181 <span class="preprocessor">#endif</span>
00182 <span class="preprocessor"></span>        }
00183     }
00184 <span class="preprocessor">#if defined(FE_SB)</span>
00185 <span class="preprocessor"></span>    <span class="keywordflow">return</span> i;
00186 <span class="preprocessor">#else</span>
00187 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00188 <span class="preprocessor">#endif</span>
00189 <span class="preprocessor"></span>}
00190 
00191 <span class="preprocessor">#if defined(FE_SB)</span>
00192 <span class="preprocessor"></span>ULONG
00193 <a class="code" href="../../d6/d8/dispatch_8h.html#a20">FE_TranslateInputToUnicode</a>(
00194     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00195     IN OUT PINPUT_RECORD InputRecords,
00196     IN ULONG NumRecords,
00197     IN OUT PINPUT_RECORD DBCSLeadByte
00198     )
00199 {
00200     ULONG i,j;
00201     INPUT_RECORD AsciiDbcs[2];
00202     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Strings[2];
00203     WCHAR UnicodeDbcs[2];
00204     PWCHAR Uni;
00205     ULONG NumBytes;
00206 
00207     <span class="keywordflow">if</span> (DBCSLeadByte-&gt;Event.KeyEvent.uChar.AsciiChar) {
00208         AsciiDbcs[0] = *DBCSLeadByte;
00209         Strings[0] = DBCSLeadByte-&gt;Event.KeyEvent.uChar.AsciiChar;
00210     }
00211     <span class="keywordflow">else</span>{
00212         RtlZeroMemory(AsciiDbcs,<span class="keyword">sizeof</span>(AsciiDbcs));
00213     }
00214     <span class="keywordflow">for</span> (i=j=0; i&lt;NumRecords; i++) {
00215         <span class="keywordflow">if</span> (InputRecords[i].EventType == KEY_EVENT) {
00216             <span class="keywordflow">if</span> (AsciiDbcs[0].Event.KeyEvent.uChar.AsciiChar) {
00217                 AsciiDbcs[1] = InputRecords[i];
00218                 Strings[1] = InputRecords[i].Event.KeyEvent.uChar.AsciiChar;
00219                 NumBytes = <span class="keyword">sizeof</span>(Strings);
00220                 NumBytes = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;CP,
00221                                                  &amp;Strings[0],
00222                                                  NumBytes,
00223                                                  &amp;UnicodeDbcs[0],
00224                                                  NumBytes);
00225                 Uni = &amp;UnicodeDbcs[0];
00226                 <span class="keywordflow">while</span> (NumBytes--) {
00227                     InputRecords[j] = AsciiDbcs[0];
00228                     InputRecords[j].Event.KeyEvent.uChar.UnicodeChar = *Uni++;
00229                     j++;
00230                 }
00231                 RtlZeroMemory(AsciiDbcs,<span class="keyword">sizeof</span>(AsciiDbcs));
00232                 <span class="keywordflow">if</span> (DBCSLeadByte-&gt;Event.KeyEvent.uChar.AsciiChar)
00233                     RtlZeroMemory(DBCSLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
00234             }
00235             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>(InputRecords[i].<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.KeyEvent.uChar.AsciiChar,&amp;Console-&gt;CPInfo)) {
00236                 <span class="keywordflow">if</span> (i &lt; NumRecords-1) {
00237                     AsciiDbcs[0] = InputRecords[i];
00238                     Strings[0] = InputRecords[i].Event.KeyEvent.uChar.AsciiChar;
00239                 }
00240                 <span class="keywordflow">else</span> {
00241                     *DBCSLeadByte = InputRecords[i];
00242                     <span class="keywordflow">break</span>;
00243                 }
00244             }
00245             <span class="keywordflow">else</span> {
00246                 <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00247                 InputRecords[j] = InputRecords[i];
00248                 <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = InputRecords[i].Event.KeyEvent.uChar.AsciiChar;
00249                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;CP,
00250                       &amp;c,
00251                       1,
00252                       &amp;InputRecords[j].Event.KeyEvent.uChar.UnicodeChar,
00253                       1);
00254                 j++;
00255             }
00256         }
00257         <span class="keywordflow">else</span> {
00258             InputRecords[j++] = InputRecords[i];
00259         }
00260     }
00261     <span class="keywordflow">return</span> j;
00262 }
00263 <span class="preprocessor">#endif</span>
00264 <span class="preprocessor"></span>
00265 
00266 BOOLEAN
<a name="l00267"></a><a class="code" href="../../d2/d8/directio_8c.html#a2">00267</a> <a class="code" href="../../d2/d8/directio_8c.html#a2">DirectReadWaitRoutine</a>(
00268     IN PLIST_ENTRY WaitQueue,
00269     IN PCSR_THREAD WaitingThread,
00270     IN PCSR_API_MSG WaitReplyMessage,
00271     IN PVOID WaitParameter,
00272     IN PVOID SatisfyParameter1,
00273     IN PVOID SatisfyParameter2,
00274     IN ULONG WaitFlags
00275     )
00276 
00277 <span class="comment">/*++</span>
00278 <span class="comment"></span>
00279 <span class="comment">Routine Description:</span>
00280 <span class="comment"></span>
00281 <span class="comment">    This routine is called to complete a direct read that blocked in</span>
00282 <span class="comment">    ReadInputBuffer.  The context of the read was saved in the DirectReadData</span>
00283 <span class="comment">    structure.  This routine is called when events have been written to</span>
00284 <span class="comment">    the input buffer.  It is called in the context of the writing thread.</span>
00285 <span class="comment"></span>
00286 <span class="comment">Arguments:</span>
00287 <span class="comment"></span>
00288 <span class="comment">    WaitQueue - Pointer to queue containing wait block.</span>
00289 <span class="comment"></span>
00290 <span class="comment">    WaitingThread - Pointer to waiting thread.</span>
00291 <span class="comment"></span>
00292 <span class="comment">    WaitReplyMessage - Pointer to reply message to return to dll when</span>
00293 <span class="comment">        read is completed.</span>
00294 <span class="comment"></span>
00295 <span class="comment">    DirectReadData - Context of read.</span>
00296 <span class="comment"></span>
00297 <span class="comment">    SatisfyParameter1 - Unused.</span>
00298 <span class="comment"></span>
00299 <span class="comment">    SatisfyParameter2 - Unused.</span>
00300 <span class="comment"></span>
00301 <span class="comment">    WaitFlags - Flags indicating status of wait.</span>
00302 <span class="comment"></span>
00303 <span class="comment">Return Value:</span>
00304 <span class="comment"></span>
00305 <span class="comment">--*/</span>
00306 
00307 {
00308     <a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html">PCONSOLE_GETCONSOLEINPUT_MSG</a> a;
00309     PINPUT_RECORD <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00310     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00311     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00312     <a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html">PDIRECT_READ_DATA</a> DirectReadData;
00313     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00314     BOOLEAN RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00315 <span class="preprocessor">#if defined(FE_SB)</span>
00316 <span class="preprocessor"></span>    BOOLEAN fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00317     PDWORD  nLength;
00318 <span class="preprocessor">#endif</span>
00319 <span class="preprocessor"></span>
00320     a = (<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html">PCONSOLE_GETCONSOLEINPUT_MSG</a>)&amp;WaitReplyMessage-&gt;u.ApiMessageData;
00321     DirectReadData = (<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html">PDIRECT_READ_DATA</a>) WaitParameter;
00322 
00323     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(DirectReadData-&gt;<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html#o2">ProcessData</a>,
00324                                         DirectReadData-&gt;<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html#o3">HandleIndex</a>,
00325                                         &amp;HandleData
00326                                        );
00327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">// see if this routine was called by CloseInputHandle.  if it</span>
00331     <span class="comment">// was, see if this wait block corresponds to the dying handle.</span>
00332     <span class="comment">// if it doesn't, just return.</span>
00333     <span class="comment">//</span>
00334 
00335     <span class="keywordflow">if</span> (SatisfyParameter1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00336         SatisfyParameter1 != HandleData) {
00337         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00338     }
00339 
00340     <span class="comment">//</span>
00341     <span class="comment">// if ctrl-c or ctrl-break was seen, ignore it.</span>
00342     <span class="comment">//</span>
00343 
00344     <span class="keywordflow">if</span> ((ULONG_PTR)SatisfyParameter2 &amp; (<a class="code" href="../../d9/d3/input_8h.html#a23">CONSOLE_CTRL_C_SEEN</a> | <a class="code" href="../../d9/d3/input_8h.html#a24">CONSOLE_CTRL_BREAK_SEEN</a>)) {
00345         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346     }
00347 
00348     Console = DirectReadData-&gt;<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html#o1">Console</a>;
00349 
00350 <span class="preprocessor">#if defined(FE_SB)</span>
00351 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console) &amp;&amp; !a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o6">Unicode</a>) {
00352         <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
00353             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a> == 1) {
00354                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o2">Record</a>[0];
00355                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte;
00356                 <span class="keywordflow">if</span> (!(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE))
00357                     RtlZeroMemory(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
00358                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00359             }
00360         }
00361     }
00362 <span class="preprocessor">#endif</span>
00363 <span class="preprocessor"></span>
00364     <span class="comment">//</span>
00365     <span class="comment">// this routine should be called by a thread owning the same</span>
00366     <span class="comment">// lock on the same console as we're reading from.</span>
00367     <span class="comment">//</span>
00368 
00369     <span class="keywordflow">try</span> {
00370         <a class="code" href="../../d9/d3/input_8h.html#a25">LockReadCount</a>(HandleData);
00371         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a>);
00372         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> -= 1;
00373         <a class="code" href="../../d9/d3/input_8h.html#a26">UnlockReadCount</a>(HandleData);
00374 
00375         <span class="comment">//</span>
00376         <span class="comment">// see if called by CsrDestroyProcess or CsrDestroyThread</span>
00377         <span class="comment">// via CsrNotifyWaitBlock.   if so, just decrement the ReadCount</span>
00378         <span class="comment">// and return.</span>
00379         <span class="comment">//</span>
00380 
00381         <span class="keywordflow">if</span> (WaitFlags &amp; CSR_PROCESS_TERMINATING) {
00382             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_THREAD_IS_TERMINATING;
00383             leave;
00384         }
00385 
00386         <span class="comment">//</span>
00387         <span class="comment">// We must see if we were woken up because the handle is being</span>
00388         <span class="comment">// closed.  if so, we decrement the read count.  if it goes to</span>
00389         <span class="comment">// zero, we wake up the close thread.  otherwise, we wake up any</span>
00390         <span class="comment">// other thread waiting for data.</span>
00391         <span class="comment">//</span>
00392 
00393         <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a51">HANDLE_CLOSING</a>) {
00394             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SatisfyParameter1 == HandleData);
00395             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ALERTED;
00396             leave;
00397         }
00398 
00399         <span class="comment">//</span>
00400         <span class="comment">// if we get to here, this routine was called either by the input</span>
00401         <span class="comment">// thread or a write routine.  both of these callers grab the</span>
00402         <span class="comment">// current console lock.</span>
00403         <span class="comment">//</span>
00404 
00405         <span class="comment">//</span>
00406         <span class="comment">// this routine should be called by a thread owning the same</span>
00407         <span class="comment">// lock on the same console as we're reading from.</span>
00408         <span class="comment">//</span>
00409 
00410         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
00411 
00412         <span class="comment">//</span>
00413         <span class="comment">// if the read buffer is contained within the message, we need to</span>
00414         <span class="comment">// reset the buffer pointer because the message copied from the</span>
00415         <span class="comment">// stack to heap space when the wait block was created.</span>
00416         <span class="comment">//</span>
00417 
00418         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a> &lt;= <a class="code" href="../../d5/d5/conmsg_8h.html#a7">INPUT_RECORD_BUFFER_SIZE</a>) {
00419             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o2">Record</a>;
00420         } <span class="keywordflow">else</span> {
00421             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o3">BufPtr</a>;
00422         }
00423 <span class="preprocessor">#if defined(FE_SB)</span>
00424 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console) ) {
00425             Console-&gt;ReadConInpNumBytesUnicode = a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>;
00426             <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o6">Unicode</a>) {
00427                 <span class="comment">/*</span>
00428 <span class="comment">                 * ASCII : a-&gt;NumRecords is ASCII byte count</span>
00429 <span class="comment">                 */</span>
00430                 <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
00431                     <span class="comment">/*</span>
00432 <span class="comment">                     * Saved DBCS Traling byte</span>
00433 <span class="comment">                     */</span>
00434                     <span class="keywordflow">if</span> (Console-&gt;ReadConInpNumBytesUnicode != 1) {
00435                         Console-&gt;ReadConInpNumBytesUnicode--;
00436                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
00437                         fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00438                         nLength = &amp;Console-&gt;ReadConInpNumBytesUnicode;
00439                     }
00440                     <span class="keywordflow">else</span> {
00441                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;ReadConInpNumBytesUnicode==1);
00442                     }
00443                 }
00444                 <span class="keywordflow">else</span> {
00445                     nLength = &amp;Console-&gt;ReadConInpNumBytesUnicode;
00446                 }
00447             }
00448             <span class="keywordflow">else</span> {
00449                 nLength = &amp;a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>;
00450             }
00451         }
00452         <span class="keywordflow">else</span> {
00453             nLength = &amp;a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>;
00454         }
00455         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a25">ReadInputBuffer</a>(DirectReadData-&gt;<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html#o0">InputInfo</a>,
00456                                  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00457                                  nLength,
00458                                  !!(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE),
00459                                  !(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOWAIT),
00460                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00461                                  Console,
00462                                  HandleData,
00463                                  WaitReplyMessage,
00464                                  <a class="code" href="../../d2/d8/directio_8c.html#a2">DirectReadWaitRoutine</a>,
00465                                  &amp;DirectReadData,
00466                                  <span class="keyword">sizeof</span>(DirectReadData),
00467                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00468                                  a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o6">Unicode</a>
00469                                 );
00470 <span class="preprocessor">#else</span>
00471 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a25">ReadInputBuffer</a>(DirectReadData-&gt;InputInfo,
00472                                  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00473                                  &amp;a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>,
00474                                  !!(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE),
00475                                  !(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOWAIT),
00476                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00477                                  Console,
00478                                  HandleData,
00479                                  WaitReplyMessage,
00480                                  <a class="code" href="../../d2/d8/directio_8c.html#a2">DirectReadWaitRoutine</a>,
00481                                  &amp;DirectReadData,
00482                                  <span class="keyword">sizeof</span>(DirectReadData),
00483                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00484                                 );
00485 <span class="preprocessor">#endif</span>
00486 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
00487             RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00488         }
00489     } finally {
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// if the read was completed (status != wait), free the direct read</span>
00493         <span class="comment">// data.</span>
00494         <span class="comment">//</span>
00495 
00496         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
00497             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS &amp;&amp; !a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o6">Unicode</a>) {
00498 <span class="preprocessor">#if defined(FE_SB)</span>
00499 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console) ) {
00500                     <span class="keywordflow">if</span> (fAddDbcsLead &amp;&amp;
00501                         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
00502                         a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>--;
00503                     }
00504                     a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a23">FE_TranslateInputToOem</a>(
00505                                         Console,
00506                                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00507                                         a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>,
00508                                         Console-&gt;ReadConInpNumBytesUnicode,
00509                                         a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE ?
00510                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> :
00511                                             &amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte);
00512                     <span class="keywordflow">if</span> (fAddDbcsLead &amp;&amp;
00513                         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
00514                         *(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-1) = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte;
00515                         <span class="keywordflow">if</span> (!(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE))
00516                             RtlZeroMemory(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
00517                         a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>++;
00518                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>--;
00519                     }
00520                 }
00521                 <span class="keywordflow">else</span> {
00522                     <a class="code" href="../../d6/d8/dispatch_8h.html#a22">TranslateInputToOem</a>(Console,
00523                                          <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00524                                          a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>,
00525                                          Console-&gt;ReadConInpNumBytesUnicode,
00526                                          a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE ?
00527                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> :
00528                                              &amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte
00529                                         );
00530                 }
00531 <span class="preprocessor">#else</span>
00532 <span class="preprocessor"></span>                <a class="code" href="../../d6/d8/dispatch_8h.html#a22">TranslateInputToOem</a>(Console,
00533                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00534                                      a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>
00535                                     );
00536 <span class="preprocessor">#endif</span>
00537 <span class="preprocessor"></span>            }
00538             WaitReplyMessage-&gt;ReturnValue = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00539             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DirectReadData);
00540         }
00541     }
00542 
00543     <span class="keywordflow">return</span> RetVal;
00544 
00545     <span class="comment">//</span>
00546     <span class="comment">// satisfy the unreferenced parameter warnings.</span>
00547     <span class="comment">//</span>
00548 
00549     UNREFERENCED_PARAMETER(WaitQueue);
00550     UNREFERENCED_PARAMETER(WaitingThread);
00551     UNREFERENCED_PARAMETER(SatisfyParameter2);
00552 }
00553 
00554 
00555 ULONG
<a name="l00556"></a><a class="code" href="../../d2/d8/directio_8c.html#a3">00556</a> <a class="code" href="../../d2/d8/directio_8c.html#a3">SrvGetConsoleInput</a>(
00557     IN OUT PCSR_API_MSG m,
00558     IN OUT PCSR_REPLY_STATUS ReplyStatus
00559     )
00560 
00561 <span class="comment">/*++</span>
00562 <span class="comment"></span>
00563 <span class="comment">Routine Description:</span>
00564 <span class="comment"></span>
00565 <span class="comment">    This routine reads or peeks input events.  In both cases, the events</span>
00566 <span class="comment">    are copied to the user's buffer.  In the read case they are removed</span>
00567 <span class="comment">    from the input buffer and in the peek case they are not.</span>
00568 <span class="comment"></span>
00569 <span class="comment">Arguments:</span>
00570 <span class="comment"></span>
00571 <span class="comment">    m - message containing api parameters</span>
00572 <span class="comment"></span>
00573 <span class="comment">    ReplyStatus - Indicates whether to reply to the dll port.</span>
00574 <span class="comment"></span>
00575 <span class="comment">Return Value:</span>
00576 <span class="comment"></span>
00577 <span class="comment">--*/</span>
00578 
00579 {
00580     <a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html">PCONSOLE_GETCONSOLEINPUT_MSG</a> a = (<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html">PCONSOLE_GETCONSOLEINPUT_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00581     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00582     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00583     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00584     PINPUT_RECORD <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00585     <a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html">DIRECT_READ_DATA</a> DirectReadData;
00586 <span class="preprocessor">#ifdef FE_SB</span>
00587 <span class="preprocessor"></span>    BOOLEAN fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00588     PDWORD  nLength;
00589 <span class="preprocessor">#endif</span>
00590 <span class="preprocessor"></span>
00591     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; ~CONSOLE_READ_VALID) {
00592         <span class="keywordflow">return</span> (ULONG)STATUS_INVALID_PARAMETER;
00593     }
00594 
00595     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o0">ConsoleHandle</a>,
00596                          &amp;Console
00597                         );
00598     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00599         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00600     }
00601     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00602                                  a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o1">InputHandle</a>,
00603                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>,
00604                                  GENERIC_READ,
00605                                  &amp;HandleData
00606                                 );
00607     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00608         a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a> = 0;
00609     } <span class="keywordflow">else</span> {
00610 
00611         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a> &lt;= <a class="code" href="../../d5/d5/conmsg_8h.html#a7">INPUT_RECORD_BUFFER_SIZE</a>) {
00612             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o2">Record</a>;
00613         } <span class="keywordflow">else</span> {
00614             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o3">BufPtr</a>;
00615             <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o3">BufPtr</a>, a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>, <span class="keyword">sizeof</span>(*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>))) {
00616                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00617                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00618             }
00619         }
00620 
00621         <span class="comment">//</span>
00622         <span class="comment">// if we're reading, wait for data.  if we're peeking, don't.</span>
00623         <span class="comment">//</span>
00624 
00625         DirectReadData.<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html#o0">InputInfo</a> = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer;
00626         DirectReadData.<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html#o1">Console</a> = Console;
00627         DirectReadData.<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html#o2">ProcessData</a> = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
00628         DirectReadData.<a class="code" href="../../d8/d5/struct__DIRECT__READ__DATA.html#o3">HandleIndex</a> = <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o1">InputHandle</a>);
00629 <span class="preprocessor">#if defined(FE_SB)</span>
00630 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console) ) {
00631             Console-&gt;ReadConInpNumBytesUnicode = a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>;
00632             <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o6">Unicode</a>) {
00633                 <span class="comment">/*</span>
00634 <span class="comment">                 * ASCII : a-&gt;NumRecords is ASCII byte count</span>
00635 <span class="comment">                 */</span>
00636                 <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
00637                     <span class="comment">/*</span>
00638 <span class="comment">                     * Saved DBCS Traling byte</span>
00639 <span class="comment">                     */</span>
00640                     *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte;
00641                     <span class="keywordflow">if</span> (!(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE))
00642                         RtlZeroMemory(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
00643 
00644                     <span class="keywordflow">if</span> (Console-&gt;ReadConInpNumBytesUnicode == 1) {
00645                         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00646                         <span class="keywordflow">return</span> STATUS_SUCCESS;
00647                     }
00648                     <span class="keywordflow">else</span> {
00649                         Console-&gt;ReadConInpNumBytesUnicode--;
00650                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
00651                         fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00652                         nLength = &amp;Console-&gt;ReadConInpNumBytesUnicode;
00653                     }
00654                 }
00655                 <span class="keywordflow">else</span> {
00656                     nLength = &amp;Console-&gt;ReadConInpNumBytesUnicode;
00657                 }
00658             }
00659             <span class="keywordflow">else</span> {
00660                 nLength = &amp;a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>;
00661             }
00662         }
00663         <span class="keywordflow">else</span> {
00664             nLength = &amp;a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>;
00665         }
00666         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a25">ReadInputBuffer</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer,
00667                                  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00668                                  nLength,
00669                                  !!(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE),
00670                                  !(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOWAIT),
00671                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00672                                  Console,
00673                                  HandleData,
00674                                  m,
00675                                  <a class="code" href="../../d2/d8/directio_8c.html#a2">DirectReadWaitRoutine</a>,
00676                                  &amp;DirectReadData,
00677                                  <span class="keyword">sizeof</span>(DirectReadData),
00678                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00679                                  a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o6">Unicode</a>
00680                                 );
00681         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
00682             *ReplyStatus = CsrReplyPending;
00683         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o6">Unicode</a>) {
00684             a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a22">TranslateInputToOem</a>(Console,
00685                                                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00686                                                 fAddDbcsLead ?
00687                                                     a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>-1 :
00688                                                     a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>,
00689                                                 Console-&gt;ReadConInpNumBytesUnicode,
00690                                                 a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE ?
00691                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> :
00692                                                     &amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte
00693                                                );
00694             <span class="keywordflow">if</span> (fAddDbcsLead)
00695             {
00696                 a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>++;
00697                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>--;
00698             }
00699         }
00700 <span class="preprocessor">#else</span>
00701 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a25">ReadInputBuffer</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer,
00702                                  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00703                                  &amp;a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>,
00704                                  !!(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOREMOVE),
00705                                  !(a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o5">Flags</a> &amp; CONSOLE_READ_NOWAIT),
00706                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00707                                  Console,
00708                                  HandleData,
00709                                  m,
00710                                  <a class="code" href="../../d2/d8/directio_8c.html#a2">DirectReadWaitRoutine</a>,
00711                                  &amp;DirectReadData,
00712                                  <span class="keyword">sizeof</span>(DirectReadData),
00713                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00714                                 );
00715         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
00716             *ReplyStatus = CsrReplyPending;
00717         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o6">Unicode</a>) {
00718             <a class="code" href="../../d6/d8/dispatch_8h.html#a22">TranslateInputToOem</a>(Console,
00719                                  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00720                                  a-&gt;<a class="code" href="../../d2/d1/struct__CONSOLE__GETCONSOLEINPUT__MSG.html#o4">NumRecords</a>
00721                                 );
00722         }
00723 <span class="preprocessor">#endif</span>
00724 <span class="preprocessor"></span>    }
00725     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00726     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00727 }
00728 
00729 ULONG
<a name="l00730"></a><a class="code" href="../../d2/d8/directio_8c.html#a4">00730</a> <a class="code" href="../../d2/d8/directio_8c.html#a4">SrvWriteConsoleInput</a>(
00731     IN OUT PCSR_API_MSG m,
00732     IN OUT PCSR_REPLY_STATUS ReplyStatus
00733     )
00734 {
00735     <a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html">PCONSOLE_WRITECONSOLEINPUT_MSG</a> a = (<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html">PCONSOLE_WRITECONSOLEINPUT_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00736     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00737     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00738     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00739     PINPUT_RECORD <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00740 
00741     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o0">ConsoleHandle</a>,
00742                          &amp;Console
00743                         );
00744     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00745         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00746     }
00747     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00748                                  a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o1">InputHandle</a>,
00749                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>,
00750                                  GENERIC_WRITE,
00751                                  &amp;HandleData
00752                                 );
00753     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00754         a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a> = 0;
00755     } <span class="keywordflow">else</span> {
00756         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a> &lt;= <a class="code" href="../../d5/d5/conmsg_8h.html#a7">INPUT_RECORD_BUFFER_SIZE</a>) {
00757             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o2">Record</a>;
00758         } <span class="keywordflow">else</span> {
00759             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o3">BufPtr</a>;
00760             <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o3">BufPtr</a>, a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a>, <span class="keyword">sizeof</span>(*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>))) {
00761                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00762                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00763             }
00764         }
00765         <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o5">Unicode</a>) {
00766 <span class="preprocessor">#if defined(FE_SB)</span>
00767 <span class="preprocessor"></span>            a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a19">TranslateInputToUnicode</a>(Console,
00768                                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00769                                     a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a>,
00770                                     &amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;WriteConInpDbcsLeadByte[0]
00771                                    );
00772 <span class="preprocessor">#else</span>
00773 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a19">TranslateInputToUnicode</a>(Console,
00774                                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00775                                     a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a>
00776                                    );
00777 <span class="preprocessor">#endif</span>
00778 <span class="preprocessor"></span>        }
00779         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o6">Append</a>) {
00780             a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>(Console,
00781                                              HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer,
00782                                              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00783                                              a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a>
00784                                             );
00785         } <span class="keywordflow">else</span> {
00786             a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a29">PrependInputBuffer</a>(Console,
00787                                              HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer,
00788                                              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00789                                              a-&gt;<a class="code" href="../../d5/d7/struct__CONSOLE__WRITECONSOLEINPUT__MSG.html#o4">NumRecords</a>
00790                                             );
00791 
00792         }
00793     }
00794     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00795     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00796     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00797 }
00798 
00799 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00800 <a class="code" href="../../d2/d8/directio_8c.html#a5">SB_TranslateOutputToOem</a>
<a name="l00801"></a><a class="code" href="../../d2/d8/directio_8c.html#a5">00801</a>     (
00802     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00803     IN OUT PCHAR_INFO OutputBuffer,
00804     IN COORD <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
00805     )
00806 <span class="comment">// this is used when the app reads oem from the output buffer</span>
00807 <span class="comment">// the app wants real OEM characters.  We have real Unicode or UnicodeOem.</span>
00808 {
00809     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
00810     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Codepage;
00811     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SB_TranslateOutputToOem(Console=%lx, OutputBuffer=%lx)\n"</span>,
00812             Console, OutputBuffer));
00813 
00814     j = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y;
00815 
00816     <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
00817             ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
00818 <span class="preprocessor">#if defined(FE_SB)</span>
00819 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
00820             Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a> ) {
00821                 Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
00822         }
00823         <span class="keywordflow">else</span>
00824 <span class="preprocessor">#endif</span>
00825 <span class="preprocessor"></span>        <span class="comment">// we have UnicodeOem characters</span>
00826         Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
00827     } <span class="keywordflow">else</span> {
00828         <span class="comment">// we have real Unicode characters</span>
00829         Codepage = Console-&gt;OutputCP;    <span class="comment">// BUG FIX by KazuM Jun.2.97</span>
00830     }
00831 
00832     <span class="keywordflow">for</span> (i=0;i&lt;j;i++,OutputBuffer++) {
00833         OutputBuffer-&gt;Char.AsciiChar = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a40">WcharToChar</a>(Codepage,
00834                 OutputBuffer-&gt;Char.UnicodeChar);
00835     }
00836     <span class="keywordflow">return</span> STATUS_SUCCESS;
00837 }
00838 
00839 <span class="preprocessor">#if defined(FE_SB)</span>
00840 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00841 FE_TranslateOutputToOem(
00842     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00843     IN OUT PCHAR_INFO OutputBuffer,
00844     IN COORD Size
00845     )
00846 <span class="comment">// this is used when the app reads oem from the output buffer</span>
00847 <span class="comment">// the app wants real OEM characters.  We have real Unicode or UnicodeOem.</span>
00848 {
00849     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
00850     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Codepage;
00851     PCHAR_INFO TmpBuffer,SaveBuffer;
00852     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>  AsciiDbcs[2];
00853     ULONG NumBytes;
00854     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"FE_TranslateOutputToOem(Console=%lx, OutputBuffer=%lx)\n"</span>,
00855             Console, OutputBuffer));
00856 
00857     SaveBuffer = TmpBuffer =
00858         <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ), <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y * <span class="keyword">sizeof</span>(CHAR_INFO) * 2);
00859     <span class="keywordflow">if</span> (TmpBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00860         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00861     }
00862 
00863     <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
00864             ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
00865         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
00866             Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a> ) {
00867                 Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
00868         }
00869         <span class="keywordflow">else</span>
00870             <span class="comment">// we have UnicodeOem characters</span>
00871             Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
00872     } <span class="keywordflow">else</span> {
00873         <span class="comment">// we have real Unicode characters</span>
00874         Codepage = Console-&gt;OutputCP;
00875     }
00876 
00877     memcpy(TmpBuffer,OutputBuffer,<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y * <span class="keyword">sizeof</span>(CHAR_INFO));
00878     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y; i++) {
00879         <span class="keywordflow">for</span> (j=0; j &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X; j++) {
00880             <span class="keywordflow">if</span> (TmpBuffer-&gt;Attributes &amp; COMMON_LVB_LEADING_BYTE) {
00881                 <span class="keywordflow">if</span> (j &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X-1) {  <span class="comment">// -1 is safe DBCS in buffer</span>
00882                     j++;
00883                     NumBytes = <span class="keyword">sizeof</span>(AsciiDbcs);
00884                     NumBytes = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a41">ConvertOutputToOem</a>(Codepage,
00885                                    &amp;TmpBuffer-&gt;Char.UnicodeChar,
00886                                    1,
00887                                    &amp;AsciiDbcs[0],
00888                                    NumBytes);
00889                     OutputBuffer-&gt;Char.AsciiChar = AsciiDbcs[0];
00890                     OutputBuffer-&gt;Attributes = TmpBuffer-&gt;Attributes;
00891                     OutputBuffer++;
00892                     TmpBuffer++;
00893                     OutputBuffer-&gt;Char.AsciiChar = AsciiDbcs[1];
00894                     OutputBuffer-&gt;Attributes = TmpBuffer-&gt;Attributes;
00895                     OutputBuffer++;
00896                     TmpBuffer++;
00897                 }
00898                 <span class="keywordflow">else</span> {
00899                     OutputBuffer-&gt;Char.AsciiChar = <span class="charliteral">' '</span>;
00900                     OutputBuffer-&gt;Attributes = TmpBuffer-&gt;Attributes &amp; ~COMMON_LVB_SBCSDBCS;
00901                     OutputBuffer++;
00902                     TmpBuffer++;
00903                 }
00904             }
00905             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(TmpBuffer-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS)){
00906                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a41">ConvertOutputToOem</a>(Codepage,
00907                     &amp;TmpBuffer-&gt;Char.UnicodeChar,
00908                     1,
00909                     &amp;OutputBuffer-&gt;Char.AsciiChar,
00910                     1);
00911                 OutputBuffer-&gt;Attributes = TmpBuffer-&gt;Attributes;
00912                 OutputBuffer++;
00913                 TmpBuffer++;
00914             }
00915         }
00916     }
00917     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(SaveBuffer);
00918     <span class="keywordflow">return</span> STATUS_SUCCESS;
00919 }
00920 <span class="preprocessor">#endif</span>
00921 <span class="preprocessor"></span>
00922 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00923 <a class="code" href="../../d2/d8/directio_8c.html#a6">SB_TranslateOutputToOemUnicode</a>
<a name="l00924"></a><a class="code" href="../../d6/d8/dispatch_8h.html#a18">00924</a>     (
00925     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00926     IN OUT PCHAR_INFO OutputBuffer,
00927     IN COORD <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
00928     )
00929 <span class="comment">// this is used when the app reads unicode from the output buffer</span>
00930 {
00931     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
00932     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SB_TranslateOutputToOemUnicode\n"</span>));
00933 
00934     j = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y;
00935 
00936     <span class="keywordflow">for</span> (i=0;i&lt;j;i++,OutputBuffer++) {
00937         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">FalseUnicodeToRealUnicode</a>(&amp;OutputBuffer-&gt;Char.UnicodeChar,
00938                                 1,
00939                                 Console-&gt;OutputCP
00940                                 );
00941     }
00942     <span class="keywordflow">return</span> STATUS_SUCCESS;
00943 }
00944 
00945 <span class="preprocessor">#if defined(FE_SB)</span>
00946 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00947 <a class="code" href="../../d6/d8/dispatch_8h.html#a17">FE_TranslateOutputToOemUnicode</a>(
00948     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00949     IN OUT PCHAR_INFO OutputBuffer,
00950     IN COORD Size,
00951     IN BOOL fRemoveDbcsMark
00952     )
00953 <span class="comment">// this is used when the app reads unicode from the output buffer</span>
00954 {
00955     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
00956     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"FE_TranslateOutputToOemUnicode\n"</span>));
00957 
00958     j = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y;
00959 
00960     <span class="keywordflow">if</span> (fRemoveDbcsMark)
00961         <a class="code" href="../../d0/d3/dbcs_8h.html#a35">RemoveDbcsMarkCell</a>(OutputBuffer,OutputBuffer,j);
00962 
00963     <span class="keywordflow">for</span> (i=0;i&lt;j;i++,OutputBuffer++) {
00964         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">FalseUnicodeToRealUnicode</a>(&amp;OutputBuffer-&gt;Char.UnicodeChar,
00965                                 1,
00966                                 Console-&gt;OutputCP
00967                                 );
00968     }
00969     <span class="keywordflow">return</span> STATUS_SUCCESS;
00970 }
00971 <span class="preprocessor">#endif</span>
00972 <span class="preprocessor"></span>
00973 
00974 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00975 <a class="code" href="../../d2/d8/directio_8c.html#a7">SB_TranslateOutputToUnicode</a>
<a name="l00976"></a><a class="code" href="../../d2/d8/directio_8c.html#a7">00976</a>     (
00977     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00978     IN OUT PCHAR_INFO OutputBuffer,
00979     IN COORD <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
00980     )
00981 <span class="comment">// this is used when the app writes oem to the output buffer</span>
00982 <span class="comment">// we want UnicodeOem or Unicode in the buffer, depending on font &amp; fullscreen</span>
00983 {
00984     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
00985     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Codepage;
00986     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SB_TranslateOutputToUnicode %lx %lx (%lx,%lx)\n"</span>,
00987             Console, OutputBuffer, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y));
00988 
00989     j = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y;
00990 
00991     <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
00992             ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
00993 <span class="preprocessor">#if defined(FE_SB)</span>
00994 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
00995             (Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>) ) {
00996                 Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
00997         }
00998         <span class="keywordflow">else</span>
00999 <span class="preprocessor">#endif</span>
01000 <span class="preprocessor"></span>        <span class="comment">// we want UnicodeOem characters</span>
01001         Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
01002     } <span class="keywordflow">else</span> {
01003         <span class="comment">// we want real Unicode characters</span>
01004         Codepage = Console-&gt;OutputCP;    <span class="comment">// BUG FIX by KazuM Jun.2.97</span>
01005     }
01006     <span class="keywordflow">for</span> (i = 0; i &lt; j; i++, OutputBuffer++) {
01007 <span class="preprocessor">#if defined(FE_SB)</span>
01008 <span class="preprocessor"></span>        OutputBuffer-&gt;Char.UnicodeChar = SB_CharToWchar(
01009                 Codepage, OutputBuffer-&gt;Char.AsciiChar);
01010 <span class="preprocessor">#else</span>
01011 <span class="preprocessor"></span>        OutputBuffer-&gt;Char.UnicodeChar = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a39">CharToWchar</a>(
01012                 Codepage, OutputBuffer-&gt;Char.AsciiChar);
01013 <span class="preprocessor">#endif</span>
01014 <span class="preprocessor"></span>    }
01015     <span class="keywordflow">return</span> STATUS_SUCCESS;
01016 }
01017 
01018 <span class="preprocessor">#if defined(FE_SB)</span>
01019 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01020 FE_TranslateOutputToUnicode(
01021     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01022     IN OUT PCHAR_INFO OutputBuffer,
01023     IN COORD Size
01024     )
01025 <span class="comment">// this is used when the app writes oem to the output buffer</span>
01026 <span class="comment">// we want UnicodeOem or Unicode in the buffer, depending on font &amp; fullscreen</span>
01027 {
01028     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
01029     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Codepage;
01030     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>  AsciiDbcs[2];
01031     WCHAR UnicodeDbcs[2];
01032     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"FE_TranslateOutputToUnicode %lx %lx (%lx,%lx)\n"</span>,
01033             Console, OutputBuffer, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y));
01034 
01035     <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01036             ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01037         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
01038             (Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>) ) {
01039                 Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
01040         }
01041         <span class="keywordflow">else</span>
01042             <span class="comment">// we want UnicodeOem characters</span>
01043             Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
01044     } <span class="keywordflow">else</span> {
01045         <span class="comment">// we want real Unicode characters</span>
01046         Codepage = Console-&gt;OutputCP;
01047     }
01048 
01049     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y; i++) {
01050         <span class="keywordflow">for</span> (j=0; j &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X; j++) {
01051             OutputBuffer-&gt;Attributes &amp;= ~COMMON_LVB_SBCSDBCS;
01052             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>(OutputBuffer-&gt;Char.AsciiChar,&amp;Console-&gt;OutputCPInfo)) {
01053                 <span class="keywordflow">if</span> (j &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X-1) {  <span class="comment">// -1 is safe DBCS in buffer</span>
01054                     j++;
01055                     AsciiDbcs[0] = OutputBuffer-&gt;Char.AsciiChar;
01056                     AsciiDbcs[1] = (OutputBuffer+1)-&gt;Char.AsciiChar;
01057                     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
01058                                            &amp;AsciiDbcs[0],
01059                                            2,
01060                                            &amp;UnicodeDbcs[0],
01061                                            2);
01062                     OutputBuffer-&gt;Char.UnicodeChar = UnicodeDbcs[0];
01063                     OutputBuffer-&gt;Attributes |= COMMON_LVB_LEADING_BYTE;
01064                     OutputBuffer++;
01065                     OutputBuffer-&gt;Char.UnicodeChar = <a class="code" href="../../d0/d3/dbcs_8h.html#a0">UNICODE_DBCS_PADDING</a>;
01066                     OutputBuffer-&gt;Attributes &amp;= ~COMMON_LVB_SBCSDBCS;
01067                     OutputBuffer-&gt;Attributes |= COMMON_LVB_TRAILING_BYTE;
01068                     OutputBuffer++;
01069                 }
01070                 <span class="keywordflow">else</span> {
01071                     OutputBuffer-&gt;Char.UnicodeChar = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01072                     OutputBuffer++;
01073                 }
01074             }
01075             <span class="keywordflow">else</span> {
01076                 <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
01077                 <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>=OutputBuffer-&gt;Char.AsciiChar;
01078                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
01079                                        &amp;c,
01080                                        1,
01081                                        &amp;OutputBuffer-&gt;Char.UnicodeChar,
01082                                        1);
01083                 OutputBuffer++;
01084             }
01085         }
01086     }
01087     <span class="keywordflow">return</span> STATUS_SUCCESS;
01088 }
01089 <span class="preprocessor">#endif</span>
01090 <span class="preprocessor"></span>
01091 
01092 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01093"></a><a class="code" href="../../d6/d8/dispatch_8h.html#a15">01093</a> <a class="code" href="../../d6/d8/dispatch_8h.html#a15">SB_TranslateOutputToAnsiUnicode</a> (
01094     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01095     IN OUT PCHAR_INFO OutputBuffer,
01096     IN COORD Size
01097     )
01098 <span class="comment">// this is used when the app writes unicode to the output buffer</span>
01099 {
01100     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
01101     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"TranslateOutputToAnsiUnicode\n"</span>));
01102 
01103     j = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y;
01104 
01105     <span class="keywordflow">for</span> (i=0;i&lt;j;i++,OutputBuffer++) {
01106         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(&amp;OutputBuffer-&gt;Char.UnicodeChar,
01107                                 1,
01108                                 Console-&gt;OutputCP
01109                                 );
01110     }
01111     <span class="keywordflow">return</span> STATUS_SUCCESS;
01112 }
01113 
01114 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01115"></a><a class="code" href="../../d2/d8/directio_8c.html#a9">01115</a> <a class="code" href="../../d2/d8/directio_8c.html#a9">FE_TranslateOutputToAnsiUnicodeInternal</a>(
01116     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01117     IN OUT PCHAR_INFO OutputBuffer,
01118     IN COORD Size,
01119     IN OUT PCHAR_INFO OutputBufferR,
01120     IN BOOL fRealUnicodeToFalseUnicode
01121     )
01122 <span class="comment">// this is used when the app writes unicode to the output buffer</span>
01123 {
01124     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
01125     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"TranslateOutputToAnsiUnicode\n"</span>));
01126 
01127     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y; i++) {
01128         <span class="keywordflow">for</span> (j=0; j &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X; j++) {
01129             WCHAR wch = OutputBuffer-&gt;Char.UnicodeChar;
01130 
01131             <span class="keywordflow">if</span> (fRealUnicodeToFalseUnicode) {
01132                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(&amp;OutputBuffer-&gt;Char.UnicodeChar,
01133                                           1,
01134                                           Console-&gt;OutputCP
01135                                          );
01136             }
01137 
01138             <span class="keywordflow">if</span> (OutputBufferR) {
01139                 OutputBufferR-&gt;Attributes = OutputBuffer-&gt;Attributes &amp; ~COMMON_LVB_SBCSDBCS;
01140                 <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,
01141                                        Console-&gt;OutputCP,OutputBuffer-&gt;Char.UnicodeChar)) {
01142                     <span class="keywordflow">if</span> (j == <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X-1){
01143                         OutputBufferR-&gt;Char.UnicodeChar = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01144                     }
01145                     <span class="keywordflow">else</span>{
01146                         OutputBufferR-&gt;Char.UnicodeChar = OutputBuffer-&gt;Char.UnicodeChar;
01147                         OutputBufferR-&gt;Attributes |= COMMON_LVB_LEADING_BYTE;
01148                         OutputBufferR++;
01149                         OutputBufferR-&gt;Char.UnicodeChar = <a class="code" href="../../d0/d3/dbcs_8h.html#a0">UNICODE_DBCS_PADDING</a>;
01150                         OutputBufferR-&gt;Attributes = OutputBuffer-&gt;Attributes &amp; ~COMMON_LVB_SBCSDBCS;
01151                         OutputBufferR-&gt;Attributes |= COMMON_LVB_TRAILING_BYTE;
01152                     }
01153                 }
01154                 <span class="keywordflow">else</span>{
01155                     OutputBufferR-&gt;Char.UnicodeChar = OutputBuffer-&gt;Char.UnicodeChar;
01156                 }
01157                 OutputBufferR++;
01158             }
01159 
01160             <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,
01161                                    Console-&gt;OutputCP,
01162                                    wch)) {
01163                 <span class="keywordflow">if</span> (j != <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X-1){
01164                     j++;
01165                 }
01166             }
01167             OutputBuffer++;
01168         }
01169     }
01170     <span class="keywordflow">return</span> STATUS_SUCCESS;
01171 }
01172 
01173 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01174"></a><a class="code" href="../../d6/d8/dispatch_8h.html#a14">01174</a> <a class="code" href="../../d6/d8/dispatch_8h.html#a14">FE_TranslateOutputToAnsiUnicode</a>(
01175     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01176     IN OUT PCHAR_INFO OutputBuffer,
01177     IN COORD Size,
01178     IN OUT PCHAR_INFO OutputBufferR
01179     )
01180 <span class="comment">// this is used when the app writes unicode to the output buffer</span>
01181 {
01182     <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/directio_8c.html#a9">FE_TranslateOutputToAnsiUnicodeInternal</a>(Console,
01183                                                    OutputBuffer,
01184                                                    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01185                                                    OutputBufferR,
01186                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01187                                                    );
01188 }
01189 
01190 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01191"></a><a class="code" href="../../d2/d8/directio_8c.html#a11">01191</a> <a class="code" href="../../d2/d8/directio_8c.html#a11">TranslateOutputToPaddingUnicode</a>(
01192     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01193     IN OUT PCHAR_INFO OutputBuffer,
01194     IN COORD Size,
01195     IN OUT PCHAR_INFO OutputBufferR
01196     )
01197 {
01198     <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/directio_8c.html#a9">FE_TranslateOutputToAnsiUnicodeInternal</a>(Console,
01199                                                    OutputBuffer,
01200                                                    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01201                                                    OutputBufferR,
01202                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01203                                                    );
01204 }
01205 
01206 ULONG
<a name="l01207"></a><a class="code" href="../../d2/d8/directio_8c.html#a12">01207</a> <a class="code" href="../../d2/d8/directio_8c.html#a12">SrvReadConsoleOutput</a>(
01208     IN OUT PCSR_API_MSG m,
01209     IN OUT PCSR_REPLY_STATUS ReplyStatus
01210     )
01211 {
01212     <a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html">PCONSOLE_READCONSOLEOUTPUT_MSG</a> a = (<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html">PCONSOLE_READCONSOLEOUTPUT_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01213     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01214     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01215     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01216     PCHAR_INFO <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01217 
01218     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"SrvReadConsoleOutput\n"</span>));
01219     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o0">ConsoleHandle</a>,
01220                          &amp;Console
01221                         );
01222     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01223         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01224     }
01225     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
01226                                  a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o1">OutputHandle</a>,
01227                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
01228                                  GENERIC_READ,
01229                                  &amp;HandleData
01230                                 );
01231     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01232         <span class="comment">//</span>
01233         <span class="comment">// a region of zero size is indicated by the right and bottom</span>
01234         <span class="comment">// coordinates being less than the left and top.</span>
01235         <span class="comment">//</span>
01236 
01237         a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Left-1);
01238         a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Top-1);
01239     }
01240     <span class="keywordflow">else</span> {
01241         COORD <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01242 
01243         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Right - a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Left + 1);
01244         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Bottom - a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Top + 1);
01245 
01246         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X == 1) &amp;&amp; (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y == 1)) {
01247             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o2">Char</a>;
01248         }
01249         <span class="keywordflow">else</span> {
01250             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o3">BufPtr</a>;
01251             <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o3">BufPtr</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X * <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y, <span class="keyword">sizeof</span>(*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>))) {
01252                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01253                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01254             }
01255         }
01256 
01257         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a52">ReadScreenBuffer</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer,
01258                                   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01259                                   &amp;a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o4">CharRegion</a>
01260                                  );
01261         <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d4/struct__CONSOLE__READCONSOLEOUTPUT__MSG.html#o5">Unicode</a>) {
01262             <a class="code" href="../../d3/d0/w32_2ntcon_2fullscr_2vga_2misc_8c.html#a1">TranslateOutputToOem</a>(Console,
01263                                   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01264                                   <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>
01265                                  );
01266         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01267                 !(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN)) {
01268             <a class="code" href="../../d6/d8/dispatch_8h.html#a16">TranslateOutputToOemUnicode</a>(Console,
01269                                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01270                                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>
01271 #<span class="keywordflow">if</span> defined(FE_SB)
01272                                         ,
01273                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01274 #endif
01275                                        );
01276         }
01277     }
01278     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01279     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01280     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01281 }
01282 
01283 ULONG
<a name="l01284"></a><a class="code" href="../../d2/d8/directio_8c.html#a13">01284</a> <a class="code" href="../../d2/d8/directio_8c.html#a13">SrvWriteConsoleOutput</a>(
01285     IN OUT PCSR_API_MSG m,
01286     IN OUT PCSR_REPLY_STATUS ReplyStatus
01287     )
01288 {
01289     <a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html">PCONSOLE_WRITECONSOLEOUTPUT_MSG</a> a = (<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html">PCONSOLE_WRITECONSOLEOUTPUT_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01290     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenBufferInformation;
01291     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01292     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01294     PCHAR_INFO <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01295 <span class="preprocessor">#if defined(FE_SB)</span>
01296 <span class="preprocessor"></span>    PCHAR_INFO TransBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01297 <span class="preprocessor">#endif</span>
01298 <span class="preprocessor"></span>
01299     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"SrvWriteConsoleOutput\n"</span>));
01300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o0">ConsoleHandle</a>,
01301                          &amp;Console
01302                         );
01303     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01304         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01305     }
01306     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
01307                                  a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o1">OutputHandle</a>,
01308                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
01309                                  GENERIC_WRITE,
01310                                  &amp;HandleData
01311                                 );
01312     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">// a region of zero size is indicated by the right and bottom</span>
01316         <span class="comment">// coordinates being less than the left and top.</span>
01317         <span class="comment">//</span>
01318 
01319         a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Left-1);
01320         a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Top-1);
01321     } <span class="keywordflow">else</span> {
01322 
01323         COORD <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01324         ULONG NumBytes;
01325 
01326         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Right - a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Left + 1);
01327         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Bottom - a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>.Top + 1);
01328         NumBytes = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X * <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y * <span class="keyword">sizeof</span>(*Buffer);
01329 
01330         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X == 1) &amp;&amp; (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y == 1)) {
01331             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o2">Char</a>;
01332         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o6">ReadVM</a>) {
01333             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),NumBytes);
01334             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01335                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01336                 <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
01337             }
01338             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01339                                          a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o3">BufPtr</a>,
01340                                          <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01341                                          NumBytes,
01342                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01343                                         );
01344             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01345                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
01346                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01347                 <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
01348             }
01349         } <span class="keywordflow">else</span> {
01350             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o3">BufPtr</a>;
01351             <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o3">BufPtr</a>, NumBytes, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01352                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01353                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01354             }
01355         }
01356         ScreenBufferInformation = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
01357 
01358         <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o5">Unicode</a>) {
01359             <a class="code" href="../../d6/d8/dispatch_8h.html#a11">TranslateOutputToUnicode</a>(Console,
01360                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01361                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>
01362                                     );
01363 <span class="preprocessor">#if defined(FE_SB)</span>
01364 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a53">WriteScreenBuffer</a>(ScreenBufferInformation,
01365                                        <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01366                                        &amp;a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>
01367                                       );
01368 <span class="preprocessor">#endif</span>
01369 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01370                 ((Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN) == 0)) {
01371 <span class="preprocessor">#if defined(FE_SB)</span>
01372 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
01373                 TransBuffer = (PCHAR_INFO)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),(<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y * <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X) * 2 * <span class="keyword">sizeof</span>(CHAR_INFO));
01374                 <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01375                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01376                     <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
01377                 }
01378                 <a class="code" href="../../d6/d8/dispatch_8h.html#a14">FE_TranslateOutputToAnsiUnicode</a>(Console,
01379                                             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01380                                             <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
01381                                             &amp;TransBuffer[0]
01382                                            );
01383                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a53">WriteScreenBuffer</a>(ScreenBufferInformation,
01384                                             &amp;TransBuffer[0],
01385                                             &amp;a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>
01386                                            );
01387                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01388             }
01389             <span class="keywordflow">else</span> {
01390                 <a class="code" href="../../d6/d8/dispatch_8h.html#a15">SB_TranslateOutputToAnsiUnicode</a>(Console,
01391                                                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01392                                                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>
01393                                                );
01394                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a53">WriteScreenBuffer</a>(ScreenBufferInformation,
01395                                             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01396                                             &amp;a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>
01397                                            );
01398             }
01399 <span class="preprocessor">#else</span>
01400 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a13">TranslateOutputToAnsiUnicode</a>(Console,
01401                                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01402                                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>
01403                                        );
01404 <span class="preprocessor">#endif</span>
01405 <span class="preprocessor"></span>        }
01406 <span class="preprocessor">#if defined(FE_SB)</span>
01407 <span class="preprocessor"></span>        <span class="keywordflow">else</span>
01408 <span class="preprocessor">#endif</span>
01409 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a53">WriteScreenBuffer</a>(ScreenBufferInformation,
01410                                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01411                                     &amp;a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>
01412                                    );
01413 
01414         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o6">ReadVM</a>) {
01415             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
01416         }
01417         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01418 
01419             <span class="comment">//</span>
01420             <span class="comment">// cause screen to be updated</span>
01421             <span class="comment">//</span>
01422 
01423 <span class="preprocessor">#if defined(FE_SB)</span>
01424 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) &amp;&amp;
01425                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; CONSOLE_JUST_VDM_UNREGISTERED ){
01426                 <span class="keywordtype">int</span> MouseRec;
01427                 MouseRec = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o4">InputMode</a>;
01428                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o4">InputMode</a> &amp;= ~ENABLE_MOUSE_INPUT;
01429                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01430                 <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenBufferInformation,&amp;a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a> );
01431                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01432                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o4">InputMode</a> = MouseRec;
01433             }
01434             <span class="keywordflow">else</span>
01435 <span class="preprocessor">#endif</span>
01436 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenBufferInformation,
01437                           &amp;a-&gt;<a class="code" href="../../d6/d7/struct__CONSOLE__WRITECONSOLEOUTPUT__MSG.html#o4">CharRegion</a>
01438                          );
01439         }
01440     }
01441     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01442     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01443     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01444 }
01445 
01446 
01447 ULONG
<a name="l01448"></a><a class="code" href="../../d2/d8/directio_8c.html#a14">01448</a> <a class="code" href="../../d2/d8/directio_8c.html#a14">SrvReadConsoleOutputString</a>(
01449     IN OUT PCSR_API_MSG m,
01450     IN OUT PCSR_REPLY_STATUS ReplyStatus
01451     )
01452 {
01453     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01454     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01455     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01456     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01457     <a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html">PCONSOLE_READCONSOLEOUTPUTSTRING_MSG</a> a = (<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html">PCONSOLE_READCONSOLEOUTPUTSTRING_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01458     ULONG nSize;
01459 
01460     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o0">ConsoleHandle</a>,
01461                          &amp;Console
01462                         );
01463     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01464         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01465     }
01466     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
01467                                  a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o1">OutputHandle</a>,
01468                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
01469                                  GENERIC_READ,
01470                                  &amp;HandleData
01471                                 );
01472     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01473 
01474         <span class="comment">//</span>
01475         <span class="comment">// a region of zero size is indicated by the right and bottom</span>
01476         <span class="comment">// coordinates being less than the left and top.</span>
01477         <span class="comment">//</span>
01478 
01479         a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o6">NumRecords</a> = 0;
01480     } <span class="keywordflow">else</span> {
01481         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o3">StringType</a> == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>)
01482             nSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
01483         <span class="keywordflow">else</span>
01484             nSize = <span class="keyword">sizeof</span>(WORD);
01485         <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o6">NumRecords</a>*nSize) &gt; <span class="keyword">sizeof</span>(a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o4">String</a>)) {
01486             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o5">BufPtr</a>;
01487             <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o5">BufPtr</a>, a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o6">NumRecords</a>, nSize)) {
01488                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01489                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01490             }
01491         }
01492         <span class="keywordflow">else</span> {
01493             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o4">String</a>;
01494         }
01495         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a54">ReadOutputString</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer,
01496                                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01497                                 a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o2">ReadCoord</a>,
01498                                 a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o3">StringType</a>,
01499                                 &amp;a-&gt;<a class="code" href="../../d5/d4/struct__CONSOLE__READCONSOLEOUTPUTSTRING__MSG.html#o6">NumRecords</a>
01500                                );
01501     }
01502     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01503     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01504     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01505 }
01506 
01507 ULONG
<a name="l01508"></a><a class="code" href="../../d2/d8/directio_8c.html#a15">01508</a> <a class="code" href="../../d2/d8/directio_8c.html#a15">SrvWriteConsoleOutputString</a>(
01509     IN OUT PCSR_API_MSG m,
01510     IN OUT PCSR_REPLY_STATUS ReplyStatus
01511     )
01512 {
01513     <a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html">PCONSOLE_WRITECONSOLEOUTPUTSTRING_MSG</a> a = (<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html">PCONSOLE_WRITECONSOLEOUTPUTSTRING_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01514     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01515     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01516     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01517     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01518     ULONG nSize;
01519 
01520     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o0">ConsoleHandle</a>,
01521                          &amp;Console
01522                         );
01523     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01524         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01525     }
01526     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
01527                                  a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o1">OutputHandle</a>,
01528                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
01529                                  GENERIC_WRITE,
01530                                  &amp;HandleData
01531                                 );
01532     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01533         a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o6">NumRecords</a> = 0;
01534     } <span class="keywordflow">else</span> {
01535         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o2">WriteCoord</a>.X &lt; 0 ||
01536             a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o2">WriteCoord</a>.Y &lt; 0) {
01537             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01538         } <span class="keywordflow">else</span> {
01539             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o3">StringType</a> == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>)
01540                 nSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
01541             <span class="keywordflow">else</span>
01542                 nSize = <span class="keyword">sizeof</span>(WORD);
01543             <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o6">NumRecords</a>*nSize) &gt; <span class="keyword">sizeof</span>(a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o4">String</a>)) {
01544                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o5">BufPtr</a>;
01545                 <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o5">BufPtr</a>, a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o6">NumRecords</a>, nSize)) {
01546                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01547                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01548                 }
01549             }
01550             <span class="keywordflow">else</span> {
01551                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o4">String</a>;
01552             }
01553             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a2">WriteOutputString</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer,
01554                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01555                                      a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o2">WriteCoord</a>,
01556                                      a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o3">StringType</a>,
01557                                      &amp;a-&gt;<a class="code" href="../../d7/d7/struct__CONSOLE__WRITECONSOLEOUTPUTSTRING__MSG.html#o6">NumRecords</a>,
01558                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01559                                     );
01560         }
01561     }
01562     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01563     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01564     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01565 }
01566 
01567 ULONG
<a name="l01568"></a><a class="code" href="../../d2/d8/directio_8c.html#a16">01568</a> <a class="code" href="../../d2/d8/directio_8c.html#a16">SrvFillConsoleOutput</a>(
01569     IN OUT PCSR_API_MSG m,
01570     IN OUT PCSR_REPLY_STATUS ReplyStatus
01571     )
01572 {
01573     <a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html">PCONSOLE_FILLCONSOLEOUTPUT_MSG</a> a = (<a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html">PCONSOLE_FILLCONSOLEOUTPUT_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01574     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01575     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01576     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01577 
01578     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html#o0">ConsoleHandle</a>,
01579                          &amp;Console
01580                         );
01581     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01582         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01583     }
01584     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
01585                                  a-&gt;<a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html#o1">OutputHandle</a>,
01586                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
01587                                  GENERIC_WRITE,
01588                                  &amp;HandleData
01589                                 );
01590     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01591         a-&gt;<a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html#o5">Length</a> = 0;
01592     } <span class="keywordflow">else</span> {
01593         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer,
01594                           a-&gt;<a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html#o4">Element</a>,
01595                           a-&gt;<a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html#o2">WriteCoord</a>,
01596                           a-&gt;<a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html#o3">ElementType</a>,
01597                           &amp;a-&gt;<a class="code" href="../../d2/d0/struct__CONSOLE__FILLCONSOLEOUTPUT__MSG.html#o5">Length</a>
01598                          );
01599     }
01600     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01601     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01602     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01603 }
01604 
01605 
01606 ULONG
<a name="l01607"></a><a class="code" href="../../d2/d8/directio_8c.html#a17">01607</a> <a class="code" href="../../d2/d8/directio_8c.html#a17">SrvCreateConsoleScreenBuffer</a>(
01608     IN OUT PCSR_API_MSG m,
01609     IN OUT PCSR_REPLY_STATUS ReplyStatus
01610     )
01611 
01612 <span class="comment">/*++</span>
01613 <span class="comment"></span>
01614 <span class="comment">Routine Description:</span>
01615 <span class="comment"></span>
01616 <span class="comment">    This routine creates a screen buffer and returns a handle to it.</span>
01617 <span class="comment"></span>
01618 <span class="comment">Arguments:</span>
01619 <span class="comment"></span>
01620 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
01621 <span class="comment"></span>
01622 <span class="comment">Return Value:</span>
01623 <span class="comment"></span>
01624 <span class="comment">--*/</span>
01625 
01626 {
01627     <a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html">PCONSOLE_CREATESCREENBUFFER_MSG</a> a = (<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html">PCONSOLE_CREATESCREENBUFFER_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01628     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01629     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01630     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01631     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01632     <a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html">PCONSOLE_SHARE_ACCESS</a> ShareAccess;
01633     CHAR_INFO Fill;
01634     COORD WindowSize;
01635     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
01636     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01637     ULONG HandleType;
01638     <span class="keywordtype">int</span> FontIndex;
01639 
01640     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"SrvCreateConsoleScreenBuffer\n"</span>));
01641     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o0">ConsoleHandle</a>,
01642                          &amp;Console
01643                         );
01644     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01645         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01646     }
01647 
01648     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o4">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
01649         <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o5">GraphicsBufferInfo</a>.lpBitMapInfo, a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o5">GraphicsBufferInfo</a>.dwBitMapInfoLength, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01650             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01651             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01652         }
01653     }
01654 
01655     <span class="keywordflow">try</span> {
01656         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE) -1;
01657         ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
01658         HandleType = (a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o4">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) ?
01659                       <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a> : <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>;
01660         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o2">InheritHandle</a>)
01661             HandleType |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
01662         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
01663                                   HandleType,
01664                                   &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
01665                                  );
01666         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01667             leave;
01668         }
01669         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
01670                                      <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01671                                      &amp;HandleData
01672                                     );
01673         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01674         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01675             leave;
01676         }
01677 
01678         <span class="comment">//</span>
01679         <span class="comment">// create new screen buffer</span>
01680         <span class="comment">//</span>
01681 
01682         Fill.Char.UnicodeChar = (WCHAR)<span class="charliteral">' '</span>;
01683         Fill.Attributes = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a>;
01684         WindowSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>);
01685         WindowSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>);
01686         FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a26">CON_FAMILY</a>(Console),
01687                                    <a class="code" href="../../d8/d5/consrv_8h.html#a28">CON_FACENAME</a>(Console),
01688                                    <a class="code" href="../../d8/d5/consrv_8h.html#a29">CON_FONTSIZE</a>(Console),
01689                                    <a class="code" href="../../d8/d5/consrv_8h.html#a30">CON_FONTWEIGHT</a>(Console),
01690                                    <a class="code" href="../../d8/d5/consrv_8h.html#a31">CON_FONTCODEPAGE</a>(Console)
01691                                   );
01692         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a42">CreateScreenBuffer</a>(&amp;ScreenInfo,WindowSize,
01693                                     FontIndex,
01694                                     WindowSize,
01695                                     Fill,Fill,Console,
01696                                     a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o4">Flags</a>,&amp;a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o5">GraphicsBufferInfo</a>,
01697                                     &amp;a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o7">lpBitmap</a>,&amp;a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o6">hMutex</a>,
01698                                     <a class="code" href="../../d7/d2/output_8h.html#a10">CURSOR_SMALL_SIZE</a>, 
01699                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01700         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01701             leave;
01702         }
01703         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a>(HandleData,ScreenInfo);
01704         ShareAccess = &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o4">ShareAccess</a>;
01705 
01706         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o1">DesiredAccess</a>,
01707                                  a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o3">ShareMode</a>,
01708                                  ShareAccess,
01709                                  HandleData
01710                                 );
01711         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01712             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;RefCount--;
01713             <a class="code" href="../../d6/d2/output_8c.html#a46">FreeScreenBuffer</a>(ScreenInfo);
01714             leave;
01715         }
01716         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a22">InsertScreenBuffer</a>(Console, ScreenInfo);
01717         a-&gt;<a class="code" href="../../d8/d9/struct__CONSOLE__CREATESCREENBUFFER__MSG.html#o8">Handle</a> = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01718     } finally {
01719         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != (HANDLE)-1) {
01720             <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a>(ProcessData,
01721                          <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
01722                         );
01723         }
01724         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01725     }
01726     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01727     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01728 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
