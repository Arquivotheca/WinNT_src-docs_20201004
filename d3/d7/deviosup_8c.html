<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: deviosup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>deviosup.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d4/d6/deviosup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/struct__IO__RUN.html">_IO_RUN</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_DEVIOSUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_DEVIOSUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a2">MAX_PARALLEL_IOS</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d5/struct__IO__RUN.html">_IO_RUN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a3">IO_RUN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d5/struct__IO__RUN.html">IO_RUN</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a4">PIO_RUN</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a5">UdfPrepareBuffers</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN PVOID UserBuffer, IN ULONG UserBufferOffset, IN LONGLONG StartingOffset, IN ULONG ByteCount, IN <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a> IoRuns, IN PULONG RunCount, IN PULONG ThisByteCount, OUT PBOOLEAN SparseRuns)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a6">UdfFinishBuffers</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a> IoRuns, IN ULONG RunCount, IN BOOLEAN FinalCleanup)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a7">UdfMultipleAsync</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN ULONG RunCount, IN <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a> IoRuns)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a8">UdfSingleAsync</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN LONGLONG ByteOffset, IN ULONG ByteCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a9">UdfWaitSync</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a10">UdfMultiSyncCompletionRoutine</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a11">UdfMultiAsyncCompletionRoutine</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a12">UdfSingleSyncCompletionRoutine</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a13">UdfSingleAsyncCompletionRoutine</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a14">UdfNonCachedRead</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN LONGLONG StartingOffset, IN ULONG ByteCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a15">UdfCreateUserMdl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN ULONG BufferLength, IN BOOLEAN RaiseOnError)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a16">UdfPerformDevIoCtrl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN ULONG IoControlCode, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> Device, OUT PVOID OutputBuffer OPTIONAL, IN ULONG OutputBufferLength, IN BOOLEAN InternalDeviceIoControl, IN BOOLEAN OverrideVerify, OUT PIO_STATUS_BLOCK Iosb OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a17">UdfReadSectors</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN LONGLONG StartingOffset, IN ULONG ByteCount, IN BOOLEAN ReturnError, IN OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/deviosup_8c.html#a18">UdfPrepareBuffers</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN PVOID UserBuffer, IN ULONG UserBufferOffset, IN LONGLONG StartingOffset, IN ULONG ByteCount, IN <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a> IoRuns, IN PULONG RunCount, IN PULONG ThisByteCount, IN PBOOLEAN SparseRuns)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="deviosup.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_DEVIOSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00027">27</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="deviosup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_DEVIOSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00033">33</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="deviosup.c::MAX_PARALLEL_IOS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_PARALLEL_IOS&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00107">107</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a3" doxytag="deviosup.c::IO_RUN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d5/struct__IO__RUN.html">_IO_RUN</a>  <a class="el" href="../../d0/d5/struct__IO__RUN.html">IO_RUN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="deviosup.c::PIO_RUN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d0/d5/struct__IO__RUN.html">IO_RUN</a>* <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00105">105</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01280">UdfFinishBuffers()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a15" doxytag="deviosup.c::UdfCreateUserMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCreateUserMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RaiseOnError</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">474</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>.
<p>
<pre class="fragment"><div>00482                    :
00483 
00484     This routine locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified buffer <span class="keywordflow">for</span> read access (we only write into
00485     the buffer).  The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system requires <span class="keyword">this</span> routine since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not
00486     ask <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system to lock its buffers <span class="keywordflow">for</span> direct I/O.  This routine
00487     may <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsd <span class="keywordflow">while</span> still in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user context.
00488 
00489     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> called <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not already an Mdl.
00490 
00491 Arguments:
00492 
00493     BufferLength - Length of user buffer.
00494 
00495     RaiseOnError - Indicates <span class="keywordflow">if</span> our caller wants <span class="keyword">this</span> routine to raise on
00496         an error condition.
00497 
00498 Return Value:
00499 
00500     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> from <span class="keyword">this</span> routine.  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> status <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> returned <span class="keywordflow">if</span>
00501         RaiseOnError <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00502 
00503 --*/
00504 
00505 {
00506     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00507     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00508 
00509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00510 
00511     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00512     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( IrpContext-&gt;Irp );
00513     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IrpContext-&gt;Irp-&gt;MdlAddress == NULL );
00514 
00515     <span class="comment">//</span>
00516     <span class="comment">// Allocate the Mdl, and Raise if we fail.</span>
00517     <span class="comment">//</span>
00518 
00519     Mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( IrpContext-&gt;Irp-&gt;UserBuffer,
00520                          BufferLength,
00521                          FALSE,
00522                          FALSE,
00523                          IrpContext-&gt;Irp );
00524 
00525     <span class="keywordflow">if</span> (Mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00526 
00527         <span class="comment">//</span>
00528         <span class="comment">//  Now probe the buffer described by the Irp.  If we get an exception,</span>
00529         <span class="comment">//  deallocate the Mdl and return the appropriate "expected" status.</span>
00530         <span class="comment">//</span>
00531 
00532         <span class="keywordflow">try</span> {
00533 
00534             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( Mdl, IrpContext-&gt;Irp-&gt;RequestorMode, IoWriteAccess );
00535 
00536             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00537 
00538         } except(EXCEPTION_EXECUTE_HANDLER) {
00539 
00540             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00541 
00542             <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( Mdl );
00543             IrpContext-&gt;Irp-&gt;MdlAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00544 
00545             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>( Status )) {
00546 
00547                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_USER_BUFFER;
00548             }
00549         }
00550     }
00551 
00552     <span class="comment">//</span>
00553     <span class="comment">//  Check if we are to raise or return</span>
00554     <span class="comment">//</span>
00555 
00556     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00557 
00558         <span class="keywordflow">if</span> (RaiseOnError) {
00559 
00560             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, Status );
00561         }
00562     }
00563 
00564     <span class="comment">//</span>
00565     <span class="comment">//  Return the status code.</span>
00566     <span class="comment">//</span>
00567 
00568     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00569 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="deviosup.c::UdfFinishBuffers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFinishBuffers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IoRuns</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RunCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FinalCleanup</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01280">1280</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00105">PIO_RUN</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00102">_IO_RUN::SavedIrp</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00082">_IO_RUN::TransferBuffer</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00084">_IO_RUN::TransferBufferOffset</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00083">_IO_RUN::TransferByteCount</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00095">_IO_RUN::TransferMdl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00060">_IO_RUN::UserBuffer</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>.
<p>
<pre class="fragment"><div>01289                    :
01290 
01291     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to perform any data transferred required <span class="keywordflow">for</span>
01292     unaligned Io or to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> cleanup of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns array.
01293 
01294     In all cases <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> where we will deallocate any buffer and mdl
01295     allocated to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unaligned transfer.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01296     <span class="keyword">final</span> cleanup then we also transfer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user buffer
01297     and flush <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hardware cache.
01298 
01299     We walk backwards through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run array because we may be shifting data
01300     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's buffer.  Typical <span class="keywordflow">case</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> where we allocated a buffer <span class="keywordflow">for</span>
01301     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first part of a read and then used <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's buffer <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01302     next section (but stored it at the beginning of the buffer.
01303 
01304 Arguments:
01305 
01306     IoRuns - Pointer to the IoRuns array.
01307 
01308     RunCount - Number of entries in the IoRuns array filled here.
01309 
01310     FinalCleanup - Indicates <span class="keywordflow">if</span> we should be deallocating temporary buffers
01311         (TRUE) or transferring bytes <span class="keywordflow">for</span> a unaligned transfers and
01312         deallocating the buffers (FALSE).  Flush the system cache <span class="keywordflow">if</span>
01313         transferring data.
01314 
01315 Return Value:
01316 
01317     BOOLEAN - TRUE <span class="keywordflow">if</span> <span class="keyword">this</span> request needs the Io buffers to be flushed, FALSE otherwise.
01318 
01319 --*/
01320 
01321 {
01322     BOOLEAN FlushIoBuffers = FALSE;
01323 
01324     ULONG RemainingEntries = RunCount;
01325     <a class="code" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a> ThisIoRun = &amp;IoRuns[RunCount - 1];
01326 
01327     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01328 
01329     <span class="comment">//</span>
01330     <span class="comment">//  Walk through each entry in the IoRun array.</span>
01331     <span class="comment">//</span>
01332 
01333     <span class="keywordflow">while</span> (RemainingEntries != 0) {
01334 
01335         <span class="comment">//</span>
01336         <span class="comment">//  We only need to deal with the case of an unaligned transfer.</span>
01337         <span class="comment">//</span>
01338 
01339         <span class="keywordflow">if</span> (ThisIoRun-&gt;TransferByteCount != 0) {
01340 
01341             <span class="comment">//</span>
01342             <span class="comment">//  If not the final cleanup then transfer the data to the</span>
01343             <span class="comment">//  user's buffer and remember that we will need to flush</span>
01344             <span class="comment">//  the user's buffer to memory.</span>
01345             <span class="comment">//</span>
01346 
01347             if (!FinalCleanup) {
01348 
01349                 <span class="comment">//</span>
01350                 <span class="comment">//  If we are shifting in the user's buffer then use</span>
01351                 <span class="comment">//  MoveMemory.</span>
01352                 <span class="comment">//</span>
01353 
01354                 <span class="keywordflow">if</span> (ThisIoRun-&gt;TransferMdl == IrpContext-&gt;Irp-&gt;MdlAddress) {
01355 
01356                     RtlMoveMemory( ThisIoRun-&gt;UserBuffer,
01357                                    <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ThisIoRun-&gt;TransferBuffer,
01358                                             ThisIoRun-&gt;TransferBufferOffset,
01359                                             PVOID ),
01360                                    ThisIoRun-&gt;TransferByteCount );
01361 
01362                 } <span class="keywordflow">else</span> {
01363 
01364                     RtlCopyMemory( ThisIoRun-&gt;UserBuffer,
01365                                    <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ThisIoRun-&gt;TransferBuffer,
01366                                             ThisIoRun-&gt;TransferBufferOffset,
01367                                             PVOID ),
01368                                    ThisIoRun-&gt;TransferByteCount );
01369                 }
01370 
01371                 FlushIoBuffers = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01372             }
01373 
01374             <span class="comment">//</span>
01375             <span class="comment">//  Free any Mdl we may have allocated.  If the Mdl isn't</span>
01376             <span class="comment">//  present then we must have failed during the allocation</span>
01377             <span class="comment">//  phase.</span>
01378             <span class="comment">//</span>
01379 
01380             <span class="keywordflow">if</span> (ThisIoRun-&gt;TransferMdl != IrpContext-&gt;Irp-&gt;MdlAddress) {
01381 
01382                 <span class="keywordflow">if</span> (ThisIoRun-&gt;TransferMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01383 
01384                     <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( ThisIoRun-&gt;TransferMdl );
01385                 }
01386 
01387                 <span class="comment">//</span>
01388                 <span class="comment">//  Now free any buffer we may have allocated.  If the Mdl</span>
01389                 <span class="comment">//  doesn't match the original Mdl then free the buffer.</span>
01390                 <span class="comment">//</span>
01391 
01392                 <span class="keywordflow">if</span> (ThisIoRun-&gt;TransferBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01393 
01394                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;ThisIoRun-&gt;TransferBuffer );
01395                 }
01396             }
01397         }
01398 
01399         <span class="comment">//</span>
01400         <span class="comment">//  Now handle the case where we failed in the process</span>
01401         <span class="comment">//  of allocating associated Irps and Mdls.</span>
01402         <span class="comment">//</span>
01403 
01404         <span class="keywordflow">if</span> (ThisIoRun-&gt;SavedIrp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01405 
01406             <span class="keywordflow">if</span> (ThisIoRun-&gt;SavedIrp-&gt;MdlAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01407 
01408                 <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( ThisIoRun-&gt;SavedIrp-&gt;MdlAddress );
01409             }
01410 
01411             <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( ThisIoRun-&gt;SavedIrp );
01412         }
01413 
01414         <span class="comment">//</span>
01415         <span class="comment">//  Move to the previous IoRun entry.</span>
01416         <span class="comment">//</span>
01417 
01418         ThisIoRun -= 1;
01419         RemainingEntries -= 1;
01420     }
01421 
01422     <span class="comment">//</span>
01423     <span class="comment">//  If we copied any data then flush the Io buffers.</span>
01424     <span class="comment">//</span>
01425 
01426     <span class="keywordflow">return</span> FlushIoBuffers;
01427 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="deviosup.c::UdfMultiAsyncCompletionRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfMultiAsyncCompletionRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01863">1863</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02476">ExReleaseResourceForThread</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01343">_UDF_IO_CONTEXT::IrpCount</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01344">_UDF_IO_CONTEXT::MasterIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01358">_UDF_IO_CONTEXT::RequestedByteCount</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01356">_UDF_IO_CONTEXT::Resource</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01357">_UDF_IO_CONTEXT::ResourceThreadId</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01345">_UDF_IO_CONTEXT::Status</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01706">UdfFreeIoContext</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01435">UdfMultipleAsync()</a>.
<p>
<pre class="fragment"><div>01871                    :
01872 
01873     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine <span class="keywordflow">for</span> all asynchronous reads
01874     started via <a class="code" href="../../d3/d7/deviosup_8c.html#a7">UdfMultipleAsync</a>.
01875 
01876     The completion routine has has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following responsibilities:
01877 
01878         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> individual request was completed with an error, then
01879         <span class="keyword">this</span> completion routine must see <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first error
01880         and remember <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error status in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context.
01881 
01882 Arguments:
01883 
01884     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object.
01885 
01886     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being completed.  (This
01887         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> will no longer be accessible after <span class="keyword">this</span> routine returns.)
01888 
01889     Context - The context parameter which was specified <span class="keywordflow">for</span> all of
01890              <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> multiple asynch I/O requests <span class="keywordflow">for</span> <span class="keyword">this</span> MasterIrp.
01891 
01892 Return Value:
01893 
01894     Currently always returns STATUS_SUCCESS.
01895 
01896 --*/
01897 
01898 {
01899     <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">PUDF_IO_CONTEXT</a> IoContext = Context;
01900     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01901 
01902     <span class="comment">//</span>
01903     <span class="comment">//  If we got an error (or verify required), remember it in the Irp</span>
01904     <span class="comment">//</span>
01905 
01906     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
01907 
01908         InterlockedExchange( &amp;IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o2">Status</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
01909     }
01910 
01911     <span class="comment">//</span>
01912     <span class="comment">//  Decrement IrpCount and see if it goes to zero.</span>
01913     <span class="comment">//</span>
01914 
01915     <span class="keywordflow">if</span> (InterlockedDecrement( &amp;IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o0">IrpCount</a> ) == 0) {
01916 
01917         <span class="comment">//</span>
01918         <span class="comment">//  Mark the master Irp pending</span>
01919         <span class="comment">//</span>
01920 
01921         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o1">MasterIrp</a> );
01922 
01923         <span class="comment">//</span>
01924         <span class="comment">//  Update the Master Irp with any error status from the associated Irps.</span>
01925         <span class="comment">//</span>
01926 
01927         IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o1">MasterIrp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o2">Status</a>;
01928 
01929         <span class="comment">//</span>
01930         <span class="comment">//  Update the information field with the correct value.</span>
01931         <span class="comment">//</span>
01932 
01933         IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o1">MasterIrp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
01934 
01935         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o1">MasterIrp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
01936 
01937             IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o1">MasterIrp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o6">RequestedByteCount</a>;
01938         }
01939 
01940         <span class="comment">//</span>
01941         <span class="comment">//  Now release the resource</span>
01942         <span class="comment">//</span>
01943 
01944         <a class="code" href="../../d5/d8/ex_8h.html#a71">ExReleaseResourceForThread</a>( IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o4">Resource</a>,
01945                                     IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o5">ResourceThreadId</a> );
01946 
01947         <span class="comment">//</span>
01948         <span class="comment">//  and finally, free the context record.</span>
01949         <span class="comment">//</span>
01950 
01951         <a class="code" href="../../d3/d8/udfprocs_8h.html#a95">UdfFreeIoContext</a>( IoContext );
01952 
01953         <span class="comment">//</span>
01954         <span class="comment">//  Return success in this case.</span>
01955         <span class="comment">//</span>
01956 
01957         <span class="keywordflow">return</span> STATUS_SUCCESS;
01958 
01959     } <span class="keywordflow">else</span> {
01960 
01961         <span class="comment">//</span>
01962         <span class="comment">//  We need to cleanup the associated Irp and its Mdl.</span>
01963         <span class="comment">//</span>
01964 
01965         <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
01966         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
01967 
01968         <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
01969     }
01970 
01971     UNREFERENCED_PARAMETER( DeviceObject );
01972 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="deviosup.c::UdfMultipleAsync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfMultipleAsync           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RunCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IoRuns</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01435">1435</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01804">IoBuildPartialMdl()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08338">IoMakeAssociatedIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03977">IoSetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01835">PIO_COMPLETION_ROUTINE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01863">UdfMultiAsyncCompletionRoutine()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01779">UdfMultiSyncCompletionRoutine()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>.
<p>
<pre class="fragment"><div>01443                    :
01444 
01445     This routine first does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial setup required of a Master <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01446     going to be completed <span class="keyword">using</span> associated IRPs.  This routine should not
01447     be used <span class="keywordflow">if</span> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> one async request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed, instead <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> single read
01448     async <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> should be called.
01449 
01450     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> context parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized, to serve as a communications area
01451     between here and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common completion routine.
01452 
01453     Next <span class="keyword">this</span> routine reads or writes one or more contiguous sectors from
01454     a device asynchronously, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">if</span> there are multiple reads <span class="keywordflow">for</span> a
01455     master <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> completion routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to synchronize with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01456     completion of all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O requests started by calls to <span class="keyword">this</span> routine.
01457 
01458     Also, prior to calling <span class="keyword">this</span> routine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01459     IoStatus field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context, with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct success status and byte
01460     count which are expected <span class="keywordflow">if</span> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parallel transfers complete
01461     successfully.  After <span class="keywordflow">return</span> <span class="keyword">this</span> status will be unchanged <span class="keywordflow">if</span> all requests
01462     were, in fact, successful.  However, <span class="keywordflow">if</span> one or more errors occur, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01463     IoStatus will be modified to reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error status and byte count
01464     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first run (by Vbo) which encountered an error.  I/O status
01465     from all subsequent runs will not be indicated.
01466 
01467 Arguments:
01468 
01469     RunCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of multiple async requests
01470         that will be issued against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master irp.
01471 
01472     IoRuns - Supplies an array containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> and ByteCount <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01473         separate requests.
01474 
01475 Return Value:
01476 
01477     None.
01478 
01479 --*/
01480 
01481 {
01482     <a class="code" href="../../d0/d5/io_8h.html#a357">PIO_COMPLETION_ROUTINE</a> CompletionRoutine;
01483     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01484     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
01485     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01486     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> MasterIrp;
01487     ULONG UnwindRunCount;
01488 
01489     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01490 
01491     <span class="comment">//</span>
01492     <span class="comment">//  Set up things according to whether this is truely async.</span>
01493     <span class="comment">//</span>
01494 
01495     CompletionRoutine = <a class="code" href="../../d3/d7/deviosup_8c.html#a10">UdfMultiSyncCompletionRoutine</a>;
01496 
01497     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
01498 
01499         CompletionRoutine = <a class="code" href="../../d3/d7/deviosup_8c.html#a11">UdfMultiAsyncCompletionRoutine</a>;
01500     }
01501 
01502     <span class="comment">//</span>
01503     <span class="comment">//  Initialize some local variables.</span>
01504     <span class="comment">//</span>
01505 
01506     MasterIrp = IrpContext-&gt;Irp;
01507 
01508     <span class="comment">//</span>
01509     <span class="comment">//  Itterate through the runs, doing everything that can fail.</span>
01510     <span class="comment">//  We let the cleanup in CdFinishBuffers clean up on error.</span>
01511     <span class="comment">//</span>
01512 
01513     <span class="keywordflow">for</span> (UnwindRunCount = 0;
01514          UnwindRunCount &lt; RunCount;
01515          UnwindRunCount += 1) {
01516 
01517         <span class="comment">//</span>
01518         <span class="comment">//  Create an associated IRP, making sure there is one stack entry for</span>
01519         <span class="comment">//  us, as well.</span>
01520         <span class="comment">//</span>
01521 
01522         IoRuns[UnwindRunCount].SavedIrp =
01523         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a87">IoMakeAssociatedIrp</a>( MasterIrp, (CCHAR)(IrpContext-&gt;Vcb-&gt;TargetDeviceObject-&gt;StackSize + 1) );
01524 
01525         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01526 
01527             IrpContext-&gt;Irp-&gt;IoStatus.Information = 0;
01528             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
01529         }
01530 
01531         <span class="comment">//</span>
01532         <span class="comment">// Allocate and build a partial Mdl for the request.</span>
01533         <span class="comment">//</span>
01534 
01535         Mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( IoRuns[UnwindRunCount].TransferVirtualAddress,
01536                              IoRuns[UnwindRunCount].DiskByteCount,
01537                              FALSE,
01538                              FALSE,
01539                              Irp );
01540 
01541         <span class="keywordflow">if</span> (Mdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01542 
01543             IrpContext-&gt;Irp-&gt;IoStatus.Information = 0;
01544             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
01545         }
01546 
01547         <a class="code" href="../../d4/d6/iosubs_8c.html#a26">IoBuildPartialMdl</a>( IoRuns[UnwindRunCount].TransferMdl,
01548                            Mdl,
01549                            IoRuns[UnwindRunCount].TransferVirtualAddress,
01550                            IoRuns[UnwindRunCount].DiskByteCount );
01551 
01552         <span class="comment">//</span>
01553         <span class="comment">//  Get the first IRP stack location in the associated Irp</span>
01554         <span class="comment">//</span>
01555 
01556         <a class="code" href="../../d0/d5/io_8h.html#a238">IoSetNextIrpStackLocation</a>( Irp );
01557         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01558 
01559         <span class="comment">//</span>
01560         <span class="comment">//  Setup the Stack location to describe our read.</span>
01561         <span class="comment">//</span>
01562 
01563         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a>;
01564         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length = IoRuns[UnwindRunCount].DiskByteCount;
01565         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.ByteOffset.QuadPart = IoRuns[UnwindRunCount].DiskOffset;
01566 
01567         <span class="comment">//</span>
01568         <span class="comment">// Set up the completion routine address in our stack frame.</span>
01569         <span class="comment">//</span>
01570 
01571         <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( Irp,
01572                                 CompletionRoutine,
01573                                 IrpContext-&gt;IoContext,
01574                                 TRUE,
01575                                 TRUE,
01576                                 TRUE );
01577 
01578         <span class="comment">//</span>
01579         <span class="comment">//  Setup the next IRP stack location in the associated Irp for the disk</span>
01580         <span class="comment">//  driver beneath us.</span>
01581         <span class="comment">//</span>
01582 
01583         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp );
01584 
01585         <span class="comment">//</span>
01586         <span class="comment">//  Setup the Stack location to do a read from the disk driver.</span>
01587         <span class="comment">//</span>
01588 
01589         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a>;
01590         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length = IoRuns[UnwindRunCount].DiskByteCount;
01591         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.ByteOffset.QuadPart = IoRuns[UnwindRunCount].DiskOffset;
01592     }
01593 
01594     <span class="comment">//</span>
01595     <span class="comment">//  We only need to set the associated IRP count in the master irp to</span>
01596     <span class="comment">//  make it a master IRP.  But we set the count to one more than our</span>
01597     <span class="comment">//  caller requested, because we do not want the I/O system to complete</span>
01598     <span class="comment">//  the I/O.  We also set our own count.</span>
01599     <span class="comment">//</span>
01600 
01601     IrpContext-&gt;IoContext-&gt;IrpCount = RunCount;
01602     IrpContext-&gt;IoContext-&gt;MasterIrp = MasterIrp;
01603 
01604     <span class="comment">//</span>
01605     <span class="comment">//  We set the count in the master Irp to 1 since typically we</span>
01606     <span class="comment">//  will clean up the associated irps ourselves.  Setting this to one</span>
01607     <span class="comment">//  means completing the last associated Irp with SUCCESS (in the async</span>
01608     <span class="comment">//  case) will complete the master irp.</span>
01609     <span class="comment">//</span>
01610 
01611     MasterIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.IrpCount = 1;
01612 
01613     <span class="comment">//</span>
01614     <span class="comment">//  Now that all the dangerous work is done, issue the Io requests</span>
01615     <span class="comment">//</span>
01616 
01617     <span class="keywordflow">for</span> (UnwindRunCount = 0;
01618          UnwindRunCount &lt; RunCount;
01619          UnwindRunCount++) {
01620 
01621         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = IoRuns[UnwindRunCount].SavedIrp;
01622         IoRuns[UnwindRunCount].SavedIrp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01623 
01624         <span class="comment">//</span>
01625         <span class="comment">//  If IoCallDriver returns an error, it has completed the Irp</span>
01626         <span class="comment">//  and the error will be caught by our completion routines</span>
01627         <span class="comment">//  and dealt with as a normal IO error.</span>
01628         <span class="comment">//</span>
01629 
01630         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, Irp );
01631     }
01632 
01633     <span class="keywordflow">return</span>;
01634 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="deviosup.c::UdfMultiSyncCompletionRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfMultiSyncCompletionRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01779">1779</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01343">_UDF_IO_CONTEXT::IrpCount</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01344">_UDF_IO_CONTEXT::MasterIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a97">PUDF_IO_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01345">_UDF_IO_CONTEXT::Status</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01365">_UDF_IO_CONTEXT::SyncEvent</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01435">UdfMultipleAsync()</a>.
<p>
<pre class="fragment"><div>01787                    :
01788 
01789     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine <span class="keywordflow">for</span> all synchronous reads
01790     started via <a class="code" href="../../d3/d7/deviosup_8c.html#a7">UdfMultipleAsync</a>.
01791 
01792     The completion routine has has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following responsibilities:
01793 
01794         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> individual request was completed with an error, then
01795         <span class="keyword">this</span> completion routine must see <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first error
01796         and remember <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error status in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context.
01797 
01798         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpCount goes to 1, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context
01799         parameter to signal <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller that all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> asynch requests
01800         are done.
01801 
01802 Arguments:
01803 
01804     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object.
01805 
01806     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being completed.  (This
01807         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> will no longer be accessible after <span class="keyword">this</span> routine returns.)
01808 
01809     Context - The context parameter which was specified <span class="keywordflow">for</span> all of
01810         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> multiple asynch I/O requests <span class="keywordflow">for</span> <span class="keyword">this</span> MasterIrp.
01811 
01812 Return Value:
01813 
01814     The routine returns STATUS_MORE_PROCESSING_REQUIRED so that we can
01815     immediately complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Master <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> without being in a race condition
01816     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a> thread trying to decrement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpCount in
01817     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Master <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
01818 
01819 --*/
01820 
01821 {
01822     <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">PUDF_IO_CONTEXT</a> IoContext = Context;
01823 
01824     <span class="comment">//</span>
01825     <span class="comment">//  If we got an error (or verify required), remember it in the Irp</span>
01826     <span class="comment">//</span>
01827 
01828     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
01829 
01830         InterlockedExchange( &amp;IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o2">Status</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
01831         IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o1">MasterIrp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
01832     }
01833 
01834     <span class="comment">//</span>
01835     <span class="comment">//  We must do this here since IoCompleteRequest won't get a chance</span>
01836     <span class="comment">//  on this associated Irp.</span>
01837     <span class="comment">//</span>
01838 
01839     <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
01840     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
01841 
01842     <span class="keywordflow">if</span> (InterlockedDecrement( &amp;IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o0">IrpCount</a> ) == 0) {
01843 
01844         <span class="comment">//</span>
01845         <span class="comment">//  Update the Master Irp with any error status from the associated Irps.</span>
01846         <span class="comment">//</span>
01847 
01848         IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o1">MasterIrp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o2">Status</a>;
01849         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;IoContext-&gt;<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html#o7">SyncEvent</a>, 0, FALSE );
01850     }
01851 
01852     UNREFERENCED_PARAMETER( DeviceObject );
01853 
01854     <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
01855 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="deviosup.c::UdfNonCachedRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfNonCachedRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">201</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01064">FCB_STATE_EMBEDDED_DATA</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01063">FCB_STATE_VMCB_MAPPING</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01241">IRP_CONTEXT_FLAG_ALLOC_IO</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d4/d4/ppc_2flush_8c-source.html#l00693">KeFlushIoBuffers()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00107">MAX_PARALLEL_IOS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">UdfCreateUserMdl()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01280">UdfFinishBuffers()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00902">UdfMapUserBuffer</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01435">UdfMultipleAsync()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01642">UdfSingleAsync()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01740">UdfWaitSync()</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.
<p>
<pre class="fragment"><div>00210                    :
00211 
00212     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-cached reads of sectors.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by
00213     performing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following in a loop.
00214 
00215         Fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns array <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next block of Io.
00216         Send <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Io to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.
00217         Perform any cleanup on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Io runs array.
00218 
00219     We will not <span class="keywordflow">do</span> async Io to any request that generates non-aligned Io.
00220     Also we will not perform async Io <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will exceed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of our
00221     IoRuns array.  These should be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unusual cases but we will raise
00222     or <span class="keywordflow">return</span> CANT_WAIT in <span class="keyword">this</span> routine <span class="keywordflow">if</span> we detect <span class="keyword">this</span> <span class="keywordflow">case</span>.
00223 
00224 Arguments:
00225 
00226     Fcb - Fcb representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to read.
00227 
00228     StartingOffset - Logical offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to read from.
00229 
00230     ByteCount - Number of bytes to read.
00231 
00232 Return Value:
00233 
00234     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00235 
00236 --*/
00237 
00238 {
00239     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00240 
00241     <a class="code" href="../../d0/d5/struct__IO__RUN.html">IO_RUN</a> IoRuns[<a class="code" href="../../d3/d7/deviosup_8c.html#a2">MAX_PARALLEL_IOS</a>];
00242     ULONG RunCount = 0;
00243     ULONG CleanupRunCount = 0;
00244 
00245     PVOID UserBuffer;
00246     ULONG UserBufferOffset = 0;
00247     LONGLONG CurrentOffset = StartingOffset;
00248     ULONG RemainingByteCount = ByteCount;
00249     ULONG ThisByteCount;
00250 
00251     BOOLEAN Unaligned;
00252     BOOLEAN SparseRuns;
00253     BOOLEAN FlushIoBuffers = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00254     BOOLEAN FirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00255 
00256     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">//  We want to make sure the user's buffer is locked in all cases.</span>
00260     <span class="comment">//</span>
00261 
00262     <span class="keywordflow">if</span> (IrpContext-&gt;Irp-&gt;MdlAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00263 
00264         <a class="code" href="../../d3/d8/udfprocs_8h.html#a162">UdfCreateUserMdl</a>( IrpContext, ByteCount, TRUE );
00265     }
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">//  Use a try-finally to perform the final cleanup.</span>
00269     <span class="comment">//</span>
00270 
00271     <span class="keywordflow">try</span> {
00272 
00273         <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;UserBuffer);
00274 
00275         <span class="comment">//</span>
00276         <span class="comment">//  Loop while there are more bytes to transfer.</span>
00277         <span class="comment">//</span>
00278 
00279         <span class="keywordflow">do</span> {
00280 
00281             <span class="comment">//</span>
00282             <span class="comment">//  Call prepare buffers to set up the next entries</span>
00283             <span class="comment">//  in the IoRuns array.  Remember if there are any</span>
00284             <span class="comment">//  unaligned entries.</span>
00285             <span class="comment">//</span>
00286 
00287             RtlZeroMemory( IoRuns, <span class="keyword">sizeof</span>( IoRuns ));
00288 
00289             Unaligned = <a class="code" href="../../d3/d7/deviosup_8c.html#a18">UdfPrepareBuffers</a>( IrpContext,
00290                                            IrpContext-&gt;Irp,
00291                                            Fcb,
00292                                            UserBuffer,
00293                                            UserBufferOffset,
00294                                            CurrentOffset,
00295                                            RemainingByteCount,
00296                                            IoRuns,
00297                                            &amp;CleanupRunCount,
00298                                            &amp;ThisByteCount,
00299                                            &amp;SparseRuns );
00300 
00301 
00302             RunCount = CleanupRunCount;
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">//  Quickly finish if we wound up having no IO to perform.  This will</span>
00306             <span class="comment">//  occur in the presence of unrecorded sectors.</span>
00307             <span class="comment">//</span>
00308 
00309             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !(SparseRuns &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;FcbState, FCB_STATE_VMCB_MAPPING|FCB_STATE_EMBEDDED_DATA )));
00310 
00311             <span class="keywordflow">if</span> (RunCount == 0) {
00312 
00313                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = IrpContext-&gt;Irp-&gt;IoStatus.Status = STATUS_SUCCESS );
00314             }
00315 
00316             <span class="comment">//</span>
00317             <span class="comment">//  If this is an async request and there aren't enough entries</span>
00318             <span class="comment">//  in the Io array then post the request.  This routine will</span>
00319             <span class="comment">//  always raise if we are doing any unaligned Io for an</span>
00320             <span class="comment">//  async request.</span>
00321             <span class="comment">//</span>
00322 
00323             <span class="keywordflow">if</span> ((ThisByteCount &lt; RemainingByteCount) &amp;&amp;
00324                 !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00325 
00326                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00327             }
00328 
00329             <span class="comment">//</span>
00330             <span class="comment">//  If the entire Io is contained in a single run then</span>
00331             <span class="comment">//  we can pass the Io down to the driver.  Send the driver down</span>
00332             <span class="comment">//  and wait on the result if this is synchronous.  We cannot</span>
00333             <span class="comment">//  do this simple form (just chucking the IRP down) if some</span>
00334             <span class="comment">//  sparse runs were encountered.</span>
00335             <span class="comment">//</span>
00336 
00337             <span class="keywordflow">if</span> ((RunCount == 1) &amp;&amp; !Unaligned &amp;&amp; !SparseRuns &amp;&amp; FirstPass) {
00338 
00339                 <a class="code" href="../../d3/d7/deviosup_8c.html#a8">UdfSingleAsync</a>( IrpContext,
00340                                 IoRuns[0].DiskOffset,
00341                                 IoRuns[0].DiskByteCount );
00342 
00343                 <span class="comment">//</span>
00344                 <span class="comment">//  No cleanup needed for the IoRuns array here.</span>
00345                 <span class="comment">//</span>
00346 
00347                 CleanupRunCount = 0;
00348 
00349                 <span class="comment">//</span>
00350                 <span class="comment">//  Wait if we are synchronous, otherwise return</span>
00351                 <span class="comment">//</span>
00352 
00353                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00354 
00355                     <a class="code" href="../../d3/d7/deviosup_8c.html#a9">UdfWaitSync</a>( IrpContext );
00356 
00357                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IrpContext-&gt;Irp-&gt;IoStatus.Status;
00358 
00359                 <span class="comment">//</span>
00360                 <span class="comment">//  Our completion routine will free the Io context but</span>
00361                 <span class="comment">//  we do want to return STATUS_PENDING.</span>
00362                 <span class="comment">//</span>
00363 
00364                 } <span class="keywordflow">else</span> {
00365 
00366                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00367                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
00368                 }
00369 
00370                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00371             }
00372 
00373             <span class="comment">//</span>
00374             <span class="comment">//  Otherwise we will perform multiple Io to read in the data.</span>
00375             <span class="comment">//</span>
00376             
00377             <a class="code" href="../../d3/d7/deviosup_8c.html#a7">UdfMultipleAsync</a>( IrpContext, RunCount, IoRuns );
00378 
00379             <span class="comment">//</span>
00380             <span class="comment">//  No cleanup needed on the IoRuns now.</span>
00381             <span class="comment">//</span>
00382 
00383             CleanupRunCount = 0;
00384 
00385             <span class="comment">//</span>
00386             <span class="comment">//  If this is a synchronous request then perform any necessary</span>
00387             <span class="comment">//  post-processing.</span>
00388             <span class="comment">//</span>
00389 
00390             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00391 
00392                 <span class="comment">//</span>
00393                 <span class="comment">//  Wait for the request to complete.</span>
00394                 <span class="comment">//</span>
00395 
00396                 <a class="code" href="../../d3/d7/deviosup_8c.html#a9">UdfWaitSync</a>( IrpContext );
00397 
00398                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IrpContext-&gt;Irp-&gt;IoStatus.Status;
00399 
00400                 <span class="comment">//</span>
00401                 <span class="comment">//  Exit this loop if there is an error.</span>
00402                 <span class="comment">//</span>
00403 
00404                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00405 
00406                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00407                 }
00408 
00409                 <span class="comment">//</span>
00410                 <span class="comment">//  Perform post read operations on the IoRuns if</span>
00411                 <span class="comment">//  necessary.</span>
00412                 <span class="comment">//</span>
00413 
00414                 <span class="keywordflow">if</span> (Unaligned &amp;&amp;
00415                     <a class="code" href="../../d3/d7/deviosup_8c.html#a6">UdfFinishBuffers</a>( IrpContext, IoRuns, RunCount, FALSE )) {
00416 
00417                     FlushIoBuffers = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00418                 }
00419 
00420                 <span class="comment">//</span>
00421                 <span class="comment">//  Exit this loop if there are no more bytes to transfer</span>
00422                 <span class="comment">//  or we have any error.</span>
00423                 <span class="comment">//</span>
00424 
00425                 RemainingByteCount -= ThisByteCount;
00426                 CurrentOffset += ThisByteCount;
00427                 UserBuffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, ThisByteCount, PVOID );
00428                 UserBufferOffset += ThisByteCount;
00429 
00430             <span class="comment">//</span>
00431             <span class="comment">//  Otherwise this is an asynchronous request.  Always return</span>
00432             <span class="comment">//  STATUS_PENDING.</span>
00433             <span class="comment">//</span>
00434 
00435             } <span class="keywordflow">else</span> {
00436 
00437                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00438                 CleanupRunCount = 0;
00439                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_PENDING );
00440                 <span class="keywordflow">break</span>;
00441             }
00442 
00443             FirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00444         } <span class="keywordflow">while</span> (RemainingByteCount != 0);
00445 
00446         <span class="comment">//</span>
00447         <span class="comment">//  Flush the hardware cache if we performed any copy operations.</span>
00448         <span class="comment">//</span>
00449 
00450         <span class="keywordflow">if</span> (FlushIoBuffers) {
00451 
00452             <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a9">KeFlushIoBuffers</a>( IrpContext-&gt;Irp-&gt;MdlAddress, TRUE, FALSE );
00453         }
00454 
00455     } finally {
00456 
00457         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfNonCachedRead"</span> );
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">//  Perform final cleanup on the IoRuns if necessary.</span>
00461         <span class="comment">//</span>
00462 
00463         <span class="keywordflow">if</span> (CleanupRunCount != 0) {
00464 
00465             <a class="code" href="../../d3/d7/deviosup_8c.html#a6">UdfFinishBuffers</a>( IrpContext, IoRuns, CleanupRunCount, TRUE );
00466         }
00467     }
00468 
00469     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00470 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="deviosup.c::UdfPerformDevIoCtrl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPerformDevIoCtrl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IoControlCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Device</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID OutputBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InternalDeviceIoControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OverrideVerify</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK Iosb&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00573">573</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01874">SL_OVERRIDE_VERIFY_VOLUME</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00586                    :
00587 
00588     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to perform DevIoCtrl <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> internally within
00589     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filesystem.  We take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver and <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to our
00590     caller.
00591 
00592 Arguments:
00593 
00594     IoControlCode - Code to send to driver.
00595 
00596     Device - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device to send <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request to.
00597 
00598     OutPutBuffer - Pointer to output buffer.
00599 
00600     OutputBufferLength - Length of output buffer above.
00601 
00602     InternalDeviceIoControl - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an internal or external
00603         Io <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> code.
00604 
00605     OverrideVerify - Indicates <span class="keywordflow">if</span> we should tell <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver not to <span class="keywordflow">return</span>
00606         STATUS_VERIFY_REQUIRED <span class="keywordflow">for</span> mount and verify.
00607 
00608     Iosb - If specified, we <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation here.
00609 
00610 Return Value:
00611 
00612     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> returned by next lower driver.
00613 
00614 --*/
00615 
00616 {
00617     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00618     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00619     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00620     IO_STATUS_BLOCK LocalIosb;
00621     PIO_STATUS_BLOCK IosbToUse = &amp;LocalIosb;
00622 
00623     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">//  Check if the user gave us an Iosb.</span>
00627     <span class="comment">//</span>
00628 
00629     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Iosb )) {
00630 
00631         IosbToUse = Iosb;
00632     }
00633 
00634     IosbToUse-&gt;Status = 0;
00635     IosbToUse-&gt;Information = 0;
00636 
00637     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00638 
00639     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IoControlCode,
00640                                          Device,
00641                                          NULL,
00642                                          0,
00643                                          OutputBuffer,
00644                                          OutputBufferLength,
00645                                          InternalDeviceIoControl,
00646                                          &amp;Event,
00647                                          IosbToUse );
00648 
00649     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00650 
00651         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00652     }
00653 
00654     <span class="keywordflow">if</span> (OverrideVerify) {
00655 
00656         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp )-&gt;Flags, SL_OVERRIDE_VERIFY_VOLUME );
00657     }
00658 
00659     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( Device, Irp );
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">//  We check for device not ready by first checking Status</span>
00663     <span class="comment">//  and then if status pending was returned, the Iosb status</span>
00664     <span class="comment">//  value.</span>
00665     <span class="comment">//</span>
00666 
00667     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00668 
00669         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00670                                       Executive,
00671                                       KernelMode,
00672                                       FALSE,
00673                                       (PLARGE_INTEGER)NULL );
00674 
00675         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IosbToUse-&gt;Status;
00676     }
00677 
00678     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00679 
00680     UNREFERENCED_PARAMETER( IrpContext );
00681 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="deviosup.c::UdfPrepareBuffers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfPrepareBuffers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>UserBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UserBufferOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IoRuns</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RunCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThisByteCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SparseRuns</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">883</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00053">_IO_RUN::DiskByteCount</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00052">_IO_RUN::DiskOffset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00208">LlSectorTruncate</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00107">MAX_PARALLEL_IOS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01500">MmBuildMdlForNonPagedPool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00105">PIO_RUN</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00212">SectorAlign</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00232">SectorOffset</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00204">SectorTruncate</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00167">TAG_IO_BUFFER</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00082">_IO_RUN::TransferBuffer</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00084">_IO_RUN::TransferBufferOffset</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00083">_IO_RUN::TransferByteCount</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00095">_IO_RUN::TransferMdl</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00096">_IO_RUN::TransferVirtualAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00069">UdfLookupAllocation()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00444">UdfNonPagedPool</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00060">_IO_RUN::UserBuffer</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>.
<p>
<pre class="fragment"><div>00899                    :
00900 
00901     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker routine which looks up each run of an IO
00902     request and stores an entry <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns array.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run
00903     begins on an unaligned disk boundary then we will allocate a buffer
00904     and Mdl <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unaligned portion and put <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns entry.
00905 
00906     This routine will raise CANT_WAIT <span class="keywordflow">if</span> an unaligned transfer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> encountered
00907     and <span class="keyword">this</span> request can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> wait.
00908 
00909 Arguments:
00910 
00911     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Originating <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <span class="keywordflow">for</span> <span class="keyword">this</span> request.
00912 
00913     Fcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> data stream.  It may be a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, directory,
00914         <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> table or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00915 
00916     UserBuffer - Current position in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's buffer.
00917 
00918     UserBufferOffset - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original user buffer.
00919 
00920     StartingOffset - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream to begin <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read.
00921 
00922     ByteCount - Number of bytes to read.  We will fill <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns array up
00923         to <span class="keyword">this</span> point.  We will stop early <span class="keywordflow">if</span> we exceed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number
00924         of parallel Ios we support.
00925 
00926     IoRuns - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns array.  The entire array <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zeroes when
00927         <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00928 
00929     RunCount - Number of entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns array filled here.
00930 
00931     ThisByteCount - Number of bytes described by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRun entries.  Will
00932         not exceed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ByteCount passed in.
00933         
00934     SparseRuns - Will indicate whether sparse runs were a component of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00935         range returned.  While not part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns, <span class="keyword">this</span> will affect
00936         our ability to <span class="keywordflow">do</span> simple IO.
00937 
00938 Return Value:
00939 
00940     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries in an unaligned buffer (provided
00941         <span class="keyword">this</span> is synchronous).  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00942 
00943 --*/
00944 
00945 {
00946     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00947 
00948     BOOLEAN Recorded;
00949     
00950     BOOLEAN FoundUnaligned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00951     <a class="code" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a> ThisIoRun = IoRuns;
00952 
00953     <span class="comment">//</span>
00954     <span class="comment">//  Following indicate where we are in the current transfer.  Current</span>
00955     <span class="comment">//  position in the file and number of bytes yet to transfer from</span>
00956     <span class="comment">//  this position.</span>
00957     <span class="comment">//</span>
00958 
00959     ULONG RemainingByteCount = ByteCount;
00960     LONGLONG CurrentFileOffset = StartingOffset;
00961 
00962     <span class="comment">//</span>
00963     <span class="comment">//  Following indicate the state of the user's buffer.  We have</span>
00964     <span class="comment">//  the destination of the next transfer and its offset in the</span>
00965     <span class="comment">//  buffer.  We also have the next available position in the buffer</span>
00966     <span class="comment">//  available for a scratch buffer.  We will align this up to a sector</span>
00967     <span class="comment">//  boundary.</span>
00968     <span class="comment">//</span>
00969 
00970     PVOID CurrentUserBuffer = UserBuffer;
00971     ULONG CurrentUserBufferOffset = UserBufferOffset;
00972 
00973     PVOID ScratchUserBuffer = UserBuffer;
00974     ULONG ScratchUserBufferOffset = UserBufferOffset;
00975 
00976     <span class="comment">//</span>
00977     <span class="comment">//  The following is the next contiguous bytes on the disk to</span>
00978     <span class="comment">//  transfer.  Read from the allocation package.</span>
00979     <span class="comment">//</span>
00980 
00981     LONGLONG DiskOffset;
00982     ULONG CurrentByteCount;
00983 
00984     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00985 
00986     Vcb = Fcb-&gt;Vcb;
00987 
00988     <span class="comment">//</span>
00989     <span class="comment">//  Initialize the RunCount, ByteCount and SparseRuns.</span>
00990     <span class="comment">//</span>
00991 
00992     *RunCount = 0;
00993     *ThisByteCount = 0;
00994     *SparseRuns = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00995 
00996     <span class="comment">//</span>
00997     <span class="comment">//  Loop while there are more bytes to process or there are</span>
00998     <span class="comment">//  available entries in the IoRun array.</span>
00999     <span class="comment">//</span>
01000 
01001     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01002 
01003         *RunCount += 1;
01004 
01005         <span class="comment">//</span>
01006         <span class="comment">//  Initialize the current position in the IoRuns array.</span>
01007         <span class="comment">//  Find the user's buffer for this portion of the transfer.</span>
01008         <span class="comment">//</span>
01009 
01010         ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o2">UserBuffer</a> = CurrentUserBuffer;
01011 
01012         <span class="comment">//</span>
01013         <span class="comment">//  Find the allocation information for the current offset in the</span>
01014         <span class="comment">//  stream.</span>
01015         <span class="comment">//</span>
01016 
01017         Recorded = <a class="code" href="../../d3/d8/udfprocs_8h.html#a146">UdfLookupAllocation</a>( IrpContext,
01018                                         Fcb,
01019                                         CurrentFileOffset,
01020                                         &amp;DiskOffset,
01021                                         &amp;CurrentByteCount );
01022 
01023         <span class="comment">//</span>
01024         <span class="comment">//  Limit ourselves to the data requested.</span>
01025         <span class="comment">//</span>
01026 
01027         <span class="keywordflow">if</span> (CurrentByteCount &gt; RemainingByteCount) {
01028 
01029             CurrentByteCount = RemainingByteCount;
01030         }
01031 
01032         <span class="comment">//</span>
01033         <span class="comment">//  Handle the case of unrecorded data first.</span>
01034         <span class="comment">//</span>
01035 
01036         <span class="keywordflow">if</span> (!Recorded) {
01037 
01038             <span class="comment">//</span>
01039             <span class="comment">//  Note that we did not consume an entry.</span>
01040             <span class="comment">//</span>
01041 
01042             *RunCount -= 1;
01043 
01044             <span class="comment">//</span>
01045             <span class="comment">//  Immediately zero the user buffer and indicate that we found sparse</span>
01046             <span class="comment">//  runs to the caller.</span>
01047             <span class="comment">//</span>
01048 
01049             RtlZeroMemory( CurrentUserBuffer, CurrentByteCount );
01050             *SparseRuns = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01051 
01052             <span class="comment">//</span>
01053             <span class="comment">//  Push the scratch buffer pointers forward so that we don't stomp</span>
01054             <span class="comment">//  on the zeroed buffer.</span>
01055             <span class="comment">//</span>
01056 
01057             ScratchUserBuffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( CurrentUserBuffer,
01058                                          CurrentByteCount,
01059                                          PVOID );
01060 
01061             ScratchUserBufferOffset += CurrentByteCount;
01062 
01063         <span class="comment">//</span>
01064         <span class="comment">//  Handle the case where this is an unaligned transfer.  The</span>
01065         <span class="comment">//  following must all be true for this to be an aligned transfer.</span>
01066         <span class="comment">//</span>
01067         <span class="comment">//      Disk offset on a 2048 byte boundary (Start of transfer)</span>
01068         <span class="comment">//</span>
01069         <span class="comment">//      Byte count is a multiple of 2048 (Length of transfer)</span>
01070         <span class="comment">//</span>
01071         <span class="comment">//      Current buffer offset is also on a 2048 byte boundary.</span>
01072         <span class="comment">//</span>
01073         <span class="comment">//  If the ByteCount is at least one sector then do the</span>
01074         <span class="comment">//  unaligned transfer only for the tail.  We can use the</span>
01075         <span class="comment">//  user's buffer for the aligned portion.</span>
01076         <span class="comment">//</span>
01077 
01078         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb, DiskOffset ) ||
01079                    <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb, CurrentUserBufferOffset ) ||
01080                    (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb, CurrentByteCount ) &amp;&amp;
01081                     CurrentByteCount &lt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>( Vcb ))) {
01082 
01083             <span class="comment">//</span>
01084             <span class="comment">//  If we can't wait then raise.</span>
01085             <span class="comment">//</span>
01086 
01087             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
01088 
01089                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
01090             }
01091 
01092             <span class="comment">//</span>
01093             <span class="comment">//  Remember the offset and the number of bytes out of</span>
01094             <span class="comment">//  the transfer buffer to copy into the user's buffer.</span>
01095             <span class="comment">//  We will truncate the current read to end on a sector</span>
01096             <span class="comment">//  boundary.</span>
01097             <span class="comment">//</span>
01098 
01099             ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o5">TransferBufferOffset</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb, DiskOffset );
01100 
01101             <span class="comment">//</span>
01102             <span class="comment">//  Make sure this transfer ends on a sector boundary.</span>
01103             <span class="comment">//</span>
01104 
01105             ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o0">DiskOffset</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a36">LlSectorTruncate</a>( Vcb, DiskOffset );
01106 
01107             <span class="comment">//</span>
01108             <span class="comment">//  Check if we can use a free portion of the user's buffer.</span>
01109             <span class="comment">//  If we can copy the bytes to an earlier portion of the</span>
01110             <span class="comment">//  buffer then read into that location and slide the bytes</span>
01111             <span class="comment">//  up.</span>
01112             <span class="comment">//</span>
01113             <span class="comment">//  We can use the user's buffer if:</span>
01114             <span class="comment">//</span>
01115             <span class="comment">//      The temporary location in the buffer is before the</span>
01116             <span class="comment">//      final destination.</span>
01117             <span class="comment">//</span>
01118             <span class="comment">//      There is at least one sector of data to read.</span>
01119             <span class="comment">//</span>
01120 
01121             <span class="keywordflow">if</span> ((ScratchUserBufferOffset + ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o5">TransferBufferOffset</a> &lt; CurrentUserBufferOffset) &amp;&amp;
01122                 (ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o5">TransferBufferOffset</a> + CurrentByteCount &gt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>( Vcb ))) {
01123 
01124                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a35">SectorTruncate</a>( Vcb, ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o5">TransferBufferOffset</a> + CurrentByteCount );
01125                 CurrentByteCount = ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a> - ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o5">TransferBufferOffset</a>;
01126                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o4">TransferByteCount</a> = CurrentByteCount;
01127 
01128                 <span class="comment">//</span>
01129                 <span class="comment">//  Point to the user's buffer and Mdl for this transfer.</span>
01130                 <span class="comment">//</span>
01131 
01132                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o3">TransferBuffer</a> = ScratchUserBuffer;
01133                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o6">TransferMdl</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>;
01134                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o7">TransferVirtualAddress</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a>,
01135                                                              ScratchUserBufferOffset,
01136                                                              PVOID );
01137 
01138                 ScratchUserBuffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ScratchUserBuffer,
01139                                              ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a>,
01140                                              PVOID );
01141 
01142                 ScratchUserBufferOffset += ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a>;
01143 
01144             <span class="comment">//</span>
01145             <span class="comment">//  Otherwise we need to allocate an auxilary buffer for the next sector.</span>
01146             <span class="comment">//</span>
01147 
01148             } <span class="keywordflow">else</span> {
01149 
01150                 <span class="comment">//</span>
01151                 <span class="comment">//  Read up to a page containing the partial data</span>
01152                 <span class="comment">//</span>
01153 
01154                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a> = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a12">SectorAlign</a>( Vcb, ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o5">TransferBufferOffset</a> + CurrentByteCount );
01155 
01156                 <span class="keywordflow">if</span> (ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a> &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
01157 
01158                     ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01159                 }
01160 
01161                 <span class="keywordflow">if</span> (ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o5">TransferBufferOffset</a> + CurrentByteCount &gt; ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a>) {
01162 
01163                     CurrentByteCount = ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a> - ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o5">TransferBufferOffset</a>;
01164                 }
01165 
01166                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o4">TransferByteCount</a> = CurrentByteCount;
01167 
01168                 <span class="comment">//</span>
01169                 <span class="comment">//  Allocate a buffer for the non-aligned transfer.</span>
01170                 <span class="comment">//</span>
01171 
01172                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o3">TransferBuffer</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfNonPagedPool,
01173                                                                       PAGE_SIZE,
01174                                                                       TAG_IO_BUFFER );
01175 
01176                 <span class="comment">//</span>
01177                 <span class="comment">//  Allocate and build the Mdl to describe this buffer.</span>
01178                 <span class="comment">//</span>
01179 
01180                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o6">TransferMdl</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o3">TransferBuffer</a>,
01181                                                         PAGE_SIZE,
01182                                                         FALSE,
01183                                                         FALSE,
01184                                                         NULL );
01185 
01186                 ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o7">TransferVirtualAddress</a> = ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o3">TransferBuffer</a>;
01187 
01188                 <span class="keywordflow">if</span> (ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o6">TransferMdl</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01189 
01190                     IrpContext-&gt;Irp-&gt;IoStatus.Information = 0;
01191                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
01192                 }
01193 
01194                 <a class="code" href="../../d5/d6/iosup_8c.html#a46">MmBuildMdlForNonPagedPool</a>( ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o6">TransferMdl</a> );
01195             }
01196 
01197             <span class="comment">//</span>
01198             <span class="comment">//  Remember we found an unaligned transfer.</span>
01199             <span class="comment">//</span>
01200 
01201             FoundUnaligned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01202 
01203         <span class="comment">//</span>
01204         <span class="comment">//  Otherwise we use the buffer and Mdl from the original request.</span>
01205         <span class="comment">//</span>
01206 
01207         } <span class="keywordflow">else</span> {
01208 
01209             <span class="comment">//</span>
01210             <span class="comment">//  Truncate the read length to a sector-aligned value.  We know</span>
01211             <span class="comment">//  the length must be at least one sector or we wouldn't be</span>
01212             <span class="comment">//  here now.</span>
01213             <span class="comment">//</span>
01214 
01215             CurrentByteCount = <a class="code" href="../../d3/d8/udfprocs_8h.html#a35">SectorTruncate</a>( Vcb, CurrentByteCount );
01216 
01217             <span class="comment">//</span>
01218             <span class="comment">//  Read these sectors from the disk.</span>
01219             <span class="comment">//</span>
01220 
01221             ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o0">DiskOffset</a> = DiskOffset;
01222             ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o1">DiskByteCount</a> = CurrentByteCount;
01223 
01224             <span class="comment">//</span>
01225             <span class="comment">//  Use the user's buffer and Mdl as our transfer buffer</span>
01226             <span class="comment">//  and Mdl.</span>
01227             <span class="comment">//</span>
01228 
01229             ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o3">TransferBuffer</a> = CurrentUserBuffer;
01230             ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o6">TransferMdl</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>;
01231             ThisIoRun-&gt;<a class="code" href="../../d0/d5/struct__IO__RUN.html#o7">TransferVirtualAddress</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a>,
01232                                                          CurrentUserBufferOffset,
01233                                                          PVOID );
01234 
01235             ScratchUserBuffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( CurrentUserBuffer,
01236                                          CurrentByteCount,
01237                                          PVOID );
01238 
01239             ScratchUserBufferOffset += CurrentByteCount;
01240         }
01241 
01242         <span class="comment">//</span>
01243         <span class="comment">//  Update our position in the transfer and the RunCount and</span>
01244         <span class="comment">//  ByteCount for the user.</span>
01245         <span class="comment">//</span>
01246 
01247         RemainingByteCount -= CurrentByteCount;
01248 
01249         <span class="comment">//</span>
01250         <span class="comment">//  Break out if no more positions in the IoRuns array or</span>
01251         <span class="comment">//  we have all of the bytes accounted for.</span>
01252         <span class="comment">//</span>
01253 
01254         *ThisByteCount += CurrentByteCount;
01255 
01256         <span class="keywordflow">if</span> ((RemainingByteCount == 0) || (*RunCount == <a class="code" href="../../d3/d7/deviosup_8c.html#a2">MAX_PARALLEL_IOS</a>)) {
01257 
01258             <span class="keywordflow">break</span>;
01259         }
01260 
01261         <span class="comment">//</span>
01262         <span class="comment">//  Update our pointers for the user's buffer.</span>
01263         <span class="comment">//</span>
01264 
01265         ThisIoRun = IoRuns + *RunCount;
01266         CurrentUserBuffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( CurrentUserBuffer, CurrentByteCount, PVOID );
01267         CurrentUserBufferOffset += CurrentByteCount;
01268         CurrentFileOffset += CurrentByteCount;
01269     }
01270 
01271     <span class="keywordflow">return</span> FoundUnaligned;
01272 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="deviosup.c::UdfPrepareBuffers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfPrepareBuffers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>UserBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UserBufferOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/struct__IO__RUN.html">PIO_RUN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IoRuns</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RunCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThisByteCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SparseRuns</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="deviosup.c::UdfReadSectors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfReadSectors           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnError</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetDeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">685</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00231">BytesFromSectors</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01933">IoBuildSynchronousFsdRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00224">LlSectorsFromBytes</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01874">SL_OVERRIDE_VERIFY_VOLUME</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00181">UdfMethod2TransformByteOffset</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00686">VCB_STATE_METHOD_2_FIXUP</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00696                    :
00697 
00698     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to transfer sectors from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk to a
00699     specified buffer.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> mount and volume verify operations.
00700 
00701     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> synchronous, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will not <span class="keywordflow">return</span> until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00702     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete or until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation fails.
00703 
00704     The routine allocates an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> and then passes <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> to a lower
00705     level driver.  Errors may occur in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation of <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> or
00706     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lower driver.
00707 
00708 Arguments:
00709 
00710     StartingOffset - Logical offset on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk to start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read.  This
00711         must be on a sector boundary, no check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> here.
00712 
00713     ByteCount - Number of bytes to read.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an integral number of
00714         sectors, or otherwise a value we know <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver can handle,
00715         no check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> here to confirm <span class="keyword">this</span>.
00716 
00717     ReturnError - Indicates whether we should <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00718         to indicate an error or raise an error condition.  This <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> applies
00719         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO.  Any other error may cause a raise.
00720 
00721     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to transfer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk data into.
00722 
00723     TargetDeviceObject - The device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to be read.
00724 
00725 Return Value:
00726 
00727     The <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00728 
00729 --*/
00730 
00731 {
00732     PLONGLONG UseStartingOffset;
00733     LONGLONG LocalStartingOffset;
00734     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00735     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>  <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00736     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00737 
00738     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00739 
00740     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00741                  <span class="stringliteral">"UdfReadSectors, %x%08x +%x -&gt; %08x from DO %08x\n"</span>,
00742                  ((PLARGE_INTEGER)&amp;StartingOffset)-&gt;HighPart,
00743                  ((PLARGE_INTEGER)&amp;StartingOffset)-&gt;LowPart,
00744                  ByteCount,
00745                  Buffer,
00746                  TargetDeviceObject ));
00747     
00748     <span class="comment">//</span>
00749     <span class="comment">//  For the time being, we assume that we only read sector-at-a-time.</span>
00750     <span class="comment">//  This simplifies sparing, and is the only way I am aware of this</span>
00751     <span class="comment">//  code would not be ready for blocksize != sectorsize.  It just is</span>
00752     <span class="comment">//  not worth writing dead (but straightforward) code right now.</span>
00753     <span class="comment">//</span>
00754 
00755     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IrpContext-&gt;Vcb == NULL || ByteCount == <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>( IrpContext-&gt;Vcb ));
00756 
00757     <span class="comment">//</span>
00758     <span class="comment">//  If the volume is spared (and at a point where sparing is possible),</span>
00759     <span class="comment">//  check if a mapping needs to be performed.</span>
00760     <span class="comment">//</span>
00761     
00762     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb &amp;&amp;
00763         IrpContext-&gt;Vcb-&gt;Pcb &amp;&amp;
00764         IrpContext-&gt;Vcb-&gt;Pcb-&gt;SparingMcb) {
00765         
00766         LONGLONG SparingPsn;
00767     
00768         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( IrpContext-&gt;Vcb-&gt;Pcb-&gt;SparingMcb,
00769                                       <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( IrpContext-&gt;Vcb, StartingOffset ),
00770                                       &amp;SparingPsn,
00771                                       NULL,
00772                                       NULL,
00773                                       NULL,
00774                                       NULL ) &amp;&amp;
00775             SparingPsn != -1) {
00776 
00777             StartingOffset = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a14">BytesFromSectors</a>( IrpContext-&gt;Vcb, (ULONG) SparingPsn );
00778         }
00779     }
00780     
00781     <span class="comment">//</span>
00782     <span class="comment">//  Initialize the event.</span>
00783     <span class="comment">//</span>
00784 
00785     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">//  Correct the starting offset by the method 2 fixup if neccesary.  This also</span>
00789     <span class="comment">//  assumes sector-at-a-time and sector == block so we don't need to fragment</span>
00790     <span class="comment">//  the request or check if it spans a packet boundary.</span>
00791     <span class="comment">//</span>
00792     <span class="comment">//  We assume that no fixups are required until a Vcb exists.  This is true</span>
00793     <span class="comment">//  since volume recognition may proceed in the first packet.</span>
00794     <span class="comment">//</span>
00795 
00796     UseStartingOffset = &amp;StartingOffset;
00797 
00798     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb &amp;&amp;
00799         <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Vcb-&gt;VcbState, VCB_STATE_METHOD_2_FIXUP )) {
00800 
00801         LocalStartingOffset = <a class="code" href="../../d9/d7/udf_8h.html#a8">UdfMethod2TransformByteOffset</a>( IrpContext-&gt;Vcb, StartingOffset );
00802         UseStartingOffset = &amp;LocalStartingOffset;
00803 
00804         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00805                      <span class="stringliteral">"UdfReadSectors, Method2 Fixup to %x%08x\n"</span>,
00806                      ((PLARGE_INTEGER)UseStartingOffset)-&gt;HighPart,
00807                      ((PLARGE_INTEGER)UseStartingOffset)-&gt;LowPart ));
00808     }
00809 
00810     <span class="comment">//</span>
00811     <span class="comment">//  Attempt to allocate the IRP.  If unsuccessful, raise</span>
00812     <span class="comment">//  STATUS_INSUFFICIENT_RESOURCES.</span>
00813     <span class="comment">//</span>
00814 
00815     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( IRP_MJ_READ,
00816                                         TargetDeviceObject,
00817                                         Buffer,
00818                                         ByteCount,
00819                                         (PLARGE_INTEGER) UseStartingOffset,
00820                                         &amp;Event,
00821                                         &amp;IrpContext-&gt;Irp-&gt;IoStatus );
00822 
00823     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00824 
00825         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
00826     }
00827 
00828     <span class="comment">//</span>
00829     <span class="comment">//  Ignore the change line (verify) for mount and verify requests</span>
00830     <span class="comment">//</span>
00831 
00832     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp )-&gt;Flags, SL_OVERRIDE_VERIFY_VOLUME );
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">//  Send the request down to the driver.  If an error occurs return</span>
00836     <span class="comment">//  it to the caller.</span>
00837     <span class="comment">//</span>
00838 
00839     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( TargetDeviceObject, Irp );
00840 
00841     <span class="comment">//</span>
00842     <span class="comment">//  If the status was STATUS_PENDING then wait on the event.</span>
00843     <span class="comment">//</span>
00844 
00845     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00846 
00847         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00848                                         Executive,
00849                                         KernelMode,
00850                                         FALSE,
00851                                         NULL );
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  On a successful wait pull the status out of the IoStatus block.</span>
00855         <span class="comment">//</span>
00856 
00857         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00858 
00859             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IrpContext-&gt;Irp-&gt;IoStatus.Status;
00860         }
00861     }
00862 
00863     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfReadSectors -&gt; %08x\n"</span>, Status ));
00864     
00865     <span class="comment">//</span>
00866     <span class="comment">//  Check whether we should raise in the error case.</span>
00867     <span class="comment">//</span>
00868 
00869     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; !ReturnError) {
00870 
00871         <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, Status );
00872     }
00873 
00874     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00875 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="deviosup.c::UdfSingleAsync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfSingleAsync           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01642">1642</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01835">PIO_COMPLETION_ROUTINE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l02039">UdfSingleAsyncCompletionRoutine()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01980">UdfSingleSyncCompletionRoutine()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>.
<p>
<pre class="fragment"><div>01650                    :
01651 
01652     This routine reads one or more contiguous sectors from a device
01653     asynchronously, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> one read necessary to
01654     complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  It implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read by simply filling
01655     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next stack frame in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, and passing <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> on.  The transfer
01656     occurs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> single buffer originally specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user request.
01657 
01658 Arguments:
01659 
01660     ByteOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Logical Byte <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> to begin reading from
01661 
01662     ByteCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to read from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
01663 
01664 Return Value:
01665 
01666     None.
01667 
01668 --*/
01669 
01670 {
01671     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01672     <a class="code" href="../../d0/d5/io_8h.html#a357">PIO_COMPLETION_ROUTINE</a> CompletionRoutine;
01673 
01674     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01675 
01676     <span class="comment">//</span>
01677     <span class="comment">//  Set up things according to whether this is truely async.</span>
01678     <span class="comment">//</span>
01679 
01680     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
01681 
01682         CompletionRoutine = <a class="code" href="../../d3/d7/deviosup_8c.html#a12">UdfSingleSyncCompletionRoutine</a>;
01683 
01684     } <span class="keywordflow">else</span> {
01685 
01686         CompletionRoutine = <a class="code" href="../../d3/d7/deviosup_8c.html#a13">UdfSingleAsyncCompletionRoutine</a>;
01687     }
01688 
01689     <span class="comment">//</span>
01690     <span class="comment">// Set up the completion routine address in our stack frame.</span>
01691     <span class="comment">//</span>
01692 
01693     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( IrpContext-&gt;Irp,
01694                             CompletionRoutine,
01695                             IrpContext-&gt;IoContext,
01696                             TRUE,
01697                             TRUE,
01698                             TRUE );
01699 
01700     <span class="comment">//</span>
01701     <span class="comment">//  Setup the next IRP stack location in the associated Irp for the disk</span>
01702     <span class="comment">//  driver beneath us.</span>
01703     <span class="comment">//</span>
01704 
01705     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( IrpContext-&gt;Irp );
01706 
01707     <span class="comment">//</span>
01708     <span class="comment">//  Setup the Stack location to do a read from the disk driver.</span>
01709     <span class="comment">//</span>
01710 
01711     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a>;
01712     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length = ByteCount;
01713     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.ByteOffset.QuadPart = ByteOffset;
01714 
01715     <span class="comment">//</span>
01716     <span class="comment">//  Issue the Io request</span>
01717     <span class="comment">//</span>
01718 
01719     <span class="comment">//</span>
01720     <span class="comment">//  If IoCallDriver returns an error, it has completed the Irp</span>
01721     <span class="comment">//  and the error will be caught by our completion routines</span>
01722     <span class="comment">//  and dealt with as a normal IO error.</span>
01723     <span class="comment">//</span>
01724 
01725     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, IrpContext-&gt;Irp );
01726 
01727     <span class="comment">//</span>
01728     <span class="comment">//  And return to our caller</span>
01729     <span class="comment">//</span>
01730 
01731     <span class="keywordflow">return</span>;
01732 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="deviosup.c::UdfSingleAsyncCompletionRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfSingleAsyncCompletionRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l02039">2039</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02476">ExReleaseResourceForThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01706">UdfFreeIoContext</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01642">UdfSingleAsync()</a>.
<p>
<pre class="fragment"><div>02047                    :
02048 
02049     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine <span class="keywordflow">for</span> all asynchronous reads
02050     started via UdfSingleAsynch.
02051 
02052 Arguments:
02053 
02054     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object.
02055 
02056     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <span class="keywordflow">for</span> <span class="keyword">this</span> request.  (This <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> will no longer
02057         be accessible after <span class="keyword">this</span> routine returns.)
02058 
02059     Context - The context parameter which was specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to
02060         UdfSingleAsynch.
02061 
02062 Return Value:
02063 
02064     Currently always returns STATUS_SUCCESS.
02065 
02066 --*/
02067 
02068 {
02069     <span class="comment">//</span>
02070     <span class="comment">//  Update the information field with the correct value for bytes read.</span>
02071     <span class="comment">//</span>
02072 
02073     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
02074 
02075     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
02076 
02077         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = ((<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">PUDF_IO_CONTEXT</a>) Context)-&gt;RequestedByteCount;
02078     }
02079 
02080     <span class="comment">//</span>
02081     <span class="comment">//  Mark the Irp pending</span>
02082     <span class="comment">//</span>
02083 
02084     <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
02085 
02086     <span class="comment">//</span>
02087     <span class="comment">//  Now release the resource</span>
02088     <span class="comment">//</span>
02089 
02090     <a class="code" href="../../d5/d8/ex_8h.html#a71">ExReleaseResourceForThread</a>( ((<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">PUDF_IO_CONTEXT</a>) Context)-&gt;Resource,
02091                                 ((<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">PUDF_IO_CONTEXT</a>) Context)-&gt;ResourceThreadId );
02092 
02093     <span class="comment">//</span>
02094     <span class="comment">//  and finally, free the context record.</span>
02095     <span class="comment">//</span>
02096 
02097     <a class="code" href="../../d3/d8/udfprocs_8h.html#a95">UdfFreeIoContext</a>( (<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">PUDF_IO_CONTEXT</a>) Context );
02098     <span class="keywordflow">return</span> STATUS_SUCCESS;
02099 
02100     UNREFERENCED_PARAMETER( DeviceObject );
02101 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="deviosup.c::UdfSingleSyncCompletionRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfSingleSyncCompletionRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01980">1980</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, and <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01642">UdfSingleAsync()</a>.
<p>
<pre class="fragment"><div>01988                    :
01989 
01990     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine <span class="keywordflow">for</span> all reads started via <a class="code" href="../../d3/d7/deviosup_8c.html#a8">UdfSingleAsync</a>.
01991 
01992     The completion routine has has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following responsibilities:
01993 
01994         It sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context parameter to signal <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01995         that all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> asynch requests are done.
01996 
01997 Arguments:
01998 
01999     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object.
02000 
02001     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <span class="keywordflow">for</span> <span class="keyword">this</span> request.  (This <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> will no longer
02002         be accessible after <span class="keyword">this</span> routine returns.)
02003 
02004     Context - The context parameter which was specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to
02005         UdfSingleAsynch.
02006 
02007 Return Value:
02008 
02009     The routine returns STATUS_MORE_PROCESSING_REQUIRED so that we can
02010     immediately complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Master <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> without being in a race condition
02011     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a> thread trying to decrement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpCount in
02012     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Master <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02013 
02014 --*/
02015 
02016 {
02017     <span class="comment">//</span>
02018     <span class="comment">//  Store the correct information field into the Irp.</span>
02019     <span class="comment">//</span>
02020 
02021     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
02022 
02023         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
02024     }
02025 
02026     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;((<a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">PUDF_IO_CONTEXT</a>)Context)-&gt;SyncEvent, 0, FALSE );
02027 
02028     <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
02029 
02030     UNREFERENCED_PARAMETER( DeviceObject );
02031 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="deviosup.c::UdfWaitSync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfWaitSync           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IrpContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01740">1740</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>.
<p>
<pre class="fragment"><div>01746                    :
01747 
01748     This routine waits <span class="keywordflow">for</span> one or more previously started I/O requests
01749     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>, by simply waiting on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event.
01750 
01751 Arguments:
01752 
01753 Return Value:
01754 
01755     None
01756 
01757 --*/
01758 
01759 {
01760     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01761 
01762     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IrpContext-&gt;IoContext-&gt;SyncEvent,
01763                            Executive,
01764                            KernelMode,
01765                            FALSE,
01766                            NULL );
01767 
01768     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;IrpContext-&gt;IoContext-&gt;SyncEvent );
01769 
01770     <span class="keywordflow">return</span>;
01771 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
