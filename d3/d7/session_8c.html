<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: session.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>session.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d4/d6/session_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a0">MM_MAXIMUM_CONCURRENT_SESSIONS</a>&nbsp;&nbsp;&nbsp;16384</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a1">MI_SESSION_COMMIT_CHARGE</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a5">MiSessionAddProcess</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a6">MiSessionRemoveProcess</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a7">MiInitializeSessionIds</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a8">MiSessionCreateInternal</a> (OUT PULONG SessionId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a9">MiSessionCommitPageTables</a> (IN PVOID StartVa, IN PVOID EndVa)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a11">MiSessionDeletePde</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde, IN BOOLEAN WorkingSetInitialized, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> SelfMapPde)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a12">MmSessionLeader</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a13">MmSessionSetUnloadAddress</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> pWin32KDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a14">MmSessionCreate</a> (OUT PULONG SessionId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a15">MmSessionDelete</a> (ULONG SessionId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a> (IN <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a18">MiSessionCommitImagePages</a> (IN PVOID VirtualAddress, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a19">MiSessionOutSwapProcess</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a20">MiSessionInSwapProcess</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a2">MiSessionCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_BITMAP&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="session.c::MI_SESSION_COMMIT_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MI_SESSION_COMMIT_CHARGE&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00035">35</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="session.c::MM_MAXIMUM_CONCURRENT_SESSIONS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_MAXIMUM_CONCURRENT_SESSIONS&nbsp;&nbsp;&nbsp;16384          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00026">26</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l00350">MiInitializeSessionIds()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="session.c::MiAttachSession" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiAttachSession           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionGlobal</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l01181">1181</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00413">KeAttachSessionSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05280">MI_SESSION_SPACE_END</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05248">MI_SESSION_SPACE_PAGE_TABLES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02788">MiEmptyAllWorkingSetsWorker()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>01187                    :
01188 
01189     Attaches to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified session space.
01190 
01191 Arguments:
01192 
01193     SessionGlobal - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session to attach to.
01194 
01195 Return Value:
01196 
01197     None.
01198 
01199 Environment:
01200 
01201     Kernel mode.  No locks held.  Current process must not have a session
01202     space - ie: <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller should be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system process or smss.exe.
01203 
01204 --*/
01205 
01206 {
01207     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01208 <span class="preprocessor">#if DBG</span>
01209 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01210 
01211     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
01212 
01213     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0);
01214 
01215 <span class="preprocessor">#if defined (_WIN64)</span>
01216 <span class="preprocessor"></span>
01217     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (MmSessionBase);
01218     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01219 
01220 <span class="preprocessor">#else</span>
01221 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase);
01222     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MI_SESSION_SPACE_END);
01223 
01224     <span class="keywordflow">while</span> (PointerPde &lt; EndPde) {
01225         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01226         PointerPde += 1;
01227     }
01228 <span class="preprocessor">#endif</span>
01229 <span class="preprocessor"></span>
01230 <span class="preprocessor">#endif</span>
01231 <span class="preprocessor"></span>
01232 <span class="preprocessor">#if defined (_WIN64)</span>
01233 <span class="preprocessor"></span>
01234     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (MmSessionBase);
01235     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, SessionGlobal-&gt;PageDirectory);
01236 
01237 <span class="preprocessor">#else</span>
01238 <span class="preprocessor"></span>
01239     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase);
01240 
01241     RtlCopyMemory (PointerPde,
01242                    &amp;SessionGlobal-&gt;PageTables[0],
01243                    MI_SESSION_SPACE_PAGE_TABLES * sizeof (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01244 <span class="preprocessor">#endif</span>
01245 <span class="preprocessor"></span>
01246 <span class="preprocessor">#if defined(_IA64_)</span>
01247 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a7">KeAttachSessionSpace</a>(&amp;SessionGlobal-&gt;SessionMapInfo);
01248 <span class="preprocessor">#endif</span>
01249 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="session.c::MiDereferenceSession" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MiDereferenceSession           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l01544">1544</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05546">_MM_SESSION_SPACE::AttachCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05548">_MM_SESSION_SPACE::AttachEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01413">_DRIVER_OBJECT::DriverUnload</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05538">_MM_SESSION_SPACE::GlobalPteEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01611">_MMWSL::HighestPermittedHashAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00543">KeDetachSessionSpace()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00364">KeDisableSessionSharing()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05632">LOCK_SESSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05617">MI_FLUSH_SESSION_TB</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02841">MI_FLUSH_SINGLE_SESSION_TB</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05221">MI_SESSION_IMAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05272">MI_SESSION_IMAGE_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05280">MI_SESSION_SPACE_END</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05248">MI_SESSION_SPACE_PAGE_TABLES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05642">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05274">MI_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05223">MI_SESSION_VIEW_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05276">MI_SESSION_VIEW_START</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04116">MiCheckSessionPoolAllocations()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04478">MiFreeSessionPoolBitMaps()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l04071">MiFreeSessionSpaceMap()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05733">MiGetPdeSessionIndex</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05611">MiSessionCount</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01408">MiSessionDeletePde()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00030">MiSessionIdBitmap</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00028">MiSessionIdMutex</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00572">MiSessionUnloadAllImages()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04296">MM_DBG_COMMIT_RETURN_SESSION_DEREFERENCE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05315">MM_DBG_SESSION_INITIAL_PAGE_FREE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05316">MM_DBG_SESSION_PAGETABLE_FREE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05307">MM_DBG_SESSION_WS_PAGE_FREE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05362">MM_SNAP_SESS_MEMORY_COUNTERS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05491">_MM_SESSION_SPACE::PageTables</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05524">_MM_SESSION_SPACE::ProcessOutSwapCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05411">_MM_SESSION_SPACE::ReferenceCount</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05300">SESSION_GLOBAL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05427">_MM_SESSION_SPACE::SessionPageDirectoryIndex</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">_MM_SESSION_SPACE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00965">UNLOCK_EXPANSION_AND_THEN_WAIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05635">UNLOCK_SESSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05584">_MM_SESSION_SPACE::Win32KDriverObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05566">_MM_SESSION_SPACE::WsListEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05559">_MM_SESSION_SPACE::WsLock</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l00259">MiSessionRemoveProcess()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00974">MmSessionCreate()</a>, and <a class="el" href="../../d4/d6/session_8c-source.html#l01093">MmSessionDelete()</a>.
<p>
<pre class="fragment"><div>01550                    :
01551 
01552     Decrement <span class="keyword">this</span> process' reference count to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session, unmapping access
01553     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last process
01554     reference to <span class="keyword">this</span> session, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire session will be destroyed upon
01555     <span class="keywordflow">return</span>.  This includes unloading drivers, unmapping pools, freeing
01556     page tables, etc.
01557 
01558 Arguments:
01559 
01560     None.
01561 
01562 Return Value:
01563 
01564     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session was deleted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keyword">this</span> process' access to
01565     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session was deleted.
01566 
01567 Environment:
01568 
01569     Kernel mode, no mutexes held, APCs disabled.
01570 
01571 --*/
01572 
01573 {
01574     KIRQL OldIrql;
01575     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01576     ULONG CountReleased;
01577     ULONG SessionId;
01578     PFN_NUMBER PageFrameIndex;
01579     ULONG SessionDataPdeIndex;
01580     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01581     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
01582     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01583     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01584     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01585     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
01586     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> GlobalPteEntrySave;
01587     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
01588     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01589     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
01590     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> SavePageTables[<a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>];
01591     BOOLEAN WorkingSetWasInitialized;
01592     ULONG AttachCount;
01593     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01594 
01595     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 1) ||
01596             ((<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.Initialized == 0) &amp;&amp; (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.SessionLeader == 1) &amp;&amp; (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1)));
01597 
01598     SessionId = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>;
01599 
01600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (MiSessionIdBitmap, SessionId));
01601 
01602     <a class="code" href="../../d4/d8/mi_8h.html#a400">LOCK_SESSION</a> (OldIrql);
01603 
01604     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> &gt; 1) {
01605 
01606         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> -= 1;
01607 
01608         <a class="code" href="../../d4/d8/mi_8h.html#a401">UNLOCK_SESSION</a> (OldIrql);
01609 
01610         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01611 
01612         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01613 
01614         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession = 0;
01615 
01616         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01617 
01618         <span class="comment">//</span>
01619         <span class="comment">// Don't delete any non-smss session space mappings here.  Let them</span>
01620         <span class="comment">// live on through process death.  This handles the case where</span>
01621         <span class="comment">// MmDispatchWin32Callout picks csrss - csrss has exited as it's not</span>
01622         <span class="comment">// the last process (smss is).  smss is simultaneously detaching from</span>
01623         <span class="comment">// the session and since it is the last process, it's waiting on</span>
01624         <span class="comment">// the AttachCount below.  The dispatch callout ends up in csrss but</span>
01625         <span class="comment">// has no way to synchronize against csrss exiting through this path</span>
01626         <span class="comment">// as the object reference count doesn't stop it.  So leave the</span>
01627         <span class="comment">// session space mappings alive so the callout can execute through</span>
01628         <span class="comment">// the remains of csrss.</span>
01629         <span class="comment">//</span>
01630         <span class="comment">// Note that when smss detaches, the address space must get cleared</span>
01631         <span class="comment">// here so that subsequent session creations by smss will succeed.</span>
01632         <span class="comment">//</span>
01633 
01634         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 1) {
01635 
01636 <span class="preprocessor">#if defined (_WIN64)</span>
01637 <span class="preprocessor"></span>            StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (MmSessionBase);
01638             StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01639 <span class="preprocessor">#else</span>
01640 <span class="preprocessor"></span>            StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase);
01641             EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MI_SESSION_SPACE_END);
01642             RtlZeroMemory (StartPde, (EndPde - StartPde) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01643 <span class="preprocessor">#endif</span>
01644 <span class="preprocessor"></span>
01645             <span class="comment">//</span>
01646             <span class="comment">// Flush the session space TB entries.</span>
01647             <span class="comment">//</span>
01648     
01649             <a class="code" href="../../d4/d8/mi_8h.html#a397">MI_FLUSH_SESSION_TB</a> (OldIrql);
01650         }
01651 
01652 <span class="preprocessor">#if defined(_IA64_)</span>
01653 <span class="preprocessor"></span>        <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a9">KeDetachSessionSpace</a>();
01654 <span class="preprocessor">#endif</span>
01655 <span class="preprocessor"></span>
01656         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01657     }
01658 
01659     <span class="comment">//</span>
01660     <span class="comment">// Mark it as being deleted.</span>
01661     <span class="comment">//</span>
01662 
01663     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.BeingDeleted = 1;
01664 
01665     <span class="comment">//</span>
01666     <span class="comment">// This is the final dereference.  We could be any process</span>
01667     <span class="comment">// including SMSS when a session space load fails.  Note also that</span>
01668     <span class="comment">// processes can terminate in any order as well.</span>
01669     <span class="comment">//</span>
01670 
01671     <a class="code" href="../../d4/d8/mi_8h.html#a401">UNLOCK_SESSION</a> (OldIrql);
01672 
01673     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a> (MmSessionSpace);
01674 
01675     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01676 
01677     <span class="comment">//</span>
01678     <span class="comment">// Wait for any cross-session process attaches to detach.  Refuse</span>
01679     <span class="comment">// subsequent attempts to cross-session attach so the address invalidation</span>
01680     <span class="comment">// code doesn't surprise an ongoing or subsequent attachee.</span>
01681     <span class="comment">//</span>
01682 
01683     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.DeletePending == 0);
01684 
01685     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.DeletePending = 1;
01686 
01687     AttachCount = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o27">AttachCount</a>;
01688 
01689     <span class="keywordflow">if</span> (AttachCount) {
01690 
01691         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o28">AttachEvent</a>,
01692                            NotificationEvent,
01693                            FALSE);
01694 
01695         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01696 
01697         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o28">AttachEvent</a>,
01698                                WrVirtualMemory,
01699                                KernelMode,
01700                                FALSE,
01701                                (PLARGE_INTEGER)NULL);
01702 
01703         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01704 
01705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.DeletePending == 1);
01706         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o27">AttachCount</a> == 0);
01707     }
01708 
01709     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed) {
01710 
01711         <span class="comment">//</span>
01712         <span class="comment">// Initialize an event and put the event address</span>
01713         <span class="comment">// in the VmSupport.  When the trimming is complete,</span>
01714         <span class="comment">// this event will be set.</span>
01715         <span class="comment">//</span>
01716 
01717         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;Event, NotificationEvent, FALSE);
01718 
01719         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink = (PLIST_ENTRY)&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01720 
01721         <span class="comment">//</span>
01722         <span class="comment">// Release the mutex and wait for the event.</span>
01723         <span class="comment">//</span>
01724 
01725         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01726         <a class="code" href="../../d4/d8/mi_8h.html#a141">UNLOCK_EXPANSION_AND_THEN_WAIT</a> (OldIrql);
01727 
01728         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;Event,
01729                               WrVirtualMemory,
01730                               KernelMode,
01731                               FALSE,
01732                               (PLARGE_INTEGER)NULL);
01733         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01734 
01735         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01736     }
01737     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.WorkingSetInserted == 1) {
01738 
01739         <span class="comment">//</span>
01740         <span class="comment">// Remove this session from the session list and the working</span>
01741         <span class="comment">// set list.</span>
01742         <span class="comment">//</span>
01743 
01744         RemoveEntryList (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
01745 
01746         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.WorkingSetInserted = 0;
01747     }
01748 
01749     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.SessionListInserted == 1) {
01750 
01751         RemoveEntryList (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o33">WsListEntry</a>);
01752 
01753         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.SessionListInserted = 0;
01754     }
01755 
01756     <a class="code" href="../../d4/d8/mi_8h.html#a754">MiSessionCount</a> -= 1;
01757 
01758     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01759 
01760 <span class="preprocessor">#if DBG</span>
01761 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.SessionLeader == 0) {
01762         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> == 0);
01763         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1);
01764     }
01765 <span class="preprocessor">#endif</span>
01766 <span class="preprocessor"></span>
01767     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(0);
01768 
01769     <span class="comment">//</span>
01770     <span class="comment">// If an unload function has been registered for WIN32K.SYS,</span>
01771     <span class="comment">// call it now before we force an unload on any modules.  WIN32K.SYS</span>
01772     <span class="comment">// is responsible for calling any other loaded modules that have</span>
01773     <span class="comment">// unload routines to be run.  Another option is to have the other</span>
01774     <span class="comment">// session drivers register a DLL initialize/uninitialize pair on load.</span>
01775     <span class="comment">//</span>
01776 
01777     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>.<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a> ) {
01778         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>.<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>);
01779     }
01780 
01781     <span class="comment">//</span>
01782     <span class="comment">// Now that all modules have had their unload routine(s)</span>
01783     <span class="comment">// called, check for pool leaks before unloading the images.</span>
01784     <span class="comment">//</span>
01785 
01786     <a class="code" href="../../d4/d8/mi_8h.html#a974">MiCheckSessionPoolAllocations</a> ();
01787 
01788     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1);
01789 
01790     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(1);
01791 
01792     <span class="comment">//</span>
01793     <span class="comment">// Destroy the view mapping structures.</span>
01794     <span class="comment">//</span>
01795 
01796     <a class="code" href="../../d4/d8/mi_8h.html#a995">MiFreeSessionSpaceMap</a> ();
01797 
01798     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(2);
01799 
01800     <span class="comment">//</span>
01801     <span class="comment">// Walk down the list of modules we have loaded dereferencing them.</span>
01802     <span class="comment">//</span>
01803     <span class="comment">// This allows us to force an unload of any kernel images loaded by</span>
01804     <span class="comment">// the session so we do not have any virtual space and paging</span>
01805     <span class="comment">// file leaks.</span>
01806     <span class="comment">//</span>
01807 
01808     <a class="code" href="../../d4/d7/sessload_8c.html#a14">MiSessionUnloadAllImages</a> ();
01809 
01810     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(3);
01811 
01812     <span class="comment">//</span>
01813     <span class="comment">// Destroy the session space bitmap structure</span>
01814     <span class="comment">//</span>
01815 
01816     <a class="code" href="../../d4/d8/mi_8h.html#a975">MiFreeSessionPoolBitMaps</a> ();
01817 
01818     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(4);
01819 
01820     <span class="comment">//</span>
01821     <span class="comment">// Reference the session space structure using its global</span>
01822     <span class="comment">// kernel PTE based address. This is to avoid deleting it out</span>
01823     <span class="comment">// from underneath ourselves.</span>
01824     <span class="comment">//</span>
01825 
01826     GlobalPteEntrySave = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>;
01827 
01828     <span class="comment">//</span>
01829     <span class="comment">// Sweep the individual regions in their proper order.</span>
01830     <span class="comment">//</span>
01831 
01832 <span class="preprocessor">#if DBG</span>
01833 <span class="preprocessor"></span>
01834     <span class="comment">//</span>
01835     <span class="comment">// Check the executable image region. All images</span>
01836     <span class="comment">// should have been unloaded by the image handler.</span>
01837     <span class="comment">//</span>
01838 
01839     MiCheckSessionVirtualSpace ((PVOID)MI_SESSION_IMAGE_START,
01840                                 MI_SESSION_IMAGE_SIZE);
01841 <span class="preprocessor">#endif</span>
01842 <span class="preprocessor"></span>
01843     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(5);
01844 
01845 <span class="preprocessor">#if DBG</span>
01846 <span class="preprocessor"></span>
01847     <span class="comment">//</span>
01848     <span class="comment">// Check the view region. All views should have been cleaned up already.</span>
01849     <span class="comment">//</span>
01850 
01851     MiCheckSessionVirtualSpace ((PVOID)MI_SESSION_VIEW_START,
01852                                 MI_SESSION_VIEW_SIZE);
01853 <span class="preprocessor">#endif</span>
01854 <span class="preprocessor"></span>
01855     <span class="comment">//</span>
01856     <span class="comment">// Save the page tables in the session space structure since</span>
01857     <span class="comment">// we are going to tear it down.</span>
01858     <span class="comment">//</span>
01859 
01860 <span class="preprocessor">#if defined (_WIN64)</span>
01861 <span class="preprocessor"></span>    RtlCopyMemory (SavePageTables,
01862                    MiGetPdeAddress (MmSessionBase),
01863                    MI_SESSION_SPACE_PAGE_TABLES * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01864 <span class="preprocessor">#else</span>
01865 <span class="preprocessor"></span>    RtlCopyMemory (SavePageTables,
01866                    <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>,
01867                    MI_SESSION_SPACE_PAGE_TABLES * sizeof (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01868 <span class="preprocessor">#endif</span>
01869 <span class="preprocessor"></span>
01870     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(6);
01871 
01872 <span class="preprocessor">#if DBG</span>
01873 <span class="preprocessor"></span>    <span class="comment">//</span>
01874     <span class="comment">// Check everything possible before the remaining virtual address space</span>
01875     <span class="comment">// is torn down.  In this way if anything is amiss, the data can be</span>
01876     <span class="comment">// more easily examined.</span>
01877     <span class="comment">//</span>
01878 
01879     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
01880 
01881     <span class="comment">//</span>
01882     <span class="comment">// This should be greater than 1 because working set page tables are</span>
01883     <span class="comment">// using this as their parent as well.</span>
01884     <span class="comment">//</span>
01885 
01886     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt; 1);
01887 <span class="preprocessor">#endif</span>
01888 <span class="preprocessor"></span>
01889     CountReleased = 0;
01890 
01891     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.HasWsLock == 1) {
01892 
01893         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MI_SESSION_SPACE_WS);
01894         EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>);
01895 
01896         <span class="keywordflow">for</span> ( ; PointerPte &lt; EndPte; PointerPte += 1) {
01897 
01898             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01899 
01900                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01901                 <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_WS_PAGE_FREE, 1);
01902 
01903                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= 1;
01904                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= 1;
01905                 CountReleased += 1;
01906             }
01907         }
01908         WorkingSetWasInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01909         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.HasWsLock = 0;
01910     }
01911     <span class="keywordflow">else</span> {
01912         WorkingSetWasInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01913     }
01914 
01915     <span class="comment">//</span>
01916     <span class="comment">// Account for the session data structure data page.  For NT64, the page</span>
01917     <span class="comment">// directory page is also accounted for here.</span>
01918     <span class="comment">//</span>
01919 
01920 <span class="preprocessor">#if defined (_WIN64)</span>
01921 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_INITIAL_PAGE_FREE, 2);
01922     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= 2;
01923     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= 2;
01924     CountReleased += 2;
01925 <span class="preprocessor">#else</span>
01926 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_INITIAL_PAGE_FREE, 1);
01927     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= 1;
01928     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= 1;
01929     CountReleased += 1;
01930 <span class="preprocessor">#endif</span>
01931 <span class="preprocessor"></span>
01932     <span class="comment">//</span>
01933     <span class="comment">// Account for any needed session space page tables.</span>
01934     <span class="comment">//</span>
01935 
01936     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
01937 
01938         StartPde = &amp;SavePageTables[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01939 
01940         <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01941             <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_PAGETABLE_FREE, 1);
01942             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= 1;
01943             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= 1;
01944             CountReleased += 1;
01945         }
01946     }
01947 
01948     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> == 0);
01949 
01950     <span class="comment">//</span>
01951     <span class="comment">// Note that whenever win32k or drivers loaded by it leak pool, the</span>
01952     <span class="comment">// ASSERT below will be triggered.</span>
01953     <span class="comment">//</span>
01954 
01955     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> == 0);
01956 
01957     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CountReleased);
01958 
01959     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_SESSION_DEREFERENCE, CountReleased);
01960 
01961     <span class="comment">//</span>
01962     <span class="comment">// Sweep the working set entries.</span>
01963     <span class="comment">// No more accesses to the working set or its lock are allowed.</span>
01964     <span class="comment">//</span>
01965 
01966     <span class="keywordflow">if</span> (WorkingSetWasInitialized == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01967         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>);
01968 
01969         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MI_SESSION_SPACE_WS);
01970         EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>);
01971 
01972         <span class="keywordflow">for</span> ( ; PointerPte &lt; EndPte; PointerPte += 1) {
01973 
01974             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01975 
01976                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01977 
01978                 <span class="comment">//</span>
01979                 <span class="comment">// Delete the page.</span>
01980                 <span class="comment">//</span>
01981 
01982                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01983 
01984                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01985 
01986                 <span class="comment">//</span>
01987                 <span class="comment">// Each page should still be locked in the session working set.</span>
01988                 <span class="comment">//</span>
01989 
01990                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01991 
01992                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
01993 
01994                 <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01995                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01996                 <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01997                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroKernelPte);
01998 
01999                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += 1;
02000                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(52, 1);
02001 
02002                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02003             }
02004         }
02005     }
02006 
02007 <span class="preprocessor">#if defined(_IA64_)</span>
02008 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a6">KeDisableSessionSharing</a>(&amp;SessionGlobal-&gt;SessionMapInfo);
02009 <span class="preprocessor">#endif</span>
02010 <span class="preprocessor"></span>
02011     <span class="comment">//</span>
02012     <span class="comment">// Now delete the session space structure itself.</span>
02013     <span class="comment">// No more accesses to MmSessionSpace after this.</span>
02014     <span class="comment">//</span>
02015 
02016     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmSessionSpace);
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// Delete the page.</span>
02020     <span class="comment">//</span>
02021 
02022     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
02023 
02024     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02025 
02026     <span class="comment">//</span>
02027     <span class="comment">// Make sure this page is still locked.</span>
02028     <span class="comment">//</span>
02029 
02030     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02031 
02032     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02033 
02034     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
02035 
02036     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
02037 
02038     <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
02039     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02040     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
02041     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroKernelPte);
02042 
02043     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += CountReleased;
02044 
02045     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(53, CountReleased);
02046 
02047     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>;
02048 
02049     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(56, MI_SESSION_SPACE_WORKING_SET_MINIMUM);
02050 
02051     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02052 
02053     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase);
02054 
02055     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MI_SESSION_SPACE_END);
02056 
02057     RtlZeroMemory (StartPde, (EndPde - StartPde) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
02058 
02059     <span class="comment">//</span>
02060     <span class="comment">// Flush the session space TB entries.</span>
02061     <span class="comment">//</span>
02062 
02063     <a class="code" href="../../d4/d8/mi_8h.html#a397">MI_FLUSH_SESSION_TB</a> (OldIrql);
02064 
02065     <span class="comment">//</span>
02066     <span class="comment">// Free the self-map PTE.</span>
02067     <span class="comment">//</span>
02068 
02069     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (GlobalPteEntrySave, 1, SystemPteSpace);
02070 
02071     <span class="comment">//</span>
02072     <span class="comment">// Delete page table pages.  Note that the page table page mapping the</span>
02073     <span class="comment">// session space data structure is done last so that we can apply</span>
02074     <span class="comment">// various ASSERTs in the DeletePde routine.</span>
02075     <span class="comment">//</span>
02076 
02077     SessionDataPdeIndex = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (MmSessionSpace);
02078 
02079     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02080 
02081     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
02082 
02083         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == SessionDataPdeIndex) {
02084 
02085             <span class="comment">//</span>
02086             <span class="comment">// The self map entry must be done last.</span>
02087             <span class="comment">//</span>
02088 
02089             <span class="keywordflow">continue</span>;
02090         }
02091 
02092         <a class="code" href="../../d3/d7/session_8c.html#a11">MiSessionDeletePde</a> (&amp;SavePageTables[Index],
02093                             WorkingSetWasInitialized,
02094                             &amp;SavePageTables[SessionDataPdeIndex]);
02095     }
02096 
02097     <a class="code" href="../../d3/d7/session_8c.html#a11">MiSessionDeletePde</a> (&amp;SavePageTables[SessionDataPdeIndex],
02098                         WorkingSetWasInitialized,
02099                         &amp;SavePageTables[SessionDataPdeIndex]);
02100 
02101 <span class="preprocessor">#if defined (_WIN64)</span>
02102 <span class="preprocessor"></span>
02103     <span class="comment">//</span>
02104     <span class="comment">// Delete the session page directory page.</span>
02105     <span class="comment">//</span>
02106 
02107     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (MmSessionSpace);
02108     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPpe);
02109     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02110     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02111     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
02112 
02113     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (MiGetPdeAddress (MmSessionSpace),
02114                                 TRUE,
02115                                 TRUE,
02116                                 (PHARDWARE_PTE)PointerPpe,
02117                                 <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
02118                                 PreviousPte);
02119 <span class="preprocessor">#endif</span>
02120 <span class="preprocessor"></span>
02121     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02122 
02123     ExAcquireFastMutex (&amp;MiSessionIdMutex);
02124 
02125     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (MiSessionIdBitmap, SessionId));
02126     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (MiSessionIdBitmap, SessionId, 1);
02127 
02128     ExReleaseFastMutex (&amp;MiSessionIdMutex);
02129 
02130     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02131 
02132     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession = 0;
02133 
02134     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02135 
02136     <span class="comment">//</span>
02137     <span class="comment">// The session space has been deleted and all TB flushing is complete.</span>
02138     <span class="comment">//</span>
02139 
02140     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02141 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="session.c::MiDetachSession" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDetachSession           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l01253">1253</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00543">KeDetachSessionSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05617">MI_FLUSH_SESSION_TB</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05280">MI_SESSION_SPACE_END</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05248">MI_SESSION_SPACE_PAGE_TABLES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02788">MiEmptyAllWorkingSetsWorker()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>01259                    :
01260 
01261     Detaches from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified session space.
01262 
01263 Arguments:
01264 
01265     None.
01266 
01267 Return Value:
01268 
01269     None.
01270 
01271 Environment:
01272 
01273     Kernel mode.  No locks held.  Current process must not have a session
01274     space to <span class="keywordflow">return</span> to - ie: <span class="keyword">this</span> should be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system process.
01275 
01276 --*/
01277 
01278 {
01279     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01280     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01281     KIRQL OldIrql;
01282 
01283     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
01284 
01285     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0);
01286     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
01287 
01288 <span class="preprocessor">#if defined (_WIN64)</span>
01289 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (MmSessionBase);
01290     PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01291 <span class="preprocessor">#else</span>
01292 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase);
01293 
01294     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MI_SESSION_SPACE_END);
01295 
01296     RtlZeroMemory (PointerPde, MI_SESSION_SPACE_PAGE_TABLES * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01297 <span class="preprocessor">#endif</span>
01298 <span class="preprocessor"></span>
01299     <a class="code" href="../../d4/d8/mi_8h.html#a397">MI_FLUSH_SESSION_TB</a> (OldIrql);
01300 
01301 <span class="preprocessor">#if defined(_IA64_)</span>
01302 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a9">KeDetachSessionSpace</a>();
01303 <span class="preprocessor">#endif</span>
01304 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="session.c::MiInitializeSessionIds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInitializeSessionIds           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="session.c::MiSessionAddProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionAddProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NewProcess</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00178">178</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00628">KeAddSessionSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05632">LOCK_SESSION</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05444">_MM_SESSION_SPACE::ProcessList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05411">_MM_SESSION_SPACE::ReferenceCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05300">SESSION_GLOBAL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00197">_EPROCESS::SessionProcessLinks</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">_MM_SESSION_SPACE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05635">UNLOCK_SESSION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>00184                    :
00185 
00186     Add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space.
00187 
00188 Arguments:
00189 
00190     NewProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being created.
00191 
00192 Return Value:
00193 
00194     None.
00195 
00196 Environment:
00197 
00198     Kernel mode, APCs disabled.
00199 
00200 --*/
00201 
00202 {
00203     KIRQL OldIrql;
00204     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
00205 
00206     <span class="comment">//</span>
00207     <span class="comment">// If the calling process has no session, then the new process won't get</span>
00208     <span class="comment">// one either.</span>
00209     <span class="comment">//</span>
00210 
00211     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
00212         <span class="keywordflow">return</span>;
00213     }
00214 
00215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmIsAddressValid (MmSessionSpace) == TRUE);
00216 
00217     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a>(MmSessionSpace);
00218 
00219     <a class="code" href="../../d4/d8/mi_8h.html#a400">LOCK_SESSION</a> (OldIrql);
00220 
00221     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> += 1;
00222 
00223     <a class="code" href="../../d4/d8/mi_8h.html#a401">UNLOCK_SESSION</a> (OldIrql);
00224 
00225 <span class="preprocessor">#if defined(_IA64_)</span>
00226 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a10">KeAddSessionSpace</a>(&amp;NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;SessionGlobal-&gt;SessionMapInfo);
00227 <span class="preprocessor">#endif</span>
00228 <span class="preprocessor"></span>
00229     <span class="comment">//</span>
00230     <span class="comment">// Link the process entry into the session space and WSL structures.</span>
00231     <span class="comment">//</span>
00232 
00233     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00234 
00235     <span class="keywordflow">if</span> (IsListEmpty(&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>)) {
00236 
00237         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00238 
00239             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.WorkingSetInserted == 0);
00240 
00241             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00242 
00243             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00244                             &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00245 
00246             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.WorkingSetInserted = 1;
00247         }
00248     }
00249 
00250     InsertTailList (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>, &amp;NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o17">SessionProcessLinks</a>);
00251 
00252     NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession = 1;
00253 
00254     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00255 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="session.c::MiSessionCommitImagePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionCommitImagePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l02144">2144</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01063">MI_GET_PAGE_COLOR_FROM_SESSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02814">MiRemoveZeroPageIfAny</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04297">MM_DBG_COMMIT_RETURN_SESSION_IMAGE_FAILURE1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04267">MM_DBG_COMMIT_SESSION_IMAGE_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05318">MM_DBG_SESSION_DRIVER_PAGES_LOCKED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00191">MM_DBG_SESSIONS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05367">MM_SESSION_FAILURE_NO_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05368">MM_SESSION_FAILURE_NO_RESIDENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00043">ValidKernelPteLocal</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>.
<p>
<pre class="fragment"><div>02151                    :
02152 
02153     This routine commits <span class="keyword">virtual</span> memory within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space with
02154     backing pages.  The <span class="keyword">virtual</span> addresses within session space are
02155     allocated with a separate facility in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image management facility.
02156     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> because images must be at a unique system wide <span class="keyword">virtual</span> address.
02157 
02158 Arguments:
02159 
02160     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first <span class="keyword">virtual</span> address to commit.
02161 
02162     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to commit.
02163 
02164 Return Value:
02165 
02166     STATUS_SUCCESS <span class="keywordflow">if</span> all went well, STATUS_NO_MEMORY <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process
02167     has no session.
02168 
02169 Environment:
02170 
02171     Kernel mode, <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a> held.
02172 
02173 --*/
02174 
02175 {
02176     KIRQL WsIrql;
02177     KIRQL OldIrql;
02178     ULONG Color;
02179     PFN_NUMBER SizeInPages;
02180     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02181     ULONG_PTR AllocationStart;
02182     PFN_NUMBER PageFrameIndex;
02183     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02184     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte, EndPte;
02185     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02186 
02187     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
02188 
02189     <span class="keywordflow">if</span> (NumberOfBytes == 0) {
02190         <span class="keywordflow">return</span> STATUS_SUCCESS;
02191     }
02192 
02193     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02194 <span class="preprocessor">#if DBG</span>
02195 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionCommitImagePages: No session space!\n"</span>);
02196 <span class="preprocessor">#endif</span>
02197 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02198     }
02199 
02200     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)VirtualAddress % PAGE_SIZE) == 0);
02201     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((NumberOfBytes % PAGE_SIZE) == 0);
02202 
02203     SizeInPages = (PFN_NUMBER)(NumberOfBytes &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02204 
02205     <span class="comment">//</span>
02206     <span class="comment">// Calculate pages needed.</span>
02207     <span class="comment">//</span>
02208 
02209     AllocationStart = (ULONG_PTR)VirtualAddress;
02210 
02211     <span class="comment">//</span>
02212     <span class="comment">// Lock the session space working set.</span>
02213     <span class="comment">//</span>
02214 
02215     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a>(WsIrql);
02216 
02217     <span class="comment">//</span>
02218     <span class="comment">// Make sure we have page tables for the PTE</span>
02219     <span class="comment">// entries we must fill in the session space structure.</span>
02220     <span class="comment">//</span>
02221 
02222     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a9">MiSessionCommitPageTables</a> ((PVOID)AllocationStart,
02223                                         (PVOID)(AllocationStart + NumberOfBytes));
02224 
02225     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02226 <span class="preprocessor">#if DBG</span>
02227 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
02228             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCommitImagePages: Could not commit pagetables, Not enough memory! MmResidentAvailablePages %d, SizeInPages %d\n"</span>,
02229                 MmResidentAvailablePages,
02230                 SizeInPages);
02231         }
02232 <span class="preprocessor">#endif</span>
02233 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
02234         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02235     }
02236 
02237     <span class="comment">//</span>
02238     <span class="comment">// go into loop allocating them and placing them into the page</span>
02239     <span class="comment">// tables.</span>
02240     <span class="comment">//</span>
02241 
02242     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AllocationStart);
02243     EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AllocationStart + NumberOfBytes);
02244 
02245     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (SizeInPages, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02246         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_COMMIT);
02247         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
02248         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02249     }
02250 
02251     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_SESSION_IMAGE_PAGES, SizeInPages);
02252 
02253     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a3">ValidKernelPteLocal</a>;
02254 
02255     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02256 
02257     <span class="comment">//</span>
02258     <span class="comment">// Check to make sure the physical pages are available.</span>
02259     <span class="comment">//</span>
02260 
02261     <span class="keywordflow">if</span> ((SPFN_NUMBER)SizeInPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 20) {
02262         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02263         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (SizeInPages);
02264         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_SESSION_IMAGE_FAILURE1, SizeInPages);
02265         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_RESIDENT);
02266         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
02267         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02268     }
02269 
02270     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= SizeInPages;
02271 
02272     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(45, SizeInPages);
02273 
02274     <span class="keywordflow">while</span> (StartPte &lt; EndPte) {
02275 
02276         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
02277 
02278         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
02279 
02280         Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a126">MI_GET_PAGE_COLOR_FROM_SESSION</a> (MmSessionSpace);
02281 
02282         PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
02283         <span class="keywordflow">if</span> (PageFrameIndex == 0) {
02284             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
02285             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02286             <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, Color);
02287             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02288         }
02289 
02290         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02291         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPte, TempPte);
02292 
02293         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02294 
02295         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02296 
02297         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, StartPte, 1);
02298 
02299         KeFillEntryTb ((PHARDWARE_PTE) StartPte, (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)AllocationStart, FALSE);
02300 
02301         StartPte += 1;
02302         AllocationStart += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02303     }
02304 
02305     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02306 
02307     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += SizeInPages;
02308     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += SizeInPages;
02309 
02310     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_DRIVER_PAGES_LOCKED, SizeInPages);
02311 
02312     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
02313 
02314     <span class="keywordflow">return</span> STATUS_SUCCESS;
02315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="session.c::MiSessionCommitPageTables" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionCommitPageTables           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartVa</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EndVa</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l02318">2318</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01063">MI_GET_PAGE_COLOR_FROM_SESSION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05280">MI_SESSION_SPACE_END</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05248">MI_SESSION_SPACE_PAGE_TABLES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04056">MiAddValidPageToWorkingSet()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05733">MiGetPdeSessionIndex</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03973">MiInitializePfnForOtherProcess()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02814">MiRemoveZeroPageIfAny</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04298">MM_DBG_COMMIT_RETURN_SESSION_PAGETABLE_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04268">MM_DBG_COMMIT_SESSION_PAGETABLE_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05308">MM_DBG_SESSION_PAGETABLE_ALLOC</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05367">MM_SESSION_FAILURE_NO_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05368">MM_SESSION_FAILURE_NO_RESIDENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05685">MM_SESSION_SPACE_WS_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05491">_MM_SESSION_SPACE::PageTables</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05427">_MM_SESSION_SPACE::SessionPageDirectoryIndex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00065">ValidKernelPdeLocal</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05557">_MM_SESSION_SPACE::Wsle</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, and <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>.
<p>
<pre class="fragment"><div>02325                    :
02326 
02327     Fill in page tables covering <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address range.
02328 
02329 Arguments:
02330 
02331     StartVa - Supplies a starting <span class="keyword">virtual</span> address.
02332 
02333     EndVa - Supplies an ending <span class="keyword">virtual</span> address.
02334 
02335 Return Value:
02336 
02337     STATUS_SUCCESS on success, STATUS_NO_MEMORY on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
02338 
02339 Environment:
02340 
02341     Kernel mode.  Session space working set mutex held.
02342 
02343 --*/
02344 
02345 {
02346     KIRQL OldIrql;
02347     ULONG Color;
02348     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02349     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde, EndPde;
02350     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02351     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02352     ULONG Entry;
02353     ULONG SwapEntry;
02354     PFN_NUMBER SizeInPages;
02355     PFN_NUMBER PageTablePage;
02356     PVOID SessionPte;
02357     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
02358     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> SavePageTables[<a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>];
02359 
02360     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
02361 
02362     <a class="code" href="../../d4/d8/mi_8h.html#a406">MM_SESSION_SPACE_WS_LOCK_ASSERT</a>();
02363 
02364     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartVa &gt;= (PVOID)MmSessionBase);
02365     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (EndVa &lt; (PVOID)MI_SESSION_SPACE_END);
02366 
02367     <span class="comment">//</span>
02368     <span class="comment">// Allocate the page table pages, loading them</span>
02369     <span class="comment">// into the current process's page directory.</span>
02370     <span class="comment">//</span>
02371 
02372     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartVa);
02373     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (EndVa);
02374     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (StartVa);
02375 
02376     SizeInPages = 0;
02377 
02378     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
02379 <span class="preprocessor">#if defined (_WIN64)</span>
02380 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)
02381 <span class="preprocessor">#else</span>
02382 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)
02383 <span class="preprocessor">#endif</span>
02384 <span class="preprocessor"></span>        {
02385             SizeInPages += 1;
02386         }
02387         StartPde += 1;
02388         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
02389     }
02390 
02391     <span class="keywordflow">if</span> (SizeInPages == 0) {
02392         <span class="keywordflow">return</span> STATUS_SUCCESS;
02393     }
02394 
02395     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (SizeInPages, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02396         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_COMMIT);
02397         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02398     }
02399 
02400     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_SESSION_PAGETABLE_PAGES, SizeInPages);
02401 
02402     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartVa);
02403     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (StartVa);
02404 
02405     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>;
02406 
02407     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02408 
02409     <span class="comment">//</span>
02410     <span class="comment">// Check to make sure the physical pages are available.</span>
02411     <span class="comment">//</span>
02412 
02413     <span class="keywordflow">if</span> ((SPFN_NUMBER)SizeInPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 20) {
02414         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02415         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (SizeInPages);
02416         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_SESSION_PAGETABLE_PAGES, SizeInPages);
02417         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_RESIDENT);
02418         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02419     }
02420 
02421     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= SizeInPages;
02422 
02423     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_PAGETABLE_ALLOC, SizeInPages);
02424 
02425     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(44, SizeInPages);
02426 
02427     WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
02428 
02429     RtlZeroMemory (SavePageTables, <span class="keyword">sizeof</span> (SavePageTables));
02430 
02431     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
02432 
02433 <span class="preprocessor">#if defined (_WIN64)</span>
02434 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)
02435 <span class="preprocessor">#else</span>
02436 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)
02437 <span class="preprocessor">#endif</span>
02438 <span class="preprocessor"></span>        {
02439 
02440             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02441 
02442             SavePageTables[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = 1;
02443 
02444             <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
02445 
02446             Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a126">MI_GET_PAGE_COLOR_FROM_SESSION</a> (MmSessionSpace);
02447 
02448             PageTablePage = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
02449             <span class="keywordflow">if</span> (PageTablePage == 0) {
02450                 PageTablePage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
02451                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02452                 <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageTablePage, Color);
02453                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02454             }
02455 
02456             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageTablePage;
02457             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPde, TempPte);
02458 
02459 <span class="preprocessor">#if !defined (_WIN64)</span>
02460 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = TempPte;
02461 <span class="preprocessor">#endif</span>
02462 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += 1;
02463             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += 1;
02464 
02465             <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageTablePage,
02466                                             StartPde,
02467                                             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
02468         }
02469 
02470         StartPde += 1;
02471         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
02472     }
02473 
02474     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02475 
02476     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartVa);
02477     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (StartVa);
02478 
02479     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
02480 
02481         <span class="keywordflow">if</span> (SavePageTables[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] == 1) {
02482 
02483             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02484 
02485             PageTablePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (StartPde);
02486 
02487             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageTablePage);
02488 
02489             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == NULL);
02490             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
02491 
02492             SessionPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
02493 
02494             <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (SessionPte,
02495                                         StartPde,
02496                                         Pfn1,
02497                                         0);
02498 
02499             Entry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (SessionPte,
02500                                   <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>,
02501                                   Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
02502 
02503             <span class="keywordflow">if</span> (Entry &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
02504 
02505                 SwapEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02506 
02507                 <span class="keywordflow">if</span> (Entry != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
02508 
02509                     <span class="comment">//</span>
02510                     <span class="comment">// Swap this entry with the one at first dynamic.</span>
02511                     <span class="comment">//</span>
02512 
02513                     <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry, SwapEntry, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
02514                 }
02515 
02516                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
02517             }
02518             <span class="keywordflow">else</span> {
02519                 SwapEntry = Entry;
02520             }
02521 
02522             <span class="comment">//</span>
02523             <span class="comment">// Indicate that the page is locked.</span>
02524             <span class="comment">//</span>
02525 
02526             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[SwapEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02527         }
02528 
02529         StartPde += 1;
02530         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
02531     }
02532 
02533     <span class="keywordflow">return</span> STATUS_SUCCESS;
02534 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="session.c::MiSessionCreateInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionCreateInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00394">394</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05522">_MM_SESSION_SPACE::Color</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05538">_MM_SESSION_SPACE::GlobalPteEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05435">_MM_SESSION_SPACE::GlobalVirtualAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05532">_MM_SESSION_SPACE::ImageList</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00315">KeEnableSessionSharing()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02841">MI_FLUSH_SINGLE_SESSION_TB</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01038">MI_GET_PAGE_COLOR_FROM_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00035">MI_SESSION_COMMIT_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05278">MI_SESSION_POOL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05642">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04478">MiFreeSessionPoolBitMaps()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l04071">MiFreeSessionSpaceMap()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03973">MiInitializePfnForOtherProcess()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04222">MiInitializeSessionPool()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a779">MiInitializeSystemSpaceMap()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02814">MiRemoveZeroPageIfAny</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00030">MiSessionIdBitmap</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00028">MiSessionIdMutex</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04295">MM_DBG_COMMIT_RETURN_SESSION_CREATE_FAILURE1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04266">MM_DBG_COMMIT_SESSION_CREATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05304">MM_DBG_SESSION_INITIAL_PAGE_ALLOC</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05305">MM_DBG_SESSION_INITIAL_PAGE_FREE_FAIL1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05302">MM_DBG_SESSION_INITIAL_PAGETABLE_ALLOC</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05306">MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_FAIL1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05303">MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_RACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00191">MM_DBG_SESSIONS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05367">MM_SESSION_FAILURE_NO_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05366">MM_SESSION_FAILURE_NO_IDS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05368">MM_SESSION_FAILURE_NO_RESIDENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05370">MM_SESSION_FAILURE_NO_SYSPTES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05369">MM_SESSION_FAILURE_RACE_DETECTED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05491">_MM_SESSION_SPACE::PageTables</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05444">_MM_SESSION_SPACE::ProcessList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05411">_MM_SESSION_SPACE::ReferenceCount</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01382">RtlFindClearBitsAndSet()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05575">_MM_SESSION_SPACE::Session</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05300">SESSION_GLOBAL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05427">_MM_SESSION_SPACE::SessionPageDirectoryIndex</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05437">_MM_SESSION_SPACE::SpinLock</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">_MM_SESSION_SPACE::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00065">ValidKernelPdeLocal</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00043">ValidKernelPteLocal</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05566">_MM_SESSION_SPACE::WsListEntry</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l00974">MmSessionCreate()</a>.
<p>
<pre class="fragment"><div>00400                    :
00401 
00402     This routine creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data structure that describes and maintains
00403     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space.  It resides at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space.
00404     Carefully construct <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first page mapping to bootstrap <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fault
00405     handler which relies on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space data structure being
00406     present and valid.
00407 
00408     In 32-bit NT, <span class="keyword">this</span> initial mapping <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> portion of session space
00409     mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first PDE will automatically be inherited by all child
00410     processes when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page
00411     directory <span class="keywordflow">for</span> <span class="keyword">new</span> address spaces.  Additional entries are faulted
00412     in by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space fault handler, which references <span class="keyword">this</span> structure.
00413     For 64-bit NT, everything <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> automatically inherited.
00414 
00415     This routine commits <span class="keyword">virtual</span> memory within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space with
00416     backing pages.  The <span class="keyword">virtual</span> addresses within session space are
00417     allocated with a separate facility in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image management facility.
00418     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> because images must be at a unique system wide <span class="keyword">virtual</span> address.
00419 
00420 Arguments:
00421 
00422     SessionId - Supplies a pointer to place <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> session <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> into.
00423 
00424 Return Value:
00425 
00426     STATUS_SUCCESS <span class="keywordflow">if</span> all went well, various <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> status codes
00427     <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session was not created.
00428 
00429 Environment:
00430 
00431     Kernel mode, no mutexes held.
00432 
00433 --*/
00434 
00435 {
00436     KIRQL  OldIrql;
00437     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00438     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00439     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00440     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00441     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
00442     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
00443     PFN_NUMBER ResidentPages;
00444     BOOLEAN GotCommit;
00445     BOOLEAN GotPages;
00446     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00447     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00448     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> AliasPte;
00449     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
00450     ULONG_PTR Va;
00451     PFN_NUMBER DataPage;
00452     PFN_NUMBER PageTablePage;
00453     PFN_NUMBER PageDirectoryPage;
00454     ULONG PageColor;
00455 
00456     SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00457     GotCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00458     GotPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00459 
00460     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(SessionSpace) == FALSE);
00461 
00462     ExAcquireFastMutex (&amp;MiSessionIdMutex);
00463 
00464     *SessionId = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (MiSessionIdBitmap, 1, 0);
00465 
00466     ExReleaseFastMutex (&amp;MiSessionIdMutex);
00467 
00468     <span class="keywordflow">if</span> (*SessionId == 0xFFFFFFFF) {
00469 <span class="preprocessor">#if DBG</span>
00470 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No session IDs available\n"</span>);
00471 <span class="preprocessor">#endif</span>
00472 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_IDS);
00473         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00474     }
00475 
00476     ResidentPages = <a class="code" href="../../d3/d7/session_8c.html#a1">MI_SESSION_COMMIT_CHARGE</a>;
00477 
00478     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (ResidentPages, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00479 <span class="preprocessor">#if DBG</span>
00480 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00481             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No commit for %d pages\n"</span>,
00482                 ResidentPages);
00483         }
00484 <span class="preprocessor">#endif</span>
00485 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_COMMIT);
00486         <span class="keywordflow">goto</span> Failure;
00487     }
00488 
00489     GotCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00490 
00491     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_SESSION_CREATE, ResidentPages);
00492 
00493     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Check to make sure the physical pages are available.</span>
00497     <span class="comment">//</span>
00498 
00499     <span class="keywordflow">if</span> ((SPFN_NUMBER)(ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>) &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>()) {
00500 <span class="preprocessor">#if DBG</span>
00501 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00502             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No Resident Pages %d, Need %d\n"</span>,
00503                 MmResidentAvailablePages,
00504                 ResidentPages + MI_SESSION_SPACE_WORKING_SET_MINIMUM);
00505         }
00506 <span class="preprocessor">#endif</span>
00507 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00508 
00509         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_RESIDENT);
00510         <span class="keywordflow">goto</span> Failure;
00511     }
00512 
00513     GotPages = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514 
00515     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= (ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00516 
00517     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(40, ResidentPages + MI_SESSION_SPACE_WORKING_SET_MINIMUM);
00518 
00519 <span class="preprocessor">#if defined (_WIN64)</span>
00520 <span class="preprocessor"></span>
00521     <span class="comment">//</span>
00522     <span class="comment">// Initialize the page directory page.</span>
00523     <span class="comment">//</span>
00524 
00525     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
00526 
00527     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (NULL);
00528 
00529     PageDirectoryPage = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
00530     <span class="keywordflow">if</span> (PageDirectoryPage == 0) {
00531         PageDirectoryPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
00532         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00533         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageDirectoryPage, PageColor);
00534         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00535     }
00536 
00537     <span class="comment">//</span>
00538     <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
00539     <span class="comment">// is flushed when we switch to a process in a different session space.</span>
00540     <span class="comment">//</span>
00541 
00542     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00543     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryPage;
00544 
00545     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> ((PVOID)MmSessionSpace);
00546 
00547     <span class="comment">//</span>
00548     <span class="comment">// Another thread may have gotten here before us, check for that now.</span>
00549     <span class="comment">//</span>
00550 
00551     <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00552 
00553 <span class="preprocessor">#if DBG</span>
00554 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00555         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: Detected PPE %p race\n"</span>,
00556             PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00557         DbgBreakPoint ();
00558 <span class="preprocessor">#endif //DBG</span>
00559 <span class="preprocessor"></span>
00560         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryPage);
00561         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
00562         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00563         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00564         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
00565         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00566 <span class="preprocessor">#if DBG</span>
00567 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00568 <span class="preprocessor">#endif</span>
00569 <span class="preprocessor"></span>
00570         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageDirectoryPage);
00571 
00572         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += (ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00573         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(46, ResidentPages + MI_SESSION_SPACE_WORKING_SET_MINIMUM);
00574 
00575         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_RACE, 1);
00576 
00577         GotPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00578         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00579 
00580         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_RACE_DETECTED);
00581 
00582         <span class="keywordflow">goto</span> Failure;
00583     }
00584 
00585     *PointerPpe = TempPte;
00586 
00587     <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageDirectoryPage, PointerPpe, 0);
00588     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryPage);
00589     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = 0;
00590 
00591     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageDirectoryPage)-&gt;u1.WsIndex == 0);
00592 
00593     KeFillEntryTb ((PHARDWARE_PTE) PointerPpe,
00594                    MiGetVirtualAddressMappedByPte (PointerPpe),
00595                    FALSE);
00596 <span class="preprocessor">#endif</span>
00597 <span class="preprocessor"></span>
00598     <span class="comment">//</span>
00599     <span class="comment">// Initialize the page table page.</span>
00600     <span class="comment">//</span>
00601 
00602     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
00603 
00604     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (NULL);
00605 
00606     PageTablePage = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
00607     <span class="keywordflow">if</span> (PageTablePage == 0) {
00608         PageTablePage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
00609         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00610         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageTablePage, PageColor);
00611         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00612     }
00613 
00614     <span class="comment">//</span>
00615     <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
00616     <span class="comment">// is flushed when we switch to a process in a different session space.</span>
00617     <span class="comment">//</span>
00618 
00619     TempPte.u.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00620     TempPte.u.Hard.PageFrameNumber = PageTablePage;
00621 
00622     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)MmSessionSpace);
00623 
00624 <span class="preprocessor">#if !defined (_WIN64)</span>
00625 <span class="preprocessor"></span>
00626     <span class="comment">//</span>
00627     <span class="comment">// Another thread may have gotten here before us, check for that now.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00631 <span class="preprocessor">#if DBG</span>
00632 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00633         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: Detected PDE %p race\n"</span>,
00634             PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00635         DbgBreakPoint ();
00636 <span class="preprocessor">#endif //DBG</span>
00637 <span class="preprocessor"></span>
00638         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageTablePage);
00639         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
00640         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00641         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00642         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
00643         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00644 <span class="preprocessor">#if DBG</span>
00645 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00646 <span class="preprocessor">#endif</span>
00647 <span class="preprocessor"></span>
00648         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageTablePage);
00649 
00650         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += (ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00651         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(46, ResidentPages + MI_SESSION_SPACE_WORKING_SET_MINIMUM);
00652 
00653         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_RACE, 1);
00654 
00655         GotPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00656         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00657 
00658         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_RACE_DETECTED);
00659 
00660         <span class="keywordflow">goto</span> Failure;
00661     }
00662 
00663 <span class="preprocessor">#endif</span>
00664 <span class="preprocessor"></span>
00665     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
00666 
00667     <span class="comment">//</span>
00668     <span class="comment">// This page frame references itself instead of the current (SMSS.EXE)</span>
00669     <span class="comment">// page directory as its PteFrame.  This allows the current process to</span>
00670     <span class="comment">// appear more normal (at least on 32-bit NT).  It just means we have</span>
00671     <span class="comment">// to treat this page specially during teardown.</span>
00672     <span class="comment">//</span>
00673 
00674     <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageTablePage, PointerPde, PageTablePage);
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// This page is never paged, ensure that its WsIndex stays clear so the</span>
00678     <span class="comment">// release of the page is handled correctly.</span>
00679     <span class="comment">//</span>
00680 
00681     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageTablePage)-&gt;u1.WsIndex == 0);
00682 
00683     Va = (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmSessionSpace);
00684 
00685     KeFillEntryTb ((PHARDWARE_PTE) PointerPde, (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)Va, FALSE);
00686 
00687     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
00688 
00689     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (NULL);
00690 
00691     DataPage = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
00692     <span class="keywordflow">if</span> (DataPage == 0) {
00693         DataPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
00694         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00695         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (DataPage, PageColor);
00696         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00697     }
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
00701     <span class="comment">// is flushed when we switch to a process in a different session space.</span>
00702     <span class="comment">//</span>
00703 
00704     TempPte.u.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a3">ValidKernelPteLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00705     TempPte.u.Hard.PageFrameNumber = DataPage;
00706 
00707     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmSessionSpace);
00708 
00709     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
00710 
00711     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (DataPage, PointerPte, 1);
00712 
00713     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(DataPage)-&gt;u1.WsIndex == 0);
00714 
00715     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00716 
00717     KeFillEntryTb ((PHARDWARE_PTE) PointerPte, (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)MmSessionSpace, FALSE);
00718 
00719     AliasPte = *PointerPte;
00720 
00721     <span class="comment">//</span>
00722     <span class="comment">// Initialize the new session space data structure.</span>
00723     <span class="comment">//</span>
00724 
00725     SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>;
00726 
00727     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_INITIAL_PAGETABLE_ALLOC, 1);
00728     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_INITIAL_PAGE_ALLOC, 1);
00729 
00730     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> = 1;
00731     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.LongFlags = 0;
00732     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a> = *SessionId;
00733     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a> = PageTablePage;
00734 
00735     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o22">Color</a> = PageColor;
00736 
00737     <span class="comment">//</span>
00738     <span class="comment">// Track the page table page and the data page.</span>
00739     <span class="comment">//</span>
00740 
00741     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> = ResidentPages;
00742     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> = ResidentPages;
00743 
00744 <span class="preprocessor">#if defined (_WIN64)</span>
00745 <span class="preprocessor"></span>
00746     <span class="comment">//</span>
00747     <span class="comment">// Initialize the session data page directory entry so trimmers can attach.</span>
00748     <span class="comment">//</span>
00749 
00750     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> ((PVOID)MmSessionSpace);
00751     SessionSpace-&gt;PageDirectory = *PointerPpe;
00752 
00753 <span class="preprocessor">#else</span>
00754 <span class="preprocessor"></span>
00755     <span class="comment">//</span>
00756     <span class="comment">// Load the session data page table entry so that other processes</span>
00757     <span class="comment">// can fault in the mapping.</span>
00758     <span class="comment">//</span>
00759 
00760     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[PointerPde - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase)] = *PointerPde;
00761 
00762 <span class="preprocessor">#endif</span>
00763 <span class="preprocessor"></span>
00764     <span class="comment">//</span>
00765     <span class="comment">// Reserve a global system PTE and map the data page into it.</span>
00766     <span class="comment">//</span>
00767 
00768     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (1,
00769                                                         SystemPteSpace,
00770                                                         0,
00771                                                         0,
00772                                                         FALSE
00773                                                         );
00774 
00775     <span class="keywordflow">if</span> (SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00776 <span class="preprocessor">#if DBG</span>
00777 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00778             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No memory for session self-map\n"</span>);
00779         }
00780 <span class="preprocessor">#endif</span>
00781 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_SYSPTES);
00782         <span class="keywordflow">goto</span> Failure;
00783     }
00784 
00785     *(SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>) = AliasPte;
00786 
00787     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>);
00788 
00789     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a>(SessionSpace);
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">// This list entry is only referenced while within the</span>
00793     <span class="comment">// session space and has session space (not global) addresses.</span>
00794     <span class="comment">//</span>
00795 
00796     InitializeListHead (&amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>);
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">// Initialize the session space pool.</span>
00800     <span class="comment">//</span>
00801 
00802     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a973">MiInitializeSessionPool</a> ();
00803 
00804     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00805 <span class="preprocessor">#if DBG</span>
00806 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00807             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No memory for session pool\n"</span>);
00808         }
00809 <span class="preprocessor">#endif</span>
00810 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> Failure;
00811     }
00812 
00813     <span class="comment">//</span>
00814     <span class="comment">// Initialize the view mapping support - note this must happen after</span>
00815     <span class="comment">// initializing session pool.</span>
00816     <span class="comment">//</span>
00817 
00818     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a779">MiInitializeSystemSpaceMap</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00819 <span class="preprocessor">#if DBG</span>
00820 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00821             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No memory for view mapping\n"</span>);
00822         }
00823 <span class="preprocessor">#endif</span>
00824 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> Failure;
00825     }
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Use the global virtual address rather than the session space virtual</span>
00829     <span class="comment">// address to set up fields that need to be globally accessible.</span>
00830     <span class="comment">//</span>
00831 
00832     InitializeListHead (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o33">WsListEntry</a>);
00833 
00834     InitializeListHead (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>);
00835 
00836     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o7">SpinLock</a>);
00837 
00838 <span class="preprocessor">#if defined(_IA64_)</span>
00839 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a5">KeEnableSessionSharing</a>(&amp;SessionGlobal-&gt;SessionMapInfo);
00840 <span class="preprocessor">#endif</span>
00841 <span class="preprocessor"></span>
00842     <span class="keywordflow">return</span> STATUS_SUCCESS;
00843 
00844 Failure:
00845 
00846     <span class="keywordflow">if</span> (GotCommit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00847         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (ResidentPages);
00848         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_SESSION_CREATE_FAILURE1,
00849                          ResidentPages);
00850     }
00851 
00852     <span class="keywordflow">if</span> (GotPages == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00853 
00854 <span class="preprocessor">#if defined (_WIN64)</span>
00855 <span class="preprocessor"></span>
00856         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (MI_SESSION_POOL);
00857 
00858         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;u.Hard.Valid != 0);
00859 
00860 <span class="preprocessor">#endif</span>
00861 <span class="preprocessor"></span>
00862         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MI_SESSION_POOL);
00863 
00864         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;u.Hard.Valid != 0);
00865 
00866         <span class="comment">//</span>
00867         <span class="comment">// Note that this call will acquire the session space lock, so the</span>
00868         <span class="comment">// data page better be mapped.</span>
00869         <span class="comment">//</span>
00870 
00871         <a class="code" href="../../d4/d8/mi_8h.html#a995">MiFreeSessionSpaceMap</a> ();
00872 
00873         <span class="comment">//</span>
00874         <span class="comment">// Free the initial page table page that was allocated for the</span>
00875         <span class="comment">// paged pool range (if it has been allocated at this point).</span>
00876         <span class="comment">//</span>
00877 
00878         <a class="code" href="../../d4/d8/mi_8h.html#a975">MiFreeSessionPoolBitMaps</a> ();
00879 
00880         <span class="keywordflow">if</span> (SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>) {
00881             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>,
00882                                  1,
00883                                  SystemPteSpace);
00884             SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)0;
00885         }
00886 
00887         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00888 
00889         <span class="comment">//</span>
00890         <span class="comment">// Free the session data structure page.</span>
00891         <span class="comment">//</span>
00892 
00893         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (DataPage);
00894         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00895         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00896         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (DataPage);
00897 
00898         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (MmSessionSpace,
00899                                     TRUE,
00900                                     TRUE,
00901                                     (PHARDWARE_PTE)PointerPte,
00902                                     <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
00903                                     PreviousPte);
00904 
00905         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_INITIAL_PAGE_FREE_FAIL1, 1);
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// Free the page table page.</span>
00909         <span class="comment">//</span>
00910 
00911         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageTablePage);
00912         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageTablePage == Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00913         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 2);
00914         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
00915         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00916         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageTablePage);
00917 
00918         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde),
00919                                     TRUE,
00920                                     TRUE,
00921                                     (PHARDWARE_PTE)PointerPde,
00922                                     <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
00923                                     PreviousPte);
00924 
00925 <span class="preprocessor">#if defined (_WIN64)</span>
00926 <span class="preprocessor"></span>
00927         <span class="comment">//</span>
00928         <span class="comment">// Free the page directory page.</span>
00929         <span class="comment">//</span>
00930 
00931         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryPage);
00932         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageDirectoryPage == Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00933         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
00934         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
00935         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00936         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageDirectoryPage);
00937 
00938         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe),
00939                                     TRUE,
00940                                     TRUE,
00941                                     (PHARDWARE_PTE)PointerPpe,
00942                                     <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
00943                                     PreviousPte);
00944 
00945 <span class="preprocessor">#endif</span>
00946 <span class="preprocessor"></span>
00947         <span class="comment">//</span>
00948         <span class="comment">// Now that the PDE has been zeroed, another thread in this process</span>
00949         <span class="comment">// could attempt a session create so be careful not to count on any</span>
00950         <span class="comment">// anything in this particular session.</span>
00951         <span class="comment">//</span>
00952 
00953         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += (ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00954 
00955         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a> (49, ResidentPages + MI_SESSION_SPACE_WORKING_SET_MINIMUM);
00956 
00957         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_FAIL1, 1);
00958 
00959         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00960     }
00961 
00962     ExAcquireFastMutex (&amp;MiSessionIdMutex);
00963 
00964     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (MiSessionIdBitmap, *SessionId));
00965     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (MiSessionIdBitmap, *SessionId, 1);
00966 
00967     ExReleaseFastMutex (&amp;MiSessionIdMutex);
00968 
00969     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00970 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="session.c::MiSessionDeletePde" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionDeletePde           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pde</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetInitialized</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SelfMapPde</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l01408">1408</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00431">MM_KERNEL_NOACCESS_PTE</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00455">PTE_PER_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>.
<p>
<pre class="fragment"><div>01416                    :
01417 
01418     Used to <span class="keyword">delete</span> a page directory entry from a session space.
01419 
01420 Arguments:
01421 
01422     Pde - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page directory entry to <span class="keyword">delete</span>.
01423 
01424     WorkingSetInitialized - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set has been
01425                             initialized.
01426 
01427     SelfMapPde - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page directory entry that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">self</span> map
01428                  session page.
01429 
01430 
01431 Return Value:
01432 
01433     None.
01434 
01435 Environment:
01436 
01437     Kernel mode.  PFN lock held.
01438 
01439 --*/
01440 
01441 {
01442     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01443     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01444     KIRQL OldIrql2;
01445     PFN_NUMBER PageFrameIndex;
01446     BOOLEAN SelfMapPage;
01447 <span class="preprocessor">#if DBG</span>
01448 <span class="preprocessor"></span>    ULONG i;
01449     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01450 <span class="preprocessor">#endif</span>
01451 <span class="preprocessor"></span>
01452     <span class="keywordflow">if</span> (Pde-&gt;u.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01453         <span class="keywordflow">return</span>;
01454     }
01455 
01456     SelfMapPage = (Pde == SelfMapPde ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01457 
01458     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pde-&gt;u.Hard.Valid == 1);
01459 
01460     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (Pde);
01461     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01462 
01463 <span class="preprocessor">#if DBG</span>
01464 <span class="preprocessor"></span>
01465     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageFrameIndex &lt;= MmHighestPhysicalPage);
01466 
01467     <span class="keywordflow">if</span> (WorkingSetInitialized == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01468         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
01469     }
01470 
01471     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0);
01472     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
01473     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> &lt;= MmHighestPhysicalPage);
01474 
01475     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01476 
01477     <span class="comment">//</span>
01478     <span class="comment">// Verify the containing page table is still the page</span>
01479     <span class="comment">// table page mapping the session data structure.</span>
01480     <span class="comment">//</span>
01481 
01482     <span class="keywordflow">if</span> (SelfMapPage == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01483 
01484         <span class="comment">//</span>
01485         <span class="comment">// Note these ASSERTs will fail if win32k leaks pool.</span>
01486         <span class="comment">//</span>
01487 
01488         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
01489 <span class="preprocessor">#if !defined (_WIN64)</span>
01490 <span class="preprocessor"></span>
01491         <span class="comment">//</span>
01492         <span class="comment">// 32-bit NT points the additional page tables at the master.</span>
01493         <span class="comment">// 64-bit NT doesn't need to use this trick as there is always</span>
01494         <span class="comment">// an additional hierarchy level.</span>
01495         <span class="comment">//</span>
01496 
01497         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (SelfMapPde));
01498 <span class="preprocessor">#endif</span>
01499 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt; 2);
01500     }
01501     <span class="keywordflow">else</span> {
01502         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1 == Pfn2);
01503         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 2);
01504     }
01505 
01506     <span class="comment">//</span>
01507     <span class="comment">// Make sure the page table page is zeroed.  It should always be zero</span>
01508     <span class="comment">// unless win32k leaks pool or random bits get set.</span>
01509     <span class="comment">//</span>
01510 
01511     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01512 
01513     i = 0;
01514     <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>) {
01515         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0 &amp;&amp; PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>) {
01516             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: Deleting session page table: Index %d PTE %p is not zero! %p\n"</span>,
01517                 i,
01518                 PointerPte,
01519                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01520             DbgBreakPoint();
01521         }
01522         PointerPte += 1;
01523         i += 1;
01524     }
01525 
01526     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01527 
01528 <span class="preprocessor">#endif // DBG</span>
01529 <span class="preprocessor"></span>
01530     <span class="keywordflow">if</span> (SelfMapPage == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01531         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01532     }
01533     <span class="keywordflow">else</span> {
01534         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1 == Pfn2);
01535         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 2);
01536         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
01537     }
01538 
01539     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01540     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01541 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="session.c::MiSessionInSwapProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionInSwapProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l02737">2737</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05435">_MM_SESSION_SPACE::GlobalVirtualAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05898">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01722">MiGetPdeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01769">MiGetPteOffset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00191">MM_DBG_SESSIONS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05444">_MM_SESSION_SPACE::ProcessList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05524">_MM_SESSION_SPACE::ProcessOutSwapCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05411">_MM_SESSION_SPACE::ReferenceCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l03910">MmInSwapProcess()</a>.
<p>
<pre class="fragment"><div>02743                    :
02744 
02745     This routine in swaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
02746 
02747 Arguments:
02748 
02749     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be swapped
02750         into memory.
02751 
02752 Return Value:
02753 
02754     None.
02755 
02756 Environment:
02757 
02758     Kernel mode.  This routine must not enter a wait state <span class="keywordflow">for</span> memory resources
02759     or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system will deadlock.
02760 
02761 --*/
02762 
02763 {
02764     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02765     PFN_NUMBER PdePage;
02766     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryMap;
02767     KIRQL OldIrql;
02768     PFN_NUMBER SessionPage;
02769     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
02770 <span class="preprocessor">#if DBG</span>
02771 <span class="preprocessor"></span>    ULONG InCount;
02772     ULONG OutCount;
02773     PLIST_ENTRY NextEntry;
02774 <span class="preprocessor">#endif</span>
02775 <span class="preprocessor"></span><span class="preprocessor">#if defined (_X86PAE_)</span>
02776 <span class="preprocessor"></span>    ULONG i;
02777     PPAE_ENTRY PaeVa;
02778 <span class="preprocessor">#endif</span>
02779 <span class="preprocessor"></span>
02780     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE &amp;&amp; Process-&gt;Vm.u.Flags.ProcessInSession == 1);
02781 
02782     <span class="comment">//</span>
02783     <span class="comment">// smss doesn't count when we catch it before it has detached from the</span>
02784     <span class="comment">// session it is currently creating.</span>
02785     <span class="comment">//</span>
02786 
02787     <span class="keywordflow">if</span> (Process-&gt;Vm.u.Flags.SessionLeader == 1) {
02788         <span class="keywordflow">return</span>;
02789     }
02790 
02791     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE &amp;&amp; Process-&gt;Vm.u.Flags.ProcessInSession == 1);
02792 
02793     <span class="comment">//</span>
02794     <span class="comment">// smss doesn't count when we swap it before it has detached from the</span>
02795     <span class="comment">// session it is currently creating.</span>
02796     <span class="comment">//</span>
02797 
02798     <span class="keywordflow">if</span> (Process-&gt;Vm.u.Flags.SessionLeader == 1) {
02799         <span class="keywordflow">return</span>;
02800     }
02801 
02802 <span class="preprocessor">#if defined (_X86PAE_)</span>
02803 <span class="preprocessor"></span>    PaeVa = Process-&gt;PaeTop;
02804 
02805 <span class="preprocessor">#if DBG</span>
02806 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
02807         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PaeVa-&gt;PteEntry[i].u.Hard.Valid == 1);
02808     }
02809 <span class="preprocessor">#endif</span>
02810 <span class="preprocessor"></span>
02811     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PaeVa-&gt;PteEntry[MiGetPdPteOffset(MmSessionSpace)]);
02812 
02813 <span class="preprocessor">#else</span>
02814 <span class="preprocessor"></span>    PdePage = <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process);
02815 <span class="preprocessor">#endif</span>
02816 <span class="preprocessor"></span>
02817     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02818 
02819 <span class="preprocessor">#if defined (_WIN64)</span>
02820 <span class="preprocessor"></span>    TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmSessionSpace)];
02821 
02822     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02823 
02824     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02825 
02826     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02827 <span class="preprocessor">#endif</span>
02828 <span class="preprocessor"></span>
02829     TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmSessionSpace)];
02830 
02831     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02832 
02833     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02834 
02835     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02836 
02837     TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmSessionSpace)];
02838 
02839     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02840 
02841     SessionPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02842 
02843     SessionGlobal = (<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>) <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (SessionPage,
02844                                                                &amp;OldIrql);
02845 
02846     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_PAGE_FRAME_FROM_PTE (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>)) == SessionPage);
02847 
02848     SessionGlobal = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>;
02849 
02850     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02851 
02852     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02853 
02854 <span class="preprocessor">#if DBG</span>
02855 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt; 0);
02856 
02857     InCount = 0;
02858     OutCount = 0;
02859     NextEntry = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>.Flink;
02860 
02861     <span class="keywordflow">while</span> (NextEntry != &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>) {
02862         Process = CONTAINING_RECORD (NextEntry, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, SessionProcessLinks);
02863 
02864         <span class="keywordflow">if</span> (Process-&gt;ProcessOutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02865             OutCount += 1;
02866         }
02867         <span class="keywordflow">else</span> {
02868             InCount += 1;
02869         }
02870 
02871         NextEntry = NextEntry-&gt;Flink;
02872     }
02873 
02874     <span class="keywordflow">if</span> (InCount + OutCount &gt; SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>) {
02875         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionInSwapProcess : count mismatch %p %x %x %x\n"</span>,
02876             SessionGlobal,
02877             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02878             InCount,
02879             OutCount);
02880         DbgBreakPoint ();
02881     }
02882 
02883     <span class="keywordflow">if</span> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> != OutCount) {
02884         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionInSwapProcess : out count mismatch %p %x %x %x %x\n"</span>,
02885             SessionGlobal,
02886             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02887             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>,
02888             InCount,
02889             OutCount);
02890         DbgBreakPoint ();
02891     }
02892 
02893     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &lt;= SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>);
02894 
02895     MiSessionSwap[MiSwapIndex].Flag = 2;
02896     MiSessionSwap[MiSwapIndex].Process = Process;
02897     MiSessionSwap[MiSwapIndex].Session = SessionGlobal;
02898     MiSessionSwap[MiSwapIndex].OutSwapCount = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>;
02899     MiSwapIndex += 1;
02900     <span class="keywordflow">if</span> (MiSwapIndex == 0x100) {
02901         MiSwapIndex = 0;
02902     }
02903 <span class="preprocessor">#endif</span>
02904 <span class="preprocessor"></span>
02905     <span class="keywordflow">if</span> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> == SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>) {
02906 <span class="preprocessor">#if DBG</span>
02907 <span class="preprocessor"></span>        MiSessionInfo[2] += 1;
02908         <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
02909             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Mm: First process (%d total) just swapped back in for session %d, %d pages\n"</span>,
02910                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>,
02911                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
02912                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>);
02913         }
02914 <span class="preprocessor">#endif</span>
02915 <span class="preprocessor"></span>        SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard = 0;
02916     }
02917 <span class="preprocessor">#if DBG</span>
02918 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
02919         MiSessionInfo[3] += 1;
02920     }
02921 <span class="preprocessor">#endif</span>
02922 <span class="preprocessor"></span>
02923     SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
02924 
02925     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 0);
02926 
02927     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02928 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="session.c::MiSessionOutSwapProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionOutSwapProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l02551">2551</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05435">_MM_SESSION_SPACE::GlobalVirtualAddress</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05473">_MM_SESSION_SPACE::LastProcessSwappedOutTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05898">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01722">MiGetPdeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01769">MiGetPteOffset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00191">MM_DBG_SESSIONS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05444">_MM_SESSION_SPACE::ProcessList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05524">_MM_SESSION_SPACE::ProcessOutSwapCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05411">_MM_SESSION_SPACE::ReferenceCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l03590">MmOutSwapProcess()</a>.
<p>
<pre class="fragment"><div>02557                    :
02558 
02559     This routine notifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> containing session that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02560     being outswapped.  When all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes within a session have been
02561     outswapped, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> containing session undergoes a heavy trim.
02562 
02563 Arguments:
02564 
02565     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> swapped <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of memory.
02566 
02567 Return Value:
02568 
02569     None.
02570 
02571 Environment:
02572 
02573     Kernel mode.  This routine must not enter a wait state <span class="keywordflow">for</span> memory resources
02574     or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system will deadlock.
02575 
02576 --*/
02577 
02578 {
02579     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02580     PFN_NUMBER PdePage;
02581     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryMap;
02582     KIRQL OldIrql;
02583     PFN_NUMBER SessionPage;
02584     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
02585 <span class="preprocessor">#if DBG</span>
02586 <span class="preprocessor"></span>    ULONG InCount;
02587     ULONG OutCount;
02588     PLIST_ENTRY NextEntry;
02589 <span class="preprocessor">#endif</span>
02590 <span class="preprocessor"></span><span class="preprocessor">#if defined (_X86PAE_)</span>
02591 <span class="preprocessor"></span>    ULONG i;
02592     PPAE_ENTRY PaeVa;
02593 <span class="preprocessor">#endif</span>
02594 <span class="preprocessor"></span>
02595     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE &amp;&amp; Process-&gt;Vm.u.Flags.ProcessInSession == 1);
02596 
02597     <span class="comment">//</span>
02598     <span class="comment">// smss doesn't count when we swap it before it has detached from the</span>
02599     <span class="comment">// session it is currently creating.</span>
02600     <span class="comment">//</span>
02601 
02602     <span class="keywordflow">if</span> (Process-&gt;Vm.u.Flags.SessionLeader == 1) {
02603         <span class="keywordflow">return</span>;
02604     }
02605 
02606 <span class="preprocessor">#if defined (_X86PAE_)</span>
02607 <span class="preprocessor"></span>    PaeVa = Process-&gt;PaeTop;
02608 
02609 <span class="preprocessor">#if DBG</span>
02610 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
02611         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PaeVa-&gt;PteEntry[i].u.Hard.Valid == 1);
02612     }
02613 <span class="preprocessor">#endif</span>
02614 <span class="preprocessor"></span>
02615     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PaeVa-&gt;PteEntry[MiGetPdPteOffset(MmSessionSpace)]);
02616 
02617 <span class="preprocessor">#else</span>
02618 <span class="preprocessor"></span>
02619     PdePage = <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process);
02620 
02621 <span class="preprocessor">#endif</span>
02622 <span class="preprocessor"></span>
02623     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02624 
02625 <span class="preprocessor">#if defined (_WIN64)</span>
02626 <span class="preprocessor"></span>    TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmSessionSpace)];
02627 
02628     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02629 
02630     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02631 
02632     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02633 <span class="preprocessor">#endif</span>
02634 <span class="preprocessor"></span>
02635     TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmSessionSpace)];
02636 
02637     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02638 
02639     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02640 
02641     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02642 
02643     TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmSessionSpace)];
02644 
02645     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02646 
02647     SessionPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02648 
02649     SessionGlobal = (<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>) <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> ( SessionPage,
02650                                                                 &amp;OldIrql);
02651 
02652     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_PAGE_FRAME_FROM_PTE (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>)) == SessionPage);
02653 
02654     SessionGlobal = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>;
02655 
02656     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02657 
02658     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02659 
02660     SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> += 1;
02661 
02662 <span class="preprocessor">#if DBG</span>
02663 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt; 0);
02664 
02665     InCount = 0;
02666     OutCount = 0;
02667     NextEntry = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>.Flink;
02668 
02669     <span class="keywordflow">while</span> (NextEntry != &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>) {
02670         Process = CONTAINING_RECORD (NextEntry, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, SessionProcessLinks);
02671 
02672         <span class="keywordflow">if</span> (Process-&gt;ProcessOutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02673             OutCount += 1;
02674         }
02675         <span class="keywordflow">else</span> {
02676             InCount += 1;
02677         }
02678 
02679         NextEntry = NextEntry-&gt;Flink;
02680     }
02681 
02682     <span class="keywordflow">if</span> (InCount + OutCount &gt; SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>) {
02683         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionOutSwapProcess : process count mismatch %p %x %x %x\n"</span>,
02684             SessionGlobal,
02685             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02686             InCount,
02687             OutCount);
02688         DbgBreakPoint ();
02689     }
02690 
02691     <span class="keywordflow">if</span> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> != OutCount) {
02692         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionOutSwapProcess : out count mismatch %p %x %x %x %x\n"</span>,
02693             SessionGlobal,
02694             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02695             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>,
02696             InCount,
02697             OutCount);
02698         DbgBreakPoint ();
02699     }
02700 
02701     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &lt;= SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>);
02702 
02703     MiSessionSwap[MiSwapIndex].Flag = 1;
02704     MiSessionSwap[MiSwapIndex].Process = Process;
02705     MiSessionSwap[MiSwapIndex].Session = SessionGlobal;
02706     MiSessionSwap[MiSwapIndex].OutSwapCount = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>;
02707     MiSwapIndex += 1;
02708     <span class="keywordflow">if</span> (MiSwapIndex == 0x100) {
02709         MiSwapIndex = 0;
02710     }
02711 <span class="preprocessor">#endif</span>
02712 <span class="preprocessor"></span>
02713     <span class="keywordflow">if</span> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> == SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>) {
02714         SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard = 1;
02715 <span class="preprocessor">#if DBG</span>
02716 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
02717             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Mm: Last process (%d total) just swapped out for session %d, %d pages\n"</span>,
02718                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>,
02719                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
02720                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>);
02721         }
02722         MiSessionInfo[0] += 1;
02723 <span class="preprocessor">#endif</span>
02724 <span class="preprocessor"></span>        <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o15">LastProcessSwappedOutTime</a>);
02725     }
02726 <span class="preprocessor">#if DBG</span>
02727 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
02728         MiSessionInfo[1] += 1;
02729     }
02730 <span class="preprocessor">#endif</span>
02731 <span class="preprocessor"></span>
02732     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02733 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="session.c::MiSessionRemoveProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionRemoveProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="session.c::MmSessionCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmSessionCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00974">974</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05280">MI_SESSION_SPACE_END</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05611">MiSessionCount</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">_MM_SESSION_SPACE::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>00980                    :
00981 
00982     Called from <a class="code" href="../../d6/d8/sysinfo_8c.html#a50">NtSetSystemInformation</a>() to create a session space
00983     in the calling process with the specified SessionId.  An error is returned
00984     if the calling process already has a session Space.
00985 
00986 Arguments:
00987 
00988     SessionId - Supplies a pointer to place the resulting session <span class="keywordtype">id</span> in.
00989 
00990 Return Value:
00991 
00992     Various NTSTATUS error codes.
00993 
00994 Environment:
00995 
00996     Kernel mode, no mutexes held.
00997 
00998 --*/
00999 
01000 {
01001     KIRQL OldIrql;
01002     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01003     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
01004 <span class="preprocessor">#if DBG</span>
01005 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
01006     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01007 <span class="preprocessor">#endif</span>
01008 <span class="preprocessor"></span>
01009     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01010         <span class="keywordflow">return</span> STATUS_INVALID_SYSTEM_SERVICE;
01011     }
01012 
01013     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01014 
01015     <span class="comment">//</span>
01016     <span class="comment">// A simple check to see if the calling process already has a session space.</span>
01017     <span class="comment">// No need to go through all this if it does.  Creation races are caught</span>
01018     <span class="comment">// below and recovered from regardless.</span>
01019     <span class="comment">//</span>
01020 
01021     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1) {
01022         <span class="keywordflow">return</span> STATUS_ALREADY_COMMITTED;
01023     }
01024 
01025     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
01026 
01027         <span class="comment">//</span>
01028         <span class="comment">// Only the session manager can create a session.</span>
01029         <span class="comment">//</span>
01030 
01031         <span class="keywordflow">return</span> STATUS_INVALID_SYSTEM_SERVICE;
01032     }
01033 
01034 <span class="preprocessor">#if DBG</span>
01035 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == FALSE);
01036 
01037 <span class="preprocessor">#if defined (_WIN64)</span>
01038 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MmSessionBase))-&gt;u.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01039 <span class="preprocessor">#else</span>
01040 <span class="preprocessor"></span>    StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase);
01041     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MI_SESSION_SPACE_END);
01042 
01043     <span class="keywordflow">while</span> (StartPde &lt; EndPde) {
01044         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01045         StartPde += 1;
01046     }
01047 <span class="preprocessor">#endif</span>
01048 <span class="preprocessor"></span>
01049 <span class="preprocessor">#endif</span>
01050 <span class="preprocessor"></span>
01051     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01052 
01053     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a8">MiSessionCreateInternal</a> (SessionId);
01054 
01055     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01056         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01057         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01058     }
01059 
01060     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01061 
01062     <a class="code" href="../../d4/d8/mi_8h.html#a754">MiSessionCount</a> += 1;
01063 
01064     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01065 
01066     <span class="comment">//</span>
01067     <span class="comment">// Add the session space to the working set list.</span>
01068     <span class="comment">//</span>
01069 
01070     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/wslist_8c.html#a29">MiSessionInitializeWorkingSetList</a> ();
01071 
01072     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01073         <a class="code" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a> ();
01074         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01075         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01076     }
01077 
01078     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01079 
01080     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.Initialized = 1;
01081 
01082     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01083 
01084     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession = 1;
01085 
01086     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01087 
01088     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01089 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="session.c::MmSessionDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmSessionDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l01093">1093</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>01099                    :
01100 
01101     Called from <a class="code" href="../../d6/d8/sysinfo_8c.html#a50">NtSetSystemInformation</a>() to detach from an existing
01102     session space in the calling process.  An error is returned
01103     if the calling process has no session Space.
01104 
01105 Arguments:
01106 
01107     SessionId - Supplies the session <span class="keywordtype">id</span> to delete.
01108 
01109 Return Value:
01110 
01111     STATUS_SUCCESS on success, STATUS_UNABLE_TO_FREE_VM on failure.
01112 
01113     This process will not be able to access session space anymore upon
01114     a successful return.  If this is the last process in the session then
01115     the entire session is torn down.
01116 
01117 Environment:
01118 
01119     Kernel mode, no mutexes held.
01120 
01121 --*/
01122 
01123 {
01124     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
01125 
01126     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01127         <span class="keywordflow">return</span> STATUS_INVALID_SYSTEM_SERVICE;
01128     }
01129 
01130     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01131 
01132     <span class="comment">//</span>
01133     <span class="comment">// See if the calling process has a session space - this must be</span>
01134     <span class="comment">// checked since we can be called via a system service.</span>
01135     <span class="comment">//</span>
01136 
01137     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 0) {
01138 <span class="preprocessor">#if DBG</span>
01139 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MmSessionDelete: Process %p not in a session\n"</span>,
01140             <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
01141         DbgBreakPoint();
01142 <span class="preprocessor">#endif</span>
01143 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_UNABLE_TO_FREE_VM;
01144     }
01145 
01146     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
01147 
01148         <span class="comment">//</span>
01149         <span class="comment">// Only the session manager can delete a session.  This is because</span>
01150         <span class="comment">// it affects the virtual mappings for all threads within the process</span>
01151         <span class="comment">// when this address space is deleted.  This is different from normal</span>
01152         <span class="comment">// VAD clearing because win32k and other drivers rely on this space.</span>
01153         <span class="comment">//</span>
01154 
01155         <span class="keywordflow">return</span> STATUS_UNABLE_TO_FREE_VM;
01156     }
01157 
01158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
01159 
01160     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a> != SessionId) {
01161 <span class="preprocessor">#if DBG</span>
01162 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MmSessionDelete: Wrong SessionId! Own %d, Ask %d\n"</span>,
01163             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
01164             SessionId);
01165         DbgBreakPoint();
01166 <span class="preprocessor">#endif</span>
01167 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_UNABLE_TO_FREE_VM;
01168     }
01169 
01170     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a> ();
01171 
01172     <a class="code" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a> ();
01173 
01174     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
01175 
01176     <span class="keywordflow">return</span> STATUS_SUCCESS;
01177 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="session.c::MmSessionLeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmSessionLeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00109">109</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
<pre class="fragment"><div>00115                    :
00116 
00117     Mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument process as having <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ability to create or <span class="keyword">delete</span> session
00118     spaces.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session manager process.
00119 
00120 Arguments:
00121 
00122     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileged process.
00123 
00124 Return Value:
00125 
00126     None.
00127 
00128 Environment:
00129 
00130     Kernel mode.
00131 
00132 --*/
00133 
00134 {
00135     Process-&gt;Vm.u.Flags.SessionLeader = 1;
00136 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="session.c::MmSessionSetUnloadAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmSessionSetUnloadAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pWin32KDevice</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00140">140</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05584">_MM_SESSION_SPACE::Win32KDriverObject</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>00146                    :
00147 
00148     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> win32k.sys driver object to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session structure <span class="keywordflow">for</span> use during
00149     unload.
00150 
00151 Arguments:
00152 
00153     NewProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> win32k driver object.
00154 
00155 Return Value:
00156 
00157     None.
00158 
00159 Environment:
00160 
00161     Kernel mode.
00162 
00163 --*/
00164 
00165 {
00166     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 1) {
00167 
00168         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
00169 
00170         RtlMoveMemory (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>,
00171                        pWin32KDevice,
00172                        <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a>));
00173         }
00174 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="session.c::MiSessionCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d3/d7/session_8c.html#a2">MiSessionCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00024">24</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, and <a class="el" href="../../d4/d6/session_8c-source.html#l00974">MmSessionCreate()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="session.c::MiSessionIdBitmap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_BITMAP <a class="el" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00030">30</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00350">MiInitializeSessionIds()</a>, and <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="session.c::MiSessionIdMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00028">28</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00350">MiInitializeSessionIds()</a>, and <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
