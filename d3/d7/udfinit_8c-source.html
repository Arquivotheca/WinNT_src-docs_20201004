<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>udfinit.c</h1><a href="../../d2/d8/udfinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1996  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    UdfInit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the DRIVER_INITIALIZATION routine for Udfs</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Dan Lovinger    [DanLo]   24-May-1996</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "UdfProcs.h"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  The Bug check file id for this module</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d2/d8/udfinit_8c.html#a0">00027</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_UDFINIT)</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//</span>
00030 <span class="comment">//  The local debug trace level</span>
00031 <span class="comment">//</span>
00032 
<a name="l00033"></a><a class="code" href="../../d2/d8/udfinit_8c.html#a1">00033</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_UDFINIT)</span>
00034 <span class="preprocessor"></span>
00035 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00036 <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a22">DriverEntry</a>(
00037     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00038     IN PUNICODE_STRING RegistryPath
00039     );
00040 
00041 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00042 <a class="code" href="../../d2/d8/udfinit_8c.html#a5">UdfInitializeGlobalData</a> (
00043     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00044     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *FileSystemDeviceObjects
00045     );
00046 
00047 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, DriverEntry)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, UdfInitializeGlobalData)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00051 <span class="preprocessor"></span>
00052 
00053 <span class="comment">//</span>
00054 <span class="comment">//  Local support routine</span>
00055 <span class="comment">//</span>
00056 
00057 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00058 <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a22">DriverEntry</a>(
00059     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00060     IN PUNICODE_STRING RegistryPath
00061     )
00062 
00063 <span class="comment">/*++</span>
00064 <span class="comment"></span>
00065 <span class="comment">Routine Description:</span>
00066 <span class="comment"></span>
00067 <span class="comment">    This is the initialization routine for the UDF file system</span>
00068 <span class="comment">    device driver.  This routine creates the device object for the FileSystem</span>
00069 <span class="comment">    device and performs all other driver initialization.</span>
00070 <span class="comment"></span>
00071 <span class="comment">Arguments:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    DriverObject - Pointer to driver object created by the system.</span>
00074 <span class="comment"></span>
00075 <span class="comment">Return Value:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    NTSTATUS - The function value is the final status from the initialization</span>
00078 <span class="comment">        operation.</span>
00079 <span class="comment"></span>
00080 <span class="comment">--*/</span>
00081 
00082 {
00083     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00084     UNICODE_STRING UnicodeString;
00085     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> UdfsFileSystemDeviceObjects[<a class="code" href="../../d6/d8/udfstruc_8h.html#a0">NUMBER_OF_FS_OBJECTS</a>];
00086     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> UdfsDiskFileSystemDeviceObject;
00087 
00088     <span class="comment">//</span>
00089     <span class="comment">//  Create the device objects for both device "types".  Since</span>
00090     <span class="comment">//  UDF is a legitimate filesystem for media underlying device</span>
00091     <span class="comment">//  drivers claiming both DVD/CDROMs and disks, we must register</span>
00092     <span class="comment">//  this filesystem twice.</span>
00093     <span class="comment">//</span>
00094 
00095     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NUMBER_OF_FS_OBJECTS &gt;= 2 );
00096     RtlZeroMemory( &amp;UdfsFileSystemDeviceObjects, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * NUMBER_OF_FS_OBJECTS );
00097     
00098     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, L<span class="stringliteral">"\\UdfsCdRom"</span> );
00099 
00100     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( DriverObject,
00101                              0,
00102                              &amp;UnicodeString,
00103                              FILE_DEVICE_CD_ROM_FILE_SYSTEM,
00104                              0,
00105                              FALSE,
00106                              &amp;UdfsFileSystemDeviceObjects[0] );
00107 
00108     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00109         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00110     }
00111     
00112     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, L<span class="stringliteral">"\\UdfsDisk"</span> );
00113 
00114     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( DriverObject,
00115                              0,
00116                              &amp;UnicodeString,
00117                              FILE_DEVICE_DISK_FILE_SYSTEM,
00118                              0,
00119                              FALSE,
00120                              &amp;UdfsFileSystemDeviceObjects[1] );
00121 
00122     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00123 
00124         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( UdfsFileSystemDeviceObjects[0] );
00125         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00126     }
00127 
00128     <span class="comment">//</span>
00129     <span class="comment">//  Note that because of the way data caching is done, we set neither</span>
00130     <span class="comment">//  the Direct I/O or Buffered I/O bit in DeviceObject-&gt;Flags.  If</span>
00131     <span class="comment">//  data is not in the cache, or the request is not buffered, we may,</span>
00132     <span class="comment">//  set up for Direct I/O by hand.</span>
00133     <span class="comment">//</span>
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">//  Initialize the driver object with this driver's entry points.</span>
00137     <span class="comment">//</span>
00138     <span class="comment">//  NOTE - Each entry in the dispatch table must have an entry in</span>
00139     <span class="comment">//  the Fsp/Fsd dispatch switch statements.</span>
00140     <span class="comment">//</span>
00141 
00142     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>]                  =
00143     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a>]                   =
00144     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a>]                    =
00145     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a>]       =
00146     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a>]         =
00147     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a>]=
00148     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a>]       =
00149     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>]     =
00150     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a>]          =
00151     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a>]            =
00152     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a>]                 =
00153     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>]                     = (<a class="code" href="../../d0/d5/io_8h.html#a287">PDRIVER_DISPATCH</a>) <a class="code" href="../../d0/d8/udfdata_8c.html#a30">UdfFsdDispatch</a>;
00154 
00155     DriverObject-&gt;FastIoDispatch = &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>;
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">//  Initialize the global data structures</span>
00159     <span class="comment">//</span>
00160 
00161     <a class="code" href="../../d2/d8/udfinit_8c.html#a5">UdfInitializeGlobalData</a>( DriverObject, UdfsFileSystemDeviceObjects );
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">//  Register the file system with the I/O system</span>
00165     <span class="comment">//</span>
00166 
00167     <a class="code" href="../../d4/d6/iosubs_8c.html#a97">IoRegisterFileSystem</a>( UdfsFileSystemDeviceObjects[0] );
00168     <a class="code" href="../../d4/d6/iosubs_8c.html#a97">IoRegisterFileSystem</a>( UdfsFileSystemDeviceObjects[1] );
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">//  And return to our caller</span>
00172     <span class="comment">//</span>
00173 
00174     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00175 }
00176 
00177 
00178 <span class="comment">//</span>
00179 <span class="comment">//  Local support routine</span>
00180 <span class="comment">//</span>
00181 
00182 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00183"></a><a class="code" href="../../d2/d8/udfinit_8c.html#a5">00183</a> <a class="code" href="../../d2/d8/udfinit_8c.html#a5">UdfInitializeGlobalData</a> (
00184     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00185     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *UdfsFileSystemDeviceObjects
00186     )
00187 
00188 <span class="comment">/*++</span>
00189 <span class="comment"></span>
00190 <span class="comment">Routine Description:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    This routine initializes the global Udfs data structures.</span>
00193 <span class="comment"></span>
00194 <span class="comment">Arguments:</span>
00195 <span class="comment"></span>
00196 <span class="comment">    DriverObject - Supplies the driver object for UDFS.</span>
00197 <span class="comment"></span>
00198 <span class="comment">    FileSystemDeviceObjects - Supplies a vector of device objects for UDFS.</span>
00199 <span class="comment"></span>
00200 <span class="comment">Return Value:</span>
00201 <span class="comment"></span>
00202 <span class="comment">    None.</span>
00203 <span class="comment"></span>
00204 <span class="comment">--*/</span>
00205 
00206 {
00207     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> CcbMaxDepth;
00208     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> FcbDataMaxDepth;
00209     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> FcbIndexMaxDepth;
00210     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> FcbNonPagedMaxDepth;
00211     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> IrpContextMaxDepth;
00212     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> LcbMaxDepth;
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">//  Start by initializing the FastIoDispatch Table.</span>
00216     <span class="comment">//</span>
00217 
00218     RtlZeroMemory( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a> ));
00219 
00220     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> =    <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/io_8h.html#a319">FAST_IO_DISPATCH</a>);
00221 
00222     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o11">AcquireFileForNtCreateSection</a> =   <a class="code" href="../../d4/d9/resrcsup_8c.html#a7">UdfAcquireForCreateSection</a>;
00223     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o12">ReleaseFileForNtCreateSection</a> =   <a class="code" href="../../d4/d9/resrcsup_8c.html#a8">UdfReleaseForCreateSection</a>;
00224     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> =           <a class="code" href="../../d0/d8/udfdata_8c.html#a35">UdfFastIoCheckIfPossible</a>;   <span class="comment">//  CheckForFastIo</span>
00225     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o2">FastIoRead</a> =                      <a class="code" href="../../d3/d1/fastio_8c.html#a1">FsRtlCopyRead</a>;              <span class="comment">//  Read</span>
00226     
00227     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o4">FastIoQueryBasicInfo</a> =            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                       <span class="comment">//  QueryBasicInfo</span>
00228     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o5">FastIoQueryStandardInfo</a> =         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                       <span class="comment">//  QueryStandardInfo</span>
00229     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o6">FastIoLock</a> =                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                       <span class="comment">//  Lock</span>
00230     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o7">FastIoUnlockSingle</a> =              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                       <span class="comment">//  UnlockSingle</span>
00231     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o8">FastIoUnlockAll</a> =                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                       <span class="comment">//  UnlockAll</span>
00232     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o9">FastIoUnlockAllByKey</a> =            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                       <span class="comment">//  UnlockAllByKey</span>
00233     <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>.<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o14">FastIoQueryNetworkOpenInfo</a> =      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                       <span class="comment">//  QueryNetworkInfo</span>
00234     
00235     <span class="comment">//</span>
00236     <span class="comment">//  Initialize the CRC table. Per UDF 1.01, we use the seed 10041 octal (4129 dec).</span>
00237     <span class="comment">//</span>
00238 
00239     <a class="code" href="../../d3/d8/udfprocs_8h.html#a133">UdfInitializeCrc16</a>( 4129 );
00240 
00241     <span class="comment">//</span>
00242     <span class="comment">//  Initialize the UdfData structure.</span>
00243     <span class="comment">//</span>
00244 
00245     RtlZeroMemory( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d3/struct__UDF__DATA.html">UDF_DATA</a> ));
00246 
00247     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o0">NodeTypeCode</a> = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a1">UDFS_NTC_DATA_HEADER</a>;
00248     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d8/udfstruc_8h.html#a58">UDF_DATA</a> );
00249 
00250     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o2">DriverObject</a> = DriverObject;
00251     RtlCopyMemory( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o7">FileSystemDeviceObjects</a>,
00252                    UdfsFileSystemDeviceObjects,
00253                    <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * <a class="code" href="../../d6/d8/udfstruc_8h.html#a0">NUMBER_OF_FS_OBJECTS</a> );
00254 
00255     InitializeListHead( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o3">VcbQueue</a> );
00256 
00257     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o19">DataResource</a> );
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">//  Initialize the cache manager callback routines</span>
00261     <span class="comment">//</span>
00262 
00263     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>.<a class="code" href="../../d3/d6/struct__CACHE__MANAGER__CALLBACKS.html#o0">AcquireForLazyWrite</a>  = &amp;<a class="code" href="../../d4/d9/resrcsup_8c.html#a3">UdfAcquireForCache</a>;
00264     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>.<a class="code" href="../../d3/d6/struct__CACHE__MANAGER__CALLBACKS.html#o1">ReleaseFromLazyWrite</a> = &amp;<a class="code" href="../../d4/d9/resrcsup_8c.html#a4">UdfReleaseFromCache</a>;
00265     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>.<a class="code" href="../../d3/d6/struct__CACHE__MANAGER__CALLBACKS.html#o2">AcquireForReadAhead</a>  = &amp;<a class="code" href="../../d4/d9/resrcsup_8c.html#a3">UdfAcquireForCache</a>;
00266     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>.<a class="code" href="../../d3/d6/struct__CACHE__MANAGER__CALLBACKS.html#o3">ReleaseFromReadAhead</a> = &amp;<a class="code" href="../../d4/d9/resrcsup_8c.html#a4">UdfReleaseFromCache</a>;
00267 
00268     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o21">CacheManagerVolumeCallbacks</a>.<a class="code" href="../../d3/d6/struct__CACHE__MANAGER__CALLBACKS.html#o0">AcquireForLazyWrite</a>  = &amp;<a class="code" href="../../d4/d9/resrcsup_8c.html#a5">UdfNoopAcquire</a>;
00269     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o21">CacheManagerVolumeCallbacks</a>.<a class="code" href="../../d3/d6/struct__CACHE__MANAGER__CALLBACKS.html#o1">ReleaseFromLazyWrite</a> = &amp;<a class="code" href="../../d4/d9/resrcsup_8c.html#a6">UdfNoopRelease</a>;
00270     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o21">CacheManagerVolumeCallbacks</a>.<a class="code" href="../../d3/d6/struct__CACHE__MANAGER__CALLBACKS.html#o2">AcquireForReadAhead</a>  = &amp;<a class="code" href="../../d4/d9/resrcsup_8c.html#a5">UdfNoopAcquire</a>;
00271     <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o21">CacheManagerVolumeCallbacks</a>.<a class="code" href="../../d3/d6/struct__CACHE__MANAGER__CALLBACKS.html#o3">ReleaseFromReadAhead</a> = &amp;<a class="code" href="../../d4/d9/resrcsup_8c.html#a6">UdfNoopRelease</a>;
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">//  Initialize the lock mutex and the async and delay close queues.</span>
00275     <span class="comment">//</span>
00276 
00277     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o18">UdfDataMutex</a> );
00278     InitializeListHead( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o8">AsyncCloseQueue</a> );
00279     InitializeListHead( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o13">DelayedCloseQueue</a> );
00280 
00281     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o22">CloseItem</a>,
00282                           (<a class="code" href="../../d5/d8/ex_8h.html#a111">PWORKER_THREAD_ROUTINE</a>) <a class="code" href="../../d2/d9/close_8c.html#a5">UdfFspClose</a>,
00283                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00284 
00285     <span class="comment">//</span>
00286     <span class="comment">//  Do the initialization based on the system size.</span>
00287     <span class="comment">//</span>
00288 
00289     <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>()) {
00290 
00291     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>:
00292         
00293         IrpContextMaxDepth = 4;
00294         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o15">MaxDelayedCloseCount</a> = 10;
00295         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o16">MinDelayedCloseCount</a> = 2;
00296         <span class="keywordflow">break</span>;
00297 
00298     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>:
00299 
00300         IrpContextMaxDepth = 24;
00301         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o15">MaxDelayedCloseCount</a> = 72;
00302         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o16">MinDelayedCloseCount</a> = 18;
00303         <span class="keywordflow">break</span>;
00304 
00305     <span class="keywordflow">default</span>:
00306     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>:
00307     
00308         IrpContextMaxDepth = 8;
00309         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o15">MaxDelayedCloseCount</a> = 32;
00310         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o16">MinDelayedCloseCount</a> = 8;
00311         <span class="keywordflow">break</span>;
00312     
00313     }
00314 
00315     <span class="comment">//</span>
00316     <span class="comment">//  Size lookasides to match what will commonly be dumped into them when we</span>
00317     <span class="comment">//  run down the delayed close queues.</span>
00318     <span class="comment">//</span>
00319     
00320     LcbMaxDepth =
00321     CcbMaxDepth =
00322     FcbDataMaxDepth =
00323     FcbNonPagedMaxDepth = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o15">MaxDelayedCloseCount</a> - <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o16">MinDelayedCloseCount</a>);
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">//  We should tend to have fewer indices than files.</span>
00327     <span class="comment">//</span>
00328     
00329     FcbIndexMaxDepth = FcbNonPagedMaxDepth / 2;
00330 
00331 <span class="preprocessor">#define NPagedInit(L,S,T,D) { ExInitializeNPagedLookasideList( (L), NULL, NULL, POOL_RAISE_IF_ALLOCATION_FAILURE, S, T, D); }</span>
00332 <span class="preprocessor"></span><span class="preprocessor">#define PagedInit(L,S,T,D)  { ExInitializePagedLookasideList(  (L), NULL, NULL, POOL_RAISE_IF_ALLOCATION_FAILURE, S, T, D); }</span>
00333 <span class="preprocessor"></span>
00334     <a class="code" href="../../d2/d8/udfinit_8c.html#a2">NPagedInit</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a24">UdfIrpContextLookasideList</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a> ), <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a79">TAG_IRP_CONTEXT</a>, IrpContextMaxDepth );
00335     <a class="code" href="../../d2/d8/udfinit_8c.html#a2">NPagedInit</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a23">UdfFcbNonPagedLookasideList</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html">FCB_NONPAGED</a> ), <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a73">TAG_FCB_NONPAGED</a>, FcbNonPagedMaxDepth );
00336 
00337     <a class="code" href="../../d2/d8/udfinit_8c.html#a3">PagedInit</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a25">UdfCcbLookasideList</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d9/struct__CCB.html">CCB</a> ), <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a67">TAG_CCB</a>, CcbMaxDepth );
00338     <a class="code" href="../../d2/d8/udfinit_8c.html#a3">PagedInit</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a26">UdfFcbIndexLookasideList</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a19">SIZEOF_FCB_INDEX</a>, <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a72">TAG_FCB_INDEX</a>, FcbIndexMaxDepth );
00339     <a class="code" href="../../d2/d8/udfinit_8c.html#a3">PagedInit</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a27">UdfFcbDataLookasideList</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a18">SIZEOF_FCB_DATA</a>, <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a71">TAG_FCB_DATA</a>, FcbDataMaxDepth );
00340     <a class="code" href="../../d2/d8/udfinit_8c.html#a3">PagedInit</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a28">UdfLcbLookasideList</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a12">SIZEOF_LOOKASIDE_LCB</a>, <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a81">TAG_LCB</a>, LcbMaxDepth );
00341 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
