<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: handle.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>handle.c</h1><a href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    handle.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file manages console and io handles.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 16-Nov-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00022 <span class="preprocessor">#pragma hdrstop</span>
00023 <span class="preprocessor"></span>
00024 <span class="comment">//</span>
00025 <span class="comment">// array of pointers to consoles</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">00028</a> <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>  <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>[<a class="code" href="../../d1/d7/server_8h.html#a54">CONSOLE_INITIAL_CONSOLES</a>];
<a name="l00029"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">00029</a> <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>  *<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>;
<a name="l00030"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">00030</a> ULONG <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>;
00031 
<a name="l00032"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a6">00032</a> CRITICAL_SECTION <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a8">ConsoleHandleLock</a>; <span class="comment">// serializes console handle table access</span>
00033 
<a name="l00034"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a7">00034</a> ULONG <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a7">ConsoleId</a>=47; <span class="comment">// unique number identifying console</span>
00035 
00036 <span class="comment">//</span>
00037 <span class="comment">// Macros to manipulate console handles</span>
00038 <span class="comment">//</span>
00039 
<a name="l00040"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a0">00040</a> <span class="preprocessor">#define HandleFromIndex(i)  ((HANDLE)((i &amp; 0xFFFF) | (ConsoleId++ &lt;&lt; 16)))</span>
<a name="l00041"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define IndexFromHandle(h)  ((USHORT)((ULONG_PTR)h &amp; 0xFFFF))</span>
<a name="l00042"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define ConsoleHandleTableLocked() (ConsoleHandleLock.OwningThread == NtCurrentTeb()-&gt;ClientId.UniqueThread)</span>
00043 <span class="preprocessor"></span>
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00045 <a class="code" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a>(
00046     IN OUT <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00047     IN OUT <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord,
00048     IN HANDLE ProcessHandle
00049     );
00050 
00051 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00052 <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a9">FreeInputHandle</a>(
00053     IN <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData
00054     );
00055 
00056 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00057"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a10">00057</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a10">InitializeConsoleHandleTable</a>( VOID )
00058 
00059 <span class="comment">/*++</span>
00060 <span class="comment"></span>
00061 <span class="comment">Routine Description:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    This routine initializes the global console handle table.</span>
00064 <span class="comment"></span>
00065 <span class="comment">Arguments:</span>
00066 <span class="comment"></span>
00067 <span class="comment">    none.</span>
00068 <span class="comment"></span>
00069 <span class="comment">Return Value:</span>
00070 <span class="comment"></span>
00071 <span class="comment">    none.</span>
00072 <span class="comment"></span>
00073 <span class="comment">--*/</span>
00074 
00075 {
00076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00077 
00078     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a8">ConsoleHandleLock</a>,
00079                                                       0x80000000);
00080 
00081     RtlZeroMemory(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>));
00082     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>;
00083     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a> = <a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>);
00084 
00085     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00086 }
00087 
00088 
00089 <span class="preprocessor">#ifdef DEBUG</span>
00090 <span class="preprocessor"></span>
00091 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00092 <a class="code" href="../../d8/d5/consrv_8h.html#a40">LockConsoleHandleTable</a>( VOID )
00093 
00094 <span class="comment">/*++</span>
00095 <span class="comment"></span>
00096 <span class="comment">Routine Description:</span>
00097 <span class="comment"></span>
00098 <span class="comment">    This routine locks the global console handle table. It also verifies</span>
00099 <span class="comment">    that we're not in the USER critical section. This is necessary to</span>
00100 <span class="comment">    prevent potential deadlocks. This routine is only defined in debug</span>
00101 <span class="comment">    builds.</span>
00102 <span class="comment"></span>
00103 <span class="comment">Arguments:</span>
00104 <span class="comment"></span>
00105 <span class="comment">    none.</span>
00106 <span class="comment"></span>
00107 <span class="comment">Return Value:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    none.</span>
00110 <span class="comment"></span>
00111 <span class="comment">--*/</span>
00112 
00113 {
00114     RtlEnterCriticalSection(&amp;ConsoleHandleLock);
00115 }
00116 
00117 
00118 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00119 <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>( VOID )
00120 
00121 <span class="comment">/*++</span>
00122 <span class="comment"></span>
00123 <span class="comment">Routine Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    This routine unlocks the global console handle table. This routine</span>
00126 <span class="comment">    is only defined in debug builds.</span>
00127 <span class="comment"></span>
00128 <span class="comment">Arguments:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    none.</span>
00131 <span class="comment"></span>
00132 <span class="comment">Return Value:</span>
00133 <span class="comment"></span>
00134 <span class="comment">    none.</span>
00135 <span class="comment"></span>
00136 <span class="comment">--*/</span>
00137 
00138 {
00139     RtlLeaveCriticalSection(&amp;ConsoleHandleLock);
00140 }
00141 
00142 
00143 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00144 <a class="code" href="../../d8/d5/consrv_8h.html#a42">LockConsole</a>(
00145     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00146     )
00147 
00148 <span class="comment">/*++</span>
00149 <span class="comment"></span>
00150 <span class="comment">Routine Description:</span>
00151 <span class="comment"></span>
00152 <span class="comment">    This routine locks the console.This routine is only defined</span>
00153 <span class="comment">    in debug builds.</span>
00154 <span class="comment"></span>
00155 <span class="comment">Arguments:</span>
00156 <span class="comment"></span>
00157 <span class="comment">    none.</span>
00158 <span class="comment"></span>
00159 <span class="comment">Return Value:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    none.</span>
00162 <span class="comment"></span>
00163 <span class="comment">--*/</span>
00164 
00165 {
00166     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00167     RtlEnterCriticalSection(&amp;(Console-&gt;ConsoleLock));
00168     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
00169 }
00170 
00171 <span class="preprocessor">#endif // DEBUG</span>
00172 <span class="preprocessor"></span>
00173 
00174 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00175"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a11">00175</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a11">DereferenceConsoleHandle</a>(
00176     IN HANDLE ConsoleHandle,
00177     OUT <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *Console
00178     )
00179 
00180 <span class="comment">/*++</span>
00181 <span class="comment"></span>
00182 <span class="comment">Routine Description:</span>
00183 <span class="comment"></span>
00184 <span class="comment">    This routine converts a console handle value into a pointer to the</span>
00185 <span class="comment">    console data structure.</span>
00186 <span class="comment"></span>
00187 <span class="comment">Arguments:</span>
00188 <span class="comment"></span>
00189 <span class="comment">    ConsoleHandle - console handle to convert.</span>
00190 <span class="comment"></span>
00191 <span class="comment">    Console - On output, contains pointer to the console data structure.</span>
00192 <span class="comment"></span>
00193 <span class="comment">Return Value:</span>
00194 <span class="comment"></span>
00195 <span class="comment">    none.</span>
00196 <span class="comment"></span>
00197 <span class="comment">Note:</span>
00198 <span class="comment"></span>
00199 <span class="comment">    The console handle table lock must be held when calling this routine.</span>
00200 <span class="comment"></span>
00201 <span class="comment">--*/</span>
00202 
00203 {
00204     ULONG i;
00205 
00206     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00207 
00208     i = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(ConsoleHandle);
00209     <span class="keywordflow">if</span> ((i &gt;= <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>) ||
00210         ((*Console = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i]) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00211         ((*Console)-&gt;ConsoleHandle != ConsoleHandle)) {
00212         *Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00213         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00214     }
00215     <span class="keywordflow">if</span> ((*Console)-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>) {
00216         *Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00217         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00218     }
00219     <span class="keywordflow">return</span> STATUS_SUCCESS;
00220 }
00221 
00222 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00223"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a12">00223</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a12">GrowConsoleHandleTable</a>( VOID )
00224 
00225 <span class="comment">/*++</span>
00226 <span class="comment"></span>
00227 <span class="comment">Routine Description:</span>
00228 <span class="comment"></span>
00229 <span class="comment">    This routine grows the console handle table.</span>
00230 <span class="comment"></span>
00231 <span class="comment">Arguments:</span>
00232 <span class="comment"></span>
00233 <span class="comment">    none</span>
00234 <span class="comment"></span>
00235 <span class="comment">Return Value:</span>
00236 <span class="comment"></span>
00237 <span class="comment">--*/</span>
00238 
00239 {
00240     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *NewTable;
00241     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *OldTable;
00242     ULONG i;
00243     ULONG MaxConsoleHandles;
00244 
00245     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00246 
00247     MaxConsoleHandles = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a> + <a class="code" href="../../d1/d7/server_8h.html#a55">CONSOLE_CONSOLE_HANDLE_INCREMENT</a>;
00248     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MaxConsoleHandles &lt;= 0xFFFF);
00249     NewTable = (<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a14">HANDLE_TAG</a> ),MaxConsoleHandles * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>));
00250     <span class="keywordflow">if</span> (NewTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00251         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00252     }
00253     RtlCopyMemory(NewTable, <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>,
00254                   <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/server_8h.html#a111">PCONSOLE_INFORMATION</a>));
00255     <span class="keywordflow">for</span> (i=<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>;i&lt;MaxConsoleHandles;i++) {
00256         NewTable[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00257     }
00258     OldTable = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>;
00259     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a> = NewTable;
00260     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a> = MaxConsoleHandles;
00261     <span class="keywordflow">if</span> (OldTable != <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>) {
00262         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(OldTable);
00263     }
00264     <span class="keywordflow">return</span> STATUS_SUCCESS;
00265 }
00266 
00267 
00268 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00269"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a13">00269</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a13">AllocateConsoleHandle</a>(
00270     OUT PHANDLE Handle
00271     )
00272 
00273 <span class="comment">/*++</span>
00274 <span class="comment"></span>
00275 <span class="comment">Routine Description:</span>
00276 <span class="comment"></span>
00277 <span class="comment">    This routine allocates a console handle from the global table.</span>
00278 <span class="comment"></span>
00279 <span class="comment">Arguments:</span>
00280 <span class="comment"></span>
00281 <span class="comment">    Handle - Pointer to store handle in.</span>
00282 <span class="comment"></span>
00283 <span class="comment">Return Value:</span>
00284 <span class="comment"></span>
00285 <span class="comment">Note:</span>
00286 <span class="comment"></span>
00287 <span class="comment">    The console handle table lock must be held when calling this routine.</span>
00288 <span class="comment"></span>
00289 <span class="comment">--*/</span>
00290 
00291 {
00292     ULONG i;
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00294 
00295     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00296 
00297     <span class="comment">//</span>
00298     <span class="comment">// have to start allocation at 1 because 0 indicates no console handle</span>
00299     <span class="comment">// in ConDllInitialize.</span>
00300     <span class="comment">//</span>
00301 
00302     <span class="keywordflow">for</span> (i=1;i&lt;<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>;i++) {
00303         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00304             <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] = (<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>) <a class="code" href="../../d1/d7/server_8h.html#a56">CONSOLE_HANDLE_ALLOCATED</a>;
00305             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a0">HandleFromIndex</a>(i);
00306             <span class="keywordflow">return</span> STATUS_SUCCESS;
00307         }
00308     }
00309 
00310     <span class="comment">//</span>
00311     <span class="comment">// grow console handle table</span>
00312     <span class="comment">//</span>
00313 
00314     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a12">GrowConsoleHandleTable</a>();
00315     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00316         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00317     <span class="keywordflow">for</span> ( ;i&lt;<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>;i++) {
00318         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00319             <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] = (<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>) <a class="code" href="../../d1/d7/server_8h.html#a56">CONSOLE_HANDLE_ALLOCATED</a>;
00320             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a0">HandleFromIndex</a>(i);
00321             <span class="keywordflow">return</span> STATUS_SUCCESS;
00322         }
00323     }
00324     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00325     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00326 }
00327 
00328 
00329 
00330 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00331"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a14">00331</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a14">FreeConsoleHandle</a>(
00332     IN HANDLE Handle
00333     )
00334 
00335 <span class="comment">/*++</span>
00336 <span class="comment"></span>
00337 <span class="comment">Routine Description:</span>
00338 <span class="comment"></span>
00339 <span class="comment">    This routine frees a console handle from the global table.</span>
00340 <span class="comment"></span>
00341 <span class="comment">Arguments:</span>
00342 <span class="comment"></span>
00343 <span class="comment">    Handle - Handle to free.</span>
00344 <span class="comment"></span>
00345 <span class="comment">Return Value:</span>
00346 <span class="comment"></span>
00347 <span class="comment">Note:</span>
00348 <span class="comment"></span>
00349 <span class="comment">    The console handle table lock must be held when calling this routine.</span>
00350 <span class="comment"></span>
00351 <span class="comment">--*/</span>
00352 
00353 {
00354     ULONG i;
00355 
00356     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00357 
00358     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00359     i = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00360     <span class="keywordflow">if</span> ((i &gt;= <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>) || (<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00361         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00362     } <span class="keywordflow">else</span> {
00363         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00364     }
00365     <span class="keywordflow">return</span> STATUS_SUCCESS;
00366 }
00367 
00368 
00369 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00370"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a15">00370</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a15">ValidateConsole</a>(
00371     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00372     )
00373 
00374 <span class="comment">/*++</span>
00375 <span class="comment"></span>
00376 <span class="comment">Routine Description:</span>
00377 <span class="comment"></span>
00378 <span class="comment">    This routine ensures that the given console pointer is valid.</span>
00379 <span class="comment"></span>
00380 <span class="comment">Arguments:</span>
00381 <span class="comment"></span>
00382 <span class="comment">    Console - Console pointer to validate.</span>
00383 <span class="comment"></span>
00384 <span class="comment">--*/</span>
00385 
00386 {
00387     ULONG i;
00388 
00389     <span class="keywordflow">if</span> (Console != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00390         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>; i++) {
00391             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] == Console)
00392                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00393         }
00394     }
00395     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00396 }
00397 
00398 
00399 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00400"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a16">00400</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a16">InitializeIoHandleTable</a>(
00401     IN OUT <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00402     OUT <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
00403     OUT PHANDLE StdIn,
00404     OUT PHANDLE StdOut,
00405     OUT PHANDLE StdErr
00406     )
00407 
00408 <span class="comment">/*++</span>
00409 <span class="comment"></span>
00410 <span class="comment">Routine Description:</span>
00411 <span class="comment"></span>
00412 <span class="comment">    This routine initializes a process's handle table for the first</span>
00413 <span class="comment">    time (there is no parent process).  It also sets up stdin, stdout,</span>
00414 <span class="comment">    and stderr.</span>
00415 <span class="comment"></span>
00416 <span class="comment">Arguments:</span>
00417 <span class="comment"></span>
00418 <span class="comment">    Console - Pointer to console information structure.</span>
00419 <span class="comment"></span>
00420 <span class="comment">    ProcessData - Pointer to per process data structure.</span>
00421 <span class="comment"></span>
00422 <span class="comment">    Stdin - Pointer in which to return StdIn handle.</span>
00423 <span class="comment"></span>
00424 <span class="comment">    StdOut - Pointer in which to return StdOut handle.</span>
00425 <span class="comment"></span>
00426 <span class="comment">    StdErr - Pointer in which to return StdErr handle.</span>
00427 <span class="comment"></span>
00428 <span class="comment">Return Value:</span>
00429 <span class="comment"></span>
00430 <span class="comment">--*/</span>
00431 
00432 {
00433     ULONG i;
00434     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00435     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00436     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00437 
00438     <span class="comment">// HandleTablePtr gets set up by ConsoleAddProcessRoutine.</span>
00439     <span class="comment">// it will be != to HandleTable if the new process was created</span>
00440     <span class="comment">// using "start xxx" at the command line and cmd.exe has &gt;</span>
00441     <span class="comment">// CONSOLE_INITIAL_IO_HANDLES.</span>
00442 
00443     <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr != ProcessData-&gt;HandleTable) {
00444         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>);
00445         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr);
00446         ProcessData-&gt;HandleTablePtr = ProcessData-&gt;HandleTable;
00447     }
00448 
00449     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;i++) {
00450         ProcessData-&gt;HandleTable[i].HandleType = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00451     }
00452 
00453     ProcessData-&gt;HandleTableSize = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
00454     ProcessData-&gt;Foo = 0xF00;
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// set up stdin, stdout, stderr.  we don't do any cleanup in case</span>
00458     <span class="comment">// of errors because we're going to fail the console creation.</span>
00459     <span class="comment">//</span>
00460     <span class="comment">// stdin</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
00464                               <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>,
00465                               &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00466                              );
00467     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00468         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00469     }
00470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00471                                  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00472                                  &amp;HandleData
00473                                 );
00474     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00475     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00476         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00477     }
00478     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a27">InitializeInputHandle</a>(HandleData,
00479                                &amp;Console-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o4">InputBuffer</a>)) {
00480         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00481     }
00482     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
00483     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(GENERIC_READ | GENERIC_WRITE,
00484                              FILE_SHARE_READ | FILE_SHARE_WRITE,
00485                              &amp;Console-&gt;InputBuffer.ShareAccess,
00486                              HandleData
00487                             );
00488     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00489     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00490         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00491     }
00492     *StdIn = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// stdout</span>
00496     <span class="comment">//</span>
00497 
00498     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
00499                               <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
00500                               &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00501                              );
00502     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00503         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00504     }
00505     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00506                                  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00507                                  &amp;HandleData
00508                                 );
00509     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00510     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00511         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00512     }
00513     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a>(HandleData,Console-&gt;CurrentScreenBuffer);
00514     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
00515     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(GENERIC_READ | GENERIC_WRITE,
00516                              FILE_SHARE_READ | FILE_SHARE_WRITE,
00517                              &amp;Console-&gt;ScreenBuffers-&gt;ShareAccess,
00518                              HandleData
00519                             );
00520     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00521     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00522         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00523     }
00524     *StdOut = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">// stderr</span>
00528     <span class="comment">//</span>
00529 
00530     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
00531                               <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
00532                               &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00533                              );
00534     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00535         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00536     }
00537     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00538                                  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00539                                  &amp;HandleData
00540                                 );
00541     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00542     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00543         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00544     }
00545     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a>(HandleData,Console-&gt;CurrentScreenBuffer);
00546     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
00547     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(GENERIC_READ | GENERIC_WRITE,
00548                              FILE_SHARE_READ | FILE_SHARE_WRITE,
00549                              &amp;Console-&gt;ScreenBuffers-&gt;ShareAccess,
00550                              HandleData
00551                             );
00552     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00553     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00554         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00555     }
00556     *StdErr = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00557     <span class="keywordflow">return</span> STATUS_SUCCESS;
00558 }
00559 
00560 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00561"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a17">00561</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a17">InheritIoHandleTable</a>(
00562     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00563     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
00564     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ParentProcessData
00565     )
00566 
00567 <span class="comment">/*++</span>
00568 <span class="comment"></span>
00569 <span class="comment">Routine Description:</span>
00570 <span class="comment"></span>
00571 <span class="comment">    This routine creates a process's handle table from the parent</span>
00572 <span class="comment">    process's handle table.  ProcessData contains the process data</span>
00573 <span class="comment">    copied directly from the parent to the child process by CSR.</span>
00574 <span class="comment">    This routine allocates a new handle table, if necessary, then</span>
00575 <span class="comment">    invalidates non-inherited handles and increments the sharing</span>
00576 <span class="comment">    and reference counts for inherited handles.</span>
00577 <span class="comment"></span>
00578 <span class="comment">Arguments:</span>
00579 <span class="comment"></span>
00580 <span class="comment">    ProcessData - Pointer to per process data structure.</span>
00581 <span class="comment"></span>
00582 <span class="comment">Return Value:</span>
00583 <span class="comment"></span>
00584 <span class="comment">Note:</span>
00585 <span class="comment"></span>
00586 <span class="comment">    The console lock must be held when calling this routine.</span>
00587 <span class="comment"></span>
00588 <span class="comment">--*/</span>
00589 
00590 {
00591     ULONG i;
00592     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">// Copy handles from parent process.  If the table size</span>
00596     <span class="comment">// is CONSOLE_INITIAL_IO_HANDLES, CSR has done the copy</span>
00597     <span class="comment">// for us.</span>
00598     <span class="comment">//</span>
00599 
00600     UNREFERENCED_PARAMETER(Console);
00601 
00602     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentProcessData-&gt;Foo == 0xF00);
00603     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentProcessData-&gt;HandleTableSize != 0);
00604     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentProcessData-&gt;HandleTableSize &lt;= 0x0000FFFF);
00605 
00606     <span class="keywordflow">if</span> (ParentProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>) {
00607         ProcessData-&gt;HandleTableSize = ParentProcessData-&gt;HandleTableSize;
00608         ProcessData-&gt;HandleTablePtr = (<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a14">HANDLE_TAG</a> ),ProcessData-&gt;HandleTableSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">HANDLE_DATA</a>));
00609 
00610         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00611             ProcessData-&gt;HandleTablePtr = ProcessData-&gt;HandleTable;
00612             ProcessData-&gt;HandleTableSize = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
00613             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00614         }
00615         RtlCopyMemory(ProcessData-&gt;HandleTablePtr,
00616             ParentProcessData-&gt;HandleTablePtr,
00617             ProcessData-&gt;HandleTableSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/server_8h.html#a112">HANDLE_DATA</a>));
00618     }
00619 
00620     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>));
00621 
00622     <span class="comment">//</span>
00623     <span class="comment">// Allocate any memory associated with each handle.</span>
00624     <span class="comment">//</span>
00625 
00626     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00627     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
00628 
00629         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; ProcessData-&gt;HandleTablePtr[i].HandleType &amp; <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>) {
00630 
00631             <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
00632                 ProcessData-&gt;HandleTablePtr[i].InputReadData = (<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html">PINPUT_READ_HANDLE_DATA</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a14">HANDLE_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html">INPUT_READ_HANDLE_DATA</a>));
00633                 <span class="keywordflow">if</span> (!ProcessData-&gt;HandleTablePtr[i].InputReadData) {
00634                     ProcessData-&gt;HandleTablePtr[i].HandleType = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00635                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00636                     <span class="keywordflow">continue</span>;
00637                 }
00638                 ProcessData-&gt;HandleTablePtr[i].InputReadData-&gt;InputHandleFlags = 0;
00639                 ProcessData-&gt;HandleTablePtr[i].InputReadData-&gt;ReadCount = 0;
00640                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;ProcessData-&gt;HandleTablePtr[i].InputReadData-&gt;ReadCountLock);
00641                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00642                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr[i].InputReadData);
00643                     ProcessData-&gt;HandleTablePtr[i].InputReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00644                     ProcessData-&gt;HandleTablePtr[i].HandleType = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00645                     <span class="keywordflow">continue</span>;
00646                 }
00647             }
00648         }
00649         <span class="keywordflow">else</span> {
00650             ProcessData-&gt;HandleTablePtr[i].HandleType = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00651         }
00652     }
00653 
00654     <span class="comment">//</span>
00655     <span class="comment">// If something failed, we need to free any input data we allocated and</span>
00656     <span class="comment">// free the handle table.</span>
00657     <span class="comment">//</span>
00658 
00659     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00660         <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
00661             <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
00662                 <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a9">FreeInputHandle</a>(&amp;ProcessData-&gt;HandleTablePtr[i]);
00663             }
00664         }
00665         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>) {
00666             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr);
00667             ProcessData-&gt;HandleTablePtr = ProcessData-&gt;HandleTable;
00668             ProcessData-&gt;HandleTableSize = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
00669         }
00670         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00671     }
00672 
00673     <span class="comment">//</span>
00674     <span class="comment">// All the memory allocations succeeded. Now go through and increment the</span>
00675     <span class="comment">// object reference counts and dup the shares.</span>
00676     <span class="comment">//</span>
00677 
00678     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
00679         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType != <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) {
00680             <a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html">PCONSOLE_SHARE_ACCESS</a> ShareAccess;
00681 
00682             <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
00683                 ProcessData-&gt;HandleTablePtr[i].Buffer.InputBuffer-&gt;RefCount++;
00684                 ShareAccess = &amp;ProcessData-&gt;HandleTablePtr[i].Buffer.InputBuffer-&gt;ShareAccess;
00685             }
00686             <span class="keywordflow">else</span> {
00687                 ProcessData-&gt;HandleTablePtr[i].Buffer.ScreenBuffer-&gt;RefCount++;
00688                 ShareAccess = &amp;ProcessData-&gt;HandleTablePtr[i].Buffer.ScreenBuffer-&gt;ShareAccess;
00689             }
00690 
00691             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a1">ConsoleDupShare</a>(ProcessData-&gt;HandleTablePtr[i].Access,
00692                                      ProcessData-&gt;HandleTablePtr[i].ShareAccess,
00693                                      ShareAccess,
00694                                      &amp;ProcessData-&gt;HandleTablePtr[i]
00695                                     );
00696             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00697         }
00698     }
00699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;Foo == 0xF00);
00700 
00701     <span class="keywordflow">return</span> STATUS_SUCCESS;
00702 }
00703 
00704 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00705"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a18">00705</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a18">ConsoleAddProcessRoutine</a>(
00706     IN PCSR_PROCESS ParentProcess,
00707     IN PCSR_PROCESS Process
00708     )
00709 {
00710     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, ParentProcessData;
00711     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00712     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
00713     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00714     ULONG i;
00715 
00716     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
00717     ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o4">HandleTablePtr</a> = ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o1">HandleTable</a>;
00718     ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o2">HandleTableSize</a> = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
00719     <a class="code" href="../../d1/d7/server_8h.html#a88">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00720 
00721     <span class="keywordflow">if</span> (ParentProcess) {
00722 
00723         ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o6">RootProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00724         ParentProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(ParentProcess);
00725 
00726         <span class="comment">//</span>
00727         <span class="comment">// If both the parent and new processes are console apps,</span>
00728         <span class="comment">// inherit handles from the parent process.</span>
00729         <span class="comment">//</span>
00730 
00731         <span class="keywordflow">if</span> (ParentProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00732                 (Process-&gt;Flags &amp; CSR_PROCESS_CONSOLEAPP)) {
00733             <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ParentProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a>,
00734                                                &amp;Console)))) {
00735                 ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00736                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00737             }
00738 
00739             <span class="comment">//</span>
00740             <span class="comment">// Don't add the process if the console is being shutdown.</span>
00741             <span class="comment">//</span>
00742 
00743             <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>) {
00744                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00745             } <span class="keywordflow">else</span> {
00746                 ProcessHandleRecord = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a14">HANDLE_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>));
00747                 <span class="keywordflow">if</span> (ProcessHandleRecord == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00748                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00749                 } <span class="keywordflow">else</span> {
00750 
00751                     <span class="comment">//</span>
00752                     <span class="comment">// duplicate parent's handle table</span>
00753                     <span class="comment">//</span>
00754 
00755                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o3">Foo</a> == 0xF00);
00756                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a17">InheritIoHandleTable</a>(Console, ProcessData, ParentProcessData);
00757                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00758                         ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a> = Process;
00759                         ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00760                         ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00761                         <a class="code" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a>(Console,ProcessHandleRecord,Process-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a>);
00762 
00763                         <span class="comment">//</span>
00764                         <span class="comment">// increment console reference count</span>
00765                         <span class="comment">//</span>
00766 
00767                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>++;
00768                     } <span class="keywordflow">else</span> {
00769                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleRecord);
00770                     }
00771                 }
00772             }
00773             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00774                 ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00775                 <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;i++) {
00776                     ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o1">HandleTable</a>[i].<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00777                 }
00778             }
00779             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00780         } <span class="keywordflow">else</span>
00781             ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00782     } <span class="keywordflow">else</span> {
00783         ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00784     }
00785     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00786 }
00787 
00788 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00789"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a19">00789</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a19">AllocateConsole</a>(
00790     IN HANDLE ConsoleHandle,
00791     IN LPWSTR Title,
00792     IN USHORT TitleLength,
00793     IN HANDLE ClientProcessHandle,
00794     OUT PHANDLE StdIn,
00795     OUT PHANDLE StdOut,
00796     OUT PHANDLE StdErr,
00797     OUT <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
00798     IN OUT <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo,
00799     IN BOOLEAN WindowVisible,
00800     IN DWORD dwConsoleThreadId
00801     )
00802 
00803 <span class="comment">/*++</span>
00804 <span class="comment"></span>
00805 <span class="comment">Routine Description:</span>
00806 <span class="comment"></span>
00807 <span class="comment">    This routine allocates and initialized a console and its associated</span>
00808 <span class="comment">    data - input buffer and screen buffer.</span>
00809 <span class="comment"></span>
00810 <span class="comment">Arguments:</span>
00811 <span class="comment"></span>
00812 <span class="comment">    ConsoleHandle - Handle of console to allocate.</span>
00813 <span class="comment"></span>
00814 <span class="comment">    dwWindowSize - Initial size of screen buffer window, in rows and columns.</span>
00815 <span class="comment"></span>
00816 <span class="comment">    nFont - Initial number of font text is displayed in.</span>
00817 <span class="comment"></span>
00818 <span class="comment">    dwScreenBufferSize - Initial size of screen buffer, in rows and columns.</span>
00819 <span class="comment"></span>
00820 <span class="comment">    nInputBufferSize - Initial size of input buffer, in events.</span>
00821 <span class="comment"></span>
00822 <span class="comment">    dwWindowFlags -</span>
00823 <span class="comment"></span>
00824 <span class="comment">    StdIn - On return, contains handle to stdin.</span>
00825 <span class="comment"></span>
00826 <span class="comment">    StdOut - On return, contains handle to stdout.</span>
00827 <span class="comment"></span>
00828 <span class="comment">    StdErr - On return, contains handle to stderr.</span>
00829 <span class="comment"></span>
00830 <span class="comment">    ProcessData - On return, contains the initialized per-process data.</span>
00831 <span class="comment"></span>
00832 <span class="comment">Return Value:</span>
00833 <span class="comment"></span>
00834 <span class="comment">Note:</span>
00835 <span class="comment"></span>
00836 <span class="comment">    The console handle table lock must be held when calling this routine.</span>
00837 <span class="comment"></span>
00838 <span class="comment">--*/</span>
00839 
00840 {
00841     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00842     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00843     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
00844 
00845     <span class="comment">//</span>
00846     <span class="comment">// allocate console data</span>
00847     <span class="comment">//</span>
00848 
00849     Console = (<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a15">CONSOLE_TAG</a> ) | HEAP_ZERO_MEMORY,
00850                                               <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">CONSOLE_INFORMATION</a>));
00851     <span class="keywordflow">if</span> (Console == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00852         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00853     }
00854     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(ConsoleHandle)] = Console;
00855 
00856     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> = WindowVisible ? 0 : <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>;
00857     Console-&gt;hIcon = ConsoleInfo-&gt;hIcon;
00858     Console-&gt;hSmIcon = ConsoleInfo-&gt;hSmIcon;
00859     Console-&gt;iIconId = ConsoleInfo-&gt;iIconId;
00860     Console-&gt;dwHotKey = ConsoleInfo-&gt;dwHotKey;
00861 <span class="preprocessor">#if !defined(FE_SB)</span>
00862 <span class="preprocessor"></span>    Console-&gt;CP = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
00863     Console-&gt;OutputCP = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a22">ConsoleOutputCP</a>;
00864 <span class="preprocessor">#endif</span>
00865 <span class="preprocessor"></span>    Console-&gt;ReserveKeys = CONSOLE_NOSHORTCUTKEY;
00866     Console-&gt;ConsoleHandle = ConsoleHandle;
00867     Console-&gt;bIconInit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00868     Console-&gt;VerticalClientToWindow = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a>;
00869     Console-&gt;HorizontalClientToWindow = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a>;
00870 <span class="preprocessor">#if defined(FE_SB)</span>
00871 <span class="preprocessor"></span>    SetConsoleCPInfo(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00872     SetConsoleCPInfo(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00873 <span class="preprocessor">#endif</span>
00874 <span class="preprocessor"></span>
00875     <span class="comment">//</span>
00876     <span class="comment">// must wait for window to be destroyed or client impersonation won't</span>
00877     <span class="comment">// work.</span>
00878     <span class="comment">//</span>
00879 
00880     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(),
00881                               <a class="code" href="../../d1/d7/server_8h.html#a78">CONSOLE_CLIENTTHREADHANDLE</a>(CSR_SERVER_QUERYCLIENTTHREAD()),
00882                               NtCurrentProcess(),
00883                               &amp;Console-&gt;ClientThreadHandle,
00884                               0,
00885                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00886                               DUPLICATE_SAME_ACCESS
00887                              );
00888     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00889         <span class="keywordflow">goto</span> ErrorExit5;
00890     }
00891 
00892 <span class="preprocessor">#if DBG</span>
00893 <span class="preprocessor"></span>    <span class="comment">//</span>
00894     <span class="comment">// Make sure the handle isn't protected so we can close it later</span>
00895     <span class="comment">//</span>
00896     <a class="code" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle</a>(Console-&gt;ClientThreadHandle);
00897 <span class="preprocessor">#endif // DBG</span>
00898 <span class="preprocessor"></span>
00899     InitializeListHead(&amp;Console-&gt;OutputQueue);
00900     InitializeListHead(&amp;Console-&gt;ProcessHandleList);
00901     InitializeListHead(&amp;Console-&gt;ExeAliasList);
00902     InitializeListHead(&amp;Console-&gt;MessageQueue);
00903 
00904     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>],
00905                            EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00906     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00907         <span class="keywordflow">goto</span> ErrorExit4a;
00908     }
00909     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>],
00910                            EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00911     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00912         <span class="keywordflow">goto</span> ErrorExit4;
00913     }
00914     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;Console-&gt;ConsoleLock);
00915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00916         <span class="keywordflow">goto</span> ErrorExit3a;
00917     }
00918     <a class="code" href="../../d8/d5/consrv_8h.html#a239">InitializeConsoleCommandData</a>(Console);
00919 
00920     <span class="comment">//</span>
00921     <span class="comment">// initialize input buffer</span>
00922     <span class="comment">//</span>
00923 
00924 <span class="preprocessor">#if defined(FE_SB)</span>
00925 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a16">CreateInputBuffer</a>(ConsoleInfo-&gt;nInputBufferSize,
00926                                &amp;Console-&gt;InputBuffer,
00927                                Console);
00928 <span class="preprocessor">#else</span>
00929 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a16">CreateInputBuffer</a>(ConsoleInfo-&gt;nInputBufferSize,
00930                                &amp;Console-&gt;InputBuffer);
00931 <span class="preprocessor">#endif</span>
00932 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00933         <span class="keywordflow">goto</span> ErrorExit3;
00934     }
00935 
00936     Console-&gt;Title = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a13">TITLE_TAG</a> ),TitleLength+<span class="keyword">sizeof</span>(WCHAR));
00937     <span class="keywordflow">if</span> (Console-&gt;Title == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00939         <span class="keywordflow">goto</span> ErrorExit2;
00940     }
00941     RtlCopyMemory(Console-&gt;Title,Title,TitleLength);
00942     Console-&gt;Title[TitleLength/<span class="keyword">sizeof</span>(WCHAR)] = (WCHAR)0;   <span class="comment">// NULL terminate</span>
00943     Console-&gt;TitleLength = TitleLength;
00944 
00945     Console-&gt;OriginalTitle = <a class="code" href="../../d0/d5/srvinit_8c.html#a42">TranslateConsoleTitle</a>(Console-&gt;Title, &amp;Console-&gt;OriginalTitleLength, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00946     <span class="keywordflow">if</span> (Console-&gt;OriginalTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00947         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00948         <span class="keywordflow">goto</span> ErrorExit1;
00949     }
00950 
00951     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;Console-&gt;TerminationEvent,
00952                            EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00953     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00954         <span class="keywordflow">goto</span> ErrorExit1a;
00955     }
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">// initialize screen buffer. we don't call OpenConsole to do this</span>
00959     <span class="comment">// because we need to specify the font, windowsize, etc.</span>
00960     <span class="comment">//</span>
00961 
00962     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a41">DoCreateScreenBuffer</a>(Console,
00963                                   ConsoleInfo);
00964     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)){
00965         <span class="keywordflow">goto</span> ErrorExit1b;
00966     }
00967 
00968 
00969     Console-&gt;CurrentScreenBuffer = Console-&gt;ScreenBuffers;
00970 <span class="preprocessor">#if defined(FE_SB)</span>
00971 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_IME)</span>
00972 <span class="preprocessor"></span>    SetUndetermineAttribute(Console) ;
00973 <span class="preprocessor">#endif</span>
00974 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d7/eudc_8h.html#a3">CreateEUDC</a>(Console);
00975     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)){
00976         <span class="keywordflow">goto</span> ErrorExit1c;
00977     }
00978 <span class="preprocessor">#endif</span>
00979 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a16">InitializeIoHandleTable</a>(Console,
00980                                      ProcessData,
00981                                      StdIn,
00982                                      StdOut,
00983                                      StdErr
00984                                     );
00985     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00986         <span class="keywordflow">goto</span> ErrorExit0;
00987     }
00988 
00989     <span class="comment">//</span>
00990     <span class="comment">// map event handles</span>
00991     <span class="comment">//</span>
00992 
00993     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(ClientProcessHandle,
00994                    Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>],
00995                    &amp;ConsoleInfo-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>]
00996                   )) {
00997         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00998         <span class="keywordflow">goto</span> ErrorExit0;
00999     }
01000     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(ClientProcessHandle,
01001                    Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>],
01002                    &amp;ConsoleInfo-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>]
01003                   )) {
01004         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01005         <span class="keywordflow">goto</span> ErrorExit0;
01006     }
01007     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(ClientProcessHandle,
01008                    Console-&gt;InputBuffer.InputWaitEvent,
01009                    &amp;ConsoleInfo-&gt;InputWaitHandle
01010                   )) {
01011         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01012         <span class="keywordflow">goto</span> ErrorExit0;
01013     }
01014 
01015     Success = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>,
01016                                 <a class="code" href="../../d1/d7/server_8h.html#a67">CM_CREATE_CONSOLE_WINDOW</a>,
01017                                 (WPARAM)ConsoleHandle,
01018                                 (LPARAM)ClientProcessHandle
01019                                );
01020     <span class="keywordflow">if</span> (!Success) {
01021         KdPrint((<span class="stringliteral">"CONSRV: PostThreadMessage failed %d\n"</span>,GetLastError()));
01022         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01023         <span class="keywordflow">goto</span> ErrorExit0;
01024     }
01025 
01026     <span class="keywordflow">return</span> STATUS_SUCCESS;
01027 
01028 ErrorExit0: Console-&gt;ScreenBuffers-&gt;RefCount = 0;
01029 <span class="preprocessor">#if defined(FE_SB)</span>
01030 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Console-&gt;EudcInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01031                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;EudcInformation);
01032             }
01033 ErrorExit1c:
01034 <span class="preprocessor">#endif</span>
01035 <span class="preprocessor"></span>            <a class="code" href="../../d6/d2/output_8c.html#a46">FreeScreenBuffer</a>(Console-&gt;ScreenBuffers);
01036 ErrorExit1b: <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;TerminationEvent);
01037 ErrorExit1a: <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;OriginalTitle);
01038 ErrorExit1: <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;Title);
01039 ErrorExit2: Console-&gt;InputBuffer.RefCount = 0;
01040             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a18">FreeInputBuffer</a>(&amp;Console-&gt;InputBuffer);
01041 ErrorExit3: <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;Console-&gt;ConsoleLock);
01042 
01043 ErrorExit3a: <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>]);
01044 ErrorExit4: <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>]);
01045 ErrorExit4a: <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;ClientThreadHandle);
01046 ErrorExit5:  <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console);
01047     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01048 }
01049 
01050 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01051"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a20">01051</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a20">DestroyConsole</a>(
01052     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
01053     )
01054 
01055 <span class="comment">/*++</span>
01056 <span class="comment"></span>
01057 <span class="comment">Routine Description:</span>
01058 <span class="comment"></span>
01059 <span class="comment">    This routine frees a console structure if it's not being referenced.</span>
01060 <span class="comment"></span>
01061 <span class="comment">Arguments:</span>
01062 <span class="comment"></span>
01063 <span class="comment">    Console - Console to free.</span>
01064 <span class="comment"></span>
01065 <span class="comment">Return Value:</span>
01066 <span class="comment"></span>
01067 <span class="comment"></span>
01068 <span class="comment">--*/</span>
01069 
01070 {
01071     HANDLE ConsoleHandle = Console-&gt;ConsoleHandle;
01072 
01073     <span class="comment">//</span>
01074     <span class="comment">// Make sure we have the console locked and it really is going away.</span>
01075     <span class="comment">//</span>
01076 
01077     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
01078     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;hWnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01079 
01080     <span class="comment">//</span>
01081     <span class="comment">// Mark this console as being destroyed.</span>
01082     <span class="comment">//</span>
01083 
01084     Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a22">CONSOLE_IN_DESTRUCTION</a>;
01085 
01086     <span class="comment">//</span>
01087     <span class="comment">// Unlock this console.</span>
01088     <span class="comment">//</span>
01089 
01090     RtlLeaveCriticalSection(&amp;Console-&gt;ConsoleLock);
01091 
01092     <span class="comment">//</span>
01093     <span class="comment">// If the console still exists and no one is waiting on it, free it.</span>
01094     <span class="comment">//</span>
01095 
01096     <a class="code" href="../../d8/d5/consrv_8h.html#a40">LockConsoleHandleTable</a>();
01097     <span class="keywordflow">if</span> (Console == <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(ConsoleHandle)] &amp;&amp;
01098         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a> == ConsoleHandle &amp;&amp;
01099         Console-&gt;ConsoleLock.OwningThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01100         Console-&gt;WaitCount == 0) {
01101 
01102         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a14">FreeConsoleHandle</a>(ConsoleHandle);
01103         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;Console-&gt;ConsoleLock);
01104         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console);
01105     }
01106     <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01107 }
01108 
01109 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01110"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a21">01110</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a21">FreeCon</a>(
01111     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
01112     )
01113 
01114 <span class="comment">/*++</span>
01115 <span class="comment"></span>
01116 <span class="comment">Routine Description:</span>
01117 <span class="comment"></span>
01118 <span class="comment">    This routine frees a console and its associated</span>
01119 <span class="comment">    data - input buffer and screen buffer.</span>
01120 <span class="comment"></span>
01121 <span class="comment">Arguments:</span>
01122 <span class="comment"></span>
01123 <span class="comment">    ConsoleHandle - Handle of console to free.</span>
01124 <span class="comment"></span>
01125 <span class="comment">Return Value:</span>
01126 <span class="comment"></span>
01127 <span class="comment">Note:</span>
01128 <span class="comment"></span>
01129 <span class="comment">    The console handle table lock must be held when calling this routine.</span>
01130 <span class="comment"></span>
01131 <span class="comment">--*/</span>
01132 
01133 {
01134     HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
01135 
01136     Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>;
01137     <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(Console-&gt;TerminationEvent,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01138     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = Console-&gt;hWnd;
01139 
01140     <span class="comment">//</span>
01141     <span class="comment">// Wait 10 seconds or until the input thread replies</span>
01142     <span class="comment">// to synchronize the window destruction with</span>
01143     <span class="comment">// the termination of the thread</span>
01144     <span class="comment">//</span>
01145 
01146     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01147         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01148         <a class="code" href="../../d5/d9/cltxt_8h.html#a17">SendMessageTimeout</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d1/d7/server_8h.html#a68">CM_DESTROY_WINDOW</a>, 0, 0, SMTO_BLOCK, 10000, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01149     } <span class="keywordflow">else</span> {
01150         <a class="code" href="../../d6/d2/output_8c.html#a79">AbortCreateConsole</a>(Console);
01151     }
01152 }
01153 
01154 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01155"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a22">01155</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a22">InsertScreenBuffer</a>(
01156     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01157     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
01158     )
01159 
01160 <span class="comment">/*++</span>
01161 <span class="comment"></span>
01162 <span class="comment">Routine Description:</span>
01163 <span class="comment"></span>
01164 <span class="comment">    This routine inserts the screen buffer pointer into the console's</span>
01165 <span class="comment">    list of screen buffers.</span>
01166 <span class="comment"></span>
01167 <span class="comment">Arguments:</span>
01168 <span class="comment"></span>
01169 <span class="comment">    Console - Pointer to console information structure.</span>
01170 <span class="comment"></span>
01171 <span class="comment">    ScreenInfo - Pointer to screen information structure.</span>
01172 <span class="comment"></span>
01173 <span class="comment">Return Value:</span>
01174 <span class="comment"></span>
01175 <span class="comment">Note:</span>
01176 <span class="comment"></span>
01177 <span class="comment">    The console lock must be held when calling this routine.</span>
01178 <span class="comment"></span>
01179 <span class="comment">--*/</span>
01180 
01181 {
01182     ScreenInfo-&gt;Next = Console-&gt;ScreenBuffers;
01183     Console-&gt;ScreenBuffers = ScreenInfo;
01184 }
01185 
01186 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01187"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a23">01187</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a23">RemoveScreenBuffer</a>(
01188     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01189     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
01190     )
01191 
01192 <span class="comment">/*++</span>
01193 <span class="comment"></span>
01194 <span class="comment">Routine Description:</span>
01195 <span class="comment"></span>
01196 <span class="comment">    This routine removes the screen buffer pointer from the console's</span>
01197 <span class="comment">    list of screen buffers.</span>
01198 <span class="comment"></span>
01199 <span class="comment">Arguments:</span>
01200 <span class="comment"></span>
01201 <span class="comment">    Console - Pointer to console information structure.</span>
01202 <span class="comment"></span>
01203 <span class="comment">    ScreenInfo - Pointer to screen information structure.</span>
01204 <span class="comment"></span>
01205 <span class="comment">Return Value:</span>
01206 <span class="comment"></span>
01207 <span class="comment">Note:</span>
01208 <span class="comment"></span>
01209 <span class="comment">    The console lock must be held when calling this routine.</span>
01210 <span class="comment"></span>
01211 <span class="comment">--*/</span>
01212 
01213 {
01214     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> Prev,Cur;
01215 
01216     <span class="keywordflow">if</span> (ScreenInfo == Console-&gt;ScreenBuffers) {
01217         Console-&gt;ScreenBuffers = ScreenInfo-&gt;Next;
01218         <span class="keywordflow">return</span>;
01219     }
01220     Prev = Cur = Console-&gt;ScreenBuffers;
01221     <span class="keywordflow">while</span> (Cur != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01222         <span class="keywordflow">if</span> (ScreenInfo == Cur)
01223             <span class="keywordflow">break</span>;
01224         Prev = Cur;
01225         Cur = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>;
01226     }
01227     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Cur != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01228     <span class="keywordflow">if</span> (Cur != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01229         Prev-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a> = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>;
01230     }
01231 }
01232 
01233 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01234"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a24">01234</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a24">GrowIoHandleTable</a>(
01235     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData
01236     )
01237 
01238 <span class="comment">/*++</span>
01239 <span class="comment"></span>
01240 <span class="comment">Routine Description:</span>
01241 <span class="comment"></span>
01242 <span class="comment">    This routine grows the per-process io handle table.</span>
01243 <span class="comment"></span>
01244 <span class="comment">Arguments:</span>
01245 <span class="comment"></span>
01246 <span class="comment">    ProcessData - Pointer to the per-process data structure.</span>
01247 <span class="comment"></span>
01248 <span class="comment">Return Value:</span>
01249 <span class="comment"></span>
01250 <span class="comment">--*/</span>
01251 
01252 {
01253     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> NewTable;
01254     ULONG i;
01255     ULONG MaxFileHandles;
01256 
01257     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;Foo == 0xF00);
01258     MaxFileHandles = ProcessData-&gt;HandleTableSize + <a class="code" href="../../d1/d7/server_8h.html#a46">CONSOLE_IO_HANDLE_INCREMENT</a>;
01259     NewTable = (<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a14">HANDLE_TAG</a> ),MaxFileHandles * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">HANDLE_DATA</a>));
01260     <span class="keywordflow">if</span> (NewTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01261         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01262     }
01263     RtlCopyMemory(NewTable, ProcessData-&gt;HandleTablePtr,
01264                   ProcessData-&gt;HandleTableSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/server_8h.html#a112">HANDLE_DATA</a>));
01265     <span class="keywordflow">for</span> (i=ProcessData-&gt;HandleTableSize;i&lt;MaxFileHandles;i++) {
01266         NewTable[i].<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
01267     }
01268     <span class="keywordflow">if</span> (ProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>) {
01269         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr);
01270     }
01271     ProcessData-&gt;HandleTablePtr = NewTable;
01272     ProcessData-&gt;HandleTableSize = MaxFileHandles;
01273     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;Foo == 0xF00);
01274     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;HandleTableSize != 0);
01275     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;HandleTableSize &lt;= 0x0000FFFF);
01276     <span class="keywordflow">return</span> STATUS_SUCCESS;
01277 }
01278 
01279 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01280"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a25">01280</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a25">FreeProcessData</a>(
01281     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData
01282     )
01283 
01284 <span class="comment">/*++</span>
01285 <span class="comment"></span>
01286 <span class="comment">Routine Description:</span>
01287 <span class="comment"></span>
01288 <span class="comment">    This routine frees any per-process data allocated by the console.</span>
01289 <span class="comment"></span>
01290 <span class="comment">Arguments:</span>
01291 <span class="comment"></span>
01292 <span class="comment">    ProcessData - Pointer to the per-process data structure.</span>
01293 <span class="comment"></span>
01294 <span class="comment">Return Value:</span>
01295 <span class="comment"></span>
01296 <span class="comment">--*/</span>
01297 
01298 {
01299     <span class="keywordflow">if</span> (ProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>) {
01300         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr);
01301         ProcessData-&gt;HandleTablePtr = ProcessData-&gt;HandleTable;
01302         ProcessData-&gt;HandleTableSize = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
01303     }
01304 }
01305 
01306 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01307"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">01307</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a>(
01308     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData,
01309     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenBuffer
01310     )
01311 
01312 <span class="comment">/*++</span>
01313 <span class="comment"></span>
01314 <span class="comment">Routine Description:</span>
01315 <span class="comment"></span>
01316 <span class="comment">    This routine initializes the output-specific fields of the handle data</span>
01317 <span class="comment">    structure.</span>
01318 <span class="comment"></span>
01319 <span class="comment">Arguments:</span>
01320 <span class="comment"></span>
01321 <span class="comment">    HandleData - Pointer to handle data structure.</span>
01322 <span class="comment"></span>
01323 <span class="comment">    ScreenBuffer - Pointer to screen buffer data structure.</span>
01324 <span class="comment"></span>
01325 <span class="comment">Return Value:</span>
01326 <span class="comment"></span>
01327 <span class="comment">--*/</span>
01328 
01329 {
01330     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer = ScreenBuffer;
01331     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;RefCount++;
01332 }
01333 
01334 BOOLEAN
<a name="l01335"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a27">01335</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a27">InitializeInputHandle</a>(
01336     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData,
01337     <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputBuffer
01338     )
01339 
01340 <span class="comment">/*++</span>
01341 <span class="comment"></span>
01342 <span class="comment">Routine Description:</span>
01343 <span class="comment"></span>
01344 <span class="comment">    This routine initializes the input-specific fields of the handle data</span>
01345 <span class="comment">    structure.</span>
01346 <span class="comment"></span>
01347 <span class="comment">Arguments:</span>
01348 <span class="comment"></span>
01349 <span class="comment">    HandleData - Pointer to handle data structure.</span>
01350 <span class="comment"></span>
01351 <span class="comment">    InputBuffer - Pointer to input buffer data structure.</span>
01352 <span class="comment"></span>
01353 <span class="comment">Return Value:</span>
01354 <span class="comment"></span>
01355 <span class="comment">--*/</span>
01356 
01357 {
01358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01359 
01360     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a> = (<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html">PINPUT_READ_HANDLE_DATA</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a14">HANDLE_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html">INPUT_READ_HANDLE_DATA</a>));
01361     <span class="keywordflow">if</span> (!HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>) {
01362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01363     }
01364     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o0">ReadCountLock</a>);
01365     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01366         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>);
01367         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01368         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01369     }
01370     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> = 0;
01371     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> = 0;
01372     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer = InputBuffer;
01373     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;RefCount++;
01374     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01375 }
01376 
01377 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01378"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a9">01378</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a9">FreeInputHandle</a>(
01379     IN <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData
01380     )
01381 {
01382     <span class="keywordflow">if</span> (HandleData-&gt;InputReadData) {
01383         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;HandleData-&gt;InputReadData-&gt;ReadCountLock);
01384         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(HandleData-&gt;InputReadData);
01385         HandleData-&gt;InputReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01386     }
01387 }
01388 
01389 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01390"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">01390</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(
01391     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
01392     IN ULONG HandleType,
01393     OUT PHANDLE Handle
01394     )
01395 
01396 <span class="comment">/*++</span>
01397 <span class="comment"></span>
01398 <span class="comment">Routine Description:</span>
01399 <span class="comment"></span>
01400 <span class="comment">    This routine allocates an input or output handle from the process's</span>
01401 <span class="comment">    handle table.</span>
01402 <span class="comment"></span>
01403 <span class="comment">    This routine initializes all non-type specific fields in the handle</span>
01404 <span class="comment">    data structure.</span>
01405 <span class="comment"></span>
01406 <span class="comment">Arguments:</span>
01407 <span class="comment"></span>
01408 <span class="comment">    ProcessData - Pointer to per process data structure.</span>
01409 <span class="comment"></span>
01410 <span class="comment">    HandleType - Flag indicating input or output handle.</span>
01411 <span class="comment"></span>
01412 <span class="comment">    Handle - On return, contains allocated handle.  Handle is an index</span>
01413 <span class="comment">    internally.  When returned to the API caller, it is translated into</span>
01414 <span class="comment">    a handle.</span>
01415 <span class="comment"></span>
01416 <span class="comment">Return Value:</span>
01417 <span class="comment"></span>
01418 <span class="comment">Note:</span>
01419 <span class="comment"></span>
01420 <span class="comment">    The console lock must be held when calling this routine.  The handle</span>
01421 <span class="comment">    is allocated from the per-process handle table.  Holding the console</span>
01422 <span class="comment">    lock serializes both threads within the calling process and any other</span>
01423 <span class="comment">    process that shares the console.</span>
01424 <span class="comment"></span>
01425 <span class="comment">--*/</span>
01426 
01427 {
01428     ULONG i;
01429     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01430 
01431     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
01432         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType == <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) {
01433             ProcessData-&gt;HandleTablePtr[i].HandleType = HandleType;
01434             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE) i;
01435 
01436             <span class="keywordflow">return</span> STATUS_SUCCESS;
01437         }
01438     }
01439     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a24">GrowIoHandleTable</a>(ProcessData);
01440     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01441         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01442     <span class="keywordflow">for</span> ( ;i&lt;ProcessData-&gt;HandleTableSize;i++) {
01443         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType == <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) {
01444             ProcessData-&gt;HandleTablePtr[i].HandleType = HandleType;
01445             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE) i;
01446             <span class="keywordflow">return</span> STATUS_SUCCESS;
01447         }
01448     }
01449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01450     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01451 }
01452 
01453 
01454 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01455"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">01455</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a>(
01456     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
01457     IN HANDLE Handle
01458     )
01459 
01460 <span class="comment">/*++</span>
01461 <span class="comment"></span>
01462 <span class="comment">Routine Description:</span>
01463 <span class="comment"></span>
01464 <span class="comment">    This routine frees an input or output handle from the process's</span>
01465 <span class="comment">    handle table.</span>
01466 <span class="comment"></span>
01467 <span class="comment">Arguments:</span>
01468 <span class="comment"></span>
01469 <span class="comment">    ProcessData - Pointer to per process data structure.</span>
01470 <span class="comment"></span>
01471 <span class="comment">    Handle - Handle to free.</span>
01472 <span class="comment"></span>
01473 <span class="comment">Return Value:</span>
01474 <span class="comment"></span>
01475 <span class="comment">Note:</span>
01476 <span class="comment"></span>
01477 <span class="comment">    The console lock must be held when calling this routine.  The handle</span>
01478 <span class="comment">    is freed from the per-process handle table.  Holding the console</span>
01479 <span class="comment">    lock serializes both threads within the calling process and any other</span>
01480 <span class="comment">    process that shares the console.</span>
01481 <span class="comment"></span>
01482 <span class="comment">--*/</span>
01483 
01484 {
01485     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01486     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01487 
01488     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
01489                                  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01490                                  &amp;HandleData
01491                                 );
01492     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01493     <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
01494         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a9">FreeInputHandle</a>(HandleData);
01495     }
01496     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
01497     <span class="keywordflow">return</span> STATUS_SUCCESS;
01498 }
01499 
01500 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01501"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">01501</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(
01502     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
01503     IN HANDLE Handle,
01504     OUT <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> *HandleData
01505     )
01506 
01507 <span class="comment">/*++</span>
01508 <span class="comment"></span>
01509 <span class="comment">Routine Description:</span>
01510 <span class="comment"></span>
01511 <span class="comment">    This routine verifies a handle's validity, then returns a pointer to</span>
01512 <span class="comment">    the handle data structure.</span>
01513 <span class="comment"></span>
01514 <span class="comment">Arguments:</span>
01515 <span class="comment"></span>
01516 <span class="comment">    ProcessData - Pointer to per process data structure.</span>
01517 <span class="comment"></span>
01518 <span class="comment">    Handle - Handle to dereference.</span>
01519 <span class="comment"></span>
01520 <span class="comment">    HandleData - On return, pointer to handle data structure.</span>
01521 <span class="comment"></span>
01522 <span class="comment">Return Value:</span>
01523 <span class="comment"></span>
01524 <span class="comment">--*/</span>
01525 
01526 {
01527     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &gt;= ProcessData-&gt;HandleTableSize) ||
01528         (ProcessData-&gt;HandleTablePtr[(ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>].HandleType == <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) ) {
01529         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01530     }
01531     *HandleData = &amp;ProcessData-&gt;HandleTablePtr[(ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>];
01532     <span class="keywordflow">return</span> STATUS_SUCCESS;
01533 }
01534 
01535 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01536"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">01536</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(
01537     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
01538     IN HANDLE Handle,
01539     IN ULONG HandleType,
01540     IN ACCESS_MASK Access,
01541     OUT <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> *HandleData
01542     )
01543 
01544 <span class="comment">/*++</span>
01545 <span class="comment"></span>
01546 <span class="comment">Routine Description:</span>
01547 <span class="comment"></span>
01548 <span class="comment">    This routine verifies a handle's validity, then returns a pointer to</span>
01549 <span class="comment">    the handle data structure.</span>
01550 <span class="comment"></span>
01551 <span class="comment">Arguments:</span>
01552 <span class="comment"></span>
01553 <span class="comment">    ProcessData - Pointer to per process data structure.</span>
01554 <span class="comment"></span>
01555 <span class="comment">    Handle - Handle to dereference.</span>
01556 <span class="comment"></span>
01557 <span class="comment">    HandleData - On return, pointer to handle data structure.</span>
01558 <span class="comment"></span>
01559 <span class="comment">Return Value:</span>
01560 <span class="comment"></span>
01561 <span class="comment">--*/</span>
01562 
01563 {
01564     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01565 
01566     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/rdwr_8c.html#a8">CONSOLE_HANDLE</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>)) {
01567         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01568     }
01569     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG_PTR)<a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01570     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= ProcessData-&gt;HandleTableSize) ||
01571         (ProcessData-&gt;HandleTablePtr[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].HandleType == <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) ||
01572         !(ProcessData-&gt;HandleTablePtr[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].HandleType &amp; HandleType) ||
01573         !(ProcessData-&gt;HandleTablePtr[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Access &amp; Access) ) {
01574         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01575     }
01576     *HandleData = &amp;ProcessData-&gt;HandleTablePtr[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01577     <span class="keywordflow">return</span> STATUS_SUCCESS;
01578 }
01579 
01580 
01581 ULONG
<a name="l01582"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a32">01582</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a32">SrvVerifyConsoleIoHandle</a>(
01583     IN OUT PCSR_API_MSG m,
01584     IN OUT PCSR_REPLY_STATUS ReplyStatus
01585     )
01586 
01587 <span class="comment">/*++</span>
01588 <span class="comment"></span>
01589 <span class="comment">Routine Description:</span>
01590 <span class="comment"></span>
01591 <span class="comment">    This routine verifies that a console io handle is valid.</span>
01592 <span class="comment"></span>
01593 <span class="comment">Arguments:</span>
01594 <span class="comment"></span>
01595 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
01596 <span class="comment"></span>
01597 <span class="comment">Return Value:</span>
01598 <span class="comment"></span>
01599 <span class="comment">--*/</span>
01600 
01601 {
01602     <a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html">PCONSOLE_VERIFYIOHANDLE_MSG</a> a = (<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html">PCONSOLE_VERIFYIOHANDLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01603     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01604     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01605     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01606     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01607 
01608     UNREFERENCED_PARAMETER(ReplyStatus);
01609 
01610     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o1">ConsoleHandle</a>,
01611                          &amp;Console
01612                         );
01613     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01614         ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
01615         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
01616                                      <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o2">Handle</a>),
01617                                      &amp;HandleData
01618                                     );
01619         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01620     }
01621     a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o0">Valid</a> = (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01622     <span class="keywordflow">return</span> STATUS_SUCCESS;
01623 }
01624 
01625 
01626 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01627"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">01627</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(
01628     IN HANDLE ConsoleHandle,
01629     OUT <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *Console
01630     )
01631 {
01632     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01633 
01634     <span class="comment">//</span>
01635     <span class="comment">// If this process doesn't have a console handle, bail immediately.</span>
01636     <span class="comment">//</span>
01637 
01638     <span class="keywordflow">if</span> (ConsoleHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ConsoleHandle != <a class="code" href="../../d1/d7/server_8h.html#a89">CONSOLE_GETCONSOLEHANDLE</a>()) {
01639         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01640     }
01641 
01642 <span class="preprocessor">#ifdef i386</span>
01643 <span class="preprocessor"></span>    <span class="comment">//Do not lock the console if we are in the special case:</span>
01644     <span class="comment">//(1). we are in the middle of handshaking with ntvdm doing</span>
01645     <span class="comment">//     full-screen to windowed mode transition</span>
01646     <span class="comment">//(2). the calling process is THE ntvdm process(this implies that the</span>
01647     <span class="comment">//     the console has vdm registered.</span>
01648     <span class="comment">//(3). the console handle is the same one.</span>
01649     <span class="comment">// if (1), (2) and (3) are true then the console is already locked</span>
01650     <span class="comment">// (locked by the windowproc while processing the WM_FULLSCREEN</span>
01651     <span class="comment">// message)</span>
01652 
01653     RtlEnterCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>);
01654     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01655         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a> == ConsoleHandle &amp;&amp;
01656         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> == <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>())
01657     {
01658         KdPrint((<span class="stringliteral">"    ApiPreamble - Thread %lx Entered VDM CritSec\n"</span>, GetCurrentThreadId()));
01659         *Console = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a>;
01660         <span class="keywordflow">return</span> STATUS_SUCCESS;
01661     }
01662     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>);
01663 <span class="preprocessor">#endif</span>
01664 <span class="preprocessor"></span>
01665     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle,
01666                                Console
01667                               );
01668     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01669         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01670     }
01671 
01672     <span class="comment">//</span>
01673     <span class="comment">// Make sure the console has been initialized and the window is valid</span>
01674     <span class="comment">//</span>
01675 
01676     <span class="keywordflow">if</span> ((*Console)-&gt;hWnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ((*Console)-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>)) {
01677         KdPrint((<span class="stringliteral">"CONSRV: bogus window for console %lx\n"</span>, *Console));
01678         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(*Console);
01679         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01680     }
01681 
01682     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01683 }
01684 
01685 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01686"></a><a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">01686</a> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(
01687     IN HANDLE ConsoleHandle,
01688     OUT <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *Console
01689     )
01690 {
01691     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01692 
01693     <a class="code" href="../../d8/d5/consrv_8h.html#a40">LockConsoleHandleTable</a>();
01694     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a11">DereferenceConsoleHandle</a>(ConsoleHandle,
01695                                       Console
01696                                      );
01697     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01698         <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01699         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01700     }
01701 
01702     <span class="comment">//</span>
01703     <span class="comment">// The WaitCount ensures the console won't go away between the time</span>
01704     <span class="comment">// we unlock the console handle table and we lock the console.</span>
01705     <span class="comment">//</span>
01706 
01707     InterlockedIncrement(&amp;(*Console)-&gt;WaitCount);
01708     <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01709     <span class="keywordflow">try</span> {
01710         <a class="code" href="../../d8/d5/consrv_8h.html#a42">LockConsole</a>(*Console);
01711     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01712         InterlockedDecrement(&amp;(*Console)-&gt;WaitCount);
01713         <span class="keywordflow">return</span> GetExceptionCode();
01714     }
01715     InterlockedDecrement(&amp;(*Console)-&gt;WaitCount);
01716 
01717     <span class="comment">//</span>
01718     <span class="comment">// If the console was marked for destruction while we were waiting to</span>
01719     <span class="comment">// lock it, try to destroy it and return.</span>
01720     <span class="comment">//</span>
01721 
01722     <span class="keywordflow">if</span> ((*Console)-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a22">CONSOLE_IN_DESTRUCTION</a>) {
01723         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a20">DestroyConsole</a>(*Console);
01724         *Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01725         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01726     }
01727 
01728     <span class="comment">//</span>
01729     <span class="comment">// If the console was marked for termination while we were waiting to</span>
01730     <span class="comment">// lock it, bail out.</span>
01731     <span class="comment">//</span>
01732 
01733     <span class="keywordflow">if</span> ((*Console)-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>) {
01734         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(*Console);
01735         *Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01736         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
01737     }
01738 
01739     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01740 }
01741 
01742 
01743 <span class="preprocessor">#if DBG</span>
01744 <span class="preprocessor"></span>
01745 BOOLEAN
01746 <a class="code" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle</a>(
01747     HANDLE hObject
01748     )
01749 {
01750     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01751     OBJECT_HANDLE_FLAG_INFORMATION HandleInfo;
01752 
01753     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>(hObject,
01754                            ObjectHandleFlagInformation,
01755                            &amp;HandleInfo,
01756                            <span class="keyword">sizeof</span>(HandleInfo),
01757                            NULL
01758                           );
01759     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01760         HandleInfo.ProtectFromClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01761         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a6">NtSetInformationObject</a>(hObject,
01762                                         ObjectHandleFlagInformation,
01763                                         &amp;HandleInfo,
01764                                         <span class="keyword">sizeof</span>(HandleInfo)
01765                                        );
01766         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01767             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01768         }
01769     }
01770 
01771     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01772 }
01773 
01774 <span class="preprocessor">#endif // DBG</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
