<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: api.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>api.c</h1><a href="../../d2/d8/api_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*************************************************************************</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* api.c</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* WinStation Control API's for WIN32 subsystem.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00009 <span class="comment">*</span>
00010 <span class="comment">*************************************************************************/</span>
00011 
00012 <span class="comment">/*</span>
00013 <span class="comment"> *  Includes</span>
00014 <span class="comment"> */</span>
00015 <span class="preprocessor">#include "<a class="code" href="../../d2/d4/w32_2ntuser_2server_2precomp_8h.html">precomp.h</a>"</span>
00016 <span class="preprocessor">#pragma hdrstop</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ntuser_8h.html">ntuser.h</a>"</span>
00019 
00020 <span class="preprocessor">#include &lt;winsta.h&gt;</span>
00021 <span class="preprocessor">#include &lt;wstmsg.h&gt;</span>
00022 
<a name="l00023"></a><a class="code" href="../../d2/d8/api_8c.html#a0">00023</a> <span class="preprocessor">#define SESSION_ROOT L"\\Sessions"</span>
<a name="l00024"></a><a class="code" href="../../d2/d8/api_8c.html#a1">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_SESSION_PATH 256</span>
00025 <span class="preprocessor"></span>
00026 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a21">CsrPopulateDosDevices</a>(<span class="keywordtype">void</span>);
00027 
00028 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00029 <a class="code" href="../../d2/d8/api_8c.html#a22">CleanupSessionObjectDirectories</a>(<span class="keywordtype">void</span>);
00030 
00031 HANDLE <a class="code" href="../../d2/d8/api_8c.html#a23">CsrQueryApiPort</a>(<span class="keywordtype">void</span>);
00032 <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/api_8c.html#a24">CtxInitUser32</a>(VOID);
00033 
00034 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/dynres_8c.html#a0">DrChangeDisplaySettings</a>(WINSTATIONDORECONNECTMSG*);
00035 
<a name="l00036"></a><a class="code" href="../../d2/d8/api_8c.html#a4">00036</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d8/api_8c.html#a4">gHRes</a> = 0;
<a name="l00037"></a><a class="code" href="../../d2/d8/api_8c.html#a5">00037</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d8/api_8c.html#a5">gVRes</a> = 0;
<a name="l00038"></a><a class="code" href="../../d2/d8/api_8c.html#a6">00038</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d8/api_8c.html#a6">gColorDepth</a> = 0;
00039 
<a name="l00040"></a><a class="code" href="../../d2/d8/api_8c.html#a7">00040</a> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00041 
<a name="l00042"></a><a class="code" href="../../d2/d8/api_8c.html#a8">00042</a> BOOLEAN <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00043 
00044 <span class="preprocessor">#if DBG</span>
00045 <span class="preprocessor"></span>ULONG  gulConnectCount = 0;
00046 <span class="preprocessor">#endif // DBG</span>
00047 <span class="preprocessor"></span>
00048 <span class="comment">/*</span>
00049 <span class="comment"> * The following are gotten from ICASRV.</span>
00050 <span class="comment"> *</span>
00051 <span class="comment"> */</span>
00052 
<a name="l00053"></a><a class="code" href="../../d2/d8/api_8c.html#a9">00053</a> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a9">G_IcaVideoChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00054"></a><a class="code" href="../../d2/d8/api_8c.html#a10">00054</a> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a10">G_IcaMouseChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00055"></a><a class="code" href="../../d2/d8/api_8c.html#a11">00055</a> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a11">G_IcaKeyboardChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00056"></a><a class="code" href="../../d2/d8/api_8c.html#a12">00056</a> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a12">G_IcaBeepChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00057"></a><a class="code" href="../../d2/d8/api_8c.html#a13">00057</a> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a13">G_IcaCommandChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00058"></a><a class="code" href="../../d2/d8/api_8c.html#a14">00058</a> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a14">G_IcaThinwireChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00059"></a><a class="code" href="../../d2/d8/api_8c.html#a15">00059</a> WCHAR <a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>[WINSTATIONNAME_LENGTH];
00060 
00061 
00062 <span class="comment">/*</span>
00063 <span class="comment"> * Definition for the WinStation control API's dispatch table</span>
00064 <span class="comment"> */</span>
<a name="l00065"></a><a class="code" href="../../d2/d8/api_8c.html#a16">00065</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> (*<a class="code" href="../../d2/d8/api_8c.html#a16">PWIN32WINSTATION_API</a>)(IN OUT PWINSTATION_APIMSG ApiMsg);
00066 
<a name="l00067"></a><a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html">00067</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html">_WIN32WINSTATION_DISPATCH</a> {
<a name="l00068"></a><a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html#o0">00068</a>     <a class="code" href="../../d2/d8/api_8c.html#a16">PWIN32WINSTATION_API</a> <a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html#o0">pWin32ApiProc</a>;
00069 } <a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html">WIN32WINSTATION_DISPATCH</a>, *<a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html">PWIN32WINSTATION_DISPATCH</a>;
00070 
00071 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a50">W32WinStationDoConnect</a>( IN OUT PWINSTATION_APIMSG );
00072 
00073 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a51">W32WinStationDoDisconnect</a>( IN OUT PWINSTATION_APIMSG );
00074 
00075 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a52">W32WinStationDoReconnect</a>( IN OUT PWINSTATION_APIMSG );
00076 
00077 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a53">W32WinStationExitWindows</a>( IN OUT PWINSTATION_APIMSG );
00078 
00079 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a54">W32WinStationTerminate</a>( IN OUT PWINSTATION_APIMSG );
00080 
00081 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a55">W32WinStationNtSecurity</a>( IN OUT PWINSTATION_APIMSG );
00082 
00083 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a56">W32WinStationDoMessage</a>( IN OUT PWINSTATION_APIMSG );
00084 
00085 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a59">W32WinStationThinwireStats</a>( IN OUT PWINSTATION_APIMSG );
00086 
00087 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a60">W32WinStationShadowSetup</a>( IN OUT PWINSTATION_APIMSG );
00088 
00089 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a61">W32WinStationShadowStart</a>( IN OUT PWINSTATION_APIMSG );
00090 
00091 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a62">W32WinStationShadowStop</a>( IN OUT PWINSTATION_APIMSG );
00092 
00093 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a63">W32WinStationShadowCleanup</a>( IN OUT PWINSTATION_APIMSG );
00094 
00095 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a64">W32WinStationPassthruEnable</a>( IN OUT PWINSTATION_APIMSG );
00096 
00097 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a65">W32WinStationPassthruDisable</a>( IN OUT PWINSTATION_APIMSG );
00098 
00099 <span class="comment">// This is the counter part to SMWinStationBroadcastSystemMessage  </span>
00100 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a57">W32WinStationBroadcastSystemMessage</a>( IN OUT PWINSTATION_APIMSG );
00101 <span class="comment">// This is the counter part to SMWinStationSendWindowMessage</span>
00102 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a58">W32WinStationSendWindowMessage</a>( IN OUT PWINSTATION_APIMSG );
00103 
00104 <span class="comment">/*</span>
00105 <span class="comment"> * WinStation API Dispatch Table</span>
00106 <span class="comment"> *</span>
00107 <span class="comment"> * Only the API's that WIN32 implements as opposed to ICASRV</span>
00108 <span class="comment"> * are entered here. The rest are NULL so that the same WinStation API</span>
00109 <span class="comment"> * numbers may be used by ICASRV and WIN32.  If this table is</span>
00110 <span class="comment"> * changed, the table below must be modified too, as well as the API</span>
00111 <span class="comment"> * dispatch table in the ICASRV.</span>
00112 <span class="comment"> */</span>
00113 
00114 <span class="comment">/*</span>
00115 <span class="comment"> * If you  ever change the index of the function pointers in this array</span>
00116 <span class="comment"> * make sure API_W32WINSTATIONTERMINATE has the right index</span>
00117 <span class="comment"> * for W32WinStationTerminate</span>
00118 <span class="comment"> */</span>
00119 
<a name="l00120"></a><a class="code" href="../../d2/d8/api_8c.html#a2">00120</a> <span class="preprocessor">#define API_W32WINSTATIONTERMINATE  12  // includes -- W32WinStationSendWindowMessage </span>
00121 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="../../d2/d8/api_8c.html#a19">00122</a> <a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html">WIN32WINSTATION_DISPATCH</a> <a class="code" href="../../d2/d8/api_8c.html#a19">Win32WinStationDispatch</a>[SMWinStationMaxApiNumber] = {
00123     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// create</span>
00124     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// reset</span>
00125     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// disconnect</span>
00126     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// WCharLog</span>
00127     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// ApiWinStationGetSMCommand,</span>
00128     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// ApiWinStationBrokenConnection,</span>
00129     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// ApiWinStationIcaReplyMessage,</span>
00130     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// ApiWinStationIcaShadowHotkey,</span>
00131     <a class="code" href="../../d2/d8/api_8c.html#a26">W32WinStationDoConnect</a>,
00132     <a class="code" href="../../d2/d8/api_8c.html#a27">W32WinStationDoDisconnect</a>,
00133     <a class="code" href="../../d2/d8/api_8c.html#a28">W32WinStationDoReconnect</a>,
00134     <a class="code" href="../../d2/d8/api_8c.html#a29">W32WinStationExitWindows</a>,
00135     <a class="code" href="../../d2/d8/api_8c.html#a30">W32WinStationTerminate</a>,
00136     <a class="code" href="../../d2/d8/api_8c.html#a31">W32WinStationNtSecurity</a>,
00137     <a class="code" href="../../d2/d8/api_8c.html#a32">W32WinStationDoMessage</a>,
00138     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00139     <a class="code" href="../../d2/d8/api_8c.html#a33">W32WinStationThinwireStats</a>,
00140     <a class="code" href="../../d2/d8/api_8c.html#a34">W32WinStationShadowSetup</a>,
00141     <a class="code" href="../../d2/d8/api_8c.html#a35">W32WinStationShadowStart</a>,
00142     <a class="code" href="../../d2/d8/api_8c.html#a36">W32WinStationShadowStop</a>,
00143     <a class="code" href="../../d2/d8/api_8c.html#a37">W32WinStationShadowCleanup</a>,
00144     <a class="code" href="../../d2/d8/api_8c.html#a38">W32WinStationPassthruEnable</a>,
00145     <a class="code" href="../../d2/d8/api_8c.html#a39">W32WinStationPassthruDisable</a>,
00146     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// [AraBern] this was missing: SMWinStationInitialProgram</span>
00147     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// [AraBern] this was missing: SMWinStationNtsdDebug</span>
00148     <a class="code" href="../../d2/d8/api_8c.html#a40">W32WinStationBroadcastSystemMessage</a>,
00149     <a class="code" href="../../d2/d8/api_8c.html#a41">W32WinStationSendWindowMessage</a>,
00150 };
00151 
00152 <span class="preprocessor">#if DBG</span>
00153 <span class="preprocessor"></span>PSZ Win32WinStationAPIName[SMWinStationMaxApiNumber] = {
00154     <span class="stringliteral">"SmWinStationCreate"</span>,
00155     <span class="stringliteral">"SmWinStationReset"</span>,
00156     <span class="stringliteral">"SmWinStationDisconnect"</span>,
00157     <span class="stringliteral">"SmWinStationWCharLog"</span>,
00158     <span class="stringliteral">"SmWinStationGetSMCommand"</span>,
00159     <span class="stringliteral">"SmWinStationBrokenConnection"</span>,
00160     <span class="stringliteral">"SmWinStationIcaReplyMessage"</span>,
00161     <span class="stringliteral">"SmWinStationIcaShadowHotkey"</span>,
00162     <span class="stringliteral">"SmWinStationDoConnect"</span>,
00163     <span class="stringliteral">"SmWinStationDoDisconnect"</span>,
00164     <span class="stringliteral">"SmWinStationDoReconnect"</span>,
00165     <span class="stringliteral">"SmWinStationExitWindows"</span>,
00166     <span class="stringliteral">"SmWinStationTerminate"</span>,
00167     <span class="stringliteral">"SmWinStationNtSecurity"</span>,
00168     <span class="stringliteral">"SmWinStationDoMessage"</span>,
00169     <span class="stringliteral">"SmWinstationDoBreakPoint"</span>,
00170     <span class="stringliteral">"SmWinStationThinwireStats"</span>,
00171     <span class="stringliteral">"SmWinStationShadowSetup"</span>,
00172     <span class="stringliteral">"SmWinStationShadowStart"</span>,
00173     <span class="stringliteral">"SmWinStationShadowStop"</span>,
00174     <span class="stringliteral">"SmWinStationShadowCleanup"</span>,
00175     <span class="stringliteral">"SmWinStationPassthruEnable"</span>,
00176     <span class="stringliteral">"SmWinStationPassthruDisable"</span>,
00177     <span class="stringliteral">"SMWinStationInitialProgram"</span>,
00178     <span class="stringliteral">"SMWinStationNtsdDebug"</span>,
00179     <span class="stringliteral">"W32WinStationBroadcastSystemMessage"</span>,
00180     <span class="stringliteral">"W32WinStationSendWindowMessage"</span>,
00181 };
00182 <span class="preprocessor">#endif</span>
00183 <span class="preprocessor"></span>
00184 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a49">TerminalServerRequestThread</a>( PVOID );
00185 
00186 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d4/command_8c.html#a5">Win32CommandChannelThread</a>( PVOID );
00187 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d4/icamsg_8c.html#a11">RemoteDoMessage</a>( PWINSTATION_APIMSG pMsg );
00188 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d8/api_8c.html#a45">MultiUserSpoolerInit</a>();
00189 <span class="comment">//extern BOOL     CtxGetCrossWinStationDebug( VOID );</span>
00190 
<a name="l00191"></a><a class="code" href="../../d2/d8/api_8c.html#a20">00191</a> <span class="keyword">extern</span> HANDLE <a class="code" href="../../d2/d8/api_8c.html#a20">g_hDoMessageEvent</a>;
00192 
00193 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d6/server_2sendmsg_8c.html#a1">RemoteDoBroadcastSystemMessage</a>( PWINSTATION_APIMSG pMsg );
00194 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d6/server_2sendmsg_8c.html#a2">RemoteDoSendWindowMessage</a>( PWINSTATION_APIMSG  pMsg);
00195 
00196 
00197 <span class="comment">/*****************************************************************************</span>
00198 <span class="comment"> *</span>
00199 <span class="comment"> *  WinStationAPIInit</span>
00200 <span class="comment"> *</span>
00201 <span class="comment"> *   Creates and initializes the WinStation API port and thread.</span>
00202 <span class="comment"> *</span>
00203 <span class="comment"> * ENTRY:</span>
00204 <span class="comment"> *    No Parameters</span>
00205 <span class="comment"> *</span>
00206 <span class="comment"> * EXIT:</span>
00207 <span class="comment"> *   STATUS_SUCCESS - no error</span>
00208 <span class="comment"> *</span>
00209 <span class="comment"> ****************************************************************************/</span>
00210 
00211 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00212"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a48">00212</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a48">WinStationAPIInit</a>(
00213     VOID)
00214 {
00215     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00216     CLIENT_ID ClientId;
00217     HANDLE    <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00218     KPRIORITY Priority;
00219 
00220 <span class="preprocessor">#if DBG</span>
00221 <span class="preprocessor"></span>    <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Inited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00222 <span class="preprocessor">#endif</span>
00223 <span class="preprocessor"></span>
00224     UserAssert(Inited == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00225 
00226     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> = NtCurrentPeb()-&gt;SessionId;
00227 
00228 <span class="preprocessor">#if DBG</span>
00229 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Inited)
00230         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"WinStationAPIInit called twice !!!\n"</span>));
00231 
00232     Inited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00233 <span class="preprocessor">#endif</span>
00234 <span class="preprocessor"></span>
00235     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(NtCurrentProcess(),
00236                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00237                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00238                               0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00239                               0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00240                               0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00241                               <a class="code" href="../../d2/d8/api_8c.html#a42">TerminalServerRequestThread</a>,
00242                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00243                               &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00244                               &amp;ClientId);
00245 
00246     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00247         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"WinStationAPIInit: failed to create TerminalServerRequestThread\n"</span>));
00248         <span class="keywordflow">goto</span> Exit;
00249     }
00250     <span class="comment">/*</span>
00251 <span class="comment">     *  Add thread to server thread pool</span>
00252 <span class="comment">     */</span>
00253     CsrAddStaticServerThread(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, &amp;ClientId, 0);
00254 
00255     <span class="comment">/*</span>
00256 <span class="comment">     * Boost priority of ICA SRV Request thread</span>
00257 <span class="comment">     */</span>
00258     Priority = THREAD_BASE_PRIORITY_MAX;
00259 
00260     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, ThreadBasePriority,
00261                                  &amp;Priority, <span class="keyword">sizeof</span>(Priority));
00262 
00263     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00264         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"WinStationAPIInit: failed to set thread priority\n"</span>));
00265         <span class="keywordflow">goto</span> Exit;
00266     }
00267 
00268     <span class="comment">/*</span>
00269 <span class="comment">     * Resume the thread now that we've initialized things.</span>
00270 <span class="comment">     */</span>
00271     <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00272 
00273 
00274 Exit:
00275     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00276 }
00277 
00278 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00279"></a><a class="code" href="../../d2/d8/api_8c.html#a49">00279</a> <a class="code" href="../../d2/d8/api_8c.html#a49">TerminalServerRequestThread</a>(
00280     IN PVOID ThreadParameter)
00281 {
00282     PTEB                        Teb;
00283     UNICODE_STRING              <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>;
00284     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>;
00285     WINSTATIONAPI_CONNECT_INFO  info;
00286     ULONG                       ConnectInfoLength;
00287     WINSTATION_APIMSG           ApiMsg;
00288     <a class="code" href="../../d2/d8/api_8c.html#a18">PWIN32WINSTATION_DISPATCH</a>   pDispatch;
00289     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00290     REMOTE_PORT_VIEW            ServerView;
00291     HANDLE                      CsrStartHandle, hevtTermSrvInit;
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     * Initialize GDI accelerators.  Identify this thread as a server thread.</span>
00295 <span class="comment">     */</span>
00296     Teb = NtCurrentTeb();
00297     Teb-&gt;GdiClientPID = 4; <span class="comment">// PID_SERVERLPC</span>
00298     Teb-&gt;GdiClientTID = HandleToUlong(Teb-&gt;ClientId.UniqueThread);
00299 
00300     <span class="comment">/*</span>
00301 <span class="comment">     *  Connect to user</span>
00302 <span class="comment">     */</span>
00303 
00304     hevtTermSrvInit = CreateEvent(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00305                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Global\\TermSrvReadyEvent"</span>);
00306 
00307     UserAssert(hevtTermSrvInit != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00308 <span class="preprocessor">#if DBG</span>
00309 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (hevtTermSrvInit == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00310         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"ERROR: could not create TermSrvReadyEvent !!!\n"</span>));
00311     }
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(hevtTermSrvInit, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00315 
00316     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hevtTermSrvInit);
00317 
00318     <span class="comment">/*</span>
00319 <span class="comment">     *  Connect to terminal server API port</span>
00320 <span class="comment">     */</span>
00321     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.ImpersonationLevel = SecurityImpersonation;
00322     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00323     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00324 
00325     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\SmSsWinStationApiPort"</span>);
00326 
00327     <span class="comment">/*</span>
00328 <span class="comment">     * Init the REMOTE_VIEW structure</span>
00329 <span class="comment">     */</span>
00330     ServerView.Length = <span class="keyword">sizeof</span>(ServerView);
00331     ServerView.ViewSize = 0;
00332     ServerView.ViewBase = 0;
00333 
00334     <span class="comment">/*</span>
00335 <span class="comment">     * Fill in the ConnectInfo structure with our access request mask</span>
00336 <span class="comment">     */</span>
00337     info.Version = CITRIX_WINSTATIONAPI_VERSION;
00338     info.RequestedAccess = 0; <span class="comment">// BUGBUG should ask for ALL access</span>
00339     ConnectInfoLength = <span class="keyword">sizeof</span>(WINSTATIONAPI_CONNECT_INFO);
00340 
00341     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a>( &amp;<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a>,
00342                             &amp;<a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>,
00343                             &amp;<a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>,
00344                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// ClientView</span>
00345                             &amp;ServerView,
00346                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// Max message length [select default]</span>
00347                             (PVOID)&amp;info,
00348                             &amp;ConnectInfoLength);
00349 
00350     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00351         RIPMSG0(RIP_WARNING, <span class="stringliteral">"TerminalServerRequestThread: Failed to connect to LPC port"</span>);
00352         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00353     }
00354 
00355     RtlZeroMemory(&amp;ApiMsg, <span class="keyword">sizeof</span>(ApiMsg));
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">// Terminal Server calls into Session Manager to create a new Hydra session.</span>
00359     <span class="comment">// The session manager creates and resume a new session and returns to Terminal</span>
00360     <span class="comment">// server the session id of the new session. There is a race condition where</span>
00361     <span class="comment">// CSR can resume and call into terminal server before terminal server can</span>
00362     <span class="comment">// store the session id in its internal structure. To prevent this CSR will</span>
00363     <span class="comment">// wait here on a named event which will be set by Terminal server once it</span>
00364     <span class="comment">// gets the sessionid for the newly created session</span>
00365     <span class="comment">//</span>
00366 
00367     <span class="keywordflow">if</span> (NtCurrentPeb()-&gt;SessionId != 0) {
00368 
00369         CsrStartHandle = CreateEvent(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CsrStartEvent"</span>);
00370 
00371         <span class="keywordflow">if</span> (!CsrStartHandle) {
00372 
00373             RIPMSG1(RIP_WARNING, <span class="stringliteral">"TerminalServerRequestThread: Failed to create 'CsrStartEvent' with Status 0x%x"</span>,
00374                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00375 
00376             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00377 
00378         } <span class="keywordflow">else</span> {
00379 
00380             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(CsrStartHandle, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00381 
00382             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CsrStartHandle);
00383             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00384                 <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"TerminalServerRequestThread: Wait for object 'CsrStartEvent' failed Status=0x%x\n"</span>,
00385                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00386             }
00387         }
00388     }
00389 
00390     <span class="keywordflow">for</span> (;;) {
00391 
00392         <span class="comment">/*</span>
00393 <span class="comment">         * Initialize LPC message fields</span>
00394 <span class="comment">         */</span>
00395         ApiMsg.h.u1.s1.DataLength     = <span class="keyword">sizeof</span>(ApiMsg) - <span class="keyword">sizeof</span>(PORT_MESSAGE);
00396         ApiMsg.h.u1.s1.TotalLength    = <span class="keyword">sizeof</span>(ApiMsg);
00397         ApiMsg.h.u2.s2.Type           = 0; <span class="comment">// Kernel will fill in message type</span>
00398         ApiMsg.h.u2.s2.DataInfoOffset = 0;
00399         ApiMsg.ApiNumber              = SMWinStationGetSMCommand;
00400 
00401         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/lpcsend_8c.html#a1">NtRequestWaitReplyPort</a>(<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a>,
00402                                         (PPORT_MESSAGE)&amp;ApiMsg,
00403                                         (PPORT_MESSAGE)&amp;ApiMsg);
00404 
00405         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00406             <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"TerminalServerRequestThread wait failed with Status %lx\n"</span>,
00407                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00408             <span class="keywordflow">break</span>;
00409         }
00410 
00411         <span class="keywordflow">if</span> (ApiMsg.ApiNumber &gt;= SMWinStationMaxApiNumber ) {
00412 
00413             <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"TerminalServerRequestThread Bad API number %d\n"</span>,
00414                    ApiMsg.ApiNumber));
00415 
00416             ApiMsg.ReturnedStatus = STATUS_NOT_IMPLEMENTED;
00417 
00418         } <span class="keywordflow">else</span> {
00419 
00420             <span class="comment">/*</span>
00421 <span class="comment">             * We must VALIDATE which ones are implemented here</span>
00422 <span class="comment">             */</span>
00423             pDispatch = &amp;<a class="code" href="../../d2/d8/api_8c.html#a19">Win32WinStationDispatch</a>[ApiMsg.ApiNumber];
00424 
00425             <span class="keywordflow">if</span> (pDispatch-&gt;<a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html#o0">pWin32ApiProc</a>) {
00426 
00427                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRestoreDesktop = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00428                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00429                 USERTHREAD_USEDESKTOPINFO utudi;
00430 
00431                 <span class="comment">/*</span>
00432 <span class="comment">                 * For all the win32k callouts with the exception of</span>
00433 <span class="comment">                 * terminate set this thread to the current desktop</span>
00434 <span class="comment">                 */</span>
00435                 <span class="keywordflow">if</span> (ApiMsg.ApiNumber != <a class="code" href="../../d2/d8/api_8c.html#a2">API_W32WINSTATIONTERMINATE</a>) {
00436                     utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00437                     utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00438                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00439                                                         UserThreadUseActiveDesktop,
00440                                                         &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00441 
00442                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00443                         bRestoreDesktop = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00444                     }
00445                 }
00446 
00447                 <span class="comment">/*</span>
00448 <span class="comment">                 * Call the API</span>
00449 <span class="comment">                 */</span>
00450                 ApiMsg.ReturnedStatus = (pDispatch-&gt;<a class="code" href="../../d9/d8/struct__WIN32WINSTATION__DISPATCH.html#o0">pWin32ApiProc</a>)(&amp;ApiMsg);
00451 
00452                 <span class="keywordflow">if</span> (bRestoreDesktop) {
00453                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00454                                                UserThreadUseDesktop,
00455                                                &amp;utudi,
00456                                                <span class="keyword">sizeof</span>(utudi));
00457                 }
00458 
00459             } <span class="keywordflow">else</span> {
00460                 <span class="comment">// This control API is not implemented in WIN32</span>
00461                 ApiMsg.ReturnedStatus = STATUS_NOT_IMPLEMENTED;
00462             }
00463         }
00464     }
00465 
00466     ExitThread(0);
00467 
00468     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00469 
00470     UNREFERENCED_PARAMETER(ThreadParameter);
00471 }
00472 
00473 <span class="preprocessor">#if DBG</span>
00474 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00475 <a class="code" href="../../d2/d8/api_8c.html#a3">W32WinStationDumpReconnectInfo</a>(
00476     WINSTATIONDORECONNECTMSG *pDoReconnect,
00477     BOOLEAN bReconnect)
00478 {
00479     PSTR pCallerName;
00480 
00481     <span class="keywordflow">if</span> (bReconnect) {
00482         pCallerName = <span class="stringliteral">"W32WinStationDoReconnect"</span>;
00483     } <span class="keywordflow">else</span> {
00484         pCallerName = <span class="stringliteral">"W32WinStationDoConnect"</span>;
00485     }
00486 
00487     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(pCallerName);
00488     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" - Display resolution information for session %d :\n"</span>, gSessionId);
00489 
00490     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tProtocolType : %04d\n"</span>, pDoReconnect-&gt;ProtocolType);
00491     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tHRes : %04d\n"</span>, pDoReconnect-&gt;HRes);
00492     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tVRes : %04d\n"</span>, pDoReconnect-&gt;VRes);
00493     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tColorDepth : %04d\n"</span>, pDoReconnect-&gt;ColorDepth);
00494 
00495     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tKeyboardType : %d\n"</span>, pDoReconnect-&gt;KeyboardType);
00496     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tKeyboardSubType : %d\n"</span>, pDoReconnect-&gt;KeyboardSubType);
00497     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tKeyboardFunctionKey : %d\n"</span>, pDoReconnect-&gt;KeyboardFunctionKey);
00498 }
00499 <span class="preprocessor">#else</span>
<a name="l00500"></a><a class="code" href="../../d2/d8/api_8c.html#a3">00500</a> <span class="preprocessor"></span><span class="preprocessor">    #define W32WinStationDumpReconnectInfo(p, b)</span>
00501 <span class="preprocessor"></span><span class="preprocessor">#endif // DBG</span>
00502 <span class="preprocessor"></span>
00503 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00504"></a><a class="code" href="../../d2/d8/api_8c.html#a50">00504</a> <a class="code" href="../../d2/d8/api_8c.html#a50">W32WinStationDoConnect</a>(
00505     PWINSTATION_APIMSG pMsg)
00506 {
00507     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00508     WINSTATIONDOCONNECTMSG* m = &amp;pMsg-&gt;u.DoConnect;
00509     WCHAR                   DisplayDriverName[10];
00510     CLIENT_ID               ClientId;
00511     HANDLE                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00512     KPRIORITY               Priority;
00513     <a class="code" href="../../d3/d8/struct__DOCONNECTDATA.html">DOCONNECTDATA</a>           DoConnectData;
00514     WINSTATIONDORECONNECTMSG mDoReconnect;
00515 
00516     UserAssert(gulConnectCount == 0);
00517 
00518     <span class="comment">/*</span>
00519 <span class="comment">     * Populate the sessions \DosDevices from</span>
00520 <span class="comment">     * the current consoles settings</span>
00521 <span class="comment">     */</span>
00522     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/api_8c.html#a21">CsrPopulateDosDevices</a>();
00523     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00524         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"CsrPopulateDosDevices failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00525         <span class="keywordflow">goto</span> Exit;
00526     }
00527 
00528 
00529     <a class="code" href="../../d2/d8/api_8c.html#a9">G_IcaVideoChannel</a>    = m-&gt;hIcaVideoChannel;
00530     <a class="code" href="../../d2/d8/api_8c.html#a10">G_IcaMouseChannel</a>    = m-&gt;hIcaMouseChannel;
00531     <a class="code" href="../../d2/d8/api_8c.html#a11">G_IcaKeyboardChannel</a> = m-&gt;hIcaKeyboardChannel;
00532     <a class="code" href="../../d2/d8/api_8c.html#a12">G_IcaBeepChannel</a>     = m-&gt;hIcaBeepChannel;
00533     <a class="code" href="../../d2/d8/api_8c.html#a13">G_IcaCommandChannel</a>  = m-&gt;hIcaCommandChannel;
00534     <a class="code" href="../../d2/d8/api_8c.html#a14">G_IcaThinwireChannel</a> = m-&gt;hIcaThinwireChannel;
00535 
00536     memset(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>));
00537     memcpy(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>, m-&gt;WinStationName,
00538             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>), <span class="keyword">sizeof</span>(m-&gt;WinStationName)));
00539 
00540     <span class="comment">/*</span>
00541 <span class="comment">     * This must be 8 unicode characters (file name) plus two zero wide characters.</span>
00542 <span class="comment">     */</span>
00543     memset(DisplayDriverName, 0, <span class="keyword">sizeof</span>(DisplayDriverName));
00544     memcpy(DisplayDriverName, m-&gt;DisplayDriverName, <span class="keyword">sizeof</span>(DisplayDriverName) - 2);
00545 
00546     <span class="comment">/*</span>
00547 <span class="comment">     * Give the information to the WIN32 driver.</span>
00548 <span class="comment">     */</span>
00549     memset(&amp;DoConnectData, 0, <span class="keyword">sizeof</span>(DoConnectData));
00550 
00551     DoConnectData.fMouse          = m-&gt;fMouse;
00552     DoConnectData.IcaBeepChannel  = <a class="code" href="../../d2/d8/api_8c.html#a12">G_IcaBeepChannel</a>;
00553     DoConnectData.IcaVideoChannel = <a class="code" href="../../d2/d8/api_8c.html#a9">G_IcaVideoChannel</a>;
00554     DoConnectData.IcaMouseChannel = <a class="code" href="../../d2/d8/api_8c.html#a10">G_IcaMouseChannel</a>;
00555     DoConnectData.fEnableWindowsKey = m-&gt;fEnableWindowsKey;;
00556 
00557     DoConnectData.IcaKeyboardChannel        = <a class="code" href="../../d2/d8/api_8c.html#a11">G_IcaKeyboardChannel</a>;
00558     DoConnectData.IcaThinwireChannel        = <a class="code" href="../../d2/d8/api_8c.html#a14">G_IcaThinwireChannel</a>;
00559     DoConnectData.fClientDoubleClickSupport = m-&gt;fClientDoubleClickSupport;
00560 
00561     <span class="comment">/*</span>
00562 <span class="comment">     * Give the information to the keyboard type/subtype/number of functions.</span>
00563 <span class="comment">     */</span>
00564     DoConnectData.ClientKeyboardType.Type        = m-&gt;KeyboardType;
00565     DoConnectData.ClientKeyboardType.SubType     = m-&gt;KeyboardSubType;
00566     DoConnectData.ClientKeyboardType.FunctionKey = m-&gt;KeyboardFunctionKey;
00567 
00568     memcpy(DoConnectData.WinStationName, <a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>,
00569             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>), <span class="keyword">sizeof</span>(DoConnectData.WinStationName)));
00570 
00571     DoConnectData.drProtocolType = m-&gt;ProtocolType;
00572     DoConnectData.drPelsHeight = m-&gt;VRes;
00573     DoConnectData.drPelsWidth = m-&gt;HRes;
00574     DoConnectData.drBitsPerPel = m-&gt;ColorDepth;
00575     <span class="comment">//BUGBUG DoConnectData.drDisplayFrequency is no yet setup</span>
00576 
00577     <span class="comment">// We set here the WINSTATIONDORECONNECTMSG that we will be using latter</span>
00578     <span class="comment">// In the call to DrChangeDisplaySettings(), because we want to trace the display</span>
00579     <span class="comment">// resolution information, prior to call NtUserRemoteConnect().</span>
00580 
00581     mDoReconnect.ProtocolType = m-&gt;ProtocolType;
00582     mDoReconnect.HRes = m-&gt;HRes;
00583     mDoReconnect.VRes = m-&gt;VRes;
00584     mDoReconnect.ColorDepth = m-&gt;ColorDepth;
00585 
00586     <a class="code" href="../../d2/d8/api_8c.html#a3">W32WinStationDumpReconnectInfo</a>(&amp;mDoReconnect, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00587 
00588     <span class="comment">/* Give winstation protocol name */</span>
00589     memset(DoConnectData.ProtocolName, 0, <span class="keyword">sizeof</span>(DoConnectData.ProtocolName));
00590     memcpy(DoConnectData.ProtocolName, m-&gt;ProtocolName, <span class="keyword">sizeof</span>(DoConnectData.ProtocolName) - 2);
00591 
00592     <span class="comment">/* Give winstation audio drver name */</span>
00593     memset(DoConnectData.AudioDriverName, 0, <span class="keyword">sizeof</span>(DoConnectData.AudioDriverName));
00594     memcpy(DoConnectData.AudioDriverName, m-&gt;AudioDriverName, <span class="keyword">sizeof</span>(DoConnectData.AudioDriverName) - 2);
00595 
00596     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a77">NtUserRemoteConnect</a>(&amp;DoConnectData,
00597                                 <span class="keyword">sizeof</span>(DisplayDriverName),
00598                                 DisplayDriverName);
00599 
00600     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00601         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"NtUserRemoteConnect failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00602         <span class="keywordflow">goto</span> Exit;
00603     }
00604     
00605     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>( NtCurrentProcess(),
00606                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00607                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00608                                   0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00609                                   0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00610                                   0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00611                                   <a class="code" href="../../d2/d8/api_8c.html#a43">Win32CommandChannelThread</a>,
00612                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00613                                   &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00614                                   &amp;ClientId );
00615 
00616     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00617     
00618     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00619         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RtlCreateUserThread failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00620         <span class="keywordflow">goto</span> Exit;
00621     }
00622 
00623     <span class="comment">/*</span>
00624 <span class="comment">     *  Add thread to server thread pool</span>
00625 <span class="comment">     */</span>
00626     <span class="keywordflow">if</span> (CsrAddStaticServerThread(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, &amp;ClientId, 0) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00627         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"CsrAddStaticServerThread failed\n"</span>));
00628         <span class="keywordflow">goto</span> Exit;
00629     }
00630 
00631     <span class="comment">/*</span>
00632 <span class="comment">     * Boost priority of thread</span>
00633 <span class="comment">     */</span>
00634     Priority = THREAD_BASE_PRIORITY_MAX;
00635 
00636     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, ThreadBasePriority,
00637                                     &amp;Priority, <span class="keyword">sizeof</span>(Priority));
00638 
00639     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00640     
00641     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00642         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"NtSetInformationThread failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00643         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00644         <span class="keywordflow">goto</span> Exit;
00645     }
00646 
00647     <span class="comment">/*</span>
00648 <span class="comment">     * Resume the thread now that we've initialized things.</span>
00649 <span class="comment">     */</span>
00650     <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00651 
00652     <span class="keywordflow">if</span> (CsrConnectToUser() == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00653         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"CsrConnectToUser failed\n"</span>));
00654         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00655         <span class="keywordflow">goto</span> Exit;
00656     }
00657     
00658     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/api_8c.html#a24">CtxInitUser32</a>()) {
00659         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"CtxInitUser32 failed\n"</span>));
00660         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00661         <span class="keywordflow">goto</span> Exit;
00662     }
00663 
00664     <span class="comment">/*</span>
00665 <span class="comment">     * Create the Spooler service thread</span>
00666 <span class="comment">     */</span>
00667     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> != 0) {
00668         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/api_8c.html#a45">MultiUserSpoolerInit</a>();
00669     }
00670 
00671     <span class="comment">/*</span>
00672 <span class="comment">     * Save the resolution</span>
00673 <span class="comment">     */</span>
00674     <a class="code" href="../../d2/d8/api_8c.html#a4">gHRes</a>       = mDoReconnect.HRes;
00675     <a class="code" href="../../d2/d8/api_8c.html#a5">gVRes</a>       = mDoReconnect.VRes;
00676     <a class="code" href="../../d2/d8/api_8c.html#a6">gColorDepth</a> = mDoReconnect.ColorDepth;
00677 
00678 
00679 Exit:
00680 
00681 <span class="preprocessor">#if DBG</span>
00682 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00683         gulConnectCount++;
00684     }
00685 <span class="preprocessor">#endif // DBG</span>
00686 <span class="preprocessor"></span>
00687     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00688 }
00689 
00690 
00691 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00692"></a><a class="code" href="../../d2/d8/api_8c.html#a51">00692</a> <a class="code" href="../../d2/d8/api_8c.html#a51">W32WinStationDoDisconnect</a>(
00693     PWINSTATION_APIMSG pMsg)
00694 {
00695     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00696 
00697     memset(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>));
00698 
00699     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_XXXREMOTEDISCONNECT);
00700 
00701     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00702         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"xxxRemoteDisconnect failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00703     }
00704 
00705 <span class="preprocessor">#if DBG</span>
00706 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
00707         gulConnectCount--;
00708     }
00709 <span class="preprocessor">#endif // DBG</span>
00710 <span class="preprocessor"></span>
00711     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00712 
00713     UNREFERENCED_PARAMETER(pMsg);
00714 }
00715 
00716 
00717 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00718"></a><a class="code" href="../../d2/d8/api_8c.html#a52">00718</a> <a class="code" href="../../d2/d8/api_8c.html#a52">W32WinStationDoReconnect</a>(
00719     PWINSTATION_APIMSG pMsg)
00720 {
00721     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00722     <a class="code" href="../../d4/d8/struct__DORECONNECTDATA.html">DORECONNECTDATA</a>             DoReconnectData;
00723     WINSTATIONDORECONNECTMSG*   m = &amp;pMsg-&gt;u.DoReconnect;
00724 
00725     UserAssert(gulConnectCount == 0);
00726 
00727 
00728     memset(&amp;DoReconnectData, 0, <span class="keyword">sizeof</span>(DoReconnectData));
00729 
00730     DoReconnectData.fMouse = m-&gt;fMouse;
00731     DoReconnectData.fEnableWindowsKey = m-&gt;fEnableWindowsKey;
00732     DoReconnectData.fClientDoubleClickSupport = m-&gt;fClientDoubleClickSupport;
00733 
00734     memcpy(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>, m-&gt;WinStationName,
00735            <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>), <span class="keyword">sizeof</span>(m-&gt;WinStationName)));
00736 
00737     memcpy(DoReconnectData.WinStationName, <a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>,
00738            <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/api_8c.html#a15">G_WinStationName</a>), <span class="keyword">sizeof</span>(DoReconnectData.WinStationName)));
00739 
00740     DoReconnectData.drProtocolType = m-&gt;ProtocolType;
00741     DoReconnectData.drPelsHeight = m-&gt;VRes;
00742     DoReconnectData.drPelsWidth = m-&gt;HRes;
00743     DoReconnectData.drBitsPerPel = m-&gt;ColorDepth;
00744     <span class="keywordflow">if</span> ((m-&gt;fDynamicReconnect) &amp;&amp; (<a class="code" href="../../d2/d8/api_8c.html#a4">gHRes</a> != m-&gt;HRes || <a class="code" href="../../d2/d8/api_8c.html#a5">gVRes</a> != m-&gt;VRes || <a class="code" href="../../d2/d8/api_8c.html#a6">gColorDepth</a> != m-&gt;ColorDepth ) ) {
00745        DoReconnectData.fChangeDisplaySettings = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00746     }<span class="keywordflow">else</span>{
00747        DoReconnectData.fChangeDisplaySettings = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00748     }
00749     <span class="comment">//BUGBUG DoReconnectData.drDisplayFrequency is no yet setup</span>
00750     DoReconnectData.drDisplayFrequency = 0;
00751 
00752     <span class="comment">/*</span>
00753 <span class="comment">     * Give the information to the keyboard type/subtype/number of functions.</span>
00754 <span class="comment">     */</span>
00755     DoReconnectData.ClientKeyboardType.Type        = m-&gt;KeyboardType;
00756     DoReconnectData.ClientKeyboardType.SubType     = m-&gt;KeyboardSubType;
00757     DoReconnectData.ClientKeyboardType.FunctionKey = m-&gt;KeyboardFunctionKey;
00758 
00759     <a class="code" href="../../d2/d8/api_8c.html#a3">W32WinStationDumpReconnectInfo</a>( m, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00760 
00761     <span class="comment">/*</span>
00762 <span class="comment">     * Give the information to the WIN32 driver.</span>
00763 <span class="comment">     */</span>
00764 
00765     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)&amp;DoReconnectData,
00766                                           SFI_XXXREMOTERECONNECT);
00767 
00768     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00769         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"xxxRemoteReconnect failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00770     }<span class="keywordflow">else</span>{
00771 
00772     <span class="comment">/*</span>
00773 <span class="comment">     * Save the resolution</span>
00774 <span class="comment">     */</span>
00775         <a class="code" href="../../d2/d8/api_8c.html#a4">gHRes</a>       = m-&gt;HRes;
00776         <a class="code" href="../../d2/d8/api_8c.html#a5">gVRes</a>       = m-&gt;VRes;
00777         <a class="code" href="../../d2/d8/api_8c.html#a6">gColorDepth</a> = m-&gt;ColorDepth;
00778 
00779 <span class="preprocessor">#if DBG</span>
00780 <span class="preprocessor"></span>        gulConnectCount++;
00781 <span class="preprocessor">#endif // DBG</span>
00782 <span class="preprocessor"></span>    }
00783 
00784 
00785     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00786 }
00787 
00788 
00789 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00790"></a><a class="code" href="../../d2/d8/api_8c.html#a53">00790</a> <a class="code" href="../../d2/d8/api_8c.html#a53">W32WinStationExitWindows</a>(
00791     PWINSTATION_APIMSG pMsg)
00792 {
00793     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00794     WINSTATIONEXITWINDOWSMSG*   m = &amp;pMsg-&gt;u.ExitWindows;
00795 
00796     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> == 0) {
00797         <span class="comment">//BUGBUG v-nicbd: I am just wondering why it would be meaningless for the console. (?)</span>
00798         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"W32WinStationExitWindows meaningless for main session\n"</span>));
00799         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00800     }
00801 
00802     UserAssert(gulConnectCount &lt;= 1);
00803 
00804     <span class="comment">/*</span>
00805 <span class="comment">     *  Tell winlogon to logoff</span>
00806 <span class="comment">     */</span>
00807     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_REMOTELOGOFF);
00808 
00809     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00810         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemoteLogoff failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00811     }
00812 
00813     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00814 }
00815 
00816 
00817 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00818"></a><a class="code" href="../../d2/d8/api_8c.html#a54">00818</a> <a class="code" href="../../d2/d8/api_8c.html#a54">W32WinStationTerminate</a>(
00819     PWINSTATION_APIMSG pMsg)
00820 {
00821     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00822     HANDLE   hevtShutDown;
00823     HANDLE   hevtRitExited, hevtRitStuck;
00824 
00825 <span class="keyword">extern</span> HANDLE <a class="code" href="../../d4/d4/command_8c.html#a2">WinStationIcaApiPort</a>;
00826 
00827     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00828 
00829     <span class="comment">/*</span>
00830 <span class="comment">     * Get rid of hard error thread</span>
00831 <span class="comment">     */</span>
00832 
00833     
00834     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> != 0) {
00835 
00836         <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>(-1, <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>);
00837 
00838         <span class="comment">/*</span>
00839 <span class="comment">         * Poll (!!?) for hard error thread completion.  The thread does</span>
00840 <span class="comment">         * not exit.</span>
00841 <span class="comment">         */</span>
00842         <span class="keywordflow">while</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> != 0) {
00843             <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"Waiting for hard error thread to stop...\n"</span>));
00844 
00845             Sleep(3 * 1000);
00846         }
00847 
00848         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"Stopped hard error thread\n"</span>));
00849     }
00850 
00851     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a20">g_hDoMessageEvent</a>)
00852         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(<a class="code" href="../../d2/d8/api_8c.html#a20">g_hDoMessageEvent</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00853 
00854     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a10">G_IcaMouseChannel</a>) {
00855         CloseHandle(<a class="code" href="../../d2/d8/api_8c.html#a10">G_IcaMouseChannel</a>);
00856         <a class="code" href="../../d2/d8/api_8c.html#a10">G_IcaMouseChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00857     }
00858 
00859     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a11">G_IcaKeyboardChannel</a>) {
00860         CloseHandle(<a class="code" href="../../d2/d8/api_8c.html#a11">G_IcaKeyboardChannel</a>);
00861         <a class="code" href="../../d2/d8/api_8c.html#a11">G_IcaKeyboardChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00862     }
00863 
00864     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a13">G_IcaCommandChannel</a>) {
00865         CloseHandle(<a class="code" href="../../d2/d8/api_8c.html#a13">G_IcaCommandChannel</a>);
00866         <a class="code" href="../../d2/d8/api_8c.html#a13">G_IcaCommandChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00867     }
00868 
00869     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a9">G_IcaVideoChannel</a>) {
00870         CloseHandle(<a class="code" href="../../d2/d8/api_8c.html#a9">G_IcaVideoChannel</a>);
00871         <a class="code" href="../../d2/d8/api_8c.html#a9">G_IcaVideoChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00872     }
00873     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a12">G_IcaBeepChannel</a>) {
00874         CloseHandle(<a class="code" href="../../d2/d8/api_8c.html#a12">G_IcaBeepChannel</a>);
00875         <a class="code" href="../../d2/d8/api_8c.html#a12">G_IcaBeepChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00876     }
00877     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a14">G_IcaThinwireChannel</a>) {
00878         CloseHandle(<a class="code" href="../../d2/d8/api_8c.html#a14">G_IcaThinwireChannel</a>);
00879         <a class="code" href="../../d2/d8/api_8c.html#a14">G_IcaThinwireChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00880     }
00881     
00882     hevtShutDown = OpenEvent(EVENT_ALL_ACCESS,
00883                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00884                              <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EventShutDownCSRSS"</span>);
00885 
00886     <span class="keywordflow">if</span> (hevtShutDown == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00887         <span class="comment">/*</span>
00888 <span class="comment">         * This case is for cached sessions where RIT and Destiop thread have</span>
00889 <span class="comment">         * not been created.</span>
00890 <span class="comment">         */</span>
00891         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"W32WinStationTerminate terminating CSRSS ...\n"</span>));
00892 
00893         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/api_8c.html#a22">CleanupSessionObjectDirectories</a>();
00894 
00895         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a>) {
00896             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a>);
00897             <a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00898         }
00899 
00900         <span class="keywordflow">return</span> 0;
00901     }
00902 
00903     hevtRitExited = CreateEvent(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00904                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00905                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00906                                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EventRitExited"</span>);
00907 
00908     UserAssert(hevtRitExited != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00909 
00910     hevtRitStuck = CreateEvent(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00911                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00912                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00913                                <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EventRitStuck"</span>);
00914 
00915     UserAssert(hevtRitStuck != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00916     
00917     <span class="comment">/*</span>
00918 <span class="comment">     * RIT is created. Signal this event that starts the</span>
00919 <span class="comment">     * cleanup in win32k</span>
00920 <span class="comment">     */</span>
00921     SetEvent(hevtShutDown);
00922 
00923     <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"EventShutDownCSRSS set in CSRSS ...\n"</span>));
00924 
00925     
00926     <span class="keywordflow">while</span> (1) {
00927 
00928         HANDLE arHandles[2] = {hevtRitExited, hevtRitStuck};
00929         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  result;
00930         
00931         result = WaitForMultipleObjects(2, arHandles, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, INFINITE);
00932 
00933         <span class="keywordflow">switch</span> (result) {
00934         <span class="keywordflow">case</span> WAIT_OBJECT_0:
00935             <span class="keywordflow">goto</span> RITExited;
00936         
00937         <span class="keywordflow">case</span> WAIT_OBJECT_0 + 1:
00938             
00939             <span class="comment">/*</span>
00940 <span class="comment">             * The RIT is stucked because there are still GUI threads</span>
00941 <span class="comment">             * assigned to desktops. One reason for this is that winlogon</span>
00942 <span class="comment">             * died w/o calling ExitWindowsEx.</span>
00943 <span class="comment">             */</span>
00944             UserAssert(<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00945 
00946             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a>) {
00947                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a>);
00948                 <a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00949             }
00950             <span class="keywordflow">break</span>;
00951         <span class="keywordflow">default</span>:
00952             UserAssert(0);
00953             <span class="keywordflow">break</span>;
00954         }
00955     }
00956     
00957 RITExited:
00958 
00959     <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"EventRitExited set in CSRSS ...\n"</span>));
00960 
00961     CloseHandle(hevtRitExited);
00962     CloseHandle(hevtRitStuck);
00963 
00964     CloseHandle(hevtShutDown);
00965 
00966     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/api_8c.html#a22">CleanupSessionObjectDirectories</a>();
00967 
00968     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a>) {
00969         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a>);
00970         <a class="code" href="../../d2/d8/api_8c.html#a7">ghportLPC</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00971     }
00972 
00973     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00974     UNREFERENCED_PARAMETER(pMsg);
00975 }
00976 
00977 
00978 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00979"></a><a class="code" href="../../d2/d8/api_8c.html#a55">00979</a> <a class="code" href="../../d2/d8/api_8c.html#a55">W32WinStationNtSecurity</a>(
00980     PWINSTATION_APIMSG pMsg)
00981 {
00982     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00983 
00984     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_REMOTENTSECURITY);
00985 
00986     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00987         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemoteNtSecurity failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00988     }
00989 
00990     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00991     UNREFERENCED_PARAMETER(pMsg);
00992 }
00993 
00994 
00995 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00996"></a><a class="code" href="../../d2/d8/api_8c.html#a56">00996</a> <a class="code" href="../../d2/d8/api_8c.html#a56">W32WinStationDoMessage</a>(
00997     PWINSTATION_APIMSG pMsg)
00998 {
00999     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01000 
01001     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d4/icamsg_8c.html#a11">RemoteDoMessage</a>(pMsg);
01002 
01003     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01004         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemoteDoMessage failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01005     }
01006 
01007     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01008 }
01009 
01010  <span class="comment">// This is the counter part to SMWinStationBroadcastSystemMessage  </span>
01011 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> 
<a name="l01012"></a><a class="code" href="../../d2/d8/api_8c.html#a57">01012</a> <a class="code" href="../../d2/d8/api_8c.html#a57">W32WinStationBroadcastSystemMessage</a>( 
01013     PWINSTATION_APIMSG pMsg )
01014 {
01015 
01016     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01017     
01018     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/server_2sendmsg_8c.html#a1">RemoteDoBroadcastSystemMessage</a>(pMsg);
01019     
01020     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01021         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemoteDoBroadcastSystemMessage(): failed with status 0x%lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01022     }
01023 
01024     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01025 }
01026  <span class="comment">// This is the counter part to SMWinStationSendWindowMessage</span>
01027 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> 
<a name="l01028"></a><a class="code" href="../../d2/d8/api_8c.html#a58">01028</a> <a class="code" href="../../d2/d8/api_8c.html#a58">W32WinStationSendWindowMessage</a>( 
01029     PWINSTATION_APIMSG  pMsg)
01030 {
01031 
01032     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01033     
01034     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/server_2sendmsg_8c.html#a2">RemoteDoSendWindowMessage</a>(pMsg);
01035 
01036     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01037         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemoteDoSendWindowMessage failed with Status 0x%lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01038     }
01039 
01040     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01041 }
01042 
01043 
01044 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01045"></a><a class="code" href="../../d2/d8/api_8c.html#a59">01045</a> <a class="code" href="../../d2/d8/api_8c.html#a59">W32WinStationThinwireStats</a>(
01046     PWINSTATION_APIMSG pMsg)
01047 {
01048     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01049     WINSTATIONTHINWIRESTATSMSG* m = &amp;pMsg-&gt;u.ThinwireStats;
01050 
01051     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)&amp;m-&gt;Stats,
01052                                           SFI_REMOTETHINWIRESTATS);
01053 
01054     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01055         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemoteThinwireStats failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01056     }
01057 
01058     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01059 }
01060 
01061 
01062 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01063"></a><a class="code" href="../../d2/d8/api_8c.html#a60">01063</a> <a class="code" href="../../d2/d8/api_8c.html#a60">W32WinStationShadowSetup</a>(
01064     PWINSTATION_APIMSG pMsg)
01065 {
01066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01067     WINSTATIONSHADOWSETUPMSG* m = &amp;pMsg-&gt;u.ShadowSetup;
01068 
01069     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_XXXREMOTESHADOWSETUP);
01070 
01071     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01072         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"xxxRemoteShadowSetup failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01073     }
01074 
01075     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01076 }
01077 
01078 
01079 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01080"></a><a class="code" href="../../d2/d8/api_8c.html#a61">01080</a> <a class="code" href="../../d2/d8/api_8c.html#a61">W32WinStationShadowStart</a>(
01081     PWINSTATION_APIMSG pMsg)
01082 {
01083     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01084     WINSTATIONSHADOWSTARTMSG* m = &amp;pMsg-&gt;u.ShadowStart;
01085 
01086     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>((ULONG_PTR)m-&gt;pThinwireData,
01087                                           (ULONG_PTR)m-&gt;ThinwireDataLength,
01088                                           SFI_REMOTESHADOWSTART);
01089 
01090     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01091         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemoteShadowStart failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01092     }
01093 
01094     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01095 }
01096 
01097 
01098 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01099"></a><a class="code" href="../../d2/d8/api_8c.html#a62">01099</a> <a class="code" href="../../d2/d8/api_8c.html#a62">W32WinStationShadowStop</a>(
01100     PWINSTATION_APIMSG pMsg)
01101 {
01102     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01103     WINSTATIONSHADOWSTOPMSG* m = &amp;pMsg-&gt;u.ShadowStop;
01104 
01105     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_XXXREMOTESHADOWSTOP);
01106 
01107     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01108         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"xxxRemoteShadowStop failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01109     }
01110 
01111     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01112 }
01113 
01114 
01115 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01116"></a><a class="code" href="../../d2/d8/api_8c.html#a63">01116</a> <a class="code" href="../../d2/d8/api_8c.html#a63">W32WinStationShadowCleanup</a>(
01117     PWINSTATION_APIMSG pMsg)
01118 {
01119     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01120     WINSTATIONSHADOWCLEANUPMSG* m = &amp;pMsg-&gt;u.ShadowCleanup;
01121 
01122     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>((ULONG_PTR)m-&gt;pThinwireData,
01123                                           (ULONG_PTR)m-&gt;ThinwireDataLength,
01124                                           SFI_REMOTESHADOWCLEANUP);
01125 
01126     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01127         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemoteShadowCleanup failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01128     }
01129 
01130     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01131 }
01132 
01133 
01134 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01135"></a><a class="code" href="../../d2/d8/api_8c.html#a64">01135</a> <a class="code" href="../../d2/d8/api_8c.html#a64">W32WinStationPassthruEnable</a>(
01136     PWINSTATION_APIMSG pMsg)
01137 {
01138     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01139 
01140     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_XXXREMOTEPASSTHRUENABLE);
01141 
01142     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01143         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"xxxRemotePassthruEnable failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01144     }
01145 
01146     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01147     UNREFERENCED_PARAMETER(pMsg);
01148 }
01149 
01150 
01151 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01152"></a><a class="code" href="../../d2/d8/api_8c.html#a65">01152</a> <a class="code" href="../../d2/d8/api_8c.html#a65">W32WinStationPassthruDisable</a>(
01153     PWINSTATION_APIMSG pMsg)
01154 {
01155     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01156 
01157     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_REMOTEPASSTHRUDISABLE);
01158 
01159     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01160         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"RemotePassthruDisable failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01161     }
01162 
01163     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01164     UNREFERENCED_PARAMETER(pMsg);
01165 }
01166 
01167 
01168 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01169"></a><a class="code" href="../../d2/d8/api_8c.html#a66">01169</a> <a class="code" href="../../d2/d8/api_8c.html#a22">CleanupSessionObjectDirectories</a>(
01170     VOID)
01171 {
01172     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01173     OBJECT_ATTRIBUTES Attributes;
01174     UNICODE_STRING    UnicodeString;
01175     HANDLE            LinkHandle;
01176     POBJECT_DIRECTORY_INFORMATION DirInfo;
01177     BOOLEAN           RestartScan;
01178     UCHAR             DirInfoBuffer[ 4096 ];
01179     WCHAR             szSessionString [ <a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a> ];
01180     ULONG             Context = 0;
01181     ULONG             ReturnedLength;
01182     HANDLE            DosDevicesDirectory;
01183     HANDLE            *HandleArray;
01184     ULONG             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 100;
01185     ULONG             i, <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
01186 
01187     swprintf(szSessionString,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws\\%ld\\DosDevices"</span>,<a class="code" href="../../d8/d9/dllinit_8c.html#a2">SESSION_ROOT</a>,NtCurrentPeb()-&gt;SessionId);
01188 
01189     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, szSessionString);
01190 
01191     InitializeObjectAttributes(&amp;Attributes,
01192                                &amp;UnicodeString,
01193                                OBJ_CASE_INSENSITIVE,
01194                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01195                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01196 
01197     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a1">NtOpenDirectoryObject</a>(&amp;DosDevicesDirectory,
01198                                    DIRECTORY_ALL_ACCESS,
01199                                    &amp;Attributes);
01200 
01201     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01202         <a class="code" href="../../d0/d0/ntuser_8h.html#a1">DBGHYD</a>((<span class="stringliteral">"NtOpenDirectoryObject failed with Status %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01203         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01204     }
01205 
01206 Restart:
01207     HandleArray = (HANDLE *)LocalAlloc(LPTR, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> * <span class="keyword">sizeof</span>(HANDLE));
01208 
01209     <span class="keywordflow">if</span> (HandleArray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01210 
01211         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(DosDevicesDirectory);
01212         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01213     }
01214 
01215     RestartScan = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01216     DirInfo = (POBJECT_DIRECTORY_INFORMATION)&amp;DirInfoBuffer;
01217 
01218     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01219         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a2">NtQueryDirectoryObject</a>( DosDevicesDirectory,
01220                                          (PVOID)DirInfo,
01221                                          <span class="keyword">sizeof</span>(DirInfoBuffer),
01222                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01223                                          RestartScan,
01224                                          &amp;Context,
01225                                          &amp;ReturnedLength);
01226 
01227         <span class="comment">/*</span>
01228 <span class="comment">         *  Check the status of the operation.</span>
01229 <span class="comment">         */</span>
01230         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01231 
01232             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
01233                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01234             }
01235             <span class="keywordflow">break</span>;
01236         }
01237 
01238         <span class="keywordflow">if</span> (!wcscmp(DirInfo-&gt;TypeName.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SymbolicLink"</span>)) {
01239 
01240             <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt;= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ) {
01241 
01242                 <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> ; i++) {
01243                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (HandleArray[i]);
01244                 }
01245                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += 20;
01246                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
01247                 LocalFree(HandleArray);
01248                 <span class="keywordflow">goto</span> Restart;
01249 
01250             }
01251 
01252             InitializeObjectAttributes( &amp;Attributes,
01253                                         &amp;DirInfo-&gt;Name,
01254                                         OBJ_CASE_INSENSITIVE,
01255                                         DosDevicesDirectory,
01256                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01257 
01258             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>( &amp;LinkHandle,
01259                                                SYMBOLIC_LINK_ALL_ACCESS,
01260                                                &amp;Attributes);
01261 
01262             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01263 
01264                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a2">NtMakeTemporaryObject</a>( LinkHandle );
01265 
01266                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01267                     HandleArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = LinkHandle;
01268                     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
01269                 }
01270             }
01271 
01272         }
01273         RestartScan = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01274      }
01275 
01276      <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> ; i++) {
01277 
01278          <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (HandleArray[i]);
01279 
01280      }
01281 
01282      LocalFree(HandleArray);
01283 
01284      <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(DosDevicesDirectory);
01285 
01286      <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01287 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
