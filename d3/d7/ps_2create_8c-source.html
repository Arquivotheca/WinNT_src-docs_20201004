<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: create.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>create.c</h1><a href="../../d2/d8/ps_2create_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    create.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Process and Thread Creation.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 20-Apr-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">// This should really be in MM.H, but it cant be there yet.</span>
00025 <span class="comment">//</span>
<a name="l00026"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a0">00026</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
00027 
00028 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtCreateThread)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtCreateProcess)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsCreateSystemThread)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspCreateThread)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsCreateSystemProcess)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspCreateProcess)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspUserThreadStartup)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsLockProcess)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsUnlockProcess)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsSetLoadImageNotifyRoutine)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsCallImageNotifyRoutines)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 
<a name="l00043"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a1">00043</a> <span class="keyword">extern</span> UNICODE_STRING <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>;
00044 
<a name="l00045"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a2">00045</a> LCID <a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a>;
<a name="l00046"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a3">00046</a> LCID <a class="code" href="../../d1/d9/ps_8h.html#a59">PsDefaultThreadLocaleId</a>;
<a name="l00047"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a4">00047</a> LANGID <a class="code" href="../../d1/d9/ps_8h.html#a60">PsDefaultUILanguageId</a>;
<a name="l00048"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a5">00048</a> LANGID <a class="code" href="../../d1/d9/ps_8h.html#a61">PsInstallUILanguageId</a>;
00049 
00050 <span class="comment">//</span>
00051 <span class="comment">// The following two globals are present to make it easier to change</span>
00052 <span class="comment">// working set sizes when debugging.</span>
00053 <span class="comment">//</span>
00054 
<a name="l00055"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a6">00055</a> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a> = 20;
<a name="l00056"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a7">00056</a> ULONG <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a> = 45;
00057 
<a name="l00058"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a8">00058</a> BOOLEAN <a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a>;
00059 
00060 <span class="comment">//</span>
00061 <span class="comment">// Define the local storage for the process lock fast mutex.</span>
00062 <span class="comment">//</span>
00063 
<a name="l00064"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a9">00064</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a>;
00065 
00066 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00067"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a10">00067</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a10">NtCreateThread</a>(
00068     OUT PHANDLE ThreadHandle,
00069     IN ACCESS_MASK DesiredAccess,
00070     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00071     IN HANDLE ProcessHandle,
00072     OUT PCLIENT_ID ClientId,
00073     IN PCONTEXT ThreadContext,
00074     IN PINITIAL_TEB InitialTeb,
00075     IN BOOLEAN CreateSuspended
00076     )
00077 
00078 <span class="comment">/*++</span>
00079 <span class="comment"></span>
00080 <span class="comment">Routine Description:</span>
00081 <span class="comment"></span>
00082 <span class="comment">    This system service API creates and initializes a thread object.</span>
00083 <span class="comment"></span>
00084 <span class="comment">Arguments:</span>
00085 <span class="comment"></span>
00086 <span class="comment">    ThreadHandle - Returns the handle for the new thread.</span>
00087 <span class="comment"></span>
00088 <span class="comment">    DesiredAccess - Supplies the desired access modes to the new thread.</span>
00089 <span class="comment"></span>
00090 <span class="comment">    ObjectAttributes - Supplies the object attributes of the new thread.</span>
00091 <span class="comment"></span>
00092 <span class="comment">    ProcessHandle - Supplies a handle to the process that the thread is being</span>
00093 <span class="comment">                    created within.</span>
00094 <span class="comment"></span>
00095 <span class="comment">    ClientId - Returns the CLIENT_ID of the new thread.</span>
00096 <span class="comment"></span>
00097 <span class="comment">    ThreadContext - Supplies an initial context for the new thread.</span>
00098 <span class="comment"></span>
00099 <span class="comment">    InitialTeb - Supplies the initial contents for the thread's TEB.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    CreateSuspended - Supplies a value that controls whether or not a</span>
00102 <span class="comment">                      thread is created in a suspended state.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Return Value:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    TBD</span>
00107 <span class="comment"></span>
00108 <span class="comment">--*/</span>
00109 
00110 {
00111     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00112     INITIAL_TEB CapturedInitialTeb;
00113 
00114     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00115 
00116     <span class="keywordflow">if</span> ( KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">// Probe all arguments</span>
00120         <span class="comment">//</span>
00121 
00122         <span class="keywordflow">try</span> {
00123             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>);
00124 
00125             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ClientId) ) {
00126                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)ClientId);
00127                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ClientId, <span class="keyword">sizeof</span>(CLIENT_ID), <span class="keyword">sizeof</span>(ULONG));
00128             }
00129 
00130             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>) ) {
00131                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>, <span class="keyword">sizeof</span>(CONTEXT), CONTEXT_ALIGN);
00132                 }
00133             <span class="keywordflow">else</span> {
00134                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00135                 }
00136             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb), <span class="keyword">sizeof</span>(ULONG));
00137             CapturedInitialTeb.OldInitialTeb = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb;
00138             <span class="keywordflow">if</span> (CapturedInitialTeb.OldInitialTeb.OldStackBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00139                 CapturedInitialTeb.OldInitialTeb.OldStackLimit == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00140                ) {
00141                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>, <span class="keyword">sizeof</span>(INITIAL_TEB), <span class="keyword">sizeof</span>(ULONG));
00142                 CapturedInitialTeb = *<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>;
00143             }
00144         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00145             <span class="keywordflow">return</span> GetExceptionCode();
00146         }
00147     } <span class="keywordflow">else</span> {
00148         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00149             <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackLimit == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00150            ) {
00151             CapturedInitialTeb = *<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>;
00152         } <span class="keywordflow">else</span> {
00153             CapturedInitialTeb.OldInitialTeb = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb;
00154         }
00155     }
00156 
00157     st = <a class="code" href="../../d8/d1/psp_8h.html#a63">PspCreateThread</a> (
00158             <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00159             DesiredAccess,
00160             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00161             ProcessHandle,
00162             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00163             ClientId,
00164             <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>,
00165             &amp;CapturedInitialTeb,
00166             CreateSuspended,
00167             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00168             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00169             );
00170 
00171     <span class="keywordflow">return</span> st;
00172 }
00173 
00174 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00175"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a11">00175</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
00176     OUT PHANDLE ThreadHandle,
00177     IN ACCESS_MASK DesiredAccess,
00178     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00179     IN HANDLE ProcessHandle OPTIONAL,
00180     OUT PCLIENT_ID ClientId OPTIONAL,
00181     IN <a class="code" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine,
00182     IN PVOID StartContext
00183     )
00184 
00185 <span class="comment">/*++</span>
00186 <span class="comment"></span>
00187 <span class="comment">Routine Description:</span>
00188 <span class="comment"></span>
00189 <span class="comment">    This routine creates and starts a system thread.</span>
00190 <span class="comment"></span>
00191 <span class="comment">Arguments:</span>
00192 <span class="comment"></span>
00193 <span class="comment">    ThreadHandle - Returns the handle for the new thread.</span>
00194 <span class="comment"></span>
00195 <span class="comment">    DesiredAccess - Supplies the desired access modes to the new thread.</span>
00196 <span class="comment"></span>
00197 <span class="comment">    ObjectAttributes - Supplies the object attributes of the new thread.</span>
00198 <span class="comment"></span>
00199 <span class="comment">    ProcessHandle - Supplies a handle to the process that the thread is being</span>
00200 <span class="comment">                    created within.  If this parameter is not specified, then</span>
00201 <span class="comment">                    the initial system process is used.</span>
00202 <span class="comment"></span>
00203 <span class="comment">    ClientId - Returns the CLIENT_ID of the new thread.</span>
00204 <span class="comment"></span>
00205 <span class="comment">    StartRoutine - Supplies the address of the system thread start routine.</span>
00206 <span class="comment"></span>
00207 <span class="comment">    StartContext - Supplies context for a system thread start routine.</span>
00208 <span class="comment"></span>
00209 <span class="comment">Return Value:</span>
00210 <span class="comment"></span>
00211 <span class="comment">    TBD</span>
00212 <span class="comment"></span>
00213 <span class="comment">--*/</span>
00214 
00215 {
00216     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00217     HANDLE SystemProcess;
00218     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessPointer;
00219 
00220     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00221 
00222     ProcessPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00223     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ProcessHandle)) {
00224         SystemProcess = ProcessHandle;
00225     } <span class="keywordflow">else</span> {
00226         SystemProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00227         ProcessPointer = <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>;
00228     }
00229 
00230     st = <a class="code" href="../../d8/d1/psp_8h.html#a63">PspCreateThread</a> (
00231         <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00232         DesiredAccess,
00233         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00234         SystemProcess,
00235         ProcessPointer,
00236         ClientId,
00237         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00238         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00239         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00240         StartRoutine,
00241         StartContext
00242         );
00243 
00244     <span class="keywordflow">return</span> st;
00245 }
00246 
00247 
00248 BOOLEAN
<a name="l00249"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a12">00249</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a12">PspMarkProcessIdValid</a>(
00250     IN <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleEntry,
00251     IN ULONG_PTR Parameter
00252     )
00253 {
00254     HandleEntry-&gt;Object = (PVOID)Parameter;
00255     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00256 }
00257 
00258 
00259 
00260 
00261 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00262"></a><a class="code" href="../../d8/d1/psp_8h.html#a63">00262</a> <a class="code" href="../../d8/d1/psp_8h.html#a63">PspCreateThread</a>(
00263     OUT PHANDLE ThreadHandle,
00264     IN ACCESS_MASK DesiredAccess,
00265     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00266     IN HANDLE ProcessHandle,
00267     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessPointer,
00268     OUT PCLIENT_ID ClientId OPTIONAL,
00269     IN PCONTEXT ThreadContext OPTIONAL,
00270     IN PINITIAL_TEB InitialTeb OPTIONAL,
00271     IN BOOLEAN CreateSuspended,
00272     IN PKSTART_ROUTINE StartRoutine OPTIONAL,
00273     IN PVOID StartContext
00274     )
00275 
00276 <span class="comment">/*++</span>
00277 <span class="comment"></span>
00278 <span class="comment">Routine Description:</span>
00279 <span class="comment"></span>
00280 <span class="comment">    This routine creates and initializes a thread object. It implements the</span>
00281 <span class="comment">    foundation for NtCreateThread and for PsCreateSystemThread.</span>
00282 <span class="comment"></span>
00283 <span class="comment">Arguments:</span>
00284 <span class="comment"></span>
00285 <span class="comment">    ThreadHandle - Returns the handle for the new thread.</span>
00286 <span class="comment"></span>
00287 <span class="comment">    DesiredAccess - Supplies the desired access modes to the new thread.</span>
00288 <span class="comment"></span>
00289 <span class="comment">    ObjectAttributes - Supplies the object attributes of the new thread.</span>
00290 <span class="comment"></span>
00291 <span class="comment">    ProcessHandle - Supplies a handle to the process that the thread is being</span>
00292 <span class="comment">                    created within.</span>
00293 <span class="comment"></span>
00294 <span class="comment">    ClientId - Returns the CLIENT_ID of the new thread.</span>
00295 <span class="comment"></span>
00296 <span class="comment">    ThreadContext - Supplies a pointer to a context frame that represents the</span>
00297 <span class="comment">                initial user-mode context for a user-mode thread. The absence</span>
00298 <span class="comment">                of this parameter indicates that a system thread is being</span>
00299 <span class="comment">                created.</span>
00300 <span class="comment"></span>
00301 <span class="comment">    InitialTeb - Supplies the contents of certain fields for the new threads</span>
00302 <span class="comment">                 TEB. This parameter is only examined if both a trap and</span>
00303 <span class="comment">                 exception frame were specified.</span>
00304 <span class="comment"></span>
00305 <span class="comment">    CreateSuspended - Supplies a value that controls whether or not a user-mode</span>
00306 <span class="comment">                      thread is created in a suspended state.</span>
00307 <span class="comment"></span>
00308 <span class="comment">    StartRoutine - Supplies the address of the system thread start routine.</span>
00309 <span class="comment"></span>
00310 <span class="comment">    StartContext - Supplies context for a system thread start routine.</span>
00311 <span class="comment"></span>
00312 <span class="comment">Return Value:</span>
00313 <span class="comment"></span>
00314 <span class="comment">    TBD</span>
00315 <span class="comment"></span>
00316 <span class="comment">--*/</span>
00317 
00318 {
00319 
00320     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> CidEntry;
00321     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00322     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00323     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00324     PVOID KernelStack;
00325     PTEB Teb;
00326     INITIAL_TEB ITeb;
00327     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00328     HANDLE LocalThreadHandle;
00329     BOOLEAN AccessCheck;
00330     BOOLEAN MemoryAllocated;
00331     PSECURITY_DESCRIPTOR SecurityDescriptor;
00332     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
00333     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> accesst;
00334     LARGE_INTEGER NullTime;
00335     LARGE_INTEGER CreateTime;
00336     BOOLEAN NeedToFixProcessId = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00337 
00338     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00339 
00340     NullTime.LowPart = 0;
00341     NullTime.HighPart = 0;
00342 
00343     <span class="keywordflow">if</span> ( StartRoutine ) {
00344         PreviousMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00345     } <span class="keywordflow">else</span> {
00346         PreviousMode = KeGetPreviousMode();
00347     }
00348 
00349     Teb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00350 
00351     Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00352     Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00353     KernelStack = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00354 
00355     <span class="keywordflow">if</span> ( ProcessHandle ) {
00356         <span class="comment">//</span>
00357         <span class="comment">// Process object reference count is biased by one for each thread.</span>
00358         <span class="comment">// This accounts for the pointer given to the kernel that remains</span>
00359         <span class="comment">// in effect until the thread terminates (and becomes signaled)</span>
00360         <span class="comment">//</span>
00361 
00362         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00363                     ProcessHandle,
00364                     PROCESS_CREATE_THREAD,
00365                     <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00366                     PreviousMode,
00367                     (PVOID *)&amp;Process,
00368                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00369                     );
00370         }
00371     <span class="keywordflow">else</span> {
00372         <span class="keywordflow">if</span> ( StartRoutine ) {
00373             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(ProcessPointer);
00374             Process = ProcessPointer;
00375             st = STATUS_SUCCESS;
00376             }
00377         <span class="keywordflow">else</span> {
00378             st = STATUS_INVALID_HANDLE;
00379             }
00380         }
00381     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00382         <span class="keywordflow">return</span> st;
00383     }
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">// If the previous mode is user and the target process is the system</span>
00387     <span class="comment">// process, then the operation cannot be performed.</span>
00388     <span class="comment">//</span>
00389 
00390     <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (Process == <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>)) {
00391         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00392         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00393     }
00394 
00395     st = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
00396              PreviousMode,
00397              <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00398              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00399              PreviousMode,
00400              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00401              (ULONG) <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>),
00402              0,
00403              0,
00404              (PVOID *)&amp;Thread
00405              );
00406     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) ) {
00407         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00408         <span class="keywordflow">return</span> st;
00409     }
00410 
00411     RtlZeroMemory(Thread,<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/ps_8h.html#a39">ETHREAD</a>));
00412     CidEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = Thread;
00413     CidEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = 0;
00414     Thread-&gt;Cid.UniqueThread = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>,&amp;CidEntry);
00415 
00416     <span class="keywordflow">if</span> ( !Thread-&gt;Cid.UniqueThread ) {
00417         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00418         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00419         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00420     }
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Initialize Mm</span>
00424     <span class="comment">//</span>
00425 
00426     Thread-&gt;ReadClusterSize = <a class="code" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a>;
00427 
00428     <span class="comment">//</span>
00429     <span class="comment">// Initialize LPC</span>
00430     <span class="comment">//</span>
00431 
00432     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(&amp;Thread-&gt;LpcReplySemaphore,0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00433     InitializeListHead( &amp;Thread-&gt;LpcReplyChain );
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">// Initialize Io</span>
00437     <span class="comment">//</span>
00438 
00439     InitializeListHead(&amp;Thread-&gt;IrpList);
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">// Initialize Registry</span>
00443     <span class="comment">//</span>
00444 
00445     InitializeListHead(&amp;Thread-&gt;PostBlockList);
00446 
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// Initialize Security</span>
00450     <span class="comment">//</span>
00451 
00452     <a class="code" href="../../d6/d5/ps_2security_8c.html#a13">PspInitializeThreadSecurity</a>( Process, Thread );
00453 
00454     <span class="comment">//</span>
00455 
00456     InitializeListHead(&amp;Thread-&gt;TerminationPortList);
00457 
00458     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Thread-&gt;ActiveTimerListLock);
00459     InitializeListHead(&amp;Thread-&gt;ActiveTimerListHead);
00460 
00461     <span class="comment">//</span>
00462     <span class="comment">// Allocate Kernel Stack</span>
00463     <span class="comment">//</span>
00464 
00465     KernelStack = <a class="code" href="../../d4/d5/procsup_8c.html#a33">MmCreateKernelStack</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00466     <span class="keywordflow">if</span> ( !KernelStack ) {
00467         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00468         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00469 
00470         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00471     }
00472 
00473     st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,<a class="code" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>);
00474     <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
00475         <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(KernelStack, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00476         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00477         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00478 
00479         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00480         }
00481 
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// If the process does not have its part of the client id, then</span>
00485     <span class="comment">// assign one</span>
00486     <span class="comment">//</span>
00487 
00488     <span class="keywordflow">if</span> ( !Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> ) {
00489         CidEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a0">PSP_INVALID_ID</a>;
00490         CidEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = 0;
00491         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>,&amp;CidEntry);
00492         <a class="code" href="../../d5/d8/ex_8h.html#a77">ExSetHandleTableOwner</a>( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>, Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> );
00493         <span class="keywordflow">if</span> (!Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>) {
00494             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00495 
00496             <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(KernelStack, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00497             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00498             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00499 
00500             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00501         }
00502 
00503         NeedToFixProcessId = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00504 
00505         <a class="code" href="../../d2/d1/mm_8h.html#a87">PERFINFO_PROCESS_CREATE</a>(Process);
00506     }
00507     Thread-&gt;Cid.UniqueProcess = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>;
00508 
00509     Thread-&gt;ThreadsProcess = Process;
00510 
00511     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>)) {
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// FIX. Handle exception on bad context</span>
00515         <span class="comment">//</span>
00516 
00517         <span class="comment">//</span>
00518         <span class="comment">// User-mode thread</span>
00519         <span class="comment">//</span>
00520 
00521         <span class="keywordflow">try</span> {
00522 
00523             ITeb = *<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>;
00524 
00525             Teb = <a class="code" href="../../d4/d5/procsup_8c.html#a40">MmCreateTeb</a> ( Process, &amp;ITeb, &amp;Thread-&gt;Cid );
00526 
00527             <span class="comment">//</span>
00528             <span class="comment">// Initialize kernel thread object for user mode thread.</span>
00529             <span class="comment">//</span>
00530 
00531             Thread-&gt;StartAddress = (PVOID)CONTEXT_TO_PROGRAM_COUNTER(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>);
00532 <span class="preprocessor">#if defined(_IA64_)</span>
00533 <span class="preprocessor"></span>            Thread-&gt;Win32StartAddress = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;IntT0;
00534 <span class="preprocessor">#endif // _IA64_</span>
00535 <span class="preprocessor"></span>
00536 <span class="preprocessor">#if defined(_X86_)</span>
00537 <span class="preprocessor"></span>            Thread-&gt;Win32StartAddress = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;Eax;
00538 <span class="preprocessor">#endif // _X86_</span>
00539 <span class="preprocessor"></span>
00540 <span class="preprocessor">#if defined(_MIPS_)</span>
00541 <span class="preprocessor"></span>            Thread-&gt;Win32StartAddress = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;XIntA0;
00542 <span class="preprocessor">#endif // _MIPS_</span>
00543 <span class="preprocessor"></span>
00544 <span class="preprocessor">#if defined(_ALPHA_)</span>
00545 <span class="preprocessor"></span>            Thread-&gt;Win32StartAddress = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;IntA0;
00546 <span class="preprocessor">#endif // _ALPHA_</span>
00547 <span class="preprocessor"></span>
00548 <span class="preprocessor">#if defined(_PPC_)</span>
00549 <span class="preprocessor"></span>            Thread-&gt;Win32StartAddress = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;Gpr3;
00550 <span class="preprocessor">#endif // _PPC_</span>
00551 <span class="preprocessor"></span>
00552             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)
00553             <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a>(
00554                 &amp;Thread-&gt;Tcb,
00555                 KernelStack,
00556                 <a class="code" href="../../d2/d8/ps_2create_8c.html#a19">PspUserThreadStartup</a>,
00557                 (<a class="code" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00558                 (PVOID)CONTEXT_TO_PROGRAM_COUNTER(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>),
00559                 <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>,
00560                 Teb,
00561                 &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>
00562                 );
00563 
00564         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00565 
00566 
00567             <span class="keywordflow">if</span> ( Teb ) {
00568                 <a class="code" href="../../d4/d5/procsup_8c.html#a42">MmDeleteTeb</a>(Process, Teb);
00569             }
00570 
00571             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00572 
00573              <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(KernelStack, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00574              Thread-&gt;Tcb.InitialStack = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00575              <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00576 
00577              <span class="keywordflow">return</span> GetExceptionCode();
00578         }
00579 
00580     } <span class="keywordflow">else</span> {
00581 
00582         <span class="comment">//</span>
00583         <span class="comment">// Initialize kernel thread object for kernel mode thread.</span>
00584         <span class="comment">//</span>
00585 
00586         Thread-&gt;StartAddress = (PVOID)StartRoutine;
00587         <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a>(
00588             &amp;Thread-&gt;Tcb,
00589             KernelStack,
00590             <a class="code" href="../../d2/d8/ps_2create_8c.html#a21">PspSystemThreadStartup</a>,
00591             StartRoutine,
00592             StartContext,
00593             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00594             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00595             &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>
00596             );
00597 
00598     }
00599 
00600     InsertTailList(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>,&amp;Thread-&gt;ThreadListEntry);
00601 
00602     <span class="keywordflow">if</span> ( NeedToFixProcessId ) {
00603 
00604         <span class="comment">//</span>
00605         <span class="comment">// Now that the thread is really there and will rundown through exit,</span>
00606         <span class="comment">// open up the process id</span>
00607         <span class="comment">//</span>
00608 
00609         <a class="code" href="../../d5/d8/ex_8h.html#a298">ExChangeHandle</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>, Thread-&gt;Cid.UniqueProcess, <a class="code" href="../../d2/d8/ps_2create_8c.html#a12">PspMarkProcessIdValid</a>, (ULONG_PTR)Process);
00610 
00611         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a21">PspCreateProcessNotifyRoutineCount</a> != 0) {
00612             ULONG i;
00613 
00614             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a5">PSP_MAX_CREATE_PROCESS_NOTIFY</a>; i++) {
00615                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00616                     (*<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i])( Process-&gt;InheritedFromUniqueProcessId,
00617                                                          Process-&gt;UniqueProcessId,
00618                                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00619                                                        );
00620                     }
00621                 }
00622             }
00623 
00624 
00625         }
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">// If the process has a job with a completion port,</span>
00629     <span class="comment">// AND if the process is really considered to be in the Job, AND</span>
00630     <span class="comment">// the process has not reported, report in</span>
00631     <span class="comment">//</span>
00632     <span class="comment">// This should really be done in add process to job, but can't</span>
00633     <span class="comment">// in this path because the process's ID isn't assigned until this point</span>
00634     <span class="comment">// in time</span>
00635     <span class="comment">//</span>
00636 
00637     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>
00638          &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>
00639          &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>)
00640          &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>)) {
00641 
00642         <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>);
00643 
00644         ExAcquireFastMutex(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
00645         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00646             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
00647                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
00648                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
00649                 (PVOID)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00650                 STATUS_SUCCESS,
00651                 JOB_OBJECT_MSG_NEW_PROCESS,
00652                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00653                 );
00654         }
00655         ExReleaseFastMutex(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
00656         }
00657 
00658     <a class="code" href="../../d2/d1/mm_8h.html#a94">PERFINFO_THREAD_CREATE</a>(Thread, <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>);
00659 
00660     <span class="comment">//</span>
00661     <span class="comment">// Notify registered callout routines of thread creation.</span>
00662     <span class="comment">//</span>
00663 
00664     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a23">PspCreateThreadNotifyRoutineCount</a> != 0) {
00665         ULONG i;
00666 
00667         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a6">PSP_MAX_CREATE_THREAD_NOTIFY</a>; i++) {
00668             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00669                 (*<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i])( Thread-&gt;Cid.UniqueProcess,
00670                                                     Thread-&gt;Cid.UniqueThread,
00671                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00672                                                    );
00673             }
00674         }
00675     }
00676 
00677     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a7">KeEnableApcQueuingThread</a>(&amp;Thread-&gt;Tcb);
00678 
00679     <span class="keywordflow">if</span> (CreateSuspended) {
00680         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a25">KeSuspendThread</a>(&amp;Thread-&gt;Tcb);
00681     }
00682 
00683 
00684     <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// Failures that occur after this point cause the thread to</span>
00688     <span class="comment">// go through PspExitThread</span>
00689     <span class="comment">//</span>
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">// Reference count of thread is biased once for itself, and</span>
00693     <span class="comment">// once to account for its Cid Handle</span>
00694     <span class="comment">//</span>
00695     <span class="comment">// Note:</span>
00696     <span class="comment">//      if this fails we should do punt so we only have one</span>
00697     <span class="comment">//      cleanup path that really goes through PspExitThread ?</span>
00698     <span class="comment">//      Remember to free spin locks, cid...</span>
00699     <span class="comment">//</span>
00700 
00701     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Thread);
00702     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Thread);
00703     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Thread);
00704 
00705     st = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
00706             Thread,
00707             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00708             DesiredAccess,
00709             0,
00710             (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00711             &amp;LocalThreadHandle
00712             );
00713 
00714     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00715 
00716         <span class="comment">//</span>
00717         <span class="comment">// The insert failed. Terminate the thread.</span>
00718         <span class="comment">//</span>
00719 
00720         <span class="comment">//</span>
00721         <span class="comment">// This trick us used so that Dbgk doesn't report</span>
00722         <span class="comment">// events for dead threads</span>
00723         <span class="comment">//</span>
00724 
00725         Thread-&gt;DeadThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00726         Thread-&gt;HasTerminated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00727 
00728         <span class="keywordflow">if</span> (CreateSuspended) {
00729             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a15">KeResumeThread</a>(&amp;Thread-&gt;Tcb);
00730         }
00731 
00732     } <span class="keywordflow">else</span> {
00733 
00734         <span class="keywordflow">try</span> {
00735 
00736             *<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> = LocalThreadHandle;
00737             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ClientId)) {
00738                 *ClientId = Thread-&gt;Cid;
00739             }
00740         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00741 
00742             <span class="keywordflow">if</span> ( GetExceptionCode() == STATUS_QUOTA_EXCEEDED ) {
00743 
00744                 <span class="comment">//</span>
00745                 <span class="comment">// This trick us used so that Dbgk doesn't report</span>
00746                 <span class="comment">// events for dead threads</span>
00747                 <span class="comment">//</span>
00748 
00749                 Thread-&gt;DeadThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00750                 Thread-&gt;HasTerminated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00751 
00752                 <span class="keywordflow">if</span> (CreateSuspended) {
00753                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a15">KeResumeThread</a>(&amp;Thread-&gt;Tcb);
00754                 }
00755                 <a class="code" href="../../d9/d1/thredobj_8c.html#a14">KeReadyThread</a>(&amp;Thread-&gt;Tcb);
00756                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00757                 ZwClose(LocalThreadHandle);
00758                 <span class="keywordflow">return</span> GetExceptionCode();
00759             }
00760         }
00761     }
00762 
00763     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;CreateTime);
00764     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((CreateTime.HighPart &amp; 0xf0000000) == 0);
00765     <a class="code" href="../../d1/d9/ps_8h.html#a16">PS_SET_THREAD_CREATE_TIME</a>(Thread, CreateTime);
00766 
00767     <span class="keywordflow">if</span> ( !Thread-&gt;DeadThread ) {
00768         st = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>(
00769                 Thread,
00770                 &amp;SecurityDescriptor,
00771                 &amp;MemoryAllocated
00772                 );
00773         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00774             <span class="comment">//</span>
00775             <span class="comment">// This trick us used so that Dbgk doesn't report</span>
00776             <span class="comment">// events for dead threads</span>
00777             <span class="comment">//</span>
00778 
00779             Thread-&gt;DeadThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00780             Thread-&gt;HasTerminated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00781 
00782             <span class="keywordflow">if</span> (CreateSuspended) {
00783                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a15">KeResumeThread</a>(&amp;Thread-&gt;Tcb);
00784             }
00785             <a class="code" href="../../d9/d1/thredobj_8c.html#a14">KeReadyThread</a>(&amp;Thread-&gt;Tcb);
00786             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00787             ZwClose(LocalThreadHandle);
00788             <span class="keywordflow">return</span> st;
00789             }
00790 
00791         <span class="comment">//</span>
00792         <span class="comment">// Compute the subject security context</span>
00793         <span class="comment">//</span>
00794 
00795         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o3">ProcessAuditId</a> = Process;
00796         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(Process);
00797         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00798 
00799         AccessCheck = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
00800                         SecurityDescriptor,
00801                         &amp;SubjectContext,
00802                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00803                         MAXIMUM_ALLOWED,
00804                         0,
00805                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00806                         &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00807                         PreviousMode,
00808                         &amp;Thread-&gt;GrantedAccess,
00809                         &amp;accesst
00810                         );
00811         <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>);
00812         <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>(
00813             SecurityDescriptor,
00814             MemoryAllocated
00815             );
00816 
00817         <span class="keywordflow">if</span> ( !AccessCheck ) {
00818             Thread-&gt;GrantedAccess = 0;
00819             }
00820 
00821         <span class="keywordflow">if</span> ( (Thread-&gt;GrantedAccess &amp; THREAD_SET_THREAD_TOKEN) == 0 )
00822         {
00823             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: Warning, new thread does not have SET_THREAD_TOKEN for itself\n"</span> );
00824             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: Check that thread %x.%x isn't in some weird state\n"</span>,
00825                         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
00826                         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread );
00827 
00828         }
00829 
00830         Thread-&gt;GrantedAccess |= (THREAD_TERMINATE | THREAD_SET_INFORMATION | THREAD_QUERY_INFORMATION);
00831 
00832         }
00833     <span class="keywordflow">else</span> {
00834         Thread-&gt;GrantedAccess = THREAD_ALL_ACCESS;
00835         }
00836     <a class="code" href="../../d9/d1/thredobj_8c.html#a14">KeReadyThread</a>(&amp;Thread-&gt;Tcb);
00837     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00838 
00839     <span class="keywordflow">return</span> st;
00840 }
00841 
00842 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00843"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a14">00843</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a14">NtCreateProcess</a>(
00844     OUT PHANDLE ProcessHandle,
00845     IN ACCESS_MASK DesiredAccess,
00846     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00847     IN HANDLE ParentProcess,
00848     IN BOOLEAN InheritObjectTable,
00849     IN HANDLE SectionHandle OPTIONAL,
00850     IN HANDLE DebugPort OPTIONAL,
00851     IN HANDLE ExceptionPort OPTIONAL
00852     )
00853 
00854 <span class="comment">/*++</span>
00855 <span class="comment"></span>
00856 <span class="comment">Routine Description:</span>
00857 <span class="comment"></span>
00858 <span class="comment">    This routine creates a process object.</span>
00859 <span class="comment"></span>
00860 <span class="comment">Arguments:</span>
00861 <span class="comment"></span>
00862 <span class="comment">    ProcessHandle - Returns the handle for the new process.</span>
00863 <span class="comment"></span>
00864 <span class="comment">    DesiredAccess - Supplies the desired access modes to the new process.</span>
00865 <span class="comment"></span>
00866 <span class="comment">    ObjectAttributes - Supplies the object attributes of the new process.</span>
00867 <span class="comment">    .</span>
00868 <span class="comment">    .</span>
00869 <span class="comment">    .</span>
00870 <span class="comment"></span>
00871 <span class="comment">Return Value:</span>
00872 <span class="comment"></span>
00873 <span class="comment">    TBD</span>
00874 <span class="comment"></span>
00875 <span class="comment">--*/</span>
00876 
00877 {
00878     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00879 
00880     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00881 
00882     <span class="keywordflow">if</span> ( KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00883 
00884         <span class="comment">//</span>
00885         <span class="comment">// Probe all arguments</span>
00886         <span class="comment">//</span>
00887 
00888         <span class="keywordflow">try</span> {
00889             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(ProcessHandle);
00890         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00891             <span class="keywordflow">return</span> GetExceptionCode();
00892         }
00893     }
00894 
00895     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ParentProcess) ) {
00896         st = <a class="code" href="../../d8/d1/psp_8h.html#a62">PspCreateProcess</a>(
00897                 ProcessHandle,
00898                 DesiredAccess,
00899                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00900                 ParentProcess,
00901                 InheritObjectTable,
00902                 SectionHandle,
00903                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00904                 ExceptionPort
00905                 );
00906     } <span class="keywordflow">else</span> {
00907         st = STATUS_INVALID_PARAMETER;
00908     }
00909 
00910     <span class="keywordflow">return</span> st;
00911 }
00912 
00913 
00914 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00915"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a15">00915</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a15">PsCreateSystemProcess</a>(
00916     OUT PHANDLE ProcessHandle,
00917     IN ACCESS_MASK DesiredAccess,
00918     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL
00919     )
00920 
00921 <span class="comment">/*++</span>
00922 <span class="comment"></span>
00923 <span class="comment">Routine Description:</span>
00924 <span class="comment"></span>
00925 <span class="comment">    This routine creates a system process object. A system process</span>
00926 <span class="comment">    has an address space that is initialized to an empty address space</span>
00927 <span class="comment">    that maps the system.</span>
00928 <span class="comment"></span>
00929 <span class="comment">    The process inherits its access token and other attributes from the</span>
00930 <span class="comment">    initial system process. The process is created with an empty handle table.</span>
00931 <span class="comment"></span>
00932 <span class="comment">Arguments:</span>
00933 <span class="comment"></span>
00934 <span class="comment">    ProcessHandle - Returns the handle for the new process.</span>
00935 <span class="comment"></span>
00936 <span class="comment">    DesiredAccess - Supplies the desired access modes to the new process.</span>
00937 <span class="comment"></span>
00938 <span class="comment">    ObjectAttributes - Supplies the object attributes of the new process.</span>
00939 <span class="comment"></span>
00940 <span class="comment"></span>
00941 <span class="comment">Return Value:</span>
00942 <span class="comment"></span>
00943 <span class="comment">    TBD</span>
00944 <span class="comment"></span>
00945 <span class="comment">--*/</span>
00946 
00947 {
00948     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00949 
00950     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00951 
00952     st = <a class="code" href="../../d8/d1/psp_8h.html#a62">PspCreateProcess</a>(
00953             ProcessHandle,
00954             DesiredAccess,
00955             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00956             <a class="code" href="../../d6/d3/modwrite_8c.html#a13">PspInitialSystemProcessHandle</a>,
00957             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00958             (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00959             (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00960             (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00961             );
00962 
00963     <span class="keywordflow">return</span> st;
00964 }
00965 
00966 
00967 
00968 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00969"></a><a class="code" href="../../d8/d1/psp_8h.html#a62">00969</a> <a class="code" href="../../d8/d1/psp_8h.html#a62">PspCreateProcess</a>(
00970     OUT PHANDLE ProcessHandle,
00971     IN ACCESS_MASK DesiredAccess,
00972     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00973     IN HANDLE ParentProcess OPTIONAL,
00974     IN BOOLEAN InheritObjectTable,
00975     IN HANDLE SectionHandle OPTIONAL,
00976     IN HANDLE DebugPort OPTIONAL,
00977     IN HANDLE ExceptionPort OPTIONAL
00978     )
00979 
00980 <span class="comment">/*++</span>
00981 <span class="comment"></span>
00982 <span class="comment">Routine Description:</span>
00983 <span class="comment"></span>
00984 <span class="comment">    This routine creates and initializes a process object.  It implements the</span>
00985 <span class="comment">    foundation for NtCreateProcess and for system initialization process</span>
00986 <span class="comment">    creation.</span>
00987 <span class="comment"></span>
00988 <span class="comment">Arguments:</span>
00989 <span class="comment"></span>
00990 <span class="comment">    ProcessHandle - Returns the handle for the new process.</span>
00991 <span class="comment"></span>
00992 <span class="comment">    DesiredAccess - Supplies the desired access modes to the new process.</span>
00993 <span class="comment"></span>
00994 <span class="comment">    ObjectAttributes - Supplies the object attributes of the new process.</span>
00995 <span class="comment"></span>
00996 <span class="comment">    ParentProcess - Supplies a handle to the process' parent process.  If this</span>
00997 <span class="comment">                    parameter is not specified, then the process has no parent</span>
00998 <span class="comment">                    and is created using the system address space.</span>
00999 <span class="comment"></span>
01000 <span class="comment">    SectionHandle - Supplies a handle to a section object to be used to create</span>
01001 <span class="comment">                    the process' address space.  If this parameter is not</span>
01002 <span class="comment">                    specified, then the address space is simply a clone of the</span>
01003 <span class="comment">                    parent process' address space.</span>
01004 <span class="comment"></span>
01005 <span class="comment">    DebugPort - Supplies a handle to a port object that will be used as the</span>
01006 <span class="comment">                process' debug port.</span>
01007 <span class="comment"></span>
01008 <span class="comment">    ExceptionPort - Supplies a handle to a port object that will be used as the</span>
01009 <span class="comment">                    process' exception port.</span>
01010 <span class="comment"></span>
01011 <span class="comment">Return Value:</span>
01012 <span class="comment"></span>
01013 <span class="comment">    TBD</span>
01014 <span class="comment"></span>
01015 <span class="comment">--*/</span>
01016 
01017 {
01018     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01019     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01020     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent;
01021     KAFFINITY Affinity;
01022     KPRIORITY BasePriority;
01023     PVOID SectionToMap;
01024     PVOID ExceptionPortObject;
01025     PVOID DebugPortObject;
01026     ULONG WorkingSetMinimum, WorkingSetMaximum;
01027     HANDLE LocalProcessHandle;
01028     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01029     HANDLE NewSection;
01030     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> DuplicateStatus;
01031     <a class="code" href="../../d2/d2/struct__INITIAL__PEB.html">INITIAL_PEB</a> InitialPeb;
01032     BOOLEAN CreatePeb;
01033     ULONG_PTR DirectoryTableBase[2];
01034     BOOLEAN AccessCheck;
01035     BOOLEAN MemoryAllocated;
01036     PSECURITY_DESCRIPTOR SecurityDescriptor;
01037     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
01038     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> accesst;
01039     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> savedst;
01040     BOOLEAN BreakAwayRequested;
01041     PUNICODE_STRING AuditName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01042 
01043     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01044 
01045     BreakAwayRequested = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01046     CreatePeb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01047     DirectoryTableBase[0] = 0;
01048     DirectoryTableBase[1] = 0;
01049     PreviousMode = KeGetPreviousMode();
01050 
01051     <span class="comment">//</span>
01052     <span class="comment">// Parent</span>
01053     <span class="comment">//</span>
01054 
01055     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ParentProcess) ) {
01056         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01057                 ParentProcess,
01058                 PROCESS_CREATE_PROCESS,
01059                 <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
01060                 PreviousMode,
01061                 (PVOID *)&amp;Parent,
01062                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01063                 );
01064         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01065             <span class="keywordflow">return</span> st;
01066         }
01067 
01068         <span class="comment">//</span>
01069         <span class="comment">// Until CSR understands priority class, don't</span>
01070         <span class="comment">// inherit base priority. This just makes things</span>
01071         <span class="comment">// worse !</span>
01072         <span class="comment">//</span>
01073 
01074         BasePriority = (KPRIORITY) NORMAL_BASE_PRIORITY;
01075 
01076         <span class="comment">//</span>
01077         <span class="comment">//BasePriority = Parent-&gt;Pcb.BasePriority;</span>
01078         <span class="comment">//</span>
01079 
01080         Affinity = Parent-&gt;Pcb.Affinity;
01081 
01082         WorkingSetMinimum = <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a>;              <span class="comment">// FIXFIX</span>
01083         WorkingSetMaximum = <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a>;
01084 
01085 
01086     } <span class="keywordflow">else</span> {
01087 
01088         Parent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01089         Affinity = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
01090         BasePriority = (KPRIORITY) NORMAL_BASE_PRIORITY;
01091 
01092         WorkingSetMinimum = <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a>;              <span class="comment">// FIXFIX</span>
01093         WorkingSetMaximum = <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a>;
01094     }
01095 
01096     <span class="comment">//</span>
01097     <span class="comment">// Section</span>
01098     <span class="comment">//</span>
01099 
01100     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SectionHandle) ) {
01101 
01102         <span class="comment">//</span>
01103         <span class="comment">// Use Object manager tag bits to indicate that breakaway is</span>
01104         <span class="comment">// desired</span>
01105         <span class="comment">//</span>
01106 
01107         <span class="keywordflow">if</span> ( (UINT_PTR)SectionHandle &amp; 1 ) {
01108             BreakAwayRequested = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01109             }
01110 
01111         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01112                 SectionHandle,
01113                 SECTION_MAP_EXECUTE,
01114                 <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
01115                 PreviousMode,
01116                 (PVOID *)&amp;SectionToMap,
01117                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01118                 );
01119         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01120             <span class="keywordflow">if</span> (Parent) {
01121                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01122             }
01123             <span class="keywordflow">return</span> st;
01124         }
01125     } <span class="keywordflow">else</span> {
01126         SectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01127     }
01128 
01129     <span class="comment">//</span>
01130     <span class="comment">// DebugPort</span>
01131     <span class="comment">//</span>
01132 
01133     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>) ) {
01134         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01135                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
01136                 0,
01137                 <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>,
01138                 KeGetPreviousMode(),
01139                 (PVOID *)&amp;DebugPortObject,
01140                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01141                 );
01142         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01143             <span class="keywordflow">if</span> (Parent) {
01144                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01145             }
01146             <span class="keywordflow">if</span> (SectionToMap) {
01147                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01148             }
01149             <span class="keywordflow">return</span> st;
01150         }
01151     } <span class="keywordflow">else</span> {
01152         DebugPortObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01153     }
01154 
01155     <span class="comment">//</span>
01156     <span class="comment">// ExceptionPort</span>
01157     <span class="comment">//</span>
01158 
01159     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExceptionPort) ) {
01160         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01161                 ExceptionPort,
01162                 0,
01163                 <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>,
01164                 KeGetPreviousMode(),
01165                 (PVOID *)&amp;ExceptionPortObject,
01166                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01167                 );
01168         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01169             <span class="keywordflow">if</span> (Parent) {
01170                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01171             }
01172             <span class="keywordflow">if</span> (SectionToMap) {
01173                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01174             }
01175             <span class="keywordflow">if</span> (DebugPortObject) {
01176                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DebugPortObject);
01177             }
01178 
01179             <span class="keywordflow">return</span> st;
01180         }
01181     } <span class="keywordflow">else</span> {
01182         ExceptionPortObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01183     }
01184 
01185     st = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
01186            KeGetPreviousMode(),
01187            <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
01188            <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01189            KeGetPreviousMode(),
01190            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01191            (ULONG) <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>),
01192            0,
01193            0,
01194            (PVOID *)&amp;Process
01195            );
01196     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) ) {
01197         <span class="keywordflow">if</span> (Parent) {
01198             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01199         }
01200         <span class="keywordflow">if</span> (SectionToMap) {
01201             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01202         }
01203         <span class="keywordflow">if</span> (DebugPortObject) {
01204             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DebugPortObject);
01205         }
01206         <span class="keywordflow">if</span> (ExceptionPortObject) {
01207             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExceptionPortObject);
01208         }
01209         <span class="keywordflow">return</span> st;
01210     }
01211 
01212     <span class="comment">//</span>
01213     <span class="comment">// The process object is created set to NULL. Errors</span>
01214     <span class="comment">// That occur after this step cause the process delete</span>
01215     <span class="comment">// routine to be entered.</span>
01216     <span class="comment">//</span>
01217     <span class="comment">// Teardown actions that occur in the process delete routine</span>
01218     <span class="comment">// do not need to be performed inline.</span>
01219     <span class="comment">//</span>
01220 
01221     RtlZeroMemory(Process,<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/ps_8h.html#a37">EPROCESS</a>));
01222 
01223     InitializeListHead(&amp;Process-&gt;ThreadListHead);
01224     Process-&gt;CreateProcessReported = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01225     Process-&gt;DebugPort = DebugPortObject;
01226     Process-&gt;ExceptionPort = ExceptionPortObject;
01227 
01228 
01229     <a class="code" href="../../d0/d2/psquota_8c.html#a4">PspInheritQuota</a>(Process,Parent);
01230     <a class="code" href="../../d7/d0/obdevmap_8c.html#a2">ObInheritDeviceMap</a>(Process,Parent);
01231 
01232     <span class="keywordflow">if</span> ( Parent ) {
01233         Process-&gt;DefaultHardErrorProcessing = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o55">DefaultHardErrorProcessing</a>;
01234         Process-&gt;InheritedFromUniqueProcessId = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>;
01235         Process-&gt;SessionId = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o60">SessionId</a>;
01236 
01237     } <span class="keywordflow">else</span> {
01238         Process-&gt;DefaultHardErrorProcessing = 1;
01239         Process-&gt;InheritedFromUniqueProcessId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01240     }
01241 
01242     Process-&gt;ExitStatus = STATUS_PENDING;
01243     Process-&gt;LockCount = 1;
01244     Process-&gt;LockOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01245     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;Process-&gt;LockEvent, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01246 
01247     <span class="comment">//</span>
01248     <span class="comment">//  Initialize the security fields of the process</span>
01249     <span class="comment">//  The parent may be null exactly once (during system init).</span>
01250     <span class="comment">//  Thereafter, a parent is always required so that we have a</span>
01251     <span class="comment">//  security context to duplicate for the new process.</span>
01252     <span class="comment">//</span>
01253 
01254     st = <a class="code" href="../../d6/d5/ps_2security_8c.html#a10">PspInitializeProcessSecurity</a>( Parent, Process );
01255 
01256     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01257 
01258 
01259         <span class="keywordflow">if</span> ( Parent ) {
01260             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01261         }
01262 
01263         <span class="keywordflow">if</span> (SectionToMap) {
01264             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01265         }
01266 
01267         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01268         <span class="keywordflow">return</span> st;
01269     }
01270 
01271     <span class="comment">//</span>
01272     <span class="comment">// Clone parent's object table.</span>
01273     <span class="comment">// If no parent (booting) then use the current object table created in</span>
01274     <span class="comment">// ObInitSystem.</span>
01275     <span class="comment">//</span>
01276 
01277     <span class="keywordflow">if</span> (Parent) {
01278 
01279 
01280         <span class="comment">//</span>
01281         <span class="comment">// Calculate address space</span>
01282         <span class="comment">//</span>
01283         <span class="comment">//      If Parent == PspInitialSystem</span>
01284         <span class="comment">//</span>
01285 
01286         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d5/procsup_8c.html#a29">MmCreateProcessAddressSpace</a>(WorkingSetMinimum,
01287                                          Process,
01288                                          &amp;DirectoryTableBase[0])) {
01289 
01290             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01291             <span class="keywordflow">if</span> (SectionToMap) {
01292                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01293             }
01294 
01295             <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>( Process );
01296 
01297             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01298             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01299         }
01300 
01301     } <span class="keywordflow">else</span> {
01302 
01303         Process-&gt;ObjectTable = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ObjectTable;
01304 
01305         DirectoryTableBase[0] = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.DirectoryTableBase[0];
01306         DirectoryTableBase[1] = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.DirectoryTableBase[1];
01307 
01308         <span class="comment">//</span>
01309         <span class="comment">// Initialize the Working Set Mutex and address creation mutex</span>
01310         <span class="comment">// for this "hand built" process.</span>
01311         <span class="comment">// Normally, the call the MmInitializeAddressSpace initializes the</span>
01312         <span class="comment">// working set mutex, however, in this case, we have already initialized</span>
01313         <span class="comment">// the address space and we are now creating a second process using</span>
01314         <span class="comment">// the address space of the idle thread.</span>
01315         <span class="comment">//</span>
01316 
01317         <span class="comment">//KeInitializeMutant(&amp;Process-&gt;WorkingSetLock, FALSE);</span>
01318         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;Process-&gt;WorkingSetLock);
01319 
01320         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;Process-&gt;AddressCreationLock);
01321 
01322         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;Process-&gt;HyperSpaceLock);
01323 
01324         <span class="comment">//</span>
01325         <span class="comment">// Initialize virtual address descriptor root.</span>
01326         <span class="comment">//</span>
01327 
01328         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;VadRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01329         Process-&gt;Vm.WorkingSetSize = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.WorkingSetSize;
01330         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Process-&gt;Vm.LastTrimTime);
01331         Process-&gt;Vm.VmWorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
01332     }
01333 
01334     Process-&gt;Vm.MaximumWorkingSetSize = WorkingSetMaximum;
01335 
01336     <a class="code" href="../../d3/d5/procobj_8c.html#a3">KeInitializeProcess</a>(
01337         &amp;Process-&gt;Pcb,
01338         BasePriority,
01339         Affinity,
01340         &amp;DirectoryTableBase[0],
01341         (BOOLEAN)(Process-&gt;DefaultHardErrorProcessing &amp; PROCESS_HARDERROR_ALIGNMENT_BIT)
01342         );
01343     Process-&gt;Pcb.ThreadQuantum = <a class="code" href="../../d0/d1/psinit_8c.html#a21">PspForegroundQuantum</a>[0];
01344     Process-&gt;PriorityClass = PROCESS_PRIORITY_CLASS_NORMAL;
01345 
01346     <span class="keywordflow">if</span> (Parent) {
01347 
01348         <span class="comment">//</span>
01349         <span class="comment">// this used to happen in basesrv\srvtask.c</span>
01350         <span class="comment">//</span>
01351         <span class="keywordflow">if</span> ( Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> == PROCESS_PRIORITY_CLASS_IDLE ||
01352              Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> == PROCESS_PRIORITY_CLASS_BELOW_NORMAL ) {
01353              Process-&gt;PriorityClass = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a>;
01354              }
01355         <span class="comment">//</span>
01356         <span class="comment">// if address space creation worked, then when going through</span>
01357         <span class="comment">// delete, we will attach. Of course, attaching means that the kprocess</span>
01358         <span class="comment">// must be initialized, so we delay the object stuff till here.</span>
01359 
01360         <span class="comment">//</span>
01361         st = <a class="code" href="../../d0/d1/obinit_8c.html#a20">ObInitProcess</a>(InheritObjectTable ? Parent : (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,Process);
01362 
01363         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01364 
01365             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01366             <span class="keywordflow">if</span> (SectionToMap) {
01367                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01368             }
01369 
01370             <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>( Process );
01371             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01372             <span class="keywordflow">return</span> st;
01373         }
01374     }
01375 
01376     st = STATUS_SUCCESS;
01377     savedst = STATUS_SUCCESS;
01378 
01379     <span class="comment">//</span>
01380     <span class="comment">// Initialize the process address space</span>
01381     <span class="comment">// The address space has four possibilities</span>
01382     <span class="comment">//</span>
01383     <span class="comment">//      1 - Boot Process. Address space is initialized during</span>
01384     <span class="comment">//          MmInit. Parent is not specified.</span>
01385     <span class="comment">//</span>
01386     <span class="comment">//      2 - System Process. Address space is a virgin address</span>
01387     <span class="comment">//          space that only maps system space. Process is same</span>
01388     <span class="comment">//          as PspInitialSystemProcess.</span>
01389     <span class="comment">//</span>
01390     <span class="comment">//      3 - User Process (Cloned Address Space). Address space</span>
01391     <span class="comment">//          is cloned from the specified process.</span>
01392     <span class="comment">//</span>
01393     <span class="comment">//      4 - User Process (New Image Address Space). Address space</span>
01394     <span class="comment">//          is initialized so that it maps the specified section.</span>
01395     <span class="comment">//</span>
01396 
01397     <span class="keywordflow">if</span> ( SectionToMap ) {
01398         <span class="comment">//</span>
01399         <span class="comment">// User Process (New Image Address Space). Don't specify Process to</span>
01400         <span class="comment">// clone, just SectionToMap.</span>
01401         <span class="comment">//</span>
01402 
01403         st = <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a>(
01404                 Process,
01405                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01406                 SectionToMap,
01407                 &amp;AuditName
01408                 );
01409 
01410         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01411         <a class="code" href="../../d0/d1/obinit_8c.html#a21">ObInitProcess2</a>(Process);
01412 
01413         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01414 
01415             <span class="comment">//</span>
01416             <span class="comment">// In order to support relocating executables, the proper status</span>
01417             <span class="comment">// (STATUS_IMAGE_NOT_AT_BASE) must be returned, so save it here.</span>
01418             <span class="comment">//</span>
01419 
01420             savedst = st;
01421 
01422             st = <a class="code" href="../../d8/d1/psp_8h.html#a61">PspMapSystemDll</a>(Process,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01423         }
01424 
01425         CreatePeb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01426 
01427         <span class="keywordflow">goto</span> insert_process;
01428     }
01429 
01430     <span class="keywordflow">if</span> ( Parent ) {
01431 
01432         <span class="keywordflow">if</span> ( Parent != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a> ) {
01433 
01434             Process-&gt;SectionBaseAddress = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>;
01435 
01436             <span class="comment">//</span>
01437             <span class="comment">// User Process ( Cloned Address Space ).  Don't specify section to</span>
01438             <span class="comment">// map, just Process to clone.</span>
01439             <span class="comment">//</span>
01440 
01441             st = <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a>(
01442                     Process,
01443                     Parent,
01444                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01445                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01446                     );
01447 
01448             CreatePeb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01449 
01450         } <span class="keywordflow">else</span> {
01451 
01452             <span class="comment">//</span>
01453             <span class="comment">// System Process.  Don't specify Process to clone or section to map</span>
01454             <span class="comment">//</span>
01455 
01456             st = <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a>(
01457                     Process,
01458                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01459                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01460                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01461                     );
01462         }
01463     }
01464 
01465 insert_process:
01466 
01467     <span class="comment">//</span>
01468     <span class="comment">// If MmInitializeProcessAddressSpace was NOT successful, then</span>
01469     <span class="comment">// dereference and exit.</span>
01470     <span class="comment">//</span>
01471 
01472     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01473 
01474         <span class="keywordflow">if</span> (Parent) {
01475             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01476         }
01477 
01478         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;Process-&gt;Pcb);
01479         <a class="code" href="../../d0/d1/obinit_8c.html#a23">ObKillProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, Process);
01480         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01481 
01482         <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>( Process );
01483         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01484         <span class="keywordflow">return</span> st;
01485     }
01486 
01487     <span class="comment">//</span>
01488     <span class="comment">// Reference count of process is not biased here. Each thread in the</span>
01489     <span class="comment">// process bias the reference count when they are created.</span>
01490     <span class="comment">//</span>
01491 
01492     st = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
01493             Process,
01494             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01495             DesiredAccess,
01496             0,
01497             (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01498             &amp;LocalProcessHandle
01499             );
01500 
01501 
01502     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01503         <span class="keywordflow">if</span> (Parent) {
01504             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01505         }
01506         <span class="keywordflow">return</span> st;
01507     }
01508 
01509     <span class="comment">//</span>
01510     <span class="comment">// See if the parent has a job. If so reference the job</span>
01511     <span class="comment">// and add the process in.</span>
01512     <span class="comment">//</span>
01513 
01514     <span class="keywordflow">if</span> ( Parent &amp;&amp; Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> &amp;&amp; !(Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_SILENT_BREAKAWAY_OK) ) {
01515 
01516         <span class="keywordflow">if</span> ( BreakAwayRequested ) {
01517             <span class="keywordflow">if</span> ( !(Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_BREAKAWAY_OK) ) {
01518                 st = STATUS_ACCESS_DENIED;
01519                 <span class="keywordflow">if</span> (Parent) {
01520                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01521                     }
01522                 ZwClose(LocalProcessHandle);
01523                 <span class="keywordflow">return</span> st;
01524                 }
01525             }
01526         <span class="keywordflow">else</span> {
01527             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>);
01528             Process-&gt;Job = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>;
01529             st = <a class="code" href="../../d8/d1/psp_8h.html#a91">PspAddProcessToJob</a>(Process-&gt;Job,Process);
01530             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01531                 <span class="keywordflow">if</span> (Parent) {
01532                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01533                     }
01534                 ZwClose(LocalProcessHandle);
01535                 <span class="keywordflow">return</span> st;
01536                 }
01537             }
01538         }
01539 
01540     <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(Process,<a class="code" href="../../d1/d9/ps_8h.html#a159a108">PsProcessPriorityBackground</a>);
01541 
01542     ExAcquireFastMutex(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
01543     InsertTailList(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>,&amp;Process-&gt;ActiveProcessLinks);
01544     ExReleaseFastMutex(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
01545 
01546     <span class="keywordflow">if</span> (Parent &amp;&amp; CreatePeb ) {
01547 
01548         <span class="comment">//</span>
01549         <span class="comment">// For processes created w/ a section,</span>
01550         <span class="comment">// a new "virgin" PEB is created. Otherwise,</span>
01551         <span class="comment">// for forked processes, uses inherited PEB</span>
01552         <span class="comment">// with an updated mutant.</span>
01553 
01554         RtlZeroMemory(&amp;InitialPeb, FIELD_OFFSET(<a class="code" href="../../d2/d2/struct__INITIAL__PEB.html">INITIAL_PEB</a>, Mutant));
01555         InitialPeb.<a class="code" href="../../d2/d2/struct__INITIAL__PEB.html#o4">Mutant</a> = (HANDLE)(-1);
01556         <span class="keywordflow">if</span> ( SectionToMap ) {
01557 
01558             <span class="keywordflow">try</span> {
01559                 Process-&gt;Peb = <a class="code" href="../../d4/d5/procsup_8c.html#a41">MmCreatePeb</a>(Process,&amp;InitialPeb);
01560             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01561                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01562                 ZwClose(LocalProcessHandle);
01563                 <span class="keywordflow">return</span> GetExceptionCode();
01564             }
01565 
01566         } <span class="keywordflow">else</span> {
01567 
01568             InitialPeb.<a class="code" href="../../d2/d2/struct__INITIAL__PEB.html#o0">InheritedAddressSpace</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01569 
01570             Process-&gt;Peb = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a>;
01571 
01572             ZwWriteVirtualMemory(
01573                 LocalProcessHandle,
01574                 Process-&gt;Peb,
01575                 &amp;InitialPeb,
01576                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/struct__INITIAL__PEB.html">INITIAL_PEB</a>),
01577                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01578                 );
01579         }
01580 
01581         <span class="comment">//</span>
01582         <span class="comment">// The new process should have a handle to its</span>
01583         <span class="comment">// section. The section is either from the specified</span>
01584         <span class="comment">// section, or the section of its parent.</span>
01585         <span class="comment">//</span>
01586 
01587         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(SectionHandle) ) {
01588             DuplicateStatus = ZwDuplicateObject(
01589                                 NtCurrentProcess(),
01590                                 SectionHandle,
01591                                 LocalProcessHandle,
01592                                 &amp;NewSection,
01593                                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01594                                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01595                                 DUPLICATE_SAME_ACCESS
01596                                 );
01597         } <span class="keywordflow">else</span> {
01598 
01599             DuplicateStatus = ZwDuplicateObject(
01600                                 ParentProcess,
01601                                 Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o46">SectionHandle</a>,
01602                                 LocalProcessHandle,
01603                                 &amp;NewSection,
01604                                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01605                                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01606                                 DUPLICATE_SAME_ACCESS
01607                                 );
01608         }
01609 
01610         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DuplicateStatus) ) {
01611             Process-&gt;SectionHandle = NewSection;
01612         }
01613 
01614         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01615     }
01616 
01617     <span class="keywordflow">if</span> ( Parent &amp;&amp; ParentProcess != <a class="code" href="../../d6/d3/modwrite_8c.html#a13">PspInitialSystemProcessHandle</a> ) {
01618 
01619         st = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>(
01620                 Process,
01621                 &amp;SecurityDescriptor,
01622                 &amp;MemoryAllocated
01623                 );
01624         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01625             ZwClose(LocalProcessHandle);
01626             <span class="keywordflow">return</span> st;
01627             }
01628 
01629         <span class="comment">//</span>
01630         <span class="comment">// Compute the subject security context</span>
01631         <span class="comment">//</span>
01632 
01633         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o3">ProcessAuditId</a> = Process;
01634         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(Process);
01635         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01636         AccessCheck = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
01637                         SecurityDescriptor,
01638                         &amp;SubjectContext,
01639                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01640                         MAXIMUM_ALLOWED,
01641                         0,
01642                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01643                         &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
01644                         PreviousMode,
01645                         &amp;Process-&gt;GrantedAccess,
01646                         &amp;accesst
01647                         );
01648         <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>);
01649         <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>(
01650             SecurityDescriptor,
01651             MemoryAllocated
01652             );
01653 
01654         <span class="keywordflow">if</span> ( !AccessCheck ) {
01655             Process-&gt;GrantedAccess = 0;
01656             }
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">// It does not make any sense to create a process that can not</span>
01660         <span class="comment">// do anything to itself</span>
01661         <span class="comment">//</span>
01662 
01663         Process-&gt;GrantedAccess |= (PROCESS_VM_OPERATION | PROCESS_VM_READ | PROCESS_VM_WRITE | PROCESS_QUERY_INFORMATION | PROCESS_TERMINATE | PROCESS_CREATE_THREAD | PROCESS_DUP_HANDLE | PROCESS_CREATE_PROCESS | PROCESS_SET_INFORMATION);
01664 
01665     } <span class="keywordflow">else</span> {
01666         Process-&gt;GrantedAccess = PROCESS_ALL_ACCESS;
01667     }
01668 
01669     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/se_8h.html#a106">SeDetailedAuditing</a> ) {
01670 
01671         <a class="code" href="../../d7/d6/sepaudit_8c.html#a19">SeAuditProcessCreation</a>( Process, Parent, AuditName );
01672     } 
01673 
01674     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Process-&gt;CreateTime);
01675 
01676     <span class="keywordflow">try</span> {
01677         *ProcessHandle = LocalProcessHandle;
01678     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01679         <span class="keywordflow">return</span> st;
01680     }
01681 
01682     <span class="keywordflow">if</span> (savedst != STATUS_SUCCESS) {
01683         st = savedst;
01684     }
01685 
01686     <span class="keywordflow">return</span> st;
01687 
01688 }
01689 
01690 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01691"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a17">01691</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a17">PsSetCreateProcessNotifyRoutine</a>(
01692     IN PCREATE_PROCESS_NOTIFY_ROUTINE NotifyRoutine,
01693     IN BOOLEAN Remove
01694     )
01695 
01696 <span class="comment">/*++</span>
01697 <span class="comment"></span>
01698 <span class="comment">Routine Description:</span>
01699 <span class="comment"></span>
01700 <span class="comment">    This function allows an installable file system to hook into process</span>
01701 <span class="comment">    creation and deletion to track those events against their own internal</span>
01702 <span class="comment">    data structures.</span>
01703 <span class="comment"></span>
01704 <span class="comment">Arguments:</span>
01705 <span class="comment"></span>
01706 <span class="comment">    NotifyRoutine - Supplies the address of a routine which is called at</span>
01707 <span class="comment">        process creation and deletion. The routine is passed the unique Id</span>
01708 <span class="comment">        of the created or deleted process and the parent process if it was</span>
01709 <span class="comment">        created with the inherit handles option. If it was created without</span>
01710 <span class="comment">        the inherit handle options, then the parent process Id will be NULL.</span>
01711 <span class="comment">        The third parameter passed to the notify routine is TRUE if the process</span>
01712 <span class="comment">        is being created and FALSE if it is being deleted.</span>
01713 <span class="comment"></span>
01714 <span class="comment">        The callout for creation happens just after the first thread in the</span>
01715 <span class="comment">        process has been created. The callout for deletion happens after the</span>
01716 <span class="comment">        last thread in a process has terminated and the address space is about</span>
01717 <span class="comment">        to be deleted. It is possible to get a deletion call without a creation</span>
01718 <span class="comment">        call if the pathological case where a process is created and deleted</span>
01719 <span class="comment">        without a thread ever being created.</span>
01720 <span class="comment"></span>
01721 <span class="comment">    Remove - FALSE specifies to install the callout and TRUE specifies to</span>
01722 <span class="comment">        remove the callout that mat</span>
01723 <span class="comment"></span>
01724 <span class="comment">Return Value:</span>
01725 <span class="comment"></span>
01726 <span class="comment">    STATUS_SUCCESS if successful, and STATUS_INVALID_PARAMETER if not.</span>
01727 <span class="comment"></span>
01728 <span class="comment">--*/</span>
01729 
01730 {
01731 
01732     ULONG i;
01733 
01734     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d8/d1/psp_8h.html#a5">PSP_MAX_CREATE_PROCESS_NOTIFY</a>; i++) {
01735         <span class="keywordflow">if</span> (Remove) {
01736             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i] == NotifyRoutine) {
01737                 <a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01738                 <a class="code" href="../../d8/d1/psp_8h.html#a21">PspCreateProcessNotifyRoutineCount</a> -= 1;
01739                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01740             }
01741 
01742         } <span class="keywordflow">else</span> {
01743             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01744                 <a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i] = NotifyRoutine;
01745                 <a class="code" href="../../d8/d1/psp_8h.html#a21">PspCreateProcessNotifyRoutineCount</a> += 1;
01746                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01747             }
01748         }
01749     }
01750 
01751     <span class="keywordflow">return</span> Remove ? STATUS_PROCEDURE_NOT_FOUND : STATUS_INVALID_PARAMETER;
01752 }
01753 
01754 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01755"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a18">01755</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a18">PsSetCreateThreadNotifyRoutine</a>(
01756     IN PCREATE_THREAD_NOTIFY_ROUTINE NotifyRoutine
01757     )
01758 
01759 <span class="comment">/*++</span>
01760 <span class="comment"></span>
01761 <span class="comment">Routine Description:</span>
01762 <span class="comment"></span>
01763 <span class="comment">    This function allows an installable file system to hook into thread</span>
01764 <span class="comment">    creation and deletion to track those events against their own internal</span>
01765 <span class="comment">    data structures.</span>
01766 <span class="comment"></span>
01767 <span class="comment">Arguments:</span>
01768 <span class="comment"></span>
01769 <span class="comment">    NotifyRoutine - Supplies the address of the routine which is called at</span>
01770 <span class="comment">        thread creation and deletion. The routine is passed the unique Id</span>
01771 <span class="comment">        of the created or deleted thread and the unique Id of the containing</span>
01772 <span class="comment">        process. The third parameter passed to the notify routine is TRUE if</span>
01773 <span class="comment">        the thread is being created and FALSE if it is being deleted.</span>
01774 <span class="comment"></span>
01775 <span class="comment">Return Value:</span>
01776 <span class="comment"></span>
01777 <span class="comment">    STATUS_SUCCESS if successful, and STATUS_INSUFFICIENT_RESOURCES if not.</span>
01778 <span class="comment"></span>
01779 <span class="comment">--*/</span>
01780 
01781 {
01782 
01783     ULONG i;
01784     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01785 
01786     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01787     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d1/psp_8h.html#a6">PSP_MAX_CREATE_THREAD_NOTIFY</a>; i += 1) {
01788         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01789             <a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i] = NotifyRoutine;
01790             <a class="code" href="../../d8/d1/psp_8h.html#a23">PspCreateThreadNotifyRoutineCount</a> += 1;
01791             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01792             <span class="keywordflow">break</span>;
01793         }
01794     }
01795 
01796     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01797 }
01798 
01799 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01800"></a><a class="code" href="../../d8/d1/psp_8h.html#a64">01800</a> <a class="code" href="../../d8/d1/psp_8h.html#a64">PspUserThreadStartup</a>(
01801     IN PKSTART_ROUTINE StartRoutine,
01802     IN PVOID StartContext
01803     )
01804 
01805 <span class="comment">/*++</span>
01806 <span class="comment"></span>
01807 <span class="comment">Routine Description:</span>
01808 <span class="comment"></span>
01809 <span class="comment">    This function is called by the kernel to start a user-mode thread.</span>
01810 <span class="comment"></span>
01811 <span class="comment">Arguments:</span>
01812 <span class="comment"></span>
01813 <span class="comment">    StartRoutine - Ignored.</span>
01814 <span class="comment"></span>
01815 <span class="comment">    StartContext - Supplies the initial pc value for the thread.</span>
01816 <span class="comment"></span>
01817 <span class="comment">Return Value:</span>
01818 <span class="comment"></span>
01819 <span class="comment">    None.</span>
01820 <span class="comment"></span>
01821 <span class="comment">--*/</span>
01822 
01823 {
01824     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01825     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> StartApc;
01826     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01827 
01828     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01829 
01830     UNREFERENCED_PARAMETER(StartRoutine);
01831 
01832     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01833 
01834     <span class="comment">//</span>
01835     <span class="comment">// All threads start with an APC at LdrInitializeThunk</span>
01836     <span class="comment">//</span>
01837 
01838     <a class="code" href="../../d4/d5/procsup_8c.html#a43">MmAllowWorkingSetExpansion</a>();
01839 
01840     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01841 
01842     <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> &amp;&amp; !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> ) {
01843 
01844         StartApc = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,(ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>));
01845 
01846         ((PTEB)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb.Teb)-&gt;CurrentLocale = <a class="code" href="../../d1/d9/ps_8h.html#a59">PsDefaultThreadLocaleId</a>;
01847 
01848         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(
01849             StartApc,
01850             &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01851             <a class="code" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>,
01852             <a class="code" href="../../d8/d0/psdelete_8c.html#a8">PspNullSpecialApc</a>,
01853             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01854             <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o2">LoaderInitRoutine</a>,
01855             <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01856             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01857             );
01858 
01859         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(StartApc,(PVOID) <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o1">DllBase</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0) ) {
01860             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(StartApc);
01861         } <span class="keywordflow">else</span> {
01862             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01863         }
01864     } <span class="keywordflow">else</span> {
01865 
01866         <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> ) {
01867 
01868             <span class="comment">//</span>
01869             <span class="comment">// If DeadThread is not set, then it means the thread was terminated before</span>
01870             <span class="comment">// it started, but creation was ok. Need to let debuggers see these threads</span>
01871             <span class="comment">// for an instant because if they are the last to exit, the exitprocess</span>
01872             <span class="comment">// message gets nuked</span>
01873             <span class="comment">//</span>
01874 
01875             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(0);
01876             <a class="code" href="../../d4/d3/dbgk_8h.html#a0">DbgkCreateThread</a>(StartContext);
01877 
01878             }
01879         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(STATUS_THREAD_IS_TERMINATING);
01880     }
01881 
01882     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(0);
01883 
01884     <a class="code" href="../../d4/d3/dbgk_8h.html#a0">DbgkCreateThread</a>(StartContext);
01885 
01886     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a> == 0 ) {
01887         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a> = 1;
01888     }
01889 
01890 }
01891 
01892 
01893 
01894 ULONG
<a name="l01895"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a20">01895</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a20">PspUnhandledExceptionInSystemThread</a>(
01896     IN PEXCEPTION_POINTERS ExceptionPointers
01897     )
01898 {
01899     KdPrint((<span class="stringliteral">"PS: Unhandled Kernel Mode Exception Pointers = 0x%p\n"</span>, ExceptionPointers));
01900     KdPrint((<span class="stringliteral">"Code %x Addr %p Info0 %p Info1 %p Info2 %p Info3 %p\n"</span>,
01901         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
01902         (ULONG_PTR)ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionAddress,
01903         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[0],
01904         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[1],
01905         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[2],
01906         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[3]
01907         ));
01908 
01909     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
01910         <a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
01911         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
01912         (ULONG_PTR)ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionAddress,
01913         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[0],
01914         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionInformation[1]
01915         );
01916     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
01917 }
01918 
01919 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01920"></a><a class="code" href="../../d8/d1/psp_8h.html#a65">01920</a> <a class="code" href="../../d8/d1/psp_8h.html#a65">PspSystemThreadStartup</a>(
01921     IN PKSTART_ROUTINE StartRoutine,
01922     IN PVOID StartContext
01923     )
01924 
01925 <span class="comment">/*++</span>
01926 <span class="comment"></span>
01927 <span class="comment">Routine Description:</span>
01928 <span class="comment"></span>
01929 <span class="comment">    This function is called by the kernel to start a system thread.</span>
01930 <span class="comment"></span>
01931 <span class="comment">Arguments:</span>
01932 <span class="comment"></span>
01933 <span class="comment">    StartRoutine - Supplies the address of the system threads entry point.</span>
01934 <span class="comment"></span>
01935 <span class="comment">    StartContext - Supplies a context value for the system thread.</span>
01936 <span class="comment"></span>
01937 <span class="comment">Return Value:</span>
01938 <span class="comment"></span>
01939 <span class="comment">    None.</span>
01940 <span class="comment"></span>
01941 <span class="comment">--*/</span>
01942 
01943 {
01944 
01945         <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01946 
01947         <a class="code" href="../../d4/d5/procsup_8c.html#a43">MmAllowWorkingSetExpansion</a>();
01948 
01949         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(0);
01950 
01951         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01952 
01953         <span class="keywordflow">try</span> {
01954             <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> &amp;&amp; !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> ) {
01955                 (StartRoutine)(StartContext);
01956                 }
01957             }
01958         except (<a class="code" href="../../d2/d8/ps_2create_8c.html#a20">PspUnhandledExceptionInSystemThread</a>(GetExceptionInformation())) {
01959             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>);
01960             }
01961         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(STATUS_SUCCESS);
01962 
01963 }
01964 
01965 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01966"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a22">01966</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(
01967     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01968     IN KPROCESSOR_MODE WaitMode,
01969     IN <a class="code" href="../../d1/d9/ps_8h.html#a73">PSLOCKPROCESSMODE</a> LockMode
01970     )
01971 
01972 <span class="comment">/*++</span>
01973 <span class="comment"></span>
01974 <span class="comment">Routine Description:</span>
01975 <span class="comment"></span>
01976 <span class="comment">    This function is used to lock the process from create/delete and to</span>
01977 <span class="comment">    freeze threads from entering/exiting the process.</span>
01978 <span class="comment"></span>
01979 <span class="comment">Arguments:</span>
01980 <span class="comment"></span>
01981 <span class="comment">    Process - Pointer to the process to lock</span>
01982 <span class="comment"></span>
01983 <span class="comment">    WaitMode - Supplies the processor mode to issue the wait under</span>
01984 <span class="comment"></span>
01985 <span class="comment">    LockMode - The type of lock to attempt</span>
01986 <span class="comment"></span>
01987 <span class="comment">                PsLockPollOnTimeout - Use a timeout and poll for the lock</span>
01988 <span class="comment">                    bailing if the process exits.</span>
01989 <span class="comment"></span>
01990 <span class="comment">                PsLockReturnTimeout - Do not poll, just timeout wait and</span>
01991 <span class="comment">                    return if you can not get the lock.</span>
01992 <span class="comment"></span>
01993 <span class="comment">                PsLockWaitForever - Wait without a timeout</span>
01994 <span class="comment"></span>
01995 <span class="comment"></span>
01996 <span class="comment">Return Value:</span>
01997 <span class="comment"></span>
01998 <span class="comment">    STATUS_SUCCESS - You got the lock, you must call PsUnlocProcess later on</span>
01999 <span class="comment"></span>
02000 <span class="comment">    STATUS_TIMEOUT - You requested PsLockReturnTimeout, and the lock was not available</span>
02001 <span class="comment"></span>
02002 <span class="comment">    STATUS_PROCESS_IS_TERMINATING - The process you are trying to lock is terminating</span>
02003 <span class="comment"></span>
02004 <span class="comment">--*/</span>
02005 
02006 {
02007 
02008     LARGE_INTEGER DueTime;
02009     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02010     PLARGE_INTEGER Timeout;
02011     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
02012     <a class="code" href="../../d1/d9/ps_8h.html#a73">PSLOCKPROCESSMODE</a> LocalLockMode;
02013     BOOLEAN WaitSuccess;
02014 
02015     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02016 
02017     LocalLockMode = LockMode;
02018     <span class="keywordflow">if</span> ( LockMode == <a class="code" href="../../d1/d9/ps_8h.html#a155a92">PsLockIAmExiting</a> ) {
02019         LocalLockMode = <a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>;
02020         }
02021 
02022     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02023 
02024 retry:
02025     <span class="comment">//</span>
02026     <span class="comment">// Acquire process lock fast mutex to synchronize access to the ownership,</span>
02027     <span class="comment">// lock count, and synchronization event of the specified process.</span>
02028     <span class="comment">//</span>
02029 
02030     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02031 
02032     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;<a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a>);
02033 
02034     <span class="comment">//</span>
02035     <span class="comment">// Check if the process lock can be acquired.</span>
02036     <span class="comment">//</span>
02037 
02038     <span class="keywordflow">if</span> (Process-&gt;LockCount != 1) {
02039 
02040         <span class="comment">//</span>
02041         <span class="comment">// The process lock is currently owned.</span>
02042         <span class="comment">//</span>
02043         <span class="comment">// If the lock mode is return timeout, then release the process lock</span>
02044         <span class="comment">// fast mutex and return timeout. Otherwise, set the timout value,</span>
02045         <span class="comment">// decrement the lock count, release the process lock fast mutex, and</span>
02046         <span class="comment">// wait for the process event.</span>
02047         <span class="comment">//</span>
02048 
02049         <span class="keywordflow">if</span> (LocalLockMode == <a class="code" href="../../d1/d9/ps_8h.html#a155a90">PsLockReturnTimeout</a>) {
02050             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a>);
02051             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02052             <span class="keywordflow">return</span> STATUS_TIMEOUT;
02053 
02054         } <span class="keywordflow">else</span> {
02055 
02056             <span class="comment">//</span>
02057             <span class="comment">// If the lock mode is not wait forever, then set the timeout</span>
02058             <span class="comment">// value to one second. Otherwise set the timeout to forever.</span>
02059             <span class="comment">//</span>
02060 
02061             <span class="keywordflow">if</span> (LocalLockMode != <a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>) {
02062                 DueTime.QuadPart = - 10 * 1000 * 1000;
02063                 Timeout = &amp;DueTime;
02064 
02065             } <span class="keywordflow">else</span> {
02066                 Timeout = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02067             }
02068 
02069             <span class="comment">//</span>
02070             <span class="comment">// Decrement the lock count and loop waiting for the process to</span>
02071             <span class="comment">// terminate or the lock to be granted.</span>
02072             <span class="comment">//</span>
02073 
02074             Process-&gt;LockCount -= 1;
02075             <span class="keywordflow">do</span> {
02076 
02077                 WaitSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02078                 <span class="comment">//</span>
02079                 <span class="comment">// If the specified process has exited, then set the</span>
02080                 <span class="comment">// completion status and exit the loop.</span>
02081                 <span class="comment">//</span>
02082 
02083                 <span class="keywordflow">if</span> (Process-&gt;ExitTime.QuadPart != 0 &amp;&amp; LocalLockMode != <a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>) {
02084                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
02085                     <span class="keywordflow">break</span>;
02086                 }
02087 
02088                 <span class="comment">//</span>
02089                 <span class="comment">// Release the process lock fast mutex and wait for the</span>
02090                 <span class="comment">// lock to be granted or time out to occur.</span>
02091                 <span class="comment">//</span>
02092 
02093                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a>);
02094 rewait:
02095                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;Process-&gt;LockEvent,
02096                                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
02097                                                WaitMode,
02098                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02099                                                Timeout);
02100 
02101                 <span class="comment">//</span>
02102                 <span class="comment">// If waitmode is user-mode, then we can pop out of the wait with</span>
02103                 <span class="comment">// status_user_apc. If callers are using PsLockWaitForever, they</span>
02104                 <span class="comment">// don't expect this API to return without holding the lock, so</span>
02105                 <span class="comment">// we need to re-execute the wait. Only place waitforever is used</span>
02106                 <span class="comment">// in conjunction with UserMode is exit where all we want to do</span>
02107                 <span class="comment">// with user-mode is allow our stack to swap, not service an exitapc</span>
02108                 <span class="comment">//</span>
02109                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC
02110                      &amp;&amp; WaitMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>
02111                      &amp;&amp; LocalLockMode == <a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a> ) {
02112                     WaitMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
02113                     <span class="keywordflow">goto</span> rewait;
02114                     }
02115 
02116                 <span class="comment">//</span>
02117                 <span class="comment">// Reacquire the process lock fast mutex and continue the</span>
02118                 <span class="comment">// loop if timeout has occured.</span>
02119                 <span class="comment">//</span>
02120                 <span class="comment">//</span>
02121 
02122                 <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;<a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a>);
02123 
02124                 <span class="comment">//</span>
02125                 <span class="comment">// If the specified process has exited, then set the</span>
02126                 <span class="comment">// completion status and exit the loop. This test needs</span>
02127                 <span class="comment">// to be repeated so we catch the non-timed out wait</span>
02128                 <span class="comment">// case where the process terminated and the lock was released</span>
02129                 <span class="comment">// during the wait period</span>
02130                 <span class="comment">//</span>
02131 
02132                 <span class="keywordflow">if</span> ( Process-&gt;ExitTime.QuadPart != 0
02133                      &amp;&amp; LocalLockMode != <a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a> ) {
02134 
02135                     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
02136                         <span class="comment">//</span>
02137                         <span class="comment">// We came out of the wait due to someone setting the</span>
02138                         <span class="comment">// event. Since we are now going to bail,</span>
02139                         <span class="comment">// we need to set the event to pass ownership on to someone else.</span>
02140                         <span class="comment">//</span>
02141                         WaitSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02142                         }
02143                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
02144                     <span class="keywordflow">break</span>;
02145                 }
02146 
02147             } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT);
02148 
02149             <span class="comment">//</span>
02150             <span class="comment">// If the completion status is success, then the lock has been</span>
02151             <span class="comment">// granted and the owner is set. Otherwise, a user APC is pending</span>
02152             <span class="comment">// or the process has terminated and the lock request should be</span>
02153             <span class="comment">// dropped.</span>
02154             <span class="comment">//</span>
02155 
02156             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
02157                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
02158                 Process-&gt;LockCount += 1;
02159 
02160                 <span class="keywordflow">if</span> ( Process-&gt;LockCount == 1 ) {
02161                     <span class="comment">//</span>
02162                     <span class="comment">// No one else is involved with the lock. We were granted owner</span>
02163                     <span class="comment">// ship. We need to make sure the event is NOT signalled</span>
02164                     <span class="comment">//</span>
02165                     <span class="comment">// Is doesn't matter if we bail in this case due to a successful</span>
02166                     <span class="comment">// wait, timeout. A lock count of 1 is the initial state</span>
02167                     <span class="comment">// of a free lock.</span>
02168 
02169                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;Process-&gt;LockEvent);
02170                 } <span class="keywordflow">else</span> {
02171 
02172                     <span class="comment">//</span>
02173                     <span class="comment">// A LockCount !=1 means that others are involved</span>
02174                     <span class="comment">// in the lock. We requested ownership of the lock</span>
02175                     <span class="comment">// by decrementing lockcount.</span>
02176                     <span class="comment">//</span>
02177                     <span class="comment">// We were granted ownership IF our wait was satisfied.</span>
02178                     <span class="comment">// Since we are bailing, we need to pass this ownership along</span>
02179                     <span class="comment">// to the next waiter.</span>
02180                     <span class="comment">//</span>
02181                     <span class="comment">// If we were not granted ownership (wait timed out, or we</span>
02182                     <span class="comment">// bailed before the wait) then we don't have to do anything</span>
02183                     <span class="comment">// more than increment the lock count</span>
02184                     <span class="comment">//</span>
02185 
02186                     <span class="keywordflow">if</span> ( WaitSuccess ) {
02187                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;Process-&gt;LockEvent, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02188                     }
02189                 }
02190 
02191             } <span class="keywordflow">else</span> {
02192                 Process-&gt;LockOwner = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
02193             }
02194         }
02195 
02196     } <span class="keywordflow">else</span> {
02197 
02198         <span class="comment">//</span>
02199         <span class="comment">// The process lock is not currently owned.</span>
02200         <span class="comment">//</span>
02201         <span class="comment">// If the lock mode is not wait forever and the process has already</span>
02202         <span class="comment">// terminated, then set the completion status to process terminating.</span>
02203         <span class="comment">// Otherwise, decrement the lock count, set the lock owner, and set</span>
02204         <span class="comment">// the completion status to success.</span>
02205         <span class="comment">//</span>
02206 
02207         <span class="keywordflow">if</span> ((LocalLockMode != <a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>) &amp;&amp;
02208             ( (Process-&gt;ExitTime.QuadPart != 0 || <a class="code" href="../../d3/d5/procobj_8c.html#a9">KeReadStateProcess</a>(&amp;Process-&gt;Pcb) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) )
02209            ) {
02210             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
02211 
02212         } <span class="keywordflow">else</span> {
02213             Process-&gt;LockCount -= 1;
02214             Process-&gt;LockOwner = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
02215             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02216         }
02217     }
02218 
02219     <span class="comment">//</span>
02220     <span class="comment">// Release the process lock fast mutex and return the completion</span>
02221     <span class="comment">// status.</span>
02222     <span class="comment">//</span>
02223 
02224     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a>);
02225 
02226     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
02227         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02228     } <span class="keywordflow">else</span> {
02229 
02230         <span class="comment">//</span>
02231         <span class="comment">// We don't want to be "frozen" with the process lock held, so now</span>
02232         <span class="comment">// that we own the lock, check to see if we have a pending freeze count,</span>
02233         <span class="comment">// and if we do and dropping the lock will help, then drop it</span>
02234         <span class="comment">//</span>
02235 
02236         <span class="keywordflow">if</span> ((LockMode != <a class="code" href="../../d1/d9/ps_8h.html#a155a92">PsLockIAmExiting</a>) &amp;&amp;
02237             (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o65">FreezeCount</a> != 0) &amp;&amp;
02238             (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == (ULONG) -1) ) {
02239             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02240             <span class="keywordflow">goto</span> retry;
02241         }
02242     }
02243 
02244     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02245 }
02246 
02247 
02248 
02249 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02250"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a23">02250</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(
02251     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02252     )
02253 
02254 <span class="comment">/*++</span>
02255 <span class="comment"></span>
02256 <span class="comment">Routine Description:</span>
02257 <span class="comment"></span>
02258 <span class="comment">    This function is the opposite of a successful call to PsLockProcess. It</span>
02259 <span class="comment">    simply releases the createdelete lock for a process.</span>
02260 <span class="comment"></span>
02261 <span class="comment">Arguments:</span>
02262 <span class="comment"></span>
02263 <span class="comment">    Process - Supplies the address of the process whose create/delete</span>
02264 <span class="comment">        lock is to be released.</span>
02265 <span class="comment"></span>
02266 <span class="comment">Return Value:</span>
02267 <span class="comment"></span>
02268 <span class="comment">    None.</span>
02269 <span class="comment"></span>
02270 <span class="comment">--*/</span>
02271 
02272 {
02273 
02274     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02275 
02276     <span class="comment">//</span>
02277     <span class="comment">// Acquire process lock fast mutex to synchronize access to the ownership,</span>
02278     <span class="comment">// lock count, and synchronization event of the specified process.</span>
02279     <span class="comment">//</span>
02280 
02281     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;<a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a>);
02282 
02283     <span class="comment">//</span>
02284     <span class="comment">// Increment the lock count and clear the lock owner. If the lock count</span>
02285     <span class="comment">// is less than one, then set the lock event.</span>
02286     <span class="comment">//</span>
02287 
02288     Process-&gt;LockCount += 1;
02289     Process-&gt;LockOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02290     <span class="keywordflow">if</span> (Process-&gt;LockCount != 1) {
02291         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;Process-&gt;LockEvent, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02292     }
02293 
02294     <span class="comment">//</span>
02295     <span class="comment">// Release the process lock fast mutex and return.</span>
02296     <span class="comment">//</span>
02297 
02298 
02299     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a>);
02300     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02301     <span class="keywordflow">return</span>;
02302 }
02303 
02304 
02305 HANDLE
<a name="l02306"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a24">02306</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a24">PsGetCurrentProcessId</a>( VOID )
02307 {
02308     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess;
02309 }
02310 
02311 HANDLE
<a name="l02312"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a25">02312</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a25">PsGetCurrentThreadId</a>( VOID )
02313 {
02314     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread;
02315 }
02316 
02317 BOOLEAN
<a name="l02318"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a26">02318</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a26">PsGetVersion</a>(
02319     PULONG MajorVersion OPTIONAL,
02320     PULONG MinorVersion OPTIONAL,
02321     PULONG BuildNumber OPTIONAL,
02322     PUNICODE_STRING CSDVersion OPTIONAL
02323     )
02324 {
02325     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(MajorVersion)) {
02326         *MajorVersion = <a class="code" href="../../d8/d1/init_8h.html#a5">NtMajorVersion</a>;
02327     }
02328 
02329     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(MinorVersion)) {
02330         *MinorVersion = <a class="code" href="../../d8/d1/init_8h.html#a6">NtMinorVersion</a>;
02331     }
02332 
02333     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BuildNumber)) {
02334         *BuildNumber = <a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &amp; 0x3FFF;
02335     }
02336 
02337     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CSDVersion)) {
02338         *CSDVersion = <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>;
02339     }
02340     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &gt;&gt; 28) == 0xC;
02341 }
02342 
02343 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02344"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a27">02344</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a27">PsSetLoadImageNotifyRoutine</a>(
02345     IN <a class="code" href="../../d1/d9/ps_8h.html#a71">PLOAD_IMAGE_NOTIFY_ROUTINE</a> NotifyRoutine
02346     )
02347 
02348 <span class="comment">/*++</span>
02349 <span class="comment"></span>
02350 <span class="comment">Routine Description:</span>
02351 <span class="comment"></span>
02352 <span class="comment">    This function allows a device driver to get notified for</span>
02353 <span class="comment">    image loads. The notify is issued for both kernel and user</span>
02354 <span class="comment">    mode image loads system-wide.</span>
02355 <span class="comment"></span>
02356 <span class="comment">Arguments:</span>
02357 <span class="comment"></span>
02358 <span class="comment">    NotifyRoutine - Supplies the address of a routine which is called at</span>
02359 <span class="comment">        image load. The routine is passed information describing the</span>
02360 <span class="comment">        image being loaded.</span>
02361 <span class="comment"></span>
02362 <span class="comment">        The callout for creation happens just after the image is loaded</span>
02363 <span class="comment">        into memory but before executiona of the image.</span>
02364 <span class="comment"></span>
02365 <span class="comment">    Remove - FALSE specifies to install the callout and TRUE specifies to</span>
02366 <span class="comment">        remove the callout that mat</span>
02367 <span class="comment"></span>
02368 <span class="comment">Return Value:</span>
02369 <span class="comment"></span>
02370 <span class="comment">    STATUS_SUCCESS if successful, and STATUS_INVALID_PARAMETER if not.</span>
02371 <span class="comment"></span>
02372 <span class="comment">--*/</span>
02373 
02374 {
02375 
02376     ULONG i;
02377     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02378 
02379     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02380 
02381     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02382     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d8/d1/psp_8h.html#a7">PSP_MAX_LOAD_IMAGE_NOTIFY</a>; i++) {
02383         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a26">PspLoadImageNotifyRoutine</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02384             <a class="code" href="../../d8/d1/psp_8h.html#a26">PspLoadImageNotifyRoutine</a>[i] = NotifyRoutine;
02385             <a class="code" href="../../d8/d1/psp_8h.html#a25">PspLoadImageNotifyRoutineCount</a> += 1;
02386             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02387             <a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02388             <span class="keywordflow">break</span>;
02389         }
02390     }
02391 
02392     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02393 }
02394 
02395 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02396"></a><a class="code" href="../../d2/d8/ps_2create_8c.html#a28">02396</a> <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(
02397     IN PUNICODE_STRING FullImageName,
02398     IN HANDLE ProcessId,                <span class="comment">// pid into which image is being mapped</span>
02399     IN <a class="code" href="../../d2/d1/struct__IMAGE__INFO.html">PIMAGE_INFO</a> ImageInfo
02400     )
02401 <span class="comment">/*++</span>
02402 <span class="comment"></span>
02403 <span class="comment">Routine Description:</span>
02404 <span class="comment"></span>
02405 <span class="comment">    This function actually calls the registered image notify functions (on behalf)</span>
02406 <span class="comment">    of mapview.c and sysload.c</span>
02407 <span class="comment"></span>
02408 <span class="comment">Arguments:</span>
02409 <span class="comment"></span>
02410 <span class="comment">    FullImageName - The name of the image being loaded</span>
02411 <span class="comment"></span>
02412 <span class="comment">    ProcessId - The process that the image is being loaded into (0 for driver loads)</span>
02413 <span class="comment"></span>
02414 <span class="comment">    ImageInfo - Various flags for the image</span>
02415 <span class="comment"></span>
02416 <span class="comment">Return Value:</span>
02417 <span class="comment"></span>
02418 <span class="comment">    None.</span>
02419 <span class="comment"></span>
02420 <span class="comment">--*/</span>
02421 
02422 {
02423     <span class="keywordtype">int</span> i;
02424 
02425     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02426 
02427     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a> ) {
02428         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a7">PSP_MAX_LOAD_IMAGE_NOTIFY</a>; i++) {
02429             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a26">PspLoadImageNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02430                (*<a class="code" href="../../d8/d1/psp_8h.html#a26">PspLoadImageNotifyRoutine</a>[i])(
02431                     (PUNICODE_STRING) FullImageName,
02432                     ProcessId,
02433                     ImageInfo
02434                     );
02435                 }
02436             }
02437         }
02438 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
