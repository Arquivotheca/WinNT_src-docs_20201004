<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flush.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flush.c</h1><a href="../../d2/d5/mips_2flush_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    flush.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements MIPS machine dependent kernel functions to flush</span>
00012 <span class="comment">    the data and instruction caches and to flush I/O buffers.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 26-Apr-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
<a name="l00027"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a0">00027</a> ULONG <a class="code" href="../../d2/d5/mips_2flush_8c.html#a0">ChangeColor</a>;
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">// Define forward referenced prototyes.</span>
00031 <span class="comment">//</span>
00032 
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00034 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a0">KiChangeColorPageTarget</a> (
00035     IN PULONG SignalDone,
00036     IN PVOID NewColor,
00037     IN PVOID OldColor,
00038     IN PVOID PageFrame
00039     );
00040 
00041 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00042 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a1">KiSweepDcacheTarget</a> (
00043     IN PULONG SignalDone,
00044     IN PVOID Parameter1,
00045     IN PVOID Parameter2,
00046     IN PVOID Parameter3
00047     );
00048 
00049 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00050 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a2">KiSweepIcacheTarget</a> (
00051     IN PULONG SignalDone,
00052     IN PVOID Parameter1,
00053     IN PVOID Parameter2,
00054     IN PVOID Parameter3
00055     );
00056 
00057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00058 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a3">KiSweepIcacheRangeTarget</a> (
00059     IN PULONG SignalDone,
00060     IN PVOID BaseAddress,
00061     IN PVOID Length,
00062     IN PVOID Parameter3
00063     );
00064 
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a4">KiFlushIoBuffersTarget</a> (
00067     IN PULONG SignalDone,
00068     IN PVOID Mdl,
00069     IN PVOID ReadOperation,
00070     IN PVOID DmaOperation
00071     );
00072 
00073 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00074"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a6">00074</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a5">KeChangeColorPage</a> (
00075     IN PVOID NewColor,
00076     IN PVOID OldColor,
00077     IN ULONG PageFrame
00078     )
00079 
00080 <span class="comment">/*++</span>
00081 <span class="comment"></span>
00082 <span class="comment">Routine Description:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    This routine changes the color of a page.</span>
00085 <span class="comment"></span>
00086 <span class="comment">Arguments:</span>
00087 <span class="comment"></span>
00088 <span class="comment">    NewColor - Supplies the page aligned virtual address of the new color</span>
00089 <span class="comment">        the page to change.</span>
00090 <span class="comment"></span>
00091 <span class="comment">    OldColor - Supplies the page aligned virtual address of the old color</span>
00092 <span class="comment">        of the page to change.</span>
00093 <span class="comment"></span>
00094 <span class="comment">    PageFrame - Supplies the page frame number of the page that is changed.</span>
00095 <span class="comment"></span>
00096 <span class="comment">Return Value:</span>
00097 <span class="comment"></span>
00098 <span class="comment">    None.</span>
00099 <span class="comment"></span>
00100 <span class="comment">--*/</span>
00101 
00102 {
00103 
00104     KIRQL OldIrql;
00105     KAFFINITY TargetProcessors;
00106 
00107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00108 
00109     <a class="code" href="../../d2/d5/mips_2flush_8c.html#a0">ChangeColor</a> += 1;
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00113     <span class="comment">//</span>
00114 
00115 <span class="preprocessor">#if !defined(NT_UP)</span>
00116 <span class="preprocessor"></span>
00117     OldIrql = KeRaiseIrqlToSynchLevel();
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// Compute the set of target processors and send the change color</span>
00121     <span class="comment">// parameters to the target processors, if any, for execution.</span>
00122     <span class="comment">//</span>
00123 
00124     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00125     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00126         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00127                         <a class="code" href="../../d2/d5/mips_2flush_8c.html#a1">KiChangeColorPageTarget</a>,
00128                         (PVOID)NewColor,
00129                         (PVOID)OldColor,
00130                         (PVOID)PageFrame);
00131     }
00132 
00133 <span class="preprocessor">#endif</span>
00134 <span class="preprocessor"></span>
00135     <span class="comment">//</span>
00136     <span class="comment">// Change the color of the page on the current processor.</span>
00137     <span class="comment">//</span>
00138 
00139     HalChangeColorPage(NewColor, OldColor, PageFrame);
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">// Wait until all target processors have finished changing the color</span>
00143     <span class="comment">// of the page.</span>
00144     <span class="comment">//</span>
00145 
00146 <span class="preprocessor">#if !defined(NT_UP)</span>
00147 <span class="preprocessor"></span>
00148     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00149         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>();
00150     }
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">// Lower IRQL to its previous level and return.</span>
00154     <span class="comment">//</span>
00155 
00156     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00157 
00158 <span class="preprocessor">#endif</span>
00159 <span class="preprocessor"></span>
00160     <span class="keywordflow">return</span>;
00161 }
00162 
00163 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00164"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a1">00164</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a0">KiChangeColorPageTarget</a> (
00165     IN PULONG SignalDone,
00166     IN PVOID NewColor,
00167     IN PVOID OldColor,
00168     IN PVOID PageFrame
00169     )
00170 
00171 <span class="comment">/*++</span>
00172 <span class="comment"></span>
00173 <span class="comment">Routine Description:</span>
00174 <span class="comment"></span>
00175 <span class="comment">    This is the target function for changing the color of a page.</span>
00176 <span class="comment"></span>
00177 <span class="comment">Arguments:</span>
00178 <span class="comment"></span>
00179 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00180 <span class="comment">        requested operation has been performed.</span>
00181 <span class="comment"></span>
00182 <span class="comment">    NewColor - Supplies the page aligned virtual address of the new color</span>
00183 <span class="comment">        the page to change.</span>
00184 <span class="comment"></span>
00185 <span class="comment">    OldColor - Supplies the page aligned virtual address of the old color</span>
00186 <span class="comment">        of the page to change.</span>
00187 <span class="comment"></span>
00188 <span class="comment">    PageFrame - Supplies the page frame number of the page that is changed.</span>
00189 <span class="comment"></span>
00190 <span class="comment">Return Value:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    None.</span>
00193 <span class="comment"></span>
00194 <span class="comment">--*/</span>
00195 
00196 {
00197 
00198 
00199     <span class="comment">//</span>
00200     <span class="comment">// Change the color of the page on the current processor and clear</span>
00201     <span class="comment">// change color packet address to signal the source to continue.</span>
00202     <span class="comment">//</span>
00203 
00204 <span class="preprocessor">#if !defined(NT_UP)</span>
00205 <span class="preprocessor"></span>
00206     HalChangeColorPage(NewColor, OldColor, (ULONG)PageFrame);
00207     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00208 
00209 <span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span>
00211     <span class="keywordflow">return</span>;
00212 }
00213 
00214 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00215"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a7">00215</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (
00216     IN BOOLEAN AllProcessors
00217     )
00218 
00219 <span class="comment">/*++</span>
00220 <span class="comment"></span>
00221 <span class="comment">Routine Description:</span>
00222 <span class="comment"></span>
00223 <span class="comment">    This function flushes the data cache on all processors that are currently</span>
00224 <span class="comment">    running threads which are children of the current process or flushes the</span>
00225 <span class="comment">    data cache on all processors in the host configuration.</span>
00226 <span class="comment"></span>
00227 <span class="comment">Arguments:</span>
00228 <span class="comment"></span>
00229 <span class="comment">    AllProcessors - Supplies a boolean value that determines which data</span>
00230 <span class="comment">        caches are flushed.</span>
00231 <span class="comment"></span>
00232 <span class="comment">Return Value:</span>
00233 <span class="comment"></span>
00234 <span class="comment">    None.</span>
00235 <span class="comment"></span>
00236 <span class="comment">--*/</span>
00237 
00238 {
00239 
00240     KIRQL OldIrql;
00241     KAFFINITY TargetProcessors;
00242 
00243     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00247     <span class="comment">//</span>
00248 
00249 <span class="preprocessor">#if !defined(NT_UP)</span>
00250 <span class="preprocessor"></span>
00251     OldIrql = KeRaiseIrqlToSynchLevel();
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">// Compute the set of target processors and send the sweep parameters</span>
00255     <span class="comment">// to the target processors, if any, for execution.</span>
00256     <span class="comment">//</span>
00257 
00258     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00259     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00260         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00261                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a1">KiSweepDcacheTarget</a>,
00262                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00263                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00264                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00265     }
00266 
00267 <span class="preprocessor">#endif</span>
00268 <span class="preprocessor"></span>
00269     <span class="comment">//</span>
00270     <span class="comment">// Sweep the data cache on the current processor.</span>
00271     <span class="comment">//</span>
00272 
00273     HalSweepDcache();
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Wait until all target processors have finished sweeping the their</span>
00277     <span class="comment">// data cache.</span>
00278     <span class="comment">//</span>
00279 
00280 <span class="preprocessor">#if !defined(NT_UP)</span>
00281 <span class="preprocessor"></span>
00282     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00283         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>();
00284     }
00285 
00286     <span class="comment">//</span>
00287     <span class="comment">// Lower IRQL to its previous level and return.</span>
00288     <span class="comment">//</span>
00289 
00290     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00291 
00292 <span class="preprocessor">#endif</span>
00293 <span class="preprocessor"></span>
00294     <span class="keywordflow">return</span>;
00295 }
00296 
00297 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00298 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a1">KiSweepDcacheTarget</a> (
00299     IN PULONG SignalDone,
00300     IN PVOID Parameter1,
00301     IN PVOID Parameter2,
00302     IN PVOID Parameter3
00303     )
00304 
00305 <span class="comment">/*++</span>
00306 <span class="comment"></span>
00307 <span class="comment">Routine Description:</span>
00308 <span class="comment"></span>
00309 <span class="comment">    This is the target function for sweeping the data cache on target</span>
00310 <span class="comment">    processors.</span>
00311 <span class="comment"></span>
00312 <span class="comment">Arguments:</span>
00313 <span class="comment"></span>
00314 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00315 <span class="comment">        requested operation has been performed.</span>
00316 <span class="comment"></span>
00317 <span class="comment">    Parameter1 - Parameter3 - Not used.</span>
00318 <span class="comment"></span>
00319 <span class="comment">Return Value:</span>
00320 <span class="comment"></span>
00321 <span class="comment">    None.</span>
00322 <span class="comment"></span>
00323 <span class="comment">--*/</span>
00324 
00325 {
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">// Sweep the data cache on the current processor and clear the sweep</span>
00329     <span class="comment">// data cache packet address to signal the source to continue.</span>
00330     <span class="comment">//</span>
00331 
00332 <span class="preprocessor">#if !defined(NT_UP)</span>
00333 <span class="preprocessor"></span>
00334     HalSweepDcache();
00335     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00336 
00337 <span class="preprocessor">#endif</span>
00338 <span class="preprocessor"></span>
00339     <span class="keywordflow">return</span>;
00340 }
00341 
00342 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00343"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a8">00343</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a7">KeSweepIcache</a> (
00344     IN BOOLEAN AllProcessors
00345     )
00346 
00347 <span class="comment">/*++</span>
00348 <span class="comment"></span>
00349 <span class="comment">Routine Description:</span>
00350 <span class="comment"></span>
00351 <span class="comment">    This function flushes the instruction cache on all processors that are</span>
00352 <span class="comment">    currently running threads which are children of the current process or</span>
00353 <span class="comment">    flushes the instruction cache on all processors in the host configuration.</span>
00354 <span class="comment"></span>
00355 <span class="comment">Arguments:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    AllProcessors - Supplies a boolean value that determines which instruction</span>
00358 <span class="comment">        caches are flushed.</span>
00359 <span class="comment"></span>
00360 <span class="comment">Return Value:</span>
00361 <span class="comment"></span>
00362 <span class="comment">    None.</span>
00363 <span class="comment"></span>
00364 <span class="comment">--*/</span>
00365 
00366 {
00367 
00368     KIRQL OldIrql;
00369     KAFFINITY TargetProcessors;
00370 
00371     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">// Raise IRQL to synchrnization level to prevent a context switch.</span>
00375     <span class="comment">//</span>
00376 
00377 <span class="preprocessor">#if !defined(NT_UP)</span>
00378 <span class="preprocessor"></span>
00379     OldIrql = KeRaiseIrqlToSynchLevel();
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// Compute the set of target processors and send the sweep parameters</span>
00383     <span class="comment">// to the target processors, if any, for execution.</span>
00384     <span class="comment">//</span>
00385 
00386     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00387     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00388         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00389                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a2">KiSweepIcacheTarget</a>,
00390                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00391                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00392                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00393     }
00394 
00395 <span class="preprocessor">#endif</span>
00396 <span class="preprocessor"></span>
00397     <span class="comment">//</span>
00398     <span class="comment">// Sweep the instruction cache on the current processor.</span>
00399     <span class="comment">//</span>
00400 
00401     HalSweepIcache();
00402     HalSweepDcache();
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Wait until all target processors have finished sweeping the their</span>
00406     <span class="comment">// instruction cache.</span>
00407     <span class="comment">//</span>
00408 
00409 <span class="preprocessor">#if !defined(NT_UP)</span>
00410 <span class="preprocessor"></span>
00411     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00412         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>();
00413     }
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Lower IRQL to its previous level and return.</span>
00417     <span class="comment">//</span>
00418 
00419     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00420 
00421 <span class="preprocessor">#endif</span>
00422 <span class="preprocessor"></span>
00423     <span class="keywordflow">return</span>;
00424 }
00425 
00426 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00427 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a2">KiSweepIcacheTarget</a> (
00428     IN PULONG SignalDone,
00429     IN PVOID Parameter1,
00430     IN PVOID Parameter2,
00431     IN PVOID Parameter3
00432     )
00433 
00434 <span class="comment">/*++</span>
00435 <span class="comment"></span>
00436 <span class="comment">Routine Description:</span>
00437 <span class="comment"></span>
00438 <span class="comment">    This is the target function for sweeping the instruction cache on</span>
00439 <span class="comment">    target processors.</span>
00440 <span class="comment"></span>
00441 <span class="comment">Arguments:</span>
00442 <span class="comment"></span>
00443 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00444 <span class="comment">        requested operation has been performed.</span>
00445 <span class="comment"></span>
00446 <span class="comment">    Parameter1 - Parameter3 - Not used.</span>
00447 <span class="comment"></span>
00448 <span class="comment">Return Value:</span>
00449 <span class="comment"></span>
00450 <span class="comment">    None.</span>
00451 <span class="comment"></span>
00452 <span class="comment">--*/</span>
00453 
00454 {
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// Sweep the instruction cache on the current processor and clear</span>
00458     <span class="comment">// the sweep instruction cache packet address to signal the source</span>
00459     <span class="comment">// to continue.</span>
00460     <span class="comment">//</span>
00461 
00462 <span class="preprocessor">#if !defined(NT_UP)</span>
00463 <span class="preprocessor"></span>
00464     HalSweepIcache();
00465     HalSweepDcache();
00466     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00467 
00468 <span class="preprocessor">#endif</span>
00469 <span class="preprocessor"></span>
00470     <span class="keywordflow">return</span>;
00471 }
00472 
00473 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00474"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a9">00474</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a8">KeSweepIcacheRange</a> (
00475     IN BOOLEAN AllProcessors,
00476     IN PVOID BaseAddress,
00477     IN ULONG Length
00478     )
00479 
00480 <span class="comment">/*++</span>
00481 <span class="comment"></span>
00482 <span class="comment">Routine Description:</span>
00483 <span class="comment"></span>
00484 <span class="comment">    This function flushes the an range of virtual addresses from the primary</span>
00485 <span class="comment">    instruction cache on all processors that are currently running threads</span>
00486 <span class="comment">    which are children of the current process or flushes the range of virtual</span>
00487 <span class="comment">    addresses from the primary instruction cache on all processors in the host</span>
00488 <span class="comment">    configuration.</span>
00489 <span class="comment"></span>
00490 <span class="comment">Arguments:</span>
00491 <span class="comment"></span>
00492 <span class="comment">    AllProcessors - Supplies a boolean value that determines which instruction</span>
00493 <span class="comment">        caches are flushed.</span>
00494 <span class="comment"></span>
00495 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is flushed.</span>
00496 <span class="comment"></span>
00497 <span class="comment">    Length - Supplies the length of the range that is flushed if the base</span>
00498 <span class="comment">        address is specified.</span>
00499 <span class="comment"></span>
00500 <span class="comment">Return Value:</span>
00501 <span class="comment"></span>
00502 <span class="comment">    None.</span>
00503 <span class="comment"></span>
00504 <span class="comment">--*/</span>
00505 
00506 {
00507 
00508     ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00509     KIRQL OldIrql;
00510     KAFFINITY TargetProcessors;
00511 
00512     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">// If the length of the range is greater than the size of the primary</span>
00516     <span class="comment">// instruction cache, then set the length of the flush to the size of</span>
00517     <span class="comment">// the primary instruction cache and set the base address of zero.</span>
00518     <span class="comment">//</span>
00519     <span class="comment">// N.B. It is assumed that the size of the primary instruction and</span>
00520     <span class="comment">//      data caches are the same.</span>
00521     <span class="comment">//</span>
00522 
00523     <span class="keywordflow">if</span> (Length &gt; PCR-&gt;FirstLevelIcacheSize) {
00524         BaseAddress = (PVOID)0;
00525         Length = PCR-&gt;FirstLevelIcacheSize;
00526     }
00527 
00528     <span class="comment">//</span>
00529     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00530     <span class="comment">//</span>
00531 
00532 <span class="preprocessor">#if !defined(NT_UP)</span>
00533 <span class="preprocessor"></span>
00534     OldIrql = KeRaiseIrqlToSynchLevel();
00535 
00536     <span class="comment">//</span>
00537     <span class="comment">// Compute the set of target processors, and send the sweep range</span>
00538     <span class="comment">// parameters to the target processors, if any, for execution.</span>
00539     <span class="comment">//</span>
00540 
00541     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00542     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00543         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00544                         <a class="code" href="../../d2/d5/mips_2flush_8c.html#a4">KiSweepIcacheRangeTarget</a>,
00545                         (PVOID)BaseAddress,
00546                         (PVOID)Length,
00547                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00548     }
00549 
00550 <span class="preprocessor">#endif</span>
00551 <span class="preprocessor"></span>
00552     <span class="comment">//</span>
00553     <span class="comment">// Flush the specified range of virtual addresses from the primary</span>
00554     <span class="comment">// instruction cache.</span>
00555     <span class="comment">//</span>
00556 
00557     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (ULONG)BaseAddress &amp; PCR-&gt;IcacheAlignment;
00558     HalSweepIcacheRange((PVOID)((ULONG)BaseAddress &amp; ~PCR-&gt;IcacheAlignment),
00559                         (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + Length + PCR-&gt;IcacheAlignment) &amp; ~PCR-&gt;IcacheAlignment);
00560 
00561     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (ULONG)BaseAddress &amp; PCR-&gt;DcacheAlignment;
00562     HalSweepDcacheRange((PVOID)((ULONG)BaseAddress &amp; ~PCR-&gt;DcacheAlignment),
00563                         (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + Length + PCR-&gt;DcacheAlignment) &amp; ~PCR-&gt;DcacheAlignment);
00564 
00565     <span class="comment">//</span>
00566     <span class="comment">// Wait until all target processors have finished sweeping the specified</span>
00567     <span class="comment">// range of addresses from the instruction cache.</span>
00568     <span class="comment">//</span>
00569 
00570 <span class="preprocessor">#if !defined(NT_UP)</span>
00571 <span class="preprocessor"></span>
00572     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00573         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>();
00574     }
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// Lower IRQL to its previous level and return.</span>
00578     <span class="comment">//</span>
00579 
00580     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00581 
00582 <span class="preprocessor">#endif</span>
00583 <span class="preprocessor"></span>
00584     <span class="keywordflow">return</span>;
00585 }
00586 
00587 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00588"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a4">00588</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a3">KiSweepIcacheRangeTarget</a> (
00589     IN PULONG SignalDone,
00590     IN PVOID BaseAddress,
00591     IN PVOID Length,
00592     IN PVOID Parameter3
00593     )
00594 
00595 <span class="comment">/*++</span>
00596 <span class="comment"></span>
00597 <span class="comment">Routine Description:</span>
00598 <span class="comment"></span>
00599 <span class="comment">    This is the target function for sweeping a range of addresses from the</span>
00600 <span class="comment">    instruction cache.</span>
00601 <span class="comment">    processors.</span>
00602 <span class="comment"></span>
00603 <span class="comment">Arguments:</span>
00604 <span class="comment"></span>
00605 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00606 <span class="comment">        requested operation has been performed.</span>
00607 <span class="comment"></span>
00608 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is flushed.</span>
00609 <span class="comment"></span>
00610 <span class="comment">    Length - Supplies the length of the range that is flushed if the base</span>
00611 <span class="comment">        address is specified.</span>
00612 <span class="comment"></span>
00613 <span class="comment">    Parameter3 - Not used.</span>
00614 <span class="comment"></span>
00615 <span class="comment">Return Value:</span>
00616 <span class="comment"></span>
00617 <span class="comment">    None.</span>
00618 <span class="comment"></span>
00619 <span class="comment">--*/</span>
00620 
00621 {
00622 
00623     ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Sweep the specified instruction cache range on the current processor.</span>
00627     <span class="comment">//</span>
00628 
00629 <span class="preprocessor">#if !defined(NT_UP)</span>
00630 <span class="preprocessor"></span>
00631     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (ULONG)(BaseAddress) &amp; PCR-&gt;IcacheAlignment;
00632     HalSweepIcacheRange((PVOID)((ULONG)(BaseAddress) &amp; ~PCR-&gt;IcacheAlignment),
00633                         (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + (ULONG)Length + PCR-&gt;IcacheAlignment) &amp; ~PCR-&gt;IcacheAlignment);
00634 
00635     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (ULONG)(BaseAddress) &amp; PCR-&gt;DcacheAlignment;
00636     HalSweepDcacheRange((PVOID)((ULONG)(BaseAddress) &amp; ~PCR-&gt;DcacheAlignment),
00637                         (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + (ULONG)Length + PCR-&gt;DcacheAlignment) &amp; ~PCR-&gt;DcacheAlignment);
00638 
00639     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00640 
00641 <span class="preprocessor">#endif</span>
00642 <span class="preprocessor"></span>
00643     <span class="keywordflow">return</span>;
00644 }
00645 
00646 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00647"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a10">00647</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a9">KeFlushIoBuffers</a> (
00648     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00649     IN BOOLEAN ReadOperation,
00650     IN BOOLEAN DmaOperation
00651     )
00652 
00653 <span class="comment">/*++</span>
00654 <span class="comment"></span>
00655 <span class="comment">Routine Description:</span>
00656 <span class="comment"></span>
00657 <span class="comment">    This function flushes the I/O buffer specified by the memory descriptor</span>
00658 <span class="comment">    list from the data cache on all processors.</span>
00659 <span class="comment"></span>
00660 <span class="comment">Arguments:</span>
00661 <span class="comment"></span>
00662 <span class="comment">    Mdl - Supplies a pointer to a memory descriptor list that describes the</span>
00663 <span class="comment">        I/O buffer location.</span>
00664 <span class="comment"></span>
00665 <span class="comment">    ReadOperation - Supplies a boolean value that determines whether the I/O</span>
00666 <span class="comment">        operation is a read into memory.</span>
00667 <span class="comment"></span>
00668 <span class="comment">    DmaOperation - Supplies a boolean value that determines whether the I/O</span>
00669 <span class="comment">        operation is a DMA operation.</span>
00670 <span class="comment"></span>
00671 <span class="comment">Return Value:</span>
00672 <span class="comment"></span>
00673 <span class="comment">    None.</span>
00674 <span class="comment"></span>
00675 <span class="comment">--*/</span>
00676 
00677 {
00678 
00679     KIRQL OldIrql;
00680     KAFFINITY TargetProcessors;
00681 
00682     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00683 
00684     <span class="comment">//</span>
00685     <span class="comment">// If the operation is a DMA operation, then check if the flush</span>
00686     <span class="comment">// can be avoided because the host system supports the right set</span>
00687     <span class="comment">// of cache coherency attributes. Otherwise, the flush can also</span>
00688     <span class="comment">// be avoided if the operation is a programmed I/O and not a page</span>
00689     <span class="comment">// read.</span>
00690     <span class="comment">//</span>
00691 
00692     <span class="keywordflow">if</span> (DmaOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00693         <span class="keywordflow">if</span> (ReadOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00694             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> &amp; <a class="code" href="../../d4/d9/ke_8h.html#a41">DMA_READ_ICACHE_INVALIDATE</a>) != 0) {
00695 
00696                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> &amp; <a class="code" href="../../d4/d9/ke_8h.html#a40">DMA_READ_DCACHE_INVALIDATE</a>) != 0);
00697 
00698                 <span class="keywordflow">return</span>;
00699 
00700             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((Mdl-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a18">MDL_IO_PAGE_READ</a>) == 0) &amp;&amp;
00701                 ((<a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> &amp; <a class="code" href="../../d4/d9/ke_8h.html#a40">DMA_READ_DCACHE_INVALIDATE</a>) != 0)) {
00702                 <span class="keywordflow">return</span>;
00703             }
00704 
00705         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> &amp; <a class="code" href="../../d4/d9/ke_8h.html#a42">DMA_WRITE_DCACHE_SNOOP</a>) != 0) {
00706             <span class="keywordflow">return</span>;
00707         }
00708 
00709     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Mdl-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a18">MDL_IO_PAGE_READ</a>) == 0) {
00710         <span class="keywordflow">return</span>;
00711     }
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Either the operation is a DMA operation and the right coherency</span>
00715     <span class="comment">// atributes are not supported by the host system, or the operation</span>
00716     <span class="comment">// is programmed I/O and a page read.</span>
00717     <span class="comment">//</span>
00718     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00719     <span class="comment">//</span>
00720 
00721     OldIrql = KeRaiseIrqlToSynchLevel();
00722 
00723     <span class="comment">//</span>
00724     <span class="comment">// Compute the set of target processors, and send the flush I/O</span>
00725     <span class="comment">// parameters to the target processors, if any, for execution.</span>
00726     <span class="comment">//</span>
00727 
00728 <span class="preprocessor">#if !defined(NT_UP)</span>
00729 <span class="preprocessor"></span>
00730     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00731     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00732         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00733                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a3">KiFlushIoBuffersTarget</a>,
00734                         (PVOID)Mdl,
00735                         (PVOID)((ULONG)ReadOperation),
00736                         (PVOID)((ULONG)DmaOperation));
00737     }
00738 
00739 <span class="preprocessor">#endif</span>
00740 <span class="preprocessor"></span>
00741     <span class="comment">//</span>
00742     <span class="comment">// Flush I/O buffer on current processor.</span>
00743     <span class="comment">//</span>
00744 
00745     HalFlushIoBuffers(Mdl, ReadOperation, DmaOperation);
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// Wait until all target processors have finished flushing the</span>
00749     <span class="comment">// specified I/O buffer.</span>
00750     <span class="comment">//</span>
00751 
00752 <span class="preprocessor">#if !defined(NT_UP)</span>
00753 <span class="preprocessor"></span>
00754     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00755         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>();
00756     }
00757 
00758 <span class="preprocessor">#endif</span>
00759 <span class="preprocessor"></span>
00760     <span class="comment">//</span>
00761     <span class="comment">// Lower IRQL to its previous level and return.</span>
00762     <span class="comment">//</span>
00763 
00764     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00765     <span class="keywordflow">return</span>;
00766 }
00767 
00768 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00769"></a><a class="code" href="../../d2/d5/mips_2flush_8c.html#a5">00769</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a4">KiFlushIoBuffersTarget</a> (
00770     IN PULONG SignalDone,
00771     IN PVOID Mdl,
00772     IN PVOID ReadOperation,
00773     IN PVOID DmaOperation
00774     )
00775 
00776 <span class="comment">/*++</span>
00777 <span class="comment"></span>
00778 <span class="comment">Routine Description:</span>
00779 <span class="comment"></span>
00780 <span class="comment">    This is the target function for flushing an I/O buffer on target</span>
00781 <span class="comment">    processors.</span>
00782 <span class="comment"></span>
00783 <span class="comment">Arguments:</span>
00784 <span class="comment"></span>
00785 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00786 <span class="comment">        requested operation has been performed.</span>
00787 <span class="comment"></span>
00788 <span class="comment">    Mdl - Supplies a pointer to a memory descriptor list that describes the</span>
00789 <span class="comment">        I/O buffer location.</span>
00790 <span class="comment"></span>
00791 <span class="comment">    ReadOperation - Supplies a boolean value that determines whether the I/O</span>
00792 <span class="comment">        operation is a read into memory.</span>
00793 <span class="comment"></span>
00794 <span class="comment">    DmaOperation - Supplies a boolean value that determines whether the I/O</span>
00795 <span class="comment">        operation is a DMA operation.</span>
00796 <span class="comment"></span>
00797 <span class="comment">Return Value:</span>
00798 <span class="comment"></span>
00799 <span class="comment">    None.</span>
00800 <span class="comment"></span>
00801 <span class="comment">--*/</span>
00802 
00803 {
00804 
00805     <span class="comment">//</span>
00806     <span class="comment">// Flush the specified I/O buffer on the current processor.</span>
00807     <span class="comment">//</span>
00808 
00809 <span class="preprocessor">#if !defined(NT_UP)</span>
00810 <span class="preprocessor"></span>
00811     HalFlushIoBuffers((<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)Mdl,
00812                       (BOOLEAN)((ULONG)ReadOperation),
00813                       (BOOLEAN)((ULONG)DmaOperation));
00814 
00815     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00816 
00817 <span class="preprocessor">#endif</span>
00818 <span class="preprocessor"></span>
00819     <span class="keywordflow">return</span>;
00820 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
