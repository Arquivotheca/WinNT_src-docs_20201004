<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ddemlwp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ddemlwp.c File Reference</h1><code>#include "<a class="el" href="../../d8/d2/w32_2ntuser_2client_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d4/d3/ddemlwp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a0">ProcessDDEMLInitiate</a> (<a class="el" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii, HWND hwndClient, <a class="el" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a> aServer, <a class="el" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a> aTopic)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a1">DDEMLMotherWndProc</a> (HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a2">DDEMLClientWndProc</a> (HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a3">DDEMLServerWndProc</a> (HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a4">ProcessTerminateMsg</a> (<a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi, HWND hwndFrom)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a5">ProcessAsyncDDEMsg</a> (<a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi, UINT <a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, HWND hwndFrom, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a6">CheckForQueuedMessages</a> (<a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a> (BOOL fFreeData, UINT <a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d4/ddemlwp_8c.html#a8">ProcessSyncDDEMessage</a> (<a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi, UINT <a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, LPARAM lParam)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="ddemlwp.c::CheckForQueuedMessages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL CheckForQueuedMessages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pcoi</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00664">664</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00058">CheckDDECritIn</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00508">_CLIENTINFO::CI_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00548">CI_PROCESSING_QUEUE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00536">_CLIENTINFO::cInDDEMLCallback</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00227">tagCONV_INFO::cLocks</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00018">DDEMLFree</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00223">tagCONV_INFO::dmqIn</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00224">tagCONV_INFO::dmqOut</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00192">GetClientInfo</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00162">tagDDE_MESSAGE_QUEUE::lParam</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00161">tagDDE_MESSAGE_QUEUE::msg</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00159">tagDDE_MESSAGE_QUEUE::next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00782">ProcessSyncDDEMessage()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00219">tagCONV_INFO::state</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/w32_2ntuser_2client_2callback_8c-source.html#l00335">DdeEnableCallback()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00572">ProcessAsyncDDEMsg()</a>, and <a class="el" href="../../d9/d3/w32_2ntuser_2client_2callback_8c-source.html#l00441">SetEnableState()</a>.
<p>
<pre class="fragment"><div>00666 {
00667     <a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html">PDDE_MESSAGE_QUEUE</a> pdmq;
00668     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00669     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00670 
00671     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00672 
00673     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_PROCESSING) {      <span class="comment">// recursion prevention</span>
00674         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00675     }
00676 
00677     UserAssert(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>);
00678 
00679     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00680 
00681     pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> |= ST_PROCESSING;
00682     <span class="keywordflow">while</span> (!(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_BLOCKED) &amp;&amp;
00683                 pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00684                 !pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o11">cInDDEMLCallback</a>) {
00685         pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a113">CI_PROCESSING_QUEUE</a>;
00686         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4/ddemlwp_8c.html#a8">ProcessSyncDDEMessage</a>(pcoi, pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a>-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o2">msg</a>, pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a>-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o3">lParam</a>)) {
00687             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00688             pdmq = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a>;
00689             pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a>-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o0">next</a>;
00690             <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00691                 pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00692             }
00693             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pdmq);
00694         }
00695         pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a113">CI_PROCESSING_QUEUE</a>;
00696     }
00697     pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp;= ~ST_PROCESSING;
00698     <span class="keywordflow">return</span>(fRet);
00699 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ddemlwp.c::DDEMLClientWndProc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT DDEMLClientWndProc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00376">376</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01738">tagCLS::atomClassName</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01297">tagSERVERINFO::atomSysClass</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00231">tagCL_CONV_INFO::ci</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00679">CLST_CONNECTED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00680">CLST_SINGLE_INITIALIZING</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00075">CreateHandle()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00016">DDEMLAlloc</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00018">DDEMLFree</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00629">DefWindowProc()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00048">EnterDDECrit</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00388">GetWindowLongPtr()</a>, <a class="el" href="../../d5/d1/hsz_8c-source.html#l00464">GlobalToLocalAtom()</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00675">GWL_CONVSTATE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00677">GWLP_CHINST</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00673">GWLP_PCI</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00105">HTYPE_CLIENT_CONVERSATION</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00218">tagCONV_INFO::hwndConv</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00360">ICLS_DDEMLSERVERA</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00361">ICLS_DDEMLSERVERW</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00095">InstFromHandle</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00049">LeaveDDECrit</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00211">tagCONV_INFO::next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00212">tagCONV_INFO::pcii</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00427">PostMessage()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00572">ProcessAsyncDDEMsg()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00543">ProcessTerminateMsg()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00210">REBASEALWAYS</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l00876">SetCommonStateFlags()</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00408">SetWindowLongPtr()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00120">ValidateHwnd</a>, <a class="el" href="../../d1/d3/instance_8c-source.html#l00111">ValidateInstance()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02286">WFANSIPROC</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/clinit_8c-source.html#l00511">RW_RegisterDDEML()</a>.
<p>
<pre class="fragment"><div>00381 {
00382     <a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a> pci, pciNew;
00383     LONG lState;
00384     LRESULT lRet = 0;
00385     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00386     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00387 
00388     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00389 
00390     pci = (<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, GWLP_PCI);
00391     UserAssert(pci == NULL || pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a> == hwnd);
00392 
00393     <span class="keywordflow">switch</span> (message) {
00394     <span class="keywordflow">case</span> WM_DDE_ACK:
00395         lState = GetWindowLong(hwnd, GWL_CONVSTATE);
00396         <span class="keywordflow">if</span> (lState != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a157">CLST_CONNECTED</a>) {
00397 
00398             <span class="comment">// Initiation mode</span>
00399 
00400             pciNew = (<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">CL_CONV_INFO</a>));
00401             <span class="keywordflow">if</span> (pciNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00402                     (pci != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; lState == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a158">CLST_SINGLE_INITIALIZING</a>)) {
00403                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>((HWND)wParam, WM_DDE_TERMINATE, (WPARAM)hwnd, 0);
00404                 <span class="keywordflow">goto</span> Exit;
00405             }
00406 
00407             <span class="comment">// PCL_CONV_INFO initialization</span>
00408 
00409             pciNew-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a> = <a class="code" href="../../d0/d4/instance_8c.html#a7">ValidateInstance</a>((HANDLE)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, GWLP_CHINST));
00410 
00411             <span class="keywordflow">if</span> (pciNew-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00412                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pciNew);
00413                 <span class="keywordflow">goto</span> Exit;
00414             }
00415 
00416             pciNew-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a> = (<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)pci; <span class="comment">// pci may be NULL</span>
00417             <span class="comment">//</span>
00418             <span class="comment">// Seting GWLP_PCI gives feedback to ConnectConv() which issued</span>
00419             <span class="comment">// the WM_DDE_INITIATE message.</span>
00420             <span class="comment">//</span>
00421             <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwnd, GWLP_PCI, (LONG_PTR)pciNew);
00422             <span class="comment">// pciNew-&gt;hUser = 0; // Zero init.</span>
00423 
00424             <span class="comment">// BUG: If this fails we can have some nasty problems</span>
00425             pciNew-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a> = (HCONV)<a class="code" href="../../d3/d8/handles_8c.html#a6">CreateHandle</a>((ULONG_PTR)pciNew,
00426                     HTYPE_CLIENT_CONVERSATION, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pciNew-&gt;ci.pcii-&gt;hInstClient));
00427 
00428             pciNew-&gt;ci.laService = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(LOWORD(lParam)); <span class="comment">// pci copy</span>
00429             GlobalDeleteAtom(LOWORD(lParam));
00430             pciNew-&gt;ci.laTopic = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(HIWORD(lParam)); <span class="comment">// pci copy</span>
00431             GlobalDeleteAtom(HIWORD(lParam));
00432             pciNew-&gt;ci.hwndPartner = (HWND)wParam;
00433             pciNew-&gt;ci.hwndConv = hwnd;
00434             pciNew-&gt;ci.state = (WORD)(ST_CONNECTED | ST_CLIENT |
00435                     pciNew-&gt;ci.pcii-&gt;ConvStartupState);
00436             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a112">SetCommonStateFlags</a>(hwnd, (HWND)wParam, &amp;pciNew-&gt;ci.state);
00437 
00438             pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>((HWND)wParam);
00439 
00440             <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) <span class="keywordflow">goto</span> Exit;
00441             pcls = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwnd, pcls);
00442 
00443             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFANSIPROC)) {
00444                 <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a88">ICLS_DDEMLSERVERW</a>]) {
00445                     pciNew-&gt;ci.state |= ST_ISLOCAL;
00446                 }
00447             } <span class="keywordflow">else</span> {
00448                 <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a87">ICLS_DDEMLSERVERA</a>]) {
00449                     pciNew-&gt;ci.state |= ST_ISLOCAL;
00450                 }
00451             }
00452 
00453             <span class="comment">// pciNew-&gt;ci.laServiceRequested = 0; // Set by InitiateEnumerationProc()</span>
00454             <span class="comment">// pciNew-&gt;ci.pxiIn = 0;</span>
00455             <span class="comment">// pciNew-&gt;ci.pxiOut = 0;</span>
00456             <span class="comment">// pciNew-&gt;ci.dmqIn = 0;</span>
00457             <span class="comment">// pciNew-&gt;ci.dmqOut = 0;</span>
00458             <span class="comment">// pciNew-&gt;ci.aLinks = NULL;</span>
00459             <span class="comment">// pciNew-&gt;ci.cLinks = 0;</span>
00460             <span class="comment">// pciNew-&gt;ci.cLocks = 0;</span>
00461             <span class="keywordflow">goto</span> Exit;
00462         }
00463         <span class="comment">// fall through to handle posted messages here.</span>
00464 
00465     <span class="keywordflow">case</span> WM_DDE_DATA:
00466         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a5">ProcessAsyncDDEMsg</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)pci, message, (HWND)wParam, lParam);
00467         <span class="keywordflow">goto</span> Exit;
00468 
00469     <span class="keywordflow">case</span> WM_DDE_TERMINATE:
00470     <span class="keywordflow">case</span> WM_DESTROY:
00471         {
00472             <a class="code" href="../../d3/d4/ddemlwp_8c.html#a4">ProcessTerminateMsg</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)pci, (HWND)wParam);
00473             <span class="keywordflow">break</span>;
00474         }
00475     }
00476 
00477     lRet = <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(hwnd, message, wParam, lParam);
00478 
00479 Exit:
00480     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00481     <span class="keywordflow">return</span> (lRet);
00482 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ddemlwp.c::DDEMLMotherWndProc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT DDEMLMotherWndProc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00027">27</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00629">DefWindowProc()</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00388">GetWindowLongPtr()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00673">GWLP_PCI</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00059">ProcessDDEMLInitiate()</a>, and <a class="el" href="../../d0/d6/register_8c-source.html#l00090">ProcessRegistrationMessage()</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/clinit_8c-source.html#l00511">RW_RegisterDDEML()</a>.
<p>
<pre class="fragment"><div>00032 {
00033     <span class="keywordflow">switch</span> (message) {
00034     <span class="keywordflow">case</span> UM_REGISTER:
00035     <span class="keywordflow">case</span> UM_UNREGISTER:
00036         <span class="keywordflow">return</span>(<a class="code" href="../../d9/d6/register_8c.html#a2">ProcessRegistrationMessage</a>(hwnd, message, wParam, lParam));
00037 
00038     <span class="keywordflow">case</span> WM_DDE_INITIATE:
00039         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a0">ProcessDDEMLInitiate</a>((<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, GWLP_PCI),
00040                 (HWND)wParam, (ATOM)LOWORD(lParam), (ATOM)HIWORD(lParam));
00041         <span class="keywordflow">return</span>(0);
00042 
00043     }
00044     <span class="keywordflow">return</span>(<a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(hwnd, message, wParam, lParam));
00045 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ddemlwp.c::DDEMLServerWndProc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT DDEMLServerWndProc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00496">496</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00237">tagSVR_CONV_INFO::ci</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00629">DefWindowProc()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00048">EnterDDECrit</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00388">GetWindowLongPtr()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00685">GWLP_PSI</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00218">tagCONV_INFO::hwndConv</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00049">LeaveDDECrit</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00572">ProcessAsyncDDEMsg()</a>, and <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00543">ProcessTerminateMsg()</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/clinit_8c-source.html#l00511">RW_RegisterDDEML()</a>.
<p>
<pre class="fragment"><div>00501 {
00502     <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi;
00503     LRESULT lRet = 0;
00504 
00505     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00506 
00507     psi = (<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, GWLP_PSI);
00508     UserAssert(psi == NULL || psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a> == hwnd);
00509 
00510     <span class="keywordflow">switch</span> (message) {
00511     <span class="keywordflow">case</span> WM_DDE_REQUEST:
00512     <span class="keywordflow">case</span> WM_DDE_POKE:
00513     <span class="keywordflow">case</span> WM_DDE_ADVISE:
00514     <span class="keywordflow">case</span> WM_DDE_EXECUTE:
00515     <span class="keywordflow">case</span> WM_DDE_ACK:
00516     <span class="keywordflow">case</span> WM_DDE_UNADVISE:
00517         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a5">ProcessAsyncDDEMsg</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)psi, message, (HWND)wParam, lParam);
00518         <span class="keywordflow">goto</span> Exit;
00519 
00520     <span class="keywordflow">case</span> WM_DDE_TERMINATE:
00521     <span class="keywordflow">case</span> WM_DESTROY:
00522         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a4">ProcessTerminateMsg</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)psi, (HWND)wParam);
00523         <span class="keywordflow">break</span>;
00524     }
00525     lRet = <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(hwnd, message, wParam, lParam);
00526 Exit:
00527     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00528     <span class="keywordflow">return</span> (lRet);
00529 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ddemlwp.c::DumpDDEMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DumpDDEMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fFreeData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00714">714</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/hdata_8c-source.html#l00491">FreeDDEData()</a>, <a class="el" href="../../d5/d3/client_2ddetrack_8c-source.html#l00642">FreeDDElParam()</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d3/client_2ddetrack_8c-source.html#l00595">UnpackDDElParam()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d7/d9/usercli_8h-source.html#l00131">WOWGLOBALFREE</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/connect_8c-source.html#l01354">FreeConversationResources()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00572">ProcessAsyncDDEMsg()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00782">ProcessSyncDDEMessage()</a>, <a class="el" href="../../d3/d5/stdptcl_8c-source.html#l01396">SpontaneousClientMessage()</a>, and <a class="el" href="../../d3/d5/stdptcl_8c-source.html#l01424">SpontaneousServerMessage()</a>.
<p>
<pre class="fragment"><div>00718 {
00719     UINT_PTR uiLo, uiHi;
00720 
00721     RIPMSG2(RIP_WARNING, <span class="stringliteral">"Dump DDE msg %x lParam %x"</span>, msg, lParam);
00722 
00723     <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00724     <span class="keywordflow">case</span> WM_DDE_ACK:
00725     <span class="keywordflow">case</span> WM_DDE_DATA:
00726     <span class="keywordflow">case</span> WM_DDE_POKE:
00727     <span class="keywordflow">case</span> WM_DDE_ADVISE:
00728         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(msg, lParam, &amp;uiLo, &amp;uiHi);
00729         <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00730         <span class="keywordflow">case</span> WM_DDE_DATA:
00731         <span class="keywordflow">case</span> WM_DDE_POKE:
00732             <span class="keywordflow">if</span> (uiLo) {
00733                 <span class="keywordflow">if</span> (fFreeData) {
00734                     <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>((HANDLE)uiLo, FALSE, TRUE);
00735                 }
00736                 GlobalDeleteAtom((ATOM)uiHi);
00737             }
00738             <span class="keywordflow">break</span>;
00739 
00740         <span class="keywordflow">case</span> WM_DDE_ADVISE:
00741             <span class="keywordflow">if</span> (uiLo) {
00742                 <span class="keywordflow">if</span> (fFreeData) {
00743                     <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>((HANDLE)uiLo, FALSE, TRUE);
00744                 }
00745                 GlobalDeleteAtom((ATOM)uiHi);
00746             }
00747             <span class="keywordflow">break</span>;
00748 
00749         <span class="keywordflow">case</span> WM_DDE_ACK:
00750             <span class="comment">// could be EXEC Ack - cant know what to do exactly.</span>
00751             <span class="keywordflow">break</span>;
00752         }
00753         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(msg, lParam);
00754         <span class="keywordflow">break</span>;
00755 
00756     <span class="keywordflow">case</span> WM_DDE_EXECUTE:
00757         <span class="keywordflow">if</span> (fFreeData) {
00758             <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>((HANDLE)lParam);
00759         }
00760         <span class="keywordflow">break</span>;
00761 
00762     <span class="keywordflow">case</span> WM_DDE_REQUEST:
00763     <span class="keywordflow">case</span> WM_DDE_UNADVISE:
00764         GlobalDeleteAtom((ATOM)HIWORD(lParam));
00765         <span class="keywordflow">break</span>;
00766     }
00767 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ddemlwp.c::ProcessAsyncDDEMsg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ProcessAsyncDDEMsg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pcoi</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hwndFrom</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00572">572</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00664">CheckForQueuedMessages()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00227">tagCONV_INFO::cLocks</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00016">DDEMLAlloc</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00223">tagCONV_INFO::dmqIn</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00224">tagCONV_INFO::dmqOut</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00714">DumpDDEMessage()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l01354">FreeConversationResources()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00218">tagCONV_INFO::hwndConv</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00217">tagCONV_INFO::hwndPartner</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00162">tagDDE_MESSAGE_QUEUE::lParam</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00161">tagDDE_MESSAGE_QUEUE::msg</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00159">tagDDE_MESSAGE_QUEUE::next</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00211">tagCONV_INFO::next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00160">tagDDE_MESSAGE_QUEUE::pcoi</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00427">PostMessage()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00782">ProcessSyncDDEMessage()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00219">tagCONV_INFO::state</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00376">DDEMLClientWndProc()</a>, and <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00496">DDEMLServerWndProc()</a>.
<p>
<pre class="fragment"><div>00577 {
00578     <a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html">PDDE_MESSAGE_QUEUE</a> pdmq;
00579 <span class="preprocessor">#if DBG</span>
00580 <span class="preprocessor"></span>    HWND hwndT = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>;
00581 <span class="preprocessor">#endif // DBG</span>
00582 <span class="preprocessor"></span>
00583     <span class="keywordflow">while</span> (pcoi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a> != hwndFrom) {
00584         pcoi = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a>;
00585     }
00586     <span class="keywordflow">if</span> (pcoi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00587         RIPMSG3(RIP_WARNING,
00588                 <span class="stringliteral">"Bogus DDE message %x received from %x by %x. Dumping."</span>,
00589                 msg, hwndFrom, hwndT);
00590         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(FALSE, msg, lParam);
00591         <span class="keywordflow">return</span> ;
00592     }
00593     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_CONNECTED) {
00594 
00595         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00596                 !(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_BLOCKED)
00597 <span class="comment">//                &amp;&amp; !PctiCurrent()-&gt;cInDDEMLCallback</span>
00598                 ) {
00599 
00600             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4/ddemlwp_8c.html#a8">ProcessSyncDDEMessage</a>(pcoi, msg, lParam)) {
00601                 <span class="keywordflow">return</span>; <span class="comment">// not blocked, ok to return.</span>
00602             }
00603         }
00604 
00605         <span class="comment">// enter into queue</span>
00606 
00607         pdmq = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html">DDE_MESSAGE_QUEUE</a>));
00608         <span class="keywordflow">if</span> (pdmq == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00609 
00610             <span class="comment">// insufficient memory - we can't process this msg - we MUST</span>
00611             <span class="comment">// terminate.</span>
00612 
00613             <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_CONNECTED) {
00614                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, WM_DDE_TERMINATE,
00615                         (WPARAM)pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0);
00616                 pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp;= ~ST_CONNECTED;
00617             }
00618             <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(!(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_INTRA_PROCESS), msg, lParam);
00619             <span class="keywordflow">return</span> ;
00620         }
00621         pdmq-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o1">pcoi</a> = pcoi;
00622         pdmq-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o2">msg</a> = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00623         pdmq-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o3">lParam</a> = lParam;
00624         pdmq-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o0">next</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00625 
00626         <span class="comment">// dmqOut-&gt;next-&gt;next-&gt;next-&gt;dmqIn-&gt;NULL</span>
00627 
00628         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00629             pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a>-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o0">next</a> = pdmq;
00630         }
00631         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a> = pdmq;
00632         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00633             pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a>;
00634         }
00635         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>++;
00636         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a6">CheckForQueuedMessages</a>(pcoi);
00637         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>--;
00638         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a> == 0 &amp;&amp; pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_FREE_CONV_RES_NOW) {
00639             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a114">FreeConversationResources</a>(pcoi);
00640         }
00641     } <span class="keywordflow">else</span> {
00642         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(!(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_INTRA_PROCESS), msg, lParam);
00643     }
00644 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ddemlwp.c::ProcessDDEMLInitiate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ProcessDDEMLInitiate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pcii</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hwndClient</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>aServer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>aTopic</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00059">59</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00191">tagCL_INSTANCE_INFO::afCmd</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00197">tagCL_INSTANCE_INFO::aServerLookup</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01738">tagCLS::atomClassName</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01297">tagSERVERINFO::atomSysClass</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00059">CheckDDECritOut</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00237">tagSVR_CONV_INFO::ci</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00680">CLST_SINGLE_INITIALIZING</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00199">tagCL_INSTANCE_INFO::ConvStartupState</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00075">CreateHandle()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00198">tagCL_INSTANCE_INFO::cServerLookupAlloc</a>, <a class="el" href="../../d1/d8/hdata_8c-source.html#l00304">DdeAccessData()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00016">DDEMLAlloc</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00018">DDEMLFree</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00017">DDEMLReAlloc</a>, <a class="el" href="../../d1/d8/hdata_8c-source.html#l00346">DdeUnaccessData()</a>, <a class="el" href="../../d9/d3/w32_2ntuser_2client_2callback_8c-source.html#l00024">DoCallback()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00048">EnterDDECrit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00200">tagCL_INSTANCE_INFO::flags</a>, <a class="el" href="../../d1/d0/xact_8c-source.html#l00368">GetConvContext()</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00388">GetWindowLongPtr()</a>, <a class="el" href="../../d5/d1/hsz_8c-source.html#l00464">GlobalToLocalAtom()</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00675">GWL_CONVSTATE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00685">GWLP_PSI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00676">GWLP_SHINST</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00186">tagCL_INSTANCE_INFO::hInstClient</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00185">tagCL_INSTANCE_INFO::hInstServer</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00104">HTYPE_SERVER_CONVERSATION</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00188">tagCL_INSTANCE_INFO::hwndMother</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00217">tagCONV_INFO::hwndPartner</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00170">tagSERVER_LOOKUP::hwndServer</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00358">ICLS_DDEMLCLIENTA</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00359">ICLS_DDEMLCLIENTW</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00360">ICLS_DDEMLSERVERA</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00361">ICLS_DDEMLSERVERW</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00206">IIF_UNICODE</a>, <a class="el" href="../../d5/d1/hsz_8c-source.html#l00516">IncLocalAtomCount()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00095">InstFromHandle</a>, <a class="el" href="../../d1/d8/hdata_8c-source.html#l00416">InternalFreeDataHandle()</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00277">IsWindow()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00168">tagSERVER_LOOKUP::laService</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00024">LATOM</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00069">LATOM_FROM_HSZ</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00169">tagSERVER_LOOKUP::laTopic</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00049">LeaveDDECrit</a>, <a class="el" href="../../d5/d1/hsz_8c-source.html#l00438">LocalToGlobalAtom()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">LPVOID</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00036">MONCONV</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00211">tagCONV_INFO::next</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00070">NORMAL_HSZ_FROM_LATOM</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04415">NtUserDdeGetQualityOfService()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04115">NtUserDestroyWindow()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00195">tagCL_INSTANCE_INFO::plaNameService</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00210">REBASEALWAYS</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00652">SendMessage()</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l00876">SetCommonStateFlags()</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00408">SetWindowLongPtr()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00120">ValidateHwnd</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02286">WFANSIPROC</a>.
<p>
Referenced by <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00027">DDEMLMotherWndProc()</a>.
<p>
<pre class="fragment"><div>00064 {
00065     CONVCONTEXT cc = {
00066         <span class="keyword">sizeof</span>(CONVCONTEXT),
00067         0,
00068         0,
00069         CP_WINANSI,
00070         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00071         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00072         {
00073             <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE),
00074             SecurityImpersonation,
00075             SECURITY_STATIC_TRACKING,
00076             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00077         }
00078     };
00079     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> flags = ST_INLIST;
00080     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWild;
00081     HDDEDATA hData;
00082     HWND hwndServer;
00083     <a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">PSERVER_LOOKUP</a> psl;
00084     PHSZPAIR php;
00085     HSZPAIR hp[2];
00086     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> laService, laFree1 = 0;
00087     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> laTopic, laFree2 = 0;
00088     <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi;
00089     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> *plaNameService;
00090     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndClient;
00091     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00092 
00093     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00094         <span class="keywordflow">return</span>;     <span class="comment">// we aren't done being initiated yet.</span>
00095     }
00096 
00097     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00098 
00099     <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_CONNECTIONS || !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndClient)) {
00100         <span class="keywordflow">goto</span> Exit;
00101     }
00102 
00103     pwndClient = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndClient);
00104     <span class="keywordflow">if</span> (pwndClient == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) <span class="keywordflow">goto</span> Exit;
00105 
00106     pcls = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwndClient, pcls);
00107     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndClient, WFANSIPROC)) {
00108         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a86">ICLS_DDEMLCLIENTW</a>]) {
00109             flags |= ST_ISLOCAL;
00110         }
00111     } <span class="keywordflow">else</span> {
00112         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a85">ICLS_DDEMLCLIENTA</a>]) {
00113             flags |= ST_ISLOCAL;
00114         }
00115     }
00116 
00117     <span class="keywordflow">if</span> (flags &amp; ST_ISLOCAL) {
00118         <span class="comment">/*</span>
00119 <span class="comment">         * Make sure other guy allows self-connections if that's what this is.</span>
00120 <span class="comment">         */</span>
00121         <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o1">hInstServer</a> == (HANDLE)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndClient, GWLP_SHINST)) {
00122             <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_SELFCONNECTIONS) {
00123                 <span class="keywordflow">goto</span> Exit;
00124             }
00125             flags |= ST_ISSELF;
00126         }
00127 
00128         <a class="code" href="../../d0/d1/xact_8c.html#a1">GetConvContext</a>(hwndClient, (LONG *)&amp;cc);
00129         <span class="keywordflow">if</span> (GetWindowLong(hwndClient, GWL_CONVSTATE) &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a158">CLST_SINGLE_INITIALIZING</a>) {
00130             flags &amp;= ~ST_INLIST;
00131         }
00132     } <span class="keywordflow">else</span> {
00133         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a169">NtUserDdeGetQualityOfService</a>(hwndClient, NULL, &amp;cc.qos);
00134     }
00135 
00136 <span class="comment">/***************************************************************************\</span>
00137 <span class="comment">*</span>
00138 <span class="comment">* Server window creation is minimized by only creating one window per</span>
00139 <span class="comment">* Instance/Service/Topic set. This should be all that is needed and</span>
00140 <span class="comment">* duplicate connections (ie where the server/client window pair is identical</span>
00141 <span class="comment">* to another conversation) should not happen. However, if some dumb</span>
00142 <span class="comment">* server app attempts to create a duplicate conversation by having</span>
00143 <span class="comment">* duplicate service/topic pairs passed back from a XTYP_WILD_CONNECT</span>
00144 <span class="comment">* callback we will not honor the request.</span>
00145 <span class="comment">*</span>
00146 <span class="comment">* The INSTANCE_INFO structure holds a pointer to an array of SERVERLOOKUP</span>
00147 <span class="comment">* structures each entry of which references the hwndServer that supports</span>
00148 <span class="comment">* all conversations on that service/topic pair. The hwndServer windows</span>
00149 <span class="comment">* in turn have window words that reference the first member in a linked</span>
00150 <span class="comment">* list of SVR_CONV_INFO structures, one for each conversation on that</span>
00151 <span class="comment">* service/topic pair.</span>
00152 <span class="comment">*</span>
00153 <span class="comment">\***************************************************************************/</span>
00154 
00155     laFree1 = laService = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(aServer);
00156     laFree2 = laTopic = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(aTopic);
00157 
00158     plaNameService = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a>;
00159     <span class="keywordflow">if</span> (!laService &amp;&amp; pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_FILTERINITS &amp;&amp; *plaNameService == 0) {
00160         <span class="comment">/*</span>
00161 <span class="comment">         * no WILDCONNECTS to servers with no registered names while filtering.</span>
00162 <span class="comment">         */</span>
00163         <span class="keywordflow">goto</span> Exit;
00164     }
00165     <span class="keywordflow">if</span> ((pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_FILTERINITS) &amp;&amp; laService) {
00166         <span class="comment">/*</span>
00167 <span class="comment">         * if we can't find the aServer in this instance's service name</span>
00168 <span class="comment">         * list, don't bother the server.</span>
00169 <span class="comment">         */</span>
00170         <span class="keywordflow">while</span> (*plaNameService != 0 &amp;&amp; *plaNameService != laService) {
00171             plaNameService++;
00172         }
00173         <span class="keywordflow">if</span> (*plaNameService == 0) {
00174             <span class="keywordflow">goto</span> Exit;
00175         }
00176     }
00177     hp[0].hszSvc = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(laService);
00178     hp[0].hszTopic = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(laTopic);
00179     hp[1].hszSvc = 0;
00180     hp[1].hszTopic = 0;
00181     fWild = !laService || !laTopic;
00182 
00183     hData = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(pcii,
00184         (WORD)(fWild ? XTYP_WILDCONNECT : XTYP_CONNECT),
00185         0,
00186         (HCONV)0,
00187         hp[0].hszTopic,
00188         hp[0].hszSvc,
00189         (HDDEDATA)0,
00190         flags &amp; ST_ISLOCAL ? (ULONG_PTR)&amp;cc : 0,
00191         (DWORD)(flags &amp; ST_ISSELF) ? 1 : 0);
00192 
00193     <span class="keywordflow">if</span> (!hData) {
00194         <span class="keywordflow">goto</span> Exit;
00195     }
00196 
00197     <span class="keywordflow">if</span> (fWild) {
00198         php = (PHSZPAIR)<a class="code" href="../../d0/d9/hdata_8c.html#a5">DdeAccessData</a>(hData, NULL);
00199         <span class="keywordflow">if</span> (php == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200             <span class="keywordflow">goto</span> Exit;
00201         }
00202     } <span class="keywordflow">else</span> {
00203         php = hp;
00204     }
00205 
00206     <span class="keywordflow">while</span> (php-&gt;hszSvc &amp;&amp; php-&gt;hszTopic) {
00207 
00208         psi = (<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">SVR_CONV_INFO</a>));
00209         <span class="keywordflow">if</span> (psi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00210             <span class="keywordflow">break</span>;
00211         }
00212 
00213         laService = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a13">LATOM_FROM_HSZ</a>(php-&gt;hszSvc);
00214         laTopic = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a13">LATOM_FROM_HSZ</a>(php-&gt;hszTopic);
00215 
00216         hwndServer = 0;
00217         <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>) {
00218             <span class="keywordtype">int</span> i;
00219             <span class="comment">/*</span>
00220 <span class="comment">             * See if there already exists a server window for this</span>
00221 <span class="comment">             * aServer/aTopic pair</span>
00222 <span class="comment">             */</span>
00223             <span class="keywordflow">for</span> (i = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>; i; i--) {
00224                 <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a>[i - 1].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o0">laService</a> == laService &amp;&amp;
00225                         pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a>[i - 1].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o1">laTopic</a> == laTopic) {
00226                     <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psiT;
00227                     <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi;
00228 
00229                     hwndServer = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a>[i - 1].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o2">hwndServer</a>;
00230                     <span class="comment">/*</span>
00231 <span class="comment">                     * Now make sure this window isn't some bogus idiot</span>
00232 <span class="comment">                     * trying to create a second conversation from the</span>
00233 <span class="comment">                     * same client window that is already talking to</span>
00234 <span class="comment">                     * our existing server window.</span>
00235 <span class="comment">                     */</span>
00236                     psiT = (<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndServer, GWLP_PSI);
00237                     <span class="keywordflow">for</span> (pcoi = &amp;psiT-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>; pcoi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pcoi = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a>) {
00238                         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a> == hwndClient) {
00239                             hwndServer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00240                             <span class="keywordflow">break</span>;
00241                         }
00242                     }
00243                     <span class="keywordflow">break</span>;
00244                 }
00245             }
00246         }
00247 
00248         <span class="keywordflow">if</span> (hwndServer == 0) {
00249 
00250             <span class="comment">// no server window exists - make one.</span>
00251 
00252             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00253             <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o16">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a50">IIF_UNICODE</a>) {
00254                 hwndServer = CreateWindowW((LPWSTR)(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[ICLS_DDEMLSERVERW]),
00255                                           L<span class="stringliteral">""</span>,
00256                                           WS_CHILD,
00257                                           0, 0, 0, 0,
00258                                           pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>,
00259                                           (HMENU)0,
00260                                           0,
00261                                           (LPVOID)NULL);
00262             } <span class="keywordflow">else</span> {
00263                 hwndServer = CreateWindowA((LPSTR)(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[ICLS_DDEMLSERVERA]),
00264                                           <span class="stringliteral">""</span>,
00265                                           WS_CHILD,
00266                                           0, 0, 0, 0,
00267                                           pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>,
00268                                           (HMENU)0,
00269                                           0,
00270                                           (LPVOID)NULL);
00271             }
00272             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00273 
00274             <span class="keywordflow">if</span> (hwndServer == 0) {
00275                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(psi);
00276                 <span class="keywordflow">break</span>;
00277             }
00278             <span class="comment">// SetWindowLongPtr(hwndServer, GWLP_PSI, (LONG)NULL); // Zero init.</span>
00279 
00280             <span class="comment">// put the window into the lookup list</span>
00281 
00282             <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00283                 psl = (<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">PSERVER_LOOKUP</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">SERVER_LOOKUP</a>));
00284             } <span class="keywordflow">else</span> {
00285                 psl = (<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">PSERVER_LOOKUP</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a1">DDEMLReAlloc</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a>,
00286                         <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">SERVER_LOOKUP</a>) * (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a> + 1));
00287             }
00288             <span class="keywordflow">if</span> (psl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00289                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"ProcessDDEMLInitiate:hwndServer (%x) destroyed due to low memory."</span>, hwndServer);
00290                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(hwndServer);
00291                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(psi);
00292                 <span class="keywordflow">break</span>;
00293             }
00294 
00295             <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(laService); <span class="comment">// for SERVER_LOOKUP</span>
00296             psl[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o0">laService</a> = laService;
00297             <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(laTopic); <span class="comment">// for SERVER_LOOKUP</span>
00298             psl[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o1">laTopic</a> = laTopic;
00299             psl[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o2">hwndServer</a> = hwndServer;
00300             pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a> = psl;
00301             pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>++;
00302             <span class="comment">// DumpServerLookupTable("After addition:", hwndServer, psl, pcii-&gt;cServerLookupAlloc);</span>
00303         }
00304 
00305         psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a> = (<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndServer, GWLP_PSI);
00306         <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwndServer, GWLP_PSI, (LONG_PTR)psi);
00307         psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a> = pcii;
00308         <span class="comment">// psi-&gt;ci.hUser = 0;</span>
00309         psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a> = (HCONV)<a class="code" href="../../d3/d8/handles_8c.html#a6">CreateHandle</a>((ULONG_PTR)psi,
00310                 HTYPE_SERVER_CONVERSATION, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>));
00311         psi-&gt;ci.laService = laService;
00312         <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(laService); <span class="comment">// for server window</span>
00313         psi-&gt;ci.laTopic = laTopic;
00314         <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(laTopic); <span class="comment">// for server window</span>
00315         psi-&gt;ci.hwndPartner = hwndClient;
00316         psi-&gt;ci.hwndConv = hwndServer;
00317         psi-&gt;ci.state = (WORD)(flags | ST_CONNECTED | pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o15">ConvStartupState</a>);
00318         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a112">SetCommonStateFlags</a>(hwndClient, hwndServer, &amp;psi-&gt;ci.state);
00319         psi-&gt;ci.laServiceRequested = laFree1;
00320         <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(psi-&gt;ci.laServiceRequested); <span class="comment">// for server window</span>
00321         <span class="comment">// psi-&gt;ci.pxiIn = NULL;</span>
00322         <span class="comment">// psi-&gt;ci.pxiOut = NULL;</span>
00323         <span class="comment">// psi-&gt;ci.dmqIn = NULL;</span>
00324         <span class="comment">// psi-&gt;ci.dmqOut = NULL;</span>
00325         <span class="comment">// psi-&gt;ci.aLinks = NULL;</span>
00326         <span class="comment">// psi-&gt;ci.cLinks = 0;</span>
00327         <span class="comment">// psi-&gt;ci.cLocks = 0;</span>
00328 
00329         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00330         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a9">CheckDDECritOut</a>;
00331         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndClient, WM_DDE_ACK, (WPARAM)hwndServer,
00332                 MAKELONG(<a class="code" href="../../d4/d2/hsz_8c.html#a12">LocalToGlobalAtom</a>(laService), <a class="code" href="../../d4/d2/hsz_8c.html#a12">LocalToGlobalAtom</a>(laTopic)));
00333         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00334 
00335         <span class="keywordflow">if</span> (!(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_SKIP_CONNECT_CONFIRMS)) {
00336             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(pcii,
00337                     (WORD)XTYP_CONNECT_CONFIRM,
00338                     0,
00339                     psi-&gt;ci.hConv,
00340                     (HSZ)laTopic,
00341                     (HSZ)laService,
00342                     (HDDEDATA)0,
00343                     0,
00344                     (flags &amp; ST_ISSELF) ? 1L : 0L);
00345         }
00346 
00347         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a5">MONCONV</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)psi, TRUE);
00348 
00349         <span class="keywordflow">if</span> (!(flags &amp; ST_INLIST)) {
00350             <span class="keywordflow">break</span>;      <span class="comment">// our partner's only gonna take the first one anyway.</span>
00351         }
00352         php++;
00353     }
00354 
00355     <span class="keywordflow">if</span> (fWild) {
00356         <a class="code" href="../../d0/d9/hdata_8c.html#a6">DdeUnaccessData</a>(hData);
00357         <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>(hData, FALSE);
00358     }
00359 
00360 Exit:
00361     DeleteAtom(laFree1);
00362     DeleteAtom(laFree2);
00363     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00364     <span class="keywordflow">return</span>;
00365 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ddemlwp.c::ProcessSyncDDEMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL ProcessSyncDDEMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pcoi</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00782">782</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00191">tagCL_INSTANCE_INFO::afCmd</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00058">CheckDDECritIn</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00201">tagCL_INSTANCE_INFO::cInDDEMLCallback</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00227">tagCONV_INFO::cLocks</a>, <a class="el" href="../../d0/d3/ddemlcli_8c-source.html#l00196">DdeUninitialize()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00714">DumpDDEMessage()</a>, <a class="el" href="../../d9/d3/w32_2ntuser_2client_2callback_8c-source.html#l00295">EnableEnumProc()</a>, <a class="el" href="../../d1/d7/clenum_8c-source.html#l00188">EnumChildWindows()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00200">tagCL_INSTANCE_INFO::flags</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l01354">FreeConversationResources()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00112">HINST_ANY</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00186">tagCL_INSTANCE_INFO::hInstClient</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00107">HTYPE_TRANSACTION</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00188">tagCL_INSTANCE_INFO::hwndMother</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00124">tagXACT_INFO::hXact</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00205">IIF_IN_SYNC_XACT</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00212">tagCONV_INFO::pcii</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00125">tagXACT_INFO::pfnResponse</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00248">tagENABLE_ENUM_STRUCT::pfRet</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00222">tagCONV_INFO::pxiOut</a>, <a class="el" href="../../d3/d5/stdptcl_8c-source.html#l01396">SpontaneousClientMessage()</a>, <a class="el" href="../../d3/d5/stdptcl_8c-source.html#l01424">SpontaneousServerMessage()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00219">tagCONV_INFO::state</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00204">ValidateCHandle()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00249">tagENABLE_ENUM_STRUCT::wCmd</a>, and <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00250">tagENABLE_ENUM_STRUCT::wCmd2</a>.
<p>
Referenced by <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00664">CheckForQueuedMessages()</a>, and <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00572">ProcessAsyncDDEMsg()</a>.
<p>
<pre class="fragment"><div>00786 {
00787     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNotBlocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00788     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00789     <a class="code" href="../../d5/d4/structtagENABLE__ENUM__STRUCT.html">ENABLE_ENUM_STRUCT</a> ees;
00790     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00791 
00792     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00793 
00794     <span class="comment">/*</span>
00795 <span class="comment">     * lock the conversation so its resources don't go away till we are</span>
00796 <span class="comment">     * done with them.  This function could generate a callback which could</span>
00797 <span class="comment">     * disconnect the conversation.</span>
00798 <span class="comment">     */</span>
00799     pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>++;
00800 
00801     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_BLOCKNEXT) {
00802         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> ^= ST_BLOCKNEXT | ST_BLOCKED;
00803     }
00804     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_BLOCKALLNEXT) {
00805         ees.<a class="code" href="../../d5/d4/structtagENABLE__ENUM__STRUCT.html#o0">pfRet</a> = &amp;fRet;
00806         ees.<a class="code" href="../../d5/d4/structtagENABLE__ENUM__STRUCT.html#o1">wCmd</a> = EC_DISABLE;
00807         ees.<a class="code" href="../../d5/d4/structtagENABLE__ENUM__STRUCT.html#o2">wCmd2</a> = 0;
00808         <a class="code" href="../../d0/d8/clenum_8c.html#a8">EnumChildWindows</a>(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>, (WNDENUMPROC)EnableEnumProc,
00809                 (LPARAM)&amp;ees);
00810     }
00811 
00812     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_CONNECTED) {
00813         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00814             <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_CLIENT) {
00815                 fNotBlocked = <a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pcoi, msg, lParam);
00816             } <span class="keywordflow">else</span> {
00817                 fNotBlocked = <a class="code" href="../../d2/d6/stdptcl_8c.html#a21">SpontaneousServerMessage</a>((<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)pcoi, msg, lParam);
00818             }
00819         } <span class="keywordflow">else</span> {
00820             UserAssert(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a> == (HANDLE)0 ||
00821                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a89">ValidateCHandle</a>(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>, HTYPE_TRANSACTION,
00822                     HINST_ANY)
00823                     == (ULONG_PTR)pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>);
00824             fNotBlocked = (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o4">pfnResponse</a>)(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00825         }
00826     } <span class="keywordflow">else</span> {
00827         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(!(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_INTRA_PROCESS), msg, lParam);
00828     }
00829     <span class="keywordflow">if</span> (!fNotBlocked) {
00830         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> |= ST_BLOCKED;
00831         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp;= ~ST_BLOCKNEXT;
00832     }
00833 
00834     pcii = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>;  <span class="comment">// save this incase unlocking makes pcoi go away.</span>
00835 
00836     pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>--;
00837     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a> == 0 &amp;&amp; pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_FREE_CONV_RES_NOW) {
00838         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a114">FreeConversationResources</a>(pcoi);
00839     }
00840 
00841     <span class="comment">/*</span>
00842 <span class="comment">     * Because callbacks are capable of blocking DdeUninitialize(), we check</span>
00843 <span class="comment">     * before exit to see if it needs to be called.</span>
00844 <span class="comment">     */</span>
00845     <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_UNINIT_ASAP &amp;&amp;
00846             !(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o16">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a49">IIF_IN_SYNC_XACT</a>) &amp;&amp;
00847             !pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o17">cInDDEMLCallback</a>) {
00848         <a class="code" href="../../d9/d3/ddemlcli_8c.html#a5">DdeUninitialize</a>(HandleToUlong(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>));
00849         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00850     }
00851     <span class="keywordflow">return</span> (fNotBlocked);
00852 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ddemlwp.c::ProcessTerminateMsg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> ProcessTerminateMsg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pcoi</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hwndFrom</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00543">543</a> of file <a class="el" href="../../d4/d3/ddemlwp_8c-source.html">ddemlwp.c</a>.
<p>
References <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00217">tagCONV_INFO::hwndPartner</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00211">tagCONV_INFO::next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d4/connect_8c-source.html#l01109">ShutdownConversation()</a>, <a class="el" href="../../d1/d3/ddemlcli_8h-source.html#l00219">tagCONV_INFO::state</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00376">DDEMLClientWndProc()</a>, <a class="el" href="../../d4/d3/ddemlwp_8c-source.html#l00496">DDEMLServerWndProc()</a>, and <a class="el" href="../../d7/d4/connect_8c-source.html#l01474">WaitForZombieTerminate()</a>.
<p>
<pre class="fragment"><div>00546 {
00547     <span class="keywordflow">while</span> (pcoi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a> != hwndFrom) {
00548         pcoi = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a>;
00549     }
00550     <span class="keywordflow">if</span> (pcoi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00551         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> |= ST_TERMINATE_RECEIVED;
00552         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a113">ShutdownConversation</a>(pcoi, TRUE);
00553     }
00554     <span class="keywordflow">return</span> (pcoi);
00555 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
