<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mapper.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mapper.c</h1><a href="../../d2/d5/mapper_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright (c) 1994 Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    registry.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains the code that manipulates the ARC firmware</span>
00013 <span class="comment">    tree and other elements in the registry.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Bob Rinne (BobRi) 15-Oct-1994</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History :</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00028 <span class="preprocessor">#pragma hdrstop</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#if UMODETEST</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#undef IsNEC_98</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#define IsNEC_98 0</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'rpaM')</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
00040 
00041 <span class="comment">//</span>
00042 <span class="comment">// This contains information obtained by checking the firmware</span>
00043 <span class="comment">// tree of the registry</span>
00044 <span class="comment">//</span>
00045 
<a name="l00046"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">00046</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">_FIRMWARE_CONFIGURATION</a> {
<a name="l00047"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o0">00047</a>     <span class="keyword">struct </span><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">_FIRMWARE_CONFIGURATION</a> *<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o0">Next</a>;
<a name="l00048"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o1">00048</a>     INTERFACE_TYPE     <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o1">BusType</a>;
<a name="l00049"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o2">00049</a>     ULONG              <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
<a name="l00050"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">00050</a>     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a> <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">ControllerType</a>;
<a name="l00051"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o4">00051</a>     ULONG              <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o4">ControllerNumber</a>;
<a name="l00052"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o5">00052</a>     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a> <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o5">PeripheralType</a>;
<a name="l00053"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o6">00053</a>     ULONG              <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o6">PeripheralNumber</a>;
<a name="l00054"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o7">00054</a>     ULONG              <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o7">NumberBases</a>;
<a name="l00055"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o8">00055</a>     ULONG              <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o8">ResourceDescriptorSize</a>;
<a name="l00056"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">00056</a>     PVOID              <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">ResourceDescriptor</a>;
<a name="l00057"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o10">00057</a>     ULONG              <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o10">IdentifierLength</a>;
<a name="l00058"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o11">00058</a>     ULONG              <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o11">IdentifierType</a>;
<a name="l00059"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">00059</a>     PVOID              <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>;
<a name="l00060"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">00060</a>     PWCHAR             <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a>;
<a name="l00061"></a><a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o14">00061</a>     BOOLEAN            <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o14">NewlyCreated</a>;
00062 } <a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">FIRMWARE_CONFIGURATION</a>, *<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">PFIRMWARE_CONFIGURATION</a>;
00063 
00064 <span class="comment">//</span>
00065 <span class="comment">// Device extension information</span>
00066 <span class="comment">//</span>
00067 
00068 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">_DEVICE_EXTENSION</a> {
00069     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>     DeviceObject;
<a name="l00070"></a><a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o43">00070</a>     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o43">DriverObject</a>;
<a name="l00071"></a><a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o44">00071</a>     INTERFACE_TYPE     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o44">InterfaceType</a>;
<a name="l00072"></a><a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o45">00072</a>     ULONG              <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
<a name="l00073"></a><a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">00073</a>     <a class="code" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a> <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">FirmwareList</a>;
00074 } <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">DEVICE_EXTENSION</a>, *<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>;
00075 <span class="comment">//</span>
00076 <span class="comment">// mapping table from firmware to enum</span>
00077 <span class="comment">//</span>
00078 
<a name="l00079"></a><a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html">00079</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html">_FIRMWARE_IDENT_TO_PNP_ID</a> {
<a name="l00080"></a><a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o0">00080</a>     PWCHAR  <a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o0">FirmwareName</a>;
<a name="l00081"></a><a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o1">00081</a>     PWCHAR  <a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o1">PnPId</a>;
00082 } <a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html">FIRMWARE_IDENT_TO_PNP_ID</a>, *<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html">PFIRMWARE_IDENT_TO_PNP_ID</a>;
00083 
00084 <span class="comment">//</span>
00085 <span class="comment">// table to hold seed information for a firmware tree entry.</span>
00086 <span class="comment">//</span>
00087 
<a name="l00088"></a><a class="code" href="../../d2/d5/mapper_8c.html#a0">00088</a> <span class="preprocessor">#define OPTIONS_NONE                    0x00000000</span>
<a name="l00089"></a><a class="code" href="../../d2/d5/mapper_8c.html#a1">00089</a> <span class="preprocessor"></span><span class="preprocessor">#define OPTIONS_INSERT_PNP_ID           0x00000001</span>
<a name="l00090"></a><a class="code" href="../../d2/d5/mapper_8c.html#a2">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define OPTIONS_INSERT_DEVICEDESC       0x00000002</span>
<a name="l00091"></a><a class="code" href="../../d2/d5/mapper_8c.html#a3">00091</a> <span class="preprocessor"></span><span class="preprocessor">#define OPTIONS_INSERT_COMPATIBLE_IDS   0x00000004</span>
<a name="l00092"></a><a class="code" href="../../d2/d5/mapper_8c.html#a4">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define OPTIONS_INSERT_PHANTOM_MARKER   0x00000008</span>
<a name="l00093"></a><a class="code" href="../../d7/d6/struct__MAPPER__SEED.html">00093</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d6/struct__MAPPER__SEED.html">_MAPPER_SEED</a> {
<a name="l00094"></a><a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o0">00094</a>     PWCHAR  <a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o0">ValueName</a>;
<a name="l00095"></a><a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o1">00095</a>     ULONG   <a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o1">ValueType</a>;
<a name="l00096"></a><a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o2">00096</a>     ULONG   <a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o2">DwordValueContent</a>;
<a name="l00097"></a><a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o3">00097</a>     ULONG   <a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o3">Options</a>;
00098 } <a class="code" href="../../d7/d6/struct__MAPPER__SEED.html">MAPPER_SEED</a>, *<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html">PMAPPER_SEED</a>;
00099 
00100 <span class="comment">//</span>
00101 <span class="comment">// table to hold key names and attributes for construction</span>
00102 <span class="comment">// in the root enumerator tree</span>
00103 <span class="comment">//</span>
00104 
<a name="l00105"></a><a class="code" href="../../d2/d5/mapper_8c.html#a5">00105</a> <span class="preprocessor">#define KEY_SEED_REQUIRED               0x00000000</span>
<a name="l00106"></a><a class="code" href="../../d2/d5/mapper_8c.html#a6">00106</a> <span class="preprocessor"></span><span class="preprocessor">#define KEY_SEED_DEVICE_PARAMETERS      0x00000001</span>
<a name="l00107"></a><a class="code" href="../../d6/d6/struct__KEY__SEED.html">00107</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__KEY__SEED.html">_KEY_SEED</a> {
<a name="l00108"></a><a class="code" href="../../d6/d6/struct__KEY__SEED.html#o0">00108</a>     PWCHAR  <a class="code" href="../../d6/d6/struct__KEY__SEED.html#o0">KeyName</a>;
<a name="l00109"></a><a class="code" href="../../d6/d6/struct__KEY__SEED.html#o1">00109</a>     ULONG   <a class="code" href="../../d6/d6/struct__KEY__SEED.html#o1">Attribute</a>;
<a name="l00110"></a><a class="code" href="../../d6/d6/struct__KEY__SEED.html#o2">00110</a>     ULONG   <a class="code" href="../../d6/d6/struct__KEY__SEED.html#o2">Options</a>;
00111 } <a class="code" href="../../d6/d6/struct__KEY__SEED.html">KEY_SEED</a>, *<a class="code" href="../../d6/d6/struct__KEY__SEED.html">PKEY_SEED</a>;
00112 
00113 
00114 <span class="comment">//</span>
00115 <span class="comment">// All the data here is INIT only</span>
00116 <span class="comment">//</span>
00117 
00118 <span class="comment">//#ifdef ALLOC_DATA_PRAGMA</span>
00119 <span class="comment">//#pragma data_seg("INIT")</span>
00120 <span class="comment">//#endif</span>
00121 
<a name="l00122"></a><a class="code" href="../../d2/d5/mapper_8c.html#a25">00122</a> <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">DEVICE_EXTENSION</a> <a class="code" href="../../d2/d5/mapper_8c.html#a25">MapperDeviceExtension</a>;
00123 
00124 <span class="comment">//</span>
00125 <span class="comment">// This table is used to translate the firmware tree information</span>
00126 <span class="comment">// to the root enumerator PNP id for keyboard devices.</span>
00127 <span class="comment">//</span>
00128 
<a name="l00129"></a><a class="code" href="../../d2/d5/mapper_8c.html#a26">00129</a> <a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html">FIRMWARE_IDENT_TO_PNP_ID</a> <a class="code" href="../../d2/d5/mapper_8c.html#a26">KeyboardMap</a>[] = {
00130     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"XT_83KEY"</span>,        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0300"</span>,
00131     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCAT_86KEY"</span>,      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0301"</span>,
00132     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCXT_84KEY"</span>,      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0302"</span>,
00133     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"XT_84KEY"</span>,        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0302"</span>,
00134     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"101-KEY"</span>,         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0303"</span>,
00135     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OLI_83KEY"</span>,       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0304"</span>,
00136     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ATT_301"</span>,         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0304"</span>,
00137     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OLI_102KEY"</span>,      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0305"</span>,
00138     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OLI_86KEY"</span>,       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0306"</span>,
00139     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OLI_A101_102KEY"</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0309"</span>,
00140     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ATT_302"</span>,         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP030a"</span>,
00141     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCAT_ENHANCED"</span>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP030b"</span>,
00142     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PC98_106KEY"</span>,     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1300"</span>,
00143     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PC98_LaptopKEY"</span>,  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1300"</span>,
00144     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PC98_N106KEY"</span>,    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0303"</span>,
00145     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00146 };
00147 
<a name="l00148"></a><a class="code" href="../../d2/d5/mapper_8c.html#a7">00148</a> <span class="preprocessor">#define PS2_KEYBOARD_COMPATIBLE_ID  L"PS2_KEYBOARD"</span>
<a name="l00149"></a><a class="code" href="../../d2/d5/mapper_8c.html#a8">00149</a> <span class="preprocessor"></span><span class="preprocessor">#define PS2_MOUSE_COMPATIBLE_ID     L"PS2_MOUSE"</span>
00150 <span class="preprocessor"></span>
00151 <span class="comment">//</span>
00152 <span class="comment">// This table is used to translate the firmware tree information</span>
00153 <span class="comment">// to the root enumerator PNP id for pointer devices.</span>
00154 <span class="comment">//</span>
00155 
<a name="l00156"></a><a class="code" href="../../d2/d5/mapper_8c.html#a27">00156</a> <a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html">FIRMWARE_IDENT_TO_PNP_ID</a> <a class="code" href="../../d2/d5/mapper_8c.html#a27">PointerMap</a>[] = {
00157     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PS2 MOUSE"</span>,                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F0E"</span>,
00158     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SERIAL MOUSE"</span>,                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F0C"</span>,
00159     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MICROSOFT PS2 MOUSE"</span>,              <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F03"</span>,
00160     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LOGITECH PS2 MOUSE"</span>,               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F12"</span>,
00161     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MICROSOFT INPORT MOUSE"</span>,           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F02"</span>,
00162     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MICROSOFT SERIAL MOUSE"</span>,           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F01"</span>,
00163     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MICROSOFT BALLPOINT SERIAL MOUSE"</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F09"</span>,
00164     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LOGITECH SERIAL MOUSE"</span>,            <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F08"</span>,
00165     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MICROSOFT BUS MOUSE"</span>,              <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F00"</span>,
00166     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NEC PC-9800 BUS MOUSE"</span>,            <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1F00"</span>,
00167     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00168 };
00169 
00170 <span class="comment">//</span>
00171 <span class="comment">// the MapperValueSeed table is a NULL terminated table (i.e. the name</span>
00172 <span class="comment">// pointer is NULL) that contains the list of values and their type</span>
00173 <span class="comment">// for insertion in a newly created root enumerator key.</span>
00174 <span class="comment">//</span>
00175 
<a name="l00176"></a><a class="code" href="../../d2/d5/mapper_8c.html#a28">00176</a> <a class="code" href="../../d7/d6/struct__MAPPER__SEED.html">MAPPER_SEED</a> <a class="code" href="../../d2/d5/mapper_8c.html#a28">MapperValueSeed</a>[] = {
00177     REGSTR_VAL_HARDWAREID,         REG_MULTI_SZ, 0, <a class="code" href="../../d2/d5/mapper_8c.html#a1">OPTIONS_INSERT_PNP_ID</a>,
00178     REGSTR_VAL_COMPATIBLEIDS,      REG_MULTI_SZ, 0, <a class="code" href="../../d2/d5/mapper_8c.html#a3">OPTIONS_INSERT_COMPATIBLE_IDS</a>,
00179     REGSTR_VAL_FIRMWAREIDENTIFIED, REG_DWORD,    1, <a class="code" href="../../d2/d5/mapper_8c.html#a0">OPTIONS_NONE</a>,
00180     REGSTR_VAL_DEVDESC,            REG_SZ,       0, <a class="code" href="../../d2/d5/mapper_8c.html#a2">OPTIONS_INSERT_DEVICEDESC</a>,
00181     REGSTR_VAL_PHANTOM,            REG_DWORD,    1, <a class="code" href="../../d2/d5/mapper_8c.html#a4">OPTIONS_INSERT_PHANTOM_MARKER</a>,
00182     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0
00183 };
00184 
00185 <span class="comment">//</span>
00186 <span class="comment">// the MapperKeySeed table is a NULL terminated table (i.e. the name</span>
00187 <span class="comment">// pointer is NULL) that contains the list of keys to and their</span>
00188 <span class="comment">// attributes (volatile or non-volatile) for keys to be created under</span>
00189 <span class="comment">// a newly created root enumerator key.</span>
00190 <span class="comment">//</span>
00191 <span class="comment">// The preceeding backslash is required on all entries in this table.</span>
00192 <span class="comment">//</span>
00193 
<a name="l00194"></a><a class="code" href="../../d2/d5/mapper_8c.html#a29">00194</a> <a class="code" href="../../d6/d6/struct__KEY__SEED.html">KEY_SEED</a> <a class="code" href="../../d2/d5/mapper_8c.html#a29">MapperKeySeed</a>[] = {
00195     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Control"</span>,           REG_OPTION_VOLATILE,     <a class="code" href="../../d2/d5/mapper_8c.html#a5">KEY_SEED_REQUIRED</a>,
00196     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\LogConf"</span>,           REG_OPTION_NON_VOLATILE, <a class="code" href="../../d2/d5/mapper_8c.html#a5">KEY_SEED_REQUIRED</a>,
00197     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,                    REG_OPTION_NON_VOLATILE, <a class="code" href="../../d2/d5/mapper_8c.html#a6">KEY_SEED_DEVICE_PARAMETERS</a>,
00198     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0
00199 };
00200 
00201 <span class="comment">//</span>
00202 <span class="comment">// SerialId is used as the PNP id for all serial controllers.</span>
00203 <span class="comment">// NOTE: there is no code to detect presense of a 16550.</span>
00204 <span class="comment">//</span>
00205 
<a name="l00206"></a><a class="code" href="../../d2/d5/mapper_8c.html#a30">00206</a> PWSTR <a class="code" href="../../d2/d5/mapper_8c.html#a30">SerialId</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0501"</span>;   <span class="comment">// RDR should be two entries.  *PNP0501 is 16550</span>
00207 
<a name="l00208"></a><a class="code" href="../../d2/d5/mapper_8c.html#a31">00208</a> PWSTR <a class="code" href="../../d2/d5/mapper_8c.html#a31">SerialIdNEC</a>[] = {         <span class="comment">// NEC98 need some DeviceId for Serial Controller.</span>
00209     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1500"</span>,
00210     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1501"</span>,
00211     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1502"</span>,
00212     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1503"</span>,
00213     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC8071"</span>,
00214     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC0C01"</span>,
00215      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00216 };
00217 
00218 <span class="comment">//</span>
00219 <span class="comment">// ParallelId is used as the PNP id for all parallel controllers.</span>
00220 <span class="comment">// NOTE: there is no code to detect presense of ECP support.</span>
00221 <span class="comment">//</span>
00222 
<a name="l00223"></a><a class="code" href="../../d2/d5/mapper_8c.html#a32">00223</a> PWSTR <a class="code" href="../../d2/d5/mapper_8c.html#a32">ParallelId</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0400"</span>; <span class="comment">// RDR should be two entries.  *PNP0401 is ECP</span>
00224 
<a name="l00225"></a><a class="code" href="../../d2/d5/mapper_8c.html#a33">00225</a> PWSTR <a class="code" href="../../d2/d5/mapper_8c.html#a33">ParallelIdNEC</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1401"</span>;  <span class="comment">// This DeviceId has NEC98 only.</span>
00226 
00227 <span class="comment">//</span>
00228 <span class="comment">// FloppyId is used as the PNP id for all floppy peripherals.</span>
00229 <span class="comment">//</span>
00230 
<a name="l00231"></a><a class="code" href="../../d2/d5/mapper_8c.html#a34">00231</a> PWSTR <a class="code" href="../../d2/d5/mapper_8c.html#a34">FloppyId</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0700"</span>;
00232 
00233 <span class="comment">//</span>
00234 <span class="comment">// ATAId is here, but not used - there is nothing in the firmware</span>
00235 <span class="comment">// tree for the IDE controller.</span>
00236 <span class="comment">//</span>
00237 
<a name="l00238"></a><a class="code" href="../../d2/d5/mapper_8c.html#a35">00238</a> PWSTR <a class="code" href="../../d2/d5/mapper_8c.html#a35">ATAId</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0600"</span>;
00239 
00240 <span class="comment">//</span>
00241 <span class="comment">// Debugging stuff</span>
00242 <span class="comment">//</span>
00243 
00244 <span class="preprocessor">#if DBG</span>
00245 <span class="preprocessor"></span>
00246 <span class="preprocessor">#define MAPPER_ERROR       0x00000001</span>
00247 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_INFORMATION 0x00000002</span>
00248 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_PNP_ID      0x00000004</span>
00249 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_RESOURCES   0x00000008</span>
00250 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_REGISTRY    0x00000010</span>
00251 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_VERBOSE     0x00008000</span>
00252 <span class="preprocessor"></span>
00253 ULONG MapperDebugMask =    MAPPER_ERROR       |
00254                            <span class="comment">// MAPPER_INFORMATION |</span>
00255                            <span class="comment">// MAPPER_REGISTRY    |</span>
00256                            <span class="comment">// MAPPER_PNP_ID      |</span>
00257                            <span class="comment">// MAPPER_RESOURCES   |</span>
00258                            <span class="comment">// MAPPER_VERBOSE |</span>
00259                            0;
00260 
00261 <span class="preprocessor">#define DebugPrint(X) MapperDebugPrint X</span>
00262 <span class="preprocessor"></span>
00263 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00264 MapperDebugPrint(
00265     ULONG  DebugMask,
00266     PCCHAR DebugMessage,
00267     ...
00268     );
00269 
00270 <span class="preprocessor">#else</span>
00271 <span class="preprocessor"></span>
<a name="l00272"></a><a class="code" href="../../d2/d5/mapper_8c.html#a9">00272</a> <span class="preprocessor">#define DebugPrint(X)</span>
00273 <span class="preprocessor"></span>
00274 <span class="preprocessor">#endif // DBG</span>
00275 <span class="preprocessor"></span>
00276 <span class="comment">//</span>
00277 <span class="comment">// Proto type declarations</span>
00278 <span class="comment">//</span>
00279 
00280 <a class="code" href="../../d2/d5/mapper_8c.html#a20">PFIRMWARE_IDENT_TO_PNP_ID</a>
00281 <a class="code" href="../../d2/d5/mapper_8c.html#a36">MapperFindIdentMatch</a>(
00282     PFIRMWARE_IDENT_TO_PNP_ID IdentTable,
00283     PWCHAR String
00284     );
00285 
00286 PWSTR
00287 <a class="code" href="../../d2/d5/mapper_8c.html#a37">MapperTranslatePnPId</a>(
00288     CONFIGURATION_TYPE PeripheralType,
00289     PKEY_VALUE_FULL_INFORMATION Identifier
00290     );
00291 
00292 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00293 <a class="code" href="../../d2/d5/mapper_8c.html#a38">MapperPeripheralCallback</a>(
00294     IN PVOID                        Context,
00295     IN PUNICODE_STRING              PathName,
00296     IN INTERFACE_TYPE               BusType,
00297     IN ULONG                        BusNumber,
00298     IN PKEY_VALUE_FULL_INFORMATION *BusInformation,
00299     IN CONFIGURATION_TYPE           ControllerType,
00300     IN ULONG                        ControllerNumber,
00301     IN PKEY_VALUE_FULL_INFORMATION *ControllerInformation,
00302     IN CONFIGURATION_TYPE           PeripheralType,
00303     IN ULONG                        PeripheralNumber,
00304     IN PKEY_VALUE_FULL_INFORMATION *PeripheralInformation
00305     );
00306 
00307 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00308 <a class="code" href="../../d2/d5/mapper_8c.html#a39">MapperCallback</a>(
00309     IN PVOID                        Context,
00310     IN PUNICODE_STRING              PathName,
00311     IN INTERFACE_TYPE               BusType,
00312     IN ULONG                        BusNumber,
00313     IN PKEY_VALUE_FULL_INFORMATION *BusInformation,
00314     IN CONFIGURATION_TYPE           ControllerType,
00315     IN ULONG                        ControllerNumber,
00316     IN PKEY_VALUE_FULL_INFORMATION *ControllerInformation,
00317     IN CONFIGURATION_TYPE           PeripheralType,
00318     IN ULONG                        PeripheralNumber,
00319     IN PKEY_VALUE_FULL_INFORMATION *PeripheralInformation
00320     );
00321 
00322 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00323 <a class="code" href="../../d2/d5/mapper_8c.html#a40">MapperMarkKey</a>(
00324     IN HANDLE Handle,
00325     IN PUNICODE_STRING  PathName,
00326     IN PFIRMWARE_CONFIGURATION FirmwareEntry
00327     );
00328 
00329 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00330 <a class="code" href="../../d2/d5/mapper_8c.html#a41">MapperSeedKey</a>(
00331     IN HANDLE                  Handle,
00332     IN PUNICODE_STRING         PathName,
00333     IN PFIRMWARE_CONFIGURATION FirmwareEntry,
00334     IN BOOLEAN                 DeviceIsPhantom
00335     );
00336 
00337 PCM_RESOURCE_LIST
00338 <a class="code" href="../../d2/d5/mapper_8c.html#a42">MapperAdjustResourceList</a> (
00339     IN     PCM_RESOURCE_LIST ResourceList,
00340     IN     PWCHAR            PnPId,
00341     IN OUT PULONG            Size
00342     );
00343 
00344 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00345 <a class="code" href="../../d2/d1/pnpmap_8c.html#a51">ComPortDBAdd</a>(
00346     IN  HANDLE  DeviceParamKey,
00347     IN  PWSTR   PortName
00348     );
00349 
00350 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00351 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperFindIdentMatch)</span>
00352 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperTranslatePnPId)</span>
00353 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperPeripheralCallback)</span>
00354 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperCallback)</span>
00355 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperMarkKey)</span>
00356 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperSeedKey)</span>
00357 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperFreeList)</span>
00358 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperAdjustResourceList)</span>
00359 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, ComPortDBAdd)</span>
00360 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperPhantomizeDetectedComPorts)</span>
00361 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
00362 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MapperDebugPrint)</span>
00363 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00364 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00365 <span class="preprocessor"></span>
00366 <a class="code" href="../../d2/d5/mapper_8c.html#a20">PFIRMWARE_IDENT_TO_PNP_ID</a>
<a name="l00367"></a><a class="code" href="../../d2/d5/mapper_8c.html#a36">00367</a> <a class="code" href="../../d2/d5/mapper_8c.html#a36">MapperFindIdentMatch</a>(
00368     PFIRMWARE_IDENT_TO_PNP_ID IdentTable,
00369     PWCHAR                    String
00370     )
00371 
00372 <span class="comment">/*++</span>
00373 <span class="comment"></span>
00374 <span class="comment">Routine Description:</span>
00375 <span class="comment"></span>
00376 <span class="comment">    Given a table of strings to match, find the match for</span>
00377 <span class="comment">    the identifier given.</span>
00378 <span class="comment"></span>
00379 <span class="comment">Arguments:</span>
00380 <span class="comment"></span>
00381 <span class="comment">Return Value:</span>
00382 <span class="comment"></span>
00383 <span class="comment">    A pointer to the ident table entry for the match if found</span>
00384 <span class="comment">    NULL if not found.</span>
00385 <span class="comment"></span>
00386 <span class="comment">--*/</span>
00387 
00388 {
00389     <a class="code" href="../../d2/d5/mapper_8c.html#a20">PFIRMWARE_IDENT_TO_PNP_ID</a> entry;
00390 
00391     entry = IdentTable;
00392     <span class="keywordflow">while</span> (entry-&gt;<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o0">FirmwareName</a>) {
00393         <span class="keywordflow">if</span> (!wcscmp(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, entry-&gt;<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o0">FirmwareName</a>)) {
00394             <span class="keywordflow">return</span> entry;
00395         }
00396         entry++;
00397     }
00398     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00399 }
00400 
00401 PWSTR
<a name="l00402"></a><a class="code" href="../../d2/d5/mapper_8c.html#a37">00402</a> <a class="code" href="../../d2/d5/mapper_8c.html#a37">MapperTranslatePnPId</a>(
00403     CONFIGURATION_TYPE          PeripheralType,
00404     PKEY_VALUE_FULL_INFORMATION Identifier
00405     )
00406 
00407 <span class="comment">/*++</span>
00408 <span class="comment"></span>
00409 <span class="comment">Routine Description:</span>
00410 <span class="comment"></span>
00411 <span class="comment">    Given the peripheral type and a location in the firmware tree</span>
00412 <span class="comment">    this routine will determine the PnP Id to be used when constructing</span>
00413 <span class="comment">    the root enumeration portion of the registry.</span>
00414 <span class="comment"></span>
00415 <span class="comment">Arguments:</span>
00416 <span class="comment"></span>
00417 <span class="comment">    PeripheralType - the type of item being translated (keyboard, mouse, etc)</span>
00418 <span class="comment">    PathName       - the registry path name into the firmware tree for</span>
00419 <span class="comment">                     this device.</span>
00420 <span class="comment"></span>
00421 <span class="comment">Return Value:</span>
00422 <span class="comment"></span>
00423 <span class="comment">    A pointer to the PnP Id string if a map is found.</span>
00424 <span class="comment"></span>
00425 <span class="comment">--*/</span>
00426 
00427 {
00428     <a class="code" href="../../d2/d5/mapper_8c.html#a20">PFIRMWARE_IDENT_TO_PNP_ID</a> identMap;
00429     PWSTR identifierString;
00430     PWSTR idStr;
00431 
00432     <span class="keywordflow">if</span> (Identifier) {
00433         identifierString = (PWSTR)((PUCHAR)Identifier + Identifier-&gt;DataOffset);
00434         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00435                     <span class="stringliteral">"Mapper: identifier = %ws\n\tType = "</span>,
00436                     identifierString));
00437     }
00438 
00439     idStr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00440     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>) {
00441     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a200">DiskController</a>:
00442         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00443                     <span class="stringliteral">"%s (%d)\n"</span>,
00444                     <span class="stringliteral">"DiskController"</span>,
00445                     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>));
00446         idStr = <a class="code" href="../../d2/d5/mapper_8c.html#a34">FloppyId</a>;
00447         <span class="keywordflow">break</span>;
00448 
00449     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>:
00450         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00451                     <span class="stringliteral">"%s (%d)\n"</span>,
00452                     <span class="stringliteral">"SerialController"</span>,
00453                     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>));
00454         idStr = <a class="code" href="../../d2/d5/mapper_8c.html#a30">SerialId</a>;
00455         <span class="keywordflow">break</span>;
00456 
00457     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a207">ParallelController</a>:
00458         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00459                     <span class="stringliteral">"%s (%d)\n"</span>,
00460                     <span class="stringliteral">"ParallelController"</span>,
00461                     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>));
00462         idStr = <a class="code" href="../../d2/d5/mapper_8c.html#a32">ParallelId</a>;
00463         <span class="keywordflow">break</span>;
00464 
00465     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a208">PointerController</a>:
00466         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00467                     <span class="stringliteral">"%s (%d)\n"</span>,
00468                     <span class="stringliteral">"PointerController"</span>,
00469                     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>));
00470         idStr = <a class="code" href="../../d2/d5/mapper_8c.html#a27">PointerMap</a>[0].<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o1">PnPId</a>;
00471         <span class="keywordflow">break</span>;
00472 
00473     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a209">KeyboardController</a>:
00474         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00475                     <span class="stringliteral">"%s (%d)\n"</span>,
00476                     <span class="stringliteral">"KeyboardController"</span>,
00477                     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>));
00478         idStr = <a class="code" href="../../d2/d5/mapper_8c.html#a26">KeyboardMap</a>[0].<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o1">PnPId</a>;
00479         <span class="keywordflow">break</span>;
00480 
00481     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a212">DiskPeripheral</a>:
00482         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00483                     <span class="stringliteral">"%s (%d)\n"</span>,
00484                     <span class="stringliteral">"DiskPeripheral"</span>,
00485                     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>));
00486         <span class="keywordflow">break</span>;
00487 
00488     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a213">FloppyDiskPeripheral</a>:
00489         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00490                     <span class="stringliteral">"%s (%d)\n"</span>,
00491                     <span class="stringliteral">"FloppyDiskPeripheral"</span>,
00492                     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>));
00493         idStr = <a class="code" href="../../d2/d5/mapper_8c.html#a34">FloppyId</a>;
00494         <span class="keywordflow">break</span>;
00495 
00496     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a218">PointerPeripheral</a>:
00497         identMap = <a class="code" href="../../d2/d5/mapper_8c.html#a36">MapperFindIdentMatch</a>(<a class="code" href="../../d2/d5/mapper_8c.html#a27">PointerMap</a>, identifierString);
00498         <span class="keywordflow">if</span> (identMap) {
00499             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00500                         <span class="stringliteral">"%ws\n"</span>,
00501                         identMap-&gt;<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o1">PnPId</a>));
00502             idStr = identMap-&gt;<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o1">PnPId</a>;
00503         } <span class="keywordflow">else</span> {
00504             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
00505                         <span class="stringliteral">"Mapper: No pointer match found\n"</span>));
00506         }
00507         <span class="keywordflow">break</span>;
00508 
00509     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a219">KeyboardPeripheral</a>:
00510         identMap = <a class="code" href="../../d2/d5/mapper_8c.html#a36">MapperFindIdentMatch</a>(<a class="code" href="../../d2/d5/mapper_8c.html#a26">KeyboardMap</a>, identifierString);
00511 
00512         <span class="keywordflow">if</span> (identMap) {
00513             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00514                         <span class="stringliteral">"%ws\n"</span>,
00515                         identMap-&gt;<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o1">PnPId</a>));
00516             idStr = identMap-&gt;<a class="code" href="../../d7/d2/struct__FIRMWARE__IDENT__TO__PNP__ID.html#o1">PnPId</a>;
00517         } <span class="keywordflow">else</span> {
00518             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
00519                         <span class="stringliteral">"Mapper: No keyboard match found\n"</span>));
00520         }
00521 
00522         <span class="keywordflow">break</span>;
00523 
00524     <span class="keywordflow">default</span>:
00525         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
00526                     <span class="stringliteral">"Mapper: Unknown device (%d)\n"</span>,
00527                     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>));
00528         <span class="keywordflow">break</span>;
00529     }
00530     <span class="keywordflow">return</span> idStr;
00531 }
00532 
00533 
00534 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00535"></a><a class="code" href="../../d2/d5/mapper_8c.html#a38">00535</a> <a class="code" href="../../d2/d5/mapper_8c.html#a38">MapperPeripheralCallback</a>(
00536     IN PVOID                        Context,
00537     IN PUNICODE_STRING              PathName,
00538     IN INTERFACE_TYPE               BusType,
00539     IN ULONG                        BusNumber,
00540     IN PKEY_VALUE_FULL_INFORMATION *BusInformation,
00541     IN CONFIGURATION_TYPE           ControllerType,
00542     IN ULONG                        ControllerNumber,
00543     IN PKEY_VALUE_FULL_INFORMATION *ControllerInformation,
00544     IN CONFIGURATION_TYPE           PeripheralType,
00545     IN ULONG                        PeripheralNumber,
00546     IN PKEY_VALUE_FULL_INFORMATION *PeripheralInformation
00547     )
00548 
00549 <span class="comment">/*++</span>
00550 <span class="comment"></span>
00551 <span class="comment">Routine Description:</span>
00552 <span class="comment"></span>
00553 <span class="comment">    This routine is used to acquire firmware tree information about</span>
00554 <span class="comment">    pointer devices in the system.</span>
00555 <span class="comment"></span>
00556 <span class="comment">Arguments:</span>
00557 <span class="comment"></span>
00558 <span class="comment">    Context               - Pointer to the device extension.</span>
00559 <span class="comment">    PathName              - unicode registry path.</span>
00560 <span class="comment">    BusType               - Internal, Isa, ...</span>
00561 <span class="comment">    BusNumber             - Which bus if we are on a multibus system.</span>
00562 <span class="comment">    BusInformation        - Configuration information about the bus. Not Used.</span>
00563 <span class="comment">    ControllerType        - serial or ata disk.</span>
00564 <span class="comment">    ControllerNumber      - Which controller if there is more than one</span>
00565 <span class="comment">                            controller in the system.</span>
00566 <span class="comment">    ControllerInformation - Array of pointers to the three pieces of</span>
00567 <span class="comment">                            registry information.</span>
00568 <span class="comment">    PeripheralType        - Undefined for this call.</span>
00569 <span class="comment">    PeripheralNumber      - Undefined for this call.</span>
00570 <span class="comment">    PeripheralInformation - Undefined for this call.</span>
00571 <span class="comment"></span>
00572 <span class="comment">Return Value:</span>
00573 <span class="comment"></span>
00574 <span class="comment">    STATUS_SUCCESS if everything went ok, or STATUS_INSUFFICIENT_RESOURCES</span>
00575 <span class="comment">    if it couldn't map the base csr or acquire the device object, or</span>
00576 <span class="comment">    all of the resource information couldn't be acquired.</span>
00577 <span class="comment"></span>
00578 <span class="comment">--*/</span>
00579 
00580 {
00581     <a class="code" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a>     firmwareEntry = Context;
00582     PKEY_VALUE_FULL_INFORMATION information;
00583     ULONG                       dataLength;
00584     PWCHAR                      ptr;
00585     PVOID                       temp;
00586 
00587     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_REGISTRY,
00588                 <span class="stringliteral">"Mapper: peripheral registry location is\n %ws\n"</span>,
00589                 PathName-&gt;Buffer));
00590 
00591     <span class="keywordflow">if</span> (!ControllerInformation) {
00592         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_VERBOSE,
00593                     <span class="stringliteral">"Mapper: No component information\n"</span>));
00594     }
00595     <span class="keywordflow">if</span> (!PeripheralInformation) {
00596         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_VERBOSE,
00597                     <span class="stringliteral">"Mapper: No peripheral information\n"</span>));
00598         <span class="keywordflow">return</span> STATUS_SUCCESS;
00599     }
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// Map the PnP Id for this device.</span>
00603     <span class="comment">//</span>
00604 
00605     <span class="keywordflow">if</span> (PeripheralInformation[<a class="code" href="../../d0/d5/io_8h.html#a599a402">IoQueryDeviceIdentifier</a>]) {
00606         information = PeripheralInformation[<a class="code" href="../../d0/d5/io_8h.html#a599a402">IoQueryDeviceIdentifier</a>];
00607         firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a> = <a class="code" href="../../d2/d5/mapper_8c.html#a37">MapperTranslatePnPId</a>(<a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>, information);
00608 
00609         <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a>) {
00610             <span class="comment">//</span>
00611             <span class="comment">// Remember the peripheral's identifier (if it has one, and it's a REG_SZ value)</span>
00612             <span class="comment">// for use as the default PnP device description.</span>
00613             <span class="comment">//</span>
00614 
00615             <span class="keywordflow">if</span> (((dataLength = information-&gt;DataLength) &gt; <span class="keyword">sizeof</span>(WCHAR)) &amp;&amp;
00616                 (information-&gt;Type == REG_SZ)) {
00617 
00618                 ptr = (PWCHAR) ((PUCHAR)information + information-&gt;DataOffset);
00619 
00620                 <span class="keywordflow">if</span> (*ptr) {
00621                     temp = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, dataLength);
00622                     <span class="keywordflow">if</span> (temp) {
00623 
00624                         <span class="comment">//</span>
00625                         <span class="comment">// If there's already an identifier here (from the peripheral's</span>
00626                         <span class="comment">// controller) then wipe it out.</span>
00627                         <span class="comment">//</span>
00628 
00629                         <span class="keywordflow">if</span>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>) {
00630                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>);
00631                         }
00632 
00633                         <span class="comment">//</span>
00634                         <span class="comment">// Move the data</span>
00635                         <span class="comment">//</span>
00636 
00637                         firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a> = temp;
00638                         firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o11">IdentifierType</a> = information-&gt;Type;
00639                         firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o10">IdentifierLength</a> = dataLength;
00640                         RtlMoveMemory(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>, ptr, dataLength);
00641                     }
00642                 }
00643             }
00644         }
00645     }
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// Save the ordinals for the peripheral type and number</span>
00649     <span class="comment">//</span>
00650 
00651     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o5">PeripheralType</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>;
00652     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o6">PeripheralNumber</a> = PeripheralNumber;
00653 
00654     <span class="keywordflow">return</span> STATUS_SUCCESS;
00655 }
00656 
00657 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00658"></a><a class="code" href="../../d2/d5/mapper_8c.html#a39">00658</a> <a class="code" href="../../d2/d5/mapper_8c.html#a39">MapperCallback</a>(
00659     IN PVOID                        Context,
00660     IN PUNICODE_STRING              PathName,
00661     IN INTERFACE_TYPE               BusType,
00662     IN ULONG                        BusNumber,
00663     IN PKEY_VALUE_FULL_INFORMATION *BusInformation,
00664     IN CONFIGURATION_TYPE           ControllerType,
00665     IN ULONG                        ControllerNumber,
00666     IN PKEY_VALUE_FULL_INFORMATION *ControllerInformation,
00667     IN CONFIGURATION_TYPE           PeripheralType,
00668     IN ULONG                        PeripheralNumber,
00669     IN PKEY_VALUE_FULL_INFORMATION *PeripheralInformation
00670     )
00671 
00672 <span class="comment">/*++</span>
00673 <span class="comment"></span>
00674 <span class="comment">Routine Description:</span>
00675 <span class="comment"></span>
00676 <span class="comment">    This routine is used to acquire firmware tree information about</span>
00677 <span class="comment">    pointer devices in the system.</span>
00678 <span class="comment"></span>
00679 <span class="comment">Arguments:</span>
00680 <span class="comment"></span>
00681 <span class="comment">    Context               - Pointer to the device extension.</span>
00682 <span class="comment">    PathName              - unicode registry path.</span>
00683 <span class="comment">    BusType               - Internal, Isa, ...</span>
00684 <span class="comment">    BusNumber             - Which bus if we are on a multibus system.</span>
00685 <span class="comment">    BusInformation        - Configuration information about the bus. Not Used.</span>
00686 <span class="comment">    ControllerType        - serial or ata disk.</span>
00687 <span class="comment">    ControllerNumber      - Which controller if there is more than one</span>
00688 <span class="comment">                            controller in the system.</span>
00689 <span class="comment">    ControllerInformation - Array of pointers to the three pieces of</span>
00690 <span class="comment">                            registry information.</span>
00691 <span class="comment">    PeripheralType        - Undefined for this call.</span>
00692 <span class="comment">    PeripheralNumber      - Undefined for this call.</span>
00693 <span class="comment">    PeripheralInformation - Undefined for this call.</span>
00694 <span class="comment"></span>
00695 <span class="comment">Return Value:</span>
00696 <span class="comment"></span>
00697 <span class="comment">    STATUS_SUCCESS if everything went ok, or STATUS_INSUFFICIENT_RESOURCES</span>
00698 <span class="comment">    if it couldn't map the base csr or acquire the device object, or</span>
00699 <span class="comment">    all of the resource information couldn't be acquired.</span>
00700 <span class="comment"></span>
00701 <span class="comment">--*/</span>
00702 
00703 {
00704     <a class="code" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a>               deviceExtension = Context;
00705     PCM_FULL_RESOURCE_DESCRIPTOR    controllerData;
00706     PKEY_VALUE_FULL_INFORMATION     information;
00707     <a class="code" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a>         firmwareEntry;
00708     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a>              peripheralType;
00709     PUCHAR                          buffer;
00710     PUCHAR                          identifier;
00711     ULONG                           dataLength;
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// If entry is found, but there is no information just return</span>
00715     <span class="comment">//</span>
00716 
00717     <span class="keywordflow">if</span> (!(information = ControllerInformation[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>])) {
00718 
00719         <span class="keywordflow">return</span> STATUS_SUCCESS;
00720     }
00721 
00722     <span class="keywordflow">if</span> (!(dataLength = information-&gt;DataLength)) {
00723 
00724         <span class="keywordflow">return</span> STATUS_SUCCESS;
00725     }
00726 
00727     <span class="comment">//</span>
00728     <span class="comment">// Setup to capture the information from the firmware tree</span>
00729     <span class="comment">//</span>
00730 
00731     firmwareEntry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html">FIRMWARE_CONFIGURATION</a>));
00732     <span class="keywordflow">if</span> (!firmwareEntry) {
00733 
00734         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00735     }
00736     RtlZeroMemory(firmwareEntry, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/mapper_8c.html#a15">FIRMWARE_CONFIGURATION</a>));
00737 
00738     <span class="comment">//</span>
00739     <span class="comment">// Save information concerning the controller</span>
00740     <span class="comment">//</span>
00741 
00742     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">ControllerType</a>   = <a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>;
00743     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o4">ControllerNumber</a> = ControllerNumber;
00744     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o2">BusNumber</a> = <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00745     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o1">BusType</a>   = BusType;
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// Save the resource descriptor</span>
00749     <span class="comment">//</span>
00750 
00751     buffer = firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">ResourceDescriptor</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00752                                                                 dataLength);
00753 
00754     <span class="keywordflow">if</span> (!buffer) {
00755         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry);
00756         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00757     }
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Save the configuration information on this controller.</span>
00761     <span class="comment">//</span>
00762 
00763     controllerData = (PCM_FULL_RESOURCE_DESCRIPTOR)
00764         ((PUCHAR)information + information-&gt;DataOffset);
00765     RtlMoveMemory(buffer, controllerData, dataLength);
00766     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o8">ResourceDescriptorSize</a> = dataLength;
00767 
00768     <span class="comment">//</span>
00769     <span class="comment">// If there is a device identifier save it.</span>
00770     <span class="comment">//</span>
00771 
00772     <span class="keywordflow">if</span> (information = ControllerInformation[<a class="code" href="../../d0/d5/io_8h.html#a599a402">IoQueryDeviceIdentifier</a>]) {
00773         PWCHAR ptr;
00774 
00775         <span class="keywordflow">if</span> (dataLength = information-&gt;DataLength) {
00776 
00777             ptr = (PWCHAR) ((PUCHAR)information + information-&gt;DataOffset);
00778             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a315a207">ParallelController</a>) {
00779                 PWCHAR tmpChar;
00780 
00781                 <span class="comment">//</span>
00782                 <span class="comment">// Some extra mapping is performed here to</span>
00783                 <span class="comment">// translate the firmware names to LPT names.</span>
00784                 <span class="comment">//</span>
00785 
00786                 *ptr++ = (WCHAR) <span class="charliteral">'L'</span>;
00787                 *ptr++ = (WCHAR) <span class="charliteral">'P'</span>;
00788                 *ptr++ = (WCHAR) <span class="charliteral">'T'</span>;
00789 
00790                 <span class="comment">//</span>
00791                 <span class="comment">// Find the number.</span>
00792                 <span class="comment">//</span>
00793 
00794                 tmpChar = ptr;
00795                 <span class="keywordflow">while</span> (*tmpChar) {
00796                     <span class="keywordflow">if</span> ((*tmpChar &gt;= (WCHAR) <span class="charliteral">'0'</span>) &amp;&amp;
00797                         (*tmpChar &lt;= (WCHAR) <span class="charliteral">'9'</span>)) {
00798                         <span class="keywordflow">break</span>;
00799                     }
00800                     tmpChar++;
00801                 }
00802 
00803                 <span class="keywordflow">if</span> (*tmpChar) {
00804                     <span class="keywordflow">while</span> (*tmpChar) {
00805                         *ptr++ = *tmpChar++;
00806                     }
00807                     *ptr = (WCHAR) 0;
00808 
00809                     <span class="comment">//</span>
00810                     <span class="comment">// Update the datalength to be 4 wchars and eos and</span>
00811                     <span class="comment">// restore the pointer.</span>
00812                     <span class="comment">//</span>
00813 
00814                     ptr = (PWCHAR) ((PUCHAR)information + information-&gt;DataOffset);
00815                     dataLength = 10;
00816                 } <span class="keywordflow">else</span> {
00817                     dataLength = 0;
00818                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
00819                                 <span class="stringliteral">"Mapper: no parallel port number!\n"</span>));
00820                 }
00821             }
00822 
00823             <span class="keywordflow">if</span> (dataLength) {
00824                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00825                                                            dataLength);
00826                 <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>) {
00827 
00828                     <span class="comment">//</span>
00829                     <span class="comment">// Move the data</span>
00830                     <span class="comment">//</span>
00831 
00832                     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o11">IdentifierType</a> = information-&gt;Type;
00833                     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o10">IdentifierLength</a> = dataLength;
00834                     RtlMoveMemory(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>, ptr, dataLength);
00835                 }
00836             }
00837         }
00838     }
00839 
00840     <span class="comment">//</span>
00841     <span class="comment">// For some controllers, search the peripheral information</span>
00842     <span class="comment">//</span>
00843 
00844     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>) {
00845     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>:
00846     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a207">ParallelController</a>:
00847         <span class="comment">//</span>
00848         <span class="comment">// Don't look for a peripheral.</span>
00849         <span class="comment">//</span>
00850         peripheralType = (<a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a>) 0;
00851         <span class="keywordflow">break</span>;
00852     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a200">DiskController</a>:
00853         peripheralType = <a class="code" href="../../d1/d9/arc_8h.html#a315a213">FloppyDiskPeripheral</a>;
00854         <span class="keywordflow">break</span>;
00855     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a209">KeyboardController</a>:
00856         peripheralType = <a class="code" href="../../d1/d9/arc_8h.html#a315a219">KeyboardPeripheral</a>;
00857         <span class="keywordflow">break</span>;
00858     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a208">PointerController</a>:
00859         peripheralType = <a class="code" href="../../d1/d9/arc_8h.html#a315a218">PointerPeripheral</a>;
00860         <span class="keywordflow">break</span>;
00861     <span class="keywordflow">default</span>:
00862         peripheralType = (<a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a>) 0;
00863         <span class="keywordflow">break</span>;
00864     }
00865 
00866     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_REGISTRY,
00867                 <span class="stringliteral">"Mapper: registry location is\n %ws\n"</span>,
00868                 PathName-&gt;Buffer));
00869 
00870     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_INFORMATION,
00871                 <span class="stringliteral">"Mapper: ControllerInformation[] -\n\tIdent: %x -\n\tData: %x -\n\tInformation: %x\n"</span>,
00872                 ControllerInformation[0],
00873                 ControllerInformation[1],
00874                 ControllerInformation[2]));
00875 
00876     <span class="keywordflow">if</span> (peripheralType) {
00877         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00878                     <span class="stringliteral">"Mapper: searching for peripheral type %d\n"</span>,
00879                     peripheralType));
00880 
00881         <a class="code" href="../../d2/d3/io_2query_8c.html#a6">IoQueryDeviceDescription</a>(&amp;BusType,
00882                                  &amp;<a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00883                                  &amp;<a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>,
00884                                  &amp;ControllerNumber,
00885                                  &amp;peripheralType,
00886                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00887                                  <a class="code" href="../../d2/d5/mapper_8c.html#a38">MapperPeripheralCallback</a>,
00888                                  firmwareEntry);
00889     }
00890 
00891     <span class="comment">//</span>
00892     <span class="comment">// firmwareEntry-&gt;PnPId will be NULL if there are no peripherals of this</span>
00893     <span class="comment">// type in the tree or if the peripheral's description doesn't match one of</span>
00894     <span class="comment">// those in our table.</span>
00895     <span class="comment">//</span>
00896     <span class="comment">// firmwareEntry-&gt;PeripheralType will be equal to peripheralType if we found</span>
00897     <span class="comment">// one of the proper type regardless of whether or not it is in the table.</span>
00898     <span class="comment">//</span>
00899     <span class="comment">// So this test just ensures that we fallback to the controller IDs in the</span>
00900     <span class="comment">// case were there is no peripheral entry.  If there is a peripheral entry</span>
00901     <span class="comment">// that we don't understand we will suppress the entire node.</span>
00902     <span class="comment">//</span>
00903     <span class="comment">// This prevents creating devices with hw ids of bogus as we were seeing on</span>
00904     <span class="comment">// the SGI x86 ARC machines.</span>
00905     <span class="comment">//</span>
00906 
00907     <span class="keywordflow">if</span> (!firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a> &amp;&amp; firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o5">PeripheralType</a> == 0) {
00908 
00909         <span class="comment">//</span>
00910         <span class="comment">// Attempt to get PnPId from the controller type.</span>
00911         <span class="comment">//</span>
00912 
00913         firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a> = <a class="code" href="../../d2/d5/mapper_8c.html#a37">MapperTranslatePnPId</a>(<a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00914 
00915         <span class="keywordflow">if</span> (!firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a>) {
00916             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00917                         <span class="stringliteral">"Mapper: NO PnP Id for\n ==&gt; %ws\n"</span>,
00918                         PathName-&gt;Buffer));
00919         }
00920     }
00921 
00922     <span class="comment">// NEC98 needs DeviceId which differs with the other H/W.</span>
00923     <span class="keywordflow">if</span> (IsNEC_98){
00924 
00925         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>) {
00926         <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>:{
00927             ULONG   i,j;
00928             PWSTR   serialFirmwareName;
00929             serialFirmwareName = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*10);
00930             <span class="keywordflow">if</span> (!serialFirmwareName) {
00931                 <span class="keywordflow">if</span> (buffer)
00932                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
00933                 <span class="keywordflow">if</span> (firmwareEntry) {
00934                     <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>)
00935                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>);
00936                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry);
00937                 }
00938                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00939             }
00940             <span class="keywordflow">for</span> (
00941                 i = 0;
00942                 i &lt; controllerData-&gt;PartialResourceList.Count;
00943                 i++
00944                 ) {
00945                 PCM_PARTIAL_RESOURCE_DESCRIPTOR partial =
00946                     &amp;controllerData-&gt;PartialResourceList.PartialDescriptors[i];
00947 
00948                 <span class="keywordflow">if</span> (partial-&gt;Type == CmResourceTypeDeviceSpecific) {
00949                     PCM_SERIAL_DEVICE_DATA sDeviceData;
00950 
00951                     sDeviceData = (PCM_SERIAL_DEVICE_DATA)(partial + 1);
00952 
00953                     swprintf(serialFirmwareName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC%04X\0"</span>, sDeviceData-&gt;Revision);
00954                     j = 0;
00955                     <span class="keywordflow">while</span> (<a class="code" href="../../d2/d5/mapper_8c.html#a31">SerialIdNEC</a>[j]) {
00956                         <span class="keywordflow">if</span> (!wcscmp(serialFirmwareName, <a class="code" href="../../d2/d5/mapper_8c.html#a31">SerialIdNEC</a>[j])) {
00957                             firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a> = <a class="code" href="../../d2/d5/mapper_8c.html#a31">SerialIdNEC</a>[j];
00958                         }
00959                         j++;
00960                     }
00961                 }
00962 
00963             }
00964             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(serialFirmwareName);
00965             <span class="keywordflow">break</span>;
00966         }
00967         <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a207">ParallelController</a>:
00968             firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a> = <a class="code" href="../../d2/d5/mapper_8c.html#a33">ParallelIdNEC</a>;
00969             <span class="keywordflow">break</span>;
00970         <span class="keywordflow">default</span>:
00971             <span class="keywordflow">break</span>;
00972         }
00973     }
00974 
00975     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_PNP_ID,
00976                 <span class="stringliteral">"Mapper: constructed name %d_%d_%d_%d_%d_%d\n"</span>,
00977                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o1">BusType</a>,
00978                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o2">BusNumber</a>,
00979                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">ControllerType</a>,
00980                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o4">ControllerNumber</a>,
00981                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o5">PeripheralType</a>,
00982                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o6">PeripheralNumber</a>));
00983 
00984     <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a>) {
00985 
00986         <span class="comment">//</span>
00987         <span class="comment">// Link into chain of entries.</span>
00988         <span class="comment">//</span>
00989 
00990         firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o0">Next</a> = deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">FirmwareList</a>;
00991         deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">FirmwareList</a> = firmwareEntry;
00992     } <span class="keywordflow">else</span> {
00993 
00994         <span class="comment">//</span>
00995         <span class="comment">// No map found - don't remember this entry.</span>
00996         <span class="comment">//</span>
00997 
00998         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
00999         <span class="keywordflow">if</span>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>) {
01000             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>);
01001         }
01002         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry);
01003     }
01004     <span class="keywordflow">return</span> STATUS_SUCCESS;
01005 }
01006 
01007 
01008 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01009"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a338">01009</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a338">MapperProcessFirmwareTree</a>(
01010     IN BOOLEAN OnlyProcessSerialPorts
01011     )
01012 
01013 <span class="comment">/*++</span>
01014 <span class="comment"></span>
01015 <span class="comment">Routine Description:</span>
01016 <span class="comment"></span>
01017 <span class="comment">    Query the information in the firmware tree to know what</span>
01018 <span class="comment">    system board devices were located.  This will cause a FirmwareList</span>
01019 <span class="comment">    to be created on the device extention passed.</span>
01020 <span class="comment"></span>
01021 <span class="comment">Arguments:</span>
01022 <span class="comment"></span>
01023 <span class="comment">    OnlyProcessSerialPorts - if non-zero, then we'll only look at serial ports.</span>
01024 <span class="comment">        This is done on ACPI machines where, in general, we don't want to pay</span>
01025 <span class="comment">        attention to ntdetect/firmware information (but we have to for serial</span>
01026 <span class="comment">        ports so that legacy add-in ISA serial ports and modems are detected</span>
01027 <span class="comment">        automatically as in previous versions of NT as well as Win9x).</span>
01028 <span class="comment"></span>
01029 <span class="comment">Return Value:</span>
01030 <span class="comment"></span>
01031 <span class="comment">    None</span>
01032 <span class="comment"></span>
01033 <span class="comment">--*/</span>
01034 
01035 {
01036     INTERFACE_TYPE     interfaceType;
01037     ULONG              index;
01038     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a> sc;
01039     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a> controllerTypes[] = { <a class="code" href="../../d1/d9/arc_8h.html#a315a208">PointerController</a>,
01040                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a209">KeyboardController</a>,
01041                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a207">ParallelController</a>,
01042                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a200">DiskController</a>,
01043                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a213">FloppyDiskPeripheral</a>,
01044                                              <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>   <span class="comment">// must be last</span>
01045                                            };
01046 <span class="preprocessor">#define CONTROLLER_TYPES_COUNT (sizeof(controllerTypes) / sizeof(controllerTypes[0]))</span>
01047 <span class="preprocessor"></span>
01048     <span class="comment">//</span>
01049     <span class="comment">// Locate all firmware controller information and save its resource usage.</span>
01050     <span class="comment">//</span>
01051     <span class="comment">// BUGBUG (lonnym)--it's pretty inefficient to be going through all</span>
01052     <span class="comment">// interface types, when we really only care about a very small subset of</span>
01053     <span class="comment">// non-PnP buses (e.g., ISA, EISA, maybe Internal).</span>
01054     <span class="comment">//</span>
01055 
01056     <span class="keywordflow">for</span> (interfaceType = 0; interfaceType &lt; MaximumInterfaceType; interfaceType++) {
01057 
01058         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_VERBOSE,
01059                     <span class="stringliteral">"Mapper: searching on interface ===&gt; %d\n"</span>,
01060                     interfaceType));
01061 
01062         <span class="keywordflow">if</span>(OnlyProcessSerialPorts) {
01063 
01064             <span class="comment">//</span>
01065             <span class="comment">// Start out at the last element of the array, so we only process</span>
01066             <span class="comment">// SerialControllers.</span>
01067             <span class="comment">//</span>
01068 
01069             index = <a class="code" href="../../d2/d5/mapper_8c.html#a10">CONTROLLER_TYPES_COUNT</a> - 1;
01070         } <span class="keywordflow">else</span> {
01071             index = 0;
01072         }
01073 
01074         <span class="keywordflow">for</span> ( ; index &lt; <a class="code" href="../../d2/d5/mapper_8c.html#a10">CONTROLLER_TYPES_COUNT</a>; index++) {
01075             sc = controllerTypes[index];
01076 
01077             <a class="code" href="../../d2/d3/io_2query_8c.html#a6">IoQueryDeviceDescription</a>(&amp;interfaceType,
01078                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01079                                      &amp;sc,
01080                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01081                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01082                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01083                                      <a class="code" href="../../d2/d5/mapper_8c.html#a39">MapperCallback</a>,
01084                                      &amp;<a class="code" href="../../d2/d5/mapper_8c.html#a25">MapperDeviceExtension</a>);
01085         }
01086     }
01087 }
01088 
01089 
01090 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01091"></a><a class="code" href="../../d2/d5/mapper_8c.html#a40">01091</a> <a class="code" href="../../d2/d5/mapper_8c.html#a40">MapperMarkKey</a>(
01092     IN HANDLE           Handle,
01093     IN PUNICODE_STRING  PathName,
01094     IN PFIRMWARE_CONFIGURATION FirmwareEntry
01095     )
01096 
01097 <span class="comment">/*++</span>
01098 <span class="comment"></span>
01099 <span class="comment">Routine Description:</span>
01100 <span class="comment"></span>
01101 <span class="comment">    Record in the root enum key that the firmware mapper found this entry.</span>
01102 <span class="comment">    Migrate configuration information entries.</span>
01103 <span class="comment"></span>
01104 <span class="comment">Arguments:</span>
01105 <span class="comment"></span>
01106 <span class="comment">    Handle   - handle to the key</span>
01107 <span class="comment">    PathName - base path name to this key</span>
01108 <span class="comment">    FirmwareEntry - information from the firmware tree.</span>
01109 <span class="comment"></span>
01110 <span class="comment">Return Value:</span>
01111 <span class="comment"></span>
01112 <span class="comment">    None</span>
01113 <span class="comment"></span>
01114 <span class="comment">--*/</span>
01115 
01116 {
01117     OBJECT_ATTRIBUTES objectAttributes;
01118     PCM_RESOURCE_LIST resourceList;
01119     UNICODE_STRING    unicodeName;
01120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          status;
01121     HANDLE            subKeyHandle;
01122     PWCHAR            wcptr;
01123     ULONG             disposition;
01124     ULONG             buffer;
01125     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>            originalLength;
01126 
01127     <span class="comment">//</span>
01128     <span class="comment">// Mark that this entry was in the firmware tree.</span>
01129     <span class="comment">//</span>
01130 
01131     buffer = 1;
01132     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_FIRMWAREIDENTIFIED);
01133 
01134     ZwSetValueKey(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01135                   &amp;unicodeName,
01136                   0,
01137                   REG_DWORD,
01138                   &amp;buffer,
01139                   <span class="keyword">sizeof</span>(ULONG));
01140 
01141     <span class="comment">//</span>
01142     <span class="comment">// Create the control subkey</span>
01143     <span class="comment">//</span>
01144 
01145     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_INFORMATION,
01146                 <span class="stringliteral">"Mapper: marking existing key\n"</span>));
01147     originalLength = PathName-&gt;Length;
01148     wcptr = (PWCHAR) ((PUCHAR)PathName-&gt;Buffer + PathName-&gt;Length);
01149     wcptr++; <span class="comment">// locate eos</span>
01150 
01151     <span class="comment">//</span>
01152     <span class="comment">// Build the volatile control key</span>
01153     <span class="comment">//</span>
01154 
01155     InitializeObjectAttributes(&amp;objectAttributes,
01156                                PathName,
01157                                OBJ_CASE_INSENSITIVE,
01158                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01159                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01160     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(PathName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Control"</span>);
01161     status = ZwCreateKey(&amp;subKeyHandle,
01162                          KEY_READ | KEY_WRITE,
01163                          &amp;objectAttributes,
01164                          0,
01165                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01166                          REG_OPTION_VOLATILE,
01167                          &amp;disposition);
01168 
01169     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01170 
01171         <span class="comment">//</span>
01172         <span class="comment">// Create the found by firmware volatile.</span>
01173         <span class="comment">//</span>
01174 
01175         buffer = 1;
01176         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_FIRMWAREMEMBER);
01177 
01178         ZwSetValueKey(subKeyHandle,
01179                       &amp;unicodeName,
01180                       0,
01181                       REG_DWORD,
01182                       &amp;buffer,
01183                       <span class="keyword">sizeof</span>(ULONG));
01184         ZwClose(subKeyHandle);
01185 
01186     } <span class="keywordflow">else</span> {
01187 
01188         <span class="comment">//</span>
01189         <span class="comment">// ignore failures</span>
01190         <span class="comment">//</span>
01191 
01192         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01193                     <span class="stringliteral">"Mapper: failed to mark control key %x\n"</span>,
01194                     status));
01195     }
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// if there is a resource descriptor, restore path and open LogConf key.</span>
01199     <span class="comment">//</span>
01200 
01201     <span class="keywordflow">if</span> (FirmwareEntry-&gt;ResourceDescriptor) {
01202         PathName-&gt;Length = originalLength;
01203         *wcptr = (WCHAR) 0;
01204 
01205         InitializeObjectAttributes(&amp;objectAttributes,
01206                                    PathName,
01207                                    OBJ_CASE_INSENSITIVE,
01208                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01209                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01210         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(PathName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\LogConf"</span>);
01211         status = ZwCreateKey(&amp;subKeyHandle,
01212                              KEY_READ | KEY_WRITE,
01213                              &amp;objectAttributes,
01214                              0,
01215                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01216                              REG_OPTION_VOLATILE,
01217                              &amp;disposition);
01218 
01219         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01220             ULONG size;
01221 
01222             <span class="comment">//</span>
01223             <span class="comment">// two entries need to be made:</span>
01224             <span class="comment">// BootConfig:REG_RESOURCE_LIST</span>
01225             <span class="comment">// BasicConfigVector:REG_RESOURCE_REQUIREMENTS_LIST</span>
01226             <span class="comment">//</span>
01227 
01228             size = <span class="keyword">sizeof</span>(CM_RESOURCE_LIST) -
01229                    <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR) +
01230                    FirmwareEntry-&gt;ResourceDescriptorSize;
01231 
01232             resourceList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, size);
01233 
01234             <span class="keywordflow">if</span> (resourceList) {
01235                 PIO_RESOURCE_REQUIREMENTS_LIST reqList;
01236 
01237                 resourceList-&gt;Count = 1;
01238                 RtlMoveMemory(&amp;resourceList-&gt;List[0],
01239                               FirmwareEntry-&gt;ResourceDescriptor,
01240                               FirmwareEntry-&gt;ResourceDescriptorSize);
01241 
01242                 resourceList = <a class="code" href="../../d2/d5/mapper_8c.html#a42">MapperAdjustResourceList</a> (
01243                                    resourceList,
01244                                    FirmwareEntry-&gt;PnPId,
01245                                    &amp;size
01246                                    );
01247 
01248                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName,
01249                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"BootConfig"</span>);
01250                 ZwSetValueKey(subKeyHandle,
01251                               &amp;unicodeName,
01252                               0,
01253                               REG_RESOURCE_LIST,
01254                               resourceList,
01255                               size);
01256 <span class="preprocessor">#if 0</span>
01257 <span class="preprocessor"></span>                <span class="comment">//</span>
01258                 <span class="comment">// Now do the resource requirements list.</span>
01259                 <span class="comment">//</span>
01260 
01261                 reqList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a>(0, resourceList);
01262 
01263                 <span class="keywordflow">if</span> (reqList) {
01264                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName,
01265                                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"BasicConfigVector"</span>);
01266                     ZwSetValueKey(subKeyHandle,
01267                                   &amp;unicodeName,
01268                                   0,
01269                                   REG_RESOURCE_REQUIREMENTS_LIST,
01270                                   reqList,
01271                                   reqList-&gt;ListSize);
01272                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reqList);
01273                 }
01274 <span class="preprocessor">#endif</span>
01275 <span class="preprocessor"></span>                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceList);
01276             }
01277         } <span class="keywordflow">else</span> {
01278 
01279             <span class="comment">//</span>
01280             <span class="comment">// ignore errors</span>
01281             <span class="comment">//</span>
01282 
01283             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01284                         <span class="stringliteral">"Mapper: failed to update logconf key %x\n"</span>,
01285                         status));
01286         }
01287     }
01288 
01289     <span class="comment">//</span>
01290     <span class="comment">// Restore path passed in.</span>
01291     <span class="comment">//</span>
01292 
01293     PathName-&gt;Length = originalLength;
01294     *wcptr = (WCHAR) 0;
01295 }
01296 
01297 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01298"></a><a class="code" href="../../d2/d5/mapper_8c.html#a41">01298</a> <a class="code" href="../../d2/d5/mapper_8c.html#a41">MapperSeedKey</a>(
01299     IN HANDLE                  Handle,
01300     IN PUNICODE_STRING         PathName,
01301     IN PFIRMWARE_CONFIGURATION FirmwareEntry,
01302     IN BOOLEAN                 DeviceIsPhantom
01303     )
01304 
01305 <span class="comment">/*++</span>
01306 <span class="comment"></span>
01307 <span class="comment">Routine Description:</span>
01308 <span class="comment"></span>
01309 <span class="comment">    This routine seeds a registry key with enough information</span>
01310 <span class="comment">    to get PnP to run the class installer on the devnode.</span>
01311 <span class="comment"></span>
01312 <span class="comment">Arguments:</span>
01313 <span class="comment"></span>
01314 <span class="comment">    Handle          - handle to the key</span>
01315 <span class="comment"></span>
01316 <span class="comment">    PathName        - base path name to this key</span>
01317 <span class="comment"></span>
01318 <span class="comment">    FirmwareEntry   - information from the firmware tree</span>
01319 <span class="comment"></span>
01320 <span class="comment">    DeviceIsPhantom - if non-zero, add "Phantom" value entry so the root</span>
01321 <span class="comment">        enumerator will skip this device instance (i.e., not turn it into a</span>
01322 <span class="comment">        devnode)</span>
01323 <span class="comment"></span>
01324 <span class="comment">Return Value:</span>
01325 <span class="comment"></span>
01326 <span class="comment">    None</span>
01327 <span class="comment"></span>
01328 <span class="comment">--*/</span>
01329 
01330 {
01331 <span class="preprocessor">#define SEED_BUFFER_SIZE (512 * sizeof(WCHAR))</span>
01332 <span class="preprocessor"></span>    UNICODE_STRING    unicodeName;
01333     UNICODE_STRING    unicodeValue;
01334     OBJECT_ATTRIBUTES objectAttributes;
01335     <a class="code" href="../../d2/d5/mapper_8c.html#a22">PMAPPER_SEED</a>      valueSeed;
01336     <a class="code" href="../../d2/d5/mapper_8c.html#a24">PKEY_SEED</a>         keySeed;
01337     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          status;
01338     HANDLE            subKeyHandle;
01339     PWCHAR            pnpid;
01340     PWCHAR            buffer;
01341     PWCHAR            wcptr;
01342     ULONG             disposition;
01343     ULONG             size;
01344     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>            originalLength;
01345 
01346     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d2/d5/mapper_8c.html#a11">SEED_BUFFER_SIZE</a>);
01347     <span class="keywordflow">if</span> (!buffer) {
01348         <span class="keywordflow">return</span>;
01349     }
01350     RtlZeroMemory(buffer, <a class="code" href="../../d2/d5/mapper_8c.html#a11">SEED_BUFFER_SIZE</a>);
01351 
01352     <span class="comment">//</span>
01353     <span class="comment">// Create subkeys.</span>
01354     <span class="comment">//</span>
01355 
01356     originalLength = PathName-&gt;Length;
01357     wcptr = (PWCHAR) ((PUCHAR)PathName-&gt;Buffer + PathName-&gt;Length);
01358 
01359     <span class="keywordflow">for</span> (keySeed = <a class="code" href="../../d2/d5/mapper_8c.html#a29">MapperKeySeed</a>; keySeed-&gt;<a class="code" href="../../d6/d6/struct__KEY__SEED.html#o0">KeyName</a>; keySeed++) {
01360 
01361         <span class="comment">//</span>
01362         <span class="comment">// Reset the base path for the next key to seed.</span>
01363         <span class="comment">//</span>
01364 
01365         *wcptr = (WCHAR) 0;
01366         PathName-&gt;Length = originalLength;
01367         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(PathName, keySeed-&gt;<a class="code" href="../../d6/d6/struct__KEY__SEED.html#o0">KeyName</a>);
01368 
01369         <span class="comment">//</span>
01370         <span class="comment">// Only build a device parameters key if there is something</span>
01371         <span class="comment">// to put in the key (i.e., this is a serial or parallel port).</span>
01372         <span class="comment">//</span>
01373 
01374         <span class="keywordflow">if</span> (keySeed-&gt;<a class="code" href="../../d6/d6/struct__KEY__SEED.html#o2">Options</a> &amp; <a class="code" href="../../d2/d5/mapper_8c.html#a6">KEY_SEED_DEVICE_PARAMETERS</a>) {
01375             <span class="keywordflow">if</span> (((FirmwareEntry-&gt;ControllerType != <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>) &amp;&amp; (FirmwareEntry-&gt;ControllerType != <a class="code" href="../../d1/d9/arc_8h.html#a315a207">ParallelController</a>)) ||
01376                 !FirmwareEntry-&gt;Identifier) {
01377                 <span class="keywordflow">continue</span>;
01378             }
01379 
01380             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a304">IopOpenDeviceParametersSubkey</a>( &amp;subKeyHandle,
01381                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01382                                                     PathName,
01383                                                     KEY_READ | KEY_WRITE
01384                                                     );
01385             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01386                 status = STATUS_SUCCESS;
01387             } <span class="keywordflow">else</span> {
01388                 status = STATUS_UNSUCCESSFUL;
01389             }
01390         } <span class="keywordflow">else</span> {
01391 
01392             <span class="comment">//</span>
01393             <span class="comment">// need to construct this key.</span>
01394             <span class="comment">//</span>
01395 
01396             InitializeObjectAttributes(&amp;objectAttributes,
01397                                        PathName,
01398                                        OBJ_CASE_INSENSITIVE,
01399                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01400                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01401             status = ZwCreateKey(&amp;subKeyHandle,
01402                                  KEY_READ | KEY_WRITE,
01403                                  &amp;objectAttributes,
01404                                  0,
01405                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01406                                  keySeed-&gt;<a class="code" href="../../d6/d6/struct__KEY__SEED.html#o1">Attribute</a>,
01407                                  &amp;disposition);
01408         }
01409 
01410         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01411 
01412             <span class="comment">//</span>
01413             <span class="comment">// Check to see if this is the parameters key and</span>
01414             <span class="comment">// migrate the parameter information.</span>
01415             <span class="comment">//</span>
01416 
01417             <span class="keywordflow">if</span> (keySeed-&gt;<a class="code" href="../../d6/d6/struct__KEY__SEED.html#o2">Options</a> &amp; <a class="code" href="../../d2/d5/mapper_8c.html#a6">KEY_SEED_DEVICE_PARAMETERS</a>) {
01418 
01419                 <span class="keywordflow">if</span> (FirmwareEntry-&gt;ControllerType == <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>)  {
01420 
01421                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a51">ComPortDBAdd</a>(subKeyHandle, (PWSTR)FirmwareEntry-&gt;Identifier);
01422                 } <span class="keywordflow">else</span> {
01423                     <span class="comment">//</span>
01424                     <span class="comment">// to get here there must be identifier information</span>
01425                     <span class="comment">// in the FirmwareEntry, so that check is not performed.</span>
01426                     <span class="comment">//</span>
01427                     <span class="comment">// NOTE: this will only happen once - when the key is</span>
01428                     <span class="comment">// created -- perhaps this needs to happen on every</span>
01429                     <span class="comment">// boot.</span>
01430                     <span class="comment">//</span>
01431 
01432                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName,
01433                                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PortName"</span>);
01434                     ZwSetValueKey(subKeyHandle,
01435                                 &amp;unicodeName,
01436                                 0,
01437                                 FirmwareEntry-&gt;IdentifierType,
01438                                 FirmwareEntry-&gt;Identifier,
01439                                 FirmwareEntry-&gt;IdentifierLength);
01440                 }
01441             }
01442             ZwClose(subKeyHandle);
01443         } <span class="keywordflow">else</span> {
01444 
01445             <span class="comment">//</span>
01446             <span class="comment">// ignore failures</span>
01447             <span class="comment">//</span>
01448 
01449             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01450                         <span class="stringliteral">"Mapper: failed to build control key %x\n"</span>,
01451                         status));
01452         }
01453     }
01454 
01455     <span class="comment">//</span>
01456     <span class="comment">// Undo the mangling of the path name performed in the loop above.</span>
01457     <span class="comment">//</span>
01458 
01459     *wcptr = (WCHAR) 0;
01460     PathName-&gt;Length = originalLength;
01461 
01462     <span class="comment">//</span>
01463     <span class="comment">// Create values.</span>
01464     <span class="comment">//</span>
01465 
01466     pnpid = FirmwareEntry-&gt;PnPId;
01467     <span class="keywordflow">for</span> (valueSeed = <a class="code" href="../../d2/d5/mapper_8c.html#a28">MapperValueSeed</a>; valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o0">ValueName</a>; valueSeed++) {
01468 
01469         <span class="keywordflow">if</span> (valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o1">ValueType</a> == REG_DWORD) {
01470 
01471             <span class="keywordflow">if</span> ((valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o3">Options</a> == <a class="code" href="../../d2/d5/mapper_8c.html#a4">OPTIONS_INSERT_PHANTOM_MARKER</a>) &amp;&amp;
01472                 !DeviceIsPhantom) {
01473 
01474                 <span class="comment">//</span>
01475                 <span class="comment">// Device isn't a phantom--we don't want to mark it as such.</span>
01476                 <span class="comment">//</span>
01477 
01478                 <span class="keywordflow">continue</span>;
01479             }
01480 
01481             size = <span class="keyword">sizeof</span>(ULONG);
01482             RtlMoveMemory(buffer, &amp;valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o2">DwordValueContent</a>, size);
01483 
01484         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o3">Options</a> == <a class="code" href="../../d2/d5/mapper_8c.html#a1">OPTIONS_INSERT_PNP_ID</a>) {
01485 
01486             size = (wcslen(pnpid) + 2) * <span class="keyword">sizeof</span>(WCHAR); <span class="comment">// eos multi_sz</span>
01487             <span class="keywordflow">if</span> (FirmwareEntry-&gt;BusType == Eisa) {
01488 
01489                 <span class="comment">//</span>
01490                 <span class="comment">// need a mult_sz of EISA\PNPblah *PNPblah</span>
01491                 <span class="comment">//</span>
01492 
01493                 RtlZeroMemory(buffer, <a class="code" href="../../d2/d5/mapper_8c.html#a11">SEED_BUFFER_SIZE</a>);
01494                 wcptr = pnpid;
01495                 wcptr++;
01496                 swprintf(buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EISA\\%s"</span>, wcptr);
01497 
01498                 wcptr = buffer;
01499                 <span class="keywordflow">while</span> (*wcptr) {
01500                     wcptr++;
01501                 }
01502                 wcptr++; <span class="comment">// step past eos for 1st string</span>
01503 
01504                 RtlMoveMemory(wcptr, pnpid, size);
01505 
01506                 size += (ULONG)((PUCHAR)wcptr - (PUCHAR)buffer);
01507             } <span class="keywordflow">else</span> {
01508                 RtlMoveMemory(buffer, pnpid, size - <span class="keyword">sizeof</span>(WCHAR));
01509                 buffer[size / <span class="keyword">sizeof</span>(WCHAR) - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01510             }
01511         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o3">Options</a> == <a class="code" href="../../d2/d5/mapper_8c.html#a3">OPTIONS_INSERT_COMPATIBLE_IDS</a>) {
01512             <span class="keywordflow">if</span> (FirmwareEntry-&gt;PeripheralType == <a class="code" href="../../d1/d9/arc_8h.html#a315a219">KeyboardPeripheral</a>)  {
01513                 size = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/mapper_8c.html#a7">PS2_KEYBOARD_COMPATIBLE_ID</a>);
01514                 RtlMoveMemory(buffer, <a class="code" href="../../d2/d5/mapper_8c.html#a7">PS2_KEYBOARD_COMPATIBLE_ID</a>, size);
01515             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FirmwareEntry-&gt;PeripheralType == <a class="code" href="../../d1/d9/arc_8h.html#a315a218">PointerPeripheral</a> &amp;&amp;
01516                        (wcscmp(pnpid, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F0E"</span>) == 0 ||
01517                         wcscmp(pnpid, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F03"</span>) == 0 ||
01518                         wcscmp(pnpid, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F12"</span>) == 0)) {
01519                 size = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/mapper_8c.html#a8">PS2_MOUSE_COMPATIBLE_ID</a>);
01520                 RtlMoveMemory(buffer, <a class="code" href="../../d2/d5/mapper_8c.html#a8">PS2_MOUSE_COMPATIBLE_ID</a>, size);
01521             } <span class="keywordflow">else</span> {
01522                 <span class="keywordflow">continue</span>;
01523             }
01524             buffer[size / 2] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;  <span class="comment">// 2nd NUL for MULTI_SZ</span>
01525             size += <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>);
01526         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o3">Options</a> == <a class="code" href="../../d2/d5/mapper_8c.html#a2">OPTIONS_INSERT_DEVICEDESC</a>) {
01527             size = FirmwareEntry-&gt;IdentifierLength;
01528             RtlMoveMemory(buffer, FirmwareEntry-&gt;Identifier, size);
01529         } <span class="keywordflow">else</span> {
01530             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR, <span class="stringliteral">"Mapper: NO VALUE TYPE!\n"</span>));
01531             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01532             <span class="keywordflow">continue</span>;
01533         }
01534 
01535         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName,
01536                              valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o0">ValueName</a>);
01537         ZwSetValueKey(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01538                       &amp;unicodeName,
01539                       0,
01540                       valueSeed-&gt;<a class="code" href="../../d7/d6/struct__MAPPER__SEED.html#o1">ValueType</a>,
01541                       buffer,
01542                       size);
01543     }
01544     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01545 }
01546 
01547 
01548 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01549"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a340">01549</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a340">MapperFreeList</a>(
01550     VOID
01551     )
01552 
01553 <span class="comment">/*++</span>
01554 <span class="comment"></span>
01555 <span class="comment">Routine Description:</span>
01556 <span class="comment"></span>
01557 <span class="comment">    This routine walks through the list of firmware entries</span>
01558 <span class="comment">    and frees all allocated memory.</span>
01559 <span class="comment"></span>
01560 <span class="comment">Arguments:</span>
01561 <span class="comment"></span>
01562 <span class="comment">    None</span>
01563 <span class="comment"></span>
01564 <span class="comment">Return Value:</span>
01565 <span class="comment"></span>
01566 <span class="comment">    None</span>
01567 <span class="comment"></span>
01568 <span class="comment">--*/</span>
01569 
01570 {
01571     <a class="code" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a>       deviceExtension = &amp;<a class="code" href="../../d2/d5/mapper_8c.html#a25">MapperDeviceExtension</a>;
01572     <a class="code" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a> tempEntry;
01573     <a class="code" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a> firmwareEntry;
01574 
01575     firmwareEntry = deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">FirmwareList</a>;
01576     <span class="keywordflow">while</span> (firmwareEntry) {
01577 
01578         <span class="comment">//</span>
01579         <span class="comment">// free allocated structures associated with the firmware entry</span>
01580         <span class="comment">//</span>
01581 
01582         <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">ResourceDescriptor</a>) {
01583             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">ResourceDescriptor</a>);
01584         }
01585         <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>) {
01586             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>);
01587         }
01588 
01589         <span class="comment">//</span>
01590         <span class="comment">// free this entry and move to the next</span>
01591         <span class="comment">//</span>
01592 
01593         tempEntry = firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o0">Next</a>;
01594         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(firmwareEntry);
01595         firmwareEntry = tempEntry;
01596     }
01597 }
01598 
01599 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01600"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a339">01600</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a339">MapperConstructRootEnumTree</a>(
01601     IN BOOLEAN CreatePhantomDevices
01602     )
01603 
01604 <span class="comment">/*++</span>
01605 <span class="comment"></span>
01606 <span class="comment">Routine Description:</span>
01607 <span class="comment"></span>
01608 <span class="comment">    This routine walks through the list of firmware entries</span>
01609 <span class="comment">    in the device extension and migrates the information into</span>
01610 <span class="comment">    the root enumerator's tree in the registry.</span>
01611 <span class="comment"></span>
01612 <span class="comment">Arguments:</span>
01613 <span class="comment"></span>
01614 <span class="comment">    CreatePhantomDevices - If non-zero, then the device instances are created</span>
01615 <span class="comment">        as "phantoms" (i.e., they are marked with the "Phantom" value entry so</span>
01616 <span class="comment">        that the root enumerator will ignore them).  The only time these device</span>
01617 <span class="comment">        instance registry keys will ever turn into real live devnodes is if the</span>
01618 <span class="comment">        class installer (in response to DIF_FIRSTTIMESETUP or DIF_DETECT)</span>
01619 <span class="comment">        decides that these devices aren't duplicates of any PnP-enumerated</span>
01620 <span class="comment">        devnodes, and subsequently registers and installs them.</span>
01621 <span class="comment"></span>
01622 <span class="comment">Return Value:</span>
01623 <span class="comment"></span>
01624 <span class="comment">    None</span>
01625 <span class="comment"></span>
01626 <span class="comment">--*/</span>
01627 
01628 {
01629 <span class="preprocessor">#define ENUM_KEY_BUFFER_SIZE (1024 * sizeof(WCHAR))</span>
01630 <span class="preprocessor"></span><span class="preprocessor">#define INSTANCE_BUFFER_SIZE (256 * sizeof(WCHAR))</span>
01631 <span class="preprocessor"></span>    UNICODE_STRING          enumKey;
01632     <a class="code" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a> firmwareEntry;
01633     OBJECT_ATTRIBUTES       objectAttributes;
01634     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
01635     BOOLEAN                 keyPresent;
01636     PWCHAR                  registryBase;
01637     PWCHAR                  instanceBuffer;
01638     HANDLE                  handle;
01639     ULONG                   disposition;
01640     PVOID                   buffer;
01641     <a class="code" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a>       DeviceExtension = &amp;<a class="code" href="../../d2/d5/mapper_8c.html#a25">MapperDeviceExtension</a>;
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">// allocate space needed for the registry path into the root</span>
01645     <span class="comment">// enumerator tree.  Note, limited size on path length.</span>
01646     <span class="comment">//</span>
01647 
01648     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>);
01649 
01650     <span class="keywordflow">if</span> (!buffer) {
01651         <a class="code" href="../../d9/d0/pnpiop_8h.html#a340">MapperFreeList</a>();
01652         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01653                     <span class="stringliteral">"Mapper: could not allocate memory for registry update\n"</span>));
01654         <span class="keywordflow">return</span>;
01655     }
01656 
01657     instanceBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d2/d5/mapper_8c.html#a13">INSTANCE_BUFFER_SIZE</a>);
01658     <span class="keywordflow">if</span> (!instanceBuffer) {
01659         <a class="code" href="../../d9/d0/pnpiop_8h.html#a340">MapperFreeList</a>();
01660         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01661         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01662                     <span class="stringliteral">"Mapper: could not allocate memory for instance buffer\n"</span>));
01663         <span class="keywordflow">return</span>;
01664     }
01665 
01666     InitializeObjectAttributes(&amp;objectAttributes,
01667                                &amp;enumKey,
01668                                OBJ_CASE_INSENSITIVE,
01669                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01670                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01671 
01672 <span class="preprocessor">#if UMODETEST</span>
01673 <span class="preprocessor"></span>    registryBase = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\TestControlSet\\Enum\\Root\\"</span>;
01674 <span class="preprocessor">#else</span>
01675 <span class="preprocessor"></span>    registryBase = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Enum\\Root\\"</span>;
01676 <span class="preprocessor">#endif</span>
01677 <span class="preprocessor"></span>
01678     firmwareEntry = DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">FirmwareList</a>;
01679     <span class="keywordflow">while</span> (firmwareEntry) {
01680 
01681         <span class="comment">//</span>
01682         <span class="comment">// Construct the base for the path for this entry.</span>
01683         <span class="comment">//</span>
01684 
01685 
01686         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;enumKey, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01687         enumKey.MaximumLength = <a class="code" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>;
01688         enumKey.Buffer = buffer;
01689         RtlZeroMemory(buffer, <a class="code" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>);
01690         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, registryBase);
01691         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a>);
01692 
01693         <span class="comment">//</span>
01694         <span class="comment">// Build the pnp Key.</span>
01695         <span class="comment">//</span>
01696 
01697         status = ZwCreateKey(&amp;handle,
01698                              KEY_READ | KEY_WRITE,
01699                              &amp;objectAttributes,
01700                              0,
01701                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01702                              REG_OPTION_NON_VOLATILE,
01703                              &amp;disposition);
01704 
01705         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01706 
01707             <span class="comment">//</span>
01708             <span class="comment">// Do not need the handle, so close it</span>
01709             <span class="comment">// Remember if the key was present prior to call</span>
01710             <span class="comment">//</span>
01711 
01712             ZwClose(handle);
01713             keyPresent = (disposition == REG_OPENED_EXISTING_KEY) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01714             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_INFORMATION,
01715                         <span class="stringliteral">"Mapper: Key was %s\n"</span>,
01716                         keyPresent ? <span class="stringliteral">"Present"</span> : <span class="stringliteral">"Created"</span>));
01717 
01718             <span class="comment">//</span>
01719             <span class="comment">// Construct the instance name.</span>
01720             <span class="comment">//</span>
01721 
01722             RtlZeroMemory(instanceBuffer, <a class="code" href="../../d2/d5/mapper_8c.html#a13">INSTANCE_BUFFER_SIZE</a>);
01723             swprintf(instanceBuffer,
01724                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\%d_%d_%d_%d_%d_%d"</span>,
01725                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o1">BusType</a>,
01726                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o2">BusNumber</a>,
01727                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">ControllerType</a>,
01728                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o4">ControllerNumber</a>,
01729                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o5">PeripheralType</a>,
01730                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o6">PeripheralNumber</a>);
01731             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, instanceBuffer);
01732 
01733             status = ZwCreateKey(&amp;handle,
01734                                  KEY_READ | KEY_WRITE,
01735                                  &amp;objectAttributes,
01736                                  0,
01737                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01738                                  REG_OPTION_NON_VOLATILE,
01739                                  &amp;disposition);
01740 
01741             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01742 
01743                 <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">ResourceDescriptor</a>) {
01744                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_INFORMATION,
01745                                 <span class="stringliteral">"Mapper: firmware entry has resources %x\n"</span>,
01746                                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o9">ResourceDescriptor</a>));
01747                 }
01748 
01749                 <span class="keywordflow">if</span> (firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>) {
01750                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_INFORMATION,
01751                                 <span class="stringliteral">"Mapper: firmware entry has identifier %x\n"</span>,
01752                                 firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o12">Identifier</a>));
01753                 }
01754 
01755                 <span class="comment">//</span>
01756                 <span class="comment">// Only if this is a new entry do we see the key.</span>
01757                 <span class="comment">//</span>
01758 
01759                 <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
01760 
01761                     <span class="comment">//</span>
01762                     <span class="comment">// Remember the fact that the key was newly-created for the</span>
01763                     <span class="comment">// PnP BIOS case where we need to come along and "phantomize"</span>
01764                     <span class="comment">// all newly-created ntdetect COM ports.</span>
01765                     <span class="comment">//</span>
01766 
01767                     firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o14">NewlyCreated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01768 
01769                     <span class="comment">//</span>
01770                     <span class="comment">// Create enough information to get pnp to</span>
01771                     <span class="comment">// install drivers</span>
01772                     <span class="comment">//</span>
01773 
01774                     <a class="code" href="../../d2/d5/mapper_8c.html#a41">MapperSeedKey</a>(handle,
01775                                   &amp;enumKey,
01776                                   firmwareEntry,
01777                                   CreatePhantomDevices
01778                                  );
01779                 }
01780                 <a class="code" href="../../d2/d5/mapper_8c.html#a40">MapperMarkKey</a>(handle,
01781                               &amp;enumKey,
01782                               firmwareEntry);
01783                 ZwClose(handle);
01784 
01785             } <span class="keywordflow">else</span> {
01786                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01787                             <span class="stringliteral">"Mapper: create of instance key failed %x\n"</span>,
01788                             status));
01789             }
01790 
01791         } <span class="keywordflow">else</span> {
01792             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
01793                         <span class="stringliteral">"Mapper: create pnp key failed %x\n"</span>,
01794                         status));
01795         }
01796 
01797         firmwareEntry = firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o0">Next</a>;
01798     }
01799     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(instanceBuffer);
01800 }
01801 
01802 PCM_RESOURCE_LIST
<a name="l01803"></a><a class="code" href="../../d2/d5/mapper_8c.html#a42">01803</a> <a class="code" href="../../d2/d5/mapper_8c.html#a42">MapperAdjustResourceList</a> (
01804     IN     PCM_RESOURCE_LIST ResourceList,
01805     IN     PWCHAR            PnPId,
01806     IN OUT PULONG            Size
01807     )
01808 {
01809     PCM_PARTIAL_RESOURCE_LIST       partialResourceList;
01810     PCM_PARTIAL_RESOURCE_DESCRIPTOR problemPartialDescriptors;
01811     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptors;
01812     PCM_RESOURCE_LIST               newResourceList;
01813     ULONG                           i;
01814 
01815     newResourceList = ResourceList;
01816 
01817 <span class="preprocessor">#if _X86_</span>
01818 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> == MACHINE_TYPE_EISA) {
01819 
01820         PCM_FULL_RESOURCE_DESCRIPTOR    fullDescriptor;
01821         PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
01822         PUCHAR                          nextDescriptor;
01823         ULONG                           j;
01824         ULONG                           lastResourceIndex;
01825 
01826         fullDescriptor = &amp;ResourceList-&gt;List[0];
01827 
01828         <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
01829 
01830             partialResourceList = &amp;fullDescriptor-&gt;PartialResourceList;
01831 
01832             <span class="keywordflow">for</span> (j = 0; j &lt; partialResourceList-&gt;Count; j++) {
01833                 partialDescriptor = &amp;partialResourceList-&gt;PartialDescriptors[j];
01834 
01835                 <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypePort) {
01836                     <span class="keywordflow">if</span> (partialDescriptor-&gt;u.Port.Start.HighPart == 0 &amp;&amp;
01837                         (partialDescriptor-&gt;u.Port.Start.LowPart &amp; 0x00000300) == 0) {
01838                         partialDescriptor-&gt;Flags |= CM_RESOURCE_PORT_16_BIT_DECODE;
01839                     }
01840                 }
01841             }
01842 
01843             nextDescriptor = (PUCHAR)fullDescriptor + <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR);
01844 
01845             <span class="comment">//</span>
01846             <span class="comment">// account for any resource descriptors in addition to the single</span>
01847             <span class="comment">// imbedded one I've already accounted for (if there aren't any,</span>
01848             <span class="comment">// then I'll end up subtracting off the extra imbedded descriptor</span>
01849             <span class="comment">// from the previous step)</span>
01850             <span class="comment">//</span>
01851             <span class="comment">//</span>
01852             <span class="comment">// finally, account for any extra device specific data at the end of</span>
01853             <span class="comment">// the last partial resource descriptor (if any)</span>
01854             <span class="comment">//</span>
01855             <span class="keywordflow">if</span> (partialResourceList-&gt;Count &gt; 0) {
01856 
01857                 nextDescriptor += (partialResourceList-&gt;Count - 1) *
01858                      <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
01859 
01860                 lastResourceIndex = partialResourceList-&gt;Count - 1;
01861 
01862                 <span class="keywordflow">if</span> (partialResourceList-&gt;PartialDescriptors[lastResourceIndex].Type ==
01863                           CmResourceTypeDeviceSpecific) {
01864 
01865                     nextDescriptor += partialResourceList-&gt;PartialDescriptors[lastResourceIndex].
01866                                u.DeviceSpecificData.DataSize;
01867                 }
01868             }
01869 
01870             fullDescriptor = (PCM_FULL_RESOURCE_DESCRIPTOR)nextDescriptor;
01871         }
01872     }
01873 <span class="preprocessor">#endif</span>
01874 <span class="preprocessor"></span>
01875     <span class="keywordflow">if</span> (wcscmp(PnPId, <a class="code" href="../../d2/d5/mapper_8c.html#a34">FloppyId</a>) == 0) {
01876 
01877         <span class="keywordflow">if</span> (ResourceList-&gt;Count == 1) {
01878 
01879             partialResourceList = &amp;ResourceList-&gt;List-&gt;PartialResourceList;
01880 
01881             partialDescriptors = partialResourceList-&gt;PartialDescriptors;
01882 
01883             <span class="comment">//</span>
01884             <span class="comment">// Look for the one and only one 8 byte port resource</span>
01885             <span class="comment">//</span>
01886             problemPartialDescriptors = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01887             <span class="keywordflow">for</span> (i=0; i&lt;partialResourceList-&gt;Count; i++) {
01888 
01889                 <span class="keywordflow">if</span> ((partialDescriptors[i].Type == CmResourceTypePort) &amp;&amp;
01890                     (partialDescriptors[i].u.Port.Length == 8)) {
01891 
01892                     <span class="keywordflow">if</span> (problemPartialDescriptors == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01893 
01894                         problemPartialDescriptors = partialDescriptors + i;
01895                     } <span class="keywordflow">else</span> {
01896 
01897                         problemPartialDescriptors = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01898                         <span class="keywordflow">break</span>;
01899                     }
01900                 }
01901             }
01902 
01903             <span class="keywordflow">if</span> (problemPartialDescriptors) {
01904 
01905                 problemPartialDescriptors-&gt;u.Port.Length = 6;
01906 
01907                 newResourceList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (
01908                                       <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01909                                       *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR)
01910                                       );
01911                 <span class="keywordflow">if</span> (newResourceList) {
01912 
01913                     RtlMoveMemory (
01914                         newResourceList,
01915                         ResourceList,
01916                         *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
01917                         );
01918 
01919                     <span class="comment">//</span>
01920                     <span class="comment">// pick out the new partial resource descriptor</span>
01921                     <span class="comment">//</span>
01922                     partialDescriptors = newResourceList-&gt;List-&gt;
01923                                              PartialResourceList.PartialDescriptors;
01924                     partialDescriptors += newResourceList-&gt;List-&gt;PartialResourceList.Count;
01925 
01926                     RtlMoveMemory (
01927                         partialDescriptors,
01928                         problemPartialDescriptors,
01929                         <span class="keyword">sizeof</span>(*partialDescriptors)
01930                         );
01931 
01932                     partialDescriptors-&gt;u.Port.Start.QuadPart += 7;
01933                     partialDescriptors-&gt;u.Port.Length = 1;
01934 
01935                     <span class="comment">//</span>
01936                     <span class="comment">// we got one more now</span>
01937                     <span class="comment">//</span>
01938                     newResourceList-&gt;List-&gt;PartialResourceList.Count++;
01939                     *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
01940 
01941                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ResourceList);
01942 
01943                 } <span class="keywordflow">else</span> {
01944 
01945                     newResourceList = ResourceList;
01946                 }
01947             }
01948         }
01949     }
01950 
01951     <span class="keywordflow">return</span> newResourceList;
01952 }
01953 
01954 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01955"></a><a class="code" href="../../d2/d5/mapper_8c.html#a43">01955</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a51">ComPortDBAdd</a>(
01956     IN  HANDLE  DeviceParamKey,
01957     IN  PWSTR   PortName
01958     )
01959 {
01960     UNICODE_STRING                  portNameString;
01961     UNICODE_STRING                  portPrefixString;
01962     UNICODE_STRING                  comDBName;
01963     UNICODE_STRING                  valueName;
01964     PKEY_VALUE_PARTIAL_INFORMATION  valueInfo;
01965     ULONG                           valueInfoLength;
01966     ULONG                           returnedLength;
01967     HANDLE                          comDBKey;
01968     ULONG                           portNo;
01969     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
01970 
01971     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;portNameString, <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>);
01972 
01973     <span class="keywordflow">if</span> (portNameString.Length &gt; 3 * <span class="keyword">sizeof</span>(WCHAR)) {
01974         portNameString.Length = 3 * <span class="keyword">sizeof</span>(WCHAR);
01975     }
01976 
01977     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;portPrefixString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"COM"</span>);
01978 
01979     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(&amp;portNameString, &amp;portPrefixString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == 0) {
01980         portNo = _wtol(&amp;<a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>[3]);
01981 
01982         <span class="keywordflow">if</span> (portNo &gt; 0 &amp;&amp; portNo &lt;= 256) {
01983 
01984 <span class="preprocessor">#if UMODETEST</span>
01985 <span class="preprocessor"></span>            <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;comDBName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\TestControlSet\\Control\\COM Name Arbiter"</span>);
01986 <span class="preprocessor">#else</span>
01987 <span class="preprocessor"></span>            <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;comDBName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\COM Name Arbiter"</span>);
01988 <span class="preprocessor">#endif</span>
01989 <span class="preprocessor"></span>
01990             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;comDBKey,
01991                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01992                                              &amp;comDBName,
01993                                              KEY_ALL_ACCESS,
01994                                              REG_OPTION_NON_VOLATILE,
01995                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01996                                              );
01997 
01998             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01999 
02000                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ComDB Merge"</span>);
02001 
02002 <span class="preprocessor">#define COMPORT_DB_MERGE_SIZE    32           //  256 / 8</span>
02003 <span class="preprocessor"></span>
02004                 valueInfoLength = <span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <a class="code" href="../../d2/d5/mapper_8c.html#a14">COMPORT_DB_MERGE_SIZE</a>;
02005                 valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueInfoLength);
02006 
02007                 <span class="keywordflow">if</span> (valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02008 
02009                     status = ZwQueryValueKey( comDBKey,
02010                                               &amp;valueName,
02011                                               KeyValuePartialInformation,
02012                                               valueInfo,
02013                                               valueInfoLength,
02014                                               &amp;returnedLength);
02015 
02016                     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
02017 
02018                         valueInfo-&gt;Type = REG_BINARY;
02019                         valueInfo-&gt;DataLength = <a class="code" href="../../d2/d5/mapper_8c.html#a14">COMPORT_DB_MERGE_SIZE</a>;
02020                         RtlZeroMemory(valueInfo-&gt;Data, valueInfo-&gt;DataLength);
02021                         status = STATUS_SUCCESS;
02022                     }
02023 
02024                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02025                         portNo--;
02026                         valueInfo-&gt;Data[ portNo / 8 ] |= 1 &lt;&lt; (portNo % 8);
02027 
02028                         status = ZwSetValueKey( comDBKey,
02029                                                 &amp;valueName,
02030                                                 0,
02031                                                 valueInfo-&gt;Type,
02032                                                 valueInfo-&gt;Data,
02033                                                 valueInfo-&gt;DataLength );
02034 
02035                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02036                     }
02037 
02038                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(valueInfo);
02039                 }
02040 
02041                 ZwClose(comDBKey);
02042             }
02043         }
02044     }
02045 
02046     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PortName"</span> );
02047 
02048     status = ZwSetValueKey( DeviceParamKey,
02049                             &amp;valueName,
02050                             0,
02051                             REG_SZ,
02052                             <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>,
02053                             (wcslen(<a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>) + 1) * <span class="keyword">sizeof</span>(WCHAR) );
02054 
02055     <span class="keywordflow">return</span> status;
02056 }
02057 
02058 
02059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02060"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a342">02060</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a342">MapperPhantomizeDetectedComPorts</a> (
02061     VOID
02062     )
02063 <span class="comment">/*++</span>
02064 <span class="comment"></span>
02065 <span class="comment">Routine Description:</span>
02066 <span class="comment"></span>
02067 <span class="comment">    This routine turns all newly-created firmware/ntdetect COM ports into</span>
02068 <span class="comment">    phantoms.</span>
02069 <span class="comment"></span>
02070 <span class="comment">Arguments:</span>
02071 <span class="comment"></span>
02072 <span class="comment">    None</span>
02073 <span class="comment"></span>
02074 <span class="comment">Return Value:</span>
02075 <span class="comment"></span>
02076 <span class="comment">    None</span>
02077 <span class="comment"></span>
02078 <span class="comment">--*/</span>
02079 {
02080     <a class="code" href="../../d2/d5/mapper_8c.html#a16">PFIRMWARE_CONFIGURATION</a> firmwareEntry;
02081     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
02082     PWCHAR                  registryBase;
02083     PWCHAR                  instanceBuffer;
02084     HANDLE                  handle;
02085     PWCHAR                  buffer;
02086     <a class="code" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a>       DeviceExtension = &amp;<a class="code" href="../../d2/d5/mapper_8c.html#a25">MapperDeviceExtension</a>;
02087     UNICODE_STRING          enumKey;
02088     OBJECT_ATTRIBUTES       objectAttributes;
02089     UNICODE_STRING          unicodeName;
02090     ULONG                   <a class="code" href="../../d2/d5/i386_2kdcpuapi_8c.html#a6">regValue</a>;
02091 
02092     <span class="comment">//</span>
02093     <span class="comment">// allocate space needed for the registry path into the root</span>
02094     <span class="comment">// enumerator tree.  Note, limited size on path length.</span>
02095     <span class="comment">//</span>
02096 
02097     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>);
02098 
02099     <span class="keywordflow">if</span> (!buffer) {
02100         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
02101                     <span class="stringliteral">"Mapper: could not allocate memory for registry update\n"</span>));
02102         <span class="keywordflow">return</span>;
02103     }
02104 
02105     instanceBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d2/d5/mapper_8c.html#a13">INSTANCE_BUFFER_SIZE</a>);
02106     <span class="keywordflow">if</span> (!instanceBuffer) {
02107         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
02108         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>((MAPPER_ERROR,
02109                     <span class="stringliteral">"Mapper: could not allocate memory for instance buffer\n"</span>));
02110         <span class="keywordflow">return</span>;
02111     }
02112 
02113     InitializeObjectAttributes(&amp;objectAttributes,
02114                                &amp;enumKey,
02115                                OBJ_CASE_INSENSITIVE,
02116                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02117                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02118 
02119 <span class="preprocessor">#if UMODETEST</span>
02120 <span class="preprocessor"></span>    registryBase = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\TestControlSet\\Enum\\Root\\"</span>;
02121 <span class="preprocessor">#else</span>
02122 <span class="preprocessor"></span>    registryBase = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Enum\\Root\\"</span>;
02123 <span class="preprocessor">#endif</span>
02124 <span class="preprocessor"></span>
02125     firmwareEntry = DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o46">FirmwareList</a>;
02126     <span class="keywordflow">while</span> (firmwareEntry) {
02127 
02128         <span class="comment">//</span>
02129         <span class="comment">// Construct the base for the path for this entry.</span>
02130         <span class="comment">//</span>
02131 
02132 
02133         <span class="keywordflow">if</span> ((firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">ControllerType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a315a204">SerialController</a>) &amp;&amp;
02134             firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o14">NewlyCreated</a>) {
02135 
02136             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;enumKey, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02137             enumKey.MaximumLength = <a class="code" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>;
02138             enumKey.Buffer = buffer;
02139             RtlZeroMemory(buffer, <a class="code" href="../../d2/d5/mapper_8c.html#a12">ENUM_KEY_BUFFER_SIZE</a>);
02140             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, registryBase);
02141             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o13">PnPId</a>);
02142 
02143             <span class="comment">//</span>
02144             <span class="comment">// Construct the instance name.</span>
02145             <span class="comment">//</span>
02146 
02147             RtlZeroMemory(instanceBuffer, <a class="code" href="../../d2/d5/mapper_8c.html#a13">INSTANCE_BUFFER_SIZE</a>);
02148             swprintf(instanceBuffer,
02149                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\%d_%d_%d_%d_%d_%d"</span>,
02150                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o1">BusType</a>,
02151                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o2">BusNumber</a>,
02152                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o3">ControllerType</a>,
02153                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o4">ControllerNumber</a>,
02154                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o5">PeripheralType</a>,
02155                      firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o6">PeripheralNumber</a>);
02156             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;enumKey, instanceBuffer);
02157 
02158             status = ZwOpenKey(&amp;handle,
02159                                KEY_READ | KEY_WRITE,
02160                                &amp;objectAttributes
02161                               );
02162 
02163             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02164 
02165                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_PHANTOM);
02166                 <a class="code" href="../../d2/d5/i386_2kdcpuapi_8c.html#a6">regValue</a> = 1;
02167                 ZwSetValueKey(handle,
02168                               &amp;unicodeName,
02169                               0,
02170                               REG_DWORD,
02171                               &amp;<a class="code" href="../../d2/d5/i386_2kdcpuapi_8c.html#a6">regValue</a>,
02172                               <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/i386_2kdcpuapi_8c.html#a6">regValue</a>)
02173                              );
02174 
02175                 ZwClose(handle);
02176             }
02177         }
02178 
02179         firmwareEntry = firmwareEntry-&gt;<a class="code" href="../../d6/d2/struct__FIRMWARE__CONFIGURATION.html#o0">Next</a>;
02180     }
02181 
02182     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (buffer);
02183     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (instanceBuffer);
02184 }
02185 
02186 
02187 <span class="preprocessor">#if DBG</span>
02188 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02189 MapperDebugPrint(
02190     ULONG  DebugMask,
02191     PCCHAR DebugMessage,
02192     ...
02193     )
02194 
02195 <span class="comment">/*++</span>
02196 <span class="comment"></span>
02197 <span class="comment">Routine Description:</span>
02198 <span class="comment"></span>
02199 <span class="comment">    Debug print for the firmware mapper</span>
02200 <span class="comment"></span>
02201 <span class="comment">Arguments:</span>
02202 <span class="comment"></span>
02203 <span class="comment">    Check the mask value to see if the debug message is requested.</span>
02204 <span class="comment"></span>
02205 <span class="comment">Return Value:</span>
02206 <span class="comment"></span>
02207 <span class="comment">    None</span>
02208 <span class="comment"></span>
02209 <span class="comment">--*/</span>
02210 
02211 {
02212     va_list ap;
02213     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    buffer[256];
02214 
02215     va_start(ap, DebugMessage);
02216 
02217     <span class="keywordflow">if</span> (DebugMask &amp; MapperDebugMask) {
02218         vsprintf(buffer, DebugMessage, ap);
02219         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(buffer);
02220     }
02221 
02222     va_end(ap);
02223 
02224 }
02225 <span class="preprocessor">#endif</span>
02226 <span class="preprocessor"></span>
02227 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:42 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
