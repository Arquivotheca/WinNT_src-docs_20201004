<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: range.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>range.c</h1><a href="../../d2/d5/range_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    range.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Kernel-mode range list support for arbiters</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Andy Thornton (andrewth) 02/17/97</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="../../d3/d5/range_8h.html">range.h</a>"</span>
00023 
00024 <span class="preprocessor">#if DBG</span>
00025 <span class="preprocessor"></span>
00026 <span class="comment">//</span>
00027 <span class="comment">// Debug print level:</span>
00028 <span class="comment">//    -1 = no messages</span>
00029 <span class="comment">//     0 = vital messages only</span>
00030 <span class="comment">//     1 = call trace</span>
00031 <span class="comment">//     2 = verbose messages</span>
00032 <span class="comment">//</span>
00033 
00034 LONG RtlRangeDebugLevel = 0;
00035 
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00039 <a class="code" href="../../d2/d5/range_8c.html#a6">RtlpAddRange</a>(
00040     IN OUT PLIST_ENTRY ListHead,
00041     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry,
00042     IN ULONG AddRangeFlags
00043     );
00044 
00045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00046 <a class="code" href="../../d2/d5/range_8c.html#a7">RtlpAddToMergedRange</a>(
00047     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Merged,
00048     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry,
00049     IN ULONG AddRangeFlags
00050     );
00051 
00052 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00053 <a class="code" href="../../d2/d5/range_8c.html#a8">RtlpConvertToMergedRange</a>(
00054     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry
00055     );
00056 
00057 <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a>
00058 <a class="code" href="../../d2/d5/range_8c.html#a9">RtlpCreateRangeListEntry</a>(
00059     IN ULONGLONG Start,
00060     IN ULONGLONG End,
00061     IN UCHAR Attributes,
00062     IN PVOID UserData,
00063     IN PVOID Owner
00064     );
00065 
00066 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00067 <a class="code" href="../../d2/d5/range_8c.html#a10">RtlpAddIntersectingRanges</a>(
00068     IN PLIST_ENTRY ListHead,
00069     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> First,
00070     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry,
00071     IN ULONG AddRangeFlags
00072     );
00073 
00074 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00075 <a class="code" href="../../d2/d5/range_8c.html#a11">RtlpDeleteFromMergedRange</a>(
00076     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Delete,
00077     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Merged
00078     );
00079 
00080 <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a>
00081 <a class="code" href="../../d2/d5/range_8c.html#a12">RtlpCopyRangeListEntry</a>(
00082     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry
00083     );
00084 
00085 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00086 <a class="code" href="../../d2/d5/range_8c.html#a13">RtlpDeleteRangeListEntry</a>(
00087     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry
00088     );
00089 
00090 BOOLEAN
00091 <a class="code" href="../../d2/d5/range_8c.html#a14">RtlpIsRangeAvailable</a>(
00092     IN PRTL_RANGE_LIST_ITERATOR Iterator,
00093     IN ULONGLONG Start,
00094     IN ULONGLONG End,
00095     IN UCHAR AttributeAvailableMask,
00096     IN BOOLEAN SharedOK,
00097     IN BOOLEAN NullConflictOK,
00098     IN BOOLEAN Forward,
00099     IN PVOID Context OPTIONAL,
00100     IN PRTL_CONFLICT_RANGE_CALLBACK Callback OPTIONAL
00101     );
00102 
00103 <span class="preprocessor">#if DBG</span>
00104 <span class="preprocessor"></span>
00105 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00106 <a class="code" href="../../d2/d5/range_8c.html#a0">RtlpDumpRangeListEntry</a>(
00107     LONG Level,
00108     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry,
00109     BOOLEAN Indent
00110     );
00111 
00112 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00113 <a class="code" href="../../d2/d5/range_8c.html#a1">RtlpDumpRangeList</a>(
00114     LONG Level,
00115     PRTL_RANGE_LIST RangeList
00116     );
00117 
00118 <span class="preprocessor">#else</span>
00119 <span class="preprocessor"></span>
<a name="l00120"></a><a class="code" href="../../d2/d5/range_8c.html#a0">00120</a> <span class="preprocessor">#define RtlpDumpRangeListEntry(Level, Entry, Indent)</span>
<a name="l00121"></a><a class="code" href="../../d2/d5/range_8c.html#a1">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define RtlpDumpRangeList(Level, RangeList)</span>
00122 <span class="preprocessor"></span>
00123 <span class="preprocessor">#endif // DBG</span>
00124 <span class="preprocessor"></span>
00125 <span class="comment">//</span>
00126 <span class="comment">// Make everything pageable or init</span>
00127 <span class="comment">//</span>
00128 
00129 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00130 <span class="preprocessor"></span>
00131 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00132 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, RtlInitializeRangeListPackage)</span>
00133 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00134 <span class="preprocessor"></span>
00135 <span class="preprocessor">#pragma alloc_text(PAGE, RtlpAddRange)</span>
00136 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpAddToMergedRange)</span>
00137 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpConvertToMergedRange)</span>
00138 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpCreateRangeListEntry)</span>
00139 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpAddIntersectingRanges)</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpDeleteFromMergedRange)</span>
00141 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpCopyRangeListEntry)</span>
00142 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpDeleteRangeListEntry)</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpIsRangeAvailable)</span>
00144 <span class="preprocessor"></span>
00145 <span class="preprocessor">#if DBG</span>
00146 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpDumpRangeListEntry)</span>
00147 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlpDumpRangeList)</span>
00148 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00149 <span class="preprocessor"></span>
00150 <span class="preprocessor">#pragma alloc_text(PAGE, RtlInitializeRangeList)</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlAddRange)</span>
00152 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlDeleteRange)</span>
00153 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlDeleteOwnersRanges)</span>
00154 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlCopyRangeList)</span>
00155 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlFreeRangeList)</span>
00156 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlIsRangeAvailable)</span>
00157 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlFindRange)</span>
00158 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlGetFirstRange)</span>
00159 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlGetNextRange)</span>
00160 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlMergeRangeLists)</span>
00161 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlInvertRangeList)</span>
00162 <span class="preprocessor"></span>
00163 <span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00164 <span class="preprocessor"></span>
00165 <span class="comment">//</span>
00166 <span class="comment">// Range List memory allocation</span>
00167 <span class="comment">//</span>
00168 
00169 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00170 <span class="preprocessor"></span>
00171 <span class="comment">//</span>
00172 <span class="comment">// The kernel mode range list API uses a lookaside list to speed allocation</span>
00173 <span class="comment">// of range list entries.  The PAGED_LOOKASIDE_LIST structure should be non-paged.</span>
00174 <span class="comment">//</span>
00175 
00176 <span class="preprocessor">#define RTLP_RANGE_LIST_ENTRY_LOOKASIDE_DEPTH   16</span>
00177 <span class="preprocessor"></span>
00178 <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a> RtlpRangeListEntryLookasideList;
00179 
00180 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00181 RtlInitializeRangeListPackage(
00182     VOID
00183     )
00184 <span class="comment">/*++</span>
00185 <span class="comment"></span>
00186 <span class="comment">Routine Description:</span>
00187 <span class="comment"></span>
00188 <span class="comment">    This routine initializes the stuctures required by the range list</span>
00189 <span class="comment">    APIs.  It is called during system initialization (Phase1Initialization)</span>
00190 <span class="comment">    and should be before any of the range list apis are called.</span>
00191 <span class="comment"></span>
00192 <span class="comment">Arguments:</span>
00193 <span class="comment"></span>
00194 <span class="comment">    None.</span>
00195 <span class="comment"></span>
00196 <span class="comment">Return Value:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    None.</span>
00199 <span class="comment"></span>
00200 <span class="comment">--*/</span>
00201 {
00202     <a class="code" href="../../d5/d8/ex_8h.html#a250">ExInitializePagedLookasideList</a>(
00203         &amp;RtlpRangeListEntryLookasideList,
00204         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00205         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00206         0,
00207         <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>),
00208         <a class="code" href="../../d3/d5/range_8h.html#a1">RTL_RANGE_LIST_ENTRY_TAG</a>,
00209         RTLP_RANGE_LIST_ENTRY_LOOKASIDE_DEPTH
00210         );
00211 
00212 }
00213 
00214 <span class="comment">//</span>
00215 <span class="comment">// PRANGE_LIST_ENTRY</span>
00216 <span class="comment">// RtlpAllocateRangeListEntry(</span>
00217 <span class="comment">//     VOID</span>
00218 <span class="comment">//     )</span>
00219 <span class="comment">//</span>
00220 <span class="preprocessor">#define RtlpAllocateRangeListEntry()                                    \</span>
00221 <span class="preprocessor">    (PRTLP_RANGE_LIST_ENTRY) ExAllocateFromPagedLookasideList(          \</span>
00222 <span class="preprocessor">        &amp;RtlpRangeListEntryLookasideList                                \</span>
00223 <span class="preprocessor">        )</span>
00224 <span class="preprocessor"></span>
00225 <span class="comment">//</span>
00226 <span class="comment">// VOID</span>
00227 <span class="comment">// RtlpFreeRangeListEntry(</span>
00228 <span class="comment">//     IN PRTLP_RANGE_LIST_ENTRY Entry</span>
00229 <span class="comment">//     )</span>
00230 <span class="comment">//</span>
00231 <span class="preprocessor">#define RtlpFreeRangeListEntry(Entry)                                   \</span>
00232 <span class="preprocessor">    ExFreeToPagedLookasideList(&amp;RtlpRangeListEntryLookasideList, (Entry))</span>
00233 <span class="preprocessor"></span>
00234 
00235 <span class="comment">//</span>
00236 <span class="comment">// PVOID</span>
00237 <span class="comment">// RtlpRangeListAllocatePool(</span>
00238 <span class="comment">//     IN ULONG Size</span>
00239 <span class="comment">//     )</span>
00240 <span class="comment">//</span>
00241 <span class="preprocessor">#define RtlpRangeListAllocatePool(Size)                                 \</span>
00242 <span class="preprocessor">    ExAllocatePoolWithTag(PagedPool, (Size), RTL_RANGE_LIST_MISC_TAG)</span>
00243 <span class="preprocessor"></span>
00244 <span class="comment">//</span>
00245 <span class="comment">// VOID</span>
00246 <span class="comment">// RtlpRangeListFreePool(</span>
00247 <span class="comment">//     IN PVOID Free</span>
00248 <span class="comment">//     )</span>
00249 <span class="comment">//</span>
00250 <span class="preprocessor">#define RtlpRangeListFreePool(Free)                                     \</span>
00251 <span class="preprocessor">    ExFreePool(Free)</span>
00252 <span class="preprocessor"></span>
00253 
00254 <span class="preprocessor">#else // defined(NTOS_KERNEL_RUNTIME)</span>
00255 <span class="preprocessor"></span>
00256 
00257 <span class="comment">//</span>
00258 <span class="comment">// Usermode range lists use the standard Rtl heap for allocations</span>
00259 <span class="comment">//</span>
00260 
00261 <span class="comment">//</span>
00262 <span class="comment">// PRANGE_LIST_ENTRY</span>
00263 <span class="comment">// RtlpAllocateRangeListEntry(</span>
00264 <span class="comment">//     VOID</span>
00265 <span class="comment">//     );</span>
00266 <span class="comment">//</span>
<a name="l00267"></a><a class="code" href="../../d2/d5/range_8c.html#a2">00267</a> <span class="preprocessor">#define RtlpAllocateRangeListEntry()                                    \</span>
00268 <span class="preprocessor">    (PRTLP_RANGE_LIST_ENTRY) RtlAllocateHeap(                           \</span>
00269 <span class="preprocessor">        RtlProcessHeap(),                                               \</span>
00270 <span class="preprocessor">        RTL_RANGE_LIST_ENTRY_TAG,                                       \</span>
00271 <span class="preprocessor">        sizeof(RTLP_RANGE_LIST_ENTRY)                                   \</span>
00272 <span class="preprocessor">        )</span>
00273 <span class="preprocessor"></span>
00274 <span class="comment">//</span>
00275 <span class="comment">// VOID</span>
00276 <span class="comment">// RtlpFreeRangeListEntry(</span>
00277 <span class="comment">//     IN PRTLP_RANGE_LIST_ENTRY Entry</span>
00278 <span class="comment">//     )</span>
00279 <span class="comment">//</span>
<a name="l00280"></a><a class="code" href="../../d2/d5/range_8c.html#a3">00280</a> <span class="preprocessor">#define RtlpFreeRangeListEntry(Entry)                                   \</span>
00281 <span class="preprocessor">    RtlFreeHeap( RtlProcessHeap(), 0, (Entry) )</span>
00282 <span class="preprocessor"></span>
00283 <span class="comment">//</span>
00284 <span class="comment">// PVOID</span>
00285 <span class="comment">// RtlpRangeListAllocatePool(</span>
00286 <span class="comment">//     IN ULONG Size</span>
00287 <span class="comment">//     )</span>
00288 <span class="comment">//</span>
<a name="l00289"></a><a class="code" href="../../d2/d5/range_8c.html#a4">00289</a> <span class="preprocessor">#define RtlpRangeListAllocatePool(Size)                                 \</span>
00290 <span class="preprocessor">    RtlAllocateHeap(RtlProcessHeap(), RTL_RANGE_LIST_MISC_TAG, (Size))</span>
00291 <span class="preprocessor"></span>
00292 <span class="comment">//</span>
00293 <span class="comment">// VOID</span>
00294 <span class="comment">// RtlpRangeListFreePool(</span>
00295 <span class="comment">//     IN PVOID Free</span>
00296 <span class="comment">//     )</span>
00297 <span class="comment">//</span>
<a name="l00298"></a><a class="code" href="../../d2/d5/range_8c.html#a5">00298</a> <span class="preprocessor">#define RtlpRangeListFreePool(Free)                                     \</span>
00299 <span class="preprocessor">    RtlFreeHeap( RtlProcessHeap(), 0, (Free) )</span>
00300 <span class="preprocessor"></span>
00301 
00302 <span class="preprocessor">#endif // defined(NTOS_KERNEL_RUNTIME)</span>
00303 <span class="preprocessor"></span>
00304 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00305"></a><a class="code" href="../../d2/d5/range_8c.html#a15">00305</a> <a class="code" href="../../d2/d5/range_8c.html#a15">RtlInitializeRangeList</a>(
00306     IN OUT PRTL_RANGE_LIST RangeList
00307     )
00308 <span class="comment">/*++</span>
00309 <span class="comment"></span>
00310 <span class="comment">Routine Description:</span>
00311 <span class="comment"></span>
00312 <span class="comment">    This routine initializes a range list.  It must be called before the range</span>
00313 <span class="comment">    list is passed to any of the other range list functions.  Initially the</span>
00314 <span class="comment">    range list contains no ranges</span>
00315 <span class="comment"></span>
00316 <span class="comment">Arguments:</span>
00317 <span class="comment"></span>
00318 <span class="comment">    RangeList - Pointer to a user allocated RTL_RANGE_LIST structre to be</span>
00319 <span class="comment">        initialized.</span>
00320 <span class="comment"></span>
00321 <span class="comment">Return Value:</span>
00322 <span class="comment"></span>
00323 <span class="comment">    None.</span>
00324 <span class="comment"></span>
00325 <span class="comment">--*/</span>
00326 {
00327     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00328 
00329     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RangeList);
00330 
00331     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(1, (<span class="stringliteral">"RtlInitializeRangeList(0x%08x)\n"</span>, RangeList));
00332 
00333     InitializeListHead(&amp;RangeList-&gt;ListHead);
00334     RangeList-&gt;Flags = 0;
00335     RangeList-&gt;Count = 0;
00336     RangeList-&gt;Stamp = 0;
00337 }
00338 
00339 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00340"></a><a class="code" href="../../d2/d5/range_8c.html#a16">00340</a> <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(
00341     IN OUT PRTL_RANGE_LIST RangeList,
00342     IN ULONGLONG Start,
00343     IN ULONGLONG End,
00344     IN UCHAR Attributes,
00345     IN ULONG Flags,
00346     IN PVOID UserData, OPTIONAL
00347     IN PVOID Owner     OPTIONAL
00348     )
00349 <span class="comment">/*++</span>
00350 <span class="comment"></span>
00351 <span class="comment">Routine Description:</span>
00352 <span class="comment"></span>
00353 <span class="comment">    This routine adds a new range with the specified properties to a range list.</span>
00354 <span class="comment"></span>
00355 <span class="comment">Arguments:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    RangeList - Pointer to the range list to which the new range is to be added.</span>
00358 <span class="comment">        It must have been previously initialized using RtlInitializeRangeList.</span>
00359 <span class="comment"></span>
00360 <span class="comment">    Start - The location of the start of the new range.</span>
00361 <span class="comment"></span>
00362 <span class="comment">    End - The location of the end of the new range.</span>
00363 <span class="comment"></span>
00364 <span class="comment">    Flags - These determine the range's properties and how it is added:</span>
00365 <span class="comment"></span>
00366 <span class="comment">        RTL_RANGE_LIST_ADD_IF_CONFLICT - The range should be added even if it</span>
00367 <span class="comment">            overlaps another range.  In this case the RTL_RANGE_CONFLICT flag</span>
00368 <span class="comment">            is set.</span>
00369 <span class="comment"></span>
00370 <span class="comment">        RTL_RANGE_LIST_ADD_SHARED - The range is marked as an RTL_RANGE_SHARED</span>
00371 <span class="comment">            and will successfully be added if it overlaps another shared range.</span>
00372 <span class="comment">            It can be speficied in conjunction with the above ADD_IF_CONFLICT</span>
00373 <span class="comment">            flag in which case if the range overlaps a non-shared range it will</span>
00374 <span class="comment">            be marked as both RTL_RANGE_SHARED and RTL_RANGE_CONFLICT.</span>
00375 <span class="comment"></span>
00376 <span class="comment">    UserData - Extra data to be stored with the range.  The system will not</span>
00377 <span class="comment">        attempt to interpret it.</span>
00378 <span class="comment"></span>
00379 <span class="comment">    Owner - A cookie that represents the entity that owns this range.  (A</span>
00380 <span class="comment">        pointer to some object is the most likley).  The system will not</span>
00381 <span class="comment">        attempt to interpret it, just use it to distinguish the range from</span>
00382 <span class="comment">        another with the same start and end.</span>
00383 <span class="comment"></span>
00384 <span class="comment">Return Value:</span>
00385 <span class="comment"></span>
00386 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    STATUS_INVALID_PARAMETER</span>
00389 <span class="comment">    STATUS_RANGE_LIST_CONFLICT</span>
00390 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
00391 <span class="comment"></span>
00392 <span class="comment">--*/</span>
00393 {
00394 
00395     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00396     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> newEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00397 
00398     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00399 
00400     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(1,
00401         (<span class="stringliteral">"RtlAddRange(0x%08x, 0x%I64x, 0x%I64x, 0x%08x, 0x%08x, 0x%08x)\n"</span>,
00402         RangeList,
00403         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
00404         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
00405         Flags,
00406         UserData,
00407         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>
00408         ));
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Validate parameters</span>
00412     <span class="comment">//</span>
00413 
00414     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) {
00415         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00416     }
00417 
00418     <span class="comment">//</span>
00419     <span class="comment">// Create a new entry</span>
00420     <span class="comment">//</span>
00421 
00422     <span class="keywordflow">if</span> (!(newEntry = <a class="code" href="../../d2/d5/range_8c.html#a9">RtlpCreateRangeListEntry</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>, Attributes, UserData, <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>))) {
00423         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00424     }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Mark the new entry as shared if appropriate</span>
00428     <span class="comment">//</span>
00429 
00430     <span class="keywordflow">if</span> (Flags &amp; RTL_RANGE_LIST_ADD_SHARED) {
00431         newEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o8">PublicFlags</a> |= RTL_RANGE_SHARED;
00432     }
00433 
00434     status = <a class="code" href="../../d2/d5/range_8c.html#a6">RtlpAddRange</a>(&amp;RangeList-&gt;ListHead,
00435                         newEntry,
00436                         Flags
00437                         );
00438 
00439     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00440 
00441         <span class="comment">//</span>
00442         <span class="comment">// We added a range so bump the count</span>
00443         <span class="comment">//</span>
00444         RangeList-&gt;Count++;
00445         RangeList-&gt;Stamp++;
00446 
00447     } <span class="keywordflow">else</span> {
00448 
00449         <span class="comment">//</span>
00450         <span class="comment">// We didn't add a range so free up the entry</span>
00451         <span class="comment">//</span>
00452 
00453         <a class="code" href="../../d2/d5/range_8c.html#a3">RtlpFreeRangeListEntry</a>(newEntry);
00454     }
00455 
00456     <span class="keywordflow">return</span> status;
00457 
00458 }
00459 
00460 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00461"></a><a class="code" href="../../d2/d5/range_8c.html#a6">00461</a> <a class="code" href="../../d2/d5/range_8c.html#a6">RtlpAddRange</a>(
00462     IN OUT PLIST_ENTRY ListHead,
00463     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry,
00464     IN ULONG AddRangeFlags
00465     )
00466 <span class="comment">/*++</span>
00467 <span class="comment"></span>
00468 <span class="comment">Routine Description:</span>
00469 <span class="comment"></span>
00470 <span class="comment">    This routine implement the AddRange operation adding the range in the</span>
00471 <span class="comment">    appropriate place in the sorted range list, converting ranges to merged</span>
00472 <span class="comment">    ranges and setting RTL_RANGE_CONFLICT flags as necessary.</span>
00473 <span class="comment"></span>
00474 <span class="comment">Arguments:</span>
00475 <span class="comment"></span>
00476 <span class="comment">    ListHead - The list of the range list to which the range should be added.</span>
00477 <span class="comment"></span>
00478 <span class="comment">    Entry - The new entry to be added to the range list</span>
00479 <span class="comment"></span>
00480 <span class="comment">    AddRangeFlags - The Flags argument to RtlAddRange, see above.</span>
00481 <span class="comment"></span>
00482 <span class="comment">Return Value:</span>
00483 <span class="comment"></span>
00484 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
00485 <span class="comment"></span>
00486 <span class="comment">    STATUS_RANGE_LIST_CONFLICT</span>
00487 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
00488 <span class="comment"></span>
00489 <span class="comment">--*/</span>
00490 {
00491     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00492     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> previous, current;
00493     ULONGLONG start, end;
00494 
00495     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2,
00496                 (<span class="stringliteral">"RtlpAddRange(0x%08x, 0x%08x{0x%I64x-0x%I64x}, 0x%08x)\n"</span>,
00497                 ListHead,
00498                 Entry,
00499                 Entry-&gt;Start,
00500                 Entry-&gt;End,
00501                 AddRangeFlags
00502                 ));
00503 
00504     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00505     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry);
00506 
00507     start = Entry-&gt;Start;
00508     end = Entry-&gt;End;
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// Clear the conflict flag if it was left around</span>
00512     <span class="comment">//</span>
00513 
00514     Entry-&gt;PublicFlags &amp;= ~RTL_RANGE_CONFLICT;
00515 
00516     <span class="comment">//</span>
00517     <span class="comment">// Iterate through the list and find where to insert the entry</span>
00518     <span class="comment">//</span>
00519 
00520     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>, ListHead, current) {
00521 
00522         <span class="keywordflow">if</span> (end &lt; current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a>) {
00523 
00524             <span class="comment">//</span>
00525             <span class="comment">// The new range is completely before this one</span>
00526             <span class="comment">//</span>
00527 
00528             <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2, (<span class="stringliteral">"Completely before\n"</span>));
00529 
00530             <a class="code" href="../../d3/d5/range_8h.html#a25">InsertEntryList</a>(current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>.Blink,
00531                             &amp;Entry-&gt;ListEntry
00532                             );
00533 
00534             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00535 
00536         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a19">RANGE_INTERSECT</a>(Entry, current)) {
00537 
00538             status = <a class="code" href="../../d2/d5/range_8c.html#a10">RtlpAddIntersectingRanges</a>(ListHead,
00539                        current,
00540                        Entry,
00541                        AddRangeFlags);
00542 
00543             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00544 
00545         }
00546     }
00547 
00548     <span class="comment">//</span>
00549     <span class="comment">// New range is after all existing ranges</span>
00550     <span class="comment">//</span>
00551 
00552     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2, (<span class="stringliteral">"After all existing ranges\n"</span>));
00553 
00554     InsertTailList(ListHead,
00555                    &amp;Entry-&gt;ListEntry
00556                   );
00557 
00558 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00559 
00560     <span class="keywordflow">return</span> status;
00561 
00562 }
00563 
00564 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00565"></a><a class="code" href="../../d2/d5/range_8c.html#a7">00565</a> <a class="code" href="../../d2/d5/range_8c.html#a7">RtlpAddToMergedRange</a>(
00566     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Merged,
00567     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry,
00568     IN ULONG AddRangeFlags
00569     )
00570 <span class="comment">/*++</span>
00571 <span class="comment"></span>
00572 <span class="comment">Routine Description:</span>
00573 <span class="comment"></span>
00574 <span class="comment">    This routine adds a new range to a merged range, setting the</span>
00575 <span class="comment">    RTL_RANGE_CONFLICT flags if necessary.</span>
00576 <span class="comment"></span>
00577 <span class="comment">Arguments:</span>
00578 <span class="comment"></span>
00579 <span class="comment">    Merged - The merged range to which Entry should be added.</span>
00580 <span class="comment"></span>
00581 <span class="comment">    Entry - The new entry to be added to the range list</span>
00582 <span class="comment"></span>
00583 <span class="comment">    AddRangeFlags - The Flags argument to RtlAddRange, see above.</span>
00584 <span class="comment"></span>
00585 <span class="comment">Return Value:</span>
00586 <span class="comment"></span>
00587 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
00588 <span class="comment"></span>
00589 <span class="comment">    STATUS_RANGE_LIST_CONFLICT - indictates that the range was not added because</span>
00590 <span class="comment">        it conflicted with another range and conflicts are not allowed</span>
00591 <span class="comment"></span>
00592 <span class="comment">--*/</span>
00593 {
00594     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current;
00595     PLIST_ENTRY insert = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00596     BOOLEAN entryShared;
00597 
00598     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00599     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Merged);
00600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry);
00601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(Merged));
00602 
00603     entryShared = <a class="code" href="../../d3/d5/range_8h.html#a6">SHARED</a>(Entry);
00604 
00605     <span class="comment">//</span>
00606     <span class="comment">// Insert it into the merged list, this is sorted in order of start</span>
00607     <span class="comment">//</span>
00608 
00609     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>, &amp;Merged-&gt;Merged.ListHead, current) {
00610 
00611         <span class="comment">//</span>
00612         <span class="comment">// Do we conflict?</span>
00613         <span class="comment">//</span>
00614 
00615         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a19">RANGE_INTERSECT</a>(current, Entry)
00616         &amp;&amp; !(entryShared &amp;&amp; <a class="code" href="../../d3/d5/range_8h.html#a6">SHARED</a>(current))) {
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// Are conflicts ok?</span>
00620             <span class="comment">//</span>
00621 
00622             <span class="keywordflow">if</span> (AddRangeFlags &amp; RTL_RANGE_LIST_ADD_IF_CONFLICT) {
00623 
00624                 <span class="comment">//</span>
00625                 <span class="comment">// Yes - Mark both entries as conflicting</span>
00626                 <span class="comment">//</span>
00627 
00628                 current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o8">PublicFlags</a> |= RTL_RANGE_CONFLICT;
00629                 Entry-&gt;PublicFlags |= RTL_RANGE_CONFLICT;
00630 
00631             } <span class="keywordflow">else</span> {
00632 
00633                 <span class="comment">//</span>
00634                 <span class="comment">// No - Fail</span>
00635                 <span class="comment">//</span>
00636 
00637                 <span class="keywordflow">return</span> STATUS_RANGE_LIST_CONFLICT;
00638 
00639             }
00640         }
00641 
00642         <span class="comment">//</span>
00643         <span class="comment">// Have we not yet found the insertion point and just passed it?</span>
00644         <span class="comment">//</span>
00645 
00646         <span class="keywordflow">if</span> (!insert &amp;&amp; current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a> &gt; Entry-&gt;Start) {
00647 
00648             <span class="comment">//</span>
00649             <span class="comment">// Insert is before current</span>
00650             <span class="comment">//</span>
00651 
00652             insert = current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>.Blink;
00653         }
00654     }
00655 
00656     <span class="comment">//</span>
00657     <span class="comment">// Did we find where to insert the new range?</span>
00658     <span class="comment">//</span>
00659 
00660     <span class="keywordflow">if</span> (!insert) {
00661 
00662         <span class="comment">//</span>
00663         <span class="comment">// New range is after all existing ranges</span>
00664         <span class="comment">//</span>
00665 
00666         InsertTailList(&amp;Merged-&gt;Merged.ListHead,
00667                        &amp;Entry-&gt;ListEntry
00668                       );
00669 
00670     } <span class="keywordflow">else</span> {
00671 
00672         <span class="comment">//</span>
00673         <span class="comment">// Insert in the list</span>
00674         <span class="comment">//</span>
00675 
00676         <a class="code" href="../../d3/d5/range_8h.html#a25">InsertEntryList</a>(insert,
00677                         &amp;Entry-&gt;ListEntry
00678                         );
00679     }
00680 
00681 
00682     <span class="comment">//</span>
00683     <span class="comment">// Expand the merged range if necessary</span>
00684     <span class="comment">//</span>
00685 
00686     <span class="keywordflow">if</span> (Entry-&gt;Start &lt; Merged-&gt;Start) {
00687         Merged-&gt;Start = Entry-&gt;Start;
00688     }
00689 
00690     <span class="keywordflow">if</span> (Entry-&gt;End &gt; Merged-&gt;End) {
00691         Merged-&gt;End = Entry-&gt;End;
00692     }
00693 
00694     <span class="comment">//</span>
00695     <span class="comment">// If we just added a shared range to a completely shared merged</span>
00696     <span class="comment">// range then the shared flag can stay otherwise it must go</span>
00697     <span class="comment">//</span>
00698 
00699     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a6">SHARED</a>(Merged) &amp;&amp; !entryShared) {
00700 
00701         <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2,
00702             (<span class="stringliteral">"RtlpAddToMergedRange: Merged range no longer completely shared\n"</span>));
00703 
00704         Merged-&gt;PublicFlags &amp;= ~RTL_RANGE_SHARED;
00705     }
00706 
00707     <span class="keywordflow">return</span> STATUS_SUCCESS;
00708 }
00709 
00710 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00711"></a><a class="code" href="../../d2/d5/range_8c.html#a8">00711</a> <a class="code" href="../../d2/d5/range_8c.html#a8">RtlpConvertToMergedRange</a>(
00712     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry
00713     )
00714 <span class="comment">/*++</span>
00715 <span class="comment"></span>
00716 <span class="comment">Routine Description:</span>
00717 <span class="comment"></span>
00718 <span class="comment">    This converts a non-merged range into a merged range with one member, the</span>
00719 <span class="comment">    range that was just converted.</span>
00720 <span class="comment"></span>
00721 <span class="comment">Arguments:</span>
00722 <span class="comment"></span>
00723 <span class="comment">    Entry - The entry to be converted into a merged range.</span>
00724 <span class="comment"></span>
00725 <span class="comment">Return Value:</span>
00726 <span class="comment"></span>
00727 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
00728 <span class="comment"></span>
00729 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
00730 <span class="comment"></span>
00731 <span class="comment">--*/</span>
00732 {
00733     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> newEntry;
00734 
00735     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00736     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry);
00737     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(Entry));
00738     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d3/d5/range_8h.html#a7">CONFLICT</a>(Entry));
00739 
00740     <span class="comment">//</span>
00741     <span class="comment">// Create a new entry</span>
00742     <span class="comment">//</span>
00743 
00744     <span class="keywordflow">if</span> (!(newEntry = <a class="code" href="../../d2/d5/range_8c.html#a12">RtlpCopyRangeListEntry</a>(Entry))) {
00745         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00746     }
00747 
00748     <span class="comment">//</span>
00749     <span class="comment">// Convert the current entry into a merged one NB. Throw away all the</span>
00750     <span class="comment">// private flags but leave the public ones as they can only be shared.</span>
00751     <span class="comment">//</span>
00752 
00753     InitializeListHead(&amp;Entry-&gt;Merged.ListHead);
00754     Entry-&gt;PrivateFlags = <a class="code" href="../../d3/d5/range_8h.html#a4">RTLP_RANGE_LIST_ENTRY_MERGED</a>;
00755 
00756     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry-&gt;PublicFlags == RTL_RANGE_SHARED || Entry-&gt;PublicFlags == 0);
00757 
00758     <span class="comment">//</span>
00759     <span class="comment">// Add the range</span>
00760     <span class="comment">//</span>
00761 
00762     InsertHeadList(&amp;Entry-&gt;Merged.ListHead,
00763                    &amp;newEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>
00764                    );
00765 
00766 
00767     <span class="keywordflow">return</span> STATUS_SUCCESS;
00768 }
00769 
00770 <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a>
<a name="l00771"></a><a class="code" href="../../d2/d5/range_8c.html#a9">00771</a> <a class="code" href="../../d2/d5/range_8c.html#a9">RtlpCreateRangeListEntry</a>(
00772     IN ULONGLONG Start,
00773     IN ULONGLONG End,
00774     IN UCHAR Attributes,
00775     IN PVOID UserData,
00776     IN PVOID Owner
00777     )
00778 <span class="comment">/*++</span>
00779 <span class="comment"></span>
00780 <span class="comment">Routine Description:</span>
00781 <span class="comment"></span>
00782 <span class="comment">    This routine allocates a new range list entry and fills it in the the data</span>
00783 <span class="comment">    provided.</span>
00784 <span class="comment"></span>
00785 <span class="comment">Arguments:</span>
00786 <span class="comment"></span>
00787 <span class="comment">    Start - The location of the start of the new range.</span>
00788 <span class="comment"></span>
00789 <span class="comment">    End - The location of the end of the new range.</span>
00790 <span class="comment"></span>
00791 <span class="comment">    Attributes - Extra data (normally flags) to be stored with the range. The</span>
00792 <span class="comment">        system will not attempt to interpret it.</span>
00793 <span class="comment"></span>
00794 <span class="comment">    UserData - Extra data to be stored with the range.  The system will not</span>
00795 <span class="comment">        attempt to interpret it.</span>
00796 <span class="comment"></span>
00797 <span class="comment">    Owner - A cookie that represents the entity that owns this range.  (A</span>
00798 <span class="comment">        pointer to some object is the most likley).  The system will not</span>
00799 <span class="comment">        attempt to interpret it, just use it to distinguish the range from</span>
00800 <span class="comment">        another with the same start and end.</span>
00801 <span class="comment"></span>
00802 <span class="comment">Return Value:</span>
00803 <span class="comment"></span>
00804 <span class="comment">    Pointer to the new range list entry or NULL if a new entry could not be</span>
00805 <span class="comment">    allocated.</span>
00806 <span class="comment"></span>
00807 <span class="comment">--*/</span>
00808 {
00809     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> entry;
00810 
00811     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00812     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>);
00813 
00814     <span class="comment">//</span>
00815     <span class="comment">// Allocate a new entry</span>
00816     <span class="comment">//</span>
00817 
00818     <span class="keywordflow">if</span> (entry = <a class="code" href="../../d2/d5/range_8c.html#a2">RtlpAllocateRangeListEntry</a>()) {
00819 
00820         <span class="comment">//</span>
00821         <span class="comment">// Fill in the details</span>
00822         <span class="comment">//</span>
00823 
00824 <span class="preprocessor">#if DBG</span>
00825 <span class="preprocessor"></span>        entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00826         entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00827 <span class="preprocessor">#endif</span>
00828 <span class="preprocessor"></span>
00829         entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o8">PublicFlags</a> = 0;
00830         entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o9">PrivateFlags</a> = 0;
00831         entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00832         entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o1">End</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00833         entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o4">Allocated</a>.UserData = UserData;
00834         entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o4">Allocated</a>.Owner = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00835         entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o7">Attributes</a> = Attributes;
00836     }
00837 
00838     <span class="keywordflow">return</span> entry;
00839 
00840 }
00841 
00842 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00843"></a><a class="code" href="../../d2/d5/range_8c.html#a10">00843</a> <a class="code" href="../../d2/d5/range_8c.html#a10">RtlpAddIntersectingRanges</a>(
00844     IN PLIST_ENTRY ListHead,
00845     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> First,
00846     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry,
00847     IN ULONG AddRangeFlags
00848     )
00849 <span class="comment">/*++</span>
00850 <span class="comment"></span>
00851 <span class="comment">Routine Description:</span>
00852 <span class="comment"></span>
00853 <span class="comment">    This routine adds a range to a range list when the new range overlaps</span>
00854 <span class="comment">    an existing range.  Ranges are converted to mergedranges and the</span>
00855 <span class="comment">    RTL_RANGE_CONFLICT flag is set as necessary.</span>
00856 <span class="comment"></span>
00857 <span class="comment">Arguments:</span>
00858 <span class="comment"></span>
00859 <span class="comment">    ListHead - The list of the range list to which the range should be added.</span>
00860 <span class="comment"></span>
00861 <span class="comment">    First - The first range that intersects</span>
00862 <span class="comment"></span>
00863 <span class="comment">    Entry - The new range to be added</span>
00864 <span class="comment"></span>
00865 <span class="comment">    AddRangeFlags - The Flags argument to RtlAddRange, see above.</span>
00866 <span class="comment"></span>
00867 <span class="comment">Return Value:</span>
00868 <span class="comment"></span>
00869 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
00870 <span class="comment"></span>
00871 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
00872 <span class="comment">    STATUS_RANGE_LIST_CONFLICT</span>
00873 <span class="comment"></span>
00874 <span class="comment">--*/</span>
00875 {
00876     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00877     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, next, currentMerged, nextMerged;
00878     BOOLEAN entryShared;
00879 
00880     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00881     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(First);
00882     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry);
00883 
00884     entryShared = <a class="code" href="../../d3/d5/range_8h.html#a6">SHARED</a>(Entry);
00885 
00886     <span class="comment">//</span>
00887     <span class="comment">// If we care about conflicts see if we conflict with anyone</span>
00888     <span class="comment">//</span>
00889 
00890     <span class="keywordflow">if</span> (!(AddRangeFlags &amp; RTL_RANGE_LIST_ADD_IF_CONFLICT)) {
00891 
00892         <span class="comment">//</span>
00893         <span class="comment">// Examine all ranges after the first intersecting one</span>
00894         <span class="comment">//</span>
00895 
00896         current = First;
00897         <a class="code" href="../../d3/d5/range_8h.html#a10">FOR_REST_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>, ListHead, current) {
00898 
00899             <span class="keywordflow">if</span> (Entry-&gt;End &lt; current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a>) {
00900 
00901                 <span class="comment">//</span>
00902                 <span class="comment">// We don't intersect anymore so there arn't any more</span>
00903                 <span class="comment">// conflicts</span>
00904                 <span class="comment">//</span>
00905 
00906                 <span class="keywordflow">break</span>;
00907 
00908             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(current)) {
00909 
00910                 <span class="comment">//</span>
00911                 <span class="comment">// Check if any of the merged ranges conflict</span>
00912                 <span class="comment">//</span>
00913 
00914                 <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
00915                                 &amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead,
00916                                 currentMerged) {
00917 
00918                     <span class="comment">//</span>
00919                     <span class="comment">// Do we conflict?</span>
00920                     <span class="comment">//</span>
00921 
00922                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a19">RANGE_INTERSECT</a>(currentMerged, Entry)
00923                     &amp;&amp; !(entryShared &amp;&amp; <a class="code" href="../../d3/d5/range_8h.html#a6">SHARED</a>(currentMerged))) {
00924 
00925                         <span class="comment">//</span>
00926                         <span class="comment">// We conflict with one of the merged ranges</span>
00927                         <span class="comment">//</span>
00928 
00929                         <span class="keywordflow">return</span> STATUS_RANGE_LIST_CONFLICT;
00930 
00931                     }
00932                 }
00933 
00934             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(entryShared &amp;&amp; <a class="code" href="../../d3/d5/range_8h.html#a6">SHARED</a>(current))) {
00935 
00936                 <span class="comment">//</span>
00937                 <span class="comment">// We conflict with a non shared region in the  main list.</span>
00938                 <span class="comment">//</span>
00939 
00940                 <span class="keywordflow">return</span> STATUS_RANGE_LIST_CONFLICT;
00941             }
00942         }
00943     }
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">// Ok - either we didn't find any conflicts or we don't care about</span>
00947     <span class="comment">// them.  Now its safe to perform the merge.   Make the first</span>
00948     <span class="comment">// overlapping range into a header if it is not already one and then</span>
00949     <span class="comment">// add the rest of the ranges</span>
00950     <span class="comment">//</span>
00951 
00952     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(First)) {
00953 
00954         status = <a class="code" href="../../d2/d5/range_8c.html#a8">RtlpConvertToMergedRange</a>(First);
00955 
00956         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00957             <span class="keywordflow">goto</span> cleanup;
00958         }
00959 
00960     }
00961 
00962     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(First));
00963 
00964     current = <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(First-&gt;ListEntry.Flink);
00965 
00966     <span class="comment">//</span>
00967     <span class="comment">// Consider the entries between the one following first and the last</span>
00968     <span class="comment">// intersecting one.</span>
00969     <span class="comment">//</span>
00970 
00971     <a class="code" href="../../d3/d5/range_8h.html#a11">FOR_REST_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>, ListHead, current, next) {
00972 
00973          <span class="keywordflow">if</span> (Entry-&gt;End &lt; current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a>) {
00974 
00975             <span class="comment">//</span>
00976             <span class="comment">// We don't intersect any more</span>
00977             <span class="comment">//</span>
00978 
00979             <span class="keywordflow">break</span>;
00980          }
00981 
00982         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(current)) {
00983 
00984             <span class="comment">//</span>
00985             <span class="comment">// Add all the merged ranges to the new entry</span>
00986             <span class="comment">//</span>
00987 
00988             <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
00989                                  &amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead,
00990                                  currentMerged,
00991                                  nextMerged) {
00992 
00993                 <span class="comment">//</span>
00994                 <span class="comment">// Remove the entry from the current list</span>
00995                 <span class="comment">//</span>
00996 
00997                 RemoveEntryList(&amp;currentMerged-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
00998 
00999                 <span class="comment">//</span>
01000                 <span class="comment">// Add the entry to the new merged range</span>
01001                 <span class="comment">//</span>
01002 
01003                 status = <a class="code" href="../../d2/d5/range_8c.html#a7">RtlpAddToMergedRange</a>(First,
01004                                             currentMerged,
01005                                             AddRangeFlags
01006                                             );
01007 
01008                 <span class="comment">//</span>
01009                 <span class="comment">// We should not be able to fail the add but just to be</span>
01010                 <span class="comment">// on the safe side...</span>
01011                 <span class="comment">//</span>
01012 
01013                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01014 
01015             }
01016 
01017             <span class="comment">//</span>
01018             <span class="comment">// Remove and free the now empty header</span>
01019             <span class="comment">//</span>
01020 
01021             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead));
01022 
01023             RemoveEntryList(&amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
01024             <a class="code" href="../../d2/d5/range_8c.html#a3">RtlpFreeRangeListEntry</a>(current);
01025 
01026         } <span class="keywordflow">else</span> {
01027 
01028             <span class="comment">//</span>
01029             <span class="comment">// Remove the entry from the main list</span>
01030             <span class="comment">//</span>
01031 
01032             RemoveEntryList(&amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
01033 
01034             <span class="comment">//</span>
01035             <span class="comment">// Add the entry to the new merged range</span>
01036             <span class="comment">//</span>
01037 
01038             status = <a class="code" href="../../d2/d5/range_8c.html#a7">RtlpAddToMergedRange</a>(First,
01039                                         current,
01040                                         AddRangeFlags
01041                                         );
01042 
01043             <span class="comment">//</span>
01044             <span class="comment">// We should not be able to fail the add but just to be</span>
01045             <span class="comment">// on the safe side...</span>
01046             <span class="comment">//</span>
01047 
01048             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01049 
01050         }
01051     }
01052 
01053     <span class="comment">//</span>
01054     <span class="comment">// Finally add the entry that did the overlapping</span>
01055     <span class="comment">//</span>
01056 
01057     status = <a class="code" href="../../d2/d5/range_8c.html#a7">RtlpAddToMergedRange</a>(First,
01058                                 Entry,
01059                                 AddRangeFlags
01060                                 );
01061 
01062     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01063 
01064 cleanup:
01065 
01066     <span class="keywordflow">return</span> status;
01067 
01068 }
01069 
01070 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01071"></a><a class="code" href="../../d2/d5/range_8c.html#a17">01071</a> <a class="code" href="../../d2/d5/range_8c.html#a17">RtlDeleteRange</a>(
01072     IN OUT PRTL_RANGE_LIST RangeList,
01073     IN ULONGLONG Start,
01074     IN ULONGLONG End,
01075     IN PVOID Owner
01076     )
01077 <span class="comment">/*++</span>
01078 <span class="comment"></span>
01079 <span class="comment">Routine Description:</span>
01080 <span class="comment"></span>
01081 <span class="comment">    This routine deletes a range from a range list.</span>
01082 <span class="comment"></span>
01083 <span class="comment">Arguments:</span>
01084 <span class="comment"></span>
01085 <span class="comment">    Start - The location of the start of the range to be deleted.</span>
01086 <span class="comment"></span>
01087 <span class="comment">    End - The location of the end of the range to be deleted.</span>
01088 <span class="comment"></span>
01089 <span class="comment">    Owner -  The owner of the range to be deleted, used to distinguish the</span>
01090 <span class="comment">    range from another with the same start and end.</span>
01091 <span class="comment"></span>
01092 <span class="comment">Return Value:</span>
01093 <span class="comment"></span>
01094 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
01095 <span class="comment"></span>
01096 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
01097 <span class="comment">    STATUS_RANGE_LIST_CONFLICT</span>
01098 <span class="comment"></span>
01099 <span class="comment">--*/</span>
01100 {
01101     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_RANGE_NOT_FOUND;
01102     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, next, currentMerged, nextMerged;
01103 
01104     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01105     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RangeList);
01106 
01107     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(1,
01108         (<span class="stringliteral">"RtlDeleteRange(0x%08x, 0x%I64x, 0x%I64x, 0x%08x)\n"</span>,
01109         RangeList,
01110         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
01111         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
01112         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>
01113         ));
01114 
01115 
01116     <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
01117                          &amp;RangeList-&gt;ListHead,
01118                          current,
01119                          next) {
01120 
01121         <span class="comment">//</span>
01122         <span class="comment">// We're passed all possible intersections</span>
01123         <span class="comment">//</span>
01124 
01125         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt; current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a>) {
01126 
01127             <span class="comment">//</span>
01128             <span class="comment">// We didn't find a match</span>
01129             <span class="comment">//</span>
01130 
01131             <span class="keywordflow">break</span>;
01132         }
01133 
01134         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(current)) {
01135 
01136             <span class="comment">//</span>
01137             <span class="comment">// COuld our range exist in this merged range?</span>
01138             <span class="comment">//</span>
01139 
01140             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt;= current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a> &amp;&amp; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt;= current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o1">End</a>) {
01141 
01142                 <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
01143                                      &amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead,
01144                                      currentMerged,
01145                                      nextMerged) {
01146 
01147                     <span class="keywordflow">if</span> (currentMerged-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a> == <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>
01148                     &amp;&amp; currentMerged-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o1">End</a> == <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>
01149                     &amp;&amp; currentMerged-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o4">Allocated</a>.Owner == <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>) {
01150 
01151                         <span class="comment">//</span>
01152                         <span class="comment">// This is the range - delete it and rebuild the merged</span>
01153                         <span class="comment">// range appropriately</span>
01154                         <span class="comment">//</span>
01155 
01156                         status = <a class="code" href="../../d2/d5/range_8c.html#a11">RtlpDeleteFromMergedRange</a>(currentMerged,
01157                                                          current
01158                                                          );
01159                         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01160                     }
01161 
01162                 }
01163             }
01164 
01165         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a> == <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>
01166                &amp;&amp; current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o1">End</a> == <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>
01167                &amp;&amp; current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o4">Allocated</a>.Owner == <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>) {
01168 
01169             <span class="comment">//</span>
01170             <span class="comment">// This is the range - delete it!</span>
01171             <span class="comment">//</span>
01172 
01173             RemoveEntryList(&amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
01174             <a class="code" href="../../d2/d5/range_8c.html#a3">RtlpFreeRangeListEntry</a>(current);
01175             status = STATUS_SUCCESS;
01176             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01177         }
01178     }
01179 
01180 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
01181 
01182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01183 
01184         <span class="comment">//</span>
01185         <span class="comment">// We have removed a range so decrement the count in the header</span>
01186         <span class="comment">//</span>
01187 
01188         RangeList-&gt;Count--;
01189         RangeList-&gt;Stamp++;
01190 
01191     }
01192 
01193     <span class="keywordflow">return</span> status;
01194 }
01195 
01196 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01197"></a><a class="code" href="../../d2/d5/range_8c.html#a18">01197</a> <a class="code" href="../../d2/d5/range_8c.html#a18">RtlDeleteOwnersRanges</a>(
01198     IN OUT PRTL_RANGE_LIST RangeList,
01199     IN PVOID Owner
01200     )
01201 <span class="comment">/*++</span>
01202 <span class="comment"></span>
01203 <span class="comment">Routine Description:</span>
01204 <span class="comment"></span>
01205 <span class="comment">    This routine deletes all the ranges owned by a specific owner from a range</span>
01206 <span class="comment">    list.</span>
01207 <span class="comment"></span>
01208 <span class="comment">Arguments:</span>
01209 <span class="comment"></span>
01210 <span class="comment">    Owner -  The owner of the ranges to be deleted.</span>
01211 <span class="comment"></span>
01212 <span class="comment">Return Value:</span>
01213 <span class="comment"></span>
01214 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
01215 <span class="comment"></span>
01216 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
01217 <span class="comment"></span>
01218 <span class="comment">--*/</span>
01219 {
01220     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01221     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, next, currentMerged, nextMerged;
01222 
01223     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01224     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RangeList);
01225 
01226     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(1,
01227                 (<span class="stringliteral">"RtlDeleteOwnersRanges(0x%08x, 0x%08x)\n"</span>,
01228                 RangeList,
01229                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>
01230                 ));
01231 
01232 findNext:
01233 
01234     <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
01235                          &amp;RangeList-&gt;ListHead,
01236                          current,
01237                          next) {
01238 
01239         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(current)) {
01240 
01241             <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
01242                                  &amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead,
01243                                  currentMerged,
01244                                  nextMerged) {
01245 
01246                 <span class="keywordflow">if</span> (currentMerged-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o4">Allocated</a>.Owner == <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>) {
01247 
01248                     <span class="comment">//</span>
01249                     <span class="comment">// This is the range - delete it and rebuild the merged</span>
01250                     <span class="comment">// range appropriately</span>
01251                     <span class="comment">//</span>
01252 
01253                     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2,
01254                         (<span class="stringliteral">"RtlDeleteOwnersRanges: Deleting merged range \</span>
01255 <span class="stringliteral">                            (Start=%I64x, End=%I64x)\n"</span>,
01256                         currentMerged-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a>,
01257                         currentMerged-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o1">End</a>
01258                         ));
01259 
01260                     status = <a class="code" href="../../d2/d5/range_8c.html#a11">RtlpDeleteFromMergedRange</a>(currentMerged,
01261                                                      current
01262                                                      );
01263                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01264                         <span class="keywordflow">goto</span> cleanup;
01265                     }
01266 
01267                     RangeList-&gt;Count--;
01268                     RangeList-&gt;Stamp++;
01269 
01270                     <span class="comment">//</span>
01271                     <span class="comment">// Can't keep scanning the list as it might have changed</span>
01272                     <span class="comment">// underneath us - start from the beginning again...</span>
01273                     <span class="comment">//</span>
01274                     <span class="comment">// BUGBUG - could keep a last safe position to go from...</span>
01275                     <span class="comment">//</span>
01276                     <span class="keywordflow">goto</span> findNext;
01277 
01278                 }
01279             }
01280 
01281         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o4">Allocated</a>.Owner == <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>) {
01282 
01283             <span class="comment">//</span>
01284             <span class="comment">// This is the range - delete it!</span>
01285             <span class="comment">//</span>
01286 
01287             RemoveEntryList(&amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
01288             <a class="code" href="../../d2/d5/range_8c.html#a3">RtlpFreeRangeListEntry</a>(current);
01289 
01290             <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2,
01291                 (<span class="stringliteral">"RtlDeleteOwnersRanges: Deleting range (Start=%I64x,End=%I64x)\n"</span>,
01292                 current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a>,
01293                 current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o1">End</a>
01294                 ));
01295 
01296             RangeList-&gt;Count--;
01297             RangeList-&gt;Stamp++;
01298 
01299             status = STATUS_SUCCESS;
01300 
01301         }
01302     }
01303 
01304 cleanup:
01305 
01306     <span class="keywordflow">return</span> status;
01307 
01308 }
01309 
01310 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01311"></a><a class="code" href="../../d2/d5/range_8c.html#a11">01311</a> <a class="code" href="../../d2/d5/range_8c.html#a11">RtlpDeleteFromMergedRange</a>(
01312     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Delete,
01313     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Merged
01314     )
01315 <span class="comment">/*++</span>
01316 <span class="comment"></span>
01317 <span class="comment">Routine Description:</span>
01318 <span class="comment"></span>
01319 <span class="comment">    This routine deletes a range from a merged range and rebuilds the merged</span>
01320 <span class="comment">    range as appropriate.  This includes adding new merged and unmerged ranges.</span>
01321 <span class="comment">    If no ranges are left in the merged range it will be deleted.</span>
01322 <span class="comment"></span>
01323 <span class="comment">Arguments:</span>
01324 <span class="comment"></span>
01325 <span class="comment">    BUGBUG these comments are not for this routine.</span>
01326 <span class="comment"></span>
01327 <span class="comment">    Start - The location of the start of the range to be deleted.</span>
01328 <span class="comment"></span>
01329 <span class="comment">    End - The location of the end of the range to be deleted.</span>
01330 <span class="comment"></span>
01331 <span class="comment">    Owner -  The owner of the range to be deleted, used to distinguish the</span>
01332 <span class="comment">    range from another with the same start and end.</span>
01333 <span class="comment"></span>
01334 <span class="comment">Return Value:</span>
01335 <span class="comment"></span>
01336 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
01337 <span class="comment"></span>
01338 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
01339 <span class="comment"></span>
01340 <span class="comment">--*/</span>
01341 {
01342     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01343     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, next;
01344     LIST_ENTRY keepList;
01345     PLIST_ENTRY previousInsert, nextInsert;
01346 
01347     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01348     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(Merged));
01349 
01350     <span class="comment">//</span>
01351     <span class="comment">// Remove the entry</span>
01352     <span class="comment">//</span>
01353 
01354     RemoveEntryList(&amp;<a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a>-&gt;ListEntry);
01355 
01356     <span class="comment">//</span>
01357     <span class="comment">// Initialize the temporary list where the new list will be build</span>
01358     <span class="comment">//</span>
01359 
01360     InitializeListHead(&amp;keepList);
01361 
01362     <span class="comment">//</span>
01363     <span class="comment">// Add the previously merged ranges into the keep list and put</span>
01364     <span class="comment">// any duplicates of the delete range into the delete list</span>
01365     <span class="comment">//</span>
01366 
01367     <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
01368                          &amp;Merged-&gt;Merged.ListHead,
01369                          current,
01370                          next) {
01371 
01372         <span class="comment">//</span>
01373         <span class="comment">// Add it to the keepList.  Explicitly remove the entries from the</span>
01374         <span class="comment">// list so it is still valid if we need to rebuild it.</span>
01375         <span class="comment">//</span>
01376 
01377         RemoveEntryList(&amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
01378 
01379         <span class="comment">//</span>
01380         <span class="comment">// Clear the conflict flag - if there is still a conflict RtlpAddRange</span>
01381         <span class="comment">// should set it again.</span>
01382         <span class="comment">//</span>
01383 
01384         current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o8">PublicFlags</a> &amp;= ~RTL_RANGE_CONFLICT;
01385 
01386         status = <a class="code" href="../../d2/d5/range_8c.html#a6">RtlpAddRange</a>(&amp;keepList,
01387                               current,
01388                               RTL_RANGE_LIST_ADD_IF_CONFLICT
01389                              );
01390 
01391         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01392             <span class="comment">//</span>
01393             <span class="comment">// This should only happen if we run out of pool</span>
01394             <span class="comment">//</span>
01395             <span class="keywordflow">goto</span> cleanup;
01396         }
01397     }
01398 
01399     <span class="keywordflow">if</span> (!IsListEmpty(&amp;keepList)) {
01400 
01401         <span class="comment">//</span>
01402         <span class="comment">// Everything went well so splice this temporary list into the</span>
01403         <span class="comment">// main list where Merged used to be</span>
01404         <span class="comment">//</span>
01405 
01406         previousInsert = Merged-&gt;ListEntry.Blink;
01407         nextInsert = Merged-&gt;ListEntry.Flink;
01408 
01409         previousInsert-&gt;Flink = keepList.Flink;
01410         keepList.Flink-&gt;Blink = previousInsert;
01411 
01412         nextInsert-&gt;Blink = keepList.Blink;
01413         keepList.Blink-&gt;Flink = nextInsert;
01414 
01415     } <span class="keywordflow">else</span> {
01416 
01417         RemoveEntryList(&amp;Merged-&gt;ListEntry);
01418 
01419     }
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">// Finally free the range we deleted and the merged range we have orphaned</span>
01423     <span class="comment">//</span>
01424 
01425     <a class="code" href="../../d2/d5/range_8c.html#a3">RtlpFreeRangeListEntry</a>(<a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a>);
01426     <a class="code" href="../../d2/d5/range_8c.html#a3">RtlpFreeRangeListEntry</a>(Merged);
01427 
01428     <span class="keywordflow">return</span> status;
01429 
01430 cleanup:
01431 
01432     <span class="comment">//</span>
01433     <span class="comment">// Things went wrong - should only be a STATUS_INSUFFICIENT_RESOURCES</span>
01434     <span class="comment">// Reconstruct the list as it was before the call using the keepList and</span>
01435     <span class="comment">// deleteList.</span>
01436     <span class="comment">//</span>
01437 
01438     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_INSUFFICIENT_RESOURCES);
01439 
01440     <span class="comment">//</span>
01441     <span class="comment">// Add all the ranges we moved to the keepList back into Merged</span>
01442     <span class="comment">//</span>
01443 
01444     <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>, &amp;keepList, current, next) {
01445 
01446         status = <a class="code" href="../../d2/d5/range_8c.html#a7">RtlpAddToMergedRange</a>(Merged,
01447                                     current,
01448                                     RTL_RANGE_LIST_ADD_IF_CONFLICT
01449                                     );
01450 
01451         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01452     }
01453 
01454     <span class="comment">//</span>
01455     <span class="comment">// And the one were meant to delete</span>
01456     <span class="comment">//</span>
01457 
01458     status = <a class="code" href="../../d2/d5/range_8c.html#a7">RtlpAddToMergedRange</a>(Merged,
01459                                   <a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a>,
01460                                   RTL_RANGE_LIST_ADD_IF_CONFLICT
01461                                  );
01462 
01463     <span class="keywordflow">return</span> status;
01464 }
01465 
01466 <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a>
<a name="l01467"></a><a class="code" href="../../d2/d5/range_8c.html#a12">01467</a> <a class="code" href="../../d2/d5/range_8c.html#a12">RtlpCopyRangeListEntry</a>(
01468     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry
01469     )
01470 <span class="comment">/*++</span>
01471 <span class="comment"></span>
01472 <span class="comment">Routine Description:</span>
01473 <span class="comment"></span>
01474 <span class="comment">    This routine copies a range list entry.  If the entry is merged all the</span>
01475 <span class="comment">    member ranges are copied too.</span>
01476 <span class="comment"></span>
01477 <span class="comment">Arguments:</span>
01478 <span class="comment"></span>
01479 <span class="comment">    Entry - the range list entry to be copied.</span>
01480 <span class="comment"></span>
01481 <span class="comment">Return Value:</span>
01482 <span class="comment"></span>
01483 <span class="comment">    Pointer to the new range list entry or NULL if a new entry could not be</span>
01484 <span class="comment">    allocated.</span>
01485 <span class="comment"></span>
01486 <span class="comment">--*/</span>
01487 {
01488     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> newEntry;
01489 
01490     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01491     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry);
01492 
01493     <span class="keywordflow">if</span> (newEntry = <a class="code" href="../../d2/d5/range_8c.html#a2">RtlpAllocateRangeListEntry</a>()) {
01494 
01495         RtlCopyMemory(newEntry, Entry, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>));
01496 
01497 <span class="preprocessor">#if DBG</span>
01498 <span class="preprocessor"></span>        newEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01499         newEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01500 <span class="preprocessor">#endif</span>
01501 <span class="preprocessor"></span>
01502         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(Entry)) {
01503 
01504             <span class="comment">//</span>
01505             <span class="comment">// Copy the merged list</span>
01506             <span class="comment">//</span>
01507 
01508             <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, newMerged;
01509 
01510             InitializeListHead(&amp;newEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead);
01511 
01512             <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d3/d5/range_8h.html#a26">RTLP_RANGE_LIST_ENTRY</a>,
01513                             &amp;Entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead,
01514                             current) {
01515 
01516                 <span class="comment">//</span>
01517                 <span class="comment">// Allocate a new entry and copy the contents</span>
01518                 <span class="comment">//</span>
01519 
01520                 newMerged = <a class="code" href="../../d2/d5/range_8c.html#a2">RtlpAllocateRangeListEntry</a>();
01521 
01522                 <span class="keywordflow">if</span> (!newMerged) {
01523                     <span class="keywordflow">goto</span> cleanup;
01524                 }
01525 
01526                 RtlCopyMemory(newMerged, current, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/range_8h.html#a26">RTLP_RANGE_LIST_ENTRY</a>));
01527 
01528                 <span class="comment">//</span>
01529                 <span class="comment">// Insert the new entry</span>
01530                 <span class="comment">//</span>
01531 
01532                 InsertTailList(&amp;newEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead, &amp;newMerged-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
01533             }
01534         }
01535     }
01536 
01537     <span class="keywordflow">return</span> newEntry;
01538 
01539 cleanup:
01540 
01541     <span class="comment">//</span>
01542     <span class="comment">// Free the partially build copy</span>
01543     <span class="comment">//</span>
01544 
01545     <a class="code" href="../../d2/d5/range_8c.html#a13">RtlpDeleteRangeListEntry</a>(newEntry);
01546 
01547     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01548 
01549 }
01550 
01551 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01552"></a><a class="code" href="../../d2/d5/range_8c.html#a19">01552</a> <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(
01553     OUT PRTL_RANGE_LIST CopyRangeList,
01554     IN PRTL_RANGE_LIST RangeList
01555     )
01556 <span class="comment">/*++</span>
01557 <span class="comment"></span>
01558 <span class="comment">Routine Description:</span>
01559 <span class="comment"></span>
01560 <span class="comment">    This routine copies a range list.</span>
01561 <span class="comment"></span>
01562 <span class="comment">Arguments:</span>
01563 <span class="comment"></span>
01564 <span class="comment">    CopyRangeList - An initialized but empty range list where RangeList should</span>
01565 <span class="comment">        be copied to.</span>
01566 <span class="comment"></span>
01567 <span class="comment">    RangeList - The range list that is to be copied.</span>
01568 <span class="comment"></span>
01569 <span class="comment">Return Value:</span>
01570 <span class="comment"></span>
01571 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
01572 <span class="comment"></span>
01573 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
01574 <span class="comment">    STATUS_INVALID_PARAMETER</span>
01575 <span class="comment"></span>
01576 <span class="comment">--*/</span>
01577 {
01578 
01579     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01580     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, newEntry, currentMerged, newMerged;
01581 
01582     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01583     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RangeList);
01584     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CopyRangeList);
01585 
01586 
01587     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(1,
01588                 (<span class="stringliteral">"RtlCopyRangeList(0x%08x, 0x%08x)\n"</span>,
01589                 CopyRangeList,
01590                 RangeList
01591                 ));
01592 
01593     <span class="comment">//</span>
01594     <span class="comment">// Sanity checks...</span>
01595     <span class="comment">//</span>
01596 
01597     <span class="keywordflow">if</span> (CopyRangeList-&gt;Count != 0) {
01598         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01599     }
01600 
01601     <span class="comment">//</span>
01602     <span class="comment">// Copy the header information</span>
01603     <span class="comment">//</span>
01604 
01605     CopyRangeList-&gt;Flags = RangeList-&gt;Flags;
01606     CopyRangeList-&gt;Count = RangeList-&gt;Count;
01607     CopyRangeList-&gt;Stamp = RangeList-&gt;Stamp;
01608 
01609     <span class="comment">//</span>
01610     <span class="comment">// Perform the copy</span>
01611     <span class="comment">//</span>
01612 
01613     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>, &amp;RangeList-&gt;ListHead, current) {
01614 
01615         <span class="comment">//</span>
01616         <span class="comment">// Copy the current entry</span>
01617         <span class="comment">//</span>
01618 
01619         newEntry = <a class="code" href="../../d2/d5/range_8c.html#a12">RtlpCopyRangeListEntry</a>(current);
01620 
01621         <span class="keywordflow">if</span> (!newEntry) {
01622             status = STATUS_INSUFFICIENT_RESOURCES;
01623             <span class="keywordflow">goto</span> cleanup;
01624         }
01625 
01626         <span class="comment">//</span>
01627         <span class="comment">// Add it into the list</span>
01628         <span class="comment">//</span>
01629 
01630         InsertTailList(&amp;CopyRangeList-&gt;ListHead, &amp;newEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
01631     }
01632 
01633     <span class="keywordflow">return</span> status;
01634 
01635 cleanup:
01636 
01637     <span class="comment">//</span>
01638     <span class="comment">// Free up the partially complete range list</span>
01639     <span class="comment">//</span>
01640 
01641     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(CopyRangeList);
01642     <span class="keywordflow">return</span> status;
01643 
01644 }
01645 
01646 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01647"></a><a class="code" href="../../d2/d5/range_8c.html#a13">01647</a> <a class="code" href="../../d2/d5/range_8c.html#a13">RtlpDeleteRangeListEntry</a>(
01648     IN <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry
01649     )
01650 <span class="comment">/*++</span>
01651 <span class="comment"></span>
01652 <span class="comment">Routine Description:</span>
01653 <span class="comment"></span>
01654 <span class="comment">    This routine deletes a range list entry - if the entry is merged then all</span>
01655 <span class="comment">    the member ranges will be deleted as well.  The entry will not be removed</span>
01656 <span class="comment">    from any list before deletion - this should be done before calling this</span>
01657 <span class="comment">    routine.</span>
01658 <span class="comment"></span>
01659 <span class="comment">Arguments:</span>
01660 <span class="comment"></span>
01661 <span class="comment">    Entry - The entry to be deleted.</span>
01662 <span class="comment"></span>
01663 <span class="comment">Return Value:</span>
01664 <span class="comment"></span>
01665 <span class="comment">    None</span>
01666 <span class="comment"></span>
01667 <span class="comment">--*/</span>
01668 
01669 {
01670     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01671 
01672     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(Entry)) {
01673 
01674         <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, next;
01675 
01676         <span class="comment">//</span>
01677         <span class="comment">// Free all member ranges first</span>
01678         <span class="comment">//</span>
01679 
01680         <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
01681                              &amp;Entry-&gt;Merged.ListHead,
01682                              current,
01683                              next) {
01684 
01685             <a class="code" href="../../d2/d5/range_8c.html#a3">RtlpFreeRangeListEntry</a>(current);
01686         }
01687     }
01688 
01689     <a class="code" href="../../d2/d5/range_8c.html#a3">RtlpFreeRangeListEntry</a>(Entry);
01690 }
01691 
01692 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01693"></a><a class="code" href="../../d2/d5/range_8c.html#a20">01693</a> <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(
01694     IN PRTL_RANGE_LIST RangeList
01695     )
01696 <span class="comment">/*++</span>
01697 <span class="comment"></span>
01698 <span class="comment">Routine Description:</span>
01699 <span class="comment"></span>
01700 <span class="comment">    This routine deletes all the ranges in a range list.</span>
01701 <span class="comment"></span>
01702 <span class="comment">Arguments:</span>
01703 <span class="comment"></span>
01704 <span class="comment">    RangeList - the range list to operate on.</span>
01705 <span class="comment"></span>
01706 <span class="comment">Return Value:</span>
01707 <span class="comment"></span>
01708 <span class="comment">    None</span>
01709 <span class="comment"></span>
01710 <span class="comment">--*/</span>
01711 {
01712 
01713     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, next;
01714 
01715     <span class="comment">//</span>
01716     <span class="comment">// Sanity checks...</span>
01717     <span class="comment">//</span>
01718 
01719     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01720     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RangeList);
01721 
01722     <span class="comment">//</span>
01723     <span class="comment">// Clean up the header information</span>
01724     <span class="comment">//</span>
01725 
01726     RangeList-&gt;Flags = 0;
01727     RangeList-&gt;Count = 0;
01728 
01729     <a class="code" href="../../d3/d5/range_8h.html#a9">FOR_ALL_IN_LIST_SAFE</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
01730                          &amp;RangeList-&gt;ListHead,
01731                          current,
01732                          next) {
01733 
01734         <span class="comment">//</span>
01735         <span class="comment">// Delete the current entry</span>
01736         <span class="comment">//</span>
01737 
01738         RemoveEntryList(&amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>);
01739         <a class="code" href="../../d2/d5/range_8c.html#a13">RtlpDeleteRangeListEntry</a>(current);
01740     }
01741 }
01742 
01743 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01744"></a><a class="code" href="../../d2/d5/range_8c.html#a21">01744</a> <a class="code" href="../../d2/d5/range_8c.html#a21">RtlIsRangeAvailable</a>(
01745     IN PRTL_RANGE_LIST RangeList,
01746     IN ULONGLONG Start,
01747     IN ULONGLONG End,
01748     IN ULONG Flags,
01749     IN UCHAR AttributeAvailableMask,
01750     IN PVOID Context OPTIONAL,
01751     IN PRTL_CONFLICT_RANGE_CALLBACK Callback OPTIONAL,
01752     OUT PBOOLEAN Available
01753     )
01754 <span class="comment">/*++</span>
01755 <span class="comment"></span>
01756 <span class="comment">Routine Description:</span>
01757 <span class="comment"></span>
01758 <span class="comment">    This routine determines if a given range is available.</span>
01759 <span class="comment"></span>
01760 <span class="comment">Arguments:</span>
01761 <span class="comment"></span>
01762 <span class="comment">    RangeList - The range list to test availability on.</span>
01763 <span class="comment"></span>
01764 <span class="comment">    Start - The start of the range to test for availability.</span>
01765 <span class="comment"></span>
01766 <span class="comment">    End - The end of the range to test for availability.</span>
01767 <span class="comment"></span>
01768 <span class="comment">    Flags - Modify the behaviour of the routine.</span>
01769 <span class="comment"></span>
01770 <span class="comment">        RTL_RANGE_LIST_SHARED_OK - indicates that shared ranges should be</span>
01771 <span class="comment">            considered to be available.</span>
01772 <span class="comment"></span>
01773 <span class="comment">    AttributeAvailableMask - Any range encountered with any of these bits set will be</span>
01774 <span class="comment">        consideredto be available.</span>
01775 <span class="comment"></span>
01776 <span class="comment">    Available -  Pointer to a boolean which will be set to TRUE if the range</span>
01777 <span class="comment">        is available, otherwise FALSE;</span>
01778 <span class="comment"></span>
01779 <span class="comment">Return Value:</span>
01780 <span class="comment"></span>
01781 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
01782 <span class="comment"></span>
01783 <span class="comment">--*/</span>
01784 {
01785     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01786     RTL_RANGE_LIST_ITERATOR iterator;
01787     PRTL_RANGE <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
01788 
01789     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01790 
01791     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RangeList);
01792     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Available);
01793 
01794     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(1,
01795         (<span class="stringliteral">"RtlIsRangeAvailable(0x%08x, 0x%I64x, 0x%I64x, 0x%08x, 0x%08x)\n"</span>,
01796         RangeList,
01797         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
01798         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
01799         Flags,
01800         Available
01801         ));
01802 
01803     <span class="comment">//</span>
01804     <span class="comment">// Initialize iterator to the start of the list</span>
01805     <span class="comment">//</span>
01806     status = <a class="code" href="../../d2/d5/range_8c.html#a23">RtlGetFirstRange</a>(RangeList, &amp;iterator, &amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>);
01807 
01808 
01809     <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
01810         <span class="comment">//</span>
01811         <span class="comment">// The range list is empty therefore the range is available</span>
01812         <span class="comment">//</span>
01813 
01814         *Available = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01815         <span class="keywordflow">return</span> STATUS_SUCCESS;
01816 
01817     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01818 
01819         <span class="keywordflow">return</span> status;
01820 
01821     }
01822 
01823     *Available = <a class="code" href="../../d2/d5/range_8c.html#a14">RtlpIsRangeAvailable</a>(&amp;iterator,
01824                                       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
01825                                       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
01826                                       AttributeAvailableMask,
01827                                       (BOOLEAN)(Flags &amp; RTL_RANGE_LIST_SHARED_OK),
01828                                       (BOOLEAN)(Flags &amp; RTL_RANGE_LIST_NULL_CONFLICT_OK),
01829                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01830                                       Context,
01831                                       Callback
01832                                       );
01833 
01834     <span class="keywordflow">return</span> STATUS_SUCCESS;
01835 
01836 }
01837 
01838 BOOLEAN
<a name="l01839"></a><a class="code" href="../../d2/d5/range_8c.html#a14">01839</a> <a class="code" href="../../d2/d5/range_8c.html#a14">RtlpIsRangeAvailable</a>(
01840     IN PRTL_RANGE_LIST_ITERATOR Iterator,
01841     IN ULONGLONG Start,
01842     IN ULONGLONG End,
01843     IN UCHAR AttributeAvailableMask,
01844     IN BOOLEAN SharedOK,
01845     IN BOOLEAN NullConflictOK,
01846     IN BOOLEAN Forward,
01847     IN PVOID Context OPTIONAL,
01848     IN PRTL_CONFLICT_RANGE_CALLBACK Callback OPTIONAL
01849     )
01850 <span class="comment">/*++</span>
01851 <span class="comment"></span>
01852 <span class="comment">Routine Description:</span>
01853 <span class="comment"></span>
01854 <span class="comment">    This routine determines if a given range is available.</span>
01855 <span class="comment"></span>
01856 <span class="comment">Arguments:</span>
01857 <span class="comment"></span>
01858 <span class="comment">    Iterator - An iterator set to the first range to test in the range list.</span>
01859 <span class="comment"></span>
01860 <span class="comment">    Start - The start of the range to test for availability.</span>
01861 <span class="comment"></span>
01862 <span class="comment">    End - The end of the range to test for availability.</span>
01863 <span class="comment"></span>
01864 <span class="comment">    AttributeAvailableMask - Any range encountered with any of these bits set will be</span>
01865 <span class="comment">        considered to be available.</span>
01866 <span class="comment"></span>
01867 <span class="comment">    SharedOK - Indicated whether or not shared ranges are considered to be</span>
01868 <span class="comment">        available.</span>
01869 <span class="comment"></span>
01870 <span class="comment">Return Value:</span>
01871 <span class="comment"></span>
01872 <span class="comment">    TRUE if the range is available, FALSE otherwise.</span>
01873 <span class="comment"></span>
01874 <span class="comment">--*/</span>
01875 {
01876     PRTL_RANGE current;
01877 
01878     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01879 
01880     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Iterator);
01881 
01882     <a class="code" href="../../d3/d5/range_8h.html#a24">FOR_REST_OF_RANGES</a>(Iterator, current, Forward) {
01883 
01884         <span class="comment">//</span>
01885         <span class="comment">// If we have passed all possible intersections then break out.  This</span>
01886         <span class="comment">// can't be done in a merged region because of possible overlaps.</span>
01887         <span class="comment">//</span>
01888 
01889         <span class="keywordflow">if</span> (Forward) {
01890             <span class="keywordflow">if</span> (!Iterator-&gt;MergedHead &amp;&amp; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &lt; current-&gt;Start) {
01891                 <span class="keywordflow">break</span>;
01892             }
01893         } <span class="keywordflow">else</span> {
01894             <span class="keywordflow">if</span> (!Iterator-&gt;MergedHead &amp;&amp; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt; current-&gt;End) {
01895                 <span class="keywordflow">break</span>;
01896             }
01897         }
01898 
01899         <span class="comment">//</span>
01900         <span class="comment">// Do we intersect?</span>
01901         <span class="comment">//</span>
01902         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a21">RANGE_LIMITS_INTERSECT</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>, current-&gt;Start, current-&gt;End)) {
01903 
01904             <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2,
01905                 (<span class="stringliteral">"Intersection 0x%I64x-0x%I64x and 0x%I64x-0x%I64x\n"</span>,
01906                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
01907                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
01908                 current-&gt;Start,
01909                 current-&gt;End
01910                 ));
01911 
01912             <span class="comment">//</span>
01913             <span class="comment">// Is the intersection not Ok because it is with a non-shared</span>
01914             <span class="comment">// region or we don't want a shared region? Or the user said that</span>
01915             <span class="comment">// it should be considered available because of the user flags set.</span>
01916             <span class="comment">//</span>
01917 
01918             <span class="keywordflow">if</span> (!((SharedOK &amp;&amp; (current-&gt;Flags &amp; RTL_RANGE_SHARED))
01919                   || (current-&gt;Attributes &amp; AttributeAvailableMask)
01920                   || (NullConflictOK &amp;&amp; (current-&gt;Owner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
01921                   )
01922                 )  {
01923 
01924                 <span class="comment">//</span>
01925                 <span class="comment">// If the caller provided a callback to support extra conflict</span>
01926                 <span class="comment">// semantics call it</span>
01927                 <span class="comment">//</span>
01928 
01929                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Callback)) {
01930                     <span class="keywordflow">if</span> ((*Callback)(Context, (PRTL_RANGE)current)) {
01931 
01932                     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2,
01933                         (<span class="stringliteral">"User provided callback overrode conflict\n"</span>,
01934                         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
01935                         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>,
01936                         current-&gt;Start,
01937                         current-&gt;End
01938                         ));
01939 
01940                         <span class="keywordflow">continue</span>;
01941                     }
01942                 }
01943 
01944                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01945             }
01946         }
01947     }
01948 
01949 
01950     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01951 }
01952 
01953 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01954"></a><a class="code" href="../../d2/d5/range_8c.html#a22">01954</a> <a class="code" href="../../d2/d5/range_8c.html#a22">RtlFindRange</a>(
01955     IN PRTL_RANGE_LIST RangeList,
01956     IN ULONGLONG Minimum,
01957     IN ULONGLONG Maximum,
01958     IN ULONG Length,
01959     IN ULONG Alignment,
01960     IN ULONG Flags,
01961     IN UCHAR AttributeAvailableMask,
01962     IN PVOID Context OPTIONAL,
01963     IN PRTL_CONFLICT_RANGE_CALLBACK Callback OPTIONAL,
01964     OUT PULONGLONG Start
01965     )
01966 <span class="comment">/*++</span>
01967 <span class="comment"></span>
01968 <span class="comment">Routine Description:</span>
01969 <span class="comment"></span>
01970 <span class="comment">    This routine finds the first available range that meets the criterion specified.</span>
01971 <span class="comment"></span>
01972 <span class="comment">Arguments:</span>
01973 <span class="comment"></span>
01974 <span class="comment">    RangeList - The range list to find a range in.</span>
01975 <span class="comment"></span>
01976 <span class="comment">    Minimum - The minimum acceptable value of the start of the range.</span>
01977 <span class="comment"></span>
01978 <span class="comment">    Maximum - The maximum acceptable value of the end of the range.</span>
01979 <span class="comment"></span>
01980 <span class="comment">    Length - The length of the range required.</span>
01981 <span class="comment"></span>
01982 <span class="comment">    Alignmnent - The alignment of the start of the range.</span>
01983 <span class="comment"></span>
01984 <span class="comment">    Flags - Modify the behaviour of the routine.</span>
01985 <span class="comment"></span>
01986 <span class="comment">        RTL_RANGE_LIST_SHARED_OK - indicates that shared ranges should be</span>
01987 <span class="comment">            considered to be available.</span>
01988 <span class="comment"></span>
01989 <span class="comment">    AttributeAvailableMask - Any range encountered with any of these bits set will be</span>
01990 <span class="comment">        considered to be available.</span>
01991 <span class="comment"></span>
01992 <span class="comment">    Start - Pointer to a ULONGLONG where the start value will be returned on</span>
01993 <span class="comment">        success.</span>
01994 <span class="comment"></span>
01995 <span class="comment">Return Value:</span>
01996 <span class="comment"></span>
01997 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
01998 <span class="comment"></span>
01999 <span class="comment">    STATUS_UNSUCCESSFUL</span>
02000 <span class="comment">    STATUS_INVALID_PARAMETER</span>
02001 <span class="comment"></span>
02002 <span class="comment">--*/</span>
02003 {
02004 
02005     ULONGLONG start, end;
02006     RTL_RANGE_LIST_ITERATOR iterator;
02007     PRTL_RANGE <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
02008     BOOLEAN sharedOK, nullConflictOK;
02009 
02010     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02011 
02012     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RangeList);
02013     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>);
02014     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Alignment &gt; 0);
02015     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Length &gt; 0);
02016 
02017     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(1,
02018         (<span class="stringliteral">"RtlFindRange(0x%08x, 0x%I64x, 0x%I64x, 0x%08x, 0x%08x, 0x%08x, 0x%08x)\n"</span>,
02019         RangeList,
02020         Minimum,
02021         Maximum,
02022         Length,
02023         Alignment,
02024         Flags,
02025         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>
02026         ));
02027 
02028     <span class="comment">//</span>
02029     <span class="comment">// Search from high to low, Align start if necessary</span>
02030     <span class="comment">//</span>
02031 
02032     start = Maximum - (Length - 1);
02033     start -= start % Alignment;
02034 
02035     <span class="comment">//</span>
02036     <span class="comment">// Valiate parameters</span>
02037     <span class="comment">//</span>
02038 
02039     <span class="keywordflow">if</span> ((Minimum &gt; Maximum)
02040     || (Maximum - Minimum &lt; Length - 1)
02041     || (Minimum + Alignment &lt; Minimum)
02042     || (start &lt; Minimum)
02043     || (Length == 0)
02044     || (Alignment == 0)) {
02045 
02046         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02047     }
02048 
02049     sharedOK = (BOOLEAN) Flags &amp; RTL_RANGE_LIST_SHARED_OK;
02050     nullConflictOK = (BOOLEAN) Flags &amp; RTL_RANGE_LIST_NULL_CONFLICT_OK;
02051     <span class="comment">//</span>
02052     <span class="comment">// Calculate the end</span>
02053     <span class="comment">//</span>
02054 
02055     end = start + Length - 1;
02056 
02057     <span class="comment">//</span>
02058     <span class="comment">// Initialze the iterator to the end of the list</span>
02059     <span class="comment">//</span>
02060 
02061     <a class="code" href="../../d2/d5/range_8c.html#a24">RtlGetLastRange</a>(RangeList, &amp;iterator, &amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>);
02062 
02063     <span class="comment">//</span>
02064     <span class="comment">// Keep trying to find ranges until we run out of room or we</span>
02065     <span class="comment">// wrap around</span>
02066     <span class="comment">//</span>
02067 
02068     <span class="keywordflow">do</span> {
02069 
02070         <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(2,
02071             (<span class="stringliteral">"RtlFindRange: Testing range %I64x-%I64x\n"</span>,
02072             start,
02073             end
02074             ));
02075 
02076         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d5/range_8c.html#a14">RtlpIsRangeAvailable</a>(&amp;iterator,
02077                                  start,
02078                                  end,
02079                                  AttributeAvailableMask,
02080                                  sharedOK,
02081                                  nullConflictOK,
02082                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02083                                  Context,
02084                                  Callback)) {
02085 
02086             *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = start;
02087 
02088             <span class="comment">//</span>
02089             <span class="comment">// Assert our result, if we produced one, is in the in</span>
02090             <span class="comment">// the range specified</span>
02091             <span class="comment">//</span>
02092 
02093             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt;= Minimum &amp;&amp; *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + Length - 1 &lt;= Maximum);
02094 
02095             <span class="keywordflow">return</span> STATUS_SUCCESS;
02096         }
02097 
02098         <span class="comment">//</span>
02099         <span class="comment">// Find a suitable range starting from the one we conflicted with,</span>
02100         <span class="comment">// that is the current range in the iterator - this breaks the</span>
02101         <span class="comment">// abstraction of the iterator in the name of efficiency.</span>
02102         <span class="comment">//</span>
02103 
02104         start = ((<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a>)(iterator.Current))-&gt;Start;
02105         <span class="keywordflow">if</span> ((start - Length) &gt; start) {
02106 
02107             <span class="comment">//</span>
02108             <span class="comment">// Wrapped, fail.</span>
02109             <span class="comment">//</span>
02110 
02111             <span class="keywordflow">break</span>;
02112         }
02113 
02114         start -= Length;
02115         start -= start % Alignment;
02116         end = start + Length - 1;
02117 
02118     } <span class="keywordflow">while</span> ( start &gt;= Minimum );
02119 
02120     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02121 }
02122 
02123 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02124"></a><a class="code" href="../../d2/d5/range_8c.html#a23">02124</a> <a class="code" href="../../d2/d5/range_8c.html#a23">RtlGetFirstRange</a>(
02125     IN PRTL_RANGE_LIST RangeList,
02126     OUT PRTL_RANGE_LIST_ITERATOR Iterator,
02127     OUT PRTL_RANGE *Range
02128     )
02129 <span class="comment">/*++</span>
02130 <span class="comment"></span>
02131 <span class="comment">Routine Description:</span>
02132 <span class="comment"></span>
02133 <span class="comment">    This routine extracts the first range in a range list.  If there are no</span>
02134 <span class="comment">    ranges then STATUS_NO_MORE_ENTRIES is returned.</span>
02135 <span class="comment"></span>
02136 <span class="comment">Arguments:</span>
02137 <span class="comment"></span>
02138 <span class="comment">    RangeList - The range list to operate on.</span>
02139 <span class="comment"></span>
02140 <span class="comment">    Iterator - On success this contains the state of the iteration and can be</span>
02141 <span class="comment">        passed to RtlGetNextRange.</span>
02142 <span class="comment"></span>
02143 <span class="comment">    Range - On success this contains a pointer to the first range</span>
02144 <span class="comment"></span>
02145 <span class="comment">Return Value:</span>
02146 <span class="comment"></span>
02147 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
02148 <span class="comment"></span>
02149 <span class="comment">    STATUS_NO_MORE_ENTRIES</span>
02150 <span class="comment"></span>
02151 <span class="comment">--*/</span>
02152 {
02153     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
02154     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> first;
02155 
02156     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02157 
02158     <span class="comment">//</span>
02159     <span class="comment">// Fill in the first part of the iterator</span>
02160     <span class="comment">//</span>
02161 
02162     Iterator-&gt;RangeListHead = &amp;RangeList-&gt;ListHead;
02163     Iterator-&gt;Stamp = RangeList-&gt;Stamp;
02164 
02165     <span class="keywordflow">if</span> (!IsListEmpty(&amp;RangeList-&gt;ListHead)) {
02166 
02167         first = <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(RangeList-&gt;ListHead.Flink);
02168 
02169         <span class="comment">//</span>
02170         <span class="comment">// Fill in the iterator and update to point to the first merged</span>
02171         <span class="comment">// range if we are merged</span>
02172         <span class="comment">//</span>
02173 
02174         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(first)) {
02175 
02176             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;first-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead));
02177 
02178             Iterator-&gt;MergedHead = &amp;first-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead;
02179             Iterator-&gt;Current = <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(
02180                                     first-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead.Flink
02181                                     );
02182 
02183         } <span class="keywordflow">else</span> {
02184 
02185             Iterator-&gt;MergedHead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02186             Iterator-&gt;Current = first;
02187         }
02188 
02189         *Range = (PRTL_RANGE) Iterator-&gt;Current;
02190 
02191     } <span class="keywordflow">else</span> {
02192 
02193         Iterator-&gt;Current = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02194         Iterator-&gt;MergedHead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02195 
02196         *Range = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02197 
02198         status = STATUS_NO_MORE_ENTRIES;
02199     }
02200 
02201     <span class="keywordflow">return</span> status;
02202 }
02203 
02204 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02205"></a><a class="code" href="../../d2/d5/range_8c.html#a24">02205</a> <a class="code" href="../../d2/d5/range_8c.html#a24">RtlGetLastRange</a>(
02206     IN PRTL_RANGE_LIST RangeList,
02207     OUT PRTL_RANGE_LIST_ITERATOR Iterator,
02208     OUT PRTL_RANGE *Range
02209     )
02210 <span class="comment">/*++</span>
02211 <span class="comment"></span>
02212 <span class="comment">Routine Description:</span>
02213 <span class="comment"></span>
02214 <span class="comment">    This routine extracts the first range in a range list.  If there are no</span>
02215 <span class="comment">    ranges then STATUS_NO_MORE_ENTRIES is returned.</span>
02216 <span class="comment"></span>
02217 <span class="comment">Arguments:</span>
02218 <span class="comment"></span>
02219 <span class="comment">    RangeList - The range list to operate on.</span>
02220 <span class="comment"></span>
02221 <span class="comment">    Iterator - On success this contains the state of the iteration and can be</span>
02222 <span class="comment">        passed to RtlGetNextRange.</span>
02223 <span class="comment"></span>
02224 <span class="comment">    Range - On success this contains a pointer to the first range</span>
02225 <span class="comment"></span>
02226 <span class="comment">Return Value:</span>
02227 <span class="comment"></span>
02228 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
02229 <span class="comment"></span>
02230 <span class="comment">    STATUS_NO_MORE_ENTRIES</span>
02231 <span class="comment"></span>
02232 <span class="comment">--*/</span>
02233 {
02234     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
02235     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> first;
02236 
02237     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02238 
02239     <span class="comment">//</span>
02240     <span class="comment">// Fill in the first part of the iterator</span>
02241     <span class="comment">//</span>
02242 
02243     Iterator-&gt;RangeListHead = &amp;RangeList-&gt;ListHead;
02244     Iterator-&gt;Stamp = RangeList-&gt;Stamp;
02245 
02246     <span class="keywordflow">if</span> (!IsListEmpty(&amp;RangeList-&gt;ListHead)) {
02247 
02248         first = <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(RangeList-&gt;ListHead.Blink);
02249 
02250         <span class="comment">//</span>
02251         <span class="comment">// Fill in the iterator and update to point to the first merged</span>
02252         <span class="comment">// range if we are merged</span>
02253         <span class="comment">//</span>
02254 
02255         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(first)) {
02256 
02257             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;first-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead));
02258 
02259             Iterator-&gt;MergedHead = &amp;first-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead;
02260             Iterator-&gt;Current = <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(
02261                                     first-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead.Blink
02262                                     );
02263 
02264         } <span class="keywordflow">else</span> {
02265 
02266             Iterator-&gt;MergedHead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02267             Iterator-&gt;Current = first;
02268         }
02269 
02270         *Range = (PRTL_RANGE) Iterator-&gt;Current;
02271 
02272     } <span class="keywordflow">else</span> {
02273 
02274         Iterator-&gt;Current = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02275         Iterator-&gt;MergedHead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02276 
02277         *Range = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02278 
02279         status = STATUS_NO_MORE_ENTRIES;
02280     }
02281 
02282     <span class="keywordflow">return</span> status;
02283 }
02284 
02285 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02286"></a><a class="code" href="../../d2/d5/range_8c.html#a25">02286</a> <a class="code" href="../../d2/d5/range_8c.html#a25">RtlGetNextRange</a>(
02287     IN OUT PRTL_RANGE_LIST_ITERATOR Iterator,
02288     OUT    PRTL_RANGE *Range,
02289     IN     BOOLEAN MoveForwards
02290     )
02291 <span class="comment">/*++</span>
02292 <span class="comment"></span>
02293 <span class="comment">Routine Description:</span>
02294 <span class="comment"></span>
02295 <span class="comment">    This routine extracts the next range in a range list.  If there are no</span>
02296 <span class="comment">    more ranges then STATUS_NO_MORE_ENTRIES is returned.</span>
02297 <span class="comment"></span>
02298 <span class="comment">Arguments:</span>
02299 <span class="comment"></span>
02300 <span class="comment">    Iterator     - The iterator filled in by RtlGet{First|Next}Range which will</span>
02301 <span class="comment">                   be update on success.</span>
02302 <span class="comment">    Range        - On success this contains a pointer to the next range</span>
02303 <span class="comment">    MoveForwards - If true, go forwards thru the list, otherwise,</span>
02304 <span class="comment">                   go backwards.</span>
02305 <span class="comment"></span>
02306 <span class="comment">Return Value:</span>
02307 <span class="comment"></span>
02308 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
02309 <span class="comment"></span>
02310 <span class="comment">    STATUS_NO_MORE_ENTRIES</span>
02311 <span class="comment">    STATUS_INVALID_PARAMETER</span>
02312 <span class="comment"></span>
02313 <span class="comment">Note:</span>
02314 <span class="comment"></span>
02315 <span class="comment">    Add/Delete operations can not be performed on the list between calls to</span>
02316 <span class="comment">    RtlGetFirstRange / RtlGetNextRange and RtlGetNextRange / RtlGetNextRange.</span>
02317 <span class="comment">    If such calls are made the routine will detect and fail the call.</span>
02318 <span class="comment"></span>
02319 <span class="comment">--*/</span>
02320 {
02321     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> mergedEntry, next;
02322     PLIST_ENTRY entry;
02323 
02324     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02325 
02326     <span class="comment">//</span>
02327     <span class="comment">// Make sure that we haven't changed the list between calls</span>
02328     <span class="comment">//</span>
02329 
02330     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a23">RANGE_LIST_FROM_LIST_HEAD</a>(Iterator-&gt;RangeListHead)-&gt;Stamp !=
02331             Iterator-&gt;Stamp) {
02332 
02333         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(
02334             <span class="stringliteral">"RtlGetNextRange: Add/Delete operations have been performed while \</span>
02335 <span class="stringliteral">            iterating through a list\n"</span>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02336 
02337         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02338     }
02339 
02340     <span class="comment">//</span>
02341     <span class="comment">// If we have already reached the end of the list then return</span>
02342     <span class="comment">//</span>
02343 
02344     <span class="keywordflow">if</span> (!Iterator-&gt;Current) {
02345         *Range = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02346         <span class="keywordflow">return</span> STATUS_NO_MORE_ENTRIES;
02347     }
02348 
02349     entry = &amp;((<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a>)(Iterator-&gt;Current))-&gt;ListEntry;
02350     next = <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(
02351                MoveForwards ? entry-&gt;Flink : entry-&gt;Blink);
02352 
02353     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(next);
02354 
02355     <span class="comment">//</span>
02356     <span class="comment">// Are we in a merged range?</span>
02357     <span class="comment">//</span>
02358     <span class="keywordflow">if</span> (Iterator-&gt;MergedHead) {
02359 
02360         <span class="comment">//</span>
02361         <span class="comment">// Have we reached the end of the merged range?</span>
02362         <span class="comment">//</span>
02363         <span class="keywordflow">if</span> (&amp;next-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a> == Iterator-&gt;MergedHead) {
02364 
02365             <span class="comment">//</span>
02366             <span class="comment">// Get back to the merged entry</span>
02367             <span class="comment">//</span>
02368             mergedEntry = CONTAINING_RECORD(
02369                               Iterator-&gt;MergedHead,
02370                               <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
02371                               Merged.ListHead
02372                               );
02373 
02374             <span class="comment">//</span>
02375             <span class="comment">// Move on to the next entry in the main list</span>
02376             <span class="comment">//</span>
02377 
02378             next = MoveForwards ?
02379                        <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(
02380                            mergedEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>.Flink
02381                            )
02382                    :   <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(
02383                            mergedEntry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>.Blink
02384                            );
02385             Iterator-&gt;MergedHead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02386 
02387         } <span class="keywordflow">else</span> {
02388 
02389             <span class="comment">//</span>
02390             <span class="comment">// There are merged ranges left - return the next one</span>
02391             <span class="comment">//</span>
02392             Iterator-&gt;Current = next;
02393             *Range = (PRTL_RANGE) next;
02394 
02395             <span class="keywordflow">return</span> STATUS_SUCCESS;
02396         }
02397     }
02398 
02399     <span class="comment">//</span>
02400     <span class="comment">// Have we reached the end of the main list?</span>
02401     <span class="comment">//</span>
02402     <span class="keywordflow">if</span> (&amp;next-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a> == Iterator-&gt;RangeListHead) {
02403 
02404         <span class="comment">//</span>
02405         <span class="comment">// Tell the caller there are no more ranges</span>
02406         <span class="comment">//</span>
02407         Iterator-&gt;Current = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02408         *Range = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02409         <span class="keywordflow">return</span> STATUS_NO_MORE_ENTRIES;
02410 
02411     } <span class="keywordflow">else</span> {
02412 
02413         <span class="comment">//</span>
02414         <span class="comment">// Is the next range merged?</span>
02415         <span class="comment">//</span>
02416 
02417         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(next)) {
02418 
02419             <span class="comment">//</span>
02420             <span class="comment">// Goto the first merged entry</span>
02421             <span class="comment">//</span>
02422             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!Iterator-&gt;MergedHead);
02423 
02424             Iterator-&gt;MergedHead = &amp;next-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead;
02425             Iterator-&gt;Current = MoveForwards ?
02426                                     <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(
02427                                         next-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead.Flink
02428                                         )
02429                                 :   <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(
02430                                         next-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead.Blink
02431                                         );
02432         } <span class="keywordflow">else</span> {
02433 
02434             <span class="comment">//</span>
02435             <span class="comment">// Go to the next entry in the main list</span>
02436             <span class="comment">//</span>
02437 
02438             Iterator-&gt;Current = <a class="code" href="../../d3/d5/range_8h.html#a22">RANGE_LIST_ENTRY_FROM_LIST_ENTRY</a>(
02439                                     &amp;next-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o10">ListEntry</a>
02440                                     );
02441         }
02442 
02443         *Range = (PRTL_RANGE) Iterator-&gt;Current;
02444     }
02445 
02446     <span class="keywordflow">return</span> STATUS_SUCCESS;
02447 }
02448 
02449 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02450"></a><a class="code" href="../../d2/d5/range_8c.html#a26">02450</a> <a class="code" href="../../d2/d5/range_8c.html#a26">RtlMergeRangeLists</a>(
02451     OUT PRTL_RANGE_LIST MergedRangeList,
02452     IN PRTL_RANGE_LIST RangeList1,
02453     IN PRTL_RANGE_LIST RangeList2,
02454     IN ULONG Flags
02455     )
02456 <span class="comment">/*++</span>
02457 <span class="comment"></span>
02458 <span class="comment">Routine Description:</span>
02459 <span class="comment"></span>
02460 <span class="comment">    This routine merges two range lists into one.</span>
02461 <span class="comment"></span>
02462 <span class="comment">Arguments:</span>
02463 <span class="comment"></span>
02464 <span class="comment">    MergedRangeList - An empty range list where on success the result of the</span>
02465 <span class="comment">        merge will be placed.</span>
02466 <span class="comment"></span>
02467 <span class="comment">    RangeList1 - One of the range lists to be merged.</span>
02468 <span class="comment"></span>
02469 <span class="comment">    RangeList2 - The other the range list to merged.</span>
02470 <span class="comment"></span>
02471 <span class="comment">    Flags - Modifies the behaviour of the routine:</span>
02472 <span class="comment"></span>
02473 <span class="comment">        RTL_RANGE_LIST_MERGE_IF_CONFLICT - Merged ranges even if the conflict.</span>
02474 <span class="comment"></span>
02475 <span class="comment">Return Value:</span>
02476 <span class="comment"></span>
02477 <span class="comment">    Status code that indicates whether or not the function was successful:</span>
02478 <span class="comment"></span>
02479 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
02480 <span class="comment">    STATUS_RANGE_LIST_CONFLICT</span>
02481 <span class="comment"></span>
02482 <span class="comment">--*/</span>
02483 {
02484     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02485     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, currentMerged, newEntry;
02486     ULONG addFlags;
02487 
02488     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02489 
02490     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(1,
02491             (<span class="stringliteral">"RtlMergeRangeList(0x%08x, 0x%08x, 0x%08x, 0x%08x)\n"</span>,
02492             MergedRangeList,
02493             RangeList1,
02494             RangeList2,
02495             Flags
02496             ));
02497 
02498     <span class="comment">//</span>
02499     <span class="comment">// Copy the first range list</span>
02500     <span class="comment">//</span>
02501 
02502     status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(MergedRangeList, RangeList1);
02503 
02504     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02505         <span class="keywordflow">goto</span> cleanup;
02506     }
02507 
02508     <span class="comment">//</span>
02509     <span class="comment">// Add all ranges from 2nd list</span>
02510     <span class="comment">//</span>
02511 
02512     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>, &amp;RangeList2-&gt;ListHead, current) {
02513 
02514         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(current)) {
02515 
02516             <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
02517                             &amp;current-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead,
02518                             currentMerged) {
02519 
02520                 <span class="keywordflow">if</span> (!(newEntry = <a class="code" href="../../d2/d5/range_8c.html#a12">RtlpCopyRangeListEntry</a>(currentMerged))) {
02521                         status = STATUS_INSUFFICIENT_RESOURCES;
02522                         <span class="keywordflow">goto</span> cleanup;
02523                 }
02524 
02525                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a7">CONFLICT</a>(currentMerged)) {
02526 
02527                     <span class="comment">//</span>
02528                     <span class="comment">// If a range was already conflicting in then it will conflict in</span>
02529                     <span class="comment">// the merged range list - allow this.</span>
02530                     <span class="comment">//</span>
02531 
02532                     addFlags = Flags | RTL_RANGE_LIST_ADD_IF_CONFLICT;
02533                 } <span class="keywordflow">else</span> {
02534 
02535                     addFlags = Flags;
02536                 }
02537 
02538                 status = <a class="code" href="../../d2/d5/range_8c.html#a6">RtlpAddRange</a>(&amp;MergedRangeList-&gt;ListHead,
02539                                       newEntry,
02540                                       addFlags
02541                                       );
02542 
02543             }
02544 
02545         } <span class="keywordflow">else</span> {
02546 
02547 
02548             <span class="keywordflow">if</span> (!(newEntry = <a class="code" href="../../d2/d5/range_8c.html#a12">RtlpCopyRangeListEntry</a>(current))){
02549                 status = STATUS_INSUFFICIENT_RESOURCES;
02550                 <span class="keywordflow">goto</span> cleanup;
02551             }
02552 
02553             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a7">CONFLICT</a>(current)) {
02554 
02555                 <span class="comment">//</span>
02556                 <span class="comment">// If a range was already conflicting in then it will conflict in</span>
02557                 <span class="comment">// the merged range list - allow this.</span>
02558                 <span class="comment">//</span>
02559 
02560                 addFlags = Flags | RTL_RANGE_LIST_ADD_IF_CONFLICT;
02561             } <span class="keywordflow">else</span> {
02562                 addFlags = Flags;
02563             }
02564 
02565             status = <a class="code" href="../../d2/d5/range_8c.html#a6">RtlpAddRange</a>(&amp;MergedRangeList-&gt;ListHead,
02566                                   newEntry,
02567                                   addFlags
02568                                   );
02569 
02570             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02571                 <span class="keywordflow">goto</span> cleanup;
02572             }
02573         }
02574 
02575     }
02576     <span class="comment">//</span>
02577     <span class="comment">// Correct the count</span>
02578     <span class="comment">//</span>
02579 
02580     MergedRangeList-&gt;Count += RangeList2-&gt;Count;
02581     MergedRangeList-&gt;Stamp += RangeList2-&gt;Count;
02582 
02583     <span class="keywordflow">return</span> status;
02584 
02585 cleanup:
02586 
02587     <span class="comment">//</span>
02588     <span class="comment">// Something went wrong... Free up what we have built of the</span>
02589     <span class="comment">// new list and return the error</span>
02590     <span class="comment">//</span>
02591 
02592     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(MergedRangeList);
02593 
02594     <span class="keywordflow">return</span> status;
02595 
02596 }
02597 
02598 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02599"></a><a class="code" href="../../d2/d5/range_8c.html#a27">02599</a> <a class="code" href="../../d2/d5/range_8c.html#a27">RtlInvertRangeList</a>(
02600     OUT PRTL_RANGE_LIST InvertedRangeList,
02601     IN PRTL_RANGE_LIST RangeList
02602     )
02603 <span class="comment">/*</span>
02604 <span class="comment"></span>
02605 <span class="comment">Routine Description:</span>
02606 <span class="comment"></span>
02607 <span class="comment">    This inverts a range list so that all areas which are allocated</span>
02608 <span class="comment">    in InvertedRangeList will not be in RangeList, and vice</span>
02609 <span class="comment">    versa. The ranges in InvertedRangeList will all be owned by NULL.</span>
02610 <span class="comment"></span>
02611 <span class="comment">Arguments:</span>
02612 <span class="comment"></span>
02613 <span class="comment">    InvertedRangeList - a pointer to an empty Range List to be filled</span>
02614 <span class="comment">        with the inverted list</span>
02615 <span class="comment"></span>
02616 <span class="comment">    RangeList - a pointer to the Range List to be inverted</span>
02617 <span class="comment"></span>
02618 <span class="comment">Return Value:</span>
02619 <span class="comment"></span>
02620 <span class="comment">    Status of operation.</span>
02621 <span class="comment"></span>
02622 <span class="comment">*/</span>
02623 
02624 {
02625 
02626     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> currentRange;
02627     ULONGLONG currentStart = 0;
02628     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02629 
02630     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02631 
02632     <span class="comment">//</span>
02633     <span class="comment">// if Inverted List does not start out empty, the inverted list</span>
02634     <span class="comment">// is meaningless</span>
02635     <span class="comment">//</span>
02636 
02637     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(InvertedRangeList-&gt;Count == 0);
02638 
02639     <span class="comment">//</span>
02640     <span class="comment">// iterate through all elements of the ReverseAllocation</span>
02641     <span class="comment">// adding the unallocated part before the current element</span>
02642     <span class="comment">// to the RealAllocation</span>
02643     <span class="comment">//</span>
02644 
02645     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
02646                     &amp;RangeList-&gt;ListHead,
02647                     currentRange) {
02648 
02649         <span class="keywordflow">if</span> (currentRange-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a> &gt; currentStart) {
02650 
02651             <span class="comment">//</span>
02652             <span class="comment">// we want a NULL range owner to show that the</span>
02653             <span class="comment">// range is unavailable</span>
02654             <span class="comment">//</span>
02655             status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(InvertedRangeList,
02656                                  currentStart,
02657                                  currentRange-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a>-1,
02658                                  0,            <span class="comment">// Attributes</span>
02659                                  0,            <span class="comment">// Flags</span>
02660                                  0,            <span class="comment">// UserData</span>
02661                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);        <span class="comment">// Owner</span>
02662 
02663             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02664                 <span class="keywordflow">return</span> status;
02665             }
02666         }
02667 
02668         currentStart = currentRange-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o1">End</a> + 1;
02669     }
02670 
02671     <span class="comment">//</span>
02672     <span class="comment">// add the portion of the address space above the last</span>
02673     <span class="comment">// element in the ReverseAllocation to the RealAllocation</span>
02674     <span class="comment">//</span>
02675     <span class="comment">// unless we've wrapped, in which case we've already added</span>
02676     <span class="comment">// the last element</span>
02677     <span class="comment">//</span>
02678 
02679     <span class="keywordflow">if</span> (currentStart &gt; (currentStart - 1)) {
02680 
02681         status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(InvertedRangeList,
02682                              currentStart,
02683                              <a class="code" href="../../d8/d9/pnpbusno_8c.html#a0">MAX_ULONGLONG</a>,
02684                              0,
02685                              0,
02686                              0,
02687                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02688 
02689         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02690             <span class="keywordflow">return</span> status;
02691         }
02692     }
02693 
02694     <span class="keywordflow">return</span> STATUS_SUCCESS;
02695 
02696 }
02697 
02698 
02699 <span class="preprocessor">#if DBG</span>
02700 <span class="preprocessor"></span>
02701 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02702 <a class="code" href="../../d2/d5/range_8c.html#a0">RtlpDumpRangeListEntry</a>(
02703     LONG Level,
02704     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> Entry,
02705     BOOLEAN Indent
02706     )
02707 {
02708     PWSTR indentString;
02709     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current;
02710 
02711     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02712 
02713     <span class="keywordflow">if</span> (Indent) {
02714         indentString = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\t\t"</span>;
02715     } <span class="keywordflow">else</span> {
02716         indentString = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
02717     }
02718     <span class="comment">//</span>
02719     <span class="comment">// Print the range</span>
02720     <span class="comment">//</span>
02721 
02722     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level,
02723                 (<span class="stringliteral">"%sRange (0x%08x): 0x%I64x-0x%I64x\n"</span>,
02724                 indentString,
02725                 Entry,
02726                 Entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o0">Start</a>,
02727                 Entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o1">End</a>
02728                 ));
02729 
02730     <span class="comment">//</span>
02731     <span class="comment">// Print the flags</span>
02732     <span class="comment">//</span>
02733 
02734     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level, (<span class="stringliteral">"%s\tPrivateFlags: "</span>, indentString));
02735 
02736     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(Entry)) {
02737         <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level, (<span class="stringliteral">"MERGED "</span>));
02738 
02739     }
02740 
02741     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level, (<span class="stringliteral">"\n%s\tPublicFlags: "</span>, indentString));
02742 
02743     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a6">SHARED</a>(Entry)) {
02744         <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level, (<span class="stringliteral">"SHARED "</span>));
02745     }
02746 
02747     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a7">CONFLICT</a>(Entry)) {
02748         <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level, (<span class="stringliteral">"CONFLICT "</span>));
02749     }
02750 
02751     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level, (<span class="stringliteral">"\n"</span>));
02752 
02753 
02754     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/range_8h.html#a5">MERGED</a>(Entry)) {
02755 
02756         <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level, (<span class="stringliteral">"%sMerged entries:\n"</span>, indentString));
02757 
02758         <span class="comment">//</span>
02759         <span class="comment">// Print the merged entries</span>
02760         <span class="comment">//</span>
02761 
02762         <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>,
02763                         &amp;Entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o6">Merged</a>.ListHead,
02764                         current) {
02765             <a class="code" href="../../d2/d5/range_8c.html#a0">RtlpDumpRangeListEntry</a>(Level, current, TRUE);
02766         }
02767 
02768 
02769     } <span class="keywordflow">else</span> {
02770 
02771         <span class="comment">//</span>
02772         <span class="comment">// Print the other data</span>
02773         <span class="comment">//</span>
02774 
02775         <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level,
02776             (<span class="stringliteral">"%s\tUserData: 0x%08x\n\tOwner: 0x%08x\n"</span>,
02777             indentString,
02778             Entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o4">Allocated</a>.UserData,
02779             Entry-&gt;<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html#o4">Allocated</a>.Owner
02780             ));
02781     }
02782 }
02783 
02784 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02785 <a class="code" href="../../d2/d5/range_8c.html#a1">RtlpDumpRangeList</a>(
02786     LONG Level,
02787     PRTL_RANGE_LIST RangeList
02788     )
02789 
02790 {
02791     <a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">PRTLP_RANGE_LIST_ENTRY</a> current, currentMerged;
02792 
02793     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02794 
02795     <a class="code" href="../../d7/d9/pnparb_8c.html#a1">DEBUG_PRINT</a>(Level,
02796                 (<span class="stringliteral">"*** Range List (0x%08x) - Count: %i\n"</span>,
02797                 RangeList,
02798                 RangeList-&gt;Count
02799                 ));
02800 
02801     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d7/d6/struct__RTLP__RANGE__LIST__ENTRY.html">RTLP_RANGE_LIST_ENTRY</a>, &amp;RangeList-&gt;ListHead, current) {
02802 
02803         <span class="comment">//</span>
02804         <span class="comment">// Print the entry</span>
02805         <span class="comment">//</span>
02806 
02807         <a class="code" href="../../d2/d5/range_8c.html#a0">RtlpDumpRangeListEntry</a>(Level, current, FALSE);
02808     }
02809 }
02810 
02811 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
