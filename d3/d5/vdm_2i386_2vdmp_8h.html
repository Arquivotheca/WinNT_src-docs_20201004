<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: vdm/i386/vdmp.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>vdmp.h File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d2/d4/vdmntos_8h-source.html">vdmntos.h</a>&gt;</code><br>

<p>
<a href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a0">VDMTIB_KMODE</a>&nbsp;&nbsp;&nbsp;0x0001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a1">VDMTIB_PROBE</a>&nbsp;&nbsp;&nbsp;0x0002</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a2">VDMTIB_KPROBE</a>&nbsp;&nbsp;&nbsp;(VDMTIB_KMODE|VDMTIB_PROBE)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a3">VdmpInitialize</a> (PVDMICAUSERDATA pIcaUserData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a4">VdmpStartExecution</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a5">VdmSwapContexts</a> (IN PKTRAP_FRAME TrapFrame, IN PCONTEXT InContext, IN PCONTEXT OutContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a6">VdmpQueueInterrupt</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a7">VdmpDelayInterrupt</a> (PVDMDELAYINTSDATA pdsd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a8">VdmpEnterIcaLock</a> (IN PRTL_CRITICAL_SECTION pIcaLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a9">VdmpLeaveIcaLock</a> (IN PRTL_CRITICAL_SECTION pIcaLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a10">VdmpDispatchableIntPending</a> (IN ULONG EFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a11">VdmpIsThreadTerminating</a> (HANDLE ThreadId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a12">VdmPrinterStatus</a> (ULONG iPort, ULONG cbInstructionSize, PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a13">VdmPrinterWriteData</a> (ULONG iPort, ULONG cbInstructionSize, PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a14">VdmpPrinterDirectIoOpen</a> (PVOID ServiceData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a15">VdmpPrinterDirectIoClose</a> (PVOID ServiceData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a16">VdmTraceEvent</a> (<a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Type, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> wData, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> lData, PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a17">VdmpPrinterInitialize</a> (PVOID ServiceData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib</a> (<a class="el" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> *ppVdmTib, ULONG <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="vdm/i386/vdmp.h::VDMTIB_KMODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define VDMTIB_KMODE&nbsp;&nbsp;&nbsp;0x0001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00198">198</a> of file <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html">vdm/i386/vdmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/rdwr_8c-source.html#l00050">NTFastDOSIO()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00236">VdmFlushPrinterWriteData()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00295">VdmpPrinterInitialize()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00042">VdmPrinterStatus()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00177">VdmPrinterWriteData()</a>, and <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00040">VdmpStartExecution()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="vdm/i386/vdmp.h::VDMTIB_KPROBE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define VDMTIB_KPROBE&nbsp;&nbsp;&nbsp;(VDMTIB_KMODE|VDMTIB_PROBE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00200">200</a> of file <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html">vdm/i386/vdmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/vdmnpx_8c-source.html#l00054">VdmDispatchIRQ13()</a>, <a class="el" href="../../d7/d3/vdmfault_8c-source.html#l00036">VdmDispatchPageFault()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="vdm/i386/vdmp.h::VDMTIB_PROBE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define VDMTIB_PROBE&nbsp;&nbsp;&nbsp;0x0002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00199">199</a> of file <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html">vdm/i386/vdmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/vdminit_8c-source.html#l00019">VdmpInitialize()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="vdm/i386/vdmp.h::VdmpDelayInterrupt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpDelayInterrupt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVDMDELAYINTSDATA&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pdsd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01235">1235</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00013">Delay</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00039">KeInitializeDpc()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00043">KeInitializeTimer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02775">KeMinimumIncrement</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00243">KeSetTimer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02813">KeTimeIncrement</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">ObReferenceObjectByPointer()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00258">_EPROCESS::VdmObjects</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01583">VdmpDelayIntDpcRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>01241                    :
01242 
01243     Sets a timer to dispatch <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed interrupt through <a class="code" href="../../d4/d9/ke_8h.html#a345">KeSetTimer</a>.
01244     When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer fires a user mode APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> queued to queue <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interrupt.
01245 
01246     This function uses lazy allocation <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> to allocate internal
01247     data structures (nonpaged pool) on a per Irq basis, and needs to
01248     be notified when specific Irq Lines no longer need Delayed
01249     Interrupt services.
01250 
01251     The caller must own <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IcaLock to synchronize access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01252     Irq lists.
01253 
01254     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>: - Until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Delayed interrupt fires or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled,
01255                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specific Irq line will not generate any interrupts.
01256 
01257              - The APC routine, does not take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HostIca lock, when
01258                unblocking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrqLine. Devices which use delayed Interrupts
01259                should not queue ANY additional interrupts <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d5/d5/vdmprint_8h.html#a7">IRQ</a>
01260                line until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed interrupt has fired or been cancelled.
01261 
01262 Arguments:
01263 
01264     pdsd.Delay         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> Interval in usecs
01265                        <span class="keywordflow">if</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 0xFFFFFFFF then per Irq Line nonpaged
01266                            data structures are freed. No Timers are set.
01267                        <span class="keywordflow">else</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer delay.
01268 
01269     pdsd.DelayIrqLine  IrqLine Number
01270 
01271     pdsd.hThread       Thread <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of CurrentMonitorTeb
01272 
01273 
01274 Return Value:
01275 
01276     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
01277 
01278 --*/
01279 
01280 {
01281     PVDM_PROCESS_OBJECTS pVdmObjects;
01282     PLIST_ENTRY   Next;
01283     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>     Process;
01284     PDELAYINTIRQ  pDelayIntIrq;
01285     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>      Thread, MainThread;
01286     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01287     KIRQL         OldIrql;
01288     ULONG         IrqLine;
01289     ULONG         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a>;
01290     PULONG        pDelayIrq;
01291     PULONG        pUndelayIrq;
01292     LARGE_INTEGER liDelay;
01293     BOOLEAN       FreeIrqLine, AlreadyInUse;
01294 
01295 
01296 
01297     <span class="comment">//</span>
01298     <span class="comment">// Get a pointer to pVdmObjects</span>
01299     <span class="comment">//</span>
01300     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01301     pVdmObjects = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>;
01302     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.VdmFlag != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || !pVdmObjects) {
01303         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
01304         }
01305 
01306     ExAcquireFastMutex(&amp;pVdmObjects-&gt;DelayIntFastMutex);
01307 
01308     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01309     Thread = MainThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01310     FreeIrqLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01311     AlreadyInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01312 
01313     <span class="keywordflow">try</span> {
01314 
01315         <span class="comment">//</span>
01316         <span class="comment">// Probe the parameters</span>
01317         <span class="comment">//</span>
01318         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pdsd, <span class="keyword">sizeof</span>(VDMDELAYINTSDATA), <span class="keyword">sizeof</span>(ULONG));
01319 
01320         <span class="comment">//</span>
01321         <span class="comment">// Form a BitMask for the IrqLine Number</span>
01322         <span class="comment">//</span>
01323         IrqLine = 1 &lt;&lt; pdsd-&gt;DelayIrqLine;
01324         <span class="keywordflow">if</span> (!IrqLine) {
01325             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
01326             <span class="keywordflow">goto</span> VidEarlyExit;
01327             }
01328 
01329         pDelayIrq = pVdmObjects-&gt;pIcaUserData-&gt;pDelayIrq;
01330         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pDelayIrq);
01331         pUndelayIrq = pVdmObjects-&gt;pIcaUserData-&gt;pUndelayIrq;
01332         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pUndelayIrq);
01333 
01334 
01335         <span class="comment">//</span>
01336         <span class="comment">// Copy out the Delay parameter, and convert hundreths nanosecs</span>
01337         <span class="comment">//</span>
01338         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> = pdsd-&gt;Delay;
01339 
01340         <span class="comment">//</span>
01341         <span class="comment">// Check to see if we need to reset the timer resolution</span>
01342         <span class="comment">//</span>
01343         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> == 0xFFFFFFFF) {
01344             ZwSetTimerResolution(KeMaximumIncrement, FALSE, &amp;Delay);
01345             <span class="keywordflow">goto</span> VidEarlyExit;
01346             }
01347 
01348 
01349          FreeIrqLine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01350 
01351             <span class="comment">// convert delay to hundreths of nanosecs</span>
01352             <span class="comment">// and ensure min delay of 1 msec</span>
01353             <span class="comment">//</span>
01354          <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &lt; 1000 ? 10000 : <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> * 10;
01355 
01356             <span class="comment">//</span>
01357             <span class="comment">// If the delay time is close to the system's clock rate</span>
01358             <span class="comment">// then adjust the system's clock rate and if needed</span>
01359             <span class="comment">// the delay time so that the timer will fire before the</span>
01360             <span class="comment">// the due time.</span>
01361             <span class="comment">//</span>
01362          <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &lt; 150000) {
01363              ULONG ul = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &gt;&gt; 1;
01364 
01365              <span class="keywordflow">if</span> (ul &lt; KeTimeIncrement &amp;&amp; KeTimeIncrement &gt; <a class="code" href="../../d4/d9/ke_8h.html#a132">KeMinimumIncrement</a>) {
01366                  ZwSetTimerResolution(ul, TRUE, (PULONG)&amp;liDelay.LowPart);
01367                  }
01368 
01369              <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &lt; <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a>) {
01370                  <span class="comment">// can't set system clock rate low enuf, so use half delay</span>
01371                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &gt;&gt;= 1;
01372                  }
01373              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &lt; (<a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a> &lt;&lt; 1)) {
01374                  <span class="comment">// Real close to the system clock rate, lower delay</span>
01375                  <span class="comment">// proportionally, to avoid missing clock cycles.</span>
01376                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> -= <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a> &gt;&gt; 1;
01377                  }
01378              }
01379 
01380          <span class="comment">//</span>
01381          <span class="comment">// Reference the Target Thread</span>
01382          <span class="comment">//</span>
01383          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01384                           pdsd-&gt;hThread,
01385                           THREAD_QUERY_INFORMATION,
01386                           PsThreadType,
01387                           KeGetPreviousMode(),
01388                           &amp;Thread,
01389                           NULL
01390                           );
01391          <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01392              Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01393              <span class="keywordflow">goto</span> VidEarlyExit;
01394              }
01395 
01396 
01397          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>(
01398                           pVdmObjects-&gt;MainThread,
01399                           THREAD_QUERY_INFORMATION,
01400                           PsThreadType,
01401                           KernelMode
01402                           );
01403          <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01404              MainThread = pVdmObjects-&gt;MainThread;
01405              }
01406          <span class="keywordflow">else</span> {
01407              <span class="keywordflow">goto</span> VidEarlyExit;
01408              }
01409 
01410 VidEarlyExit:;
01411         }
01412    except(EXCEPTION_EXECUTE_HANDLER) {
01413         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01414         }
01415 
01416    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01417        ExReleaseFastMutex(&amp;pVdmObjects-&gt;DelayIntFastMutex);
01418        <span class="keywordflow">if</span> (Thread) {
01419            <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01420            }
01421 
01422        <span class="keywordflow">if</span> (MainThread) {
01423            <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MainThread);
01424            }
01425 
01426        <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01427        }
01428 
01429 
01430 
01431    <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, &amp;OldIrql);
01432 
01433    <span class="keywordflow">try</span> {
01434 
01435         <span class="comment">//</span>
01436         <span class="comment">// Search the DelayedIntList for a matching Irq Line.</span>
01437         <span class="comment">//</span>
01438         Next = pVdmObjects-&gt;DelayIntListHead.Flink;
01439         <span class="keywordflow">while</span> (Next != &amp;pVdmObjects-&gt;DelayIntListHead) {
01440             pDelayIntIrq = CONTAINING_RECORD(Next, DELAYINTIRQ, DelayIntListEntry);
01441             <span class="keywordflow">if</span> (pDelayIntIrq-&gt;IrqLine == IrqLine) {
01442                 <span class="keywordflow">break</span>;
01443                 }
01444             Next = Next-&gt;Flink;
01445             }
01446 
01447         <span class="keywordflow">if</span> (Next == &amp;pVdmObjects-&gt;DelayIntListHead) {
01448             pDelayIntIrq = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01449             }
01450 
01451 
01452         <span class="keywordflow">if</span> (!pDelayIntIrq) {
01453             <span class="keywordflow">if</span> (FreeIrqLine) {
01454                 <span class="keywordflow">goto</span> VidExit;
01455                 }
01456 
01457             <span class="comment">//</span>
01458             <span class="comment">// If a DelayIntIrq does not exist for this irql, allocate from nonpaged</span>
01459             <span class="comment">// pool and initialize it</span>
01460             <span class="comment">//</span>
01461 
01462             pDelayIntIrq = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
01463                                                  <span class="keyword">sizeof</span>(DELAYINTIRQ),
01464                                                  ' MDV');
01465 
01466             <span class="keywordflow">if</span> (!pDelayIntIrq) {
01467                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01468                 <span class="keywordflow">goto</span> VidExit;
01469                 }
01470 
01471 
01472             <span class="keywordflow">try</span> {
01473                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(Process, NonPagedPool, <span class="keyword">sizeof</span>(DELAYINTIRQ));
01474                 }
01475             except(EXCEPTION_EXECUTE_HANDLER) {
01476                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01477                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDelayIntIrq);
01478                 <span class="keywordflow">goto</span> VidExit;
01479                 }
01480             RtlZeroMemory(pDelayIntIrq, <span class="keyword">sizeof</span>(DELAYINTIRQ));
01481             pDelayIntIrq-&gt;IrqLine = IrqLine;
01482 
01483             <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;pDelayIntIrq-&gt;Timer);
01484 
01485             <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(&amp;pDelayIntIrq-&gt;Dpc,
01486                             VdmpDelayIntDpcRoutine,
01487                             Process
01488                             );
01489 
01490             InsertTailList(&amp;pVdmObjects-&gt;DelayIntListHead,
01491                            &amp;pDelayIntIrq-&gt;DelayIntListEntry
01492                            );
01493             }
01494 
01495 
01496          <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> == 0xFFFFFFFF) {
01497              <span class="keywordflow">if</span> (pDelayIntIrq-&gt;InUse == VDMDELAY_KTIMER) {
01498                  pDelayIntIrq-&gt;InUse = VDMDELAY_NOTINUSE;
01499                  pDelayIntIrq = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01500                  }
01501              }
01502          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pDelayIntIrq-&gt;InUse == VDMDELAY_NOTINUSE) {
01503              liDelay = RtlEnlargedIntegerMultiply(Delay, -1);
01504              <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;pDelayIntIrq-&gt;Timer, liDelay, &amp;pDelayIntIrq-&gt;Dpc);
01505              <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
01506              }
01507 
01508 VidExit:;
01509         }
01510     except(EXCEPTION_EXECUTE_HANDLER)  {
01511         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01512         }
01513 
01514     <span class="keywordflow">if</span> (pDelayIntIrq &amp;&amp; !pDelayIntIrq-&gt;InUse) {
01515 
01516         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01517             <span class="comment">//</span>
01518             <span class="comment">// Save PETHREAD of Target thread for the dpc routine</span>
01519             <span class="comment">// the DPC routine will deref the threads.</span>
01520             <span class="comment">//</span>
01521             pDelayIntIrq-&gt;InUse = VDMDELAY_KTIMER;
01522             pDelayIntIrq-&gt;Thread = Thread;
01523             Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01524             pDelayIntIrq-&gt;MainThread = MainThread;
01525             MainThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01526             }
01527         <span class="keywordflow">else</span> {
01528             pDelayIntIrq-&gt;InUse = VDMDELAY_NOTINUSE;
01529             pDelayIntIrq-&gt;Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01530             FreeIrqLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01531             }
01532         }
01533     <span class="keywordflow">else</span> {
01534         AlreadyInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01535         }
01536 
01537 
01538 
01539     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, OldIrql);
01540 
01541     <span class="keywordflow">try</span> {
01542         <span class="keywordflow">if</span> (FreeIrqLine) {
01543             *pDelayIrq &amp;= ~IrqLine;
01544             _asm {
01545                mov eax, pUndelayIrq
01546                mov ebx, IrqLine
01547                lock or [eax], ebx
01548                }
01549             }
01550         <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!AlreadyInUse) {  <span class="comment">// TakeIrqLine</span>
01551             *pDelayIrq |= IrqLine;
01552             _asm {
01553                mov eax, pUndelayIrq
01554                mov ebx, IrqLine
01555                not ebx
01556                lock and [eax], ebx
01557                }
01558             }
01559         }
01560     except(EXCEPTION_EXECUTE_HANDLER)  {
01561         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01562         }
01563 
01564     ExReleaseFastMutex(&amp;pVdmObjects-&gt;DelayIntFastMutex);
01565 
01566     <span class="keywordflow">if</span> (Thread) {
01567         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01568         }
01569 
01570     <span class="keywordflow">if</span> (MainThread) {
01571         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MainThread);
01572         }
01573 
01574     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01575 
01576 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="vdm/i386/vdmp.h::VdmpDispatchableIntPending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN VdmpDispatchableIntPending           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>EFlags</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="vdm/i386/vdmp.h::VdmpEnterIcaLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpEnterIcaLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pIcaLock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="vdm/i386/vdmp.h::VdmpGetVdmTib" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpGetVdmTib           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ppVdmTib</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d4/rdwr_8c-source.html#l00050">NTFastDOSIO()</a>, <a class="el" href="../../d1/d4/vdmnpx_8c-source.html#l00054">VdmDispatchIRQ13()</a>, <a class="el" href="../../d7/d3/vdmfault_8c-source.html#l00036">VdmDispatchPageFault()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00236">VdmFlushPrinterWriteData()</a>, <a class="el" href="../../d8/d3/vdminit_8c-source.html#l00019">VdmpInitialize()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00295">VdmpPrinterInitialize()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00042">VdmPrinterStatus()</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00177">VdmPrinterWriteData()</a>, and <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00040">VdmpStartExecution()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="vdm/i386/vdmp.h::VdmpInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVDMICAUSERDATA&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pIcaUserData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/vdminit_8c-source.html#l00019">19</a> of file <a class="el" href="../../d8/d3/vdminit_8c-source.html">vdminit.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00170">CmRegistryMachineHardwareDescriptionSystemName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d2/i386init_8c-source.html#l00038">KeI386MachineType</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d8/d3/vdminit_8c-source.html#l00011">KEY_VALUE_BUFFER_SIZE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00258">_EPROCESS::VdmObjects</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib()</a>, and <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00199">VDMTIB_PROBE</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>00025                    :
00026 
00027     Initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space of a VDM.
00028 
00029 Arguments:
00030 
00031     None,
00032 
00033 Return Value:
00034 
00035     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
00036 
00037 --*/
00038 
00039 {
00040     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, StatusCopy;
00041     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00042     UNICODE_STRING SectionName;
00043     UNICODE_STRING WorkString;
00044     ULONG ViewSize;
00045     LARGE_INTEGER ViewBase;
00046     PVOID BaseAddress;
00047     PVOID destination;
00048     HANDLE SectionHandle, RegistryHandle;
00049     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00050     ULONG ResultLength;
00051     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00052     PCM_FULL_RESOURCE_DESCRIPTOR ResourceDescriptor;
00053     PCM_PARTIAL_RESOURCE_DESCRIPTOR PartialResourceDescriptor;
00054     PKEY_VALUE_FULL_INFORMATION KeyValueBuffer;
00055     PCM_ROM_BLOCK BiosBlock;
00056     ULONG LastMappedAddress;
00057     PVDM_PROCESS_OBJECTS pVdmObjects = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00058     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PagedQuotaCharged = 0;
00059     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NonPagedQuotaCharged = 0;
00060     HANDLE hThread;
00061     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib;
00062 
00063 
00064     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00065 
00066     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib</a>(&amp;VdmTib, VDMTIB_PROBE); <span class="comment">// take from user mode and probe</span>
00067 
00068     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00069         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00070     }
00071 
00072     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> &amp; MACHINE_TYPE_PC_9800_COMPATIBLE) == 0) {
00073 
00074         <span class="comment">//</span>
00075         <span class="comment">// This is PC/AT (and FMR in Japan) VDM.</span>
00076         <span class="comment">//</span>
00077 
00078         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00079             &amp;SectionName,
00080             L<span class="stringliteral">"\\Device\\PhysicalMemory"</span>
00081             );
00082 
00083         InitializeObjectAttributes(
00084             &amp;ObjectAttributes,
00085             &amp;SectionName,
00086             OBJ_CASE_INSENSITIVE|OBJ_KERNEL_HANDLE,
00087             (HANDLE) NULL,
00088             (PSECURITY_DESCRIPTOR) NULL
00089             );
00090 
00091         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenSection(
00092             &amp;SectionHandle,
00093             SECTION_ALL_ACCESS,
00094             &amp;ObjectAttributes
00095             );
00096 
00097         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00098 
00099             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00100 
00101         }
00102 
00103         <span class="comment">//</span>
00104         <span class="comment">// Copy the first page of memory into the VDM's address space</span>
00105         <span class="comment">//</span>
00106 
00107         BaseAddress = 0;
00108         destination = 0;
00109         ViewSize = 0x1000;
00110         ViewBase.LowPart = 0;
00111         ViewBase.HighPart = 0;
00112 
00113         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwMapViewOfSection(
00114             SectionHandle,
00115             NtCurrentProcess(),
00116             &amp;BaseAddress,
00117             0,
00118             ViewSize,
00119             &amp;ViewBase,
00120             &amp;ViewSize,
00121             ViewUnmap,
00122             0,
00123             PAGE_READWRITE
00124             );
00125 
00126         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00127            ZwClose(SectionHandle);
00128            <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00129         }
00130 
00131         <span class="comment">// problem with this statement below --</span>
00132         <span class="comment">// it could be a non-vdm process and copying memory to address 0</span>
00133         <span class="comment">// should be guarded against</span>
00134 
00135         StatusCopy = STATUS_SUCCESS;
00136         <span class="keywordflow">try</span> {
00137             RtlMoveMemory(
00138                destination,
00139                BaseAddress,
00140                ViewSize
00141                );
00142         }
00143         except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00144            StatusCopy = GetExceptionCode();
00145         }
00146 
00147 
00148         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwUnmapViewOfSection(
00149             NtCurrentProcess(),
00150             BaseAddress
00151             );
00152 
00153         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(StatusCopy)) {
00154            ZwClose(SectionHandle);
00155            <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ? StatusCopy : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00156         }
00157 
00158         <span class="comment">//</span>
00159         <span class="comment">// Map Rom into address space</span>
00160         <span class="comment">//</span>
00161 
00162         BaseAddress = (PVOID) 0x000C0000;
00163         ViewSize = 0x40000;
00164         ViewBase.LowPart = 0x000C0000;
00165         ViewBase.HighPart = 0;
00166 
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">// First unmap the reserved memory.  This must be done here to prevent</span>
00170         <span class="comment">// the virtual memory in question from being consumed by some other</span>
00171         <span class="comment">// alloc vm call.</span>
00172         <span class="comment">//</span>
00173 
00174         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory(
00175             NtCurrentProcess(),
00176             &amp;BaseAddress,
00177             &amp;ViewSize,
00178             MEM_RELEASE
00179             );
00180 
00181         <span class="comment">// N.B.  This should probably take into account the fact that there are</span>
00182         <span class="comment">// a handfull of error conditions that are ok.  (such as no memory to</span>
00183         <span class="comment">// release.)</span>
00184 
00185         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00186             ZwClose(SectionHandle);
00187             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00188 
00189         }
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// Set up and open KeyPath</span>
00193         <span class="comment">//</span>
00194 
00195         InitializeObjectAttributes(
00196             &amp;ObjectAttributes,
00197             &amp;CmRegistryMachineHardwareDescriptionSystemName,
00198             OBJ_CASE_INSENSITIVE|OBJ_KERNEL_HANDLE,
00199             (HANDLE)NULL,
00200             NULL
00201             );
00202 
00203         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(
00204             &amp;RegistryHandle,
00205             KEY_READ,
00206             &amp;ObjectAttributes
00207             );
00208 
00209         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00210             ZwClose(SectionHandle);
00211             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00212         }
00213 
00214         <span class="comment">//</span>
00215         <span class="comment">// Allocate space for the data</span>
00216         <span class="comment">//</span>
00217 
00218         KeyValueBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00219             PagedPool,
00220             KEY_VALUE_BUFFER_SIZE,
00221             ' MDV'
00222             );
00223 
00224         <span class="keywordflow">if</span> (KeyValueBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00225             ZwClose(RegistryHandle);
00226             ZwClose(SectionHandle);
00227             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00228         }
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">// Get the data for the rom information</span>
00232         <span class="comment">//</span>
00233 
00234         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00235             &amp;WorkString,
00236             L<span class="stringliteral">"Configuration Data"</span>
00237             );
00238 
00239         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey(
00240             RegistryHandle,
00241             &amp;WorkString,
00242             KeyValueFullInformation,
00243             KeyValueBuffer,
00244             KEY_VALUE_BUFFER_SIZE,
00245             &amp;ResultLength
00246             );
00247 
00248         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00249             ZwClose(RegistryHandle);
00250             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueBuffer);
00251             ZwClose(SectionHandle);
00252             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00253         }
00254 
00255         ResourceDescriptor = (PCM_FULL_RESOURCE_DESCRIPTOR)
00256             ((PUCHAR) KeyValueBuffer + KeyValueBuffer-&gt;DataOffset);
00257 
00258         <span class="keywordflow">if</span> ((KeyValueBuffer-&gt;DataLength &lt; <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR)) ||
00259             (ResourceDescriptor-&gt;PartialResourceList.Count &lt; 2)
00260         ) {
00261             ZwClose(RegistryHandle);
00262             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueBuffer);
00263             ZwClose(SectionHandle);
00264             <span class="comment">// No rom blocks.</span>
00265             <span class="keywordflow">return</span> STATUS_SUCCESS;
00266         }
00267 
00268         PartialResourceDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
00269             ((PUCHAR)ResourceDescriptor +
00270             <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR) +
00271             ResourceDescriptor-&gt;PartialResourceList.PartialDescriptors[0]
00272                 .u.DeviceSpecificData.DataSize);
00273 
00274 
00275         <span class="keywordflow">if</span> (KeyValueBuffer-&gt;DataLength &lt; ((PUCHAR)PartialResourceDescriptor -
00276             (PUCHAR)ResourceDescriptor + <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR)
00277             + <span class="keyword">sizeof</span>(CM_ROM_BLOCK))
00278         ) {
00279             ZwClose(RegistryHandle);
00280             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueBuffer);
00281             ZwClose(SectionHandle);
00282             <span class="keywordflow">return</span> STATUS_ILL_FORMED_SERVICE_ENTRY;
00283         }
00284 
00285 
00286         BiosBlock = (PCM_ROM_BLOCK)((PUCHAR)PartialResourceDescriptor +
00287             <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR));
00288 
00289         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = PartialResourceDescriptor-&gt;u.DeviceSpecificData.DataSize /
00290             <span class="keyword">sizeof</span>(CM_ROM_BLOCK);
00291 
00292         <span class="comment">//</span>
00293         <span class="comment">// N.B.  Rom blocks begin on 2K (not necessarily page) boundaries</span>
00294         <span class="comment">//       They end on 512 byte boundaries.  This means that we have</span>
00295         <span class="comment">//       to keep track of the last page mapped, and round the next</span>
00296         <span class="comment">//       Rom block up to the next page boundary if necessary.</span>
00297         <span class="comment">//</span>
00298 
00299         LastMappedAddress = 0xC0000;
00300 
00301         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
00302 <span class="preprocessor">    #if 0</span>
00303 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
00304                 <span class="stringliteral">"Bios Block, PhysAddr = %lx, size = %lx\n"</span>,
00305                 BiosBlock-&gt;Address,
00306                 BiosBlock-&gt;Size
00307                 );
00308 <span class="preprocessor">    #endif</span>
00309 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; 1) &amp;&amp;
00310                 ((BiosBlock-&gt;Address + BiosBlock-&gt;Size) == BiosBlock[1].Address)
00311             ) {
00312                 <span class="comment">//</span>
00313                 <span class="comment">// Coalesce adjacent blocks</span>
00314                 <span class="comment">//</span>
00315                 BiosBlock[1].Address = BiosBlock[0].Address;
00316                 BiosBlock[1].Size += BiosBlock[0].Size;
00317                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>--;
00318                 BiosBlock++;
00319                 <span class="keywordflow">continue</span>;
00320             }
00321 
00322             BaseAddress = (PVOID)(BiosBlock-&gt;Address);
00323             ViewSize = BiosBlock-&gt;Size;
00324 
00325             <span class="keywordflow">if</span> ((ULONG)BaseAddress &lt; LastMappedAddress) {
00326                 <span class="keywordflow">if</span> (ViewSize &gt; (LastMappedAddress - (ULONG)BaseAddress)) {
00327                     ViewSize = ViewSize - (LastMappedAddress - (ULONG)BaseAddress);
00328                     BaseAddress = (PVOID)LastMappedAddress;
00329                 } <span class="keywordflow">else</span> {
00330                     ViewSize = 0;
00331                 }
00332             }
00333 
00334             ViewBase.LowPart = (ULONG)BaseAddress;
00335 
00336             <span class="keywordflow">if</span> (ViewSize &gt; 0) {
00337 
00338                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwMapViewOfSection(
00339                     SectionHandle,
00340                     NtCurrentProcess(),
00341                     &amp;BaseAddress,
00342                     0,
00343                     ViewSize,
00344                     &amp;ViewBase,
00345                     &amp;ViewSize,
00346                     ViewUnmap,
00347                     MEM_DOS_LIM,
00348                     PAGE_READWRITE
00349                     );
00350 
00351                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00352                     <span class="keywordflow">break</span>;
00353                 }
00354 
00355                 LastMappedAddress = (ULONG)BaseAddress + ViewSize;
00356             }
00357 
00358             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>--;
00359             BiosBlock++;
00360         }
00361 
00362         <span class="comment">//</span>
00363         <span class="comment">// Free up the handles</span>
00364         <span class="comment">//</span>
00365 
00366         ZwClose(SectionHandle);
00367         ZwClose(RegistryHandle);
00368         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueBuffer);
00369 
00370     } <span class="keywordflow">else</span> {
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">// This is PC-9800 Series VDM.</span>
00374         <span class="comment">//</span>
00375 
00376         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00377     }
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// Mark the process as a vdm</span>
00381     <span class="comment">//</span>
00382 
00383     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00384     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.VdmFlag = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00385 
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Create VdmObjects structure</span>
00389     <span class="comment">//</span>
00390     <span class="comment">// N.B.  We don't use ExAllocatePoolWithQuota because it</span>
00391     <span class="comment">//       takes a reference to the process (which ExFreePool</span>
00392     <span class="comment">//       dereferences).  Since we expect to clean up on</span>
00393     <span class="comment">//       process deletion, we don't need or want the reference</span>
00394     <span class="comment">//       (which will prevent the process from being deleted)</span>
00395     <span class="comment">//</span>
00396 
00397     <span class="keywordflow">try</span> {
00398 
00399         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00400             NonPagedPool,
00401             <span class="keyword">sizeof</span>(VDM_PROCESS_OBJECTS),
00402             ' MDV'
00403             );
00404 
00405         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00406             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00407         }
00408 
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// We use NonPagedQuotaCharged to keep track of the quota to return</span>
00412         <span class="comment">// if this function fails</span>
00413         <span class="comment">//</span>
00414         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(Process, NonPagedPool, <span class="keyword">sizeof</span>(VDM_PROCESS_OBJECTS));
00415         NonPagedQuotaCharged = <span class="keyword">sizeof</span>(VDM_PROCESS_OBJECTS);
00416 
00417         RtlZeroMemory( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>, <span class="keyword">sizeof</span>(VDM_PROCESS_OBJECTS));
00418         pVdmObjects = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>;
00419         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;pVdmObjects-&gt;DelayIntFastMutex);
00420         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock);
00421         InitializeListHead(&amp;pVdmObjects-&gt;DelayIntListHead);
00422 
00423         pVdmObjects-&gt;pIcaUserData = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00424             PagedPool,
00425             <span class="keyword">sizeof</span>(VDMICAUSERDATA),
00426             ' MDV'
00427             );
00428 
00429         <span class="keywordflow">if</span> (pVdmObjects-&gt;pIcaUserData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00430             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00431         } <span class="keywordflow">else</span> {
00432 
00433             <span class="comment">//</span>
00434             <span class="comment">// We use NonPagedQuotaCharged to keep track of the quota to return</span>
00435             <span class="comment">// if this function fails</span>
00436             <span class="comment">//</span>
00437             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(
00438                 Process,
00439                 PagedPool,
00440                 <span class="keyword">sizeof</span>(VDMICAUSERDATA)
00441                 );
00442             PagedQuotaCharged = <span class="keyword">sizeof</span>(VDMICAUSERDATA);
00443 
00444             RtlZeroMemory( pVdmObjects-&gt;pIcaUserData, <span class="keyword">sizeof</span>(VDMICAUSERDATA));
00445 
00446 
00447             <span class="comment">//</span>
00448             <span class="comment">// Copy Ica addresses from service data (in user space) into</span>
00449             <span class="comment">// pVdmObjects-&gt;pIcaUserData</span>
00450             <span class="comment">//</span>
00451 
00452             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pIcaUserData, <span class="keyword">sizeof</span>(VDMICAUSERDATA), <span class="keyword">sizeof</span>(UCHAR));
00453             *pVdmObjects-&gt;pIcaUserData  = *pIcaUserData;
00454 
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">// Probe static addresses in IcaUserData.</span>
00458             <span class="comment">//</span>
00459             pIcaUserData = pVdmObjects-&gt;pIcaUserData;
00460 
00461             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(pIcaUserData-&gt;phWowIdleEvent);
00462 
00463             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00464                 pIcaUserData-&gt;pIcaLock,
00465                 <span class="keyword">sizeof</span>(RTL_CRITICAL_SECTION),
00466                 <span class="keyword">sizeof</span>(UCHAR)
00467                 );
00468 
00469             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00470                 pIcaUserData-&gt;pIcaMaster,
00471                 <span class="keyword">sizeof</span>(VDMVIRTUALICA),
00472                 <span class="keyword">sizeof</span>(UCHAR)
00473                 );
00474 
00475             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00476                 pIcaUserData-&gt;pIcaSlave,
00477                 <span class="keyword">sizeof</span>(VDMVIRTUALICA),
00478                 <span class="keyword">sizeof</span>(UCHAR)
00479                 );
00480 
00481             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pIcaUserData-&gt;pIretHooked);
00482             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pIcaUserData-&gt;pDelayIrq);
00483             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pIcaUserData-&gt;pUndelayIrq);
00484             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pIcaUserData-&gt;pDelayIret);
00485 
00486 
00487             <span class="comment">//</span>
00488             <span class="comment">// Save pointer to main thread, for delayed interrupts DPC routine.</span>
00489             <span class="comment">// To keep the pointer to the main thread valid, open a thread handle</span>
00490             <span class="comment">// and keep it open until process cleanup.</span>
00491             <span class="comment">//</span>
00492 
00493             InitializeObjectAttributes(&amp;ObjectAttributes, NULL, 0, NULL, NULL);
00494             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  ZwOpenThread(&amp;hThread,
00495                                    THREAD_QUERY_INFORMATION,
00496                                    &amp;ObjectAttributes,
00497                                    &amp;NtCurrentTeb()-&gt;ClientId
00498                                    );
00499 
00500             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00501                 pVdmObjects-&gt;MainThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00502                 }
00503 
00504 
00505             pVdmObjects-&gt;VdmTib = VdmTib;
00506         }
00507 
00508     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00509         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00510     }
00511 
00512 
00513     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00514         <span class="keywordflow">if</span> (pVdmObjects) {
00515             <span class="keywordflow">if</span> (pVdmObjects-&gt;pIcaUserData) {
00516                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pVdmObjects-&gt;pIcaUserData);
00517             }
00518             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pVdmObjects);
00519         }
00520         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00521 
00522         <span class="comment">//</span>
00523         <span class="comment">// Return Quota charged</span>
00524         <span class="comment">//</span>
00525         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(Process, NonPagedPool, NonPagedQuotaCharged);
00526         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(Process, PagedPool, PagedQuotaCharged);
00527         }
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// following codepath only for PC/AT (and FMR in Japan) vdm</span>
00531     <span class="comment">//</span>
00532 
00533     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> &amp; MACHINE_TYPE_PC_9800_COMPATIBLE) == 0) {
00534 
00535 <span class="preprocessor">#ifdef WHEN_IO_DISPATCHING_IMPROVED</span>
00536 <span class="preprocessor"></span>        <span class="comment">// Sudeepb - Once we improve the IO dispatching we should use this</span>
00537         <span class="comment">// routine. Currently we are dispatching the printer ports directly</span>
00538         <span class="comment">// from emv86.asm and instemul.asm</span>
00539 
00540         VdmInitializePrinter ();
00541 <span class="preprocessor">#endif</span>
00542 <span class="preprocessor"></span>    }
00543 
00544     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00545 
00546 } <span class="comment">// end InitializeVDM()</span>
} <span class="comment">// end InitializeVDM()</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="vdm/i386/vdmp.h::VdmpIsThreadTerminating" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpIsThreadTerminating           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ThreadId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01922">1922</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00875">PsIsThreadTerminating</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>01927                    :
01928 
01929     This routine determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> terminating or not.
01930 
01931 Arguments:
01932 
01933 Return Value:
01934 
01935     True --
01936     False -
01937 
01938 --*/
01939 {
01940     CLIENT_ID     Cid;
01941     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>      Thread;
01942     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01943 
01944     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01945 
01946         <span class="comment">//</span>
01947         <span class="comment">// If the owning thread juest exited the IcaLock the</span>
01948         <span class="comment">// OwningThread Tid may be NULL, return success, since</span>
01949         <span class="comment">// we don't know what the owning threads state was.</span>
01950         <span class="comment">//</span>
01951     <span class="keywordflow">if</span> (!ThreadId) {
01952         <span class="keywordflow">return</span> STATUS_SUCCESS;
01953         }
01954 
01955     Cid.UniqueProcess = NtCurrentTeb()-&gt;ClientId.UniqueProcess;
01956     Cid.UniqueThread  = ThreadId;
01957 
01958     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>(&amp;Cid, NULL, &amp;Thread);
01959     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01960         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(Thread) ? STATUS_THREAD_IS_TERMINATING
01961                                                : STATUS_SUCCESS;
01962         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01963         }
01964 
01965     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01966 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="vdm/i386/vdmp.h::VdmpLeaveIcaLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpLeaveIcaLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pIcaLock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="vdm/i386/vdmp.h::VdmpPrinterDirectIoClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpPrinterDirectIoClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ServiceData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00388">388</a> of file <a class="el" href="../../d5/d4/vdmprint_8c-source.html">vdmprint.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00236">VdmFlushPrinterWriteData()</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>00389 {
00390     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00391     PVDM_PRINTER_INFO PrtInfo;
00392     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Adapter;
00393     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib;
00394 
00395     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00396 
00397     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00398 
00399     <span class="comment">// first we fetch vdm tib and do some damage control in case</span>
00400     <span class="comment">// this is bad user-mode memory</span>
00401     <span class="comment">// PrtInfo points to a stricture</span>
00402 
00403     <span class="keywordflow">try</span> {
00404         VdmTib = NtCurrentTeb()-&gt;Vdm;
00405         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(VdmTib, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/struct__Vdm__Tib.html">VDM_TIB</a>), <span class="keyword">sizeof</span>(UCHAR));
00406 
00407         <span class="comment">// now verify that servicedata ptr is valid</span>
00408         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ServiceData, <span class="keyword">sizeof</span>(USHORT), <span class="keyword">sizeof</span>(UCHAR));
00409         Adapter = *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *)ServiceData;
00410 
00411     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00412         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00413     }
00414 
00415     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == VdmTib || <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == ServiceData) {
00416        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
00417     }
00418 
00419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00420        <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00421     }
00422 
00423     PrtInfo =&amp;VdmTib-&gt;PrinterInfo;
00424 
00425     <span class="keywordflow">try</span> {
00426              <span class="keywordflow">if</span> (Adapter &lt; VDM_NUMBER_OF_LPT) {
00427                 <span class="keywordflow">if</span> (PRT_MODE_DIRECT_IO == PrtInfo-&gt;prt_Mode[Adapter] &amp;&amp;
00428                          PrtInfo-&gt;prt_BytesInBuffer[Adapter]) {
00429                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d5/vdmprint_8h.html#a16">VdmFlushPrinterWriteData</a>(Adapter);
00430                 }
00431              }
00432         <span class="keywordflow">else</span> {
00433                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00434         }
00435     } except (EXCEPTION_EXECUTE_HANDLER) {
00436              <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>     = GetExceptionCode();
00437     }
00438     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00439 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="vdm/i386/vdmp.h::VdmpPrinterDirectIoOpen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpPrinterDirectIoOpen           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ServiceData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00380">380</a> of file <a class="el" href="../../d5/d4/vdmprint_8c-source.html">vdmprint.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>00381 {
00382     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00383 
00384     <span class="keywordflow">return</span> STATUS_SUCCESS;
00385 
00386 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="vdm/i386/vdmp.h::VdmpPrinterInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpPrinterInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ServiceData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00295">295</a> of file <a class="el" href="../../d5/d4/vdmprint_8c-source.html">vdmprint.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib()</a>, and <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00198">VDMTIB_KMODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>00300                    :
00301 
00302     This routine probes and caches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data associated with kernel
00303     mode printer emulation.
00304 
00305 Arguments:
00306 
00307     ServiceData - Not used.
00308 
00309 Return Value:
00310 
00311 
00312 --*/
00313 {
00314     PUCHAR State, PrtStatus, Control, HostState;
00315     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib;
00316     PVDM_PROCESS_OBJECTS VdmObjects;
00317     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00318 
00319     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// Note:  We only support two printers in the kernel.</span>
00323     <span class="comment">//</span>
00324 
00325     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib</a>(&amp;VdmTib, VDMTIB_KMODE);
00326     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00327        <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00328     }
00329 
00330 
00331     <span class="keywordflow">try</span> {
00332         State = VdmTib-&gt;PrinterInfo.prt_State;
00333         PrtStatus = VdmTib-&gt;PrinterInfo.prt_Status;
00334         Control = VdmTib-&gt;PrinterInfo.prt_Control;
00335         HostState = VdmTib-&gt;PrinterInfo.prt_HostState;
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">// Probe the locations for two printers</span>
00339         <span class="comment">//</span>
00340         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00341             State,
00342             2 * <span class="keyword">sizeof</span>(UCHAR),
00343             <span class="keyword">sizeof</span>(UCHAR)
00344             );
00345 
00346         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00347             PrtStatus,
00348             2 * <span class="keyword">sizeof</span>(UCHAR),
00349             <span class="keyword">sizeof</span>(UCHAR)
00350             );
00351 
00352         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00353             Control,
00354             2 * <span class="keyword">sizeof</span>(UCHAR),
00355             <span class="keyword">sizeof</span>(UCHAR)
00356             );
00357 
00358         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00359             HostState,
00360             2 * <span class="keyword">sizeof</span>(UCHAR),
00361             <span class="keyword">sizeof</span>(UCHAR)
00362             );
00363 
00364     } except (EXCEPTION_EXECUTE_HANDLER) {
00365         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00366     }
00367 
00368     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00369         VdmObjects = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;VdmObjects;
00370         VdmObjects-&gt;PrinterState = State;
00371         VdmObjects-&gt;PrinterStatus = PrtStatus;
00372         VdmObjects-&gt;PrinterControl = Control;
00373         VdmObjects-&gt;PrinterHostState = HostState;
00374     }
00375 
00376     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00377 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="vdm/i386/vdmp.h::VdmpQueueInterrupt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpQueueInterrupt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ThreadHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00146">146</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l01257">Ke386VdmInsertQueueApc()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00441">_ETHREAD::ThreadsProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00258">_EPROCESS::VdmObjects</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01969">VdmpNullRundownRoutine()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00408">VdmpQueueIntNormalRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>00152                    :
00153 
00154     Queues a user mode APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specifed application thread
00155     which will dispatch an interrupt.
00156 
00157     <span class="keywordflow">if</span> APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already queued to specified thread
00158        does nothing
00159 
00160     <span class="keywordflow">if</span> APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wrong thread
00161        dequeue <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00162 
00163     Reset <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user APC <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specifed thread
00164 
00165     Insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specifed thread
00166 
00167 Arguments:
00168 
00169     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - handle of thread to insert QueueIntApcRoutine
00170 
00171 Return Value:
00172 
00173     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
00174 
00175 --*/
00176 
00177 {
00178 
00179     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>    Process;
00180     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>     Thread;
00181     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00182     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>      PrevMode;
00183     PVDM_PROCESS_OBJECTS pVdmObjects;
00184 
00185     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00186 
00187 
00188     PrevMode = KeGetPreviousMode();
00189 
00190     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ThreadHandle,
00191                                        THREAD_QUERY_INFORMATION,
00192                                        PsThreadType,
00193                                        PrevMode,
00194                                        &amp;Thread,
00195                                        NULL
00196                                        );
00197     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00198         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00199         }
00200 
00201     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00202     <span class="keywordflow">if</span> (Process != Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a> || Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.VdmFlag != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00203       {
00204         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_1;
00205         }
00206     <span class="keywordflow">else</span> {
00207         pVdmObjects = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>;
00208 
00209         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a20">Ke386VdmInsertQueueApc</a>(&amp;pVdmObjects-&gt;QueuedIntApc,
00210                                     &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00211                                     KernelMode,
00212                                     VdmpQueueIntApcRoutine,
00213                                     VdmpNullRundownRoutine, <span class="comment">// rundown</span>
00214                                     VdmpQueueIntNormalRoutine, <span class="comment">// normal routine</span>
00215                                     (PVOID)KernelMode,      <span class="comment">// NormalContext</span>
00216                                     0
00217                                     ))
00218            {
00219             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00220             }
00221         <span class="keywordflow">else</span> {
00222             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00223             }
00224         }
00225 
00226     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00227     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00228 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="vdm/i386/vdmp.h::VdmPrinterStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN VdmPrinterStatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>iPort</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>cbInstructionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00042">42</a> of file <a class="el" href="../../d5/d4/vdmprint_8c-source.html">vdmprint.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00039">get_control</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00038">get_status</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00035">HOST_LPT_BUSY</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00040">host_lpt_status</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00032">IRQ</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00034">NOTBUSY</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00041">set_status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00025">STATUS_PORT_OFFSET</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00036">STATUS_REG_MASK</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00236">VdmFlushPrinterWriteData()</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib()</a>, and <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00198">VDMTIB_KMODE</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This routine handles <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> printer status port
00053 
00054 Arguments:
00055     iPort              - port on which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> io was trapped
00056     cbInstructionSize  - Instruction size to update TsEip
00057     TrapFrame          - Trap Frame
00058 
00059 Return Value:
00060 
00061     True <span class="keywordflow">if</span> successfull, False otherwise
00062 
00063 --*/
00064 {
00065     UCHAR    PrtMode;
00066     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>   adapter;
00067     ULONG *  printer_status;
00068     KIRQL    OldIrql;
00069     PIO_STATUS_BLOCK IoStatusBlock;
00070     PVDM_PRINTER_INFO   PrtInfo;
00071     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a>    VdmTib;
00072     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00073 
00074     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00075 
00076     <span class="comment">// why we have printer stuff in TIB? It would be more appropriate</span>
00077     <span class="comment">// if we have them in the process object. The main reason(I think)</span>
00078     <span class="comment">// is that we can get rid of synchronization.</span>
00079     <span class="comment">//</span>
00080 
00081     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib</a>(&amp;VdmTib, VDMTIB_KMODE);
00082     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00083        <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00084     }
00085 
00086     PrtInfo = &amp;VdmTib-&gt;PrinterInfo;
00087     IoStatusBlock = (PIO_STATUS_BLOCK) &amp;VdmTib-&gt;TempArea1;
00088     printer_status = &amp;VdmTib-&gt;PrinterInfo.prt_Scratch;
00089 
00090     *pNtVDMState |= VDM_IDLEACTIVITY;
00091     <span class="keywordflow">try</span> {
00092         <span class="comment">// first, figure out which PRT we are dealing with. The</span>
00093         <span class="comment">// port addresses in the PrinterInfo are base address of each</span>
00094         <span class="comment">// PRT sorted in the adapter order.</span>
00095 
00096         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)iPort == PrtInfo-&gt;prt_PortAddr[0] + <a class="code" href="../../d5/d5/vdmprint_8h.html#a1">STATUS_PORT_OFFSET</a>)
00097             adapter = 0;
00098         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)iPort == PrtInfo-&gt;prt_PortAddr[1] + <a class="code" href="../../d5/d5/vdmprint_8h.html#a1">STATUS_PORT_OFFSET</a>)
00099             adapter = 1;
00100         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)iPort == PrtInfo-&gt;prt_PortAddr[2] + <a class="code" href="../../d5/d5/vdmprint_8h.html#a1">STATUS_PORT_OFFSET</a>)
00101             adapter = 2;
00102         <span class="keywordflow">else</span> {
00103             <span class="comment">// something must be wrong in our code, better check it out</span>
00104             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00105             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00106         }
00107         PrtMode = PrtInfo-&gt;prt_Mode[adapter];
00108 
00109 
00110         <span class="keywordflow">if</span>(PRT_MODE_SIMULATE_STATUS_PORT == PrtMode) {
00111             <span class="comment">// we are simulating printer status read.</span>
00112             <span class="comment">// get the current status from softpc.</span>
00113             <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d5/vdmprint_8h.html#a11">get_status</a>(adapter) &amp; <a class="code" href="../../d5/d5/vdmprint_8h.html#a8">NOTBUSY</a>) &amp;&amp;
00114                 !(<a class="code" href="../../d5/d5/vdmprint_8h.html#a13">host_lpt_status</a>(adapter) &amp; <a class="code" href="../../d5/d5/vdmprint_8h.html#a9">HOST_LPT_BUSY</a>)) {
00115                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/vdmprint_8h.html#a12">get_control</a>(adapter) &amp; <a class="code" href="../../d5/d5/vdmprint_8h.html#a7">IRQ</a>)
00116                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00117                 <a class="code" href="../../d5/d5/vdmprint_8h.html#a14">set_status</a>(adapter, <a class="code" href="../../d5/d5/vdmprint_8h.html#a11">get_status</a>(adapter) | NOTBUSY);
00118             }
00119             *printer_status = (ULONG)(<a class="code" href="../../d5/d5/vdmprint_8h.html#a11">get_status</a>(adapter) | <a class="code" href="../../d5/d5/vdmprint_8h.html#a10">STATUS_REG_MASK</a>);
00120         }
00121         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PRT_MODE_DIRECT_IO ==  PrtMode) {
00122             <span class="comment">// we have to read the i/o directly(of course, through file system</span>
00123             <span class="comment">// which in turn goes to the driver).</span>
00124             <span class="comment">// Before performing read, flush out all pending output data in our</span>
00125             <span class="comment">// buffer. This is done because the status we are about to read</span>
00126             <span class="comment">// may depend on those pending output data.</span>
00127             <span class="comment">//</span>
00128             <span class="keywordflow">if</span> (PrtInfo-&gt;prt_BytesInBuffer[adapter]) {
00129                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d5/vdmprint_8h.html#a16">VdmFlushPrinterWriteData</a>(adapter);
00130 <span class="preprocessor">#ifdef DBG</span>
00131 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00132                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"VdmPrintStatus: failed to flush buffered data, status = %ls\n"</span>, Status);
00133                 }
00134 <span class="preprocessor">#endif</span>
00135 <span class="preprocessor"></span>            }
00136             OldIrql = KeGetCurrentIrql();
00137             <span class="comment">// lower irql to passive before doing any IO</span>
00138             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(PASSIVE_LEVEL);
00139             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(PrtInfo-&gt;prt_Handle[adapter],
00140                                            NULL,        <span class="comment">// notification event</span>
00141                                            NULL,        <span class="comment">// APC routine</span>
00142                                            NULL,        <span class="comment">// Apc Context</span>
00143                                            IoStatusBlock,
00144                                            IOCTL_VDM_PAR_READ_STATUS_PORT,
00145                                            NULL,
00146                                            0,
00147                                            printer_status,
00148                                            <span class="keyword">sizeof</span>(ULONG)
00149                                            );
00150 
00151             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatusBlock-&gt;Status)) {
00152                 <span class="comment">// fake a status to make it looks like the port is not connected</span>
00153                 <span class="comment">// to a printer.</span>
00154                 *printer_status = 0x7F;
00155 <span class="preprocessor">#ifdef DBG</span>
00156 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"VdmPrinterStatus: failed to get status from printer, status = %lx\n"</span>, Status);
00157 <span class="preprocessor">#endif</span>
00158 <span class="preprocessor"></span>                <span class="comment">// always tell the caller that we have simulated the operation.</span>
00159                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00160             }
00161             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(OldIrql, &amp;OldIrql);
00162         }
00163         <span class="keywordflow">else</span>
00164             <span class="comment">// we don't simulate it here</span>
00165             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00166 
00167         TrapFrame-&gt;Eax &amp;= 0xffffff00;
00168         TrapFrame-&gt;Eax |= (UCHAR)*printer_status;
00169         TrapFrame-&gt;Eip += cbInstructionSize;
00170 
00171     } except(EXCEPTION_EXECUTE_HANDLER) {
00172         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00173     }
00174     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00175 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="vdm/i386/vdmp.h::VdmPrinterWriteData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN VdmPrinterWriteData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>iPort</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>cbInstructionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00177">177</a> of file <a class="el" href="../../d5/d4/vdmprint_8c-source.html">vdmprint.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/vdmprint_8h-source.html#l00024">DATA_PORT_OFFSET</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d5/d4/vdmprint_8c-source.html#l00236">VdmFlushPrinterWriteData()</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib()</a>, and <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00198">VDMTIB_KMODE</a>.
<p>
<pre class="fragment"><div>00182 {
00183     UCHAR    PrtMode;
00184     PVDM_PRINTER_INFO   PrtInfo;
00185     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>   adapter;
00186     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib;
00187     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00188 
00189     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00190 
00191     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib</a>(&amp;VdmTib, VDMTIB_KMODE);
00192     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00193        <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00194     }
00195 
00196     PrtInfo = &amp;VdmTib-&gt;PrinterInfo;
00197     *pNtVDMState |= VDM_IDLEACTIVITY;
00198 
00199     <span class="keywordflow">try</span> {
00200         <span class="comment">// first, figure out which PRT we are dealing with. The</span>
00201         <span class="comment">// port addresses in the PrinterInfo are base address of each</span>
00202         <span class="comment">// PRT sorted in the adapter order</span>
00203         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)iPort == PrtInfo-&gt;prt_PortAddr[0] + <a class="code" href="../../d5/d5/vdmprint_8h.html#a0">DATA_PORT_OFFSET</a>)
00204             adapter = 0;
00205         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)iPort == PrtInfo-&gt;prt_PortAddr[1] + <a class="code" href="../../d5/d5/vdmprint_8h.html#a0">DATA_PORT_OFFSET</a>)
00206             adapter = 1;
00207         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)iPort == PrtInfo-&gt;prt_PortAddr[2] + <a class="code" href="../../d5/d5/vdmprint_8h.html#a0">DATA_PORT_OFFSET</a>)
00208             adapter = 2;
00209         <span class="keywordflow">else</span> {
00210             <span class="comment">// something must be wrong in our code, better check it out</span>
00211             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00212             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00213         }
00214         <span class="keywordflow">if</span> (PRT_MODE_DIRECT_IO == PrtInfo-&gt;prt_Mode[adapter]){
00215             PrtInfo-&gt;prt_Buffer[adapter][PrtInfo-&gt;prt_BytesInBuffer[adapter]] = (UCHAR)TrapFrame-&gt;Eax;
00216             <span class="comment">// buffer full, then flush it out</span>
00217             <span class="keywordflow">if</span> (++PrtInfo-&gt;prt_BytesInBuffer[adapter] &gt;= PRT_DATA_BUFFER_SIZE){
00218 
00219                 <a class="code" href="../../d5/d5/vdmprint_8h.html#a16">VdmFlushPrinterWriteData</a>(adapter);
00220             }
00221 
00222             TrapFrame-&gt;Eip += cbInstructionSize;
00223 
00224         }
00225         <span class="keywordflow">else</span>
00226             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ILLEGAL_INSTRUCTION;
00227     } except(EXCEPTION_EXECUTE_HANDLER) {
00228         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00229     }
00230     <span class="keywordflow">return</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00231 
00232 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="vdm/i386/vdmp.h::VdmpStartExecution" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpStartExecution           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00040">40</a> of file <a class="el" href="../../d8/d6/strtexec_8c-source.html">strtexec.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00036">_VdmEventInfo::Event</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00059">_Vdm_Tib::EventInfo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00037">_VdmEventInfo::InstructionSize</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02688">KeI386VdmIoplAllowed</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02689">KeI386VirtualIntExtensions</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00057">_Vdm_Tib::MonitorContext</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00004">VDM_VIRTUAL_INTERRUPTS</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00058">_Vdm_Tib::VdmContext</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l00151">VdmFixedStateLinear</a>, <a class="el" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a33a28">VdmIntAck</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib()</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a5">VdmSwapContexts()</a>, and <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00198">VDMTIB_KMODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>00045                    :
00046 
00047     This routine causes execution of dos application code to begin.  The
00048     Dos application executes on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.  The Vdms context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> loaded
00049     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">VDM_TIB</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.  The 32 bit context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored into
00050     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MonitorContext.  Execution in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VDM context will <span class="keywordflow">continue</span> until
00051     an event occurs that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> monitor needs to service.  At that point,
00052     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information will be put into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">VDM_TIB</a>, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call will
00053     <span class="keywordflow">return</span>.
00054 
00055 Arguments:
00056 
00057 Return Value:
00058 
00059     TrapFrame-&gt;Eax <span class="keywordflow">for</span> application mode, required <span class="keywordflow">for</span> system sevices
00060     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>.
00061 
00062 
00063 --*/
00064 {
00065     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib;
00066     PKTRAP_FRAME TrapFrame;
00067     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00068     KIRQL    OldIrql;
00069     BOOLEAN  IntsEnabled;
00070     PVDM_PROCESS_OBJECTS pProcessObjects;
00071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00072     CONTEXT VdmContext;
00073 
00074     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00075 
00076 
00077     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">// Form a pointer to the trap frame for the current thread</span>
00081     <span class="comment">//</span>
00082     Thread    = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00083     TrapFrame = VdmGetTrapFrame(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00084 
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">// Get the VdmTib</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib</a>(&amp;VdmTib, VDMTIB_KMODE);
00091     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00092        <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00093        <span class="keywordflow">return</span>(STATUS_INVALID_SYSTEM_SERVICE);
00094     }
00095 
00096     <span class="keywordflow">try</span> {
00097 
00098     <span class="comment">//</span>
00099     <span class="comment">// Determine if interrupts are on or off</span>
00100     <span class="comment">//</span>
00101     IntsEnabled = VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags &amp; EFLAGS_INTERRUPT_MASK
00102                    ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">// check for timer ints to dispatch, However if interrupts are disabled</span>
00106     <span class="comment">// or there are hardware ints pending we postpone dispatching the timer</span>
00107     <span class="comment">// interrupt until interrupts are enabled.</span>
00108     <span class="comment">//</span>
00109     <span class="keywordflow">if</span> (*pNtVDMState &amp; VDM_INT_TIMER &amp;&amp;
00110         IntsEnabled &amp;&amp; !(*pNtVDMState &amp; VDM_INT_HARDWARE))
00111     {
00112         VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.<a class="code" href="../../d1/d6/struct__VdmEventInfo.html#o1">Event</a> = <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a33a28">VdmIntAck</a>;
00113         VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.<a class="code" href="../../d1/d6/struct__VdmEventInfo.html#o2">InstructionSize</a> = 0;
00114         VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.IntAckInfo = 0;
00115         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00116         <span class="keywordflow">return</span> STATUS_SUCCESS;
00117     }
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// Perform IF to VIF translation</span>
00121     <span class="comment">//</span>
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">// If the processor supports IF virtualization</span>
00125     <span class="comment">//</span>
00126     <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; V86_VIRTUAL_INT_EXTENSIONS) &amp;&amp;
00127         (VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags &amp; EFLAGS_V86_MASK)) ||
00128         ((<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; PM_VIRTUAL_INT_EXTENSIONS) &amp;&amp;
00129         !(VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags &amp; EFLAGS_V86_MASK)))
00130     {
00131         <span class="comment">//</span>
00132         <span class="comment">// Translate IF to VIF</span>
00133         <span class="comment">//</span>
00134 
00135         <span class="keywordflow">if</span> (IntsEnabled) {
00136             VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags |= EFLAGS_VIF;
00137 
00138         } <span class="keywordflow">else</span> {
00139             VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags &amp;= ~EFLAGS_VIF;
00140             VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags |= EFLAGS_INTERRUPT_MASK;
00141         }
00142 
00143         <span class="keywordflow">if</span> (*pNtVDMState &amp; VDM_INT_HARDWARE)
00144             VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags |= EFLAGS_VIP;
00145         <span class="keywordflow">else</span>
00146             VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags &amp;= ~EFLAGS_VIP;
00147 
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">// Else if we are not running in v86 mode, or not using IOPL in</span>
00151     <span class="comment">// v86 mode</span>
00152     <span class="comment">//</span>
00153     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d3/i386_8h.html#a19">KeI386VdmIoplAllowed</a>) ||
00154         !(VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags &amp; EFLAGS_V86_MASK))
00155     {
00156         <span class="comment">//</span>
00157         <span class="comment">// Translate the real interrupt flag in the VdmContext to the virtual</span>
00158         <span class="comment">// interrupt flag in the VdmTib, and force real interrupts enabled.</span>
00159         <span class="comment">//</span>
00160 
00161         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(VDM_VIRTUAL_INTERRUPTS == EFLAGS_INTERRUPT_MASK);
00162 
00163         <span class="keywordflow">if</span> (VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags &amp; EFLAGS_INTERRUPT_MASK) {
00164             _asm {
00165 
00166                  mov  eax,<a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a3">VdmFixedStateLinear</a>     ; get pointer to VDM State
00167                  lock or dword ptr [eax], dword ptr <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a3">VDM_VIRTUAL_INTERRUPTS</a>
00168             }
00169         } <span class="keywordflow">else</span> {
00170             _asm {
00171 
00172                  mov  eax,<a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a3">VdmFixedStateLinear</a>   ; get pointer to VDM State
00173                  lock and dword ptr [eax], NOT <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a3">VDM_VIRTUAL_INTERRUPTS</a>
00174             }
00175         }
00176 
00177         <span class="comment">//</span>
00178         <span class="comment">// Insure that real interrupts are always enabled.</span>
00179         <span class="comment">//</span>
00180         VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>.EFlags |= EFLAGS_INTERRUPT_MASK;
00181     }
00182 
00183     <span class="comment">// before working on a trap frame, make sure that it's our own structure</span>
00184     <span class="comment">//</span>
00185 
00186     VdmContext = VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o4">VdmContext</a>;
00187     <span class="keywordflow">if</span> (!(VdmContext.SegCs &amp; FRAME_EDITED)) {
00188        <span class="comment">// we will crash in KiServiceExit</span>
00189        <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00190        <span class="keywordflow">return</span>(STATUS_INVALID_SYSTEM_SERVICE);
00191     }
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Switch from MonitorContext to VdmContext</span>
00195     <span class="comment">//</span>
00196 
00197     <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a5">VdmSwapContexts</a>(
00198         TrapFrame,
00199         &amp;(VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o3">MonitorContext</a>),
00200         &amp;VdmContext
00201         );
00202 
00203 
00204     <span class="comment">//</span>
00205     <span class="comment">// Check for pending interrupts</span>
00206     <span class="comment">//</span>
00207     <span class="keywordflow">if</span> (IntsEnabled &amp;&amp; (*pNtVDMState &amp; VDM_INT_HARDWARE)) {
00208         <a class="code" href="../../d9/d4/vdmints_8c.html#a16">VdmDispatchInterrupts</a>(TrapFrame, VdmTib);
00209     }
00210 
00211     }
00212     except(EXCEPTION_EXECUTE_HANDLER) {
00213        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00214        <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00215        <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00216     }
00217 
00218     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00219 
00220     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>) TrapFrame-&gt;Eax;
00221 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="vdm/i386/vdmp.h::VdmSwapContexts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VdmSwapContexts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>InContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>OutContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00224">VdmEndExecution()</a>, and <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00040">VdmpStartExecution()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="vdm/i386/vdmp.h::VdmTraceEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VdmTraceEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>wData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>lData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/vdmtrace_8c-source.html#l00037">37</a> of file <a class="el" href="../../d7/d4/vdmtrace_8c-source.html">vdmtrace.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00055">_Vdm_Tib::Flags</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00046                    :
00047 
00048 
00049 
00050 Arguments:
00051 
00052 Return Value:
00053 
00054     None
00055 
00056 --*/
00057 {
00058     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib;
00059     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00060     KIRQL   OldIrql;
00061     PVDM_TRACEENTRY pEntry;
00062     PVDM_TRACEINFO pInfo;
00063     LARGE_INTEGER CurTime, DiffTime;
00064 
00065 
00066     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00067 <span class="preprocessor">#if 0</span>
00068 <span class="preprocessor"></span>        <span class="comment">// This code represents a security problem.  Since it is only used</span>
00069         <span class="comment">// on special occasions, it won't be built into the standard build.</span>
00070         <span class="comment">// Individuals wishing to use it can build themselves a kernel with</span>
00071         <span class="comment">// it in.</span>
00072 <span class="preprocessor">#if 0</span>
00073 <span class="preprocessor"></span>    <span class="comment">//</span>
00074     <span class="comment">// Raise Irql to APC level...</span>
00075     <span class="comment">//</span>
00076     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">// VdmTib is in user mode memory</span>
00080     <span class="comment">//</span>
00081     <span class="keywordflow">try</span> {
00082 <span class="preprocessor">#endif</span>
00083 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((*(ULONG *)(FIXED_NTVDMSTATE_LINEAR) &amp; VDM_TRACE_HISTORY)) {
00084 
00085             <span class="comment">//</span>
00086             <span class="comment">// Get a pointer to the VdmTib</span>
00087             <span class="comment">//</span>
00088             VdmTib = NtCurrentTeb()-&gt;Vdm;
00089 
00090             <span class="keywordflow">if</span> (VdmTib-&gt;TraceInfo.pTraceTable) {
00091            
00092                 pEntry = &amp;VdmTib-&gt;TraceInfo.pTraceTable[VdmTib-&gt;TraceInfo.CurrentEntry];
00093                
00094                 pEntry-&gt;Type = Type;
00095                 pEntry-&gt;wData = wData;
00096                 pEntry-&gt;lData = lData;
00097 
00098                 <span class="keywordflow">switch</span> (VdmTib-&gt;TraceInfo.<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o1">Flags</a> &amp; VDMTI_TIMER_MODE) {
00099                 <span class="keywordflow">case</span> VDMTI_TIMER_TICK:
00100                     CurTime.LowPart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00101                     pEntry-&gt;Time = CurTime.LowPart - VdmTib-&gt;TraceInfo.TimeStamp.LowPart;
00102                     VdmTib-&gt;TraceInfo.TimeStamp.LowPart = CurTime.LowPart;
00103                     <span class="keywordflow">break</span>;
00104 
00105                 <span class="keywordflow">case</span> VDMTI_TIMER_PERFCTR:
00106                     pEntry-&gt;Time = 0;
00107                     <span class="keywordflow">break</span>;
00108 
00109                 <span class="keywordflow">case</span> VDMTI_TIMER_STAT:
00110                     pEntry-&gt;Time = 0;
00111                     <span class="keywordflow">break</span>;
00112 
00113                 }
00114                
00115                 pEntry-&gt;eax = TrapFrame-&gt;Eax;
00116                 pEntry-&gt;ebx = TrapFrame-&gt;Ebx;
00117                 pEntry-&gt;ecx = TrapFrame-&gt;Ecx;
00118                 pEntry-&gt;edx = TrapFrame-&gt;Edx;
00119                 pEntry-&gt;esi = TrapFrame-&gt;Esi;
00120                 pEntry-&gt;edi = TrapFrame-&gt;Edi;
00121                 pEntry-&gt;ebp = TrapFrame-&gt;Ebp;
00122                 pEntry-&gt;esp = TrapFrame-&gt;HardwareEsp;
00123                 pEntry-&gt;eip = TrapFrame-&gt;Eip;
00124                 pEntry-&gt;eflags = TrapFrame-&gt;EFlags;
00125                
00126                 pEntry-&gt;cs = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;SegCs;
00127                 pEntry-&gt;ds = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;SegDs;
00128                 pEntry-&gt;es = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;SegEs;
00129                 pEntry-&gt;fs = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;SegFs;
00130                 pEntry-&gt;gs = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;SegGs;
00131                 pEntry-&gt;ss = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;HardwareSegSs;
00132                
00133                 <span class="keywordflow">if</span> (++VdmTib-&gt;TraceInfo.CurrentEntry &gt;=
00134                    (VdmTib-&gt;TraceInfo.NumPages*4096/<span class="keyword">sizeof</span>(VDM_TRACEENTRY))) {
00135                     VdmTib-&gt;TraceInfo.CurrentEntry = 0;
00136                 }
00137             }
00138         }
00139 
00140 <span class="preprocessor">#if 0</span>
00141 <span class="preprocessor"></span>    } except(EXCEPTION_EXECUTE_HANDLER) {
00142         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00143     }
00144 
00145     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00146 <span class="preprocessor">#endif</span>
00147 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00148 <span class="preprocessor"></span>}
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:07 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
