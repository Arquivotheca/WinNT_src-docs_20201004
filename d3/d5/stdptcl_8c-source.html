<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: stdptcl.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>stdptcl.c</h1><a href="../../d2/d6/stdptcl_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: stdptcl.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* DDE Manager DDE protocol transaction management functions</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* NITTY GRITTY GUCK of DDE</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* Created: 11/3/91 Sanford Staab</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 
00017 <span class="comment">/*</span>
00018 <span class="comment"></span>
00019 <span class="comment">    StartFunctions:</span>
00020 <span class="comment">        These are used to fill in a preallocated pxi with transaction</span>
00021 <span class="comment">        specific data. They then start the desired transaction and</span>
00022 <span class="comment">        link the pxi into the conversation's transaction queue.</span>
00023 <span class="comment">        fSuccess is return ed. On error, SetLastDDEMLError is called</span>
00024 <span class="comment">        by these functions and the pxi is untouched, ready for</span>
00025 <span class="comment">        reuse on a subsequent call. Note that the pxi-&gt;gaItem field</span>
00026 <span class="comment">        is a global atom and needs to be deleted by the caller on</span>
00027 <span class="comment">        failure as apropriate. Success implies the transaction</span>
00028 <span class="comment">        is started successfully.</span>
00029 <span class="comment"></span>
00030 <span class="comment">    RespFunctions:</span>
00031 <span class="comment">        These are called via the pxi-&gt;pfnRespnose field in response</span>
00032 <span class="comment">        to expected DDE messages. If the msg parameter is 0, these</span>
00033 <span class="comment">        functions assume transaction cleanup is being done. FALSE</span>
00034 <span class="comment">        is only return ed if CBR_BLOCK was returned from a callback.</span>
00035 <span class="comment"></span>
00036 <span class="comment">    SpontFunctions:</span>
00037 <span class="comment">        These are called in response to a spontaneous (unexpected) DDE</span>
00038 <span class="comment">        message. These functions may create a pxi and link it into the</span>
00039 <span class="comment">        conversation's transaction queue to properly handle expected</span>
00040 <span class="comment">        replies. FALSE is only return ed if CBR_BLOCK was returned</span>
00041 <span class="comment">        from a callback.</span>
00042 <span class="comment"></span>
00043 <span class="comment">    The prefixes Sv and Cl indicate which side of the DDE conversation</span>
00044 <span class="comment">    is doing the work.</span>
00045 <span class="comment"></span>
00046 <span class="comment">    Weaknesses: Can't deal well with failed PostMessage() or</span>
00047 <span class="comment">                 lParam acessing/allocation failures. Hoping these</span>
00048 <span class="comment">                 are rare enough (ie never) to not matter. If they</span>
00049 <span class="comment">                 do fail, the tracking layer will eventually shut down</span>
00050 <span class="comment">                 the conversation.</span>
00051 <span class="comment"></span>
00052 <span class="comment">*/</span>
00053 
00054 <span class="comment">//--------------------------------ADVISE-------------------------------//</span>
00055 
00056 <span class="comment">/***************************************************************************\</span>
00057 <span class="comment">* ClStartAdvise</span>
00058 <span class="comment">*</span>
00059 <span class="comment">* Description:</span>
00060 <span class="comment">* CLIENT side Advise link processing</span>
00061 <span class="comment">* Post WM_DDE_ADVISE message</span>
00062 <span class="comment">* Link pxi for responding WM_DDE_ACK message.</span>
00063 <span class="comment">*</span>
00064 <span class="comment">* History:</span>
00065 <span class="comment">* 11-12-91 sanfords Created.</span>
00066 <span class="comment">\***************************************************************************/</span>
<a name="l00067"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a0">00067</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a0">ClStartAdvise</a>(
00068 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi)
00069 {
00070     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00071 
00072     <span class="comment">//</span>
00073     <span class="comment">// protocol quirk: DDE_FRELEASE is always assumed set in a WM_DDE_ADVISE</span>
00074     <span class="comment">// message. We set it here just in case the dork on the other end</span>
00075     <span class="comment">// pays attention to it.</span>
00076     <span class="comment">//</span>
00077     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a> = <a class="code" href="../../d2/d6/stdptcl_8c.html#a22">AllocAndSetDDEData</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/structtagDDE__DATA.html">DDE_DATA</a>),
00078             (WORD)(((pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o7">wType</a> &lt;&lt; 12) &amp; (DDE_FDEFERUPD | DDE_FACKREQ)) | DDE_FRELEASE),
00079             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>);
00080     <span class="keywordflow">if</span> (!pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>) {
00081         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_MEMORY_ERROR);
00082         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00083     }
00084 
00085     <a class="code" href="../../d4/d2/hsz_8c.html#a14">IncGlobalAtomCount</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
00086     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, 0, WM_DDE_ADVISE,
00087             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, HandleToUlong(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>), pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>);
00088     <span class="keywordflow">if</span> (dwError) {
00089         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
00090         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>);
00091         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a> = 0;
00092         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
00093         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00094     }
00095 
00096     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_ADVSENT;
00097     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o4">pfnResponse</a> = (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a58">FNRESPONSE</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a143">ClRespAdviseAck</a>;
00098     <a class="code" href="../../d0/d1/xact_8c.html#a10">LinkTransaction</a>(pxi);
00099     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00100 }
00101 
00102 
00103 <span class="comment">/***************************************************************************\</span>
00104 <span class="comment">* SvSpontAdvise</span>
00105 <span class="comment">*</span>
00106 <span class="comment">* Description:</span>
00107 <span class="comment">* SERVER side WM_DDE_ADVISE processing</span>
00108 <span class="comment">*</span>
00109 <span class="comment">* History:</span>
00110 <span class="comment">* 11-12-91 sanfords Created.</span>
00111 <span class="comment">\***************************************************************************/</span>
<a name="l00112"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a1">00112</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a1">SvSpontAdvise</a>(
00113 <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi,
00114 LPARAM lParam)
00115 {
00116     UINT_PTR uiHi;
00117     HANDLE hDDE;
00118     WORD wFmt, wStatus;
00119     ULONG_PTR dwRet = 0;
00120     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00121     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> la;
00122 
00123     <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_ADVISE, lParam, (PUINT_PTR)&amp;hDDE, &amp;uiHi);
00124     <span class="keywordflow">if</span> (psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_ADVISES) {
00125         <span class="keywordflow">goto</span> Ack;
00126     }
00127 
00128     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/stdptcl_8c.html#a24">ExtractDDEDataInfo</a>(hDDE, &amp;wStatus, &amp;wFmt)) {
00129         <span class="keywordflow">goto</span> Ack;
00130     }
00131 
00132     <span class="keywordflow">if</span> (wStatus &amp; DDE_FDEFERUPD) {
00133         wStatus &amp;= ~DDE_FACKREQ;   <span class="comment">// warm links shouldn't have this flag set</span>
00134     }
00135 
00136     la = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi);
00137     dwRet = (ULONG_PTR)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>,
00138         XTYP_ADVSTART,
00139         wFmt, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
00140         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>),
00141         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(la),
00142         (HDDEDATA)0, 0, 0);
00143     DeleteAtom(la);
00144 
00145     <span class="comment">// check CBR_BLOCK case</span>
00146 
00147     <span class="keywordflow">if</span> (dwRet == (ULONG_PTR)CBR_BLOCK) {
00148         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00149     }
00150 
00151     <span class="keywordflow">if</span> (dwRet) {
00152         <span class="comment">//</span>
00153         <span class="comment">// If we fail to add the link internally, dwRet == 0 -&gt; NACK</span>
00154         <span class="comment">//</span>
00155         dwRet = <a class="code" href="../../d2/d2/util_8c.html#a0">AddLink</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)psi, (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi, wFmt,
00156                 (WORD)(wStatus &amp; (WORD)(DDE_FDEFERUPD | DDE_FACKREQ)));
00157         <span class="keywordflow">if</span> (dwRet) {
00158             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a4">MONLINK</a>(psi-&gt;ci.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, wStatus &amp; DDE_FDEFERUPD, psi-&gt;ci.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o4">laService</a>,
00159                     psi-&gt;ci.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>, (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi, wFmt, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00160                     (HCONV)psi-&gt;ci.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, (HCONV)psi-&gt;ci.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>);
00161         }
00162     }
00163 
00164 Ack:
00165     <span class="keywordflow">if</span> (dwRet) {
00166         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(hDDE); <span class="comment">// hOptions - NACK -&gt; HE frees it.</span>
00167     }
00168     <span class="comment">// IncGlobalAtomCount((GATOM)uiHi);         // message copy - reuse</span>
00169     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, WM_DDE_ADVISE, WM_DDE_ACK,
00170             psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, lParam, dwRet ? DDE_FACK : 0, uiHi);
00171     <span class="keywordflow">if</span> (dwError) {
00172         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
00173         GlobalDeleteAtom((ATOM)uiHi); <span class="comment">// message copy</span>
00174     }
00175 
00176     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00177 }
00178 
00179 
00180 
00181 <span class="comment">/***************************************************************************\</span>
00182 <span class="comment">* ClRespAdviseAck</span>
00183 <span class="comment">*</span>
00184 <span class="comment">* Description:</span>
00185 <span class="comment">* Client's response to an expected Advise Ack.</span>
00186 <span class="comment">*</span>
00187 <span class="comment">* History:</span>
00188 <span class="comment">* 11-12-91 sanfords Created.</span>
00189 <span class="comment">\***************************************************************************/</span>
<a name="l00190"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a2">00190</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a2">ClRespAdviseAck</a>(
00191 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi,
00192 UINT msg,
00193 LPARAM lParam)
00194 {
00195     UINT_PTR uiLo, uiHi;
00196 
00197     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00198         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> != WM_DDE_ACK) {
00199             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
00200         }
00201 
00202         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_ACK, lParam, &amp;uiLo, &amp;uiHi);
00203 <span class="preprocessor">#if DBG</span>
00204 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>) {
00205             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
00206         }
00207 <span class="preprocessor">#endif</span>
00208 <span class="preprocessor"></span>
00209         GlobalDeleteAtom((ATOM)uiHi); <span class="comment">// message copy</span>
00210 
00211         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_ADVACKRCVD;
00212         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> = (WORD)uiLo;
00213 
00214         <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> &amp; DDE_FACK) {
00215             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/util_8c.html#a0">AddLink</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>,
00216                     (WORD)((pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o7">wType</a> &lt;&lt; 12) &amp; (DDE_FACKREQ | DDE_FDEFERUPD)))) {
00217                 <span class="comment">//</span>
00218                 <span class="comment">// only server side reports links on local conversations.</span>
00219                 <span class="comment">//</span>
00220                 <span class="keywordflow">if</span> (!(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_ISLOCAL)) {
00221                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a4">MONLINK</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (WORD)uiLo &amp; DDE_FDEFERUPD,
00222                             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o4">laService</a>, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>,
00223                             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (HCONV)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>,
00224                             (HCONV)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>);
00225                 }
00226             } <span class="keywordflow">else</span> {
00227                 pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> = 0;  <span class="comment">// memory failure - fake a NACK.</span>
00228             }
00229         } <span class="keywordflow">else</span> {
00230             <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>);  <span class="comment">// Nack free.</span>
00231         }
00232 
00233         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a25">TransactionComplete</a>(pxi,
00234                 (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> &amp; DDE_FACK) ? (HDDEDATA)1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> : (HDDEDATA)0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
00235             <span class="keywordflow">goto</span> Cleanup;
00236         }
00237     } <span class="keywordflow">else</span> {
00238 Cleanup:
00239         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// pxi copy</span>
00240         <a class="code" href="../../d0/d1/xact_8c.html#a11">UnlinkTransaction</a>(pxi);
00241         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxi);
00242     }
00243     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00244         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00245     }
00246     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00247 }
00248 
00249 <span class="comment">//-------------------------ADVISE LINK UPDATE--------------------------//</span>
00250 
00251 
00252 <span class="comment">/***************************************************************************\</span>
00253 <span class="comment">* SvStartAdviseUpdate</span>
00254 <span class="comment">*</span>
00255 <span class="comment">* Description:</span>
00256 <span class="comment">* Starts a single link update transaction. The return value is TRUE only</span>
00257 <span class="comment">* if pxi was queued.</span>
00258 <span class="comment">*</span>
00259 <span class="comment">* History:</span>
00260 <span class="comment">* 11-19-91 sanfords Created.</span>
00261 <span class="comment">* 8-24-92  sanfords Added cLinksToGo</span>
00262 <span class="comment">\***************************************************************************/</span>
<a name="l00263"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a3">00263</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a3">SvStartAdviseUpdate</a>(
00264 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi,
00265 DWORD cLinksToGo)
00266 {
00267     HDDEDATA hData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00268     <a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a> pdde;
00269     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00270     HANDLE hDDE;
00271     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> al;
00272 
00273     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00274 
00275     <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o7">wType</a> &amp; DDE_FDEFERUPD) {
00276         hDDE = 0;
00277     } <span class="keywordflow">else</span> {
00278         al = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>);
00279         hData = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>,
00280                            XTYP_ADVREQ,
00281                            pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>,
00282                            pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
00283                            <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>),
00284                            <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(al),
00285                            (HDDEDATA)0,
00286                            MAKELONG(cLinksToGo, 0),
00287                            0);
00288         DeleteAtom(al);
00289         <span class="keywordflow">if</span> (!hData) {
00290             <span class="comment">// app doesn't honor the advise.</span>
00291             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// reuse pxi</span>
00292         }
00293         hDDE = <a class="code" href="../../d2/d6/stdptcl_8c.html#a26">UnpackAndFreeDDEMLDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00294         <span class="keywordflow">if</span> (!hDDE) {
00295 
00296             <span class="comment">/*</span>
00297 <span class="comment">             * failed - must be execute type data</span>
00298 <span class="comment">             */</span>
00299             <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00300             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_DLL_USAGE);
00301             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00302         }
00303         <span class="comment">/*</span>
00304 <span class="comment">         * Set fAckReq bit apropriately - note APPOWNED handles will already</span>
00305 <span class="comment">         * have the fAckReq bit set so this will not change their state.</span>
00306 <span class="comment">         */</span>
00307         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDE, pdde);
00308         <span class="keywordflow">if</span> (pdde == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00309             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00310         }
00311         <span class="keywordflow">if</span> (pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o1">wFmt</a> != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>) {
00312 
00313             <span class="comment">/*</span>
00314 <span class="comment">             * bogus data - wrong format!</span>
00315 <span class="comment">             */</span>
00316             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00317             <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00318             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_DLL_USAGE);
00319             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00320         }
00321         <span class="keywordflow">if</span> (!(pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o0">wStatus</a> &amp; DDE_FRELEASE)) {
00322             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o7">wType</a> |= DDE_FACKREQ; <span class="comment">// dare not allow neither flag set!</span>
00323         }
00324         pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o0">wStatus</a> |= (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o7">wType</a> &amp; DDE_FACKREQ);
00325         <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00326     }
00327 
00328     <a class="code" href="../../d4/d2/hsz_8c.html#a14">IncGlobalAtomCount</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
00329     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, 0, WM_DDE_DATA,
00330             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, HandleToUlong(hDDE), pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>);
00331     <span class="keywordflow">if</span> (dwError) {
00332         <span class="keywordflow">if</span> (hData) {
00333             <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00334         }
00335         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
00336         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
00337         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00338     }
00339 
00340     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_ADVDATASENT;
00341     <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o7">wType</a> &amp; DDE_FACKREQ) {
00342         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a> = hDDE;
00343         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o4">pfnResponse</a> = (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a58">FNRESPONSE</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a146">SvRespAdviseDataAck</a>;
00344         <a class="code" href="../../d0/d1/xact_8c.html#a10">LinkTransaction</a>(pxi);
00345         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>); <span class="comment">// prevents reuse - since its queued.</span>
00346     } <span class="keywordflow">else</span> {
00347         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// causes pxi to be reused for next advdata message.</span>
00348     }
00349 }
00350 
00351 
00352 
00353 <span class="comment">/***************************************************************************\</span>
00354 <span class="comment">* ClSpontAdviseData</span>
00355 <span class="comment">*</span>
00356 <span class="comment">* Description:</span>
00357 <span class="comment">* Handles WM_DDE_DATA messages that are not request data.</span>
00358 <span class="comment">*</span>
00359 <span class="comment">* History:</span>
00360 <span class="comment">* 11-19-91 sanfords Created.</span>
00361 <span class="comment">\***************************************************************************/</span>
<a name="l00362"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a4">00362</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a4">ClSpontAdviseData</a>(
00363 <a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a> pci,
00364 LPARAM lParam)
00365 {
00366     UINT_PTR uiHi;
00367     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00368     HANDLE hDDE = 0;
00369     HDDEDATA hData, hDataReturn;
00370     <a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a> pdde;
00371     WORD wFmt;
00372     WORD wStatus;
00373     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> la;
00374     <a class="code" href="../../d2/d8/structtagADVISE__LINK.html">PADVISE_LINK</a> paLink;
00375     <span class="keywordtype">int</span> iLink;
00376 
00377     <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_DATA, lParam, (PUINT_PTR)&amp;hDDE, &amp;uiHi);
00378     UserAssert(!hDDE || GlobalSize(hDDE));
00379     wFmt = 0;
00380     wStatus = 0;
00381     hDataReturn = 0;
00382     la = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi);
00383     <span class="keywordflow">if</span> (hDDE) {
00384         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDE, pdde);
00385         <span class="keywordflow">if</span> (pdde == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00386             hData = 0;
00387         } <span class="keywordflow">else</span> {
00388             wFmt = pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o1">wFmt</a>;
00389             wStatus = pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o0">wStatus</a>;
00390             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00391 
00392             <span class="comment">/*</span>
00393 <span class="comment">             * if data is coming in, create a data handle for the app</span>
00394 <span class="comment">             */</span>
00395             hData = <a class="code" href="../../d0/d9/hdata_8c.html#a2">InternalCreateDataHandle</a>(pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, (LPBYTE)hDDE,
00396                     (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1, 0, HDATA_NOAPPFREE | HDATA_READONLY, 0, 0);
00397         }
00398         <span class="keywordflow">if</span> (hData) {
00399             hDataReturn = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, XTYP_ADVDATA,
00400                     wFmt, pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
00401                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>),
00402                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(la),
00403                     hData, 0, 0);
00404             <span class="keywordflow">if</span> (hDataReturn != CBR_BLOCK) {
00405                 <a class="code" href="../../d2/d6/stdptcl_8c.html#a26">UnpackAndFreeDDEMLDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00406                 <span class="keywordflow">if</span> (((ULONG_PTR)hDataReturn &amp; DDE_FACK) || !(wStatus &amp; DDE_FACKREQ)) {
00407                     <span class="comment">/*</span>
00408 <span class="comment">                     * Nacked Advise data with fAckReq set is server's</span>
00409 <span class="comment">                     * responsibility to free!</span>
00410 <span class="comment">                     */</span>
00411                     <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(hDDE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00412                 }
00413             }
00414         }
00415     } <span class="keywordflow">else</span> {
00416         <span class="comment">/*</span>
00417 <span class="comment">         * WARM LINK CASE</span>
00418 <span class="comment">         *</span>
00419 <span class="comment">         * Search through the client's link info to find what formats this</span>
00420 <span class="comment">         * puppy is on. We let the client know for each format being supported</span>
00421 <span class="comment">         * on this item that is warm-linked. The last hDataReturn determines</span>
00422 <span class="comment">         * the ACK returned - for lack of a better method.</span>
00423 <span class="comment">         */</span>
00424         <span class="keywordflow">for</span> (paLink = pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o14">aLinks</a>, iLink = 0; iLink &lt; pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a>; iLink++, paLink++) {
00425             <span class="keywordflow">if</span> ((paLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o1">laItem</a> == la) &amp;&amp; (paLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o3">wType</a> &amp; DDE_FDEFERUPD)) {
00426                 hDataReturn = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, XTYP_ADVDATA,
00427                         paLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o2">wFmt</a>, pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
00428                         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>),
00429                         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(la),
00430                         0, 0, 0);
00431                 <span class="keywordflow">if</span> (hDataReturn == CBR_BLOCK) {
00432                     DeleteAtom(la);
00433                     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00434                 }
00435             }
00436         }
00437     }
00438     DeleteAtom(la);
00439     <span class="keywordflow">if</span> (hDataReturn == CBR_BLOCK) {
00440         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00441     }
00442 
00443     <span class="keywordflow">if</span> (wStatus &amp; DDE_FACKREQ) {
00444 
00445         (ULONG_PTR)hDataReturn &amp;= ~DDE_FACKRESERVED;
00446         <span class="comment">// reuse uiHi</span>
00447         <span class="keywordflow">if</span> (dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, WM_DDE_DATA,
00448                 WM_DDE_ACK, pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, lParam, (UINT_PTR)hDataReturn, uiHi)) {
00449             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
00450         }
00451     } <span class="keywordflow">else</span> {
00452         GlobalDeleteAtom((ATOM)uiHi); <span class="comment">// data message copy</span>
00453         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(WM_DDE_DATA, lParam); <span class="comment">// not reused so free it.</span>
00454     }
00455     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00456 }
00457 
00458 
00459 
00460 
00461 <span class="comment">/***************************************************************************\</span>
00462 <span class="comment">* SvRespAdviseDataAck</span>
00463 <span class="comment">*</span>
00464 <span class="comment">* Description:</span>
00465 <span class="comment">* Handles expected Advise Data ACK message.</span>
00466 <span class="comment">*</span>
00467 <span class="comment">* History:</span>
00468 <span class="comment">* 11-19-91 sanfords Created.</span>
00469 <span class="comment">\***************************************************************************/</span>
<a name="l00470"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a5">00470</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a5">SvRespAdviseDataAck</a>(
00471 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi,
00472 UINT msg,
00473 LPARAM lParam)
00474 {
00475     UINT_PTR uiLo, uiHi;
00476     <span class="keywordtype">int</span> iLink;
00477     <a class="code" href="../../d2/d8/structtagADVISE__LINK.html">PADVISE_LINK</a> paLink;
00478     <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxiNew;
00479     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> la;
00480     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSwapped;
00481 <span class="preprocessor">#if DBG</span>
00482 <span class="preprocessor"></span>    <span class="keywordtype">int</span> cLinks;
00483 <span class="preprocessor">#endif</span>
00484 <span class="preprocessor"></span>
00485     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00486         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> != WM_DDE_ACK) {
00487             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a21">SpontaneousServerMessage</a>((<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
00488         }
00489         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_ACK, lParam, &amp;uiLo, &amp;uiHi);
00490         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>) {
00491             RIPMSG0(RIP_ERROR, <span class="stringliteral">"DDE Protocol violation: Data ACK had wrong item"</span>);
00492             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a21">SpontaneousServerMessage</a>((<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
00493         }
00494 
00495         GlobalDeleteAtom((ATOM)uiHi); <span class="comment">// message copy</span>
00496         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(WM_DDE_ACK, lParam);
00497 
00498         <span class="keywordflow">if</span> (!((uiLo &amp; DDE_FACK) &amp;&amp; pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>)) {
00499             <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00500         }
00501 
00502 <span class="preprocessor">        #if DBG</span>
00503 <span class="preprocessor"></span>        <span class="comment">/*</span>
00504 <span class="comment">         * Rememeber the number of links so we can assert if they change during the loop below</span>
00505 <span class="comment">         */</span>
00506         cLinks = pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a>;
00507 <span class="preprocessor">        #endif</span>
00508 <span class="preprocessor"></span>        <span class="comment">/*</span>
00509 <span class="comment">         * locate link info and clear ADVST_WAITING bit</span>
00510 <span class="comment">         */</span>
00511         la = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi);
00512         paLink = pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o14">aLinks</a>;
00513         <span class="keywordflow">for</span> (iLink = 0; iLink &lt; pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a>; iLink++, paLink++) {
00514             <span class="keywordflow">if</span> (paLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o1">laItem</a> == la &amp;&amp;
00515                     paLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o4">state</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a47">ADVST_WAITING</a>) {
00516                 paLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o4">state</a> &amp;= ~<a class="code" href="../../d0/d4/ddemlcli_8h.html#a47">ADVST_WAITING</a>;
00517                 <span class="comment">/*</span>
00518 <span class="comment">                 * We have to allocate pxiNew because it may become linked</span>
00519 <span class="comment">                 * into pcoi-&gt;pxiIn.</span>
00520 <span class="comment">                 */</span>
00521                 pxiNew = (<a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/structtagXACT__INFO.html">XACT_INFO</a>));
00522 
00523                 <span class="keywordflow">if</span> (pxiNew &amp;&amp; !<a class="code" href="../../d0/d1/xact_8c.html#a8">UpdateLinkIfChanged</a>(paLink, pxiNew, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>,
00524                         &amp;pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o14">aLinks</a>[pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a> - 1], &amp;fSwapped,
00525                         CADV_LATEACK)) {
00526                     <span class="comment">/*</span>
00527 <span class="comment">                     * Not used, free it.</span>
00528 <span class="comment">                     */</span>
00529                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxiNew);
00530                 }
00531                 <span class="keywordflow">break</span>;
00532             }
00533         }
00534 <span class="preprocessor">        #if DBG</span>
00535 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (cLinks != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a>) {
00536             RIPMSG1(RIP_ERROR, <span class="stringliteral">"SvRespAdviseDataAck: cLinks changed. pxi:%#p"</span>, pxi);
00537         }
00538 <span class="preprocessor">        #endif</span>
00539 <span class="preprocessor"></span>
00540         DeleteAtom(la);
00541     }
00542     GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// pxi copy</span>
00543     <a class="code" href="../../d0/d1/xact_8c.html#a11">UnlinkTransaction</a>(pxi);
00544     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxi);
00545     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00546 }
00547 
00548 
00549 
00550 <span class="comment">//------------------------------UNADVISE-------------------------------//</span>
00551 
00552 <span class="comment">/***************************************************************************\</span>
00553 <span class="comment">* ClStartUnadvise</span>
00554 <span class="comment">*</span>
00555 <span class="comment">* Description:</span>
00556 <span class="comment">* Starts a WM_DDE_UNADVISE transaction.</span>
00557 <span class="comment">*</span>
00558 <span class="comment">* History:</span>
00559 <span class="comment">* 11-19-91 sanfords Created.</span>
00560 <span class="comment">\***************************************************************************/</span>
<a name="l00561"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a6">00561</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a6">ClStartUnadvise</a>(
00562 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi)
00563 {
00564     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00565 
00566     <a class="code" href="../../d4/d2/hsz_8c.html#a14">IncGlobalAtomCount</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
00567     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, 0, WM_DDE_UNADVISE,
00568             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>);
00569     <span class="keywordflow">if</span> (dwError) {
00570         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
00571         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
00572         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00573     }
00574 
00575     <span class="comment">//</span>
00576     <span class="comment">// only server side reports links on local conversations.</span>
00577     <span class="comment">//</span>
00578     <span class="keywordflow">if</span> (!(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_ISLOCAL)) {
00579         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a4">MONLINK</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0,
00580                 pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o4">laService</a>, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>,
00581                 pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (HCONV)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>,
00582                 (HCONV)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>);
00583     }
00584     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_UNADVSENT;
00585     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o4">pfnResponse</a> = (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a58">FNRESPONSE</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a149">ClRespUnadviseAck</a>;
00586     <a class="code" href="../../d0/d1/xact_8c.html#a10">LinkTransaction</a>(pxi);
00587     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00588 }
00589 <span class="comment">/***************************************************************************\</span>
00590 <span class="comment">* CloseTransaction</span>
00591 <span class="comment">*</span>
00592 <span class="comment">* Description:</span>
00593 <span class="comment">* Remove all outstanding pxi coresponding to the transaction</span>
00594 <span class="comment">* that will be closed in responds to a WM_DDE_UNADVISE message.</span>
00595 <span class="comment">*</span>
00596 <span class="comment">* History:</span>
00597 <span class="comment">* 6-4-96 clupu Created.</span>
00598 <span class="comment">\***************************************************************************/</span>
<a name="l00599"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a7">00599</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d6/stdptcl_8c.html#a7">CloseTransaction</a>(
00600     <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pci,
00601     ATOM       atom)
00602 {
00603     <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi;
00604     <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxiD;
00605 
00606     pxi = pci-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>;
00607 
00608     <span class="keywordflow">while</span> (pxi &amp;&amp; (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a> == atom)) {
00609         pxiD = pxi;
00610         pxi  = pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o0">next</a>;
00611         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxiD);
00612     }
00613     pci-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a> = pxi;
00614 
00615     <span class="keywordflow">if</span> (pxi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00616         pci-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o10">pxiIn</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00617         <span class="keywordflow">return</span>;
00618     }
00619 
00620     <span class="keywordflow">while</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o0">next</a>) {
00621         <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o0">next</a>-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a> == atom) {
00622             pxiD = pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o0">next</a>;
00623             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o0">next</a> = pxiD-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o0">next</a>;
00624             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxiD);
00625         } <span class="keywordflow">else</span>
00626             pxi = pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o0">next</a>;
00627     }
00628     pci-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o10">pxiIn</a> = pxi;
00629 }
00630 
00631 <span class="comment">/***************************************************************************\</span>
00632 <span class="comment">* SvSpontUnadvise</span>
00633 <span class="comment">*</span>
00634 <span class="comment">* Description:</span>
00635 <span class="comment">* Responds to a WM_DDE_UNADVISE message.</span>
00636 <span class="comment">*</span>
00637 <span class="comment">* History:</span>
00638 <span class="comment">* 11-19-91 sanfords Created.</span>
00639 <span class="comment">\***************************************************************************/</span>
<a name="l00640"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a8">00640</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a8">SvSpontUnadvise</a>(
00641 <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi,
00642 LPARAM lParam)
00643 {
00644     ULONG_PTR dwRet = 0;
00645     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00646     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iLink;
00647     <a class="code" href="../../d2/d8/structtagADVISE__LINK.html">PADVISE_LINK</a> aLink;
00648     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> la;
00649 
00650     la = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)HIWORD(lParam));
00651 
00652     <a class="code" href="../../d2/d6/stdptcl_8c.html#a7">CloseTransaction</a>(&amp;psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>, HIWORD(lParam));
00653 
00654     <span class="keywordflow">for</span> (aLink = psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o14">aLinks</a>, iLink = 0; iLink &lt; psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a>;) {
00655 
00656         <span class="keywordflow">if</span> (la == 0 || aLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o1">laItem</a> == la &amp;&amp;
00657                 (LOWORD(lParam) == 0 || LOWORD(lParam) == aLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o2">wFmt</a>)) {
00658 
00659             <span class="keywordflow">if</span> (!(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_ADVISES)) {
00660                 <span class="comment">/*</span>
00661 <span class="comment">                 * Only do the callbacks if he wants them.</span>
00662 <span class="comment">                 */</span>
00663                 dwRet = (ULONG_PTR)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>,
00664                     (WORD)XTYP_ADVSTOP, aLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o2">wFmt</a>, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
00665                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>),
00666                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(la),
00667                     (HDDEDATA)0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00668                 <span class="keywordflow">if</span> (dwRet == (ULONG_PTR)CBR_BLOCK) {
00669                     DeleteAtom(la);
00670                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00671                 }
00672             }
00673             <span class="comment">/*</span>
00674 <span class="comment">             * Notify any DDESPY apps.</span>
00675 <span class="comment">             */</span>
00676             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a4">MONLINK</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o4">laService</a>,
00677                     psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>, HIWORD(lParam), aLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o2">wFmt</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00678                     (HCONV)psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, (HCONV)psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>);
00679             <span class="comment">/*</span>
00680 <span class="comment">             * Remove link info</span>
00681 <span class="comment">             */</span>
00682             DeleteAtom(aLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o1">laItem</a>);  <span class="comment">// aLink copy</span>
00683             <a class="code" href="../../d2/d2/util_8c.html#a1">DeleteLinkCount</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, aLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o0">pLinkCount</a>);
00684             <span class="keywordflow">if</span> (--psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a>) {
00685                 memmove((LPSTR)aLink, (LPSTR)(aLink + 1),
00686                         <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/structtagADVISE__LINK.html">ADVISE_LINK</a>) * (psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a> - iLink));
00687             }
00688         } <span class="keywordflow">else</span> {
00689             aLink++;
00690             iLink++;
00691         }
00692     }
00693 
00694     DeleteAtom(la);
00695 
00696     <span class="comment">/*</span>
00697 <span class="comment">     * Now ACK the unadvise message.</span>
00698 <span class="comment">     */</span>
00699     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, 0,
00700             WM_DDE_ACK, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, DDE_FACK, HIWORD(lParam));
00701     <span class="keywordflow">if</span> (dwError) {
00702         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
00703         GlobalDeleteAtom((ATOM)HIWORD(lParam));      <span class="comment">// message copy</span>
00704         <span class="comment">// FreeDDElParam(WM_DDE_UNADVISE, lParam);   // no unpack needed</span>
00705     }
00706 
00707     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00708 }
00709 
00710 <span class="comment">/***************************************************************************\</span>
00711 <span class="comment">* ClRespUnadviseAck</span>
00712 <span class="comment">*</span>
00713 <span class="comment">* Description:</span>
00714 <span class="comment">* Client's response to an expected Unadvise Ack.</span>
00715 <span class="comment">*</span>
00716 <span class="comment">* History:</span>
00717 <span class="comment">* 11-12-91 sanfords Created.</span>
00718 <span class="comment">\***************************************************************************/</span>
<a name="l00719"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a9">00719</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a9">ClRespUnadviseAck</a>(
00720 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi,
00721 UINT msg,
00722 LPARAM lParam)
00723 {
00724     UINT_PTR uiLo, uiHi;
00725     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> al;
00726     <a class="code" href="../../d2/d8/structtagADVISE__LINK.html">PADVISE_LINK</a> aLink;
00727     <span class="keywordtype">int</span> iLink;
00728 
00729     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00730         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> != WM_DDE_ACK) {
00731             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
00732         }
00733 
00734         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_ACK, lParam, &amp;uiLo, &amp;uiHi);
00735         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>) {
00736             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
00737         }
00738 
00739         al = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>((ATOM)uiHi);
00740         <span class="keywordflow">for</span> (aLink = pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o14">aLinks</a>, iLink = 0;
00741                 iLink &lt; pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a>;
00742                     ) {
00743             <span class="keywordflow">if</span> (aLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o1">laItem</a> == al &amp;&amp;
00744                     (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a> == 0 || aLink-&gt;<a class="code" href="../../d2/d8/structtagADVISE__LINK.html#o2">wFmt</a> == pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>)) {
00745                 DeleteAtom(al);  <span class="comment">// aLink copy</span>
00746                 <span class="keywordflow">if</span> (--pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a>) {
00747                     memmove((LPSTR)aLink, (LPSTR)(aLink + 1),
00748                             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/structtagADVISE__LINK.html">ADVISE_LINK</a>) * (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o15">cLinks</a> - iLink));
00749                 }
00750             } <span class="keywordflow">else</span> {
00751                 aLink++;
00752                 iLink++;
00753             }
00754         }
00755         DeleteAtom(al);  <span class="comment">// local copy</span>
00756         GlobalDeleteAtom((ATOM)uiHi);   <span class="comment">// message copy</span>
00757 
00758         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_UNADVACKRCVD;
00759         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> = (WORD)uiLo;
00760         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a25">TransactionComplete</a>(pxi, (HDDEDATA)1)) {
00761             <span class="keywordflow">goto</span> Cleanup;
00762         }
00763     } <span class="keywordflow">else</span> {
00764 Cleanup:
00765         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>);   <span class="comment">// pxi copy</span>
00766         <a class="code" href="../../d0/d1/xact_8c.html#a11">UnlinkTransaction</a>(pxi);
00767         <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>) {
00768             <a class="code" href="../../d3/d8/handles_8c.html#a7">DestroyHandle</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>);
00769         }
00770         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxi);
00771     }
00772     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00773         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00774     }
00775     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00776 }
00777 
00778 
00779 <span class="comment">//-------------------------------EXECUTE-------------------------------//</span>
00780 
00781 
00782 <span class="comment">/***************************************************************************\</span>
00783 <span class="comment">* MaybeTranslateExecuteData</span>
00784 <span class="comment">*</span>
00785 <span class="comment">* Description:</span>
00786 <span class="comment">* Translates DDE execute data if needed.</span>
00787 <span class="comment">*</span>
00788 <span class="comment">* History:</span>
00789 <span class="comment">* 1/28/92 sanfords created</span>
00790 <span class="comment">\***************************************************************************/</span>
<a name="l00791"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a10">00791</a> HANDLE <a class="code" href="../../d2/d6/stdptcl_8c.html#a10">MaybeTranslateExecuteData</a>(
00792 HANDLE hDDE,
00793 BOOL fUnicodeFrom,
00794 BOOL fUnicodeTo,
00795 BOOL fFreeSource)
00796 {
00797     PSTR pstr;
00798     PWSTR pwstr;
00799     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cb;
00800     HANDLE hDDEnew;
00801 
00802     <span class="keywordflow">if</span> (fUnicodeFrom &amp;&amp; !fUnicodeTo) {
00803         <span class="comment">// translate data from UNICODE to ANSII</span>
00804         cb = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(GlobalSize(hDDE) &gt;&gt; 1);
00805         hDDEnew = <a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(GMEM_DDESHARE | GMEM_MOVEABLE, cb);
00806         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDEnew, pstr);
00807         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDE, pwstr);
00808         <span class="keywordflow">if</span> (pstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00809             WCSToMB(pwstr, -1, &amp;pstr, cb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00810         }
00811         <span class="keywordflow">if</span> (pwstr) {
00812             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00813         }
00814         <span class="keywordflow">if</span> (pstr) {
00815             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDEnew);
00816         }
00817     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fUnicodeFrom &amp;&amp; fUnicodeTo) {
00818         <span class="comment">// translate data from ANSII to UNICODE</span>
00819         cb = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(GlobalSize(hDDE) &lt;&lt; 1);
00820         hDDEnew = <a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(GMEM_DDESHARE | GMEM_MOVEABLE, cb);
00821         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDEnew, pwstr);
00822         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDE, pstr);
00823         <span class="keywordflow">if</span> (pwstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00824             MBToWCS(pstr, -1, &amp;pwstr, cb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00825         }
00826         <span class="keywordflow">if</span> (pstr) {
00827             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00828         }
00829         <span class="keywordflow">if</span> (pwstr) {
00830             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDEnew);
00831         }
00832     } <span class="keywordflow">else</span> {
00833         <span class="keywordflow">return</span> (hDDE); <span class="comment">// no translation needed.</span>
00834     }
00835     <span class="keywordflow">if</span> (fFreeSource) {
00836         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(hDDE);
00837     }
00838     <span class="keywordflow">return</span> (hDDEnew);
00839 }
00840 
00841 
00842 <span class="comment">/***************************************************************************\</span>
00843 <span class="comment">* ClStartExecute</span>
00844 <span class="comment">*</span>
00845 <span class="comment">* Description:</span>
00846 <span class="comment">* Starts an execute transaction.</span>
00847 <span class="comment">*</span>
00848 <span class="comment">* History:</span>
00849 <span class="comment">* 11-19-91 sanfords Created.</span>
00850 <span class="comment">* 1/28/92 sanfords added UNICODE support.</span>
00851 <span class="comment">\***************************************************************************/</span>
<a name="l00852"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a11">00852</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a11">ClStartExecute</a>(
00853 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi)
00854 {
00855     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00856 
00857     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a> = <a class="code" href="../../d2/d6/stdptcl_8c.html#a10">MaybeTranslateExecuteData</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>,
00858             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o16">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a50">IIF_UNICODE</a>,
00859             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_UNICODE_EXECUTE,
00860             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00861 
00862     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, 0, WM_DDE_EXECUTE,
00863             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, 0, HandleToUlong(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>));
00864     <span class="keywordflow">if</span> (dwError) {
00865         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
00866         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00867     }
00868     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_EXECSENT;
00869     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o4">pfnResponse</a> = (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a58">FNRESPONSE</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a151">ClRespExecuteAck</a>;
00870     <a class="code" href="../../d0/d1/xact_8c.html#a10">LinkTransaction</a>(pxi);
00871     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00872 }
00873 
00874 
00875 <span class="comment">/***************************************************************************\</span>
00876 <span class="comment">* SvSpontExecute</span>
00877 <span class="comment">*</span>
00878 <span class="comment">* Description:</span>
00879 <span class="comment">* Responds to a WM_DDE_EXECUTE message.</span>
00880 <span class="comment">*</span>
00881 <span class="comment">* History:</span>
00882 <span class="comment">* 11-19-91 sanfords Created.</span>
00883 <span class="comment">* 1/28/92 sanfords added UNICODE support.</span>
00884 <span class="comment">\***************************************************************************/</span>
<a name="l00885"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a12">00885</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a12">SvSpontExecute</a>(
00886 <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi,
00887 LPARAM lParam)
00888 {
00889     HANDLE hDDE, hDDEx;
00890     ULONG_PTR dwRet = 0;
00891     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00892     HDDEDATA hData = 0;
00893 
00894     hDDEx = hDDE = (HANDLE)lParam; <span class="comment">// UnpackDDElParam(msg, lParam, NULL, &amp;hDDE);</span>
00895     <span class="keywordflow">if</span> (psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_EXECUTES) {
00896         <span class="keywordflow">goto</span> Ack;
00897     }
00898 
00899     <span class="comment">/*</span>
00900 <span class="comment">     * Note that if unicode translation is needed, we use the translated</span>
00901 <span class="comment">     * handle for the callback and then destroy it but the ACK is always</span>
00902 <span class="comment">     * the original hDDE so that the protocol isn't violated:</span>
00903 <span class="comment">     *</span>
00904 <span class="comment">     * DDE COMMANDMENT #324: Thou shalt pass back the exact same data</span>
00905 <span class="comment">     * handle in an execute ACK that you were given by the execute</span>
00906 <span class="comment">     * message.</span>
00907 <span class="comment">     */</span>
00908     hDDEx = <a class="code" href="../../d2/d6/stdptcl_8c.html#a10">MaybeTranslateExecuteData</a>(hDDE,
00909             psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_UNICODE_EXECUTE,
00910             psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o16">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a50">IIF_UNICODE</a>,
00911             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00912 
00913     hData = <a class="code" href="../../d0/d9/hdata_8c.html#a2">InternalCreateDataHandle</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, (LPBYTE)hDDEx, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1, 0,
00914         HDATA_EXECUTE | HDATA_READONLY | HDATA_NOAPPFREE, 0, 0);
00915     <span class="keywordflow">if</span> (!hData) {
00916         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_MEMORY_ERROR);
00917         <span class="keywordflow">goto</span> Ack;
00918     }
00919 
00920     dwRet = (ULONG_PTR)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>,
00921             XTYP_EXECUTE, 0, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
00922             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>), 0, hData, 0, 0);
00923     <a class="code" href="../../d2/d6/stdptcl_8c.html#a26">UnpackAndFreeDDEMLDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00924 
00925     <span class="keywordflow">if</span> (dwRet == (ULONG_PTR)CBR_BLOCK) {
00926         <span class="keywordflow">if</span> (hDDEx != hDDE) {
00927             <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(hDDEx);
00928         }
00929         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00930     }
00931 
00932 Ack:
00933     dwRet &amp;= ~DDE_FACKRESERVED;
00934     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, WM_DDE_EXECUTE,
00935             WM_DDE_ACK, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, lParam, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)dwRet, HandleToUlong(hDDE));
00936     <span class="keywordflow">if</span> (dwError) {
00937         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
00938     }
00939 
00940     <span class="keywordflow">if</span> (hDDEx != hDDE) {
00941         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(hDDEx);
00942     }
00943 
00944     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00945 }
00946 
00947 
00948 
00949 <span class="comment">/***************************************************************************\</span>
00950 <span class="comment">* ClRespExecuteAck</span>
00951 <span class="comment">*</span>
00952 <span class="comment">* Description:</span>
00953 <span class="comment">* Responds to a WM_DDE_ACK in response to a WM_DDE_EXECUTE message.</span>
00954 <span class="comment">*</span>
00955 <span class="comment">* History:</span>
00956 <span class="comment">* 11-19-91 sanfords Created.</span>
00957 <span class="comment">\***************************************************************************/</span>
<a name="l00958"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a13">00958</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a13">ClRespExecuteAck</a>(
00959 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi,
00960 UINT msg,
00961 LPARAM lParam)
00962 {
00963     UINT_PTR uiLo, uiHi;
00964 
00965     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00966         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> != WM_DDE_ACK) {
00967             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
00968         }
00969 
00970         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_ACK, lParam, &amp;uiLo, &amp;uiHi);
00971         <span class="keywordflow">if</span> (uiHi != HandleToUlong(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>)) {
00972             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
00973         }
00974 
00975         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>((HANDLE)uiHi);
00976 
00977         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_EXECACKRCVD;
00978         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> = (WORD)uiLo;
00979 
00980         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a25">TransactionComplete</a>(pxi, (HDDEDATA)(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> &amp; DDE_FACK ? 1 : 0))) {
00981             <span class="keywordflow">goto</span> Cleanup;
00982         }
00983     } <span class="keywordflow">else</span> {
00984 Cleanup:
00985         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// pxi copy</span>
00986         <a class="code" href="../../d0/d1/xact_8c.html#a11">UnlinkTransaction</a>(pxi);
00987         <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>) {
00988             <a class="code" href="../../d3/d8/handles_8c.html#a7">DestroyHandle</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>);
00989         }
00990         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxi);
00991     }
00992     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00993         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00994     }
00995     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00996 }
00997 
00998 
00999 
01000 <span class="comment">//----------------------------------POKE-------------------------------//</span>
01001 
01002 
01003 <span class="comment">/***************************************************************************\</span>
01004 <span class="comment">* ClStartPoke</span>
01005 <span class="comment">*</span>
01006 <span class="comment">* Description:</span>
01007 <span class="comment">* Initiates a poke transaction.</span>
01008 <span class="comment">*</span>
01009 <span class="comment">* History:</span>
01010 <span class="comment">* 11-19-91 sanfords Created.</span>
01011 <span class="comment">\***************************************************************************/</span>
<a name="l01012"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a14">01012</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a14">ClStartPoke</a>(
01013 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi)
01014 {
01015     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
01016 
01017     <a class="code" href="../../d4/d2/hsz_8c.html#a14">IncGlobalAtomCount</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
01018     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, 0, WM_DDE_POKE,
01019             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, HandleToUlong(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>), pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>);
01020     <span class="keywordflow">if</span> (dwError) {
01021         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
01022         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
01023         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01024     }
01025 
01026     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_POKESENT;
01027     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o4">pfnResponse</a> = (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a58">FNRESPONSE</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a154">ClRespPokeAck</a>;
01028     <a class="code" href="../../d0/d1/xact_8c.html#a10">LinkTransaction</a>(pxi);
01029     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01030 }
01031 
01032 
01033 <span class="comment">/***************************************************************************\</span>
01034 <span class="comment">* SvSpontPoke</span>
01035 <span class="comment">*</span>
01036 <span class="comment">* Description:</span>
01037 <span class="comment">* Handles WM_DDE_POKE messages.</span>
01038 <span class="comment">*</span>
01039 <span class="comment">* History:</span>
01040 <span class="comment">* 11-19-91 sanfords Created.</span>
01041 <span class="comment">\***************************************************************************/</span>
<a name="l01042"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a15">01042</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a15">SvSpontPoke</a>(
01043 <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi,
01044 LPARAM lParam)
01045 {
01046     UINT_PTR uiHi;
01047     HANDLE hDDE = 0;
01048     HDDEDATA hData;
01049     ULONG_PTR dwRet = 0;
01050     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
01051     WORD wFmt, wStatus;
01052     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> al;
01053 
01054     <span class="comment">// See what we have</span>
01055 
01056     <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_DATA, lParam, (PUINT_PTR)&amp;hDDE, &amp;uiHi);
01057 
01058     <span class="keywordflow">if</span> (!(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_POKES)) {
01059         <span class="keywordflow">if</span> (!hDDE) {
01060             <span class="keywordflow">goto</span> Ack;
01061         }
01062         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/stdptcl_8c.html#a24">ExtractDDEDataInfo</a>(hDDE, &amp;wStatus, &amp;wFmt)) {
01063             <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(hDDE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);             <span class="comment">// free message data</span>
01064             <span class="keywordflow">goto</span> Ack;
01065         }
01066 
01067         hData = <a class="code" href="../../d0/d9/hdata_8c.html#a2">InternalCreateDataHandle</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, (LPBYTE)hDDE, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1, 0,
01068                 HDATA_NOAPPFREE | HDATA_READONLY, 0, 0);
01069         <span class="keywordflow">if</span> (!hData) {
01070             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_MEMORY_ERROR);
01071             <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(hDDE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);       <span class="comment">// free message data</span>
01072             <span class="keywordflow">goto</span> Ack;                             <span class="comment">// Nack it.</span>
01073             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01074         }
01075 
01076         al = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi);
01077             dwRet = (ULONG_PTR)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, XTYP_POKE,
01078                     wFmt, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
01079                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>),
01080                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(al),
01081                     hData, 0, 0);
01082         DeleteAtom(al);
01083         <a class="code" href="../../d2/d6/stdptcl_8c.html#a26">UnpackAndFreeDDEMLDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01084     }
01085     <span class="keywordflow">if</span> (dwRet == (ULONG_PTR)CBR_BLOCK) {
01086 
01087         <span class="comment">// Note: this code makes an app that return s CBR_BLOCK unable to</span>
01088         <span class="comment">// access the data after the callback return .</span>
01089 
01090         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01091     }
01092     <span class="keywordflow">if</span> (dwRet &amp; DDE_FACK) {
01093         <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(hDDE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01094     }
01095 
01096 Ack:
01097     dwRet &amp;= ~DDE_FACKRESERVED;
01098     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, WM_DDE_POKE, WM_DDE_ACK,
01099             psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, lParam, dwRet, uiHi);
01100     <span class="keywordflow">if</span> (dwError) {
01101         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
01102     }
01103     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01104 }
01105 
01106 
01107 <span class="comment">/***************************************************************************\</span>
01108 <span class="comment">* ClRespPokeAck</span>
01109 <span class="comment">*</span>
01110 <span class="comment">* Description:</span>
01111 <span class="comment">* Response to a WM_DDE_ACK message in response to a WM_DDE_POKE message.</span>
01112 <span class="comment">*</span>
01113 <span class="comment">* History:</span>
01114 <span class="comment">* 11-19-91 sanfords Created.</span>
01115 <span class="comment">\***************************************************************************/</span>
<a name="l01116"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a16">01116</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a16">ClRespPokeAck</a>(
01117 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi,
01118 UINT msg,
01119 LPARAM lParam)
01120 {
01121     UINT_PTR uiLo, uiHi;
01122 
01123     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
01124         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> != WM_DDE_ACK) {
01125             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
01126         }
01127 
01128         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_ACK, lParam, &amp;uiLo, &amp;uiHi);
01129         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>) {
01130             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
01131         }
01132 
01133         GlobalDeleteAtom((ATOM)uiHi); <span class="comment">// message copy</span>
01134 
01135         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_POKEACKRCVD;
01136         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> = (WORD)uiLo;
01137 
01138         <span class="keywordflow">if</span> (!((WORD)uiLo &amp; DDE_FACK)) {
01139             <span class="comment">//</span>
01140             <span class="comment">// NACKs make it our business to free the poked data.</span>
01141             <span class="comment">//</span>
01142             <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o11">hDDESent</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01143         }
01144 
01145         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a25">TransactionComplete</a>(pxi,
01146                 (HDDEDATA)(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> &amp; DDE_FACK ? 1 : 0))) {
01147             <span class="keywordflow">goto</span> Cleanup;
01148         }
01149     } <span class="keywordflow">else</span> {
01150 Cleanup:
01151         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// pxi copy</span>
01152         <a class="code" href="../../d0/d1/xact_8c.html#a11">UnlinkTransaction</a>(pxi);
01153         <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>) {
01154             <a class="code" href="../../d3/d8/handles_8c.html#a7">DestroyHandle</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>);
01155         }
01156         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxi);
01157     }
01158     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
01159         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
01160     }
01161     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01162 }
01163 
01164 
01165 <span class="comment">//-------------------------------REQUEST-------------------------------//</span>
01166 
01167 <span class="comment">/***************************************************************************\</span>
01168 <span class="comment">* ClStartRequest</span>
01169 <span class="comment">*</span>
01170 <span class="comment">* Description:</span>
01171 <span class="comment">* Start a request transaction.</span>
01172 <span class="comment">*</span>
01173 <span class="comment">* History:</span>
01174 <span class="comment">* 11-19-91 sanfords Created.</span>
01175 <span class="comment">\***************************************************************************/</span>
<a name="l01176"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a17">01176</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a17">ClStartRequest</a>(
01177 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi)
01178 {
01179     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
01180 
01181     <a class="code" href="../../d4/d2/hsz_8c.html#a14">IncGlobalAtomCount</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
01182     dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, 0, WM_DDE_REQUEST,
01183             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>);
01184     <span class="keywordflow">if</span> (dwError) {
01185         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
01186         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// message copy</span>
01187         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01188     }
01189 
01190     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_REQSENT;
01191     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o4">pfnResponse</a> = (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a58">FNRESPONSE</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a157">ClRespRequestData</a>;
01192     <a class="code" href="../../d0/d1/xact_8c.html#a10">LinkTransaction</a>(pxi);
01193     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01194 }
01195 
01196 
01197 
01198 <span class="comment">/***************************************************************************\</span>
01199 <span class="comment">* SvSpontRequest</span>
01200 <span class="comment">*</span>
01201 <span class="comment">* Description:</span>
01202 <span class="comment">* Respond to a WM_DDE_REQUEST message.</span>
01203 <span class="comment">*</span>
01204 <span class="comment">* History:</span>
01205 <span class="comment">* 11-19-91 sanfords Created.</span>
01206 <span class="comment">\***************************************************************************/</span>
<a name="l01207"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a18">01207</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a18">SvSpontRequest</a>(
01208 <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi,
01209 LPARAM lParam)
01210 {
01211     HANDLE hDDE = 0;
01212     HDDEDATA hDataRet;
01213     WORD wFmt, wStatus;
01214     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
01215     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> la;
01216 
01217     <span class="keywordflow">if</span> (psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_REQUESTS) {
01218         <span class="keywordflow">goto</span> Nack;
01219     }
01220     <span class="comment">// See what we have</span>
01221 
01222     <span class="comment">// UnpackDDElParam(lParam, WM_DDE_REQUEST, .... Requests arn't packed</span>
01223     wFmt = LOWORD(lParam);
01224     la = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)HIWORD(lParam));
01225     hDataRet = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, XTYP_REQUEST,
01226             wFmt, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
01227             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>),
01228             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(la),
01229             (HDDEDATA)0, 0, 0);
01230     DeleteAtom(la);
01231 
01232     <span class="keywordflow">if</span> (hDataRet == CBR_BLOCK) {
01233         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01234     }
01235 
01236     <span class="keywordflow">if</span> (hDataRet) {
01237 
01238         hDDE = <a class="code" href="../../d2/d6/stdptcl_8c.html#a26">UnpackAndFreeDDEMLDataHandle</a>(hDataRet, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01239         <span class="keywordflow">if</span> (!hDDE) {
01240             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_DLL_USAGE);
01241             <span class="keywordflow">goto</span> Nack;
01242         }
01243         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/stdptcl_8c.html#a24">ExtractDDEDataInfo</a>(hDDE, &amp;wStatus, &amp;wFmt)) {
01244             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_DLL_USAGE);
01245             <span class="keywordflow">goto</span> Nack;
01246         }
01247         <span class="keywordflow">if</span> (!(wStatus &amp; DDE_FRELEASE)) {
01248             <span class="comment">// Its APPOWNED or relayed from another server - only safe</span>
01249             <span class="comment">// thing to do is use a copy.</span>
01250             hDDE = <a class="code" href="../../d0/d9/hdata_8c.html#a13">CopyDDEData</a>(hDDE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01251             <span class="keywordflow">if</span> (!hDDE) {
01252                 <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_MEMORY_ERROR);
01253                 <span class="keywordflow">goto</span> Nack;
01254             }
01255         }
01256 
01257         <span class="comment">// Keep it simple, DDEML servers never ask for acks from requests.</span>
01258 
01259         wStatus = DDE_FRELEASE | DDE_FREQUESTED;
01260         <a class="code" href="../../d2/d6/stdptcl_8c.html#a22">AllocAndSetDDEData</a>((LPBYTE)hDDE, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1, wStatus, wFmt);
01261 
01262         <span class="comment">// just reuse HIWORD(lParam) (aItem) - message copy</span>
01263         <span class="keywordflow">if</span> (dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, WM_DDE_REQUEST,
01264                 WM_DDE_DATA, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, HandleToUlong(hDDE), HIWORD(lParam))) {
01265             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
01266             GlobalDeleteAtom(HIWORD(lParam)); <span class="comment">// message copy</span>
01267         }
01268 
01269     } <span class="keywordflow">else</span> {
01270 Nack:
01271         <span class="comment">// just reuse HIWORD(lParam) (aItem) - message copy</span>
01272         dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, WM_DDE_REQUEST,
01273                 WM_DDE_ACK, psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0, 0, HIWORD(lParam));
01274         <span class="keywordflow">if</span> (dwError) {
01275             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
01276             GlobalDeleteAtom(HIWORD(lParam)); <span class="comment">// message copy</span>
01277         }
01278     }
01279 
01280     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01281 }
01282 
01283 
01284 <span class="comment">/***************************************************************************\</span>
01285 <span class="comment">* ClRespRequestData</span>
01286 <span class="comment">*</span>
01287 <span class="comment">* Description:</span>
01288 <span class="comment">* Handles response to either a WM_DDE_ACK or WM_DDE_DATA in response to</span>
01289 <span class="comment">* a WM_DDE_REQUEST message.</span>
01290 <span class="comment">*</span>
01291 <span class="comment">* History:</span>
01292 <span class="comment">* 11-19-91 sanfords Created.</span>
01293 <span class="comment">\***************************************************************************/</span>
<a name="l01294"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a19">01294</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a19">ClRespRequestData</a>(
01295 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi,
01296 UINT msg,
01297 LPARAM lParam)
01298 {
01299     UINT_PTR uiLo, uiHi;
01300     WORD wFmt, wStatus;
01301     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
01302 
01303     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
01304         <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
01305         <span class="keywordflow">case</span> WM_DDE_DATA:
01306             <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_DATA, lParam, (PUINT_PTR)&amp;pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a>, &amp;uiHi);
01307             <span class="keywordflow">if</span> (!pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a>) {
01308                 <span class="comment">// must be an advise data message with NODATA.</span>
01309                 <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a4">ClSpontAdviseData</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, lParam));
01310             }
01311             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/stdptcl_8c.html#a24">ExtractDDEDataInfo</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a>, &amp;wStatus, &amp;wFmt)) {
01312                 <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a4">ClSpontAdviseData</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, lParam));
01313             }
01314             <span class="keywordflow">if</span> (!(wStatus &amp; DDE_FREQUESTED)) {
01315                 <span class="comment">// must be advise data</span>
01316                 <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a4">ClSpontAdviseData</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, lParam));
01317             }
01318             <span class="keywordflow">if</span> (wStatus &amp; DDE_FACKREQ) {
01319 
01320                 <span class="comment">// if DDE_FRELEASE is not set, and this is a synchronous</span>
01321                 <span class="comment">// transaction, we need to make a copy here so the user</span>
01322                 <span class="comment">// can free at his leisure.</span>
01323 
01324                 <span class="comment">// reuse uiHi - message copy</span>
01325                 dwError = <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>,
01326                         WM_DDE_DATA, WM_DDE_ACK, pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0,
01327                         pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a> == wFmt &amp;&amp; pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a> == (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi ?
01328                             DDE_FACK : 0, uiHi);
01329                 <span class="keywordflow">if</span> (dwError) {
01330                     <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, dwError);
01331                 }
01332             } <span class="keywordflow">else</span> {
01333                 GlobalDeleteAtom((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi);     <span class="comment">// message copy</span>
01334             }
01335             <span class="keywordflow">if</span> (wFmt != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a> || (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>) {
01336                 <span class="comment">/*</span>
01337 <span class="comment">                 * BOGUS returned data!  Just free it and make it look like</span>
01338 <span class="comment">                 * a NACK</span>
01339 <span class="comment">                 */</span>
01340                 <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01341                 pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a> = 0;
01342                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a25">TransactionComplete</a>(pxi, 0)) {
01343                     <span class="keywordflow">goto</span> Cleanup;
01344                 }
01345             } <span class="keywordflow">else</span> {
01346                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a25">TransactionComplete</a>(pxi, (HDDEDATA)-1)) {
01347                     <span class="keywordflow">goto</span> Cleanup;
01348                 }
01349             }
01350             <span class="keywordflow">break</span>;
01351 
01352         <span class="keywordflow">case</span> WM_DDE_ACK:
01353             <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_ACK, lParam, &amp;uiLo, &amp;uiHi);
01354             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi != pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>) {
01355                 <span class="keywordflow">return</span>(<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
01356             }
01357             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o10">state</a> = XST_DATARCVD;
01358             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> = (WORD)uiLo;
01359             GlobalDeleteAtom((<a class="code" href="../../d0/d4/ddemlcli_8h.html#a52">GATOM</a>)uiHi); <span class="comment">// message copy</span>
01360             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a25">TransactionComplete</a>(pxi, 0)) {
01361                 <span class="keywordflow">goto</span> Cleanup;
01362             }
01363             <span class="keywordflow">break</span>;
01364 
01365         <span class="keywordflow">default</span>:
01366             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam));
01367         }
01368 
01369     } <span class="keywordflow">else</span> {
01370 
01371 Cleanup:
01372         GlobalDeleteAtom(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>); <span class="comment">// pxi copy</span>
01373         <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a>) {
01374             <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);  <span class="comment">// free message data</span>
01375         }
01376         <a class="code" href="../../d0/d1/xact_8c.html#a11">UnlinkTransaction</a>(pxi);
01377         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pxi);
01378     }
01379     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
01380         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
01381     }
01382     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01383 }
01384 
01385 <span class="comment">//----------------------SPONTANEOUS CLIENT MESSAGE---------------------//</span>
01386 
01387 <span class="comment">/***************************************************************************\</span>
01388 <span class="comment">* SpontaneousClientMessage</span>
01389 <span class="comment">*</span>
01390 <span class="comment">* Description:</span>
01391 <span class="comment">* General unexpected message client side handler.</span>
01392 <span class="comment">*</span>
01393 <span class="comment">* History:</span>
01394 <span class="comment">* 11-19-91 sanfords Created.</span>
01395 <span class="comment">\***************************************************************************/</span>
<a name="l01396"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a20">01396</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>(
01397 <a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a> pci,
01398 UINT msg,
01399 LPARAM lParam)
01400 {
01401     <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
01402     <span class="keywordflow">case</span> WM_DDE_DATA:
01403         <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a4">ClSpontAdviseData</a>(pci, lParam));
01404         <span class="keywordflow">break</span>;
01405 
01406     <span class="keywordflow">default</span>:
01407         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(!(pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_INTRA_PROCESS), <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
01408         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a113">ShutdownConversation</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)pci, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01409         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01410     }
01411 }
01412 
01413 <span class="comment">//----------------------SPONTANEOUS SERVER MESSAGE---------------------//</span>
01414 
01415 <span class="comment">/***************************************************************************\</span>
01416 <span class="comment">* SpontaneousServerMessage</span>
01417 <span class="comment">*</span>
01418 <span class="comment">* Description:</span>
01419 <span class="comment">* General unexpected message server side handler.</span>
01420 <span class="comment">*</span>
01421 <span class="comment">* History:</span>
01422 <span class="comment">* 11-19-91 sanfords Created.</span>
01423 <span class="comment">\***************************************************************************/</span>
<a name="l01424"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a21">01424</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a21">SpontaneousServerMessage</a>(
01425 <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi,
01426 UINT msg,
01427 LPARAM lParam)
01428 {
01429     <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
01430     <span class="keywordflow">case</span> WM_DDE_ADVISE:
01431         <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a1">SvSpontAdvise</a>(psi, lParam));
01432         <span class="keywordflow">break</span>;
01433 
01434     <span class="keywordflow">case</span> WM_DDE_UNADVISE:
01435         <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a8">SvSpontUnadvise</a>(psi, lParam));
01436         <span class="keywordflow">break</span>;
01437 
01438     <span class="keywordflow">case</span> WM_DDE_EXECUTE:
01439         <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a12">SvSpontExecute</a>(psi, lParam));
01440         <span class="keywordflow">break</span>;
01441 
01442     <span class="keywordflow">case</span> WM_DDE_POKE:
01443         <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a15">SvSpontPoke</a>(psi, lParam));
01444         <span class="keywordflow">break</span>;
01445 
01446     <span class="keywordflow">case</span> WM_DDE_REQUEST:
01447         <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/stdptcl_8c.html#a18">SvSpontRequest</a>(psi, lParam));
01448         <span class="keywordflow">break</span>;
01449 
01450     <span class="keywordflow">default</span>:
01451         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(!(psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_INTRA_PROCESS), <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
01452 
01453         <span class="comment">/*</span>
01454 <span class="comment">         * It use to call ShutdownConversation here. Don't call it</span>
01455 <span class="comment">         * anymore. Fix for bugs: 49063, 70906</span>
01456 <span class="comment">         */</span>
01457         <span class="comment">//ShutdownConversation((PCONV_INFO)psi, TRUE);</span>
01458         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01459     }
01460 }
01461 
01462 
01463 
01464 <span class="comment">//-------------------------HELPER FUNCTIONS----------------------------//</span>
01465 
01466 
01467 
01468 <span class="comment">/***************************************************************************\</span>
01469 <span class="comment">* AllocAndSetDDEData</span>
01470 <span class="comment">*</span>
01471 <span class="comment">* Description:</span>
01472 <span class="comment">* Worker function to create a data handle of size cb with wStatus and</span>
01473 <span class="comment">* wFmt initialized. If cb == -1 pSrc is assumed to be a valid hDDE</span>
01474 <span class="comment">* that is to have its data set.</span>
01475 <span class="comment">*</span>
01476 <span class="comment">* History:</span>
01477 <span class="comment">* 11-19-91 sanfords Created.</span>
01478 <span class="comment">\***************************************************************************/</span>
<a name="l01479"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a22">01479</a> HANDLE <a class="code" href="../../d2/d6/stdptcl_8c.html#a22">AllocAndSetDDEData</a>(
01480 LPBYTE pSrc,
01481 DWORD cb,
01482 WORD wStatus,
01483 WORD wFmt) <span class="comment">// a 0 format implied execute data</span>
01484 {
01485     HANDLE hDDE;
01486     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbOff;
01487     <a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a> pdde;
01488     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fCopyIt;
01489 
01490     <span class="keywordflow">if</span> (cb == -1) {
01491         hDDE = (HANDLE)pSrc;
01492         cb = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)GlobalSize(hDDE);
01493         fCopyIt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01494     } <span class="keywordflow">else</span> {
01495         hDDE = <a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(GMEM_DDESHARE | GMEM_MOVEABLE | GMEM_ZEROINIT,
01496                 (wFmt ? (cb + 4) : cb));
01497         fCopyIt = (pSrc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01498     }
01499     <span class="keywordflow">if</span> (hDDE == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01500         <span class="keywordflow">return</span>(0);
01501     }
01502     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDE, pdde);
01503     <span class="keywordflow">if</span> (pdde == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01504         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(hDDE);
01505         <span class="keywordflow">return</span> (0);
01506     }
01507     <span class="keywordflow">if</span> (wFmt) {
01508         pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o0">wStatus</a> = wStatus;
01509         pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o1">wFmt</a> = wFmt;
01510         cbOff = 4;
01511     } <span class="keywordflow">else</span> {
01512         cbOff = 0;
01513     }
01514     <span class="keywordflow">if</span> (fCopyIt) {
01515         RtlCopyMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdde + cbOff, pSrc, cb);
01516     }
01517     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
01518 
01519     <span class="keywordflow">return</span> (hDDE);
01520 }
01521 
01522 
01523 
01524 <span class="comment">/***************************************************************************\</span>
01525 <span class="comment">* PackAndPostMessage</span>
01526 <span class="comment">*</span>
01527 <span class="comment">* Description:</span>
01528 <span class="comment">* Worker function to provide common functionality. An error code is</span>
01529 <span class="comment">* return ed on failure. 0 on success.</span>
01530 <span class="comment">*</span>
01531 <span class="comment">* History:</span>
01532 <span class="comment">* 11-19-91 sanfords Created.</span>
01533 <span class="comment">\***************************************************************************/</span>
<a name="l01534"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a23">01534</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a23">PackAndPostMessage</a>(
01535 HWND hwndTo,
01536 UINT msgIn,
01537 UINT msgOut,
01538 HWND hwndFrom,
01539 LPARAM lParam,
01540 UINT_PTR uiLo,
01541 UINT_PTR uiHi)
01542 {
01543     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> retval;
01544 
01545     lParam = <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a10">ReuseDDElParam</a>(lParam, msgIn, msgOut, uiLo, uiHi);
01546     <span class="keywordflow">if</span> (!lParam) {
01547         <span class="keywordflow">return</span> (DMLERR_MEMORY_ERROR);
01548     }
01549     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
01550     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
01551     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a9">CheckDDECritOut</a>;
01552 
01553     retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwndTo, msgOut, (WPARAM)hwndFrom, lParam);
01554     <span class="keywordflow">switch</span> (retval) {
01555     <span class="keywordflow">case</span> <a class="code" href="../../d6/d4/ddetrack_8h.html#a17">FAIL_POST</a>:
01556 <span class="preprocessor">#if (FAIL_POST != FALSE)</span>
01557 <span class="preprocessor"></span><span class="preprocessor">#error FAIL_POST must be defined as PostMessage's failure return value.</span>
01558 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01559 <span class="preprocessor"></span>        <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(msgOut, lParam);
01560         RIPMSG0(RIP_WARNING, <span class="stringliteral">"PostMessage failed."</span>);
01561         <span class="comment">/* Fall through */</span>
01562 
01563     <span class="keywordflow">case</span> <a class="code" href="../../d6/d4/ddetrack_8h.html#a20">FAILNOFREE_POST</a>:
01564         retval = DMLERR_POSTMSG_FAILED;
01565         <span class="keywordflow">break</span>;
01566 
01567     <span class="keywordflow">default</span>:
01568 <span class="preprocessor">#if (FAKE_POST != TRUE)</span>
01569 <span class="preprocessor"></span><span class="preprocessor">#error FAKE_POST must be defined as PostMessage's success return value.</span>
01570 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01571 <span class="preprocessor"></span>        UserAssert(retval == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01572         retval = 0;
01573     }
01574 
01575     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
01576     <span class="keywordflow">return</span> (retval);
01577 }
01578 
01579 
01580 
01581 <span class="comment">/***************************************************************************\</span>
01582 <span class="comment">* ExtractDDEDataInfo</span>
01583 <span class="comment">*</span>
01584 <span class="comment">* Description:</span>
01585 <span class="comment">* Worker function to retrieve wStatus and wFmt from a standard DDE data</span>
01586 <span class="comment">* handle - NOT FOR EXECUTE HANDLES.</span>
01587 <span class="comment">*</span>
01588 <span class="comment">* History:</span>
01589 <span class="comment">* 11-19-91 sanfords Created.</span>
01590 <span class="comment">\***************************************************************************/</span>
<a name="l01591"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a24">01591</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a24">ExtractDDEDataInfo</a>(
01592 HANDLE hDDE,
01593 LPWORD pwStatus,
01594 LPWORD pwFmt)
01595 {
01596     <a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a> pdde;
01597 
01598     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDE, pdde);
01599     <span class="keywordflow">if</span> (pdde == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01600         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01601     }
01602     *pwStatus = pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o0">wStatus</a>;
01603     *pwFmt = pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o1">wFmt</a>;
01604     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
01605     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01606 }
01607 
01608 
01609 
01610 <span class="comment">/***************************************************************************\</span>
01611 <span class="comment">* TransactionComplete</span>
01612 <span class="comment">*</span>
01613 <span class="comment">* Description:</span>
01614 <span class="comment">* Called when a response function completes a transaction. pxi-&gt;wStatus,</span>
01615 <span class="comment">* pxi-&gt;flags, pxi-&gt;wFmt, pxi-&gt;gaItem, pxi-&gt;hXact, and hData are expected</span>
01616 <span class="comment">* to be set apropriately for a XTYP_XACT_COMPLETE callback.</span>
01617 <span class="comment">*</span>
01618 <span class="comment">* fCleanup is returned - TRUE implies the calling function needs to</span>
01619 <span class="comment">* cleanup its pxi before returning.  (fAsync case.)</span>
01620 <span class="comment">*</span>
01621 <span class="comment">* History:</span>
01622 <span class="comment">* 11-19-91 sanfords Created.</span>
01623 <span class="comment">\***************************************************************************/</span>
<a name="l01624"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a25">01624</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/stdptcl_8c.html#a25">TransactionComplete</a>(
01625 <a class="code" href="../../d0/d0/structtagXACT__INFO.html">PXACT_INFO</a> pxi,
01626 HDDEDATA hData)
01627 {
01628     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> al;
01629     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fMustFree;
01630 
01631     <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o9">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a45">XIF_ABANDONED</a>) {
01632         UserAssert(!(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o9">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a43">XIF_SYNCHRONOUS</a>));
01633         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01634     }
01635     pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o9">flags</a> |= <a class="code" href="../../d0/d4/ddemlcli_8h.html#a44">XIF_COMPLETE</a>;
01636     <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o9">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a43">XIF_SYNCHRONOUS</a>) {
01637         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, WM_TIMER, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a46">TID_TIMEOUT</a>, 0);
01638         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01639     } <span class="keywordflow">else</span> {
01640         <span class="keywordflow">if</span> (hData == (HDDEDATA)(-1)) {
01641             fMustFree = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01642             hData = <a class="code" href="../../d0/d9/hdata_8c.html#a2">InternalCreateDataHandle</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>,
01643                 (LPBYTE)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a>, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1, 0,
01644                 HDATA_NOAPPFREE | HDATA_READONLY, 0, 0);
01645         } <span class="keywordflow">else</span> {
01646             fMustFree = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01647         }
01648         al = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o5">gaItem</a>);
01649 
01650         <span class="keywordflow">if</span> (!(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> &amp; DDE_FACK)) {
01651             <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a> &amp; DDE_FBUSY) {
01652                 <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_BUSY);
01653             } <span class="keywordflow">else</span> {
01654                 <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>, DMLERR_NOTPROCESSED);
01655             }
01656         }
01657 
01658         <span class="comment">/*</span>
01659 <span class="comment">         * During the callback the app may disconnect or otherwise kill</span>
01660 <span class="comment">         * this conversation so we unlink the pxi FIRST so cleanup code</span>
01661 <span class="comment">         * doesn't destroy it before this transaction code exits.</span>
01662 <span class="comment">         */</span>
01663         <a class="code" href="../../d0/d1/xact_8c.html#a11">UnlinkTransaction</a>(pxi);
01664 
01665         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(
01666             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>,
01667             (WORD)XTYP_XACT_COMPLETE,
01668             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o6">wFmt</a>,
01669             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o3">hConv</a>,
01670             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o1">pcoi</a>-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o5">laTopic</a>),
01671             (HSZ)al,
01672             hData,
01673             HandleToUlong(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>),
01674             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o8">wStatus</a>);
01675         DeleteAtom(al);
01676         <span class="keywordflow">if</span> (fMustFree) {
01677             <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01678             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o12">hDDEResult</a> = 0;
01679         }
01680 
01681         <span class="comment">/*</span>
01682 <span class="comment">         * during the callback is the only time the app has to access the</span>
01683 <span class="comment">         * transaction information.   pxi-&gt;hXact will be invalid once he</span>
01684 <span class="comment">         * returns.</span>
01685 <span class="comment">         */</span>
01686         <span class="keywordflow">if</span> (pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>) {
01687             <a class="code" href="../../d3/d8/handles_8c.html#a7">DestroyHandle</a>(pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>);
01688             pxi-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a> = 0;
01689         }
01690         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01691     }
01692 }
01693 
01694 
01695 
01696 <span class="comment">/***************************************************************************\</span>
01697 <span class="comment">* UnpackAndFreeDDEMLDataHandle</span>
01698 <span class="comment">*</span>
01699 <span class="comment">* Description:</span>
01700 <span class="comment">* Removes DDEML data handle wrapping from a DDE data handle. If the</span>
01701 <span class="comment">* data handle is APPOWNED the wrapping is NOT freed. The hDDE is</span>
01702 <span class="comment">* return ed or 0 on failure. If fExec is FALSE, this call fails on</span>
01703 <span class="comment">* HDATA_EXECUTE type handles.</span>
01704 <span class="comment">*</span>
01705 <span class="comment">* History:</span>
01706 <span class="comment">* 11-19-91 sanfords Created.</span>
01707 <span class="comment">\***************************************************************************/</span>
<a name="l01708"></a><a class="code" href="../../d2/d6/stdptcl_8c.html#a26">01708</a> HANDLE <a class="code" href="../../d2/d6/stdptcl_8c.html#a26">UnpackAndFreeDDEMLDataHandle</a>(
01709 HDDEDATA hData,
01710 BOOL fExec)
01711 {
01712     <a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a> pdd;
01713     HANDLE hDDE;
01714 
01715     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
01716 
01717     <span class="keywordflow">if</span> (hData == 0) {
01718         <span class="keywordflow">return</span> (0);
01719     }
01720     pdd = (<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a>)<a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>((HANDLE)hData, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>,
01721             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>);
01722     <span class="keywordflow">if</span> (pdd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01723         <span class="keywordflow">return</span> (0);
01724     }
01725     <span class="keywordflow">if</span> (!fExec &amp;&amp; pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> &amp; HDATA_EXECUTE) {
01726         <span class="keywordflow">return</span> (0);
01727     }
01728 
01729     hDDE = pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>;
01730     <span class="keywordflow">if</span> (pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> &amp; HDATA_APPOWNED) {
01731         <span class="keywordflow">return</span> (hDDE); <span class="comment">// don't destroy appowned data handles</span>
01732     }
01733     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pdd);
01734     <a class="code" href="../../d3/d8/handles_8c.html#a7">DestroyHandle</a>((HANDLE)hData);
01735     <span class="keywordflow">return</span> (hDDE);
01736 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
