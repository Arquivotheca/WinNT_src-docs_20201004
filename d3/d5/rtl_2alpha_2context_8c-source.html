<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: context.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c</h1><a href="../../d2/d6/rtl_2alpha_2context_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    context.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements user-mode callable context manipulation routines.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 20-Jun-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    David N. Cutler (davec) 18-Apr-1990</span>
00020 <span class="comment"></span>
00021 <span class="comment">        Revise for MIPS environment.</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Thomas Van Baak (tvb) 11-May-1992</span>
00024 <span class="comment"></span>
00025 <span class="comment">        Adapted for Alpha AXP.</span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00030 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00031 <span class="preprocessor">#include &lt;alphaops.h&gt;</span>
00032 
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00034"></a><a class="code" href="../../d2/d6/rtl_2alpha_2context_8c.html#a0">00034</a> <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a1">RtlInitializeContext</a>(
00035     IN HANDLE Process,
00036     OUT PCONTEXT Context,
00037     IN PVOID Parameter OPTIONAL,
00038     IN PVOID InitialPc OPTIONAL,
00039     IN PVOID InitialSp OPTIONAL
00040     )
00041 
00042 <span class="comment">/*++</span>
00043 <span class="comment"></span>
00044 <span class="comment">Routine Description:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    This function initializes a context structure so that it can be used in</span>
00047 <span class="comment">    a subsequent call to NtCreateThread.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Arguments:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    Process - Supplies an open handle to the target process. This argument</span>
00052 <span class="comment">        is ignored by this function.</span>
00053 <span class="comment"></span>
00054 <span class="comment">    Context - Supplies a pointer to a context record that is to be initialized.</span>
00055 <span class="comment"></span>
00056 <span class="comment">    Parameter - Supplies an initial value for register A0.</span>
00057 <span class="comment"></span>
00058 <span class="comment">    InitialPc - Supplies an initial program counter value.</span>
00059 <span class="comment"></span>
00060 <span class="comment">    InitialSp - Supplies an initial stack pointer value.</span>
00061 <span class="comment"></span>
00062 <span class="comment">Return Value:</span>
00063 <span class="comment"></span>
00064 <span class="comment">    Raises STATUS_BAD_INITIAL_STACK if the value of InitialSp is not properly</span>
00065 <span class="comment">           aligned.</span>
00066 <span class="comment"></span>
00067 <span class="comment">    Raises STATUS_BAD_INITIAL_PC if the value of InitialPc is not properly</span>
00068 <span class="comment">           aligned.</span>
00069 <span class="comment"></span>
00070 <span class="comment">--*/</span>
00071 
00072 {
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">// Check for proper initial stack and PC alignment.</span>
00076     <span class="comment">//</span>
00077 
00078     <span class="keywordflow">if</span> (((ULONG_PTR)InitialSp &amp; 0xF) != 0) {
00079         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_STACK);
00080     }
00081     <span class="keywordflow">if</span> (((ULONG_PTR)InitialPc &amp; 0x3) != 0) {
00082         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_PC);
00083     }
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// Initialize the integer registers to contain their register number</span>
00087     <span class="comment">// (they must be initialized and using register numbers instead of 0</span>
00088     <span class="comment">// can be useful for debugging). Integer registers a0, ra, gp, and sp</span>
00089     <span class="comment">// are set later.</span>
00090     <span class="comment">//</span>
00091 
00092     Context-&gt;IntV0 = 0;
00093     Context-&gt;IntT0 = 1;
00094     Context-&gt;IntT1 = 2;
00095     Context-&gt;IntT2 = 3;
00096     Context-&gt;IntT3 = 4;
00097     Context-&gt;IntT4 = 5;
00098     Context-&gt;IntT5 = 6;
00099     Context-&gt;IntT6 = 7;
00100     Context-&gt;IntT7 = 8;
00101     Context-&gt;IntS0 = 9;
00102     Context-&gt;IntS1 = 10;
00103     Context-&gt;IntS2 = 11;
00104     Context-&gt;IntS3 = 12;
00105     Context-&gt;IntS4 = 13;
00106     Context-&gt;IntS5 = 14;
00107     Context-&gt;IntFp = 15;
00108     Context-&gt;IntA1 = 17;
00109     Context-&gt;IntA2 = 18;
00110     Context-&gt;IntA3 = 19;
00111     Context-&gt;IntA4 = 20;
00112     Context-&gt;IntA5 = 21;
00113     Context-&gt;IntT8 = 22;
00114     Context-&gt;IntT9 = 23;
00115     Context-&gt;IntT10 = 24;
00116     Context-&gt;IntT11 = 25;
00117     Context-&gt;IntT12 = 27;
00118     Context-&gt;IntAt = 28;
00119 
00120     <span class="comment">//</span>
00121     <span class="comment">// Initialize the floating point registers to contain the integer value</span>
00122     <span class="comment">// of their register number (they must be initialized and using register</span>
00123     <span class="comment">// numbers instead of 0 can be useful for debugging).</span>
00124     <span class="comment">//</span>
00125 
00126     Context-&gt;FltF0 = 0;
00127     Context-&gt;FltF1 = 1;
00128     Context-&gt;FltF2 = 2;
00129     Context-&gt;FltF3 = 3;
00130     Context-&gt;FltF4 = 4;
00131     Context-&gt;FltF5 = 5;
00132     Context-&gt;FltF6 = 6;
00133     Context-&gt;FltF7 = 7;
00134     Context-&gt;FltF8 = 8;
00135     Context-&gt;FltF9 = 9;
00136     Context-&gt;FltF10 = 10;
00137     Context-&gt;FltF11 = 11;
00138     Context-&gt;FltF12 = 12;
00139     Context-&gt;FltF13 = 13;
00140     Context-&gt;FltF14 = 14;
00141     Context-&gt;FltF15 = 15;
00142     Context-&gt;FltF16 = 16;
00143     Context-&gt;FltF17 = 17;
00144     Context-&gt;FltF18 = 18;
00145     Context-&gt;FltF19 = 19;
00146     Context-&gt;FltF20 = 20;
00147     Context-&gt;FltF21 = 21;
00148     Context-&gt;FltF22 = 22;
00149     Context-&gt;FltF23 = 23;
00150     Context-&gt;FltF24 = 24;
00151     Context-&gt;FltF25 = 25;
00152     Context-&gt;FltF26 = 26;
00153     Context-&gt;FltF27 = 27;
00154     Context-&gt;FltF28 = 28;
00155     Context-&gt;FltF29 = 29;
00156     Context-&gt;FltF30 = 30;
00157     Context-&gt;FltF31 = 0;
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// Initialize the control registers.</span>
00161     <span class="comment">//</span>
00162     <span class="comment">// Gp: will be set in LdrpInitialize at thread startup.</span>
00163     <span class="comment">// Ra: some debuggers compare for 1 as a top-of-stack indication.</span>
00164     <span class="comment">//</span>
00165     <span class="comment">// N.B. On 32-bit systems, ULONG becomes canonical longword with the</span>
00166     <span class="comment">//      (ULONGLONG)(LONG) cast.</span>
00167     <span class="comment">//</span>
00168 
00169     Context-&gt;IntGp = 0;
00170     Context-&gt;IntSp = (ULONGLONG)(LONG_PTR)InitialSp;
00171     Context-&gt;IntRa = 1;
00172     Context-&gt;Fir = (ULONGLONG)(LONG_PTR)InitialPc;
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// Set default Alpha floating point control register values.</span>
00176     <span class="comment">//</span>
00177 
00178     Context-&gt;Fpcr = (ULONGLONG)0;
00179     ((PFPCR)(&amp;Context-&gt;Fpcr))-&gt;DynamicRoundingMode = ROUND_TO_NEAREST;
00180     Context-&gt;SoftFpcr = (ULONGLONG)0;
00181 
00182     Context-&gt;Psr = 0;
00183     Context-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">// Set the initial context of the thread in a machine specific way.</span>
00187     <span class="comment">//</span>
00188 
00189     Context-&gt;IntA0 = (ULONGLONG)(LONG_PTR)Parameter;
00190 }
00191 
00192 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00193"></a><a class="code" href="../../d2/d6/rtl_2alpha_2context_8c.html#a1">00193</a> <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a2">RtlRemoteCall</a>(
00194     HANDLE Process,
00195     HANDLE Thread,
00196     PVOID CallSite,
00197     ULONG ArgumentCount,
00198     PULONG_PTR Arguments,
00199     BOOLEAN PassContext,
00200     BOOLEAN AlreadySuspended
00201     )
00202 
00203 <span class="comment">/*++</span>
00204 <span class="comment"></span>
00205 <span class="comment">Routine Description:</span>
00206 <span class="comment"></span>
00207 <span class="comment">    This function calls a procedure in another thread/process by using</span>
00208 <span class="comment">    NtGetContext and NtSetContext. Parameters are passed to the target</span>
00209 <span class="comment">    procedure via the nonvolatile registers (s0 - s5).</span>
00210 <span class="comment"></span>
00211 <span class="comment">Arguments:</span>
00212 <span class="comment"></span>
00213 <span class="comment">    Process - Supplies an open handle to the target process.</span>
00214 <span class="comment"></span>
00215 <span class="comment">    Thread - Supplies an open handle to the target thread within the target</span>
00216 <span class="comment">        process.</span>
00217 <span class="comment"></span>
00218 <span class="comment">    CallSite - Supplies the address of the procedure to call in the target</span>
00219 <span class="comment">        process.</span>
00220 <span class="comment"></span>
00221 <span class="comment">    ArgumentCount - Supplies the number of parameters to pass to the</span>
00222 <span class="comment">        target procedure.</span>
00223 <span class="comment"></span>
00224 <span class="comment">    Arguments - Supplies a pointer to the array of parameters to pass.</span>
00225 <span class="comment"></span>
00226 <span class="comment">    PassContext - Supplies a boolean value that determines whether a parameter</span>
00227 <span class="comment">        is to be passed that points to a context record. This parameter is</span>
00228 <span class="comment">        ignored on MIPS and Alpha hosts.</span>
00229 <span class="comment"></span>
00230 <span class="comment">    AlreadySuspended - Supplies a boolean value that determines whether the</span>
00231 <span class="comment">        target thread is already in a suspended or waiting state.</span>
00232 <span class="comment"></span>
00233 <span class="comment">Return Value:</span>
00234 <span class="comment"></span>
00235 <span class="comment">    Status - Status value.</span>
00236 <span class="comment"></span>
00237 <span class="comment">--*/</span>
00238 
00239 {
00240 
00241     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00242     CONTEXT Context;
00243     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00244     ULONGLONG NewSp;
00245 
00246     <span class="keywordflow">if</span> ((ArgumentCount &gt; 6) ||
00247         (PassContext &amp;&amp; (ArgumentCount &gt; 5))) {
00248         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00249     }
00250 
00251     <span class="comment">//</span>
00252     <span class="comment">// If necessary, suspend the target thread before getting the thread's</span>
00253     <span class="comment">// current state.</span>
00254     <span class="comment">//</span>
00255 
00256     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00257         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00258         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00259             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00260         }
00261     }
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Get the current state of the target thread.</span>
00265     <span class="comment">//</span>
00266 
00267     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00268     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>(Thread, &amp;Context);
00269     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00270         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00271             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00272         }
00273         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00274     }
00275 
00276     <span class="keywordflow">if</span> (AlreadySuspended) {
00277         Context.IntV0 = STATUS_ALERTED;
00278     }
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">// Pass the parameters to the other thread via the non-volatile registers</span>
00282     <span class="comment">// s0 - s5. The context record is passed on the stack of the target thread.</span>
00283     <span class="comment">//</span>
00284 
00285     NewSp = Context.IntSp - <span class="keyword">sizeof</span>(CONTEXT);
00286     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process, (PVOID)NewSp, &amp;Context,
00287                                   <span class="keyword">sizeof</span>(CONTEXT), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00288     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00289         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00290             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00291         }
00292         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00293     }
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// N.B. On 32-bit system each ULONG argument is converted to canonical</span>
00297     <span class="comment">//      form with the (ULONGLONG)(LONG) cast as required by the calling</span>
00298     <span class="comment">//      standard.</span>
00299     <span class="comment">//</span>
00300 
00301     Context.IntSp = NewSp;
00302 
00303     <span class="keywordflow">if</span> (PassContext) {
00304         Context.IntS0 = NewSp;
00305         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ArgumentCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00306             (&amp;Context.IntS1)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (ULONGLONG)(LONG_PTR)Arguments[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00307         }
00308 
00309     } <span class="keywordflow">else</span> {
00310         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ArgumentCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00311             (&amp;Context.IntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (ULONGLONG)(LONG_PTR)Arguments[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00312         }
00313     }
00314 
00315     <span class="comment">//</span>
00316     <span class="comment">// Set the address of the target code into FIR and set the thread context</span>
00317     <span class="comment">// to cause the target procedure to be executed.</span>
00318     <span class="comment">//</span>
00319     <span class="comment">// N.B. The PVOID CallSite is stored as a canonical longword in order</span>
00320     <span class="comment">//      for Fir to be a valid 64-bit address.</span>
00321     <span class="comment">//</span>
00322 
00323     Context.Fir = (ULONGLONG)(LONG_PTR)CallSite;
00324     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>(Thread, &amp;Context);
00325     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00326         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00327     }
00328     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00329 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
