<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mapview.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mapview.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d4/d4/mapview_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d4/struct__NTSYM.html">_NTSYM</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a0">X256MEG</a>&nbsp;&nbsp;&nbsp;(256*1024*1024)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a1">ROUND_TO_PAGES64</a>(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)&nbsp;&nbsp;&nbsp;(((UINT64)(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>) + PAGE_SIZE - 1) &amp; ~(PAGE_SIZE - 1))</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__NTSYM.html">_NTSYM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a7">NTSYM</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__NTSYM.html">_NTSYM</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a8">PNTSYM</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a9">MiSetPageModified</a> (IN PVOID Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a10">MiMapViewOfImageSection</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID *CapturedBase, IN PLARGE_INTEGER SectionOffset, IN PSIZE_T CapturedViewSize, IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a> Section, IN SECTION_INHERIT InheritDisposition, IN ULONG_PTR ZeroBits, IN SIZE_T ImageCommitment, OUT PBOOLEAN ReleasedWsMutex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a11">MiMapViewOfDataSection</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID *CapturedBase, IN PLARGE_INTEGER SectionOffset, IN PSIZE_T CapturedViewSize, IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a> Section, IN SECTION_INHERIT InheritDisposition, IN ULONG ProtectionMask, IN SIZE_T CommitSize, IN ULONG_PTR ZeroBits, IN ULONG AllocationType, OUT PBOOLEAN ReleasedWsMutex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a12">MiRemoveMappedPtes</a> (IN PVOID BaseAddress, IN ULONG NumberOfPtes, IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WorkingSetInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a13">MiMapViewInSystemSpace</a> (IN PVOID Section, IN <a class="el" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session, OUT PVOID *MappedBase, IN OUT PSIZE_T ViewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (IN <a class="el" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session, IN PVOID MappedBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a15">MiFillSystemPageDirectory</a> (PVOID Base, SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a16">VadTreeWalk</a> (<a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a17">CacheImageSymbols</a> (IN PVOID ImageBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a18">MiInsertInSystemSpace</a> (IN <a class="el" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session, IN ULONG SizeIn64k, IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a19">MiRemoveFromSystemSpace</a> (IN <a class="el" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session, IN PVOID Base, OUT <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> *ControlArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a> (IN HANDLE SectionHandle, IN HANDLE ProcessHandle, IN OUT PVOID *BaseAddress, IN ULONG_PTR ZeroBits, IN SIZE_T CommitSize, IN OUT PLARGE_INTEGER SectionOffset OPTIONAL, IN OUT PSIZE_T ViewSize, IN SECTION_INHERIT InheritDisposition, IN ULONG AllocationType, IN ULONG Protect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> (IN PVOID SectionToMap, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN OUT PVOID *CapturedBase, IN ULONG_PTR ZeroBits, IN SIZE_T CommitSize, IN OUT PLARGE_INTEGER SectionOffset, IN OUT PSIZE_T CapturedViewSize, IN SECTION_INHERIT InheritDisposition, IN ULONG AllocationType, IN ULONG Protect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a22">MiMapViewOfPhysicalSection</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID *CapturedBase, IN PLARGE_INTEGER SectionOffset, IN PSIZE_T CapturedViewSize, IN ULONG ProtectionMask, IN ULONG_PTR ZeroBits, IN ULONG AllocationType, IN BOOLEAN WriteCombined, OUT PBOOLEAN ReleasedWsMutex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a23">MiMapViewOfImageSection</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID *CapturedBase, IN PLARGE_INTEGER SectionOffset, IN PSIZE_T CapturedViewSize, IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a> Section, IN SECTION_INHERIT InheritDisposition, IN ULONG_PTR ZeroBits, IN SIZE_T ImageCommitment, IN OUT PBOOLEAN ReleasedWsMutex)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">_ALPHA_  <a href="#a23"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a24">MiMapViewOfDataSection</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID *CapturedBase, IN PLARGE_INTEGER SectionOffset, IN PSIZE_T CapturedViewSize, IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a> Section, IN SECTION_INHERIT InheritDisposition, IN ULONG ProtectionMask, IN SIZE_T CommitSize, IN ULONG_PTR ZeroBits, IN ULONG AllocationType, IN PBOOLEAN ReleasedWsMutex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a25">MiCheckPurgeAndUpMapCount</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a26">NtAreMappedFilesTheSame</a> (IN PVOID File1MappedAsAnImage, IN PVOID File2MappedAsFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a27">MmMapViewInSystemSpace</a> (IN PVOID Section, OUT PVOID *MappedBase, IN OUT PSIZE_T ViewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a28">MmMapViewInSessionSpace</a> (IN PVOID Section, OUT PVOID *MappedBase, IN OUT PSIZE_T ViewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a29">MmUnmapViewInSystemSpace</a> (IN PVOID MappedBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a30">MmUnmapViewInSessionSpace</a> (IN PVOID MappedBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a31">MiInitializeSystemSpaceMap</a> (PVOID InputSession OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a32">MiFreeSessionSpaceMap</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a33">MmSecureVirtualMemory</a> (IN PVOID Address, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN ULONG ProbeMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a34">MmUnsecureVirtualMemory</a> (IN HANDLE SecureHandle)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a2">MMPPTE_NAME</a> = 'tPmM'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a3">MMDB</a> = 'bDmM'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a4">MMVADKEY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a5">MmLoadedUserImageList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/struct__MMSESSION.html">MMSESSION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/mapview_8c.html#a6">MmSession</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="mapview.c::ROUND_TO_PAGES64" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ROUND_TO_PAGES64          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((UINT64)(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>) + PAGE_SIZE - 1) &amp; ~(PAGE_SIZE - 1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00042">42</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="mapview.c::X256MEG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define X256MEG&nbsp;&nbsp;&nbsp;(256*1024*1024)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00036">36</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a7" doxytag="mapview.c::NTSYM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__NTSYM.html">_NTSYM</a>  <a class="el" href="../../d4/d4/struct__NTSYM.html">NTSYM</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="mapview.c::PNTSYM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__NTSYM.html">_NTSYM</a> * <a class="el" href="../../d4/d4/struct__NTSYM.html">PNTSYM</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a17" doxytag="mapview.c::CacheImageSymbols" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CacheImageSymbols           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l02930">2930</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02933 {
02934     PIMAGE_DEBUG_DIRECTORY DebugDirectory;
02935     ULONG DebugSize;
02936 
02937     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02938 
02939     <span class="keywordflow">try</span> {
02940         DebugDirectory = (PIMAGE_DEBUG_DIRECTORY)
02941         <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( ImageBase,
02942                                       TRUE,
02943                                       IMAGE_DIRECTORY_ENTRY_DEBUG,
02944                                       &amp;DebugSize
02945                                     );
02946         <span class="keywordflow">if</span> (!DebugDirectory) {
02947             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02948         }
02949 
02950         <span class="comment">//</span>
02951         <span class="comment">// If using remote KD, ImageBase is what it wants to see.</span>
02952         <span class="comment">//</span>
02953 
02954     } except (EXCEPTION_EXECUTE_HANDLER) {
02955         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02956     }
02957 
02958     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02959 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="mapview.c::MiCheckPurgeAndUpMapCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCheckPurgeAndUpMapCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ControlArea</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l02809">2809</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02020">_EVENT_COUNTER::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02438">MiFreeEventCounter()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02377">MiGetEventCounter()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02019">_EVENT_COUNTER::RefCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00910">UNLOCK_PFN_AND_THEN_WAIT</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, and <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>.
<p>
<pre class="fragment"><div>02815                    :
02816 
02817     This routine synchronizes with any on going purge operations
02818     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same segment (identified via the control area).  If
02819     another purge operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> occurring, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function blocks until
02820     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> completed.
02821 
02822     When <span class="keyword">this</span> function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MappedView and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NumberOfUserReferences
02823     count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area will be incremented thereby referencing
02824     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area.
02825 
02826 Arguments:
02827 
02828     ControlArea - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment to be purged.
02829 
02830 Return Value:
02831 
02832     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> synchronization was successful.
02833     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> synchronization did not occur due to <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> resources, etc.
02834 
02835 Environment:
02836 
02837     Kernel Mode.
02838 
02839 --*/
02840 
02841 {
02842     KIRQL OldIrql;
02843     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> PurgedEvent;
02844     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> WaitEvent;
02845     ULONG OldRef;
02846 
02847     PurgedEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02848     OldRef = 1;
02849 
02850     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02851 
02852     <span class="keywordflow">while</span> (ControlArea-&gt;u.Flags.BeingPurged != 0) {
02853 
02854         <span class="comment">//</span>
02855         <span class="comment">// A purge operation is in progress.</span>
02856         <span class="comment">//</span>
02857 
02858         <span class="keywordflow">if</span> (PurgedEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02859 
02860             <span class="comment">//</span>
02861             <span class="comment">// Release the locks and allocate pool for the event.</span>
02862             <span class="comment">//</span>
02863 
02864             PurgedEvent = <a class="code" href="../../d4/d8/mi_8h.html#a931">MiGetEventCounter</a> ();
02865             <span class="keywordflow">if</span> (PurgedEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02866                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02867                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02868             }
02869 
02870             <span class="keywordflow">continue</span>;
02871         }
02872 
02873         <span class="keywordflow">if</span> (ControlArea-&gt;WaitingForDeletion == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02874             ControlArea-&gt;WaitingForDeletion = PurgedEvent;
02875             WaitEvent = PurgedEvent;
02876             PurgedEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02877         } <span class="keywordflow">else</span> {
02878             WaitEvent = ControlArea-&gt;WaitingForDeletion;
02879             WaitEvent-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o0">RefCount</a> += 1;
02880         }
02881 
02882         <span class="comment">//</span>
02883         <span class="comment">// Release the pfn lock and wait for the event.</span>
02884         <span class="comment">//</span>
02885 
02886         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02887         <a class="code" href="../../d4/d8/mi_8h.html#a132">UNLOCK_PFN_AND_THEN_WAIT</a>(OldIrql);
02888 
02889         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;WaitEvent-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o1">Event</a>,
02890                               WrVirtualMemory,
02891                               KernelMode,
02892                               FALSE,
02893                               (PLARGE_INTEGER)NULL);
02894         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02895         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02896         <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (WaitEvent, FALSE);
02897     }
02898 
02899     <span class="comment">//</span>
02900     <span class="comment">// Indicate another file is mapped for the segment.</span>
02901     <span class="comment">//</span>
02902 
02903     ControlArea-&gt;NumberOfMappedViews += 1;
02904     ControlArea-&gt;NumberOfUserReferences += 1;
02905     ControlArea-&gt;u.Flags.HadUserReference = 1;
02906     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfSectionReferences != 0);
02907 
02908     <span class="keywordflow">if</span> (PurgedEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02909         <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (PurgedEvent, TRUE);
02910     }
02911     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02912 
02913     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02914 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="mapview.c::MiFillSystemPageDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MiFillSystemPageDirectory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03484">3484</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03973">MiInitializePfnForOtherProcess()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04259">MM_DBG_COMMIT_FILL_SYSTEM_DIRECTORY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00412">MM_ZERO_KERNEL_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04673">MmSystemPageDirectory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04670">MmSystemPagePtes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00453">PDE_PER_PAGE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00060">ValidKernelPde</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>.
<p>
<pre class="fragment"><div>03491                    :
03492 
03493     This routine allocates page tables and fills <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system page directory
03494     entries <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address range.
03495 
03496 Arguments:
03497 
03498     Base - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
03499 
03500     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view spans.
03501 
03502 Return Value:
03503 
03504     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> on success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03505 
03506 Environment:
03507 
03508     Kernel Mode, IRQL of dispatch level.
03509 
03510 --*/
03511 
03512 {
03513     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPde;
03514     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPde;
03515     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstSystemPde;
03516     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03517     PFN_NUMBER PageFrameIndex;
03518     KIRQL OldIrql;
03519     ULONG i;
03520 
03521     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03522 
03523     <span class="comment">//</span>
03524     <span class="comment">// CODE IS ALREADY LOCKED BY CALLER.</span>
03525     <span class="comment">//</span>
03526 
03527     FirstPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Base);
03528     LastPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)(((PCHAR)Base) + NumberOfBytes - 1));
03529 
03530 <span class="preprocessor">#if defined (_WIN64)</span>
03531 <span class="preprocessor"></span>    FirstSystemPde = FirstPde;
03532 <span class="preprocessor">#else</span>
03533 <span class="preprocessor"></span><span class="preprocessor">#if !defined (_X86PAE_)</span>
03534 <span class="preprocessor"></span>    FirstSystemPde = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a>[((ULONG_PTR)FirstPde &amp;
03535                      ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) - 1)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) ];
03536 <span class="preprocessor">#else</span>
03537 <span class="preprocessor"></span>    FirstSystemPde = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a>[((ULONG_PTR)FirstPde &amp;
03538                      (PD_PER_SYSTEM * (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) - 1)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) ];
03539 <span class="preprocessor">#endif</span>
03540 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03541 <span class="preprocessor"></span>
03542     <span class="keywordflow">do</span> {
03543         <span class="keywordflow">if</span> (FirstSystemPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03544 
03545             <span class="comment">//</span>
03546             <span class="comment">// No page table page exists, get a page and map it in.</span>
03547             <span class="comment">//</span>
03548 
03549             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
03550 
03551             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03552 
03553             <span class="keywordflow">if</span> (((<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)FirstSystemPde)-&gt;u.Hard.Valid == 0) {
03554 
03555                 <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, FirstPde)) {
03556 
03557                     <span class="comment">//</span>
03558                     <span class="comment">// PFN_LOCK was dropped, redo this loop as another process</span>
03559                     <span class="comment">// could have made this PDE valid.</span>
03560                     <span class="comment">//</span>
03561 
03562                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03563                     <span class="keywordflow">continue</span>;
03564                 }
03565 
03566                 <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, TRUE);
03567                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_FILL_SYSTEM_DIRECTORY, 1);
03568                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
03569                                     MI_GET_PAGE_COLOR_FROM_PTE (FirstSystemPde));
03570                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
03571                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (FirstSystemPde, TempPte);
03572                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (FirstPde, TempPte);
03573 
03574 <span class="preprocessor">#if defined (_WIN64)</span>
03575 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex,
03576                                  FirstPde,
03577                                  1);
03578 <span class="preprocessor">#else</span>
03579 <span class="preprocessor"></span>
03580 <span class="preprocessor">#if !defined (_X86PAE_)</span>
03581 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
03582                                                 FirstPde,
03583                                                 MmSystemPageDirectory);
03584 <span class="preprocessor">#else</span>
03585 <span class="preprocessor"></span>                i = (FirstPde - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(0)) / <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>;
03586                 <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
03587                                                 FirstPde,
03588                                                 MmSystemPageDirectory[i]);
03589 <span class="preprocessor">#endif</span>
03590 <span class="preprocessor"></span>
03591 <span class="preprocessor">#endif</span>
03592 <span class="preprocessor"></span>
03593                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (MiGetVirtualAddressMappedByPte (FirstPde),
03594                                  PAGE_SIZE,
03595                                  MM_ZERO_KERNEL_PTE);
03596             }
03597             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03598         }
03599 
03600         FirstSystemPde += 1;
03601         FirstPde += 1;
03602     } <span class="keywordflow">while</span> (FirstPde &lt;= LastPde  );
03603 
03604     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03605 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="mapview.c::MiFreeSessionSpaceMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFreeSessionSpaceMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l04071">4071</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02608">_MMVIEW::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02607">_MMVIEW::Entry</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02644">LOCK_SYSTEM_VIEW_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02505">MiRemoveBitMap</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05575">_MM_SESSION_SPACE::Session</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02638">_MMSESSION::SystemSpaceBitMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02636">_MMSESSION::SystemSpaceHashEntries</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02635">_MMSESSION::SystemSpaceHashSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02634">_MMSESSION::SystemSpaceViewTable</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02647">UNLOCK_SYSTEM_VIEW_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, and <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>.
<p>
<pre class="fragment"><div>04077                    :
04078 
04079     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tables used <span class="keywordflow">for</span> mapping session views.
04080 
04081 Arguments:
04082 
04083     None.
04084 
04085 Return Value:
04086 
04087     None.
04088 
04089 Environment:
04090 
04091     Kernel Mode.  The caller must be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct session context.
04092 
04093 --*/
04094 
04095 {
04096     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
04097 
04098     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04099 
04100     Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
04101 
04102     <span class="comment">//</span>
04103     <span class="comment">// Check for leaks of objects in the view table.</span>
04104     <span class="comment">//</span>
04105 
04106     <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
04107 
04108     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> &amp;&amp; Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o5">SystemSpaceHashEntries</a>) {
04109 
04110         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SESSION_HAS_VALID_VIEWS_ON_EXIT,
04111                       (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
04112                       Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o5">SystemSpaceHashEntries</a>,
04113                       (ULONG_PTR)&amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>[0],
04114                       Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a>);
04115 
04116 <span class="preprocessor">#if 0</span>
04117 <span class="preprocessor"></span>        ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
04118 
04119         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
04120 
04121             <a class="code" href="../../d5/d7/struct__MMVIEW.html">PMMVIEW</a> Table;
04122             PVOID Base;
04123 
04124             Table = &amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
04125 
04126             <span class="keywordflow">if</span> (Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a>) {
04127 
04128 <span class="preprocessor">#if DBG</span>
04129 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiFreeSessionSpaceMap: view entry %d leak: ControlArea %p, Addr %p, Size %d\n"</span>,
04130                     Index,
04131                     Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o1">ControlArea</a>,
04132                     Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> &amp; ~0xFFFF,
04133                     Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> &amp; 0x0000FFFF
04134                 );
04135 <span class="preprocessor">#endif</span>
04136 <span class="preprocessor"></span>
04137                 Base = (PVOID)(Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> &amp; ~0xFFFF);
04138 
04139                 <span class="comment">//</span>
04140                 <span class="comment">// MiUnmapViewInSystemSpace locks the ViewLock.</span>
04141                 <span class="comment">//</span>
04142 
04143                 <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a>(Session);
04144 
04145                 <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (Session, Base);
04146 
04147                 <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
04148 
04149                 <span class="comment">//</span>
04150                 <span class="comment">// The view table may have been deleted while we let go of</span>
04151                 <span class="comment">// the lock.</span>
04152                 <span class="comment">//</span>
04153 
04154                 <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04155                     <span class="keywordflow">break</span>;
04156                 }
04157             }
04158         }
04159 <span class="preprocessor">#endif</span>
04160 <span class="preprocessor"></span>
04161     }
04162 
04163     <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
04164 
04165     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>) {
04166         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>);
04167         Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04168     }
04169 
04170     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>) {
04171         <a class="code" href="../../d4/d8/mi_8h.html#a234">MiRemoveBitMap</a> (&amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>);
04172     }
04173 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="mapview.c::MiInitializeSystemSpaceMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MiInitializeSystemSpaceMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID InputSession&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>OPTIONAL</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03967">3967</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05223">MI_SESSION_VIEW_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05276">MI_SESSION_VIEW_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02496">MiCreateBitMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02505">MiRemoveBitMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04744">MiSystemViewStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05372">MM_SESSION_FAILURE_NO_NONPAGED_POOL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05374">MM_SESSION_FAILURE_NO_SESSION_PAGED_POOL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00154">MM_SYSTEM_VIEW_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00158">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00266">RtlClearAllBits()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02638">_MMSESSION::SystemSpaceBitMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02636">_MMSESSION::SystemSpaceHashEntries</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02637">_MMSESSION::SystemSpaceHashKey</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02635">_MMSESSION::SystemSpaceHashSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02624">_MMSESSION::SystemSpaceViewLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02632">_MMSESSION::SystemSpaceViewLockPointer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02633">_MMSESSION::SystemSpaceViewStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02634">_MMSESSION::SystemSpaceViewTable</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
<pre class="fragment"><div>03973                    :
03974 
03975     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tables <span class="keywordflow">for</span> mapping views into system space.
03976     Views are kept in a multiple of 64k bytes in a growable hashed table.
03977 
03978 Arguments:
03979 
03980     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial system session (non-Hydra), a valid session
03981     pointer (the pointer must be in global space, not session space) <span class="keywordflow">for</span>
03982     Hydra session initialization.
03983 
03984 Return Value:
03985 
03986     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> on success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03987 
03988 Environment:
03989 
03990     Kernel Mode, initialization.
03991 
03992 --*/
03993 
03994 {
03995     ULONG AllocSize;
03996     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03997     PCHAR ViewStart;
03998     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
03999 
04000     <span class="keywordflow">if</span> (ARGUMENT_PRESENT (InputSession)) {
04001         Session = (<a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>)InputSession;
04002         ViewStart = (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a349">MI_SESSION_VIEW_START</a>;
04003         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d4/d8/mi_8h.html#a336">MI_SESSION_VIEW_SIZE</a>;
04004     }
04005     <span class="keywordflow">else</span> {
04006         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
04007         ViewStart = (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a>;
04008         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04009             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a20">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a>;
04010         }
04011         <span class="keywordflow">else</span> {
04012             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a18">MM_SYSTEM_VIEW_SIZE</a>;
04013         }
04014     }
04015 
04016     <span class="comment">//</span>
04017     <span class="comment">// We are passed a system global address for the address of the session.</span>
04018     <span class="comment">// Save a global pointer to the mutex below because multiple sessions will</span>
04019     <span class="comment">// generally give us a session-space (not a global space) pointer to the</span>
04020     <span class="comment">// MMSESSION in subsequent calls.  We need the global pointer for the mutex</span>
04021     <span class="comment">// field for the kernel primitives to work properly.</span>
04022     <span class="comment">//</span>
04023 
04024     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o1">SystemSpaceViewLockPointer</a> = &amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o0">SystemSpaceViewLock</a>;
04025     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o1">SystemSpaceViewLockPointer</a>);
04026 
04027     <span class="comment">//</span>
04028     <span class="comment">// If the kernel image has not been biased to allow for 3gb of user space,</span>
04029     <span class="comment">// then the system space view starts at the defined place. Otherwise, it</span>
04030     <span class="comment">// starts 16mb above the kernel image.</span>
04031     <span class="comment">//</span>
04032 
04033     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o2">SystemSpaceViewStart</a> = ViewStart;
04034 
04035     <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>, Size / X64K, NonPagedPool);
04036     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04037         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_NONPAGED_POOL);
04038         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04039     }
04040 
04041     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>);
04042 
04043     <span class="comment">//</span>
04044     <span class="comment">// Build the view table.</span>
04045     <span class="comment">//</span>
04046 
04047     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a> = 31;
04048     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o6">SystemSpaceHashKey</a> = Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a> - 1;
04049     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o5">SystemSpaceHashEntries</a> = 0;
04050 
04051     AllocSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__MMVIEW.html">MMVIEW</a>) * Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a>;
04052     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocSize &lt; PAGE_SIZE);
04053 
04054     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
04055                                                            AllocSize,
04056                                                            '  mM');
04057 
04058     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04059         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_SESSION_PAGED_POOL);
04060         <a class="code" href="../../d4/d8/mi_8h.html#a234">MiRemoveBitMap</a> (&amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>);
04061         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04062     }
04063 
04064     RtlZeroMemory (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>, AllocSize);
04065 
04066     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04067 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="mapview.c::MiInsertInSystemSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiInsertInSystemSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Session</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeIn64k</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03757">3757</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02607">_MMVIEW::Entry</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02644">LOCK_SYSTEM_VIEW_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00360">MI_64K_ALIGN</a>, <a class="el" href="../../d4/d8/mi_8h.html#a517">MMVIEW</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d4/d8/mi_8h.html#a518">PMMVIEW</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01382">RtlFindClearBitsAndSet()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02647">UNLOCK_SYSTEM_VIEW_SPACE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>.
<p>
<pre class="fragment"><div>03765                    :
03766 
03767     This routine creates a view in system space <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
03768     area (file mapping).
03769 
03770 Arguments:
03771 
03772     SizeIn64k - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to be created.
03773 
03774     ControlArea - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">for</span> <span class="keyword">this</span> view.
03775 
03776 Return Value:
03777 
03778     Base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view was mapped, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view could not be
03779     mapped.
03780 
03781 Environment:
03782 
03783     Kernel Mode.
03784 
03785 --*/
03786 
03787 {
03788 
03789     PVOID Base;
03790     ULONG_PTR Entry;
03791     ULONG Hash;
03792     ULONG i;
03793     ULONG AllocSize;
03794     <a class="code" href="../../d5/d7/struct__MMVIEW.html">PMMVIEW</a> OldTable;
03795     ULONG StartBit;
03796     ULONG NewHashSize;
03797 
03798     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03799 
03800     <span class="comment">//</span>
03801     <span class="comment">// CODE IS ALREADY LOCKED BY CALLER.</span>
03802     <span class="comment">//</span>
03803 
03804     <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
03805 
03806     <span class="keywordflow">if</span> (Session-&gt;SystemSpaceHashEntries + 8 &gt; Session-&gt;SystemSpaceHashSize) {
03807 
03808         <span class="comment">//</span>
03809         <span class="comment">// Less than 8 free slots, reallocate and rehash.</span>
03810         <span class="comment">//</span>
03811 
03812         NewHashSize = Session-&gt;SystemSpaceHashSize &lt;&lt; 1;
03813 
03814         AllocSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__MMVIEW.html">MMVIEW</a>) * NewHashSize;
03815         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocSize &lt; PAGE_SIZE);
03816 
03817         OldTable = Session-&gt;SystemSpaceViewTable;
03818 
03819         Session-&gt;SystemSpaceViewTable = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
03820                                                                AllocSize,
03821                                                                '  mM');
03822 
03823         <span class="keywordflow">if</span> (Session-&gt;SystemSpaceViewTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03824             Session-&gt;SystemSpaceViewTable = OldTable;
03825         }
03826         <span class="keywordflow">else</span> {
03827             RtlZeroMemory (Session-&gt;SystemSpaceViewTable, AllocSize);
03828 
03829             Session-&gt;SystemSpaceHashSize = NewHashSize;
03830             Session-&gt;SystemSpaceHashKey = Session-&gt;SystemSpaceHashSize - 1;
03831 
03832             <span class="keywordflow">for</span> (i = 0; i &lt; (Session-&gt;SystemSpaceHashSize / 2); i += 1) {
03833                 <span class="keywordflow">if</span> (OldTable[i].<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> != 0) {
03834                     Hash = (ULONG) ((OldTable[i].<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> &gt;&gt; 16) % Session-&gt;SystemSpaceHashKey);
03835 
03836                     <span class="keywordflow">while</span> (Session-&gt;SystemSpaceViewTable[Hash].Entry != 0) {
03837                         Hash += 1;
03838                         <span class="keywordflow">if</span> (Hash &gt;= Session-&gt;SystemSpaceHashSize) {
03839                             Hash = 0;
03840                         }
03841                     }
03842                     Session-&gt;SystemSpaceViewTable[Hash] = OldTable[i];
03843                 }
03844             }
03845             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldTable);
03846         }
03847     }
03848 
03849     <span class="keywordflow">if</span> (Session-&gt;SystemSpaceHashEntries == Session-&gt;SystemSpaceHashSize) {
03850 
03851         <span class="comment">//</span>
03852         <span class="comment">// There are no free hash slots to place a new entry into even</span>
03853         <span class="comment">// though there may still be unused virtual address space.</span>
03854         <span class="comment">//</span>
03855 
03856         <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03857         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03858     }
03859 
03860     StartBit = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (Session-&gt;SystemSpaceBitMap,
03861                                        SizeIn64k,
03862                                        0);
03863 
03864     <span class="keywordflow">if</span> (StartBit == 0xFFFFFFFF) {
03865         <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03866         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03867     }
03868 
03869     Base = (PVOID)((PCHAR)Session-&gt;SystemSpaceViewStart + (StartBit * <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>));
03870 
03871     Entry = (ULONG_PTR) <a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(Base) + SizeIn64k;
03872 
03873     Hash = (ULONG) ((Entry &gt;&gt; 16) % Session-&gt;SystemSpaceHashKey);
03874 
03875     <span class="keywordflow">while</span> (Session-&gt;SystemSpaceViewTable[Hash].Entry != 0) {
03876         Hash += 1;
03877         <span class="keywordflow">if</span> (Hash &gt;= Session-&gt;SystemSpaceHashSize) {
03878             Hash = 0;
03879         }
03880     }
03881 
03882     Session-&gt;SystemSpaceHashEntries += 1;
03883 
03884     Session-&gt;SystemSpaceViewTable[Hash].Entry = Entry;
03885     Session-&gt;SystemSpaceViewTable[Hash].ControlArea = ControlArea;
03886 
03887     <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03888     <span class="keywordflow">return</span> Base;
03889 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="mapview.c::MiMapViewInSystemSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiMapViewInSystemSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Session</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>MappedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">3268</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02644">LOCK_SYSTEM_VIEW_SPACE</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00287">MiAddMappedPtes()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02809">MiCheckPurgeAndUpMapCount()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03484">MiFillSystemPageDirectory()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03757">MiInsertInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03893">MiRemoveFromSystemSpace()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a972">MiSessionCommitPageTables()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02065">_CONTROL_AREA::NumberOfUserReferences</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02647">UNLOCK_SYSTEM_VIEW_SPACE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l03211">MmMapViewInSessionSpace()</a>, and <a class="el" href="../../d4/d4/mapview_8c-source.html#l03164">MmMapViewInSystemSpace()</a>.
<p>
<pre class="fragment"><div>03277                    :
03278 
03279     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space.
03280 
03281 Arguments:
03282 
03283     Section - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section to map.
03284 
03285     Session - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session data structure <span class="keywordflow">for</span> <span class="keyword">this</span> view.
03286 
03287     *MappedBase - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section was mapped.
03288 
03289     ViewSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to map.  If <span class="keyword">this</span>
03290                <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> whole section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped.
03291                Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size mapped.
03292 
03293     Protect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.  Must be
03294               either PAGE_READWRITE or PAGE_READONLY.
03295 
03296 Return Value:
03297 
03298     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03299 
03300 Environment:
03301 
03302     Kernel Mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
03303 
03304 --*/
03305 
03306 {
03307     PVOID Base;
03308     KIRQL OldIrql;
03309     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
03310     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
03311     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> NewControlArea;
03312     ULONG StartBit;
03313     ULONG SizeIn64k;
03314     ULONG NewSizeIn64k;
03315     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
03316     ULONG NumberOfPtes;
03317     ULONG NumberOfBytes;
03318     BOOLEAN status;
03319     KIRQL WsIrql;
03320 
03321     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03322 
03323     <span class="comment">//</span>
03324     <span class="comment">// Check to see if a purge operation is in progress and if so, wait</span>
03325     <span class="comment">// for the purge to complete.  In addition, up the count of mapped</span>
03326     <span class="comment">// views for this control area.</span>
03327     <span class="comment">//</span>
03328 
03329     ControlArea = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
03330 
03331     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
03332         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
03333     }
03334     <span class="keywordflow">else</span> {
03335         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
03336     }
03337 
03338     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
03339 
03340     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (ControlArea) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03341         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03342         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03343     }
03344 
03345     <span class="keywordflow">if</span> (*ViewSize == 0) {
03346 
03347         *ViewSize = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;SizeOfSection.LowPart;
03348 
03349     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ViewSize &gt; ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;SizeOfSection.LowPart) {
03350 
03351         <span class="comment">//</span>
03352         <span class="comment">// Section offset or view size past size of section.</span>
03353         <span class="comment">//</span>
03354 
03355         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03356         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
03357         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
03358 
03359         <span class="comment">//</span>
03360         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
03361         <span class="comment">// This routine releases the PFN lock.</span>
03362         <span class="comment">//</span>
03363     
03364         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
03365 
03366         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03367         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
03368     }
03369 
03370     <span class="comment">//</span>
03371     <span class="comment">// Calculate the first prototype PTE field in the Vad.</span>
03372     <span class="comment">//</span>
03373 
03374     SizeIn64k = (ULONG)((*ViewSize / <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>) + ((*ViewSize &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0));
03375 
03376     Base = <a class="code" href="../../d3/d5/mapview_8c.html#a18">MiInsertInSystemSpace</a> (Session, SizeIn64k, ControlArea);
03377 
03378     <span class="keywordflow">if</span> (Base == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03379         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03380         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
03381         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
03382 
03383         <span class="comment">//</span>
03384         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
03385         <span class="comment">// This routine releases the PFN lock.</span>
03386         <span class="comment">//</span>
03387     
03388         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
03389 
03390         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03391         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03392     }
03393 
03394     NumberOfBytes = SizeIn64k * <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
03395 
03396     <span class="keywordflow">if</span> (Session == &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03397         status = <a class="code" href="../../d3/d5/mapview_8c.html#a15">MiFillSystemPageDirectory</a> (Base, NumberOfBytes);
03398     }
03399     <span class="keywordflow">else</span> {
03400         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (WsIrql);
03401         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(MiSessionCommitPageTables (Base,
03402                 (PVOID)((ULONG_PTR)Base + NumberOfBytes - 1)))) {
03403                     status = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03404         }
03405         <span class="keywordflow">else</span> {
03406                     status = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03407         }
03408     }
03409 
03410     <span class="keywordflow">if</span> (status == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03411         <span class="keywordflow">if</span> (Session != &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03412             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (WsIrql);
03413         }
03414 
03415         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03416         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
03417         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
03418 
03419         <span class="comment">//</span>
03420         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
03421         <span class="comment">// This routine releases the PFN lock.</span>
03422         <span class="comment">//</span>
03423     
03424         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
03425 
03426         StartBit = (ULONG) (((ULONG_PTR)Base - (ULONG_PTR)Session-&gt;SystemSpaceViewStart) &gt;&gt; 16);
03427 
03428         <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
03429 
03430         NewSizeIn64k = <a class="code" href="../../d3/d5/mapview_8c.html#a19">MiRemoveFromSystemSpace</a> (Session, Base, &amp;NewControlArea);
03431 
03432         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea == NewControlArea);
03433         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SizeIn64k == NewSizeIn64k);
03434 
03435         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (Session-&gt;SystemSpaceBitMap, StartBit, SizeIn64k);
03436 
03437         <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03438 
03439         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03440         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03441     }
03442 
03443     <span class="comment">//</span>
03444     <span class="comment">// Setup PTEs to point to prototype PTEs.</span>
03445     <span class="comment">//</span>
03446 
03447     <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;u.Flags.Image) {
03448 
03449 <span class="preprocessor">#if DBG</span>
03450 <span class="preprocessor"></span>        <span class="comment">//</span>
03451         <span class="comment">// The only reason this ASSERT isn't done for Hydra is because</span>
03452         <span class="comment">// the session space working set lock is currently held so faults</span>
03453         <span class="comment">// are not allowed.</span>
03454         <span class="comment">//</span>
03455 
03456         <span class="keywordflow">if</span> (Session == &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03457             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((PSECTION)Section)-&gt;Segment-&gt;ControlArea == ControlArea);
03458         }
03459 <span class="preprocessor">#endif</span>
03460 <span class="preprocessor"></span>
03461         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03462         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.ImageMappedInSystemSpace = 1;
03463         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03464     }
03465 
03466     BasePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Base);
03467     NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (*ViewSize);
03468 
03469     <a class="code" href="../../d4/d8/mi_8h.html#a816">MiAddMappedPtes</a> (BasePte,
03470                      NumberOfPtes,
03471                      ControlArea);
03472 
03473     <span class="keywordflow">if</span> (Session != &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03474         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (WsIrql);
03475     }
03476 
03477     *MappedBase = Base;
03478 
03479     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03480     <span class="keywordflow">return</span> STATUS_SUCCESS;
03481 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="mapview.c::MiMapViewOfDataSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiMapViewOfDataSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECTION_INHERIT&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CommitSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReleasedWsMutex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">2256</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01996">_MMEXTEND_INFO::CommittedSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02394">_MMVAD::FirstPrototypePte</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02395">_MMVAD::LastContiguousPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00389">MI_ALIGN_TO_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00280">MI_IS_PTE_PROTECTION_COPY_WRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02809">MiCheckPurgeAndUpMapCount()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00431">MiFindEmptyAddressRange()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00451">MiFindEmptyAddressRangeDown</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a304">MiProtectMapFileFor4kPage()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04258">MM_DBG_COMMIT_MAPVIEW_DATA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04290">MM_DBG_COMMIT_RETURN_MAPVIEW_DATA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00096">MM_HIGHEST_VAD_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00132">MM_USER_ADDRESS_RANGE_LIMIT</a>, <a class="el" href="../../d4/d8/mi_8h.html#a453">MMEXTEND_INFO</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04833">MmSectionBasedMutex</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04827">MmSectionCommitMutex</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00074">MmSharedCommit</a>, <a class="el" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00030">MMVADKEY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l03208">PAGE_4K</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01997">_MMEXTEND_INFO::ReferenceCount</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00042">ROUND_TO_PAGES64</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o19">_MMVAD::u4</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02122">_SUBSECTION::UnusedPtes</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>02273                    :
02274 
02275     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02276     specified process's address space.
02277 
02278 Arguments:
02279 
02280     see <a class="code" href="../../d2/d1/mm_8h.html#a241">MmMapViewOfSection</a> above...
02281 
02282     ControlArea - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
02283 
02284     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process pointer which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> receiving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
02285 
02286     ProtectionMask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial page protection-mask.
02287 
02288     ReleasedWsMutex - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02289                       not held when returning <span class="keyword">this</span> must be set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02290                       so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller will not release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unheld mutex.
02291 
02292                       Note <span class="keywordflow">if</span> <span class="keyword">this</span> routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex
02293                       <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always done unsafely as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space mutex
02294                       must be held on entry regardless.
02295 
02296 Return Value:
02297 
02298     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
02299 
02300 Environment:
02301 
02302     Kernel Mode, address creation mutex held.
02303 
02304 --*/
02305 
02306 {
02307     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
02308     PVOID StartingAddress;
02309     PVOID EndingAddress;
02310     BOOLEAN Attached;
02311     KIRQL OldIrql;
02312     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02313     ULONG PteOffset;
02314     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02315     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02316     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02317     ULONG_PTR Alignment;
02318     SIZE_T QuotaCharge;
02319     BOOLEAN ChargedQuota;
02320     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> TheFirstPrototypePte;
02321     PVOID CapturedStartingVa;
02322     ULONG CapturedCopyOnWrite;
02323 <span class="preprocessor">#if defined(_MIALT4K_)</span>
02324 <span class="preprocessor"></span>    SIZE_T ViewSizeFor4k;
02325 <span class="preprocessor">#endif</span>
02326 <span class="preprocessor"></span>
02327     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02328     QuotaCharge = 0;
02329     ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02330 
02331     <span class="keywordflow">if</span> ((AllocationType &amp; MEM_RESERVE) &amp;&amp;
02332         (ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02333         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02334         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
02335     }
02336 
02337     <span class="comment">//</span>
02338     <span class="comment">// Check to see if there is a purge operation ongoing for</span>
02339     <span class="comment">// this segment.</span>
02340     <span class="comment">//</span>
02341 
02342     <span class="keywordflow">if</span> ((AllocationType &amp; MEM_DOS_LIM) != 0) {
02343         <span class="keywordflow">if</span> ((*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02344             (AllocationType &amp; MEM_RESERVE)) {
02345 
02346             <span class="comment">//</span>
02347             <span class="comment">// If MEM_DOS_LIM is specified, the address to map the</span>
02348             <span class="comment">// view MUST be specified as well.</span>
02349             <span class="comment">//</span>
02350 
02351             *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02352             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
02353         }
02354         Alignment = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02355     } <span class="keywordflow">else</span> {
02356        Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
02357     }
02358 
02359     <span class="comment">//</span>
02360     <span class="comment">// Check to see if a purge operation is in progress and if so, wait</span>
02361     <span class="comment">// for the purge to complete.  In addition, up the count of mapped</span>
02362     <span class="comment">// views for this control area.</span>
02363     <span class="comment">//</span>
02364 
02365     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (ControlArea) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02366         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02367         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02368     }
02369 
02370     <span class="keywordflow">if</span> (*CapturedViewSize == 0) {
02371 
02372         SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~((ULONG)Alignment - 1);
02373         *CapturedViewSize = (ULONG_PTR)(Section-&gt;SizeOfSection.QuadPart -
02374                                     SectionOffset-&gt;QuadPart);
02375     } <span class="keywordflow">else</span> {
02376         *CapturedViewSize += SectionOffset-&gt;LowPart &amp; (Alignment - 1);
02377         SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~((ULONG)Alignment - 1);
02378     }
02379 
02380     <span class="keywordflow">if</span> ((LONG_PTR)*CapturedViewSize &lt;= 0) {
02381 
02382         <span class="comment">//</span>
02383         <span class="comment">// Section offset or view size past size of section.</span>
02384         <span class="comment">//</span>
02385 
02386         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02387         ControlArea-&gt;NumberOfMappedViews -= 1;
02388         ControlArea-&gt;NumberOfUserReferences -= 1;
02389 
02390         <span class="comment">//</span>
02391         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02392         <span class="comment">// This routine releases the PFN lock.</span>
02393         <span class="comment">//</span>
02394     
02395         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
02396 
02397         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02398         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
02399     }
02400 
02401     <span class="comment">//</span>
02402     <span class="comment">// Calculate the first prototype PTE field in the Vad.</span>
02403     <span class="comment">//</span>
02404 
02405     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0);
02406 
02407     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
02408 
02409     SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~((ULONG)Alignment - 1);
02410     PteOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02411 
02412     <span class="comment">//</span>
02413     <span class="comment">// Make sure the PTEs are not in the extended part of the</span>
02414     <span class="comment">// segment.</span>
02415     <span class="comment">//</span>
02416 
02417     <span class="keywordflow">if</span> (PteOffset &gt;= ControlArea-&gt;Segment-&gt;TotalNumberOfPtes) {
02418         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02419         ControlArea-&gt;NumberOfMappedViews -= 1;
02420         ControlArea-&gt;NumberOfUserReferences -= 1;
02421 
02422         <span class="comment">//</span>
02423         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02424         <span class="comment">// This routine releases the PFN lock.</span>
02425         <span class="comment">//</span>
02426     
02427         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
02428 
02429         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02430         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
02431     }
02432 
02433     <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
02434         PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
02435         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
02436         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection != NULL);
02437     }
02438 
02439     TheFirstPrototypePte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
02440 
02441     <span class="comment">//</span>
02442     <span class="comment">// Calculate the quota for the specified pages.</span>
02443     <span class="comment">//</span>
02444 
02445     <span class="keywordflow">if</span> ((ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02446         (CommitSize != 0) &amp;&amp;
02447         (ControlArea-&gt;Segment-&gt;NumberOfCommittedPages &lt;
02448                 ControlArea-&gt;Segment-&gt;TotalNumberOfPtes)) {
02449 
02450 
02451         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
02452 
02453         PointerPte = TheFirstPrototypePte;
02454         LastPte = PointerPte + <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(CommitSize);
02455 
02456         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
02457             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
02458                 QuotaCharge += 1;
02459             }
02460             PointerPte += 1;
02461         }
02462         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
02463     }
02464 
02465     CapturedStartingVa = (PVOID)Section-&gt;Address.StartingVpn;
02466     CapturedCopyOnWrite = Section-&gt;u.Flags.CopyOnWrite;
02467     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
02468 
02469     <span class="keywordflow">if</span> ((*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedStartingVa == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02470 
02471         <span class="comment">//</span>
02472         <span class="comment">// The section is not based, find an empty range.</span>
02473         <span class="comment">// This could raise an exception.</span>
02474 
02475         <span class="keywordflow">try</span> {
02476 
02477             <span class="comment">//</span>
02478             <span class="comment">// Find a starting address on a 64k boundary.</span>
02479             <span class="comment">//</span>
02480 
02481             <span class="keywordflow">if</span> ( AllocationType &amp; MEM_TOP_DOWN ) {
02482                 StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a94">MiFindEmptyAddressRangeDown</a> (
02483                                     *CapturedViewSize,
02484                                     (PVOID)((PCHAR)MM_HIGHEST_VAD_ADDRESS + 1),
02485                                     Alignment
02486                                     );
02487             } <span class="keywordflow">else</span> {
02488                 StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (*CapturedViewSize,
02489                                                            Alignment,
02490                                                            (ULONG)ZeroBits);
02491             }
02492 
02493         } except (EXCEPTION_EXECUTE_HANDLER) {
02494 
02495             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02496             ControlArea-&gt;NumberOfMappedViews -= 1;
02497             ControlArea-&gt;NumberOfUserReferences -= 1;
02498 
02499             <span class="comment">//</span>
02500             <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02501             <span class="comment">// This routine releases the PFN lock.</span>
02502             <span class="comment">//</span>
02503         
02504             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
02505 
02506             <span class="keywordflow">return</span> GetExceptionCode();
02507         }
02508 
02509         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
02510                                     *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
02511 
02512         <span class="keywordflow">if</span> (ZeroBits &gt; 0) {
02513             <span class="keywordflow">if</span> (EndingAddress &gt; (PVOID)((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a9">MM_USER_ADDRESS_RANGE_LIMIT</a> &gt;&gt; ZeroBits)) {
02514                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02515                 ControlArea-&gt;NumberOfMappedViews -= 1;
02516                 ControlArea-&gt;NumberOfUserReferences -= 1;
02517 
02518                 <span class="comment">//</span>
02519                 <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02520                 <span class="comment">// This routine releases the PFN lock.</span>
02521                 <span class="comment">//</span>
02522             
02523                 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
02524 
02525                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02526             }
02527         }
02528 
02529     } <span class="keywordflow">else</span> {
02530 
02531         <span class="keywordflow">if</span> (*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02532 
02533             <span class="comment">//</span>
02534             <span class="comment">// The section is based.</span>
02535             <span class="comment">//</span>
02536 
02537             StartingAddress = (PVOID)((PCHAR)CapturedStartingVa +
02538                                                      SectionOffset-&gt;LowPart);
02539         } <span class="keywordflow">else</span> {
02540 
02541             StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a92">MI_ALIGN_TO_SIZE</a> (*CapturedBase, Alignment);
02542 
02543         }
02544 
02545         <span class="comment">//</span>
02546         <span class="comment">// Check to make sure the specified base address to ending address</span>
02547         <span class="comment">// is currently unused.</span>
02548         <span class="comment">//</span>
02549 
02550         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
02551                                    *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
02552 
02553         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
02554         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02555 <span class="preprocessor">#if DBG</span>
02556 <span class="preprocessor"></span>                MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
02557 <span class="preprocessor">#endif</span>
02558 <span class="preprocessor"></span>
02559             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02560             ControlArea-&gt;NumberOfMappedViews -= 1;
02561             ControlArea-&gt;NumberOfUserReferences -= 1;
02562 
02563             <span class="comment">//</span>
02564             <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02565             <span class="comment">// This routine releases the PFN lock.</span>
02566             <span class="comment">//</span>
02567         
02568             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
02569 
02570             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
02571         }
02572     }
02573 
02574     <span class="comment">//</span>
02575     <span class="comment">// An unoccupied address range has been found, build the virtual</span>
02576     <span class="comment">// address descriptor to describe this range.</span>
02577     <span class="comment">//</span>
02578 
02579     <span class="keywordflow">try</span>  {
02580 
02581         Vad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02582                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>),
02583                                      MMVADKEY);
02584         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02585             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
02586         }
02587         RtlZeroMemory (Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
02588 
02589         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
02590         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
02591         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = TheFirstPrototypePte;
02592 
02593         <span class="comment">//</span>
02594         <span class="comment">// Set the protection in the PTE template field of the VAD.</span>
02595         <span class="comment">//</span>
02596 
02597         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
02598 
02599         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = (InheritDisposition == ViewShare);
02600         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
02601         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite = CapturedCopyOnWrite;
02602 
02603         <span class="comment">//</span>
02604         <span class="comment">// Note that for MEM_DOS_LIM significance is lost here, but those</span>
02605         <span class="comment">// files are not mapped MEM_RESERVE.</span>
02606         <span class="comment">//</span>
02607 
02608         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.FileOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; 16);
02609 
02610         <span class="keywordflow">if</span> ((AllocationType &amp; SEC_NO_CHANGE) || (Section-&gt;u.Flags.NoChange)) {
02611             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
02612             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange = 1;
02613         }
02614         <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
02615             <a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">PMMEXTEND_INFO</a> ExtendInfo;
02616 
02617             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;MmSectionBasedMutex);
02618             ExtendInfo = ControlArea-&gt;Segment-&gt;ExtendInfo;
02619             <span class="keywordflow">if</span> (ExtendInfo) {
02620                 ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o1">ReferenceCount</a> += 1;
02621                 <span class="keywordflow">if</span> (ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> &lt; (UINT64)Section-&gt;SizeOfSection.QuadPart) {
02622                     ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> = (UINT64)Section-&gt;SizeOfSection.QuadPart;
02623                 }
02624             } <span class="keywordflow">else</span> {
02625 
02626                 ExtendInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02627                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">MMEXTEND_INFO</a>),
02628                                                     'xCmM');
02629                 <span class="keywordflow">if</span> (ExtendInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02630                     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionBasedMutex);
02631                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
02632                 }
02633                 ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o1">ReferenceCount</a> = 1;
02634                 ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> = ControlArea-&gt;Segment-&gt;SizeOfSegment;
02635                 <span class="keywordflow">if</span> (ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> &lt; (UINT64)Section-&gt;SizeOfSection.QuadPart) {
02636                     ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> = (UINT64)Section-&gt;SizeOfSection.QuadPart;
02637                 }
02638                 ControlArea-&gt;Segment-&gt;ExtendInfo = ExtendInfo;
02639             }
02640             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionBasedMutex);
02641             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ExtendableFile = 1;
02642             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.ExtendedInfo == NULL);
02643             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.ExtendedInfo = ExtendInfo;
02644         }
02645 
02646         <span class="comment">//</span>
02647         <span class="comment">// If the page protection is write-copy or execute-write-copy</span>
02648         <span class="comment">// charge for each page in the view as it may become private.</span>
02649         <span class="comment">//</span>
02650 
02651         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a88">MI_IS_PTE_PROTECTION_COPY_WRITE</a>(ProtectionMask)) {
02652             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge = (<a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((PCHAR) EndingAddress -
02653                                (PCHAR) StartingAddress));
02654         }
02655 
02656         <span class="comment">//</span>
02657         <span class="comment">// If this is a page file backed section, charge the process's page</span>
02658         <span class="comment">// file quota as if all the pages have been committed.  This solves</span>
02659         <span class="comment">// the problem when other processes commit all the pages and leave</span>
02660         <span class="comment">// only one process around who may not have been charged the proper</span>
02661         <span class="comment">// quota.  This is solved by charging everyone the maximum quota.</span>
02662         <span class="comment">//</span>
02663 <span class="comment">//</span>
02664 <span class="comment">// commented out for commitment charging.</span>
02665 <span class="comment">//</span>
02666 
02667 <span class="preprocessor">#if 0</span>
02668 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02669 
02670             <span class="comment">//</span>
02671             <span class="comment">// This is a page file backed section.  Charge for all the pages.</span>
02672             <span class="comment">//</span>
02673 
02674             Vad-&gt;CommitCharge += (<a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((PCHAR)EndingAddress -
02675                                (PCHAR)StartingAddress));
02676         }
02677 <span class="preprocessor">#endif</span>
02678 <span class="preprocessor"></span>
02679 
02680         PteOffset += (ULONG)(Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
02681 
02682         <span class="keywordflow">if</span> (PteOffset &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> ) {
02683             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
02684 
02685         } <span class="keywordflow">else</span> {
02686             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[
02687                                         (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1) +
02688                                         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a>];
02689         }
02690 
02691         <span class="keywordflow">if</span> (QuotaCharge != 0) {
02692             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (QuotaCharge, Process) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02693                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
02694             }
02695             ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02696             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_MAPVIEW_DATA, QuotaCharge);
02697         }
02698 
02699         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> &lt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>);
02700         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
02701 
02702     } except (EXCEPTION_EXECUTE_HANDLER) {
02703 
02704         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02705         ControlArea-&gt;NumberOfMappedViews -= 1;
02706         ControlArea-&gt;NumberOfUserReferences -= 1;
02707 
02708         <span class="comment">//</span>
02709         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02710         <span class="comment">// This routine releases the PFN lock.</span>
02711         <span class="comment">//</span>
02712     
02713         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
02714 
02715         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02716 
02717             <span class="comment">//</span>
02718             <span class="comment">// The pool allocation succeeded, but the quota charge</span>
02719             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
02720             <span class="comment">// an error.</span>
02721             <span class="comment">//</span>
02722 
02723             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
02724             <span class="keywordflow">if</span> (ChargedQuota) {
02725                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (QuotaCharge);
02726                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_MAPVIEW_DATA, QuotaCharge);
02727             }
02728             <span class="keywordflow">return</span> GetExceptionCode();
02729         }
02730         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02731     }
02732 
02733     *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02734 
02735 <span class="preprocessor">#if DBG</span>
02736 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(AllocationType &amp; MEM_RESERVE)) {
02737         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((ULONG_PTR)EndingAddress - (ULONG_PTR)StartingAddress) &lt;=
02738                 <a class="code" href="../../d3/d5/mapview_8c.html#a1">ROUND_TO_PAGES64</a>(Section-&gt;Segment-&gt;SizeOfSegment));
02739     }
02740 <span class="preprocessor">#endif //DBG</span>
02741 <span class="preprocessor"></span>
02742     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02743 
02744     <span class="comment">//</span>
02745     <span class="comment">// If a commit size was specified, make sure those pages are committed.</span>
02746     <span class="comment">//</span>
02747 
02748     <span class="keywordflow">if</span> (QuotaCharge != 0) {
02749 
02750         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
02751 
02752         PointerPte = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>;
02753         LastPte = PointerPte + <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(CommitSize);
02754         TempPte = ControlArea-&gt;Segment-&gt;SegmentPteTemplate;
02755 
02756         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
02757 
02758             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
02759 
02760                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
02761             }
02762             PointerPte += 1;
02763         }
02764 
02765         ControlArea-&gt;Segment-&gt;NumberOfCommittedPages += QuotaCharge;
02766 
02767         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;Segment-&gt;NumberOfCommittedPages &lt;=
02768                 ControlArea-&gt;Segment-&gt;TotalNumberOfPtes);
02769         <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> += QuotaCharge;
02770 
02771         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
02772     }
02773 
02774 <span class="preprocessor">#if defined(_MIALT4K_)</span>
02775 <span class="preprocessor"></span>
02776     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02777 
02778 
02779         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
02780                                  *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
02781 
02782         ViewSizeFor4k = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02783 
02784         <a class="code" href="../../d2/d9/miia64_8h.html#a304">MiProtectMapFileFor4kPage</a> (StartingAddress,
02785                                    ViewSizeFor4k,
02786                                    ProtectionMask, 
02787                                    Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>,
02788                                    Process);
02789     }
02790 <span class="preprocessor">#endif</span>
02791 <span class="preprocessor"></span>
02792     <span class="comment">//</span>
02793     <span class="comment">// Update the current virtual size in the process header.</span>
02794     <span class="comment">//</span>
02795 
02796     *CapturedViewSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02797     Process-&gt;VirtualSize += *CapturedViewSize;
02798 
02799     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
02800         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
02801     }
02802 
02803     *CapturedBase = StartingAddress;
02804 
02805     <span class="keywordflow">return</span> STATUS_SUCCESS;
02806 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="mapview.c::MiMapViewOfDataSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiMapViewOfDataSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECTION_INHERIT&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CommitSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReleasedWsMutex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="mapview.c::MiMapViewOfImageSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiMapViewOfImageSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECTION_INHERIT&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageCommitment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReleasedWsMutex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
_ALPHA_ 
<p>
_WIN64 
<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">1567</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02394">_MMVAD::FirstPrototypePte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00769">IMAGE_ADDRESSING_MODE_32BIT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00757">_IMAGE_INFO::ImageAddressingMode</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00763">_IMAGE_INFO::ImageBase</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00766">_IMAGE_INFO::ImageSectionNumber</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00764">_IMAGE_INFO::ImageSelector</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00765">_IMAGE_INFO::ImageSize</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02395">_MMVAD::LastContiguousPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00360">MI_64K_ALIGN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02809">MiCheckPurgeAndUpMapCount()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00431">MiFindEmptyAddressRange()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a305">MiProtectImageFileFor4kPage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03060">MiSetPageModified()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00084">MM_ALLOCATION_FILLS_VAD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00184">MM_DBG_WALK_VAD_TREE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00140">MM_EXECUTE_WRITECOPY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00096">MM_HIGHEST_VAD_ADDRESS</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00026">MMDB</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00027">MmHighestUserAddress</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00062">MmLoadedUserImageList</a>, <a class="el" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00030">MMVADKEY</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00755">_IMAGE_INFO::Properties</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02396">PsCallImageNotifyRoutines()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00880">PsImageNotifyEnabled</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01249">RtlFreeAnsiString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk()</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>01582                    :
01583 
01584     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Image section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01585     specified process's address space.
01586 
01587 Arguments:
01588 
01589     see <a class="code" href="../../d2/d1/mm_8h.html#a241">MmMapViewOfSection</a> above...
01590 
01591     ControlArea - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
01592 
01593     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process pointer which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> receiving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
01594 
01595     ReleasedWsMutex - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01596                       not held when returning <span class="keyword">this</span> must be set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01597                       so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller will not release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unheld mutex.
01598 
01599                       Note <span class="keywordflow">if</span> <span class="keyword">this</span> routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex
01600                       <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always done unsafely as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space mutex
01601                       must be held on entry regardless.
01602 
01603 Return Value:
01604 
01605     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
01606 
01607 Environment:
01608 
01609     Kernel Mode, address creation mutex held.
01610 
01611 --*/
01612 
01613 {
01614     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
01615     PVOID StartingAddress;
01616     PVOID EndingAddress;
01617     BOOLEAN Attached;
01618     KIRQL OldIrql;
01619     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01620     ULONG PteOffset;
01621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ReturnedStatus;
01622     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
01623     PVOID BasedAddress;
01624     SIZE_T NeededViewSize;
01625 <span class="preprocessor">#if defined(_ALPHA_)</span>
01626 <span class="preprocessor"></span>    ULONG_PTR Starting2gb;
01627     ULONG_PTR Ending2gb;
01628     ULONG_PTR BoundaryMask;
01629     LOGICAL AlignmentOk;
01630 <span class="preprocessor">#endif</span>
01631 <span class="preprocessor"></span><span class="preprocessor">#if defined(_MIALT4K_)</span>
01632 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
01633     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoAltPte;
01634     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltPte;
01635     PIMAGE_NT_HEADERS NtHeaders;
01636     ULONG ImageAlignment;
01637 <span class="preprocessor">#endif</span>
01638 <span class="preprocessor"></span>
01639     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01640 
01641     <span class="comment">//</span>
01642     <span class="comment">// Image file.</span>
01643     <span class="comment">//</span>
01644     <span class="comment">// Locate the first subsection (text) and create a virtual</span>
01645     <span class="comment">// address descriptor to map the entire image here.</span>
01646     <span class="comment">//</span>
01647 
01648     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0) {
01649         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
01650     }
01651     <span class="keywordflow">else</span> {
01652         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
01653     }
01654 
01655     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.ImageMappedInSystemSpace) {
01656 
01657         <span class="keywordflow">if</span> (KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01658 
01659             <span class="comment">//</span>
01660             <span class="comment">// Mapping in system space as a driver, hence copy on write does</span>
01661             <span class="comment">// not work.  Don't allow user processes to map the image.</span>
01662             <span class="comment">//</span>
01663 
01664             *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01665             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01666         }
01667     }
01668 
01669     <span class="comment">//</span>
01670     <span class="comment">// Check to see if a purge operation is in progress and if so, wait</span>
01671     <span class="comment">// for the purge to complete.  In addition, up the count of mapped</span>
01672     <span class="comment">// views for this control area.</span>
01673     <span class="comment">//</span>
01674 
01675     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (ControlArea) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01676         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01677         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01678     }
01679 
01680     <span class="comment">//</span>
01681     <span class="comment">// Capture the based address to the stack, to prevent page faults.</span>
01682     <span class="comment">//</span>
01683 
01684     BasedAddress = ControlArea-&gt;Segment-&gt;BasedAddress;
01685 
01686     <span class="keywordflow">if</span> (*CapturedViewSize == 0) {
01687         *CapturedViewSize =
01688             (ULONG_PTR)(Section-&gt;SizeOfSection.QuadPart - SectionOffset-&gt;QuadPart);
01689     }
01690 
01691     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01692 
01693     ReturnedStatus = STATUS_SUCCESS;
01694 
01695     <span class="comment">//</span>
01696     <span class="comment">// Determine if a specific base was specified.</span>
01697     <span class="comment">//</span>
01698 
01699     <span class="keywordflow">if</span> (*CapturedBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01700 
01701         <span class="comment">//</span>
01702         <span class="comment">// Captured base is not NULL.</span>
01703         <span class="comment">//</span>
01704         <span class="comment">// Check to make sure the specified address range is currently unused</span>
01705         <span class="comment">// and within the user address space.</span>
01706         <span class="comment">//</span>
01707 
01708         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)1;
01709         StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(*CapturedBase);
01710         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01711                                        *CapturedViewSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01712 
01713         <span class="keywordflow">if</span> ((StartingAddress &lt;=  <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) &amp;&amp;
01714             (((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1) -
01715                                 (ULONG_PTR)StartingAddress &gt;= *CapturedViewSize) &amp;&amp;
01716 
01717             (EndingAddress &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>)) {
01718 
01719             Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
01720         }
01721 
01722         <span class="keywordflow">if</span> (Vad != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01723 <span class="preprocessor">#if DBG</span>
01724 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)1) {
01725                 MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
01726             }
01727 <span class="preprocessor">#endif</span>
01728 <span class="preprocessor"></span>
01729             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01730             ControlArea-&gt;NumberOfMappedViews -= 1;
01731             ControlArea-&gt;NumberOfUserReferences -= 1;
01732 
01733             <span class="comment">//</span>
01734             <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
01735             <span class="comment">// This routine releases the PFN lock.</span>
01736             <span class="comment">//</span>
01737         
01738             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
01739             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01740         }
01741 
01742         <span class="comment">//</span>
01743         <span class="comment">// A conflicting VAD was not found and the specified address range is</span>
01744         <span class="comment">// within the user address space. If the image will not reside at its</span>
01745         <span class="comment">// base address, then set a special return status.</span>
01746         <span class="comment">//</span>
01747 
01748         <span class="keywordflow">if</span> (((ULONG_PTR)StartingAddress +
01749             (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart)) != (ULONG_PTR)BasedAddress) {
01750             ReturnedStatus = STATUS_IMAGE_NOT_AT_BASE;
01751         }
01752 
01753     } <span class="keywordflow">else</span> {
01754 
01755         <span class="comment">//</span>
01756         <span class="comment">// Captured base is NULL.</span>
01757         <span class="comment">//</span>
01758         <span class="comment">// If the captured view size is greater than the largest size that</span>
01759         <span class="comment">// can fit in the user address space, then it is not possible to map</span>
01760         <span class="comment">// the image.</span>
01761         <span class="comment">//</span>
01762 
01763         <span class="keywordflow">if</span> ((PVOID)*CapturedViewSize &gt; <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) {
01764             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01765             ControlArea-&gt;NumberOfMappedViews -= 1;
01766             ControlArea-&gt;NumberOfUserReferences -= 1;
01767 
01768             <span class="comment">//</span>
01769             <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
01770             <span class="comment">// This routine releases the PFN lock.</span>
01771             <span class="comment">//</span>
01772         
01773             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
01774             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01775         }
01776 
01777         <span class="comment">//</span>
01778         <span class="comment">// Check to make sure the specified address range is currently unused</span>
01779         <span class="comment">// and within the user address space.</span>
01780         <span class="comment">//</span>
01781 
01782         StartingAddress = (PVOID)((ULONG_PTR)BasedAddress +
01783                                     (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart));
01784 
01785         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01786                                     *CapturedViewSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01787 
01788         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)1;
01789         NeededViewSize = *CapturedViewSize;
01790 
01791 <span class="preprocessor">#if defined(_ALPHA_)</span>
01792 <span class="preprocessor"></span>
01793 <span class="preprocessor">#if defined(_AXP64_)</span>
01794 <span class="preprocessor"></span><span class="preprocessor">#define BOUNDARY ((LONG_PTR)_2gb)</span>
01795 <span class="preprocessor"></span><span class="preprocessor">#else</span>
01796 <span class="preprocessor"></span><span class="preprocessor">#define BOUNDARY ((ULONG_PTR)_2gb)</span>
01797 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01798 <span class="preprocessor"></span>
01799         <span class="comment">//</span>
01800         <span class="comment">// Alpha images cannot span 2GB boundaries with the current compiler</span>
01801         <span class="comment">// generated branch instructions.  If a spanning image is detected, it</span>
01802         <span class="comment">// must be relocated.</span>
01803         <span class="comment">//</span>
01804 
01805         BoundaryMask = (ULONG_PTR)~(BOUNDARY-1);
01806 
01807         Starting2gb = (ULONG_PTR)StartingAddress &amp; BoundaryMask;
01808         Ending2gb = (ULONG_PTR)EndingAddress &amp; BoundaryMask;
01809 
01810         AlignmentOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01811 
01812         <span class="keywordflow">if</span> (Starting2gb != Ending2gb) {
01813             AlignmentOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01814             <span class="keywordflow">if</span> (Starting2gb + 1 == Ending2gb) {
01815                 <span class="keywordflow">if</span> (((ULONG_PTR)EndingAddress &amp; (BOUNDARY-1)) == 0) {
01816                     AlignmentOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01817                 }
01818             }
01819         }
01820 
01821         <span class="keywordflow">if</span> (AlignmentOk == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01822 
01823             <span class="comment">//</span>
01824             <span class="comment">// Find twice the required size so that it can be placed correctly.</span>
01825             <span class="comment">//</span>
01826 
01827             NeededViewSize = *CapturedViewSize * 2 + <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
01828         }
01829         <span class="keywordflow">else</span>
01830 <span class="preprocessor">#endif</span>
01831 <span class="preprocessor"></span>
01832         <span class="keywordflow">if</span> ((StartingAddress &gt;= MM_LOWEST_USER_ADDRESS) &amp;&amp;
01833             (StartingAddress &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) &amp;&amp;
01834             (((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1) -
01835                                 (ULONG_PTR)StartingAddress &gt;= *CapturedViewSize) &amp;&amp;
01836 
01837             (EndingAddress &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>)) {
01838 
01839             Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
01840         }
01841 
01842         <span class="comment">//</span>
01843         <span class="comment">// If the VAD address is not NULL, then a conflict was discovered.</span>
01844         <span class="comment">// Attempt to select another address range in which to map the image.</span>
01845         <span class="comment">//</span>
01846 
01847         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01848 
01849             <span class="comment">//</span>
01850             <span class="comment">// The image could not be mapped at its natural base address</span>
01851             <span class="comment">// try to find another place to map it.</span>
01852             <span class="comment">//</span>
01853 <span class="preprocessor">#if DBG</span>
01854 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)1) {
01855                 MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
01856             }
01857 <span class="preprocessor">#endif</span>
01858 <span class="preprocessor"></span>
01859             <span class="comment">//</span>
01860             <span class="comment">// If the system has been biased to an alternate base address to</span>
01861             <span class="comment">// allow 3gb of user address space, then make sure the high order</span>
01862             <span class="comment">// address bit is zero.</span>
01863             <span class="comment">//</span>
01864 
01865 <span class="preprocessor">#if defined(_X86_)</span>
01866 <span class="preprocessor"></span>
01867             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) &amp;&amp;
01868                 (ZeroBits == 0)) {
01869                 ZeroBits = 1;
01870             }
01871 <span class="preprocessor">#endif</span>
01872 <span class="preprocessor"></span>
01873             ReturnedStatus = STATUS_IMAGE_NOT_AT_BASE;
01874             <span class="keywordflow">try</span> {
01875 
01876                 <span class="comment">//</span>
01877                 <span class="comment">// Find a starting address on a 64k boundary.</span>
01878                 <span class="comment">//</span>
01879 
01880                 StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (NeededViewSize,
01881                                                            X64K,
01882                                                            (ULONG)ZeroBits);
01883 
01884 
01885             } except (EXCEPTION_EXECUTE_HANDLER) {
01886                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01887                 ControlArea-&gt;NumberOfMappedViews -= 1;
01888                 ControlArea-&gt;NumberOfUserReferences -= 1;
01889 
01890                 <span class="comment">//</span>
01891                 <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
01892                 <span class="comment">// This routine releases the PFN lock.</span>
01893                 <span class="comment">//</span>
01894             
01895                 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
01896 
01897                 <span class="keywordflow">return</span> GetExceptionCode();
01898             }
01899 
01900             EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01901                                         *CapturedViewSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01902 
01903 <span class="preprocessor">#if defined(_ALPHA_)</span>
01904 <span class="preprocessor"></span>
01905             <span class="keywordflow">if</span> (AlignmentOk == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01906                 Starting2gb = (ULONG_PTR)StartingAddress &amp; ~(BOUNDARY-1);
01907                 Ending2gb = (ULONG_PTR)EndingAddress &amp; ~(BOUNDARY-1);
01908         
01909                 <span class="keywordflow">if</span> (Starting2gb != Ending2gb) {
01910     
01911                     <span class="comment">//</span>
01912                     <span class="comment">// Not in the same 2gb.  Up the start to a 2gb boundary.</span>
01913                     <span class="comment">//</span>
01914     
01915                     StartingAddress = (PVOID)Ending2gb;
01916                     EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01917                                         *CapturedViewSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01918                 }
01919             }
01920 <span class="preprocessor">#endif</span>
01921 <span class="preprocessor"></span>
01922         }
01923     }
01924 
01925     <span class="comment">//</span>
01926     <span class="comment">// Allocate and initialize a VAD for the specified address range.</span>
01927     <span class="comment">//</span>
01928 
01929     Vad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), MMVADKEY);
01930     <span class="keywordflow">try</span>  {
01931         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01932             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01933         }
01934 
01935         RtlZeroMemory (Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
01936         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
01937         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
01938         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = (InheritDisposition == ViewShare);
01939         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap = 1;
01940 
01941         <span class="comment">//</span>
01942         <span class="comment">// Set the protection in the VAD as EXECUTE_WRITE_COPY.</span>
01943         <span class="comment">//</span>
01944 
01945         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>;
01946         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
01947 
01948         <span class="comment">//</span>
01949         <span class="comment">// Set the first prototype PTE field in the Vad.</span>
01950         <span class="comment">//</span>
01951 
01952         SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~(<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1);
01953         PteOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01954 
01955         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
01956         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = <a class="code" href="../../d4/d8/mi_8h.html#a13">MM_ALLOCATION_FILLS_VAD</a>;
01957 
01958         <span class="comment">//</span>
01959         <span class="comment">// NOTE: the full commitment is charged even if a partial map of an</span>
01960         <span class="comment">// image is being done.  This saves from having to run through the</span>
01961         <span class="comment">// entire image (via prototype PTEs) and calculate the charge on</span>
01962         <span class="comment">// a per page basis for the partial map.</span>
01963         <span class="comment">//</span>
01964 
01965         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge = (SIZE_T)ImageCommitment; <span class="comment">// ****** temp</span>
01966 
01967         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> &lt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>);
01968 
01969         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
01970 
01971     } except (EXCEPTION_EXECUTE_HANDLER) {
01972         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01973         ControlArea-&gt;NumberOfMappedViews -= 1;
01974         ControlArea-&gt;NumberOfUserReferences -= 1;
01975 
01976         <span class="comment">//</span>
01977         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
01978         <span class="comment">// This routine releases the PFN lock.</span>
01979         <span class="comment">//</span>
01980     
01981         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
01982 
01983         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01984 
01985             <span class="comment">//</span>
01986             <span class="comment">// The pool allocation succeeded, but the quota charge</span>
01987             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
01988             <span class="comment">// an error.</span>
01989             <span class="comment">//</span>
01990 
01991             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
01992             <span class="keywordflow">return</span> GetExceptionCode();
01993         }
01994 
01995         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01996     }
01997 
01998     *CapturedViewSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01999     *CapturedBase = StartingAddress;
02000 
02001 <span class="preprocessor">#if DBG</span>
02002 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a76">MM_DBG_WALK_VAD_TREE</a>) {
02003         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"mapped image section vads\n"</span>);
02004         <a class="code" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk</a>(Process-&gt;VadRoot);
02005     }
02006 <span class="preprocessor">#endif</span>
02007 <span class="preprocessor"></span>
02008     <span class="comment">//</span>
02009     <span class="comment">// Update the current virtual size in the process header.</span>
02010     <span class="comment">//</span>
02011 
02012     Process-&gt;VirtualSize += *CapturedViewSize;
02013 
02014     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
02015         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
02016     }
02017 
02018     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.FloppyMedia) {
02019 
02020         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02021         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02022 
02023         <span class="comment">//</span>
02024         <span class="comment">// The image resides on a floppy disk, in-page all</span>
02025         <span class="comment">// pages from the floppy and mark them as modified so</span>
02026         <span class="comment">// they migrate to the paging file rather than reread</span>
02027         <span class="comment">// them from the floppy disk which may have been removed.</span>
02028         <span class="comment">//</span>
02029 
02030         ProtoPte = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>;
02031 
02032         <span class="comment">//</span>
02033         <span class="comment">// This could get an in-page error from the floppy.</span>
02034         <span class="comment">//</span>
02035 
02036         <span class="keywordflow">while</span> (StartingAddress &lt; EndingAddress) {
02037 
02038             <span class="comment">//</span>
02039             <span class="comment">// If the prototype PTE is valid, transition or</span>
02040             <span class="comment">// in prototype PTE format, bring the page into</span>
02041             <span class="comment">// memory and set the modified bit.</span>
02042             <span class="comment">//</span>
02043 
02044             <span class="keywordflow">if</span> ((ProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
02045                 (ProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) ||
02046                 (ProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
02047 
02048                 <span class="keywordflow">try</span> {
02049 
02050                     <a class="code" href="../../d3/d5/mapview_8c.html#a9">MiSetPageModified</a> (StartingAddress);
02051 
02052                 } except (EXCEPTION_EXECUTE_HANDLER) {
02053 
02054                     <span class="comment">//</span>
02055                     <span class="comment">// An in page error must have occurred touching the image,</span>
02056                     <span class="comment">// ignore the error and continue to the next page.</span>
02057                     <span class="comment">//</span>
02058 
02059                     NOTHING;
02060                 }
02061             }
02062             ProtoPte += 1;
02063             StartingAddress = (PVOID)((PCHAR)StartingAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02064         }
02065     }
02066 
02067     <span class="keywordflow">if</span> (!*ReleasedWsMutex) {
02068         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02069         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02070     }
02071 
02072     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnedStatus)) {
02073 
02074 
02075         <span class="comment">//</span>
02076         <span class="comment">// Check to see if this image is for the architecture of the current</span>
02077         <span class="comment">// machine.</span>
02078         <span class="comment">//</span>
02079 
02080         <span class="keywordflow">if</span> (ControlArea-&gt;Segment-&gt;ImageInformation-&gt;ImageContainsCode &amp;&amp;
02081             ((ControlArea-&gt;Segment-&gt;ImageInformation-&gt;Machine &lt;
02082                                           USER_SHARED_DATA-&gt;ImageNumberLow) ||
02083              (ControlArea-&gt;Segment-&gt;ImageInformation-&gt;Machine &gt;
02084                                           USER_SHARED_DATA-&gt;ImageNumberHigh)
02085             )
02086            ) {
02087 <span class="preprocessor">#if defined (_WIN64)</span>
02088 <span class="preprocessor"></span>
02089             <span class="comment">//</span>
02090             <span class="comment">// If this is a wow64 process, allow i386 images</span>
02091             <span class="comment">//</span>
02092 
02093             <span class="keywordflow">if</span> (!Process-&gt;Wow64Process ||
02094                 ControlArea-&gt;Segment-&gt;ImageInformation-&gt;Machine != IMAGE_FILE_MACHINE_I386) {
02095                 <span class="keywordflow">return</span> STATUS_IMAGE_MACHINE_TYPE_MISMATCH;
02096             }
02097 <span class="preprocessor">#else   </span>
02098 <span class="preprocessor">            return STATUS_IMAGE_MACHINE_TYPE_MISMATCH;</span>
02099 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02100 <span class="preprocessor"></span>        }
02101 
02102         StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
02103 
02104         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a>) {
02105 
02106             <a class="code" href="../../d2/d1/struct__IMAGE__INFO.html">IMAGE_INFO</a> ImageInfo;
02107 
02108             <span class="keywordflow">if</span> ( (StartingAddress &lt; <a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a>) &amp;&amp;
02109                  Process-&gt;UniqueProcessId &amp;&amp;
02110                  Process != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a> ) {
02111 
02112                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o0">Properties</a> = 0;
02113                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o1">ImageAddressingMode</a> = <a class="code" href="../../d1/d9/ps_8h.html#a23">IMAGE_ADDRESSING_MODE_32BIT</a>;
02114                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o5">ImageBase</a> = StartingAddress;
02115                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = *CapturedViewSize;
02116                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o6">ImageSelector</a> = 0;
02117                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o8">ImageSectionNumber</a> = 0;
02118                 <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(
02119                             (PUNICODE_STRING) &amp;ControlArea-&gt;FilePointer-&gt;FileName,
02120                             Process-&gt;UniqueProcessId,
02121                             &amp;ImageInfo
02122                             );
02123             }
02124         }
02125 
02126         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_KDEBUG_SYMBOL_LOAD) &amp;&amp;
02127             (ControlArea-&gt;u.Flags.Image) &amp;&amp;
02128             (ReturnedStatus != STATUS_IMAGE_NOT_AT_BASE)) {
02129             <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.DebugSymbolsLoaded == 0) {
02130                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols</a> (StartingAddress)) {
02131 
02132                     <span class="comment">//</span>
02133                     <span class="comment">//  TEMP TEMP TEMP rip out when debugger converted</span>
02134                     <span class="comment">//</span>
02135 
02136                     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
02137                     ANSI_STRING AnsiName;
02138                     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02139 
02140                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02141                     ControlArea-&gt;u.Flags.DebugSymbolsLoaded = 1;
02142                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02143 
02144                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = (PUNICODE_STRING)&amp;ControlArea-&gt;FilePointer-&gt;FileName;
02145                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != 0 &amp;&amp; (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_KDEBUG_SYMBOL_LOAD)) {
02146                         PLIST_ENTRY Head, Next;
02147                         PLDR_DATA_TABLE_ENTRY Entry;
02148 
02149                         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02150                         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;PsLoadedModuleResource, TRUE);
02151                         Head = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a20">MmLoadedUserImageList</a>;
02152                         Next = Head-&gt;Flink;
02153                         <span class="keywordflow">while</span> (Next != Head) {
02154                             Entry = CONTAINING_RECORD( Next,
02155                                                        LDR_DATA_TABLE_ENTRY,
02156                                                        InLoadOrderLinks
02157                                                      );
02158                             <span class="keywordflow">if</span> (Entry-&gt;DllBase == StartingAddress) {
02159                                 Entry-&gt;LoadCount += 1;
02160                                 <span class="keywordflow">break</span>;
02161                             }
02162                             Next = Next-&gt;Flink;
02163                         }
02164 
02165                         <span class="keywordflow">if</span> (Next == Head) {
02166                             Entry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
02167                                                     <span class="keyword">sizeof</span>( *Entry ) +
02168                                                         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length +
02169                                                         <span class="keyword">sizeof</span>( UNICODE_NULL ),
02170                                                         MMDB
02171                                                   );
02172                             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02173                                 PIMAGE_NT_HEADERS NtHeaders;
02174 
02175                                 RtlZeroMemory (Entry, <span class="keyword">sizeof</span>(*Entry));
02176 
02177                                 <span class="keywordflow">try</span> {
02178                                     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a> (StartingAddress);
02179                                     <span class="keywordflow">if</span> (NtHeaders != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02180 <span class="preprocessor">#if defined(_WIN64)</span>
02181 <span class="preprocessor"></span>                                        <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC) {
02182                                             Entry-&gt;SizeOfImage = NtHeaders-&gt;OptionalHeader.SizeOfImage;
02183                                             Entry-&gt;CheckSum = NtHeaders-&gt;OptionalHeader.CheckSum;
02184                                         }
02185                                         <span class="keywordflow">else</span> {
02186                                             PIMAGE_NT_HEADERS32 NtHeaders32 = (PIMAGE_NT_HEADERS32)NtHeaders;
02187 
02188                                             Entry-&gt;SizeOfImage = NtHeaders32-&gt;OptionalHeader.SizeOfImage;
02189                                             Entry-&gt;CheckSum = NtHeaders32-&gt;OptionalHeader.CheckSum;
02190                                         }
02191 <span class="preprocessor">#else</span>
02192 <span class="preprocessor"></span>                                        Entry-&gt;SizeOfImage = NtHeaders-&gt;OptionalHeader.SizeOfImage;
02193                                         Entry-&gt;CheckSum = NtHeaders-&gt;OptionalHeader.CheckSum;
02194 <span class="preprocessor">#endif</span>
02195 <span class="preprocessor"></span>                                    }
02196                                 } except (EXCEPTION_EXECUTE_HANDLER) {
02197                                     NOTHING;
02198                                 }
02199 
02200                                 Entry-&gt;DllBase = StartingAddress;
02201                                 Entry-&gt;FullDllName.Buffer = (PWSTR)(Entry+1);
02202                                 Entry-&gt;FullDllName.Length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
02203                                 Entry-&gt;FullDllName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
02204                                     (Entry-&gt;FullDllName.Length + <span class="keyword">sizeof</span>( UNICODE_NULL ));
02205                                 RtlMoveMemory( Entry-&gt;FullDllName.Buffer,
02206                                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
02207                                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length
02208                                              );
02209                                 Entry-&gt;FullDllName.Buffer[ Entry-&gt;FullDllName.Length / <span class="keyword">sizeof</span>( WCHAR )] = UNICODE_NULL;
02210                                 Entry-&gt;LoadCount = 1;
02211                                 InsertTailList( &amp;MmLoadedUserImageList,
02212                                                 &amp;Entry-&gt;InLoadOrderLinks
02213                                               );
02214                                 InitializeListHead( &amp;Entry-&gt;InInitializationOrderLinks );
02215                                 InitializeListHead( &amp;Entry-&gt;InMemoryOrderLinks );
02216                             }
02217                         }
02218 
02219                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
02220                         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02221                     }
02222 
02223                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiName,
02224                                                            FileName,
02225                                                            TRUE );
02226 
02227                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status)) {
02228                         DbgLoadImageSymbols( &amp;AnsiName,
02229                                              StartingAddress,
02230                                              (ULONG_PTR)Process
02231                                            );
02232                         <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a>( &amp;AnsiName );
02233                     }
02234                 }
02235             }
02236         }
02237     }
02238 
02239 <span class="preprocessor">#if defined(_MIALT4K_)</span>
02240 <span class="preprocessor"></span>
02241     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02242 
02243         <a class="code" href="../../d2/d9/miia64_8h.html#a305">MiProtectImageFileFor4kPage</a>(StartingAddress,
02244                                     *CapturedViewSize,
02245                                     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>,
02246                                     Process);
02247     }
02248 
02249 <span class="preprocessor">#endif</span>
02250 <span class="preprocessor"></span>
02251     <span class="keywordflow">return</span> ReturnedStatus;
02252 
02253 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="mapview.c::MiMapViewOfImageSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiMapViewOfImageSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECTION_INHERIT&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageCommitment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReleasedWsMutex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="mapview.c::MiMapViewOfPhysicalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiMapViewOfPhysicalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteCombined</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReleasedWsMutex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l01028">1028</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00522">AggregatePages()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02429">_MI_PHYSICAL_VIEW::EndVa</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02394">_MMVAD::FirstPrototypePte</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d4/i386_2flush_8c-source.html#l00187">KeInvalidateAllCaches()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02395">_MMVAD::LastContiguousPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02426">_MI_PHYSICAL_VIEW::ListEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00922">LOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00478">MaximumAlignment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00360">MI_64K_ALIGN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02312">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01357">MI_GET_USED_PTES_FROM_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01359">MI_INCREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00884">MI_IS_CACHING_DISABLED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02433">MI_PHYSICAL_VIEW_KEY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00687">MI_SET_PTE_WRITE_COMBINE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00431">MiFindEmptyAddressRange()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01591">MiGetSubsectionAddressForPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">MiMakePdeExistAndMakeValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03591">MiMakePpeExistAndMakeValid</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01495">MiProtoAddressForPte</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00267">MiWriteCombiningPtes</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00132">MM_USER_ADDRESS_RANGE_LIMIT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00278">MM_VA_MAPPED_BY_PDE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02340">MM_VIEW_UNMAP</a>, <a class="el" href="../../d4/d1/dataia64_8c-source.html#l00180">MmPageSizeInfo</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00025">MMPPTE_NAME</a>, <a class="el" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00030">MMVADKEY</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02119">_SUBSECTION::StartingSector</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02428">_MI_PHYSICAL_VIEW::StartVa</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/struct__SUBSECTION.html#o3">_SUBSECTION::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o19">_MMVAD::u4</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00925">UNLOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>01043                    :
01044 
01045     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01046     specified process's address space.
01047 
01048 Arguments:
01049 
01050     see <a class="code" href="../../d2/d1/mm_8h.html#a241">MmMapViewOfSection</a> above...
01051 
01052     ControlArea - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
01053 
01054     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process pointer which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> receiving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
01055 
01056     ProtectionMask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial page protection-mask.
01057 
01058     ReleasedWsMutex - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01059                       not held when returning <span class="keyword">this</span> must be set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01060                       so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller will not release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unheld mutex.
01061 
01062                       Note <span class="keywordflow">if</span> <span class="keyword">this</span> routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex
01063                       <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always done unsafely as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space mutex
01064                       must be held on entry regardless.
01065 
01066 Return Value:
01067 
01068     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
01069 
01070 Environment:
01071 
01072     Kernel Mode, address creation mutex held.
01073 
01074 --*/
01075 
01076 {
01077     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
01078     PVOID StartingAddress;
01079     PVOID EndingAddress;
01080     KIRQL OldIrql;
01081     KIRQL OldIrql2;
01082     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01083     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01084     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01085     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01086     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01087     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01088     SIZE_T PhysicalViewSize;
01089     ULONG_PTR Alignment;
01090     PVOID UsedPageTableHandle;
01091     PVOID UsedPageDirectoryHandle;
01092     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
01093 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01094 <span class="preprocessor"></span>    ULONG size;
01095     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> protoPte;
01096     ULONG pageSize;
01097     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01098     ULONG EmPageSize;
01099 <span class="preprocessor">#endif //LARGE_PAGES</span>
01100 <span class="preprocessor"></span>
01101     <span class="comment">//</span>
01102     <span class="comment">// Physical memory section.</span>
01103     <span class="comment">//</span>
01104 
01105     <span class="comment">//</span>
01106     <span class="comment">// If running on an R4000 and MEM_LARGE_PAGES is specified,</span>
01107     <span class="comment">// set up the PTEs as a series of  pointers to the same</span>
01108     <span class="comment">// prototype PTE.  This prototype PTE will reference a subsection</span>
01109     <span class="comment">// that indicates large pages should be used.</span>
01110     <span class="comment">//</span>
01111     <span class="comment">// The R4000 supports pages of 4k, 16k, 64k, etc (powers of 4).</span>
01112     <span class="comment">// Since the TB supports 2 entries, sizes of 8k, 32k etc can</span>
01113     <span class="comment">// be mapped by 2 LargePages in a single TB entry.  These 2 entries</span>
01114     <span class="comment">// are maintained in the subsection structure pointed to by the</span>
01115     <span class="comment">// prototype PTE.</span>
01116     <span class="comment">//</span>
01117 
01118     <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
01119         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01120         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
01121     }
01122     Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
01123     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01124 
01125 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01126 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01127 
01128         <span class="comment">//</span>
01129         <span class="comment">// Determine the page size and the required alignment.</span>
01130         <span class="comment">//</span>
01131 
01132         <span class="keywordflow">if</span> ((SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0) {
01133             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
01134         }
01135 
01136         size = (*CapturedViewSize - 1) &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> + 1);
01137         pageSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01138 
01139         <span class="keywordflow">while</span> (size != 0) {
01140             size = size &gt;&gt; 2;
01141             pageSize = pageSize &lt;&lt; 2;
01142         }
01143 
01144         Alignment = pageSize &lt;&lt; 1;
01145         <span class="keywordflow">if</span> (Alignment &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>) {
01146             Alignment = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>;
01147         }
01148 
01149 <span class="preprocessor">#if defined(_IA64_)</span>
01150 <span class="preprocessor"></span>
01151         <span class="comment">//</span>
01152         <span class="comment">// Convert pageSize to the EM page-size field format.</span>
01153         <span class="comment">//</span>
01154 
01155         EmPageSize = 0;
01156         size = pageSize - 1 ;
01157 
01158         <span class="keywordflow">while</span> (size) {
01159             size = size &gt;&gt; 1;
01160             EmPageSize += 1;
01161         }
01162 
01163         <span class="keywordflow">if</span> (*CapturedViewSize &gt; pageSize) {
01164 
01165             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d2/dataia64_8c.html#a27">MmPageSizeInfo</a> &amp; (pageSize &lt;&lt; 1)) {
01166 
01167                 <span class="comment">//</span>
01168                 <span class="comment">// if larger page size is supported in the implementation</span>
01169                 <span class="comment">//</span>
01170 
01171                 pageSize = pageSize &lt;&lt; 1;
01172                 EmPageSize += 1;
01173 
01174             }
01175             <span class="keywordflow">else</span> {
01176 
01177                 EmPageSize = EmPageSize | pageSize;
01178 
01179             }
01180         }
01181 
01182         pageSize = EmPageSize;
01183 <span class="preprocessor">#endif</span>
01184 <span class="preprocessor"></span>
01185     }
01186 <span class="preprocessor">#endif //LARGE_PAGES</span>
01187 <span class="preprocessor"></span>
01188     <span class="keywordflow">if</span> (*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01189 
01190         <span class="comment">//</span>
01191         <span class="comment">// Attempt to locate address space.  This could raise an</span>
01192         <span class="comment">// exception.</span>
01193         <span class="comment">//</span>
01194 
01195         <span class="keywordflow">try</span> {
01196 
01197             <span class="comment">//</span>
01198             <span class="comment">// Find a starting address on a 64k boundary.</span>
01199             <span class="comment">//</span>
01200 <span class="preprocessor">#ifdef i386</span>
01201 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SectionOffset-&gt;HighPart == 0);
01202 <span class="preprocessor">#endif</span>
01203 <span class="preprocessor"></span>
01204 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01205 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01206                 PhysicalViewSize = Alignment;
01207             } <span class="keywordflow">else</span> {
01208 <span class="preprocessor">#endif //LARGE_PAGES</span>
01209 <span class="preprocessor"></span>
01210                 PhysicalViewSize = *CapturedViewSize +
01211                                        (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1));
01212 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01213 <span class="preprocessor"></span>            }
01214 <span class="preprocessor">#endif //LARGE_PAGES</span>
01215 <span class="preprocessor"></span>
01216             StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (PhysicalViewSize,
01217                                                        Alignment,
01218                                                        (ULONG)ZeroBits);
01219 
01220         } except (EXCEPTION_EXECUTE_HANDLER) {
01221 
01222             <span class="keywordflow">return</span> GetExceptionCode();
01223         }
01224 
01225         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01226                                 PhysicalViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
01227         StartingAddress = (PVOID)((ULONG_PTR)StartingAddress +
01228                                      (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
01229 
01230         <span class="keywordflow">if</span> (ZeroBits &gt; 0) {
01231             <span class="keywordflow">if</span> (EndingAddress &gt; (PVOID)((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a9">MM_USER_ADDRESS_RANGE_LIMIT</a> &gt;&gt; ZeroBits)) {
01232                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01233             }
01234         }
01235 
01236     } <span class="keywordflow">else</span> {
01237 
01238         <span class="comment">//</span>
01239         <span class="comment">// Check to make sure the specified base address to ending address</span>
01240         <span class="comment">// is currently unused.</span>
01241         <span class="comment">//</span>
01242 
01243         StartingAddress = (PVOID)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(*CapturedBase) +
01244                                     (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
01245         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01246                                 *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
01247 
01248 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01249 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01250             <span class="keywordflow">if</span> (((ULONG_PTR)StartingAddress &amp; (Alignment - 1)) != 0) {
01251                 <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01252             }
01253             EndingAddress = (PVOID)((PCHAR)StartingAddress + Alignment);
01254         }
01255 <span class="preprocessor">#endif //LARGE_PAGES</span>
01256 <span class="preprocessor"></span>
01257         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
01258 
01259         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01260 <span class="preprocessor">#if DBG</span>
01261 <span class="preprocessor"></span>            MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
01262 <span class="preprocessor">#endif</span>
01263 <span class="preprocessor"></span>
01264             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01265         }
01266     }
01267 
01268     <span class="comment">//</span>
01269     <span class="comment">// An unoccupied address range has been found, build the virtual</span>
01270     <span class="comment">// address descriptor to describe this range.</span>
01271     <span class="comment">//</span>
01272 
01273 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01274 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01275         <span class="comment">//</span>
01276         <span class="comment">// Allocate a subsection and 4 prototype PTEs to hold</span>
01277         <span class="comment">// the information for the large pages.</span>
01278         <span class="comment">//</span>
01279 
01280         Subsection = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01281                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>) + (4 * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)),
01282                                      MMPPTE_NAME);
01283         <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01284             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01285         }
01286     }
01287 <span class="preprocessor">#endif //LARGE_PAGES</span>
01288 <span class="preprocessor"></span>
01289     <span class="comment">//</span>
01290     <span class="comment">// Establish an exception handler and attempt to allocate</span>
01291     <span class="comment">// the pool and charge quota.  Note that the InsertVad routine</span>
01292     <span class="comment">// will also charge quota which could raise an exception.</span>
01293     <span class="comment">//</span>
01294 
01295     <span class="keywordflow">try</span>  {
01296 
01297         PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01298                                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
01299                                                                  MI_PHYSICAL_VIEW_KEY);
01300         <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01301             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01302         }
01303 
01304         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01305                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>),
01306                                              MMVADKEY);
01307         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01308             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01309         }
01310 
01311         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
01312         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = StartingAddress;
01313         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
01314 
01315         RtlZeroMemory (Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
01316         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
01317         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
01318         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
01319         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = <a class="code" href="../../d4/d8/mi_8h.html#a228">MM_VIEW_UNMAP</a>;
01320         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping = 1;
01321         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
01322 
01323         <span class="comment">//</span>
01324         <span class="comment">// Set the last contiguous PTE field in the Vad to the page frame</span>
01325         <span class="comment">// number of the starting physical page.</span>
01326         <span class="comment">//</span>
01327 
01328         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(ULONG)(
01329                             SectionOffset-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01330 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01331 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01332         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.LargePages = 1;
01333         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)Subsection;
01334     } <span class="keywordflow">else</span> {
01335 <span class="preprocessor">#endif //LARGE_PAGES</span>
01336 <span class="preprocessor"></span>        <span class="comment">// Vad-&gt;u.VadFlags.LargePages = 0;</span>
01337         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>;
01338 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01339 <span class="preprocessor"></span>    }
01340 <span class="preprocessor">#endif //LARGE_PAGES</span>
01341 <span class="preprocessor"></span>
01342         <span class="comment">//</span>
01343         <span class="comment">// Insert the VAD.  This could get an exception.</span>
01344         <span class="comment">//</span>
01345 
01346         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> &lt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>);
01347         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
01348 
01349     } except (EXCEPTION_EXECUTE_HANDLER) {
01350 
01351         <span class="keywordflow">if</span> (PhysicalView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01352             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
01353         }
01354 
01355         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01356 
01357             <span class="comment">//</span>
01358             <span class="comment">// The pool allocation succeeded, but the quota charge</span>
01359             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
01360             <span class="comment">// an error.</span>
01361             <span class="comment">//</span>
01362 
01363             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
01364 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01365 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01366             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Subsection);
01367     }
01368 <span class="preprocessor">#endif //LARGE_PAGES</span>
01369 <span class="preprocessor"></span>            <span class="keywordflow">return</span> GetExceptionCode();
01370         }
01371         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01372     }
01373 
01374     <span class="comment">//</span>
01375     <span class="comment">// Increment the count of the number of views for the</span>
01376     <span class="comment">// section object.  This requires the PFN lock to be held.</span>
01377     <span class="comment">//</span>
01378 
01379     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
01380     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
01381 
01382     InsertHeadList (&amp;Process-&gt;PhysicalVadList, &amp;PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o0">ListEntry</a>);
01383 
01384     ControlArea-&gt;NumberOfMappedViews += 1;
01385     ControlArea-&gt;NumberOfUserReferences += 1;
01386 
01387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfSectionReferences != 0);
01388 
01389     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
01390     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
01391 
01392     <span class="comment">//</span>
01393     <span class="comment">// Build the PTEs in the address space.</span>
01394     <span class="comment">//</span>
01395 
01396     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
01397     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
01398     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
01399     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
01400 
01401     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01402                        (ULONG_PTR)Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>,
01403                        ProtectionMask,
01404                        PointerPte);
01405 
01406     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01407         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
01408     }
01409 
01410     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write) {
01411         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01412     }
01413 
01414 <span class="preprocessor">#if defined(_IA64_)</span>
01415 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a119">MI_IS_CACHING_DISABLED</a>(&amp;TempPte) || (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01416         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
01417     }
01418 <span class="preprocessor">#endif</span>
01419 <span class="preprocessor"></span>
01420 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01421 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01422         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">StartingSector</a> = pageSize;
01423         Subsection-&gt;EndingSector = (ULONG_PTR)StartingAddress;
01424         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.LongFlags = 0;
01425         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.LargePages = 1;
01426         protoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(Subsection + 1);
01427 
01428         <span class="comment">//</span>
01429         <span class="comment">// Build the first 2 PTEs as entries for the TLB to</span>
01430         <span class="comment">// map the specified physical address.</span>
01431         <span class="comment">//</span>
01432 
01433         *protoPte = TempPte;
01434         protoPte += 1;
01435 
01436         <span class="keywordflow">if</span> (*CapturedViewSize &gt; pageSize) {
01437             *protoPte = TempPte;
01438             protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += (pageSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01439         } <span class="keywordflow">else</span> {
01440             *protoPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
01441         }
01442         protoPte += 1;
01443 
01444         <span class="comment">//</span>
01445         <span class="comment">// Build the first prototype PTE as a paging file format PTE</span>
01446         <span class="comment">// referring to the subsection.</span>
01447         <span class="comment">//</span>
01448 
01449         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (Subsection);
01450         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
01451         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
01452 
01453         <span class="comment">//</span>
01454         <span class="comment">// Set the PTE up for all the user's PTE entries, proto pte</span>
01455         <span class="comment">// format pointing to the 3rd prototype PTE.</span>
01456         <span class="comment">//</span>
01457 
01458         TempPte.u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (protoPte);
01459     }
01460 
01461     <span class="keywordflow">if</span> (!(AllocationType &amp; MEM_LARGE_PAGES)) {
01462 <span class="preprocessor">#endif //LARGE_PAGES</span>
01463 <span class="preprocessor"></span>
01464 <span class="preprocessor">#if defined (_WIN64)</span>
01465 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
01466         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01467             UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01468             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01469         }
01470 <span class="preprocessor">#endif</span>
01471 <span class="preprocessor"></span>
01472         <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
01473 
01474         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01475 
01476         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (StartingAddress);
01477 
01478         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01479 
01480             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01481 
01482                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01483 
01484                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte)) {
01485                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01486                     <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
01487                 }
01488 
01489 <span class="preprocessor">#if defined (_WIN64)</span>
01490 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01491                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01492                     <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01493                 }
01494 <span class="preprocessor">#endif</span>
01495 <span class="preprocessor"></span>
01496                 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
01497                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01498                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MiGetVirtualAddressMappedByPte (PointerPte));
01499             }
01500 
01501             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
01502 
01503             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01504 
01505             <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01506 
01507             Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01508 
01509             <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01510 
01511             <span class="comment">//</span>
01512             <span class="comment">// Increment the count of non-zero page table entries for this</span>
01513             <span class="comment">// page table and the number of private pages for the process.</span>
01514             <span class="comment">//</span>
01515 
01516             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01517 
01518             PointerPte += 1;
01519             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += 1;
01520         }
01521 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01522 <span class="preprocessor"></span>    }
01523 <span class="preprocessor">#endif //LARGE_PAGES</span>
01524 <span class="preprocessor"></span>
01525 <span class="preprocessor">#if defined(i386)</span>
01526 <span class="preprocessor"></span>    <span class="comment">//</span>
01527     <span class="comment">// If write combined was specified then flush all caches and TBs.</span>
01528     <span class="comment">//</span>
01529 
01530     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; <a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01531         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
01532         <a class="code" href="../../d0/d5/i386_2flush_8c.html#a2">KeInvalidateAllCaches</a> (TRUE);
01533     }
01534 <span class="preprocessor">#endif</span>
01535 <span class="preprocessor"></span>
01536 <span class="preprocessor">#if defined(_IA64_)</span>
01537 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a119">MI_IS_CACHING_DISABLED</a>(&amp;TempPte) || (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01538         <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(StartingAddress, 
01539                                      (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1L,
01540                                      MmWriteCombined);
01541     }
01542 <span class="preprocessor">#endif</span>
01543 <span class="preprocessor"></span>
01544     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
01545     *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01546 
01547     <span class="comment">//</span>
01548     <span class="comment">// Update the current virtual size in the process header.</span>
01549     <span class="comment">//</span>
01550 
01551     *CapturedViewSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01552     Process-&gt;VirtualSize += *CapturedViewSize;
01553 
01554     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
01555         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
01556     }
01557 
01558     *CapturedBase = StartingAddress;
01559 
01560     <span class="keywordflow">return</span> STATUS_SUCCESS;
01561 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="mapview.c::MiRemoveFromSystemSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiRemoveFromSystemSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Session</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03893">3893</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, and <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>.
<p>
<pre class="fragment"><div>03901                    :
03902 
03903     This routine looks up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified view in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system space hash
03904     table and unmaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view from system space and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table.
03905 
03906 Arguments:
03907 
03908     Session - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session data structure <span class="keywordflow">for</span> <span class="keyword">this</span> view.
03909 
03910     Base - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.  If <span class="keyword">this</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03911            NOT found in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash table, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system bugchecks.
03912 
03913     ControlArea - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base
03914                   address.
03915 
03916 Return Value:
03917 
03918     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view divided by 64k.
03919 
03920 Environment:
03921 
03922     Kernel Mode, system view hash table locked.
03923 
03924 --*/
03925 
03926 {
03927     ULONG_PTR Base16;
03928     ULONG Hash;
03929     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03930     ULONG count;
03931 
03932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03933 
03934     count = 0;
03935 
03936     <span class="comment">//</span>
03937     <span class="comment">// CODE IS ALREADY LOCKED BY CALLER.</span>
03938     <span class="comment">//</span>
03939 
03940     Base16 = (ULONG_PTR)Base &gt;&gt; 16;
03941     Hash = (ULONG)(Base16 % Session-&gt;SystemSpaceHashKey);
03942 
03943     <span class="keywordflow">while</span> ((Session-&gt;SystemSpaceViewTable[Hash].Entry &gt;&gt; 16) != Base16) {
03944         Hash += 1;
03945         <span class="keywordflow">if</span> (Hash &gt;= Session-&gt;SystemSpaceHashSize) {
03946             Hash = 0;
03947             count += 1;
03948             <span class="keywordflow">if</span> (count == 2) {
03949                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_UNMAPPING_INVALID_VIEW,
03950                               (ULONG_PTR)Base,
03951                               MiHydra,
03952                               0,
03953                               0);
03954             }
03955         }
03956     }
03957 
03958     Session-&gt;SystemSpaceHashEntries -= 1;
03959     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG) (Session-&gt;SystemSpaceViewTable[Hash].Entry &amp; 0xFFFF);
03960     Session-&gt;SystemSpaceViewTable[Hash].Entry = 0;
03961     *ControlArea = Session-&gt;SystemSpaceViewTable[Hash].ControlArea;
03962     <span class="keywordflow">return</span> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03963 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="mapview.c::MiRemoveMappedPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRemoveMappedPtes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="mapview.c::MiSetPageModified" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSetPageModified           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Address</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03060">3060</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00757">MI_IS_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00733">MI_SET_PTE_CLEAN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>.
<p>
<pre class="fragment"><div>03066                    :
03067 
03068     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03069     pages that correspond to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range.
03070 
03071     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleared by <span class="keyword">this</span> operation.
03072 
03073 Arguments:
03074 
03075     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.  This
03076               range must reside within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
03077 
03078 Return Value:
03079 
03080     None.
03081 
03082 Environment:
03083 
03084     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below <span class="keywordflow">for</span> pagable addresses,
03085                   <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and below <span class="keywordflow">for</span> non-pagable addresses.
03086 
03087 --*/
03088 
03089 {
03090     <span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
03091     <span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03092     <span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03093     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03094     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
03095     KIRQL OldIrql;
03096 
03097     <span class="comment">//</span>
03098     <span class="comment">// Loop on the copy on write case until the page is only</span>
03099     <span class="comment">// writable.</span>
03100     <span class="comment">//</span>
03101 
03102     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
03103     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Address);
03104     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Address);
03105 
03106     *(<span class="keyword">volatile</span> CCHAR *)Address;
03107 
03108     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03109 
03110 <span class="preprocessor">#if defined (_WIN64)</span>
03111 <span class="preprocessor"></span>    <span class="keywordflow">while</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
03112            (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
03113            (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0))
03114 <span class="preprocessor">#else</span>
03115 <span class="preprocessor"></span>    <span class="keywordflow">while</span> ((PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
03116            (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0))
03117 <span class="preprocessor">#endif</span>
03118 <span class="preprocessor"></span>    {
03119 
03120         <span class="comment">//</span>
03121         <span class="comment">// Page is no longer valid.</span>
03122         <span class="comment">//</span>
03123 
03124         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03125         *(<span class="keyword">volatile</span> CCHAR *)Address;
03126         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03127     }
03128 
03129     PteContents = *PointerPte;
03130 
03131     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03132     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
03133 
03134     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
03135                  (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
03136         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
03137         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
03138     }
03139 
03140 <span class="preprocessor">#ifdef NT_UP</span>
03141 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents)) {
03142 <span class="preprocessor">#endif //NT_UP</span>
03143 <span class="preprocessor"></span>        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a113">MI_SET_PTE_CLEAN</a> (PteContents);
03144 
03145         <span class="comment">//</span>
03146         <span class="comment">// Clear the dirty bit in the PTE so new writes can be tracked.</span>
03147         <span class="comment">//</span>
03148 
03149         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (Address,
03150                                FALSE,
03151                                TRUE,
03152                                (PHARDWARE_PTE)PointerPte,
03153                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
03154 <span class="preprocessor">#ifdef NT_UP</span>
03155 <span class="preprocessor"></span>    }
03156 <span class="preprocessor">#endif //NT_UP</span>
03157 <span class="preprocessor"></span>
03158     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03159     <span class="keywordflow">return</span>;
03160 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="mapview.c::MiUnmapViewInSystemSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiUnmapViewInSystemSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Session</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MappedBase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">3683</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02644">LOCK_SYSTEM_VIEW_SPACE</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03893">MiRemoveFromSystemSpace()</a>, <a class="el" href="../../d3/d5/mapview_8c.html#a12">MiRemoveMappedPtes()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02647">UNLOCK_SYSTEM_VIEW_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l04071">MiFreeSessionSpaceMap()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03639">MmUnmapViewInSessionSpace()</a>, and <a class="el" href="../../d4/d4/mapview_8c-source.html#l03608">MmUnmapViewInSystemSpace()</a>.
<p>
<pre class="fragment"><div>03690                    :
03691 
03692     This routine unmaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space.
03693 
03694 Arguments:
03695 
03696     Session - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session data structure <span class="keywordflow">for</span> <span class="keyword">this</span> view.
03697 
03698     MappedBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to unmap.
03699 
03700 Return Value:
03701 
03702     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03703 
03704 Environment:
03705 
03706     Kernel Mode, IRQL of dispatch level.
03707 
03708 --*/
03709 
03710 {
03711     ULONG StartBit;
03712     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03713     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
03714     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> Ws;
03715     KIRQL WsIrql;
03716 
03717     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03718 
03719     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
03720     StartBit =  (ULONG) (((ULONG_PTR)MappedBase - (ULONG_PTR)Session-&gt;SystemSpaceViewStart) &gt;&gt; 16);
03721 
03722     <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
03723 
03724     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a19">MiRemoveFromSystemSpace</a> (Session, MappedBase, &amp;ControlArea);
03725 
03726     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (Session-&gt;SystemSpaceBitMap, StartBit, Size);
03727 
03728     <span class="comment">//</span>
03729     <span class="comment">// Zero PTEs.</span>
03730     <span class="comment">//</span>
03731 
03732     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> * (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03733 
03734     <span class="keywordflow">if</span> (Session == &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03735         Ws = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
03736     }
03737     <span class="keywordflow">else</span> {
03738         Ws = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
03739         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a>(WsIrql);
03740     }
03741 
03742     <a class="code" href="../../d3/d5/mapview_8c.html#a12">MiRemoveMappedPtes</a> (MappedBase, Size, ControlArea, Ws);
03743 
03744     <span class="keywordflow">if</span> (Session != &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03745         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
03746     }
03747 
03748     <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03749 
03750     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03751 
03752     <span class="keywordflow">return</span> STATUS_SUCCESS;
03753 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="mapview.c::MmMapViewInSessionSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmMapViewInSessionSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>MappedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03211">3211</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05575">_MM_SESSION_SPACE::Session</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03219                    :
03220 
03221     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process's
03222     session address space.
03223 
03224 Arguments:
03225 
03226     Section - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section to map.
03227 
03228     *MappedBase - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section was mapped.
03229 
03230     ViewSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to map.  If <span class="keyword">this</span>
03231                <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> whole section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped.
03232                Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size mapped.
03233 
03234 Return Value:
03235 
03236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03237 
03238 Environment:
03239 
03240     Kernel Mode, IRQL of dispatch level.
03241 
03242 --*/
03243 
03244 {
03245     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>  Session;
03246 
03247     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03248 
03249     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03250         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
03251             <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
03252         }
03253         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
03254         Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
03255     }
03256     <span class="keywordflow">else</span> {
03257         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
03258     }
03259 
03260     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a13">MiMapViewInSystemSpace</a> (Section,
03261                                    Session,
03262                                    MappedBase,
03263                                    ViewSize);
03264 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="mapview.c::MmMapViewInSystemSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmMapViewInSystemSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>MappedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03164">3164</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>03172                    :
03173 
03174     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space.
03175 
03176 Arguments:
03177 
03178     Section - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section to map.
03179 
03180     *MappedBase - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section was mapped.
03181 
03182     ViewSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to map.  If <span class="keyword">this</span>
03183                <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> whole section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped.
03184                Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size mapped.
03185 
03186 Return Value:
03187 
03188     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03189 
03190 Environment:
03191 
03192     Kernel Mode, IRQL of dispatch level.
03193 
03194 --*/
03195 
03196 {
03197     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>  Session;
03198 
03199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03200 
03201     Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
03202 
03203     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a13">MiMapViewInSystemSpace</a> (Section,
03204                                    Session,
03205                                    MappedBase,
03206                                    ViewSize);
03207 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="mapview.c::MmMapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmMapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionToMap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CommitSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECTION_INHERIT&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Protect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">753</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02006">_SEGMENT::ImageCommitment</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01090">LOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html#l00043">MiMapViewOfPhysicalSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/ex_8c-source.html#l00278">CommitReadOnlyMemory()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01654">InitMapSharedSection()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02836">MapDesktop()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04868">MiGetWritablePagesInSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00311">NtMapViewOfSuperSection()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00679">PspMapSystemDll()</a>, and <a class="el" href="../../d3/d8/w32_2ntuser_2kernel_2heap_8c-source.html#l00189">UserCreateHeap()</a>.
<p>
<pre class="fragment"><div>00768                    :
00769 
00770     This function maps a view in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified subject process to
00771     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00772 
00773     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a kernel mode interface to allow LPC to map
00774     a section given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section pointer to map.
00775 
00776     This routine assumes all arguments have been probed and captured.
00777 
00778     ********************************************************************
00779     ********************************************************************
00780     ********************************************************************
00781 
00782     NOTE:
00783 
00784     CapturedViewSize, SectionOffset, and CapturedBase must be
00785     captured in non-paged system space (i.e., kernel stack).
00786 
00787     ********************************************************************
00788     ********************************************************************
00789     ********************************************************************
00790 
00791 Arguments:
00792 
00793     SectionToMap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00794 
00795     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object.
00796 
00797     BaseAddress - Supplies a pointer to a variable that will receive
00798          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value
00799          of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view will
00800          be allocated starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span>
00801          address rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next 64kb address
00802          boundary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00803          null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system will determine
00804          where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
00805          specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ZeroBits argument value and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00806          section allocation attributes (i.e. based and
00807          tiled).
00808 
00809     ZeroBits - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> order address bits that
00810          must be zero in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section
00811          view. The value of <span class="keyword">this</span> argument must be less than
00812          21 and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system
00813          determines where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view (i.e. when
00814          BaseAddress is null).
00815 
00816     CommitSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initially committed region
00817          of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes. This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to
00818          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00819 
00820     SectionOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00821          section to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes. This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00822          rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00823 
00824     ViewSize - Supplies a pointer to a variable that will receive
00825          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
00826          of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then a view of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00827          section will be mapped starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00828          section offset and continuing to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00829          section. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span>
00830          argument specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes
00831          and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size
00832          boundary.
00833 
00834     InheritDisposition - Supplies a value that specifies how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00835          view <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be shared by a child process created
00836          with a create process operation.
00837 
00838     AllocationType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of allocation.
00839 
00840     Protect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection desired <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region of
00841          initially committed pages.
00842 
00843 Return Value:
00844 
00845     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00846 
00847     TBS
00848 
00849 
00850 --*/
00851 {
00852     BOOLEAN Attached;
00853     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00854     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00855     ULONG ProtectionMask;
00856     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00857     BOOLEAN ReleasedWsMutex;
00858     BOOLEAN WriteCombined;
00859     SIZE_T ImageCommitment;
00860 
00861     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00862 
00863     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00864     ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00865 
00866     Section = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap;
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">// Check to make sure the section is not smaller than the view size.</span>
00870     <span class="comment">//</span>
00871 
00872     <span class="keywordflow">if</span> ((LONGLONG)*CapturedViewSize &gt; Section-&gt;SizeOfSection.QuadPart) {
00873         <span class="keywordflow">if</span> ((AllocationType &amp; MEM_RESERVE) == 0) {
00874             <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
00875         }
00876     }
00877 
00878     <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
00879         <span class="keywordflow">if</span> (((Section-&gt;InitialPageProtection &amp; PAGE_READWRITE) |
00880             (Section-&gt;InitialPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
00881 
00882             <span class="keywordflow">return</span> STATUS_SECTION_PROTECTION;
00883         }
00884     }
00885 
00886     <span class="keywordflow">if</span> (Section-&gt;u.Flags.NoCache) {
00887         Protect |= PAGE_NOCACHE;
00888     }
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Note that write combining is only relevant to physical memory sections</span>
00892     <span class="comment">// because they are never trimmed - the write combining bits in a PTE entry</span>
00893     <span class="comment">// are not preserved across trims.</span>
00894     <span class="comment">//</span>
00895 
00896     <span class="keywordflow">if</span> (Protect &amp; PAGE_WRITECOMBINE) {
00897         Protect &amp;= ~PAGE_WRITECOMBINE;
00898         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00899     }
00900     <span class="keywordflow">else</span> {
00901         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00902     }
00903 
00904     <span class="comment">//</span>
00905     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00906     <span class="comment">//</span>
00907 
00908     <span class="keywordflow">try</span> {
00909         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (Protect);
00910     } except (EXCEPTION_EXECUTE_HANDLER) {
00911         <span class="keywordflow">return</span> GetExceptionCode();
00912     }
00913 
00914     ControlArea = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00915     ImageCommitment = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o5">ImageCommitment</a>;
00916 
00917     <span class="comment">//</span>
00918     <span class="comment">// If the specified process is not the current process, attach</span>
00919     <span class="comment">// to the specified process.</span>
00920     <span class="comment">//</span>
00921 
00922     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00923         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00924         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00925     }
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">// Get the address creation mutex to block multiple threads</span>
00929     <span class="comment">// creating or deleting address space at the same time.</span>
00930     <span class="comment">//</span>
00931 
00932     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00936     <span class="comment">//</span>
00937 
00938     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00939         status = STATUS_PROCESS_IS_TERMINATING;
00940         <span class="keywordflow">goto</span> ErrorReturn;
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Map the view base on the type.</span>
00945     <span class="comment">//</span>
00946 
00947     ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00948 
00949     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.PhysicalMemory) {
00950 
00951         <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
00952         status = <a class="code" href="../../d4/d8/mi_8h.html#a913">MiMapViewOfPhysicalSection</a> (ControlArea,
00953                                              Process,
00954                                              CapturedBase,
00955                                              SectionOffset,
00956                                              CapturedViewSize,
00957                                              ProtectionMask,
00958                                              ZeroBits,
00959                                              AllocationType,
00960                                              WriteCombined,
00961                                              &amp;ReleasedWsMutex);
00962         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00963 
00964     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) {
00965         <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
00966             status = STATUS_INVALID_PARAMETER_9;
00967         }
00968         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00969             status = STATUS_INVALID_PARAMETER_10;
00970         } <span class="keywordflow">else</span> {
00971 
00972             status = <a class="code" href="../../d3/d5/mapview_8c.html#a23">MiMapViewOfImageSection</a> (ControlArea,
00973                                               Process,
00974                                               CapturedBase,
00975                                               SectionOffset,
00976                                               CapturedViewSize,
00977                                               Section,
00978                                               InheritDisposition,
00979                                               ZeroBits,
00980                                               ImageCommitment,
00981                                               &amp;ReleasedWsMutex);
00982         }
00983 
00984     } <span class="keywordflow">else</span> {
00985 
00986         <span class="comment">//</span>
00987         <span class="comment">// Not an image section, therefore it is a data section.</span>
00988         <span class="comment">//</span>
00989 
00990         <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00991             status = STATUS_INVALID_PARAMETER_10;
00992         }
00993         <span class="keywordflow">else</span> {
00994             status = <a class="code" href="../../d3/d5/mapview_8c.html#a24">MiMapViewOfDataSection</a> (ControlArea,
00995                                          Process,
00996                                          CapturedBase,
00997                                          SectionOffset,
00998                                          CapturedViewSize,
00999                                          Section,
01000                                          InheritDisposition,
01001                                          ProtectionMask,
01002                                          CommitSize,
01003                                          ZeroBits,
01004                                          AllocationType,
01005                                          &amp;ReleasedWsMutex
01006                                         );
01007         }
01008     }
01009 
01010 ErrorReturn:
01011     <span class="keywordflow">if</span> (!ReleasedWsMutex) {
01012         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01013     }
01014     <span class="keywordflow">else</span> {
01015         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
01016     }
01017 
01018     <span class="keywordflow">if</span> (Attached) {
01019         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01020     }
01021 
01022     <span class="keywordflow">return</span> status;
01023 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="mapview.c::MmSecureVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE MmSecureVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProbeMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l04177">4177</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02379">_MMSECURE_ENTRY::EndVpn</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02387">_MMVAD::LeftChild</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02380">_MMSECURE_ENTRY::List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01090">LOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d4/d8/mi_8h.html#a775">MiInsertConflictInList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02721">MiPhysicalViewAdjuster()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00139">MM_EXECUTE_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00140">MM_EXECUTE_WRITECOPY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00145">MM_NOACCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a487">MMSECURE_ENTRY</a>, <a class="el" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00030">MMVADKEY</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02386">_MMVAD::Parent</a>, <a class="el" href="../../d4/d8/mi_8h.html#a488">PMMSECURE_ENTRY</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02388">_MMVAD::RightChild</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02378">_MMSECURE_ENTRY::StartVpn</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">_MMSECURE_ENTRY::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o16">_MMVAD::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00257">_EPROCESS::VadFreeHint</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00228">_EPROCESS::VadHint</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00227">_EPROCESS::VadRoot</a>.
<p>
<pre class="fragment"><div>04185                    :
04186 
04187     This routine probes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested address range and protects
04188     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range from having its protection <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
04189     more restricted and being deleted.
04190 
04191     <a class="code" href="../../d2/d1/mm_8h.html#a314">MmUnsecureVirtualMemory</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range to <span class="keywordflow">return</span>
04192     to a normal state.
04193 
04194 Arguments:
04195 
04196     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address to probe and secure.
04197 
04198     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range to secure.
04199 
04200     ProbeMode - Supplies one of PAGE_READONLY or PAGE_READWRITE.
04201 
04202 Return Value:
04203 
04204     Returns a handle to be used to unsecure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
04205     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range could not be locked because of protection
04206     problems or noncommitted memory, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value (HANDLE)0
04207     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
04208 
04209 Environment:
04210 
04211     Kernel Mode.
04212 
04213 --*/
04214 
04215 {
04216     ULONG_PTR EndAddress;
04217     PVOID StartAddress;
04218     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Temp;
04219     ULONG Probe;
04220     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04221     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
04222     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NewVad;
04223     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Secure;
04224     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04225     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
04226     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
04227     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04228     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
04229     <a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">MMLOCK_CONFLICT</a> Conflict;
04230     ULONG Waited;
04231 
04232     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04233 
04234     <span class="keywordflow">if</span> ((ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; (ULONG_PTR)MM_HIGHEST_USER_ADDRESS || (ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt;= (ULONG_PTR)Address) {
04235         <span class="keywordflow">return</span> (HANDLE)0;
04236     }
04237 
04238     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)0;
04239 
04240     Probe = (ProbeMode == PAGE_READONLY);
04241 
04242     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04243     StartAddress = Address;
04244 
04245     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
04246 
04247     <span class="comment">//</span>
04248     <span class="comment">// Check for a private committed VAD first instead of probing to avoid all</span>
04249     <span class="comment">// the page faults and zeroing.  If we find one, then we run the PTEs</span>
04250     <span class="comment">// instead.</span>
04251     <span class="comment">//</span>
04252 
04253     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt;= 64 * 1024) {
04254         EndAddress = (ULONG_PTR)StartAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04255         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (StartAddress);
04256 
04257         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04258             <span class="keywordflow">goto</span> Return1;
04259         }
04260 
04261         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
04262             <span class="keywordflow">goto</span> Return1;
04263         }
04264 
04265         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.MemCommit == 0) {
04266             <span class="keywordflow">goto</span> LongWay;
04267         }
04268 
04269         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0) {
04270             <span class="keywordflow">goto</span> LongWay;
04271         }
04272 
04273         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) {
04274             <span class="keywordflow">goto</span> LongWay;
04275         }
04276 
04277         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection);
04278 
04279         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartAddress) &lt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
04280             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndAddress) &gt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
04281             <span class="keywordflow">goto</span> Return1;
04282         }
04283 
04284         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
04285             <span class="keywordflow">goto</span> LongWay;
04286         }
04287 
04288         <span class="keywordflow">if</span> (ProbeMode == PAGE_READONLY) {
04289             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection &gt; <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>) {
04290                 <span class="keywordflow">goto</span> LongWay;
04291             }
04292         }
04293         <span class="keywordflow">else</span> {
04294             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a> &amp;&amp;
04295                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>) {
04296                     <span class="keywordflow">goto</span> LongWay;
04297             }
04298         }
04299 
04300         <span class="comment">//</span>
04301         <span class="comment">// Check individual page permissions.</span>
04302         <span class="comment">//</span>
04303 
04304         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartAddress);
04305         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04306         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartAddress);
04307         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndAddress);
04308 
04309         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
04310 
04311         <span class="keywordflow">do</span> {
04312 
04313             <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
04314                                                Process,
04315                                                FALSE,
04316                                                &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04317                 <span class="comment">//</span>
04318                 <span class="comment">// Page directory parent entry is empty, go to the next one.</span>
04319                 <span class="comment">//</span>
04320 
04321                 PointerPpe += 1;
04322                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
04323                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04324                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04325                     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04326                     <span class="keywordflow">goto</span> EditVad;
04327                 }
04328             }
04329 
04330             Waited = 0;
04331 
04332             <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
04333                                                Process,
04334                                                FALSE,
04335                                                &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04336                 <span class="comment">//</span>
04337                 <span class="comment">// This page directory entry is empty, go to the next one.</span>
04338                 <span class="comment">//</span>
04339 
04340                 PointerPde += 1;
04341                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04342                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04343                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04344                     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04345                     <span class="keywordflow">goto</span> EditVad;
04346                 }
04347 <span class="preprocessor">#if defined (_WIN64)</span>
04348 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
04349                     Waited = 1;
04350                     <span class="keywordflow">break</span>;
04351                 }
04352 <span class="preprocessor">#endif</span>
04353 <span class="preprocessor"></span>            }
04354 
04355         } <span class="keywordflow">while</span> (Waited != 0);
04356 
04357         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
04358 
04359             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
04360 
04361                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
04362                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04363 
04364                 <span class="keywordflow">do</span> {
04365 
04366                     <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
04367                                                        Process,
04368                                                        FALSE,
04369                                                        &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04370                         <span class="comment">//</span>
04371                         <span class="comment">// Page directory parent entry is empty, go to the next one.</span>
04372                         <span class="comment">//</span>
04373 
04374                         PointerPpe += 1;
04375                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
04376                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04377 
04378                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04379                             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04380                             <span class="keywordflow">goto</span> EditVad;
04381                         }
04382                     }
04383 
04384                     Waited = 0;
04385 
04386                     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
04387                                                        Process,
04388                                                        FALSE,
04389                                                        &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04390                         <span class="comment">//</span>
04391                         <span class="comment">// This page directory entry is empty, go to the next one.</span>
04392                         <span class="comment">//</span>
04393 
04394                         PointerPde += 1;
04395                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04396                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04397                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04398                             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04399                             <span class="keywordflow">goto</span> EditVad;
04400                         }
04401 <span class="preprocessor">#if defined (_WIN64)</span>
04402 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
04403                             Waited = 1;
04404                             <span class="keywordflow">break</span>;
04405                         }
04406 <span class="preprocessor">#endif</span>
04407 <span class="preprocessor"></span>                    }
04408 
04409                 } <span class="keywordflow">while</span> (Waited != 0);
04410             }
04411             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
04412                 <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04413                 <span class="keywordflow">goto</span> LongWay;
04414             }
04415             PointerPte += 1;
04416         }
04417         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04418     }
04419     <span class="keywordflow">else</span> {
04420 LongWay:
04421 
04422         <a class="code" href="../../d4/d8/mi_8h.html#a775">MiInsertConflictInList</a> (&amp;Conflict);
04423 
04424         <span class="keywordflow">try</span> {
04425 
04426             <span class="keywordflow">if</span> (ProbeMode == PAGE_READONLY) {
04427 
04428                 EndAddress = (ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04429                 EndAddress = (EndAddress &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
04430 
04431                 <span class="keywordflow">do</span> {
04432                     Temp = *(<span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *)Address;
04433                     Address = (PVOID)(((ULONG_PTR)Address &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04434                 } <span class="keywordflow">while</span> ((ULONG_PTR)Address != EndAddress);
04435             } <span class="keywordflow">else</span> {
04436                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (Address, (ULONG)Size, 1); <span class="comment">// ****** temp ******</span>
04437             }
04438 
04439         } except (EXCEPTION_EXECUTE_HANDLER) {
04440             <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (&amp;Conflict);
04441             <span class="keywordflow">goto</span> Return1;
04442         }
04443 
04444         <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (&amp;Conflict);
04445 
04446         <span class="comment">//</span>
04447         <span class="comment">// Locate VAD and add in secure descriptor.</span>
04448         <span class="comment">//</span>
04449 
04450         EndAddress = (ULONG_PTR)StartAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04451         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (StartAddress);
04452 
04453         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04454             <span class="keywordflow">goto</span> Return1;
04455         }
04456 
04457         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
04458             <span class="keywordflow">goto</span> Return1;
04459         }
04460 
04461         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartAddress) &lt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
04462             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndAddress) &gt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
04463 
04464             <span class="comment">//</span>
04465             <span class="comment">// Not within the section virtual address descriptor,</span>
04466             <span class="comment">// return an error.</span>
04467             <span class="comment">//</span>
04468 
04469             <span class="keywordflow">goto</span> Return1;
04470         }
04471     }
04472 
04473 EditVad:
04474 
04475     <span class="comment">//</span>
04476     <span class="comment">// If this is a short VAD, it needs to be reallocated as a large</span>
04477     <span class="comment">// VAD.</span>
04478     <span class="comment">//</span>
04479 
04480     <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory) &amp;&amp; (!Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange)) {
04481 
04482         NewVad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04483                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>),
04484                                         MMVADKEY);
04485         <span class="keywordflow">if</span> (NewVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04486             <span class="keywordflow">goto</span> Return1;
04487         }
04488 
04489         RtlZeroMemory (NewVad, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
04490         RtlCopyMemory (NewVad, Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">MMVAD_SHORT</a>));
04491         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
04492         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 1;
04493         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 1;
04494         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ReadOnly = Probe;
04495         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn = (ULONG_PTR)StartAddress;
04496         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn = EndAddress;
04497 
04498         <span class="comment">//</span>
04499         <span class="comment">// Replace the current VAD with this expanded VAD.</span>
04500         <span class="comment">//</span>
04501 
04502         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
04503         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>) {
04504             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a> == Vad) {
04505                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a> = NewVad;
04506             } <span class="keywordflow">else</span> {
04507                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a> == Vad);
04508                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a> = NewVad;
04509             }
04510         } <span class="keywordflow">else</span> {
04511             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a> = NewVad;
04512         }
04513         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a>) {
04514             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a> = NewVad;
04515         }
04516         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a>) {
04517             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a> = NewVad;
04518         }
04519         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> == Vad) {
04520             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = NewVad;
04521         }
04522         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> == Vad) {
04523             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> = NewVad;
04524         }
04525 
04526         <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) ||
04527             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.WriteWatch == 1)) {
04528 
04529             <a class="code" href="../../d4/d8/mi_8h.html#a894">MiPhysicalViewAdjuster</a> (Process, Vad, NewVad);
04530         }
04531 
04532         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04533         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
04534         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)&amp;NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2;
04535         <span class="keywordflow">goto</span> Return1;
04536     }
04537 
04538     <span class="comment">//</span>
04539     <span class="comment">// This is already a large VAD, add the secure entry.</span>
04540     <span class="comment">//</span>
04541 
04542     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) {
04543 
04544         <span class="comment">//</span>
04545         <span class="comment">// This VAD already is secured.  Move the info out of the</span>
04546         <span class="comment">// block into pool.</span>
04547         <span class="comment">//</span>
04548 
04549         Secure = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04550                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>),
04551                                         'eSmM');
04552         <span class="keywordflow">if</span> (Secure == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04553             <span class="keywordflow">goto</span> Return1;
04554         }
04555 
04556         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1);
04557         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 0;
04558         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured = 1;
04559         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.LongFlags2 = (ULONG) Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags;
04560         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.StoredInVad = 0;
04561         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a> = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn;
04562         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">EndVpn</a> = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn;
04563 
04564         InitializeListHead (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List);
04565         InsertTailList (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List,
04566                         &amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04567     }
04568 
04569     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured) {
04570 
04571         <span class="comment">//</span>
04572         <span class="comment">// This VAD already has a secured element in its list, allocate and</span>
04573         <span class="comment">// add in the new secured element.</span>
04574         <span class="comment">//</span>
04575 
04576         Secure = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04577                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>),
04578                                         'eSmM');
04579         <span class="keywordflow">if</span> (Secure == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04580             <span class="keywordflow">goto</span> Return1;
04581         }
04582 
04583         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.LongFlags2 = 0;
04584         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.ReadOnly = Probe;
04585         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a> = (ULONG_PTR)StartAddress;
04586         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">EndVpn</a> = EndAddress;
04587 
04588         InsertTailList (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List,
04589                         &amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04590         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)Secure;
04591 
04592     } <span class="keywordflow">else</span> {
04593 
04594         <span class="comment">//</span>
04595         <span class="comment">// This list does not have a secure element.  Put it in the VAD.</span>
04596         <span class="comment">//</span>
04597 
04598         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
04599         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 1;
04600         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 1;
04601         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ReadOnly = Probe;
04602         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn = (ULONG_PTR)StartAddress;
04603         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn = EndAddress;
04604         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2;
04605     }
04606 
04607 Return1:
04608     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
04609     <span class="keywordflow">return</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04610 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="mapview.c::MmUnmapViewInSessionSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmUnmapViewInSessionSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MappedBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03639">3639</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05575">_MM_SESSION_SPACE::Session</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03645                    :
03646 
03647     This routine unmaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space.
03648 
03649 Arguments:
03650 
03651     MappedBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to unmap.
03652 
03653 Return Value:
03654 
03655     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03656 
03657 Environment:
03658 
03659     Kernel Mode, IRQL of dispatch level.
03660 
03661 --*/
03662 
03663 {
03664     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
03665 
03666     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03667 
03668     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03669         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
03670             <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
03671         }
03672         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
03673         Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
03674     }
03675     <span class="keywordflow">else</span> {
03676         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
03677     }
03678 
03679     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (Session, MappedBase);
03680 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="mapview.c::MmUnmapViewInSystemSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmUnmapViewInSystemSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MappedBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03608">3608</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>03614                    :
03615 
03616     This routine unmaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space.
03617 
03618 Arguments:
03619 
03620     MappedBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to unmap.
03621 
03622 Return Value:
03623 
03624     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03625 
03626 Environment:
03627 
03628     Kernel Mode, IRQL of dispatch level.
03629 
03630 --*/
03631 
03632 {
03633     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03634 
03635     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (&amp;MmSession, MappedBase);
03636 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="mapview.c::MmUnsecureVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmUnsecureVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecureHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l04614">4614</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02380">_MMSECURE_ENTRY::List</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01090">LOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02375">_MMSECURE_ENTRY::LongFlags2</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02378">_MMSECURE_ENTRY::StartVpn</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">_MMSECURE_ENTRY::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o16">_MMVAD::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>.
<p>
<pre class="fragment"><div>04620                    :
04621 
04622     This routine unsecures memory previous secured via a call to
04623     <a class="code" href="../../d2/d1/mm_8h.html#a313">MmSecureVirtualMemory</a>.
04624 
04625 Arguments:
04626 
04627     SecureHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle returned in <a class="code" href="../../d2/d1/mm_8h.html#a313">MmSecureVirtualMemory</a>.
04628 
04629 Return Value:
04630 
04631     None.
04632 
04633 Environment:
04634 
04635     Kernel Mode.
04636 
04637 --*/
04638 
04639 {
04640     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Secure;
04641     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04642     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
04643 
04644     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04645 
04646     Secure = (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)SecureHandle;
04647     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
04648     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
04649 
04650     <span class="keywordflow">if</span> (Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.StoredInVad) {
04651         Vad = CONTAINING_RECORD( Secure,
04652                                  <a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>,
04653                                  u2.LongFlags2);
04654     } <span class="keywordflow">else</span> {
04655         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> ((PVOID)Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a>);
04656     }
04657 
04658     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad);
04659     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1);
04660 
04661     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) {
04662         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Secure == (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2);
04663         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 0;
04664         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured == 0);
04665         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange == 0) {
04666 
04667             <span class="comment">//</span>
04668             <span class="comment">// No more secure entries in this list, remove the state.</span>
04669             <span class="comment">//</span>
04670 
04671             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
04672         }
04673     } <span class="keywordflow">else</span> {
04674         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured == 1);
04675 
04676         <span class="keywordflow">if</span> (Secure == (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2) {
04677 
04678             <span class="comment">//</span>
04679             <span class="comment">// This was a single block that got converted into a list.</span>
04680             <span class="comment">// Reset the entry.</span>
04681             <span class="comment">//</span>
04682 
04683             Secure = CONTAINING_RECORD (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List.Flink,
04684                                         <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
04685                                         List);
04686         }
04687         RemoveEntryList (&amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04688         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Secure);
04689         <span class="keywordflow">if</span> (IsListEmpty (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List)) {
04690 
04691             <span class="comment">//</span>
04692             <span class="comment">// No more secure entries, reset the state.</span>
04693             <span class="comment">//</span>
04694 
04695             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured = 0;
04696 
04697             <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange == 0) &amp;&amp;
04698                (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0)) {
04699 
04700                 <span class="comment">//</span>
04701                 <span class="comment">// No more secure entries in this list, remove the state</span>
04702                 <span class="comment">// if and only if this VAD is not private.  If this VAD</span>
04703                 <span class="comment">// is private, removing the state NoChange flag indicates</span>
04704                 <span class="comment">// that this is a short VAD which it no longer is.</span>
04705                 <span class="comment">//</span>
04706 
04707                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
04708             }
04709         }
04710     }
04711 
04712     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
04713     <span class="keywordflow">return</span>;
04714 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="mapview.c::NtAreMappedFilesTheSame" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI NTSTATUS NTAPI NtAreMappedFilesTheSame           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>File1MappedAsAnImage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>File2MappedAsFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l02965">2965</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01473">_SECTION_OBJECT_POINTERS::ImageSectionObject</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01090">LOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01521">_FILE_OBJECT::SectionObjectPointer</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>.
<p>
<pre class="fragment"><div>02972                    :
02973 
02974     This routine compares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two files mapped at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
02975     addresses to see <span class="keywordflow">if</span> they are both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02976 
02977 Arguments:
02978 
02979     File1MappedAsAnImage - Supplies an address within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which
02980         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped as an image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02981 
02982     File2MappedAsFile - Supplies an address within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which
02983         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped as either an image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or a data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02984 
02985 Return Value:
02986 
02987 
02988     STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two files are <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
02989 
02990     STATUS_NOT_SAME_DEVICE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> files are different.
02991 
02992     Other status values can be returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> addresses are not mapped as
02993     files, etc.
02994 
02995 Environment:
02996 
02997     User mode callable system service.
02998 
02999 --*/
03000 
03001 {
03002     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad1;
03003     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad2;
03004     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03005 
03006     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
03007     FoundVad1 = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (File1MappedAsAnImage);
03008     FoundVad2 = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (File2MappedAsFile);
03009 
03010     <span class="keywordflow">if</span> ((FoundVad1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03011         (FoundVad2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03012 
03013         <span class="comment">//</span>
03014         <span class="comment">// No virtual address is allocated at the specified base address,</span>
03015         <span class="comment">// return an error.</span>
03016         <span class="comment">//</span>
03017 
03018         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_ADDRESS;
03019         <span class="keywordflow">goto</span> ErrorReturn;
03020     }
03021 
03022     <span class="comment">//</span>
03023     <span class="comment">// Check file names.</span>
03024     <span class="comment">//</span>
03025 
03026     <span class="keywordflow">if</span> ((FoundVad1-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1) ||
03027         (FoundVad2-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1)) {
03028         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
03029         <span class="keywordflow">goto</span> ErrorReturn;
03030     }
03031 
03032     <span class="keywordflow">if</span> ((FoundVad1-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03033         (FoundVad2-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03034         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
03035         <span class="keywordflow">goto</span> ErrorReturn;
03036     }
03037 
03038     <span class="keywordflow">if</span> ((FoundVad1-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03039         (FoundVad2-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03040         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
03041         <span class="keywordflow">goto</span> ErrorReturn;
03042     }
03043 
03044     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SAME_DEVICE;
03045 
03046     <span class="keywordflow">if</span> ((PVOID)FoundVad1-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> ==
03047             FoundVad2-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a>-&gt;<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o2">ImageSectionObject</a>) {
03048         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03049     }
03050 
03051 ErrorReturn:
03052 
03053     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
03054     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03055 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="mapview.c::NtMapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtMapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CommitSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER SectionOffset&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECTION_INHERIT&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Protect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">199</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00586">DbgkMapViewOfSection()</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00139">MiIsProtectionCompatible()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00189">MM_DBG_SHOW_NT_CALLS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00096">MM_HIGHEST_VAD_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00133">MM_MAXIMUM_ZERO_BITS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00132">MM_USER_ADDRESS_RANGE_LIMIT</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00203">MmMakeSectionAccess</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03164">MmMapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">MmSectionObjectType</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03608">MmUnmapViewInSystemSpace()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01598">ProbeForWritePointer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01666">ProbeForWriteUlong_ptr</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02923">RtlFindMostSignificantBit()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01128">ZERO_LARGE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00027">CreateConsoleBitmap()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01563">LdrLoadAlternateResourceModule()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01069">LdrVerifyImageMatchesChecksum()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01407">MapViewOfSection()</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00164">NapCreateDataSection()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00287">PropertiesDlgShow()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00459">PropertiesUpdate()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00316">RtlCreateQueryDebugBuffer()</a>, and <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00099">RtlpChangeQueryDebugBufferTarget()</a>.
<p>
<pre class="fragment"><div>00214                    :
00215 
00216     This function maps a view in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified subject process to
00217     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00218 
00219 Arguments:
00220 
00221     SectionHandle - Supplies an open handle to a section object.
00222 
00223     ProcessHandle - Supplies an open handle to a process object.
00224 
00225     BaseAddress - Supplies a pointer to a variable that will receive
00226                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value
00227                   of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view will
00228                   be allocated starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span>
00229                   address rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next 64kb address
00230                   boundary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00231                   null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system will determine
00232                   where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
00233                   specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ZeroBits argument value and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00234                   section allocation attributes (i.e. based and
00235                   tiled).
00236         
00237     ZeroBits - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> order address bits that
00238                must be zero in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section
00239                view. The value of <span class="keyword">this</span> argument must be less than
00240                or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number of zero bits and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
00241                used when memory management determines where to allocate
00242                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view (i.e. when BaseAddress is null).
00243         
00244                If ZeroBits <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then no zero bit constraints are applied.
00245 
00246                If ZeroBits <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than 0 and less than 32, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00247                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of leading zero bits from bit 31.  Bits 63:32 are
00248                also required to be zero.  This retains compatibility
00249                with 32-bit systems.
00250                 
00251                If ZeroBits <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than 32, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> considered as
00252                a mask and then number of leading zero are counted <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>
00253                in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask.  This then becomes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zero bits argument.
00254 
00255     CommitSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initially committed region
00256                  of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes. This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to
00257                  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00258 
00259     SectionOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00260                     section to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes. This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00261                     rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00262 
00263     ViewSize - Supplies a pointer to a variable that will receive
00264                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
00265                of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then a view of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00266                section will be mapped starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00267                section offset and continuing to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00268                section. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span>
00269                argument specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes
00270                and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size
00271                boundary.
00272         
00273     InheritDisposition - Supplies a value that specifies how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00274                          view <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be shared by a child process created
00275                          with a create process operation.
00276 
00277         InheritDisposition Values
00278 
00279          ViewShare - Inherit view and share a single copy
00280               of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed pages with a child process
00281               <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current protection value.
00282 
00283          ViewUnmap - Do not map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view into a child process.
00284 
00285     AllocationType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of allocation.
00286 
00287          MEM_TOP_DOWN
00288          MEM_DOS_LIM
00289          MEM_LARGE_PAGES
00290          MEM_RESERVE - <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> mapped sections <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
00291 
00292     Protect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection desired <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region of
00293               initially committed pages.
00294 
00295         Protect Values
00296 
00297 
00298          PAGE_NOACCESS - No access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region
00299               of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An attempt to read,
00300               write, or execute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region
00301               results in an access violation (i.e. a GP
00302               fault).
00303 
00304          PAGE_EXECUTE - Execute access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed
00305               region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An attempt to
00306               read or write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region results in
00307               an access violation.
00308 
00309          PAGE_READONLY - Read <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> and execute access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00310               committed region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An
00311               attempt to write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region results
00312               in an access violation.
00313 
00314          PAGE_READWRITE - Read, write, and execute access to
00315               <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region of committed pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. If
00316               write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00317               allowed, then a single copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are
00318               shared. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are shared read
00319               <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>/copy on write.
00320 
00321 Return Value:
00322 
00323     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> codes.
00324 
00325 --*/
00326 
00327 {
00328     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00329     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00330     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00331     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00332     PVOID CapturedBase;
00333     SIZE_T CapturedViewSize;
00334     LARGE_INTEGER TempViewSize;
00335     LARGE_INTEGER CapturedOffset;
00336     ULONGLONG HighestPhysicalAddressInPfnDatabase;
00337     ACCESS_MASK DesiredSectionAccess;
00338     ULONG ProtectMaskForAccess;
00339     BOOLEAN WriteCombined;
00340 
00341     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Check the zero bits argument for correctness.</span>
00345     <span class="comment">//</span>
00346 
00347 <span class="preprocessor">#if defined (_WIN64)</span>
00348 <span class="preprocessor"></span>
00349     <span class="keywordflow">if</span> (ZeroBits &gt;= 32) {
00350 
00351         <span class="comment">//</span>
00352         <span class="comment">// ZeroBits is a mask instead of a count.  Translate it to a count now.</span>
00353         <span class="comment">//</span>
00354 
00355         ZeroBits = 64 - <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a44">RtlFindMostSignificantBit</a> (ZeroBits);        
00356     }
00357     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ZeroBits) {
00358         ZeroBits += 32;
00359     }
00360 
00361 <span class="preprocessor">#endif</span>
00362 <span class="preprocessor"></span>
00363     <span class="keywordflow">if</span> (ZeroBits &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a10">MM_MAXIMUM_ZERO_BITS</a>) {
00364         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00365     }
00366 
00367     <span class="comment">//</span>
00368     <span class="comment">// Check the inherit disposition flags.</span>
00369     <span class="comment">//</span>
00370 
00371     <span class="keywordflow">if</span> ((InheritDisposition &gt; ViewUnmap) ||
00372         (InheritDisposition &lt; ViewShare)) {
00373         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_8;
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Check the allocation type field.</span>
00378     <span class="comment">//</span>
00379 
00380 <span class="preprocessor">#ifdef i386</span>
00381 <span class="preprocessor"></span>
00382     <span class="comment">//</span>
00383     <span class="comment">// Only allow DOS_LIM support for i386.  The MEM_DOS_LIM flag allows</span>
00384     <span class="comment">// map views of data sections to be done on 4k boundaries rather</span>
00385     <span class="comment">// than 64k boundaries.</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> ((AllocationType &amp; ~(MEM_TOP_DOWN | MEM_LARGE_PAGES | MEM_DOS_LIM |
00389            SEC_NO_CHANGE | MEM_RESERVE)) != 0) {
00390         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
00391     }
00392 <span class="preprocessor">#else</span>
00393 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((AllocationType &amp; ~(MEM_TOP_DOWN | MEM_LARGE_PAGES |
00394            SEC_NO_CHANGE | MEM_RESERVE)) != 0) {
00395         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
00396     }
00397 
00398 <span class="preprocessor">#endif //i386</span>
00399 <span class="preprocessor"></span>
00400     <span class="comment">//</span>
00401     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00402     <span class="comment">//</span>
00403 
00404     <span class="keywordflow">if</span> (Protect &amp; PAGE_WRITECOMBINE) {
00405         Protect &amp;= ~PAGE_WRITECOMBINE;
00406         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00407     }
00408     <span class="keywordflow">else</span> {
00409         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00410     }
00411 
00412     <span class="keywordflow">try</span> {
00413         ProtectMaskForAccess = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (Protect) &amp; 0x7;
00414     } except (EXCEPTION_EXECUTE_HANDLER) {
00415         <span class="keywordflow">return</span> GetExceptionCode();
00416     }
00417 
00418     DesiredSectionAccess = <a class="code" href="../../d4/d8/mi_8h.html#a414">MmMakeSectionAccess</a>[ProtectMaskForAccess];
00419 
00420     PreviousMode = KeGetPreviousMode();
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Establish an exception handler, probe the specified addresses</span>
00424     <span class="comment">// for write access and capture the initial values.</span>
00425     <span class="comment">//</span>
00426 
00427     <span class="keywordflow">try</span> {
00428         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00429             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> ((PULONG)BaseAddress);
00430             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (ViewSize);
00431 
00432         }
00433 
00434         <span class="keywordflow">if</span> (ARGUMENT_PRESENT (SectionOffset)) {
00435             <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00436                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (SectionOffset,
00437                                <span class="keyword">sizeof</span>(LARGE_INTEGER),
00438                                <span class="keyword">sizeof</span>(ULONG_PTR));
00439             }
00440             CapturedOffset = *SectionOffset;
00441         } <span class="keywordflow">else</span> {
00442             <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (CapturedOffset);
00443         }
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">// Capture the base address.</span>
00447         <span class="comment">//</span>
00448 
00449         CapturedBase = *BaseAddress;
00450 
00451         <span class="comment">//</span>
00452         <span class="comment">// Capture the region size.</span>
00453         <span class="comment">//</span>
00454 
00455         CapturedViewSize = *ViewSize;
00456 
00457     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">// If an exception occurs during the probe or capture</span>
00461         <span class="comment">// of the initial values, then handle the exception and</span>
00462         <span class="comment">// return the exception code as the status value.</span>
00463         <span class="comment">//</span>
00464 
00465         <span class="keywordflow">return</span> GetExceptionCode();
00466     }
00467 
00468 <span class="preprocessor">#if DBG</span>
00469 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00470         <span class="keywordflow">if</span> ( !MmWatchProcess ) {
00471             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"mapview process handle %lx section %lx base address %p zero bits %lx\n"</span>,
00472                 ProcessHandle, SectionHandle, CapturedBase, ZeroBits);
00473             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    view size %p offset %p commitsize %p  protect %lx\n"</span>,
00474                 CapturedViewSize, CapturedOffset, CommitSize, Protect);
00475             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    Inheritdisp %lx  Allocation type %lx\n"</span>,
00476                 InheritDisposition, AllocationType);
00477         }
00478     }
00479 <span class="preprocessor">#endif</span>
00480 <span class="preprocessor"></span>
00481     <span class="comment">//</span>
00482     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00483     <span class="comment">// within the user part of the virtual address space.</span>
00484     <span class="comment">//</span>
00485 
00486     <span class="keywordflow">if</span> (CapturedBase &gt; <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) {
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Invalid base address.</span>
00490         <span class="comment">//</span>
00491 
00492         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00493     }
00494 
00495     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> - (ULONG_PTR)CapturedBase) &lt;
00496                                                         CapturedViewSize) {
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// Invalid region size;</span>
00500         <span class="comment">//</span>
00501 
00502         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00503 
00504     }
00505 
00506     <span class="keywordflow">if</span> (((ULONG_PTR)CapturedBase + CapturedViewSize) &gt; ((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a9">MM_USER_ADDRESS_RANGE_LIMIT</a> &gt;&gt; ZeroBits)) {
00507 
00508         <span class="comment">//</span>
00509         <span class="comment">// Desired Base and zero_bits conflict.</span>
00510         <span class="comment">//</span>
00511 
00512         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00513     }
00514 
00515     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00516                                          PROCESS_VM_OPERATION,
00517                                          PsProcessType,
00518                                          PreviousMode,
00519                                          (PVOID *)&amp;Process,
00520                                          NULL );
00521     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00522         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00523     }
00524 
00525     <span class="comment">//</span>
00526     <span class="comment">// Reference the section object, if a view is mapped to the section</span>
00527     <span class="comment">// object, the object is not dereferenced as the virtual address</span>
00528     <span class="comment">// descriptor contains a pointer to the section object.</span>
00529     <span class="comment">//</span>
00530 
00531     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( SectionHandle,
00532                                          DesiredSectionAccess,
00533                                          MmSectionObjectType,
00534                                          PreviousMode,
00535                                          (PVOID *)&amp;Section,
00536                                          NULL );
00537 
00538     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00539         <span class="keywordflow">goto</span> ErrorReturn1;
00540     }
00541 
00542     <span class="keywordflow">if</span> (Section-&gt;u.Flags.Image == 0) {
00543 
00544         <span class="comment">//</span>
00545         <span class="comment">// This is not an image section, make sure the section page</span>
00546         <span class="comment">// protection is compatible with the specified page protection.</span>
00547         <span class="comment">//</span>
00548 
00549         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a4">MiIsProtectionCompatible</a> (Section-&gt;InitialPageProtection,
00550                                        Protect)) {
00551             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_PROTECTION;
00552             <span class="keywordflow">goto</span> ErrorReturn;
00553         }
00554     }
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// Check to see if this the section backs physical memory, if</span>
00558     <span class="comment">// so DON'T align the offset on a 64K boundary, just a 4k boundary.</span>
00559     <span class="comment">//</span>
00560 
00561     <span class="keywordflow">if</span> (Section-&gt;Segment-&gt;ControlArea-&gt;u.Flags.PhysicalMemory) {
00562         HighestPhysicalAddressInPfnDatabase = (ULONGLONG)<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00563         CapturedOffset.LowPart = CapturedOffset.LowPart &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">// No usermode mappings past the end of the PFN database are allowed.</span>
00567         <span class="comment">// Address wrap is checked in the common path.</span>
00568         <span class="comment">//</span>
00569 
00570         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00571 
00572             <span class="keywordflow">if</span> ((ULONGLONG)(CapturedOffset.QuadPart + CapturedViewSize) &gt; HighestPhysicalAddressInPfnDatabase) {
00573                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_6;
00574                 <span class="keywordflow">goto</span> ErrorReturn;
00575             }
00576         }
00577 
00578     } <span class="keywordflow">else</span> {
00579 
00580         <span class="comment">//</span>
00581         <span class="comment">// Make sure alignments are correct for specified address</span>
00582         <span class="comment">// and offset into the file.</span>
00583         <span class="comment">//</span>
00584 
00585         <span class="keywordflow">if</span> ((AllocationType &amp; MEM_DOS_LIM) == 0) {
00586             <span class="keywordflow">if</span> (((ULONG_PTR)CapturedBase &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0) {
00587                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MAPPED_ALIGNMENT;
00588                 <span class="keywordflow">goto</span> ErrorReturn;
00589             }
00590 
00591             <span class="keywordflow">if</span> ((ARGUMENT_PRESENT (SectionOffset)) &amp;&amp;
00592                 ((CapturedOffset.LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0)) {
00593                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MAPPED_ALIGNMENT;
00594                 <span class="keywordflow">goto</span> ErrorReturn;
00595             }
00596         }
00597     }
00598 
00599     <span class="comment">//</span>
00600     <span class="comment">// Check to make sure the view size plus the offset is less</span>
00601     <span class="comment">// than the size of the section.</span>
00602     <span class="comment">//</span>
00603 
00604     <span class="keywordflow">if</span> ((ULONGLONG) (CapturedOffset.QuadPart + CapturedViewSize) &lt;
00605         (ULONGLONG)CapturedOffset.QuadPart) {
00606 
00607         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_VIEW_SIZE;
00608         <span class="keywordflow">goto</span> ErrorReturn;
00609     }
00610 
00611     <span class="keywordflow">if</span> (((ULONGLONG) (CapturedOffset.QuadPart + CapturedViewSize) &gt;
00612                  (ULONGLONG)Section-&gt;SizeOfSection.QuadPart) &amp;&amp;
00613         ((AllocationType &amp; MEM_RESERVE) == 0)) {
00614 
00615         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_VIEW_SIZE;
00616         <span class="keywordflow">goto</span> ErrorReturn;
00617     }
00618 
00619     <span class="keywordflow">if</span> (CapturedViewSize == 0) {
00620 
00621         <span class="comment">//</span>
00622         <span class="comment">// Set the view size to be size of the section less the offset.</span>
00623         <span class="comment">//</span>
00624 
00625         TempViewSize.QuadPart = Section-&gt;SizeOfSection.QuadPart -
00626                                                 CapturedOffset.QuadPart;
00627 
00628         CapturedViewSize = (SIZE_T)TempViewSize.QuadPart;
00629 
00630         <span class="keywordflow">if</span> (
00631 
00632 <span class="preprocessor">#if !defined(_WIN64)</span>
00633 <span class="preprocessor"></span>
00634             (TempViewSize.HighPart != 0) ||
00635 
00636 <span class="preprocessor">#endif</span>
00637 <span class="preprocessor"></span>
00638             (((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> - (ULONG_PTR)CapturedBase) &lt;
00639                                                         CapturedViewSize)) {
00640 
00641             <span class="comment">//</span>
00642             <span class="comment">// Invalid region size;</span>
00643             <span class="comment">//</span>
00644 
00645             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_VIEW_SIZE;
00646             <span class="keywordflow">goto</span> ErrorReturn;
00647         }
00648     }
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Check commit size.</span>
00652     <span class="comment">//</span>
00653 
00654     <span class="keywordflow">if</span> ((CommitSize &gt; CapturedViewSize) &amp;&amp;
00655         ((AllocationType &amp; MEM_RESERVE) == 0)) {
00656         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_5;
00657         <span class="keywordflow">goto</span> ErrorReturn;
00658     }
00659 
00660     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00661         Protect |= PAGE_WRITECOMBINE;
00662     }
00663 
00664     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> ( (PVOID)Section,
00665                                   Process,
00666                                   &amp;CapturedBase,
00667                                   ZeroBits,
00668                                   CommitSize,
00669                                   &amp;CapturedOffset,
00670                                   &amp;CapturedViewSize,
00671                                   InheritDisposition,
00672                                   AllocationType,
00673                                   Protect);
00674 
00675     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00676         <span class="keywordflow">if</span> ( (Section-&gt;Segment-&gt;ControlArea-&gt;u.Flags.Image) &amp;&amp;
00677              Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00678             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CONFLICTING_ADDRESSES ) {
00679                 <a class="code" href="../../d4/d3/dbgk_8h.html#a3">DbgkMapViewOfSection</a>(
00680                     SectionHandle,
00681                     CapturedBase,
00682                     CapturedOffset.LowPart,
00683                     CapturedViewSize
00684                     );
00685             }
00686         }
00687         <span class="keywordflow">goto</span> ErrorReturn;
00688     }
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">// Anytime the current process maps an image file,</span>
00692     <span class="comment">// a potential debug event occurs. DbgkMapViewOfSection</span>
00693     <span class="comment">// handles these events.</span>
00694     <span class="comment">//</span>
00695 
00696     <span class="keywordflow">if</span> ( (Section-&gt;Segment-&gt;ControlArea-&gt;u.Flags.Image) &amp;&amp;
00697          Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00698         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_IMAGE_NOT_AT_BASE ) {
00699             <a class="code" href="../../d4/d3/dbgk_8h.html#a3">DbgkMapViewOfSection</a>(
00700                 SectionHandle,
00701                 CapturedBase,
00702                 CapturedOffset.LowPart,
00703                 CapturedViewSize
00704                 );
00705         }
00706     }
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// Establish an exception handler and write the size and base</span>
00710     <span class="comment">// address.</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">try</span> {
00714 
00715         *ViewSize = CapturedViewSize;
00716         *BaseAddress = CapturedBase;
00717 
00718         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SectionOffset)) {
00719             *SectionOffset = CapturedOffset;
00720         }
00721 
00722     } except (EXCEPTION_EXECUTE_HANDLER) {
00723         <span class="keywordflow">goto</span> ErrorReturn;
00724     }
00725 
00726 <span class="preprocessor">#if 0 // test code...</span>
00727 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) &amp;&amp;
00728         (Section-&gt;u.Flags.Image == 0)) {
00729 
00730         PVOID Base;
00731         ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00732         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00733 
00734         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a27">MmMapViewInSystemSpace</a> ((PVOID)Section,
00735                                         &amp;Base,
00736                                         &amp;Size);
00737         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00738             <a class="code" href="../../d3/d5/mapview_8c.html#a29">MmUnmapViewInSystemSpace</a> (Base);
00739         }
00740     }
00741 <span class="preprocessor">#endif //0</span>
00742 <span class="preprocessor"></span>
00743     {
00744 ErrorReturn:
00745         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Section);
00746 ErrorReturn1:
00747         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00748         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00749     }
00750 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="mapview.c::VadTreeWalk" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VadTreeWalk           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Start</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a3" doxytag="mapview.c::MMDB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d3/d5/mapview_8c.html#a3">MMDB</a> = 'bDmM'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00026">26</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="mapview.c::MmLoadedUserImageList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d5/d1/mminit_8c.html#a40">MmLoadedUserImageList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00034">34</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="mapview.c::MMPPTE_NAME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d3/d5/mapview_8c.html#a2">MMPPTE_NAME</a> = 'tPmM'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00025">25</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l01028">MiMapViewOfPhysicalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="mapview.c::MmSession" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/struct__MMSESSION.html">MMSESSION</a> <a class="el" href="../../d4/d8/mi_8h.html#a521">MmSession</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">44</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l03967">MiInitializeSystemSpaceMap()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03211">MmMapViewInSessionSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03164">MmMapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03639">MmUnmapViewInSessionSpace()</a>, and <a class="el" href="../../d4/d4/mapview_8c-source.html#l03608">MmUnmapViewInSystemSpace()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="mapview.c::MMVADKEY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d6/vlm_8c.html#a0">MMVADKEY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00027">27</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
