<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: procobj.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>procobj.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d4/d4/procobj_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a0">ASSERT_PROCESS</a>(E)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a1">KiAttachProcess</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread, IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process, IN KIRQL OldIrql, OUT <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a> SavedApcState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a> (IN <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> Source, OUT <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> Destination)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a3">KeInitializeProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process, IN KPRIORITY BasePriority, IN KAFFINITY Affinity, IN ULONG_PTR DirectoryTableBase[2], IN BOOLEAN Enable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a5">KeForceAttachProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process, OUT <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a> ApcState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a> (IN <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a> ApcState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a9">KeReadStateProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a10">KeSetProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process, IN KPRIORITY Increment, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KPRIORITY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a11">KeSetPriorityProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN KPRIORITY NewBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a12">KeSetDisableQuantumProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN LOGICAL Disable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread, IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN KIRQL OldIrql, OUT <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a> SavedApcState)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="procobj.c::ASSERT_PROCESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_PROCESS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{             \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((E)-&gt;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>.Type == ProcessObject); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00057">57</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="procobj.c::KeAttachProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeAttachProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">166</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00658">_KTHREAD::ApcStateIndex</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00955">KiAttachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00656">_KTHREAD::SavedApcState</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/winable2_8c-source.html#l00778">_GetComboBoxInfo()</a>, <a class="el" href="../../d7/d6/winable2_8c-source.html#l00946">_GetListBoxInfo()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00986">CheckWHFBits()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00758">MiDoPoolCopy()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02788">MiEmptyAllWorkingSetsWorker()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02386">MmAssignProcessToJob()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04314">MmCreateTeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00813">MmProbeAndLockProcessPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07311">MmSetBankedSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d6/d4/flushbuf_8c-source.html#l00142">NtFlushInstructionCache()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00907">SepRmCallLsa()</a>, <a class="el" href="../../d4/d7/job_8c-source.html#l00322">SetProcessFlags()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01879">SmbTraceDisconnect()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02375">xxxCheckImeShowStatus()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01654">xxxCreateDisconnectDesktop()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04211">xxxGetThreadDesktop()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00749">xxxImmActivateAndUnloadThreadsLayout()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02544">xxxNotifyImeShowStatus()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02461">xxxSendMessageToUI()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>00172                    :
00173 
00174     This function attaches a thread to a target process' address space
00175     <span class="keywordflow">if</span>, and <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span>, there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not already a process attached.
00176 
00177 Arguments:
00178 
00179     Process - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00180 
00181 Return Value:
00182 
00183     None.
00184 
00185 --*/
00186 
00187 {
00188 
00189     KIRQL OldIrql;
00190     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00191 
00192     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00194 
00195     <span class="comment">//</span>
00196     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00197     <span class="comment">//</span>
00198 
00199     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00200     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// If the target process is the current process, then return immediately.</span>
00204     <span class="comment">// Otherwise, check whether there is a process address space attached or</span>
00205     <span class="comment">// the thread is executing a DPC. If either condition is true, then call</span>
00206     <span class="comment">// bug check. Otherwise, attach the target process.</span>
00207     <span class="comment">//</span>
00208 
00209     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> == Process) {
00210         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00211 
00212     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> != 0) ||
00213                (KeIsExecutingDpc() != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00214         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_PROCESS_ATTACH_ATTEMPT,
00215                      (ULONG_PTR)Process,
00216                      (ULONG_PTR)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>,
00217                      (ULONG)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>,
00218                      (ULONG)KeIsExecutingDpc());
00219 
00220     } <span class="keywordflow">else</span> {
00221         <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a>(Thread, Process, OldIrql, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>);
00222     }
00223 
00224     <span class="keywordflow">return</span>;
00225 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="procobj.c::KeDetachProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeDetachProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">405</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00243">_KAPC_STATE::ApcListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00658">_KTHREAD::ApcStateIndex</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00638">_KTHREAD::ApcStatePointer</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00036">BALANCE_INCREMENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00413">_KEVENT::Header</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00245">_KAPC_STATE::KernelApcInProgress</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00246">_KAPC_STATE::KernelApcPending</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l01092">KiMoveApcState()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00435">KiProcessOutSwapListHead</a>, <a class="el" href="../../d0/d4/intsupc_8c-source.html#l00159">KiRequestSoftwareInterrupt()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00421">KiSwapEvent</a>, <a class="el" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00656">_KTHREAD::SavedApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00262">_DISPATCHER_HEADER::SignalState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00767">_KPROCESS::StackCount</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00771">_KPROCESS::State</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00763">_KPROCESS::SwapListEntry</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00764">_KPROCESS::ThreadListHead</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/winable2_8c-source.html#l00778">_GetComboBoxInfo()</a>, <a class="el" href="../../d7/d6/winable2_8c-source.html#l00946">_GetListBoxInfo()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00986">CheckWHFBits()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04202">MiCreatePebOrTeb()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00758">MiDoPoolCopy()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02788">MiEmptyAllWorkingSetsWorker()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02386">MmAssignProcessToJob()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04314">MmCreateTeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00813">MmProbeAndLockProcessPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07311">MmSetBankedSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d6/d4/flushbuf_8c-source.html#l00142">NtFlushInstructionCache()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00907">SepRmCallLsa()</a>, <a class="el" href="../../d4/d7/job_8c-source.html#l00322">SetProcessFlags()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01879">SmbTraceDisconnect()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02375">xxxCheckImeShowStatus()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01654">xxxCreateDisconnectDesktop()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04211">xxxGetThreadDesktop()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00749">xxxImmActivateAndUnloadThreadsLayout()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02544">xxxNotifyImeShowStatus()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02461">xxxSendMessageToUI()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>00411                    :
00412 
00413     This function detaches a thread from another process' address space.
00414 
00415 Arguments:
00416 
00417     None.
00418 
00419 Return Value:
00420 
00421     None.
00422 
00423 --*/
00424 
00425 {
00426 
00427     KIRQL OldIrql;
00428     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00429     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00430 
00431     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00435     <span class="comment">//</span>
00436 
00437     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00438     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// If the current thread is attached to another process, then detach</span>
00442     <span class="comment">// it.</span>
00443     <span class="comment">//</span>
00444 
00445     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> != 0) {
00446 
00447         <span class="comment">//</span>
00448         <span class="comment">// Check if a kernel APC is in progress, the kernel APC queue is</span>
00449         <span class="comment">// not empty, or the user APC queue is not empty. If any of these</span>
00450         <span class="comment">// conditions are true, then call bug check.</span>
00451         <span class="comment">//</span>
00452 
00453 <span class="preprocessor">#if DBG</span>
00454 <span class="preprocessor"></span>
00455         <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a>) ||
00456             (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[KernelMode]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00457             (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[UserMode]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00458             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(INVALID_PROCESS_DETACH_ATTEMPT);
00459         }
00460 
00461 <span class="preprocessor">#endif</span>
00462 <span class="preprocessor"></span>
00463         <span class="comment">//</span>
00464         <span class="comment">// Unbias current process stack count and check if the process should</span>
00465         <span class="comment">// be swapped out of memory.</span>
00466         <span class="comment">//</span>
00467 
00468         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00469         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> -= 1;
00470         <span class="keywordflow">if</span> ((Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> == 0) &amp;&amp;
00471             (IsListEmpty(&amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00472             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
00473             InsertTailList(&amp;KiProcessOutSwapListHead, &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
00474             <a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
00475             <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00476                 <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;KiSwapEvent, BALANCE_INCREMENT);
00477             }
00478         }
00479 
00480         <span class="comment">//</span>
00481         <span class="comment">// Restore APC state and check whether the kernel APC queue contains</span>
00482         <span class="comment">// an entry. If the kernel APC queue contains an entry then set kernel</span>
00483         <span class="comment">// APC pending and request a software interrupt at APC_LEVEL.</span>
00484         <span class="comment">//</span>
00485 
00486         <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>);
00487         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> = (<a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00488         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[0] = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>;
00489         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[1] = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>;
00490         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> = 0;
00491         <span class="keywordflow">if</span> (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[KernelMode]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00492             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00493             <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a>(APC_LEVEL);
00494         }
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">// Swap the address space back to the parent process.</span>
00498         <span class="comment">//</span>
00499 
00500         <a class="code" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>, Process);
00501     }
00502 
00503     <span class="comment">//</span>
00504     <span class="comment">// Lower IRQL to its previous value and return.</span>
00505     <span class="comment">//</span>
00506 
00507     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00508     <span class="keywordflow">return</span>;
00509 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="procobj.c::KeForceAttachProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL KeForceAttachProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00228">228</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00658">_KTHREAD::ApcStateIndex</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00955">KiAttachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a189">ProcessInSwap</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a190">ProcessOutSwap</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00656">_KTHREAD::SavedApcState</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>00234                    :
00235 
00236     This function forces an attach of a thread to a target process' address
00237     space <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not current being swapped into or <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of memory.
00238 
00239     N.B. This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> use by memory management ONLY.
00240 
00241 Arguments:
00242 
00243     Process - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00244 
00245 Return Value:
00246 
00247     None.
00248 
00249 --*/
00250 
00251 {
00252 
00253     KIRQL OldIrql;
00254     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00255 
00256     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00257     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00261     <span class="comment">//</span>
00262 
00263     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00264     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// Check whether there is already a process address space attached or</span>
00268     <span class="comment">// the thread is executing a DPC. If either condition is true, then call</span>
00269     <span class="comment">// bug check.</span>
00270     <span class="comment">//</span>
00271 
00272     <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> != 0) ||
00273         (KeIsExecutingDpc() != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00274         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_PROCESS_ATTACH_ATTEMPT,
00275                      (ULONG_PTR)Process,
00276                      (ULONG_PTR)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>,
00277                      (ULONG)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>,
00278                      (ULONG)KeIsExecutingDpc());
00279     }
00280 
00281     <span class="comment">//</span>
00282     <span class="comment">// If the target process is not the current process, then attach the target</span>
00283     <span class="comment">// process if the process is not currently being swapped in or out of memory.</span>
00284     <span class="comment">//</span>
00285 
00286     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> == Process) {
00287         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00288 
00289     } <span class="keywordflow">else</span> {
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">// If the target process is currently being swapped into or out of memory,</span>
00293         <span class="comment">// then return a value of FALSE. Otherwise, force the process to be inswapped.</span>
00294         <span class="comment">//</span>
00295 
00296         <span class="keywordflow">if</span> ((Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a189">ProcessInSwap</a>) || Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a190">ProcessOutSwap</a>) {
00297             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00298             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00299 
00300         } <span class="keywordflow">else</span> {
00301 
00302             <span class="comment">//</span>
00303             <span class="comment">// If the target process is in transition, then remove it from its</span>
00304             <span class="comment">// transition list.</span>
00305             <span class="comment">//</span>
00306 
00307             <span class="keywordflow">if</span> (Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>) {
00308                 RemoveEntryList(&amp;Process-&gt;SwapListEntry);
00309             }
00310 
00311             <span class="comment">//</span>
00312             <span class="comment">// Force the process state to in memory and attach the target process.</span>
00313             <span class="comment">//</span>
00314 
00315             Process-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>;
00316             <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a>(Thread, Process, OldIrql, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>);
00317         }
00318     }
00319 
00320     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00321 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="procobj.c::KeInitializeProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeInitializeProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPRIORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>BasePriority</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KAFFINITY&nbsp;</td>
          <td class="mdname" nowrap> <em>Affinity</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryTableBase</em>[2], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00063">63</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a160">ProcessObject</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00036">THREAD_QUANTUM</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/alpha_2initkr_8c-source.html#l00065">KiInitializeKernel()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00073                    :
00074 
00075     This function initializes a kernel process object. The base priority,
00076     affinity, and page frame numbers <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process page table directory
00077     and hyper space are stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object.
00078 
00079     N.B. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zeroed.
00080 
00081 Arguments:
00082 
00083     Process - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00084 
00085     BasePriority - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00086 
00087     Affinity - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of processors on which children threads
00088         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process can execute.
00089 
00090     DirectoryTableBase - Supplies a pointer to an array whose fist element
00091         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be loaded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> Table Base
00092         <span class="keyword">register</span> when a child thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dispatched <span class="keywordflow">for</span> execution and whose
00093         second element contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page table entry that maps hyper space.
00094 
00095     Enable - Supplies a <span class="keywordtype">boolean</span> value that determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span>
00096         handling of data alignment exceptions <span class="keywordflow">for</span> child threads. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value
00097         of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> causes all data alignment exceptions to be automatically
00098         handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> causes all data alignment
00099         exceptions to be actually raised as exceptions.
00100 
00101 Return Value:
00102 
00103     None.
00104 
00105 --*/
00106 
00107 {
00108 
00109     <span class="comment">//</span>
00110     <span class="comment">// Initialize the standard dispatcher object header and set the initial</span>
00111     <span class="comment">// signal state of the process object.</span>
00112     <span class="comment">//</span>
00113 
00114     Process-&gt;Header.Type = <a class="code" href="../../d4/d9/ke_8h.html#a402a160">ProcessObject</a>;
00115     Process-&gt;Header.Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a>) / <span class="keyword">sizeof</span>(LONG);
00116     InitializeListHead(&amp;Process-&gt;Header.WaitListHead);
00117 
00118     <span class="comment">//</span>
00119     <span class="comment">// Initialize the base priority, affinity, directory table base values,</span>
00120     <span class="comment">// autoalignment, and stack count.</span>
00121     <span class="comment">//</span>
00122     <span class="comment">// N.B. The distinguished value MAXSHORT is used to signify that no</span>
00123     <span class="comment">//      threads have been created for the process.</span>
00124     <span class="comment">//</span>
00125 
00126     Process-&gt;BasePriority = (SCHAR)BasePriority;
00127     Process-&gt;Affinity = Affinity;
00128     Process-&gt;AutoAlignment = Enable;
00129     Process-&gt;DirectoryTableBase[0] = DirectoryTableBase[0];
00130     Process-&gt;DirectoryTableBase[1] = DirectoryTableBase[1];
00131     Process-&gt;StackCount = MAXSHORT;
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">// Initialize the stack count, profile listhead, ready queue list head,</span>
00135     <span class="comment">// accumulated runtime, process quantum, thread quantum, and thread list</span>
00136     <span class="comment">// head.</span>
00137     <span class="comment">//</span>
00138 
00139     InitializeListHead(&amp;Process-&gt;ProfileListHead);
00140     InitializeListHead(&amp;Process-&gt;ReadyListHead);
00141     InitializeListHead(&amp;Process-&gt;ThreadListHead);
00142     Process-&gt;ThreadQuantum = <a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>;
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Initialize the process state and set the thread processor selection</span>
00146     <span class="comment">// seed.</span>
00147     <span class="comment">//</span>
00148 
00149     Process-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>;
00150     Process-&gt;ThreadSeed = (UCHAR)KiQueryLowTickCount();
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">// Initialize IopmBase and Iopl flag for this process (i386 only)</span>
00154     <span class="comment">//</span>
00155 
00156 <span class="preprocessor">#ifdef i386</span>
00157 <span class="preprocessor"></span>
00158     Process-&gt;IopmOffset = KiComputeIopmOffset(IO_ACCESS_MAP_NONE);
00159 
00160 <span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>
00162     <span class="keywordflow">return</span>;
00163 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="procobj.c::KeReadStateProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG KeReadStateProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00624">624</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>.
<p>
<pre class="fragment"><div>00630                    :
00631 
00632     This function reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current signal state of a process object.
00633 
00634 Arguments:
00635 
00636     Process - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00637 
00638 Return Value:
00639 
00640     The current signal state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object.
00641 
00642 --*/
00643 
00644 {
00645 
00646     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00647 
00648     <span class="comment">//</span>
00649     <span class="comment">// Return current signal state of process object.</span>
00650     <span class="comment">//</span>
00651 
00652     <span class="keywordflow">return</span> Process-&gt;Header.SignalState;
00653 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="procobj.c::KeSetDisableQuantumProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL KeSetDisableQuantumProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>Disable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00907">907</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>.
<p>
<pre class="fragment"><div>00914                    :
00915 
00916     This function disables quantum runout <span class="keywordflow">for</span> realtime threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00917     specified process.
00918 
00919 Arguments:
00920 
00921     Process  - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00922 
00923     Disable - Supplies a logical value that determines whether quantum
00924         runout <span class="keywordflow">for</span> realtime threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process are disabled
00925         or enabled.
00926 
00927 Return Value:
00928 
00929     The previous value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disable quantum state variable.
00930 
00931 --*/
00932 
00933 {
00934 
00935     LOGICAL DisableQuantum;
00936 
00937     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">// Capture the current state of the disable boost variable and set its</span>
00941     <span class="comment">// state to TRUE.</span>
00942     <span class="comment">//</span>
00943 
00944     DisableQuantum = Process-&gt;DisableQuantum;
00945     Process-&gt;DisableQuantum = (BOOLEAN)Disable;
00946 
00947     <span class="comment">//</span>
00948     <span class="comment">// Return the previous disable quantum state.</span>
00949     <span class="comment">//</span>
00950 
00951     <span class="keywordflow">return</span> DisableQuantum;
00952 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="procobj.c::KeSetPriorityProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KPRIORITY KeSetPriorityProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPRIORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>NewBase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00738">738</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00590">_KTHREAD::BasePriority</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00591">_KTHREAD::DecrementCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00576">KiSetPriorityThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00592">_KTHREAD::PriorityDecrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00593">_KTHREAD::Quantum</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00573">_KTHREAD::Saturation</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>.
<p>
<pre class="fragment"><div>00745                    :
00746 
00747     This function set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base priority of a process to a <span class="keyword">new</span> value
00748     and adjusts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority and base priority of all child threads
00749     as appropriate.
00750 
00751 Arguments:
00752 
00753     Process - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00754 
00755     NewBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> base priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00756 
00757 Return Value:
00758 
00759     The previous base priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00760 
00761 --*/
00762 
00763 {
00764 
00765     KPRIORITY Adjustment;
00766     PLIST_ENTRY NextEntry;
00767     KPRIORITY NewPriority;
00768     KIRQL OldIrql;
00769     KPRIORITY OldBase;
00770     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00771 
00772     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00773     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00774 
00775     <span class="comment">//</span>
00776     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00777     <span class="comment">//</span>
00778 
00779     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">// Save the current process base priority, set the new process base</span>
00783     <span class="comment">// priority, compute the adjustment value, and adjust the priority</span>
00784     <span class="comment">// and base priority of all child threads as appropriate.</span>
00785     <span class="comment">//</span>
00786 
00787     OldBase = Process-&gt;BasePriority;
00788     Process-&gt;BasePriority = (SCHAR)NewBase;
00789     Adjustment = NewBase - OldBase;
00790     NextEntry = Process-&gt;ThreadListHead.Flink;
00791     <span class="keywordflow">if</span> (NewBase &gt;= LOW_REALTIME_PRIORITY) {
00792         <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;ThreadListHead) {
00793             Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, ThreadListEntry);
00794 
00795             <span class="comment">//</span>
00796             <span class="comment">// Compute the new base priority of the thread.</span>
00797             <span class="comment">//</span>
00798 
00799             NewPriority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> + Adjustment;
00800 
00801             <span class="comment">//</span>
00802             <span class="comment">// If the new base priority is outside the realtime class,</span>
00803             <span class="comment">// then limit the change to the realtime class.</span>
00804             <span class="comment">//</span>
00805 
00806             <span class="keywordflow">if</span> (NewPriority &lt; LOW_REALTIME_PRIORITY) {
00807                 NewPriority = LOW_REALTIME_PRIORITY;
00808 
00809             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewPriority &gt; HIGH_PRIORITY) {
00810                 NewPriority = HIGH_PRIORITY;
00811             }
00812 
00813             <span class="comment">//</span>
00814             <span class="comment">// Set the base priority and the current priority of the</span>
00815             <span class="comment">// thread to the appropriate value.</span>
00816             <span class="comment">//</span>
00817             <span class="comment">// N.B. If priority saturation occured the last time the thread</span>
00818             <span class="comment">//      base priority was set and the new process base priority</span>
00819             <span class="comment">//      is not crossing from variable to realtime, then it is not</span>
00820             <span class="comment">//      necessary to change the thread priority.</span>
00821             <span class="comment">//</span>
00822 
00823             <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> == 0) || (OldBase &lt; LOW_REALTIME_PRIORITY)) {
00824                 <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> &gt; 0) {
00825                     NewPriority = HIGH_PRIORITY;
00826 
00827                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> &lt; 0) {
00828                     NewPriority = LOW_REALTIME_PRIORITY;
00829                 }
00830 
00831                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> = (SCHAR)NewPriority;
00832                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Process-&gt;ThreadQuantum;
00833                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> = 0;
00834                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> = 0;
00835                 <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, NewPriority);
00836             }
00837 
00838             NextEntry = NextEntry-&gt;Flink;
00839         }
00840 
00841     } <span class="keywordflow">else</span> {
00842         <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;ThreadListHead) {
00843             Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, ThreadListEntry);
00844 
00845             <span class="comment">//</span>
00846             <span class="comment">// Compute the new base priority of the thread.</span>
00847             <span class="comment">//</span>
00848 
00849             NewPriority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> + Adjustment;
00850 
00851             <span class="comment">//</span>
00852             <span class="comment">// If the new base priority is outside the variable class,</span>
00853             <span class="comment">// then limit the change to the variable class.</span>
00854             <span class="comment">//</span>
00855 
00856             <span class="keywordflow">if</span> (NewPriority &gt;= LOW_REALTIME_PRIORITY) {
00857                 NewPriority = LOW_REALTIME_PRIORITY - 1;
00858 
00859             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewPriority &lt;= LOW_PRIORITY) {
00860                 NewPriority = 1;
00861             }
00862 
00863             <span class="comment">//</span>
00864             <span class="comment">// Set the base priority and the current priority of the</span>
00865             <span class="comment">// thread to the computed value and reset the thread quantum.</span>
00866             <span class="comment">//</span>
00867             <span class="comment">// N.B. If priority saturation occured the last time the thread</span>
00868             <span class="comment">//      base priority was set and the new process base priority</span>
00869             <span class="comment">//      is not crossing from realtime to variable, then it is not</span>
00870             <span class="comment">//      necessary to change the thread priority.</span>
00871             <span class="comment">//</span>
00872 
00873             <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> == 0) || (OldBase &gt;= LOW_REALTIME_PRIORITY)) {
00874                 <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> &gt; 0) {
00875                     NewPriority = LOW_REALTIME_PRIORITY - 1;
00876 
00877                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> &lt; 0) {
00878                     NewPriority = 1;
00879                 }
00880 
00881                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> = (SCHAR)NewPriority;
00882                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Process-&gt;ThreadQuantum;
00883                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> = 0;
00884                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> = 0;
00885                 <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, NewPriority);
00886             }
00887 
00888             NextEntry = NextEntry-&gt;Flink;
00889         }
00890     }
00891 
00892     <span class="comment">//</span>
00893     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00894     <span class="comment">// value.</span>
00895     <span class="comment">//</span>
00896 
00897     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00898 
00899     <span class="comment">//</span>
00900     <span class="comment">// Return previous process base priority</span>
00901     <span class="comment">//</span>
00902 
00903     <span class="keywordflow">return</span> OldBase;
00904 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="procobj.c::KeSetProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG KeSetProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPRIORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>Increment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00656">656</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d3/rtl_2random_8c-source.html#l00032">Increment</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00583">_KTHREAD::WaitIrql</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00585">_KTHREAD::WaitNext</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">PspExitProcess()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>00664                    :
00665 
00666     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> signal state of a proces object to Signaled
00667     and attempts to satisfy as many Waits as possible. The previous
00668     signal state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
00669 
00670 Arguments:
00671 
00672     Process - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00673 
00674     <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority increment that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be applied
00675        <span class="keywordflow">if</span> setting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process causes a Wait to be satisfied.
00676 
00677     Wait - Supplies a <span class="keywordtype">boolean</span> value that signifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to
00678        <a class="code" href="../../d4/d9/ke_8h.html#a307">KeSetProcess</a> will be immediately followed by a call to one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00679        kernel Wait <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a>.
00680 
00681 Return Value:
00682 
00683     The previous signal state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object.
00684 
00685 --*/
00686 
00687 {
00688 
00689     KIRQL OldIrql;
00690     LONG OldState;
00691     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00692 
00693     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00694     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00698     <span class="comment">//</span>
00699 
00700     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">// If the previous state of the process object is Not-Signaled and</span>
00704     <span class="comment">// the wait queue is not empty, then satisfy as many Waits as</span>
00705     <span class="comment">// possible.</span>
00706     <span class="comment">//</span>
00707 
00708     OldState = Process-&gt;Header.SignalState;
00709     Process-&gt;Header.SignalState = 1;
00710     <span class="keywordflow">if</span> ((OldState == 0) &amp;&amp; (!IsListEmpty(&amp;Process-&gt;Header.WaitListHead))) {
00711         <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(Process, Increment);
00712     }
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">// If the value of the Wait argument is TRUE, then return to the</span>
00716     <span class="comment">// caller with IRQL raised and the dispatcher database locked. Else</span>
00717     <span class="comment">// release the dispatcher database lock and lower IRQL to its</span>
00718     <span class="comment">// previous value.</span>
00719     <span class="comment">//</span>
00720 
00721     <span class="keywordflow">if</span> (Wait) {
00722         Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00723         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a> = Wait;
00724         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> = OldIrql;
00725 
00726     } <span class="keywordflow">else</span> {
00727         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00728     }
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// Return previous signal state of process object.</span>
00732     <span class="comment">//</span>
00733 
00734     <span class="keywordflow">return</span> OldState;
00735 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="procobj.c::KeStackAttachProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeStackAttachProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ApcState</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">324</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00658">_KTHREAD::ApcStateIndex</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00955">KiAttachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00656">_KTHREAD::SavedApcState</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>00331                    :
00332 
00333     This function attaches a thread to a target process' address space
00334     and returns information about a previous attached process.
00335 
00336 Arguments:
00337 
00338     Process - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00339 
00340 Return Value:
00341 
00342     None.
00343 
00344 --*/
00345 
00346 {
00347 
00348     KIRQL OldIrql;
00349     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00350 
00351     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00352     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00356     <span class="comment">//</span>
00357 
00358     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00359     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// If the current thread is executing a DPC, then bug check.</span>
00363     <span class="comment">//</span>
00364 
00365     <span class="keywordflow">if</span> (KeIsExecutingDpc() != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00366         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_PROCESS_ATTACH_ATTEMPT,
00367                      (ULONG_PTR)Process,
00368                      (ULONG_PTR)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>,
00369                      (ULONG)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>,
00370                      (ULONG)KeIsExecutingDpc());
00371     }
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">// If the target process is not the current process, then attach the target</span>
00375     <span class="comment">// process. Otherwise, return a distinguished process value to indicate that</span>
00376     <span class="comment">// an attach was not performed.</span>
00377     <span class="comment">//</span>
00378 
00379     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> == Process) {
00380         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00381         ApcState-&gt;Process = (<a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>)1;
00382 
00383     } <span class="keywordflow">else</span> {
00384 
00385         <span class="comment">//</span>
00386         <span class="comment">// If the current thread is attached to a process, then save the current</span>
00387         <span class="comment">// APC state in the callers APC state structure. Otherwise, save the</span>
00388         <span class="comment">// current APC state in the saved APC state structure, and return a NULL</span>
00389         <span class="comment">// process pointer.</span>
00390         <span class="comment">//</span>
00391 
00392         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> != 0) {
00393             <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a>(Thread, Process, OldIrql, ApcState);
00394 
00395         } <span class="keywordflow">else</span> {
00396             <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a>(Thread, Process, OldIrql, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>);
00397             ApcState-&gt;Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00398         }
00399     }
00400 
00401     <span class="keywordflow">return</span>;
00402 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="procobj.c::KeUnstackDetachProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeUnstackDetachProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ApcState</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">512</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00243">_KAPC_STATE::ApcListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00658">_KTHREAD::ApcStateIndex</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00638">_KTHREAD::ApcStatePointer</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00036">BALANCE_INCREMENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00413">_KEVENT::Header</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00245">_KAPC_STATE::KernelApcInProgress</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00246">_KAPC_STATE::KernelApcPending</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l01092">KiMoveApcState()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00435">KiProcessOutSwapListHead</a>, <a class="el" href="../../d0/d4/intsupc_8c-source.html#l00159">KiRequestSoftwareInterrupt()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00421">KiSwapEvent</a>, <a class="el" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00656">_KTHREAD::SavedApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00262">_DISPATCHER_HEADER::SignalState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00767">_KPROCESS::StackCount</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00771">_KPROCESS::State</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00763">_KPROCESS::SwapListEntry</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00764">_KPROCESS::ThreadListHead</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>00518                    :
00519 
00520     This function detaches a thread from another process' address space
00521     and restores previous attach state.
00522 
00523 Arguments:
00524 
00525     ApcState - Supplies a pointer to an APC state structure that was returned
00526         from a previous call to stack attach process.
00527 
00528 Return Value:
00529 
00530     None.
00531 
00532 --*/
00533 
00534 {
00535 
00536     KIRQL OldIrql;
00537     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00538     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00539 
00540     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00544     <span class="comment">//</span>
00545 
00546     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00547     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// If the APC state has a distinguished process pointer value, then no</span>
00551     <span class="comment">// attach was performed on the paired call to stack attach process.</span>
00552     <span class="comment">//</span>
00553 
00554     <span class="keywordflow">if</span> (ApcState-&gt;Process != (<a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>)1) {
00555 
00556         <span class="comment">//</span>
00557         <span class="comment">// If the current thread is not attached to another process, a kernel</span>
00558         <span class="comment">// APC is in progress, or either the kernel or user mode APC queues</span>
00559         <span class="comment">// are not empty, then call bug check.</span>
00560         <span class="comment">//</span>
00561 
00562         <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> == 0) ||
00563              (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a>) ||
00564              (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[KernelMode]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00565              (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[UserMode]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00566             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(INVALID_PROCESS_DETACH_ATTEMPT);
00567         }
00568 
00569         <span class="comment">//</span>
00570         <span class="comment">// Unbias current process stack count and check if the process should</span>
00571         <span class="comment">// be swapped out of memory.</span>
00572         <span class="comment">//</span>
00573 
00574         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00575         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> -= 1;
00576         <span class="keywordflow">if</span> ((Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> == 0) &amp;&amp;
00577             (IsListEmpty(&amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00578             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
00579             InsertTailList(&amp;KiProcessOutSwapListHead, &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
00580             <a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
00581             <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00582                 <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;KiSwapEvent, BALANCE_INCREMENT);
00583             }
00584         }
00585 
00586         <span class="comment">//</span>
00587         <span class="comment">// Restore APC state and check whether the kernel APC queue contains</span>
00588         <span class="comment">// an entry. If the kernel APC queue contains an entry then set kernel</span>
00589         <span class="comment">// APC pending and request a software interrupt at APC_LEVEL.</span>
00590         <span class="comment">//</span>
00591 
00592         <span class="keywordflow">if</span> (ApcState-&gt;Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00593             <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a>(ApcState, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>);
00594 
00595         } <span class="keywordflow">else</span> {
00596             <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>);
00597             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> = (<a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00598             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[0] = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>;
00599             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[1] = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>;
00600             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> = 0;
00601         }
00602 
00603         <span class="keywordflow">if</span> (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[KernelMode]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00604             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00605             <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a>(APC_LEVEL);
00606         }
00607 
00608         <span class="comment">//</span>
00609         <span class="comment">// Swap the address space back to the parent process.</span>
00610         <span class="comment">//</span>
00611 
00612         <a class="code" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>, Process);
00613     }
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Lower IRQL to its previous value and return.</span>
00617     <span class="comment">//</span>
00618 
00619     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00620     <span class="keywordflow">return</span>;
00621 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="procobj.c::KiAttachProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiAttachProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>OldIrql</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SavedApcState</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l00955">955</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00036">BALANCE_INCREMENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00413">_KEVENT::Header</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00128">KiLockContextSwap</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l01092">KiMoveApcState()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00428">KiProcessInSwapListHead</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00421">KiSwapEvent</a>, <a class="el" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a138">KiSwapThread()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00131">KiUnlockContextSwap</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>, <a class="el" href="../../d4/d9/ke_8h.html#a405a187">ProcessOutOfMemory</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00624">_KTHREAD::ProcessReadyQueue</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a192">Ready</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00262">_DISPATCHER_HEADER::SignalState</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00228">KeForceAttachProcess()</a>, and <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>.
<p>
<pre class="fragment"><div>00964                    :
00965 
00966     This function attaches a thread to a target process' address space.
00967 
00968     N.B. The dispatcher database lock must be held when <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00969         called.
00970 
00971 Arguments:
00972 
00973     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00974 
00975     Process - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00976 
00977     OldIrql - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous IRQL.
00978 
00979     SavedApcState - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC state structure that receives
00980         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> saved APC state.
00981 
00982 Return Value:
00983 
00984     None.
00985 
00986 --*/
00987 
00988 {
00989 
00990     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> OutThread;
00991     KAFFINITY Processor;
00992     PLIST_ENTRY NextEntry;
00993     KIRQL HighIrql;
00994 
00995     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Process != Thread-&gt;ApcState.Process);
00996 
00997     <span class="comment">//</span>
00998     <span class="comment">// Bias the stack count of the target process to signify that a</span>
00999     <span class="comment">// thread exists in that process with a stack that is resident.</span>
01000     <span class="comment">//</span>
01001 
01002     Process-&gt;StackCount += 1;
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// Save current APC state and initialize a new APC state.</span>
01006     <span class="comment">//</span>
01007 
01008     <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a>(&amp;Thread-&gt;ApcState, SavedApcState);
01009     InitializeListHead(&amp;Thread-&gt;ApcState.ApcListHead[KernelMode]);
01010     InitializeListHead(&amp;Thread-&gt;ApcState.ApcListHead[UserMode]);
01011     Thread-&gt;ApcState.Process = Process;
01012     Thread-&gt;ApcState.KernelApcInProgress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01013     Thread-&gt;ApcState.KernelApcPending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01014     Thread-&gt;ApcState.UserApcPending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01015     <span class="keywordflow">if</span> (SavedApcState == &amp;Thread-&gt;SavedApcState) {
01016         Thread-&gt;ApcStatePointer[0] = &amp;Thread-&gt;SavedApcState;
01017         Thread-&gt;ApcStatePointer[1] = &amp;Thread-&gt;ApcState;
01018         Thread-&gt;ApcStateIndex = 1;
01019     }
01020 
01021     <span class="comment">//</span>
01022     <span class="comment">// If the target process is in memory, then immediately enter the</span>
01023     <span class="comment">// new address space by loading a new Directory Table Base. Otherwise,</span>
01024     <span class="comment">// insert the current thread in the target process ready list, inswap</span>
01025     <span class="comment">// the target process if necessary, select a new thread to run on the</span>
01026     <span class="comment">// the current processor and context switch to the new thread.</span>
01027     <span class="comment">//</span>
01028 
01029     <span class="keywordflow">if</span> (Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>) {
01030 
01031         <span class="comment">//</span>
01032         <span class="comment">// It is possible that the process is in memory, but there exist</span>
01033         <span class="comment">// threads in the process ready list. This can happen when memory</span>
01034         <span class="comment">// management forces a process attach.</span>
01035         <span class="comment">//</span>
01036 
01037         NextEntry = Process-&gt;ReadyListHead.Flink;
01038         <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;ReadyListHead) {
01039             OutThread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
01040             RemoveEntryList(NextEntry);
01041             OutThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o43">ProcessReadyQueue</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01042             <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(OutThread);
01043             NextEntry = Process-&gt;ReadyListHead.Flink;
01044         }
01045 
01046         <a class="code" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess</a>(Process, SavedApcState-&gt;Process);
01047         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01048 
01049     } <span class="keywordflow">else</span> {
01050         Thread-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a192">Ready</a>;
01051         Thread-&gt;ProcessReadyQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01052         InsertTailList(&amp;Process-&gt;ReadyListHead, &amp;Thread-&gt;WaitListEntry);
01053         <span class="keywordflow">if</span> (Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a187">ProcessOutOfMemory</a>) {
01054             Process-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
01055             InsertTailList(&amp;KiProcessInSwapListHead, &amp;Process-&gt;SwapListEntry);
01056             <a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
01057             <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01058                 <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;KiSwapEvent, BALANCE_INCREMENT);
01059             }
01060         }
01061 
01062         <span class="comment">//</span>
01063         <span class="comment">// Clear the active processor bit in the previous process and</span>
01064         <span class="comment">// set active processor bit in the process being attached to.</span>
01065         <span class="comment">//</span>
01066 
01067 <span class="preprocessor">#if !defined(NT_UP)</span>
01068 <span class="preprocessor"></span>
01069         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;HighIrql);
01070         Processor = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;SetMember;
01071         SavedApcState-&gt;Process-&gt;ActiveProcessors &amp;= ~Processor;
01072         Process-&gt;ActiveProcessors |= Processor;
01073 
01074 <span class="preprocessor">#if defined(_ALPHA_)</span>
01075 <span class="preprocessor"></span>
01076         Process-&gt;RunOnProcessors |= Processor;
01077 
01078 <span class="preprocessor">#endif</span>
01079 <span class="preprocessor"></span>
01080         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(HighIrql);
01081 
01082 <span class="preprocessor">#endif</span>
01083 <span class="preprocessor"></span>
01084         Thread-&gt;WaitIrql = OldIrql;
01085         <a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
01086     }
01087 
01088     <span class="keywordflow">return</span>;
01089 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="procobj.c::KiAttachProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiAttachProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>OldIrql</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SavedApcState</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="procobj.c::KiMoveApcState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiMoveApcState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/procobj_8c-source.html#l01092">1092</a> of file <a class="el" href="../../d4/d4/procobj_8c-source.html">procobj.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, and <a class="el" href="../../d4/d4/procobj_8c-source.html#l00955">KiAttachProcess()</a>.
<p>
<pre class="fragment"><div>01099                    :
01100 
01101     This function moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC state from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source structure to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01102     destination structure and reinitializes list headers as appropriate.
01103 
01104 Arguments:
01105 
01106     Source - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source APC state structure.
01107 
01108     Destination - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination APC state structure.
01109 
01110 
01111 Return Value:
01112 
01113     None.
01114 
01115 --*/
01116 
01117 {
01118 
01119     PLIST_ENTRY First;
01120     PLIST_ENTRY Last;
01121 
01122     <span class="comment">//</span>
01123     <span class="comment">// Copy the APC state from the source to the destination.</span>
01124     <span class="comment">//</span>
01125 
01126     *Destination = *Source;
01127     <span class="keywordflow">if</span> (IsListEmpty(&amp;Source-&gt;ApcListHead[KernelMode]) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01128         InitializeListHead(&amp;Destination-&gt;ApcListHead[KernelMode]);
01129 
01130     } <span class="keywordflow">else</span> {
01131         First = Source-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Flink;
01132         Last = Source-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Blink;
01133         Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Flink = First;
01134         Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Blink = Last;
01135         First-&gt;Blink = &amp;Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>];
01136         Last-&gt;Flink = &amp;Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>];
01137     }
01138 
01139     <span class="keywordflow">if</span> (IsListEmpty(&amp;Source-&gt;ApcListHead[UserMode]) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01140         InitializeListHead(&amp;Destination-&gt;ApcListHead[UserMode]);
01141 
01142     } <span class="keywordflow">else</span> {
01143         First = Source-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Flink;
01144         Last = Source-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Blink;
01145         Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Flink = First;
01146         Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Blink = Last;
01147         First-&gt;Blink = &amp;Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>];
01148         Last-&gt;Flink = &amp;Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>];
01149     }
01150 
01151     <span class="keywordflow">return</span>;
01152 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
