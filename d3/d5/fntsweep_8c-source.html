<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fntsweep.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fntsweep.c</h1><a href="../../d2/d6/fntsweep_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/******************************Module*Header*******************************\</span>
00002 <span class="comment">* Module Name: fntsweep.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">* Author: Bodin Dresevic [BodinD]</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* Copyright (c) 1990 Microsoft Corporation</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* This file contains font sweeper related stuff.</span>
00010 <span class="comment">* On the boot of ths system, i.e.  initialization of userk, the</span>
00011 <span class="comment">* [Fonts] section of win.ini is checked to</span>
00012 <span class="comment">* find out if any new fonts have been added by any font installers.</span>
00013 <span class="comment">* If third party installers have installed fonts in the system directory</span>
00014 <span class="comment">* those are copied to fonts directory. Any fot entries are replaced</span>
00015 <span class="comment">* by appropriate *.ttf entries, any fot files are deleted if they were</span>
00016 <span class="comment">* ever installed.</span>
00017 <span class="comment">*</span>
00018 <span class="comment">\**************************************************************************/</span>
00019 
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00022 <span class="preprocessor">#pragma hdrstop</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include &lt;setupbat.h&gt;</span>      <span class="comment">// in sdkinc</span>
00024 
<a name="l00025"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a5">00025</a> CONST WCHAR <a class="code" href="../../d2/d6/fntsweep_8c.html#a5">pwszType1Key</a>[]      = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\Type 1 Fonts"</span>;
<a name="l00026"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a6">00026</a> CONST WCHAR <a class="code" href="../../d2/d6/fntsweep_8c.html#a6">pwszSweepType1Key</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\LastType1Sweep"</span>;
<a name="l00027"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a7">00027</a> CONST WCHAR <a class="code" href="../../d2/d6/fntsweep_8c.html#a7">pwszUpdType1Key</a>[]   = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\Upgraded Type1"</span>;
00028 
<a name="l00029"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a8">00029</a> CONST WCHAR <a class="code" href="../../d2/d6/fntsweep_8c.html#a8">pwszFontsKey</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Fonts"</span>;
<a name="l00030"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a9">00030</a> CONST WCHAR <a class="code" href="../../d2/d6/fntsweep_8c.html#a9">pwszSweepKey</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\LastFontSweep"</span>;
<a name="l00031"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a10">00031</a> CONST WCHAR <a class="code" href="../../d2/d6/fntsweep_8c.html#a10">pwszFontDrivers</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Font Drivers"</span>;
00032 
<a name="l00033"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a0">00033</a> <span class="preprocessor">#define LAST_SWEEP_TIME L"LastSweepTime"</span>
<a name="l00034"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a1">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define UPGRADED_TYPE1 L"UpgradedType1"</span>
00035 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a2">00036</a> <span class="preprocessor">#define DWORDALIGN(X) (((X) + 3) &amp; ~3)</span>
00037 <span class="preprocessor"></span>
<a name="l00038"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a11">00038</a> WCHAR *<a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>;
<a name="l00039"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a12">00039</a> WCHAR *<a class="code" href="../../d2/d6/fntsweep_8c.html#a12">gpwcFontsDir</a>;
<a name="l00040"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a13">00040</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   <a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a>;
00041 
00042 
<a name="l00043"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a15">00043</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a15">bCheckIfDualBootingWithWin31</a>()
00044 {
00045     WCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[32];
00046     WCHAR awcWindowsDir[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00047     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
00048     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  cwchWinPath = GetSystemWindowsDirectoryW(awcWindowsDir, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00049 
00050 <span class="comment">// the cwchWinPath value does not include the terminating zero</span>
00051 
00052     <span class="keywordflow">if</span> (awcWindowsDir[cwchWinPath - 1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)
00053     {
00054         cwchWinPath -= 1;
00055     }
00056     awcWindowsDir[cwchWinPath] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>; <span class="comment">// make sure to zero terminated</span>
00057 
00058     lstrcatW(awcWindowsDir, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\system32\\"</span>);
00059     lstrcatW(awcWindowsDir, WINNT_GUI_FILE_W);
00060 
00061     dwRet = GetPrivateProfileStringW(
00062                 WINNT_DATA_W,
00063                 WINNT_D_WIN31UPGRADE_W,
00064                 WINNT_A_NO_W,
00065                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00066                 <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)/<span class="keyword">sizeof</span>(WCHAR),
00067                 awcWindowsDir
00068                 );
00069 
00070 <span class="preprocessor">    #if DBGSWEEP</span>
00071 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n dwRet = %ld, win31upgrade = %ws\n\n"</span>, dwRet, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00072 <span class="preprocessor">    #endif</span>
00073 <span class="preprocessor"></span>
00074     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(dwRet ? (!lstrcmpiW(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,WINNT_A_YES)) : 0);
00075 }
00076 
00077 
00078 <span class="comment">/******************************Public*Routine******************************\</span>
00079 <span class="comment">*</span>
00080 <span class="comment">* VOID vNullTermWideString (WCHAR *pwcDest, WCHAR *pwcSrc, ULONG ulLength)</span>
00081 <span class="comment">*</span>
00082 <span class="comment">* Given pwcSrc, which is not necessarily null-terminated, copy ulLength characters</span>
00083 <span class="comment">* the into pwcDest and place a null character after it.</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* History:</span>
00086 <span class="comment">*  03-Feb-99 -by- Donald Chinn [dchinn]</span>
00087 <span class="comment">* Wrote it.</span>
00088 <span class="comment">\**************************************************************************/</span>
<a name="l00089"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a16">00089</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (WCHAR *pwcDest, WCHAR *pwcSrc, ULONG ulLength)
00090 {
00091     ULONG index;
00092 
00093     <span class="keywordflow">for</span> (index = 0; index &lt; ulLength; index++) {
00094         *pwcDest++ = *pwcSrc++;
00095     }
00096     *pwcDest = <span class="charliteral">'\0'</span>;
00097 }
00098 
00099 
00100 <span class="comment">/******************************Public*Routine******************************\</span>
00101 <span class="comment">*</span>
00102 <span class="comment">* BOOL bCheckFontEntry(WCHAR *pwcName, WCHAR *pwcExtension)</span>
00103 <span class="comment">*</span>
00104 <span class="comment">* This function assumes that both pwcName and pwcExtension are null-terminated.</span>
00105 <span class="comment">*</span>
00106 <span class="comment">* History:</span>
00107 <span class="comment">*  25-Oct-1995 -by- Bodin Dresevic [BodinD]</span>
00108 <span class="comment">* Wrote it.</span>
00109 <span class="comment">\**************************************************************************/</span>
00110 
00111 
<a name="l00112"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a17">00112</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a17">bCheckFontEntry</a>(WCHAR *pwcName, WCHAR *pwcExtension)
00113 {
00114     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00115     LONG cwc = (LONG)wcslen(pwcName) - (LONG)wcslen(pwcExtension);
00116     <span class="keywordflow">if</span> (cwc &gt; 0)
00117     {
00118         bRet = !_wcsicmp(&amp;pwcName[cwc], pwcExtension);
00119     }
00120     <span class="keywordflow">return</span> bRet;
00121 
00122 }
00123 
00124 
00125 
00126 <span class="comment">/******************************Public*Routine******************************\</span>
00127 <span class="comment">*   Process win.ini line</span>
00128 <span class="comment">*</span>
00129 <span class="comment">* History:</span>
00130 <span class="comment">*  24-Oct-1995 -by- Bodin Dresevic [BodinD]</span>
00131 <span class="comment">* Wrote it.</span>
00132 <span class="comment">\**************************************************************************/</span>
00133 
<a name="l00134"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a3">00134</a> <span class="preprocessor">#define EXT_TRUETYPE  L"(TrueType)"</span>
<a name="l00135"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a4">00135</a> <span class="preprocessor"></span><span class="preprocessor">#define EXT_FOT       L".FOT"</span>
00136 <span class="preprocessor"></span>
00137 
<a name="l00138"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a18">00138</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a18">vProcessFontEntry</a>(
00139     HKEY   hkey,
00140     WCHAR *pwcValueName,
00141     ULONG ulValueNameLength,
00142     WCHAR *pwcFileName,
00143     ULONG ulFileNameLength
00144 )
00145 {
00146     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00147     UNICODE_STRING UnicodeString;
00148     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bFot = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149     WCHAR awcTTF[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00150     WCHAR awcTmpBuf[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00151     WCHAR *pwcTTF;
00152     FLONG fl, fl2;
00153     FLONG flEmbed;
00154     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwPidTid;
00155     WCHAR awcValueName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];  <span class="comment">// null-terminated pwcValueName</span>
00156     WCHAR awcFileName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];   <span class="comment">// null-terminated pwcFileName</span>
00157     
00158 
00159     <span class="comment">// Make sure the ValueName is null-terminated</span>
00160     ulValueNameLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> - 1, ulValueNameLength);
00161     <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcValueName, pwcValueName, ulValueNameLength);
00162     
00163     <span class="comment">// Make sure the FileName is null-terminated</span>
00164     ulFileNameLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> - 1, ulFileNameLength);
00165     <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcFileName, pwcFileName, ulFileNameLength);
00166     
00167     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a17">bCheckFontEntry</a>(awcValueName, <a class="code" href="../../d2/d6/fntsweep_8c.html#a3">EXT_TRUETYPE</a>))
00168     {
00169     <span class="comment">// This is a tt entry, either .fot or .ttf</span>
00170 
00171         <span class="keywordflow">if</span> (bFot = <a class="code" href="../../d2/d6/fntsweep_8c.html#a17">bCheckFontEntry</a>(awcFileName, <a class="code" href="../../d2/d6/fntsweep_8c.html#a4">EXT_FOT</a>))
00172         {
00173         <span class="comment">// this is an .fot entry, must find ttf pointed to by .fot,</span>
00174         <span class="comment">// but first must get the full path to the .fot file</span>
00175         <span class="comment">// for cGetTTFFromFOT routine expects it. We will also need</span>
00176         <span class="comment">// the full path to the .fot file so that we can delete it</span>
00177         <span class="comment">// eventually.</span>
00178 
00179             <span class="keywordflow">if</span> (bMakePathNameW(awcTmpBuf, awcFileName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;fl2))
00180             {
00181                 <span class="keywordflow">if</span> (cGetTTFFromFOT(awcTmpBuf, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>, awcTTF, &amp;fl, &amp;flEmbed, &amp;dwPidTid, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
00182                     !(fl &amp; FONT_ISNOT_FOT))
00183                 {
00184                 <span class="comment">// fix the entry to point to .ttf file. At this point</span>
00185                 <span class="comment">// awcTTF points to the FULL path to the .ttf file.</span>
00186                 <span class="comment">// However, we will only need a relative path to the</span>
00187                 <span class="comment">// .ttf file, when the .ttf file is in the %windir%\system</span>
00188                 <span class="comment">// or %windir%\fonts directories. In case the file is in the</span>
00189                 <span class="comment">// %windir%\system directory we shall copy it to %windir%\fonts</span>
00190                 <span class="comment">// directory and write the relative path to the registry.</span>
00191                 <span class="comment">// In case it is in the %windir%\fonts directory we do not</span>
00192                 <span class="comment">// touch the file and also just write the relative path to the</span>
00193                 <span class="comment">// registry. In any other case we just write the full .ttf</span>
00194                 <span class="comment">// path to the registry.</span>
00195 
00196                 <span class="comment">// first delete the .fot file, it is no longer needed</span>
00197 
00198                     <span class="keywordflow">if</span> (bFot &amp;&amp; !<a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a>)
00199                     {
00200                         UserVerify(DeleteFileW(awcTmpBuf));
00201                     }
00202 
00203                     <span class="keywordflow">if</span> ((fl &amp; (FONT_IN_FONTS_DIR | FONT_IN_SYSTEM_DIR)) == 0)
00204                     {
00205                     <span class="comment">// if ttf file is not in either the system or the fonts</span>
00206                     <span class="comment">// directories, just write the full path to the registry</span>
00207 
00208                         pwcTTF = awcTTF;
00209                     }
00210                     <span class="keywordflow">else</span>
00211                     {
00212                     <span class="comment">// find the bare file part, this is what will be written</span>
00213                     <span class="comment">// in the registry</span>
00214 
00215                         pwcTTF = &amp;awcTTF[wcslen(awcTTF) - 1];
00216                         <span class="keywordflow">while</span> ((pwcTTF &gt;= awcTTF) &amp;&amp; (*pwcTTF != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp; (*pwcTTF != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>))
00217                             pwcTTF--;
00218                         pwcTTF++;
00219 
00220                         <span class="keywordflow">if</span> (fl &amp; FONT_IN_SYSTEM_DIR)
00221                         {
00222                         <span class="comment">// need to move the ttf to fonts dir, can reuse the</span>
00223                         <span class="comment">// buffer on the stack:</span>
00224 
00225                             wcscpy(awcTmpBuf, <a class="code" href="../../d2/d6/fntsweep_8c.html#a12">gpwcFontsDir</a>);
00226                             lstrcatW(awcTmpBuf, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00227                             lstrcatW(awcTmpBuf, pwcTTF);
00228 
00229                         <span class="comment">// note that MoveFile should succeed, for if there was</span>
00230                         <span class="comment">// a ttf file of the same file name in %windir%\fonts dir</span>
00231                         <span class="comment">// we would not have been in this code path.</span>
00232 
00233                                 RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"Moving %ws to %ws"</span>, awcTTF, awcTmpBuf);
00234                                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a>)
00235                                 {
00236                                     UserVerify(MoveFileW(awcTTF, awcTmpBuf));
00237                                 }
00238                                 <span class="keywordflow">else</span>
00239                                 {
00240                                 <span class="comment">// Boolean value TRUE means "do not copy if target exists"</span>
00241 
00242                                     UserVerify(CopyFileW(awcTTF, awcTmpBuf, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00243                                 }
00244                         }
00245                     }
00246 
00247                     RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"writing to the registry:\n    %ws=%ws"</span>, pwcValueName, pwcTTF);
00248                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, awcValueName);
00249                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(hkey,
00250                                            &amp;UnicodeString,
00251                                            0,
00252                                            REG_SZ,
00253                                            pwcTTF,
00254                                            (wcslen(pwcTTF)+1) * <span class="keyword">sizeof</span>(WCHAR));
00255                     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00256                 }
00257 <span class="preprocessor">                #if DBG</span>
00258 <span class="preprocessor"></span>                <span class="keywordflow">else</span>
00259                 {
00260                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"Could not locate ttf pointed to by %ws"</span>, awcTmpBuf);
00261                 }
00262 <span class="preprocessor">                #endif</span>
00263 <span class="preprocessor"></span>            }
00264 <span class="preprocessor">            #if DBG</span>
00265 <span class="preprocessor"></span>            <span class="keywordflow">else</span>
00266             {
00267                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"Could not locate .fot:  %ws"</span>, awcFileName);
00268             }
00269 <span class="preprocessor">            #endif</span>
00270 <span class="preprocessor"></span>        }
00271     }
00272     <span class="keywordflow">else</span>
00273     {
00274     <span class="comment">// not a true type case. little bit simpler,</span>
00275     <span class="comment">// we will use awcTTF buffer for the full path name, and pwcTTF</span>
00276     <span class="comment">// as local variable even though these TTF names are misnomer</span>
00277     <span class="comment">// for these are not tt fonts</span>
00278 
00279         <span class="keywordflow">if</span> (bMakePathNameW(awcTTF, awcFileName,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;fl))
00280         {
00281         <span class="comment">// At this point</span>
00282         <span class="comment">// awcTTF points to the FULL path to the font file.</span>
00283 
00284         <span class="comment">// If the font is in the system subdirectory we will just move it</span>
00285         <span class="comment">// to the fonts subdirectory. If the path in the registry is relative</span>
00286         <span class="comment">// we will leave it alone. If it is an absolute path, we shall</span>
00287         <span class="comment">// fix the registry entry to only contain relative path, the</span>
00288         <span class="comment">// absolute path is redundant.</span>
00289 
00290             <span class="keywordflow">if</span> (fl &amp; (FONT_IN_SYSTEM_DIR | FONT_IN_FONTS_DIR))
00291             {
00292             <span class="comment">// find the bare file part, this is what will be written</span>
00293             <span class="comment">// in the registry</span>
00294 
00295                 pwcTTF = &amp;awcTTF[wcslen(awcTTF) - 1];
00296                 <span class="keywordflow">while</span> ((pwcTTF &gt;= awcTTF) &amp;&amp; (*pwcTTF != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp; (*pwcTTF != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>))
00297                     pwcTTF--;
00298                 pwcTTF++;
00299 
00300                 <span class="keywordflow">if</span> (fl &amp; FONT_IN_SYSTEM_DIR)
00301                 {
00302                 <span class="comment">// need to move the font to fonts dir, can reuse the</span>
00303                 <span class="comment">// buffer on the stack to build the full destination path</span>
00304 
00305                     wcscpy(awcTmpBuf, <a class="code" href="../../d2/d6/fntsweep_8c.html#a12">gpwcFontsDir</a>);
00306                     lstrcatW(awcTmpBuf, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00307                     lstrcatW(awcTmpBuf, pwcTTF);
00308 
00309                 <span class="comment">// note that MoveFile should succeed, for if there was</span>
00310                 <span class="comment">// a font file of the same file name in %windir%\fonts dir</span>
00311                 <span class="comment">// we would not have been in this code path. The only time</span>
00312                 <span class="comment">// it could fail if the path in the registry is absolute.</span>
00313 
00314                     RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"Moving %ws to %ws"</span>, awcTTF, awcTmpBuf);
00315                     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a>)
00316                     {
00317                         UserVerify(MoveFileW(awcTTF, awcTmpBuf));
00318                     }
00319                     <span class="keywordflow">else</span>
00320                     {
00321                     <span class="comment">// Boolean value TRUE means "do not copy if target exists"</span>
00322 
00323                         UserVerify(CopyFileW(awcTTF, awcTmpBuf, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00324                     }
00325                 }
00326 
00327             <span class="comment">// check if the file path in the registry is absolute,</span>
00328             <span class="comment">// if so make it relative:</span>
00329 
00330                 <span class="keywordflow">if</span> (!(fl &amp; FONT_RELATIVE_PATH))
00331                 {
00332                     RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"writing to the registry:\n    %ws=%ws"</span>, pwcValueName, pwcTTF);
00333                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, awcValueName);
00334                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(hkey,
00335                                            &amp;UnicodeString,
00336                                            0,
00337                                            REG_SZ,
00338                                            pwcTTF,
00339                                            (wcslen(pwcTTF)+1) * <span class="keyword">sizeof</span>(WCHAR));
00340                     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00341                 }
00342             }
00343         }
00344     }
00345 }
00346 
00347 
00348 <span class="comment">/******************************Public*Routine******************************\</span>
00349 <span class="comment">*</span>
00350 <span class="comment">* VOID vMoveFileFromSystemToFontsDir(WCHAR *pwcFile)</span>
00351 <span class="comment">*</span>
00352 <span class="comment">* History:</span>
00353 <span class="comment">*  24-Apr-1996 -by- Bodin Dresevic [BodinD]</span>
00354 <span class="comment">* Wrote it.</span>
00355 <span class="comment">\**************************************************************************/</span>
00356 
00357 
00358 
00359 
<a name="l00360"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a19">00360</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a19">vMoveFileFromSystemToFontsDir</a>(WCHAR *pwcFile)
00361 {
00362     WCHAR awcTmpBuf[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00363     WCHAR awcTmp[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00364     FLONG fl;
00365     WCHAR *pwcTmp;
00366 
00367 <span class="preprocessor">#if DBG</span>
00368 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bOk;
00369 <span class="preprocessor">#endif</span>
00370 <span class="preprocessor"></span>
00371     <span class="keywordflow">if</span> (bMakePathNameW(awcTmp, pwcFile,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;fl))
00372     {
00373     <span class="comment">// If the font is in the system subdirectory we will just move it</span>
00374     <span class="comment">// to the fonts subdirectory. The path in the registry is relative</span>
00375     <span class="comment">// and we will leave it alone.</span>
00376 
00377         <span class="keywordflow">if</span>
00378         (
00379             (fl &amp; (FONT_IN_SYSTEM_DIR | FONT_RELATIVE_PATH)) ==
00380             (FONT_IN_SYSTEM_DIR | FONT_RELATIVE_PATH)
00381         )
00382         {
00383         <span class="comment">// find the bare file part, this is what will be written</span>
00384         <span class="comment">// in the registry</span>
00385 
00386             pwcTmp = &amp;awcTmp[wcslen(awcTmp) - 1];
00387             <span class="keywordflow">while</span> ((pwcTmp &gt;= awcTmp) &amp;&amp; (*pwcTmp != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp; (*pwcTmp != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>))
00388                 pwcTmp--;
00389 
00390             <span class="keywordflow">if</span> (pwcTmp &gt; awcTmp)
00391                 pwcTmp++;
00392 
00393         <span class="comment">// need to move the font to fonts dir, can reuse the</span>
00394         <span class="comment">// buffer on the stack to build the full destination path</span>
00395 
00396             wcscpy(awcTmpBuf, <a class="code" href="../../d2/d6/fntsweep_8c.html#a12">gpwcFontsDir</a>);
00397             lstrcatW(awcTmpBuf, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00398             lstrcatW(awcTmpBuf, pwcTmp);
00399 
00400         <span class="comment">// note that MoveFile should succeed, for if there was</span>
00401         <span class="comment">// a font file of the same file name in %windir%\fonts dir</span>
00402         <span class="comment">// we would not have been in this code path.</span>
00403 
00404 <span class="preprocessor">            #if DBG</span>
00405 <span class="preprocessor"></span>                bOk =
00406 <span class="preprocessor">            #endif</span>
00407 <span class="preprocessor"></span>                MoveFileW(awcTmp, awcTmpBuf);
00408 
00409             RIPMSG3(RIP_VERBOSE,
00410                     <span class="stringliteral">"move %ws to %ws %s"</span>,
00411                     awcTmp,
00412                     awcTmpBuf,
00413                     (bOk) ? <span class="stringliteral">"succeeded"</span> : <span class="stringliteral">"failed"</span>);
00414         }
00415 <span class="preprocessor">        #if DBG</span>
00416 <span class="preprocessor"></span>        <span class="keywordflow">else</span>
00417         {
00418             RIPMSG2(RIP_WARNING,
00419                     <span class="stringliteral">"File %ws not in system directory, fl = 0x%lx\n"</span>,
00420                     awcTmp, fl);
00421         }
00422 <span class="preprocessor">        #endif</span>
00423 <span class="preprocessor"></span>
00424     }
00425 <span class="preprocessor">    #if DBG</span>
00426 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
00427     {
00428         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Could not locate %ws"</span>, pwcFile);
00429     }
00430 <span class="preprocessor">    #endif</span>
00431 <span class="preprocessor"></span>}
00432 
00433 
00434 
00435 <span class="comment">/******************************Public*Routine******************************\</span>
00436 <span class="comment">*</span>
00437 <span class="comment">* VOID vProcessType1FontEntry</span>
00438 <span class="comment">*</span>
00439 <span class="comment">*</span>
00440 <span class="comment">* Effects: All this routine does is to check if pwcPFM and pwcPFB pointed to</span>
00441 <span class="comment">*          by pwcValueData point to files in the %windir%system directory</span>
00442 <span class="comment">*          and if so copies these type 1 files to %windir%\fonts directory</span>
00443 <span class="comment">*</span>
00444 <span class="comment">* History:</span>
00445 <span class="comment">*  20-Nov-1995 -by- Bodin Dresevic [BodinD]</span>
00446 <span class="comment">* Wrote it.</span>
00447 <span class="comment">\**************************************************************************/</span>
00448 
00449 
<a name="l00450"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a20">00450</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a20">vProcessType1FontEntry</a>(
00451     HKEY   hkey,
00452     WCHAR *pwcValueName,
00453     ULONG ulValueNameLength,
00454     WCHAR *pwcValueData,
00455     ULONG ulValueDataLength
00456 )
00457 {
00458     WCHAR *pwcPFM, *pwcPFB;
00459 
00460     UNREFERENCED_PARAMETER(hkey);
00461     UNREFERENCED_PARAMETER(pwcValueName);
00462     UNREFERENCED_PARAMETER(ulValueNameLength);
00463     UNREFERENCED_PARAMETER(ulValueDataLength);
00464 
00465 <span class="comment">// skip unused boolean value in this multi reg_sz string:</span>
00466 
00467     <span class="keywordflow">if</span> ((pwcValueData[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) &amp;&amp; (pwcValueData[1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>))
00468     {
00469         pwcPFM = &amp;pwcValueData[2];
00470         pwcPFB = pwcPFM + wcslen(pwcPFM) + 1; <span class="comment">// add 1 for zero separator</span>
00471 
00472         <a class="code" href="../../d2/d6/fntsweep_8c.html#a19">vMoveFileFromSystemToFontsDir</a>(pwcPFM);
00473         <a class="code" href="../../d2/d6/fntsweep_8c.html#a19">vMoveFileFromSystemToFontsDir</a>(pwcPFB);
00474     }
00475 }
00476 
00477 
00478 <span class="comment">/******************************Public*Routine******************************\</span>
00479 <span class="comment">*</span>
00480 <span class="comment">* VOID vAddRemote/LocalType1Font</span>
00481 <span class="comment">*</span>
00482 <span class="comment">* History:</span>
00483 <span class="comment">*  25-Apr-1996 -by- Bodin Dresevic [BodinD]</span>
00484 <span class="comment">* Wrote it.</span>
00485 <span class="comment">\**************************************************************************/</span>
00486 
00487 
00488 
<a name="l00489"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a21">00489</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a21">vAddType1Font</a>(
00490     WCHAR *pwcValueData,
00491     DWORD  dwFlags
00492 )
00493 {
00494     WCHAR *pwcPFM, *pwcPFB, *pwcMMM;
00495 
00496 <span class="preprocessor">    #if DBG</span>
00497 <span class="preprocessor"></span>    <span class="keywordtype">int</span> iRet;
00498 <span class="preprocessor">    #endif</span>
00499 <span class="preprocessor"></span>
00500 <span class="comment">// skip unused boolean value in this multi reg_sz string:</span>
00501 
00502     <span class="keywordflow">if</span> ((pwcValueData[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) &amp;&amp; (pwcValueData[1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>))
00503     {
00504         pwcPFM = &amp;pwcValueData[2];
00505         pwcPFB = pwcPFM + wcslen(pwcPFM) + 1; <span class="comment">// add 1 for zero separator</span>
00506         pwcMMM = pwcPFB + wcslen(pwcPFB) + 1; <span class="comment">// may of may not be there.</span>
00507 
00508     <span class="comment">// replace space by separator and call addfontresourcew</span>
00509 
00510         pwcPFB[-1] = PATH_SEPARATOR;
00511 
00512     <span class="comment">// if this is a multiple master font, need one more separator:</span>
00513 
00514         <span class="keywordflow">if</span> (pwcMMM[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)
00515             pwcMMM[-1] = PATH_SEPARATOR;
00516 
00517 <span class="preprocessor">        #if DBG</span>
00518 <span class="preprocessor"></span>            iRet =
00519 <span class="preprocessor">        #endif</span>
00520 <span class="preprocessor"></span>
00521         GdiAddFontResourceW(pwcPFM, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00522 
00523 <span class="preprocessor">        #if DBGSWEEP</span>
00524 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%ld = GdiAddFontResourceW(%ws, 0x%lx);\n"</span>,
00525                 iRet, pwcPFM, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00526 <span class="preprocessor">        #endif</span>
00527 <span class="preprocessor"></span>    }
00528 }
00529 
00530 
<a name="l00531"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a22">00531</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a22">vAddRemoteType1Font</a>(
00532     HKEY   hkey,
00533     WCHAR *pwcValueName,
00534     ULONG ulValueNameLength,
00535     WCHAR *pwcValueData,
00536     ULONG ulValueDataLength
00537 )
00538 {
00539     UNREFERENCED_PARAMETER(hkey);
00540     UNREFERENCED_PARAMETER(pwcValueName);
00541     UNREFERENCED_PARAMETER(ulValueNameLength);
00542     UNREFERENCED_PARAMETER(ulValueDataLength);
00543     <a class="code" href="../../d2/d6/fntsweep_8c.html#a21">vAddType1Font</a>(pwcValueData, AFRW_ADD_REMOTE_FONT);
00544 }
00545 
<a name="l00546"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a23">00546</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a23">vAddLocalType1Font</a>(
00547     HKEY   hkey,
00548     WCHAR *pwcValueName,
00549     ULONG ulValueNameLength,
00550     WCHAR *pwcValueData,
00551     ULONG ulValueDataLength
00552 )
00553 {
00554     UNREFERENCED_PARAMETER(hkey);
00555     UNREFERENCED_PARAMETER(pwcValueName);
00556     UNREFERENCED_PARAMETER(ulValueNameLength);
00557     UNREFERENCED_PARAMETER(ulValueDataLength);
00558     <a class="code" href="../../d2/d6/fntsweep_8c.html#a21">vAddType1Font</a>(pwcValueData, AFRW_ADD_LOCAL_FONT);
00559 }
00560 
00561 
<a name="l00562"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a14">00562</a> <span class="keyword">typedef</span>  <a class="code" href="../../d0/d6/iop_8h.html#a145">VOID</a> (*<a class="code" href="../../d2/d6/fntsweep_8c.html#a14">PFNENTRY</a>)(HKEY hkey, WCHAR *, ULONG, WCHAR *, ULONG);
00563 
00564 
00565 <span class="comment">/******************************Public*Routine******************************\</span>
00566 <span class="comment">*</span>
00567 <span class="comment">* VOID vFontSweep()</span>
00568 <span class="comment">*</span>
00569 <span class="comment">* This is the main routine in this module. Checks if the fonts need to be</span>
00570 <span class="comment">* "sweeped" and does so if need be.</span>
00571 <span class="comment">*</span>
00572 <span class="comment">* History:</span>
00573 <span class="comment">*  27-Oct-1995 -by- Bodin Dresevic [BodinD]</span>
00574 <span class="comment">* Wrote it.</span>
00575 <span class="comment">\**************************************************************************/</span>
00576 
<a name="l00577"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a24">00577</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a24">vSweepFonts</a>(
00578     PCWSTR   pwszFontListKey,       <span class="comment">// font list key</span>
00579     PCWSTR   pwszFontSweepKey,      <span class="comment">// the corresponding sweep key</span>
00580     PFNENTRY pfnProcessFontEntry,   <span class="comment">// function that processes individual entry</span>
00581     BOOL     bForceEnum             <span class="comment">// force enumeration</span>
00582     )
00583 {
00584     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      cjMaxValueName;
00585     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      iFont;
00586     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00587     UNICODE_STRING UnicodeString;
00588     OBJECT_ATTRIBUTES ObjA;
00589     KEY_FULL_INFORMATION KeyInfo;
00590     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      dwReturnLength;
00591 
00592     PKEY_VALUE_FULL_INFORMATION KeyValueInfo;
00593     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>       *pjValueData;
00594 
00595     HKEY       hkey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00596     <span class="keyword">struct </span>{
00597         KEY_VALUE_PARTIAL_INFORMATION;
00598         LARGE_INTEGER;
00599     } SweepValueInfo;
00600     LARGE_INTEGER LastSweepTime;
00601     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00602 
00603     HKEY       hkeyLastSweep;
00604     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      cjData;
00605 
00606     <span class="keywordflow">if</span> (!bForceEnum)
00607     {
00608     <span class="comment">// first check if anything needs to be done, that is, if anybody</span>
00609     <span class="comment">// touched the [Fonts] section of the registry since the last time we sweeped it.</span>
00610     <span class="comment">// get the time of the last sweep of the fonts section of the registry:</span>
00611 
00612         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, pwszFontSweepKey);
00613         InitializeObjectAttributes(&amp;ObjA,
00614                                    &amp;UnicodeString,
00615                                    OBJ_CASE_INSENSITIVE,
00616                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00617                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00618         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkeyLastSweep,
00619                            KEY_READ | KEY_WRITE,
00620                            &amp;ObjA);
00621 
00622         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00623         {
00624             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwDisposition;
00625 
00626         <span class="comment">// We are running for the first time, we need to create the key</span>
00627         <span class="comment">// for it does not exist as yet at this time</span>
00628 
00629             bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00630 
00631         <span class="comment">// Create the key, open it for writing, since we will have to</span>
00632         <span class="comment">// store the time when the [Fonts] section of the registry was last swept</span>
00633 
00634             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;hkeyLastSweep,
00635                                  KEY_WRITE,
00636                                  &amp;ObjA,
00637                                  0,
00638                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00639                                  REG_OPTION_NON_VOLATILE,
00640                                  &amp;dwDisposition);
00641 
00642             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00643                 <span class="keywordflow">return</span>;
00644         }
00645         <span class="keywordflow">else</span>
00646         {
00647             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d6/fntsweep_8c.html#a0">LAST_SWEEP_TIME</a>);
00648             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hkeyLastSweep,
00649                                      &amp;UnicodeString,
00650                                      KeyValuePartialInformation,
00651                                      &amp;SweepValueInfo,
00652                                      <span class="keyword">sizeof</span>(SweepValueInfo),
00653                                      &amp;dwReturnLength);
00654             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00655             {
00656                 bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// force sweep, something is suspicious</span>
00657             }
00658             <span class="keywordflow">else</span>
00659             {
00660                 UserAssert(SweepValueInfo.Type == REG_BINARY);
00661                 UserAssert(SweepValueInfo.DataLength == <span class="keyword">sizeof</span>(LastSweepTime));
00662                 RtlCopyMemory(&amp;LastSweepTime, &amp;SweepValueInfo.Data, <span class="keyword">sizeof</span>(LastSweepTime));
00663             }
00664         }
00665     }
00666     <span class="keywordflow">else</span>
00667     {
00668         bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00669     }
00670 
00671 <span class="comment">// now open the Fonts key and get the time the key last changed:</span>
00672 <span class="comment">// now get the time of the time of the last change is bigger than</span>
00673 <span class="comment">// the time of last sweep, must sweep again:</span>
00674 
00675     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, pwszFontListKey);
00676     InitializeObjectAttributes(&amp;ObjA,
00677                                &amp;UnicodeString,
00678                                OBJ_CASE_INSENSITIVE,
00679                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00680                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00681     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkey,
00682                        KEY_READ | KEY_WRITE,
00683                        &amp;ObjA);
00684 
00685     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00686     {
00687     <span class="comment">// get the number of entries in the [Fonts] section</span>
00688 
00689         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkey,
00690                     KeyFullInformation,
00691                     &amp;KeyInfo,
00692                     <span class="keyword">sizeof</span>(KeyInfo),
00693                     &amp;dwReturnLength);
00694 
00695         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; KeyInfo.Values)
00696         {
00697             UserAssert(!(KeyInfo.ClassLength | KeyInfo.SubKeys | KeyInfo.MaxNameLen | KeyInfo.MaxClassLen));
00698 
00699         <span class="comment">// now let us check if the fonts need to be sweeped. This is the case</span>
00700         <span class="comment">// when the registry last write time is bigger than the last sweep time</span>
00701 
00702             <span class="keywordflow">if</span> (!bSweep)
00703             {
00704                 <span class="keywordflow">if</span> (KeyInfo.LastWriteTime.QuadPart != LastSweepTime.QuadPart ) {
00705                     bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00706                 }
00707             }
00708 
00709         <span class="comment">// init system dir, we will need it:</span>
00710 
00711             <span class="keywordflow">if</span> (bSweep &amp;&amp;
00712                 bInitSystemAndFontsDirectoriesW(&amp;<a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>, &amp;<a class="code" href="../../d2/d6/fntsweep_8c.html#a12">gpwcFontsDir</a>))
00713             {
00714             <span class="comment">// alloc buffer big enough to hold the biggest ValueName and ValueData</span>
00715 
00716                 cjMaxValueName = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfo.MaxValueNameLen + <span class="keyword">sizeof</span>(WCHAR));
00717 
00718             <span class="comment">// allocate temporary buffer into which we are going to suck the contents</span>
00719             <span class="comment">// of the registry</span>
00720 
00721                 KeyInfo.MaxValueDataLen = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfo.MaxValueDataLen);
00722                 cjData = cjMaxValueName +    <span class="comment">// space for the value name</span>
00723                          KeyInfo.MaxValueDataLen ;    <span class="comment">// space for the value data</span>
00724 
00725                 <span class="keywordflow">if</span> (KeyValueInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(*KeyValueInfo) + cjData))
00726                 {
00727                     <span class="keywordflow">for</span> (iFont = 0; iFont &lt; KeyInfo.Values; iFont++)
00728                     {
00729                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(
00730                                     hkey,
00731                                     iFont,
00732                                     KeyValueFullInformation,
00733                                     KeyValueInfo,
00734                                     <span class="keyword">sizeof</span>(*KeyValueInfo) + cjData,
00735                                     &amp;dwReturnLength);
00736 
00737                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00738                         {
00739                             UserAssert(KeyValueInfo-&gt;NameLength &lt;= KeyInfo.MaxValueNameLen);
00740                             UserAssert(KeyValueInfo-&gt;DataLength &lt;= KeyInfo.MaxValueDataLen);
00741                             UserAssert((KeyValueInfo-&gt;Type == REG_SZ) || (KeyValueInfo-&gt;Type == REG_MULTI_SZ));
00742 
00743                         <span class="comment">// data goes into the second half of the buffer</span>
00744 
00745                             pjValueData = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)KeyValueInfo + KeyValueInfo-&gt;DataOffset;
00746 
00747                         <span class="comment">// see if the font files are where the registry claims they are.</span>
00748                         <span class="comment">// It is unfortunate we have to do this because SearchPathW</span>
00749                         <span class="comment">// is slow because it touches the disk.</span>
00750 
00751                             (*pfnProcessFontEntry)(hkey,
00752                                                    KeyValueInfo-&gt;Name,
00753                                                    KeyValueInfo-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR),
00754                                                    (WCHAR *)pjValueData,
00755                                                    KeyValueInfo-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR));
00756                         }
00757                     }
00758 
00759                     <span class="keywordflow">if</span> (!bForceEnum)
00760                     {
00761                     <span class="comment">// now that the sweep is completed, get the last write time</span>
00762                     <span class="comment">// and store it as the LastSweepTime at the appropriate location</span>
00763 
00764                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkey,
00765                                     KeyFullInformation,
00766                                     &amp;KeyInfo,
00767                                     <span class="keyword">sizeof</span>(KeyInfo),
00768                                     &amp;dwReturnLength);
00769                         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00770 
00771                     <span class="comment">// now remember the result</span>
00772 
00773                         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d6/fntsweep_8c.html#a0">LAST_SWEEP_TIME</a>);
00774                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(hkeyLastSweep,
00775                                                &amp;UnicodeString,
00776                                                0,
00777                                                REG_BINARY,
00778                                                &amp;KeyInfo.LastWriteTime,
00779                                                <span class="keyword">sizeof</span>(KeyInfo.LastWriteTime));
00780                         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00781                     }
00782 
00783                 <span class="comment">// free the memory that will be no longer needed</span>
00784 
00785                     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(KeyValueInfo);
00786                 }
00787             }
00788         }
00789         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkey);
00790     }
00791 
00792     <span class="keywordflow">if</span> (!bForceEnum)
00793     {
00794         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkeyLastSweep);
00795     }
00796 }
00797 
00798 
00799 <span class="comment">/******************************Public*Routine******************************\</span>
00800 <span class="comment">*</span>
00801 <span class="comment">* BOOL bLoadableFontDrivers()</span>
00802 <span class="comment">*</span>
00803 <span class="comment">* open the font drivers key and check if there are any entries, if so</span>
00804 <span class="comment">* return true. If that is the case we will call AddFontResourceW on</span>
00805 <span class="comment">* Type 1 fonts at boot time, right after user had logged on</span>
00806 <span class="comment">* PostScript printer drivers are not initialized at this time yet,</span>
00807 <span class="comment">* it is safe to do it at this time.</span>
00808 <span class="comment">* Effects:</span>
00809 <span class="comment">*</span>
00810 <span class="comment">* Warnings:</span>
00811 <span class="comment">*</span>
00812 <span class="comment">* History:</span>
00813 <span class="comment">*  24-Apr-1996 -by- Bodin Dresevic [BodinD]</span>
00814 <span class="comment">* Wrote it.</span>
00815 <span class="comment">\**************************************************************************/</span>
00816 
00817 
<a name="l00818"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a25">00818</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a25">bLoadableFontDrivers</a>()
00819 {
00820     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00821     UNICODE_STRING       UnicodeString;
00822     OBJECT_ATTRIBUTES    ObjA;
00823     KEY_FULL_INFORMATION KeyInfo;
00824     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                dwReturnLength;
00825     HKEY                 hkey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00826     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                 bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00827 
00828 <span class="comment">// open the font drivers key and check if there are any entries, if so</span>
00829 <span class="comment">// return true. If that is the case we will call AddFontResourceW on</span>
00830 <span class="comment">// Type 1 fonts at boot time, right after user had logged on</span>
00831 <span class="comment">// PostScript printer drivers are not initialized at this time yet,</span>
00832 <span class="comment">// it is safe to do it at this time.</span>
00833 
00834     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d6/fntsweep_8c.html#a10">pwszFontDrivers</a>);
00835     InitializeObjectAttributes(&amp;ObjA,
00836                                &amp;UnicodeString,
00837                                OBJ_CASE_INSENSITIVE,
00838                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00839                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00840     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkey,
00841                        KEY_READ,
00842                        &amp;ObjA);
00843 
00844     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00845     {
00846     <span class="comment">// get the number of entries in the [Fonts] section</span>
00847 
00848         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkey,
00849                     KeyFullInformation,
00850                     &amp;KeyInfo,
00851                     <span class="keyword">sizeof</span>(KeyInfo),
00852                     &amp;dwReturnLength);
00853 
00854         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; KeyInfo.Values)
00855         {
00856             UserAssert(!(KeyInfo.ClassLength | KeyInfo.SubKeys | KeyInfo.MaxNameLen | KeyInfo.MaxClassLen));
00857 
00858         <span class="comment">// externally loadable drivers are present, force sweep</span>
00859 
00860             bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00861         }
00862 
00863         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkey);
00864     }
00865     <span class="keywordflow">return</span> bRet;
00866 }
00867 
00868 
00869 
00870 <span class="comment">/***********************Public*Routine******************************\</span>
00871 <span class="comment">*</span>
00872 <span class="comment">* BOOL bCheckAndDeleteTTF()</span>
00873 <span class="comment">*</span>
00874 <span class="comment">* Checks whether there is a converted TTF corresponding to</span>
00875 <span class="comment">* a Type1 font. Delete the TTF file and the reg entry if there is.</span>
00876 <span class="comment">*</span>
00877 <span class="comment">* History:</span>
00878 <span class="comment">*  29-Jan-1998 -by- Xudong Wu [TessieW]</span>
00879 <span class="comment">* Wrote it.</span>
00880 <span class="comment">\*******************************************************************/</span>
00881 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a26">bCheckAndDeleteTTF</a>
<a name="l00882"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a26">00882</a> (
00883     HKEY    hkey,
00884     PKEY_FULL_INFORMATION pKeyInfo,
00885     PKEY_VALUE_FULL_INFORMATION KeyValueInfo,
00886     PKEY_VALUE_BASIC_INFORMATION KeyValueBasicInfo,
00887     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   cjData
00888 )
00889 {
00890     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00891     UNICODE_STRING UnicodeString;
00892     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwReturnLength;
00893     ULONG       iFont;
00894     WCHAR       awcTmp[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>], *pFontName, *pType1Name, *pwcFile;
00895     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bDelTTFfile, bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00896     FLONG       fl;
00897     WCHAR       awcType1Name[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];  <span class="comment">// null-terminated pType1Name</span>
00898     WCHAR       awcFontName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];   <span class="comment">// null-terminated pFontName</span>
00899     WCHAR       awcFile[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];       <span class="comment">// null-terminated pwcFile</span>
00900 
00901     <span class="comment">// pKeyInfo holds the full info on the key "Fonts"</span>
00902     <span class="keywordflow">for</span> (iFont = 0; iFont &lt; pKeyInfo-&gt;Values; iFont++)
00903     {
00904         RtlZeroMemory(KeyValueInfo-&gt;Name, cjData);
00905         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(
00906                     hkey,
00907                     iFont,
00908                     KeyValueFullInformation,
00909                     KeyValueInfo,
00910                     <span class="keyword">sizeof</span>(*KeyValueInfo) + cjData,
00911                     &amp;dwReturnLength);
00912 
00913         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00914         {
00915             UserAssert(KeyValueInfo-&gt;NameLength &lt;= pKeyInfo-&gt;MaxValueNameLen);
00916             UserAssert(KeyValueInfo-&gt;DataLength &lt;= pKeyInfo-&gt;MaxValueDataLen);
00917             UserAssert(KeyValueInfo-&gt;Type == REG_SZ);
00918 
00919             bDelTTFfile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00920 
00921             <span class="comment">// Make sure we use null-terminated strings</span>
00922             <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcType1Name,
00923                                  KeyValueBasicInfo-&gt;Name,
00924                                  KeyValueBasicInfo-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR));
00925             <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcFontName,
00926                                  KeyValueInfo-&gt;Name,
00927                                  KeyValueInfo-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR));
00928             <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcFile,
00929                                  (WCHAR *) ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)KeyValueInfo + KeyValueInfo-&gt;DataOffset),
00930                                  KeyValueInfo-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR));
00931             pType1Name = awcType1Name;
00932             pFontName = awcFontName;
00933             pwcFile = awcFile;
00934 
00935             <span class="keywordflow">while</span>((*pType1Name) &amp;&amp; (*pType1Name++ == *pFontName++))
00936                 ;
00937 
00938             <span class="comment">// if the font name match the type1 name</span>
00939             <span class="comment">// check whether this is a ttf font</span>
00940             <span class="keywordflow">if</span> ((*pType1Name == 0) &amp;&amp; (*pFontName++ == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>))
00941             {
00942                 WCHAR *pTrueType = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"(TrueType)"</span>;
00943 
00944                 <span class="keywordflow">while</span>(*pTrueType &amp;&amp; (*pTrueType++ == *pFontName++))
00945                     ;
00946                 <span class="keywordflow">if</span> (*pTrueType == 0)
00947                 {
00948                     bDelTTFfile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00949                 }
00950             }
00951 
00952             <span class="keywordflow">if</span> (bDelTTFfile)
00953             {
00954                 <span class="comment">// delete the converted TTF file</span>
00955                 <span class="keywordflow">if</span> (bRet = bMakePathNameW(awcTmp, pwcFile, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;fl))
00956                 {
00957                     UserVerify((bRet = DeleteFileW(awcTmp)));
00958                 }
00959 
00960                 <span class="comment">// remove the reg entry</span>
00961                 *pFontName = 0;
00962                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, awcFontName);
00963                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>(hkey, (PUNICODE_STRING)&amp;UnicodeString);
00964 
00965                 <span class="comment">// decrement the number of values under [Fonts]</span>
00966                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00967                     pKeyInfo-&gt;Values--;
00968                 <span class="keywordflow">else</span>
00969                     bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00970 
00971                 <span class="keywordflow">break</span>;
00972             }
00973         }
00974         <span class="keywordflow">else</span>
00975         {
00976             bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00977             <span class="keywordflow">break</span>;
00978         }
00979     }
00980 
00981     <span class="keywordflow">return</span> bRet;
00982 }
00983 
00984 
00985 <span class="comment">/***********************Public*Routine**************************\</span>
00986 <span class="comment">*</span>
00987 <span class="comment">* BOOL bCleanConvertedTTFs()</span>
00988 <span class="comment">*</span>
00989 <span class="comment">* Enumerate each entry under "Upgrade Type1" key, call</span>
00990 <span class="comment">* bCheckAndDeleteTTF() to remove the coverted TTFs.</span>
00991 <span class="comment">*</span>
00992 <span class="comment">* History:</span>
00993 <span class="comment">*  29-Jan-1998 -by- Xudong Wu [TessieW]</span>
00994 <span class="comment">* Wrote it.</span>
00995 <span class="comment">\***************************************************************/</span>
<a name="l00996"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a27">00996</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a27">bCleanConvertedTTFs</a>()
00997 {
00998     UNICODE_STRING UnicodeString;
00999     OBJECT_ATTRIBUTES ObjA;
01000     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01001     HKEY        hkeyFonts = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hkeyType1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01002     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwReturnLength;
01003     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       iFontT1, cjData;
01004     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       cjMaxValueNameT1, cjMaxValueNameFonts;
01005     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, bError = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01006 
01007     KEY_FULL_INFORMATION KeyInfoType1, KeyInfoFonts;
01008     PKEY_VALUE_BASIC_INFORMATION KeyValueBasicInfo;
01009     PKEY_VALUE_FULL_INFORMATION KeyValueInfo;
01010 
01011     <span class="comment">// Open and query the value from the "Type1 Fonts" key</span>
01012     <span class="comment">// No need to continue if not succeed or no Type1 font listed</span>
01013     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d6/fntsweep_8c.html#a5">pwszType1Key</a>);
01014     InitializeObjectAttributes(&amp;ObjA,
01015             &amp;UnicodeString,
01016             OBJ_CASE_INSENSITIVE,
01017             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01018             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01019 
01020     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkeyType1,
01021                     KEY_READ | KEY_WRITE,
01022                     &amp;ObjA);
01023 
01024     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01025     {
01026         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkeyType1,
01027                     KeyFullInformation,
01028                     &amp;KeyInfoType1,
01029                     <span class="keyword">sizeof</span>(KeyInfoType1),
01030                     &amp;dwReturnLength);
01031 
01032         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; KeyInfoType1.Values)
01033         {
01034             UserAssert(!(KeyInfoType1.ClassLength | KeyInfoType1.SubKeys |
01035                          KeyInfoType1.MaxNameLen | KeyInfoType1.MaxClassLen));
01036 
01037             cjMaxValueNameT1 = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfoType1.MaxValueNameLen + <span class="keyword">sizeof</span>(WCHAR));
01038 
01039             <span class="comment">// Alloc buffer big enough to hold the longest Name</span>
01040             <span class="keywordflow">if</span> (KeyValueBasicInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(*KeyValueBasicInfo) + cjMaxValueNameT1))
01041             {
01042                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d6/fntsweep_8c.html#a8">pwszFontsKey</a>);
01043                 InitializeObjectAttributes(&amp;ObjA,
01044                                     &amp;UnicodeString,
01045                                     OBJ_CASE_INSENSITIVE,
01046                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01047                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01048                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkeyFonts,
01049                                 KEY_READ | KEY_WRITE,
01050                                 &amp;ObjA);
01051 
01052                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01053                 {
01054                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkeyFonts,
01055                                 KeyFullInformation,
01056                                 &amp;KeyInfoFonts,
01057                                 <span class="keyword">sizeof</span>(KeyInfoFonts),
01058                                 &amp;dwReturnLength);
01059 
01060                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; KeyInfoFonts.Values)
01061                     {
01062                         UserAssert(!(KeyInfoFonts.ClassLength | KeyInfoFonts.SubKeys |
01063                                      KeyInfoFonts.MaxNameLen | KeyInfoFonts.MaxClassLen));
01064 
01065                         cjMaxValueNameFonts = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfoFonts.MaxValueNameLen + <span class="keyword">sizeof</span>(WCHAR));
01066                         KeyInfoFonts.MaxValueDataLen = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfoFonts.MaxValueDataLen);
01067                         cjData = cjMaxValueNameFonts + KeyInfoFonts.MaxValueDataLen;
01068 
01069                         <span class="comment">// Alloc buffer big enough to hold the longest Name and Value</span>
01070                         <span class="keywordflow">if</span> (KeyValueInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(*KeyValueInfo) + cjData))
01071                         {
01072                             <span class="comment">// Enum the "Type1 Fonts" key</span>
01073                             <span class="keywordflow">for</span> (iFontT1 = 0; iFontT1 &lt; KeyInfoType1.Values; iFontT1++)
01074                             {
01075                                 RtlZeroMemory(KeyValueBasicInfo-&gt;Name, cjMaxValueNameT1);
01076                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(
01077                                             hkeyType1,
01078                                             iFontT1,
01079                                             KeyValueBasicInformation,
01080                                             KeyValueBasicInfo,
01081                                             <span class="keyword">sizeof</span>(*KeyValueBasicInfo) + cjMaxValueNameT1,
01082                                             &amp;dwReturnLength);
01083 
01084                                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01085                                 {
01086                                     UserAssert(KeyValueBasicInfo-&gt;NameLength &lt;= KeyInfoType1.MaxValueNameLen);
01087                                     UserAssert(KeyValueBasicInfo-&gt;Type == REG_MULTI_SZ);
01088 
01089                                     <span class="comment">// For each Type1 font, check to see whether</span>
01090                                     <span class="comment">// there is corresponding converted TTF</span>
01091                                     <span class="comment">// Delete the TTF file and reg entry if any</span>
01092 
01093                                     bRet = <a class="code" href="../../d2/d6/fntsweep_8c.html#a26">bCheckAndDeleteTTF</a>(hkeyFonts, &amp;KeyInfoFonts, KeyValueInfo,
01094                                                             KeyValueBasicInfo, cjData);
01095                                     <span class="keywordflow">if</span> (!bRet)
01096                                     {
01097                                         bError = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01098                                     }
01099                                 }
01100                             }
01101                             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(KeyValueInfo);
01102                             <span class="comment">// no type1 fonts installed</span>
01103                             <span class="keywordflow">if</span> (KeyInfoType1.Values == 0)
01104                             {
01105                                 bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01106                             }
01107                         }
01108                     }
01109                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkeyFonts);
01110                 }  <span class="comment">// NtOpenKey (hkeyFonts)</span>
01111                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(KeyValueBasicInfo);
01112             }
01113         }  <span class="comment">// NtQueryKey (hkeyType1)</span>
01114         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkeyType1);
01115     }
01116 
01117     <span class="keywordflow">return</span> (bRet &amp;&amp; !bError);
01118 }
01119 
01120 
01121 <span class="comment">/***********************Public*Routine******************************\</span>
01122 <span class="comment">*</span>
01123 <span class="comment">* VOID vCleanConvertedTTFs()</span>
01124 <span class="comment">*</span>
01125 <span class="comment">* Delete the converted TTFs and clean the registry if there is any</span>
01126 <span class="comment">* TTFs generated from Type1 fonts.</span>
01127 <span class="comment">*</span>
01128 <span class="comment">* History:</span>
01129 <span class="comment">*  29-Jan-1998 -by- Xudong Wu [TessieW]</span>
01130 <span class="comment">* Wrote it.</span>
01131 <span class="comment">\*******************************************************************/</span>
<a name="l01132"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a28">01132</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a28">vCleanConvertedTTFs</a>()
01133 {
01134     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    bNeedUpgrade = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01135     UNICODE_STRING UnicodeString;
01136     OBJECT_ATTRIBUTES ObjA;
01137     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      dwReturnLength;
01138     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01139     HKEY       hkeyUpgradeType1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01140 
01141     <span class="keyword">struct </span>{
01142         KEY_VALUE_PARTIAL_INFORMATION;
01143         LARGE_INTEGER;
01144     } UpgradeValueInfo;
01145     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      UpgradeValue = 0;
01146 
01147     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d6/fntsweep_8c.html#a7">pwszUpdType1Key</a>);
01148     InitializeObjectAttributes(&amp;ObjA,
01149                            &amp;UnicodeString,
01150                            OBJ_CASE_INSENSITIVE,
01151                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01152                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01153 
01154     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkeyUpgradeType1,
01155                    KEY_READ | KEY_WRITE,
01156                    &amp;ObjA);
01157 
01158     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01159     {
01160         <span class="comment">// Key doesn't exist, run for the first time</span>
01161         <span class="comment">// Create the key, open it for writing</span>
01162 
01163         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwDisposition;
01164 
01165         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;hkeyUpgradeType1,
01166                          KEY_WRITE,
01167                          &amp;ObjA,
01168                          0,
01169                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01170                          REG_OPTION_NON_VOLATILE,
01171                          &amp;dwDisposition);
01172         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01173         {
01174             bNeedUpgrade = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01175         }
01176     }
01177     <span class="keywordflow">else</span>
01178     {
01179         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d6/fntsweep_8c.html#a1">UPGRADED_TYPE1</a>);
01180         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hkeyUpgradeType1,
01181                          &amp;UnicodeString,
01182                          KeyValuePartialInformation,
01183                          &amp;UpgradeValueInfo,
01184                          <span class="keyword">sizeof</span>(UpgradeValueInfo),
01185                          &amp;dwReturnLength);
01186 
01187         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01188         {
01189             UserAssert(UpgradeValueInfo.Type == REG_DWORD);
01190             UserAssert(UpgradeValueInfo.DataLength == <span class="keyword">sizeof</span>(UpgradeValue));
01191             RtlCopyMemory(&amp;UpgradeValue, &amp;UpgradeValueInfo.Data, <span class="keyword">sizeof</span>(UpgradeValue));
01192 
01193             <span class="comment">// Done if the value is non-zero.</span>
01194             <span class="keywordflow">if</span> (UpgradeValue == 0)
01195             {
01196                bNeedUpgrade = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01197             }
01198         }
01199     }
01200 
01201     <span class="keywordflow">if</span> (bNeedUpgrade)
01202     {
01203         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a27">bCleanConvertedTTFs</a>())
01204         {
01205             UpgradeValue = 1;
01206         }
01207 
01208         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d6/fntsweep_8c.html#a1">UPGRADED_TYPE1</a>);
01209         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(hkeyUpgradeType1,
01210               &amp;UnicodeString,
01211               0,
01212               REG_DWORD,
01213               &amp;UpgradeValue,
01214               <span class="keyword">sizeof</span>(UpgradeValue));
01215         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01216     }
01217 
01218     <span class="keywordflow">if</span> (hkeyUpgradeType1)
01219     {
01220         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkeyUpgradeType1);
01221     }
01222 }
01223 
01224 
01225 <span class="comment">/******************************Public*Routine******************************\</span>
01226 <span class="comment">*</span>
01227 <span class="comment">* VOID vFontSweep()</span>
01228 <span class="comment">*</span>
01229 <span class="comment">* Effects: The main routine, calls vSweepFonts to sweep "regular" fonts</span>
01230 <span class="comment">*          and then to sweep type 1 fonts</span>
01231 <span class="comment">*</span>
01232 <span class="comment">* History:</span>
01233 <span class="comment">*  20-Nov-1995 -by- Bodin Dresevic [BodinD]</span>
01234 <span class="comment">* Wrote it.</span>
01235 <span class="comment">\**************************************************************************/</span>
01236 
<a name="l01237"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a29">01237</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a29">vFontSweep</a>()
01238 {
01239 <span class="comment">// check if shared windows directory installation:</span>
01240 
01241     <a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a> = <a class="code" href="../../d2/d6/fntsweep_8c.html#a15">bCheckIfDualBootingWithWin31</a>();
01242 
01243 <span class="comment">// before we sweep the files to the Fonts directory,</span>
01244 <span class="comment">// check whether the 'converted' ttf's have been rmoved</span>
01245 
01246     <a class="code" href="../../d2/d6/fntsweep_8c.html#a28">vCleanConvertedTTFs</a>();
01247 
01248 <span class="comment">// sweep fonts in the [Fonts] key</span>
01249 
01250     <a class="code" href="../../d2/d6/fntsweep_8c.html#a24">vSweepFonts</a>(<a class="code" href="../../d2/d6/fntsweep_8c.html#a8">pwszFontsKey</a>, <a class="code" href="../../d2/d6/fntsweep_8c.html#a9">pwszSweepKey</a>, <a class="code" href="../../d2/d6/fntsweep_8c.html#a18">vProcessFontEntry</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01251 
01252 <span class="comment">// now sweep type 1 fonts, if any</span>
01253 
01254     <a class="code" href="../../d2/d6/fntsweep_8c.html#a24">vSweepFonts</a>(<a class="code" href="../../d2/d6/fntsweep_8c.html#a5">pwszType1Key</a>, <a class="code" href="../../d2/d6/fntsweep_8c.html#a6">pwszSweepType1Key</a>, <a class="code" href="../../d2/d6/fntsweep_8c.html#a20">vProcessType1FontEntry</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01255 
01256 <span class="comment">// one of the two routines above may have initialized %windir%\system</span>
01257 <span class="comment">// and %windir%\fonts directories. Free the memory associated with this</span>
01258 
01259     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>)
01260     {
01261         LocalFree(<a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>);
01262         <a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01263     }
01264 
01265 }
01266 
01267 
01268 <span class="comment">/******************************Public*Routine******************************\</span>
01269 <span class="comment">*</span>
01270 <span class="comment">* VOID vLoadLocal/RemoteT1Fonts()</span>
01271 <span class="comment">*</span>
01272 <span class="comment">* History:</span>
01273 <span class="comment">*  30-Apr-1996 -by- Bodin Dresevic [BodinD]</span>
01274 <span class="comment">* Wrote it.</span>
01275 <span class="comment">\**************************************************************************/</span>
01276 
<a name="l01277"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a30">01277</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a30">vLoadT1Fonts</a>(PFNENTRY pfnProcessFontEntry)
01278 {
01279 
01280     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a25">bLoadableFontDrivers</a>())
01281     {
01282 <span class="preprocessor">    #if DBGSWEEP</span>
01283 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"vLoadT1Fonts(0x%lx) was called\n"</span>, pfnProcessFontEntry);
01284 <span class="preprocessor">    #endif</span>
01285 <span class="preprocessor"></span>    <span class="comment">// now enum and add remote type1 fonts if any</span>
01286 
01287         <a class="code" href="../../d2/d6/fntsweep_8c.html#a24">vSweepFonts</a>(<a class="code" href="../../d2/d6/fntsweep_8c.html#a5">pwszType1Key</a>, <a class="code" href="../../d2/d6/fntsweep_8c.html#a6">pwszSweepType1Key</a>, pfnProcessFontEntry, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01288 
01289     <span class="comment">// if the routines above initialized %windir%\system</span>
01290     <span class="comment">// and %windir%\fonts directories. Free the memory associated with this</span>
01291 
01292         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>)
01293         {
01294             LocalFree(<a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>);
01295             <a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01296         }
01297     }
01298 }
01299 
<a name="l01300"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a31">01300</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a31">vLoadLocalT1Fonts</a>()
01301 {
01302     <a class="code" href="../../d2/d6/fntsweep_8c.html#a30">vLoadT1Fonts</a>(<a class="code" href="../../d2/d6/fntsweep_8c.html#a23">vAddLocalType1Font</a>);
01303 }
01304 
<a name="l01305"></a><a class="code" href="../../d2/d6/fntsweep_8c.html#a32">01305</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d6/fntsweep_8c.html#a32">vLoadRemoteT1Fonts</a>()
01306 {
01307     <a class="code" href="../../d2/d6/fntsweep_8c.html#a30">vLoadT1Fonts</a>(<a class="code" href="../../d2/d6/fntsweep_8c.html#a22">vAddRemoteType1Font</a>);
01308 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
