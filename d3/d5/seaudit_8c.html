<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: seaudit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>seaudit.c File Reference</h1><code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>
<code>#include "<a class="el" href="../../d8/d3/adt_8h-source.html">adt.h</a>"</code><br>
<code>#include "<a class="el" href="../../d2/d4/adtp_8h-source.html">adtp.h</a>"</code><br>
<code>#include &lt;sertlp.h&gt;</code><br>

<p>
<a href="../../d4/d4/seaudit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>&nbsp;&nbsp;&nbsp;0xFFFFFFFF</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> (IN PUNICODE_STRING <a class="el" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>, OUT PUNICODE_STRING *<a class="el" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> (IN PUNICODE_STRING CapturedString)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a7">SepAuditTypeList</a> (IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList, IN ULONG ObjectTypeListLength, IN PNTSTATUS AccessStatus, IN ULONG StartIndex, OUT PBOOLEAN GenerateSuccessAudit, OUT PBOOLEAN GenerateFailureAudit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a8">SepExamineSaclEx</a> (IN PACL Sacl, IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN ACCESS_MASK DesiredAccess, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN BOOLEAN ReturnResultList, IN PNTSTATUS AccessStatus, IN PACCESS_MASK GrantedAccess, OUT PBOOLEAN GenerateSuccessAudit, OUT PBOOLEAN GenerateFailureAudit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId, IN PHANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a> OPTIONAL, IN PUNICODE_STRING ObjectTypeName, IN PUNICODE_STRING ObjectName, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN ACCESS_MASK DesiredAccess, IN AUDIT_EVENT_TYPE AuditType, IN ULONG Flags, IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN ObjectCreation, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus, OUT PBOOLEAN GenerateOnClose, IN BOOLEAN ReturnResultList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a10">SepSinglePrivilegeCheck</a> (LUID DesiredPrivilege, IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a12">NtPrivilegeObjectAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId, IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN ACCESS_MASK DesiredAccess, IN PPRIVILEGE_SET Privileges, IN BOOLEAN AccessGranted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a13">SePrivilegeObjectAuditAlarm</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN ACCESS_MASK DesiredAccess, IN PPRIVILEGE_SET Privileges, IN BOOLEAN AccessGranted, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a14">NtPrivilegedServiceAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PUNICODE_STRING ServiceName, IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN PPRIVILEGE_SET Privileges, IN BOOLEAN AccessGranted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a15">SePrivilegedServiceAuditAlarm</a> (IN PUNICODE_STRING ServiceName, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN PPRIVILEGE_SET Privileges, IN BOOLEAN AccessGranted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a16">NtAccessCheckAndAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId, IN PUNICODE_STRING ObjectTypeName, IN PUNICODE_STRING ObjectName, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN ACCESS_MASK DesiredAccess, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN ObjectCreation, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus, OUT PBOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a17">NtAccessCheckByTypeAndAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId, IN PUNICODE_STRING ObjectTypeName, IN PUNICODE_STRING ObjectName, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN ACCESS_MASK DesiredAccess, IN AUDIT_EVENT_TYPE AuditType, IN ULONG Flags, IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN ObjectCreation, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus, OUT PBOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a18">NtAccessCheckByTypeResultListAndAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId, IN PUNICODE_STRING ObjectTypeName, IN PUNICODE_STRING ObjectName, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN ACCESS_MASK DesiredAccess, IN AUDIT_EVENT_TYPE AuditType, IN ULONG Flags, IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN ObjectCreation, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus, OUT PBOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a19">NtAccessCheckByTypeResultListAndAuditAlarmByHandle</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId, IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN PUNICODE_STRING ObjectTypeName, IN PUNICODE_STRING ObjectName, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN ACCESS_MASK DesiredAccess, IN AUDIT_EVENT_TYPE AuditType, IN ULONG Flags, IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN ObjectCreation, OUT PACCESS_MASK GrantedAccess, OUT PNTSTATUS AccessStatus, OUT PBOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a20">NtOpenObjectAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId OPTIONAL, IN PUNICODE_STRING ObjectTypeName, IN PUNICODE_STRING ObjectName, IN PSECURITY_DESCRIPTOR SecurityDescriptor OPTIONAL, IN HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, IN ACCESS_MASK DesiredAccess, IN ACCESS_MASK GrantedAccess, IN PPRIVILEGE_SET Privileges OPTIONAL, IN BOOLEAN ObjectCreation, IN BOOLEAN AccessGranted, OUT PBOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a21">NtCloseObjectAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId, IN BOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a22">NtDeleteObjectAuditAlarm</a> (IN PUNICODE_STRING SubsystemName, IN PVOID HandleId, IN BOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a23">SeOpenObjectAuditAlarm</a> (IN PUNICODE_STRING ObjectTypeName, IN PVOID Object OPTIONAL, IN PUNICODE_STRING AbsoluteObjectName OPTIONAL, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN BOOLEAN ObjectCreated, IN BOOLEAN AccessGranted, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PBOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a24">SeOpenObjectForDeleteAuditAlarm</a> (IN PUNICODE_STRING ObjectTypeName, IN PVOID Object OPTIONAL, IN PUNICODE_STRING AbsoluteObjectName OPTIONAL, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN BOOLEAN ObjectCreated, IN BOOLEAN AccessGranted, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PBOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a25">SeTraverseAuditAlarm</a> (IN PLUID OperationID, IN PVOID DirectoryObject, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN BOOLEAN SubjectContextLocked, IN ACCESS_MASK TraverseAccess, IN PPRIVILEGE_SET Privileges OPTIONAL, IN BOOLEAN AccessGranted, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a26">SeCreateObjectAuditAlarm</a> (IN PLUID OperationID OPTIONAL, IN PVOID DirectoryObject, IN PUNICODE_STRING ComponentName, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN ACCESS_MASK DesiredAccess, IN PPRIVILEGE_SET Privileges OPTIONAL, IN BOOLEAN AccessGranted, OUT PBOOLEAN AuditPerformed, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a27">SeObjectReferenceAuditAlarm</a> (IN PLUID OperationID OPTIONAL, IN PVOID Object, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN ACCESS_MASK DesiredAccess, IN PPRIVILEGE_SET Privileges OPTIONAL, IN BOOLEAN AccessGranted, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a28">SeAuditHandleCreation</a> (IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a29">SeCloseObjectAuditAlarm</a> (IN PVOID Object, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN BOOLEAN GenerateOnClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a30">SeDeleteObjectAuditAlarm</a> (IN PVOID Object, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a31">SepExamineSacl</a> (IN PACL Sacl, IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN ACCESS_MASK DesiredAccess, IN BOOLEAN AccessGranted, OUT PBOOLEAN GenerateAudit, OUT PBOOLEAN GenerateAlarm)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a32">SepSetAuditInfoForObjectType</a> (IN UCHAR AceFlags, IN ACCESS_MASK AccessMask, IN ACCESS_MASK DesiredAccess, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList, IN ULONG ObjectTypeListLength, IN BOOLEAN ReturnResultList, IN ULONG ObjectTypeIndex, IN PNTSTATUS AccessStatus, IN PACCESS_MASK GrantedAccess, IN BOOLEAN FailedMaximumAllowed, OUT PBOOLEAN GenerateSuccessAudit, OUT PBOOLEAN GenerateFailureAudit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a33">SepInitializePrivilegeFilter</a> (BOOLEAN Verbose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a34">SepFilterPrivilegeAudits</a> (IN PPRIVILEGE_SET PrivilegeSet)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a35">SeAuditingFileOrGlobalEvents</a> (IN BOOLEAN AccessGranted, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a36">SeAuditingFileEvents</a> (IN BOOLEAN AccessGranted, IN PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a1">SepAuditShutdownEvents</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLUID *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> = NULL</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLUID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a3">SepFilterPrivilegesLong</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLUID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/seaudit_8c.html#a4">SepFilterPrivilegesShort</a> []</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="seaudit.c::INVALID_OBJECT_TYPE_LIST_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INVALID_OBJECT_TYPE_LIST_INDEX&nbsp;&nbsp;&nbsp;0xFFFFFFFF          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04257">SepExamineSaclEx()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="seaudit.c::NtAccessCheckAndAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAccessCheckAndAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01820">1820</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>01835                    :
01836 
01837     See <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>.
01838 
01839 Arguments:
01840 
01841     See <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>.
01842 
01843 Return Value:
01844 
01845     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.  In <span class="keyword">this</span>
01846         <span class="keywordflow">case</span>, ClientStatus receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
01847 
01848     STATUS_PRIVILEGE_NOT_HELD - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not have
01849         sufficient privilege to use <span class="keyword">this</span> privileged system service.
01850 
01851 --*/
01852 
01853 {
01854     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01855     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>(
01856             SubsystemName,
01857             HandleId,
01858             NULL,
01859             ObjectTypeName,
01860             ObjectName,
01861             SecurityDescriptor,
01862             NULL,       <span class="comment">// No Principal Self sid</span>
01863             DesiredAccess,
01864             AuditEventObjectAccess,  <span class="comment">// Default to ObjectAccess</span>
01865             0,          <span class="comment">// No Flags</span>
01866             NULL,       <span class="comment">// No ObjectType List</span>
01867             0,          <span class="comment">// No ObjectType List</span>
01868             GenericMapping,
01869             ObjectCreation,
01870             GrantedAccess,
01871             AccessStatus,
01872             GenerateOnClose,
01873             FALSE );    <span class="comment">// Return a single GrantedAccess and AccessStatus</span>
01874 
01875 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="seaudit.c::NtAccessCheckByTypeAndAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAccessCheckByTypeAndAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN AUDIT_EVENT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01879">1879</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>01899                    :
01900 
01901     See <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>.
01902 
01903 Arguments:
01904 
01905     See <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>.
01906 
01907 Return Value:
01908 
01909     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.  In <span class="keyword">this</span>
01910         <span class="keywordflow">case</span>, ClientStatus receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
01911 
01912     STATUS_PRIVILEGE_NOT_HELD - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not have
01913         sufficient privilege to use <span class="keyword">this</span> privileged system service.
01914 
01915 --*/
01916 
01917 {
01918     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01919     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>(
01920             SubsystemName,
01921             HandleId,
01922             NULL,
01923             ObjectTypeName,
01924             ObjectName,
01925             SecurityDescriptor,
01926             PrincipalSelfSid,
01927             DesiredAccess,
01928             AuditType,
01929             Flags,
01930             ObjectTypeList,
01931             ObjectTypeListLength,
01932             GenericMapping,
01933             ObjectCreation,
01934             GrantedAccess,
01935             AccessStatus,
01936             GenerateOnClose,
01937             FALSE );  <span class="comment">// Return a single GrantedAccess and AccessStatus</span>
01938 
01939 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="seaudit.c::NtAccessCheckByTypeResultListAndAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAccessCheckByTypeResultListAndAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN AUDIT_EVENT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01943">1943</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01963                    :
01964 
01965     See <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>.
01966 
01967 Arguments:
01968 
01969     See <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>.
01970 
01971 Return Value:
01972 
01973     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.  In <span class="keyword">this</span>
01974         <span class="keywordflow">case</span>, ClientStatus receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
01975 
01976     STATUS_PRIVILEGE_NOT_HELD - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not have
01977         sufficient privilege to use <span class="keyword">this</span> privileged system service.
01978 
01979 --*/
01980 
01981 {
01982     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01983     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>(
01984             SubsystemName,
01985             HandleId,
01986             NULL,
01987             ObjectTypeName,
01988             ObjectName,
01989             SecurityDescriptor,
01990             PrincipalSelfSid,
01991             DesiredAccess,
01992             AuditType,
01993             Flags,
01994             ObjectTypeList,
01995             ObjectTypeListLength,
01996             GenericMapping,
01997             ObjectCreation,
01998             GrantedAccess,
01999             AccessStatus,
02000             GenerateOnClose,
02001             TRUE );  <span class="comment">// Return an array of GrantedAccess and AccessStatus</span>
02002 
02003 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="seaudit.c::NtAccessCheckByTypeResultListAndAuditAlarmByHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAccessCheckByTypeResultListAndAuditAlarmByHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN AUDIT_EVENT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02007">2007</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02028                    :
02029 
02030     See <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>.
02031 
02032 Arguments:
02033 
02034     See <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>.
02035 
02036 Return Value:
02037 
02038     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.  In <span class="keyword">this</span>
02039         <span class="keywordflow">case</span>, ClientStatus receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
02040 
02041     STATUS_PRIVILEGE_NOT_HELD - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not have
02042         sufficient privilege to use <span class="keyword">this</span> privileged system service.
02043 
02044 --*/
02045 
02046 {
02047     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02048     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>(
02049             SubsystemName,
02050             HandleId,
02051             &amp;ClientToken,
02052             ObjectTypeName,
02053             ObjectName,
02054             SecurityDescriptor,
02055             PrincipalSelfSid,
02056             DesiredAccess,
02057             AuditType,
02058             Flags,
02059             ObjectTypeList,
02060             ObjectTypeListLength,
02061             GenericMapping,
02062             ObjectCreation,
02063             GrantedAccess,
02064             AccessStatus,
02065             GenerateOnClose,
02066             TRUE );  <span class="comment">// Return an array of GrantedAccess and AccessStatus</span>
02067 
02068 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="seaudit.c::NtCloseObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCloseObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02492">2492</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">SeCheckAuditPrivilege()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01312">SepAdtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00370">SepFreeCapturedString()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00259">SepProbeAndCaptureString_U()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>02500                    :
02501 
02502     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when a handle
02503     to a <span class="keyword">protected</span> subsystem object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.  This routine may result in
02504     several messages being generated and sent to Port objects.  This may
02505     result in a significant latency before returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
02506     that must call <span class="keyword">this</span> routine must take <span class="keyword">this</span> potential latency into
02507     account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data
02508     structure mutex locking, <span class="keywordflow">for</span> example.
02509 
02510     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a> privilege.  The test
02511     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
02512     process, allowing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be impersonating a client during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02513     call with no ill effects.
02514 
02515 Arguments:
02516 
02517     SubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsystem
02518         calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
02519 
02520     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02521         object.
02522 
02523     GenerateOnClose - Is a <span class="keywordtype">boolean</span> value returned from a corresponding
02524         <a class="code" href="../../d3/d5/seaudit_8c.html#a16">NtAccessCheckAndAuditAlarm</a>() call or NtOpenObjectAuditAlarm() call
02525         when the object handle was created.
02526 
02527 Return value:
02528 
02529 --*/
02530 
02531 {
02532     BOOLEAN Result;
02533     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02534     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02535     PUNICODE_STRING CapturedSubsystemName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02536     PSID UserSid;
02537     PSID CapturedUserSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02538     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02539 
02540     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02541 
02542     PreviousMode = KeGetPreviousMode();
02543 
02544     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousMode != KernelMode);
02545 
02546     <span class="keywordflow">if</span> (!GenerateOnClose) {
02547         <span class="keywordflow">return</span>( STATUS_SUCCESS );
02548     }
02549 
02550     <span class="comment">//</span>
02551     <span class="comment">// Check for SeAuditPrivilege</span>
02552     <span class="comment">//</span>
02553 
02554     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
02555 
02556     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
02557                  &amp;SubjectSecurityContext,
02558                  PreviousMode
02559                  );
02560 
02561     <span class="keywordflow">if</span> (!Result) {
02562         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
02563         <span class="keywordflow">goto</span> Cleanup;
02564     }
02565 
02566     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( EffectiveToken (&amp;SubjectSecurityContext));
02567 
02568     CapturedUserSid = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02569                           PagedPool,
02570                           <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid ),
02571                           'iSeS'
02572                           );
02573 
02574     <span class="keywordflow">if</span> ( CapturedUserSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02575         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02576         <span class="keywordflow">goto</span> Cleanup;
02577     }
02578 
02579     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a> (
02580                   <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid ),
02581                   CapturedUserSid,
02582                   UserSid
02583                   );
02584 
02585     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
02586 
02587 
02588     <span class="keywordflow">try</span> {
02589 
02590         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
02591                                    &amp;CapturedSubsystemName );
02592 
02593     } except (EXCEPTION_EXECUTE_HANDLER) {
02594         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02595         <span class="keywordflow">goto</span> Cleanup;
02596     }
02597 
02598     <span class="comment">//</span>
02599     <span class="comment">// This routine will check to see if auditing is enabled</span>
02600     <span class="comment">//</span>
02601 
02602     <a class="code" href="../../d7/d6/sepaudit_8c.html#a13">SepAdtCloseObjectAuditAlarm</a> ( CapturedSubsystemName,
02603                                HandleId,
02604                                NULL,
02605                                CapturedUserSid,
02606                                <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;SubjectSecurityContext ))
02607                                );
02608 
02609     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02610 
02611 Cleanup:
02612     <span class="keywordflow">if</span> ( CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02613         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02614     }
02615 
02616     <span class="keywordflow">if</span> ( CapturedUserSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02617         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedUserSid );
02618     }
02619 
02620     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02621 
02622     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02623 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="seaudit.c::NtDeleteObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtDeleteObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02627">2627</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">SeCheckAuditPrivilege()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01465">SepAdtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00370">SepFreeCapturedString()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00259">SepProbeAndCaptureString_U()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>02635                    :
02636 
02637     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an object
02638     in a <span class="keyword">protected</span> subsystem object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.  This routine may result in
02639     several messages being generated and sent to Port objects.  This may
02640     result in a significant latency before returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
02641     that must call <span class="keyword">this</span> routine must take <span class="keyword">this</span> potential latency into
02642     account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data
02643     structure mutex locking, <span class="keywordflow">for</span> example.
02644 
02645     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a> privilege.  The test
02646     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
02647     process, allowing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be impersonating a client during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02648     call with no ill effects.
02649 
02650 Arguments:
02651 
02652     SubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsystem
02653         calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
02654 
02655     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02656         object.
02657 
02658     GenerateOnClose - Is a <span class="keywordtype">boolean</span> value returned from a corresponding
02659         <a class="code" href="../../d3/d5/seaudit_8c.html#a16">NtAccessCheckAndAuditAlarm</a>() call or NtOpenObjectAuditAlarm() call
02660         when the object handle was created.
02661 
02662 Return value:
02663 
02664 --*/
02665 
02666 {
02667     BOOLEAN Result;
02668     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02669     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02670     PUNICODE_STRING CapturedSubsystemName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02671     PSID UserSid;
02672     PSID CapturedUserSid;
02673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02674 
02675     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02676 
02677     PreviousMode = KeGetPreviousMode();
02678 
02679     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousMode != KernelMode);
02680 
02681     <span class="keywordflow">if</span> (!GenerateOnClose) {
02682         <span class="keywordflow">return</span>( STATUS_SUCCESS );
02683     }
02684 
02685     <span class="comment">//</span>
02686     <span class="comment">// Check for SeAuditPrivilege</span>
02687     <span class="comment">//</span>
02688 
02689     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
02690 
02691     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
02692                  &amp;SubjectSecurityContext,
02693                  PreviousMode
02694                  );
02695 
02696     <span class="keywordflow">if</span> (!Result) {
02697 
02698         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02699         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02700     }
02701 
02702     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( EffectiveToken (&amp;SubjectSecurityContext));
02703 
02704     CapturedUserSid = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02705                           PagedPool,
02706                           <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid ),
02707                           'iSeS'
02708                           );
02709 
02710     <span class="keywordflow">if</span> ( CapturedUserSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02711         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02712         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02713     }
02714 
02715     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a> (
02716                   <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid ),
02717                   CapturedUserSid,
02718                   UserSid
02719                   );
02720 
02721     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
02722 
02723 
02724     <span class="keywordflow">try</span> {
02725 
02726         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
02727                                    &amp;CapturedSubsystemName );
02728 
02729     } except (EXCEPTION_EXECUTE_HANDLER) {
02730 
02731         <span class="keywordflow">if</span> ( CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02732             <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02733         }
02734 
02735         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedUserSid );
02736         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02737         <span class="keywordflow">return</span> GetExceptionCode();
02738 
02739     }
02740 
02741     <span class="comment">//</span>
02742     <span class="comment">// This routine will check to see if auditing is enabled</span>
02743     <span class="comment">//</span>
02744 
02745     <a class="code" href="../../d7/d6/sepaudit_8c.html#a14">SepAdtDeleteObjectAuditAlarm</a> ( CapturedSubsystemName,
02746                                HandleId,
02747                                NULL,
02748                                CapturedUserSid,
02749                                <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;SubjectSecurityContext ))
02750                                );
02751 
02752     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02753 
02754     <span class="keywordflow">if</span> ( CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02755         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02756     }
02757 
02758     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedUserSid );
02759 
02760     <span class="keywordflow">return</span>(STATUS_SUCCESS);
02761 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="seaudit.c::NtOpenObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID HandleId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR SecurityDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">2072</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00242">IsValidElementCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01447">ProbeForWriteBoolean</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00814">PsProcessAuditId</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00053">SeCaptureSecurityDescriptor()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">SeCheckAuditPrivilege()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03952">SepExamineSacl()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00370">SepFreeCapturedString()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00259">SepProbeAndCaptureString_U()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00631">SeReleaseSecurityDescriptor()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02088                        :
02089 
02090     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
02091     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to access an existing <span class="keyword">protected</span> subsystem object or
02092     create a <span class="keyword">new</span> one.  This routine may result in several messages being
02093     generated and sent to Port objects.  This may result in a significant
02094     latency before returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span>
02095     routine must take <span class="keyword">this</span> potential latency into account.  This may have
02096     an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span>
02097     example.
02098 
02099     This routine may not be able to generate a complete audit record
02100     due to memory restrictions.
02101 
02102     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a> privilege.  The test
02103     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
02104     process, not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
02105 
02106 Arguments:
02107 
02108     SubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02109         subsystem calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
02110 
02111     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02112         object.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt was not successful (AccessGranted is
02113         FALSE), then <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
02114 
02115     ObjectTypeName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object being
02116         accessed.
02117 
02118     ObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
02119         accessed or attempted to access.
02120 
02121     SecurityDescriptor - An optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of
02122         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being accessed.
02123 
02124     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to a token object representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client that
02125         requested <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  This handle must be obtained from a
02126         communication session layer, such as from an LPC Port or Local
02127         Named Pipe, to prevent possible security policy violations.
02128 
02129     DesiredAccess - The desired access mask.  This mask must have been
02130         previously mapped to contain no generic accesses.
02131 
02132     GrantedAccess - The mask of accesses that were actually granted.
02133 
02134     Privileges - Optionally points to a set of privileges that were
02135         required <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt.  Those privileges that were held
02136         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject are marked <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UsedForAccess flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02137         attributes associated with each privilege.
02138 
02139     ObjectCreation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access will
02140         result in a <span class="keyword">new</span> object being created <span class="keywordflow">if</span> granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02141         indicates an object will be created, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates an existing
02142         object will be opened.
02143 
02144     AccessGranted - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested access was granted or
02145         not.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
02146         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was not granted.
02147 
02148     GenerateOnClose - Points to a <span class="keywordtype">boolean</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit
02149         generation routine and must be passed to <a class="code" href="../../d3/d5/seaudit_8c.html#a21">NtCloseObjectAuditAlarm</a>()
02150         when the object handle is closed.
02151 
02152 Return Value:
02153 
02154 --*/
02155 {
02156 
02157     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02158     ULONG PrivilegeParameterLength;
02159     PUNICODE_STRING CapturedSubsystemName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02160     PUNICODE_STRING CapturedObjectTypeName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02161     PUNICODE_STRING CapturedObjectName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02162     PSECURITY_DESCRIPTOR CapturedSecurityDescriptor = (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02163     PPRIVILEGE_SET CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02164     BOOLEAN LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02165     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02166     BOOLEAN Result;
02167     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02168     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02169     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02170     PLUID ClientAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02171     HANDLE CapturedHandleId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02172     BOOLEAN AuditPerformed;
02173     ULONG PrivilegeCount;
02174 
02175     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02176 
02177     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02178 
02179     PreviousMode = KeGetPreviousMode();
02180 
02181     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PreviousMode != KernelMode );
02182 
02183     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( ClientToken,             <span class="comment">// Handle</span>
02184                                         TOKEN_QUERY,             <span class="comment">// DesiredAccess</span>
02185                                         SepTokenObjectType,      <span class="comment">// ObjectType</span>
02186                                         PreviousMode,            <span class="comment">// AccessMode</span>
02187                                         (PVOID *)&amp;Token,         <span class="comment">// Object</span>
02188                                         NULL                     <span class="comment">// GrantedAccess</span>
02189                                         );
02190 
02191     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02192         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02193     }
02194 
02195     <span class="comment">//</span>
02196     <span class="comment">// If the passed token is an impersonation token, make sure</span>
02197     <span class="comment">// it is at SecurityIdentification or above.</span>
02198     <span class="comment">//</span>
02199 
02200     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType == TokenImpersonation) {
02201 
02202         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt; SecurityIdentification) {
02203 
02204             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
02205 
02206             <span class="keywordflow">return</span>( STATUS_BAD_IMPERSONATION_LEVEL );
02207 
02208         }
02209     }
02210 
02211     <span class="comment">//</span>
02212     <span class="comment">// Check for SeAuditPrivilege.  This must be tested against</span>
02213     <span class="comment">// the caller's primary token.</span>
02214     <span class="comment">//</span>
02215 
02216     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
02217 
02218     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
02219                  &amp;SubjectSecurityContext,
02220                  PreviousMode
02221                  );
02222 
02223     <span class="keywordflow">if</span> (!Result) {
02224 
02225         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
02226 
02227         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02228 
02229         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02230     }
02231 
02232     <span class="comment">//</span>
02233     <span class="comment">// This will just return NULL if the input descriptor is NULL</span>
02234     <span class="comment">//</span>
02235 
02236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a> ( SecurityDescriptor,
02237                                            PreviousMode,
02238                                            PagedPool,
02239                                            FALSE,
02240                                            &amp;CapturedSecurityDescriptor
02241                                            );
02242 
02243     <span class="comment">//</span>
02244     <span class="comment">// At this point in time, if there's no security descriptor, there's</span>
02245     <span class="comment">// nothing to do.  Return success.</span>
02246     <span class="comment">//</span>
02247 
02248     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) || CapturedSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02249 
02250         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
02251 
02252         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02253 
02254         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02255     }
02256 
02257     <span class="keywordflow">try</span> {
02258 
02259         <span class="comment">//</span>
02260         <span class="comment">// Only capture the privileges if we've completed a successful</span>
02261         <span class="comment">// access check.  Otherwise they don't mean anything.</span>
02262         <span class="comment">//</span>
02263 
02264         <span class="keywordflow">if</span> (AccessGranted &amp;&amp; ARGUMENT_PRESENT(Privileges)) {
02265 
02266             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
02267                 Privileges,
02268                 <span class="keyword">sizeof</span>(PRIVILEGE_SET),
02269                 <span class="keyword">sizeof</span>(ULONG)
02270                 );
02271 
02272             PrivilegeCount = Privileges-&gt;PrivilegeCount;
02273             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( PrivilegeCount, LUID_AND_ATTRIBUTES) ) {
02274                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02275                 leave;
02276             }
02277 
02278             PrivilegeParameterLength = (ULONG)<span class="keyword">sizeof</span>(PRIVILEGE_SET) +
02279                               ((PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
02280                                 (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)  );
02281 
02282             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
02283                 Privileges,
02284                 PrivilegeParameterLength,
02285                 <span class="keyword">sizeof</span>(ULONG)
02286                 );
02287 
02288             CapturedPrivileges = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
02289                                                         PrivilegeParameterLength,
02290                                                         'rPeS'
02291                                                       );
02292 
02293             <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02294 
02295                 RtlCopyMemory ( CapturedPrivileges,
02296                                 Privileges,
02297                                 PrivilegeParameterLength );
02298                 CapturedPrivileges-&gt;PrivilegeCount = PrivilegeCount;
02299             } <span class="keywordflow">else</span> {
02300 
02301                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> ( CapturedSecurityDescriptor,
02302                                               PreviousMode,
02303                                               FALSE );
02304 
02305                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
02306                 <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02307                 <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02308             }
02309 
02310 
02311         }
02312 
02313         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( HandleId )) {
02314 
02315             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( (PHANDLE)HandleId, <span class="keyword">sizeof</span>(PVOID), <span class="keyword">sizeof</span>(PVOID) );
02316             CapturedHandleId = *(PHANDLE)HandleId;
02317         }
02318 
02319         <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>(GenerateOnClose);
02320 
02321         <span class="comment">//</span>
02322         <span class="comment">// Probe and Capture the parameter strings.</span>
02323         <span class="comment">// If we run out of memory attempting to capture</span>
02324         <span class="comment">// the strings, the returned pointer will be</span>
02325         <span class="comment">// NULL and we will continue with the audit.</span>
02326         <span class="comment">//</span>
02327 
02328         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
02329                                      &amp;CapturedSubsystemName );
02330 
02331         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ObjectTypeName,
02332                                      &amp;CapturedObjectTypeName );
02333 
02334         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ObjectName,
02335                                      &amp;CapturedObjectName );
02336 
02337     } except(EXCEPTION_EXECUTE_HANDLER) {
02338         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02339     }
02340 
02341     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02342 
02343         <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02344           <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02345         }
02346 
02347         <span class="keywordflow">if</span> (CapturedObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02348           <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectTypeName );
02349         }
02350 
02351         <span class="keywordflow">if</span> (CapturedObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02352           <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectName );
02353         }
02354 
02355         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02356           <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedPrivileges );
02357         }
02358 
02359         <span class="keywordflow">if</span> (CapturedSecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02360 
02361             <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> ( CapturedSecurityDescriptor,
02362                                           PreviousMode,
02363                                           FALSE );
02364         }
02365 
02366         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
02367 
02368         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02369 
02370         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02371 
02372     }
02373 
02374     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted) ) {
02375 
02376         <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
02377             RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor ),
02378             Token,
02379             DesiredAccess | GrantedAccess,
02380             AccessGranted,
02381             &amp;GenerateAudit,
02382             &amp;GenerateAlarm
02383             );
02384 
02385         <span class="keywordflow">if</span> (GenerateAudit || GenerateAlarm) {
02386 
02387             <span class="comment">//</span>
02388             <span class="comment">// Take a read lock on the token, because we're going to extract</span>
02389             <span class="comment">// the user's Sid from it.</span>
02390             <span class="comment">//</span>
02391 
02392             LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02393 
02394             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> ( CapturedSubsystemName,
02395                                                           ARGUMENT_PRESENT(HandleId) ? (PVOID)&amp;CapturedHandleId : NULL,
02396                                                           CapturedObjectTypeName,
02397                                                           NULL,
02398                                                           CapturedObjectName,
02399                                                           Token,
02400                                                           SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
02401                                                           DesiredAccess,
02402                                                           GrantedAccess,
02403                                                           NULL,
02404                                                           CapturedPrivileges,
02405                                                           ObjectCreation,
02406                                                           AccessGranted,
02407                                                           GenerateAudit,
02408                                                           GenerateAlarm,
02409                                                           <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
02410                                                           AuditCategoryObjectAccess,
02411                                                           NULL,
02412                                                           0,
02413                                                           NULL
02414                                                           );
02415 
02416             LocalGenerateOnClose = AuditPerformed;
02417         }
02418     }
02419 
02420     <span class="keywordflow">if</span> ( !(GenerateAudit || GenerateAlarm) ) {
02421 
02422         <span class="comment">//</span>
02423         <span class="comment">// We didn't attempt to generate an audit above, so if privileges were used,</span>
02424         <span class="comment">// see if we should generate an audit here.</span>
02425         <span class="comment">//</span>
02426 
02427         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(Privileges) ) {
02428 
02429             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted) ) {
02430 
02431                 AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> ( CapturedSubsystemName,
02432                                                                    CapturedHandleId,
02433                                                                    Token,
02434                                                                    SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
02435                                                                    <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
02436                                                                    DesiredAccess,
02437                                                                    CapturedPrivileges,
02438                                                                    AccessGranted
02439                                                                    );
02440                 <span class="comment">//</span>
02441                 <span class="comment">// If we generate an audit due to use of privilege, don't set generate on close,</span>
02442                 <span class="comment">// because then we'll have a close audit without a corresponding open audit.</span>
02443                 <span class="comment">//</span>
02444 
02445                 LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02446             }
02447         }
02448     }
02449 
02450     <span class="keywordflow">if</span> (CapturedSecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02451 
02452         <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> ( CapturedSecurityDescriptor,
02453                                       PreviousMode,
02454                                       FALSE );
02455     }
02456 
02457     <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02458       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02459     }
02460 
02461     <span class="keywordflow">if</span> (CapturedObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02462       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectTypeName );
02463     }
02464 
02465     <span class="keywordflow">if</span> (CapturedObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02466       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectName );
02467     }
02468 
02469     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02470       <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedPrivileges );
02471     }
02472 
02473     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
02474 
02475     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02476 
02477     <span class="keywordflow">try</span> {
02478 
02479         *GenerateOnClose = LocalGenerateOnClose;
02480 
02481     } except (EXCEPTION_EXECUTE_HANDLER) {
02482 
02483             <span class="keywordflow">return</span> GetExceptionCode();
02484     }
02485 
02486     <span class="keywordflow">return</span>(STATUS_SUCCESS);
02487 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="seaudit.c::NtPrivilegedServiceAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtPrivilegedServiceAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>Privileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00731">731</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00242">IsValidElementCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">SeCheckAuditPrivilege()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">SepAdtPrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00370">SepFreeCapturedString()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00259">SepProbeAndCaptureString_U()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
<pre class="fragment"><div>00741                    :
00742 
00743     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
00744     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to perform privileged system service operations.  This
00745     routine may result in several messages being generated and sent to Port
00746     objects.  This may result in a significant latency before returning.
00747     Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span> routine must take <span class="keyword">this</span> potential
00748     latency into account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken
00749     <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span> example.
00750 
00751     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a> privilege.  The test
00752     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
00753     process, allowing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be impersonating a client during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00754     call with no ill effects
00755 
00756 Arguments:
00757 
00758     SubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsystem
00759         calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
00760 
00761     ServiceName - Supplies a name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileged subsystem service.  For
00762         example, <span class="stringliteral">"RESET RUNTIME LOCAL SECURITY POLICY"</span> might be specified
00763         by a Local Security Authority service used to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local
00764         security policy database.
00765 
00766     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to a token object representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client that
00767         requested <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  This handle must be obtained from a
00768         communication session layer, such as from an LPC Port or Local
00769         Named Pipe, to prevent possible security policy violations.
00770 
00771     Privileges - Points to a set of privileges required to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00772         privileged operation.  Those privileges that were held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00773         subject are marked <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UsedForAccess flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00774         attributes associated with each privilege.
00775 
00776     AccessGranted - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested access was granted or
00777         not.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00778         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was not granted.
00779 
00780 Return value:
00781 
00782 --*/
00783 
00784 {
00785 
00786     PPRIVILEGE_SET CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00787     ULONG PrivilegeParameterLength = 0;
00788     BOOLEAN Result;
00789     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
00790     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00791     PUNICODE_STRING CapturedSubsystemName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00792     PUNICODE_STRING CapturedServiceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00793     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00794     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00795     ULONG PrivilegeCount;
00796 
00797     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00798 
00799     PreviousMode = KeGetPreviousMode();
00800 
00801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousMode != KernelMode);
00802 
00803     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00804                  ClientToken,             <span class="comment">// Handle</span>
00805                  TOKEN_QUERY,             <span class="comment">// DesiredAccess</span>
00806                  SepTokenObjectType,      <span class="comment">// ObjectType</span>
00807                  PreviousMode,            <span class="comment">// AccessMode</span>
00808                  (PVOID *)&amp;Token,         <span class="comment">// Object</span>
00809                  NULL                     <span class="comment">// GrantedAccess</span>
00810                  );
00811 
00812     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00813         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00814     }
00815 
00816     <span class="comment">//</span>
00817     <span class="comment">// If the passed token is an impersonation token, make sure</span>
00818     <span class="comment">// it is at SecurityIdentification or above.</span>
00819     <span class="comment">//</span>
00820 
00821     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType == TokenImpersonation) {
00822 
00823         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt; SecurityIdentification) {
00824 
00825             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00826 
00827             <span class="keywordflow">return</span>( STATUS_BAD_IMPERSONATION_LEVEL );
00828 
00829         }
00830     }
00831 
00832 <span class="comment">//    //</span>
00833 <span class="comment">//    // Make sure the passed token is an impersonation token...</span>
00834 <span class="comment">//    //</span>
00835 <span class="comment">//</span>
00836 <span class="comment">//    if (Token-&gt;TokenType != TokenImpersonation) {</span>
00837 <span class="comment">//</span>
00838 <span class="comment">//        ObDereferenceObject( (PVOID)Token );</span>
00839 <span class="comment">//</span>
00840 <span class="comment">//        return( STATUS_NO_IMPERSONATION_TOKEN );</span>
00841 <span class="comment">//</span>
00842 <span class="comment">//    }</span>
00843 <span class="comment">//</span>
00844 <span class="comment">//    //</span>
00845 <span class="comment">//    //  ...and at a high enough impersonation level</span>
00846 <span class="comment">//    //</span>
00847 <span class="comment">//</span>
00848 <span class="comment">//    if (Token-&gt;ImpersonationLevel &lt; SecurityIdentification) {</span>
00849 <span class="comment">//</span>
00850 <span class="comment">//        ObDereferenceObject( (PVOID)Token );</span>
00851 <span class="comment">//</span>
00852 <span class="comment">//        return( STATUS_BAD_IMPERSONATION_LEVEL );</span>
00853 <span class="comment">//</span>
00854 <span class="comment">//    }</span>
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">// Check for SeAuditPrivilege</span>
00858     <span class="comment">//</span>
00859 
00860     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
00861 
00862     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
00863                  &amp;SubjectSecurityContext,
00864                  PreviousMode
00865                  );
00866 
00867     <span class="keywordflow">if</span> (!Result) {
00868 
00869         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00870 
00871         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00872 
00873         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
00874     }
00875 
00876     <span class="keywordflow">try</span> {
00877 
00878         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( SubsystemName )) {
00879             <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
00880                                          &amp;CapturedSubsystemName );
00881         }
00882 
00883         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ServiceName )) {
00884             <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ServiceName,
00885                                          &amp;CapturedServiceName );
00886 
00887         }
00888 
00889         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00890             Privileges,
00891             <span class="keyword">sizeof</span>(PRIVILEGE_SET),
00892             <span class="keyword">sizeof</span>(ULONG)
00893             );
00894 
00895         PrivilegeCount = Privileges-&gt;PrivilegeCount;
00896 
00897         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( PrivilegeCount, LUID_AND_ATTRIBUTES ) ) {
00898             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00899             leave ;
00900         }
00901         PrivilegeParameterLength = (ULONG)<span class="keyword">sizeof</span>(PRIVILEGE_SET) +
00902                           ((PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
00903                             (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)  );
00904 
00905         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00906             Privileges,
00907             PrivilegeParameterLength,
00908             <span class="keyword">sizeof</span>(ULONG)
00909             );
00910 
00911         CapturedPrivileges = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
00912                                                     PrivilegeParameterLength,
00913                                                     'rPeS'
00914                                                   );
00915 
00916         <span class="comment">//</span>
00917         <span class="comment">// If ExAllocatePool has failed, too bad.  Carry on and do as much of the</span>
00918         <span class="comment">// audit as we can.</span>
00919         <span class="comment">//</span>
00920 
00921         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00922 
00923             RtlCopyMemory ( CapturedPrivileges,
00924                             Privileges,
00925                             PrivilegeParameterLength );
00926             CapturedPrivileges-&gt;PrivilegeCount = PrivilegeCount;
00927 
00928         }
00929 
00930     } except (EXCEPTION_EXECUTE_HANDLER) {
00931         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00932     }
00933 
00934     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00935 
00936         <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00937             <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedSubsystemName );
00938         }
00939 
00940         <span class="keywordflow">if</span> (CapturedServiceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00941             <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedServiceName );
00942         }
00943 
00944         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00945             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ( CapturedPrivileges );
00946         }
00947 
00948         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00949 
00950         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00951 
00952         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00953 
00954     }
00955 
00956     <span class="comment">//</span>
00957     <span class="comment">// The AuthenticationId is in the read-only part of the token,</span>
00958     <span class="comment">// so we may reference it without having the token read-locked.</span>
00959     <span class="comment">//</span>
00960 
00961     <a class="code" href="../../d7/d6/sepaudit_8c.html#a10">SepAdtPrivilegedServiceAuditAlarm</a> ( CapturedSubsystemName,
00962                                         CapturedServiceName,
00963                                         Token,
00964                                         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
00965                                         CapturedPrivileges,
00966                                         AccessGranted );
00967 
00968     <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00969         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedSubsystemName );
00970     }
00971 
00972     <span class="keywordflow">if</span> (CapturedServiceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00973         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedServiceName );
00974     }
00975 
00976     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00977         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ( CapturedPrivileges );
00978     }
00979 
00980     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00981 
00982     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00983 
00984     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00985 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="seaudit.c::NtPrivilegeObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtPrivilegeObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>Privileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00406">406</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00242">IsValidElementCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00103">_SECURITY_SUBJECT_CONTEXT::ProcessAuditId</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">SeCheckAuditPrivilege()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00370">SepFreeCapturedString()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00259">SepProbeAndCaptureString_U()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l02001">IsPrivileged()</a>.
<p>
<pre class="fragment"><div>00416                    :
00417 
00418     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
00419     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to perform privileged operations on a <span class="keyword">protected</span>
00420     subsystem object after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already opened.  This routine may
00421     result in several messages being generated and sent to Port objects.
00422     This may result in a significant latency before returning.  Design of
00423     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span> routine must take <span class="keyword">this</span> potential latency
00424     into account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data
00425     structure mutex locking, <span class="keywordflow">for</span> example.
00426 
00427     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a> privilege.  The test
00428     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
00429     process, allowing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be impersonating a client during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00430     call with no ill effects.
00431 
00432 Arguments:
00433 
00434     SubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsystem
00435         calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
00436 
00437     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00438         object.
00439 
00440     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to a token object representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client that
00441         requested <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  This handle must be obtained from a
00442         communication session layer, such as from an LPC Port or Local
00443         Named Pipe, to prevent possible security policy violations.
00444 
00445     DesiredAccess - The desired access mask.  This mask must have been
00446         previously mapped to contain no generic accesses.
00447 
00448     Privileges - The set of privileges required <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00449         operation.  Those privileges that were held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject are
00450         marked <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UsedForAccess flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes
00451         associated with each privilege.
00452 
00453     AccessGranted - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested access was granted or
00454         not.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00455         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was not granted.
00456 
00457 Return value:
00458 
00459 --*/
00460 {
00461 
00462     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00463     PUNICODE_STRING CapturedSubsystemName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00464     PPRIVILEGE_SET CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00465     ULONG PrivilegeParameterLength;
00466     ULONG PrivilegeCount;
00467     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
00468     BOOLEAN Result;
00469     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00470     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00471     BOOLEAN AuditPerformed;
00472 
00473     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00474 
00475     PreviousMode = KeGetPreviousMode();
00476 
00477     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousMode != KernelMode);
00478 
00479     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00480          ClientToken,             <span class="comment">// Handle</span>
00481          TOKEN_QUERY,             <span class="comment">// DesiredAccess</span>
00482          SepTokenObjectType,      <span class="comment">// ObjectType</span>
00483          PreviousMode,            <span class="comment">// AccessMode</span>
00484          (PVOID *)&amp;Token,         <span class="comment">// Object</span>
00485          NULL                     <span class="comment">// GrantedAccess</span>
00486          );
00487 
00488     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00489         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00490     }
00491 
00492     <span class="comment">//</span>
00493     <span class="comment">// If the passed token is an impersonation token, make sure</span>
00494     <span class="comment">// it is at SecurityIdentification or above.</span>
00495     <span class="comment">//</span>
00496 
00497     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType == TokenImpersonation) {
00498 
00499         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt; SecurityIdentification) {
00500 
00501             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00502 
00503             <span class="keywordflow">return</span>( STATUS_BAD_IMPERSONATION_LEVEL );
00504 
00505         }
00506     }
00507 
00508 <span class="comment">//    //</span>
00509 <span class="comment">//    // Make sure the passed token is an impersonation token...</span>
00510 <span class="comment">//    //</span>
00511 <span class="comment">//</span>
00512 <span class="comment">//    if (Token-&gt;TokenType != TokenImpersonation) {</span>
00513 <span class="comment">//</span>
00514 <span class="comment">//        ObDereferenceObject( (PVOID)Token );</span>
00515 <span class="comment">//</span>
00516 <span class="comment">//        return( STATUS_NO_IMPERSONATION_TOKEN );</span>
00517 <span class="comment">//</span>
00518 <span class="comment">//    }</span>
00519 <span class="comment">//</span>
00520 <span class="comment">//    //</span>
00521 <span class="comment">//    //  ...and at a high enough impersonation level</span>
00522 <span class="comment">//    //</span>
00523 <span class="comment">//</span>
00524 <span class="comment">//    if (Token-&gt;ImpersonationLevel &lt; SecurityIdentification) {</span>
00525 <span class="comment">//</span>
00526 <span class="comment">//        ObDereferenceObject( (PVOID)Token );</span>
00527 <span class="comment">//</span>
00528 <span class="comment">//        return( STATUS_BAD_IMPERSONATION_LEVEL );</span>
00529 <span class="comment">//</span>
00530 <span class="comment">//    }</span>
00531 
00532     <span class="comment">//</span>
00533     <span class="comment">// Check for SeAuditPrivilege</span>
00534     <span class="comment">//</span>
00535 
00536     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
00537 
00538     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
00539                  &amp;SubjectSecurityContext,
00540                  PreviousMode
00541                  );
00542 
00543     <span class="keywordflow">if</span> (!Result) {
00544 
00545         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00546         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00547         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
00548 
00549     }
00550 
00551     <span class="keywordflow">try</span> {
00552 
00553         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
00554                                      &amp;CapturedSubsystemName );
00555 
00556         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00557             Privileges,
00558             <span class="keyword">sizeof</span>(PRIVILEGE_SET),
00559             <span class="keyword">sizeof</span>(ULONG)
00560             );
00561         PrivilegeCount = Privileges-&gt;PrivilegeCount;
00562 
00563         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>(PrivilegeCount, LUID_AND_ATTRIBUTES)) {
00564             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>= STATUS_INVALID_PARAMETER;
00565             leave ;
00566         }
00567         PrivilegeParameterLength = (ULONG)<span class="keyword">sizeof</span>(PRIVILEGE_SET) +
00568                           ((PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
00569                             (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)  );
00570 
00571         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00572             Privileges,
00573             PrivilegeParameterLength,
00574             <span class="keyword">sizeof</span>(ULONG)
00575             );
00576 
00577         CapturedPrivileges = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
00578                                                     PrivilegeParameterLength,
00579                                                     'rPeS'
00580                                                   );
00581 
00582         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00583 
00584             RtlCopyMemory ( CapturedPrivileges,
00585                             Privileges,
00586                             PrivilegeParameterLength );
00587             CapturedPrivileges-&gt;PrivilegeCount = PrivilegeCount;
00588         }
00589 
00590     } except (EXCEPTION_EXECUTE_HANDLER) {
00591 
00592         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00593     }
00594     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00595 
00596         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00597             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedPrivileges );
00598         }
00599 
00600         <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00601             <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedSubsystemName );
00602         }
00603 
00604         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00605 
00606         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00607 
00608         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00609 
00610     }
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">// No need to lock the token, because the only thing we're going</span>
00614     <span class="comment">// to reference in it is the User's Sid, which cannot be changed.</span>
00615     <span class="comment">//</span>
00616 
00617     <span class="comment">//</span>
00618     <span class="comment">// SepPrivilegeObjectAuditAlarm will check the global flags</span>
00619     <span class="comment">// to determine if we're supposed to be auditing here.</span>
00620     <span class="comment">//</span>
00621 
00622     AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> (
00623                          CapturedSubsystemName,
00624                          HandleId,
00625                          Token,                                <span class="comment">// ClientToken</span>
00626                          SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,  <span class="comment">// PrimaryToken</span>
00627                          SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o3">ProcessAuditId</a>,
00628                          DesiredAccess,
00629                          CapturedPrivileges,
00630                          AccessGranted
00631                          );
00632 
00633     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00634         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedPrivileges );
00635     }
00636 
00637     <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedSubsystemName );
00639     }
00640 
00641     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00642 
00643     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)Token );
00644 
00645     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00646 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="seaudit.c::SeAuditHandleCreation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeAuditHandleCreation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03736">3736</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00258">_AUX_ACCESS_DATA::PrivilegesUsed</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02306">PsGetCurrentProcessId()</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>.
<p>
<pre class="fragment"><div>03743                    :
03744 
03745     This function audits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of a handle.
03746 
03747     It will examine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AuditHandleCreation field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed AccessState,
03748     which will indicate whether auditing was performed when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
03749     was found or created.
03750 
03751     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary because object name decoding and handle
03752     allocation occur in widely separate places, preventing us from
03753     auditing everything at once.
03754 
03755 Arguments:
03756 
03757     AccessState - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState structure
03758         representing <span class="keyword">this</span> access attempt.
03759 
03760     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - The newly allocated handle value.
03761 
03762 Return Value:
03763 
03764     None.
03765 
03766 --*/
03767 
03768 {
03769     BOOLEAN AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03770     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData;
03771 
03772     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03773 
03774     AuxData = (<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)AccessState-&gt;AuxData;
03775 
03776     <span class="keywordflow">if</span> ( AccessState-&gt;GenerateAudit ) {
03777 
03778         <span class="keywordflow">if</span> ( AccessState-&gt;AuditPrivileges ) {
03779 
03780             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> (
03781                                  &amp;SeSubsystemName,
03782                                  Handle,
03783                                  (PTOKEN)AccessState-&gt;SubjectSecurityContext.ClientToken,
03784                                  (PTOKEN)AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03785                                  &amp;AccessState-&gt;SubjectSecurityContext.ProcessAuditId,
03786                                  AccessState-&gt;PreviouslyGrantedAccess,
03787                                  AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03788                                  TRUE
03789                                  );
03790         } <span class="keywordflow">else</span> {
03791 
03792             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> ( &amp;SeSubsystemName,
03793                                                           &amp;Handle,
03794                                                           &amp;AccessState-&gt;ObjectTypeName,
03795                                                           NULL,
03796                                                           &amp;AccessState-&gt;ObjectName,
03797                                                           AccessState-&gt;SubjectSecurityContext.ClientToken,
03798                                                           AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03799                                                           AccessState-&gt;OriginalDesiredAccess,
03800                                                           AccessState-&gt;PreviouslyGrantedAccess,
03801                                                           &amp;AccessState-&gt;OperationID,
03802                                                           AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03803                                                           FALSE,
03804                                                           TRUE,
03805                                                           TRUE,
03806                                                           FALSE,
03807                                                           <a class="code" href="../../d1/d9/ps_8h.html#a152">PsGetCurrentProcessId</a>(),
03808                                                           AuditCategoryObjectAccess,
03809                                                           NULL,
03810                                                           0,
03811                                                           NULL );
03812         }
03813     }
03814 
03815     <span class="comment">//</span>
03816     <span class="comment">// If we generated an 'open' audit, make sure we generate a close</span>
03817     <span class="comment">//</span>
03818 
03819     AccessState-&gt;GenerateOnClose = AuditPerformed;
03820 
03821     <span class="keywordflow">return</span>;
03822 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="seaudit.c::SeAuditingFileEvents" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SeAuditingFileEvents           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04693">4693</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>.
<p>
<pre class="fragment"><div>04700                    :
04701 
04702     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system to quickly determine
04703     <span class="keywordflow">if</span> we are auditing <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> open events.  This allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
04704     to avoid <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> often considerable setup involved in generating an audit.
04705 
04706 Arguments:
04707 
04708     AccessGranted - Supplies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt was successful
04709         or a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
04710 
04711 Return Value:
04712 
04713     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> events of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> AccessGranted are being audited, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
04714         otherwise.
04715 
04716 --*/
04717 
04718 {
04719     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04720 
04721     UNREFERENCED_PARAMETER( SecurityDescriptor );
04722 
04723     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted ) );
04724 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="seaudit.c::SeAuditingFileOrGlobalEvents" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SeAuditingFileOrGlobalEvents           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04648">4648</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>04656                    :
04657 
04658     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system to quickly determine
04659     <span class="keywordflow">if</span> we are auditing <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> open events.  This allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
04660     to avoid <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> often considerable setup involved in generating an audit.
04661 
04662 Arguments:
04663 
04664     AccessGranted - Supplies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt was successful
04665         or a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
04666 
04667 Return Value:
04668 
04669     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> events of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> AccessGranted are being audited, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
04670         otherwise.
04671 
04672 --*/
04673 
04674 {
04675     PISECURITY_DESCRIPTOR ISecurityDescriptor = (PISECURITY_DESCRIPTOR) SecurityDescriptor;
04676 
04677     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04678 
04679     <span class="keywordflow">if</span> ( ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ))-&gt;AuditData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04680         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
04681     }
04682 
04683     <span class="keywordflow">if</span> ( RtlpSaclAddrSecurityDescriptor( ISecurityDescriptor ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04684 
04685         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
04686     }
04687 
04688     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted ) );
04689 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="seaudit.c::SeCheckAuditPrivilege" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SeCheckAuditPrivilege           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">199</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01689">SeAuditPrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00038">SepPrivilegeCheck()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00989">SePrivilegedServiceAuditAlarm()</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02492">NtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02627">NtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">NtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00731">NtPrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00406">NtPrivilegeObjectAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00205                    :
00206 
00207     This routine specifically searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token (rather than
00208     the effective token) of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process <span class="keywordflow">for</span> <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>.
00209     In order to <span class="keywordflow">do</span> <span class="keyword">this</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying worker
00210     <a class="code" href="../../d8/d4/privileg_8c.html#a0">SepPrivilegeCheck</a> directly, to ensure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00211     searched
00212 
00213 Arguments:
00214 
00215     SubjectSecurityContext - The subject being examined.
00216 
00217     PreviousMode - The previous processor mode.
00218 
00219 Return Value:
00220 
00221     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject has <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00222 
00223 --*/
00224 {
00225 
00226     PRIVILEGE_SET RequiredPrivileges;
00227     BOOLEAN AccessGranted;
00228 
00229     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00230 
00231     RequiredPrivileges.PrivilegeCount = 1;
00232     RequiredPrivileges.Control = PRIVILEGE_SET_ALL_NECESSARY;
00233     RequiredPrivileges.Privilege[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>;
00234     RequiredPrivileges.Privilege[0].Attributes = 0;
00235 
00236     AccessGranted = <a class="code" href="../../d8/d3/tokenp_8h.html#a37">SepPrivilegeCheck</a>(
00237                         SubjectSecurityContext-&gt;PrimaryToken,     <span class="comment">// token</span>
00238                         RequiredPrivileges.Privilege,             <span class="comment">// privilege set</span>
00239                         RequiredPrivileges.PrivilegeCount,        <span class="comment">// privilege count</span>
00240                         PRIVILEGE_SET_ALL_NECESSARY,              <span class="comment">// privilege control</span>
00241                         PreviousMode                              <span class="comment">// previous mode</span>
00242                         );
00243 
00244     <span class="keywordflow">if</span> ( PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00245 
00246         <a class="code" href="../../d3/d5/seaudit_8c.html#a15">SePrivilegedServiceAuditAlarm</a> (
00247             NULL,                              <span class="comment">// BUGWARNING need service name</span>
00248             SubjectSecurityContext,
00249             &amp;RequiredPrivileges,
00250             AccessGranted
00251             );
00252     }
00253 
00254     <span class="keywordflow">return</span>( AccessGranted );
00255 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="seaudit.c::SeCloseObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeCloseObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03826">3826</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01312">SepAdtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>.
<p>
<pre class="fragment"><div>03834                    :
03835 
03836     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when a handle
03837     to an object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.
03838 
03839     This routine may result in several messages being generated and sent to
03840     Port objects.  This may result in a significant latency before
03841     returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span> routine must take
03842     <span class="keyword">this</span> potential latency into account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03843     approach taken <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span> example.
03844 
03845 Arguments:
03846 
03847     Object - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being accessed.  This value will not be
03848         used as a pointer (referenced).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to enter into
03849         log messages.
03850 
03851     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open.
03852 
03853     GenerateOnClose - Is a <span class="keywordtype">boolean</span> value returned from a corresponding
03854         <a class="code" href="../../d3/d5/seaudit_8c.html#a23">SeOpenObjectAuditAlarm</a>() call when the object handle was created.
03855 
03856 Return Value:
03857 
03858     None.
03859 
03860 --*/
03861 
03862 {
03863     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
03864     PSID UserSid;
03865     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03866 
03867     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03868 
03869     <span class="keywordflow">if</span> (GenerateOnClose) {
03870 
03871         <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
03872 
03873         UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( EffectiveToken (&amp;SubjectSecurityContext));
03874 
03875 
03876         <a class="code" href="../../d7/d6/sepaudit_8c.html#a13">SepAdtCloseObjectAuditAlarm</a> (
03877             &amp;SeSubsystemName,
03878             (PVOID)Handle,
03879             Object,
03880             UserSid,
03881             <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( EffectiveToken (&amp;SubjectSecurityContext))
03882             );
03883 
03884         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
03885     }
03886 
03887     <span class="keywordflow">return</span>;
03888 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="seaudit.c::SeCreateObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeCreateObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID OperationID&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ComponentName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditPerformed</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03538">3538</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d4/d2/tob_8c-source.html#l00048">DirectoryName</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d1/d5/adtp_8h.html#a22">SepAdtCreateObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03952">SepExamineSacl()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02324">SepQueryNameString()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>.
<p>
<pre class="fragment"><div>03553                    :
03554 
03555     Audits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of an object in a directory.
03556 
03557 Arguments:
03558 
03559     OperationID - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LUID representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
03560         <span class="keywordtype">id</span> <span class="keywordflow">for</span> <span class="keyword">this</span> operation.
03561 
03562     DirectoryObject - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory object being
03563         examined.
03564 
03565     ComponentName - Provides a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03566         relative name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being created.
03567 
03568     SecurityDescriptor - The security descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed direcctory.
03569 
03570     SubjectSecurityContext - The current subject context.
03571 
03572     DesiredAccess - The desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory.
03573 
03574     Privileges - Returns any privileges that were used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt.
03575 
03576     AccessGranted - Returns whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was successful.
03577 
03578     AuditPerformed - Returns whether or not auditing was performed.
03579 
03580     AccessMode - The previous mode.
03581 
03582 Return Value:
03583 
03584     <span class="keywordflow">return</span>-value - <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a> of conditions needed to <span class="keywordflow">return</span> value. - or -
03585     None.
03586 
03587 --*/
03588 
03589 {
03590     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03591 <span class="preprocessor">#if 0</span>
03592 <span class="preprocessor"></span>
03593     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03594     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03595     PUNICODE_STRING <a class="code" href="../../d3/d3/tob_8c.html#a8">DirectoryName</a>;
03596     POBJECT_NAME_INFORMATION ObjectNameInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03597 
03598     UNREFERENCED_PARAMETER( DirectoryObject );
03599     UNREFERENCED_PARAMETER( Privileges );
03600 
03601     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03602         <span class="keywordflow">return</span>;
03603     }
03604 
03605     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03606 
03607         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted )) {
03608 
03609             <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03610                 RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
03611                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ),
03612                 DesiredAccess,
03613                 AccessGranted,
03614                 &amp;GenerateAudit,
03615                 &amp;GenerateAlarm
03616                 );
03617 
03618             <span class="keywordflow">if</span> ( GenerateAudit || GenerateAlarm ) {
03619 
03620                 <span class="comment">//</span>
03621                 <span class="comment">// Call ob for the name of the directory.</span>
03622                 <span class="comment">//</span>
03623 
03624                 ObjectNameInformation = <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>( DirectoryObject );
03625 
03626                 <span class="keywordflow">if</span> ( ObjectNameInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03627 
03628                     <a class="code" href="../../d3/d3/tob_8c.html#a8">DirectoryName</a> = &amp;ObjectNameInformation-&gt;Name;
03629                 }
03630 
03631                 <a class="code" href="../../d1/d5/adtp_8h.html#a22">SepAdtCreateObjectAuditAlarm</a>(
03632                     OperationID,
03633                     DirectoryName,
03634                     ComponentName,
03635                     <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>(<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext )),
03636                     <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext )),
03637                     DesiredAccess,
03638                     AccessGranted,
03639                     GenerateAudit,
03640                     GenerateAlarm
03641                     );
03642 
03643                 *AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03644 
03645                 <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/tob_8c.html#a8">DirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03646 
03647                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DirectoryName );
03648                 }
03649             }
03650         }
03651     }
03652 
03653 <span class="preprocessor">#endif</span>
03654 <span class="preprocessor"></span>
03655     <span class="keywordflow">return</span>;
03656 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="seaudit.c::SeDeleteObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeDeleteObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03892">3892</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01465">SepAdtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, and <a class="el" href="../../d6/d9/obclose_8c-source.html#l00414">NtMakeTemporaryObject()</a>.
<p>
<pre class="fragment"><div>03899                    :
03900 
03901     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an object
03902     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> marked <span class="keywordflow">for</span> deletion.
03903 
03904     This routine may result in several messages being generated and sent to
03905     Port objects.  This may result in a significant latency before
03906     returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span> routine must take
03907     <span class="keyword">this</span> potential latency into account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03908     approach taken <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span> example.
03909 
03910 Arguments:
03911 
03912     Object - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being accessed.  This value will not be
03913         used as a pointer (referenced).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to enter into
03914         log messages.
03915 
03916     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open.
03917 
03918 Return Value:
03919 
03920     None.
03921 
03922 --*/
03923 
03924 {
03925     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
03926     PSID UserSid;
03927     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03928 
03929     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03930 
03931     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
03932 
03933     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( EffectiveToken (&amp;SubjectSecurityContext));
03934 
03935 
03936 
03937     <a class="code" href="../../d7/d6/sepaudit_8c.html#a14">SepAdtDeleteObjectAuditAlarm</a> (
03938         &amp;SeSubsystemName,
03939         (PVOID)Handle,
03940         Object,
03941         UserSid,
03942         <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( EffectiveToken (&amp;SubjectSecurityContext))
03943         );
03944 
03945     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
03946 
03947     <span class="keywordflow">return</span>;
03948 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="seaudit.c::SeObjectReferenceAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeObjectReferenceAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID OperationID&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03660">3660</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03952">SepExamineSacl()</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">ObpCheckObjectReference()</a>.
<p>
<pre class="fragment"><div>03673                    :
03674 
03675     description-of-function.
03676 
03677 Arguments:
03678 
03679     argument-name - Supplies | Returns description of argument.
03680     .
03681     .
03682 
03683 Return Value:
03684 
03685     <span class="keywordflow">return</span>-value - <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a> of conditions needed to <span class="keywordflow">return</span> value. - or -
03686     None.
03687 
03688 --*/
03689 
03690 {
03691     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03692     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03693 
03694     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03695 
03696     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03697         <span class="keywordflow">return</span>;
03698     }
03699 
03700     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03701 
03702         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryDetailedTracking, &amp;AccessGranted )) {
03703 
03704             <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03705                 RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
03706                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ),
03707                 DesiredAccess,
03708                 AccessGranted,
03709                 &amp;GenerateAudit,
03710                 &amp;GenerateAlarm
03711                 );
03712 
03713             <span class="keywordflow">if</span> ( GenerateAudit || GenerateAlarm ) {
03714 
03715                 <a class="code" href="../../d7/d6/sepaudit_8c.html#a16">SepAdtObjectReferenceAuditAlarm</a>(
03716                     OperationID,
03717                     Object,
03718                     SubjectSecurityContext,
03719                     DesiredAccess,
03720                     Privileges,
03721                     AccessGranted,
03722                     GenerateAudit,
03723                     GenerateAlarm
03724                     );
03725             }
03726         }
03727     }
03728 
03729     <span class="keywordflow">return</span>;
03730 
03731 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="seaudit.c::SeOpenObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeOpenObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Object&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING AbsoluteObjectName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreated</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">2765</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00259">_AUX_ACCESS_DATA::GenericMapping</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00258">_AUX_ACCESS_DATA::PrivilegesUsed</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03952">SepExamineSacl()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04587">SepFilterPrivilegeAudits()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02324">SepQueryNameString()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02400">SepQueryTypeString()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>.
<p>
<pre class="fragment"><div>02778                    :
02779 
02780     <a class="code" href="../../d0/d5/se_8h.html#a141">SeOpenObjectAuditAlarm</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager that open objects
02781     to generate any necessary audit or alarm messages.  The open may be to
02782     existing objects or <span class="keywordflow">for</span> newly created objects.  No messages will be
02783     generated <span class="keywordflow">for</span> Kernel mode accesses.
02784 
02785     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
02786     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to open an object.
02787 
02788     This routine may result in several messages being generated and sent to
02789     Port objects.  This may result in a significant latency before
02790     returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span> routine must take
02791     <span class="keyword">this</span> potential latency into account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02792     approach taken <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span> example.
02793 
02794 Arguments:
02795 
02796     ObjectTypeName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object being
02797         accessed.  This must be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same name provided to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02798         <a class="code" href="../../d4/d0/ob_8h.html#a67">ObCreateObjectType</a> service when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> was created.
02799 
02800     Object - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object accessed.  This value will not be used
02801         as a pointer (referenced).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to enter into log
02802         messages.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open was not successful, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02803         ignored.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be provided.
02804 
02805     AbsoluteObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being accessed.
02806         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> have a name, then <span class="keyword">this</span> field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> left null.
02807         Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be provided.
02808 
02809     SecurityDescriptor - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02810         object being accessed.
02811 
02812     AccessState - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to an access state structure containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02813         subject context, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining desired access types, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted
02814         access types, and optionally a privilege set to indicate which
02815         privileges were used to permit <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access.
02816 
02817     ObjectCreated - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access resulted
02818         in a <span class="keyword">new</span> object being created.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates an object
02819         was created, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates an existing object was opened.
02820 
02821     AccessGranted - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted or denied based on
02822         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check or privilege check.
02823 
02824     AccessMode - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.  One
02825         of <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>.  Messages will not be generated by
02826         kernel mode accesses.
02827 
02828     GenerateOnClose - Points to a <span class="keywordtype">boolean</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit
02829         generation routine and must be passed to <a class="code" href="../../d3/d5/seaudit_8c.html#a29">SeCloseObjectAuditAlarm</a>()
02830         when the object handle is closed.
02831 
02832 Return value:
02833 
02834     None.
02835 
02836 --*/
02837 {
02838     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02839     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02840     ACCESS_MASK RequestedAccess;
02841     POBJECT_NAME_INFORMATION ObjectNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02842     PUNICODE_STRING ObjectTypeNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02843     PUNICODE_STRING ObjectName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02844     PUNICODE_STRING LocalObjectTypeName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02845     PLUID PrimaryAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02846     PLUID ClientAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02847     BOOLEAN AuditPrivileges = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02848     BOOLEAN AuditPerformed;
02849     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02850     ACCESS_MASK MappedGrantMask = (ACCESS_MASK)0;
02851     ACCESS_MASK MappedDenyMask = (ACCESS_MASK)0;
02852     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData;
02853 
02854     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02855 
02856     <span class="keywordflow">if</span> ( AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
02857         <span class="keywordflow">return</span>;
02858     }
02859 
02860     AuxData = (<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)AccessState-&gt;AuxData;
02861 
02862     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;AccessState-&gt;SubjectSecurityContext );
02863 
02864     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData)) {
02865 
02866         MappedGrantMask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData-&gt;GrantMask;
02867 
02868         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
02869             &amp;MappedGrantMask,
02870             &amp;AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a>
02871             );
02872 
02873         MappedDenyMask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData-&gt;DenyMask;
02874 
02875         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
02876             &amp;MappedDenyMask,
02877             &amp;AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a>
02878             );
02879     }
02880 
02881     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02882 
02883         RequestedAccess = AccessState-&gt;RemainingDesiredAccess |
02884                           AccessState-&gt;PreviouslyGrantedAccess;
02885 
02886         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted )) {
02887 
02888             <span class="keywordflow">if</span> ( RequestedAccess &amp; (AccessGranted ? MappedGrantMask : MappedDenyMask)) {
02889 
02890                 GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02891 
02892             } <span class="keywordflow">else</span> {
02893 
02894                 <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
02895                     RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
02896                     Token,
02897                     RequestedAccess,
02898                     AccessGranted,
02899                     &amp;GenerateAudit,
02900                     &amp;GenerateAlarm
02901                     );
02902             }
02903 
02904             <span class="comment">//</span>
02905             <span class="comment">// Only generate an audit on close of we're auditing from SACL</span>
02906             <span class="comment">// settings.</span>
02907             <span class="comment">//</span>
02908 
02909             <span class="keywordflow">if</span> (GenerateAudit) {
02910                 *GenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02911             }
02912         }
02913     }
02914 
02915     <span class="comment">//</span>
02916     <span class="comment">// If we don't generate an audit via the SACL, see if we need to generate</span>
02917     <span class="comment">// one for privilege use.</span>
02918     <span class="comment">//</span>
02919     <span class="comment">// Note that we only audit privileges successfully used to open objects,</span>
02920     <span class="comment">// so we don't care about a failed privilege use here.  Therefore, only</span>
02921     <span class="comment">// do this test of access has been granted.</span>
02922     <span class="comment">//</span>
02923 
02924     <span class="keywordflow">if</span> (!GenerateAudit &amp;&amp; (AccessGranted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02925 
02926         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted )) {
02927 
02928             <span class="keywordflow">if</span> ((AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02929                 (AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>-&gt;PrivilegeCount &gt; 0) ) {
02930 
02931                 <span class="comment">//</span>
02932                 <span class="comment">// Make sure these are actually privileges that we want to audit</span>
02933                 <span class="comment">//</span>
02934 
02935                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>( AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> )) {
02936 
02937                     GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02938 
02939                     <span class="comment">//</span>
02940                     <span class="comment">// When we finally try to generate this audit, this flag</span>
02941                     <span class="comment">// will tell us that we need to audit the fact that we</span>
02942                     <span class="comment">// used a privilege, as opposed to audit due to the SACL.</span>
02943                     <span class="comment">//</span>
02944 
02945                     AccessState-&gt;AuditPrivileges = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02946                 }
02947             }
02948         }
02949     }
02950 
02951     <span class="comment">//</span>
02952     <span class="comment">// Set up either to generate an audit (if the access check has failed), or save</span>
02953     <span class="comment">// the stuff that we're going to audit later into the AccessState structure.</span>
02954     <span class="comment">//</span>
02955 
02956     <span class="keywordflow">if</span> (GenerateAudit || GenerateAlarm) {
02957 
02958         AccessState-&gt;GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02959 
02960         <span class="comment">//</span>
02961         <span class="comment">// Figure out what we've been passed, and obtain as much</span>
02962         <span class="comment">// missing information as possible.</span>
02963         <span class="comment">//</span>
02964 
02965         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( AbsoluteObjectName )) {
02966 
02967             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Object )) {
02968 
02969                 ObjectNameInfo = <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>( Object  );
02970 
02971                 <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02972 
02973                     ObjectName = &amp;ObjectNameInfo-&gt;Name;
02974                 }
02975             }
02976 
02977         } <span class="keywordflow">else</span> {
02978 
02979             ObjectName = AbsoluteObjectName;
02980         }
02981 
02982         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( ObjectTypeName )) {
02983 
02984             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Object )) {
02985 
02986                 ObjectTypeNameInfo = <a class="code" href="../../d7/d6/sepaudit_8c.html#a18">SepQueryTypeString</a>( Object );
02987 
02988                 <span class="keywordflow">if</span> ( ObjectTypeNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02989 
02990                     LocalObjectTypeName = ObjectTypeNameInfo;
02991                 }
02992             }
02993 
02994         } <span class="keywordflow">else</span> {
02995 
02996             LocalObjectTypeName = ObjectTypeName;
02997         }
02998 
02999         <span class="comment">//</span>
03000         <span class="comment">// If the access attempt failed, do the audit here.  If it succeeded,</span>
03001         <span class="comment">// we'll do the audit later, when the handle is allocated.</span>
03002         <span class="comment">//</span>
03003         <span class="comment">//</span>
03004 
03005         <span class="keywordflow">if</span> (!AccessGranted) {
03006 
03007             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> ( &amp;SeSubsystemName,
03008                                                           NULL,
03009                                                           LocalObjectTypeName,
03010                                                           NULL,
03011                                                           ObjectName,
03012                                                           AccessState-&gt;SubjectSecurityContext.ClientToken,
03013                                                           AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03014                                                           AccessState-&gt;OriginalDesiredAccess,
03015                                                           AccessState-&gt;PreviouslyGrantedAccess,
03016                                                           &amp;AccessState-&gt;OperationID,
03017                                                           AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03018                                                           FALSE,
03019                                                           FALSE,
03020                                                           TRUE,
03021                                                           FALSE,
03022                                                           AccessState-&gt;SubjectSecurityContext.ProcessAuditId,
03023                                                           AuditCategoryObjectAccess,
03024                                                           NULL,
03025                                                           0,
03026                                                           NULL );
03027         } <span class="keywordflow">else</span> {
03028 
03029             <span class="comment">//</span>
03030             <span class="comment">// Copy all the stuff we're going to need into the</span>
03031             <span class="comment">// AccessState and return.</span>
03032             <span class="comment">//</span>
03033 
03034             <span class="keywordflow">if</span> ( ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03035 
03036                  <span class="keywordflow">if</span> ( AccessState-&gt;ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03037 
03038                      <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AccessState-&gt;ObjectName.Buffer );
03039                      AccessState-&gt;ObjectName.Length = 0;
03040                      AccessState-&gt;ObjectName.MaximumLength = 0;
03041                  }
03042 
03043                 AccessState-&gt;ObjectName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,ObjectName-&gt;MaximumLength );
03044                 <span class="keywordflow">if</span> (AccessState-&gt;ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03045 
03046                     AccessState-&gt;ObjectName.MaximumLength = ObjectName-&gt;MaximumLength;
03047                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;AccessState-&gt;ObjectName, ObjectName );
03048                 }
03049             }
03050 
03051             <span class="keywordflow">if</span> ( LocalObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03052 
03053                  <span class="keywordflow">if</span> ( AccessState-&gt;ObjectTypeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03054 
03055                      <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AccessState-&gt;ObjectTypeName.Buffer );
03056                      AccessState-&gt;ObjectTypeName.Length = 0;
03057                      AccessState-&gt;ObjectTypeName.MaximumLength = 0;
03058                  }
03059 
03060                 AccessState-&gt;ObjectTypeName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, LocalObjectTypeName-&gt;MaximumLength );
03061                 <span class="keywordflow">if</span> (AccessState-&gt;ObjectTypeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03062 
03063                     AccessState-&gt;ObjectTypeName.MaximumLength = LocalObjectTypeName-&gt;MaximumLength;
03064                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;AccessState-&gt;ObjectTypeName, LocalObjectTypeName );
03065                 }
03066             }
03067         }
03068 
03069         <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03070 
03071             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectNameInfo );
03072         }
03073 
03074         <span class="keywordflow">if</span> ( ObjectTypeNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03075 
03076             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeNameInfo );
03077         }
03078     }
03079 
03080     <span class="keywordflow">return</span>;
03081 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="seaudit.c::SeOpenObjectForDeleteAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeOpenObjectForDeleteAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Object&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING AbsoluteObjectName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreated</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03085">3085</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00259">_AUX_ACCESS_DATA::GenericMapping</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00258">_AUX_ACCESS_DATA::PrivilegesUsed</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03952">SepExamineSacl()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04587">SepFilterPrivilegeAudits()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02324">SepQueryNameString()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02400">SepQueryTypeString()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03098                    :
03099 
03100     <a class="code" href="../../d0/d5/se_8h.html#a142">SeOpenObjectForDeleteAuditAlarm</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager that open
03101     objects to generate any necessary audit or alarm messages.  The open may
03102     be to existing objects or <span class="keywordflow">for</span> newly created objects.  No messages will be
03103     generated <span class="keywordflow">for</span> Kernel mode accesses.
03104 
03105     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
03106     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to open an object with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> intent to <span class="keyword">delete</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
03107     Specifically, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> systems when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag
03108     FILE_DELETE_ON_CLOSE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.
03109 
03110     This routine may result in several messages being generated and sent to
03111     Port objects.  This may result in a significant latency before
03112     returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span> routine must take
03113     <span class="keyword">this</span> potential latency into account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03114     approach taken <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span> example.
03115 
03116 Arguments:
03117 
03118     ObjectTypeName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object being
03119         accessed.  This must be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same name provided to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03120         <a class="code" href="../../d4/d0/ob_8h.html#a67">ObCreateObjectType</a> service when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> was created.
03121 
03122     Object - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object accessed.  This value will not be used
03123         as a pointer (referenced).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to enter into log
03124         messages.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open was not successful, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03125         ignored.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be provided.
03126 
03127     AbsoluteObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being accessed.
03128         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> have a name, then <span class="keyword">this</span> field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> left null.
03129         Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be provided.
03130 
03131     SecurityDescriptor - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03132         object being accessed.
03133 
03134     AccessState - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to an access state structure containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03135         subject context, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining desired access types, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted
03136         access types, and optionally a privilege set to indicate which
03137         privileges were used to permit <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access.
03138 
03139     ObjectCreated - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access resulted
03140         in a <span class="keyword">new</span> object being created.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates an object
03141         was created, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates an existing object was opened.
03142 
03143     AccessGranted - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted or denied based on
03144         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check or privilege check.
03145 
03146     AccessMode - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.  One
03147         of <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>.  Messages will not be generated by
03148         kernel mode accesses.
03149 
03150     GenerateOnClose - Points to a <span class="keywordtype">boolean</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit
03151         generation routine and must be passed to <a class="code" href="../../d3/d5/seaudit_8c.html#a29">SeCloseObjectAuditAlarm</a>()
03152         when the object handle is closed.
03153 
03154 Return value:
03155 
03156     None.
03157 
03158 --*/
03159 {
03160     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03161     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03162     ACCESS_MASK RequestedAccess;
03163     POBJECT_NAME_INFORMATION ObjectNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03164     PUNICODE_STRING ObjectTypeNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03165     PUNICODE_STRING ObjectName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03166     PUNICODE_STRING LocalObjectTypeName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03167     PLUID PrimaryAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03168     PLUID ClientAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03169     BOOLEAN AuditPrivileges = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03170     BOOLEAN AuditPerformed;
03171     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
03172     ACCESS_MASK MappedGrantMask = (ACCESS_MASK)0;
03173     ACCESS_MASK MappedDenyMask = (ACCESS_MASK)0;
03174     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData;
03175 
03176     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03177 
03178     <span class="keywordflow">if</span> ( AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
03179         <span class="keywordflow">return</span>;
03180     }
03181 
03182     AuxData = (<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)AccessState-&gt;AuxData;
03183 
03184     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;AccessState-&gt;SubjectSecurityContext );
03185 
03186     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData)) {
03187 
03188         MappedGrantMask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData-&gt;GrantMask;
03189 
03190         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
03191             &amp;MappedGrantMask,
03192             &amp;AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a>
03193             );
03194 
03195         MappedDenyMask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData-&gt;DenyMask;
03196 
03197         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
03198             &amp;MappedDenyMask,
03199             &amp;AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a>
03200             );
03201     }
03202 
03203     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03204 
03205         RequestedAccess = AccessState-&gt;RemainingDesiredAccess |
03206                           AccessState-&gt;PreviouslyGrantedAccess;
03207 
03208         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted )) {
03209 
03210             <span class="keywordflow">if</span> ( RequestedAccess &amp; (AccessGranted ? MappedGrantMask : MappedDenyMask)) {
03211 
03212                 GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03213 
03214             } <span class="keywordflow">else</span> {
03215 
03216                 <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03217                     RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
03218                     Token,
03219                     RequestedAccess,
03220                     AccessGranted,
03221                     &amp;GenerateAudit,
03222                     &amp;GenerateAlarm
03223                     );
03224             }
03225 
03226             <span class="comment">//</span>
03227             <span class="comment">// Only generate an audit on close of we're auditing from SACL</span>
03228             <span class="comment">// settings.</span>
03229             <span class="comment">//</span>
03230 
03231             <span class="keywordflow">if</span> (GenerateAudit) {
03232                 *GenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03233             }
03234         }
03235     }
03236 
03237     <span class="comment">//</span>
03238     <span class="comment">// If we don't generate an audit via the SACL, see if we need to generate</span>
03239     <span class="comment">// one for privilege use.</span>
03240     <span class="comment">//</span>
03241     <span class="comment">// Note that we only audit privileges successfully used to open objects,</span>
03242     <span class="comment">// so we don't care about a failed privilege use here.  Therefore, only</span>
03243     <span class="comment">// do this test of access has been granted.</span>
03244     <span class="comment">//</span>
03245 
03246     <span class="keywordflow">if</span> (!GenerateAudit &amp;&amp; (AccessGranted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03247 
03248         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted )) {
03249 
03250             <span class="keywordflow">if</span> ((AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03251                 (AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>-&gt;PrivilegeCount &gt; 0) ) {
03252 
03253                 <span class="comment">//</span>
03254                 <span class="comment">// Make sure these are actually privileges that we want to audit</span>
03255                 <span class="comment">//</span>
03256 
03257                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>( AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> )) {
03258 
03259                     GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03260 
03261                     <span class="comment">//</span>
03262                     <span class="comment">// When we finally try to generate this audit, this flag</span>
03263                     <span class="comment">// will tell us that we need to audit the fact that we</span>
03264                     <span class="comment">// used a privilege, as opposed to audit due to the SACL.</span>
03265                     <span class="comment">//</span>
03266 
03267                     AccessState-&gt;AuditPrivileges = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03268                 }
03269             }
03270         }
03271     }
03272 
03273     <span class="comment">//</span>
03274     <span class="comment">// Set up either to generate an audit (if the access check has failed), or save</span>
03275     <span class="comment">// the stuff that we're going to audit later into the AccessState structure.</span>
03276     <span class="comment">//</span>
03277 
03278     <span class="keywordflow">if</span> (GenerateAudit || GenerateAlarm) {
03279 
03280         AccessState-&gt;GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03281 
03282         <span class="comment">//</span>
03283         <span class="comment">// Figure out what we've been passed, and obtain as much</span>
03284         <span class="comment">// missing information as possible.</span>
03285         <span class="comment">//</span>
03286 
03287         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( AbsoluteObjectName )) {
03288 
03289             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Object )) {
03290 
03291                 ObjectNameInfo = <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>( Object  );
03292 
03293                 <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03294 
03295                     ObjectName = &amp;ObjectNameInfo-&gt;Name;
03296                 }
03297             }
03298 
03299         } <span class="keywordflow">else</span> {
03300 
03301             ObjectName = AbsoluteObjectName;
03302         }
03303 
03304         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( ObjectTypeName )) {
03305 
03306             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Object )) {
03307 
03308                 ObjectTypeNameInfo = <a class="code" href="../../d7/d6/sepaudit_8c.html#a18">SepQueryTypeString</a>( Object );
03309 
03310                 <span class="keywordflow">if</span> ( ObjectTypeNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03311 
03312                     LocalObjectTypeName = ObjectTypeNameInfo;
03313                 }
03314             }
03315 
03316         } <span class="keywordflow">else</span> {
03317 
03318             LocalObjectTypeName = ObjectTypeName;
03319         }
03320 
03321         <span class="comment">//</span>
03322         <span class="comment">// If the access attempt failed, do the audit here.  If it succeeded,</span>
03323         <span class="comment">// we'll do the audit later, when the handle is allocated.</span>
03324         <span class="comment">//</span>
03325         <span class="comment">//</span>
03326 
03327         <span class="keywordflow">if</span> (!AccessGranted) {
03328 
03329             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> ( &amp;SeSubsystemName,
03330                                                           NULL,
03331                                                           LocalObjectTypeName,
03332                                                           NULL,
03333                                                           ObjectName,
03334                                                           AccessState-&gt;SubjectSecurityContext.ClientToken,
03335                                                           AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03336                                                           AccessState-&gt;OriginalDesiredAccess,
03337                                                           AccessState-&gt;PreviouslyGrantedAccess,
03338                                                           &amp;AccessState-&gt;OperationID,
03339                                                           AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03340                                                           FALSE,
03341                                                           FALSE,
03342                                                           TRUE,
03343                                                           FALSE,
03344                                                           AccessState-&gt;SubjectSecurityContext.ProcessAuditId,
03345                                                           AuditCategoryObjectAccess,
03346                                                           NULL,
03347                                                           0,
03348                                                           NULL );
03349         } <span class="keywordflow">else</span> {
03350 
03351             <span class="comment">//</span>
03352             <span class="comment">// Generate the delete audit first</span>
03353             <span class="comment">//</span>
03354 
03355             <a class="code" href="../../d7/d6/sepaudit_8c.html#a12">SepAdtOpenObjectForDeleteAuditAlarm</a> ( &amp;SeSubsystemName,
03356                                                   NULL,
03357                                                   LocalObjectTypeName,
03358                                                   NULL,
03359                                                   ObjectName,
03360                                                   AccessState-&gt;SubjectSecurityContext.ClientToken,
03361                                                   AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03362                                                   AccessState-&gt;OriginalDesiredAccess,
03363                                                   AccessState-&gt;PreviouslyGrantedAccess,
03364                                                   &amp;AccessState-&gt;OperationID,
03365                                                   AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03366                                                   FALSE,
03367                                                   TRUE,
03368                                                   TRUE,
03369                                                   FALSE,
03370                                                   AccessState-&gt;SubjectSecurityContext.ProcessAuditId );
03371 
03372             <span class="comment">//</span>
03373             <span class="comment">// Copy all the stuff we're going to need into the</span>
03374             <span class="comment">// AccessState and return.</span>
03375             <span class="comment">//</span>
03376 
03377             <span class="keywordflow">if</span> ( ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03378 
03379                  <span class="keywordflow">if</span> ( AccessState-&gt;ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03380 
03381                      <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AccessState-&gt;ObjectName.Buffer );
03382                      AccessState-&gt;ObjectName.Length = 0;
03383                      AccessState-&gt;ObjectName.MaximumLength = 0;
03384                  }
03385 
03386                 AccessState-&gt;ObjectName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,ObjectName-&gt;MaximumLength );
03387                 <span class="keywordflow">if</span> (AccessState-&gt;ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03388 
03389                     AccessState-&gt;ObjectName.MaximumLength = ObjectName-&gt;MaximumLength;
03390                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;AccessState-&gt;ObjectName, ObjectName );
03391                 }
03392             }
03393 
03394             <span class="keywordflow">if</span> ( LocalObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03395 
03396                  <span class="keywordflow">if</span> ( AccessState-&gt;ObjectTypeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03397 
03398                      <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AccessState-&gt;ObjectTypeName.Buffer );
03399                      AccessState-&gt;ObjectTypeName.Length = 0;
03400                      AccessState-&gt;ObjectTypeName.MaximumLength = 0;
03401                  }
03402 
03403                 AccessState-&gt;ObjectTypeName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, LocalObjectTypeName-&gt;MaximumLength );
03404                 <span class="keywordflow">if</span> (AccessState-&gt;ObjectTypeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03405 
03406                     AccessState-&gt;ObjectTypeName.MaximumLength = LocalObjectTypeName-&gt;MaximumLength;
03407                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;AccessState-&gt;ObjectTypeName, LocalObjectTypeName );
03408                 }
03409             }
03410         }
03411 
03412         <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03413 
03414             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectNameInfo );
03415         }
03416 
03417         <span class="keywordflow">if</span> ( ObjectTypeNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03418 
03419             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeNameInfo );
03420         }
03421     }
03422 
03423     <span class="keywordflow">return</span>;
03424 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="seaudit.c::SepAccessCheckAndAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepAccessCheckAndAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN AUDIT_EVENT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateOnClose</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnResultList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">1050</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00100">_SECURITY_SUBJECT_CONTEXT::ClientToken</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03024">ExAllocateLocallyUniqueId</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00101">_SECURITY_SUBJECT_CONTEXT::ImpersonationLevel</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00242">IsValidElementCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01447">ProbeForWriteBoolean</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00814">PsProcessAuditId</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00144">SeCaptureObjectTypeList()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00053">SeCaptureSecurityDescriptor()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01141">SeCaptureSid()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">SeCheckAuditPrivilege()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00353">SeFreeCapturedObjectTypeList()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00269">SepAdtAuditThisEventEx</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04257">SepExamineSaclEx()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00370">SepFreeCapturedString()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00259">SepProbeAndCaptureString_U()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03652">SePrivilegePolicyCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03796">SepTokenIsOwner()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00631">SeReleaseSecurityDescriptor()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01320">SeReleaseSid()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01820">NtAccessCheckAndAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01879">NtAccessCheckByTypeAndAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01943">NtAccessCheckByTypeResultListAndAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02007">NtAccessCheckByTypeResultListAndAuditAlarmByHandle()</a>.
<p>
<pre class="fragment"><div>01072                    :
01073 
01074     This system service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to perform both an access validation and
01075     generate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding audit and alarm messages.  This service may
01076     <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be used by a <span class="keyword">protected</span> server that chooses to impersonate its
01077     client and thereby specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client security context implicitly.
01078 
01079 Arguments:
01080 
01081     SubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsystem
01082         calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
01083 
01084     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value that will be used to represent <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's
01085         handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored (and may be re-used)
01086         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> denied.
01087 
01088     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client token so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not have
01089         to impersonate before making <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel call.
01090 
01091     ObjectTypeName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
01092         created or accessed.
01093 
01094     ObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being created or accessed.
01095 
01096     SecurityDescriptor - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor against which
01097         acccess <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be checked.
01098 
01099     DesiredAccess - The desired acccess mask.  This mask must have been
01100         previously mapped to contain no generic accesses.
01101 
01102     AuditType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of audit to be generated.  Valid values
01103         are: AuditEventObjectAccess and AuditEventDirectoryServiceAccess.
01104 
01105     Flags - Flags modifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> execution of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> API:
01106 
01107         AUDIT_ALLOW_NO_PRIVILEGE - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> called does not have AuditPrivilege,
01108             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call will silently <span class="keywordflow">continue</span> to check access and will
01109             generate no audit.
01110 
01111     ObjectTypeList - Supplies a list of GUIDs representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (and
01112         sub-objects) being accessed.  If no list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, AccessCheckByType
01113         behaves identically to AccessCheck.
01114 
01115     ObjectTypeListLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList.
01116 
01117     GenericMapping - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated
01118         with <span class="keyword">this</span> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
01119 
01120     ObjectCreation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> flag indicated whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access will
01121         result in a <span class="keyword">new</span> object being created <span class="keywordflow">if</span> granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01122         indicates an object will be created, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates an existing
01123         object will be opened.
01124 
01125     GrantedAccess - Receives a masking indicating which accesses have been
01126         granted.
01127 
01128     AccessStatus - Receives an indication of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01129         access check.  If access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> granted, STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01130         If access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> denied, a value appropriate <span class="keywordflow">for</span> <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
01131         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.  This will be STATUS_ACCESS_DENIED or, when mandatory
01132         access controls are implemented, STATUS_OBJECT_NOT_FOUND.
01133 
01134     GenerateOnClose - Points to a <span class="keywordtype">boolean</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audity
01135         generation routine and must be passed to <a class="code" href="../../d3/d5/seaudit_8c.html#a21">NtCloseObjectAuditAlarm</a>
01136         when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed.
01137 
01138     ReturnResultList - If <span class="keyword">true</span>, GrantedAccess and AccessStatus are actually
01139         arrays of entries ObjectTypeListLength elements <span class="keywordtype">long</span>.
01140 
01141 Return Value:
01142 
01143     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.  In <span class="keyword">this</span>
01144         <span class="keywordflow">case</span>, ClientStatus receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
01145 
01146     STATUS_PRIVILEGE_NOT_HELD - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not have
01147         sufficient privilege to use <span class="keyword">this</span> privileged system service.
01148 
01149 --*/
01150 
01151 {
01152 
01153     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
01154 
01155     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01156 
01157     ACCESS_MASK LocalGrantedAccess = (ACCESS_MASK)0;
01158     PACCESS_MASK LocalGrantedAccessPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01159     BOOLEAN LocalGrantedAccessAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01160     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> LocalAccessStatus;
01161     PNTSTATUS LocalAccessStatusPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01162     BOOLEAN LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01163     POLICY_AUDIT_EVENT_TYPE NtAuditType;
01164 
01165     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01166 
01167     PUNICODE_STRING CapturedSubsystemName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168     PUNICODE_STRING CapturedObjectTypeName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01169     PUNICODE_STRING CapturedObjectName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01170     PSECURITY_DESCRIPTOR CapturedSecurityDescriptor = (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01171     PSID CapturedPrincipalSelfSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01172     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalObjectTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01173 
01174     ACCESS_MASK PreviouslyGrantedAccess = (ACCESS_MASK)0;
01175     GENERIC_MAPPING LocalGenericMapping;
01176 
01177     PPRIVILEGE_SET PrivilegeSet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01178 
01179     BOOLEAN Result;
01180 
01181     BOOLEAN AccessGranted;
01182     BOOLEAN AccessDenied;
01183     BOOLEAN GenerateSuccessAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01184     BOOLEAN GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01185     LUID OperationId;
01186     BOOLEAN AuditPerformed;
01187     BOOLEAN AvoidAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01188 
01189     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01190     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> OldToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01191     BOOLEAN TokenSwapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01192 
01193     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01194 
01195     PreviousMode = KeGetPreviousMode();
01196 
01197     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PreviousMode != KernelMode );
01198 
01199     <span class="comment">//</span>
01200     <span class="comment">// Capture the subject Context</span>
01201     <span class="comment">//</span>
01202 
01203     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
01204 
01205     <span class="comment">//</span>
01206     <span class="comment">// Convert AuditType</span>
01207     <span class="comment">//</span>
01208 
01209     <span class="keywordflow">if</span> ( AuditType == AuditEventObjectAccess ) {
01210         NtAuditType = AuditCategoryObjectAccess;
01211     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( AuditType == AuditEventDirectoryServiceAccess ) {
01212         NtAuditType = AuditCategoryDirectoryServiceAccess;
01213     } <span class="keywordflow">else</span> {
01214         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01215         <span class="keywordflow">goto</span> Cleanup;
01216     }
01217 
01218     <span class="comment">//</span>
01219     <span class="comment">// Impersonation checks should be done only if the ClientToken is NULL.</span>
01220     <span class="comment">//</span>
01221 
01222     <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( ClientToken ) ) {
01223 
01224         <span class="comment">//</span>
01225         <span class="comment">// Make sure we're impersonating a client...</span>
01226         <span class="comment">//</span>
01227 
01228         <span class="keywordflow">if</span> ( (SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01229             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_IMPERSONATION_TOKEN;
01230             <span class="keywordflow">goto</span> Cleanup;
01231         }
01232 
01233 
01234         <span class="comment">//</span>
01235         <span class="comment">// ...and at a high enough impersonation level</span>
01236         <span class="comment">//</span>
01237 
01238         <span class="keywordflow">if</span> (SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o1">ImpersonationLevel</a> &lt; SecurityIdentification) {
01239             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BAD_IMPERSONATION_LEVEL;
01240             <span class="keywordflow">goto</span> Cleanup;
01241         }
01242     }
01243 
01244     <span class="keywordflow">try</span> {
01245 
01246         <span class="keywordflow">if</span> ( ReturnResultList ) {
01247 
01248             <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01249                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01250                 leave;
01251             }
01252 
01253             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>(ObjectTypeListLength, ULONG)) {
01254                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01255                 leave;
01256             }
01257             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
01258                 AccessStatus,
01259                 <span class="keyword">sizeof</span>(NTSTATUS) * ObjectTypeListLength,
01260                 <span class="keyword">sizeof</span>(ULONG)
01261                 );
01262 
01263             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
01264                 GrantedAccess,
01265                 <span class="keyword">sizeof</span>(ACCESS_MASK) * ObjectTypeListLength,
01266                 <span class="keyword">sizeof</span>(ULONG)
01267                 );
01268 
01269         } <span class="keywordflow">else</span> {
01270             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)AccessStatus);
01271             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)GrantedAccess);
01272         }
01273 
01274         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01275             GenericMapping,
01276             <span class="keyword">sizeof</span>(GENERIC_MAPPING),
01277             <span class="keyword">sizeof</span>(ULONG)
01278             );
01279 
01280         LocalGenericMapping = *GenericMapping;
01281 
01282     } except (EXCEPTION_EXECUTE_HANDLER) {
01283 
01284         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01285     }
01286 
01287     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01288         <span class="keywordflow">goto</span> Cleanup;
01289     }
01290 
01291     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken ) ) {
01292 
01293         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01294                      *ClientToken,                 <span class="comment">// Handle</span>
01295                      (ACCESS_MASK)TOKEN_QUERY,     <span class="comment">// DesiredAccess</span>
01296                      SepTokenObjectType,           <span class="comment">// ObjectType</span>
01297                      PreviousMode,                 <span class="comment">// AccessMode</span>
01298                      (PVOID *)&amp;NewToken,           <span class="comment">// Object</span>
01299                      NULL                          <span class="comment">// GrantedAccess</span>
01300                      );
01301 
01302         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01303             NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01304             <span class="keywordflow">goto</span> Cleanup;
01305         }
01306 
01307         <span class="comment">//</span>
01308         <span class="comment">// Save the old token so that it can be recovered before</span>
01309         <span class="comment">// SeReleaseSubjectContext.</span>
01310         <span class="comment">//</span>
01311 
01312         OldToken = SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>;
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">// Set the impersonation token to the one that has been obtained thru</span>
01316         <span class="comment">// ClientToken handle. This must be freed later in Cleanup.</span>
01317         <span class="comment">//</span>
01318 
01319         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = NewToken;
01320 
01321         TokenSwapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01322     }
01323 
01324     <span class="comment">//</span>
01325     <span class="comment">// Check for SeAuditPrivilege</span>
01326     <span class="comment">//</span>
01327 
01328     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
01329                  &amp;SubjectSecurityContext,
01330                  PreviousMode
01331                  );
01332 
01333     <span class="keywordflow">if</span> (!Result) {
01334         <span class="keywordflow">if</span> ( Flags &amp; AUDIT_ALLOW_NO_PRIVILEGE ) {
01335             AvoidAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01336         } <span class="keywordflow">else</span> {
01337             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
01338             <span class="keywordflow">goto</span> Cleanup;
01339         }
01340     }
01341 
01342     <span class="keywordflow">if</span> (DesiredAccess &amp;
01343         ( GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | GENERIC_ALL )) {
01344 
01345         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_GENERIC_NOT_MAPPED;
01346         <span class="keywordflow">goto</span> Cleanup;
01347     }
01348 
01349     <span class="comment">//</span>
01350     <span class="comment">// Capture the passed security descriptor.</span>
01351     <span class="comment">//</span>
01352     <span class="comment">// SeCaptureSecurityDescriptor probes the input security descriptor,</span>
01353     <span class="comment">// so we don't have to</span>
01354     <span class="comment">//</span>
01355 
01356     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a> (
01357                 SecurityDescriptor,
01358                 PreviousMode,
01359                 PagedPool,
01360                 FALSE,
01361                 &amp;CapturedSecurityDescriptor
01362                 );
01363 
01364     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01365         CapturedSecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01366         <span class="keywordflow">goto</span> Cleanup;
01367     }
01368 
01369     <span class="keywordflow">if</span> ( CapturedSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01370         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
01371         <span class="keywordflow">goto</span> Cleanup;
01372     }
01373 
01374     <span class="comment">//</span>
01375     <span class="comment">// A valid security descriptor must have an owner and a group</span>
01376     <span class="comment">//</span>
01377 
01378     <span class="keywordflow">if</span> ( RtlpOwnerAddrSecurityDescriptor(
01379                 (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor
01380                 ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01381          RtlpGroupAddrSecurityDescriptor(
01382                 (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor
01383                 ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01384 
01385         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
01386         <span class="keywordflow">goto</span> Cleanup;
01387     }
01388 
01389     <span class="comment">//</span>
01390     <span class="comment">//  Probe and capture the STRING arguments</span>
01391     <span class="comment">//</span>
01392 
01393     <span class="keywordflow">try</span> {
01394 
01395         <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>(GenerateOnClose);
01396 
01397         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName, &amp;CapturedSubsystemName );
01398 
01399         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ObjectTypeName, &amp;CapturedObjectTypeName );
01400 
01401         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ObjectName, &amp;CapturedObjectName );
01402 
01403     } except (EXCEPTION_EXECUTE_HANDLER) {
01404 
01405         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01406         <span class="keywordflow">goto</span> Cleanup;
01407 
01408     }
01409 
01410     <span class="comment">//</span>
01411     <span class="comment">// Capture the PrincipalSelfSid.</span>
01412     <span class="comment">//</span>
01413 
01414     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01415         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
01416                      PrincipalSelfSid,
01417                      PreviousMode,
01418                      NULL, 0,
01419                      PagedPool,
01420                      TRUE,
01421                      &amp;CapturedPrincipalSelfSid );
01422 
01423         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01424             CapturedPrincipalSelfSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01425             <span class="keywordflow">goto</span> Cleanup;
01426         }
01427     }
01428 
01429     <span class="comment">//</span>
01430     <span class="comment">// Capture any Object type list</span>
01431     <span class="comment">//</span>
01432 
01433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a21">SeCaptureObjectTypeList</a>( ObjectTypeList,
01434                                       ObjectTypeListLength,
01435                                       PreviousMode,
01436                                       &amp;LocalObjectTypeList );
01437 
01438     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01439         <span class="keywordflow">goto</span> Cleanup;
01440     }
01441 
01442     <span class="comment">//</span>
01443     <span class="comment">// See if anything (or everything) in the desired access can be</span>
01444     <span class="comment">// satisfied by privileges.</span>
01445     <span class="comment">//</span>
01446 
01447     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a20">SePrivilegePolicyCheck</a>(
01448                  &amp;DesiredAccess,
01449                  &amp;PreviouslyGrantedAccess,
01450                  &amp;SubjectSecurityContext,
01451                  NULL,
01452                  &amp;PrivilegeSet,
01453                  PreviousMode
01454                  );
01455 
01456     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;SubjectSecurityContext );
01457 
01458     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01459         AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01460         AccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01461         LocalAccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01462 
01463         <span class="keywordflow">if</span> ( ReturnResultList ) {
01464             ULONG ResultListIndex;
01465             LocalGrantedAccessPointer =
01466                 <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, (<span class="keyword">sizeof</span>(ACCESS_MASK)+<span class="keyword">sizeof</span>(NTSTATUS)) * ObjectTypeListLength, 'aGeS' );
01467 
01468             <span class="keywordflow">if</span> (LocalGrantedAccessPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01469                 <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;SubjectSecurityContext );
01470                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01471                 <span class="keywordflow">goto</span> Cleanup;
01472             }
01473             LocalGrantedAccessAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01474             LocalAccessStatusPointer = (PNTSTATUS)(LocalGrantedAccessPointer + ObjectTypeListLength);
01475 
01476             <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
01477                 LocalGrantedAccessPointer[ResultListIndex] = LocalGrantedAccess;
01478                 LocalAccessStatusPointer[ResultListIndex] = LocalAccessStatus;
01479             }
01480 
01481         } <span class="keywordflow">else</span> {
01482         LocalGrantedAccessPointer = &amp;LocalGrantedAccess;
01483         LocalAccessStatusPointer =  &amp;LocalAccessStatus;
01484         }
01485 
01486     } <span class="keywordflow">else</span> {
01487 
01488         <span class="comment">//</span>
01489         <span class="comment">// If the user in the token is the owner of the object, we</span>
01490         <span class="comment">// must automatically grant ReadControl and WriteDac access</span>
01491         <span class="comment">// if desired.  If the DesiredAccess mask is empty after</span>
01492         <span class="comment">// these bits are turned off, we don't have to do any more</span>
01493         <span class="comment">// access checking (ref section 4, DSA ACL Arch)</span>
01494         <span class="comment">//</span>
01495 
01496         <span class="keywordflow">if</span> ( DesiredAccess &amp; (WRITE_DAC | READ_CONTROL | MAXIMUM_ALLOWED) ) {
01497 
01498             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a54">SepTokenIsOwner</a>( SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>, CapturedSecurityDescriptor, TRUE )) {
01499 
01500                 <span class="keywordflow">if</span> ( DesiredAccess &amp; MAXIMUM_ALLOWED ) {
01501 
01502                     PreviouslyGrantedAccess |= ( WRITE_DAC | READ_CONTROL );
01503 
01504                 } <span class="keywordflow">else</span> {
01505 
01506                     PreviouslyGrantedAccess |= (DesiredAccess &amp; (WRITE_DAC | READ_CONTROL));
01507                 }
01508 
01509                 DesiredAccess &amp;= ~(WRITE_DAC | READ_CONTROL);
01510             }
01511 
01512         }
01513 
01514         <span class="keywordflow">if</span> (DesiredAccess == 0) {
01515 
01516             LocalGrantedAccess = PreviouslyGrantedAccess;
01517             AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01518             AccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01519             LocalAccessStatus = STATUS_SUCCESS;
01520 
01521             <span class="keywordflow">if</span> ( ReturnResultList ) {
01522                 ULONG ResultListIndex;
01523                 LocalGrantedAccessPointer =
01524                     <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, (<span class="keyword">sizeof</span>(ACCESS_MASK)+<span class="keyword">sizeof</span>(NTSTATUS)) * ObjectTypeListLength, 'aGeS' );
01525 
01526                 <span class="keywordflow">if</span> (LocalGrantedAccessPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01527                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01528                     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;SubjectSecurityContext );
01529                     <span class="keywordflow">goto</span> Cleanup;
01530                 }
01531                 LocalGrantedAccessAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01532                 LocalAccessStatusPointer = (PNTSTATUS)(LocalGrantedAccessPointer + ObjectTypeListLength);
01533 
01534                 <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
01535                     LocalGrantedAccessPointer[ResultListIndex] = LocalGrantedAccess;
01536                     LocalAccessStatusPointer[ResultListIndex] = LocalAccessStatus;
01537                 }
01538 
01539             } <span class="keywordflow">else</span> {
01540             LocalGrantedAccessPointer = &amp;LocalGrantedAccess;
01541             LocalAccessStatusPointer =  &amp;LocalAccessStatus;
01542             }
01543 
01544         } <span class="keywordflow">else</span> {
01545 
01546             <span class="comment">//</span>
01547             <span class="comment">// Finally, do the access check</span>
01548             <span class="comment">//</span>
01549 
01550             <span class="keywordflow">if</span> ( ReturnResultList ) {
01551                 LocalGrantedAccessPointer =
01552                     <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, (<span class="keyword">sizeof</span>(ACCESS_MASK)+<span class="keyword">sizeof</span>(NTSTATUS)) * ObjectTypeListLength, 'aGeS' );
01553 
01554                 <span class="keywordflow">if</span> (LocalGrantedAccessPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01555                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01556                     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;SubjectSecurityContext );
01557                     <span class="keywordflow">goto</span> Cleanup;
01558                 }
01559                 LocalGrantedAccessAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01560                 LocalAccessStatusPointer = (PNTSTATUS)(LocalGrantedAccessPointer + ObjectTypeListLength);
01561 
01562             } <span class="keywordflow">else</span> {
01563                 LocalGrantedAccessPointer = &amp;LocalGrantedAccess;
01564                 LocalAccessStatusPointer =  &amp;LocalAccessStatus;
01565             }
01566 
01567             <a class="code" href="../../d8/d3/tokenp_8h.html#a38">SepAccessCheck</a> (
01568                         CapturedSecurityDescriptor,
01569                         CapturedPrincipalSelfSid,
01570                         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
01571                         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>,
01572                         DesiredAccess,
01573                         LocalObjectTypeList,
01574                         ObjectTypeListLength,
01575                         &amp;LocalGenericMapping,
01576                         PreviouslyGrantedAccess,
01577                         PreviousMode,
01578                         LocalGrantedAccessPointer,
01579                         NULL,       <span class="comment">// Privileges already checked</span>
01580                         LocalAccessStatusPointer,
01581                         ReturnResultList,
01582                         &amp;AccessGranted,
01583                         &amp;AccessDenied
01584                         );
01585 
01586         }
01587     }
01588 
01589     <span class="comment">//</span>
01590     <span class="comment">// sound the alarms...</span>
01591     <span class="comment">//</span>
01592 
01593     <span class="keywordflow">if</span> ( !AvoidAudit ) {
01594         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a2">SepAdtAuditThisEventEx</a>( NtAuditType, AccessGranted, AccessDenied )) {
01595 
01596             <a class="code" href="../../d3/d5/seaudit_8c.html#a8">SepExamineSaclEx</a>(
01597                 RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor ),
01598                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;SubjectSecurityContext ),
01599                 DesiredAccess | PreviouslyGrantedAccess,
01600                 LocalObjectTypeList,
01601                 ObjectTypeListLength,
01602                 ReturnResultList,
01603                 LocalAccessStatusPointer,
01604                 LocalGrantedAccessPointer,
01605                 &amp;GenerateSuccessAudit,
01606                 &amp;GenerateFailureAudit
01607                 );
01608 
01609         }
01610 
01611         <span class="keywordflow">if</span> ( GenerateSuccessAudit ||
01612              GenerateFailureAudit ) {
01613 
01614             <span class="comment">//</span>
01615             <span class="comment">// Save this to a local here, so we don't</span>
01616             <span class="comment">// have to risk accessing user memory and</span>
01617             <span class="comment">// potentially having to exit before the audit</span>
01618             <span class="comment">//</span>
01619 
01620             <span class="keywordflow">if</span> ( AccessGranted ) {
01621 
01622                 <span class="comment">//</span>
01623                 <span class="comment">// SAM calls NtCloseObjectAuditAlarm despite the fact that it may not</span>
01624                 <span class="comment">// have successfully opened the object, causing a spurious close audit.</span>
01625                 <span class="comment">// Since no one should rely on this anyway if their access attempt</span>
01626                 <span class="comment">// failed, make sure it's false and SAM will work properly.</span>
01627                 <span class="comment">//</span>
01628 
01629                 LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01630             }
01631 
01632             <span class="comment">//</span>
01633             <span class="comment">// Generate the success audit if needed.</span>
01634             <span class="comment">//</span>
01635             <span class="keywordflow">if</span> ( GenerateSuccessAudit ) {
01636                 <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;OperationId );
01637 
01638                 <span class="comment">// ??</span>
01639                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AccessGranted );
01640                 AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> (
01641                                      CapturedSubsystemName,
01642                                      AccessGranted ? &amp;HandleId : NULL, <span class="comment">// Don't audit handle if failure</span>
01643                                      CapturedObjectTypeName,
01644                                      0,                            <span class="comment">// IN PVOID Object OPTIONAL,</span>
01645                                      CapturedObjectName,
01646                                      SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>,
01647                                      SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
01648                                      *LocalGrantedAccessPointer,
01649                                      *LocalGrantedAccessPointer,
01650                                      &amp;OperationId,
01651                                      PrivilegeSet,
01652                                      ObjectCreation,
01653                                      TRUE,  <span class="comment">// Generate success case</span>
01654                                      TRUE,  <span class="comment">// Generate audit</span>
01655                                      FALSE, <span class="comment">// Don't generate alarm</span>
01656                                      <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
01657                                      NtAuditType,
01658                                      LocalObjectTypeList,
01659                                      ObjectTypeListLength,
01660                                      ReturnResultList ? LocalGrantedAccessPointer : NULL
01661                                      );
01662             }
01663 
01664             <span class="comment">//</span>
01665             <span class="comment">// Generate failure audit if it is needed.</span>
01666             <span class="comment">//</span>
01667             <span class="keywordflow">if</span> ( GenerateFailureAudit ) {
01668                 <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;OperationId );
01669 
01670                 <span class="comment">// ??</span>
01671                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AccessDenied );
01672                 AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> (
01673                                      CapturedSubsystemName,
01674                                      AccessGranted ? &amp;HandleId : NULL, <span class="comment">// Don't audit handle if failure</span>
01675                                      CapturedObjectTypeName,
01676                                      0,                            <span class="comment">// IN PVOID Object OPTIONAL,</span>
01677                                      CapturedObjectName,
01678                                      SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>,
01679                                      SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
01680                                      DesiredAccess,
01681                                      DesiredAccess,
01682                                      &amp;OperationId,
01683                                      PrivilegeSet,
01684                                      ObjectCreation,
01685                                      FALSE, <span class="comment">// Generate failure case</span>
01686                                      TRUE,  <span class="comment">// Generate audit</span>
01687                                      FALSE, <span class="comment">// Don't generate alarm</span>
01688                                      <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
01689                                      NtAuditType,
01690                                      LocalObjectTypeList,
01691                                      ObjectTypeListLength,
01692                                      ReturnResultList ? LocalGrantedAccessPointer : NULL
01693                                      );
01694             }
01695         } <span class="keywordflow">else</span> {
01696 
01697             <span class="comment">//</span>
01698             <span class="comment">// We didn't generate an audit due to the SACL.  If privileges were used, we need</span>
01699             <span class="comment">// to audit that.</span>
01700             <span class="comment">//</span>
01701 
01702             <span class="keywordflow">if</span> ( PrivilegeSet != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01703 
01704                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted) ) {
01705 
01706                     AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> ( CapturedSubsystemName,
01707                                                                        &amp;HandleId,
01708                                                                        SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>,
01709                                                                        SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
01710                                                                        <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
01711                                                                        DesiredAccess,
01712                                                                        PrivilegeSet,
01713                                                                        AccessGranted
01714                                                                        );
01715 
01716                     <span class="comment">//</span>
01717                     <span class="comment">// We don't want close audits to be generated.  May need to revisit this.</span>
01718                     <span class="comment">//</span>
01719 
01720                     LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01721                 }
01722             }
01723         }
01724     }
01725 
01726     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;SubjectSecurityContext );
01727 
01728     <span class="keywordflow">try</span> {
01729             <span class="keywordflow">if</span> ( ReturnResultList ) {
01730                 ULONG ResultListIndex;
01731                 <span class="keywordflow">if</span> ( LocalAccessStatusPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01732                     <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
01733                         AccessStatus[ResultListIndex] = LocalAccessStatus;
01734                         GrantedAccess[ResultListIndex] = LocalGrantedAccess;
01735                     }
01736                 } <span class="keywordflow">else</span> {
01737                     <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
01738                         AccessStatus[ResultListIndex] = LocalAccessStatusPointer[ResultListIndex];
01739                         GrantedAccess[ResultListIndex] = LocalGrantedAccessPointer[ResultListIndex];
01740                     }
01741                 }
01742 
01743             } <span class="keywordflow">else</span> {
01744                 *AccessStatus = LocalAccessStatus;
01745                 *GrantedAccess = LocalGrantedAccess;
01746             }
01747             *GenerateOnClose    = LocalGenerateOnClose;
01748             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01749 
01750     } except (EXCEPTION_EXECUTE_HANDLER) {
01751 
01752         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01753     }
01754 
01755     <span class="comment">//</span>
01756     <span class="comment">// Free locally used resources.</span>
01757     <span class="comment">//</span>
01758 Cleanup:
01759 
01760     <span class="keywordflow">if</span> ( TokenSwapped ) {
01761 
01762         <span class="comment">//</span>
01763         <span class="comment">// Decrement the reference count for the ClientToken that was passed in.</span>
01764         <span class="comment">//</span>
01765 
01766         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)NewToken );
01767 
01768         <span class="comment">//</span>
01769         <span class="comment">// Reset the value of the token from saved value.</span>
01770         <span class="comment">//</span>
01771 
01772         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = OldToken;
01773     }
01774 
01775     <span class="comment">//</span>
01776     <span class="comment">// Free any privileges allocated as part of the access check</span>
01777     <span class="comment">//</span>
01778 
01779     <span class="keywordflow">if</span> (PrivilegeSet != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01780         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( PrivilegeSet );
01781     }
01782 
01783     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
01784 
01785     <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> ( CapturedSecurityDescriptor,
01786                                   PreviousMode,
01787                                   FALSE );
01788 
01789     <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01790       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
01791     }
01792 
01793     <span class="keywordflow">if</span> (CapturedObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01794       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectTypeName );
01795     }
01796 
01797     <span class="keywordflow">if</span> (CapturedObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01798       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectName );
01799     }
01800 
01801     <span class="keywordflow">if</span> (CapturedPrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01802         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrincipalSelfSid, PreviousMode, TRUE);
01803     }
01804 
01805     <span class="keywordflow">if</span> ( LocalObjectTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01806         <a class="code" href="../../d8/d3/tokenp_8h.html#a22">SeFreeCapturedObjectTypeList</a>( LocalObjectTypeList );
01807     }
01808 
01809     <span class="keywordflow">if</span> ( LocalGrantedAccessAllocated ) {
01810         <span class="keywordflow">if</span> ( LocalGrantedAccessPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01811             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalGrantedAccessPointer );
01812         }
01813     }
01814 
01815     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01816 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="seaudit.c::SepAuditTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAuditTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateSuccessAudit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateFailureAudit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04093">4093</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00377">OBJECT_FAILURE_AUDIT</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00376">OBJECT_SUCCESS_AUDIT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04179">SepSetAuditInfoForObjectType()</a>.
<p>
<pre class="fragment"><div>04103                    :
04104 
04105     This routine determines <span class="keywordflow">if</span> any children of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object represented by
04106     StartIndex have a different degree of success than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> StartIndex element.
04107 
04108 Arguments:
04109 
04110     ObjectTypeList - The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list to update.
04111 
04112     ObjectTypeListLength - Number of elements in ObjectTypeList
04113 
04114     AccessStatus - Specifies STATUS_SUCCESS or other error code to be
04115         propogated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
04116 
04117     StartIndex - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target element to update.
04118 
04119     GenerateSuccessAudit - Returns a <span class="keywordtype">boolean</span> indicating whether or not
04120         we should generate a success audit.
04121 
04122     GenerateFailureAudit - Returns a <span class="keywordtype">boolean</span> indicating whether or not
04123         we should generate a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> audit.
04124 
04125 Return Value:
04126 
04127     None.
04128 
04129 --*/
04130 
04131 {
04132     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
04133     BOOLEAN WasSuccess;
04134 
04135     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04136 
04137     <span class="comment">//</span>
04138     <span class="comment">// Determine if the target was successful.</span>
04139     <span class="comment">//</span>
04140 
04141     WasSuccess = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( AccessStatus[StartIndex] );
04142 
04143     <span class="comment">//</span>
04144     <span class="comment">// Loop handling all children of the target.</span>
04145     <span class="comment">//</span>
04146 
04147     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=StartIndex+1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
04148 
04149         <span class="comment">//</span>
04150         <span class="comment">// By definition, the children of an object are all those entries</span>
04151         <span class="comment">// immediately following the target.  The list of children (or</span>
04152         <span class="comment">// grandchildren) stops as soon as we reach an entry the has the</span>
04153         <span class="comment">// same level as the target (a sibling) or lower than the target</span>
04154         <span class="comment">// (an uncle).</span>
04155         <span class="comment">//</span>
04156 
04157         <span class="keywordflow">if</span> ( ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Level &lt;= ObjectTypeList[StartIndex].Level ) {
04158             <span class="keywordflow">break</span>;
04159         }
04160 
04161         <span class="comment">//</span>
04162         <span class="comment">// If the child has different access than the target,</span>
04163         <span class="comment">//  mark the child.</span>
04164         <span class="comment">//</span>
04165 
04166         <span class="keywordflow">if</span> ( WasSuccess &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( AccessStatus[Index]) ) {
04167             *GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04168             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>;
04169         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !WasSuccess &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( AccessStatus[Index]) ) {
04170             *GenerateSuccessAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04171             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a4">OBJECT_SUCCESS_AUDIT</a>;
04172         }
04173 
04174     }
04175 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="seaudit.c::SepExamineSacl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepExamineSacl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Sacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateAudit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateAlarm</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03952">3952</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00733">SepSidInToken()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">NtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03538">SeCreateObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03660">SeObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">SeOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03085">SeOpenObjectForDeleteAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03429">SeTraverseAuditAlarm()</a>.
<p>
<pre class="fragment"><div>03963                    :
03964 
03965     This routine will examine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed Sacl and determine what
03966     <span class="keywordflow">if</span> any action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required based its contents.
03967 
03968     Note that <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not aware of any system state, ie,
03969     whether or not auditing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently enabled <span class="keywordflow">for</span> either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03970     system or <span class="keyword">this</span> particular object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
03971 
03972 Arguments:
03973 
03974     Sacl - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Sacl to be examined.
03975 
03976     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
03977 
03978     AccessGranted - Supplies whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt
03979         was successful.
03980 
03981     GenerateAudit - Returns a <span class="keywordtype">boolean</span> indicating whether or not
03982         we should generate an audit.
03983 
03984     GenerateAlarm - Returns a <span class="keywordtype">boolean</span> indiciating whether or not
03985         we should generate an alarm.
03986 
03987 Return Value:
03988 
03989     STATUS_SUCCESS - The operation completed successfully.
03990 
03991 --*/
03992 
03993 {
03994 
03995     ULONG i;
03996     PVOID Ace;
03997     ULONG AceCount;
03998     ACCESS_MASK AccessMask;
03999     UCHAR AceFlags;
04000     BOOLEAN FailedMaximumAllowed;
04001 
04002     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04003 
04004     *GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04005     *GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04006 
04007     <span class="comment">//</span>
04008     <span class="comment">// If we failed an attempt to open an object for ONLY maximumum allowed,</span>
04009     <span class="comment">// then we generate an audit if ANY ACCESS_DENIED audit matching this</span>
04010     <span class="comment">// user's list of sids is found</span>
04011     <span class="comment">//</span>
04012 
04013     FailedMaximumAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04014     <span class="keywordflow">if</span> (!AccessGranted &amp;&amp; (DesiredAccess &amp; MAXIMUM_ALLOWED)) {
04015         FailedMaximumAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04016     }
04017 
04018     <span class="comment">//</span>
04019     <span class="comment">// If the Sacl is null, do nothing and return</span>
04020     <span class="comment">//</span>
04021 
04022     <span class="keywordflow">if</span> (Sacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04023 
04024         <span class="keywordflow">return</span>;
04025     }
04026 
04027     AceCount = Sacl-&gt;AceCount;
04028 
04029     <span class="keywordflow">if</span> (AceCount == 0) {
04030         <span class="keywordflow">return</span>;
04031     }
04032 
04033     <span class="comment">//</span>
04034     <span class="comment">// Iterate through the ACEs on the Sacl until either we reach</span>
04035     <span class="comment">// the end or discover that we have to take all possible actions,</span>
04036     <span class="comment">// in which case it doesn't pay to look any further</span>
04037     <span class="comment">//</span>
04038 
04039     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Sacl ) ;
04040           (i &lt; AceCount) &amp;&amp; !(*GenerateAudit &amp;&amp; *GenerateAlarm);
04041           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
04042 
04043         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
04044 
04045              <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == SYSTEM_AUDIT_ACE_TYPE) ) {
04046 
04047                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( (PACCESS_TOKEN)Token, NULL, &amp;((PSYSTEM_AUDIT_ACE)Ace)-&gt;SidStart, FALSE ) ) {
04048 
04049                     AccessMask = ((PSYSTEM_AUDIT_ACE)Ace)-&gt;Mask;
04050                     AceFlags   = ((PACE_HEADER)Ace)-&gt;AceFlags;
04051 
04052                     <span class="keywordflow">if</span> ( AccessMask &amp; DesiredAccess ) {
04053 
04054                         <span class="keywordflow">if</span> (((AceFlags &amp; SUCCESSFUL_ACCESS_ACE_FLAG) &amp;&amp; AccessGranted) ||
04055                               ((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) &amp;&amp; !AccessGranted)) {
04056 
04057                             *GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04058                         }
04059                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( FailedMaximumAllowed &amp;&amp; (AceFlags &amp; FAILED_ACCESS_ACE_FLAG) ) {
04060                             *GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04061                     }
04062                 }
04063 
04064                  <span class="keywordflow">continue</span>;
04065              }
04066 
04067              <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == SYSTEM_ALARM_ACE_TYPE) ) {
04068 
04069                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( (PACCESS_TOKEN)Token, NULL, &amp;((PSYSTEM_ALARM_ACE)Ace)-&gt;SidStart, FALSE ) ) {
04070 
04071                     AccessMask = ((PSYSTEM_ALARM_ACE)Ace)-&gt;Mask;
04072 
04073                     <span class="keywordflow">if</span> ( AccessMask &amp; DesiredAccess ) {
04074 
04075                         AceFlags   = ((PACE_HEADER)Ace)-&gt;AceFlags;
04076 
04077                         <span class="keywordflow">if</span> (((AceFlags &amp; SUCCESSFUL_ACCESS_ACE_FLAG) &amp;&amp; AccessGranted) ||
04078                               ((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) &amp;&amp; !AccessGranted)) {
04079 
04080                             *GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04081                         }
04082                     }
04083                 }
04084             }
04085         }
04086     }
04087 
04088     <span class="keywordflow">return</span>;
04089 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="seaudit.c::SepExamineSaclEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepExamineSaclEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Sacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnResultList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateSuccessAudit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateFailureAudit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04257">4257</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00388">SepObjectInTypeList()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04179">SepSetAuditInfoForObjectType()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00733">SepSidInToken()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>04272                    :
04273 
04274     This routine will examine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed Sacl and determine what
04275     <span class="keywordflow">if</span> any action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required based its contents.
04276 
04277     Note that <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not aware of any system state, ie,
04278     whether or not auditing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently enabled <span class="keywordflow">for</span> either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04279     system or <span class="keyword">this</span> particular object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
04280 
04281 Arguments:
04282 
04283     Sacl - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Sacl to be examined.
04284 
04285     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
04286 
04287     DesiredAccess - Access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller wanted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
04288 
04289     ObjectTypeList - Supplies a list of GUIDs representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (and
04290         sub-objects) being accessed.
04291 
04292     ObjectTypeListLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList.
04293 
04294     ReturnResultList - If <span class="keyword">true</span>, AccessStatus and GrantedAccess <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually
04295         an array of entries ObjectTypeListLength elements <span class="keywordtype">long</span>.
04296 
04297     AccessStatus - Specifies STATUS_SUCCESS or other error code to be
04298         propogated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
04299 
04300     GrantedAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
04301 
04302     GenerateSuccessAudit - Returns a <span class="keywordtype">boolean</span> indicating whether or not
04303         we should generate a success audit.
04304 
04305     GenerateFailureAudit - Returns a <span class="keywordtype">boolean</span> indicating whether or not
04306         we should generate a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> audit.
04307 
04308 Return Value:
04309 
04310     STATUS_SUCCESS - The operation completed successfully.
04311 
04312 --*/
04313 
04314 {
04315 
04316     ULONG i, j;
04317     PVOID Ace;
04318     ULONG AceCount;
04319     ACCESS_MASK AccessMask;
04320     UCHAR AceFlags;
04321     BOOLEAN FailedMaximumAllowed;
04322     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
04323     ULONG SuccessIndex;
04324 <span class="preprocessor">#define INVALID_OBJECT_TYPE_LIST_INDEX 0xFFFFFFFF</span>
04325 <span class="preprocessor"></span>
04326     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04327 
04328     *GenerateSuccessAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04329     *GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04330 
04331     <span class="comment">//</span>
04332     <span class="comment">// If we failed an attempt to open an object for maximumum allowed,</span>
04333     <span class="comment">// then we generate an audit if ANY ACCESS_DENIED audit matching this</span>
04334     <span class="comment">// user's list of sids is found</span>
04335     <span class="comment">//</span>
04336 
04337     FailedMaximumAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04338     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*AccessStatus) &amp;&amp; (DesiredAccess &amp; MAXIMUM_ALLOWED)) {
04339         FailedMaximumAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04340     }
04341 
04342     <span class="comment">//</span>
04343     <span class="comment">// If the Sacl is null, do nothing and return</span>
04344     <span class="comment">//</span>
04345 
04346     <span class="keywordflow">if</span> (Sacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04347         <span class="keywordflow">return</span>;
04348     }
04349 
04350     AceCount = Sacl-&gt;AceCount;
04351 
04352     <span class="keywordflow">if</span> (AceCount == 0) {
04353         <span class="keywordflow">return</span>;
04354     }
04355 
04356 
04357     <span class="comment">//</span>
04358     <span class="comment">// Iterate through the ACEs on the Sacl until either we reach</span>
04359     <span class="comment">// the end or discover that we have to take all possible actions,</span>
04360     <span class="comment">// in which case it doesn't pay to look any further</span>
04361     <span class="comment">//</span>
04362 
04363     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Sacl ) ;
04364           (i &lt; AceCount) &amp;&amp; !((*GenerateSuccessAudit || *GenerateFailureAudit) &amp;&amp; ObjectTypeListLength &lt;= 1 );
04365           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
04366 
04367         AceFlags = ((PACE_HEADER)Ace)-&gt;AceFlags;
04368 
04369         <span class="keywordflow">if</span> ( !(AceFlags &amp; INHERIT_ONLY_ACE)) {
04370 
04371             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>;
04372 
04373              <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == SYSTEM_AUDIT_ACE_TYPE) ) {
04374 
04375                  <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( Token, NULL, &amp;((PSYSTEM_AUDIT_ACE)Ace)-&gt;SidStart, (BOOLEAN) ((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) != 0) ) ) {
04376 
04377                     AccessMask = ((PSYSTEM_AUDIT_ACE)Ace)-&gt;Mask;
04378 
04379                     <span class="keywordflow">for</span> (j=0; j &lt; ObjectTypeListLength; j++)
04380                     {
04381                         <a class="code" href="../../d3/d5/seaudit_8c.html#a32">SepSetAuditInfoForObjectType</a>(AceFlags,
04382                                                      AccessMask,
04383                                                      DesiredAccess,
04384                                                      ObjectTypeList,
04385                                                      ObjectTypeListLength,
04386                                                      ReturnResultList,
04387                                                      j,
04388                                                      AccessStatus,
04389                                                      GrantedAccess,
04390                                                      FailedMaximumAllowed,
04391                                                      GenerateSuccessAudit,
04392                                                      GenerateFailureAudit
04393                                                      );
04394                     }
04395                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>;
04396                 }
04397 
04398             <span class="comment">//</span>
04399             <span class="comment">// Handle an object specific audit ACE</span>
04400             <span class="comment">//</span>
04401             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == SYSTEM_AUDIT_OBJECT_ACE_TYPE) ) {
04402                 GUID *ObjectTypeInAce;
04403 
04404                 <span class="comment">//</span>
04405                 <span class="comment">// If no object type is in the ACE,</span>
04406                 <span class="comment">//  treat this as a normal audit ACE.</span>
04407                 <span class="comment">//</span>
04408 
04409                 AccessMask = ((PSYSTEM_AUDIT_OBJECT_ACE)Ace)-&gt;Mask;
04410                 ObjectTypeInAce = RtlObjectAceObjectType(Ace);
04411 
04412                 <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04413 
04414                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( Token, NULL, RtlObjectAceSid(Ace), (BOOLEAN)((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) != 0) ) ) {
04415 
04416                         <span class="keywordflow">for</span> (j=0; j &lt; ObjectTypeListLength; j++)
04417                         {
04418                             <a class="code" href="../../d3/d5/seaudit_8c.html#a32">SepSetAuditInfoForObjectType</a>(AceFlags,
04419                                                          AccessMask,
04420                                                          DesiredAccess,
04421                                                          ObjectTypeList,
04422                                                          ObjectTypeListLength,
04423                                                          ReturnResultList,
04424                                                          j,
04425                                                          AccessStatus,
04426                                                          GrantedAccess,
04427                                                          FailedMaximumAllowed,
04428                                                          GenerateSuccessAudit,
04429                                                          GenerateFailureAudit
04430                                                          );
04431                         }
04432                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>;
04433                     }
04434 
04435                 <span class="comment">//</span>
04436                 <span class="comment">// If no object type list was passed,</span>
04437                 <span class="comment">//  don't generate an audit.</span>
04438                 <span class="comment">//</span>
04439 
04440                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
04441 
04442                     <span class="comment">// Drop through</span>
04443 
04444                 <span class="comment">//</span>
04445                 <span class="comment">// If an object type is in the ACE,</span>
04446                 <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
04447                 <span class="comment">//</span>
04448                 } <span class="keywordflow">else</span> {
04449 
04450                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( Token, NULL, RtlObjectAceSid(Ace), (BOOLEAN)((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) != 0) ) ) {
04451 
04452                         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
04453                                                    ObjectTypeList,
04454                                                    ObjectTypeListLength,
04455                                                    &amp;Index ) ) {
04456 
04457                             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>;
04458                         }
04459                     }
04460                 }
04461 
04462             }
04463 
04464             <span class="comment">//</span>
04465             <span class="comment">// If the ACE has a matched SID and a matched GUID,</span>
04466             <span class="comment">//  handle it.</span>
04467             <span class="comment">//</span>
04468 
04469             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a> ) {
04470 
04471                 <span class="comment">//</span>
04472                 <span class="comment">// ASSERT: we have an ACE to be audited.</span>
04473                 <span class="comment">//</span>
04474                 <span class="comment">// Index is an index into ObjectTypeList of the entry to mark</span>
04475                 <span class="comment">//  as the GUID needs auditing.</span>
04476                 <span class="comment">//</span>
04477                 <span class="comment">// SuccessIndex is an index into AccessStatus to determine if</span>
04478                 <span class="comment">//  a success or failure audit is to be generated</span>
04479                 <span class="comment">//</span>
04480 
04481                 <a class="code" href="../../d3/d5/seaudit_8c.html#a32">SepSetAuditInfoForObjectType</a>(AceFlags,
04482                                              AccessMask,
04483                                              DesiredAccess,
04484                                              ObjectTypeList,
04485                                              ObjectTypeListLength,
04486                                              ReturnResultList,
04487                                              Index,
04488                                              AccessStatus,
04489                                              GrantedAccess,
04490                                              FailedMaximumAllowed,
04491                                              GenerateSuccessAudit,
04492                                              GenerateFailureAudit
04493                                              );
04494             }
04495 
04496         }
04497     }
04498 
04499     <span class="keywordflow">return</span>;
04500 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="seaudit.c::SepFilterPrivilegeAudits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepFilterPrivilegeAudits           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PrivilegeSet</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04587">4587</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04520">SepFilterPrivileges</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">SeOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03085">SeOpenObjectForDeleteAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00989">SePrivilegedServiceAuditAlarm()</a>.
<p>
<pre class="fragment"><div>04593                    :
04594 
04595     This routine will filter <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> a list of privileges as listed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04596     <a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> array.
04597 
04598 Arguments:
04599 
04600     Privileges - The privilege set to be audited
04601 
04602 Return Value:
04603 
04604     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> means that <span class="keyword">this</span> use of privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not to be audited.
04605     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> means that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit should <span class="keywordflow">continue</span> normally.
04606 
04607 --*/
04608 
04609 {
04610     PLUID *Privilege;
04611     ULONG Match = 0;
04612     ULONG i;
04613 
04614     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04615 
04616     <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT(PrivilegeSet) ||
04617         (PrivilegeSet-&gt;PrivilegeCount == 0) ) {
04618         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
04619     }
04620 
04621     <span class="keywordflow">for</span> (i=0; i&lt;PrivilegeSet-&gt;PrivilegeCount; i++) {
04622 
04623         Privilege = <a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a>;
04624 
04625         <span class="keywordflow">do</span> {
04626 
04627             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( &amp;PrivilegeSet-&gt;Privilege[i].Luid, *Privilege )) {
04628 
04629                 Match++;
04630                 <span class="keywordflow">break</span>;
04631             }
04632 
04633         } <span class="keywordflow">while</span> ( *++Privilege != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  );
04634     }
04635 
04636     <span class="keywordflow">if</span> ( Match == PrivilegeSet-&gt;PrivilegeCount ) {
04637 
04638         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
04639 
04640     } <span class="keywordflow">else</span> {
04641 
04642         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
04643     }
04644 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="seaudit.c::SepFreeCapturedString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepFreeCapturedString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CapturedString</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00370">370</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02492">NtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02627">NtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">NtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00731">NtPrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00406">NtPrivilegeObjectAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     Frees a string captured by SepProbeAndCaptureString.
00379 
00380 Arguments:
00381 
00382     CapturedString - Supplies a pointer to a string previously captured
00383         by SepProbeAndCaptureString.
00384 
00385 Return Value:
00386 
00387     None.
00388 
00389 --*/
00390 
00391 {
00392     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00393 
00394     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedString );
00395     <span class="keywordflow">return</span>;
00396 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="seaudit.c::SepInitializePrivilegeFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepInitializePrivilegeFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Verbose</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04556">4556</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04520">SepFilterPrivileges</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04522">SepFilterPrivilegesLong</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04545">SepFilterPrivilegesShort</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00329">SepAdtInitializePrivilegeAuditing()</a>.
<p>
<pre class="fragment"><div>04561                    :
04562 
04563     Initializes <a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> <span class="keywordflow">for</span> either normal or <a class="code" href="../../d2/d1/userexts_8c.html#a135">verbose</a> auditing.
04564 
04565 Arguments:
04566 
04567     Verbose - Whether we want to filter by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">short</span> or <span class="keywordtype">long</span> privileges
04568     list.  Verbose == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> means use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">short</span> list.
04569 
04570 Return Value:
04571 
04572     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">for</span> success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">for</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
04573 
04574 --*/
04575 {
04576     <span class="keywordflow">if</span> (Verbose) {
04577         <a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a4">SepFilterPrivilegesShort</a>;
04578     } <span class="keywordflow">else</span> {
04579         <a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a3">SepFilterPrivilegesLong</a>;
04580     }
04581 
04582     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
04583 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="seaudit.c::SepProbeAndCaptureString_U" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepProbeAndCaptureString_U           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>DestString</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00259">259</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d1/d1/usrbench_8h-source.html#l00232">DestString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d1/d1/usrbench_8h-source.html#l00230">SourceString</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02492">NtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02627">NtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">NtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00731">NtPrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00406">NtPrivilegeObjectAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00265                    :
00266 
00267     Helper routine to probe and capture a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string argument.
00268 
00269     This routine may fail due to lack of memory, in which <span class="keywordflow">case</span>,
00270     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will <span class="keywordflow">return</span> a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> pointer in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output parameter.
00271 
00272 Arguments:
00273 
00274     <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> - Pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string to be captured.
00275 
00276     <a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> - Returns a pointer to a captured <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string.  This
00277         will be one contiguous structure, and thus may be freed by
00278         a single call to <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>().
00279 
00280 Return Value:
00281 
00282     None.
00283 
00284 --*/
00285 {
00286 
00287     UNICODE_STRING InputString;
00288     ULONG Length;
00289     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00290 
00291     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">// Initialize the object name descriptor and capture the specified name</span>
00295     <span class="comment">// string.</span>
00296     <span class="comment">//</span>
00297 
00298     *<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00299 
00300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00301     <span class="keywordflow">try</span> {
00302 
00303         <span class="comment">//</span>
00304         <span class="comment">// Probe and capture the name string descriptor and probe the</span>
00305         <span class="comment">// name string, if necessary.</span>
00306         <span class="comment">//</span>
00307 
00308         InputString = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(SourceString);
00309         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(InputString.Buffer,
00310                      InputString.Length,
00311                      <span class="keyword">sizeof</span>(WCHAR));
00312 
00313 
00314 
00315         <span class="comment">//</span>
00316         <span class="comment">// If the length of the string is not an even multiple of the</span>
00317         <span class="comment">// size of a UNICODE character or cannot be zero terminated,</span>
00318         <span class="comment">// then return an error.</span>
00319         <span class="comment">//</span>
00320 
00321         Length = InputString.Length;
00322         <span class="keywordflow">if</span> (((Length &amp; (<span class="keyword">sizeof</span>(WCHAR) - 1)) != 0) ||
00323             (Length == (MAXUSHORT - <span class="keyword">sizeof</span>(WCHAR) + 1))) {
00324             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00325 
00326         } <span class="keywordflow">else</span> {
00327 
00328             <span class="comment">//</span>
00329             <span class="comment">// Allocate a buffer for the specified name string.</span>
00330             <span class="comment">//</span>
00331 
00332             *<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00333                             PagedPool,
00334                             InputString.Length + <span class="keyword">sizeof</span>(UNICODE_STRING),
00335                             'sUeS');
00336 
00337             <span class="keywordflow">if</span> (*<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00338                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00339 
00340             } <span class="keywordflow">else</span> {
00341                 (*DestString)-&gt;Length = InputString.Length;
00342                 (*DestString)-&gt;MaximumLength = InputString.Length;
00343                 (*DestString)-&gt;Buffer = (PWSTR) ((*DestString) + 1);
00344 
00345                 <span class="keywordflow">if</span> (InputString.Length != 0) {
00346 
00347                     RtlCopyMemory(
00348                         (*DestString)-&gt;Buffer,
00349                         InputString.Buffer,
00350                         InputString.Length);
00351                 }
00352 
00353             }
00354         }
00355 
00356     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00357         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00358         <span class="keywordflow">if</span> (*<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00359             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*DestString);
00360             *<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361         }
00362     }
00363 
00364     <span class="keywordflow">return</span>;
00365 
00366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="seaudit.c::SePrivilegedServiceAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SePrivilegedServiceAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>Privileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00989">989</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01628">SeLocalSystemSid</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">SepAdtPrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04587">SepFilterPrivilegeAudits()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">SeCheckAuditPrivilege()</a>, and <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>.
<p>
<pre class="fragment"><div>00997                    :
00998 
00999     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be called whenever a privileged system service
01000     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attempted.  It should be called immediately after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege
01001     check regardless of whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> test succeeds.
01002 
01003 Arguments:
01004 
01005     ServiceName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileged system service.
01006 
01007     SubjectSecurityContext - The subject security context representing
01008         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service.
01009 
01010     Privileges - Supplies a privilge set containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege(s)
01011         required for the access.
01012 
01013     AccessGranted - Supplies the results of the privilege test.
01014 
01015 Return Value:
01016 
01017     None.
01018 
01019 --*/
01020 
01021 {
01022     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01023 
01024     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01025 
01026     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted ) &amp;&amp;
01027          <a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>( Privileges )) {
01028 
01029         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext );
01030 
01031         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SeLocalSystemSid, <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( Token ))) {
01032             <span class="keywordflow">return</span>;
01033         }
01034 
01035         <a class="code" href="../../d7/d6/sepaudit_8c.html#a10">SepAdtPrivilegedServiceAuditAlarm</a> (
01036             &amp;SeSubsystemName,
01037             ServiceName,
01038             SubjectSecurityContext-&gt;ClientToken,
01039             SubjectSecurityContext-&gt;PrimaryToken,
01040             Privileges,
01041             AccessGranted
01042             );
01043     }
01044 
01045     <span class="keywordflow">return</span>;
01046 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="seaudit.c::SePrivilegeObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SePrivilegeObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>Privileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00650">650</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00593">IsPrivileged()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, and <a class="el" href="../../d9/d3/privileg_8c-source.html#l00504">SeCheckPrivilegedObject()</a>.
<p>
<pre class="fragment"><div>00661                    :
00662 
00663     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by object methods that perform privileged
00664     operations to generate audit and alarm messages related to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> use
00665     of privileges, or attempts to use privileges.
00666 
00667 Arguments:
00668 
00669     Object - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object accessed.  This value will not be
00670     used as a pointer (referenced).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to enter
00671     into log messages.
00672 
00673     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value assigned <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open.
00674 
00675     SecurityDescriptor - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00676     object being accessed.
00677 
00678     SubjectSecurityContext - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> captured security
00679     context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject attempting to open <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00680 
00681     DesiredAccess - The desired access mask.  This mask must have been
00682     previously mapped to contain no generic accesses.
00683 
00684     Privileges - Points to a set of privileges required <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access
00685     attempt.  Those privileges that were held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject are
00686     marked <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UsedForAccess flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PRIVILEGE_ATTRIBUTES
00687     associated with each privilege.
00688 
00689     AccessGranted - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted or
00690     denied.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was allowed.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>
00691     value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was denied.
00692 
00693     AccessMode - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
00694     Messages will not be generated by kernel mode accesses.
00695 
00696 Return Value:
00697 
00698     None.
00699 
00700 --*/
00701 
00702 {
00703     BOOLEAN AuditPerformed;
00704 
00705     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00706 
00707     <span class="keywordflow">if</span> (AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00708 
00709         AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> (
00710                              &amp;SeSubsystemName,
00711                              Handle,
00712                              SubjectSecurityContext-&gt;ClientToken,
00713                              SubjectSecurityContext-&gt;PrimaryToken,
00714                              SubjectSecurityContext-&gt;ProcessAuditId,
00715                              DesiredAccess,
00716                              Privileges,
00717                              AccessGranted
00718                              );
00719     }
00720 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="seaudit.c::SepSetAuditInfoForObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepSetAuditInfoForObjectType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnResultList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FailedMaximumAllowed</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateSuccessAudit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateFailureAudit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04179">4179</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00377">OBJECT_FAILURE_AUDIT</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00376">OBJECT_SUCCESS_AUDIT</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04093">SepAuditTypeList()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04257">SepExamineSaclEx()</a>.
<p>
<pre class="fragment"><div>04195                    :
04196 
04197     Determine <span class="keywordflow">if</span> success/<a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> audit needs to be generated <span class="keywordflow">for</span>
04198     object at ObjectTypeIndex in ObjectTypeList.
04199 
04200     This helper function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> by <a class="code" href="../../d3/d5/seaudit_8c.html#a8">SepExamineSaclEx</a>.
04201 
04202 Arguments:
04203 
04204     please refer to arg <a class="code" href="../../d7/d4/conexts_8c.html#a23">help</a> <span class="keywordflow">for</span> function <a class="code" href="../../d3/d5/seaudit_8c.html#a8">SepExamineSaclEx</a>
04205 
04206 Return Value:
04207 
04208     None.
04209 
04210 --*/
04211 {
04212     <span class="keywordflow">if</span> ( AccessMask &amp; (DesiredAccess|GrantedAccess[ObjectTypeIndex]) ) {
04213 
04214         <span class="keywordflow">if</span> ( (AceFlags &amp; SUCCESSFUL_ACCESS_ACE_FLAG) &amp;&amp;
04215              <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus[ObjectTypeIndex]) ) {
04216 
04217             *GenerateSuccessAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04218             <span class="keywordflow">if</span> ( ObjectTypeListLength != 0 ) {
04219 
04220                 ObjectTypeList[ObjectTypeIndex].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a4">OBJECT_SUCCESS_AUDIT</a>;
04221                 <span class="keywordflow">if</span> ( ReturnResultList ) {
04222                     <a class="code" href="../../d3/d5/seaudit_8c.html#a7">SepAuditTypeList</a>( ObjectTypeList,
04223                                       ObjectTypeListLength,
04224                                       AccessStatus,
04225                                       ObjectTypeIndex,
04226                                       GenerateSuccessAudit,
04227                                       GenerateFailureAudit );
04228                 }
04229             }
04230 
04231         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) &amp;&amp;
04232                    !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus[ObjectTypeIndex]) ) {
04233 
04234             *GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04235             <span class="keywordflow">if</span> ( ObjectTypeListLength != 0 ) {
04236                 ObjectTypeList[ObjectTypeIndex].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>;
04237                 <span class="keywordflow">if</span> ( ReturnResultList ) {
04238                     <a class="code" href="../../d3/d5/seaudit_8c.html#a7">SepAuditTypeList</a>( ObjectTypeList,
04239                                       ObjectTypeListLength,
04240                                       AccessStatus,
04241                                       ObjectTypeIndex,
04242                                       GenerateSuccessAudit,
04243                                       GenerateFailureAudit );
04244                 }
04245             }
04246         }
04247     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( FailedMaximumAllowed &amp;&amp; (AceFlags &amp; FAILED_ACCESS_ACE_FLAG) ) {
04248         *GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04249         <span class="keywordflow">if</span> ( ObjectTypeListLength != 0 ) {
04250             ObjectTypeList[ObjectTypeIndex].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>;
04251         }
04252     }
04253 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="seaudit.c::SepSinglePrivilegeCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepSinglePrivilegeCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LUID&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredPrivilege</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00143">143</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00038">SepPrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01675">SeTcbPrivilege</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l03652">SePrivilegePolicyCheck()</a>.
<p>
<pre class="fragment"><div>00151                    :
00152 
00153     Determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed token has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed privilege.
00154 
00155 Arguments:
00156 
00157     DesiredPrivilege - The privilege to be tested <span class="keywordflow">for</span>.
00158 
00159     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - The token being examined.
00160 
00161     PreviousMode - The previous processor mode.
00162 
00163 Return Value:
00164 
00165     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed privilege, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00166 
00167 --*/
00168 
00169 {
00170 
00171    LUID_AND_ATTRIBUTES Privilege;
00172    BOOLEAN Result;
00173 
00174    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00175 
00176    <span class="comment">//</span>
00177    <span class="comment">// Don't let anyone call this to test for SeTcbPrivilege</span>
00178    <span class="comment">//</span>
00179 
00180    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!((DesiredPrivilege.LowPart == <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>.LowPart) &amp;&amp;
00181             (DesiredPrivilege.HighPart == <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>.HighPart)));
00182 
00183    Privilege.Luid = DesiredPrivilege;
00184    Privilege.Attributes = 0;
00185 
00186    Result = <a class="code" href="../../d8/d3/tokenp_8h.html#a37">SepPrivilegeCheck</a>(
00187                Token,
00188                &amp;Privilege,
00189                1,
00190                PRIVILEGE_SET_ALL_NECESSARY,
00191                PreviousMode
00192                );
00193 
00194    <span class="keywordflow">return</span>(Result);
00195 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="seaudit.c::SeTraverseAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeTraverseAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectContextLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>TraverseAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03429">3429</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
References <a class="el" href="../../d1/d4/se_8h-source.html#l00297">_SE_AUDITING_STATE::AuditOnFailure</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00296">_SE_AUDITING_STATE::AuditOnSuccess</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01702">SeAuditingState</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d5/adtp_8h.html#a20">SepAdtTraverseAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03952">SepExamineSacl()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, and <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>.
<p>
<pre class="fragment"><div>03442                    :
03443 
03444     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to audit directory traverse operations
03445     specifically.  It should be called by parse procedures as they traverse
03446     directories as part of their operation.
03447 
03448 Arguments:
03449 
03450     OperationID - LUID identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation in progress
03451 
03452     DirectoryObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being traversed.
03453 
03454     SecurityDescriptor - The security descriptor (<span class="keywordflow">if</span> any) attached to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03455         directory being traversed.
03456 
03457     SubjectSecurityContext - Security context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client.
03458 
03459     SubjectContextLocked - Supplies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SubjectContext <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked
03460         <span class="keywordflow">for</span> shared access.
03461 
03462     TraverseAccess - Mask to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> traverse access <span class="keywordflow">for</span> <span class="keyword">this</span> object
03463         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
03464 
03465     Privileges - Optional parameter to indicate any privilges that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03466         subject may have used to gain access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
03467 
03468     AccessGranted - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted or denied based on
03469         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check or privilege check.
03470 
03471     AccessMode - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.  One
03472         of <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>.  Messages will not be generated by
03473         kernel mode accesses.
03474 
03475 Return value:
03476 
03477     None.
03478 
03479 --*/
03480 
03481 {
03482     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03483 
03484 <span class="preprocessor">#if 0</span>
03485 <span class="preprocessor"></span>    BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03486     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03487 
03488     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03489         <span class="keywordflow">return</span>;
03490     }
03491 
03492     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/se_8h.html#a105">SeAuditingState</a>[AuditEventTraverse].<a class="code" href="../../d1/d0/struct__SE__AUDITING__STATE.html#o0">AuditOnSuccess</a> &amp;&amp; AccessGranted) ||
03493          <a class="code" href="../../d0/d5/se_8h.html#a105">SeAuditingState</a>[AuditEventTraverse].<a class="code" href="../../d1/d0/struct__SE__AUDITING__STATE.html#o1">AuditOnFailure</a> &amp;&amp; !AccessGranted) {
03494 
03495         <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03496 
03497             <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03498                 <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( SubjectSecurityContext );
03499             }
03500 
03501             <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03502                 RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
03503                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ),
03504                 TraverseAccess,
03505                 AccessGranted,
03506                 &amp;GenerateAudit,
03507                 &amp;GenerateAlarm
03508                 );
03509 
03510             <span class="keywordflow">if</span> (GenerateAudit || GenerateAlarm) {
03511 
03512                 <a class="code" href="../../d1/d5/adtp_8h.html#a20">SepAdtTraverseAuditAlarm</a>(
03513                     OperationID,
03514                     DirectoryObject,
03515                     <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>(<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext )),
03516                     <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>(<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext )),
03517                     TraverseAccess,
03518                     Privileges,
03519                     AccessGranted,
03520                     GenerateAudit,
03521                     GenerateAlarm
03522                     );
03523             }
03524 
03525             <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03526                 <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectSecurityContext );
03527             }
03528         }
03529     }
03530 
03531 <span class="preprocessor">#endif</span>
03532 <span class="preprocessor"></span>
03533     <span class="keywordflow">return</span>;
03534 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="seaudit.c::SepAuditShutdownEvents" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d6/sep_8h.html#a20">SepAuditShutdownEvents</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00127">127</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="seaudit.c::SepFilterPrivileges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLUID* <a class="el" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> = NULL          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04520">4520</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04587">SepFilterPrivilegeAudits()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04556">SepInitializePrivilegeFilter()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="seaudit.c::SepFilterPrivilegesLong" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLUID <a class="el" href="../../d3/d5/seaudit_8c.html#a3">SepFilterPrivilegesLong</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div>
    {
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a100">SeChangeNotifyPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a79">SeCreateTokenPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a80">SeAssignPrimaryTokenPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a97">SeDebugPrivilege</a>,
        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04522">4522</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04556">SepInitializePrivilegeFilter()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="seaudit.c::SepFilterPrivilegesShort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLUID <a class="el" href="../../d3/d5/seaudit_8c.html#a4">SepFilterPrivilegesShort</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div>
    {
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a100">SeChangeNotifyPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a79">SeCreateTokenPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a80">SeAssignPrimaryTokenPrivilege</a>,
        &amp;<a class="code" href="../../d0/d5/se_8h.html#a97">SeDebugPrivilege</a>,
        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04545">4545</a> of file <a class="el" href="../../d4/d4/seaudit_8c-source.html">seaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04556">SepInitializePrivilegeFilter()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
