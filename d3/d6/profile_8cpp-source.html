<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: profile.cpp Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profile.cpp</h1><a href="../../d2/d7/profile_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/******************************************************************************</span>
00002 <span class="comment"></span>
00003 <span class="comment">  Source File:  ICC Profile.CPP</span>
00004 <span class="comment"></span>
00005 <span class="comment">  This implements the class we use to encapsulate everything we will ever care</span>
00006 <span class="comment">  to know about a profile, including the classes we need to support</span>
00007 <span class="comment">  associations and the like.</span>
00008 <span class="comment"></span>
00009 <span class="comment">  Copyright (c) 1996, 1997 by Microsoft Corporation.  All Rights Reserved.</span>
00010 <span class="comment"></span>
00011 <span class="comment">  A Pretty Penny Enterprises Production</span>
00012 <span class="comment"></span>
00013 <span class="comment">  Change History:</span>
00014 <span class="comment"></span>
00015 <span class="comment">  10-31-96  A-RobKj (Pretty Penny Enterprises) began encapsulating it</span>
00016 <span class="comment">  12-04-96  A-RobKj Added the CProfileArray and CAllDeviceList classes</span>
00017 <span class="comment">  12-13-96  A-RobKj Modified for faster operation (more lazy evaluation,</span>
00018 <span class="comment">                    and common DLL-wide database for installation checks)</span>
00019 <span class="comment">                    Also moved CDeviceList derived classes to the header, so</span>
00020 <span class="comment">                    I can use them other places, as well...</span>
00021 <span class="comment">  01-07-97  KjelgaardR@acm.org  Fixed CProfileArray::Empty- wasn't setting Next</span>
00022 <span class="comment">            object pointer to NULL after deleting said object (Fixed GP fault).</span>
00023 <span class="comment">  01-08-97  KjelgaardR@acm.org  Modified printer enumeration routine to only</span>
00024 <span class="comment">            enumerate color models (uses Global utility function).</span>
00025 <span class="comment"></span>
00026 <span class="comment">******************************************************************************/</span>
00027 
00028 <span class="preprocessor">#include    "ICMUI.H"</span>
00029 <span class="preprocessor">#include    &lt;shlobj.h&gt;</span>
00030 <span class="preprocessor">#include    "<a class="code" href="../../d9/d8/shellext_8h.html">shellext.h</a>"</span>
00031 <span class="preprocessor">#include    "..\mscms\sti.h"</span>
00032 
<a name="l00033"></a><a class="code" href="../../d2/d7/profile_8cpp.html#a0">00033</a> <span class="keyword">typedef</span> HRESULT (__stdcall *<a class="code" href="../../d2/d7/profile_8cpp.html#a0">PFNSTICREATEINSTANCE</a>)(HINSTANCE, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d4/d6/sti_8h.html#a123">PSTI</a>*, LPDWORD);
00034 
<a name="l00035"></a><a class="code" href="../../d2/d7/profile_8cpp.html#a1">00035</a> TCHAR  <a class="code" href="../../d2/d7/profile_8cpp.html#a1">gszStiDll</a>[]             = __TEXT(<span class="stringliteral">"sti.dll"</span>);
<a name="l00036"></a><a class="code" href="../../d2/d7/profile_8cpp.html#a2">00036</a> <span class="keywordtype">char</span>   <a class="code" href="../../d2/d7/profile_8cpp.html#a2">gszStiCreateInstance</a>[]  = <span class="stringliteral">"StiCreateInstance"</span>;
00037 
00038 <span class="comment">//  Printer DeviceEnumeration method</span>
00039 
<a name="l00040"></a><a class="code" href="../../d5/d5/classCPrinterList.html#a5">00040</a> <span class="keywordtype">void</span>    <a class="code" href="../../d5/d5/classCPrinterList.html#a5">CPrinterList::Enumerate</a>() {
00041 
00042 <span class="preprocessor">#if !defined(_WIN95_) // CPrinterList::Enumetate()</span>
00043 <span class="preprocessor"></span>
00044     <span class="comment">//  Enumerate all local printers</span>
00045 
00046     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwcNeeded, dwcReturned;
00047     EnumPrinters(PRINTER_ENUM_LOCAL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 4, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;dwcNeeded,
00048         &amp;dwcReturned);
00049 
00050     <span class="keyword">union </span>{
00051         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>   pBuff;
00052         PPRINTER_INFO_4 ppi4;
00053     };
00054 
00055     pBuff = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwcNeeded];
00056 
00057     <span class="keywordflow">while</span>   (pBuff &amp;&amp; !EnumPrinters(PRINTER_ENUM_LOCAL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 4, pBuff,
00058         dwcNeeded, &amp;dwcNeeded, &amp;dwcReturned) &amp;&amp;
00059         GetLastError() == ERROR_MORE_DATA) {
00060         <span class="keyword">delete</span> pBuff;
00061         pBuff = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwcNeeded];
00062     }
00063 
00064     <span class="keywordflow">if</span>  (pBuff) {
00065 
00066         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; dwcReturned; u++)
00067             <span class="keywordflow">if</span>  (CGlobals::ThisIsAColorPrinter(ppi4[u].pPrinterName)) {
00068                 <a class="code" href="../../d5/d5/classCPrinterList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(ppi4[u].pPrinterName);
00069                 <a class="code" href="../../d5/d5/classCPrinterList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(ppi4[u].pPrinterName);
00070             }
00071 
00072         <span class="keyword">delete</span>  pBuff;
00073     }
00074 
00075     <span class="comment">//  Now, enumerate all the connected printers</span>
00076 
00077     EnumPrinters(PRINTER_ENUM_CONNECTIONS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 4, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;dwcNeeded,
00078         &amp;dwcReturned);
00079 
00080     pBuff = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwcNeeded];
00081 
00082     <span class="keywordflow">while</span>   (pBuff &amp;&amp; !EnumPrinters(PRINTER_ENUM_CONNECTIONS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 4, pBuff,
00083         dwcNeeded, &amp;dwcNeeded, &amp;dwcReturned) &amp;&amp;
00084         GetLastError() == ERROR_MORE_DATA) {
00085         <span class="keyword">delete</span> pBuff;
00086         pBuff = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwcNeeded];
00087     }
00088 
00089     <span class="keywordflow">if</span>  (!pBuff)
00090         <span class="keywordflow">return</span>;
00091 
00092     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; dwcReturned; u++)
00093         <span class="keywordflow">if</span>  (CGlobals::ThisIsAColorPrinter(ppi4[u].pPrinterName)) {
00094             <a class="code" href="../../d5/d5/classCPrinterList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(ppi4[u].pPrinterName);
00095             <a class="code" href="../../d5/d5/classCPrinterList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(ppi4[u].pPrinterName);
00096         }
00097 
00098     <span class="keyword">delete</span>  pBuff;
00099 
00100 <span class="preprocessor">#else </span>
00101 <span class="preprocessor"></span>
00102     <span class="comment">//  Enumerate all local printers</span>
00103 
00104     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwcNeeded, dwcReturned;
00105     EnumPrinters(PRINTER_ENUM_LOCAL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 5, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;dwcNeeded,
00106         &amp;dwcReturned);
00107 
00108     <span class="keyword">union </span>{
00109         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>   pBuff;
00110         PPRINTER_INFO_5 ppi5;
00111     };
00112 
00113     pBuff = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwcNeeded];
00114 
00115     <span class="keywordflow">while</span>   (pBuff &amp;&amp; !EnumPrinters(PRINTER_ENUM_LOCAL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 5, pBuff,
00116         dwcNeeded, &amp;dwcNeeded, &amp;dwcReturned) &amp;&amp;
00117         GetLastError() == ERROR_MORE_DATA) {
00118         <span class="keyword">delete</span> pBuff;
00119         pBuff = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwcNeeded];
00120     }
00121 
00122     <span class="keywordflow">if</span>  (pBuff) {
00123 
00124         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; dwcReturned; u++) {
00125             <span class="keywordflow">if</span>  (CGlobals::ThisIsAColorPrinter(ppi5[u].pPrinterName)) {
00126                 <a class="code" href="../../d5/d5/classCPrinterList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(ppi5[u].pPrinterName);
00127                 <a class="code" href="../../d5/d5/classCPrinterList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(ppi5[u].pPrinterName);
00128             }
00129         }
00130 
00131         <span class="keyword">delete</span>  pBuff;
00132     }
00133 <span class="preprocessor">#endif</span>
00134 <span class="preprocessor"></span>}
00135 
00136 <span class="comment">//  Printer Name Validity Check</span>
00137 
<a name="l00138"></a><a class="code" href="../../d5/d5/classCPrinterList.html#a6">00138</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d5/d5/classCPrinterList.html#a6">CPrinterList::IsValidDeviceName</a>(LPCTSTR lpstrRef) {
00139 
00140     <span class="keywordflow">if</span>  (!lpstrRef) <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00141 
00142     <span class="keywordflow">if</span>  (!<a class="code" href="../../d5/d5/classCPrinterList.html#a2">Count</a>())
00143         <a class="code" href="../../d5/d5/classCPrinterList.html#a5">Enumerate</a>();
00144 
00145     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; <a class="code" href="../../d5/d5/classCPrinterList.html#a2">Count</a>(); u++)
00146         <span class="keywordflow">if</span>  (!lstrcmpi(<a class="code" href="../../d5/d5/classCPrinterList.html#r0">m_csaDeviceNames</a>[u], lpstrRef))
00147             <span class="keywordflow">break</span>;
00148 
00149     <span class="keywordflow">return</span>  u &lt; <a class="code" href="../../d5/d5/classCPrinterList.html#a2">Count</a>();
00150 }
00151 
00152 <span class="comment">//  Private monitor enumeration function- note this is ANSI only...</span>
00153 
00154 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI  <a class="code" href="../../d2/d7/profile_8cpp.html#a3">EnumerateMonitors</a>(LPBYTE pBuffer, PDWORD pdwcbNeeded,
00155                                           PDWORD pdwcReturned);
00156 
00157 <span class="comment">//  CMonitor class enumerator</span>
00158 
<a name="l00159"></a><a class="code" href="../../d2/d4/classCMonitorList.html#a6">00159</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d4/classCMonitorList.html#a6">CMonitorList::Enumerate</a>() {
00160 
00161     ULONG          ulSerialNumber = 1;
00162     ULONG          ulDeviceIndex  = 0;
00163     DISPLAY_DEVICE ddPriv;
00164 
00165     ddPriv.cb = <span class="keyword">sizeof</span>(ddPriv);
00166 
00167     <span class="comment">// Enumurate display adaptor on the system.</span>
00168 
00169     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d8/ntcftxt_8h.html#a33">EnumDisplayDevices</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ulDeviceIndex, &amp;ddPriv, 0))
00170     {
00171         ULONG          ulMonitorIndex = 0;
00172         DISPLAY_DEVICE ddPrivMonitor;
00173 
00174         ddPrivMonitor.cb = <span class="keyword">sizeof</span>(ddPrivMonitor);
00175 
00176         <span class="comment">// then, enumurate monitor device, attached the display adaptor.</span>
00177 
00178         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d8/ntcftxt_8h.html#a33">EnumDisplayDevices</a>(ddPriv.DeviceName, ulMonitorIndex, &amp;ddPrivMonitor, 0))
00179         {
00180             TCHAR DisplayNameBuf[256]; <span class="comment">// number: devicename - 256 is good enough.</span>
00181 
00182             <span class="comment">// Insert PnP id as device name.</span>
00183 
00184             <a class="code" href="../../d2/d4/classCMonitorList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(ddPrivMonitor.DeviceID);
00185 
00186             <span class="comment">// If this is primary display device, remember it.</span>
00187 
00188             <span class="keywordflow">if</span> (ddPriv.StateFlags &amp; DISPLAY_DEVICE_PRIMARY_DEVICE)
00189             {
00190                 <a class="code" href="../../d2/d4/classCMonitorList.html#r2">m_csPrimaryDeviceName</a> = ddPrivMonitor.DeviceID;
00191             }
00192 
00193             <span class="comment">// Build display name.</span>
00194 
00195             wsprintf(DisplayNameBuf,TEXT(<span class="stringliteral">"%d. %s"</span>),ulSerialNumber,ddPrivMonitor.DeviceString);
00196             <a class="code" href="../../d2/d4/classCMonitorList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(DisplayNameBuf);
00197 
00198             ulMonitorIndex++;
00199             ulSerialNumber++;
00200             ddPrivMonitor.cb = <span class="keyword">sizeof</span>(ddPrivMonitor);
00201         }
00202 
00203         ulDeviceIndex++;
00204         ddPriv.cb = <span class="keyword">sizeof</span>(ddPriv);
00205     }
00206 }
00207 
00208 <span class="comment">//  Monitor Name Validity Check</span>
00209 
<a name="l00210"></a><a class="code" href="../../d2/d4/classCMonitorList.html#a7">00210</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d2/d4/classCMonitorList.html#a7">CMonitorList::IsValidDeviceName</a>(LPCTSTR lpstrRef) {
00211 
00212     <span class="keywordflow">if</span>  (!lpstrRef) <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00213 
00214     <span class="keywordflow">if</span>  (!<a class="code" href="../../d2/d4/classCMonitorList.html#a2">Count</a>())
00215         <a class="code" href="../../d2/d4/classCMonitorList.html#a6">Enumerate</a>();
00216 
00217     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; <a class="code" href="../../d2/d4/classCMonitorList.html#a2">Count</a>(); u++)
00218         <span class="keywordflow">if</span>  (!lstrcmpi(<a class="code" href="../../d2/d4/classCMonitorList.html#r0">m_csaDeviceNames</a>[u], lpstrRef))
00219             <span class="keywordflow">break</span>;
00220 
00221     <span class="keywordflow">return</span>  u &lt; <a class="code" href="../../d2/d4/classCMonitorList.html#a2">Count</a>();
00222 }
00223 
<a name="l00224"></a><a class="code" href="../../d2/d4/classCMonitorList.html#a8">00224</a> LPCSTR  <a class="code" href="../../d2/d4/classCMonitorList.html#a8">CMonitorList::DeviceNameToDisplayName</a>(LPCTSTR lpstrRef) {
00225 
00226     <span class="keywordflow">if</span>  (!lpstrRef) <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00227 
00228     <span class="keywordflow">if</span>  (!<a class="code" href="../../d2/d4/classCMonitorList.html#a2">Count</a>())
00229         <a class="code" href="../../d2/d4/classCMonitorList.html#a6">Enumerate</a>();
00230 
00231     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; <a class="code" href="../../d2/d4/classCMonitorList.html#a2">Count</a>(); u++)
00232         <span class="keywordflow">if</span>  (!lstrcmpi(<a class="code" href="../../d2/d4/classCMonitorList.html#r0">m_csaDeviceNames</a>[u], lpstrRef))
00233             <span class="keywordflow">return</span> (LPCSTR)(<a class="code" href="../../d2/d4/classCMonitorList.html#r1">m_csaDisplayNames</a>[u]);
00234 
00235     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00236 }  
00237 
00238 <span class="comment">//  Scanner DeviceEnumeration method</span>
00239 
<a name="l00240"></a><a class="code" href="../../d7/d6/classCScannerList.html#a5">00240</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d6/classCScannerList.html#a5">CScannerList::Enumerate</a>() {
00241 
00242     <a class="code" href="../../d2/d7/profile_8cpp.html#a0">PFNSTICREATEINSTANCE</a>    pStiCreateInstance;
00243     <a class="code" href="../../d4/d6/sti_8h.html#a123">PSTI</a>                    pSti = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00244     <a class="code" href="../../d5/d6/struct__STI__DEVICE__INFORMATIONW.html">PSTI_DEVICE_INFORMATION</a> pDevInfo;
00245     PVOID                   pBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00246     HINSTANCE               hModule;
00247     HRESULT                 hres;
00248     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                   i, dwItemsReturned;
00249 <span class="preprocessor">    #ifndef UNICODE</span>
00250 <span class="preprocessor"></span>    <span class="keywordtype">char</span>                    <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>[256];
00251 <span class="preprocessor">    #endif</span>
00252 <span class="preprocessor"></span>
00253     <span class="keywordflow">if</span> (!(hModule = LoadLibrary(<a class="code" href="../../d2/d7/profile_8cpp.html#a1">gszStiDll</a>)))
00254     {
00255         _RPTF1(_CRT_WARN, <span class="stringliteral">"Error loading sti.dll: %d\n"</span>,
00256                GetLastError());
00257         <span class="keywordflow">return</span>;
00258     }
00259 
00260     <span class="keywordflow">if</span> (!(pStiCreateInstance = (<a class="code" href="../../d2/d7/profile_8cpp.html#a0">PFNSTICREATEINSTANCE</a>)GetProcAddress(hModule, <a class="code" href="../../d2/d7/profile_8cpp.html#a2">gszStiCreateInstance</a>)))
00261     {
00262         _RPTF0(_CRT_WARN, <span class="stringliteral">"Error getting proc StiCreateInstance\n"</span>);
00263         <span class="keywordflow">goto</span> EndEnumerate;
00264     }
00265 
00266     hres = (*pStiCreateInstance)(GetModuleHandle(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>), <a class="code" href="../../d4/d6/sti_8h.html#a2">STI_VERSION</a>, &amp;pSti, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00267 
00268     <span class="keywordflow">if</span> (FAILED(hres))
00269     {
00270         _RPTF1(_CRT_WARN, <span class="stringliteral">"Error creating sti instance: %d\n"</span>, hres);
00271         <span class="keywordflow">goto</span> EndEnumerate;
00272     }
00273 
00274     hres = pSti-&gt;GetDeviceList(0, 0, &amp;dwItemsReturned, &amp;pBuffer);
00275 
00276     <span class="keywordflow">if</span> (FAILED(hres) || !pBuffer)
00277     {
00278         _RPTF0(_CRT_WARN, <span class="stringliteral">"Error getting scanner devices\n"</span>);
00279         <span class="keywordflow">goto</span> EndEnumerate;
00280     }
00281 
00282     pDevInfo = (<a class="code" href="../../d5/d6/struct__STI__DEVICE__INFORMATIONW.html">PSTI_DEVICE_INFORMATION</a>) pBuffer;
00283 
00284     <span class="keywordflow">for</span> (i=0; i&lt;dwItemsReturned; i++, pDevInfo++)
00285     {
00286 <span class="preprocessor">        #ifndef UNICODE</span>
00287 <span class="preprocessor"></span>        <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen;                    <span class="comment">// length of Ansi string</span>
00288         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bUsedDefaultChar;
00289 
00290         dwLen = (lstrlenW(pDevInfo-&gt;<a class="code" href="../../d5/d6/struct__STI__DEVICE__INFORMATIONW.html#o9">pszLocalName</a>) + 1) * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>);
00291 
00292         <span class="comment">//</span>
00293         <span class="comment">// Convert Unicode name to Ansi</span>
00294         <span class="comment">//</span>
00295         <span class="keywordflow">if</span> (WideCharToMultiByte(CP_ACP, 0, pDevInfo-&gt;<a class="code" href="../../d5/d6/struct__STI__DEVICE__INFORMATIONW.html#o2">szDeviceInternalName</a>, -1, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>,
00296               dwLen, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bUsedDefaultChar) &amp;&amp; ! bUsedDefaultChar)
00297         {
00298             <a class="code" href="../../d7/d6/classCScannerList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>);
00299         }
00300         <span class="keywordflow">else</span>
00301         {
00302             _RPTF0(_CRT_WARN, <span class="stringliteral">"Error converting internalName to Unicode name\n"</span>);
00303         }
00304 
00305         <span class="keywordflow">if</span> (WideCharToMultiByte(CP_ACP, 0, pDevInfo-&gt;<a class="code" href="../../d5/d6/struct__STI__DEVICE__INFORMATIONW.html#o9">pszLocalName</a>, -1, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>,
00306               dwLen, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bUsedDefaultChar) &amp;&amp; ! bUsedDefaultChar)
00307         {
00308             <a class="code" href="../../d7/d6/classCScannerList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>);
00309         }
00310         <span class="keywordflow">else</span>
00311         {
00312             _RPTF0(_CRT_WARN, <span class="stringliteral">"Error converting deviceName to Unicode name\n"</span>);
00313         }
00314 
00315 <span class="preprocessor">        #else</span>
00316 <span class="preprocessor"></span>        <a class="code" href="../../d7/d6/classCScannerList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(pDevInfo-&gt;<a class="code" href="../../d5/d6/struct__STI__DEVICE__INFORMATIONW.html#o2">szDeviceInternalName</a>);
00317         <a class="code" href="../../d7/d6/classCScannerList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(pDevInfo-&gt;<a class="code" href="../../d5/d6/struct__STI__DEVICE__INFORMATIONW.html#o9">pszLocalName</a>);
00318 <span class="preprocessor">        #endif</span>
00319 <span class="preprocessor"></span>    }
00320 
00321 EndEnumerate:
00322     <span class="keywordflow">if</span> (pBuffer)
00323     {
00324         LocalFree(pBuffer);
00325     }
00326 
00327     <span class="keywordflow">if</span> (pSti)
00328     {
00329         pSti-&gt;Release();
00330     }
00331 
00332     <span class="keywordflow">if</span> (hModule)
00333     {
00334         FreeLibrary(hModule);
00335     }
00336 
00337     <span class="keywordflow">return</span>;
00338 }
00339 
00340 <span class="comment">//  Scanner Name Validity Check</span>
00341 
<a name="l00342"></a><a class="code" href="../../d7/d6/classCScannerList.html#a6">00342</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d7/d6/classCScannerList.html#a6">CScannerList::IsValidDeviceName</a>(LPCTSTR lpstrRef) {
00343 
00344     <span class="keywordflow">if</span>  (!lpstrRef) <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00345 
00346     <span class="keywordflow">if</span>  (!<a class="code" href="../../d7/d6/classCScannerList.html#a2">Count</a>())
00347         <a class="code" href="../../d7/d6/classCScannerList.html#a5">Enumerate</a>();
00348 
00349     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; <a class="code" href="../../d7/d6/classCScannerList.html#a2">Count</a>(); u++)
00350         <span class="keywordflow">if</span>  (!lstrcmpi(<a class="code" href="../../d7/d6/classCScannerList.html#r0">m_csaDeviceNames</a>[u], lpstrRef))
00351             <span class="keywordflow">break</span>;
00352 
00353     <span class="keywordflow">return</span>  u &lt; <a class="code" href="../../d7/d6/classCScannerList.html#a2">Count</a>();
00354 }
00355 
00356 <span class="comment">//  CAllDeviceList class enumerator</span>
00357 
<a name="l00358"></a><a class="code" href="../../d7/d1/classCAllDeviceList.html#a5">00358</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d1/classCAllDeviceList.html#a5">CAllDeviceList::Enumerate</a>() {
00359 
00360     <a class="code" href="../../d2/d4/classCMonitorList.html">CMonitorList</a>    cml;
00361     <a class="code" href="../../d5/d5/classCPrinterList.html">CPrinterList</a>    cpl;
00362     <a class="code" href="../../d7/d6/classCScannerList.html">CScannerList</a>    csl;
00363 
00364     cml.<a class="code" href="../../d2/d4/classCMonitorList.html#a6">Enumerate</a>();
00365     cpl.<a class="code" href="../../d5/d5/classCPrinterList.html#a5">Enumerate</a>();
00366     csl.<a class="code" href="../../d7/d6/classCScannerList.html#a5">Enumerate</a>();
00367 
00368     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; cpl.<a class="code" href="../../d5/d5/classCPrinterList.html#a2">Count</a>(); u++) {
00369         <a class="code" href="../../d7/d1/classCAllDeviceList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(cpl.<a class="code" href="../../d5/d5/classCPrinterList.html#a3">DeviceName</a>(u));
00370         <a class="code" href="../../d7/d1/classCAllDeviceList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(cpl.<a class="code" href="../../d5/d5/classCPrinterList.html#a4">DisplayName</a>(u));
00371     }
00372 
00373     <span class="keywordflow">for</span> (u = 0; u &lt; cml.<a class="code" href="../../d2/d4/classCMonitorList.html#a2">Count</a>(); u++) {
00374         <a class="code" href="../../d7/d1/classCAllDeviceList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(cml.<a class="code" href="../../d2/d4/classCMonitorList.html#a3">DeviceName</a>(u));
00375         <a class="code" href="../../d7/d1/classCAllDeviceList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(cml.<a class="code" href="../../d2/d4/classCMonitorList.html#a4">DisplayName</a>(u));
00376     }
00377 
00378     <span class="keywordflow">for</span> (u = 0; u &lt; csl.<a class="code" href="../../d7/d6/classCScannerList.html#a2">Count</a>(); u++) {
00379         <a class="code" href="../../d7/d1/classCAllDeviceList.html#r0">m_csaDeviceNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(csl.<a class="code" href="../../d7/d6/classCScannerList.html#a3">DeviceName</a>(u));
00380         <a class="code" href="../../d7/d1/classCAllDeviceList.html#r1">m_csaDisplayNames</a>.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(csl.<a class="code" href="../../d7/d6/classCScannerList.html#a4">DisplayName</a>(u));
00381     }
00382 }
00383 
00384 <span class="comment">//  Device Name Validity Check</span>
00385 
<a name="l00386"></a><a class="code" href="../../d7/d1/classCAllDeviceList.html#a6">00386</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d7/d1/classCAllDeviceList.html#a6">CAllDeviceList::IsValidDeviceName</a>(LPCTSTR lpstrRef) {
00387 
00388     <span class="keywordflow">if</span>  (!lpstrRef) <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00389 
00390     <span class="keywordflow">if</span>  (!<a class="code" href="../../d7/d1/classCAllDeviceList.html#a2">Count</a>())
00391         <a class="code" href="../../d7/d1/classCAllDeviceList.html#a5">Enumerate</a>();
00392 
00393     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; <a class="code" href="../../d7/d1/classCAllDeviceList.html#a2">Count</a>(); u++)
00394         <span class="keywordflow">if</span>  (!lstrcmpi(<a class="code" href="../../d7/d1/classCAllDeviceList.html#r0">m_csaDeviceNames</a>[u], lpstrRef))
00395             <span class="keywordflow">break</span>;
00396 
00397     <span class="keywordflow">return</span>  u &lt; <a class="code" href="../../d7/d1/classCAllDeviceList.html#a2">Count</a>();
00398 }
00399 
00400 <span class="comment">//  CProfile member functions</span>
00401 
00402 <span class="comment">//  The following static functions fills the appropriate array using the</span>
00403 <span class="comment">//  profiles that match the search criteria goven.</span>
00404 
<a name="l00405"></a><a class="code" href="../../d7/d5/classCProfile.html#e0">00405</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#e0">CProfile::Enumerate</a>(ENUMTYPE&amp; et, <a class="code" href="../../d2/d7/classCStringArray.html">CStringArray</a>&amp; csaList) {
00406 
00407     <span class="comment">//  Enumerate the existing profiles</span>
00408 
00409     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwBuffer =0, dwcProfiles;
00410 
00411     csaList.<a class="code" href="../../d2/d7/classCStringArray.html#a6">Empty</a>();
00412 
00413     <a class="code" href="../../d7/d6/jul98_2test_2icm_8h.html#a49">EnumColorProfiles</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;et, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;dwBuffer, &amp;dwcProfiles);
00414 
00415     <span class="keywordflow">if</span>  (!dwBuffer) {
00416         _RPTF2(_CRT_WARN,
00417             <span class="stringliteral">"CProfile::Enumerate(String)- empty list- dwBuffer %d Error %d\n"</span>,
00418             dwBuffer, GetLastError());
00419         <span class="keywordflow">return</span>;
00420     }
00421 
00422     <span class="keyword">union </span>{
00423         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>   pbBuffer;
00424         PTSTR   pstrBuffer;
00425     };
00426 
00427     pbBuffer = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwBuffer];
00428 
00429     <span class="keywordflow">if</span> (pbBuffer) {
00430 
00431         <span class="keywordflow">if</span>  (<a class="code" href="../../d7/d6/jul98_2test_2icm_8h.html#a49">EnumColorProfiles</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;et, pbBuffer, &amp;dwBuffer, &amp;dwcProfiles)) {
00432             <span class="keywordflow">for</span> (PTSTR pstrMe = pstrBuffer;
00433                  dwcProfiles--;
00434                  pstrMe += 1 + lstrlen(pstrMe)) {
00435                 _RPTF1(_CRT_WARN, <span class="stringliteral">"CProfile::Enumerate(String) %s found\n"</span>,
00436                     pstrMe);
00437                 csaList.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(pstrMe);
00438             }
00439         }
00440 
00441         <span class="keyword">delete</span>  pbBuffer;
00442     }
00443 }
00444 
<a name="l00445"></a><a class="code" href="../../d7/d5/classCProfile.html#e1">00445</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#e0">CProfile::Enumerate</a>(ENUMTYPE&amp; et, <a class="code" href="../../d2/d7/classCStringArray.html">CStringArray</a>&amp; csaList, <a class="code" href="../../d2/d7/classCStringArray.html">CStringArray</a>&amp; csaDesc) {
00446 
00447     <span class="comment">//  Enumerate the existing profiles</span>
00448 
00449     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwBuffer =0, dwcProfiles;
00450 
00451     csaList.<a class="code" href="../../d2/d7/classCStringArray.html#a6">Empty</a>();
00452 
00453     <a class="code" href="../../d7/d6/jul98_2test_2icm_8h.html#a49">EnumColorProfiles</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;et, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;dwBuffer, &amp;dwcProfiles);
00454 
00455     <span class="keywordflow">if</span>  (!dwBuffer) {
00456         _RPTF2(_CRT_WARN,
00457             <span class="stringliteral">"CProfile::Enumerate(String)- empty list- dwBuffer %d Error %d\n"</span>,
00458             dwBuffer, GetLastError());
00459         <span class="keywordflow">return</span>;
00460     }
00461 
00462     <span class="keyword">union </span>{
00463         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>   pbBuffer;
00464         PTSTR   pstrBuffer;
00465     };
00466 
00467     pbBuffer = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwBuffer];
00468 
00469     <span class="keywordflow">if</span> (pbBuffer) {
00470 
00471         <span class="keywordflow">if</span>  (<a class="code" href="../../d7/d6/jul98_2test_2icm_8h.html#a49">EnumColorProfiles</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;et, pbBuffer, &amp;dwBuffer, &amp;dwcProfiles)) {
00472             <span class="keywordflow">for</span> (PTSTR pstrMe = pstrBuffer;
00473                  dwcProfiles--;
00474                  pstrMe += 1 + lstrlen(pstrMe)) {
00475                 _RPTF1(_CRT_WARN, <span class="stringliteral">"CProfile::Enumerate(String) %s found\n"</span>,
00476                     pstrMe);
00477 
00478                 <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> cp(pstrMe);
00479 
00480                 <span class="keywordflow">if</span> (cp.<a class="code" href="../../d7/d5/classCProfile.html#a7">IsValid</a>()) {
00481 
00482                     <a class="code" href="../../d1/d7/classCString.html">CString</a> csDescription = cp.<a class="code" href="../../d7/d5/classCProfile.html#a13">TagContents</a>('desc', 4);
00483 
00484                     <span class="keywordflow">if</span> (csDescription.<a class="code" href="../../d1/d7/classCString.html#a5">IsEmpty</a>()) {
00485                         csaDesc.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(pstrMe);
00486                     } <span class="keywordflow">else</span> {
00487                         csaDesc.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>((LPTSTR)csDescription);
00488                     }
00489 
00490                     csaList.<a class="code" href="../../d2/d7/classCStringArray.html#a3">Add</a>(pstrMe);
00491                 }
00492             }
00493         }
00494 
00495         <span class="keyword">delete</span>  pbBuffer;
00496     }
00497 }
00498 
<a name="l00499"></a><a class="code" href="../../d7/d5/classCProfile.html#e2">00499</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#e0">CProfile::Enumerate</a>(ENUMTYPE&amp; et, <a class="code" href="../../d8/d5/classCProfileArray.html">CProfileArray</a>&amp; cpaList) {
00500 
00501     <span class="comment">//  Enumerate the existing profiles</span>
00502 
00503     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwBuffer = 0, dwcProfiles;
00504 
00505     cpaList.<a class="code" href="../../d8/d5/classCProfileArray.html#a6">Empty</a>();
00506 
00507     <a class="code" href="../../d7/d6/jul98_2test_2icm_8h.html#a49">EnumColorProfiles</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;et, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;dwBuffer, &amp;dwcProfiles);
00508 
00509     <span class="keywordflow">if</span>  (!dwBuffer) {
00510         _RPTF2(_CRT_WARN,
00511             <span class="stringliteral">"CProfile::Enumerate(Profile)- empty list- dwBuffer %d Error %d\n"</span>,
00512             dwBuffer, GetLastError());
00513         <span class="keywordflow">return</span>;
00514     }
00515 
00516     <span class="keyword">union </span>{
00517         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>   pbBuffer;
00518         PTSTR   pstrBuffer;
00519     };
00520 
00521     pbBuffer = <span class="keyword">new</span> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>[dwBuffer];
00522 
00523     <span class="keywordflow">if</span> (pbBuffer) {
00524 
00525         <span class="keywordflow">if</span>  (<a class="code" href="../../d7/d6/jul98_2test_2icm_8h.html#a49">EnumColorProfiles</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;et, pbBuffer, &amp;dwBuffer, &amp;dwcProfiles)) {
00526             <span class="keywordflow">for</span> (PTSTR pstrMe = pstrBuffer;
00527                  dwcProfiles--;
00528                  pstrMe += 1 + lstrlen(pstrMe)) {
00529                 _RPTF1(_CRT_WARN, <span class="stringliteral">"CProfile::Enumerate(Profile) %s added\n"</span>,
00530                     pstrMe);
00531                 cpaList.<a class="code" href="../../d8/d5/classCProfileArray.html#a3">Add</a>(pstrMe);
00532             }
00533         }
00534 
00535         <span class="keyword">delete</span>  pbBuffer;
00536     }
00537 
00538 }
00539 
00540 <span class="comment">//  This retrieves the color directory name.  Since it is a const, we whouldn't</span>
00541 <span class="comment">//  be calling it too often...</span>
00542 
<a name="l00543"></a><a class="code" href="../../d7/d5/classCProfile.html#e3">00543</a> <span class="keyword">const</span> <a class="code" href="../../d1/d7/classCString.html">CString</a>   <a class="code" href="../../d7/d5/classCProfile.html#e3">CProfile::ColorDirectory</a>() {
00544     TCHAR   acDirectory[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00545     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwccDir = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
00546 
00547     GetColorDirectory(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, acDirectory, &amp;dwccDir);
00548 
00549     <span class="keywordflow">return</span>  acDirectory;
00550 }
00551 
00552 <span class="comment">//  This checks for profile installation</span>
00553 
<a name="l00554"></a><a class="code" href="../../d7/d5/classCProfile.html#d0">00554</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#d0">CProfile::InstallCheck</a>() {
00555 
00556     <span class="comment">//  Enumerate the existing profiles, so we can see if this one's been</span>
00557     <span class="comment">//  installed, already.</span>
00558 
00559     ENUMTYPE    et = {<span class="keyword">sizeof</span> (ENUMTYPE), ENUM_TYPE_VERSION, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>};
00560 
00561     <a class="code" href="../../d2/d7/classCStringArray.html">CStringArray</a>    csaWork;
00562 
00563     <a class="code" href="../../d7/d5/classCProfile.html#e0">Enumerate</a>(et, csaWork);
00564 
00565     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; csaWork.<a class="code" href="../../d2/d7/classCStringArray.html#a2">Count</a>(); u++)
00566         <span class="keywordflow">if</span>  (!lstrcmpi(csaWork[u].NameOnly(), <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a14">NameOnly</a>()))
00567             <span class="keywordflow">break</span>;
00568 
00569     <a class="code" href="../../d7/d5/classCProfile.html#r3">m_bIsInstalled</a> = u &lt; csaWork.<a class="code" href="../../d2/d7/classCStringArray.html#a2">Count</a>();
00570     <a class="code" href="../../d7/d5/classCProfile.html#r4">m_bInstallChecked</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00571 }
00572 
00573 <span class="comment">//  This Checks for Associated Devices</span>
00574 
<a name="l00575"></a><a class="code" href="../../d7/d5/classCProfile.html#d1">00575</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#d1">CProfile::AssociationCheck</a>() {
00576 
00577     <a class="code" href="../../d7/d5/classCProfile.html#r5">m_bAssociationsChecked</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00578 
00579     <span class="comment">//  If the profile isn't installed, associations are moot...</span>
00580 
00581     <span class="keywordflow">if</span>  (!<a class="code" href="../../d7/d5/classCProfile.html#a6">IsInstalled</a>())
00582         <span class="keywordflow">return</span>;
00583 
00584     <span class="comment">//  The final step is to build a list of associations</span>
00585 
00586     ENUMTYPE        et = {<span class="keyword">sizeof</span> (ENUMTYPE), ENUM_TYPE_VERSION, ET_DEVICENAME};
00587     <a class="code" href="../../d2/d7/classCStringArray.html">CStringArray</a>    csaWork;
00588 
00589     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> u = 0; u &lt; <a class="code" href="../../d7/d5/classCProfile.html#a8">DeviceCount</a>(); u++) {
00590 
00591         et.pDeviceName = <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> -&gt; <a class="code" href="../../d7/d5/classCProfile.html#a10">DeviceName</a>(u);
00592 
00593         <a class="code" href="../../d7/d5/classCProfile.html#e0">Enumerate</a>(et, csaWork);
00594 
00595         <span class="comment">//  We track associations by index into the total device list...</span>
00596 
00597         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> uProfile = 0; uProfile &lt; csaWork.<a class="code" href="../../d2/d7/classCStringArray.html#a2">Count</a>(); uProfile++)
00598             <span class="keywordflow">if</span>  (!lstrcmpi(csaWork[uProfile].NameOnly(), <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a14">NameOnly</a>())){
00599                 <a class="code" href="../../d7/d5/classCProfile.html#r8">m_cuaAssociation</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a3">Add</a>(u);    <span class="comment">//  Found one!</span>
00600                 <span class="keywordflow">break</span>;
00601             }
00602     }
00603 }
00604 
00605 <span class="comment">//  This determines the device list of related class...</span>
00606 
<a name="l00607"></a><a class="code" href="../../d7/d5/classCProfile.html#d2">00607</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#d2">CProfile::DeviceCheck</a>() {
00608 
00609     <span class="comment">//  Enumerate the available devices of this type in the csaDevice Array</span>
00610 
00611     <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> -&gt; <a class="code" href="../../d7/d5/classCProfile.html#e0">Enumerate</a>();
00612     <a class="code" href="../../d7/d5/classCProfile.html#r6">m_bDevicesChecked</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00613 }
00614 
00615 <span class="comment">//  Class constructor</span>
00616 
<a name="l00617"></a><a class="code" href="../../d7/d5/classCProfile.html#a0">00617</a> <a class="code" href="../../d7/d5/classCProfile.html#a0">CProfile::CProfile</a>(LPCTSTR lpstrTarget) {
00618 
00619     _ASSERTE(lpstrTarget &amp;&amp; *lpstrTarget);
00620 
00621     <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00622 
00623     <span class="comment">//  First, let's make sure it's the real McCoy</span>
00624 
00625     PROFILE     prof = { PROFILE_FILENAME,
00626                          (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) lpstrTarget,
00627                          (1 + lstrlen(lpstrTarget)) * <span class="keyword">sizeof</span>(TCHAR)};
00628 
00629     <a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a> = OpenColorProfile(&amp;prof, PROFILE_READ,
00630                                       FILE_SHARE_READ|FILE_SHARE_WRITE,
00631                                       <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>);
00632 
00633     <span class="keywordflow">if</span>  (!<a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a>)
00634         <span class="keywordflow">return</span>;
00635 
00636     <span class="keywordflow">if</span>  (!<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a25">GetColorProfileHeader</a>(<a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a>, &amp;<a class="code" href="../../d7/d5/classCProfile.html#r1">m_phThis</a>)) {
00637         <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a13">CloseColorProfile</a>(<a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a>);
00638         <a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00639         <span class="keywordflow">return</span>;
00640     }
00641 
00642     <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a> = lpstrTarget;
00643     <a class="code" href="../../d7/d5/classCProfile.html#r4">m_bInstallChecked</a> = <a class="code" href="../../d7/d5/classCProfile.html#r6">m_bDevicesChecked</a> = <a class="code" href="../../d7/d5/classCProfile.html#r5">m_bAssociationsChecked</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00644 
00645     <span class="comment">//  Init the DeviceList pointer, because it doesn't cost much...</span>
00646 
00647     <span class="keywordflow">switch</span>  (<a class="code" href="../../d7/d5/classCProfile.html#r1">m_phThis</a>.phClass) {
00648         <span class="keywordflow">case</span>    CLASS_PRINTER:
00649 
00650             <span class="comment">//  Our device list is a printer list</span>
00651 
00652             <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> = <span class="keyword">new</span> <a class="code" href="../../d5/d5/classCPrinterList.html">CPrinterList</a>;
00653             <span class="keywordflow">break</span>;
00654 
00655         <span class="keywordflow">case</span>     CLASS_SCANNER:
00656 
00657             <span class="comment">//  Our device list is a scanner list</span>
00658 
00659             <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> = <span class="keyword">new</span> <a class="code" href="../../d7/d6/classCScannerList.html">CScannerList</a>;
00660             <span class="keywordflow">break</span>;
00661 
00662 
00663         <span class="keywordflow">case</span>    CLASS_MONITOR:
00664 
00665             <span class="comment">//  Our device list is a monitor list</span>
00666 
00667 <span class="preprocessor">        #if 1 // ALLOW_MONITOR_PROFILE_TO_ANY_DEVICE</span>
00668 <span class="preprocessor"></span>            <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> = <span class="keyword">new</span> <a class="code" href="../../d7/d1/classCAllDeviceList.html">CAllDeviceList</a>;
00669 <span class="preprocessor">        #else</span>
00670 <span class="preprocessor"></span>            <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> = <span class="keyword">new</span> <a class="code" href="../../d2/d4/classCMonitorList.html">CMonitorList</a>;
00671 <span class="preprocessor">        #endif</span>
00672 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00673 
00674         <span class="keywordflow">case</span>    CLASS_COLORSPACE:
00675 
00676             <span class="comment">//  List everything we can count</span>
00677 
00678             <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> = <span class="keyword">new</span> CAllDeviceList;
00679             <span class="keywordflow">break</span>;
00680 
00681         <span class="keywordflow">default</span>:
00682             <span class="comment">//  Use the base device class (i.e., no devices of this type).</span>
00683             <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a> = <span class="keyword">new</span> <a class="code" href="../../d1/d2/classCDeviceList.html">CDeviceList</a>;
00684     }
00685 }
00686 
00687 <span class="comment">//  Destructor</span>
00688 
<a name="l00689"></a><a class="code" href="../../d7/d5/classCProfile.html#a1">00689</a> <a class="code" href="../../d7/d5/classCProfile.html#a1">CProfile::~CProfile</a>() {
00690     <span class="keywordflow">if</span>  (<a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a>)
00691         <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a13">CloseColorProfile</a>(<a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a>);
00692     <span class="keywordflow">if</span>  (<a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a>)
00693         <span class="keyword">delete</span>  <a class="code" href="../../d7/d5/classCProfile.html#r7">m_pcdlClass</a>;
00694 }
00695 
00696 <span class="comment">//  Tag retrieval function</span>
00697 
<a name="l00698"></a><a class="code" href="../../d7/d5/classCProfile.html#a13">00698</a> LPCSTR  <a class="code" href="../../d7/d5/classCProfile.html#a13">CProfile::TagContents</a>(TAGTYPE tt, <span class="keywordtype">unsigned</span> uOffset) {
00699 
00700     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwcNeeded = <span class="keyword">sizeof</span> <a class="code" href="../../d7/d5/classCProfile.html#r9">m_acTag</a>;
00701     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    bIgnore;
00702 
00703     <span class="keywordflow">if</span>  (!<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a21">GetColorProfileElement</a>(<a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a>, tt, 8 + uOffset, &amp;dwcNeeded, m_acTag,
00704          &amp;bIgnore))
00705         <span class="keywordflow">return</span>  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">//  Nothing to copy!</span>
00706     <span class="keywordflow">else</span>
00707         <span class="keywordflow">return</span>  m_acTag;
00708 }
00709 
00710 <span class="comment">//  Profile Installation function</span>
00711 
<a name="l00712"></a><a class="code" href="../../d7/d5/classCProfile.html#a14">00712</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d7/d5/classCProfile.html#a14">CProfile::Install</a>() {
00713 
00714     <span class="keywordflow">if</span>  (!InstallColorProfile(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>)) {
00715         CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a30">InstFailedWithName</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00716                            MB_OK|MB_ICONEXCLAMATION,1,<a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>());
00717         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00718     } <span class="keywordflow">else</span> {
00719         <a class="code" href="../../d7/d5/classCProfile.html#r3">m_bIsInstalled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00720         <a class="code" href="../../d0/d3/classCGlobals.html#e9">CGlobals::InvalidateList</a>();
00721         SHChangeNotify(SHCNE_UPDATEITEM, SHCNF_PATH, (LPCTSTR) <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00722 
00723         _RPTF1(_CRT_WARN, <span class="stringliteral">"CProfile::Install %s succeeded\n"</span>,
00724             (LPCSTR) m_csName);
00725         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00726     }
00727 }
00728 
00729 <span class="comment">//  Profile Uninstallation function</span>
00730 
<a name="l00731"></a><a class="code" href="../../d7/d5/classCProfile.html#a15">00731</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#a15">CProfile::Uninstall</a>(BOOL bDelete) {
00732 
00733     <span class="keywordflow">while</span>   (<a class="code" href="../../d7/d5/classCProfile.html#a9">AssociationCount</a>()) {    <span class="comment">// Dissociate all uses</span>
00734         <a class="code" href="../../d7/d5/classCProfile.html#a17">Dissociate</a>(<a class="code" href="../../d7/d5/classCProfile.html#a10">DeviceName</a>(<a class="code" href="../../d7/d5/classCProfile.html#r8">m_cuaAssociation</a>[0]));
00735         <a class="code" href="../../d7/d5/classCProfile.html#r8">m_cuaAssociation</a>.<a class="code" href="../../d3/d7/classCUintArray.html#a5">Remove</a>(0);
00736     }
00737 
00738     <span class="keywordflow">if</span>  (<a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a>)
00739     {
00740         <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a13">CloseColorProfile</a>(<a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a>);
00741         <a class="code" href="../../d7/d5/classCProfile.html#r0">m_hprof</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00742     }
00743 
00744     <span class="keywordflow">if</span>  (!UninstallColorProfile(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>(), bDelete)) {
00745         CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a31">UninstFailedWithName</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00746                            MB_OK|MB_ICONEXCLAMATION,1,<a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>());
00747     } <span class="keywordflow">else</span> {
00748         <a class="code" href="../../d7/d5/classCProfile.html#r3">m_bIsInstalled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00749         <a class="code" href="../../d0/d3/classCGlobals.html#e9">CGlobals::InvalidateList</a>();
00750         SHChangeNotify(SHCNE_UPDATEITEM, SHCNF_PATH, (LPCTSTR) <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00751 
00752         _RPTF1(_CRT_WARN, <span class="stringliteral">"CProfile::Uninstall %s succeeded\n"</span>,
00753             (LPCSTR) m_csName);
00754     }
00755 }
00756 
00757 <span class="comment">//  Association</span>
00758 
<a name="l00759"></a><a class="code" href="../../d7/d5/classCProfile.html#a16">00759</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#a16">CProfile::Associate</a>(LPCTSTR lpstrDevice) {
00760 
00761     <span class="comment">// if the profile is not installed, install it first.</span>
00762 
00763     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bInstalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00764 
00765     <span class="comment">// Install profile, if not installed, yet.</span>
00766     <span class="keywordflow">if</span>  (!<a class="code" href="../../d7/d5/classCProfile.html#a6">IsInstalled</a>()) {
00767         bInstalled = <a class="code" href="../../d7/d5/classCProfile.html#a14">Install</a>();
00768     } <span class="keywordflow">else</span>
00769         bInstalled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00770 
00771     <span class="keywordflow">if</span>  (bInstalled) {
00772         <span class="keywordflow">if</span>  (!AssociateColorProfileWithDevice(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>(),
00773             lpstrDevice)) {
00774             CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a32">AssocFailedWithName</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,1,
00775                                MB_OK|MB_ICONEXCLAMATION,<a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>());
00776         } <span class="keywordflow">else</span>
00777             _RPTF2(_CRT_WARN, <span class="stringliteral">"CProfile::Associate %s with %s succeeded\n"</span>,
00778                 lpstrDevice, (LPCTSTR) <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>());
00779     }
00780 }
00781 
00782 <span class="comment">//  Dissociation</span>
00783 
<a name="l00784"></a><a class="code" href="../../d7/d5/classCProfile.html#a17">00784</a> <span class="keywordtype">void</span>    <a class="code" href="../../d7/d5/classCProfile.html#a17">CProfile::Dissociate</a>(LPCTSTR lpstrDevice) {
00785     <span class="keywordflow">if</span>  (!DisassociateColorProfileFromDevice(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>(),
00786         lpstrDevice)) {
00787         CGlobals::ReportEx(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a33">DisassocFailedWithName</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,1,
00788                            MB_OK|MB_ICONEXCLAMATION,<a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>());
00789     } <span class="keywordflow">else</span>
00790         _RPTF2(_CRT_WARN, <span class="stringliteral">"CProfile::Dissociate %s from %s succeeded\n"</span>,
00791             lpstrDevice, (LPCTSTR) <a class="code" href="../../d7/d5/classCProfile.html#r2">m_csName</a>.<a class="code" href="../../d1/d7/classCString.html#a15">NameAndExtension</a>());
00792 }
00793 
00794 <span class="comment">//  CProfileArray class- Same basic implementation, different base type.</span>
00795 
<a name="l00796"></a><a class="code" href="../../d8/d5/classCProfileArray.html#d1">00796</a> <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a>    *<a class="code" href="../../d8/d5/classCProfileArray.html#d1">CProfileArray::Borrow</a>() {
00797     <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a>    *pcpReturn = <a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>[0];
00798 
00799     memcpy((LPSTR) m_aStore, (LPSTR) (m_aStore + 1),
00800         (<a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() - 1) * <span class="keyword">sizeof</span> m_aStore[0]);
00801 
00802     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a> &gt; <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>())
00803         m_aStore[<a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() - 1] = <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> -&gt; <a class="code" href="../../d8/d5/classCProfileArray.html#d1">Borrow</a>();
00804     <span class="keywordflow">else</span>
00805         m_aStore[<a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() - 1] = (<a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> *) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00806 
00807     <a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a>--;
00808 
00809     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a> &lt;= <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() &amp;&amp; <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a>) {
00810         <span class="keyword">delete</span>  <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a>;
00811         <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00812     }
00813 
00814     <span class="keywordflow">return</span>  pcpReturn;
00815 }
00816 
<a name="l00817"></a><a class="code" href="../../d8/d5/classCProfileArray.html#a0">00817</a> <a class="code" href="../../d8/d5/classCProfileArray.html#a0">CProfileArray::CProfileArray</a>() {
00818     <a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a> = 0;
00819     <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00820     memset(<a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>, 0, <span class="keyword">sizeof</span> <a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>);
00821 }
00822 
<a name="l00823"></a><a class="code" href="../../d8/d5/classCProfileArray.html#a1">00823</a> <a class="code" href="../../d8/d5/classCProfileArray.html#a1">CProfileArray::~CProfileArray</a>() {
00824     <a class="code" href="../../d8/d5/classCProfileArray.html#a6">Empty</a>();
00825 }
00826 
<a name="l00827"></a><a class="code" href="../../d8/d5/classCProfileArray.html#a6">00827</a> <span class="keywordtype">void</span>    <a class="code" href="../../d8/d5/classCProfileArray.html#a6">CProfileArray::Empty</a>() {
00828     <span class="keywordflow">if</span>  (!<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a>) <span class="keywordflow">return</span>;
00829 
00830     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a>) {
00831         <span class="keyword">delete</span>  <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a>;
00832         <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00833         <a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a> = <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>();
00834     }
00835 
00836     <span class="keywordflow">while</span>   (<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a>--)
00837         <span class="keyword">delete</span>  <a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>[<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a>];
00838 
00839     <a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a> = 0;
00840     memset(<a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>, 0, <span class="keyword">sizeof</span> <a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>);
00841 }
00842 
00843 <span class="comment">//  Add an item</span>
<a name="l00844"></a><a class="code" href="../../d8/d5/classCProfileArray.html#a3">00844</a> <span class="keywordtype">void</span>    <a class="code" href="../../d8/d5/classCProfileArray.html#a3">CProfileArray::Add</a>(LPCTSTR lpstrNew) {
00845     _ASSERTE(lpstrNew &amp;&amp; *lpstrNew);
00846 
00847     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a> &lt; <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>()) {
00848         <a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>[<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a>++] = <span class="keyword">new</span>  <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a>(lpstrNew);
00849         <span class="keywordflow">return</span>;
00850     }
00851 
00852     <span class="comment">//  Not enough space!  Add another record, if there isn't one</span>
00853 
00854     <span class="keywordflow">if</span>  (!<a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a>)
00855         <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d5/classCProfileArray.html">CProfileArray</a>;
00856 
00857     <span class="comment">//  Add the profile to the next array (recursive call!)</span>
00858 
00859     <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> -&gt; <a class="code" href="../../d8/d5/classCProfileArray.html#a3">Add</a>(lpstrNew);
00860     <a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a>++;
00861 }
00862 
<a name="l00863"></a><a class="code" href="../../d8/d5/classCProfileArray.html#a4">00863</a> <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a>    *CProfileArray::operator [](<span class="keywordtype">unsigned</span> u)<span class="keyword"> const </span>{
00864     <span class="keywordflow">return</span>  u &lt; <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() ?
00865         <a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>[u] : <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> -&gt; <a class="code" href="../../d8/d5/classCProfileArray.html#a4">operator[]</a>(u - <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>());
00866 }
00867 
<a name="l00868"></a><a class="code" href="../../d8/d5/classCProfileArray.html#a5">00868</a> <span class="keywordtype">void</span>    <a class="code" href="../../d8/d5/classCProfileArray.html#a5">CProfileArray::Remove</a>(<span class="keywordtype">unsigned</span> u) {
00869 
00870     <span class="keywordflow">if</span>  (u &gt; <a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a>)
00871         <span class="keywordflow">return</span>;
00872 
00873     <span class="keywordflow">if</span>  (u &gt;= <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>()) {
00874         <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> -&gt; <a class="code" href="../../d8/d5/classCProfileArray.html#a5">Remove</a>(u - <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>());
00875         <span class="keywordflow">return</span>;
00876     }
00877 
00878     <span class="keyword">delete</span>  <a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>[u];
00879 
00880     memmove((LPSTR) (<a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a> + u), (LPSTR) (<a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a> + u + 1),
00881         (<a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() - (u + 1)) * <span class="keyword">sizeof</span> <a class="code" href="../../d8/d5/classCProfileArray.html#r0">m_aStore</a>[0]);
00882 
00883     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a> &gt; <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>())
00884         m_aStore[<a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() - 1] = <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> -&gt; <a class="code" href="../../d8/d5/classCProfileArray.html#d1">Borrow</a>();
00885     <span class="keywordflow">else</span>
00886         m_aStore[<a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() - 1] = (<a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> *) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00887 
00888     <a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a>--;
00889 
00890     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/classCProfileArray.html#r2">m_ucUsed</a> &lt;= <a class="code" href="../../d8/d5/classCProfileArray.html#d0">ChunkSize</a>() &amp;&amp; <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a>) {
00891         <span class="keyword">delete</span>  <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a>;
00892         <a class="code" href="../../d8/d5/classCProfileArray.html#r1">m_pcpaNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00893     }
00894 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
