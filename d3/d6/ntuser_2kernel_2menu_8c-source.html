<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: menu.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>menu.c</h1><a href="../../d2/d7/ntuser_2kernel_2menu_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/**************************** Module Header ********************************\</span>
00003 <span class="comment">* Module Name: menu.c</span>
00004 <span class="comment">*</span>
00005 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* Keyboard Accelerator Routines</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/***********************************************************************\</span>
00017 <span class="comment">* MNGetpItemIndex</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* 11/19/96  GerardoB  Created</span>
00020 <span class="comment">\***********************************************************************/</span>
00021 <span class="preprocessor">#if DBG</span>
00022 <span class="preprocessor"></span><a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> DBGMNGetpItemIndex(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu, <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pitem)
00023 {
00024     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uiPos;
00025     UserAssert((ULONG_PTR)pitem &gt;= (ULONG_PTR)pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>);
00026     uiPos = <a class="code" href="../../d4/d1/userk_8h.html#a1353">_MNGetpItemIndex</a>(pmenu, pitem);
00027     UserAssert(uiPos &lt; pmenu-&gt;cItems);
00028     <span class="keywordflow">return</span> uiPos;
00029 }
00030 <span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span><span class="comment">/**************************************************************************\</span>
00032 <span class="comment">* xxxMNDismiss</span>
00033 <span class="comment">*</span>
00034 <span class="comment">* 12/03/96 GerardoB     Created</span>
00035 <span class="comment">\**************************************************************************/</span>
<a name="l00036"></a><a class="code" href="../../d4/d1/userk_8h.html#a1354">00036</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a> (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
00037 {
00038     <a class="code" href="../../d4/d1/userk_8h.html#a1371">xxxMNCancel</a>(pMenuState, 0, 0, 0);
00039 }
00040 
00041 <span class="comment">/***************************************************************************\</span>
00042 <span class="comment">* MNFadeSelection</span>
00043 <span class="comment">*</span>
00044 <span class="comment">* 2/5/1998   vadimg          created</span>
00045 <span class="comment">\***************************************************************************/</span>
00046 
<a name="l00047"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a2">00047</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a2">MNFadeSelection</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu, <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pitem)
00048 {
00049     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00050     HDC hdc;
00051     RECT rc;
00052     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup;
00053 
00054     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a666">TestALPHA</a>(SELECTIONFADE))
00055         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00056 
00057     <span class="comment">/*</span>
00058 <span class="comment">     * Get the window for the currently active popup menu.</span>
00059 <span class="comment">     */</span>
00060     <span class="keywordflow">if</span> ((ppopup = <a class="code" href="../../d4/d1/userk_8h.html#a1602">MNGetPopupFromMenu</a>(pmenu, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00061         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00062 
00063     <span class="keywordflow">if</span> ((pwnd = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00064         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00065 
00066     rc.left = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a>;
00067     rc.top = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
00068     rc.right = rc.left + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00069     rc.bottom = rc.top + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
00070 
00071     <span class="comment">/*</span>
00072 <span class="comment">     * Initialize the fade animation and get the DC to draw the selection into.</span>
00073 <span class="comment">     */</span>
00074     <span class="keywordflow">if</span> ((hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1977">CreateFade</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;rc, <a class="code" href="../../d1/d0/inc_2user_8h.html#a891">CMS_SELECTIONFADE</a>, 0)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00075         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00076 
00077     <span class="comment">/*</span>
00078 <span class="comment">     * Read the current menu selection right from the screen, since the menu</span>
00079 <span class="comment">     * is still visible and it's always on top. In the worst case we could</span>
00080 <span class="comment">     * offset the origin of the DC and call xxxDrawMenuItem, but just reading</span>
00081 <span class="comment">     * from the screen is much faster.</span>
00082 <span class="comment">     */</span>
00083     GreBitBlt(hdc, 0, 0, pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>, pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>,
00084             rc.left, rc.top, SRCCOPY, 0);
00085 
00086     <a class="code" href="../../d8/d4/sprite_8c.html#a20">ShowFade</a>();
00087 
00088     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00089 }
00090 
00091 <span class="comment">/**************************************************************************\</span>
00092 <span class="comment">* xxxMNDismissWithNotify</span>
00093 <span class="comment">*</span>
00094 <span class="comment">* Generates parameters for WM_COMMAND or WM_SYSCOMMAND message.</span>
00095 <span class="comment">*</span>
00096 <span class="comment">* 12/03/96 GerardoB     Created</span>
00097 <span class="comment">\**************************************************************************/</span>
<a name="l00098"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a3">00098</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a3">xxxMNDismissWithNotify</a> (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu, <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pitem,
00099         UINT uPos, LPARAM lParam)
00100 {
00101     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uMsg;
00102     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uCmd;
00103 
00104     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>) {
00105         uMsg = WM_SYSCOMMAND;
00106         uCmd = pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o2">wID</a>;
00107         <span class="comment">/* lParam set by caller */</span>
00108     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o18">fNotifyByPos</a>) {
00109         uMsg = WM_MENUCOMMAND;
00110         uCmd = uPos;
00111         lParam = (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pmenu);
00112     } <span class="keywordflow">else</span> {
00113         uMsg = WM_COMMAND;
00114         uCmd = pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o2">wID</a>;
00115         lParam = 0;
00116     }
00117 
00118     <span class="comment">/*</span>
00119 <span class="comment">     * The menu is about to go away, see if we want to fade out the selection.</span>
00120 <span class="comment">     */</span>
00121     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a2">MNFadeSelection</a>(pmenu, pitem)) {
00122         <a class="code" href="../../d8/d4/sprite_8c.html#a21">StartFade</a>();
00123     }
00124 
00125     <span class="comment">/*</span>
00126 <span class="comment">     * Dismiss the menu.</span>
00127 <span class="comment">     */</span>
00128     <a class="code" href="../../d4/d1/userk_8h.html#a1371">xxxMNCancel</a>(pMenuState, uMsg, uCmd, lParam);
00129 }
00130 
00131 <span class="comment">/**************************************************************************\</span>
00132 <span class="comment">* MNGetpItem</span>
00133 <span class="comment">*</span>
00134 <span class="comment">* 11/15/96 GerardoB     Created</span>
00135 <span class="comment">\**************************************************************************/</span>
<a name="l00136"></a><a class="code" href="../../d4/d1/userk_8h.html#a1355">00136</a> <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> <a class="code" href="../../d4/d1/userk_8h.html#a1355">MNGetpItem</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup, UINT uIndex)
00137 {
00138     <span class="keywordflow">if</span> ((ppopup == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00139             || (uIndex &gt;= ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)) {
00140 
00141        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00142     }
00143 
00144     <span class="keywordflow">return</span> ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + uIndex;
00145 }
00146 <span class="comment">/***************************************************************************\</span>
00147 <span class="comment">* MNSetCapture</span>
00148 <span class="comment">*</span>
00149 <span class="comment">* History:</span>
00150 <span class="comment">* 11/18/96 GerardoB  Created</span>
00151 <span class="comment">\***************************************************************************/</span>
<a name="l00152"></a><a class="code" href="../../d4/d1/userk_8h.html#a1356">00152</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1356">xxxMNSetCapture</a> (<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup)
00153 {
00154     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00155 
00156     <span class="comment">/*</span>
00157 <span class="comment">     * Set the capture and lock it so no one will be able to steal it</span>
00158 <span class="comment">     *  from us.</span>
00159 <span class="comment">     */</span>
00160     <a class="code" href="../../d4/d1/userk_8h.html#a1516">xxxCapture</a>(ptiCurrent, ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, <a class="code" href="../../d4/d1/userk_8h.html#a466">SCREEN_CAPTURE</a>);
00161     UserAssert (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00162     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>;
00163     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o19">fSetCapture</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00164 <span class="preprocessor">#if DBG</span>
00165 <span class="preprocessor"></span>    <span class="comment">/*</span>
00166 <span class="comment">     * Unless we're in the foreground, this menu mode won't go away</span>
00167 <span class="comment">     *  when the user clicks outside the menu. This is because only</span>
00168 <span class="comment">     *  the foreground queue capture sees clicks outside its windows.</span>
00169 <span class="comment">     */</span>
00170     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
00171         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxMNSetCapture: Menu mode is not in foreground queue"</span>);
00172     }
00173 <span class="preprocessor">#endif</span>
00174 <span class="preprocessor"></span>}
00175 <span class="comment">/***************************************************************************\</span>
00176 <span class="comment">* MNReleaseCapture</span>
00177 <span class="comment">*</span>
00178 <span class="comment">* History:</span>
00179 <span class="comment">* 11/18/96 GerardoB  Created</span>
00180 <span class="comment">\***************************************************************************/</span>
<a name="l00181"></a><a class="code" href="../../d4/d1/userk_8h.html#a1357">00181</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a6">xxxMNReleaseCapture</a> (<span class="keywordtype">void</span>)
00182 {
00183     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00184 
00185     <span class="comment">/*</span>
00186 <span class="comment">     * Bail if we didn't set capture</span>
00187 <span class="comment">     */</span>
00188     <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00189         (! ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o19">fSetCapture</a>)) {
00190         <span class="keywordflow">return</span>;
00191     }
00192     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o19">fSetCapture</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00193 
00194     <span class="comment">/*</span>
00195 <span class="comment">     * Unlock capture and release it.</span>
00196 <span class="comment">     */</span>
00197     <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;QF_flags &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>;
00198     <a class="code" href="../../d4/d1/userk_8h.html#a1713">xxxReleaseCapture</a>();
00199 }
00200 <span class="comment">/***************************************************************************\</span>
00201 <span class="comment">* MNCheckButtonDownState</span>
00202 <span class="comment">*</span>
00203 <span class="comment">* History:</span>
00204 <span class="comment">* 11/14/96 GerardoB  Created</span>
00205 <span class="comment">\***************************************************************************/</span>
<a name="l00206"></a><a class="code" href="../../d4/d1/userk_8h.html#a1358">00206</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1358">MNCheckButtonDownState</a> (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
00207 {
00208     <span class="comment">/*</span>
00209 <span class="comment">     * Modeless menus don't capture the mouse so when a mouse down</span>
00210 <span class="comment">     *  goes off the window, we need to keep watching its state.</span>
00211 <span class="comment">     * We also might not see the button up when going on DoDragDrop loop</span>
00212 <span class="comment">     */</span>
00213     UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a> || pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>);
00214     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> = ((<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o30">vkButtonDown</a>) &amp; 0x8000) != 0);
00215     <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) {
00216         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o8">fDragging</a> =
00217         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o14">fIgnoreButtonUp</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00218         <a class="code" href="../../d4/d1/userk_8h.html#a1377">UnlockMFMWFPWindow</a>(&amp;pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a>);
00219     }
00220 }
00221 <span class="comment">/***************************************************************************\</span>
00222 <span class="comment">* GetMenuStateWindow</span>
00223 <span class="comment">*</span>
00224 <span class="comment">* This function is called when we need to post a message to the menu loop.</span>
00225 <span class="comment">* The actual pwnd is not important since we just want to reach</span>
00226 <span class="comment">*  xxxHandleMenuMessages or xxxMenuWindowProc. So we just pick a window that</span>
00227 <span class="comment">*  has a good chance to be around as long as we are in menu mode.</span>
00228 <span class="comment">*</span>
00229 <span class="comment">* History:</span>
00230 <span class="comment">* 10/31/96 GerardoB  Created</span>
00231 <span class="comment">\***************************************************************************/</span>
<a name="l00232"></a><a class="code" href="../../d4/d1/userk_8h.html#a1359">00232</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1359">GetMenuStateWindow</a> (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
00233 {
00234     <span class="keywordflow">if</span> (pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00235         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00236     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>) {
00237         <span class="keywordflow">return</span> pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>;
00238     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00239         <span class="keywordflow">return</span> pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>;
00240     } <span class="keywordflow">else</span> {
00241         <span class="keywordflow">return</span> pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>;
00242     }
00243 }
00244 <span class="comment">/***************************************************************************\</span>
00245 <span class="comment">* UnlockPopupMenuWindow</span>
00246 <span class="comment">*</span>
00247 <span class="comment">* This function is called when locking/unlocking a menu into a popup structure.</span>
00248 <span class="comment">* It makes sure that pmenu doesn't keep the notification window locked</span>
00249 <span class="comment">*  unneccessarily</span>
00250 <span class="comment">*</span>
00251 <span class="comment">* It unlocks pmenu-&gt;spwndNotify if the menu it's not locked into pmenu-&gt;spwndNotify</span>
00252 <span class="comment">*  itself AND it's currently locked to pwnd.</span>
00253 <span class="comment">* It's also unlocked if pmenu-&gt;spwndNotify is marked as destroyed</span>
00254 <span class="comment">*</span>
00255 <span class="comment">* History:</span>
00256 <span class="comment">* 10/15/96 GerardoB  Created</span>
00257 <span class="comment">\***************************************************************************/</span>
<a name="l00258"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a9">00258</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a9">UnlockPopupMenuWindow</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00259 {
00260     <span class="comment">/*</span>
00261 <span class="comment">     * Bail if there's nothing to unlock</span>
00262 <span class="comment">     */</span>
00263     <span class="keywordflow">if</span> ((pmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00264             || (pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00265         <span class="keywordflow">return</span>;
00266     }
00267     <span class="comment">/*</span>
00268 <span class="comment">     * if pmenu-&gt;spwndNotify owns the menu, bail</span>
00269 <span class="comment">     */</span>
00270     <span class="keywordflow">if</span> ((pmenu == pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>)
00271             || (pmenu == pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>)) {
00272         <span class="keywordflow">return</span>;
00273     }
00274     <span class="comment">/*</span>
00275 <span class="comment">     * If pwnd doesn't own the menu, and pmenu-&gt;spwndNotify is not destroyed, bail</span>
00276 <span class="comment">     */</span>
00277     <span class="keywordflow">if</span> ((pwnd != pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>)
00278             &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
00279         <span class="keywordflow">return</span>;
00280     }
00281     <span class="comment">/*</span>
00282 <span class="comment">     * Unlock it</span>
00283 <span class="comment">     */</span>
00284     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>);
00285     <span class="keywordflow">return</span>;
00286 }
00287 <span class="comment">/***************************************************************************\</span>
00288 <span class="comment">* LockPopupMenu</span>
00289 <span class="comment">*</span>
00290 <span class="comment">* Locks a given menu into a popup strucuture and makes the</span>
00291 <span class="comment">*  popup's notification window the owner of the menu</span>
00292 <span class="comment">*</span>
00293 <span class="comment">* History:</span>
00294 <span class="comment">* 10/15/96 GerardoB  Created</span>
00295 <span class="comment">\***************************************************************************/</span>
<a name="l00296"></a><a class="code" href="../../d4/d1/userk_8h.html#a1360">00296</a> PVOID <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> * pspmenu, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu)
00297 {
00298     <span class="comment">/*</span>
00299 <span class="comment">     * If you hit this assertion, you're probably not passing the right thing</span>
00300 <span class="comment">     */</span>
00301     UserAssert((pspmenu == &amp;ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>) || (pspmenu == &amp;ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>));
00302     <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopup);
00303     <span class="comment">/*</span>
00304 <span class="comment">     * This won't work properly if the popup hasn't locked the notification</span>
00305 <span class="comment">     *  window.</span>
00306 <span class="comment">     */</span>
00307     UserAssert(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00308 
00309     <span class="comment">/*</span>
00310 <span class="comment">     * When using modeless menus, menus can be shared by several active popups.</span>
00311 <span class="comment">     * If the menu has owner draw items, the app better knows how to draw them</span>
00312 <span class="comment">     *  correctly. This shouldn't happen with modal menus though</span>
00313 <span class="comment">     */</span>
00314 <span class="preprocessor">#if DBG</span>
00315 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((*pspmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00316                 &amp;&amp; ((*pspmenu)-&gt;spwndNotify != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00317                 &amp;&amp; ((*pspmenu)-&gt;spwndNotify != ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>)) {
00318 
00319             RIPMSG3(RIP_WARNING, <span class="stringliteral">"LockPopupMenu: Current Menu %#p shared by %#p and %#p"</span>,
00320                     *pspmenu, (*pspmenu)-&gt;spwndNotify, ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00321         }
00322 <span class="preprocessor">#endif</span>
00323 <span class="preprocessor"></span>
00324     <span class="comment">/*</span>
00325 <span class="comment">     * Unlock the current's menu spwndNotify if needed</span>
00326 <span class="comment">     */</span>
00327     <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a9">UnlockPopupMenuWindow</a>(*pspmenu, ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00328 
00329     <span class="comment">/*</span>
00330 <span class="comment">     * Lock the notification window into the menu structure</span>
00331 <span class="comment">     */</span>
00332     <span class="keywordflow">if</span> (pmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00333 
00334         <span class="comment">/*</span>
00335 <span class="comment">         * Display a warning if this menu is being shared</span>
00336 <span class="comment">         */</span>
00337 <span class="preprocessor">#if DBG</span>
00338 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00339                 &amp;&amp; (pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> != ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>)
00340                 &amp;&amp; (pmenu != pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;spmenuDialogSys)) {
00341 
00342             RIPMSG3(RIP_WARNING, <span class="stringliteral">"LockPopupMenu: New Menu %#p shared by %#p and %#p"</span>,
00343                     pmenu, pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00344         }
00345 <span class="preprocessor">#endif</span>
00346 <span class="preprocessor"></span>
00347         <span class="comment">/*</span>
00348 <span class="comment">         * spwndNotify "owns" this menu now.</span>
00349 <span class="comment">         */</span>
00350         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00351     }
00352 
00353     <span class="comment">/*</span>
00354 <span class="comment">     * Lock the menu into the popup structure (unlock the previous one)</span>
00355 <span class="comment">     */</span>
00356     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(pspmenu, pmenu);
00357 }
00358 <span class="comment">/***************************************************************************\</span>
00359 <span class="comment">* UnlockPopupMenu</span>
00360 <span class="comment">*</span>
00361 <span class="comment">* Unlocks a given menu from a popup strucuture and makes sure that the</span>
00362 <span class="comment">*  menu is no longer "owned" by the popup's notification window; if needed</span>
00363 <span class="comment">*</span>
00364 <span class="comment">* History:</span>
00365 <span class="comment">* 10/15/96 GerardoB  Created</span>
00366 <span class="comment">\***************************************************************************/</span>
<a name="l00367"></a><a class="code" href="../../d4/d1/userk_8h.html#a1361">00367</a> PVOID <a class="code" href="../../d4/d1/userk_8h.html#a1361">UnlockPopupMenu</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> * pspmenu)
00368 {
00369     <span class="comment">/*</span>
00370 <span class="comment">     * If you hit this assertion, you're probably not passing the right thing</span>
00371 <span class="comment">     */</span>
00372     UserAssert((pspmenu == &amp;ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>) || (pspmenu == &amp;ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>));
00373     <span class="comment">/*</span>
00374 <span class="comment">     * If nothing is locked, bail.</span>
00375 <span class="comment">     */</span>
00376     <span class="keywordflow">if</span> (*pspmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00377         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00378     }
00379 
00380     <span class="comment">/*</span>
00381 <span class="comment">     * This won't work properly if the popup already unlocked the notification</span>
00382 <span class="comment">     *  window. However, this can happen with the root popup if the</span>
00383 <span class="comment">     *  notification window gets destroyed while in menu mode.</span>
00384 <span class="comment">     */</span>
00385     UserAssert((ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || <a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopup));
00386 
00387     <span class="comment">/*</span>
00388 <span class="comment">     * When using modeless menus, menus can be shared by several active</span>
00389 <span class="comment">     *  popups/notification windows. If the menu has owner draw items,</span>
00390 <span class="comment">     *  the app better knows how to paint them right. It shouldn't</span>
00391 <span class="comment">     *  happen with modal menus though.</span>
00392 <span class="comment">     */</span>
00393 <span class="preprocessor">#if DBG</span>
00394 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((*pspmenu)-&gt;spwndNotify != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00395             &amp;&amp; (ppopup-&gt;spwndNotify != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00396             &amp;&amp; (ppopup-&gt;spwndNotify != (*pspmenu)-&gt;spwndNotify)) {
00397 
00398         RIPMSG3(RIP_WARNING, <span class="stringliteral">"UnlockPopupMenu: Menu %#p shared by %#p and %#p"</span>,
00399                 *pspmenu, (*pspmenu)-&gt;spwndNotify, ppopup-&gt;spwndNotify);
00400     }
00401 <span class="preprocessor">#endif</span>
00402 <span class="preprocessor"></span>
00403     <span class="comment">/*</span>
00404 <span class="comment">     * Unlock the menu's spwndNotify if needed</span>
00405 <span class="comment">     */</span>
00406     <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a9">UnlockPopupMenuWindow</a>(*pspmenu, ppopup-&gt;spwndNotify);
00407 
00408     <span class="comment">/*</span>
00409 <span class="comment">     * Unlock the menu from the popup structure</span>
00410 <span class="comment">     */</span>
00411     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(pspmenu);
00412 }
00413 <span class="comment">/***************************************************************************\</span>
00414 <span class="comment">* LockWndMenu</span>
00415 <span class="comment">*</span>
00416 <span class="comment">* Locks a given menu into a window structure and locks the window into</span>
00417 <span class="comment">*  the menu strucuture.</span>
00418 <span class="comment">*</span>
00419 <span class="comment">* History:</span>
00420 <span class="comment">* 10/15/96 GerardoB  Created</span>
00421 <span class="comment">\***************************************************************************/</span>
<a name="l00422"></a><a class="code" href="../../d4/d1/userk_8h.html#a1362">00422</a> PVOID <a class="code" href="../../d4/d1/userk_8h.html#a1362">LockWndMenu</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> * pspmenu, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu)
00423 {
00424     <span class="comment">/*</span>
00425 <span class="comment">     * If you hit this assertion, you're probably not passing the right thing</span>
00426 <span class="comment">     */</span>
00427     UserAssert((pspmenu == &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>) || (pspmenu == &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>));
00428 
00429     <span class="comment">/*</span>
00430 <span class="comment">     * If the current menu is owned by this window, unlock it</span>
00431 <span class="comment">     */</span>
00432     <span class="keywordflow">if</span> ((*pspmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; ((*pspmenu)-&gt;spwndNotify == pwnd)) {
00433         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;((*pspmenu)-&gt;spwndNotify));
00434     }
00435 
00436     <span class="comment">/*</span>
00437 <span class="comment">     * If nobody owns the new menu, make this window the owner</span>
00438 <span class="comment">     */</span>
00439     <span class="keywordflow">if</span> ((pmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00440         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, pwnd);
00441     }
00442 
00443     <span class="comment">/*</span>
00444 <span class="comment">     * Lock the menu into the window structure (unlock the previous menu)</span>
00445 <span class="comment">     */</span>
00446     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(pspmenu, pmenu);
00447 
00448 }
00449 <span class="comment">/***************************************************************************\</span>
00450 <span class="comment">* UnlockWndMenu</span>
00451 <span class="comment">*</span>
00452 <span class="comment">* Unlocks a given menu from a window strucutre and the window from the</span>
00453 <span class="comment">*  menu strucuture</span>
00454 <span class="comment">*</span>
00455 <span class="comment">* History:</span>
00456 <span class="comment">* 10/15/96 GerardoB  Created</span>
00457 <span class="comment">\***************************************************************************/</span>
<a name="l00458"></a><a class="code" href="../../d4/d1/userk_8h.html#a1363">00458</a> PVOID <a class="code" href="../../d4/d1/userk_8h.html#a1363">UnlockWndMenu</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> * pspmenu)
00459 {
00460     <span class="comment">/*</span>
00461 <span class="comment">     * If you hit this assertion, you're probably not passing the right thing</span>
00462 <span class="comment">     */</span>
00463     UserAssert((pspmenu == &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>) || (pspmenu == &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>));
00464 
00465     <span class="comment">/*</span>
00466 <span class="comment">     * If nothing is locked, bail</span>
00467 <span class="comment">     */</span>
00468     <span class="keywordflow">if</span> (*pspmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00469         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00470     }
00471 
00472     <span class="comment">/*</span>
00473 <span class="comment">     * If this window owns the menu, unlock it from the menu strucutre</span>
00474 <span class="comment">     */</span>
00475     <span class="keywordflow">if</span> (pwnd == (*pspmenu)-&gt;spwndNotify) {
00476         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;((*pspmenu)-&gt;spwndNotify));
00477     }
00478 
00479     <span class="comment">/*</span>
00480 <span class="comment">     * Unlock the menu from the window structure</span>
00481 <span class="comment">     */</span>
00482     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(pspmenu);
00483 }
00484 
00485 
00486 <span class="comment">/***************************************************************************\</span>
00487 <span class="comment">* MNSetTop</span>
00488 <span class="comment">*</span>
00489 <span class="comment">*  sets the first visible item in a scrollable menu to the given iNewTop;</span>
00490 <span class="comment">*  returns TRUE if iTop was changed; FALSE if iNewTop is already the</span>
00491 <span class="comment">*  first visible item</span>
00492 <span class="comment">*</span>
00493 <span class="comment">* 08/13/96 GerardoB Ported From Memphis.</span>
00494 <span class="comment">\***************************************************************************/</span>
<a name="l00495"></a><a class="code" href="../../d4/d1/userk_8h.html#a1365">00495</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1365">xxxMNSetTop</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup, <span class="keywordtype">int</span> iNewTop)
00496 {
00497     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>   pMenu = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>;
00498     <span class="keywordtype">int</span>     dy;
00499 
00500     <span class="keywordflow">if</span> (iNewTop &lt; 0) {
00501         iNewTop = 0;
00502     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iNewTop &gt; pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o15">iMaxTop</a>) {
00503         iNewTop = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o15">iMaxTop</a>;
00504     }
00505 
00506     <span class="comment">/*</span>
00507 <span class="comment">     * If no change, done</span>
00508 <span class="comment">     */</span>
00509     <span class="keywordflow">if</span> (iNewTop == pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a>) {
00510         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00511     }
00512 
00513 <span class="preprocessor">#if DBG</span>
00514 <span class="preprocessor"></span>    <span class="comment">/*</span>
00515 <span class="comment">     * We're going to scroll, so validate iMaxTop, cyMax and cyMenu</span>
00516 <span class="comment">     */</span>
00517     UserAssert((pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o11">cyMax</a> == 0) || (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o11">cyMax</a> &gt;= pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>));
00518     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o15">iMaxTop</a> &lt; pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) {
00519         <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pitemLast = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1;
00520         <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pitemMaxTop = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o15">iMaxTop</a>;
00521         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uHeight = pitemLast-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> + pitemLast-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a> - pitemMaxTop-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
00522         UserAssert(uHeight &lt;= pMenu-&gt;cyMenu);
00523         <span class="comment">/*</span>
00524 <span class="comment">         * Let's guess a max item height</span>
00525 <span class="comment">         */</span>
00526         UserAssert(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a> - uHeight &lt;= 2 * pitemLast-&gt;cyItem);
00527     } <span class="keywordflow">else</span> {
00528         UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o15">iMaxTop</a> &lt; pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>);
00529     }
00530 <span class="preprocessor">#endif</span>
00531 <span class="preprocessor"></span>
00532 
00533     <span class="comment">/*</span>
00534 <span class="comment">     * if we've made it this far, the new iTop WILL change -- thus if the</span>
00535 <span class="comment">     * current iTop is at the top it won't be after this change -- same goes</span>
00536 <span class="comment">     * for iTop at the bottom</span>
00537 <span class="comment">     */</span>
00538     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a761">MSA_ATTOP</a>) {
00539         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a760">MSA_ON</a>;
00540         <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o13">hbrBack</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00541             <a class="code" href="../../d4/d1/userk_8h.html#a1341">MNDrawArrow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ppopup, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a779">MFMWFP_UPARROW</a>);
00542         }
00543     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a762">MSA_ATBOTTOM</a>) {
00544         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a760">MSA_ON</a>;
00545         <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o13">hbrBack</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00546             <a class="code" href="../../d4/d1/userk_8h.html#a1341">MNDrawArrow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ppopup, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a780">MFMWFP_DOWNARROW</a>);
00547         }
00548     }
00549 
00550     UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iNewTop &lt; pMenu-&gt;cItems);
00551     dy = <a class="code" href="../../d4/d1/userk_8h.html#a1324">MNGetToppItem</a>(pMenu)-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> - (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + iNewTop)-&gt;yItem;
00552 
00553     <span class="keywordflow">if</span> ((dy &gt; 0 ? dy : -dy) &gt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>) {
00554         <a class="code" href="../../d4/d1/userk_8h.html#a1669">xxxInvalidateRect</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00555     } <span class="keywordflow">else</span> {
00556         <a class="code" href="../../d4/d1/userk_8h.html#a1426">xxxScrollWindowEx</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, 0, dy, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, SW_INVALIDATE | SW_ERASE);
00557     }
00558 
00559     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a> = iNewTop;
00560 
00561     <span class="keywordflow">if</span> (iNewTop == 0) {
00562         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a761">MSA_ATTOP</a>;
00563         <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o13">hbrBack</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00564             <a class="code" href="../../d4/d1/userk_8h.html#a1341">MNDrawArrow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ppopup, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a779">MFMWFP_UPARROW</a>);
00565         }
00566     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iNewTop == pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o15">iMaxTop</a>) {
00567         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a762">MSA_ATBOTTOM</a>;
00568         <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o13">hbrBack</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00569             <a class="code" href="../../d4/d1/userk_8h.html#a1341">MNDrawArrow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ppopup, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a780">MFMWFP_DOWNARROW</a>);
00570         }
00571     }
00572 
00573     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o13">hbrBack</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00574         <a class="code" href="../../d4/d1/userk_8h.html#a1340">MNDrawFullNC</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ppopup);
00575     }
00576 
00577     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00578 
00579 }
00580 
00581 <span class="comment">/***************************************************************************\</span>
00582 <span class="comment">* xxxMNDoScroll</span>
00583 <span class="comment">*</span>
00584 <span class="comment">*  scrolls a scrollable menu (ppopup) if the given position (uArrow) is one of</span>
00585 <span class="comment">*  the menu scroll arrows and sets a timer to auto-scroll when necessary;</span>
00586 <span class="comment">*  returns FALSE if the given position was not a menu scroll arrow; returns</span>
00587 <span class="comment">*  TRUE otherwise</span>
00588 <span class="comment">*</span>
00589 <span class="comment">* 08/13/96 GerardoB Ported From Memphis.</span>
00590 <span class="comment">\***************************************************************************/</span>
<a name="l00591"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a15">00591</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a15">xxxMNDoScroll</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup, UINT uArrow, BOOL fSetTimer)
00592 {
00593     <span class="keywordtype">int</span> iScrollTop = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a>;
00594 
00595     <span class="keywordflow">if</span> (uArrow == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a779">MFMWFP_UPARROW</a>) {
00596         iScrollTop--;
00597     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uArrow == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a780">MFMWFP_DOWNARROW</a>) {
00598         iScrollTop++;
00599     } <span class="keywordflow">else</span> {
00600         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00601     }
00602 
00603     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1365">xxxMNSetTop</a>(ppopup, iScrollTop)) {
00604         <span class="keywordflow">if</span> (!fSetTimer) {
00605             <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, uArrow);
00606         }
00607     } <span class="keywordflow">else</span> {
00608         <span class="comment">/*</span>
00609 <span class="comment">         * Set this timer just like we do in the scrollbar code:</span>
00610 <span class="comment">         * the first time we wait a little longer.</span>
00611 <span class="comment">         */</span>
00612         <a class="code" href="../../d4/d1/userk_8h.html#a1241">_SetTimer</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, uArrow,
00613                   (fSetTimer ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtScroll : <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtScroll / 4), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00614     }
00615 
00616     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00617 }
00618 
00619 <span class="comment">/***************************************************************************\</span>
00620 <span class="comment">* MNCheckScroll</span>
00621 <span class="comment">*</span>
00622 <span class="comment">*  checks to see if the given menu (pMenu) can be displayed in it's entirety</span>
00623 <span class="comment">*  or if it can't, in which case it sets the menu to be scrollable</span>
00624 <span class="comment">*</span>
00625 <span class="comment">* 08/13/96 GerardoB Ported From Memphis.</span>
00626 <span class="comment">\***************************************************************************/</span>
<a name="l00627"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a16">00627</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a16">MNCheckScroll</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor)
00628 {
00629     <span class="keywordtype">int</span>     i;
00630     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    cyMax;
00631     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>   pItem;
00632 
00633     <span class="comment">/*</span>
00634 <span class="comment">     * Max height that fits on the monitor</span>
00635 <span class="comment">     */</span>
00636     cyMax = (pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
00637 
00638     <span class="comment">/*</span>
00639 <span class="comment">     * If the menu has a valid max height, use it</span>
00640 <span class="comment">     */</span>
00641     <span class="keywordflow">if</span> ((pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o11">cyMax</a> != 0) &amp;&amp; (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o11">cyMax</a> &lt; cyMax)) {
00642         cyMax = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o11">cyMax</a>;
00643     }
00644 
00645     <span class="comment">/*</span>
00646 <span class="comment">     * Bail if menu is either empty, multicolumn, or able to fit</span>
00647 <span class="comment">     *   without scrolling</span>
00648 <span class="comment">     */</span>
00649     <span class="keywordflow">if</span> ((pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> == 0)
00650             || (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> != pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a>)
00651             || (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a> + (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME)) &lt;= cyMax))  {
00652 
00653         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a759">MSA_OFF</a>;
00654         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a> = 0;
00655         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o15">iMaxTop</a> = 0;
00656         <span class="keywordflow">return</span> pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>;
00657     }
00658 
00659     <span class="comment">/*</span>
00660 <span class="comment">     * Max client height</span>
00661 <span class="comment">     */</span>
00662     cyMax -= 2 * (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME) + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a144">gcyMenuScrollArrow</a>);
00663 
00664     <span class="comment">/*</span>
00665 <span class="comment">     * Determine the menu height</span>
00666 <span class="comment">     * Find the first item that won't fit.</span>
00667 <span class="comment">     */</span>
00668     pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>;
00669     <span class="keywordflow">for</span> (i = 0; i &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; i++, pItem++) {
00670         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> &gt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)cyMax) {
00671             <span class="keywordflow">break</span>;
00672         }
00673     }
00674     <span class="keywordflow">if</span> (i != 0) {
00675         pItem--;
00676     }
00677     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a> = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
00678 
00679     <span class="comment">/*</span>
00680 <span class="comment">     * compute the last possible top item when all remaining items are fully</span>
00681 <span class="comment">     * visible</span>
00682 <span class="comment">     */</span>
00683     cyMax = 0;
00684     i = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1;
00685     pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + i;
00686     <span class="keywordflow">for</span> (; i &gt;= 0; i--, pItem--) {
00687         cyMax += pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
00688         <span class="keywordflow">if</span> (cyMax &gt; pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>) {
00689             <span class="keywordflow">break</span>;
00690         }
00691     }
00692     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i != pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1) {
00693         i++;
00694     }
00695     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o15">iMaxTop</a> = i;
00696 
00697     <span class="comment">/*</span>
00698 <span class="comment">     * Update top item and scroll state</span>
00699 <span class="comment">     */</span>
00700     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a> &gt; i) {
00701         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a> = i;
00702     }
00703 
00704     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a> == i) {
00705         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a762">MSA_ATBOTTOM</a>;
00706     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a> == 0) {
00707         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a761">MSA_ATTOP</a>;
00708     } <span class="keywordflow">else</span> {
00709         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a760">MSA_ON</a>;
00710     }
00711 
00712     <span class="comment">/*</span>
00713 <span class="comment">     * This is funtion is called by MN_SIZEWINDOW which doesn't check</span>
00714 <span class="comment">     *  if the scroll bars are present but simply adds (2 * SYSMET(CYFIXEDFRAME))</span>
00715 <span class="comment">     *  to calculate the window height. So we add the scrollbars height</span>
00716 <span class="comment">     *  here. (I believe MN_SIZEWINDOW is a private-but-publicly-known message)</span>
00717 <span class="comment">     */</span>
00718     <span class="keywordflow">return</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a> + (2 * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a144">gcyMenuScrollArrow</a>));
00719 }
00720 
00721 <span class="comment">/***************************************************************************\</span>
00722 <span class="comment">* MNIsPopupItem</span>
00723 <span class="comment">*</span>
00724 <span class="comment">*</span>
00725 <span class="comment">\***************************************************************************/</span>
00726 
<a name="l00727"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a17">00727</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a17">MNIsPopupItem</a>(<a class="code" href="../../d0/d9/structtagITEM.html">ITEM</a> *lpItem)
00728 {
00729     <span class="keywordflow">return</span>((lpItem) &amp;&amp; (lpItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>) &amp;&amp;
00730         !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(lpItem, MFS_GRAYED));
00731 }
00732 
00733 <span class="comment">/***************************************************************************\</span>
00734 <span class="comment">* Validateppopupmenu</span>
00735 <span class="comment">*</span>
00736 <span class="comment">* 05-15-96 GerardoB  Created</span>
00737 <span class="comment">\***************************************************************************/</span>
00738 <span class="preprocessor">#if DBG</span>
00739 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a> (<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu)
00740 {
00741     UserAssert(ppopupmenu != NULL);
00742     <span class="keywordflow">try</span> {
00743         UserAssert(!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o18">fFreed</a>);
00744 
00745         <span class="comment">/*</span>
00746 <span class="comment">         * If this popup is being destroyed to soon, ppopupmenuRoot can be NULL</span>
00747 <span class="comment">         */</span>
00748          <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00749              <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> != ppopupmenu) {
00750                  <span class="comment">/*</span>
00751 <span class="comment">                  * This must be a hierarchical popup</span>
00752 <span class="comment">                  */</span>
00753                  UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a> != NULL);
00754                  UserAssert(!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> &amp;&amp; !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>);
00755                  <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>);
00756              } <span class="keywordflow">else</span> {
00757                  <span class="comment">/*</span>
00758 <span class="comment">                  * This must be the root popupmenu</span>
00759 <span class="comment">                  */</span>
00760                  UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a> == NULL);
00761                  UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> || ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>);
00762              }
00763          }
00764 
00765          <span class="comment">/*</span>
00766 <span class="comment">          * This can be NULL when called from xxxDeleteThreadInfo</span>
00767 <span class="comment">          */</span>
00768          <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00769              UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> == <a class="code" href="../../d4/d1/userk_8h.html#a99">RevalidateCatHwnd</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>)));
00770          }
00771 
00772          <span class="comment">/*</span>
00773 <span class="comment">          * This can be NULL when called from xxxDestroyWindow (spwndNotify)</span>
00774 <span class="comment">          *  or from xxxDeleteThreadInfo</span>
00775 <span class="comment">          */</span>
00776          <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00777              UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> == <a class="code" href="../../d4/d1/userk_8h.html#a99">RevalidateCatHwnd</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>)));
00778          }
00779 
00780     } except (W32ExceptionHandler(FALSE, RIP_ERROR)) {
00781         RIPMSG1(RIP_ERROR, <span class="stringliteral">"Validateppopupmenu: Invalid popup:%#p"</span>, ppopupmenu);
00782     }
00783 }
00784 <span class="preprocessor">#endif</span>
00785 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
00786 <span class="comment">* xxxSwitchToAlternateMenu</span>
00787 <span class="comment">*</span>
00788 <span class="comment">* Switches to the alternate popupmenu. Returns TRUE if we switch</span>
00789 <span class="comment">* else FALSE.</span>
00790 <span class="comment">*</span>
00791 <span class="comment">* History:</span>
00792 <span class="comment">* 05-25-91 Mikehar      Ported from Win3.1</span>
00793 <span class="comment">\***************************************************************************/</span>
00794 
<a name="l00795"></a><a class="code" href="../../d4/d1/userk_8h.html#a1370">00795</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1370">xxxMNSwitchToAlternateMenu</a>(
00796     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu)
00797 {
00798     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenuSwap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00799     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
00800     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndPopupMenu;
00801 
00802     <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> || !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>) {
00803         <span class="comment">/*</span>
00804 <span class="comment">         * Do nothing if no menu or not top level menu bar.</span>
00805 <span class="comment">         * ppopupmenu-&gt;spmenuAlternate can be NULL when an app has</span>
00806 <span class="comment">         *  either system menu or menu bar but not both. If that menu</span>
00807 <span class="comment">         *  has only one popup that it's not dropped, then hitting</span>
00808 <span class="comment">         *  VK_RIGHT or VK_LEFT causes xxxMNKeyDown to end up here.</span>
00809 <span class="comment">         * ppopupmenu-&gt;fIsMenuBar can be false when you drop the</span>
00810 <span class="comment">         *  system menu of an app with no menu bar; then hit VK_RIGHT</span>
00811 <span class="comment">         *  on an item that doesn't have a popup and you'll get here</span>
00812 <span class="comment">         * There might be some other situations like this; in any case</span>
00813 <span class="comment">         *  the assertion got to go</span>
00814 <span class="comment">         */</span>
00815         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00816     }
00817 
00818     <span class="comment">/*</span>
00819 <span class="comment">     * If we're getting out of menu mode, do nothing</span>
00820 <span class="comment">     */</span>
00821     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a>) {
00822         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00823     }
00824 
00825     <span class="comment">/*</span>
00826 <span class="comment">     * Select no items in the current menu.</span>
00827 <span class="comment">     */</span>
00828     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, &amp;tlpwndPopupMenu);
00829     UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00830     pMenuState = <a class="code" href="../../d4/d1/userk_8h.html#a1320">GetpMenuState</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>);
00831     <span class="keywordflow">if</span> (pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00832         RIPMSG0(RIP_ERROR, <span class="stringliteral">"xxxMNSwitchToAlternateMenu: pMenuState == NULL"</span>);
00833         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndPopupMenu);
00834         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00835     }
00836     <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>);
00837 
00838 
00839     UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> == ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>);
00840     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pmenuSwap, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>);
00841     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>);
00842     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, pmenuSwap);
00843     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pmenuSwap);
00844 
00845     <span class="comment">/*</span>
00846 <span class="comment">     * Set this global because it is used in SendMenuSelect()</span>
00847 <span class="comment">     */</span>
00848     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>)) {
00849         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o2">fIsSysMenu</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00850     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00851         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o2">fIsSysMenu</a> = (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a> ==
00852                 ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>);
00853     } <span class="keywordflow">else</span> {
00854         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o2">fIsSysMenu</a> = !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a149">MFSYSMENU</a>);
00855     }
00856 
00857     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o2">fIsSysMenu</a>;
00858 
00859     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00860         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUEND, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>,
00861             (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? OBJID_MENU : OBJID_SYSMENU), INDEXID_CONTAINER, 0);
00862         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUSTART, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>,
00863             (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? OBJID_SYSMENU : OBJID_MENU), INDEXID_CONTAINER, 0);
00864     }
00865 
00866     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndPopupMenu);
00867 
00868     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00869 }
00870 
00871 <span class="comment">/***************************************************************************\</span>
00872 <span class="comment">* MenuDestroyHandler</span>
00873 <span class="comment">*</span>
00874 <span class="comment">* cleans up after this menu</span>
00875 <span class="comment">*</span>
00876 <span class="comment">* History:</span>
00877 <span class="comment">* 05-25-91 Mikehar      Ported from Win3.1</span>
00878 <span class="comment">\***************************************************************************/</span>
00879 
<a name="l00880"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a19">00880</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a19">xxxMNDestroyHandler</a>(
00881     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu)
00882 {
00883     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00884     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
00885 
00886     <span class="keywordflow">if</span> (ppopupmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00887         <span class="comment">/*</span>
00888 <span class="comment">         * This can happen if WM_NCCREATE failed to allocate the ppopupmenu</span>
00889 <span class="comment">         * in xxxMenuWindowProc.</span>
00890 <span class="comment">         */</span>
00891         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxMNDestroyHandler: NULL \"ppopupmenu\""</span>);
00892         <span class="keywordflow">return</span>;
00893     }
00894 
00895 <span class="preprocessor">#if DBG</span>
00896 <span class="preprocessor"></span>    <span class="comment">/*</span>
00897 <span class="comment">     * When destroying a desktop's spwndMenu that is not in use (i.e., the</span>
00898 <span class="comment">     *  desktop is going away), the ppopupmenu is not exactly valid (i.e.,</span>
00899 <span class="comment">     *  we're not in menu mode) but it should be properly NULLed out so</span>
00900 <span class="comment">     *  everything should go smoothly</span>
00901 <span class="comment">     */</span>
00902     <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu);
00903 <span class="preprocessor">#endif</span>
00904 <span class="preprocessor"></span>
00905     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00906         <span class="comment">/*</span>
00907 <span class="comment">         * We used to send the message to spwndNextPopup here. The message should</span>
00908 <span class="comment">         *  go to the current popup so it'll close spwndNextPopup (not to the next</span>
00909 <span class="comment">         *  to close its next, if any).</span>
00910 <span class="comment">         * I don't see how the current spwndPopupMenu can be NULL but we better</span>
00911 <span class="comment">         *  handle it since we never accessed it before. This menu code is tricky...</span>
00912 <span class="comment">         */</span>
00913         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00914         UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00915         pwnd = (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> : ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>);
00916         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwndT);
00917         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, MN_CLOSEHIERARCHY, 0, 0);
00918         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00919     }
00920 
00921     <span class="keywordflow">if</span> ((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1325">MNIsItemSelected</a>(ppopupmenu))
00922     {
00923         <span class="comment">/*</span>
00924 <span class="comment">         * Unset the hilite bit on the hilited item.</span>
00925 <span class="comment">         */</span>
00926         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> &lt; ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) {
00927             <span class="comment">/*</span>
00928 <span class="comment">             * this extra check saves Ambiente 1.02 -- they have a menu with</span>
00929 <span class="comment">             * one item in it.  When that command is chosen, the app proceeds</span>
00930 <span class="comment">             * to remove that one item -- leaving us in the oh so strange state</span>
00931 <span class="comment">             * of having a valid hMenu with a NULL rgItems.</span>
00932 <span class="comment">             */</span>
00933             pItem = &amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>]);
00934             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp;= ~MFS_HILITE;
00935         }
00936     }
00937 
00938     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a>) {
00939         <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a55">IDSYS_MNSHOW</a>);
00940     }
00941 
00942     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o14">fHideTimer</a>) {
00943         <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a57">IDSYS_MNHIDE</a>);
00944     }
00945 
00946     <span class="comment">/*</span>
00947 <span class="comment">     * Send WM_UNINITMENUPOPUP so the menu owner can clean up.</span>
00948 <span class="comment">     */</span>
00949     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o21">fSendUninit</a>
00950             &amp;&amp; (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00951 
00952         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndT);
00953         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_UNINITMENUPOPUP,
00954                        (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>),
00955                         MAKELONG(0, (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? MF_SYSMENU: 0)));
00956         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00957     }
00958 
00959     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00960     <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a>) {
00961 
00962         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00963             ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>))-&gt;ppopupmenu = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00964         }
00965 
00966     }
00967 
00968     <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o16">fDelayedFree</a>) {
00969         <a class="code" href="../../d4/d1/userk_8h.html#a1394">MNFreePopup</a>(ppopupmenu);
00970     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00971         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o17">fFlushDelayedFree</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00972 <span class="preprocessor">        #if DBG</span>
00973 <span class="preprocessor"></span>        {
00974             <span class="comment">/*</span>
00975 <span class="comment">             * If this is not the rootpopup,</span>
00976 <span class="comment">             * assert that this popup is linked in the delayed free list</span>
00977 <span class="comment">             */</span>
00978             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopupmenu)) {
00979                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00980                 <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppm = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>;
00981                 <span class="keywordflow">while</span> (ppm-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00982                     <span class="keywordflow">if</span> (ppm-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a> == ppopupmenu) {
00983                         fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00984                         <span class="keywordflow">break</span>;
00985                     }
00986                     ppm = ppm-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>;
00987                 }
00988                 UserAssert(fFound);
00989             }
00990         }
00991 <span class="preprocessor">        #endif</span>
00992 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00993         UserAssertMsg1(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="stringliteral">"Leaking ppopupmenu:%p?"</span>, ppopupmenu);
00994     }
00995 
00996 }
00997 
00998 
00999 <span class="comment">/***************************************************************************\</span>
01000 <span class="comment">* MenuCharHandler</span>
01001 <span class="comment">*</span>
01002 <span class="comment">* Handles char messages for the given menu. This procedure is called</span>
01003 <span class="comment">* directly if the menu char is for the top level menu bar else it is called</span>
01004 <span class="comment">* by the menu window proc on behalf of the window that should process the</span>
01005 <span class="comment">* key.</span>
01006 <span class="comment">*</span>
01007 <span class="comment">* History:</span>
01008 <span class="comment">* 05-25-91 Mikehar      Ported from Win3.1</span>
01009 <span class="comment">\***************************************************************************/</span>
01010 
<a name="l01011"></a><a class="code" href="../../d4/d1/userk_8h.html#a1392">01011</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1392">xxxMNChar</a>(
01012     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu,
01013     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState,
01014     UINT character)
01015 {
01016     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu;
01017     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> flags;
01018     LRESULT result;
01019     <span class="keywordtype">int</span> item;
01020     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> matchType;
01021     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fExecute = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01022     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNotify;
01023 
01024     pMenu = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>;
01025 
01026     <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu);
01027 
01028     <span class="comment">/*</span>
01029 <span class="comment">     * If this comes in with a NULL pMenu, then we could have problems.</span>
01030 <span class="comment">     * This could happen if the xxxMNStartMenuState never gets called</span>
01031 <span class="comment">     * because the fInsideMenuLoop is set.</span>
01032 <span class="comment">     *</span>
01033 <span class="comment">     * This is placed in here temporarily until we can discover why</span>
01034 <span class="comment">     * this pMenu isn't set.  We will prevent the system from crashing</span>
01035 <span class="comment">     * in the meantime.</span>
01036 <span class="comment">     *</span>
01037 <span class="comment">     * HACK: ChrisWil</span>
01038 <span class="comment">     */</span>
01039     <span class="keywordflow">if</span> (pMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01040         UserAssert(pMenu);
01041         <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01042         <span class="keywordflow">return</span>;
01043     }
01044 
01045     <span class="comment">/*</span>
01046 <span class="comment">     * If we're getting out of menu mode, bail</span>
01047 <span class="comment">     */</span>
01048     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a>) {
01049         <span class="keywordflow">return</span>;
01050     }
01051 
01052     item = <a class="code" href="../../d4/d1/userk_8h.html#a1337">xxxMNFindChar</a>(pMenu, character,
01053             ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>, &amp;matchType);
01054     <span class="keywordflow">if</span> (item != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01055         <span class="keywordtype">int</span> item1;
01056         <span class="keywordtype">int</span> firstItem = item;
01057 
01058         <span class="comment">/*</span>
01059 <span class="comment">         * Find first ENABLED menu item with the given mnemonic 'character'</span>
01060 <span class="comment">         * !!!  If none found, exit menu loop  !!!</span>
01061 <span class="comment">         */</span>
01062         <span class="keywordflow">while</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[item].<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp; MFS_GRAYED) {
01063             item = <a class="code" href="../../d4/d1/userk_8h.html#a1337">xxxMNFindChar</a>(pMenu, character, item, &amp;matchType);
01064             <span class="keywordflow">if</span> (item == firstItem) {
01065                 <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01066                 <span class="keywordflow">return</span>;
01067             }
01068         }
01069         item1 = item;
01070 
01071         <span class="comment">/*</span>
01072 <span class="comment">         * Find next ENABLED menu item with the given mnemonic 'character'</span>
01073 <span class="comment">         * This is to see if we have a DUPLICATE MNEMONIC situation</span>
01074 <span class="comment">         */</span>
01075         <span class="keywordflow">do</span> {
01076             item = <a class="code" href="../../d4/d1/userk_8h.html#a1337">xxxMNFindChar</a>(pMenu, character, item, &amp;matchType);
01077         } <span class="keywordflow">while</span> ((pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[item].<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp; MFS_GRAYED) &amp;&amp; (item != firstItem));
01078 
01079         <span class="keywordflow">if</span> ((firstItem == item) || (item == item1))
01080             fExecute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01081 
01082         item = item1;
01083     }
01084 
01085     <span class="keywordflow">if</span> ((item == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) &amp;&amp; ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> &amp;&amp; (character == TEXT(<span class="charliteral">' '</span>))) {
01086 
01087         <span class="comment">/*</span>
01088 <span class="comment">         * Handle the case of the user cruising through the top level menu bar</span>
01089 <span class="comment">         * without any popups dropped.  We need to handle switching to and from</span>
01090 <span class="comment">         * the system menu.</span>
01091 <span class="comment">         */</span>
01092         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>) {
01093 
01094             <span class="comment">/*</span>
01095 <span class="comment">             * If we are on the system menu and user hits space, bring</span>
01096 <span class="comment">             * down thesystem menu.</span>
01097 <span class="comment">             */</span>
01098             item = 0;
01099             fExecute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01100         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01101 
01102             <span class="comment">/*</span>
01103 <span class="comment">             * We are not currently on the system menu but one exists.  So</span>
01104 <span class="comment">             * switch to it and bring it down.</span>
01105 <span class="comment">             */</span>
01106             item = 0;
01107             <span class="keywordflow">goto</span> SwitchToAlternate;
01108         }
01109     }
01110 
01111     <span class="keywordflow">if</span> ((item == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) &amp;&amp; ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> &amp;&amp; ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>) {
01112 
01113         <span class="comment">/*</span>
01114 <span class="comment">         * No matching item found on this top level menu (could be either the</span>
01115 <span class="comment">         * system menu or the menu bar).  We need to check the other menu.</span>
01116 <span class="comment">         */</span>
01117         item = <a class="code" href="../../d4/d1/userk_8h.html#a1337">xxxMNFindChar</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>,
01118                 character, 0, &amp;matchType);
01119 
01120         <span class="keywordflow">if</span> (item != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01121 SwitchToAlternate:
01122             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1370">xxxMNSwitchToAlternateMenu</a>(ppopupmenu)) {
01123                 <a class="code" href="../../d4/d1/userk_8h.html#a1392">xxxMNChar</a>(ppopupmenu, pMenuState, character);
01124             }
01125             <span class="keywordflow">return</span>;
01126         }
01127     }
01128 
01129     <span class="keywordflow">if</span> (item == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01130         flags = (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>) ? MF_SYSMENU : 0;
01131 
01132         <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
01133             flags |= MF_POPUP;
01134         }
01135 
01136         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndNotify);
01137         result = <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_MENUCHAR,
01138                 MAKELONG((WORD)character, (WORD)flags),
01139                 (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>));
01140         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
01141 
01142         <span class="keywordflow">switch</span> (HIWORD(result)) {
01143         <span class="keywordflow">case</span> MNC_IGNORE:
01144             <a class="code" href="../../d4/d1/userk_8h.html#a1730">xxxMessageBeep</a>(0);
01145             <span class="comment">/*</span>
01146 <span class="comment">             * If we're on the menu bar, cancel menu mode (fall through).</span>
01147 <span class="comment">             * We do this because you can really freak out an end user</span>
01148 <span class="comment">             *  who accidentally tapped the Alt key (causing us to go</span>
01149 <span class="comment">             *  into "invisible" menu mode) and now can't type anything!</span>
01150 <span class="comment">             */</span>
01151             <span class="keywordflow">if</span> (flags &amp; MF_POPUP) {
01152                 <span class="keywordflow">return</span>;
01153             }
01154             <span class="comment">/*</span>
01155 <span class="comment">             * Fall through.</span>
01156 <span class="comment">             */</span>
01157 
01158         <span class="keywordflow">case</span> MNC_CLOSE:
01159             <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01160             <span class="keywordflow">return</span>;
01161 
01162         <span class="keywordflow">case</span> MNC_EXECUTE:
01163             fExecute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01164             <span class="comment">/* fall thru */</span>
01165 
01166         <span class="keywordflow">case</span> MNC_SELECT:
01167             item = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(<span class="keywordtype">short</span>)LOWORD(result);
01168             <span class="keywordflow">if</span> ((WORD) item &gt;= ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)
01169             {
01170                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"Invalid item number returned from WM_MENUCHAR %#lx"</span>, result);
01171                 <span class="keywordflow">return</span>;
01172             }
01173             <span class="keywordflow">break</span>;
01174         }
01175     }
01176 
01177     <span class="keywordflow">if</span> (item != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01178         <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, item);
01179 
01180         <span class="keywordflow">if</span> (fExecute)
01181             <a class="code" href="../../d4/d1/userk_8h.html#a1372">xxxMNKeyDown</a>(ppopupmenu, pMenuState, VK_RETURN);
01182     }
01183 }
01184 
01185 <span class="comment">/***************************************************************************\</span>
01186 <span class="comment">*</span>
01187 <span class="comment">*  GetMenuInheritedContextHelpId(PPOPUPMENU  ppopup)</span>
01188 <span class="comment">* Given a ppopup, this function will see if that menu has a context help</span>
01189 <span class="comment">*  id and return it. If it does not have a context help id, it will look up</span>
01190 <span class="comment">*  in the parent menu, parent of the parent etc., all the way to the top</span>
01191 <span class="comment">*  top level menu bar till it finds a context help id and returns it. If no</span>
01192 <span class="comment">*  context help id is found, it returns a zero.</span>
01193 <span class="comment">*</span>
01194 <span class="comment">\***************************************************************************/</span>
01195 
<a name="l01196"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a21">01196</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a21">GetMenuInheritedContextHelpId</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>  ppopup)
01197 {
01198   <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pWnd;
01199 
01200   <span class="comment">/*</span>
01201 <span class="comment">   * If we are already at the menubar, simply return it's ContextHelpId</span>
01202 <span class="comment">   */</span>
01203   UserAssert(ppopup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01204   <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>)
01205       <span class="keywordflow">goto</span> Exit_GMI;
01206 
01207   <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01208       UserAssert(ppopup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01209 
01210       <span class="comment">/*</span>
01211 <span class="comment">       * See if the given popup has a context help id.</span>
01212 <span class="comment">       */</span>
01213       <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o10">dwContextHelpId</a>) {
01214           <span class="comment">/* Found the context Id */</span>
01215           <span class="keywordflow">break</span>;
01216       }
01217 
01218       <span class="comment">/*</span>
01219 <span class="comment">       * Get the previous popup menu;</span>
01220 <span class="comment">       * Check if the previous menu is the menu bar.</span>
01221 <span class="comment">       */</span>
01222       <span class="keywordflow">if</span> (  (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a>) &amp;&amp;
01223             (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a> == ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>)) {
01224 
01225           ppopup = ppopup -&gt; ppopupmenuRoot;
01226           <span class="keywordflow">break</span>;
01227       } <span class="keywordflow">else</span> {
01228           <span class="comment">/*</span>
01229 <span class="comment">           * See if this has a valid prevPopup; (it could be TrackPopup menu)</span>
01230 <span class="comment">           */</span>
01231           <span class="keywordflow">if</span> ((pWnd = ppopup -&gt; spwndPrevPopup) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01232               <span class="keywordflow">return</span> ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0);
01233           }
01234 
01235           ppopup = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pWnd)-&gt;ppopupmenu;
01236       }
01237   }
01238 
01239 Exit_GMI:
01240   <span class="keywordflow">return</span>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o10">dwContextHelpId</a>);
01241 }
01242 
01243 <span class="comment">/***************************************************************************\</span>
01244 <span class="comment">* void MenuKeyDownHandler(PPOPUPMENU ppopupmenu, UINT key)</span>
01245 <span class="comment">* effects: Handles a keydown for the given menu.</span>
01246 <span class="comment">*</span>
01247 <span class="comment">* History:</span>
01248 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
01249 <span class="comment">\***************************************************************************/</span>
01250 
<a name="l01251"></a><a class="code" href="../../d4/d1/userk_8h.html#a1372">01251</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1372">xxxMNKeyDown</a>(
01252     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu,
01253     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState,
01254     UINT key)
01255 {
01256     LRESULT dwMDIMenu;
01257     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> item;
01258     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fHierarchyWasDropped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01259     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
01260     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupSave;
01261     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bFakedKey;
01262     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> keyOrig = key;
01263 
01264     <span class="comment">/*</span>
01265 <span class="comment">     * Blow off keyboard if mouse down.</span>
01266 <span class="comment">     */</span>
01267     <span class="keywordflow">if</span> ((pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) &amp;&amp; (key != VK_F1)) {
01268         <span class="comment">/*</span>
01269 <span class="comment">         * Check if the user wants to cancel dragging.</span>
01270 <span class="comment">         */</span>
01271         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o8">fDragging</a> &amp;&amp; (key == VK_ESCAPE)) {
01272             RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxMNKeyDown: ESC while dragging"</span>);
01273             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o14">fIgnoreButtonUp</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01274         }
01275 
01276         <span class="keywordflow">return</span>;
01277     }
01278 
01279     <span class="keywordflow">switch</span> (key) {
01280     <span class="keywordflow">case</span> VK_MENU:
01281     <span class="keywordflow">case</span> VK_F10:
01282     {
01283         <span class="comment">/*</span>
01284 <span class="comment">         * Modeless don't go away when the menu key is hit. They just</span>
01285 <span class="comment">         *  ignore it.</span>
01286 <span class="comment">         */</span>
01287         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
01288             <span class="keywordflow">return</span>;
01289         }
01290 
01291         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a101">gwinOldAppHackoMaticFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a491">WOAHACK_CHECKALTKEYSTATE</a>) {
01292 
01293             <span class="comment">/*</span>
01294 <span class="comment">             * Winoldapp is telling us to put up/down the system menu.  Due to</span>
01295 <span class="comment">             * possible race conditions, we need to check the state of the alt</span>
01296 <span class="comment">             * key before throwing away the menu.</span>
01297 <span class="comment">             */</span>
01298             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a101">gwinOldAppHackoMaticFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a492">WOAHACK_IGNOREALTKEYDOWN</a>) {
01299                 <span class="keywordflow">return</span>;
01300             }
01301         }
01302         <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01303 
01304         <span class="comment">/*</span>
01305 <span class="comment">         * We're going to exit menu mode but the ALT key is down, so clear</span>
01306 <span class="comment">         *  pMenuState-&gt;fUnderline to cause xxxMNLoop not to erase the underlines</span>
01307 <span class="comment">         */</span>
01308         <span class="keywordflow">if</span> (key == VK_MENU) {
01309             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o6">fUnderline</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01310         }
01311     }
01312         <span class="keywordflow">return</span>;
01313 
01314     <span class="keywordflow">case</span> VK_ESCAPE:
01315 
01316         <span class="comment">/*</span>
01317 <span class="comment">         * Escape key was hit.  Get out of one level of menus.  If no active</span>
01318 <span class="comment">         * popups or we are minimized and there are no active popups below</span>
01319 <span class="comment">         * this, we need to get out of menu mode.  Otherwise, we popup up</span>
01320 <span class="comment">         * one level in the hierarchy.</span>
01321 <span class="comment">         */</span>
01322         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> ||
01323                 ppopupmenu == ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> ||
01324                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
01325             <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01326         } <span class="keywordflow">else</span> {
01327             <span class="comment">/*</span>
01328 <span class="comment">             * Pop back one level of menus.</span>
01329 <span class="comment">             */</span>
01330             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a> &amp;&amp;
01331                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a> == ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>) {
01332 
01333                 <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenuRoot = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>;
01334 
01335                 ppopupmenuRoot-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o10">fDropNextPopup</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01336 
01337 <span class="preprocessor">#if 0</span>
01338 <span class="preprocessor"></span>                <span class="comment">/*</span>
01339 <span class="comment">                 * We are on a menu bar hierarchy and there is only one popup</span>
01340 <span class="comment">                 * visible.  We have to cancel this popup and put focus back on</span>
01341 <span class="comment">                 * the menu bar.</span>
01342 <span class="comment">                 */</span>
01343                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a748">_IsIconic</a>(ppopupmenuRoot-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>)) {
01344 
01345                     <span class="comment">/*</span>
01346 <span class="comment">                     * However, if we are iconic there really is no menu</span>
01347 <span class="comment">                     * bar so let's make it easier for users and get out</span>
01348 <span class="comment">                     * of menu mode completely.</span>
01349 <span class="comment">                     */</span>
01350                     <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01351                 } <span class="keywordflow">else</span>
01352 <span class="preprocessor">#endif</span>
01353 <span class="preprocessor"></span>                    <span class="comment">/*</span>
01354 <span class="comment">                     * If the popup is closed, a modeless menu won't</span>
01355 <span class="comment">                     *  have a window to get the keys. So modeless menu</span>
01356 <span class="comment">                     *  cancel the menu at this point. Modal menus go</span>
01357 <span class="comment">                     *  to the menu bar.</span>
01358 <span class="comment">                     */</span>
01359                     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
01360                         <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01361                     } <span class="keywordflow">else</span> {
01362                         <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupmenuRoot, pMenuState);
01363                     }
01364             } <span class="keywordflow">else</span> {
01365                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a>, &amp;tlpwndT);
01366                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a>, MN_CLOSEHIERARCHY,
01367                         0, 0);
01368                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01369             }
01370         }
01371         <span class="keywordflow">return</span>;
01372 
01373     <span class="keywordflow">case</span> VK_UP:
01374     <span class="keywordflow">case</span> VK_DOWN:
01375         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
01376 
01377             <span class="comment">/*</span>
01378 <span class="comment">             * If we are on the top level menu bar, try to open the popup if</span>
01379 <span class="comment">             * possible.</span>
01380 <span class="comment">             */</span>
01381             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(ppopupmenu, pMenuState) == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)-1)
01382                 <span class="keywordflow">return</span>;
01383         } <span class="keywordflow">else</span> {
01384             item = <a class="code" href="../../d4/d1/userk_8h.html#a1384">MNFindNextValidItem</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>,
01385                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>, (key == VK_UP ? -1 : 1), 0);
01386             <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, item);
01387         }
01388         <span class="keywordflow">return</span>;
01389 
01390     <span class="keywordflow">case</span> VK_LEFT:
01391     <span class="keywordflow">case</span> VK_RIGHT:
01392 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01393 <span class="preprocessor"></span>            bFakedKey = (!!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o22">fRtoL</a>) ^ (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, WEFLAYOUTRTL));
01394 <span class="preprocessor">#else</span>
01395 <span class="preprocessor"></span>            bFakedKey = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o22">fRtoL</a>;
01396 <span class="preprocessor">#endif</span>
01397 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (bFakedKey)
01398             <span class="comment">/*</span>
01399 <span class="comment">             * turn the keys around, we drew the menu backwards.</span>
01400 <span class="comment">             */</span>
01401             key = (key == VK_LEFT) ? VK_RIGHT : VK_LEFT;
01402         <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> &amp;&amp; (key == VK_RIGHT) &amp;&amp;
01403                 !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>) {
01404             <span class="comment">/*</span>
01405 <span class="comment">             * Try to open the hierarchy at this item if there is one.</span>
01406 <span class="comment">             */</span>
01407             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(ppopupmenu, pMenuState) == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)-1)
01408                 <span class="keywordflow">return</span>;
01409             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a>) {
01410                 <span class="keywordflow">return</span>;
01411             }
01412         }
01413 
01414         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>) {
01415             fHierarchyWasDropped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01416             <span class="keywordflow">if</span> ((key == VK_LEFT) &amp;&amp; !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
01417                 <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupmenu, pMenuState);
01418                 <span class="keywordflow">return</span>;
01419             }
01420         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o10">fDropNextPopup</a>)
01421             fHierarchyWasDropped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01422 
01423         ppopupSave = ppopupmenu;
01424 
01425         item = <a class="code" href="../../d4/d1/userk_8h.html#a1338">MNFindItemInColumn</a>(ppopupmenu-&gt;spmenu,
01426                 ppopupmenu-&gt;posSelectedItem,
01427                 (key == VK_LEFT ? -1 : 1),
01428                 (ppopupmenu-&gt;fHasMenuBar &amp;&amp;
01429                 ppopupmenu == ppopupmenu-&gt;ppopupmenuRoot));
01430 
01431         <span class="keywordflow">if</span> (item == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01432 
01433             <span class="comment">/*</span>
01434 <span class="comment">             * No valid item found in the given direction so send it up to our</span>
01435 <span class="comment">             * parent to handle.</span>
01436 <span class="comment">             */</span>
01437             <span class="keywordflow">if</span> (ppopupmenu-&gt;fHasMenuBar &amp;&amp;
01438                     ppopupmenu-&gt;spwndPrevPopup == ppopupmenu-&gt;spwndNotify) {
01439 
01440                 <span class="comment">/*</span>
01441 <span class="comment">                 * if we turned the key round, then turn it back again.</span>
01442 <span class="comment">                 */</span>
01443                 <span class="keywordflow">if</span> (bFakedKey)
01444                     key = (key == VK_LEFT) ? VK_RIGHT : VK_LEFT;
01445                 <span class="comment">/*</span>
01446 <span class="comment">                 * Go to next/prev item in menu bar since a popup was down and</span>
01447 <span class="comment">                 * no item on the popup to go to.</span>
01448 <span class="comment">                 */</span>
01449                 <a class="code" href="../../d4/d1/userk_8h.html#a1372">xxxMNKeyDown</a>(ppopupmenu-&gt;ppopupmenuRoot, pMenuState, key);
01450                 <span class="keywordflow">return</span>;
01451             }
01452 
01453             <span class="keywordflow">if</span> (ppopupmenu == ppopupmenu-&gt;ppopupmenuRoot) {
01454                 <span class="keywordflow">if</span> (!ppopupmenu-&gt;fIsMenuBar) {
01455 
01456                     <span class="comment">/*</span>
01457 <span class="comment">                     * No menu bar associated with this menu so do nothing.</span>
01458 <span class="comment">                     */</span>
01459                     <span class="keywordflow">return</span>;
01460                 }
01461             } <span class="keywordflow">else</span> {
01462                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;spwndPrevPopup, &amp;tlpwndT);
01463                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;spwndPrevPopup, WM_KEYDOWN, keyOrig, 0);
01464                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01465                 <span class="keywordflow">return</span>;
01466             }
01467         }
01468 
01469         <span class="keywordflow">if</span> (!ppopupmenu-&gt;fIsMenuBar) {
01470             <span class="keywordflow">if</span> (item != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01471                 <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, item);
01472             }
01473             <span class="keywordflow">return</span>;
01474 
01475         } <span class="keywordflow">else</span> {
01476 
01477             <span class="comment">/*</span>
01478 <span class="comment">             * Special handling if keydown occurred on a menu bar.</span>
01479 <span class="comment">             */</span>
01480             <span class="keywordflow">if</span> (item == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01481 
01482                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopupmenu-&gt;spwndNotify, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>)) {
01483                     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01484                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndNextMenu;
01485                     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>   pmenuNextMenu, pmenuUse;
01486                     MDINEXTMENU mnm;
01487                     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenuNextMenu;
01488                     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNextMenu;
01489 
01490                     mnm.hmenuIn = (HMENU)0;
01491                     mnm.hmenuNext = (HMENU)0;
01492                     mnm.hwndNext = (HWND)0;
01493 
01494                     <span class="comment">/*</span>
01495 <span class="comment">                     * We are in the menu bar and need to go up to the system menu</span>
01496 <span class="comment">                     * or go from the system menu to the menu bar.</span>
01497 <span class="comment">                     */</span>
01498                     pmenuNextMenu = ppopupmenu-&gt;fIsSysMenu ?
01499                         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a15">_GetSubMenu</a>(ppopupmenu-&gt;spmenu, 0) :
01500                         ppopupmenu-&gt;spmenu;
01501                     mnm.hmenuIn = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pmenuNextMenu);
01502                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;spwndNotify, &amp;tlpwndT);
01503                     dwMDIMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;spwndNotify,
01504                         WM_NEXTMENU, (WPARAM)keyOrig, (LPARAM)&amp;mnm);
01505                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01506 
01507                     pwndNextMenu = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(mnm.hwndNext);
01508                     <span class="keywordflow">if</span> (pwndNextMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01509                         <span class="keywordflow">goto</span> TryAlternate;
01510 
01511                     <span class="comment">/*</span>
01512 <span class="comment">                     * If this window belongs to another thread, we cannot</span>
01513 <span class="comment">                     *  use it. The menu loop won't get any messages</span>
01514 <span class="comment">                     *  directed to that thread.</span>
01515 <span class="comment">                     */</span>
01516                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNextMenu) != ptiCurrent) {
01517                         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxMNKeyDown: Ignoring mnm.hwndNext bacause it belongs to another thread: %#p"</span>, pwndNextMenu);
01518                         <span class="keywordflow">goto</span> TryAlternate;
01519                     }
01520 
01521 
01522                     pmenuNextMenu = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a441">RevalidateHmenu</a>(mnm.hmenuNext);
01523                     <span class="keywordflow">if</span> (pmenuNextMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01524                         <span class="keywordflow">goto</span> TryAlternate;
01525 
01526                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pmenuNextMenu, &amp;tlpmenuNextMenu);
01527                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndNextMenu, &amp;tlpwndNextMenu);
01528 
01529                     <span class="comment">/*</span>
01530 <span class="comment">                     * If the system menu is for a minimized MDI child,</span>
01531 <span class="comment">                     * make sure the menu is dropped to give the user a</span>
01532 <span class="comment">                     * visual clue that they are in menu mode</span>
01533 <span class="comment">                     */</span>
01534                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNextMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
01535                         fHierarchyWasDropped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01536 
01537                     <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>);
01538 
01539                     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o2">fIsSysMenu</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01540                     <a class="code" href="../../d4/d1/userk_8h.html#a1361">UnlockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;spmenuAlternate);
01541                     ppopupmenu-&gt;fToggle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01542                     <span class="comment">/*</span>
01543 <span class="comment">                     * GetSystemMenu(pwnd, FALSE) and pwnd-&gt;spmenuSys are</span>
01544 <span class="comment">                     * NOT equivalent -- GetSystemMenu returns the 1st submenu</span>
01545 <span class="comment">                     * of pwnd-&gt;spmenuSys -- make up for that here</span>
01546 <span class="comment">                     */</span>
01547                     pmenuUse = (((pwndNextMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01548                                     &amp;&amp; (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a15">_GetSubMenu</a>(pwndNextMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>, 0) == pmenuNextMenu))
01549                                ? pwndNextMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>
01550                                : pmenuNextMenu);
01551                     <span class="comment">/*</span>
01552 <span class="comment">                     * We're going to change the notification window AND the menu.</span>
01553 <span class="comment">                     * LockPopupMenu needs to unlock the current pmenu-spwndNotify</span>
01554 <span class="comment">                     *  but also lock the new pmenu-spwndNotify. Since we cannot</span>
01555 <span class="comment">                     *  give it the current AND the new pair, we unlock the</span>
01556 <span class="comment">                     *  current one first, switch the notification window and</span>
01557 <span class="comment">                     *  then call LockPopupMenu to lock the new pmenu-spwndNotify.</span>
01558 <span class="comment">                     */</span>
01559                     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopupmenu));
01560                     <a class="code" href="../../d4/d1/userk_8h.html#a1361">UnlockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;spmenu);
01561                     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ppopupmenu-&gt;spwndNotify, pwndNextMenu);
01562                     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ppopupmenu-&gt;spwndPopupMenu, pwndNextMenu);
01563                     <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;spmenu, pmenuUse);
01564                     <span class="comment">/*</span>
01565 <span class="comment">                     * We just switched to a new notification window so</span>
01566 <span class="comment">                     *  we need to Adjust capture accordingly</span>
01567 <span class="comment">                     */</span>
01568                     <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
01569                         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>;
01570                         <a class="code" href="../../d4/d1/userk_8h.html#a1356">xxxMNSetCapture</a>(ppopupmenu);
01571                     }
01572 
01573 
01574                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNextMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) &amp;&amp;
01575                             ppopupmenu-&gt;spmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01576 
01577                         <span class="comment">/*</span>
01578 <span class="comment">                         * This window has a system menu and a main menu bar</span>
01579 <span class="comment">                         * Set the alternate menu to the appropriate menu</span>
01580 <span class="comment">                         */</span>
01581                         <span class="keywordflow">if</span> (pwndNextMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> == ppopupmenu-&gt;spmenu) {
01582                             <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;spmenuAlternate,
01583                                     pwndNextMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>);
01584                             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o2">fIsSysMenu</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01585                         } <span class="keywordflow">else</span> {
01586                             <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupmenu, &amp;ppopupmenu-&gt;spmenuAlternate,
01587                                     pwndNextMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
01588                         }
01589                     }
01590 
01591                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNextMenu);
01592                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenuNextMenu);
01593 
01594                     ppopupmenu-&gt;fIsSysMenu = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o2">fIsSysMenu</a>;
01595 
01596                     item = 0;
01597                 } <span class="keywordflow">else</span>
01598 TryAlternate:
01599                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1370">xxxMNSwitchToAlternateMenu</a>(ppopupmenu)) {
01600                         <span class="comment">/*</span>
01601 <span class="comment">                         * go to first or last menu item int ppopup-&gt;hMenu</span>
01602 <span class="comment">                         * based on 'key'</span>
01603 <span class="comment">                         */</span>
01604                     <span class="keywordtype">int</span> <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a> = (key == VK_RIGHT) ? 1 : -1;
01605 
01606                     item = <a class="code" href="../../d4/d1/userk_8h.html#a1384">MNFindNextValidItem</a>(ppopupmenu-&gt;spmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>, <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a>, 0);
01607                 }
01608             }
01609 
01610             <span class="keywordflow">if</span> (item != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01611                 <span class="comment">/*</span>
01612 <span class="comment">                 * we found a new menu item to go to</span>
01613 <span class="comment">                 * 1) close up the previous menu if it was dropped</span>
01614 <span class="comment">                 * 2) select the new menu item to go to</span>
01615 <span class="comment">                 * 3) drop the new menu if the previous menu was dropped</span>
01616 <span class="comment">                 */</span>
01617 
01618                 <span class="keywordflow">if</span> (ppopupSave-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>)
01619                     <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupSave, pMenuState);
01620 
01621                 <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, item);
01622 
01623                 <span class="keywordflow">if</span> (fHierarchyWasDropped) {
01624 DropHierarchy:
01625                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(ppopupmenu, pMenuState) == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)-1) {
01626                         <span class="keywordflow">return</span>;
01627                     }
01628                 }
01629             }
01630         }
01631         <span class="keywordflow">return</span>;
01632 
01633     <span class="keywordflow">case</span> VK_RETURN:
01634         {
01635         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fEnabled;
01636         <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
01637 
01638         <span class="keywordflow">if</span> (ppopupmenu-&gt;posSelectedItem &gt;= ppopupmenu-&gt;spmenu-&gt;cItems) {
01639             <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01640             <span class="keywordflow">return</span>;
01641         }
01642 
01643         pItem = ppopupmenu-&gt;spmenu-&gt;rgItems + ppopupmenu-&gt;posSelectedItem;
01644         fEnabled = !(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp; MFS_GRAYED);
01645         <span class="keywordflow">if</span> ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; fEnabled)
01646             <span class="keywordflow">goto</span> DropHierarchy;
01647 
01648         <span class="comment">/*</span>
01649 <span class="comment">         * If no item is selected, throw away menu and return.</span>
01650 <span class="comment">         */</span>
01651         <span class="keywordflow">if</span> (fEnabled) {
01652             <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a3">xxxMNDismissWithNotify</a>(pMenuState, ppopupmenu-&gt;spmenu, pItem, ppopupmenu-&gt;posSelectedItem, 0);
01653         } <span class="keywordflow">else</span> {
01654             <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
01655         }
01656         <span class="keywordflow">return</span>;
01657         }
01658 
01659     <span class="keywordflow">case</span> VK_F1: <span class="comment">/* Provide context sensitive help. */</span>
01660         {
01661         <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
01662 
01663         pItem = ppopupmenu-&gt;spmenu-&gt;rgItems + ppopupmenu-&gt;posSelectedItem;
01664         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;spwndNotify, &amp;tlpwndT);
01665         <a class="code" href="../../d4/d1/userk_8h.html#a1102">xxxSendHelpMessage</a>(ppopupmenu-&gt;spwndNotify, HELPINFO_MENUITEM, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o2">wID</a>,
01666                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(ppopupmenu-&gt;spmenu),
01667                 <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a21">GetMenuInheritedContextHelpId</a>(ppopupmenu));
01668         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01669         <span class="keywordflow">break</span>;
01670         }
01671 
01672     }
01673 }
01674 <span class="comment">/***************************************************************************\</span>
01675 <span class="comment">* xxxMNPositionHierarchy</span>
01676 <span class="comment">*</span>
01677 <span class="comment">* Calculates the x.y postion to drop a hierarchy and returns the direction</span>
01678 <span class="comment">*  to be used when animating (PAS_* value)</span>
01679 <span class="comment">*</span>
01680 <span class="comment">* 11/19/96  GerardoB  Extracted from xxxMNOpenHierarchy</span>
01681 <span class="comment">\***************************************************************************/</span>
01682 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>
<a name="l01683"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a23">01683</a> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a23">xxxMNPositionHierarchy</a>(
01684         <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>  ppopup,
01685         <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>       pitem,
01686         <span class="keywordtype">int</span>         cx,
01687         <span class="keywordtype">int</span>         cy,
01688         <span class="keywordtype">int</span>         *px,
01689         <span class="keywordtype">int</span>         *py,
01690         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    *ppMonitor)
01691 {
01692     <span class="keywordtype">int</span>         x, y;
01693     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        uPAS;
01694     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
01695 
01696     UserAssert(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a> &amp;&amp; (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
01697 
01698     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
01699         <span class="comment">/*</span>
01700 <span class="comment">         * This is a menu being dropped from the top menu bar.  We need to</span>
01701 <span class="comment">         * position it differently than hierarchicals which are dropped from</span>
01702 <span class="comment">         * another popup.</span>
01703 <span class="comment">         */</span>
01704 
01705         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIconic = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) != 0);
01706         RECT rcWindow;
01707 
01708         <span class="comment">/*</span>
01709 <span class="comment">         * Menu bar popups animate down.</span>
01710 <span class="comment">         */</span>
01711         uPAS = <a class="code" href="../../d4/d1/userk_8h.html#a539">PAS_DOWN</a>;
01712 
01713         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcWindow, &amp;ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
01714         <span class="keywordflow">if</span> (fIconic &amp;&amp; <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>)) {
01715             <a class="code" href="../../d4/d1/userk_8h.html#a1866">xxxSendMinRectMessages</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, &amp;rcWindow);
01716         }
01717 
01718         <span class="comment">/*</span>
01719 <span class="comment">         * x position</span>
01720 <span class="comment">         */</span>
01721         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MENUDROPALIGNMENT) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>)) {
01722             <span class="keywordflow">if</span> (fIconic) {
01723                 x = rcWindow.left;
01724             } <span class="keywordflow">else</span> {
01725                 x = rcWindow.left + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a>;
01726             }
01727         } <span class="keywordflow">else</span> {
01728             ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o4">fDroppedLeft</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01729             <span class="keywordflow">if</span> (fIconic) {
01730                 x = rcWindow.right - cx;
01731             } <span class="keywordflow">else</span> {
01732                 x = rcWindow.left + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> - cx;
01733             }
01734         }
01735 
01736         <span class="comment">/*</span>
01737 <span class="comment">         * For a menu bar dropdown, pin to the monitor that owns the</span>
01738 <span class="comment">         * majority of the menu item.  Otherwise, pin to the monitor that</span>
01739 <span class="comment">         * owns the minimized window (the tray rect for min-to-tray dudes).</span>
01740 <span class="comment">         */</span>
01741         <span class="keywordflow">if</span> (!fIconic)
01742         {
01743             <span class="comment">/*</span>
01744 <span class="comment">             * Use rcWindow as scratch for the menu bar item rect.  We want</span>
01745 <span class="comment">             * to pin this menu on whatever monitor owns most of the menu</span>
01746 <span class="comment">             * item clicked on.</span>
01747 <span class="comment">             */</span>
01748             rcWindow.left += pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a>;
01749             rcWindow.top  += pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
01750             rcWindow.right = rcWindow.left + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
01751             rcWindow.bottom = rcWindow.top + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
01752         }
01753 
01754         pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;rcWindow, MONITOR_DEFAULTTOPRIMARY);
01755 
01756         <span class="comment">/*</span>
01757 <span class="comment">         * y position</span>
01758 <span class="comment">         */</span>
01759         <span class="keywordflow">if</span> (!fIconic) {
01760             y = rcWindow.bottom;
01761         } <span class="keywordflow">else</span> {
01762             <span class="comment">/*</span>
01763 <span class="comment">             * If the window is iconic, pop the menu up.  Since we're</span>
01764 <span class="comment">             * minimized, the sysmenu button doesn't really exist.</span>
01765 <span class="comment">             */</span>
01766             y = rcWindow.top - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01767             <span class="keywordflow">if</span> (y &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top) {
01768                 y = rcWindow.bottom;
01769             }
01770         }
01771 
01772         <span class="comment">/*</span>
01773 <span class="comment">         * Make sure the menu doesn't go off right side of monitor</span>
01774 <span class="comment">         */</span>
01775         x = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(x, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - cx);
01776 
01777 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01778 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, WEFLAYOUTRTL)) {
01779             x = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - x + ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left - cx;
01780         }
01781 <span class="preprocessor">#endif</span>
01782 <span class="preprocessor"></span>
01783     } <span class="keywordflow">else</span> { <span class="comment">/* if (ppopup-&gt;fIsMenuBar) */</span>
01784 
01785         <span class="comment">/* Now position the hierarchical menu window.</span>
01786 <span class="comment">         * We want to overlap by the amount of the frame, to help in the</span>
01787 <span class="comment">         * 3D illusion.</span>
01788 <span class="comment">         */</span>
01789 
01790         <span class="comment">/*</span>
01791 <span class="comment">         * By default, hierachical popups animate to the right</span>
01792 <span class="comment">         */</span>
01793         uPAS = <a class="code" href="../../d4/d1/userk_8h.html#a537">PAS_RIGHT</a>;
01794         x = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
01795 
01796         <span class="comment">/* Note that we DO want the selections in the item and its popup to</span>
01797 <span class="comment">         * align horizontally.</span>
01798 <span class="comment">         */</span>
01799         y = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top + pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
01800         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a759">MSA_OFF</a>) {
01801             y += <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a144">gcyMenuScrollArrow</a> - <a class="code" href="../../d4/d1/userk_8h.html#a1324">MNGetToppItem</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>)-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
01802         }
01803 
01804         <span class="comment">/*</span>
01805 <span class="comment">         * Try to make sure the menu doesn't go off right side of the</span>
01806 <span class="comment">         * monitor.  If it does, drop it left, overlapping the checkmark</span>
01807 <span class="comment">         * area.  Unless it would cover the previous menu...</span>
01808 <span class="comment">         *</span>
01809 <span class="comment">         * Use the monitor that the parent menu is on to keep all hierarchicals</span>
01810 <span class="comment">         * in the same place.</span>
01811 <span class="comment">         */</span>
01812         pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(
01813                 ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, MONITOR_DEFAULTTOPRIMARY);
01814 
01815 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01816 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((!!ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o4">fDroppedLeft</a>) ^ (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, WEFLAYOUTRTL))) {
01817 <span class="preprocessor">#else</span>
01818 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o4">fDroppedLeft</a>) {
01819 <span class="preprocessor">#endif</span>
01820 <span class="preprocessor"></span>            <span class="keywordtype">int</span> xTmp;
01821 
01822             <span class="comment">/*</span>
01823 <span class="comment">             * If this menu has dropped left, see if our hierarchy can be made</span>
01824 <span class="comment">             * to drop to the left also.</span>
01825 <span class="comment">             */</span>
01826             xTmp = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME) - cx;
01827             <span class="keywordflow">if</span> (xTmp &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left) {
01828                 x = xTmp;
01829                 uPAS = <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a>;
01830             }
01831         }
01832 
01833         <span class="comment">/*</span>
01834 <span class="comment">         * Make sure the menu doesn't go off right side of screen.  Make it drop</span>
01835 <span class="comment">         * left if it does.</span>
01836 <span class="comment">         */</span>
01837          <span class="keywordflow">if</span> (x + cx &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right) {
01838              x = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME) - cx;
01839              uPAS = <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a>;
01840          }
01841 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01842 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, WEFLAYOUTRTL)) {
01843         uPAS ^= <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>;
01844     }
01845 <span class="preprocessor">#endif</span>
01846 <span class="preprocessor"></span>
01847     } <span class="comment">/* else if (ppopup-&gt;fIsMenuBar) */</span>
01848 
01849     <span class="comment">/*</span>
01850 <span class="comment">     * Does the menu extend beyond bottom of monitor?</span>
01851 <span class="comment">     */</span>
01852     UserAssert(pMonitor);
01853     <span class="keywordflow">if</span> (y + <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom) {
01854         y -= <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01855 
01856         <span class="comment">/*</span>
01857 <span class="comment">         * Try to pop above menu bar first</span>
01858 <span class="comment">         */</span>
01859         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
01860             y -= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENUSIZE);
01861             <span class="keywordflow">if</span> (y &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top) {
01862                 uPAS = <a class="code" href="../../d4/d1/userk_8h.html#a540">PAS_UP</a>;
01863             }
01864         } <span class="keywordflow">else</span> {
01865             <span class="comment">/*</span>
01866 <span class="comment">             * Account for nonclient frame above &amp; below</span>
01867 <span class="comment">             */</span>
01868             y += pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a> + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME);
01869         }
01870 
01871         <span class="comment">/*</span>
01872 <span class="comment">         * Make sure that starting point is on a monitor, and all of menu shows.</span>
01873 <span class="comment">         */</span>
01874         <span class="keywordflow">if</span> (    (y &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top) ||
01875                 (y + <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom))
01876             <span class="comment">/*</span>
01877 <span class="comment">             * Pin it to the bottom.</span>
01878 <span class="comment">             */</span>
01879             y = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01880     }
01881 
01882     <span class="comment">/*</span>
01883 <span class="comment">     * Make sure Upper Left corner of menu is always visible.</span>
01884 <span class="comment">     */</span>
01885     x = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(x, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left);
01886     y = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(y, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
01887 
01888     <span class="comment">/*</span>
01889 <span class="comment">     * Propagate position</span>
01890 <span class="comment">     */</span>
01891     *px = x;
01892     *py = y;
01893     *ppMonitor = pMonitor;
01894 
01895     <span class="comment">/*</span>
01896 <span class="comment">     * Return animation direction</span>
01897 <span class="comment">     */</span>
01898     <span class="keywordflow">return</span> uPAS;
01899 }
01900 
01901 
01902 <span class="comment">/***************************************************************************\</span>
01903 <span class="comment">* xxxCleanupDesktopMenu</span>
01904 <span class="comment">*</span>
01905 <span class="comment">* History:</span>
01906 <span class="comment">* 10/19/98 GerardoB  Extracted from xxxMNCloseHierarchy</span>
01907 <span class="comment">\***************************************************************************/</span>
<a name="l01908"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a24">01908</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a24">xxxCleanupDesktopMenu</a> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDeskMenu, <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk)
01909 {
01910     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01911     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndDeskMenu);
01912     <span class="comment">/*</span>
01913 <span class="comment">     *  Put it on the message window tree so it is out of the way.</span>
01914 <span class="comment">     */</span>
01915     UserAssert(pwndDeskMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1137">_GetDesktopWindow</a>());
01916     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>, &amp;tlpwnd);
01917     <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a6">xxxSetParent</a>(pwndDeskMenu, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o13">spwndMessage</a>);
01918     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01919 
01920     <span class="comment">/*</span>
01921 <span class="comment">     * Give ownershipe back to the desktop thread</span>
01922 <span class="comment">     */</span>
01923     pwndDeskMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.pti = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.pti;
01924     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwndDeskMenu-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>);
01925 }
01926 <span class="comment">/***************************************************************************\</span>
01927 <span class="comment">* PWND MenuOpenHierarchyHandler(PPOPUPMENU ppopupmenu)</span>
01928 <span class="comment">* effects: Drops one level of the hierarchy at the selection.</span>
01929 <span class="comment">*</span>
01930 <span class="comment">* History:</span>
01931 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
01932 <span class="comment">\***************************************************************************/</span>
01933 
<a name="l01934"></a><a class="code" href="../../d4/d1/userk_8h.html#a1375">01934</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(
01935     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu, <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
01936 {
01937     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        ret = 0;
01938     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>       pItem;
01939     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndHierarchy;
01940     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>  ppopupmenuHierarchy;
01941     LONG        sizeHierarchy;
01942     <span class="keywordtype">int</span>         xLeft;
01943     <span class="keywordtype">int</span>         yTop;
01944     <span class="keywordtype">int</span>         cxPopup, cyPopup;
01945     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndT;
01946     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndHierarchy;
01947     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01948     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>    pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
01949     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fSendUninit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01950     HMENU       hmenuInit;
01951     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
01952 
01953 
01954     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
01955         <span class="comment">/*</span>
01956 <span class="comment">         *  No selection so fail.</span>
01957 <span class="comment">         */</span>
01958         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01959     }
01960 
01961     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> &gt;= ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)
01962         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01963 
01964     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a>) {
01965         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o14">fHideTimer</a>) {
01966             <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupmenu,pMenuState);
01967         } <span class="keywordflow">else</span> {
01968         <span class="comment">/*</span>
01969 <span class="comment">         * Hierarchy already dropped. What are we doing here?</span>
01970 <span class="comment">         */</span>
01971             UserAssert(!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a>);
01972             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01973         }
01974     }
01975 
01976     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a>) {
01977         <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a55">IDSYS_MNSHOW</a>);
01978         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01979     }
01980 
01981     <span class="comment">/*</span>
01982 <span class="comment">     * Get a pointer to the currently selected item in this menu.</span>
01983 <span class="comment">     */</span>
01984     pItem = &amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>]);
01985 
01986     <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01987         <span class="keywordflow">goto</span> Exit;
01988 
01989     <span class="comment">/*</span>
01990 <span class="comment">     * Send the initmenupopup message.</span>
01991 <span class="comment">     */</span>
01992     <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>) {
01993         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndT);
01994         <span class="comment">/*</span>
01995 <span class="comment">         * WordPerfect's Grammatik app doesn't know that TRUE means NON-ZERO,</span>
01996 <span class="comment">         * not 1.  So we must use 0 &amp; 1 explicitly for fIsSysMenu here</span>
01997 <span class="comment">         * -- Win95B B#4947 -- 2/13/95 -- jeffbog</span>
01998 <span class="comment">         */</span>
01999         hmenuInit = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>);
02000         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_INITMENUPOPUP,
02001             (WPARAM)hmenuInit, MAKELONG(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>,
02002             (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? 1: 0)));
02003         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02004         fSendUninit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02005     }
02006 
02007 
02008     <span class="comment">/*</span>
02009 <span class="comment">     * B#1517</span>
02010 <span class="comment">     * Check if we're still in menu loop</span>
02011 <span class="comment">     */</span>
02012     <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a>) {
02013         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Menu loop ended unexpectedly by WM_INITMENUPOPUP"</span>);
02014         ret = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)-1;
02015         <span class="keywordflow">goto</span> Exit;
02016     }
02017 
02018     <span class="comment">/*</span>
02019 <span class="comment">     * The WM_INITMENUPOPUP message may have resulted in a change to the</span>
02020 <span class="comment">     * menu.  Make sure the selection is still valid.</span>
02021 <span class="comment">     */</span>
02022     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> &gt;= ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) {
02023         <span class="comment">/*</span>
02024 <span class="comment">         * Selection is out of range, so fail.</span>
02025 <span class="comment">         */</span>
02026         <span class="keywordflow">goto</span> Exit;
02027     }
02028 
02029     <span class="comment">/*</span>
02030 <span class="comment">     * Get a pointer to the currently selected item in this menu.</span>
02031 <span class="comment">     * Bug #17867 - the call can cause this thing to change, so reload it.</span>
02032 <span class="comment">     */</span>
02033     pItem = &amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>]);
02034 
02035     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem, MFS_GRAYED) || (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == 0)) {
02036         <span class="comment">/*</span>
02037 <span class="comment">         * The item is disabled, no longer a popup, or empty so don't drop.</span>
02038 <span class="comment">         */</span>
02039         <span class="comment">/*</span>
02040 <span class="comment">         * No items in menu.</span>
02041 <span class="comment">         */</span>
02042         <span class="keywordflow">goto</span> Exit;
02043     }
02044 
02045     <span class="comment">/*</span>
02046 <span class="comment">     * Let's make sure that the current thread is in menu mode and</span>
02047 <span class="comment">     *  it uses this pMenuState. Otherwise the window we're about to</span>
02048 <span class="comment">     *  create (or set the thread to) will point to a different pMenuState</span>
02049 <span class="comment">     */</span>
02050     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> == pMenuState);
02051 
02052     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> &amp;&amp; (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02053             (!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a296">DF_MENUINUSE</a>)) &amp;&amp;
02054             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
02055 
02056         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a296">DF_MENUINUSE</a>;
02057 
02058         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>)-&gt;bFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>) {
02059             <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
02060             <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiSave;
02061             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>         pwndMenu;
02062             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        dwDisableHooks;
02063 
02064             <span class="comment">/*</span>
02065 <span class="comment">             * the menu window is destroyed -- recreate it</span>
02066 <span class="comment">             *</span>
02067 <span class="comment">             * clear the desktopMenu flag so that the popup is</span>
02068 <span class="comment">             * freed.</span>
02069 <span class="comment">             */</span>
02070             UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a>);
02071 
02072             ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02073             ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o16">fDelayedFree</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02074 
02075             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>);
02076             ppiSave  = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
02077             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = ppi;
02078 
02079             <span class="comment">/*</span>
02080 <span class="comment">             * HACK HACK HACK!!! (adams) In order to create the menu window</span>
02081 <span class="comment">             * with the correct desktop, we set the desktop of the current thread</span>
02082 <span class="comment">             * to the new desktop. But in so doing we allow hooks on the current</span>
02083 <span class="comment">             * thread to also hook this new desktop. This is bad, because we don't</span>
02084 <span class="comment">             * want the menu window to be hooked while it is created. So we</span>
02085 <span class="comment">             * temporarily disable hooks of the current thread or desktop,</span>
02086 <span class="comment">             * and reenable them after switching back to the original desktop.</span>
02087 <span class="comment">             */</span>
02088 
02089             dwDisableHooks = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>;
02090             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>;
02091 
02092             pwndMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
02093                 WS_EX_TOOLWINDOW | WS_EX_DLGMODALFRAME | WS_EX_WINDOWEDGE,
02094                 (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a45">MENUCLASS</a>,
02095                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02096                 WS_POPUP | WS_BORDER,
02097                 0,
02098                 0,
02099                 100,
02100                 100,
02101                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02102                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02103                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
02104                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02105                 WINVER);
02106 
02107             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>);
02108             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>) | dwDisableHooks;
02109 
02110             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>), pwndMenu);
02111 
02112             UserAssert(((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwndMenu)-&gt;ppopupmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02113 
02114             <span class="comment">/*</span>
02115 <span class="comment">             * Set the desktopMenu flag to mark that this is the popup</span>
02116 <span class="comment">             * allocated for pdesk-&gt;spwndMenu</span>
02117 <span class="comment">             * Unlock spwndPopupMenu to avoid this special case in the common code path.</span>
02118 <span class="comment">             */</span>
02119             ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwndMenu)-&gt;ppopupmenu-&gt;fDesktopMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02120             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwndMenu)-&gt;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>);
02121 
02122             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = ppiSave;
02123 
02124             <a class="code" href="../../d4/d1/userk_8h.html#a980">HMChangeOwnerThread</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>);
02125         } <span class="keywordflow">else</span> {
02126             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndDesk;
02127 
02128             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>, &amp;tlpwndT);
02129             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, &amp;tlpwndDesk);
02130             <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a6">xxxSetParent</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>);
02131             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDesk);
02132             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02133 
02134         }
02135 
02136 
02137         pwndHierarchy = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>;
02138         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwndHierarchy-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
02139         pwndHierarchy-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.pti = ptiCurrent;
02140 
02141         <span class="comment">/*</span>
02142 <span class="comment">         * Make the topmost state match the menu mode</span>
02143 <span class="comment">         */</span>
02144         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) &amp;&amp; pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>)
02145                 || (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>)) {
02146 
02147             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>, &amp;tlpwndHierarchy);
02148             <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>,
02149               (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> ? PWND_NOTOPMOST: <a class="code" href="../../d4/d1/userk_8h.html#a455">PWND_TOPMOST</a>),
02150               0,0,0,0,
02151               SWP_NOACTIVATE | SWP_NOSIZE | SWP_NOMOVE | SWP_NOREDRAW | SWP_NOOWNERZORDER | SWP_NOSENDCHANGING);
02152             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndHierarchy);
02153         }
02154 
02155         ppopupmenuHierarchy = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwndHierarchy)-&gt;ppopupmenu;
02156 
02157         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a>);
02158         <span class="comment">/*</span>
02159 <span class="comment">         * clear any leftover data from the last time we used it</span>
02160 <span class="comment">         * Assert that we're not zapping any locks here</span>
02161 <span class="comment">         */</span>
02162         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02163         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02164         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02165         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02166         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02167         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02168         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02169 
02170         RtlZeroMemory((PVOID)ppopupmenuHierarchy, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">POPUPMENU</a>));
02171         ppopupmenuHierarchy-&gt;fDesktopMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02172 
02173         ppopupmenuHierarchy-&gt;posSelectedItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
02174         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ppopupmenuHierarchy-&gt;spwndPopupMenu, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>);
02175 
02176         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenuHierarchy-&gt;spwndNotify), ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
02177         <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupmenuHierarchy, &amp;ppopupmenuHierarchy-&gt;spmenu, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>);
02178 
02179     } <span class="keywordflow">else</span> {
02180 
02181         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndT);
02182 
02183         pwndHierarchy = <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
02184                 WS_EX_TOOLWINDOW | WS_EX_DLGMODALFRAME | WS_EX_WINDOWEDGE,
02185                 (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a45">MENUCLASS</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02186                 WS_POPUP | WS_BORDER, 0, 0, 100, 100, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>,
02187                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (HANDLE)ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>-&gt;hModule,
02188                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, WINVER);
02189 
02190         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02191 
02192         <span class="keywordflow">if</span> (!pwndHierarchy)
02193             <span class="keywordflow">goto</span> Exit;
02194 
02195         <span class="comment">/*</span>
02196 <span class="comment">         * Do this so old apps don't get weird borders on the popups of</span>
02197 <span class="comment">         * hierarchical items!</span>
02198 <span class="comment">         */</span>
02199         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndHierarchy, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a587">WFOLDUI</a>);
02200 
02201         ppopupmenuHierarchy = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwndHierarchy)-&gt;ppopupmenu;
02202 
02203     }
02204 
02205     <span class="comment">/*</span>
02206 <span class="comment">     * Mark this as fDelayedFree and link it</span>
02207 <span class="comment">     */</span>
02208     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o16">fDelayedFree</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02209     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a> = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a>;
02210     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o33">ppmDelayedFree</a> = ppopupmenuHierarchy;
02211 
02212 <span class="preprocessor">#ifdef USE_MIRRORING</span>
02213 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, WEFLAYOUTRTL)) {
02214         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwndHierarchy, WEFLAYOUTRTL);
02215     } <span class="keywordflow">else</span> {
02216         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndHierarchy, WEFLAYOUTRTL);
02217     }
02218 <span class="preprocessor">#endif</span>
02219 <span class="preprocessor"></span>
02220 
02221     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>), ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
02222 <span class="preprocessor">#if DBG</span>
02223 <span class="preprocessor"></span>    <span class="comment">/*</span>
02224 <span class="comment">     * We should associate ppopupmenuHierarchy to the same menu we sent the</span>
02225 <span class="comment">     *  WM_INITMsENUPOPUP message. Otherwise, the WM_UNINITMENUPOPUP</span>
02226 <span class="comment">     *  will go to the wrong window. It would be the app's fault...</span>
02227 <span class="comment">     */</span>
02228     <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a> &amp;&amp; (hmenuInit != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>))) {
02229         RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxMNOpenHierarchy: bad app changed submenu from %#p to %#p"</span>,
02230                               hmenuInit, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>));
02231     }
02232 <span class="preprocessor">#endif</span>
02233 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupmenuHierarchy, &amp;ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>);
02234     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>), pwndHierarchy);
02235     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a>              = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>;
02236     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a>), ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>);
02237     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>;
02238     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a> = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a>;
02239     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>;
02240     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>      = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>;
02241     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o21">fSendUninit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02242     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o22">fRtoL</a> = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o22">fRtoL</a>;
02243 
02244     <span class="comment">/*</span>
02245 <span class="comment">     * The menu window has been created and intialized so if</span>
02246 <span class="comment">     *  something fails, the WM_UNINITMENUPOPUP message will</span>
02247 <span class="comment">     *  be sent from xxxMNDestroyHandler</span>
02248 <span class="comment">     */</span>
02249     fSendUninit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02250 
02251     <span class="comment">/*</span>
02252 <span class="comment">     * Set/clear the underline flag</span>
02253 <span class="comment">     */</span>
02254     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o6">fUnderline</a>) {
02255         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a144">MFUNDERLINE</a>);
02256     } <span class="keywordflow">else</span> {
02257         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a785">ClearMF</a>(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a144">MFUNDERLINE</a>);
02258     }
02259 
02260     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o12">fAboutToHide</a>   = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02261 
02262     <span class="comment">/*</span>
02263 <span class="comment">     * Find the size of the menu window and actually size it (wParam = 1)</span>
02264 <span class="comment">     */</span>
02265     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndHierarchy, &amp;tlpwndHierarchy);
02266     sizeHierarchy = (LONG)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndHierarchy, MN_SIZEWINDOW, <a class="code" href="../../d4/d1/userk_8h.html#a535">MNSW_SIZE</a>, 0);
02267 
02268     <span class="keywordflow">if</span> (!sizeHierarchy) {
02269         <span class="comment">/*</span>
02270 <span class="comment">         * No size for this menu so zero it and blow off.</span>
02271 <span class="comment">         */</span>
02272         UserAssert(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o16">fDelayedFree</a>);
02273         <span class="keywordflow">if</span> (ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a>) {
02274             <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a19">xxxMNDestroyHandler</a>(ppopupmenuHierarchy);
02275             <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a24">xxxCleanupDesktopMenu</a>(pwndHierarchy, pdesk);
02276         }
02277 
02278         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndHierarchy)) {
02279             <span class="keywordflow">if</span> (!ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a>) {
02280                 <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwndHierarchy);
02281             }
02282         }
02283 
02284         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>);
02285         <span class="keywordflow">goto</span> Exit;
02286     }
02287 
02288     cxPopup = LOWORD(sizeHierarchy) + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME);
02289     cyPopup = HIWORD(sizeHierarchy) + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME);
02290 
02291     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02292 
02293     <span class="comment">/*</span>
02294 <span class="comment">     * Find out the x,y position to drop the hierarchy and the animation</span>
02295 <span class="comment">     *  direction</span>
02296 <span class="comment">     */</span>
02297     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a23">xxxMNPositionHierarchy</a>(
02298             ppopupmenu, pItem, cxPopup, cyPopup, &amp;xLeft, &amp;yTop, &amp;pMonitor);
02299 
02300     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(VK_LBUTTON) &amp; 0x8000) {
02301         <span class="comment">/*</span>
02302 <span class="comment">         * If the menu had to be pinned to the bottom of the screen and</span>
02303 <span class="comment">         * the mouse button is down, make sure the mouse isn't over the</span>
02304 <span class="comment">         * menu rect.</span>
02305 <span class="comment">         */</span>
02306         RECT rc;
02307         RECT rcParent;
02308         <span class="keywordtype">int</span> xrightdrop;
02309         <span class="keywordtype">int</span> xleftdrop;
02310 
02311         <span class="comment">/*</span>
02312 <span class="comment">         * Get rect of hierarchical</span>
02313 <span class="comment">         */</span>
02314         <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(
02315                 &amp;rc,
02316                 &amp;pwndHierarchy-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>,
02317                 xLeft - pwndHierarchy-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left,
02318                 yTop  - pwndHierarchy-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
02319 
02320         <span class="comment">/*</span>
02321 <span class="comment">         * Get the rect of the menu bar popup item</span>
02322 <span class="comment">         */</span>
02323         rcParent.left = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> + ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
02324         rcParent.top = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> + ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
02325         rcParent.right = rcParent.left + pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
02326         rcParent.bottom = rcParent.top + pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
02327 
02328         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, &amp;rcParent)) {
02329 
02330             <span class="comment">/*</span>
02331 <span class="comment">             * Oh, oh...  The cursor will sit right on top of a menu item.</span>
02332 <span class="comment">             * If the user up clicks, a menu will be accidently selected.</span>
02333 <span class="comment">             *</span>
02334 <span class="comment">             * Calc x position of hierarchical if we dropped it to the</span>
02335 <span class="comment">             * right/left of the menu bar item.</span>
02336 <span class="comment">             */</span>
02337             xrightdrop = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left +
02338                 pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> + pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> + cxPopup;
02339 
02340             <span class="keywordflow">if</span> (xrightdrop &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right) {
02341                 xrightdrop = 0;
02342             }
02343 
02344             xleftdrop = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left +
02345                 pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> - cxPopup;
02346 
02347             <span class="keywordflow">if</span> (xleftdrop &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left) {
02348                 xleftdrop = 0;
02349             }
02350 
02351             <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MENUDROPALIGNMENT) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_RIGHTORDER))
02352                   &amp;&amp; xleftdrop) || !xrightdrop) {
02353                 xLeft = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left +
02354                     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> - cxPopup;
02355                     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a>;
02356             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xrightdrop) {
02357                 xLeft = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left +
02358                     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> + pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
02359                     ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = <a class="code" href="../../d4/d1/userk_8h.html#a537">PAS_RIGHT</a>;
02360             }
02361         }
02362     }
02363 
02364     <span class="comment">/*</span>
02365 <span class="comment">     * Take care of fDropNextPopup (menu bar) or fDroppedLeft (popups)</span>
02366 <span class="comment">     * Set animation flag</span>
02367 <span class="comment">     */</span>
02368     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
02369         <span class="comment">/*</span>
02370 <span class="comment">         * Only the first popup being dropped off the menu bar</span>
02371 <span class="comment">         * is animated.</span>
02372 <span class="comment">         */</span>
02373         <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o10">fDropNextPopup</a>) {
02374             ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a541">PAS_OUT</a>;
02375         }
02376 
02377         <span class="comment">/*</span>
02378 <span class="comment">         * Propagate right-to-left direction.</span>
02379 <span class="comment">         */</span>
02380         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o4">fDroppedLeft</a> || (ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> == <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a>)) {
02381             ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o4">fDroppedLeft</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02382         }
02383         <span class="comment">/*</span>
02384 <span class="comment">         * Once a popup is dropped from the menu bar, moving to the next</span>
02385 <span class="comment">         *  item on the menu bar should drop the popup.</span>
02386 <span class="comment">         */</span>
02387         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o10">fDropNextPopup</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02388     } <span class="keywordflow">else</span> {
02389         <span class="comment">/*</span>
02390 <span class="comment">         * Submenus always animate.</span>
02391 <span class="comment">         */</span>
02392         ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a541">PAS_OUT</a>;
02393 
02394         <span class="comment">/*</span>
02395 <span class="comment">         * Is this popup a lefty?</span>
02396 <span class="comment">         */</span>
02397         <span class="keywordflow">if</span> (ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> == <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a>) {
02398             ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o4">fDroppedLeft</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02399         }
02400     }
02401 
02402     <span class="comment">/*</span>
02403 <span class="comment">     * The previous active dude must be visible</span>
02404 <span class="comment">     */</span>
02405     UserAssert((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02406             || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>));
02407 
02408     <span class="comment">/*</span>
02409 <span class="comment">     * This is the new active popup</span>
02410 <span class="comment">     */</span>
02411     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>), pwndHierarchy);
02412 
02413     <span class="comment">/*</span>
02414 <span class="comment">     * Paint the owner window before the popup menu comes up so that</span>
02415 <span class="comment">     * the proper bits are saved.</span>
02416 <span class="comment">     */</span>
02417     <span class="keywordflow">if</span> (ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02418         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndT);
02419         <a class="code" href="../../d4/d1/userk_8h.html#a1673">xxxUpdateWindow</a>(ppopupmenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
02420         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02421     }
02422 
02423     <span class="comment">/*</span>
02424 <span class="comment">     * If this is a drag and drop menu, then we need to register the window</span>
02425 <span class="comment">     *  as a drop target.</span>
02426 <span class="comment">     */</span>
02427     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a>) {
02428         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1413">xxxClientRegisterDragDrop</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndHierarchy)))) {
02429             RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxMNOpenHierarchy: xxxClientRegisterDragDrop failed:%#p"</span>, pwndHierarchy);
02430         }
02431     }
02432 
02433     <span class="comment">/*</span>
02434 <span class="comment">     * Show the window. Modeless menus are not topmost and get activated.</span>
02435 <span class="comment">     *  Modal menus are topmost but don't get activated.</span>
02436 <span class="comment">     */</span>
02437     <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a924">USER_SOUND_MENUPOPUP</a>);
02438 
02439     <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndHierarchy,
02440                     (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> ? <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a> : <a class="code" href="../../d4/d1/userk_8h.html#a455">PWND_TOPMOST</a>),
02441                     xLeft, yTop, 0, 0,
02442                     SWP_SHOWWINDOW | SWP_NOSIZE | SWP_NOOWNERZORDER
02443                     | (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> ? 0 : SWP_NOACTIVATE));
02444 
02445     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
02446         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUPOPUPSTART, pwndHierarchy, OBJID_CLIENT, INDEXID_CONTAINER, 0);
02447     }
02448 
02449     <span class="comment">/*</span>
02450 <span class="comment">     * Select the first item IFF we're in keyboard mode.  This fixes a</span>
02451 <span class="comment">     * surprising number of compatibility problems with keyboard macros,</span>
02452 <span class="comment">     * scripts, etc.</span>
02453 <span class="comment">     */</span>
02454     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o22">mnFocus</a> == <a class="code" href="../../d4/d1/userk_8h.html#a333">KEYBDHOLD</a>) {
02455         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndHierarchy, MN_SELECTITEM, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02456     }
02457 
02458     <span class="comment">/*</span>
02459 <span class="comment">     * This is needed so that popup menus are properly drawn on sys</span>
02460 <span class="comment">     * modal dialog boxes.</span>
02461 <span class="comment">     */</span>
02462     <a class="code" href="../../d4/d1/userk_8h.html#a1673">xxxUpdateWindow</a>(pwndHierarchy);
02463 
02464     ret = pwndHierarchy;
02465     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndHierarchy);
02466 
02467 Exit:
02468     <span class="comment">/*</span>
02469 <span class="comment">     * send matching WM_UNINITMENUPOPUP if needed (i.e, something</span>
02470 <span class="comment">     *  failed).</span>
02471 <span class="comment">     */</span>
02472     <span class="keywordflow">if</span> (fSendUninit
02473             &amp;&amp; (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02474 
02475         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndT);
02476         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_UNINITMENUPOPUP,
02477             (WPARAM)hmenuInit,
02478              MAKELONG(0, (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? MF_SYSMENU : 0)));
02479         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02480     }
02481 
02482     <span class="keywordflow">return</span> ret;
02483 }
02484 
02485 <span class="comment">/***************************************************************************\</span>
02486 <span class="comment">*</span>
02487 <span class="comment">*  MNHideNextHierarchy()</span>
02488 <span class="comment">*</span>
02489 <span class="comment">*  Closes any submenu coming off of this popup.</span>
02490 <span class="comment">*</span>
02491 <span class="comment">\***************************************************************************/</span>
<a name="l02492"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a26">02492</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a26">xxxMNHideNextHierarchy</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup)
02493 {
02494     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02495         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
02496 
02497         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>, &amp;tlpwndT);
02498         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> != ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>)
02499             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>, MN_CLOSEHIERARCHY, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02500 
02501         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>, MN_SELECTITEM, (WPARAM)-1, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02502         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02503         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02504     }
02505     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02506 }
02507 
02508 
02509 <span class="comment">/***************************************************************************\</span>
02510 <span class="comment">* void MenuCloseHierarchyHandler(PPOPUPMENU ppopupmenu)</span>
02511 <span class="comment">* effects: Close all hierarchies from this window down.</span>
02512 <span class="comment">*</span>
02513 <span class="comment">* History:</span>
02514 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
02515 <span class="comment">\***************************************************************************/</span>
02516 
<a name="l02517"></a><a class="code" href="../../d4/d1/userk_8h.html#a1374">02517</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(
02518     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu, <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState)
02519 {
02520     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>           tlpwndNext;
02521     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>           tlpwnd;
02522     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>           tlpopup;
02523     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02524     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>     pdesk;
02525     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>         pwndNext;
02526 
02527     <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu);
02528 
02529     <span class="comment">/*</span>
02530 <span class="comment">     * Terminate any animation</span>
02531 <span class="comment">     */</span>
02532     <a class="code" href="../../d4/d1/userk_8h.html#a1339">MNAnimate</a>(pMenuState, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02533 
02534     <span class="comment">/*</span>
02535 <span class="comment">     * If a hierarchy exists, close all childen below us.  Do it in reversed</span>
02536 <span class="comment">     * order so savebits work out.</span>
02537 <span class="comment">     */</span>
02538     <span class="keywordflow">if</span>  (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a>) {
02539         <span class="comment">/*</span>
02540 <span class="comment">         * Assert that there's no next or it might not get closed</span>
02541 <span class="comment">         */</span>
02542         UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02543         <span class="keywordflow">return</span>;
02544     }
02545 
02546     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o14">fHideTimer</a>)
02547     {
02548         <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a57">IDSYS_MNHIDE</a>);
02549         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o14">fHideTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02550     }
02551 
02552     pwndNext = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>;
02553     <span class="keywordflow">if</span> (pwndNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02554 
02555         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndNext, &amp;tlpwndNext);
02556         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndNext, MN_CLOSEHIERARCHY, 0, 0);
02557 
02558         <span class="comment">/*</span>
02559 <span class="comment">         * If modeless menu, activate the this popup since we're about</span>
02560 <span class="comment">         *  to destroy the current active one. We want to keep activation</span>
02561 <span class="comment">         *  on a menu window so we can get the keys. Also, modeless menus</span>
02562 <span class="comment">         *  are canceled when a non-menu window is activated in their queue</span>
02563 <span class="comment">         */</span>
02564         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>
02565                 &amp;&amp; pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a>
02566                 &amp;&amp; !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
02567 
02568             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, &amp;tlpwnd);
02569             <a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, 0, 0);
02570             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02571         }
02572 
02573         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
02574             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUPOPUPEND, pwndNext, OBJID_CLIENT, INDEXID_CONTAINER, 0);
02575         }
02576 
02577         <span class="comment">/*</span>
02578 <span class="comment">         * If the current thread is not in the right pdesk, then that could</span>
02579 <span class="comment">         *  be the cause of the stuck menu bug.</span>
02580 <span class="comment">         * In other words, are we nuking this menu out of context?</span>
02581 <span class="comment">         */</span>
02582         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02583         pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
02584 
02585         <span class="keywordflow">if</span> (pwndNext == pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>) {
02586             <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenuReal;
02587 
02588             UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a296">DF_MENUINUSE</a>);
02589 
02590             <span class="comment">/*</span>
02591 <span class="comment">             * If this is our precreated real popup window,</span>
02592 <span class="comment">             * initialize ourselves and just hide.</span>
02593 <span class="comment">             */</span>
02594             <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwndNext, SW_HIDE | <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>));
02595 
02596             <span class="comment">/*</span>
02597 <span class="comment">             * Its possible that during Logoff the above xxxShowWindow</span>
02598 <span class="comment">             * won't get prossessed and because this window is a special</span>
02599 <span class="comment">             * window that is owned by they desktop we have to manually mark</span>
02600 <span class="comment">             * it as invisible.</span>
02601 <span class="comment">             */</span>
02602             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
02603                 <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwndNext, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a750">SV_UNSET</a>);
02604             }
02605 
02606 <span class="preprocessor">#ifdef HAVE_MN_GETPPOPUPMENU</span>
02607 <span class="preprocessor"></span>            ppopupmenuReal = (<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndNext,
02608                     MN_GETPPOPUPMENU,0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02609 <span class="preprocessor">#else</span>
02610 <span class="preprocessor"></span>            ppopupmenuReal = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwndNext)-&gt;ppopupmenu;
02611 <span class="preprocessor">#endif</span>
02612 <span class="preprocessor"></span>            UserAssert(ppopupmenuReal-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o23">fDesktopMenu</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02613 
02614             <span class="comment">/*</span>
02615 <span class="comment">             * We don't want this window to be a drop target anymore.</span>
02616 <span class="comment">             * Non cached menu windows revoke it on WM_FINALDESTROY.</span>
02617 <span class="comment">             */</span>
02618             <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a>) {
02619                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1414">xxxClientRevokeDragDrop</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndNext)))) {
02620                     RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxMNCloseHierarchy: xxxClientRevokeRegisterDragDrop failed:%#p"</span>, pwndNext);
02621                 }
02622             }
02623 
02624             <span class="keywordflow">if</span> (ppopupmenuReal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02625                 <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a19">xxxMNDestroyHandler</a>(ppopupmenuReal);
02626                 <span class="comment">/*</span>
02627 <span class="comment">                 * We used to clear the popup contents here but the popup might be</span>
02628 <span class="comment">                 *  still in use if this is happening during a callback. So we let</span>
02629 <span class="comment">                 *  MNFreePopup do that. If it didn't happen during the call above,</span>
02630 <span class="comment">                 *  it'll happen when MNFlushDestroyedPopups is executed.</span>
02631 <span class="comment">                 */</span>
02632             }
02633 
02634             <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a24">xxxCleanupDesktopMenu</a>(pwndNext, pdesk);
02635 
02636             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNext);
02637         } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNext)) {
02638             <span class="comment">/*</span>
02639 <span class="comment">             * We know this is not the current thread's desktop menu window.</span>
02640 <span class="comment">             * Let's assert that it's not the menu window of another desktop.</span>
02641 <span class="comment">             */</span>
02642             UserAssert(pwndNext != pwndNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;spwndMenu);
02643             <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwndNext);
02644         }
02645 
02646         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>);
02647         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02648 
02649     }
02650 
02651     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
02652         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>);
02653     } <span class="keywordflow">else</span> {
02654         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>),
02655                 ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>);
02656     }
02657 
02658     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a> &amp;&amp;
02659             (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>)) {
02660         <span class="comment">/*</span>
02661 <span class="comment">         * Send a menu select as if this item had just been selected.  This</span>
02662 <span class="comment">         * allows people to easily update their menu status bars when a</span>
02663 <span class="comment">         * hierarchy from this item has been closed.</span>
02664 <span class="comment">         */</span>
02665         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>;
02666         <span class="keywordflow">if</span> (pwnd) {
02667             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
02668             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, &amp;tlpopup);
02669             <a class="code" href="../../d4/d1/userk_8h.html#a1389">xxxSendMenuSelect</a>(pwnd, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>,
02670                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>);
02671             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpopup);
02672             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02673         }
02674     }
02675 
02676 }
02677 
02678 <span class="comment">/***************************************************************************\</span>
02679 <span class="comment">*</span>
02680 <span class="comment">*  MNDoubleClick()</span>
02681 <span class="comment">*</span>
02682 <span class="comment">*  If an item isn't a hierarchical, then the double-click works just like</span>
02683 <span class="comment">*  single click did.  Otherwise, we traverse the submenu hierarchy to find</span>
02684 <span class="comment">*  a valid default element.  If we reach a submenu that has no valid default</span>
02685 <span class="comment">*  subitems and it itself has a valid ID, that becomes the valid default</span>
02686 <span class="comment">*  element.</span>
02687 <span class="comment">*</span>
02688 <span class="comment">*  Note:   This function does not remove the double click message</span>
02689 <span class="comment">*          from the message queue, so the caller must do so.</span>
02690 <span class="comment">*</span>
02691 <span class="comment">*  BOGUS</span>
02692 <span class="comment">*  How about opening the hierarchies if we don't find anything?</span>
02693 <span class="comment">*</span>
02694 <span class="comment">*  Returns TRUE if handled.</span>
02695 <span class="comment">*</span>
02696 <span class="comment">\***************************************************************************/</span>
<a name="l02697"></a><a class="code" href="../../d4/d1/userk_8h.html#a1373">02697</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1373">xxxMNDoubleClick</a>(<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup, <span class="keywordtype">int</span> idxItem)
02698 {
02699     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>  pMenu;
02700     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
02701     MSG   <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
02702     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uPos;
02703 
02704     <span class="comment">/*</span>
02705 <span class="comment">     * This code to swallow double clicks isn't executed!  MNLoop will</span>
02706 <span class="comment">     * swallow all double clicks for us.  Swallow the up button for the</span>
02707 <span class="comment">     * double dude instead.  Word will not be happy if they get a spurious</span>
02708 <span class="comment">     * WM_LBUTTONUP on the menu bar if their code to close the MDI child</span>
02709 <span class="comment">     * doesn't swallow it soon enough.</span>
02710 <span class="comment">     */</span>
02711 
02712     <span class="comment">/*</span>
02713 <span class="comment">     * Eat the click.</span>
02714 <span class="comment">     */</span>
02715     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_NOYIELD)) {
02716         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_LBUTTONUP) ||
02717             (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_NCLBUTTONUP)) {
02718            <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, PM_REMOVE);
02719         }
02720 <span class="preprocessor">#if DBG</span>
02721 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_LBUTTONDBLCLK ||
02722             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_NCLBUTTONDBLCLK)
02723         {
02724             UserAssertMsg0(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="stringliteral">"xxxMNDoubleClick found a double click"</span>);
02725         }
02726 <span class="preprocessor">#endif</span>
02727 <span class="preprocessor"></span>    }
02728 
02729     <span class="comment">/*</span>
02730 <span class="comment">     * Get current item.</span>
02731 <span class="comment">     */</span>
02732     pMenu = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>;
02733     <span class="keywordflow">if</span> ((pMenu==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)idxItem &gt;= pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)) {
02734         <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a15">xxxMNDoScroll</a>(ppopup, ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02735         <span class="keywordflow">goto</span> Done;
02736     }
02737 
02738     pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + idxItem;
02739     uPos = idxItem;
02740 
02741     <span class="comment">/*</span>
02742 <span class="comment">     * Do nothing if item is disabled.</span>
02743 <span class="comment">     */</span>
02744     <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp; MFS_GRAYED)
02745         <span class="keywordflow">goto</span> Done;
02746 
02747     <span class="comment">/*</span>
02748 <span class="comment">     * Traverse the hierarchy down as far as possible.</span>
02749 <span class="comment">     */</span>
02750     <span class="keywordflow">do</span>
02751     {
02752         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02753             <span class="comment">/*</span>
02754 <span class="comment">             * The item is a popup menu, so continue traversing.</span>
02755 <span class="comment">             */</span>
02756             pMenu = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>;
02757             idxItem = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d5/d7/ntuser_2rtl_2menu_8c.html#a0">_GetMenuDefaultItem</a>(pMenu, MF_BYPOSITION, 0);
02758 
02759             <span class="keywordflow">if</span> (idxItem != -1) {
02760                 pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + idxItem;
02761                 uPos = idxItem;
02762                 <span class="keywordflow">continue</span>;
02763             } <span class="keywordflow">else</span> <span class="comment">/* if (lpItem-&gt;wID == -1) How do we know this popup has an ID? */</span>
02764                 <span class="keywordflow">break</span>;
02765         }
02766 
02767         <span class="comment">/*</span>
02768 <span class="comment">         * We've found a leaf node of some kind, either a MFS_DEFAULT popup</span>
02769 <span class="comment">         * with a valid cmd ID that has no valid MFS_DEFAULT children, or</span>
02770 <span class="comment">         * a real cmd with MFS_DEFAULT style.</span>
02771 <span class="comment">         *</span>
02772 <span class="comment">         * Exit menu mode and send command ID.</span>
02773 <span class="comment">         */</span>
02774 
02775         <span class="comment">/*</span>
02776 <span class="comment">         * For old apps we need to generate a WM_MENUSELECT message first.</span>
02777 <span class="comment">         * Old apps, esp. Word 6.0, can't handle double-clicks on maximized</span>
02778 <span class="comment">         * child sys menus because they never get a WM_MENUSELECT for the</span>
02779 <span class="comment">         * item, unlike with normal keyboard/mouse choosing.  We need to</span>
02780 <span class="comment">         * fake it so they won't fault.  Several VB apps have a similar</span>
02781 <span class="comment">         * problem.</span>
02782 <span class="comment">         */</span>
02783         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
02784         {
02785             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNotify, tlpopup;
02786 
02787             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndNotify);
02788             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, &amp;tlpopup);
02789             <a class="code" href="../../d4/d1/userk_8h.html#a1389">xxxSendMenuSelect</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>,
02790                     ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, pMenu, idxItem);
02791             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpopup);
02792             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
02793         }
02794 
02795         <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a3">xxxMNDismissWithNotify</a>(pMenuState, pMenu, pItem, uPos, 0);
02796         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02797     }
02798     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02799 
02800 Done:
02801     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02802 }
02803 
02804 
02805 <span class="comment">/***************************************************************************\</span>
02806 <span class="comment">* UINT MenuSelectItemHandler(PPOPUPMENU ppopupmenu, int itemPos)</span>
02807 <span class="comment">*</span>
02808 <span class="comment">* Unselects the old selection, selects the item at itemPos and highlights it.</span>
02809 <span class="comment">*</span>
02810 <span class="comment">* MFMWFP_NOITEM if no item is to be selected.</span>
02811 <span class="comment">*</span>
02812 <span class="comment">* Returns the item flags of the item being selected.</span>
02813 <span class="comment">*</span>
02814 <span class="comment">* History:</span>
02815 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
02816 <span class="comment">\***************************************************************************/</span>
02817 
<a name="l02818"></a><a class="code" href="../../d4/d1/userk_8h.html#a1369">02818</a> <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(
02819     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu,
02820     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState,
02821     UINT itemPos)
02822 {
02823     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02824     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNotify;
02825     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndPopup;
02826     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
02827     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNotify;
02828     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
02829 
02830     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> == itemPos) {
02831 
02832         <span class="comment">/*</span>
02833 <span class="comment">         * If this item is already selectected, just return its flags.</span>
02834 <span class="comment">         */</span>
02835         <span class="keywordflow">if</span> ((itemPos != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) &amp;&amp; (itemPos &lt; ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)) {
02836             <span class="keywordflow">return</span> &amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[itemPos]);
02837         }
02838         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02839     }
02840 
02841     <span class="comment">/*</span>
02842 <span class="comment">     * Terminate any animation</span>
02843 <span class="comment">     */</span>
02844     <a class="code" href="../../d4/d1/userk_8h.html#a1339">MNAnimate</a>(pMenuState, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02845 
02846     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a>) {
02847         <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a55">IDSYS_MNSHOW</a>);
02848         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02849     }
02850 
02851     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pmenu = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, &amp;tlpmenu);
02852     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndNotify = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndNotify);
02853 
02854     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o12">fAboutToHide</a>)
02855     {
02856         <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupPrev = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a>))-&gt;ppopupmenu;
02857 
02858         <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a57">IDSYS_MNHIDE</a>);
02859         ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o14">fHideTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02860         <span class="keywordflow">if</span> (ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a>)
02861         {
02862             <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a55">IDSYS_MNSHOW</a>);
02863             ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02864         }
02865 
02866         <span class="keywordflow">if</span> (ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> != ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a>)
02867         {
02868             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenuPopupMenuPrev;
02869             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, &amp;tlpmenuPopupMenuPrev);
02870             <span class="keywordflow">if</span> (ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
02871                 <a class="code" href="../../d4/d1/userk_8h.html#a1388">xxxMNInvertItem</a>(ppopupPrev, ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>,
02872                         ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>, ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02873             }
02874 
02875             ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> = ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a>;
02876 
02877             <a class="code" href="../../d4/d1/userk_8h.html#a1388">xxxMNInvertItem</a>(ppopupPrev, ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>,
02878                         ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a>, ppopupPrev-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02879             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenuPopupMenuPrev);
02880         }
02881 
02882         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o12">fAboutToHide</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02883         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>);
02884     }
02885 
02886     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1325">MNIsItemSelected</a>(ppopupmenu)) {
02887         <span class="comment">/*</span>
02888 <span class="comment">         * Something else is selected so we need to unselect it.</span>
02889 <span class="comment">         */</span>
02890         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>) {
02891             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
02892                 <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupmenu, pMenuState);
02893             } <span class="keywordflow">else</span> {
02894                 <a class="code" href="../../d4/d1/userk_8h.html#a1364">MNSetTimerToCloseHierarchy</a>(ppopupmenu);
02895             }
02896         }
02897 
02898         <span class="keywordflow">goto</span> DeselectItem;
02899     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1327">MNIsScrollArrowSelected</a>(ppopupmenu)) {
02900             <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>);
02901 DeselectItem:
02902 
02903             <a class="code" href="../../d4/d1/userk_8h.html#a1388">xxxMNInvertItem</a>(ppopupmenu, pmenu,
02904                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>, pwndNotify, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02905     }
02906 
02907     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> = itemPos;
02908 
02909     <span class="keywordflow">if</span> (itemPos != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
02910         <span class="comment">/*</span>
02911 <span class="comment">         * If an item is selected, no autodismiss plus this means</span>
02912 <span class="comment">         *  that the mouse is on the menu</span>
02913 <span class="comment">         */</span>
02914         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o13">fAboutToAutoDismiss</a> =
02915         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o15">fMouseOffMenu</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02916 
02917         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) {
02918             <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a15">xxxMNDoScroll</a>(ppopupmenu, itemPos, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02919         }
02920 
02921         pItem = <a class="code" href="../../d4/d1/userk_8h.html#a1388">xxxMNInvertItem</a>(ppopupmenu, pmenu,
02922                 itemPos, pwndNotify, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02923         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
02924         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
02925         <span class="keywordflow">return</span> pItem;
02926 
02927     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
02928         <span class="comment">/*</span>
02929 <span class="comment">         * Notify that nothing is now focused in this menu.</span>
02930 <span class="comment">         */</span>
02931         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_FOCUS, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>,
02932                ((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>) ? OBJID_CLIENT :
02933                (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? OBJID_SYSMENU : OBJID_MENU)), 0, 0);
02934     }
02935 
02936     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
02937     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
02938 
02939     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02940         <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> pp;
02941 
02942         <span class="comment">/*</span>
02943 <span class="comment">         * Get the popupMenu data for the previous menu</span>
02944 <span class="comment">         * Use the root popupMenu if the previous menu is the menu bar</span>
02945 <span class="comment">         */</span>
02946         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a> &amp;&amp; (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a> ==
02947                 ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>)) {
02948             pp = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>;
02949         } <span class="keywordflow">else</span> {
02950 <span class="preprocessor">#ifdef HAVE_MN_GETPPOPUPMENU</span>
02951 <span class="preprocessor"></span>            <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndPrevPopup;
02952             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a>, &amp;tlpwndPrevPopup);
02953             pp = (<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a>,
02954                     MN_GETPPOPUPMENU, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02955             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndPrevPopup);
02956 <span class="preprocessor">#else</span>
02957 <span class="preprocessor"></span>            pp = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o28">spwndPrevPopup</a>)-&gt;ppopupmenu;
02958 <span class="preprocessor">#endif</span>
02959 <span class="preprocessor"></span>        }
02960 
02961         <span class="comment">/*</span>
02962 <span class="comment">         * Generate a WM_MENUSELECT for the previous menu to re-establish</span>
02963 <span class="comment">         * it's current item as the SELECTED item</span>
02964 <span class="comment">         */</span>
02965         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pp-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndNotify);
02966         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pp-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, &amp;tlpwndPopup);
02967         <a class="code" href="../../d4/d1/userk_8h.html#a1389">xxxSendMenuSelect</a>(pp-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, pp-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, pp-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, pp-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>);
02968         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndPopup);
02969         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
02970     }
02971 
02972     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02973 }
02974 
02975 <span class="comment">/***************************************************************************\</span>
02976 <span class="comment">*</span>
02977 <span class="comment">*  MNItemHitTest()</span>
02978 <span class="comment">*</span>
02979 <span class="comment">*  Given a hMenu and a point in screen coordinates, returns the position</span>
02980 <span class="comment">*  of the item the point is in.  Returns -1 if no item exists there.</span>
02981 <span class="comment">*</span>
02982 <span class="comment">\***************************************************************************/</span>
<a name="l02983"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a8">02983</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d1/d4/tooltips_8c.html#a8">MNItemHitTest</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, POINT pt)
02984 {
02985     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
02986     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    iItem;
02987     RECT    rect;
02988 
02989     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02990 
02991     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == 0)
02992         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
02993 
02994 
02995     <span class="comment">/*</span>
02996 <span class="comment">     * This point is screen-relative.  Menu bar coordinates relative</span>
02997 <span class="comment">     * to the window.  But popup menu coordinates are relative to the client.</span>
02998 <span class="comment">     */</span>
02999     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>)) {
03000 
03001         <span class="comment">/*</span>
03002 <span class="comment">         * Bail if it's outside rcWindow</span>
03003 <span class="comment">         */</span>
03004         <a class="code" href="../../d3/d6/rect_8c.html#a2">CopyInflateRect</a>(&amp;rect, &amp;(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>),
03005                 -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME), -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME));
03006 
03007         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rect, pt)) {
03008             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
03009         }
03010 
03011         <span class="comment">/* ScreenToClient */</span>
03012 <span class="preprocessor">#ifdef USE_MIRRORING</span>
03013 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
03014             pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pt.x;
03015         } <span class="keywordflow">else</span>
03016 <span class="preprocessor">#endif</span>
03017 <span class="preprocessor"></span>        {
03018             pt.x -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
03019         }
03020         pt.y -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
03021 
03022         <span class="comment">/*</span>
03023 <span class="comment">         * If on the non client area, then it's on the scroll arrows</span>
03024 <span class="comment">         */</span>
03025         <span class="keywordflow">if</span> (pt.y &lt; 0) {
03026             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a779">MFMWFP_UPARROW</a>;
03027         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pt.y &gt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>) {
03028             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a780">MFMWFP_DOWNARROW</a>;
03029         }
03030 
03031     } <span class="keywordflow">else</span> {
03032         <span class="comment">/* ScreenToWindow */</span>
03033 <span class="preprocessor">#ifdef USE_MIRRORING</span>
03034 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL) &amp;&amp;
03035             (
03036              (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a> == <a class="code" href="../../d4/d1/userk_8h.html#a466">SCREEN_CAPTURE</a>) || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a> == <a class="code" href="../../d4/d1/userk_8h.html#a463">NO_CAP_SYS</a>)
03037             )
03038            ) {
03039             pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pt.x;
03040         } <span class="keywordflow">else</span>
03041 <span class="preprocessor">#endif</span>
03042 <span class="preprocessor"></span>        {
03043             pt.x -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
03044         }
03045         pt.y -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
03046     }
03047 
03048     <span class="comment">/*</span>
03049 <span class="comment">     * Step through all the items in the menu.</span>
03050 <span class="comment">     * If scrollable menu</span>
03051 <span class="comment">     */</span>
03052     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a759">MSA_OFF</a>) {
03053         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>));
03054         pItem = <a class="code" href="../../d4/d1/userk_8h.html#a1324">MNGetToppItem</a>(pMenu);
03055         rect.left = rect.top = 0;
03056         rect.right = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
03057         rect.bottom = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
03058         <span class="keywordflow">for</span> (iItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o14">iTop</a>; (iItem &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) &amp;&amp; (rect.top &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>); iItem++) {
03059 
03060             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rect, pt)) {
03061                 <span class="keywordflow">return</span> iItem;
03062             }
03063 
03064             pItem++;
03065             rect.top = rect.bottom;
03066             rect.bottom += pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
03067         }
03068     } <span class="keywordflow">else</span> {
03069         <span class="comment">/*</span>
03070 <span class="comment">         * No scroll bars.</span>
03071 <span class="comment">         */</span>
03072         <span class="keywordflow">for</span> (iItem = 0, pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>; iItem &lt; pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; iItem++, pItem++) {
03073             <span class="comment">/* Is the mouse inside this item's rectangle? */</span>
03074             rect.left       = pItem-&gt;xItem;
03075             rect.top        = pItem-&gt;yItem;
03076             rect.right      = pItem-&gt;xItem + pItem-&gt;cxItem;
03077             rect.bottom     = pItem-&gt;yItem + pItem-&gt;cyItem;
03078 
03079             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rect, pt)) {
03080                 <span class="keywordflow">return</span>(iItem);
03081             }
03082         }
03083     }
03084 
03085 
03086     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>);
03087 }
03088 <span class="comment">/***************************************************************************\</span>
03089 <span class="comment">* LockMFMWFPWindow</span>
03090 <span class="comment">*</span>
03091 <span class="comment">* This function is called when we need to save the return value of</span>
03092 <span class="comment">*  xxxMNFindWindowFromPoint.</span>
03093 <span class="comment">*</span>
03094 <span class="comment">* History:</span>
03095 <span class="comment">* 11/14/96  GerardoB  Created</span>
03096 <span class="comment">\***************************************************************************/</span>
<a name="l03097"></a><a class="code" href="../../d4/d1/userk_8h.html#a1376">03097</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1376">LockMFMWFPWindow</a> (PULONG_PTR puHitArea, ULONG_PTR uNewHitArea)
03098 {
03099     <span class="comment">/*</span>
03100 <span class="comment">     * Bail if there is nothing to do.</span>
03101 <span class="comment">     */</span>
03102     <span class="keywordflow">if</span> (*puHitArea == uNewHitArea) {
03103         <span class="keywordflow">return</span>;
03104     }
03105 
03106     <span class="comment">/*</span>
03107 <span class="comment">     * Unlock current hit area</span>
03108 <span class="comment">     */</span>
03109     <a class="code" href="../../d4/d1/userk_8h.html#a1377">UnlockMFMWFPWindow</a>(puHitArea);
03110 
03111     <span class="comment">/*</span>
03112 <span class="comment">     * Lock new hit area</span>
03113 <span class="comment">     */</span>
03114     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1378">IsMFMWFPWindow</a>(uNewHitArea)) {
03115         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(puHitArea, (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)uNewHitArea);
03116     } <span class="keywordflow">else</span> {
03117         *puHitArea = uNewHitArea;
03118     }
03119 }
03120 <span class="comment">/***************************************************************************\</span>
03121 <span class="comment">* UnlockMFMWFPWindow</span>
03122 <span class="comment">*</span>
03123 <span class="comment">* You must called this if you ever called LockMFMWFPWindow</span>
03124 <span class="comment">*</span>
03125 <span class="comment">* History:</span>
03126 <span class="comment">* 11/14/96  GerardoB  Created</span>
03127 <span class="comment">\***************************************************************************/</span>
<a name="l03128"></a><a class="code" href="../../d4/d1/userk_8h.html#a1377">03128</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1377">UnlockMFMWFPWindow</a> (PULONG_PTR puHitArea)
03129 {
03130     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1378">IsMFMWFPWindow</a>(*puHitArea)) {
03131         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(puHitArea);
03132     } <span class="keywordflow">else</span> {
03133         *puHitArea = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>;
03134     }
03135 }
03136 <span class="comment">/***************************************************************************\</span>
03137 <span class="comment">* IsMFMWFPWindow</span>
03138 <span class="comment">*</span>
03139 <span class="comment">* Test whether or not the return value of xxxMNFindWindowFromPoint is</span>
03140 <span class="comment">*  a window. Not that uHitArea could be an HWND or a PWND.</span>
03141 <span class="comment">*</span>
03142 <span class="comment">* History:</span>
03143 <span class="comment">*   10-02-96 GerardoB   Created</span>
03144 <span class="comment">\***************************************************************************/</span>
<a name="l03145"></a><a class="code" href="../../d4/d1/userk_8h.html#a1378">03145</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1378">IsMFMWFPWindow</a> (ULONG_PTR uHitArea)
03146 {
03147     <span class="keywordflow">switch</span>(uHitArea) {
03148         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>:
03149         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>:
03150         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a782">MFMWFP_ALTMENU</a>:
03151             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03152 
03153         <span class="keywordflow">default</span>:
03154             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03155     }
03156 }
03157 <span class="comment">/***************************************************************************\</span>
03158 <span class="comment">* LONG MenuFindMenuWindowFromPoint(</span>
03159 <span class="comment">*         PPOPUPMENU ppopupmenu, PUINT pIndex, POINT screenPt)</span>
03160 <span class="comment">*</span>
03161 <span class="comment">* effects: Determines in which window the point lies.</span>
03162 <span class="comment">*</span>
03163 <span class="comment">* Returns</span>
03164 <span class="comment">*   - PWND of the hierarchical menu the point is on,</span>
03165 <span class="comment">*   - MFMWFP_ALTMENU if point lies on the alternate popup menu.</span>
03166 <span class="comment">*   - MFMWFP_NOITEM if there is no item at that point on the menu or the</span>
03167 <span class="comment">*      point lies on the menu bar.</span>
03168 <span class="comment">*   - MFMWFP_OFFMENU if point lies elsewhere.</span>
03169 <span class="comment">*</span>
03170 <span class="comment">* Returns in pIndex</span>
03171 <span class="comment">*   - the index of the item hit,</span>
03172 <span class="comment">*   - MFMWFP_NOITEM if there is no item at that point on the menu or</span>
03173 <span class="comment">*      point lies on the menu bar.</span>
03174 <span class="comment">*</span>
03175 <span class="comment">* History:</span>
03176 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
03177 <span class="comment">*   8-11-92 Sanfords added MFMWFP_ constants</span>
03178 <span class="comment">\***************************************************************************/</span>
03179 
<a name="l03180"></a><a class="code" href="../../d4/d1/userk_8h.html#a1379">03180</a> LONG_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1379">xxxMNFindWindowFromPoint</a>(
03181     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu,
03182     PUINT pIndex,
03183     POINTS screenPt)
03184 {
03185     POINT pt;
03186     RECT rect;
03187     LONG_PTR longHit;
03188     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> itemHit;
03189     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03190     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
03191 <span class="preprocessor">#ifdef USE_MIRRORING</span>
03192 <span class="preprocessor"></span>    <span class="keywordtype">int</span> cx;
03193 <span class="preprocessor">#endif</span>
03194 <span class="preprocessor"></span>
03195 
03196     *pIndex = 0;
03197 
03198     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>) {
03199 
03200         <span class="comment">/*</span>
03201 <span class="comment">         * Check if this point is on any of our children before checking if it</span>
03202 <span class="comment">         * is on ourselves.</span>
03203 <span class="comment">         */</span>
03204         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>, &amp;tlpwndT);
03205         longHit = <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>,
03206                 MN_FINDMENUWINDOWFROMPOINT, (WPARAM)&amp;itemHit,
03207                 MAKELONG(screenPt.x, screenPt.y));
03208         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03209 
03210         <span class="comment">/*</span>
03211 <span class="comment">         * If return value is an hwnd, convert to pwnd.</span>
03212 <span class="comment">         */</span>
03213         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1378">IsMFMWFPWindow</a>(longHit)) {
03214             longHit = (LONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)longHit);
03215         }
03216 
03217         <span class="keywordflow">if</span> (longHit) {
03218 
03219             <span class="comment">/*</span>
03220 <span class="comment">             * Hit occurred on one of our children.</span>
03221 <span class="comment">             */</span>
03222 
03223             *pIndex = itemHit;
03224             <span class="keywordflow">return</span> longHit;
03225         }
03226     }
03227 
03228     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
03229         <span class="keywordtype">int</span> cBorders;
03230 
03231          <span class="comment">/*</span>
03232 <span class="comment">          * Check if this point is on the menu bar</span>
03233 <span class="comment">          */</span>
03234         pwnd = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>;
03235         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03236             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>;
03237         }
03238 
03239         pt.x = screenPt.x;
03240         pt.y = screenPt.y;
03241 
03242         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>) {
03243 
03244             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a10">_HasCaptionIcon</a>(pwnd)) {
03245                 <span class="comment">/*</span>
03246 <span class="comment">                 * no system menu rect to click in if it doesn't have an icon</span>
03247 <span class="comment">                 */</span>
03248                 <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03249             }
03250 
03251             <span class="comment">/*</span>
03252 <span class="comment">             * Check if this is a click on the system menu icon.</span>
03253 <span class="comment">             */</span>
03254             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
03255 
03256                 <span class="comment">/*</span>
03257 <span class="comment">                 * If the window is minimized, then check if there was a hit in</span>
03258 <span class="comment">                 * the client area of the icon's window.</span>
03259 <span class="comment">                 */</span>
03260 
03261 <span class="comment">/*</span>
03262 <span class="comment"> * Mikehar 5/27</span>
03263 <span class="comment"> * Don't know how this ever worked. If we are the system menu of an icon</span>
03264 <span class="comment"> * we want to punt the menus if the click occurs ANYWHERE outside of the</span>
03265 <span class="comment"> * menu.</span>
03266 <span class="comment"> * Johnc 03-Jun-1992 the next 4 lines were commented out for Mike's</span>
03267 <span class="comment"> * problem above but that made clicking on a minimized window with</span>
03268 <span class="comment"> * the system menu already up, bring down the menu and put it right</span>
03269 <span class="comment"> * up again (bug 10951) because the mnloop wouldn't swallow the mouse</span>
03270 <span class="comment"> * down click message.  The problem Mike mentions no longer shows up.</span>
03271 <span class="comment"> */</span>
03272 
03273                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>), pt)) {
03274                     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
03275                 }
03276 
03277                 <span class="comment">/*</span>
03278 <span class="comment">                 * It's an iconic window, so can't be hitting anywhere else.</span>
03279 <span class="comment">                 */</span>
03280                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>;
03281             }
03282 
03283             <span class="comment">/*</span>
03284 <span class="comment">             * Check if we are hitting on the system menu rectangle on the top</span>
03285 <span class="comment">             * left of windows.</span>
03286 <span class="comment">             */</span>
03287             rect.top = rect.left = 0;
03288             rect.right  = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZE);
03289             rect.bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSIZE);
03290 
03291             cBorders = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a7">GetWindowBorders</a>(pwnd-&gt;style, pwnd-&gt;ExStyle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03292 
03293             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rect, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left + cBorders*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER),
03294                 pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top + cBorders*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
03295 <span class="preprocessor">#ifdef USE_MIRRORING</span>
03296 <span class="preprocessor"></span>            <span class="comment">//Mirror the rect because the buttons in the left hand side of the window if it mirrored</span>
03297             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
03298                 cx         = rect.right - rect.left;
03299                 rect.right = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - (rect.left - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left);
03300                 rect.left  = rect.right - cx;
03301             }
03302 <span class="preprocessor">#endif</span>
03303 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rect, pt)) {
03304                 *pIndex = 0;
03305                 <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>);
03306             }
03307             <span class="comment">/*</span>
03308 <span class="comment">             * Check if we hit in the alternate menu if available.</span>
03309 <span class="comment">             */</span>
03310             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>) {
03311                 itemHit = <a class="code" href="../../d1/d4/tooltips_8c.html#a8">MNItemHitTest</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>, pwnd, pt);
03312                 <span class="keywordflow">if</span> (itemHit != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
03313                     *pIndex = itemHit;
03314                     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a782">MFMWFP_ALTMENU</a>;
03315                 }
03316             }
03317             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>;
03318         } <span class="keywordflow">else</span> {
03319             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
03320 
03321                 <span class="comment">/*</span>
03322 <span class="comment">                 * If we are minimized, we can't hit on the main menu bar.</span>
03323 <span class="comment">                 */</span>
03324                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>;
03325             }
03326         }
03327     } <span class="keywordflow">else</span> {
03328         pwnd = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>;
03329 
03330         <span class="comment">/*</span>
03331 <span class="comment">         * else this is a popup window and we need to check if we are hitting</span>
03332 <span class="comment">         * anywhere on this popup window.</span>
03333 <span class="comment">         */</span>
03334         pt.x = screenPt.x;
03335         pt.y = screenPt.y;
03336         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, pt)) {
03337 
03338             <span class="comment">/*</span>
03339 <span class="comment">             * Point completely outside the popup menu window so return 0.</span>
03340 <span class="comment">             */</span>
03341             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>;
03342         }
03343     }
03344 
03345     pt.x = screenPt.x;
03346     pt.y = screenPt.y;
03347 
03348     itemHit = <a class="code" href="../../d1/d4/tooltips_8c.html#a8">MNItemHitTest</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, pwnd, pt);
03349 
03350     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
03351 
03352         <span class="comment">/*</span>
03353 <span class="comment">         * If hit is on menu bar but no item is there, treat it as if the user</span>
03354 <span class="comment">         * hit nothing.</span>
03355 <span class="comment">         */</span>
03356         <span class="keywordflow">if</span> (itemHit == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
03357 
03358             <span class="comment">/*</span>
03359 <span class="comment">             * Check if we hit in the alternate menu if available.</span>
03360 <span class="comment">             */</span>
03361             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>) {
03362                 itemHit = <a class="code" href="../../d1/d4/tooltips_8c.html#a8">MNItemHitTest</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>, pwnd, pt);
03363                 <span class="keywordflow">if</span> (itemHit != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
03364                     *pIndex = itemHit;
03365                     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a782">MFMWFP_ALTMENU</a>;
03366                 }
03367             }
03368             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>;
03369         }
03370 
03371         *pIndex = itemHit;
03372         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
03373     } <span class="keywordflow">else</span> {
03374 
03375         <span class="comment">/*</span>
03376 <span class="comment">         * If hit is on popup menu but no item is there, itemHit</span>
03377 <span class="comment">         * will be MFMWFP_NOITEM</span>
03378 <span class="comment">         */</span>
03379         *pIndex = itemHit;
03380         <span class="keywordflow">return</span> (LONG_PTR)pwnd;
03381     }
03382     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>;
03383 }
03384 
03385 <span class="comment">/***************************************************************************\</span>
03386 <span class="comment">*void MenuCancelMenus(PPOPUPMENU ppopupmenu,</span>
03387 <span class="comment">*                                UINT cmd, BOOL fSend)</span>
03388 <span class="comment">* Should only be sent to the top most ppopupmenu/menu window in the</span>
03389 <span class="comment">* hierarchy.</span>
03390 <span class="comment">*</span>
03391 <span class="comment">* History:</span>
03392 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
03393 <span class="comment">\***************************************************************************/</span>
03394 
<a name="l03395"></a><a class="code" href="../../d4/d1/userk_8h.html#a1371">03395</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1371">xxxMNCancel</a>(
03396     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState,
03397     UINT uMsg,
03398     UINT cmd,
03399     LPARAM lParam)
03400 {
03401     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>;
03402     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSynchronous   = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o8">fSynchronous</a>;
03403     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fTrackFlagsSet = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>;
03404     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIsSysMenu     = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>;
03405     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIsMenuBar     = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>;
03406     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNotify        = !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>;
03407     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
03408     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
03409     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndPopupMenu;
03410 
03411     <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu);
03412 
03413     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03414     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03415     <span class="comment">/*</span>
03416 <span class="comment">     * Mark the popup as destroyed so people will not use it anymore.</span>
03417 <span class="comment">     * This means that root popups can be marked as destroyed before</span>
03418 <span class="comment">     * actually being destroyed (nice and confusing).</span>
03419 <span class="comment">     */</span>
03420     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03421 
03422     <span class="comment">/*</span>
03423 <span class="comment">     * Only the menu loop owner can destroy the menu windows (i.e, xxxMNCloseHierarchy)</span>
03424 <span class="comment">     */</span>
03425     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a>) {
03426         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxMNCancel: Thread %#p doesn't own the menu loop"</span>, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
03427         <span class="keywordflow">return</span>;
03428     }
03429 
03430     <span class="comment">/*</span>
03431 <span class="comment">     * If the menu loop is running on a thread different than the thread</span>
03432 <span class="comment">     *  that owns spwndNotify, we can have two threads trying to cancel</span>
03433 <span class="comment">     *  this popup at the same time.</span>
03434 <span class="comment">     */</span>
03435     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o19">fInCancel</a>) {
03436         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxMNCancel: already in cancel. ppopupmenu:%#p"</span>, ppopupmenu);
03437         <span class="keywordflow">return</span>;
03438     }
03439     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o19">fInCancel</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03440 
03441     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, &amp;tlpwndPopupMenu);
03442 
03443     <span class="comment">/*</span>
03444 <span class="comment">     * Close all hierarchies from this point down.</span>
03445 <span class="comment">     */</span>
03446     <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupmenu, pMenuState);
03447 
03448     <span class="comment">/*</span>
03449 <span class="comment">     * Unselect any items on this top level window</span>
03450 <span class="comment">     */</span>
03451     <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>);
03452 
03453     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o1">fMenuStarted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03454 
03455     pwndT = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>;
03456 
03457     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT, &amp;tlpwndT);
03458 
03459     <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a6">xxxMNReleaseCapture</a>();
03460 
03461     <span class="keywordflow">if</span> (fTrackFlagsSet) {
03462         <span class="comment">/*</span>
03463 <span class="comment">         * Send a POPUPEND so people watching see them paired</span>
03464 <span class="comment">         */</span>
03465         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
03466             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUPOPUPEND,
03467                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, OBJID_CLIENT, 0, 0);
03468         }
03469 
03470         UserAssert(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> != ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;spwndMenu);
03471         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>);
03472     }
03473 
03474     <span class="keywordflow">if</span> (pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03475         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03476         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndPopupMenu);
03477         <span class="keywordflow">return</span>;
03478     }
03479 
03480     <span class="comment">/*</span>
03481 <span class="comment">     * SMS_NOMENU hack so we can send MenuSelect messages with</span>
03482 <span class="comment">     * (loword(lparam) = -1) when</span>
03483 <span class="comment">     * the menu pops back up for the CBT people. In 3.0, all WM_MENUSELECT</span>
03484 <span class="comment">     * messages went through the message filter so go through the function</span>
03485 <span class="comment">     * SendMenuSelect. We need to do this in 3.1 since WordDefect for Windows</span>
03486 <span class="comment">     * depends on this.</span>
03487 <span class="comment">     */</span>
03488     <a class="code" href="../../d4/d1/userk_8h.html#a1389">xxxSendMenuSelect</a>(pwndT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a551">SMS_NOMENU</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>);
03489 
03490     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
03491         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUEND, pwndT, (fIsSysMenu ?
03492             OBJID_SYSMENU : (fIsMenuBar ? OBJID_MENU : OBJID_WINDOW)),
03493             INDEXID_CONTAINER, 0);
03494     }
03495 
03496     <span class="keywordflow">if</span> (fNotify) {
03497     <span class="comment">/*</span>
03498 <span class="comment">     * Notify app we are exiting the menu loop.  Mainly for WinOldApp 386.</span>
03499 <span class="comment">     * wParam is 1 if a TrackPopupMenu else 0.</span>
03500 <span class="comment">     */</span>
03501         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndT, WM_EXITMENULOOP,
03502             ((fTrackFlagsSet &amp;&amp; !fIsSysMenu)? 1 : 0), 0);
03503     }
03504 
03505     <span class="keywordflow">if</span> (uMsg != 0) {
03506         <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a925">USER_SOUND_MENUCOMMAND</a>);
03507         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o23">cmdLast</a> = cmd;
03508         <span class="keywordflow">if</span> (!fSynchronous) {
03509             <span class="keywordflow">if</span> (!fIsSysMenu &amp;&amp; fTrackFlagsSet &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>)) {
03510                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndT, uMsg, cmd, lParam);
03511             } <span class="keywordflow">else</span> {
03512                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndT, uMsg, cmd, lParam);
03513             }
03514         }
03515     } <span class="keywordflow">else</span>
03516         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o23">cmdLast</a> = 0;
03517 
03518     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03519 
03520     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndPopupMenu);
03521 
03522 }
03523 <span class="comment">/***************************************************************************\</span>
03524 <span class="comment">* void MenuButtonDownHandler(PPOPUPMENU ppopupmenu, int posItemHit)</span>
03525 <span class="comment">* effects: Handles a mouse down on the menu associated with ppopupmenu at</span>
03526 <span class="comment">* item index posItemHit.  posItemHit could be MFMWFP_NOITEM if user hit on a</span>
03527 <span class="comment">* menu where no item exists.</span>
03528 <span class="comment">*</span>
03529 <span class="comment">* History:</span>
03530 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
03531 <span class="comment">\***************************************************************************/</span>
03532 
<a name="l03533"></a><a class="code" href="../../d4/d1/userk_8h.html#a1368">03533</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1368">xxxMNButtonDown</a>(
03534     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu,
03535     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState,
03536     UINT posItemHit, BOOL fClick)
03537 {
03538     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
03539     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fOpenHierarchy;
03540 
03541     <span class="comment">/*</span>
03542 <span class="comment">     * A different item was hit than is currently selected, so select it</span>
03543 <span class="comment">     * and drop its menu if available.  Make sure we toggle click state.</span>
03544 <span class="comment">     */</span>
03545     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> != posItemHit) {
03546         <span class="comment">/*</span>
03547 <span class="comment">         * We are clicking on a new item, not moving the mouse over to it.</span>
03548 <span class="comment">         * So reset cancel toggle state.  We don't want button up from</span>
03549 <span class="comment">         * this button down to cancel.</span>
03550 <span class="comment">         */</span>
03551         <span class="keywordflow">if</span> (fClick) {
03552             fOpenHierarchy = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03553             ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03554         }
03555         <span class="keywordflow">else</span>
03556         {
03557             fOpenHierarchy = (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o10">fDropNextPopup</a> != 0);
03558         }
03559 
03560 
03561         <span class="comment">/*</span>
03562 <span class="comment">         * If the item has a popup and isn't disabled, open it.  Note that</span>
03563 <span class="comment">         * selecting this item will cancel any hierarchies associated with</span>
03564 <span class="comment">         * the previously selected item.</span>
03565 <span class="comment">         */</span>
03566         pItem = <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, posItemHit);
03567         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a17">MNIsPopupItem</a>(pItem) &amp;&amp; fOpenHierarchy) {
03568             <span class="comment">/* Punt if menu was destroyed. */</span>
03569             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(ppopupmenu, pMenuState) == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)-1) {
03570                 <span class="keywordflow">return</span>;
03571             }
03572         }
03573     } <span class="keywordflow">else</span> {
03574         <span class="comment">/*</span>
03575 <span class="comment">         * We are moving over to the already-selected item.  If we are</span>
03576 <span class="comment">         * clicking for real, reset cancel toggle state.  We want button</span>
03577 <span class="comment">         * up to cancel if on same item.  Otherwise, do nothing if just</span>
03578 <span class="comment">         * moving...</span>
03579 <span class="comment">         */</span>
03580         <span class="keywordflow">if</span> (fClick) {
03581             ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03582         }
03583 
03584         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a26">xxxMNHideNextHierarchy</a>(ppopupmenu) &amp;&amp; fClick &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(ppopupmenu, pMenuState))
03585             ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03586     }
03587 
03588     <span class="keywordflow">if</span> (fClick) {
03589         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03590         <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a15">xxxMNDoScroll</a>(ppopupmenu, posItemHit, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03591     }
03592 }
03593 
03594 <span class="comment">/***************************************************************************\</span>
03595 <span class="comment">* MNSetTimerToAutoDissmiss</span>
03596 <span class="comment">*</span>
03597 <span class="comment">* History:</span>
03598 <span class="comment">*  11/14/96 GerardoB  Created</span>
03599 <span class="comment">\***************************************************************************/</span>
<a name="l03600"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a37">03600</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a37">MNSetTimerToAutoDismiss</a>(<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
03601 {
03602     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o12">fAutoDismiss</a> &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o13">fAboutToAutoDismiss</a>) {
03603         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1241">_SetTimer</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a48">IDSYS_MNAUTODISMISS</a>, 16 * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a94">gdtMNDropDown</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03604             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o13">fAboutToAutoDismiss</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03605         } <span class="keywordflow">else</span> {
03606             RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxMNMouseMove: Failed to set autodismiss timer"</span>);
03607         }
03608     }
03609 }
03610 <span class="comment">/***************************************************************************\</span>
03611 <span class="comment">* void MenuMouseMoveHandler(PPOPUPMENU ppopupmenu, POINT screenPt)</span>
03612 <span class="comment">* Handles a mouse move to the given point.</span>
03613 <span class="comment">*</span>
03614 <span class="comment">* History:</span>
03615 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
03616 <span class="comment">\***************************************************************************/</span>
03617 
<a name="l03618"></a><a class="code" href="../../d4/d1/userk_8h.html#a1380">03618</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1380">xxxMNMouseMove</a>(
03619     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup,
03620     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState,
03621     POINTS ptScreen)
03622 {
03623     LONG_PTR cmdHitArea;
03624     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uFlags;
03625     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cmdItem;
03626     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03627     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
03628 
03629 
03630     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopup)) {
03631         RIPMSG0(RIP_ERROR,
03632             <span class="stringliteral">"MenuMouseMoveHandler() called for a non top most menu"</span>);
03633         <span class="keywordflow">return</span>;
03634     }
03635 
03636     <span class="comment">/*</span>
03637 <span class="comment">     * Ignore mouse moves that aren't really moves.  MSTEST jiggles</span>
03638 <span class="comment">     * the mouse for some reason.  And windows coming and going will</span>
03639 <span class="comment">     * force mouse moves, to reset the cursor.</span>
03640 <span class="comment">     */</span>
03641     <span class="keywordflow">if</span> ((ptScreen.x == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.x) &amp;&amp; (ptScreen.y == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.y))
03642         <span class="keywordflow">return</span>;
03643 
03644     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.x = ptScreen.x;
03645     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.y = ptScreen.y;
03646 
03647     <span class="comment">/*</span>
03648 <span class="comment">     * Find out where this mouse move occurred.</span>
03649 <span class="comment">     */</span>
03650     cmdHitArea = <a class="code" href="../../d4/d1/userk_8h.html#a1379">xxxMNFindWindowFromPoint</a>(ppopup, &amp;cmdItem, ptScreen);
03651 
03652     <span class="comment">/*</span>
03653 <span class="comment">     * If coming from an IDropTarget call out, remember the hit test</span>
03654 <span class="comment">     */</span>
03655     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a>) {
03656         <a class="code" href="../../d4/d1/userk_8h.html#a1419">xxxMNUpdateDraggingInfo</a>(pMenuState, cmdHitArea, cmdItem);
03657     }
03658 
03659     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o22">mnFocus</a> == <a class="code" href="../../d4/d1/userk_8h.html#a333">KEYBDHOLD</a>) {
03660         <span class="comment">/*</span>
03661 <span class="comment">         * Ignore mouse moves when in keyboard mode if the mouse isn't over any</span>
03662 <span class="comment">         * menu at all.  Also ignore mouse moves if over minimized window,</span>
03663 <span class="comment">         * because we pretend that its entire window is like system menu.</span>
03664 <span class="comment">         */</span>
03665         <span class="keywordflow">if</span> ((cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>) ||
03666             ((cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))) {
03667             <span class="keywordflow">return</span>;
03668         }
03669 
03670         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o22">mnFocus</a> = <a class="code" href="../../d4/d1/userk_8h.html#a332">MOUSEHOLD</a>;
03671     }
03672 
03673     <span class="keywordflow">if</span> (cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a782">MFMWFP_ALTMENU</a>) {
03674         <span class="comment">/*</span>
03675 <span class="comment">         * User clicked in the other menu so switch to it ONLY IF</span>
03676 <span class="comment">         * MOUSE IS DOWN.  Usability testing proves that people frequently</span>
03677 <span class="comment">         * get kicked into the system menu accidentally when browsing the</span>
03678 <span class="comment">         * menu bar.  We support the Win3.1 behavior when the mouse is</span>
03679 <span class="comment">         * down however.</span>
03680 <span class="comment">         */</span>
03681         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) {
03682             <a class="code" href="../../d4/d1/userk_8h.html#a1370">xxxMNSwitchToAlternateMenu</a>(ppopup);
03683             cmdHitArea = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
03684         } <span class="keywordflow">else</span>
03685             <span class="keywordflow">goto</span> OverNothing;
03686     }
03687 
03688     <span class="keywordflow">if</span> (cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
03689         <span class="comment">/*</span>
03690 <span class="comment">         * Mouse move occurred to an item in the main menu bar. If the item</span>
03691 <span class="comment">         * is different than the one already selected, close up the current</span>
03692 <span class="comment">         * one, select the new one and drop its menu. But if the item is the</span>
03693 <span class="comment">         * same as the one currently selected, we need to pull up any popups</span>
03694 <span class="comment">         * if needed and just keep the current level visible.  Hey, this is</span>
03695 <span class="comment">         * the same as a mousedown so lets do that instead.</span>
03696 <span class="comment">         */</span>
03697         <a class="code" href="../../d4/d1/userk_8h.html#a1368">xxxMNButtonDown</a>(ppopup, pMenuState, cmdItem, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03698         <span class="keywordflow">return</span>;
03699     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmdHitArea != 0) {
03700         <span class="comment">/* This is a popup window we moved onto. */</span>
03701         pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)(cmdHitArea);
03702         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwndT);
03703 
03704         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>));
03705 
03706         <span class="comment">/*</span>
03707 <span class="comment">         * Modeless menus don't capture the mouse, so track it to know</span>
03708 <span class="comment">         *  when it leaves the popup.</span>
03709 <span class="comment">         */</span>
03710         ppopup = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwnd)-&gt;ppopupmenu;
03711         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>
03712                 &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a>
03713                 &amp;&amp; !ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o20">fTrackMouseEvent</a>) {
03714 
03715             TRACKMOUSEEVENT tme;
03716 
03717             <span class="comment">/* tme.cbSize = sizeof(TRACKMOUSEEVENT); Not checked on kernel side */</span>
03718             tme.dwFlags = TME_LEAVE;
03719             tme.hwndTrack = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd);
03720             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a47">TrackMouseEvent</a>(&amp;tme);
03721             ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o20">fTrackMouseEvent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03722 
03723             <span class="comment">/*</span>
03724 <span class="comment">             * We just entered this window so make sure the cursor</span>
03725 <span class="comment">             *  is properly set.</span>
03726 <span class="comment">             */</span>
03727             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_SETCURSOR, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), MAKELONG(MSGF_MENU, 0));
03728 
03729         }
03730 
03731         <span class="comment">/*</span>
03732 <span class="comment">         * Select the item.</span>
03733 <span class="comment">         */</span>
03734         uFlags = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, MN_SELECTITEM, (WPARAM)cmdItem, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03735         <span class="keywordflow">if</span> ((uFlags &amp; MF_POPUP) &amp;&amp; !(uFlags &amp; MFS_GRAYED)) {
03736            <span class="comment">/*</span>
03737 <span class="comment">            * User moved back onto an item with a hierarchy.  Hide the</span>
03738 <span class="comment">            * the dropped popup.</span>
03739 <span class="comment">            */</span>
03740            <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, MN_SETTIMERTOOPENHIERARCHY, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
03741                 <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a26">xxxMNHideNextHierarchy</a>(ppopup);
03742            }
03743         }
03744         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03745     } <span class="keywordflow">else</span>
03746 OverNothing:
03747     {
03748         <span class="comment">/* We moved off all menu windows... */</span>
03749         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03750             pwnd = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>;
03751 
03752             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwndT);
03753             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, MN_SELECTITEM, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03754             <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a37">MNSetTimerToAutoDismiss</a>(pMenuState, pwnd);
03755             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03756         } <span class="keywordflow">else</span> {
03757             <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopup, pMenuState, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>);
03758         }
03759 
03760     }
03761 }
03762 
03763 
03764 <span class="comment">/***************************************************************************\</span>
03765 <span class="comment">* void MenuButtonUpHandler(PPOPUPMENU ppopupmenu, int posItemHit)</span>
03766 <span class="comment">* effects: Handles a mouse button up at the given point.</span>
03767 <span class="comment">*</span>
03768 <span class="comment">* History:</span>
03769 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
03770 <span class="comment">\***************************************************************************/</span>
03771 
<a name="l03772"></a><a class="code" href="../../d4/d1/userk_8h.html#a1367">03772</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1367">xxxMNButtonUp</a>(
03773     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup,
03774     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState,
03775     UINT posItemHit,
03776     LPARAM lParam)
03777 {
03778     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
03779 
03780     <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) {
03781 
03782         <span class="comment">/*</span>
03783 <span class="comment">         * Ignore if button was never down...  Really shouldn't happen...</span>
03784 <span class="comment">         */</span>
03785         <span class="keywordflow">return</span>;
03786     }
03787 
03788     <span class="keywordflow">if</span> (posItemHit == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
03789         RIPMSG0(RIP_WARNING, <span class="stringliteral">"button up on no item"</span>);
03790         <span class="keywordflow">goto</span> ExitButtonUp;
03791     }
03792 
03793     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> != posItemHit) {
03794         <span class="keywordflow">goto</span> ExitButtonUp;
03795     }
03796 
03797     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
03798 
03799         <span class="comment">/*</span>
03800 <span class="comment">         * Handle button up in menubar specially.</span>
03801 <span class="comment">         */</span>
03802         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a>) {
03803             <span class="keywordflow">if</span> (!ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a>) {
03804                 <span class="keywordflow">goto</span> ExitButtonUp;
03805             } <span class="keywordflow">else</span> {
03806                 <span class="comment">/*</span>
03807 <span class="comment">                 * Cancel menu now.</span>
03808 <span class="comment">                 */</span>
03809                 ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03810                 <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
03811                 <span class="keywordflow">return</span>;
03812             }
03813         }
03814     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a>) {
03815         ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03816 
03817         <span class="comment">/*</span>
03818 <span class="comment">         * Open hierarchy on popup</span>
03819 <span class="comment">         */</span>
03820         <a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(ppopup, pMenuState);
03821 
03822         <span class="keywordflow">goto</span> ExitButtonUp;
03823     }
03824 
03825     <span class="comment">/*</span>
03826 <span class="comment">     * If nothing is selected, get out.  This occurs mainly on unbalanced</span>
03827 <span class="comment">     * multicolumn menus where one of the columns isn't completely full.</span>
03828 <span class="comment">     */</span>
03829     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>)
03830         <span class="keywordflow">goto</span> ExitButtonUp;
03831 
03832     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> &gt;= ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)
03833         <span class="keywordflow">goto</span> ExitButtonUp;
03834 
03835     <span class="comment">/*</span>
03836 <span class="comment">     * Get a pointer to the currently selected item in this menu.</span>
03837 <span class="comment">     */</span>
03838     pItem = &amp;(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>]);
03839 
03840     <span class="comment">/*</span>
03841 <span class="comment">     * Kick out of menu mode if user clicked on a non-separator, enabled,</span>
03842 <span class="comment">     * non-hierarchical item.</span>
03843 <span class="comment">     *</span>
03844 <span class="comment">     * BOGUS</span>
03845 <span class="comment">     * Why doesn't MFS_GRAYED check work for separators now?  Find out later.</span>
03846 <span class="comment">     */</span>
03847     <span class="keywordflow">if</span> (!(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a> &amp; MFT_SEPARATOR)
03848             &amp;&amp; !(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp; MFS_GRAYED)
03849             &amp;&amp; (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03850 
03851         <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a3">xxxMNDismissWithNotify</a>(pMenuState, ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, pItem,
03852                                ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>, lParam);
03853         <span class="keywordflow">return</span>;
03854     }
03855 
03856 ExitButtonUp:
03857     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> =
03858     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o7">fButtonAlwaysDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03859 }
03860 
03861 
03862 <span class="comment">/***************************************************************************\</span>
03863 <span class="comment">*UINT MenuSetTimerToOpenHierarchy(PPOPUPMENU ppopupmenu)</span>
03864 <span class="comment">* Given the current selection, set a timer to show this hierarchy if</span>
03865 <span class="comment">* valid else return 0. If a timer should be set but couldn't return -1.</span>
03866 <span class="comment">*</span>
03867 <span class="comment">* History:</span>
03868 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
03869 <span class="comment">\***************************************************************************/</span>
<a name="l03870"></a><a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a40">03870</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a40">MNSetTimerToOpenHierarchy</a>(
03871     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup)
03872 {
03873     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
03874 
03875     <span class="comment">/*</span>
03876 <span class="comment">     * No selection so fail</span>
03877 <span class="comment">     */</span>
03878     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>)
03879         <span class="keywordflow">return</span>(0);
03880 
03881     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> &gt;= ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)
03882         <span class="keywordflow">return</span>(0);
03883 
03884     <span class="comment">/*</span>
03885 <span class="comment">     * Is item an enabled popup?</span>
03886 <span class="comment">     * Get a pointer to the currently selected item in this menu.</span>
03887 <span class="comment">     */</span>
03888     pItem = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>;
03889     <span class="keywordflow">if</span> ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp; MFS_GRAYED))
03890         <span class="keywordflow">return</span>(0);
03891 
03892     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a>
03893         || (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a>
03894             &amp;&amp; (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> == ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a>))) {
03895 
03896         <span class="comment">/*</span>
03897 <span class="comment">         * A timer is already set or the hierarchy is already opened.</span>
03898 <span class="comment">         */</span>
03899         <span class="keywordflow">return</span> 1;
03900     }
03901 
03902     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1241">_SetTimer</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a55">IDSYS_MNSHOW</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a94">gdtMNDropDown</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
03903         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
03904 
03905     ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03906 
03907     <span class="keywordflow">return</span> 1;
03908 }
03909 
03910 
03911 
03912 <span class="comment">/***************************************************************************\</span>
03913 <span class="comment">* MNSetTimerToCloseHierarchy</span>
03914 <span class="comment">*</span>
03915 <span class="comment">\***************************************************************************/</span>
03916 
<a name="l03917"></a><a class="code" href="../../d4/d1/userk_8h.html#a1364">03917</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1364">MNSetTimerToCloseHierarchy</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup)
03918 {
03919 
03920     <span class="keywordflow">if</span> (!ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a>)
03921         <span class="keywordflow">return</span>(0);
03922 
03923     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o14">fHideTimer</a>)
03924         <span class="keywordflow">return</span>(1);
03925 
03926     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1241">_SetTimer</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a57">IDSYS_MNHIDE</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a94">gdtMNDropDown</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
03927         <span class="keywordflow">return</span>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>) -1);
03928 
03929     ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o14">fHideTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03930 
03931     ppopup = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>))-&gt;ppopupmenu;
03932     ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o12">fAboutToHide</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03933 
03934     <span class="keywordflow">return</span>(1);
03935 }
03936 
03937 
03938 <span class="comment">/***************************************************************************\</span>
03939 <span class="comment">* xxxCallHandleMenuMessages</span>
03940 <span class="comment">*</span>
03941 <span class="comment">* Modeless menus don't have a modal loop so we don't see the messages until</span>
03942 <span class="comment">*  they are dispatched to xxxMenuWindowProc. So we call this function to</span>
03943 <span class="comment">*  process the message just like we would in the modal case, only that</span>
03944 <span class="comment">*  the message has already been pulled out of the queue.</span>
03945 <span class="comment">* This is also calledfrom xxxScanSysQueue to pass mouse messages on the menu</span>
03946 <span class="comment">*  bar or from xxxMNDragOver to upadate the mouse position when being draged over.</span>
03947 <span class="comment">*</span>
03948 <span class="comment">* History:</span>
03949 <span class="comment">* 10/25/96 GerardoB  Created</span>
03950 <span class="comment">\***************************************************************************/</span>
<a name="l03951"></a><a class="code" href="../../d4/d1/userk_8h.html#a1398">03951</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1398">xxxCallHandleMenuMessages</a>(<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam)
03952 {
03953     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fHandled;
03954     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
03955 
03956     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
03957 
03958     UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> || pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a>);
03959 
03960     <span class="comment">/*</span>
03961 <span class="comment">     * Since modeless menus don't capture the mouse, then we need to</span>
03962 <span class="comment">     *  keep checking on the mouse button when the mouse is off the</span>
03963 <span class="comment">     *  menu.</span>
03964 <span class="comment">     * Note that we do not set fMouseOffMenu if fInDoDragDrop is set</span>
03965 <span class="comment">     */</span>
03966     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o15">fMouseOffMenu</a> &amp;&amp; pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) {
03967         UserAssert(!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a> &amp;&amp; pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>);
03968         <a class="code" href="../../d4/d1/userk_8h.html#a1358">MNCheckButtonDownState</a>(pMenuState);
03969     }
03970 
03971     <span class="comment">/*</span>
03972 <span class="comment">     * Setup the msg structure</span>
03973 <span class="comment">     */</span>
03974     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
03975     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message = message;
03976     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam = wParam;
03977 
03978     <span class="comment">/*</span>
03979 <span class="comment">     * xxxHandleMenuMessages expects screen coordinates</span>
03980 <span class="comment">     */</span>
03981     <span class="keywordflow">if</span> ((message &gt;= WM_MOUSEFIRST) &amp;&amp; (message &lt;= WM_MOUSELAST)) {
03982         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam = MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam) + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
03983                               <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam) + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
03984     } <span class="keywordflow">else</span> {
03985         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam = lParam;
03986     }
03987 
03988     <span class="comment">/*</span>
03989 <span class="comment">     * Not used by xxxHandleMenuMessages</span>
03990 <span class="comment">     */</span>
03991     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.time = 0;
03992     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.pt.x = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.pt.x = 0;
03993 
03994 
03995     UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03996 
03997     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o10">fInCallHandleMenuMessages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03998     fHandled = <a class="code" href="../../d4/d1/userk_8h.html#a1399">xxxHandleMenuMessages</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, pMenuState, pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>);
03999     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o10">fInCallHandleMenuMessages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04000 
04001     <span class="comment">/*</span>
04002 <span class="comment">     * If the message was handled and this is a modeless menu,</span>
04003 <span class="comment">     *  check to see if it's time to go.</span>
04004 <span class="comment">     */</span>
04005     <span class="keywordflow">if</span> (fHandled
04006             &amp;&amp; pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>
04007             &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a> (pMenuState, pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>)) {
04008 
04009         <a class="code" href="../../d4/d1/userk_8h.html#a1400">xxxEndMenuLoop</a> (pMenuState, pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>);
04010         <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04011     }
04012 
04013     <span class="keywordflow">return</span> fHandled;
04014 }
04015 <span class="comment">/***************************************************************************\</span>
04016 <span class="comment">*</span>
04017 <span class="comment">* History:</span>
04018 <span class="comment">*  05-25-91 Mikehar Ported from Win3.1</span>
04019 <span class="comment">*  08-12-96 jparsons Catch NULL lParam on WM_CREATE [51986]</span>
04020 <span class="comment">\***************************************************************************/</span>
04021 
<a name="l04022"></a><a class="code" href="../../d4/d1/userk_8h.html#a1366">04022</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1366">xxxMenuWindowProc</a>(
04023     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
04024     UINT message,
04025     WPARAM wParam,
04026     LPARAM lParam)
04027 {
04028     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIsRecursedMenu;
04029     LRESULT lRet;
04030     PAINTSTRUCT ps;
04031     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu;
04032     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
04033     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>      pmenu;
04034     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>      pItem;
04035     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
04036     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNotify;
04037     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk;
04038     POINT ptOrg;
04039     HDC hdcAni;
04040 
04041     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
04042 
04043     <a class="code" href="../../d6/d0/usercli_8h.html#a28">VALIDATECLASSANDSIZE</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>, WM_NCCREATE);
04044 
04045     <span class="comment">/*</span>
04046 <span class="comment">     * If we're not in menu mode or this window is just being created,</span>
04047 <span class="comment">     *  there are only few messages we care about.</span>
04048 <span class="comment">     */</span>
04049     pMenuState = <a class="code" href="../../d4/d1/userk_8h.html#a1320">GetpMenuState</a>(pwnd);
04050     ppopupmenu = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwnd)-&gt;ppopupmenu;
04051     pmenu = (ppopupmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04052     <span class="keywordflow">if</span> ((pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04053         <span class="keywordflow">switch</span> (message) {
04054             <span class="keywordflow">case</span> WM_NCCREATE:
04055             <span class="keywordflow">case</span> WM_FINALDESTROY:
04056                 <span class="keywordflow">break</span>;
04057 
04058             <span class="keywordflow">case</span> MN_SETHMENU:
04059                 <span class="keywordflow">if</span> (ppopupmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04060                     <span class="keywordflow">break</span>;
04061                 } <span class="keywordflow">else</span> {
04062                     <span class="keywordflow">return</span> 0;
04063                 }
04064 
04065             <span class="keywordflow">default</span>:
04066                 <span class="keywordflow">goto</span> CallDWP;
04067         }
04068     } <span class="keywordflow">else</span> {
04069         <span class="comment">/*</span>
04070 <span class="comment">         * TPM_RECURSE support: make sure we grab the proper pMenuState.</span>
04071 <span class="comment">         */</span>
04072         fIsRecursedMenu = ((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04073                             &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1329">IsRecursedMenuState</a>(pMenuState, ppopupmenu));
04074         <span class="keywordflow">if</span> (fIsRecursedMenu) {
04075             <span class="keywordflow">while</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1329">IsRecursedMenuState</a>(pMenuState, ppopupmenu)
04076                     &amp;&amp; (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o26">pmnsPrev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04077                 pMenuState = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o26">pmnsPrev</a>;
04078             }
04079             UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a> == ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a>);
04080         }
04081 
04082         <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu);
04083 
04084         <span class="comment">/*</span>
04085 <span class="comment">         * If this is a modeless menu, give xxxHandleMenuMessages the first</span>
04086 <span class="comment">         *  shot at the message</span>
04087 <span class="comment">         */</span>
04088         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o10">fInCallHandleMenuMessages</a>) {
04089             <span class="comment">/*</span>
04090 <span class="comment">             * If this is a recursed menu, we don't want to process any</span>
04091 <span class="comment">             *  input for it until the current menu goes away.</span>
04092 <span class="comment">             */</span>
04093             <span class="keywordflow">if</span> (fIsRecursedMenu) {
04094                 <span class="keywordflow">if</span> (((message &gt;= WM_MOUSEFIRST) &amp;&amp; (message &lt;= WM_MOUSELAST))
04095                         || ((message &gt;= WM_KEYFIRST) &amp;&amp; (message &lt;= WM_KEYLAST))
04096                         || ((message &gt;= WM_NCMOUSEFIRST) &amp;&amp; (message &lt;= WM_NCMOUSELAST))) {
04097 
04098                     <span class="keywordflow">goto</span> CallDWP;
04099                 }
04100             } <span class="keywordflow">else</span> {
04101                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1398">xxxCallHandleMenuMessages</a>(pMenuState, pwnd, message, wParam, lParam)) {
04102                     <span class="keywordflow">return</span> 0;
04103                 }
04104             }
04105         }
04106     } <span class="comment">/* else of if ((pMenuState == NULL) || (ppopupmenu == NULL)) */</span>
04107 
04108     <span class="keywordflow">switch</span> (message) {
04109     <span class="keywordflow">case</span> WM_NCCREATE:
04110         <span class="comment">/*</span>
04111 <span class="comment">         * Ignore evil messages to prevent leaks.</span>
04112 <span class="comment">         * Use RIP_ERROR for a while to make sure to see if we're getting here</span>
04113 <span class="comment">         */</span>
04114         <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwnd)-&gt;ppopupmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04115             RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxMenuWindowProc: evil WM_NCCREATE. already initialized. pwnd:%p"</span>, pwnd);
04116             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04117         }
04118         ppopupmenu = <a class="code" href="../../d4/d1/userk_8h.html#a1393">MNAllocPopup</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04119         <span class="keywordflow">if</span> (ppopupmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04120             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04121         }
04122 
04123         ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwnd)-&gt;ppopupmenu = ppopupmenu;
04124         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
04125         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>), pwnd);
04126         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04127 
04128     <span class="keywordflow">case</span> WM_NCCALCSIZE:
04129         <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam);
04130         <span class="keywordflow">if</span> (pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a759">MSA_OFF</a>) {
04131             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>((PRECT)lParam, 0, -<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a144">gcyMenuScrollArrow</a>);
04132         }
04133         <span class="keywordflow">break</span>;
04134 
04135     <span class="keywordflow">case</span> WM_ERASEBKGND:
04136         <span class="keywordflow">if</span> (pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o13">hbrBack</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04137             <a class="code" href="../../d4/d1/userk_8h.html#a1342">MNEraseBackground</a> ((HDC) wParam, pmenu,
04138                     0, 0,
04139                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
04140                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
04141             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04142         } <span class="keywordflow">else</span> {
04143             <span class="keywordflow">goto</span> CallDWP;
04144         }
04145         <span class="keywordflow">break</span>;
04146 
04147     <span class="keywordflow">case</span> WM_PRINT:
04148          <span class="comment">/*</span>
04149 <span class="comment">          * default processing of WM_PRINT does not handle custom non-</span>
04150 <span class="comment">          * client painting -- which scrollable menus have -- so take</span>
04151 <span class="comment">          * care of drawing nonclient area and then let DefWindowProc</span>
04152 <span class="comment">          * handle the rest</span>
04153 <span class="comment">          */</span>
04154         <span class="keywordflow">if</span> ((lParam &amp; PRF_NONCLIENT) &amp;&amp; (pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a759">MSA_OFF</a>)) {
04155 
04156             <a class="code" href="../../d4/d1/userk_8h.html#a1340">MNDrawFullNC</a>(pwnd, (HDC)wParam, ppopupmenu);
04157             GreGetWindowOrg((HDC)wParam, &amp;ptOrg);
04158             GreSetWindowOrg((HDC)wParam,
04159                   ptOrg.x - <a class="code" href="../../d4/d1/userk_8h.html#a526">MNXBORDER</a>,
04160                   ptOrg.y - <a class="code" href="../../d4/d1/userk_8h.html#a527">MNYBORDER</a> - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a144">gcyMenuScrollArrow</a>,
04161                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04162             <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam &amp; ~PRF_NONCLIENT);
04163             GreSetWindowOrg((HDC)wParam, ptOrg.x, ptOrg.y, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04164 
04165         } <span class="keywordflow">else</span> {
04166             <span class="keywordflow">goto</span> CallDWP;
04167         }
04168         <span class="keywordflow">break</span>;
04169 
04170     <span class="keywordflow">case</span> WM_WINDOWPOSCHANGING:
04171         <span class="keywordflow">if</span> (!(((LPWINDOWPOS)lParam)-&gt;flags &amp; SWP_SHOWWINDOW))
04172             <span class="keywordflow">goto</span> CallDWP;
04173 
04174         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a567">TestEffectUP</a>(MENUANIMATION) || !(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a541">PAS_OUT</a>)
04175             || (<a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) &amp; GACF2_ANIMATIONOFF)) {
04176 NoAnimation:
04177             ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a541">PAS_OUT</a>;
04178             <span class="keywordflow">goto</span> CallDWP;
04179         }
04180 
04181         <span class="comment">/*</span>
04182 <span class="comment">         * Create the animation bitmap.</span>
04183 <span class="comment">         */</span>
04184         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o38">cxAni</a> = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
04185         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o39">cyAni</a> = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
04186 
04187         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a666">TestALPHA</a>(MENUFADE)) {
04188             <span class="keywordflow">if</span> ((hdcAni = <a class="code" href="../../d4/d1/userk_8h.html#a1977">CreateFade</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a890">CMS_MENUFADE</a>,
04189                     <a class="code" href="../../d4/d1/userk_8h.html#a684">FADE_SHOW</a> | <a class="code" href="../../d4/d1/userk_8h.html#a688">FADE_MENU</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04190                 <span class="keywordflow">goto</span> NoAnimation;
04191             }
04192         } <span class="keywordflow">else</span> {
04193 
04194             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1348">MNCreateAnimationBitmap</a>(pMenuState, pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o38">cxAni</a>,
04195                     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o39">cyAni</a>)) {
04196                 <span class="keywordflow">goto</span> NoAnimation;
04197             }
04198 
04199             <span class="comment">/*</span>
04200 <span class="comment">             * We shouldn't be animating at this time.</span>
04201 <span class="comment">             */</span>
04202             UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o34">hdcWndAni</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04203 
04204             <span class="comment">/*</span>
04205 <span class="comment">             * This window must be the active popup</span>
04206 <span class="comment">             */</span>
04207             UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a> == pwnd);
04208 
04209             <span class="comment">/*</span>
04210 <span class="comment">             * Initialize animation info</span>
04211 <span class="comment">             */</span>
04212             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o34">hdcWndAni</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>, DCX_WINDOW | DCX_USESTYLE | DCX_INTERSECTRGN);
04213             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o20">iAniDropDir</a> = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a>;
04214             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o36">ixAni</a> = (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o20">iAniDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>) ? 0 : pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o38">cxAni</a>;
04215             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o37">iyAni</a> = (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o20">iAniDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a543">PAS_VERT</a>) ? 0 : pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o39">cyAni</a>;
04216             hdcAni = pMenuState-&gt;hdcAni;
04217         }
04218 
04219         <span class="comment">/*</span>
04220 <span class="comment">         * MFWINDOWDC is used by MNEraseBackground to determine where the</span>
04221 <span class="comment">         *  brush org should be set.</span>
04222 <span class="comment">         */</span>
04223         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a145">MFWINDOWDC</a>);
04224 
04225         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_PRINT, (WPARAM)hdcAni, PRF_CLIENT | PRF_NONCLIENT | PRF_ERASEBKGND);
04226 
04227         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a785">ClearMF</a>(pmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a145">MFWINDOWDC</a>);
04228 
04229         <span class="comment">/*</span>
04230 <span class="comment">         *If owner draw, we just passed hdcAni to the client side.</span>
04231 <span class="comment">         *  The app might have deleted it (??); no blue screen seems to</span>
04232 <span class="comment">         *  happen but only painting on that DC will fail from</span>
04233 <span class="comment">         *  now on. I won't waste time handling this unless it turns</span>
04234 <span class="comment">         *  out to be a problem (it's unlikely an app would do so).</span>
04235 <span class="comment">         */</span>
04236         UserAssert(GreValidateServerHandle(hdcAni, DC_TYPE));
04237 
04238         <span class="comment">/*</span>
04239 <span class="comment">         * While the window is still hidden, load the first fade animation</span>
04240 <span class="comment">         * frame to avoid flicker when the window is actually shown.</span>
04241 <span class="comment">         *</span>
04242 <span class="comment">         * There would still be flicker with slide animations, though. It</span>
04243 <span class="comment">         * could be fixed by using the window region, similar to</span>
04244 <span class="comment">         * AnimateWindow. For now, too many functions would become xxx, so</span>
04245 <span class="comment">         * let's not do it, unless it becomes a big issue.</span>
04246 <span class="comment">         */</span>
04247         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1982">TestFadeFlags</a>(<a class="code" href="../../d4/d1/userk_8h.html#a688">FADE_MENU</a>)) {
04248             <a class="code" href="../../d8/d4/sprite_8c.html#a20">ShowFade</a>();
04249         }
04250         <span class="keywordflow">goto</span> CallDWP;
04251 
04252     <span class="keywordflow">case</span> WM_WINDOWPOSCHANGED:
04253         <span class="keywordflow">if</span> (!(((LPWINDOWPOS)lParam)-&gt;flags &amp; SWP_SHOWWINDOW))
04254             <span class="keywordflow">goto</span> CallDWP;
04255 
04256         <span class="comment">/*</span>
04257 <span class="comment">         * If not animating, nothing else to do here.</span>
04258 <span class="comment">         */</span>
04259         <span class="keywordflow">if</span> (!(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a541">PAS_OUT</a>))
04260             <span class="keywordflow">goto</span> CallDWP;
04261 
04262         <span class="comment">/*</span>
04263 <span class="comment">         * Start the animation cycle now.</span>
04264 <span class="comment">         */</span>
04265         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1982">TestFadeFlags</a>(<a class="code" href="../../d4/d1/userk_8h.html#a688">FADE_MENU</a>)) {
04266             <a class="code" href="../../d8/d4/sprite_8c.html#a21">StartFade</a>();
04267         } <span class="keywordflow">else</span> {
04268             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o35">dwAniStartTime</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
04269             <a class="code" href="../../d4/d1/userk_8h.html#a1241">_SetTimer</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a50">IDSYS_MNANIMATE</a>, 1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04270         }
04271         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a541">PAS_OUT</a>;
04272         <span class="keywordflow">goto</span> CallDWP;
04273 
04274     <span class="keywordflow">case</span> WM_NCPAINT:
04275 
04276         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a541">PAS_OUT</a>) {
04277 
04278             <span class="comment">/*</span>
04279 <span class="comment">             * When animating, validate itself to ensure no further drawing</span>
04280 <span class="comment">             * that is not related to the animation.</span>
04281 <span class="comment">             */</span>
04282             <a class="code" href="../../d4/d1/userk_8h.html#a1670">xxxValidateRect</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04283         } <span class="keywordflow">else</span> {
04284 
04285             <span class="comment">/*</span>
04286 <span class="comment">             * If we have scroll bars, draw them</span>
04287 <span class="comment">             */</span>
04288             <span class="keywordflow">if</span> (pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a759">MSA_OFF</a>) {
04289 
04290                 HDC hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, (HRGN)wParam,
04291                         DCX_USESTYLE | DCX_WINDOW | DCX_INTERSECTRGN | DCX_NODELETERGN | DCX_LOCKWINDOWUPDATE);
04292                 <a class="code" href="../../d4/d1/userk_8h.html#a1340">MNDrawFullNC</a>(pwnd, hdc, ppopupmenu);
04293                 <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
04294             } <span class="keywordflow">else</span> {
04295                 <span class="keywordflow">goto</span> CallDWP;
04296             }
04297         }
04298         <span class="keywordflow">break</span>;
04299 
04300     <span class="keywordflow">case</span> WM_PRINTCLIENT:
04301         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pmenu, &amp;tlpmenu);
04302         <a class="code" href="../../d4/d1/userk_8h.html#a1383">xxxMenuDraw</a>((HDC)wParam, pmenu);
04303         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
04304         <span class="keywordflow">break</span>;
04305 
04306       <span class="keywordflow">case</span> WM_FINALDESTROY:
04307         <span class="comment">/*</span>
04308 <span class="comment">         * If we're animating, we must haved been killed in a rude way....</span>
04309 <span class="comment">         */</span>
04310         UserAssert((pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o34">hdcWndAni</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
04311 
04312         <span class="comment">/*</span>
04313 <span class="comment">         * If this is a drag and drop menu, then call RevokeDragDrop.</span>
04314 <span class="comment">         */</span>
04315         <span class="keywordflow">if</span> ((pMenuState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a>) {
04316             <span class="keywordflow">if</span> (!SUCCEEDED(<a class="code" href="../../d4/d1/userk_8h.html#a1414">xxxClientRevokeDragDrop</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd)))) {
04317                 RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxMenuWindowProc: xxxClientRevokeRegisterDragDrop failed:%#p"</span>, pwnd);
04318             }
04319         }
04320 
04321         <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a19">xxxMNDestroyHandler</a>(ppopupmenu);
04322         <span class="keywordflow">return</span> 0;
04323 
04324 
04325       <span class="keywordflow">case</span> WM_PAINT:
04326         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pmenu, &amp;tlpmenu);
04327         <a class="code" href="../../d4/d1/userk_8h.html#a1710">xxxBeginPaint</a>(pwnd, &amp;ps);
04328         <a class="code" href="../../d4/d1/userk_8h.html#a1383">xxxMenuDraw</a>(ps.hdc, pmenu);
04329         <a class="code" href="../../d4/d1/userk_8h.html#a1711">xxxEndPaint</a>(pwnd, &amp;ps);
04330         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
04331         <span class="keywordflow">break</span>;
04332 
04333     <span class="keywordflow">case</span> WM_CHAR:
04334     <span class="keywordflow">case</span> WM_SYSCHAR:
04335         <a class="code" href="../../d4/d1/userk_8h.html#a1392">xxxMNChar</a>(ppopupmenu, pMenuState, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam);
04336         <span class="keywordflow">break</span>;
04337 
04338     <span class="keywordflow">case</span> WM_KEYDOWN:
04339     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
04340         <a class="code" href="../../d4/d1/userk_8h.html#a1372">xxxMNKeyDown</a>(ppopupmenu, pMenuState, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam);
04341         <span class="keywordflow">break</span>;
04342 
04343     <span class="keywordflow">case</span> WM_TIMER:
04344         <span class="keywordflow">switch</span> (wParam) {
04345             <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a55">IDSYS_MNSHOW</a>:
04346                 <span class="comment">/*</span>
04347 <span class="comment">                 * Open the window and kill the show timer.</span>
04348 <span class="comment">                 *</span>
04349 <span class="comment">                 * Cancel any toggle state we might have.  We don't</span>
04350 <span class="comment">                 * want to dismiss this on button up if shown from</span>
04351 <span class="comment">                 * button down.</span>
04352 <span class="comment">                 */</span>
04353                 ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04354                 <a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(ppopupmenu, pMenuState);
04355                 <span class="keywordflow">break</span>;
04356 
04357             <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a57">IDSYS_MNHIDE</a>:
04358                 ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04359                 <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupmenu,pMenuState);
04360                 <span class="keywordflow">break</span>;
04361 
04362             <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a53">IDSYS_MNUP</a>:
04363             <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a51">IDSYS_MNDOWN</a>:
04364                 <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) {
04365                     <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a15">xxxMNDoScroll</a>(ppopupmenu, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04366                 } <span class="keywordflow">else</span> {
04367                     <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(pwnd, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam);
04368                 }
04369                 <span class="keywordflow">break</span>;
04370 
04371             <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a50">IDSYS_MNANIMATE</a>:
04372                 <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o34">hdcWndAni</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04373                     <a class="code" href="../../d4/d1/userk_8h.html#a1339">MNAnimate</a>(pMenuState, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04374                 } <span class="keywordflow">else</span> {
04375                     <span class="comment">/*</span>
04376 <span class="comment">                     * This timer shouldn't be set. Left over in msg queue?</span>
04377 <span class="comment">                     */</span>
04378                     UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o34">hdcWndAni</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04379                 }
04380                 <span class="keywordflow">break</span>;
04381 
04382             <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a48">IDSYS_MNAUTODISMISS</a>:
04383                 <span class="comment">/*</span>
04384 <span class="comment">                 * This is a one shot timer, so kill it.</span>
04385 <span class="comment">                 * Dismiss the popup if the flag hasn't been reset.</span>
04386 <span class="comment">                 */</span>
04387                 <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a48">IDSYS_MNAUTODISMISS</a>);
04388                 <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o13">fAboutToAutoDismiss</a>) {
04389                     <span class="keywordflow">goto</span> EndMenu;
04390                 }
04391         }
04392         <span class="keywordflow">break</span>;
04393 
04394     <span class="comment">/*</span>
04395 <span class="comment">     * Menu messages.</span>
04396 <span class="comment">     */</span>
04397     <span class="keywordflow">case</span> MN_SETHMENU:
04398 
04399          <span class="comment">/*</span>
04400 <span class="comment">          * wParam - new hmenu to associate with this menu window</span>
04401 <span class="comment">          * Don't let them set the spmenu to NULL of we have to deal with</span>
04402 <span class="comment">          *  that all over. Use RIP_ERROR for a while to make sure this is OK</span>
04403 <span class="comment">          */</span>
04404         <span class="keywordflow">if</span> (wParam != 0) {
04405             <span class="keywordflow">if</span> ((wParam = (WPARAM)<a class="code" href="../../d7/d3/validate_8c.html#a9">ValidateHmenu</a>((HMENU)wParam)) == 0) {
04406                 <span class="keywordflow">break</span>;
04407             }
04408             <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupmenu, &amp;(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>), (<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)wParam);
04409         } <span class="keywordflow">else</span> {
04410             RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxMenuWindowProc: MN_SETHMENU ignoring NULL wParam. pwnd:%p"</span>, pwnd);
04411         }
04412         <span class="keywordflow">break</span>;
04413 
04414     <span class="keywordflow">case</span> MN_GETHMENU:
04415 
04416         <span class="comment">/*</span>
04417 <span class="comment">         * returns the hmenu associated with this menu window</span>
04418 <span class="comment">         */</span>
04419         <span class="keywordflow">return</span> (LRESULT)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pmenu);
04420 
04421     <span class="keywordflow">case</span> MN_SIZEWINDOW:
04422         {
04423 
04424             <span class="comment">/*</span>
04425 <span class="comment">             * Computes the size of the menu associated with this window and resizes</span>
04426 <span class="comment">             * it if needed.  Size is returned x in loword, y in highword.  wParam</span>
04427 <span class="comment">             * is 0 to just return new size.  wParam is non zero if we should also resize</span>
04428 <span class="comment">             * window.</span>
04429 <span class="comment">             * When called by xxxMNUpdateShownMenu, we might need to redraw the</span>
04430 <span class="comment">             *  frame (i.e, the scrollbars). So we check for MNSW_DRAWFRAME in wParam.</span>
04431 <span class="comment">             *  If some app is sending this message and that bit is set, then we'll</span>
04432 <span class="comment">             *  do some extra work, but I think everything should be cool.</span>
04433 <span class="comment">             */</span>
04434             <span class="keywordtype">int</span>         cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
04435             <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
04436 
04437             <span class="comment">/*</span>
04438 <span class="comment">             * Call menucomputeHelper directly since this is the entry point for</span>
04439 <span class="comment">             * non toplevel menu bars.</span>
04440 <span class="comment">             */</span>
04441             <span class="keywordflow">if</span> (pmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04442                 <span class="keywordflow">break</span>;
04443 
04444             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pmenu, &amp;tlpmenu);
04445             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndNotify);
04446             UserAssert(pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> == ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
04447             <a class="code" href="../../d4/d1/userk_8h.html#a1381">xxxMNCompute</a>(pmenu, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, 0, 0, 0, 0);
04448             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
04449             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
04450 
04451             pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(pwnd, MONITOR_DEFAULTTOPRIMARY);
04452             cx = pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a>;
04453             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a16">MNCheckScroll</a>(pmenu, pMonitor);
04454 
04455             <span class="comment">/*</span>
04456 <span class="comment">             * Size the window?</span>
04457 <span class="comment">             */</span>
04458             <span class="keywordflow">if</span> (wParam != 0) {
04459                 LONG    lPos;
04460                 <span class="keywordtype">int</span>     x, y;
04461                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = SWP_NOZORDER | SWP_NOACTIVATE | SWP_NOOWNERZORDER;
04462 
04463                 <span class="comment">/*</span>
04464 <span class="comment">                 * Need to redraw the frame?</span>
04465 <span class="comment">                 */</span>
04466                 <span class="keywordflow">if</span> (wParam &amp; <a class="code" href="../../d4/d1/userk_8h.html#a536">MNSW_DRAWFRAME</a>) {
04467                     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= SWP_DRAWFRAME;
04468                 }
04469 
04470                 <span class="comment">/*</span>
04471 <span class="comment">                 * If the window is visible, it's being resized while</span>
04472 <span class="comment">                 *  shown. So make sure that it still fits on the screen</span>
04473 <span class="comment">                 *  (i.e, move it to the best pos).</span>
04474 <span class="comment">                 */</span>
04475                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
04476                     lPos = <a class="code" href="../../d4/d1/userk_8h.html#a1598">FindBestPos</a>(
04477                             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left,
04478                             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top,
04479                             cx,
04480                             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
04481                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04482                             0,
04483                             ppopupmenu,
04484                             pMonitor);
04485 
04486                     x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lPos);
04487                     y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lPos);
04488                 } <span class="keywordflow">else</span> {
04489                     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= SWP_NOMOVE;
04490                 }
04491 
04492                 <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(
04493                         pwnd,
04494                         <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>,
04495                         x,
04496                         y,
04497                         cx + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME),    <span class="comment">/* For shadow */</span>
04498                         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME),    <span class="comment">/* For shadow */</span>
04499                         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
04500 
04501             }
04502 
04503             <span class="keywordflow">return</span> MAKELONG(cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
04504         }
04505 
04506     <span class="keywordflow">case</span> MN_OPENHIERARCHY:
04507         {
04508             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
04509             <span class="comment">/*</span>
04510 <span class="comment">             * Opens one level of the hierarchy at the selected item, if</span>
04511 <span class="comment">             * present. Return 0 if error, else hwnd of opened hierarchy.</span>
04512 <span class="comment">             */</span>
04513             pwndT = <a class="code" href="../../d4/d1/userk_8h.html#a1375">xxxMNOpenHierarchy</a>(ppopupmenu, pMenuState);
04514             <span class="keywordflow">return</span> (LRESULT)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndT);
04515         }
04516 
04517     <span class="keywordflow">case</span> MN_CLOSEHIERARCHY:
04518         <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupmenu, pMenuState);
04519         <span class="keywordflow">break</span>;
04520 
04521     <span class="keywordflow">case</span> MN_SELECTITEM:
04522         <span class="comment">/*</span>
04523 <span class="comment">         * wParam - the item to select. Must be a valid</span>
04524 <span class="comment">         * Returns the item flags of the wParam (0 if failure)</span>
04525 <span class="comment">         */</span>
04526         <span class="keywordflow">if</span> ((wParam &gt;= pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) &amp;&amp; (wParam &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a781">MFMWFP_MINVALID</a>)) {
04527             UserAssertMsg1(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="stringliteral">"Bad wParam %x for MN_SELECTITEM"</span>, wParam);
04528             <span class="keywordflow">break</span>;
04529         }
04530 
04531         pItem = <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam);
04532         <span class="keywordflow">if</span> (pItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04533             <span class="keywordflow">return</span>((LONG)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(WORD)(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> |
04534                 ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? MF_POPUP : 0)));
04535         }
04536 
04537         <span class="keywordflow">break</span>;
04538 
04539     <span class="keywordflow">case</span> MN_SELECTFIRSTVALIDITEM: {
04540         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> item;
04541 
04542         item = <a class="code" href="../../d4/d1/userk_8h.html#a1384">MNFindNextValidItem</a>(pmenu, -1, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04543         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, MN_SELECTITEM, item, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
04544         <span class="keywordflow">return</span> (LONG)item;
04545       }
04546 
04547     <span class="keywordflow">case</span> MN_CANCELMENUS:
04548 
04549         <span class="comment">/*</span>
04550 <span class="comment">         * Cancels all menus, unselects everything, destroys windows, and cleans</span>
04551 <span class="comment">         * everything up for this hierarchy.  wParam is the command to send and</span>
04552 <span class="comment">         * lParam says if it is valid or not.</span>
04553 <span class="comment">         */</span>
04554         <a class="code" href="../../d4/d1/userk_8h.html#a1371">xxxMNCancel</a>(pMenuState, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)LOWORD(lParam), 0);
04555         <span class="keywordflow">break</span>;
04556 
04557     <span class="keywordflow">case</span> MN_FINDMENUWINDOWFROMPOINT:
04558         <span class="comment">/*</span>
04559 <span class="comment">         * lParam is point to search for from this hierarchy down.</span>
04560 <span class="comment">         * returns MFMWFP_* value or a pwnd.</span>
04561 <span class="comment">         */</span>
04562         lRet = <a class="code" href="../../d4/d1/userk_8h.html#a1379">xxxMNFindWindowFromPoint</a>(ppopupmenu, (<a class="code" href="../../d9/d5/ndismain_8h.html#a266">PUINT</a>)wParam, MAKEPOINTS(lParam));
04563 
04564         <span class="comment">/*</span>
04565 <span class="comment">         * Convert return value to a handle.</span>
04566 <span class="comment">         */</span>
04567         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1378">IsMFMWFPWindow</a>(lRet)) {
04568             <span class="keywordflow">return</span> (LRESULT)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)lRet);
04569         } <span class="keywordflow">else</span> {
04570             <span class="keywordflow">return</span> lRet;
04571         }
04572 
04573 
04574     <span class="keywordflow">case</span> MN_SHOWPOPUPWINDOW:
04575         <span class="comment">/*</span>
04576 <span class="comment">         * Forces the dropped down popup to be visible and if modeless, also active.</span>
04577 <span class="comment">         */</span>
04578         <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a924">USER_SOUND_MENUPOPUP</a>);
04579         <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwnd, (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> ? SW_SHOW : SW_SHOWNOACTIVATE));
04580         <span class="keywordflow">break</span>;
04581 
04582     <span class="keywordflow">case</span> MN_ACTIVATEPOPUP:
04583         <span class="comment">/*</span>
04584 <span class="comment">         * Activates a popup. This messages is posted in response to WM_ACTIVATEAPP</span>
04585 <span class="comment">         *  or WM_ACTIVATE</span>
04586 <span class="comment">         */</span>
04587         UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>);
04588         <a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(pwnd, 0, 0);
04589         <span class="keywordflow">break</span>;
04590 
04591     <span class="keywordflow">case</span> MN_ENDMENU:
04592         <span class="comment">/*</span>
04593 <span class="comment">         * End the menu. This message is posted to avoid ending the menu</span>
04594 <span class="comment">         *  at randmom moments. By posting the message, the request is</span>
04595 <span class="comment">         *  queued after any pending/current processing.</span>
04596 <span class="comment">         */</span>
04597 EndMenu:
04598         <a class="code" href="../../d4/d1/userk_8h.html#a1400">xxxEndMenuLoop</a>(pMenuState, pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>);
04599         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
04600             UserAssert(!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o10">fInCallHandleMenuMessages</a>);
04601             <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04602         }
04603         <span class="keywordflow">return</span> 0;
04604 
04605      <span class="keywordflow">case</span> MN_DODRAGDROP:
04606         <span class="comment">/*</span>
04607 <span class="comment">         * Let the app know that the user is dragging.</span>
04608 <span class="comment">         */</span>
04609         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o8">fDragging</a>
04610                 &amp;&amp; (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04611                 &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1378">IsMFMWFPWindow</a>(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a>)) {
04612             <span class="comment">/*</span>
04613 <span class="comment">             * Get the pmenu that contains the item being dragged</span>
04614 <span class="comment">             */</span>
04615              pmenu = (((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a>)-&gt;ppopupmenu)-&gt;spmenu;
04616             <span class="comment">/*</span>
04617 <span class="comment">             * If this is a modal menu, release the capture lock so</span>
04618 <span class="comment">             *  DoDragDrop (if called) can get it.</span>
04619 <span class="comment">             */</span>
04620             <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
04621                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;QF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>);
04622                 <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;QF_flags &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>;
04623             }
04624 
04625             <a class="code" href="../../d4/d1/userk_8h.html#a1351">LockMenuState</a>(pMenuState);
04626             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndNotify);
04627 
04628             <span class="comment">/*</span>
04629 <span class="comment">             * Give them a chance to call DoDragDrop</span>
04630 <span class="comment">             */</span>
04631             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04632             lRet = <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_MENUDRAG,
04633                                   pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o29">uButtonDownIndex</a>, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pmenu));
04634             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04635 
04636             <span class="keywordflow">if</span> (lRet == MND_ENDMENU) {
04637                 <span class="comment">/*</span>
04638 <span class="comment">                 * Go away.</span>
04639 <span class="comment">                 */</span>
04640                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
04641                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1352">xxxUnlockMenuState</a>(pMenuState)) {
04642                     <span class="keywordflow">goto</span> EndMenu;
04643                 } <span class="keywordflow">else</span> {
04644                     <span class="keywordflow">return</span> 0;
04645                 }
04646                 <span class="keywordflow">break</span>;
04647              } <span class="keywordflow">else</span> {
04648                  <span class="comment">/*</span>
04649 <span class="comment">                  * If the user starts dragging, we always</span>
04650 <span class="comment">                  *  ignore the following button up</span>
04651 <span class="comment">                  */</span>
04652                  pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o14">fIgnoreButtonUp</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04653              }
04654 
04655             <span class="comment">/*</span>
04656 <span class="comment">             * Check the button state since we might have not seen the button up</span>
04657 <span class="comment">             * If so, this will cancel the dragging state</span>
04658 <span class="comment">             */</span>
04659             <a class="code" href="../../d4/d1/userk_8h.html#a1358">MNCheckButtonDownState</a>(pMenuState);
04660 
04661             <span class="comment">/*</span>
04662 <span class="comment">             * If this is a modal menu, make sure we recover capture</span>
04663 <span class="comment">             */</span>
04664             <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
04665                 <a class="code" href="../../d4/d1/userk_8h.html#a1356">xxxMNSetCapture</a>(ppopupmenu);
04666             }
04667 
04668             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
04669             <a class="code" href="../../d4/d1/userk_8h.html#a1352">xxxUnlockMenuState</a>(pMenuState);
04670         }
04671         <span class="keywordflow">return</span> 0;
04672 
04673     <span class="keywordflow">case</span> MN_BUTTONDOWN:
04674 
04675         <span class="comment">/*</span>
04676 <span class="comment">         * wParam is position (index) of item the button was clicked on.</span>
04677 <span class="comment">         * Must be a valid</span>
04678 <span class="comment">         */</span>
04679         <span class="keywordflow">if</span> ((wParam &gt;= pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) &amp;&amp; (wParam &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a781">MFMWFP_MINVALID</a>)) {
04680             UserAssertMsg1(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="stringliteral">"Bad wParam %x for MN_BUTTONDOWN"</span>, wParam);
04681             <span class="keywordflow">break</span>;
04682         }
04683         <a class="code" href="../../d4/d1/userk_8h.html#a1368">xxxMNButtonDown</a>(ppopupmenu, pMenuState, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04684         <span class="keywordflow">break</span>;
04685 
04686     <span class="keywordflow">case</span> MN_MOUSEMOVE:
04687 
04688         <span class="comment">/*</span>
04689 <span class="comment">         * lParam is mouse move coordinate wrt screen.</span>
04690 <span class="comment">         */</span>
04691         <a class="code" href="../../d4/d1/userk_8h.html#a1380">xxxMNMouseMove</a>(ppopupmenu, pMenuState, MAKEPOINTS(lParam));
04692         <span class="keywordflow">break</span>;
04693 
04694     <span class="keywordflow">case</span> MN_BUTTONUP:
04695 
04696         <span class="comment">/*</span>
04697 <span class="comment">         * wParam is position (index) of item the button was up clicked on.</span>
04698 <span class="comment">         */</span>
04699         <span class="keywordflow">if</span> ((wParam &gt;= pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) &amp;&amp; (wParam &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a781">MFMWFP_MINVALID</a>)) {
04700             UserAssertMsg1(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="stringliteral">"Bad wParam %x for MN_BUTTONUP"</span>, wParam);
04701             <span class="keywordflow">break</span>;
04702         }
04703         <a class="code" href="../../d4/d1/userk_8h.html#a1367">xxxMNButtonUp</a>(ppopupmenu, pMenuState, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam, lParam);
04704         <span class="keywordflow">break</span>;
04705 
04706     <span class="keywordflow">case</span> MN_SETTIMERTOOPENHIERARCHY:
04707 
04708         <span class="comment">/*</span>
04709 <span class="comment">         * Given the current selection, set a timer to show this hierarchy if</span>
04710 <span class="comment">         * valid else return 0.</span>
04711 <span class="comment">         */</span>
04712         <span class="keywordflow">return</span> (LONG)(WORD)<a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a40">MNSetTimerToOpenHierarchy</a>(ppopupmenu);
04713 
04714     <span class="keywordflow">case</span> MN_DBLCLK:
04715             <span class="comment">//</span>
04716             <span class="comment">// User double-clicked on item.  wParamLo is the item.</span>
04717             <span class="comment">//</span>
04718         <a class="code" href="../../d4/d1/userk_8h.html#a1373">xxxMNDoubleClick</a>(pMenuState, ppopupmenu, (<span class="keywordtype">int</span>)wParam);
04719         <span class="keywordflow">break</span>;
04720 
04721     <span class="keywordflow">case</span> WM_MOUSELEAVE:
04722         UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>);
04723         <span class="comment">/*</span>
04724 <span class="comment">         * If we're in DoDragDrop loop, we don't track the mouse</span>
04725 <span class="comment">         *  when it goes off the menu window</span>
04726 <span class="comment">         */</span>
04727         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o15">fMouseOffMenu</a> = !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a>;
04728         ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o20">fTrackMouseEvent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04729         <span class="comment">/*</span>
04730 <span class="comment">         * See if we need to set the timer to autodismiss</span>
04731 <span class="comment">         */</span>
04732         <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a37">MNSetTimerToAutoDismiss</a>(pMenuState, pwnd);
04733         <span class="comment">/*</span>
04734 <span class="comment">         * If we left the active popup, remove the selection</span>
04735 <span class="comment">         */</span>
04736         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>) {
04737             <a class="code" href="../../d4/d1/userk_8h.html#a1369">xxxMNSelectItem</a>(ppopupmenu, pMenuState, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>);
04738         }
04739         <span class="keywordflow">break</span>;
04740 
04741     <span class="keywordflow">case</span> WM_ACTIVATEAPP:
04742         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>
04743                 &amp;&amp; (pwnd == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>)) {
04744             <span class="comment">/*</span>
04745 <span class="comment">             * If the application is getting activated,  we post a message</span>
04746 <span class="comment">             *  to let the dust settle and then re-activate spwndPopupActive</span>
04747 <span class="comment">             */</span>
04748             <span class="keywordflow">if</span> (wParam) {
04749                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, MN_ACTIVATEPOPUP, 0, 0);
04750                 <span class="comment">/*</span>
04751 <span class="comment">                 * If we're not in the foregruond queue, we want to keep</span>
04752 <span class="comment">                 *  the frame off.</span>
04753 <span class="comment">                 * This flag will also tell us that if we lose activation</span>
04754 <span class="comment">                 *  while coming to the foregrund (later), we don't want</span>
04755 <span class="comment">                 *  to dismiss the menu.</span>
04756 <span class="comment">                 */</span>
04757                  pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o17">fActiveNoForeground</a> = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq);
04758             }
04759 
04760             <span class="comment">/*</span>
04761 <span class="comment">             * Make the notification window frame show that we're active/inactive.</span>
04762 <span class="comment">             * If the application is inactive but the user moves the mouse</span>
04763 <span class="comment">             *  over the menu, then we can get this message when the first</span>
04764 <span class="comment">             *  window in the app gets activated (i.e., the move causes a popup to</span>
04765 <span class="comment">             *  be closed/opened). So turn on the frame only if we're in</span>
04766 <span class="comment">             *  the foreground.</span>
04767 <span class="comment">             */</span>
04768             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04769                 <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndNotify);
04770                 <a class="code" href="../../d4/d1/userk_8h.html#a1453">xxxDWP_DoNCActivate</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>,
04771                                     ((wParam &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o17">fActiveNoForeground</a>) ? <a class="code" href="../../d4/d1/userk_8h.html#a552">NCA_ACTIVE</a> : <a class="code" href="../../d4/d1/userk_8h.html#a553">NCA_FORCEFRAMEOFF</a>),
04772                                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>);
04773                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
04774             }
04775         }
04776         <span class="keywordflow">break</span>;
04777 
04778      <span class="keywordflow">case</span> WM_ACTIVATE:
04779          <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
04780              <span class="comment">/*</span>
04781 <span class="comment">              * If activation is NOT going to a menu window or</span>
04782 <span class="comment">              *  it's going to a recursed menu, bail</span>
04783 <span class="comment">              */</span>
04784              <span class="keywordflow">if</span> ((LOWORD(wParam) == WA_INACTIVE)
04785                     &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o10">fInCallHandleMenuMessages</a>
04786                     &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o19">fInCancel</a>) {
04787 
04788                  lParam = (LPARAM)<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)lParam);
04789                  <span class="keywordflow">if</span> ((lParam != 0)
04790                      &amp;&amp; ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)lParam) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>)
04791                          || <a class="code" href="../../d4/d1/userk_8h.html#a1329">IsRecursedMenuState</a>(pMenuState, ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)lParam)-&gt;ppopupmenu))) {
04792                      <span class="comment">/*</span>
04793 <span class="comment">                      * If we're just coming to the foreground, then</span>
04794 <span class="comment">                      *  activate the popup later and stay up.</span>
04795 <span class="comment">                      */</span>
04796                      <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o17">fActiveNoForeground</a>
04797                             &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq)) {
04798 
04799                          pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o17">fActiveNoForeground</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04800                          <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, MN_ACTIVATEPOPUP, 0, 0);
04801                      } <span class="keywordflow">else</span> {
04802                          <span class="comment">/*</span>
04803 <span class="comment">                          * Since the menu window is active, ending the menu</span>
04804 <span class="comment">                          *  now would set a new active window, messing the</span>
04805 <span class="comment">                          *  current activation that sent us this message.</span>
04806 <span class="comment">                          *  so end the menu later.</span>
04807 <span class="comment">                          */</span>
04808                          <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, MN_ENDMENU, 0, 0);
04809                          <span class="keywordflow">break</span>;
04810                      }
04811                  }
04812              }
04813              <span class="keywordflow">goto</span> CallDWP;
04814          } <span class="comment">/* if (pMenuState-&gt;fModelessMenu) */</span>
04815 
04816        <span class="comment">/*</span>
04817 <span class="comment">        * We must make sure that the menu window does not get activated.</span>
04818 <span class="comment">        * Powerpoint 2.00e activates it deliberately and this causes problems.</span>
04819 <span class="comment">        * We try to activate the previously active window in such a case.</span>
04820 <span class="comment">        * Fix for Bug #13961 --SANKAR-- 09/26/91--</span>
04821 <span class="comment">        */</span>
04822        <span class="comment">/*</span>
04823 <span class="comment">        * In Win32, wParam has other information in the hi 16bits, so to</span>
04824 <span class="comment">        * prevent infinite recursion, we need to mask off those bits</span>
04825 <span class="comment">        * Fix for NT bug #13086 -- 23-Jun-1992 JonPa</span>
04826 <span class="comment">        *</span>
04827 <span class="comment">        */</span>
04828 
04829        <span class="keywordflow">if</span> (LOWORD(wParam)) {
04830             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
04831             <span class="comment">/*</span>
04832 <span class="comment">             * This is a super bogus hack. Let's start failing this for 5.0 apps.</span>
04833 <span class="comment">             */</span>
04834             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a104">Is500Compat</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;dwExpWinVer)) {
04835                 RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxMenuWindowProc: Menu window activated:%#p"</span>, pwnd);
04836                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, MN_ENDMENU, 0, 0);
04837                 <span class="keywordflow">break</span>;
04838             }
04839 
04840 <span class="preprocessor">#if 0</span>
04841 <span class="preprocessor"></span>           <span class="comment">/*</span>
04842 <span class="comment">            * Activate the previously active wnd</span>
04843 <span class="comment">            */</span>
04844            <a class="code" href="../../d4/d1/userk_8h.html#a1230">xxxActivateWindow</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a254">AW_SKIP2</a>);
04845 <span class="preprocessor">#else</span>
04846 <span class="preprocessor"></span>            <span class="comment">/*</span>
04847 <span class="comment">             * Try the previously active window.</span>
04848 <span class="comment">             */</span>
04849             <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
04850                     !<a class="code" href="../../d4/d1/userk_8h.html#a1228">FBadWindow</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>) &amp;&amp;
04851                     !<a class="code" href="../../d4/d1/userk_8h.html#a326">ISAMENU</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>)) {
04852                 pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>;
04853             } <span class="keywordflow">else</span> {
04854 
04855                 <span class="comment">/*</span>
04856 <span class="comment">                 * Find a new active window from the top-level window list.</span>
04857 <span class="comment">                 * Bug 78131: Make sure we don't loop for ever. This is a pretty</span>
04858 <span class="comment">                 *  unusual scenario (in addtion, normally we should not hit this code path)</span>
04859 <span class="comment">                 *  So let's use a counter to rule out the possibility that another</span>
04860 <span class="comment">                 *  weird window configuration is going to make us loop for ever</span>
04861 <span class="comment">                 */</span>
04862                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndMenu = pwnd;
04863                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uCounter = 0;
04864                 <span class="keywordflow">do</span> {
04865                     pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1231">NextTopWindow</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
04866                     <span class="keywordflow">if</span> (pwnd &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a1228">FBadWindow</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>) &amp;&amp;
04867                         !<a class="code" href="../../d4/d1/userk_8h.html#a326">ISAMENU</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>)) {
04868                         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>;
04869                         uCounter = 0;
04870                         <span class="keywordflow">break</span>;
04871                     }
04872                 } <span class="keywordflow">while</span> ((pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (uCounter++ &lt; 255));
04873                 <span class="comment">/*</span>
04874 <span class="comment">                 * If we couldn't find a window, just bail.</span>
04875 <span class="comment">                 */</span>
04876                 <span class="keywordflow">if</span> (uCounter != 0) {
04877                     RIPMSG0(RIP_ERROR, <span class="stringliteral">"xxxMenuWindowProc: couldn't fix active window"</span>);
04878                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndMenu, MN_ENDMENU, 0, 0);
04879                     <span class="keywordflow">break</span>;
04880                 }
04881             }
04882 
04883             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04884                 <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04885                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(pti, pwnd, &amp;tlpwnd);
04886 
04887                 <span class="comment">/*</span>
04888 <span class="comment">                 * If GETPTI(pwnd) isn't pqCurrent this is a AW_SKIP* activation</span>
04889 <span class="comment">                 * we'll want to a do a xxxSetForegroundWindow().</span>
04890 <span class="comment">                 */</span>
04891                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
04892 
04893                     <span class="comment">/*</span>
04894 <span class="comment">                     * Only allow this if we're on the current foreground queue.</span>
04895 <span class="comment">                     */</span>
04896                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
04897                         <a class="code" href="../../d4/d1/userk_8h.html#a1665">xxxSetForegroundWindow</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04898                     }
04899                 } <span class="keywordflow">else</span> {
04900                     <a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(pwnd, 0, <a class="code" href="../../d4/d1/userk_8h.html#a512">ATW_SETFOCUS</a>);
04901                 }
04902 
04903                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
04904             }
04905 <span class="preprocessor">#endif</span>
04906 <span class="preprocessor"></span>       }
04907        <span class="keywordflow">break</span>;
04908 
04909      <span class="keywordflow">case</span> WM_SIZE:
04910      <span class="keywordflow">case</span> WM_MOVE:
04911        <span class="comment">/*</span>
04912 <span class="comment">        * When a popup has been sized/moved, we need to make</span>
04913 <span class="comment">        *  sure any dropped hierarchy is moved accordingly.</span>
04914 <span class="comment">        */</span>
04915        <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04916            pItem = <a class="code" href="../../d4/d1/userk_8h.html#a1355">MNGetpItem</a>(ppopupmenu, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a>);
04917            <span class="keywordflow">if</span> (pItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04918                <span class="keywordtype">int</span>      x, y;
04919                <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitorDummy;
04920 
04921                <span class="comment">/*</span>
04922 <span class="comment">                * If the dropped hierarchy needs to be recomputed, do it</span>
04923 <span class="comment">                */</span>
04924 <span class="preprocessor">#define pmenuNext (((PMENUWND)ppopupmenu-&gt;spwndNextPopup)-&gt;ppopupmenu-&gt;spmenu)</span>
04925 <span class="preprocessor"></span>              <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a0">pmenuNext</a>-&gt;cxMenu == 0) {
04926                   <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>, MN_SIZEWINDOW, <a class="code" href="../../d4/d1/userk_8h.html#a534">MNSW_RETURNSIZE</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
04927               }
04928 
04929               <span class="comment">/*</span>
04930 <span class="comment">               * Find out the new position</span>
04931 <span class="comment">               */</span>
04932               <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a23">xxxMNPositionHierarchy</a>(ppopupmenu, pItem,
04933                                      <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a0">pmenuNext</a>-&gt;cxMenu + (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME)),
04934                                      <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a0">pmenuNext</a>-&gt;cyMenu + (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME)),
04935                                      &amp;x, &amp;y, &amp;pMonitorDummy);
04936 
04937               <span class="comment">/*</span>
04938 <span class="comment">               * Move it</span>
04939 <span class="comment">               */</span>
04940               <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>, &amp;tlpwndNotify);
04941               <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04942                               x, y, 0, 0,
04943                               SWP_NOSIZE | SWP_NOZORDER | SWP_NOSENDCHANGING);
04944               <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
04945 <span class="preprocessor">#undef pmenuNext</span>
04946 <span class="preprocessor"></span>           } <span class="comment">/* if (pItem != NULL) */</span>
04947        } <span class="comment">/* if (ppopupmenu-&gt;spwndNextPopup != NULL) */</span>
04948        <span class="keywordflow">break</span>;
04949 
04950      <span class="keywordflow">case</span> WM_NCHITTEST:
04951         <span class="comment">/*</span>
04952 <span class="comment">         * Since modeless menus don't capture the mouse, we</span>
04953 <span class="comment">         *  process this message to make sure that we always receive</span>
04954 <span class="comment">         *  a mouse move when the mouse in our window.</span>
04955 <span class="comment">         * This also causes us to receive the WM_MOUSELEAVE only when</span>
04956 <span class="comment">         *  the mouse leaves the window and not just the  client area.</span>
04957 <span class="comment">         */</span>
04958         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
04959             ptOrg.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam);
04960             ptOrg.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam);
04961             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, ptOrg)) {
04962                 <span class="keywordflow">return</span> HTCLIENT;
04963             } <span class="keywordflow">else</span> {
04964                 <span class="keywordflow">return</span> HTNOWHERE;
04965             }
04966         } <span class="keywordflow">else</span> {
04967             <span class="keywordflow">goto</span> CallDWP;
04968         }
04969 
04970 
04971     <span class="keywordflow">default</span>:
04972 CallDWP:
04973         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam);
04974     }
04975 
04976     <span class="keywordflow">return</span> 0;
04977 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
