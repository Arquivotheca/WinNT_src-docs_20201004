<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kernel/sendmsg.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sendmsg.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>
<code>#include "<a class="el" href="../../d7/d8/pnp_8h-source.html">pnp.h</a>"</code><br>

<p>
<a href="../../d4/d5/kernel_2sendmsg_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a0">IsASwitchWnd</a>(pw)&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a317">gpsi</a>-&gt;atomSysClass[ICLS_SWITCH] == pw-&gt;pcls-&gt;atomClassName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a1">IsOleMainThreadWnd</a>(pw)&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a299">gaOleMainThreadWndClass</a> == pw-&gt;pcls-&gt;atomClassName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a2">fBroadcastProc</a>(pwnd)&nbsp;&nbsp;&nbsp;(!(ISAMENU(pwnd) || IsASwitchWnd(pwnd) || IsOleMainThreadWnd(pwnd)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a3">XXXSENDMESSAGETOCLIENT</a>(pwnd, message, wParam, lParam, psms, fLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a4">NoString</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a5">IsAnsiString</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a6">IsUnicodeString</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a8">UnlinkSendListSms</a> (<a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a>, <a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a9">ReceiverDied</a> (<a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a>, <a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a10">SenderDied</a> (<a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a>, <a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a11">InitSMSLookaside</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a12">StubAllocSMS</a> (<a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, SIZE_T uBytes, ULONG iTag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a13">StubFreeSMS</a> (PVOID p)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a14">InitSMSLookaside</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a15">AllocSMS</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a16">FreeSMS</a> (<a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psms)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a17">_ReplyMessage</a> (LRESULT lRet)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a18">UserLogError</a> (PCWSTR pwszError, ULONG cbError, NTSTATUS ErrorCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a19">xxxSendBSMtoDesktop</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesk, UINT message, WPARAM wParam, LPARAM lParam, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a987">LPBROADCASTSYSTEMMSGPARAMS</a> pbsmParams)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a20">xxxSendMessageBSM</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam, <a class="el" href="../../d1/d0/inc_2user_8h.html#a956">LPBROADCASTSYSTEMMSGPARAMS</a> pbsmParams)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a21">xxxSendMessageFF</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam, ULONG_PTR xParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a22">xxxSendMessageEx</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam, ULONG_PTR xParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a23">xxxSendMessage</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a24">xxxSendMessageTimeout</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam, UINT fuFlags, UINT uTimeout, PLONG_PTR lpdwResult)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a25">QueueNotifyMessage</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a26">xxxSystemBroadcastMessage</a> (UINT message, WPARAM wParam, LPARAM lParam, UINT wCmd, <a class="el" href="../../d8/d8/uniontagBROADCASTMSG.html">PBROADCASTMSG</a> pbcm)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a27">xxxSendNotifyMessage</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a28">xxxSendMessageCallback</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam, SENDASYNCPROC lpResultCallBack, ULONG_PTR dwData, BOOL fClientRequest)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a29">xxxInterSendMsgEx</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam, <a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiSender, <a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiReceiver, <a class="el" href="../../d9/d8/structtagINTERSENDMSGEX.html">PINTRSENDMSGEX</a> pism)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a30">xxxReceiveMessage</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiReceiver)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a31">SendMsgCleanup</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a32">ClearSendMessages</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a33">xxxSendSizeMessage</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT cmdSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a34">xxxProcessAsyncSendMessage</a> (<a class="el" href="../../d5/d8/structtagASYNCSENDMSG.html">PASYNCSENDMSG</a> pmsg)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a35">xxxBroadcastMessage</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, WPARAM wParam, LPARAM lParam, UINT wCmd, <a class="el" href="../../d8/d8/uniontagBROADCASTMSG.html">PBROADCASTMSG</a> pbcm)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a7">SMSLookaside</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="kernel/sendmsg.c::fBroadcastProc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define fBroadcastProc          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pwnd&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(!(ISAMENU(pwnd) || IsASwitchWnd(pwnd) || IsOleMainThreadWnd(pwnd)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00098">98</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00315">xxxSendBSMtoDesktop()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="kernel/sendmsg.c::IsAnsiString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsAnsiString&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01293">1293</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="kernel/sendmsg.c::IsASwitchWnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsASwitchWnd          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pw&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a317">gpsi</a>-&gt;atomSysClass[ICLS_SWITCH] == pw-&gt;pcls-&gt;atomClassName)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00018">18</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="kernel/sendmsg.c::IsOleMainThreadWnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsOleMainThreadWnd          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pw&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a299">gaOleMainThreadWndClass</a> == pw-&gt;pcls-&gt;atomClassName)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00021">21</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="kernel/sendmsg.c::IsUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsUnicodeString&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01294">1294</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="kernel/sendmsg.c::NoString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NoString&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01292">1292</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/fekbd_8c-source.html#l01092">NlsKbdInitializePerSystem()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="kernel/sendmsg.c::XXXSENDMESSAGETOCLIENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define XXXSENDMESSAGETOCLIENT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pwnd,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>message,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>wParam,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>lParam,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>psms,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>fLock&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00705">705</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01964">xxxReceiveMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01114">xxxSendMessageCallback()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a17" doxytag="kernel/sendmsg.c::_ReplyMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _ReplyMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LRESULT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>lRet</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00198">198</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d7/d8/taskman_8c-source.html#l00594">DirectedScheduleTask()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03747">tagINTERSENDMSGEX::dwData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03744">tagINTERSENDMSGEX::fuCall</a>, <a class="el" href="../../d4/d1/userk_8h.html#a894">INTRSENDMSGEX</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03755">ISM_CALLBACK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03759">ISM_CB_CLIENT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03758">ISM_REPLY</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03746">tagINTERSENDMSGEX::lpResultCallBack</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03748">tagINTERSENDMSGEX::lRet</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03297">PSMS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03336">tagTHREADINFO::psmsCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04578">SetWakeBit()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03734">SMF_CB_CLIENT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03732">SMF_CB_REQUEST</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03727">SMF_REPLY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03729">SMF_SENDERDIED</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>, and <a class="el" href="../../d7/d8/taskman_8c-source.html#l00252">xxxSleepTask()</a>.
<p>
<pre class="fragment"><div>00200 {
00201     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00202     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psms;
00203 
00204     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00205 
00206     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00207 
00208     <span class="comment">/*</span>
00209 <span class="comment">     * Are we processing a SendMessage?</span>
00210 <span class="comment">     */</span>
00211     psms = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a>;
00212     <span class="keywordflow">if</span> (psms == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00213         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00214 
00215     <span class="comment">/*</span>
00216 <span class="comment">     * See if the reply has been made already.</span>
00217 <span class="comment">     */</span>
00218     <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>)
00219         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00220 
00221     <span class="comment">/*</span>
00222 <span class="comment">     * Blow off the rest of the call if the SMS came</span>
00223 <span class="comment">     * from xxxSendNotifyMessage().  Obviously there's</span>
00224 <span class="comment">     * no one around to reply to in the case.</span>
00225 <span class="comment">     */</span>
00226     <span class="keywordflow">if</span> (psms-&gt;ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00227 
00228         <span class="comment">/*</span>
00229 <span class="comment">         * Reply to this message.  The sender should not free the SMS</span>
00230 <span class="comment">         * because the receiver still considers it valid.  Thus we</span>
00231 <span class="comment">         * mark it with a special bit indicating it has been replied</span>
00232 <span class="comment">         * to.  We wait until both the sender and receiver are done</span>
00233 <span class="comment">         * with the sms before we free it.</span>
00234 <span class="comment">         */</span>
00235         psms-&gt;lRet = lRet;
00236         psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
00237 
00238         <span class="comment">/*</span>
00239 <span class="comment">         * Wake up the sender.</span>
00240 <span class="comment">         * ??? why don't we test that psms == ptiSender-&gt;psmsSent?</span>
00241 <span class="comment">         */</span>
00242         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(psms-&gt;ptiSender, QS_SMSREPLY);
00243     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a429">SMF_CB_REQUEST</a>) {
00244 
00245         <span class="comment">/*</span>
00246 <span class="comment">         * From SendMessageCallback REQUEST callback.  Send the message</span>
00247 <span class="comment">         * back with a the REPLY value.</span>
00248 <span class="comment">         */</span>
00249         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00250         <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">INTRSENDMSGEX</a> ism;
00251 
00252         psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
00253 
00254         <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a>)) {
00255             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> = <a class="code" href="../../d4/d1/userk_8h.html#a436">ISM_CALLBACK</a> | <a class="code" href="../../d4/d1/userk_8h.html#a439">ISM_REPLY</a>;
00256             <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a431">SMF_CB_CLIENT</a>)
00257                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a440">ISM_CB_CLIENT</a>;
00258             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o1">lpResultCallBack</a> = psms-&gt;lpResultCallBack;
00259             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o2">dwData</a> = psms-&gt;dwData;
00260             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o3">lRet</a> = lRet;
00261 
00262             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, psms-&gt;spwnd, &amp;tlpwnd);
00263 
00264             <a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(psms-&gt;spwnd, psms-&gt;message, 0L, 0L,
00265                     NULL, psms-&gt;ptiCallBackSender, &amp;ism );
00266 
00267             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00268         }
00269     }
00270 
00271     <span class="comment">/*</span>
00272 <span class="comment">     * We have 4 conditions to satisfy:</span>
00273 <span class="comment">     *</span>
00274 <span class="comment">     * 16 - 16 : receiver yields if sender is waiting for this reply</span>
00275 <span class="comment">     * 32 - 16 : receiver yields if sender is waiting for this reply</span>
00276 <span class="comment">     * 16 - 32 : no yield required</span>
00277 <span class="comment">     * 32 - 32 : No yielding required.</span>
00278 <span class="comment">     */</span>
00279     <span class="keywordflow">if</span> (psms-&gt;ptiSender &amp;&amp;
00280         (psms-&gt;ptiSender-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a> || ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00281 
00282         <a class="code" href="../../d4/d1/userk_8h.html#a1559">DirectedScheduleTask</a>(ptiCurrent, psms-&gt;ptiSender, FALSE, psms);
00283         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a> &amp;&amp; psms-&gt;ptiSender-&gt;psmsSent == psms) {
00284             <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(TRUE, NULL);
00285         }
00286     }
00287 
00288     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00289 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="kernel/sendmsg.c::AllocSMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a> AllocSMS           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00164">164</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00906">ExAllocateFromPagedLookasideList()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03297">PSMS</a>, and <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00091">SMSLookaside</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>.
<p>
<pre class="fragment"><div>00166 {
00167     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>(SMSLookaside);
00168 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="kernel/sendmsg.c::ClearSendMessages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ClearSendMessages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02400">2400</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>.
<p>
<pre class="fragment"><div>02409          :
02410 * 01-13-91 DavidPe      Ported.
02411 \***********************************************************************/
02412 
02413 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1151">ClearSendMessages</a>(
02414     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
02415 {
02416     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psms, psmsNext;
02417     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *ppsms;
02418 
02419     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02420 
02421     psms = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>;
02422     <span class="keywordflow">while</span> (psms != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02423         <span class="comment">/*</span>
02424 <span class="comment">         * Grab the next one beforehand in case we free the current one.</span>
02425 <span class="comment">         */</span>
02426         psmsNext = psms-&gt;psmsNext;
02427 
02428         <span class="keywordflow">if</span> (psms-&gt;spwnd == pwnd) {
02429 
02430             <span class="comment">/*</span>
02431 <span class="comment">             * If the sender has died, then mark this receiver free so the</span>
02432 <span class="comment">             * receiver will destroy it in its processing.</span>
02433 <span class="comment">             */</span>
02434             <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a>) {
02435                 psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a> | <a class="code" href="../../d4/d1/userk_8h.html#a427">SMF_RECEIVERFREE</a>;
02436             } <span class="keywordflow">else</span> {
02437                 <span class="comment">/*</span>
02438 <span class="comment">                 * The sender is alive. If the receiver hasn't replied to</span>
02439 <span class="comment">                 * this yet, make a reply so the sender gets it. Make sure</span>
02440 <span class="comment">                 * the receiver is the one free it so we don't have a race</span>
02441 <span class="comment">                 * condition.</span>
02442 <span class="comment">                 */</span>
02443                 <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>)) {
02444 
02445                     <span class="comment">/*</span>
02446 <span class="comment">                     * The sms is either still on the receive list</span>
02447 <span class="comment">                     * or is currently being received. Since the sender</span>
02448 <span class="comment">                     * is alive, we want the sender to get the reply</span>
02449 <span class="comment">                     * to this SMS. If it hasn't been received, take</span>
02450 <span class="comment">                     * it off the receive list and reply to it. If it</span>
02451 <span class="comment">                     * has been received, then just leave it alone:</span>
02452 <span class="comment">                     * it'll get replied to normally.</span>
02453 <span class="comment">                     */</span>
02454                     <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a429">SMF_CB_REQUEST</a>) {
02455                         <span class="comment">/*</span>
02456 <span class="comment">                         * From SendMessageCallback REQUEST callback.  Send the</span>
02457 <span class="comment">                         * message back with a the REPLY value.</span>
02458 <span class="comment">                         */</span>
02459                         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
02460                         <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">INTRSENDMSGEX</a> ism;
02461 
02462                         psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
02463 
02464                         ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> = <a class="code" href="../../d4/d1/userk_8h.html#a436">ISM_CALLBACK</a> | <a class="code" href="../../d4/d1/userk_8h.html#a439">ISM_REPLY</a>;
02465                         <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a431">SMF_CB_CLIENT</a>)
02466                             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a440">ISM_CB_CLIENT</a>;
02467                         ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o1">lpResultCallBack</a> = psms-&gt;lpResultCallBack;
02468                         ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o2">dwData</a> = psms-&gt;dwData;
02469                         ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o3">lRet</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;    <span class="comment">/* null return */</span>
02470 
02471                         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(psms-&gt;spwnd, &amp;tlpwnd);
02472 
02473                         <a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(psms-&gt;spwnd, psms-&gt;message, 0L, 0L,
02474                                 NULL, psms-&gt;ptiCallBackSender, &amp;ism );
02475 
02476                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02477                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a435">SMF_RECEIVERBUSY</a>)) {
02478                         <span class="comment">/*</span>
02479 <span class="comment">                         * If there is no sender, this is a notification</span>
02480 <span class="comment">                         * message (nobody to reply to). In this case,</span>
02481 <span class="comment">                         * just set the SMF_REPLY bit (SMF_RECEIVERFREE</span>
02482 <span class="comment">                         * is already set) and this'll cause ReceiveMessage</span>
02483 <span class="comment">                         * to just free this SMS and return.</span>
02484 <span class="comment">                         */</span>
02485                         <span class="keywordflow">if</span> (psms-&gt;ptiSender == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02486                             psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
02487                         } <span class="keywordflow">else</span> {
02488                             <span class="comment">/*</span>
02489 <span class="comment">                             * There is a sender, and it wants a reply: take</span>
02490 <span class="comment">                             * this SMS off the receive list, and reply</span>
02491 <span class="comment">                             * to the sender.</span>
02492 <span class="comment">                             */</span>
02493                             <span class="keywordflow">for</span> (ppsms = &amp;(psms-&gt;ptiReceiver-&gt;psmsReceiveList);
02494                                         *ppsms != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02495                                         ppsms = &amp;((*ppsms)-&gt;psmsReceiveNext)) {
02496 
02497                                 <span class="keywordflow">if</span> (*ppsms == psms) {
02498                                     *ppsms = psms-&gt;psmsReceiveNext;
02499                                     <span class="keywordflow">break</span>;
02500                                 }
02501                             }
02502 
02503 
02504       <span class="comment">/*</span>
02505 <span class="comment">                             * Reply to this message so the sender</span>
02506 <span class="comment">                             * wakes up.</span>
02507 <span class="comment">                             */</span>
02508                             psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
02509                             psms-&gt;lRet = 0;
02510                             psms-&gt;psmsReceiveNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02511                             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(psms-&gt;ptiSender, QS_SMSREPLY);
02512 
02513                             <span class="comment">/*</span>
02514 <span class="comment">                             *  16 bit senders need to be notifed that sends completed</span>
02515 <span class="comment">                             *  otherwise it may wait for a very long time for the reply.</span>
02516 <span class="comment">                             */</span>
02517                             <span class="keywordflow">if</span> (psms-&gt;ptiSender-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
02518                                 <a class="code" href="../../d4/d1/userk_8h.html#a1559">DirectedScheduleTask</a>(psms-&gt;ptiReceiver, psms-&gt;ptiSender, FALSE, psms);
02519                             }
02520                         }
                    }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="kernel/sendmsg.c::FreeSMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void FreeSMS           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>psms</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00178">178</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00947">ExFreeToPagedLookasideList()</a>, and <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00091">SMSLookaside</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00097">Win32kNtUserCleanup()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>.
<p>
<pre class="fragment"><div>00180 {
00181     <a class="code" href="../../d5/d8/ex_8h.html#a253">ExFreeToPagedLookasideList</a>(SMSLookaside, psms);
00182 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="kernel/sendmsg.c::InitSMSLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InitSMSLookaside           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00137">137</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00543">ExInitializePagedLookasideList()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00143">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>, <a class="el" href="../../d4/d1/userk_8h.html#a893">SMS</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00091">SMSLookaside</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00111">StubAllocSMS()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00121">StubFreeSMS()</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02249">Win32UserInitialize()</a>.
<p>
<pre class="fragment"><div>00138 {
00139     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a19">SMSLookaside</a> = UserAllocPoolNonPaged(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a>), TAG_LOOKASIDE);
00140     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a19">SMSLookaside</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00141         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00142     }
00143 
00144     <a class="code" href="../../d5/d8/ex_8h.html#a250">ExInitializePagedLookasideList</a>(SMSLookaside,
00145                                    StubAllocSMS,
00146                                    StubFreeSMS,
00147                                    POOL_QUOTA_FAIL_INSTEAD_OF_RAISE,
00148                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d6/structtagSMS.html">SMS</a>),
00149                                    TAG_SMS,
00150                                    8);
00151 
00152     <span class="keywordflow">return</span> STATUS_SUCCESS;
00153 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="kernel/sendmsg.c::InitSMSLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InitSMSLookaside           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="kernel/sendmsg.c::QueueNotifyMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void QueueNotifyMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00969">969</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l05671">CancelInputState()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00972">DoQueuedSyncPaint()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00336">xxxActivateApp()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l01152">xxxResetDisplayDevice()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00315">xxxSendBSMtoDesktop()</a>.
<p>
<pre class="fragment"><div>00987 {
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="kernel/sendmsg.c::ReceiverDied" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ReceiverDied           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a>&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02534">2534</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d7/d8/taskman_8c-source.html#l00594">DirectedScheduleTask()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03747">tagINTERSENDMSGEX::dwData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03040">tagCLIENTTHREADINFO::fsChangeBits</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03041">tagCLIENTTHREADINFO::fsWakeBits</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03744">tagINTERSENDMSGEX::fuCall</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03755">ISM_CALLBACK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03759">ISM_CB_CLIENT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03758">ISM_REPLY</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03746">tagINTERSENDMSGEX::lpResultCallBack</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03748">tagINTERSENDMSGEX::lRet</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03325">tagTHREADINFO::pcti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03297">PSMS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03337">tagTHREADINFO::psmsReceiveList</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04578">SetWakeBit()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03734">SMF_CB_CLIENT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03732">SMF_CB_REQUEST</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03738">SMF_RECEIVERBUSY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03728">SMF_RECEIVERDIED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03730">SMF_RECEIVERFREE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03727">SMF_REPLY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03729">SMF_SENDERDIED</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02770">UnlinkSendListSms()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>.
<p>
<pre class="fragment"><div>02543          :
02544 * 01-13-91 DavidPe      Ported.
02545 \***********************************************************************/
02546 
02547 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1149">ReceiverDied</a>(
02548     PSMS psms,
02549     PSMS *ppsmsUnlink)
02550 {
02551     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *ppsms;
02552     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiReceiver;
02553     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiSender;
02554 
02555     <span class="comment">/*</span>
02556 <span class="comment">     * mark that the receiver died</span>
02557 <span class="comment">     */</span>
02558     ptiReceiver = psms-&gt;ptiReceiver;
02559     psms-&gt;ptiReceiver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02560     psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a425">SMF_RECEIVERDIED</a>;
02561 
02562     <span class="comment">/*</span>
02563 <span class="comment">     * Unlink sms from thread if it is not dying.  We need to do</span>
02564 <span class="comment">     * this for journal cleanup.</span>
02565 <span class="comment">     */</span>
02566     <span class="keywordflow">if</span> (!(ptiReceiver-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
02567 
02568         <span class="comment">/*</span>
02569 <span class="comment">         * unlink sms from the receiver's receive list</span>
02570 <span class="comment">         */</span>
02571         <span class="keywordflow">for</span> (ppsms = &amp;(ptiReceiver-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o13">psmsReceiveList</a>); *ppsms != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02572                     ppsms = &amp;((*ppsms)-&gt;psmsReceiveNext)) {
02573 
02574             <span class="keywordflow">if</span> (*ppsms == psms) {
02575                 *ppsms = psms-&gt;psmsReceiveNext;
02576                 <span class="keywordflow">break</span>;
02577             }
02578         }
02579 
02580         <span class="comment">/*</span>
02581 <span class="comment">         * clear the QS_SENDMESSAGE bit if there are no more messages</span>
02582 <span class="comment">         */</span>
02583         <span class="keywordflow">if</span> (ptiReceiver-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o13">psmsReceiveList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02584             ptiReceiver-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp;= ~QS_SENDMESSAGE;
02585             ptiReceiver-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~QS_SENDMESSAGE;
02586         }
02587     } <span class="keywordflow">else</span> {
02588 
02589         <span class="comment">/*</span>
02590 <span class="comment">         * The receiver thread is dying.  Clear the received flag</span>
02591 <span class="comment">         * so that if there is a sender, it will free the sms.</span>
02592 <span class="comment">         */</span>
02593         psms-&gt;flags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a435">SMF_RECEIVERBUSY</a>;
02594     }
02595 
02596     psms-&gt;psmsReceiveNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02597 
02598     <span class="comment">/*</span>
02599 <span class="comment">     * Check if the sender died or if the receiver was marked to</span>
02600 <span class="comment">     * free the sms.</span>
02601 <span class="comment">     */</span>
02602     <span class="keywordflow">if</span> (psms-&gt;ptiSender == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02603 
02604         <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a>) &amp;&amp;
02605                 (psms-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a429">SMF_CB_REQUEST</a> | <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>)) == <a class="code" href="../../d4/d1/userk_8h.html#a429">SMF_CB_REQUEST</a>) {
02606 
02607             <span class="comment">/*</span>
02608 <span class="comment">             * From SendMessageCallback REQUEST callback.  Send the message</span>
02609 <span class="comment">             * back with a the REPLY value.</span>
02610 <span class="comment">             */</span>
02611             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
02612             <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">INTRSENDMSGEX</a> ism;
02613 
02614             psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
02615 
02616             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> = <a class="code" href="../../d4/d1/userk_8h.html#a436">ISM_CALLBACK</a> | <a class="code" href="../../d4/d1/userk_8h.html#a439">ISM_REPLY</a>;
02617             <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a431">SMF_CB_CLIENT</a>)
02618                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a440">ISM_CB_CLIENT</a>;
02619             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o1">lpResultCallBack</a> = psms-&gt;lpResultCallBack;
02620             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o2">dwData</a> = psms-&gt;dwData;
02621             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o3">lRet</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;    <span class="comment">/* null return */</span>
02622 
02623             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(psms-&gt;spwnd, &amp;tlpwnd);
02624 
02625             <a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(psms-&gt;spwnd, psms-&gt;message, 0L, 0L,
02626                     NULL, psms-&gt;ptiCallBackSender, &amp;ism );
02627 
02628             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02629         }
02630 
02631         <span class="comment">/*</span>
02632 <span class="comment">         * If the receiver is not processing the message, free it.</span>
02633 <span class="comment">         */</span>
02634         <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a435">SMF_RECEIVERBUSY</a>))
02635             <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a8">UnlinkSendListSms</a>(psms, ppsmsUnlink);
02636         <span class="keywordflow">return</span>;
02637 
02638     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>)) {
02639 
02640         <span class="comment">/*</span>
02641 <span class="comment">         * fake a reply</span>
02642 <span class="comment">         */</span>
02643         psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
02644         psms-&gt;lRet = 0;
02645         psms-&gt;ptiReceiver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02646 
02647         <span class="comment">/*</span>
02648 <span class="comment">         * wake the sender if he was waiting for us</span>
02649 <span class="comment">         */</span>
02650         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(psms-&gt;ptiSender, QS_SMSREPLY);
02651     } <span class="keywordflow">else</span> {
02652         <span class="comment">/*</span>
02653 <span class="comment">         * There is a reply. We know the receiver is dying, so clear the</span>
02654 <span class="comment">         * SMF_RECEIVERFREE bit or the sender won't free this SMS!</span>
02655 <span class="comment">         * Although the sender's wake bit has already been set by the</span>
02656 <span class="comment">         * call to ClearSendMessages() earlier in the cleanup code,</span>
02657 <span class="comment">         * set it here again for safety.</span>
02658 <span class="comment">         *</span>
02659 <span class="comment">         * ??? Why would SMF_RECEIVERFREE be set?</span>
02660 <span class="comment">         */</span>
02661         psms-&gt;flags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a427">SMF_RECEIVERFREE</a>;
02662         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(psms-&gt;ptiSender, QS_SMSREPLY);
02663     }
02664 
02665     <span class="comment">/*</span>
02666 <span class="comment">     * If the sender is a WOW task, that task is now blocked in the non-</span>
02667 <span class="comment">     * preemptive scheduler waiting for a reply.  DestroyTask will</span>
     * clean this up (even if ptiReceiver is 32-bit).</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="kernel/sendmsg.c::SenderDied" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SenderDied           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a>&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02680">2680</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02364">SendMsgCleanup()</a>.
<p>
<pre class="fragment"><div>02689          :
02690 * 01-13-91 DavidPe      Ported.
02691 \***********************************************************************/
02692 
02693 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a10">SenderDied</a>(
02694     PSMS psms,
02695     PSMS *ppsmsUnlink)
02696 {
02697     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiSender;
02698     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fReply = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02699 
02700     <span class="comment">/*</span>
02701 <span class="comment">     * mark the death</span>
02702 <span class="comment">     */</span>
02703     <span class="keywordflow">if</span> (psms-&gt;ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02704         ptiSender = psms-&gt;ptiSender;
02705     <span class="keywordflow">else</span>
02706         ptiSender = psms-&gt;ptiCallBackSender;
02707     psms-&gt;ptiSender = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02708     psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a>;
02709 
02710     <span class="comment">/*</span>
02711 <span class="comment">     * There are two cases where we leave the sms alone so the receiver</span>
02712 <span class="comment">     * can handle the message and then free the sms itself.</span>
02713 <span class="comment">     *</span>
02714 <span class="comment">     *  1.  When the receiver is processing the message.</span>
02715 <span class="comment">     *</span>
02716 <span class="comment">     *  2.  When the message has not yet been received.</span>
02717 <span class="comment">     */</span>
02718 
02719     <span class="comment">/*</span>
02720 <span class="comment">     * If the receiver is processing the message, make it free the sms.</span>
02721 <span class="comment">     * Fake a reply for journal cancel.</span>
02722 <span class="comment">     */</span>
02723     <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a435">SMF_RECEIVERBUSY</a>) {
02724         psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a427">SMF_RECEIVERFREE</a>;
02725         fReply = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02726     }
02727 
02728     <span class="comment">/*</span>
02729 <span class="comment">     * This sms may be in the process of being sent, but has not yet</span>
02730 <span class="comment">     * been received.  In so, fake a reply and wake the sender.</span>
02731 <span class="comment">     * The last thread to touch the sms, either the sender or</span>
02732 <span class="comment">     * receiver, will free the sms.</span>
02733 <span class="comment">     */</span>
02734     <span class="keywordflow">if</span> (ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o11">psmsSent</a> == psms)
02735         fReply = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02736 
02737     <span class="comment">/*</span>
02738 <span class="comment">     * If journalling is being cancelled and reply needs to be made,</span>
02739 <span class="comment">     * fake a reply and return.</span>
02740 <span class="comment">     */</span>
02741     <span class="keywordflow">if</span> (!(ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) &amp;&amp; fReply) {
02742 
02743         <span class="comment">/*</span>
02744 <span class="comment">         * fake a reply</span>
02745 <span class="comment">         */</span>
02746         psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
02747         psms-&gt;lRet = 0;
02748 
02749         <span class="comment">/*</span>
02750 <span class="comment">         * wake the sender if he was waiting for us</span>
02751 <span class="comment">         */</span>
02752         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiSender, QS_SMSREPLY);
02753         <span class="keywordflow">return</span>;
02754     }
02755 
02756     <span class="comment">/*</span>
02757 <span class="comment">     * If the receiver isn't dead, check to see if it has honestly replied to</span>
     * this SMS. If it has not replied, leave it alone so the receiver can</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="kernel/sendmsg.c::SendMsgCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SendMsgCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ptiCurrent</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02364">2364</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00643">gpsmsList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03297">PSMS</a>, <a class="el" href="../../d4/d1/userk_8h.html#a1149">ReceiverDied()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02680">SenderDied()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00404">zzzCancelJournalling()</a>.
<p>
<pre class="fragment"><div>02364                       :  free sms
02365 *   R replied,  R dies:  no problem
02366 *
02367 * <span class="keywordtype">double</span> death:
02368 *   R no reply, S dies, R dies:  free sms
02369 *   R no reply, R dies, S dies:  free sms
02370 *   R replied,  S dies, R dies:  sms freed when S dies, as in single death
02371 *   R replied,  R dies, S dies:  sms freed when S dies, as in single death
02372 *
02373 * <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>:
02374 * 01-13-91 DavidPe      Ported.
02375 \***********************************************************************/
02376 
02377 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1148">SendMsgCleanup</a>(
02378     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent)
02379 {
02380     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *ppsms;
02381     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psmsNext;
02382 
02383     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02384 
02385     <span class="keywordflow">for</span> (ppsms = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>; *ppsms; ) {
02386         psmsNext = (*ppsms)-&gt;psmsNext;
02387 
02388         <span class="keywordflow">if</span> ((*ppsms)-&gt;ptiSender == ptiCurrent ||
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="kernel/sendmsg.c::StubAllocSMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID StubAllocSMS           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>uBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>iTag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00111">111</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00137">InitSMSLookaside()</a>.
<p>
<pre class="fragment"><div>00115 {
00116     <span class="keywordflow">return</span> UserAllocPool(uBytes, iTag);
00117 
00118     UNREFERENCED_PARAMETER(PoolType);
00119 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="kernel/sendmsg.c::StubFreeSMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID StubFreeSMS           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>p</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00121">121</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00137">InitSMSLookaside()</a>.
<p>
<pre class="fragment"><div>00123 {
00124     UserFreePool(p);
00125 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="kernel/sendmsg.c::UnlinkSendListSms" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UnlinkSendListSms           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a>&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02770">2770</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02534">ReceiverDied()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01964">xxxReceiveMessage()</a>.
<p>
<pre class="fragment"><div>02779          :
02780 * 01-13-91 DavidPe      Ported.
02781 \***********************************************************************/
02782 
02783 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a8">UnlinkSendListSms</a>(
02784     PSMS psms,
02785     PSMS *ppsmsUnlink)
02786 {
02787 <span class="preprocessor">#if DBG</span>
02788 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psmsT;
02789     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUpdateSendList;
02790     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *ppsms;
02791 <span class="preprocessor">#endif</span>
02792 <span class="preprocessor"></span>
02793     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02794 
02795 <span class="preprocessor">#ifdef DEBUG_SMS</span>
02796 <span class="preprocessor"></span>    ValidateSmsSendLists(psms);
02797 <span class="preprocessor">#endif</span>
02798 <span class="preprocessor"></span>
02799     UserAssert(psms-&gt;psmsReceiveNext == NULL);
02800 
02801 <span class="preprocessor">#if DBG</span>
02802 <span class="preprocessor"></span>    <span class="comment">/*</span>
02803 <span class="comment">     * Remember ahead of time if the psms we're unlinking is also the</span>
02804 <span class="comment">     * head of the sms send list (so we know if we need to update this field</span>
02805 <span class="comment">     * member in every SMS in this list).</span>
02806 <span class="comment">     */</span>
02807     fUpdateSendList = (psms == psms-&gt;psmsSendList);
02808 
02809     <span class="comment">/*</span>
02810 <span class="comment">     * Unlink sms from the sendlist chain. This effectively unlinks the SMS</span>
02811 <span class="comment">     * and updates psms-&gt;psmsSendList with the right head....</span>
02812 <span class="comment">     */</span>
02813     ppsms = &amp;(psms-&gt;psmsSendList);
02814     <span class="keywordflow">while</span> (*ppsms != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02815         <span class="keywordflow">if</span> (*ppsms == psms) {
02816             *ppsms = psms-&gt;psmsSendNext;
02817             <span class="keywordflow">break</span>;
02818         }
02819         ppsms = &amp;(*ppsms)-&gt;psmsSendNext;
02820     }
02821 
02822     <span class="comment">/*</span>
02823 <span class="comment">     * Update psmsSendList if necessary. psms-&gt;psmsSendList has been updated</span>
02824 <span class="comment">     * with the right sms send list head... distribute this head to all other</span>
02825 <span class="comment">     * sms's in this chain if this sms we're removing the current head.</span>
02826 <span class="comment">     */</span>
02827     <span class="keywordflow">if</span> (fUpdateSendList) {
02828         <span class="keywordflow">for</span> (psmsT = psms-&gt;psmsSendList; psmsT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02829                 psmsT = psmsT-&gt;psmsSendNext) {
02830             psmsT-&gt;psmsSendList = psms-&gt;psmsSendList;
02831         }
02832     }
02833 
02834     psms-&gt;psmsSendList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02835 <span class="preprocessor">#endif</span>
02836 <span class="preprocessor"></span>
02837     <span class="comment">/*</span>
02838 <span class="comment">     * This unlinks an sms structure from the global gpsmsList and frees it.</span>
02839 <span class="comment">     */</span>
02840     <span class="keywordflow">if</span> (ppsmsUnlink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02841         ppsmsUnlink = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>;
02842 
02843         <span class="keywordflow">while</span> (*ppsmsUnlink &amp;&amp; (*ppsmsUnlink != psms)) {
02844             ppsmsUnlink = &amp;((*ppsmsUnlink)-&gt;psmsNext);
02845         }
02846     }
02847 
02848     UserAssert(*ppsmsUnlink);
02849 
    *ppsmsUnlink = psms-&gt;psmsNext;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="kernel/sendmsg.c::UserLogError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UserLogError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>pwszError</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>cbError</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrorCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00292">292</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00528">gpWin32kDriverObject</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00428">IoAllocateErrorLogEntry()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00315">xxxSendBSMtoDesktop()</a>.
<p>
<pre class="fragment"><div>00296 {
00297     PIO_ERROR_LOG_PACKET perrLogEntry;
00298 
00299     <span class="comment">/*</span>
00300 <span class="comment">     * Allocate an error packet, fill it out, and write it to the log.</span>
00301 <span class="comment">     */</span>
00302     perrLogEntry = (PIO_ERROR_LOG_PACKET)<a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a>(gpWin32kDriverObject,
00303                                 (UCHAR)(cbError + <span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET)));
00304     <span class="keywordflow">if</span> (perrLogEntry) {
00305         perrLogEntry-&gt;ErrorCode = ErrorCode;
00306         <span class="keywordflow">if</span> (cbError) {
00307             perrLogEntry-&gt;NumberOfStrings = 1;
00308             perrLogEntry-&gt;StringOffset = FIELD_OFFSET(IO_ERROR_LOG_PACKET, DumpData);
00309             RtlCopyMemory(perrLogEntry-&gt;DumpData, pwszError, cbError);
00310         }
00311         <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a>(perrLogEntry);
00312     }
00313 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="kernel/sendmsg.c::xxxBroadcastMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG xxxBroadcastMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>wCmd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d8/uniontagBROADCASTMSG.html">PBROADCASTMSG</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pbcm</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02937">2937</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00981">_PostMessage()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l01797">xxxBroadcastDisplaySettingsChange()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01114">xxxSendMessageCallback()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01002">xxxSystemBroadcastMessage()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l03136">xxxUserResetDisplayDevice()</a>.
<p>
<pre class="fragment"><div>02946          :
02947 * 02-21-91 DavidPe      Created.
02948 \***************************************************************************/
02949 
02950 LONG <a class="code" href="../../d4/d1/userk_8h.html#a1475">xxxBroadcastMessage</a>(
02951     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02952     UINT message,
02953     WPARAM wParam,
02954     LPARAM lParam,
02955     UINT wCmd,
02956     <a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html">PBROADCASTMSG</a> pbcm)
02957 {
02958     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
02959     HWND *phwnd;
02960     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
02961     <a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html">PASYNCSENDMSG</a> pmsg;
02962     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiCurrent;
02963     LONG lRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02964     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPool;
02965     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02966     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPrivateMessage = (message &gt;= WM_USER) &amp;&amp; (message &lt; MAXINTATOM);
02967 
02968     <span class="keywordflow">if</span> (fPrivateMessage) {
02969         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Attempt to broadcast a private message"</span>);
02970     }
02971 
02972     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02973         <a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">LARGE_UNICODE_STRING</a> str;
02974         <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> pstr;
02975 
02976         <span class="comment">/*</span>
02977 <span class="comment">         * Handle special system-wide broadcasts.</span>
02978 <span class="comment">         */</span>
02979         <span class="keywordflow">switch</span> (message) {
02980         <span class="keywordflow">case</span> WM_SPOOLERSTATUS:
02981             <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a26">xxxSystemBroadcastMessage</a>(message, wParam, lParam, wCmd, pbcm);
02982             <span class="keywordflow">return</span> 1;
02983 
02984         <span class="keywordflow">case</span> WM_WININICHANGE:
02985         <span class="keywordflow">case</span> WM_DEVMODECHANGE:
02986 
02987             <span class="comment">/*</span>
02988 <span class="comment">             * Probe and capture the string.</span>
02989 <span class="comment">             */</span>
02990             <span class="keywordflow">if</span> (lParam) {
02991                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbAlloc;
02992                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02993 
02994                 <span class="comment">/*</span>
02995 <span class="comment">                 * Allocate a temp buffer and convert</span>
02996 <span class="comment">                 * the string to Unicode</span>
02997 <span class="comment">                 */</span>
02998                 pstr = ((<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)lParam);
02999                 <span class="keywordflow">if</span> (pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a>)
03000                     cbAlloc = (pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> + 1) * <span class="keyword">sizeof</span>(WCHAR);
03001                 <span class="keywordflow">else</span>
03002                     cbAlloc = pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> + <span class="keyword">sizeof</span>(WCHAR);
03003                 str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = UserAllocPoolWithQuota(cbAlloc, TAG_SMS_STRING);
03004                 <span class="keywordflow">if</span> (str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03005                     <span class="keywordflow">return</span> 0;
03006                 }
03007                 str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = cbAlloc;
03008                 str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o2">bAnsi</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03009                 <span class="keywordflow">try</span> {
03010                     <span class="keywordflow">if</span> (pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a>) {
03011                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(
03012                                         (PWCH)str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>,
03013                                         cbAlloc,
03014                                         &amp;cbAlloc,
03015                                         (PCH)pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>,
03016                                         pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>
03017                                         );
03018                         str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = cbAlloc;
03019                     } <span class="keywordflow">else</span> {
03020                         str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>;
03021                         RtlCopyMemory(str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>, pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>);
03022                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03023                     }
03024                     str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>[str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> / <span class="keyword">sizeof</span>(WCHAR)] = 0;
03025                 } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
03026                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03027                 }
03028                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03029                     UserFreePool(str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>);
03030                     <span class="keywordflow">return</span> 0;
03031                 }
03032                 pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>;
03033             }
03034             <span class="keywordflow">if</span> (lParam) {
03035                 <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, str.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>, &amp;tlPool);
03036             }
03037             <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a26">xxxSystemBroadcastMessage</a>(message, wParam,
03038                     lParam ? (LPARAM)&amp;str : 0, wCmd, pbcm);
03039             <span class="keywordflow">if</span> (lParam)
03040                 <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(ptiCurrent, &amp;tlPool);
03041             <span class="keywordflow">return</span> 1;
03042 
03043         <span class="keywordflow">case</span> WM_TIMECHANGE:
03044             <span class="comment">/*</span>
03045 <span class="comment">             * We automatically broadcast a WM_TIMECHANGE message whenever the</span>
03046 <span class="comment">             * kernel tells us the time has changed, so blow off any apps who</span>
03047 <span class="comment">             * are trying to do the same thing.</span>
03048 <span class="comment">             */</span>
03049             <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)) {
03050                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Only system should broadcast WM_TIMECHANGE"</span>);
03051                 <span class="keywordflow">return</span> 0;
03052             }
03053             <span class="keywordflow">break</span>;
03054         }
03055 
03056         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>);
03057 
03058         pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
03059 
03060         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03061             RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"sender must have an associated desktop"</span>);
03062             <span class="keywordflow">return</span> 0;
03063         }
03064     }
03065 
03066     pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, BWL_ENUMLIST, NULL);
03067     <span class="keywordflow">if</span> (pbwl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03068         <span class="keywordflow">return</span> 0;
03069 
03070     ppiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
03071 
03072     <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
03073 
03074         <span class="comment">/*</span>
03075 <span class="comment">         * Make sure this hwnd is still around.</span>
03076 <span class="comment">         */</span>
03077         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03078             <span class="keywordflow">continue</span>;
03079 
03080         <span class="comment">/*</span>
03081 <span class="comment">         * Make sure this window can handle broadcast messages</span>
03082 <span class="comment">         */</span>
03083         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a2">fBroadcastProc</a>(pwnd))
03084             <span class="keywordflow">continue</span>;
03085 
03086         <span class="keywordflow">if</span> (fPrivateMessage &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFWIN40COMPAT)) { <span class="comment">// Don't broadcast</span>
03087             <span class="keywordflow">continue</span>;                                         <span class="comment">// private message</span>
03088         }                                                     <span class="comment">// to 4.0 apps.</span>
03089 
03090         <span class="comment">/*</span>
03091 <span class="comment">         * Don't bother sending palette messages to windows that are not</span>
03092 <span class="comment">         * visible on threads that are not palette aware.</span>
03093 <span class="comment">         */</span>
03094         <span class="keywordflow">if</span> ((message == WM_PALETTEISCHANGING || message == WM_PALETTECHANGED) &amp;&amp;
03095                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFVISIBLE) &amp;&amp;
03096                 !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a805">TIF_PALETTEAWARE</a>)) {
03097             <span class="keywordflow">continue</span>;
03098         }
03099 
03100         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
03101 
03102         <span class="keywordflow">switch</span> (wCmd) {
03103         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a443">BMSG_SENDMSG</a>:
03104             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, message, wParam, lParam);
03105             <span class="keywordflow">break</span>;
03106 
03107         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a444">BMSG_SENDNOTIFYMSG</a>:
03108             {
03109                 ATOM Atom = 0;
03110 
03111                 <span class="keywordflow">switch</span> (message) {
03112                 <span class="keywordflow">case</span> WM_WININICHANGE:
03113                 <span class="keywordflow">case</span> WM_DEVMODECHANGE:
03114                     <span class="keywordflow">if</span> (lParam) {
03115                         <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> pstr = (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)lParam;
03116 
03117                         <span class="comment">/*</span>
03118 <span class="comment">                         * Convert strings to atoms for the post.</span>
03119 <span class="comment">                         */</span>
03120                         <span class="keywordflow">if</span> (pstr)
03121                             Atom = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, FALSE);
03122                         <span class="keywordflow">if</span> (!Atom) {
03123                             lRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03124                             <span class="keywordflow">break</span>;
03125                         }
03126                     }
03127 
03128                     <span class="comment">/*</span>
03129 <span class="comment">                     * These messages need to be able to cross</span>
03130 <span class="comment">                     * desktops so PostEvent 'em.</span>
03131 <span class="comment">                     */</span>
03132                     pmsg = UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html">ASYNCSENDMSG</a>),
03133                         TAG_SMS_ASYNC);
03134                     <span class="keywordflow">if</span> (pmsg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03135                         <span class="keywordflow">goto</span> CleanupAtom;
03136                     }
03137 
03138                     pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o3">hwnd</a> = *phwnd;
03139                     pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o2">message</a> = message;
03140                     pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o0">wParam</a> = wParam;
03141                     pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o1">lParam</a> = Atom;
03142 
03143                     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq,
03144                                          QEVENT_ASYNCSENDMSG,NULL, 0,
03145                                          (WPARAM)pmsg, 0)) {
03146 
03147                         UserFreePool(pmsg);
03148 CleanupAtom:
03149                         <span class="keywordflow">if</span> (Atom) {
03150                             <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>(Atom);
03151                         }
03152                         lRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03153                     }
03154                     <span class="keywordflow">break</span>;
03155 
03156                 <span class="keywordflow">default</span>:
03157                     <span class="comment">/*</span>
03158 <span class="comment">                     * A regular kind of guy.  No desktop crossing.</span>
03159 <span class="comment">                     */</span>
03160                     <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(pwnd, message, wParam, lParam);
03161                     <span class="keywordflow">break</span>;
03162                 }
03163             }
03164             <span class="keywordflow">break</span>;
03165 
03166         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a448">BMSG_SENDNOTIFYMSGPROCESS</a>:
03167             UserAssert(message != WM_WININICHANGE &amp;&amp; message != WM_DEVMODECHANGE);
03168 
03169             <span class="comment">/*</span>
03170 <span class="comment">             * Intra-process messages are synchronous; 22238.</span>
03171 <span class="comment">             * WM_PALETTECHANGED was being sent after the WM_DESTROY</span>
03172 <span class="comment">             * but console thread must not be synchronous.</span>
03173 <span class="comment">             */</span>
03174             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi == ppiCurrent) &amp;&amp; !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)) {
03175                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, message, wParam, lParam);
03176             } <span class="keywordflow">else</span> {
03177                 <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(pwnd, message, wParam, lParam);
03178             }
03179             <span class="keywordflow">break</span>;
03180 
03181         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a445">BMSG_POSTMSG</a>:
03182             <span class="comment">/*</span>
03183 <span class="comment">             * Don't broadcast-post to owned windows (Win3.1 compatiblilty)</span>
03184 <span class="comment">             */</span>
03185             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03186                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, message, wParam, lParam);
03187             <span class="keywordflow">break</span>;
03188 
03189         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a446">BMSG_SENDMSGCALLBACK</a>:
03190             <a class="code" href="../../d4/d1/userk_8h.html#a1583">xxxSendMessageCallback</a>(pwnd, message, wParam, lParam,
03191                     pbcm-&gt;<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o3">cb</a>.lpResultCallBack, pbcm-&gt;<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o3">cb</a>.dwData, pbcm-&gt;<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o3">cb</a>.bClientRequest);
03192             <span class="keywordflow">break</span>;
03193 
03194         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a447">BMSG_SENDMSGTIMEOUT</a>:
03195             <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwnd, message, wParam, lParam,
03196                     pbcm-&gt;<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o7">to</a>.fuFlags, pbcm-&gt;<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o7">to</a>.uTimeout, pbcm-&gt;<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o7">to</a>.lpdwResult);
03197             <span class="keywordflow">break</span>;
03198         }
03199 
03200         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
03201     }
03202 
    <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="kernel/sendmsg.c::xxxInterSendMsgEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT xxxInterSendMsgEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ptiSender</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ptiReceiver</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d8/structtagINTERSENDMSGEX.html">PINTRSENDMSGEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pism</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">1296</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00164">AllocSMS()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00451">_LARGE_STRING::bAnsi</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00421">_LARGE_STRING::Buffer</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03382">tagTHREADINFO::cEnterCount</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03506">CMSHUNGAPPTIMEOUT</a>, <a class="el" href="../../d7/d8/taskman_8c-source.html#l00594">DirectedScheduleTask()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03747">tagINTERSENDMSGEX::dwData</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02494">EFPASSWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00080">FHungApp()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00797">FNID_EDIT</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00178">FreeSMS()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03040">tagCLIENTTHREADINFO::fsChangeBits</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03744">tagINTERSENDMSGEX::fuCall</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03750">tagINTERSENDMSGEX::fuSend</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00843">GETFNID</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00643">gpsmsList</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00248">IS_SYSTEM_ADDRESS</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01293">IsAnsiString</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03755">ISM_CALLBACK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03759">ISM_CB_CLIENT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03758">ISM_REPLY</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01294">IsUnicodeString</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01799">KeSetKernelStackSwapEnable()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00449">_LARGE_STRING::Length</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03752">tagINTERSENDMSGEX::lpdwResult</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03746">tagINTERSENDMSGEX::lpResultCallBack</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">LPVOID</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03748">tagINTERSENDMSGEX::lRet</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00450">_LARGE_STRING::MaximumLength</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03684">_MDICREATESTRUCTEX::mdics</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01292">NoString</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03325">tagTHREADINFO::pcti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00084">PpiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03297">PSMS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03336">tagTHREADINFO::psmsCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03337">tagTHREADINFO::psmsReceiveList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03335">tagTHREADINFO::psmsSent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04578">SetWakeBit()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03734">SMF_CB_CLIENT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03733">SMF_CB_REPLY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03732">SMF_CB_REQUEST</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03735">SMF_CB_SERVER</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03731">SMF_RECEIVEDMESSAGE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03738">SMF_RECEIVERBUSY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03730">SMF_RECEIVERFREE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03727">SMF_REPLY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03686">_MDICREATESTRUCTEX::strClass</a>, <a class="el" href="../../d2/d4/w32_2ntuser_2rtl_2random_8c-source.html#l00184">strncpycch()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03685">_MDICREATESTRUCTEX::strTitle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02770">UnlinkSendListSms()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03751">tagINTERSENDMSGEX::uTimeout</a>, <a class="el" href="../../d2/d4/w32_2ntuser_2rtl_2random_8c-source.html#l00146">wcsncpycch()</a>, and <a class="el" href="../../d7/d2/queue_8c-source.html#l04382">xxxSleepThread()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00198">_ReplyMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02534">ReceiverDied()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01964">xxxReceiveMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01114">xxxSendMessageCallback()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>.
<p>
<pre class="fragment"><div>01301          :
01302 * 07-13-92 ChrisBl       Created/extended from xxxInterSendMsg
01303 \***********************************************************************/
01304 
01305 <span class="preprocessor">#define NoString        0</span>
01306 <span class="preprocessor"></span><span class="preprocessor">#define IsAnsiString    1</span>
01307 <span class="preprocessor"></span><span class="preprocessor">#define IsUnicodeString 2</span>
01308 <span class="preprocessor"></span>
01309 LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(
01310     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01311     UINT message,
01312     WPARAM wParam,
01313     LPARAM lParam,
01314     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiSender,
01315     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiReceiver,
01316     <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">PINTRSENDMSGEX</a> pism)
01317 {
01318     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psms, *ppsms;
01319     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psmsSentSave;
01320     LRESULT lRet = 0;
01321     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbCapture, cbOutput;
01322     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> lpCapture;
01323     PCOPYDATASTRUCT pcds;
01324     <a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html">PMDICREATESTRUCTEX</a> pmdics;
01325     LPHLP phlp;
01326     LPHELPINFO phelpinfo;
01327     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
01328     LPARAM lParamSave;
01329     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fString = <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a4">NoString</a>;
01330     BOOLEAN bWasSwapEnabled;
01331 
01332     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01333 
01334 
01335     <span class="comment">/*</span>
01336 <span class="comment">     * If the sender is dying, fail the call</span>
01337 <span class="comment">     */</span>
01338     <span class="keywordflow">if</span> ((ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>))
01339         <span class="keywordflow">return</span> 0;
01340 
01341     <span class="comment">/*</span>
01342 <span class="comment">     * Some messages cannot be sent across process because we don't know how to thunk them</span>
01343 <span class="comment">     * Fail attempts to read passwords across processes.</span>
01344 <span class="comment">     */</span>
01345     <span class="keywordflow">if</span> (pwnd &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
01346         <span class="keywordflow">switch</span> (message) {
01347         <span class="keywordflow">case</span> WM_NOTIFY:
01348             RIPMSG0(RIP_WARNING | RIP_THERESMORE, <span class="stringliteral">"xxxInterSendMsgEx: message cannot be sent across processes"</span>);
01349             RIPMSG4(RIP_WARNING | RIP_THERESMORE, <span class="stringliteral">" pwnd:%#p message:%#x wParam:%#p lParam:%#p"</span>, pwnd, message, wParam, lParam);
01350             <span class="keywordflow">return</span> 0;
01351 
01352         <span class="keywordflow">case</span> WM_GETTEXT:
01353         <span class="keywordflow">case</span> EM_GETLINE:
01354         <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
01355             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a204">FNID_EDIT</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, EFPASSWORD)) {
01356                 RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"Can't access protected edit control"</span>);
01357                 <span class="keywordflow">return</span> 0;
01358             }
01359             <span class="keywordflow">break</span>;
01360         }
01361     }
01362 
01363     <span class="comment">/*</span>
01364 <span class="comment">     * Alloc SMS structure.</span>
01365 <span class="comment">     */</span>
01366     psms = <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a15">AllocSMS</a>();
01367     <span class="keywordflow">if</span> (psms == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01368 
01369         <span class="comment">/*</span>
01370 <span class="comment">         * Set to zero so xxxSendNotifyMessage would return FALSE.</span>
01371 <span class="comment">         */</span>
01372         <span class="keywordflow">return</span> 0;
01373     }
01374 
01375     <span class="comment">/*</span>
01376 <span class="comment">     * Prepare to capture variable length data from client</span>
01377 <span class="comment">     * space.  Addresses have already been probed.  Fixed-length</span>
01378 <span class="comment">     * data is probed and captured in the message thunk.</span>
01379 <span class="comment">     */</span>
01380     psms-&gt;pvCapture = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01381     cbCapture = cbOutput = 0;
01382     lpCapture = (LPBYTE)lParam;
01383 
01384     <span class="comment">/*</span>
01385 <span class="comment">     * For messages with indirect data, set cbCapture and lpCapture</span>
01386 <span class="comment">     * (if not lParam) as approp.</span>
01387 <span class="comment">     */</span>
01388     <span class="keywordflow">try</span> {
01389         <span class="keywordflow">switch</span> (message) {
01390         <span class="keywordflow">case</span> WM_COPYGLOBALDATA:     <span class="comment">// fnCOPYGLOBALDATA</span>
01391             cbCapture = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)wParam;
01392             <span class="keywordflow">break</span>;
01393 
01394         <span class="keywordflow">case</span> WM_COPYDATA:           <span class="comment">// fnCOPYDATA</span>
01395             pcds = (PCOPYDATASTRUCT)lParam;
01396             <span class="keywordflow">if</span> (pcds-&gt;lpData) {
01397                 cbCapture = <span class="keyword">sizeof</span>(COPYDATASTRUCT) + pcds-&gt;cbData;
01398             } <span class="keywordflow">else</span> {
01399                 cbCapture = <span class="keyword">sizeof</span>(COPYDATASTRUCT);
01400             }
01401             <span class="keywordflow">break</span>;
01402 
01403         <span class="keywordflow">case</span> WM_CREATE:             <span class="comment">// fnINLPCREATESTRUCT</span>
01404         <span class="keywordflow">case</span> WM_NCCREATE:           <span class="comment">// fnINLPCREATESTRUCT</span>
01405             RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"Can't Intersend WM_CREATE or WM_NCCREATE message"</span>);
01406             <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a16">FreeSMS</a>(psms);
01407             <span class="keywordflow">return</span> 0;
01408 
01409         <span class="keywordflow">case</span> WM_HELP:               <span class="comment">// fnINLPHELPINFOSTRUCT</span>
01410             phelpinfo = (LPHELPINFO)lParam;
01411             cbCapture = phelpinfo-&gt;cbSize;
01412             <span class="keywordflow">break</span>;
01413 
01414         <span class="keywordflow">case</span> WM_WINHELP:            <span class="comment">// fnINLPHLPSTRUCT</span>
01415             phlp = (LPHLP)lParam;
01416             cbCapture = phlp-&gt;cbData;
01417             <span class="keywordflow">break</span>;
01418 
01419         <span class="keywordflow">case</span> WM_MDICREATE:          <span class="comment">// fnINLPMDICREATESTRUCT</span>
01420             pmdics = (<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html">PMDICREATESTRUCTEX</a>)lParam;
01421             cbCapture = pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o1">strTitle</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> +
01422                     pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>;
01423             UserAssert(pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> == NULL || pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> == pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szClass);
01424             <span class="keywordflow">if</span> (pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o1">strTitle</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>)
01425                 UserAssert(pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o1">strTitle</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> == pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szTitle);
01426             <span class="keywordflow">break</span>;
01427 
01428         <span class="keywordflow">case</span> LB_ADDSTRING:           <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01429         <span class="keywordflow">case</span> LB_INSERTSTRING:        <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01430         <span class="keywordflow">case</span> LB_SELECTSTRING:        <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01431         <span class="keywordflow">case</span> LB_FINDSTRING:          <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01432         <span class="keywordflow">case</span> LB_FINDSTRINGEXACT:     <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01433             <span class="comment">/*</span>
01434 <span class="comment">             * See if the control is ownerdraw and does not have the LBS_HASSTRINGS</span>
01435 <span class="comment">             * style. If so, treat lParam as a DWORD.</span>
01436 <span class="comment">             */</span>
01437             <span class="keywordflow">if</span> (pwnd &amp;&amp; !(pwnd-&gt;style &amp; LBS_HASSTRINGS) &amp;&amp;
01438                     (pwnd-&gt;style &amp; (LBS_OWNERDRAWFIXED | LBS_OWNERDRAWVARIABLE))) {
01439                 <span class="comment">/*</span>
01440 <span class="comment">                 * Treat lParam as a dword.</span>
01441 <span class="comment">                 */</span>
01442                 <span class="keywordflow">break</span>;
01443             } <span class="keywordflow">else</span> {
01444                 <span class="keywordflow">goto</span> fnINSTRINGThunk;
01445             }
01446             <span class="keywordflow">break</span>;
01447 
01448         <span class="keywordflow">case</span> CB_ADDSTRING:           <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01449         <span class="keywordflow">case</span> CB_INSERTSTRING:        <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01450         <span class="keywordflow">case</span> CB_SELECTSTRING:        <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01451         <span class="keywordflow">case</span> CB_FINDSTRING:          <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01452         <span class="keywordflow">case</span> CB_FINDSTRINGEXACT:     <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01453             <span class="comment">/*</span>
01454 <span class="comment">             * See if the control is ownerdraw and does not have the CBS_HASSTRINGS</span>
01455 <span class="comment">             * style. If so, treat lParam as a DWORD.</span>
01456 <span class="comment">             */</span>
01457             <span class="keywordflow">if</span> (pwnd &amp;&amp; !(pwnd-&gt;style &amp; CBS_HASSTRINGS) &amp;&amp;
01458                     (pwnd-&gt;style &amp; (CBS_OWNERDRAWFIXED | CBS_OWNERDRAWVARIABLE))) {
01459 
01460                 <span class="comment">/*</span>
01461 <span class="comment">                 * Treat lParam as a dword.</span>
01462 <span class="comment">                 */</span>
01463                 <span class="keywordflow">break</span>;
01464             } <span class="keywordflow">else</span> {
01465                 <span class="keywordflow">goto</span> fnINSTRINGThunk;
01466             }
01467             <span class="keywordflow">break</span>;
01468 
01469         <span class="keywordflow">case</span> EM_REPLACESEL:         <span class="comment">// fnINSTRINGNULL</span>
01470         <span class="keywordflow">case</span> WM_SETTEXT:            <span class="comment">// fnINSTRINGNULL</span>
01471         <span class="keywordflow">case</span> WM_WININICHANGE:       <span class="comment">// fnINSTRINGNULL</span>
01472             <span class="keywordflow">if</span> (lParam == 0)
01473                 <span class="keywordflow">break</span>;
01474 
01475             <span class="comment">/*</span>
01476 <span class="comment">             * Fall through</span>
01477 <span class="comment">             */</span>
01478 
01479         <span class="keywordflow">case</span> CB_DIR:                <span class="comment">// fnINSTRING</span>
01480         <span class="keywordflow">case</span> LB_ADDFILE:            <span class="comment">// fnINSTRING</span>
01481         <span class="keywordflow">case</span> LB_DIR:                <span class="comment">// fnINSTRING</span>
01482         <span class="keywordflow">case</span> WM_DEVMODECHANGE:      <span class="comment">// fnINSTRING</span>
01483 fnINSTRINGThunk:
01484 
01485             <span class="comment">/*</span>
01486 <span class="comment">             * Only capture strings if they are not in system space</span>
01487 <span class="comment">             */</span>
01488             str = *(<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)lParam;
01489             lParam = (LPARAM)&amp;str;
01490 
01491             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/mm_8h.html#a10">IS_SYSTEM_ADDRESS</a>(str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>))
01492                 cbCapture = str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> + <span class="keyword">sizeof</span>(WCHAR);
01493             <span class="keywordflow">break</span>;
01494 
01495         <span class="keywordflow">case</span> WM_DEVICECHANGE:
01496             <span class="keywordflow">if</span> (lParam == 0)
01497                 <span class="keywordflow">break</span>;
01498 
01499             <span class="comment">/*</span>
01500 <span class="comment">             * Only capture data if lParam is a pointer and</span>
01501 <span class="comment">             * the data is not in system space</span>
01502 <span class="comment">             */</span>
01503             <span class="keywordflow">if</span> ((wParam &amp; 0x8000) != 0x8000)
01504                 <span class="keywordflow">break</span>;
01505 
01506             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/mm_8h.html#a10">IS_SYSTEM_ADDRESS</a>((LPVOID)lParam)) {
01507                 cbCapture = *((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)lpCapture);
01508                 UserAssert(FALSE);
01509             }
01510             <span class="keywordflow">break</span>;
01511 
01512         <span class="keywordflow">case</span> EM_SETTABSTOPS:        <span class="comment">// fnPOPTINLPUINT</span>
01513         <span class="keywordflow">case</span> LB_SETTABSTOPS:        <span class="comment">// fnPOPTINLPUINT</span>
01514         <span class="keywordflow">case</span> LB_GETSELITEMS:        <span class="comment">// fnPOUTLPINT</span>
01515             cbCapture = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>);
01516             <span class="keywordflow">break</span>;
01517 
01518         <span class="keywordflow">case</span> EM_GETLINE:            <span class="comment">// fnINCNTOUTSTRING</span>
01519         <span class="keywordflow">case</span> WM_ASKCBFORMATNAME:    <span class="comment">// fnINCNTOUTSTRINGNULL</span>
01520         <span class="keywordflow">case</span> WM_GETTEXT:            <span class="comment">// fnOUTSTRING</span>
01521         <span class="keywordflow">case</span> LB_GETTEXT:            <span class="comment">// fnOUTLBOXSTRING</span>
01522         <span class="keywordflow">case</span> CB_GETLBTEXT:          <span class="comment">// fnOUTCBOXSTRING</span>
01523 
01524             <span class="comment">/*</span>
01525 <span class="comment">             * Only allocate output buffer if the real one is not in system space</span>
01526 <span class="comment">             */</span>
01527             str = *(<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)lParam;
01528             <span class="comment">/*</span>
01529 <span class="comment">            * Bug 18108. For WM_GETTEXT only copy the actual string and not the</span>
01530 <span class="comment">            * the maximum size into the output buffer</span>
01531 <span class="comment">            */</span>
01532             <span class="keywordflow">if</span>(str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a>) {
01533                 fString = <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a5">IsAnsiString</a>  ;
01534             } <span class="keywordflow">else</span> {
01535                 fString  = <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a6">IsUnicodeString</a> ;
01536             }
01537             lParam = (LPARAM)&amp;str;
01538             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/mm_8h.html#a10">IS_SYSTEM_ADDRESS</a>(str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>))
01539                 cbCapture = str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>;
01540             <span class="keywordflow">break</span>;
01541         }
01542         <span class="keywordflow">if</span> (cbCapture &amp;&amp;
01543                 (psms-&gt;pvCapture = UserAllocPoolWithQuota(cbCapture, TAG_SMS_CAPTURE)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01544 
01545             lParamSave = lParam;
01546 
01547             <span class="comment">/*</span>
01548 <span class="comment">             * now actually copy memory from lpCapture to psms-&gt;pvCapture</span>
01549 <span class="comment">             * and fixup any references to the indirect data to point to</span>
01550 <span class="comment">             * psms-&gt;pvCapture.</span>
01551 <span class="comment">             */</span>
01552             <span class="keywordflow">switch</span> (message) {
01553             <span class="keywordflow">case</span> WM_COPYDATA:     <span class="comment">// fnCOPYDATA</span>
01554                 {
01555                     PCOPYDATASTRUCT pcdsNew = (PCOPYDATASTRUCT)psms-&gt;pvCapture;
01556                     lParam = (LPARAM)pcdsNew;
01557                     RtlCopyMemory(pcdsNew, pcds, <span class="keyword">sizeof</span>(COPYDATASTRUCT));
01558                     <span class="keywordflow">if</span> (pcds-&gt;lpData) {
01559                         pcdsNew-&gt;lpData = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcdsNew + <span class="keyword">sizeof</span>(COPYDATASTRUCT));
01560                         RtlCopyMemory(pcdsNew-&gt;lpData, pcds-&gt;lpData, pcds-&gt;cbData);
01561                     }
01562                 }
01563                 <span class="keywordflow">break</span>;
01564             <span class="keywordflow">case</span> WM_MDICREATE:          <span class="comment">// fnINLPMDICREATESTRUCT</span>
01565                 <span class="keywordflow">if</span> (pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>) {
01566                     RtlCopyMemory(psms-&gt;pvCapture, pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>,
01567                             pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>);
01568                     pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szClass = (LPWSTR)psms-&gt;pvCapture;
01569                 }
01570                 <span class="keywordflow">if</span> (pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o1">strTitle</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a>) {
01571                     lpCapture = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)psms-&gt;pvCapture + pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o2">strClass</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>;
01572                     RtlCopyMemory(lpCapture, pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o1">strTitle</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>,
01573                             pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o1">strTitle</a>.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a>);
01574                     pmdics-&gt;<a class="code" href="../../d5/d7/struct__MDICREATESTRUCTEX.html#o0">mdics</a>.szTitle = (LPWSTR)lpCapture;
01575                 }
01576                 <span class="keywordflow">break</span>;
01577 
01578             <span class="keywordflow">case</span> CB_DIR:                <span class="comment">// fnINSTRING</span>
01579             <span class="keywordflow">case</span> LB_FINDSTRING:         <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01580             <span class="keywordflow">case</span> LB_FINDSTRINGEXACT:    <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01581             <span class="keywordflow">case</span> CB_FINDSTRING:         <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01582             <span class="keywordflow">case</span> CB_FINDSTRINGEXACT:    <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01583             <span class="keywordflow">case</span> LB_ADDFILE:            <span class="comment">// fnINSTRING</span>
01584             <span class="keywordflow">case</span> LB_ADDSTRING:          <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01585             <span class="keywordflow">case</span> LB_INSERTSTRING:       <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01586             <span class="keywordflow">case</span> LB_SELECTSTRING:       <span class="comment">// INLBOXSTRING calls fnINSTRING</span>
01587             <span class="keywordflow">case</span> CB_ADDSTRING:          <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01588             <span class="keywordflow">case</span> CB_INSERTSTRING:       <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01589             <span class="keywordflow">case</span> CB_SELECTSTRING:       <span class="comment">// INCBOXSTRING calls fnINSTRING</span>
01590             <span class="keywordflow">case</span> LB_DIR:                <span class="comment">// fnINSTRING</span>
01591             <span class="keywordflow">case</span> WM_DEVMODECHANGE:      <span class="comment">// fnINSTRING</span>
01592             <span class="keywordflow">case</span> EM_REPLACESEL:         <span class="comment">// fnINSTRINGNULL</span>
01593             <span class="keywordflow">case</span> WM_SETTEXT:            <span class="comment">// fnINSTRINGNULL</span>
01594             <span class="keywordflow">case</span> WM_WININICHANGE:       <span class="comment">// fnINSTRINGNULL</span>
01595                 RtlCopyMemory(psms-&gt;pvCapture, str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, cbCapture);
01596                 str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = psms-&gt;pvCapture;
01597                 <span class="keywordflow">break</span>;
01598 
01599             <span class="keywordflow">case</span> LB_GETSELITEMS:
01600                  cbOutput = cbCapture;
01601                  RtlCopyMemory(psms-&gt;pvCapture, lpCapture, cbCapture);
01602                  lParam = (LPARAM)psms-&gt;pvCapture;
01603                  <span class="keywordflow">break</span>;
01604 
01605             <span class="keywordflow">case</span> EM_GETLINE:            <span class="comment">// fnINCNTOUTSTRING</span>
01606                  *(WORD *)psms-&gt;pvCapture = *(WORD *)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>;
01607 
01608                 <span class="comment">/*</span>
01609 <span class="comment">                 * Fall through</span>
01610 <span class="comment">                 */</span>
01611             <span class="keywordflow">case</span> WM_ASKCBFORMATNAME:    <span class="comment">// fnINCNTOUTSTRINGNULL</span>
01612             <span class="keywordflow">case</span> WM_GETTEXT:            <span class="comment">// fnOUTSTRING</span>
01613             <span class="keywordflow">case</span> LB_GETTEXT:            <span class="comment">// fnOUTLBOXSTRING</span>
01614             <span class="keywordflow">case</span> CB_GETLBTEXT:          <span class="comment">// fnOUTCBOXSTRING</span>
01615                 cbOutput = cbCapture;
01616                 lParamSave = (LPARAM)str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>;
01617                 str.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = psms-&gt;pvCapture;
01618                 <span class="keywordflow">break</span>;
01619 
01620             <span class="keywordflow">default</span>:
01621                 RtlCopyMemory(psms-&gt;pvCapture, lpCapture, cbCapture);
01622                 lParam = (LPARAM)psms-&gt;pvCapture;
01623                 <span class="keywordflow">break</span>;
01624             }
01625         }
01626     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
01627         <span class="keywordflow">if</span> (psms-&gt;pvCapture != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01628             UserFreePool(psms-&gt;pvCapture);
01629         <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a16">FreeSMS</a>(psms);
01630         <span class="keywordflow">return</span> 0;
01631     }
01632 
01633     <span class="keywordflow">if</span> (cbCapture &amp;&amp; psms-&gt;pvCapture == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01634         <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a16">FreeSMS</a>(psms);
01635         <span class="keywordflow">return</span> 0;
01636     }
01637 
01638     <span class="comment">/*</span>
01639 <span class="comment">     * Copy message parms</span>
01640 <span class="comment">     */</span>
01641     psms-&gt;spwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01642     psms-&gt;psmsReceiveNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01643 <span class="preprocessor">#if DBG</span>
01644 <span class="preprocessor"></span>    psms-&gt;psmsSendList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01645     psms-&gt;psmsSendNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01646 <span class="preprocessor">#endif</span>
01647 <span class="preprocessor"></span>    <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(psms-&gt;spwnd), pwnd);
01648     psms-&gt;message = message;
01649     psms-&gt;wParam = wParam;
01650     psms-&gt;lParam = lParam;
01651     psms-&gt;flags = 0;
01652 
01653     <span class="comment">/*</span>
01654 <span class="comment">     * Link into gpsmsList</span>
01655 <span class="comment">     */</span>
01656     psms-&gt;psmsNext = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>;
01657     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a> = psms;
01658 
01659     <span class="comment">/*</span>
01660 <span class="comment">     * Time stamp message</span>
01661 <span class="comment">     */</span>
01662     psms-&gt;tSent = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
01663 
01664     <span class="comment">/*</span>
01665 <span class="comment">     * Set queue fields</span>
01666 <span class="comment">     */</span>
01667     psms-&gt;ptiReceiver = ptiReceiver;
01668     psms-&gt;ptiSender = ptiSender;
01669     psms-&gt;ptiCallBackSender = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01670 
01671     <span class="keywordflow">if</span> ((pism != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a436">ISM_CALLBACK</a>)) {
01672         <span class="comment">/*</span>
01673 <span class="comment">         * Setup for a SendMessageCallback</span>
01674 <span class="comment">         */</span>
01675         psms-&gt;flags |= (pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a440">ISM_CB_CLIENT</a>) ? <a class="code" href="../../d4/d1/userk_8h.html#a431">SMF_CB_CLIENT</a> : <a class="code" href="../../d4/d1/userk_8h.html#a432">SMF_CB_SERVER</a>;
01676         psms-&gt;lpResultCallBack = pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o1">lpResultCallBack</a>;
01677         psms-&gt;dwData = pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o2">dwData</a>;
01678 
01679         <span class="keywordflow">if</span> (pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a439">ISM_REPLY</a>) {
01680             psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a430">SMF_CB_REPLY</a>;
01681             psms-&gt;lRet = pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o3">lRet</a>;
01682         } <span class="keywordflow">else</span> {  <span class="comment">/* REQUEST */</span>
01683             psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a429">SMF_CB_REQUEST</a>;
01684             psms-&gt;ptiCallBackSender = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01685         }
01686     }
01687 
01688     <span class="comment">/*</span>
01689 <span class="comment">     * Add SMS to the end of the ptiReceiver's receive list</span>
01690 <span class="comment">     */</span>
01691     ppsms = &amp;ptiReceiver-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o13">psmsReceiveList</a>;
01692     <span class="keywordflow">while</span> (*ppsms != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01693         ppsms = &amp;((*ppsms)-&gt;psmsReceiveNext);
01694     }
01695     *ppsms = psms;
01696 
01697     <span class="comment">/*</span>
01698 <span class="comment">     * Link this SMS into the SendMsg chain.  Of course only do this if</span>
01699 <span class="comment">     * it's not from a xxxSendNotifyMessage() call.</span>
01700 <span class="comment">     *</span>
01701 <span class="comment">     * The psmsSendNext field implements a chain of messages being</span>
01702 <span class="comment">     * processed because of an initial SendMsg call.  For example, if</span>
01703 <span class="comment">     * thread A sends message M1 to thread B, which causes B to send</span>
01704 <span class="comment">     * message M2 to thread C, the SendMsg chain is M1-&gt;M2.  If the</span>
01705 <span class="comment">     * system hangs in this situation, the chain is traversed to find</span>
01706 <span class="comment">     * the offending thread (C).</span>
01707 <span class="comment">     *</span>
01708 <span class="comment">     * psms-&gt;psmsSendList always points to the head of this list so</span>
01709 <span class="comment">     * we can tell where to begin a list traversal.</span>
01710 <span class="comment">     *</span>
01711 <span class="comment">     * ptiSender-&gt;psmsCurrent is the last SMS in the chain.</span>
01712 <span class="comment">     */</span>
01713 <span class="preprocessor">#if DBG</span>
01714 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01715         <span class="comment">/*</span>
01716 <span class="comment">         * sending queue is currently processing a message sent to it,</span>
01717 <span class="comment">         * so append SMS to the chain.  Link in the new sms because</span>
01718 <span class="comment">         * psmsSendNext may be pointing to a replied-to message.</span>
01719 <span class="comment">         */</span>
01720         psms-&gt;psmsSendNext = ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a>-&gt;psmsSendNext;
01721         ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a>-&gt;psmsSendNext = psms;
01722         psms-&gt;psmsSendList = ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a>-&gt;psmsSendList;
01723 
01724     } <span class="keywordflow">else</span> {
01725         <span class="comment">/*</span>
01726 <span class="comment">         * sending queue is initiating a send sequence, so put sms at</span>
01727 <span class="comment">         * the head of the chain</span>
01728 <span class="comment">         */</span>
01729         psms-&gt;psmsSendList = psms;
01730     }
01731 <span class="preprocessor">#endif</span>
01732 <span class="preprocessor"></span>
01733     <span class="keywordflow">if</span> (ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01734         <span class="comment">/*</span>
01735 <span class="comment">         * ptiSender-&gt;psmsSent marks the most recent message sent from this</span>
01736 <span class="comment">         * thread that has not yet been replied to.  Save the previous value</span>
01737 <span class="comment">         * on the stack so it can be restored when we get the reply.</span>
01738 <span class="comment">         *</span>
01739 <span class="comment">         * This way when an "older" SMS for this thread gets a reply before</span>
01740 <span class="comment">         * the "current" one does, the thread does get woken up.</span>
01741 <span class="comment">         */</span>
01742         psmsSentSave = ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o11">psmsSent</a>;
01743         ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o11">psmsSent</a> = psms;
01744     } <span class="keywordflow">else</span> {
01745 
01746         <span class="comment">/*</span>
01747 <span class="comment">         * Set SMF_RECEIVERFREE since we'll be returning to</span>
01748 <span class="comment">         * xxxSendNotifyMessage() right away and won't get a</span>
01749 <span class="comment">         * chance to free it.</span>
01750 <span class="comment">         */</span>
01751         psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a427">SMF_RECEIVERFREE</a>;
01752     }
01753 
01754 <span class="preprocessor">#ifdef DEBUG_SMS</span>
01755 <span class="preprocessor"></span>    ValidateSmsSendLists(psms);
01756 <span class="preprocessor">#endif</span>
01757 <span class="preprocessor"></span>
01758     <span class="comment">/*</span>
01759 <span class="comment">     * If we're not being called from xxxSendNotifyMessage() or</span>
01760 <span class="comment">     * SendMessageCallback(), then sleep while we wait for the reply.</span>
01761 <span class="comment">     */</span>
01762     <span class="keywordflow">if</span> (ptiSender == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01763         <span class="comment">/*</span>
01764 <span class="comment">         * Wake receiver for the sent message</span>
01765 <span class="comment">         */</span>
01766         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiReceiver, QS_SENDMESSAGE);
01767 
01768         <span class="keywordflow">return</span> (LONG)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01769     } <span class="keywordflow">else</span> {
01770         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fTimeOut = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01771         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uTimeout = 0;
01772         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uWakeMask = QS_SMSREPLY;
01773 
01774         <span class="comment">/*</span>
01775 <span class="comment">         * Wake up the receiver thread.</span>
01776 <span class="comment">         */</span>
01777         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiReceiver, QS_SENDMESSAGE);
01778 
01779         <span class="comment">/*</span>
01780 <span class="comment">         * We have 4 sending cases:</span>
01781 <span class="comment">         *</span>
01782 <span class="comment">         * 16 - 16 : yield to the 16 bit receiver</span>
01783 <span class="comment">         * 32 - 16 : no yielding required</span>
01784 <span class="comment">         * 16 - 32 : sender yields while receiver processes the message</span>
01785 <span class="comment">         * 32 - 32 : no yielding required.</span>
01786 <span class="comment">         */</span>
01787         <span class="keywordflow">if</span> (ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a> || ptiReceiver-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
01788             <a class="code" href="../../d4/d1/userk_8h.html#a1559">DirectedScheduleTask</a>(ptiSender, ptiReceiver, TRUE, psms);
01789         }
01790 
01791         <span class="comment">/*</span>
01792 <span class="comment">         * Put this thread to sleep until the reply arrives.  First clear</span>
01793 <span class="comment">         * the QS_SMSREPLY bit, then leave the semaphore and go to sleep.</span>
01794 <span class="comment">         *</span>
01795 <span class="comment">         * IMPORTANT:  The QS_SMSREPLY bit is not cleared once we get a</span>
01796 <span class="comment">         * reply because of the following case:</span>
01797 <span class="comment">         *</span>
01798 <span class="comment">         * We've recursed a second level into SendMessage() when the first level</span>
01799 <span class="comment">         * receiver thread dies, causing exit list processing to simulate</span>
01800 <span class="comment">         * a reply to the first message.  When the second level send returns,</span>
01801 <span class="comment">         * SleepThread() is called again to get the first reply.</span>
01802 <span class="comment">         *</span>
01803 <span class="comment">         * Keeping QS_SMSREPLY set causes this call to SleepThread()</span>
01804 <span class="comment">         * to return without going to sleep to wait for the reply that has</span>
01805 <span class="comment">         * already happened.</span>
01806 <span class="comment">         */</span>
01807         <span class="keywordflow">if</span> ( pism != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01808             <span class="keywordflow">if</span> (pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o4">fuSend</a> &amp; SMTO_BLOCK) {
01809                 <span class="comment">/*</span>
01810 <span class="comment">                 * only wait for a return, all other events will</span>
01811 <span class="comment">                 * be ignored until timeout or return</span>
01812 <span class="comment">                 */</span>
01813                 uWakeMask |= QS_EXCLUSIVE;
01814             }
01815 
01816             uTimeout = pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o5">uTimeout</a>;
01817         }
01818 
01819 
01820         <span class="comment">/*</span>
01821 <span class="comment">         * Don't swap this guys stack while sleeping during a sendmessage</span>
01822 <span class="comment">         */</span>
01823         <span class="keywordflow">if</span> (ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o42">cEnterCount</a> == 0) {
01824             bWasSwapEnabled = <a class="code" href="../../d9/d1/thredobj_8c.html#a23">KeSetKernelStackSwapEnable</a>(FALSE);
01825         } <span class="keywordflow">else</span> {
01826             UserAssert(ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o42">cEnterCount</a> &gt; 0);
01827         }
01828         ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o42">cEnterCount</a>++;
01829 
01830 
01831         <span class="keywordflow">while</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>) &amp;&amp; !fTimeOut) {
01832             ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~QS_SMSREPLY;
01833 
01834             <span class="comment">/*</span>
01835 <span class="comment">             * If SendMessageTimeout, sleep for timeout amount, else wait</span>
01836 <span class="comment">             * forever.  Since this is not technically a transition to an</span>
01837 <span class="comment">             * idle condition, indicate that this sleep is not going "idle".</span>
01838 <span class="comment">             */</span>
01839             fTimeOut = !<a class="code" href="../../d4/d1/userk_8h.html#a1196">xxxSleepThread</a>(uWakeMask, uTimeout, FALSE);
01840             <span class="comment">/*</span>
01841 <span class="comment">             * If a timeout occurs, and the SMTO_NOTIMEOUTIFNOTHUNG bit is set,</span>
01842 <span class="comment">             * and the app is still calling GetMessage(), then just try again.</span>
01843 <span class="comment">             * This probably means that the receiver has put up some UI in</span>
01844 <span class="comment">             * response to this message but the user hasn't completed the</span>
01845 <span class="comment">             * interaction yet.</span>
01846 <span class="comment">             */</span>
01847             <span class="keywordflow">if</span> (fTimeOut &amp;&amp; pism &amp;&amp; (pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o4">fuSend</a> &amp; SMTO_NOTIMEOUTIFNOTHUNG) &amp;&amp;
01848                     !<a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(ptiReceiver, CMSHUNGAPPTIMEOUT)) {
01849                 fTimeOut = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01850             }
01851         }
01852 
01853         UserAssert(ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o42">cEnterCount</a> &gt; 0);
01854         <span class="keywordflow">if</span> (--ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o42">cEnterCount</a> == 0) {
01855             <a class="code" href="../../d9/d1/thredobj_8c.html#a23">KeSetKernelStackSwapEnable</a>(bWasSwapEnabled);
01856         }
01857 
01858         <span class="comment">/*</span>
01859 <span class="comment">         * The reply bit should always be set! (even if we timed out). That</span>
01860 <span class="comment">         * is because if we're recursed into intersendmsg, we're going to</span>
01861 <span class="comment">         * return to the first intersendmsg's call to SleepThread() - and</span>
01862 <span class="comment">         * it needs to return back to intersendmsgex to see if its sms</span>
01863 <span class="comment">         * has been replied to.</span>
01864 <span class="comment">         */</span>
01865         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiSender, QS_SMSREPLY);
01866 
01867         <span class="comment">/*</span>
01868 <span class="comment">         * Copy out captured data.  If cbOutput != 0 we know</span>
01869 <span class="comment">         * that the output buffer is in user-mode address</span>
01870 <span class="comment">         * space.</span>
01871 <span class="comment">         */</span>
01872         <span class="keywordflow">if</span> (!fTimeOut &amp;&amp; cbOutput) {
01873             <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbOutput;
01874             <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> len;
01875 
01876             <span class="comment">/*</span>
01877 <span class="comment">             * Probe output buffer if it is in the user's address space</span>
01878 <span class="comment">             */</span>
01879 
01880             pbOutput = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lParamSave;
01881             <span class="keywordflow">try</span> {
01882                 <span class="keywordflow">if</span>(fString == <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a4">NoString</a>) {
01883                     RtlCopyMemory((PBYTE)pbOutput, psms-&gt;pvCapture,
01884                             cbOutput);
01885                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fString == <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a5">IsAnsiString</a>) {
01886                     len = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a4">strncpycch</a>((LPSTR)pbOutput,(LPCSTR)psms-&gt;pvCapture,
01887                             cbOutput);
01888 <span class="preprocessor">                    #if DBG</span>
01889 <span class="preprocessor"></span>                     len--; <span class="comment">//Length includes terminating NULL char</span>
01890                      <span class="keywordflow">if</span>(len != psms-&gt;lRet) {
01891                         RIPMSG0(RIP_WARNING,
01892                             <span class="stringliteral">"Length of the copied string being returned is diffrent from the actual string length"</span>);
01893                      }
01894 <span class="preprocessor">                    #endif</span>
01895 <span class="preprocessor"></span>                } <span class="keywordflow">else</span>  { <span class="comment">//IsUnicodeString</span>
01896                     len = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>((LPWSTR)pbOutput,(LPCWSTR)psms-&gt;pvCapture,
01897                             cbOutput/<span class="keyword">sizeof</span>(WCHAR));
01898 <span class="preprocessor">                    #if DBG</span>
01899 <span class="preprocessor"></span>                    len--;
01900                      <span class="keywordflow">if</span>(len != psms-&gt;lRet) {
01901                         RIPMSG0(RIP_WARNING,
01902                             <span class="stringliteral">"Length of the copied string being returned is diffrent from the actual string length"</span>);
01903                      }
01904 <span class="preprocessor">                    #endif</span>
01905 <span class="preprocessor"></span>                }
01906             } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
01907 
01908                 <span class="comment">/*</span>
01909 <span class="comment">                 * Return 0 to indicate an error.</span>
01910 <span class="comment">                 */</span>
01911                 psms-&gt;lRet = 0;
01912             }
01913         }
01914 
01915         <span class="comment">/*</span>
01916 <span class="comment">         * we now have the reply -- restore psmsSent and save the return value</span>
01917 <span class="comment">         */</span>
01918         ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o11">psmsSent</a> = psmsSentSave;
01919 
01920         <span class="keywordflow">if</span> (pism == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01921             lRet = psms-&gt;lRet;
01922         } <span class="keywordflow">else</span> {
01923             <span class="comment">/*</span>
01924 <span class="comment">             * save the values off for a SendMesssageTimeOut</span>
01925 <span class="comment">             */</span>
01926             *pism-&gt;<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o6">lpdwResult</a> = psms-&gt;lRet;
01927             lRet = (!fTimeOut) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">/* do this to ensure ret is T or F... */</span>
01928 
01929             <span class="comment">/*</span>
01930 <span class="comment">             * If we did timeout and no reply was received, rely on</span>
01931 <span class="comment">             * the receiver to free the sms.</span>
01932 <span class="comment">             */</span>
01933             <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>))
01934                 psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a> | <a class="code" href="../../d4/d1/userk_8h.html#a427">SMF_RECEIVERFREE</a>;
01935         }
01936 
01937         <span class="comment">/*</span>
01938 <span class="comment">         * If the reply came while the receiver is still processing</span>
01939 <span class="comment">         * the sms, force the receiver to free the sms.  This can occur</span>
01940 <span class="comment">         * via timeout, ReplyMessage or journal cancel.</span>
01941 <span class="comment">         */</span>
01942         <span class="keywordflow">if</span> ((psms-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a435">SMF_RECEIVERBUSY</a> | <a class="code" href="../../d4/d1/userk_8h.html#a428">SMF_RECEIVEDMESSAGE</a>)) !=
01943                 <a class="code" href="../../d4/d1/userk_8h.html#a428">SMF_RECEIVEDMESSAGE</a>) {
01944             psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a427">SMF_RECEIVERFREE</a>;
01945         }
01946 
01947         <span class="comment">/*</span>
01948 <span class="comment">         * Unlink the SMS structure from both the SendMsg chain and gpsmsList</span>
         * list and free it.  This sms could be anywhere in the chain.</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="kernel/sendmsg.c::xxxProcessAsyncSendMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxProcessAsyncSendMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d8/structtagASYNCSENDMSG.html">PASYNCSENDMSG</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pmsg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02891">2891</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>.
<p>
<pre class="fragment"><div>02900          :
02901 * 05-12-94 JimA         Created.
02902 \***************************************************************************/
02903 
02904 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1216">xxxProcessAsyncSendMessage</a>(
02905     <a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html">PASYNCSENDMSG</a> pmsg)
02906 {
02907     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02908     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
02909     WCHAR awchString[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
02910     ATOM Atom = 0;
02911     <a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">LARGE_UNICODE_STRING</a> str;
02912 
02913     pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o3">hwnd</a>);
02914     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02915         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwndT);
02916         <span class="keywordflow">switch</span> (pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o2">message</a>) {
02917         <span class="keywordflow">case</span> WM_WININICHANGE:
02918         <span class="keywordflow">case</span> WM_DEVMODECHANGE:
02919             <span class="keywordflow">if</span> (pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o1">lParam</a>) {
02920                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1300">UserGetAtomName</a>((ATOM)pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o1">lParam</a>, awchString, <span class="keyword">sizeof</span>(awchString))) {
02921                     Atom = (ATOM)pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o1">lParam</a>;
02922                     <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>(&amp;str, awchString, (UINT)-1);
02923                     pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o1">lParam</a> = (LPARAM)&amp;str;
02924                 } <span class="keywordflow">else</span> {
02925                     UserAssert(FALSE);
                    pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o1">lParam</a> = 0;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="kernel/sendmsg.c::xxxReceiveMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxReceiveMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ptiReceiver</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01964">1964</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02251">CallClientProcA</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03039">tagCLIENTTHREADINFO::CTIF_flags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03048">CTIF_INSENDMESSAGE</a>, <a class="el" href="../../d7/d8/taskman_8c-source.html#l00594">DirectedScheduleTask()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03747">tagINTERSENDMSGEX::dwData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03040">tagCLIENTTHREADINFO::fsChangeBits</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03041">tagCLIENTTHREADINFO::fsWakeBits</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03744">tagINTERSENDMSGEX::fuCall</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02077">tagHOOK::iHook</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l01266">IsHooked</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03755">ISM_CALLBACK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03759">ISM_CB_CLIENT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03758">ISM_REPLY</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03783">tagHOOKMSGSTRUCT::lParam</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03746">tagINTERSENDMSGEX::lpResultCallBack</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03695">_CWPRETSTRUCTEX::lResult</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03748">tagINTERSENDMSGEX::lRet</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03782">tagHOOKMSGSTRUCT::nCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03325">tagTHREADINFO::pcti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03781">tagHOOKMSGSTRUCT::phk</a>, <a class="el" href="../../d4/d1/userk_8h.html#a899">PHOOKMSGSTRUCT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03297">PSMS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03336">tagTHREADINFO::psmsCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03337">tagTHREADINFO::psmsReceiveList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03691">_CWPSTRUCTEX::psmsSender</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03697">_CWPRETSTRUCTEX::psmsSender</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03335">tagTHREADINFO::psmsSent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00155">SET_FLAG</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00186">SET_OR_CLEAR_FLAG</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04578">SetWakeBit()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03734">SMF_CB_CLIENT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03733">SMF_CB_REPLY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03732">SMF_CB_REQUEST</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03731">SMF_RECEIVEDMESSAGE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03738">SMF_RECEIVERBUSY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03728">SMF_RECEIVERDIED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03730">SMF_RECEIVERFREE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03727">SMF_REPLY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03729">SMF_SENDERDIED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02770">UnlinkSendListSms()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02285">WFSERVERSIDEPROC</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02035">WHF_CALLWNDPROC</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02036">WHF_CALLWNDPROCRET</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00705">XXXSENDMESSAGETOCLIENT</a>, and <a class="el" href="../../d7/d8/taskman_8c-source.html#l00252">xxxSleepTask()</a>.
<p>
<pre class="fragment"><div>01971          :
01972 * 01-13-91 DavidPe      Ported.
01973 * 01-23-91 DavidPe      Add <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>() support.
01974 * 07-14-92 ChrisBl      Added xxxSendMessageCallback support.
01975 \***********************************************************************/
01976 
01977 VOID xxxReceiveMessage(
01978     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiReceiver)
01979 {
01980     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psms;
01981     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psmsCurrentSave;
01982     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiSender;
01983     LRESULT lRet = 0;
01984     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01985 
01986     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01987 
01988     <span class="comment">/*</span>
01989 <span class="comment">     * Get the SMS and unlink it from the list of SMSs we've received</span>
01990 <span class="comment">     */</span>
01991     psms = ptiReceiver-&gt;psmsReceiveList;
01992 
01993     <span class="comment">/*</span>
01994 <span class="comment">     * This can be NULL because an SMS can be removed in our cleanup</span>
01995 <span class="comment">     * code without clearing the QS_SENDMESSAGE bit.</span>
01996 <span class="comment">     */</span>
01997     <span class="keywordflow">if</span> (psms == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01998         ptiReceiver-&gt;pcti-&gt;fsWakeBits &amp;= ~QS_SENDMESSAGE;
01999         ptiReceiver-&gt;pcti-&gt;fsChangeBits &amp;= ~QS_SENDMESSAGE;
02000         <span class="keywordflow">return</span>;
02001     }
02002 
02003     ptiReceiver-&gt;psmsReceiveList = psms-&gt;psmsReceiveNext;
02004     psms-&gt;psmsReceiveNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02005 
02006     <span class="comment">/*</span>
02007 <span class="comment">     * We've taken the SMS off the receive list - mark the SMS with this</span>
02008 <span class="comment">     * information - used during cleanup.</span>
02009 <span class="comment">     */</span>
02010     psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a435">SMF_RECEIVERBUSY</a> | <a class="code" href="../../d4/d1/userk_8h.html#a428">SMF_RECEIVEDMESSAGE</a>;
02011 
02012     <span class="comment">/*</span>
02013 <span class="comment">     * Clear QS_SENDMESSAGE wakebit if list is now empty</span>
02014 <span class="comment">     */</span>
02015     <span class="keywordflow">if</span> (ptiReceiver-&gt;psmsReceiveList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02016         ptiReceiver-&gt;pcti-&gt;fsWakeBits &amp;= ~QS_SENDMESSAGE;
02017         ptiReceiver-&gt;pcti-&gt;fsChangeBits &amp;= ~QS_SENDMESSAGE;
02018     }
02019 
02020     ptiSender = psms-&gt;ptiSender;
02021 
02022     <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a430">SMF_CB_REPLY</a>) {
02023         <span class="comment">/*</span>
02024 <span class="comment">         * From SendMessageCallback REPLY to callback.  We need to call</span>
02025 <span class="comment">         * the call back function to give the return value.</span>
02026 <span class="comment">         * Don't process any this message, just mechanism for notification</span>
02027 <span class="comment">         * the sender's thread lock is already gone, so we need to re-lock here.</span>
02028 <span class="comment">         */</span>
02029         <span class="keywordflow">if</span> (ptiSender == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02030             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(psms-&gt;spwnd, &amp;tlpwnd);
02031         }
02032 
02033         <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a431">SMF_CB_CLIENT</a>) {
02034             <span class="comment">/*</span>
02035 <span class="comment">             * Application-defined callback proc is neither Unicode nor ANSI</span>
02036 <span class="comment">             */</span>
02037             <a class="code" href="../../d4/d1/userk_8h.html#a242">CallClientProcA</a>(psms-&gt;spwnd, psms-&gt;message, psms-&gt;dwData,
02038                     psms-&gt;lRet, (ULONG_PTR)psms-&gt;lpResultCallBack);
02039         } <span class="keywordflow">else</span> {
02040             psms-&gt;lpResultCallBack(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(psms-&gt;spwnd), psms-&gt;message,
02041                     psms-&gt;dwData, psms-&gt;lRet);
02042         }
02043 
02044         <span class="keywordflow">if</span> (ptiSender == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02045             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02046         }
02047     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a> | <a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a425">SMF_RECEIVERDIED</a>))) {
02048         <span class="comment">/*</span>
02049 <span class="comment">         * Don't process message if it has been replied to already or</span>
02050 <span class="comment">         * if the sending or receiving thread has died</span>
02051 <span class="comment">         */</span>
02052 
02053         <span class="comment">/*</span>
02054 <span class="comment">         * Set new psmsCurrent for this queue, saving the current one</span>
02055 <span class="comment">         */</span>
02056         psmsCurrentSave = ptiReceiver-&gt;psmsCurrent;
02057         ptiReceiver-&gt;psmsCurrent = psms;
02058         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a11">SET_FLAG</a>(ptiReceiver-&gt;pcti-&gt;CTIF_flags, CTIF_INSENDMESSAGE);
02059 
02060         <span class="comment">/*</span>
02061 <span class="comment">         * If this SMS originated from a xxxSendNotifyMessage() or a</span>
02062 <span class="comment">         * xxxSendMessageCallback() call, the sender's thread lock is</span>
02063 <span class="comment">         * already gone, so we need to re-lock here.</span>
02064 <span class="comment">         */</span>
02065         <span class="keywordflow">if</span> (ptiSender == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02066             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(psms-&gt;spwnd, &amp;tlpwnd);
02067         }
02068 
02069         <span class="keywordflow">if</span> (psms-&gt;message == WM_HOOKMSG) {
02070             <span class="keyword">union </span>{
02071                 EVENTMSG emsg;          <span class="comment">// WH_JOURNALRECORD/PLAYBACK</span>
02072                 MOUSEHOOKSTRUCTEX mhs;  <span class="comment">// WH_MOUSE</span>
02073                 KBDLLHOOKSTRUCT   kbds; <span class="comment">// WH_KEYBORD_LL</span>
02074                 MSLLHOOKSTRUCT    mslls;<span class="comment">// WH_MOUSE_LL</span>
02075 <span class="preprocessor">#ifdef REDIRECTION</span>
02076 <span class="preprocessor"></span>                HTHOOKSTRUCT      ht;   <span class="comment">// WH_HITTEST</span>
02077 <span class="preprocessor">#endif // REDIRECTION</span>
02078 <span class="preprocessor"></span>            } LocalData;
02079             PVOID pSendersData;
02080             <a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html">PHOOKMSGSTRUCT</a> phkmp;
02081             <span class="keywordtype">int</span> iHook;
02082             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
02083 
02084             <span class="comment">/*</span>
02085 <span class="comment">             * Some hook types (eg: WH_JOURNALPLAYBACK) pass pointers to</span>
02086 <span class="comment">             * data in the calling thread's stack.  We must copy this to our</span>
02087 <span class="comment">             * own (called thread's) stack for safety because of the way this</span>
02088 <span class="comment">             * "message" is handled and in case the calling thread dies. #13577</span>
02089 <span class="comment">             *</span>
02090 <span class="comment">             * Originally only WH_JOURNALRECORD and WH_JOURNALPLAYBACK went</span>
02091 <span class="comment">             * through this code, but now all sorts of hooks do.</span>
02092 <span class="comment">             */</span>
02093             phkmp = (<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html">PHOOKMSGSTRUCT</a>)psms-&gt;<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o2">lParam</a>;
02094             pSendersData = (PVOID)(phkmp-&gt;<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o2">lParam</a>);
02095             iHook = phkmp-&gt;<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o0">phk</a>-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>;
02096 
02097             <span class="keywordflow">switch</span> (iHook) {
02098             <span class="keywordflow">case</span> WH_JOURNALRECORD:
02099             <span class="keywordflow">case</span> WH_JOURNALPLAYBACK:
02100                 <span class="keywordflow">if</span> (pSendersData)
02101                     LocalData.emsg = *(PEVENTMSG)pSendersData;
02102                 <span class="keywordflow">break</span>;
02103 
02104             <span class="keywordflow">case</span> WH_MOUSE:
02105                 <span class="keywordflow">if</span> (pSendersData)
02106                     LocalData.mhs = *(LPMOUSEHOOKSTRUCTEX)pSendersData;
02107                 <span class="keywordflow">break</span>;
02108 
02109             <span class="keywordflow">case</span> WH_KEYBOARD_LL:
02110                 <span class="keywordflow">if</span> (pSendersData)
02111                     LocalData.kbds = *(LPKBDLLHOOKSTRUCT)pSendersData;
02112                 <span class="keywordflow">break</span>;
02113 
02114             <span class="keywordflow">case</span> WH_MOUSE_LL:
02115                 <span class="keywordflow">if</span> (pSendersData)
02116                     LocalData.mslls = *(LPMSLLHOOKSTRUCT)pSendersData;
02117                 <span class="keywordflow">break</span>;
02118 
02119 <span class="preprocessor">#ifdef REDIRECTION</span>
02120 <span class="preprocessor"></span>            <span class="keywordflow">case</span> WH_HITTEST:
02121                 <span class="keywordflow">if</span> (pSendersData)
02122                     LocalData.ht = *(LPHTHOOKSTRUCT)pSendersData;
02123                 <span class="keywordflow">break</span>;
02124 <span class="preprocessor">#endif // REDIRECTION</span>
02125 <span class="preprocessor"></span>
02126             <span class="keywordflow">case</span> WH_KEYBOARD:
02127             <span class="keywordflow">case</span> WH_SHELL:
02128                 <span class="comment">/*</span>
02129 <span class="comment">                 * Fall thru...</span>
02130 <span class="comment">                 */</span>
02131                 pSendersData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02132                 <span class="keywordflow">break</span>;
02133 
02134             <span class="keywordflow">default</span>:
02135                 <span class="comment">/*</span>
02136 <span class="comment">                 * No pointers: wParam &amp; lParam can be sent as is.</span>
02137 <span class="comment">                 */</span>
02138                 RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Receive hook %d"</span>, iHook);
02139                 pSendersData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02140                 <span class="keywordflow">break</span>;
02141             }
02142 
02143 
02144             lRet = <a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(phkmp-&gt;<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o0">phk</a>, phkmp-&gt;<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o1">nCode</a>, psms-&gt;wParam,
02145                     pSendersData ? (LPARAM)&amp;LocalData : phkmp-&gt;<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o2">lParam</a>, &amp;bAnsiHook);
02146 
02147             <span class="comment">/*</span>
02148 <span class="comment">             * Copy back data only if the sender hasn't died or timed out</span>
02149 <span class="comment">             * (timed out messages are marked SMF_REPLY by the sending thread)</span>
02150 <span class="comment">             */</span>
02151             <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a>|<a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>)) &amp;&amp; pSendersData) {
02152                 <span class="keywordflow">switch</span> (iHook) {
02153                 <span class="keywordflow">case</span> WH_JOURNALRECORD:
02154                 <span class="keywordflow">case</span> WH_JOURNALPLAYBACK:
02155                     *(PEVENTMSG)pSendersData = LocalData.emsg;
02156                     <span class="keywordflow">break</span>;
02157 
02158                 <span class="keywordflow">case</span> WH_KEYBOARD_LL:
02159                     *(LPKBDLLHOOKSTRUCT)pSendersData = LocalData.kbds;
02160                     <span class="keywordflow">break</span>;
02161 
02162                 <span class="keywordflow">case</span> WH_MOUSE_LL:
02163                     *(LPMSLLHOOKSTRUCT)pSendersData = LocalData.mslls;
02164                     <span class="keywordflow">break</span>;
02165 
02166                 <span class="keywordflow">case</span> WH_MOUSE:
02167                     *(LPMOUSEHOOKSTRUCTEX)pSendersData = LocalData.mhs;
02168                     <span class="keywordflow">break</span>;
02169 
02170 <span class="preprocessor">#ifdef REDIRECTION</span>
02171 <span class="preprocessor"></span>                <span class="keywordflow">case</span> WH_HITTEST:
02172                     *(LPHTHOOKSTRUCT)pSendersData = LocalData.ht;
02173                     <span class="keywordflow">break</span>;
02174 <span class="preprocessor">#endif // REDIRECTION</span>
02175 <span class="preprocessor"></span>                }
02176             }
02177 
02178         } <span class="keywordflow">else</span> {
02179             <span class="comment">/*</span>
02180 <span class="comment">             * Call WH_CALLWNDPROC if it's installed and the window is not marked</span>
02181 <span class="comment">             * as destroyed.</span>
02182 <span class="comment">             */</span>
02183             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiReceiver, WHF_CALLWNDPROC)) {
02184                 <a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html">CWPSTRUCTEX</a> cwps;
02185 
02186                 cwps.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(psms-&gt;spwnd);
02187                 cwps.message = psms-&gt;message;
02188                 cwps.wParam = psms-&gt;wParam;
02189                 cwps.lParam = psms-&gt;lParam;
02190                 cwps.<a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html#o0">psmsSender</a> = psms;
02191 
02192                 <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, TRUE, (LPARAM)&amp;cwps, WH_CALLWNDPROC);
02193 
02194                 <span class="comment">/*</span>
02195 <span class="comment">                 * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
02196 <span class="comment">                 * to the CWPSTRUCT contents.  If this behavior reverts to</span>
02197 <span class="comment">                 * Win3.1 semantics, we will need to copy the new parameters</span>
02198 <span class="comment">                 * from cwps.</span>
02199 <span class="comment">                 */</span>
02200             }
02201 
02202             <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a> | <a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a425">SMF_RECEIVERDIED</a>)) &amp;&amp;
02203                     psms-&gt;spwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02204                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(psms-&gt;spwnd, WFSERVERSIDEPROC)) {
02205                     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndKernel;
02206 
02207                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(psms-&gt;spwnd, &amp;tlpwndKernel);
02208                     <span class="comment">/*</span>
02209 <span class="comment">                     * If this window's proc is meant to be executed from the server side</span>
02210 <span class="comment">                     * we'll just stay inside the semaphore and call it directly.  Note</span>
02211 <span class="comment">                     * how we don't convert the pwnd into an hwnd before calling the proc.</span>
02212 <span class="comment">                     */</span>
02213                     lRet = psms-&gt;spwnd-&gt;lpfnWndProc(psms-&gt;spwnd, psms-&gt;message,
02214                             psms-&gt;wParam, psms-&gt;lParam);
02215 
02216                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndKernel);
02217                 } <span class="keywordflow">else</span> {
02218                     <span class="comment">/*</span>
02219 <span class="comment">                     * Call the client or xxxDefWindowProc.</span>
02220 <span class="comment">                     */</span>
02221                     <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a3">XXXSENDMESSAGETOCLIENT</a>(psms-&gt;spwnd, psms-&gt;message, psms-&gt;wParam, psms-&gt;lParam,
02222                                         psms, TRUE);
02223                 }
02224 
02225                 <span class="comment">/*</span>
02226 <span class="comment">                 * Call WH_CALLWNDPROCRET if it's installed.</span>
02227 <span class="comment">                 */</span>
02228                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiReceiver, WHF_CALLWNDPROCRET) &amp;&amp;
02229                         !(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a>)) {
02230                     <a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html">CWPRETSTRUCTEX</a> cwps;
02231 
02232                     cwps.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(psms-&gt;spwnd);
02233                     cwps.message = psms-&gt;message;
02234                     cwps.wParam = psms-&gt;wParam;
02235                     cwps.lParam = psms-&gt;lParam;
02236                     cwps.<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o0">lResult</a> = lRet;
02237                     cwps.<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o1">psmsSender</a> = psms;
02238 
02239                     <span class="comment">/*</span>
02240 <span class="comment">                     * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
02241 <span class="comment">                     * to the CWPSTRUCT contents.</span>
02242 <span class="comment">                     */</span>
02243                     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, TRUE, (LPARAM)&amp;cwps, WH_CALLWNDPROCRET);
02244 
02245                     <span class="comment">/*</span>
02246 <span class="comment">                     * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
02247 <span class="comment">                     * to the CWPSTRUCT contents.  If this behavior reverts to</span>
02248 <span class="comment">                     * Win3.1 semantics, we will need to copy the new parameters</span>
02249 <span class="comment">                     * from cwps.</span>
02250 <span class="comment">                     */</span>
02251                 }
02252             }
02253         }
02254 
02255         <span class="keywordflow">if</span> ((psms-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a429">SMF_CB_REQUEST</a> | <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>)) == <a class="code" href="../../d4/d1/userk_8h.html#a429">SMF_CB_REQUEST</a>) {
02256 
02257             <span class="comment">/*</span>
02258 <span class="comment">             * From SendMessageCallback REQUEST callback.  Send the message</span>
02259 <span class="comment">             * back with a the REPLY value.</span>
02260 <span class="comment">             */</span>
02261             <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">INTRSENDMSGEX</a> ism;
02262 
02263             psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
02264 
02265             <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a426">SMF_SENDERDIED</a>)) {
02266                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> = <a class="code" href="../../d4/d1/userk_8h.html#a436">ISM_CALLBACK</a> | <a class="code" href="../../d4/d1/userk_8h.html#a439">ISM_REPLY</a>;
02267                 <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a431">SMF_CB_CLIENT</a>)
02268                     ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a440">ISM_CB_CLIENT</a>;
02269                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o1">lpResultCallBack</a> = psms-&gt;lpResultCallBack;
02270                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o2">dwData</a> = psms-&gt;dwData;
02271                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o3">lRet</a> = lRet;
02272 
02273                 <a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(psms-&gt;spwnd, psms-&gt;message, 0L, 0L,
02274                         NULL, psms-&gt;ptiCallBackSender, &amp;ism );
02275             }
02276         }
02277 
02278         <span class="keywordflow">if</span> (ptiSender == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02279             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02280         }
02281 
02282         <span class="comment">/*</span>
02283 <span class="comment">         * Restore receiver's original psmsCurrent.</span>
02284 <span class="comment">         */</span>
02285         ptiReceiver-&gt;psmsCurrent = psmsCurrentSave;
02286         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(ptiReceiver-&gt;pcti-&gt;CTIF_flags,
02287                           CTIF_INSENDMESSAGE,
02288                           ptiReceiver-&gt;psmsCurrent);
02289 
02290 <span class="preprocessor">#ifdef DEBUG_SMS</span>
02291 <span class="preprocessor"></span>        ValidateSmsSendLists(psmsCurrentSave);
02292 <span class="preprocessor">#endif</span>
02293 <span class="preprocessor"></span>    }
02294 
02295     <span class="comment">/*</span>
02296 <span class="comment">     * We're done with this sms, so the appropriate thread</span>
02297 <span class="comment">     * can now free it.</span>
02298 <span class="comment">     */</span>
02299     psms-&gt;flags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a435">SMF_RECEIVERBUSY</a>;
02300 
02301     <span class="comment">/*</span>
02302 <span class="comment">     * Free the sms and return without reply if the</span>
02303 <span class="comment">     * SMF_RECEIVERFREE bit is set.  Handily, this does just what we</span>
02304 <span class="comment">     * want for xxxSendNotifyMessage() since we set SMF_RECEIVERFREE</span>
02305 <span class="comment">     * in that case.</span>
02306 <span class="comment">     */</span>
02307     <span class="keywordflow">if</span> (psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a427">SMF_RECEIVERFREE</a>) {
02308         <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a8">UnlinkSendListSms</a>(psms, NULL);
02309         <span class="keywordflow">return</span>;
02310     }
02311 
02312     <span class="comment">/*</span>
02313 <span class="comment">     * Set reply flag and return value if this message has not already</span>
02314 <span class="comment">     * been replied to with ReplyMessage().</span>
02315 <span class="comment">     */</span>
02316     <span class="keywordflow">if</span> (!(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>)) {
02317         psms-&gt;lRet = lRet;
02318         psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>;
02319 
02320         <span class="comment">/*</span>
02321 <span class="comment">         * Tell the sender, the reply is done</span>
02322 <span class="comment">         */</span>
02323         <span class="keywordflow">if</span> (ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02324             <span class="comment">/*</span>
02325 <span class="comment">             * Wake up the sender thread.</span>
02326 <span class="comment">             */</span>
02327             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiSender, QS_SMSREPLY);
02328 
02329             <span class="comment">/*</span>
02330 <span class="comment">             * We have 4 conditions to satisfy:</span>
02331 <span class="comment">             *</span>
02332 <span class="comment">             * 16 - 16 : yielding required, if sender is waiting for this reply</span>
02333 <span class="comment">             * 32 - 16 : yielding required, if sender is waiting for this reply</span>
02334 <span class="comment">             * 16 - 32 : no yielding required</span>
02335 <span class="comment">             * 32 - 32 : No yielding required.</span>
02336 <span class="comment">             */</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="kernel/sendmsg.c::xxxSendBSMtoDesktop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxSendBSMtoDesktop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndDesk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d0/inc_2user_8h.html#a956">LPBROADCASTSYSTEMMSGPARAMS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pbsmParams</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00315">315</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00981">_PostMessage()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d6/enumwin_8c-source.html#l00091">BuildHwndList()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03634">BWL_ENUMLIST</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01056">CanForceForeground()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03508">CMSWAITTOKILLTIMEOUT</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00098">fBroadcastProc</a>, <a class="el" href="../../d5/d6/enumwin_8c-source.html#l00417">FreeHwndList()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01548">GETPDESK</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05857">GetTaskName()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00198">glinp</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00456">grpdeskRitInput</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a987">LPBROADCASTSYSTEMMSGPARAMS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03262">tagLASTINPUT::ptiLastWoken</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00969">QueueNotifyMessage()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00194">RevalidateHwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03624">tagBWL::rghwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00365">ThreadLockAlwaysWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02829">TIF_CSRSSTHREAD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00292">UserLogError()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02319">WFWIN40COMPAT</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01069">xxxSendNotifyMessage()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00466">xxxSendMessageBSM()</a>.
<p>
<pre class="fragment"><div>00321 {
00322     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
00323     HWND *phwnd;
00324     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00325     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00326     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00328     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPrivateMessage = (message &gt;= WM_USER) &amp;&amp; (message &lt; MAXINTATOM);
00329 
00330 
00331     <span class="keywordflow">if</span> (fPrivateMessage) {
00332         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Attempt to broadcast a private message"</span>);
00333     }
00334 
00335     pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pwndDesk-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, BWL_ENUMLIST, NULL);
00336 
00337     <span class="keywordflow">if</span> (pbwl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00338         <span class="keywordflow">return</span> 0;
00339 
00340     <span class="keywordflow">if</span> (!(pbsmParams-&gt;dwFlags &amp; BSF_POSTMESSAGE)) {
00341         <span class="comment">/*</span>
00342 <span class="comment">         * Does the caller want to allow the receivers to take the foreground</span>
00343 <span class="comment">         *  while processing the notification?</span>
00344 <span class="comment">         */</span>
00345         <span class="comment">/*</span>
00346 <span class="comment">         * Bug 412159. In order to allow the AppsHelp window to come to the</span>
00347 <span class="comment">         * foreground we set ptiLastWoken to NULL, which will allow any window</span>
00348 <span class="comment">         * to come to the foreground after a CD's been inserted.</span>
00349 <span class="comment">         */</span>
00350         <span class="keywordflow">if</span>((pbsmParams-&gt;dwFlags &amp; BSF_ALLOWSFW) &amp;&amp;
00351            (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a456">GETPDESK</a>(pwndDesk) == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) &amp;&amp;
00352            ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)
00353             || <a class="code" href="../../d4/d1/userk_8h.html#a1663">CanForceForeground</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>))) {
00354              <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00355          }
00356 
00357     }
00358 
00359     <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
00360 
00361         <span class="comment">/*</span>
00362 <span class="comment">         * Make sure this hwnd is still around.</span>
00363 <span class="comment">         */</span>
00364         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00365             <span class="keywordflow">continue</span>;
00366 
00367         <span class="keywordflow">if</span> (pbsmParams-&gt;dwFlags &amp;  BSF_IGNORECURRENTTASK) {
00368         <span class="comment">// Don't deal with windows in the current task.</span>
00369             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)
00370                 <span class="keywordflow">continue</span>;
00371         }
00372 
00373 
00374         <span class="comment">/*</span>
00375 <span class="comment">         * Make sure this window can handle broadcast messages</span>
00376 <span class="comment">         */</span>
00377 
00378         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a2">fBroadcastProc</a>(pwnd)) {
00379             <span class="keywordflow">continue</span>;
00380         }
00381 
00382         <span class="keywordflow">if</span> (fPrivateMessage &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFWIN40COMPAT)) { <span class="comment">// Don't broadcast</span>
00383             <span class="keywordflow">continue</span>;                                         <span class="comment">// private message</span>
00384         }                                                     <span class="comment">// to 4.0 apps.</span>
00385 
00386         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
00387 
00388         <span class="comment">// Now, send message; This could be a query; so, remember the return value.</span>
00389         <span class="keywordflow">if</span> (pbsmParams-&gt;dwFlags &amp; BSF_POSTMESSAGE) {
00390             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, message, wParam, lParam);
00391         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pbsmParams-&gt;dwFlags &amp; BSF_SENDNOTIFYMESSAGE) {
00392             <span class="comment">/*</span>
00393 <span class="comment">             * We don't want to wait for an answer, but we don't want to use</span>
00394 <span class="comment">             * PostMessage either. This is useful if you need to maintain the</span>
00395 <span class="comment">             * order in which messages are delivered, but you only want to</span>
00396 <span class="comment">             * wait for some of them. See WM_POWERBROADCAST for an example.</span>
00397 <span class="comment">             */</span>
00398             <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(pwnd, message, wParam, lParam);
00399         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pbsmParams-&gt;dwFlags &amp; BSF_QUEUENOTIFYMESSAGE) {
00400             <span class="comment">/*</span>
00401 <span class="comment">             * We don't want to wait for an answer, but we don't want to use</span>
00402 <span class="comment">             * PostMessage either. This is useful if you need to maintain the</span>
00403 <span class="comment">             * order in which messages are delivered, but you only want to</span>
00404 <span class="comment">             * wait for some of them. See WM_POWERBROADCAST for an example.</span>
00405 <span class="comment">             */</span>
00406             <a class="code" href="../../d4/d1/userk_8h.html#a1582">QueueNotifyMessage</a>(pwnd, message, wParam, lParam);
00407         } <span class="keywordflow">else</span> {
00408             <span class="comment">/*</span>
00409 <span class="comment">             * pbsmParams-&gt;dwFlags can be changed while we loop here</span>
00410 <span class="comment">             *  so we need to check it in every iteration.</span>
00411 <span class="comment">             */</span>
00412             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNoHang = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)pbsmParams-&gt;dwFlags &amp; BSF_NOHANG;
00413             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fForce = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)pbsmParams-&gt;dwFlags &amp; BSF_FORCEIFHUNG;
00414             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTimeout;
00415             ULONG_PTR dwResult = 0;
00416 
00417             <span class="keywordflow">if</span> (fNoHang)
00418                 dwTimeout = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a914">CMSWAITTOKILLTIMEOUT</a>;
00419             <span class="keywordflow">else</span>
00420                 dwTimeout = 0;
00421 
00422             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwnd, message, wParam, lParam,
00423                 (fNoHang ? SMTO_ABORTIFHUNG : SMTO_NORMAL) |
00424                 ((pbsmParams-&gt;dwFlags &amp; BSF_NOTIMEOUTIFNOTHUNG) ? SMTO_NOTIMEOUTIFNOTHUNG : 0),
00425                 dwTimeout, &amp;dwResult)) {
00426 
00427                 <span class="keywordflow">if</span> (pbsmParams-&gt;dwFlags &amp; BSF_QUERY) {
00428                     <span class="comment">// For old messages, returning 0 means a deny</span>
00429                     <span class="keywordflow">if</span>(message == WM_QUERYENDSESSION)
00430                         fReturnValue = (dwResult != 0);
00431                     <span class="keywordflow">else</span>
00432                     <span class="comment">// For all new messages, returning BROADCAST_QUERY_DENY is</span>
00433                     <span class="comment">// the way to deny a query.</span>
00434                         fReturnValue = (dwResult != BROADCAST_QUERY_DENY);
00435                 }
00436             } <span class="keywordflow">else</span> {
00437                 fReturnValue = fForce;
00438             }
00439 
00440             <span class="comment">/*</span>
00441 <span class="comment">             * If our query was denied, return immediately.</span>
00442 <span class="comment">             */</span>
00443             <span class="keywordflow">if</span> (fReturnValue == 0) {
00444                 <span class="keywordflow">if</span> (message == WM_POWERBROADCAST &amp;&amp; wParam == PBT_APMQUERYSUSPEND) {
00445                     WCHAR wchTask[40];
00446                     ULONG cbTask;
00447 
00448                     <span class="comment">/*</span>
00449 <span class="comment">                     * Get the application name and log an error.</span>
00450 <span class="comment">                     */</span>
00451                     cbTask = <a class="code" href="../../d4/d1/userk_8h.html#a1825">GetTaskName</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), wchTask, <span class="keyword">sizeof</span>(wchTask));
00452                     <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a18">UserLogError</a>(wchTask, cbTask, WARNING_POWER_QUERYSUSPEND_CANCELLED);
00453                 }
00454                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00455                 <span class="keywordflow">break</span>;
00456             }
00457         }
00458         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00459     }
00460 
00461     <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00462 
00463     <span class="keywordflow">return</span> fReturnValue;
00464 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="kernel/sendmsg.c::xxxSendMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT xxxSendMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">688</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l00336">xxxActivateApp()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02327">xxxActiveWindowTracking()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l00821">xxxCalcValidRects()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02618">xxxChangeClipboardChain()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02375">xxxCheckImeShowStatus()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00428">xxxClientShutdown2()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l00033">xxxCreateWindowEx()</a>, <a class="el" href="../../d2/d7/w32_2ntuser_2kernel_2event_8c-source.html#l00120">xxxCsEvent()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00034">xxxDeactivate()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00883">xxxDesktopWndProc()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l01591">xxxDestroyWindow()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l01549">xxxDoScroll()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00232">xxxDoSend()</a>, <a class="el" href="../../d7/d0/dragdrop_8c-source.html#l00026">xxxDragObject()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00220">xxxDrawClipboard()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02053">xxxDW_SendDestroyMessages()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l00601">xxxDWP_NCMouse()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l00228">xxxDWP_ProcessVirtKey()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l00402">xxxDWP_SetCursor()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l00846">xxxDWPPrint()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l00392">xxxEnableScrollBar()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00184">xxxEnableWindow()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00027">xxxFlashWindow()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00405">xxxFocusSetInputContext()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>, <a class="el" href="../../d9/d3/w32_2ntuser_2kernel_2random_8c-source.html#l00193">xxxGetControlColor()</a>, <a class="el" href="../../d7/d6/winable2_8c-source.html#l00580">xxxGetMenuBarInfo()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02303">xxxGetRenderData()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00043">xxxHandleMenuMessages()</a>, <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00023">xxxHandleNCMouseGuys()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l03381">xxxHandleWindowPosChanged()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00921">xxxImmActivateLayout()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l00032">xxxInitSendValidateMinMaxInfo()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l01203">xxxInternalActivateKeyboardLayout()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00166">xxxMakeWindowForegroundWithState()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l04022">xxxMenuWindowProc()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l00362">xxxMetricsRecalc()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03395">xxxMNCancel()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01011">xxxMNChar()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l02517">xxxMNCloseHierarchy()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l00880">xxxMNDestroyHandler()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03180">xxxMNFindWindowFromPoint()</a>, <a class="el" href="../../d5/d1/mncomput_8c-source.html#l00027">xxxMNGetBitmapSize()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l02492">xxxMNHideNextHierarchy()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01251">xxxMNKeyDown()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00635">xxxMNLoop()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03618">xxxMNMouseMove()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01934">xxxMNOpenHierarchy()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l02818">xxxMNSelectItem()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00677">xxxMNStartMenu()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00540">xxxMNStartMenuState()</a>, <a class="el" href="../../d4/d1/mnchange_8c-source.html#l01106">xxxMNUpdateShownMenu()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02444">xxxMouseActivate()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01053">xxxMoveSize()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00437">xxxMS_TrackMove()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02582">xxxSBWndProc()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l03305">xxxScanSysQueue()</a>, <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00741">xxxScrollWindowEx()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01669">xxxSendChangedMsgs()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00783">xxxSendClipboardMessage()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l01147">xxxSendEraseBkgnd()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00220">xxxSendFocusMessages()</a>, <a class="el" href="../../d3/d9/kernel_2help_8c-source.html#l00043">xxxSendHelpMessage()</a>, <a class="el" href="../../d7/d1/mndraw_8c-source.html#l00617">xxxSendMenuDrawItemMessage()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02461">xxxSendMessageToUI()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00232">xxxSendNCPaint()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02518">xxxSendOpenStatusNotify()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l01316">xxxSetScrollBar()</a>, <a class="el" href="../../d7/d6/classchg_8c-source.html#l00203">xxxSetWindowStyle()</a>, <a class="el" href="../../d1/d8/showwin_8c-source.html#l00437">xxxShowOwnedWindows()</a>, <a class="el" href="../../d1/d8/showwin_8c-source.html#l00085">xxxShowWindow()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03358">xxxSwitchDesktop()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01586">xxxSwpActivate()</a>, <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00193">xxxSysCommand()</a>, <a class="el" href="../../d2/d1/mnaccel_8c-source.html#l00145">xxxTA_AccelerateMenu()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00274">xxxTM_MoveDragRect()</a>, <a class="el" href="../../d2/d3/tooltips_8c-source.html#l00570">xxxTooltipWndProc()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00873">xxxTrackInitSize()</a>, <a class="el" href="../../d3/d2/mnpopup_8c-source.html#l00052">xxxTrackPopupMenuEx()</a>, <a class="el" href="../../d2/d1/mnaccel_8c-source.html#l00251">xxxTranslateAccelerator()</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l01121">xxxUpdateWindow2()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00481">xxxUserPowerStateCalloutWorker()</a>, and <a class="el" href="../../d0/d8/winwhere_8c-source.html#l00315">xxxWindowHitTest2()</a>.
<p>
<pre class="fragment"><div>00693 {
00694     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>( pwnd, message, wParam, lParam,
00695             SMTO_NORMAL, 0, NULL );
00696 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="kernel/sendmsg.c::xxxSendMessageBSM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG xxxSendMessageBSM           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d0/inc_2user_8h.html#a956">LPBROADCASTSYSTEMMSGPARAMS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pbsmParams</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00466">466</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00932">gbRemoteSession</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00648">grpWinStaList</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09221">IoPnPDeliverServicePowerNotification()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02712">tagWINDOWSTATION::rpdeskList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02647">tagDESKTOP::rpdeskNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02711">tagWINDOWSTATION::rpwinstaNext</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01652">ThreadLockDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01658">ThreadLockExchangeDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01674">ThreadLockExchangeWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01668">ThreadLockWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01664">ThreadUnlockDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01698">ThreadUnlockWinSta</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00315">xxxSendBSMtoDesktop()</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/power_8c-source.html#l00274">xxxUserPowerEventCalloutWorker()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00481">xxxUserPowerStateCalloutWorker()</a>, and <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l00781">xxxWrapSendMessageBSM()</a>.
<p>
<pre class="fragment"><div>00473 {
00474     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00475     LONG        lRet;
00476 
00477     <span class="keywordflow">if</span> (pbsmParams-&gt;dwRecipients &amp; BSM_ALLDESKTOPS) {
00478         <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta;
00479         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
00480         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwinsta;
00481         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpdesk;
00482 
00483         <span class="comment">/*</span>
00484 <span class="comment">         * Walk through all windowstations and desktop looking for</span>
00485 <span class="comment">         * top-level windows.</span>
00486 <span class="comment">         */</span>
00487         <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, NULL, &amp;tlpwinsta);
00488         <a class="code" href="../../d4/d1/userk_8h.html#a128">ThreadLockDesktop</a>(ptiCurrent, NULL, &amp;tlpdesk, LDLT_FN_SENDMESSAGEBSM);
00489         <span class="keywordflow">for</span> (pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>; pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
00490             <a class="code" href="../../d4/d1/userk_8h.html#a132">ThreadLockExchangeWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
00491             <span class="keywordflow">for</span> (pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
00492                 <a class="code" href="../../d4/d1/userk_8h.html#a129">ThreadLockExchangeDesktop</a>(ptiCurrent, pdesk, &amp;tlpdesk, LDLT_FN_SENDMESSAGEBSM);
00493 
00494                 lRet = <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a19">xxxSendBSMtoDesktop</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>,
00495                               message, wParam, lParam, pbsmParams);
00496 
00497                 <span class="comment">/*</span>
00498 <span class="comment">                 * If our query was denied, return immediately.</span>
00499 <span class="comment">                 */</span>
00500                 <span class="keywordflow">if</span> ((lRet == 0) &amp;&amp; (pbsmParams-&gt;dwFlags &amp; BSF_QUERY)) {
00501                     <a class="code" href="../../d4/d1/userk_8h.html#a130">ThreadUnlockDesktop</a>(ptiCurrent, &amp;tlpdesk, LDUT_FN_SENDMESSAGEBSM1);
00502                     <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
00503                     <span class="keywordflow">return</span> 0;
00504                 }
00505                 pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>;
00506             }
00507             pwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>;
00508         }
00509         <a class="code" href="../../d4/d1/userk_8h.html#a130">ThreadUnlockDesktop</a>(ptiCurrent, &amp;tlpdesk, LDUT_FN_SENDMESSAGEBSM2);
00510         <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
00511 
00512         <span class="comment">/*</span>
00513 <span class="comment">         * If this is a power broadcast, inform any service that cares.</span>
00514 <span class="comment">         */</span>
00515         <span class="keywordflow">if</span> (message == WM_POWERBROADCAST &amp;&amp; !<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00516             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00517 
00518             <span class="comment">/*</span>
00519 <span class="comment">             * If it's a query, deliver it synchronously to pickup the return code</span>
00520 <span class="comment">             */</span>
00521             <span class="keywordflow">if</span> ((wParam == PBT_APMQUERYSUSPEND) ||
00522                 (wParam == PBT_APMQUERYSTANDBY)) {
00523                 lRet = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a114">IoPnPDeliverServicePowerNotification</a>((ULONG)wParam,TRUE);
00524             }<span class="keywordflow">else</span> {
00525                 lRet = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a114">IoPnPDeliverServicePowerNotification</a>((ULONG)wParam,FALSE);
00526 
00527             }
00528             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00529         }
00530 
00531     } <span class="keywordflow">else</span> {
00532         lRet = <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a19">xxxSendBSMtoDesktop</a>(pwnd, message, wParam, lParam,
00533                     pbsmParams);
00534     }
00535 
00536     <span class="keywordflow">return</span> lRet;
00537 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="kernel/sendmsg.c::xxxSendMessageCallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxSendMessageCallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SENDASYNCPROC&nbsp;</td>
          <td class="mdname" nowrap> <em>lpResultCallBack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>dwData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fClientRequest</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01114">1114</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03792">BMSG_SENDMSGCALLBACK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03790">BMSG_SENDNOTIFYMSG</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02251">CallClientProcA</a>, <a class="el" href="../../d8/d8/uniontagBROADCASTMSG.html#o3">tagBROADCASTMSG::cb</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03747">tagINTERSENDMSGEX::dwData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03744">tagINTERSENDMSGEX::fuCall</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01515">HWq</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l01266">IsHooked</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03755">ISM_CALLBACK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03759">ISM_CB_CLIENT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01841">tagWND::lpfnWndProc</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03746">tagINTERSENDMSGEX::lpResultCallBack</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03695">_CWPRETSTRUCTEX::lResult</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03691">_CWPSTRUCTEX::psmsSender</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03697">_CWPRETSTRUCTEX::psmsSender</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03833">PWND_BROADCAST</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03526">TESTSYNCONLYMESSAGE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02285">WFSERVERSIDEPROC</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02035">WHF_CALLWNDPROC</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02036">WHF_CALLWNDPROCRET</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02937">xxxBroadcastMessage()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00705">XXXSENDMESSAGETOCLIENT</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05648">NtUserSendMessageCallback()</a>, <a class="el" href="../../d4/d4/w32_2ntuser_2kernel_2capture_8c-source.html#l00124">xxxCapture()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00405">xxxFocusSetInputContext()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00808">xxxPaintIconsInSwitchWindow()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01069">xxxSendNotifyMessage()</a>.
<p>
<pre class="fragment"><div>01123          :
01124 * 07-13-92 ChrisBl      Created/extended from <a class="code" href="../../d0/d8/ntcftxt_8h.html#a28">SendNotifyMessage</a>
01125 \***********************************************************************/
01126 
01127 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1583">xxxSendMessageCallback</a>(
01128     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01129     UINT message,
01130     WPARAM wParam,
01131     LPARAM lParam,
01132     SENDASYNCPROC lpResultCallBack,
01133     ULONG_PTR dwData,
01134     BOOL fClientRequest)
01135 {
01136     LRESULT lRet;
01137     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01138     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fQueuedNotify;
01139 
01140     <span class="comment">/*</span>
01141 <span class="comment">     * See if this is a queued notify message.</span>
01142 <span class="comment">     */</span>
01143     fQueuedNotify = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01144     <span class="keywordflow">if</span> (lpResultCallBack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; dwData == 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)
01145         fQueuedNotify = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01146 
01147     <span class="comment">/*</span>
01148 <span class="comment">     * First check to see if this message takes DWORDs only. If it does not,</span>
01149 <span class="comment">     * fail the call. Cannot allow an app to post a message with pointers or</span>
01150 <span class="comment">     * handles in it - this can cause the server to fault and cause other</span>
01151 <span class="comment">     * problems - such as causing apps in separate address spaces to fault.</span>
01152 <span class="comment">     * (or even an app in the same address space to fault!)</span>
01153 <span class="comment">     */</span>
01154     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a918">TESTSYNCONLYMESSAGE</a>(message, wParam)) {
01155         RIPERR1(ERROR_MESSAGE_SYNC_ONLY, RIP_WARNING,
01156                 <span class="stringliteral">"Trying to non-synchronously send a structure msg=%lX"</span>, message);
01157         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01158     }
01159 
01160     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01161 
01162     <span class="comment">/*</span>
01163 <span class="comment">     * Is this a BroadcastMsg()?</span>
01164 <span class="comment">     */</span>
01165     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>) {
01166         <a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html">BROADCASTMSG</a> bcm;
01167         <a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html">PBROADCASTMSG</a> pbcm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uCmd = <a class="code" href="../../d4/d1/userk_8h.html#a444">BMSG_SENDNOTIFYMSG</a>;
01169 
01170         <span class="keywordflow">if</span> (lpResultCallBack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01171             uCmd = <a class="code" href="../../d4/d1/userk_8h.html#a446">BMSG_SENDMSGCALLBACK</a>;
01172             bcm.<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o3">cb</a>.lpResultCallBack = lpResultCallBack;
01173             bcm.<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o3">cb</a>.dwData = dwData;
01174             bcm.<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o3">cb</a>.bClientRequest = fClientRequest;
01175             pbcm = &amp;bcm;
01176         }
01177 
01178         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1475">xxxBroadcastMessage</a>(NULL, message, wParam, lParam, uCmd, pbcm );
01179     }
01180 
01181     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01182 
01183     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01184 
01185     <span class="comment">/*</span>
01186 <span class="comment">     * Do inter-thread call if window thead differs from current thread.</span>
01187 <span class="comment">     * We pass NULL for ptiSender to tell xxxInterSendMsgEx() that this is</span>
01188 <span class="comment">     * a xxxSendNotifyMessage() and that there's no need for a reply.</span>
01189 <span class="comment">     *</span>
01190 <span class="comment">     * If this is a queued notify, always call InterSendMsgEx() so that</span>
01191 <span class="comment">     * we queue it up and return - we don't do callbacks here with queued</span>
01192 <span class="comment">     * notifies.</span>
01193 <span class="comment">     */</span>
01194     <span class="keywordflow">if</span> (fQueuedNotify || ptiCurrent != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) {
01195         <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">INTRSENDMSGEX</a> ism;
01196         <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">PINTRSENDMSGEX</a> pism = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01197 
01198         <span class="keywordflow">if</span> (lpResultCallBack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {  <span class="comment">/* CallBack request */</span>
01199             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> = <a class="code" href="../../d4/d1/userk_8h.html#a436">ISM_CALLBACK</a> | (fClientRequest ? <a class="code" href="../../d4/d1/userk_8h.html#a440">ISM_CB_CLIENT</a> : 0);
01200             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o1">lpResultCallBack</a> = lpResultCallBack;
01201             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o2">dwData</a> = dwData;
01202             pism = &amp;ism;
01203         }
01204         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(pwnd, message, wParam, lParam,
01205                 NULL, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), pism );
01206     }
01207 
01208     <span class="comment">/*</span>
01209 <span class="comment">     * Call WH_CALLWNDPROC if it's installed.</span>
01210 <span class="comment">     */</span>
01211     <span class="keywordflow">if</span> (!fQueuedNotify &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_CALLWNDPROC)) {
01212         <a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html">CWPSTRUCTEX</a> cwps;
01213 
01214         cwps.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
01215         cwps.message = message;
01216         cwps.wParam = wParam;
01217         cwps.lParam = lParam;
01218         cwps.<a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html#o0">psmsSender</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01219 
01220         <span class="comment">/*</span>
01221 <span class="comment">         * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
01222 <span class="comment">         * to the CWPSTRUCT contents.</span>
01223 <span class="comment">         */</span>
01224         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, FALSE, (LPARAM)&amp;cwps, WH_CALLWNDPROC);
01225 
01226         <span class="comment">/*</span>
01227 <span class="comment">         * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
01228 <span class="comment">         * to the CWPSTRUCT contents.  If this behavior reverts to</span>
01229 <span class="comment">         * Win3.1 semantics, we will need to copy the new parameters</span>
01230 <span class="comment">         * from cwps.</span>
01231 <span class="comment">         */</span>
01232     }
01233 
01234     <span class="comment">/*</span>
01235 <span class="comment">     * If this window's proc is meant to be executed from the server side</span>
01236 <span class="comment">     * we'll just stay inside the semaphore and call it directly.  Note</span>
01237 <span class="comment">     * how we don't convert the pwnd into an hwnd before calling the proc.</span>
01238 <span class="comment">     */</span>
01239     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFSERVERSIDEPROC)) {
01240         lRet = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>(pwnd, message, wParam, lParam);
01241     } <span class="keywordflow">else</span> {
01242         <span class="comment">/*</span>
01243 <span class="comment">         * Call the client or xxxDefWindowProc. pwnd is already locked</span>
01244 <span class="comment">         */</span>
01245         <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a3">XXXSENDMESSAGETOCLIENT</a>(pwnd, message, wParam, lParam, NULL, FALSE);
01246     }
01247 
01248     <span class="keywordflow">if</span> (lpResultCallBack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01249        <span class="comment">/*</span>
01250 <span class="comment">        * Call the callback funtion for the return value</span>
01251 <span class="comment">        */</span>
01252         <span class="keywordflow">if</span> (fClientRequest) {
01253             <span class="comment">/*</span>
01254 <span class="comment">             * The application-defined callback proc is neither Unicode/ANSI</span>
01255 <span class="comment">             */</span>
01256             <a class="code" href="../../d4/d1/userk_8h.html#a242">CallClientProcA</a>(pwnd, message, dwData, lRet,
01257                     (ULONG_PTR)lpResultCallBack);
01258         } <span class="keywordflow">else</span> {
01259             (*lpResultCallBack)((HWND)pwnd, message, dwData, lRet);
01260         }
01261     }
01262 
01263     <span class="comment">/*</span>
01264 <span class="comment">     * Call WH_CALLWNDPROCRET if it's installed.</span>
01265 <span class="comment">     */</span>
01266     <span class="keywordflow">if</span> (!fQueuedNotify &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_CALLWNDPROCRET)) {
01267         <a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html">CWPRETSTRUCTEX</a> cwps;
01268 
01269         cwps.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
01270         cwps.message = message;
01271         cwps.wParam = wParam;
01272         cwps.lParam = lParam;
01273         cwps.<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o0">lResult</a> = lRet;
01274         cwps.<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o1">psmsSender</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01275 
01276         <span class="comment">/*</span>
01277 <span class="comment">         * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
01278 <span class="comment">         * to the CWPSTRUCT contents.</span>
         */</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="kernel/sendmsg.c::xxxSendMessageEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT xxxSendMessageEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>xParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00609">609</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03165">tagSNDMSGTIMEOUT::fuFlags</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03168">tagSNDMSGTIMEOUT::lSMTOResult</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03167">tagSNDMSGTIMEOUT::lSMTOReturn</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1095">SNDMSGTIMEOUT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03166">tagSNDMSGTIMEOUT::uTimeout</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l00975">InitFunctionTables()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00556">xxxSendMessageFF()</a>.
<p>
<pre class="fragment"><div>00615 {
00616     <span class="comment">/*</span>
00617 <span class="comment">     * extract values from the xParam if from TimeOut call</span>
00618 <span class="comment">     * This should be the only way this function is ever</span>
00619 <span class="comment">     * called, but check it just in case...</span>
00620 <span class="comment">     */</span>
00621     <span class="keywordflow">if</span> (xParam != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) {
00622         LRESULT lRet;
00623         LRESULT lResult;
00624         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00625         <a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html">SNDMSGTIMEOUT</a> smto;
00626         <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00627 
00628         <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00629             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00630 
00631         <span class="comment">/*</span>
00632 <span class="comment">         * Probe all read arguments</span>
00633 <span class="comment">         */</span>
00634         <span class="keywordflow">try</span> {
00635             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)xParam, <span class="keyword">sizeof</span>(smto), <span class="keyword">sizeof</span>(ULONG));
00636             smto = *(<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html">SNDMSGTIMEOUT</a> *)xParam;
00637             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00638         } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
00639             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00640         }
00641         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00642             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00643         }
00644 
00645         lRet = <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwnd, message, wParam, lParam,
00646                 smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o0">fuFlags</a>, smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o1">uTimeout</a>, &amp;lResult );
00647 
00648         <span class="comment">/*</span>
00649 <span class="comment">         * put the result back into the client</span>
00650 <span class="comment">         */</span>
00651         smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o3">lSMTOResult</a> = lResult;
00652         smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o2">lSMTOReturn</a> = lRet;
00653 
00654         <span class="keywordflow">try</span> {
00655             *(<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html">SNDMSGTIMEOUT</a> *)xParam = smto;
00656         } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
00657             lResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00658         }
00659 
00660         <span class="comment">/*</span>
00661 <span class="comment">         * Return the lResult so our thunks are happy.</span>
00662 <span class="comment">         */</span>
00663         <span class="keywordflow">return</span> lResult;
00664     }
00665 
00666     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwnd, message, wParam,
00667             lParam, SMTO_NORMAL, 0, NULL );
00668 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="kernel/sendmsg.c::xxxSendMessageFF" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT xxxSendMessageFF           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>xParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00556">556</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03833">PWND_BROADCAST</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00609">xxxSendMessageEx()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l00975">InitFunctionTables()</a>.
<p>
<pre class="fragment"><div>00562 {
00563     DBG_UNREFERENCED_PARAMETER(pwnd);
00564 
00565     <span class="comment">/*</span>
00566 <span class="comment">     * Call xxxSendMessage() to do broadcasting rather than calling</span>
00567 <span class="comment">     * broadcast from here in case any internal code that calls</span>
00568 <span class="comment">     * sendmessage passes a -1 (that way the internal code doesn't</span>
00569 <span class="comment">     * need to know about this weird routine).</span>
00570 <span class="comment">     */</span>
00571     <span class="keywordflow">if</span> (xParam != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) {
00572         <span class="comment">/*</span>
00573 <span class="comment">         * SendMessageTimeout call</span>
00574 <span class="comment">         */</span>
00575         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1578">xxxSendMessageEx</a>(PWND_BROADCAST, message, wParam, lParam, xParam);
00576     } <span class="keywordflow">else</span> {
00577         <span class="comment">/*</span>
00578 <span class="comment">         * Normal SendMessage call</span>
00579 <span class="comment">         */</span>
00580         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(PWND_BROADCAST, message, wParam,
00581                 lParam, SMTO_NORMAL, 0, NULL );
00582     }
00583 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="kernel/sendmsg.c::xxxSendMessageTimeout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT xxxSendMessageTimeout           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>fuFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>uTimeout</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpdwResult</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">764</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03789">BMSG_SENDMSG</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03793">BMSG_SENDMSGTIMEOUT</a>, <a class="el" href="../../d4/d1/userk_8h.html#a900">BROADCASTMSG</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03508">CMSWAITTOKILLTIMEOUT</a>, <a class="el" href="../../d4/d1/userk_8h.html#a891">CWPRETSTRUCTEX</a>, <a class="el" href="../../d4/d1/userk_8h.html#a889">CWPSTRUCTEX</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00080">FHungApp()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03744">tagINTERSENDMSGEX::fuCall</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03750">tagINTERSENDMSGEX::fuSend</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00283">guDdeSendTimeout</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01477">HMIsMarkDestroy</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01515">HWq</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l01266">IsHooked</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03756">ISM_TIMEOUT</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02385">KERNEL_STACK_MINIMUM_RESERVE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03752">tagINTERSENDMSGEX::lpdwResult</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01841">tagWND::lpfnWndProc</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03695">_CWPRETSTRUCTEX::lResult</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d1/userk_8h.html#a901">PBROADCASTMSG</a>, <a class="el" href="../../d4/d1/userk_8h.html#a895">PINTRSENDMSGEX</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03691">_CWPSTRUCTEX::psmsSender</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03697">_CWPRETSTRUCTEX::psmsSender</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03833">PWND_BROADCAST</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d8/d8/uniontagBROADCASTMSG.html#o7">tagBROADCASTMSG::to</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03751">tagINTERSENDMSGEX::uTimeout</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02285">WFSERVERSIDEPROC</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02035">WHF_CALLWNDPROC</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02036">WHF_CALLWNDPROCRET</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02937">xxxBroadcastMessage()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l00147">xxxDDETrackSendHook()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00705">XXXSENDMESSAGETOCLIENT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00538">DrawSwitchWndHilite()</a>, <a class="el" href="../../d2/d4/caption_8c-source.html#l00306">xxxGetWindowSmIcon()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l01070">xxxImmUnloadLayout()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01675">xxxNextWindow()</a>, <a class="el" href="../../d7/d0/dragdrop_8c-source.html#l00243">xxxQueryDropObject()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00315">xxxSendBSMtoDesktop()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00783">xxxSendClipboardMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00609">xxxSendMessageEx()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00556">xxxSendMessageFF()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l03675">xxxSendMinRectMessages()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l01497">xxxSystemParametersInfo()</a>, and <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l00763">xxxWrapSendMessage()</a>.
<p>
<pre class="fragment"><div>00770          :
00771 *   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> window <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an error
00772 *
00773 * <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>:
00774 * 07-13-92 ChrisBl      Created/extended from <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>
00775 \***********************************************************************/
00776 
00777 LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(
00778     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00779     UINT message,
00780     WPARAM wParam,
00781     LPARAM lParam,
00782     UINT fuFlags,
00783     UINT uTimeout,
00784     PLONG_PTR lpdwResult)
00785 {
00786     LRESULT lRet;
00787     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00788     ULONG_PTR uResult;   <span class="comment">// holder for DDE_INITIATE case</span>
00789 
00790     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00791 
00792     <span class="keywordflow">if</span> (lpdwResult != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00793        *lpdwResult = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00794 
00795     <span class="comment">/*</span>
00796 <span class="comment">     * Is this a BroadcastMsg()?</span>
00797 <span class="comment">     */</span>
00798     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>) {
00799         <a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html">BROADCASTMSG</a> bcm;
00800         <a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html">PBROADCASTMSG</a> pbcm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00801         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uCmd = <a class="code" href="../../d4/d1/userk_8h.html#a443">BMSG_SENDMSG</a>;
00802 
00803         <span class="keywordflow">if</span> (lpdwResult != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00804             uCmd = <a class="code" href="../../d4/d1/userk_8h.html#a447">BMSG_SENDMSGTIMEOUT</a>;
00805             bcm.<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o7">to</a>.fuFlags = fuFlags;
00806             bcm.<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o7">to</a>.uTimeout = uTimeout;
00807             bcm.<a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html#o7">to</a>.lpdwResult = lpdwResult;
00808             pbcm = &amp;bcm;
00809         }
00810 
00811         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1475">xxxBroadcastMessage</a>(NULL, message, wParam, lParam, uCmd, pbcm );
00812     }
00813 
00814     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00815 
00816     <span class="keywordflow">if</span> (message &gt;= WM_DDE_FIRST &amp;&amp; message &lt;= WM_DDE_LAST) {
00817         <span class="comment">/*</span>
00818 <span class="comment">         * Even though apps should only send WM_DDE_INITIATE or WM_DDE_ACK</span>
00819 <span class="comment">         * messages, we hook them all so DDESPY can monitor them.</span>
00820 <span class="comment">         */</span>
00821         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1873">xxxDDETrackSendHook</a>(pwnd, message, wParam, lParam)) {
00822             <span class="keywordflow">return</span> 0;
00823         }
00824         <span class="keywordflow">if</span> (message == WM_DDE_INITIATE &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a125">guDdeSendTimeout</a>) {
00825             <span class="comment">/*</span>
00826 <span class="comment">             * This hack prevents DDE apps from locking up because some</span>
00827 <span class="comment">             * bozo in the system has a top level window and is not</span>
00828 <span class="comment">             * processing messages.  guDdeSendTimeout is registry set.</span>
00829 <span class="comment">             */</span>
00830             <span class="keywordflow">if</span> (lpdwResult == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00831                 lpdwResult = &amp;uResult;
00832             }
00833             fuFlags |= SMTO_ABORTIFHUNG;
00834             uTimeout = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a125">guDdeSendTimeout</a>;
00835         }
00836     }
00837 
00838     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00839 
00840     <span class="comment">/*</span>
00841 <span class="comment">     * Do inter-thread call if window queue differs from current queue</span>
00842 <span class="comment">     */</span>
00843     <span class="keywordflow">if</span> (ptiCurrent != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) {
00844         <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">INTRSENDMSGEX</a> ism;
00845         <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">PINTRSENDMSGEX</a> pism = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00846 
00847         <span class="comment">/*</span>
00848 <span class="comment">         * If this window is a zombie, don't allow inter-thread send messages</span>
00849 <span class="comment">         * to it.</span>
00850 <span class="comment">         */</span>
00851         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pwnd))
00852             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam);
00853 
00854         <span class="keywordflow">if</span> ( lpdwResult != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00855             <span class="comment">/*</span>
00856 <span class="comment">             * fail if we think the thread is hung</span>
00857 <span class="comment">             */</span>
00858             <span class="keywordflow">if</span> ((fuFlags &amp; SMTO_ABORTIFHUNG) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), CMSWAITTOKILLTIMEOUT))
00859                <span class="keywordflow">return</span> 0;
00860 
00861             <span class="comment">/*</span>
00862 <span class="comment">             * Setup for a InterSend time-out call</span>
00863 <span class="comment">             */</span>
00864             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a> = <a class="code" href="../../d4/d1/userk_8h.html#a437">ISM_TIMEOUT</a>;
00865             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o4">fuSend</a> = fuFlags;
00866             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o5">uTimeout</a> = uTimeout;
00867             ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o6">lpdwResult</a> = lpdwResult;
00868             pism = &amp;ism;
00869         }
00870 
00871         lRet = <a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(pwnd, message, wParam, lParam,
00872                 ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), pism );
00873 
00874         <span class="keywordflow">return</span> lRet;
00875     }
00876 
00877     <span class="comment">/*</span>
00878 <span class="comment">     * Call WH_CALLWNDPROC if it's installed and the window is not marked</span>
00879 <span class="comment">     * as destroyed.</span>
00880 <span class="comment">     */</span>
00881     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_CALLWNDPROC)) {
00882         <a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html">CWPSTRUCTEX</a> cwps;
00883 
00884         cwps.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00885         cwps.message = message;
00886         cwps.wParam = wParam;
00887         cwps.lParam = lParam;
00888         cwps.<a class="code" href="../../d0/d0/struct__CWPSTRUCTEX.html#o0">psmsSender</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00889 
00890         <span class="comment">/*</span>
00891 <span class="comment">         * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
00892 <span class="comment">         * to the CWPSTRUCT contents.</span>
00893 <span class="comment">         */</span>
00894         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, FALSE, (LPARAM)&amp;cwps, WH_CALLWNDPROC);
00895 
00896         <span class="comment">/*</span>
00897 <span class="comment">         * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
00898 <span class="comment">         * to the CWPSTRUCT contents.  If this behavior reverts to</span>
00899 <span class="comment">         * Win3.1 semantics, we will need to copy the new parameters</span>
00900 <span class="comment">         * from cwps.</span>
00901 <span class="comment">         */</span>
00902     }
00903 
00904     <span class="comment">/*</span>
00905 <span class="comment">     * If this window's proc is meant to be executed from the server side</span>
00906 <span class="comment">     * we'll just stay inside the semaphore and call it directly.  Note</span>
00907 <span class="comment">     * how we don't convert the pwnd into an hwnd before calling the proc.</span>
00908 <span class="comment">     */</span>
00909     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFSERVERSIDEPROC)) {
00910 
00911         <span class="comment">/*</span>
00912 <span class="comment">         * We have a number of places where we do recursion in User.  This often goes</span>
00913 <span class="comment">         * through SendMessage (when we send a message to the parent for example) which</span>
00914 <span class="comment">         * can eat the amount of stack we have</span>
00915 <span class="comment">         */</span>
00916         <span class="keywordflow">if</span> (((ULONG_PTR)&amp;uResult - (ULONG_PTR)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;StackLimit) &lt; <a class="code" href="../../d4/d1/userk_8h.html#a266">KERNEL_STACK_MINIMUM_RESERVE</a>) {
00917             RIPMSG1(RIP_ERROR, <span class="stringliteral">"SendMessage: Thread recursing in User with message %lX; failing"</span>, message);
00918             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00919         }
00920 
00921         lRet = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>(pwnd, message, wParam, lParam);
00922 
00923         <span class="keywordflow">if</span> ( lpdwResult == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00924             <span class="keywordflow">return</span> lRet;
00925         } <span class="keywordflow">else</span> {      <span class="comment">/* time-out call */</span>
00926             *lpdwResult = lRet;
00927             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00928         }
00929     }
00930 
00931     <span class="comment">/*</span>
00932 <span class="comment">     * Call the client or xxxDefWindowProc. pwnd is already locked.</span>
00933 <span class="comment">     */</span>
00934     <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a3">XXXSENDMESSAGETOCLIENT</a>(pwnd, message, wParam, lParam, NULL, FALSE);
00935 
00936     <span class="comment">/*</span>
00937 <span class="comment">     * Call WH_CALLWNDPROCRET if it's installed.</span>
00938 <span class="comment">     */</span>
00939     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_CALLWNDPROCRET)) {
00940         <a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html">CWPRETSTRUCTEX</a> cwps;
00941 
00942         cwps.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00943         cwps.message = message;
00944         cwps.wParam = wParam;
00945         cwps.lParam = lParam;
00946         cwps.<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o0">lResult</a> = lRet;
00947         cwps.<a class="code" href="../../d9/d9/struct__CWPRETSTRUCTEX.html#o1">psmsSender</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00948 
00949         <span class="comment">/*</span>
00950 <span class="comment">         * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
00951 <span class="comment">         * to the CWPSTRUCT contents.</span>
00952 <span class="comment">         */</span>
00953         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, FALSE, (LPARAM)&amp;cwps, WH_CALLWNDPROCRET);
00954 
00955         <span class="comment">/*</span>
00956 <span class="comment">         * Unlike Win3.1, NT and Win95 ignore any changes the app makes</span>
         * to the CWPSTRUCT contents.  If this behavior reverts to</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="kernel/sendmsg.c::xxxSendNotifyMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxSendNotifyMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01069">1069</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03790">BMSG_SENDNOTIFYMSG</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03833">PWND_BROADCAST</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01114">xxxSendMessageCallback()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01002">xxxSystemBroadcastMessage()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00101">FullScreenCleanup()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05599">NtUserSendNotifyMessage()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, <a class="el" href="../../d1/d2/palette_8c-source.html#l00243">xxxBroadcastPaletteChanged()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00883">xxxDesktopWndProc()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00220">xxxDrawClipboard()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00635">xxxMNLoop()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01675">xxxNextWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l02121">xxxOldNextWindow()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00315">xxxSendBSMtoDesktop()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00783">xxxSendClipboardMessage()</a>, <a class="el" href="../../d4/d2/mnsel_8c-source.html#l00029">xxxSendMenuSelect()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01105">xxxSetDeskPattern()</a>, <a class="el" href="../../d2/d2/dtbitmap_8c-source.html#l01079">xxxSetDeskWallpaper()</a>, and <a class="el" href="../../d0/d8/sysmet_8c-source.html#l00225">xxxSetSysColors()</a>.
<p>
<pre class="fragment"><div>01077          :
01078 * 01-23-91 DavidPe      Created.
01079 * 07-14-92 ChrisBl      Will <span class="keywordflow">return</span> T/F <span class="keywordflow">if</span> in same thread, as documented
01080 \***********************************************************************/
01081 
01082 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(
01083     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01084     UINT message,
01085     WPARAM wParam,
01086     LPARAM lParam)
01087 {
01088     <span class="comment">/*</span>
01089 <span class="comment">     * If this is a broadcast of one of the system</span>
01090 <span class="comment">     * notification messages,  send it to all top-level</span>
01091 <span class="comment">     * windows in the system.</span>
01092 <span class="comment">     */</span>
01093     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>) {
01094         <span class="keywordflow">switch</span> (message) {
01095         <span class="keywordflow">case</span> WM_WININICHANGE:
01096         <span class="keywordflow">case</span> WM_DEVMODECHANGE:
        <span class="keywordflow">case</span> WM_SPOOLERSTATUS:
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="kernel/sendmsg.c::xxxSendSizeMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxSendSizeMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>cmdSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02861">2861</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/createw_8c-source.html#l00033">xxxCreateWindowEx()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l03381">xxxHandleWindowPosChanged()</a>, and <a class="el" href="../../d1/d8/showwin_8c-source.html#l00085">xxxShowWindow()</a>.
<p>
<pre class="fragment"><div>02870          :
02871 * 10-19-90 darrinm      Ported from Win 3.0 sources.
02872 \***************************************************************************/
02873 
02874 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1505">xxxSendSizeMessage</a>(
02875     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02876     UINT cmdSize)
02877 {
02878     RECT rc;
    <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="kernel/sendmsg.c::xxxSystemBroadcastMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxSystemBroadcastMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>wCmd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d8/uniontagBROADCASTMSG.html">PBROADCASTMSG</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pbcm</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01002">1002</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03789">BMSG_SENDMSG</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03790">BMSG_SENDNOTIFYMSG</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00648">grpWinStaList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02712">tagWINDOWSTATION::rpdeskList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02647">tagDESKTOP::rpdeskNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02711">tagWINDOWSTATION::rpwinstaNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02648">tagDESKTOP::rpwinstaParent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01652">ThreadLockDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01658">ThreadLockExchangeDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01674">ThreadLockExchangeWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01668">ThreadLockWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01664">ThreadUnlockDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01698">ThreadUnlockWinSta</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02937">xxxBroadcastMessage()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01069">xxxSendNotifyMessage()</a>.
<p>
<pre class="fragment"><div>01011          :
01012 * 05-12-94 JimA         Created.
01013 \***************************************************************************/
01014 
01015 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a26">xxxSystemBroadcastMessage</a>(
01016     UINT message,
01017     WPARAM wParam,
01018     LPARAM lParam,
01019     UINT wCmd,
01020     <a class="code" href="../../d8/d8/uniontagBROADCASTMSG.html">PBROADCASTMSG</a> pbcm)
01021 {
01022     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01023     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta;
01024     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
01025     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwinsta;
01026     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpdesk;
01027 
01028     <span class="comment">/*</span>
01029 <span class="comment">     * Walk through all windowstations and desktop looking for</span>
01030 <span class="comment">     * top-level windows.</span>
01031 <span class="comment">     */</span>
01032     <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, NULL, &amp;tlpwinsta);
01033     <a class="code" href="../../d4/d1/userk_8h.html#a128">ThreadLockDesktop</a>(ptiCurrent, NULL, &amp;tlpdesk, LDLT_FN_SYSTEMBROADCASTMESSAGE);
01034     <span class="keywordflow">for</span> (pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>; pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
01035         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wCmd1;
01036 
01037         <span class="keywordflow">if</span> ((wCmd == <a class="code" href="../../d4/d1/userk_8h.html#a443">BMSG_SENDMSG</a>) &amp;&amp; (pwinsta != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>))
01038             wCmd1 = <a class="code" href="../../d4/d1/userk_8h.html#a444">BMSG_SENDNOTIFYMSG</a>;
01039         <span class="keywordflow">else</span>
01040             wCmd1 = wCmd;
01041 
01042         <a class="code" href="../../d4/d1/userk_8h.html#a132">ThreadLockExchangeWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
01043         <span class="keywordflow">for</span> (pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
01044 
01045             <a class="code" href="../../d4/d1/userk_8h.html#a129">ThreadLockExchangeDesktop</a>(ptiCurrent, pdesk, &amp;tlpdesk, LDLT_FN_SYSTEMBROADCASTMESSAGE);
01046 
01047             <span class="comment">/*</span>
01048 <span class="comment">             * Bug 276814. Don't recurse calling again xxxBroadcastMessage if there</span>
01049 <span class="comment">             * is no window on this desktop.</span>
             */</span>
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a7" doxytag="kernel/sendmsg.c::SMSLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d3/d6/kernel_2sendmsg_8c.html#a7">SMSLookaside</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00034">34</a> of file <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html">kernel/sendmsg.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00164">AllocSMS()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00178">FreeSMS()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00137">InitSMSLookaside()</a>, and <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00097">Win32kNtUserCleanup()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
