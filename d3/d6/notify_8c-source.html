<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: notify.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>notify.c</h1><a href="../../d2/d7/notify_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Notify.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    The Notify package provides support to filesystems which implement</span>
00012 <span class="comment">    NotifyChangeDirectory.  This package will manage a queue of notify</span>
00013 <span class="comment">    blocks which are attached to some filesystem structure (i.e. Vcb</span>
00014 <span class="comment">    in Fat, HPFS).  The filesystems will allocate a fast mutex to be used</span>
00015 <span class="comment">    by this package to synchronize access to the notify queue.</span>
00016 <span class="comment"></span>
00017 <span class="comment">    The following routines are provided by this package:</span>
00018 <span class="comment"></span>
00019 <span class="comment">        o  FsRtlNotifyInitializeSync - Create and initializes the</span>
00020 <span class="comment">           synchronization object.</span>
00021 <span class="comment"></span>
00022 <span class="comment">        o  FsrtlNotifyUninitializeSync - Deallocates the synchronization</span>
00023 <span class="comment">           object.</span>
00024 <span class="comment"></span>
00025 <span class="comment">        o  FsRtlNotifyChangeDirectory - This routine is called whenever the</span>
00026 <span class="comment">           filesystems receive a NotifyChangeDirectoryFile call.  This</span>
00027 <span class="comment">           routine allocates any neccessary structures and places the</span>
00028 <span class="comment">           Irp in the NotifyQueue (or possibly completes or cancels it</span>
00029 <span class="comment">           immediately).</span>
00030 <span class="comment"></span>
00031 <span class="comment">        o  FsRtlNotifyFullChangeDirectory - This routine is called whenever the</span>
00032 <span class="comment">           filesystems receive a NotifyChangeDirectoryFile call.  This differs</span>
00033 <span class="comment">           from the FsRtlNotifyChangeDirectory in that it expects to return</span>
00034 <span class="comment">           the notify information in the user's buffer.</span>
00035 <span class="comment"></span>
00036 <span class="comment">        o  FsRtlNotifyReportChange - This routine is called by the</span>
00037 <span class="comment">           filesystems whenever they perform some operation that could</span>
00038 <span class="comment">           cause the completion of a notify operation.  This routine will</span>
00039 <span class="comment">           walk through the notify queue to see if any Irps are affected</span>
00040 <span class="comment">           by the indicated operation.</span>
00041 <span class="comment"></span>
00042 <span class="comment">        o  FsRtlNotifyFullReportChange - This routine is called by the</span>
00043 <span class="comment">           filesystems whenever they perform some operation that could</span>
00044 <span class="comment">           cause the completion of a notify operation.  This routine differs</span>
00045 <span class="comment">           from the FsRtlNotifyReportChange call in that it returns more</span>
00046 <span class="comment">           detailed information in the caller's buffer if present.</span>
00047 <span class="comment"></span>
00048 <span class="comment">        o  FsRtlNotifyCleanup - This routine is called to remove any</span>
00049 <span class="comment">           references to a particular FsContext structure from the notify</span>
00050 <span class="comment">           queue.  If the matching FsContext structure is found in the</span>
00051 <span class="comment">           queue, then all associated Irps are completed.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Author:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    Brian Andrew    [BrianAn]   9-19-1991</span>
00056 <span class="comment"></span>
00057 <span class="comment">Revision History:</span>
00058 <span class="comment"></span>
00059 <span class="comment">--*/</span>
00060 
00061 <span class="preprocessor">#include "FsRtlP.h"</span>
00062 
00063 <span class="comment">//</span>
00064 <span class="comment">//  Trace level for the module</span>
00065 <span class="comment">//</span>
00066 
<a name="l00067"></a><a class="code" href="../../d2/d7/notify_8c.html#a0">00067</a> <span class="preprocessor">#define Dbg                              (0x04000000)</span>
00068 <span class="preprocessor"></span>
00069 <span class="comment">//</span>
00070 <span class="comment">//  This is the synchronization object for the notify package.  The caller</span>
00071 <span class="comment">//  given a pointer to this structure.</span>
00072 <span class="comment">//</span>
00073 
<a name="l00074"></a><a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">00074</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">_REAL_NOTIFY_SYNC</a> {
00075 
<a name="l00076"></a><a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o0">00076</a>     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o0">FastMutex</a>;
<a name="l00077"></a><a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o1">00077</a>     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o1">OwningThread</a>;
<a name="l00078"></a><a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o2">00078</a>     ULONG <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o2">OwnerCount</a>;
00079 
00080 } <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">REAL_NOTIFY_SYNC</a>, *<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>;
00081 
00082 <span class="comment">//</span>
00083 <span class="comment">//  A list of the following structures is used to store the NotifyChange</span>
00084 <span class="comment">//  requests.  They are linked to a filesystem-defined list head.</span>
00085 <span class="comment">//</span>
00086 
<a name="l00087"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">00087</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">_NOTIFY_CHANGE</a> {
00088 
00089     <span class="comment">//</span>
00090     <span class="comment">//  Fast Mutex.  This fast mutex is used to access the list containing this</span>
00091     <span class="comment">//  structure.</span>
00092     <span class="comment">//</span>
00093 
<a name="l00094"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o0">00094</a>     <a class="code" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a> <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o0">NotifySync</a>;
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">//  FsContext.  This value is given by the filesystems to uniquely</span>
00098     <span class="comment">//  identify this structure.  The identification is on a</span>
00099     <span class="comment">//  per-user file object basis.  The expected value is the Ccb address</span>
00100     <span class="comment">//  for this user file object.</span>
00101     <span class="comment">//</span>
00102 
<a name="l00103"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">00103</a>     PVOID <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a>;
00104 
00105     <span class="comment">//</span>
00106     <span class="comment">//  StreamID.  This value matches the FsContext field in the file object for</span>
00107     <span class="comment">//  the directory being watched.  This is used to identify the directory stream</span>
00108     <span class="comment">//  when the directory is being deleted.</span>
00109     <span class="comment">//</span>
00110 
<a name="l00111"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o2">00111</a>     PVOID <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o2">StreamID</a>;
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">//  TraverseAccessCallback.  This is the filesystem-supplied routine used</span>
00115     <span class="comment">//  to call back into the filesystem to check whether the caller has traverse</span>
00116     <span class="comment">//  access when watching a sub-directory.  Only applies when watching a</span>
00117     <span class="comment">//  sub-directory.</span>
00118     <span class="comment">//</span>
00119 
<a name="l00120"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">00120</a>     <a class="code" href="../../d1/d8/fsrtl_8h.html#a82">PCHECK_FOR_TRAVERSE_ACCESS</a> <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a>;
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">//  SubjectContext.  If the caller specifies a traverse callback routine</span>
00124     <span class="comment">//  we will need to pass the Security Context from the thread which</span>
00125     <span class="comment">//  originated this call.  The notify package will free this structure</span>
00126     <span class="comment">//  on tearing down the notify package.  We don't expect to need this</span>
00127     <span class="comment">//  structure often.</span>
00128     <span class="comment">//</span>
00129 
<a name="l00130"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">00130</a>     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>;
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  Full Directory Name.  The following string is the full directory</span>
00134     <span class="comment">//  name of the directory being watched.  It is used during watch tree</span>
00135     <span class="comment">//  operations to check whether this directory is an ancestor of</span>
00136     <span class="comment">//  the modified file.  The string could be in ANSI or UNICODE form.</span>
00137     <span class="comment">//</span>
00138 
<a name="l00139"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">00139</a>     PSTRING <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>;
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">//  Notify List.  The following field links the notify structures for</span>
00143     <span class="comment">//  a particular volume.</span>
00144     <span class="comment">//</span>
00145 
<a name="l00146"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o6">00146</a>     LIST_ENTRY <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o6">NotifyList</a>;
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">//  Notify Irps.  The following field links the Irps associated with</span>
00150     <span class="comment">//</span>
00151     <span class="comment">//</span>
00152 
<a name="l00153"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">00153</a>     LIST_ENTRY <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>;
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">//  Flags.  State of the notify for this volume.</span>
00157     <span class="comment">//</span>
00158 
<a name="l00159"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">00159</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>;
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">//  Character size.  Larger size indicates unicode characters.</span>
00163     <span class="comment">//  unicode names.</span>
00164     <span class="comment">//</span>
00165 
<a name="l00166"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">00166</a>     UCHAR <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">//  Completion Filter.  This field is used to mask the modification</span>
00170     <span class="comment">//  actions to determine whether to complete the notify irp.</span>
00171     <span class="comment">//</span>
00172 
<a name="l00173"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o10">00173</a>     ULONG <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o10">CompletionFilter</a>;
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  The following values are used to manage a buffer if there is no current</span>
00177     <span class="comment">//  Irp to complete. The fields have the following meaning:</span>
00178     <span class="comment">//</span>
00179     <span class="comment">//      AllocatedBuffer     - Buffer we need to allocate</span>
00180     <span class="comment">//      Buffer              - Buffer to store data in</span>
00181     <span class="comment">//      BufferLength        - Length of original user buffer</span>
00182     <span class="comment">//      ThisBufferLength    - Length of the buffer we are using</span>
00183     <span class="comment">//      DataLength          - Current length of the data in the buffer</span>
00184     <span class="comment">//      LastEntry           - Offset of previous entry in the buffer</span>
00185     <span class="comment">//</span>
00186 
<a name="l00187"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">00187</a>     PVOID <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a>;
<a name="l00188"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">00188</a>     PVOID <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>;
<a name="l00189"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">00189</a>     ULONG <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>;
<a name="l00190"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">00190</a>     ULONG <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a>;
<a name="l00191"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">00191</a>     ULONG <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a>;
<a name="l00192"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">00192</a>     ULONG <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>;
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">//  Reference count which keeps the notify structure around.  Such references include</span>
00196     <span class="comment">// </span>
00197     <span class="comment">//      - Lifetime reference.  Count set to one initially and removed on cleanup</span>
00198     <span class="comment">//      - Cancel reference.  Reference the notify struct when storing the cancel routine</span>
00199     <span class="comment">//          in the Irp.  The routine which actually clears the routine will decrement</span>
00200     <span class="comment">//          this value.</span>
00201     <span class="comment">//</span>
00202 
<a name="l00203"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">00203</a>     ULONG <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a>;
00204 
00205     <span class="comment">//</span>
00206     <span class="comment">//  This is the process on whose behalf the structure was allocated.  We</span>
00207     <span class="comment">//  charge any quota to this process.</span>
00208     <span class="comment">//</span>
00209 
<a name="l00210"></a><a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">00210</a>     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>;
00211 
00212 } <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>, *<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a>;
00213 
<a name="l00214"></a><a class="code" href="../../d2/d7/notify_8c.html#a1">00214</a> <span class="preprocessor">#define NOTIFY_WATCH_TREE               (0x0001)</span>
<a name="l00215"></a><a class="code" href="../../d2/d7/notify_8c.html#a2">00215</a> <span class="preprocessor"></span><span class="preprocessor">#define NOTIFY_IMMEDIATE_NOTIFY         (0x0002)</span>
<a name="l00216"></a><a class="code" href="../../d2/d7/notify_8c.html#a3">00216</a> <span class="preprocessor"></span><span class="preprocessor">#define NOTIFY_CLEANUP_CALLED           (0x0004)</span>
<a name="l00217"></a><a class="code" href="../../d2/d7/notify_8c.html#a4">00217</a> <span class="preprocessor"></span><span class="preprocessor">#define NOTIFY_DEFER_NOTIFY             (0x0008)</span>
<a name="l00218"></a><a class="code" href="../../d2/d7/notify_8c.html#a5">00218</a> <span class="preprocessor"></span><span class="preprocessor">#define NOTIFY_DIR_IS_ROOT              (0x0010)</span>
<a name="l00219"></a><a class="code" href="../../d2/d7/notify_8c.html#a6">00219</a> <span class="preprocessor"></span><span class="preprocessor">#define NOTIFY_STREAM_IS_DELETED        (0x0020)</span>
00220 <span class="preprocessor"></span>
00221 <span class="comment">//</span>
00222 <span class="comment">//      CAST</span>
00223 <span class="comment">//      Add2Ptr (</span>
00224 <span class="comment">//          IN PVOID Pointer,</span>
00225 <span class="comment">//          IN ULONG Increment</span>
00226 <span class="comment">//          IN (CAST)</span>
00227 <span class="comment">//          );</span>
00228 <span class="comment">//</span>
00229 <span class="comment">//      ULONG</span>
00230 <span class="comment">//      PtrOffset (</span>
00231 <span class="comment">//          IN PVOID BasePtr,</span>
00232 <span class="comment">//          IN PVOID OffsetPtr</span>
00233 <span class="comment">//          );</span>
00234 <span class="comment">//</span>
00235 
<a name="l00236"></a><a class="code" href="../../d2/d7/notify_8c.html#a7">00236</a> <span class="preprocessor">#define Add2Ptr(PTR,INC,CAST) ((CAST)((PUCHAR)(PTR) + (INC)))</span>
00237 <span class="preprocessor"></span>
<a name="l00238"></a><a class="code" href="../../d2/d7/notify_8c.html#a8">00238</a> <span class="preprocessor">#define PtrOffset(BASE,OFFSET) ((ULONG)((PCHAR)(OFFSET) - (PCHAR)(BASE)))</span>
00239 <span class="preprocessor"></span>
00240 <span class="comment">//</span>
00241 <span class="comment">//      VOID</span>
00242 <span class="comment">//      SetFlag (</span>
00243 <span class="comment">//          IN ULONG Flags,</span>
00244 <span class="comment">//          IN ULONG SingleFlag</span>
00245 <span class="comment">//          );</span>
00246 <span class="comment">//</span>
00247 <span class="comment">//      VOID</span>
00248 <span class="comment">//      ClearFlag (</span>
00249 <span class="comment">//          IN ULONG Flags,</span>
00250 <span class="comment">//          IN ULONG SingleFlag</span>
00251 <span class="comment">//          );</span>
00252 <span class="comment">//</span>
00253 
<a name="l00254"></a><a class="code" href="../../d2/d7/notify_8c.html#a9">00254</a> <span class="preprocessor">#define SetFlag(F,SF) {     \</span>
00255 <span class="preprocessor">    (F) |= (SF);            \</span>
00256 <span class="preprocessor">}</span>
00257 <span class="preprocessor"></span>
<a name="l00258"></a><a class="code" href="../../d2/d7/notify_8c.html#a10">00258</a> <span class="preprocessor">#define ClearFlag(F,SF) {   \</span>
00259 <span class="preprocessor">    (F) &amp;= ~(SF);           \</span>
00260 <span class="preprocessor">}</span>
00261 <span class="preprocessor"></span>
00262 <span class="comment">//</span>
00263 <span class="comment">//  VOID</span>
00264 <span class="comment">//  AcquireNotifySync (</span>
00265 <span class="comment">//      IN PREAL_NOTIFY_SYNC NotifySync</span>
00266 <span class="comment">//      );</span>
00267 <span class="comment">//</span>
00268 <span class="comment">//  VOID</span>
00269 <span class="comment">//  ReleaseNotifySync (</span>
00270 <span class="comment">//      IN PREAL_NOTIFY_SYNC NotifySync</span>
00271 <span class="comment">//      );</span>
00272 <span class="comment">//</span>
00273 
<a name="l00274"></a><a class="code" href="../../d2/d7/notify_8c.html#a11">00274</a> <span class="preprocessor">#define AcquireNotifySync(NS) {                                             \</span>
00275 <span class="preprocessor">    ERESOURCE_THREAD _CurrentThread;                                        \</span>
00276 <span class="preprocessor">    _CurrentThread = (ERESOURCE_THREAD) PsGetCurrentThread();               \</span>
00277 <span class="preprocessor">    if (_CurrentThread != ((PREAL_NOTIFY_SYNC) (NS))-&gt;OwningThread) {       \</span>
00278 <span class="preprocessor">        ExAcquireFastMutexUnsafe( &amp;((PREAL_NOTIFY_SYNC) (NS))-&gt;FastMutex ); \</span>
00279 <span class="preprocessor">        ((PREAL_NOTIFY_SYNC) (NS))-&gt;OwningThread = _CurrentThread;          \</span>
00280 <span class="preprocessor">    }                                                                       \</span>
00281 <span class="preprocessor">    ((PREAL_NOTIFY_SYNC) (NS))-&gt;OwnerCount += 1;                            \</span>
00282 <span class="preprocessor">}</span>
00283 <span class="preprocessor"></span>
<a name="l00284"></a><a class="code" href="../../d2/d7/notify_8c.html#a12">00284</a> <span class="preprocessor">#define ReleaseNotifySync(NS) {                                             \</span>
00285 <span class="preprocessor">    ((PREAL_NOTIFY_SYNC) (NS))-&gt;OwnerCount -= 1;                            \</span>
00286 <span class="preprocessor">    if (((PREAL_NOTIFY_SYNC) (NS))-&gt;OwnerCount == 0) {                      \</span>
00287 <span class="preprocessor">        ((PREAL_NOTIFY_SYNC) (NS))-&gt;OwningThread = (ERESOURCE_THREAD) 0;    \</span>
00288 <span class="preprocessor">        ExReleaseFastMutexUnsafe(&amp;((PREAL_NOTIFY_SYNC) (NS))-&gt;FastMutex);   \</span>
00289 <span class="preprocessor">    }                                                                       \</span>
00290 <span class="preprocessor">}</span>
00291 <span class="preprocessor"></span>
00292 <span class="comment">//</span>
00293 <span class="comment">//  Define a tag for general pool allocations from this module</span>
00294 <span class="comment">//</span>
00295 
00296 <span class="preprocessor">#undef MODULE_POOL_TAG</span>
<a name="l00297"></a><a class="code" href="../../d2/d7/notify_8c.html#a13">00297</a> <span class="preprocessor"></span><span class="preprocessor">#define MODULE_POOL_TAG                  ('NrSF')</span>
00298 <span class="preprocessor"></span>
00299 
00300 <span class="comment">//</span>
00301 <span class="comment">//  Local support routines</span>
00302 <span class="comment">//</span>
00303 
00304 <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>
00305 <a class="code" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a> (
00306     IN PLIST_ENTRY NotifyListHead,
00307     IN PVOID FsContext
00308     );
00309 
00310 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00311 <a class="code" href="../../d2/d7/notify_8c.html#a19">FsRtlNotifyCompleteIrp</a> (
00312     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp,
00313     IN PNOTIFY_CHANGE Notify,
00314     IN ULONG DataLength,
00315     IN NTSTATUS Status,
00316     IN ULONG CheckCancel
00317     );
00318 
00319 BOOLEAN
00320 <a class="code" href="../../d2/d7/notify_8c.html#a20">FsRtlNotifySetCancelRoutine</a> (
00321     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp,
00322     IN PNOTIFY_CHANGE Notify OPTIONAL
00323     );
00324 
00325 BOOLEAN
00326 <a class="code" href="../../d2/d7/notify_8c.html#a21">FsRtlNotifyUpdateBuffer</a> (
00327     IN PFILE_NOTIFY_INFORMATION NotifyInfo,
00328     IN ULONG FileAction,
00329     IN PSTRING ParentName,
00330     IN PSTRING TargetName,
00331     IN PSTRING StreamName OPTIONAL,
00332     IN BOOLEAN UnicodeName,
00333     IN ULONG SizeOfEntry
00334     );
00335 
00336 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00337 <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a> (
00338     IN PNOTIFY_CHANGE Notify,
00339     IN NTSTATUS Status
00340     );
00341 
00342 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00343 <a class="code" href="../../d2/d7/notify_8c.html#a23">FsRtlCancelNotify</a> (
00344     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00345     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> ThisIrp
00346     );
00347 
00348 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00349 <a class="code" href="../../d2/d7/notify_8c.html#a24">FsRtlCheckNotifyForDelete</a> (
00350     IN PLIST_ENTRY NotifyListHead,
00351     IN PVOID FsContext
00352     );
00353 
00354 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00355 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyInitializeSync)</span>
00356 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyUninitializeSync)</span>
00357 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyFullChangeDirectory)</span>
00358 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyFullReportChange)</span>
00359 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlIsNotifyOnList)</span>
00360 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyChangeDirectory)</span>
00361 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyCleanup)</span>
00362 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyCompleteIrp)</span>
00363 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyReportChange)</span>
00364 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlNotifyUpdateBuffer)</span>
00365 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlCheckNotifyForDelete)</span>
00366 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00367 <span class="preprocessor"></span>
00368 
00369 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
00370 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00371"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a169">00371</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a169">FsRtlNotifyInitializeSync</a> (
00372     IN PNOTIFY_SYNC *NotifySync
00373     )
00374 
00375 <span class="comment">/*++</span>
00376 <span class="comment"></span>
00377 <span class="comment">Routine Description:</span>
00378 <span class="comment"></span>
00379 <span class="comment">    This routine is called to allocate and initialize the synchronization object</span>
00380 <span class="comment">    for this notify list.</span>
00381 <span class="comment"></span>
00382 <span class="comment">Arguments:</span>
00383 <span class="comment"></span>
00384 <span class="comment">    NotifySync  -  This is the address to store the structure we allocate.</span>
00385 <span class="comment"></span>
00386 <span class="comment">Return Value:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    None.</span>
00389 <span class="comment"></span>
00390 <span class="comment">--*/</span>
00391 
00392 {
00393     <a class="code" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a> RealSync;
00394 
00395     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00396 
00397     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyInitializeSync:  Entered\n"</span>, 0 );
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  Clear the pointer and then attempt to allocate a non-paged</span>
00401     <span class="comment">//  structure.</span>
00402     <span class="comment">//</span>
00403 
00404     *NotifySync = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00405 
00406     RealSync = (<a class="code" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a>) <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00407                                                        <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">REAL_NOTIFY_SYNC</a> ));
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">//  Initialize the structure.</span>
00411     <span class="comment">//</span>
00412 
00413     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o0">FastMutex</a> );
00414     RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o1">OwningThread</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) 0;
00415     RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o2">OwnerCount</a> = 0;
00416 
00417     *NotifySync = (<a class="code" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>) RealSync;
00418 
00419     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyInitializeSync:  Exit\n"</span>, 0 );
00420     <span class="keywordflow">return</span>;
00421 }
00422 
00423 
00424 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
00425 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00426"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a170">00426</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a170">FsRtlNotifyUninitializeSync</a> (
00427     IN PNOTIFY_SYNC *NotifySync
00428     )
00429 
00430 <span class="comment">/*++</span>
00431 <span class="comment"></span>
00432 <span class="comment">Routine Description:</span>
00433 <span class="comment"></span>
00434 <span class="comment">    This routine is called to uninitialize the synchronization object</span>
00435 <span class="comment">    for this notify list.</span>
00436 <span class="comment"></span>
00437 <span class="comment">Arguments:</span>
00438 <span class="comment"></span>
00439 <span class="comment">    NotifySync  -  This is the address containing the pointer to our synchronization</span>
00440 <span class="comment">        object.</span>
00441 <span class="comment"></span>
00442 <span class="comment">Return Value:</span>
00443 <span class="comment"></span>
00444 <span class="comment">    None.</span>
00445 <span class="comment"></span>
00446 <span class="comment">--*/</span>
00447 
00448 {
00449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00450 
00451     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyUninitializeSync:  Entered\n"</span>, 0 );
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">//  Free the structure if present and clear the pointer.</span>
00455     <span class="comment">//</span>
00456 
00457     <span class="keywordflow">if</span> (*NotifySync != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00458 
00459         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *NotifySync );
00460         *NotifySync = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00461     }
00462 
00463     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyUninitializeSync:  Exit\n"</span>, 0 );
00464     <span class="keywordflow">return</span>;
00465 }
00466 
00467 
00468 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00469"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a171">00469</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a171">FsRtlNotifyChangeDirectory</a> (
00470     IN PNOTIFY_SYNC NotifySync,
00471     IN PVOID FsContext,
00472     IN PSTRING FullDirectoryName,
00473     IN PLIST_ENTRY NotifyList,
00474     IN BOOLEAN WatchTree,
00475     IN ULONG CompletionFilter,
00476     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp
00477     )
00478 
00479 <span class="comment">/*++</span>
00480 <span class="comment"></span>
00481 <span class="comment">Routine Description:</span>
00482 <span class="comment"></span>
00483 <span class="comment">    This routine is called by a file system which has received a NotifyChange</span>
00484 <span class="comment">    request.  This routine checks if there is already a notify structure and</span>
00485 <span class="comment">    inserts one if not present.  With a notify structure in hand, we check</span>
00486 <span class="comment">    whether we already have a pending notify and report it if so.  If there</span>
00487 <span class="comment">    is no pending notify, we check if this Irp has already been cancelled and</span>
00488 <span class="comment">    completes it if so.  Otherwise we add this to the list of Irps waiting</span>
00489 <span class="comment">    for notification.</span>
00490 <span class="comment"></span>
00491 <span class="comment">Arguments:</span>
00492 <span class="comment"></span>
00493 <span class="comment">    NotifySync  -  This is the controlling fast mutex for this notify list.</span>
00494 <span class="comment">        It is stored here so that it can be found for an Irp which is being</span>
00495 <span class="comment">        cancelled.</span>
00496 <span class="comment"></span>
00497 <span class="comment">    FsContext  -  This is supplied by the file system so that this notify</span>
00498 <span class="comment">                  structure can be uniquely identified.</span>
00499 <span class="comment"></span>
00500 <span class="comment">    FullDirectoryName  -  Points to the full name for the directory associated</span>
00501 <span class="comment">                          with this notify structure.</span>
00502 <span class="comment"></span>
00503 <span class="comment">    NotifyList  -  This is the start of the notify list to add this</span>
00504 <span class="comment">                   structure to.</span>
00505 <span class="comment"></span>
00506 <span class="comment">    WatchTree  -  This indicates whether all subdirectories for this directory</span>
00507 <span class="comment">                  should be watched, or just the directory itself.</span>
00508 <span class="comment"></span>
00509 <span class="comment">    CompletionFilter  -  This provides the mask to determine which operations</span>
00510 <span class="comment">                         will trigger the notify operations.</span>
00511 <span class="comment"></span>
00512 <span class="comment">    NotifyIrp  -  This is the Irp to complete on notify change.</span>
00513 <span class="comment"></span>
00514 <span class="comment">Return Value:</span>
00515 <span class="comment"></span>
00516 <span class="comment">    None.</span>
00517 <span class="comment"></span>
00518 <span class="comment">--*/</span>
00519 
00520 {
00521     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00522 
00523     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyChangeDirectory:  Entered\n"</span>, 0 );
00524 
00525     <span class="comment">//</span>
00526     <span class="comment">//  We will simply call the full notify routine to do the real work.</span>
00527     <span class="comment">//</span>
00528 
00529     <a class="code" href="../../d1/d8/fsrtl_8h.html#a172">FsRtlNotifyFullChangeDirectory</a>( NotifySync,
00530                                     NotifyList,
00531                                     FsContext,
00532                                     FullDirectoryName,
00533                                     <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>,
00534                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00535                                     CompletionFilter,
00536                                     NotifyIrp,
00537                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00538                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00539 
00540     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyChangeDirectory:  Exit\n"</span>, 0 );
00541 
00542     <span class="keywordflow">return</span>;
00543 }
00544 
00545 
00546 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00547"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a172">00547</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a172">FsRtlNotifyFullChangeDirectory</a> (
00548     IN PNOTIFY_SYNC NotifySync,
00549     IN PLIST_ENTRY NotifyList,
00550     IN PVOID FsContext,
00551     IN PSTRING FullDirectoryName,
00552     IN BOOLEAN WatchTree,
00553     IN BOOLEAN IgnoreBuffer,
00554     IN ULONG CompletionFilter,
00555     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp,
00556     IN PCHECK_FOR_TRAVERSE_ACCESS TraverseCallback OPTIONAL,
00557     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext OPTIONAL
00558     )
00559 
00560 <span class="comment">/*++</span>
00561 <span class="comment"></span>
00562 <span class="comment">Routine Description:</span>
00563 <span class="comment"></span>
00564 <span class="comment">    This routine is called by a file system which has received a NotifyChange</span>
00565 <span class="comment">    request.  This routine checks if there is already a notify structure and</span>
00566 <span class="comment">    inserts one if not present.  With a notify structure in hand, we check</span>
00567 <span class="comment">    whether we already have a pending notify and report it if so.  If there</span>
00568 <span class="comment">    is no pending notify, we check if this Irp has already been cancelled and</span>
00569 <span class="comment">    completes it if so.  Otherwise we add this to the list of Irps waiting</span>
00570 <span class="comment">    for notification.</span>
00571 <span class="comment"></span>
00572 <span class="comment">    This is the version of this routine which understands about the user's</span>
00573 <span class="comment">    buffer and will fill it in on a reported change.</span>
00574 <span class="comment"></span>
00575 <span class="comment">Arguments:</span>
00576 <span class="comment"></span>
00577 <span class="comment">    NotifySync  -  This is the controlling fast mutex for this notify list.</span>
00578 <span class="comment">        It is stored here so that it can be found for an Irp which is being</span>
00579 <span class="comment">        cancelled.</span>
00580 <span class="comment"></span>
00581 <span class="comment">    NotifyList  -  This is the start of the notify list to add this</span>
00582 <span class="comment">        structure to.</span>
00583 <span class="comment"></span>
00584 <span class="comment">    FsContext  -  This is supplied by the file system so that this notify</span>
00585 <span class="comment">        structure can be uniquely identified.  If the NotifyIrp is not specified</span>
00586 <span class="comment">        then this is used to identify the stream and it will match the FsContext</span>
00587 <span class="comment">        field in the file object of a stream being deleted.</span>
00588 <span class="comment"></span>
00589 <span class="comment">    FullDirectoryName  -  Points to the full name for the directory associated</span>
00590 <span class="comment">        with this notify structure.  Ignored if the NotifyIrp is not specified.</span>
00591 <span class="comment"></span>
00592 <span class="comment">    WatchTree  -  This indicates whether all subdirectories for this directory</span>
00593 <span class="comment">        should be watched, or just the directory itself.  Ignored if the</span>
00594 <span class="comment">        NotifyIrp is not specified.</span>
00595 <span class="comment"></span>
00596 <span class="comment">    IgnoreBuffer  -  Indicates whether we will always ignore any user buffer</span>
00597 <span class="comment">        and force the directory to be reenumerated.  This will speed up the</span>
00598 <span class="comment">        operation.  Ignored if the NotifyIrp is not specified.</span>
00599 <span class="comment"></span>
00600 <span class="comment">    CompletionFilter  -  This provides the mask to determine which operations</span>
00601 <span class="comment">        will trigger the notify operations.  Ignored if the NotifyIrp is not</span>
00602 <span class="comment">        specified.</span>
00603 <span class="comment"></span>
00604 <span class="comment">    NotifyIrp  -  This is the Irp to complete on notify change.  If this irp is</span>
00605 <span class="comment">        not specified it means that the stream represented by this file object</span>
00606 <span class="comment">        is being deleted.</span>
00607 <span class="comment"></span>
00608 <span class="comment">    TraverseCallback  -  If specified we must call this routine when a change</span>
00609 <span class="comment">        has occurred in a subdirectory being watched in a tree.  This will</span>
00610 <span class="comment">        let the filesystem check if the watcher has traverse access to that</span>
00611 <span class="comment">        directory.  Ignored if the NotifyIrp is not specified.</span>
00612 <span class="comment"></span>
00613 <span class="comment">    SubjectContext - If there is a traverse callback routine then we will</span>
00614 <span class="comment">        pass this subject context as a parameter to the call.  We will release</span>
00615 <span class="comment">        the context and free the structure when done with it.  Ignored if the</span>
00616 <span class="comment">        NotifyIrp is not specified.</span>
00617 <span class="comment"></span>
00618 <span class="comment">Return Value:</span>
00619 <span class="comment"></span>
00620 <span class="comment">    None.</span>
00621 <span class="comment"></span>
00622 <span class="comment">--*/</span>
00623 
00624 {
00625     <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a> Notify;
00626     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00627 
00628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00629 
00630     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyFullChangeDirectory:  Entered\n"</span>, 0 );
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
00634     <span class="comment">//</span>
00635 
00636     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
00637 
00638     <span class="comment">//</span>
00639     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00640     <span class="comment">//</span>
00641 
00642     <span class="keywordflow">try</span> {
00643 
00644         <span class="comment">//</span>
00645         <span class="comment">//  If there is no Irp then find all of the pending Irps whose file objects</span>
00646         <span class="comment">//  refer to the same stream and complete them with STATUS_DELETE_PENDING.</span>
00647         <span class="comment">//</span>
00648 
00649         <span class="keywordflow">if</span> (NotifyIrp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00650 
00651             <a class="code" href="../../d2/d7/notify_8c.html#a24">FsRtlCheckNotifyForDelete</a>( NotifyList, FsContext );
00652             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00653         }
00654 
00655         <span class="comment">//</span>
00656         <span class="comment">//  Get the current Stack location</span>
00657         <span class="comment">//</span>
00658 
00659         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NotifyIrp );
00660 
00661         <span class="comment">//</span>
00662         <span class="comment">//  Clear the Iosb in the Irp.</span>
00663         <span class="comment">//</span>
00664 
00665         NotifyIrp-&gt;IoStatus.Status = STATUS_SUCCESS;
00666         NotifyIrp-&gt;IoStatus.Information = 0;
00667 
00668         <span class="comment">//</span>
00669         <span class="comment">//  If the file object has already gone through cleanup, then complete</span>
00670         <span class="comment">//  the request immediately.</span>
00671         <span class="comment">//</span>
00672 
00673         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a164">FO_CLEANUP_COMPLETE</a> )) {
00674 
00675             <span class="comment">//</span>
00676             <span class="comment">//  Always mark this Irp as pending returned.</span>
00677             <span class="comment">//</span>
00678 
00679             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00680 
00681             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_CLEANUP );
00682             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00683         }
00684 
00685         <span class="comment">//</span>
00686         <span class="comment">//  If the notify structure is not already in the list, add it</span>
00687         <span class="comment">//  now.</span>
00688         <span class="comment">//</span>
00689 
00690         Notify = <a class="code" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a>( NotifyList, FsContext );
00691 
00692         <span class="keywordflow">if</span> (Notify == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00693 
00694             <span class="comment">//</span>
00695             <span class="comment">//  Allocate and initialize the structure.</span>
00696             <span class="comment">//</span>
00697 
00698             Notify = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a> ));
00699             RtlZeroMemory( Notify, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d7/notify_8c.html#a16">NOTIFY_CHANGE</a> ));
00700 
00701             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o0">NotifySync</a> = (<a class="code" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a>) NotifySync;
00702             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a> = FsContext;
00703             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o2">StreamID</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o4">FsContext</a>;
00704 
00705             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a> = TraverseCallback;
00706             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a> = SubjectContext;
00707             SubjectContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00708 
00709             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> = FullDirectoryName;
00710 
00711             InitializeListHead( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> );
00712 
00713             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>) {
00714 
00715                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a1">NOTIFY_WATCH_TREE</a> );
00716             }
00717 
00718             <span class="keywordflow">if</span> (FullDirectoryName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00719 
00720                 <span class="comment">//</span>
00721                 <span class="comment">//  In the view index we aren't using this buffer to hold a</span>
00722                 <span class="comment">//  unicode string.</span>
00723                 <span class="comment">//</span>
00724 
00725                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> );
00726 
00727             } <span class="keywordflow">else</span> {
00728 
00729                 <span class="comment">//</span>
00730                 <span class="comment">//  We look at the directory name to decide if we have a unicode</span>
00731                 <span class="comment">//  name.</span>
00732                 <span class="comment">//</span>
00733 
00734                 <span class="keywordflow">if</span> (FullDirectoryName-&gt;Length &gt;= 2
00735                     &amp;&amp; FullDirectoryName-&gt;Buffer[1] == <span class="charliteral">'\0'</span>) {
00736 
00737                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( WCHAR );
00738 
00739                 } <span class="keywordflow">else</span> {
00740 
00741                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> );
00742                 }
00743 
00744                 <span class="keywordflow">if</span> (FullDirectoryName-&gt;Length == Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
00745 
00746                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a5">NOTIFY_DIR_IS_ROOT</a> );
00747                 }
00748             }
00749 
00750             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o10">CompletionFilter</a> = CompletionFilter;
00751 
00752             <span class="comment">//</span>
00753             <span class="comment">//  If we are to return data to the user then look for the length</span>
00754             <span class="comment">//  of the original buffer in the IrpSp.</span>
00755             <span class="comment">//</span>
00756 
00757             <span class="keywordflow">if</span> (!IgnoreBuffer) {
00758 
00759                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length;
00760             }
00761 
00762             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( NotifyIrp-&gt;Tail.Overlay.Thread );
00763             InsertTailList( NotifyList, &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o6">NotifyList</a> );
00764 
00765             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> = 1;
00766 
00767         <span class="comment">//</span>
00768         <span class="comment">//  If we have already been called with cleanup then complete</span>
00769         <span class="comment">//  the request immediately.</span>
00770         <span class="comment">//</span>
00771 
00772         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a3">NOTIFY_CLEANUP_CALLED</a> )) {
00773 
00774             <span class="comment">//</span>
00775             <span class="comment">//  Always mark this Irp as pending returned.</span>
00776             <span class="comment">//</span>
00777 
00778             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00779 
00780             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_CLEANUP );
00781             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00782 
00783         <span class="comment">//</span>
00784         <span class="comment">//  If this file has been deleted then complete with STATUS_DELETE_PENDING.</span>
00785         <span class="comment">//</span>
00786 
00787         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a6">NOTIFY_STREAM_IS_DELETED</a> )) {
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">//  Always mark this Irp as pending returned.</span>
00791             <span class="comment">//</span>
00792 
00793             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00794 
00795             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_DELETE_PENDING );
00796             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">//  If the notify pending flag is set or there is data in an internal buffer</span>
00800         <span class="comment">//  we complete this Irp immediately and exit.</span>
00801         <span class="comment">//</span>
00802 
00803         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> )
00804                    &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a4">NOTIFY_DEFER_NOTIFY</a> )) {
00805 
00806             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Notify has been pending\n"</span>, 0 );
00807 
00808             <span class="comment">//</span>
00809             <span class="comment">//  Clear the flag in our notify structure before completing the</span>
00810             <span class="comment">//  Irp.  This will prevent a caller who reposts in his completion</span>
00811             <span class="comment">//  routine from looping in the completion routine.</span>
00812             <span class="comment">//</span>
00813 
00814             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> );
00815 
00816             <span class="comment">//</span>
00817             <span class="comment">//  Always mark this Irp as pending returned.</span>
00818             <span class="comment">//</span>
00819 
00820             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00821 
00822             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_ENUM_DIR );
00823             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00824 
00825         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> != 0
00826                    &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a4">NOTIFY_DEFER_NOTIFY</a> )) {
00827 
00828             ULONG ThisDataLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a>;
00829 
00830             <span class="comment">//</span>
00831             <span class="comment">//  Now set our buffer pointers back to indicate an empty buffer.</span>
00832             <span class="comment">//</span>
00833 
00834             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = 0;
00835             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = 0;
00836 
00837             <a class="code" href="../../d2/d7/notify_8c.html#a19">FsRtlNotifyCompleteIrp</a>( NotifyIrp,
00838                                     Notify,
00839                                     ThisDataLength,
00840                                     STATUS_SUCCESS,
00841                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00842 
00843             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00844         }
00845 
00846         <span class="comment">//</span>
00847         <span class="comment">//  Add the Irp to the tail of the notify queue.</span>
00848         <span class="comment">//</span>
00849 
00850         NotifyIrp-&gt;IoStatus.Information = (ULONG_PTR) Notify;
00851         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00852         InsertTailList( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>, &amp;NotifyIrp-&gt;Tail.Overlay.ListEntry );
00853 
00854         <span class="comment">//</span>
00855         <span class="comment">//  Increment the reference count to indicate that Irp might go through cancel.</span>
00856         <span class="comment">//</span>
00857 
00858         InterlockedIncrement( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> );
00859 
00860         <span class="comment">//</span>
00861         <span class="comment">//  Call the routine to set the cancel routine.</span>
00862         <span class="comment">//</span>
00863 
00864         <a class="code" href="../../d2/d7/notify_8c.html#a20">FsRtlNotifySetCancelRoutine</a>( NotifyIrp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00865 
00866     try_exit:  NOTHING;
00867     } finally {
00868 
00869         <span class="comment">//</span>
00870         <span class="comment">//  Release the mutex.</span>
00871         <span class="comment">//</span>
00872 
00873         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
00874 
00875         <span class="comment">//</span>
00876         <span class="comment">//  If there is still a subject context then release it and deallocate</span>
00877         <span class="comment">//  the structure.  Remember that if FullDirectoryName is null, it means</span>
00878         <span class="comment">//  this is a view index, not a directory index, and the SubjectContext</span>
00879         <span class="comment">//  is really a piece of file system context information.</span>
00880         <span class="comment">//</span>
00881 
00882         <span class="keywordflow">if</span> ((SubjectContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00883             (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00884 
00885             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( SubjectContext );
00886             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContext );
00887         }
00888 
00889         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyFullChangeDirectory:  Exit\n"</span>, 0 );
00890     }
00891 
00892     <span class="keywordflow">return</span>;
00893 }
00894 
00895 
00896 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00897"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a173">00897</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a173">FsRtlNotifyReportChange</a> (
00898     IN PNOTIFY_SYNC NotifySync,
00899     IN PLIST_ENTRY NotifyList,
00900     IN PSTRING FullTargetName,
00901     IN PSTRING TargetName,
00902     IN ULONG FilterMatch
00903     )
00904 
00905 <span class="comment">/*++</span>
00906 <span class="comment"></span>
00907 <span class="comment">Routine Description:</span>
00908 <span class="comment"></span>
00909 <span class="comment">    This routine is called by a file system when a file has been modified in</span>
00910 <span class="comment">    such a way that it will cause a notify change Irp to complete.  We walk</span>
00911 <span class="comment">    through all the notify structures looking for those structures which</span>
00912 <span class="comment">    would be associated with an ancestor directory of the target file name.</span>
00913 <span class="comment"></span>
00914 <span class="comment">    We look for all the notify structures which have a filter match and</span>
00915 <span class="comment">    then check that the directory name in the notify structure is a</span>
00916 <span class="comment">    proper prefix of the full target name.</span>
00917 <span class="comment"></span>
00918 <span class="comment">    If we find a notify structure which matches the above conditions, we</span>
00919 <span class="comment">    complete all the Irps for the notify structure.  If the structure has</span>
00920 <span class="comment">    no Irps, we mark the notify pending field.</span>
00921 <span class="comment"></span>
00922 <span class="comment">Arguments:</span>
00923 <span class="comment"></span>
00924 <span class="comment">    NotifySync  -  This is the controlling fast mutex for this notify list.</span>
00925 <span class="comment">        It is stored here so that it can be found for an Irp which is being</span>
00926 <span class="comment">        cancelled.</span>
00927 <span class="comment"></span>
00928 <span class="comment">    NotifyList  -  This is the start of the notify list to add this</span>
00929 <span class="comment">                   structure to.</span>
00930 <span class="comment"></span>
00931 <span class="comment">    FullTargetName  -  This is the full name of the file which has been</span>
00932 <span class="comment">                       changed.</span>
00933 <span class="comment"></span>
00934 <span class="comment">    TargetName  -  This is the final component of the modified file.</span>
00935 <span class="comment"></span>
00936 <span class="comment">    FilterMatch  -  This flag field is compared with the completion filter</span>
00937 <span class="comment">                    in the notify structure.  If any of the corresponding</span>
00938 <span class="comment">                    bits in the completion filter are set, then a notify</span>
00939 <span class="comment">                    condition exists.</span>
00940 <span class="comment"></span>
00941 <span class="comment">Return Value:</span>
00942 <span class="comment"></span>
00943 <span class="comment">    None.</span>
00944 <span class="comment"></span>
00945 <span class="comment">--*/</span>
00946 
00947 {
00948     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00949 
00950     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyReportChange:  Entered\n"</span>, 0 );
00951 
00952     <span class="comment">//</span>
00953     <span class="comment">//  Call the full notify routine to do the actual work.</span>
00954     <span class="comment">//</span>
00955 
00956     <a class="code" href="../../d1/d8/fsrtl_8h.html#a174">FsRtlNotifyFullReportChange</a>( NotifySync,
00957                                  NotifyList,
00958                                  FullTargetName,
00959                                  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (FullTargetName-&gt;Length - TargetName-&gt;Length),
00960                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00961                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00962                                  FilterMatch,
00963                                  0,
00964                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00965 
00966     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyReportChange:  Exit\n"</span>, 0 );
00967 
00968     <span class="keywordflow">return</span>;
00969 }
00970 
00971 
00972 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00973"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a174">00973</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a174">FsRtlNotifyFullReportChange</a> (
00974     IN PNOTIFY_SYNC NotifySync,
00975     IN PLIST_ENTRY NotifyList,
00976     IN PSTRING FullTargetName,
00977     IN USHORT TargetNameOffset,
00978     IN PSTRING StreamName OPTIONAL,
00979     IN PSTRING NormalizedParentName OPTIONAL,
00980     IN ULONG FilterMatch,
00981     IN ULONG Action,
00982     IN PVOID TargetContext
00983     )
00984 
00985 <span class="comment">/*++</span>
00986 <span class="comment"></span>
00987 <span class="comment">Routine Description:</span>
00988 <span class="comment"></span>
00989 <span class="comment">    This routine is called by a file system when a file has been modified in</span>
00990 <span class="comment">    such a way that it will cause a notify change Irp to complete.  We walk</span>
00991 <span class="comment">    through all the notify structures looking for those structures which</span>
00992 <span class="comment">    would be associated with an ancestor directory of the target file name.</span>
00993 <span class="comment"></span>
00994 <span class="comment">    We look for all the notify structures which have a filter match and</span>
00995 <span class="comment">    then check that the directory name in the notify structure is a</span>
00996 <span class="comment">    proper prefix of the full target name.</span>
00997 <span class="comment"></span>
00998 <span class="comment">    If we find a notify structure which matches the above conditions, we</span>
00999 <span class="comment">    complete all the Irps for the notify structure.  If the structure has</span>
01000 <span class="comment">    no Irps, we mark the notify pending field.</span>
01001 <span class="comment"></span>
01002 <span class="comment">Arguments:</span>
01003 <span class="comment"></span>
01004 <span class="comment">    NotifySync  -  This is the controlling fast mutex for this notify list.</span>
01005 <span class="comment">        It is stored here so that it can be found for an Irp which is being</span>
01006 <span class="comment">        cancelled.</span>
01007 <span class="comment"></span>
01008 <span class="comment">    NotifyList  -  This is the start of the notify list to add this</span>
01009 <span class="comment">        structure to.</span>
01010 <span class="comment"></span>
01011 <span class="comment">    FullTargetName - This is the full name of the file from the root of the volume.</span>
01012 <span class="comment"></span>
01013 <span class="comment">    TargetNameOffset - This is the offset in the full name of the final component</span>
01014 <span class="comment">        of the name.</span>
01015 <span class="comment"></span>
01016 <span class="comment">    StreamName  -  If present then this is the stream name to store with</span>
01017 <span class="comment">        the filename.</span>
01018 <span class="comment"></span>
01019 <span class="comment">    NormalizedParentName  -  If present this is the same path as the parent name</span>
01020 <span class="comment">        but the DOS-ONLY names have been replaced with the associated long name.</span>
01021 <span class="comment"></span>
01022 <span class="comment">    FilterMatch  -  This flag field is compared with the completion filter</span>
01023 <span class="comment">        in the notify structure.  If any of the corresponding bits in the</span>
01024 <span class="comment">        completion filter are set, then a notify condition exists.</span>
01025 <span class="comment"></span>
01026 <span class="comment">    Action  -  This is the action code to store in the user's buffer if</span>
01027 <span class="comment">        present.</span>
01028 <span class="comment"></span>
01029 <span class="comment">    TargetContext  -  This is one of the context pointers to pass to the file</span>
01030 <span class="comment">        system if performing a traverse check in the case of a tree being</span>
01031 <span class="comment">        watched.</span>
01032 <span class="comment"></span>
01033 <span class="comment">Return Value:</span>
01034 <span class="comment"></span>
01035 <span class="comment">    None.</span>
01036 <span class="comment"></span>
01037 <span class="comment">--*/</span>
01038 
01039 {
01040     PLIST_ENTRY NotifyLinks;
01041 
01042     STRING NormalizedParent;
01043     STRING ParentName;
01044     STRING TargetName;
01045 
01046     <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a> Notify;
01047     STRING TargetParent;
01048     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp;
01049 
01050     BOOLEAN NotifyIsParent;
01051     BOOLEAN ViewIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01052     UCHAR ComponentCount;
01053     ULONG SizeOfEntry;
01054     ULONG CurrentOffset;
01055     ULONG NextEntryOffset;
01056     ULONG ExceptionCode;
01057 
01058     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01059 
01060     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Entered\n"</span>, 0 );
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">//  If this is a change to the root directory then return immediately.</span>
01064     <span class="comment">//</span>
01065 
01066     <span class="keywordflow">if</span> ((TargetNameOffset == 0) &amp;&amp; (FullTargetName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01067 
01068         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Exit\n"</span>, 0 );
01069         <span class="keywordflow">return</span>;
01070     }
01071 
01072     ParentName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01073     TargetName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
01077     <span class="comment">//</span>
01078 
01079     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01083     <span class="comment">//</span>
01084 
01085     <span class="keywordflow">try</span> {
01086 
01087         <span class="comment">//</span>
01088         <span class="comment">//  Walk through all the notify blocks.</span>
01089         <span class="comment">//</span>
01090 
01091         <span class="keywordflow">for</span> (NotifyLinks = NotifyList-&gt;Flink;
01092              NotifyLinks != NotifyList;
01093              NotifyLinks = NotifyLinks-&gt;Flink) {
01094 
01095             <span class="comment">//</span>
01096             <span class="comment">//  Obtain the Notify structure from the list entry.</span>
01097             <span class="comment">//</span>
01098 
01099             Notify = CONTAINING_RECORD( NotifyLinks, <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>, NotifyList );
01100 
01101             <span class="comment">//</span>
01102             <span class="comment">//  The rules for deciding whether this notification applies are</span>
01103             <span class="comment">//  different for view indices versus file name indices (directories).</span>
01104             <span class="comment">//</span>
01105 
01106             <span class="keywordflow">if</span> (FullTargetName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01107 
01108                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"Directory notify handle in view index notify list!"</span>, Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01109 
01110                 <span class="comment">//</span>
01111                 <span class="comment">//  Make sure this is the Fcb being watched.</span>
01112                 <span class="comment">//</span>
01113 
01114                 <span class="keywordflow">if</span> (TargetContext != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>) {
01115 
01116                     <span class="keywordflow">continue</span>;
01117                 }
01118 
01119                 TargetParent.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01120                 TargetParent.Length = 0;
01121 
01122                 ViewIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01123 
01124             <span class="comment">//</span>
01125             <span class="comment">//  Handle the directory case.</span>
01126             <span class="comment">//</span>
01127 
01128             } <span class="keywordflow">else</span> {
01129 
01130                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"View index notify handle in directory notify list!"</span>, Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01131 
01132                 <span class="comment">//</span>
01133                 <span class="comment">//  If the length of the name in the notify block is currently zero then</span>
01134                 <span class="comment">//  someone is doing a rename and we can skip this block.</span>
01135                 <span class="comment">//</span>
01136 
01137                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length == 0) {
01138 
01139                     <span class="keywordflow">continue</span>;
01140                 }
01141 
01142                 <span class="comment">//</span>
01143                 <span class="comment">//  If this filter match is not part of the completion filter then continue.</span>
01144                 <span class="comment">//</span>
01145 
01146                 <span class="keywordflow">if</span> (!(FilterMatch &amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o10">CompletionFilter</a>)) {
01147 
01148                     <span class="keywordflow">continue</span>;
01149                 }
01150 
01151                 <span class="comment">//</span>
01152                 <span class="comment">//  If there is no normalized name then set its value from the full</span>
01153                 <span class="comment">//  file name.</span>
01154                 <span class="comment">//</span>
01155 
01156                 <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( NormalizedParentName )) {
01157                     NormalizedParent.Buffer = FullTargetName-&gt;Buffer;
01158                     NormalizedParent.Length = TargetNameOffset;
01159 
01160                     <span class="keywordflow">if</span> (NormalizedParent.Length != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
01161 
01162                         NormalizedParent.Length -= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01163                     }
01164 
01165                     NormalizedParent.MaximumLength = NormalizedParent.Length;
01166 
01167                     NormalizedParentName = &amp;NormalizedParent;
01168                 }
01169 
01170                 <span class="comment">//</span>
01171                 <span class="comment">//  If the length of the directory being watched is longer than the</span>
01172                 <span class="comment">//  parent of the modified file then it can't be an ancestor of the</span>
01173                 <span class="comment">//  modified file.</span>
01174                 <span class="comment">//</span>
01175 
01176                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length &gt; NormalizedParentName-&gt;Length) {
01177 
01178                     <span class="keywordflow">continue</span>;
01179                 }
01180 
01181                 <span class="comment">//</span>
01182                 <span class="comment">//  If the lengths match exactly then this can only be the parent of</span>
01183                 <span class="comment">//  the modified file.</span>
01184                 <span class="comment">//</span>
01185 
01186                 <span class="keywordflow">if</span> (NormalizedParentName-&gt;Length == Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length) {
01187 
01188                     NotifyIsParent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189 
01190                 <span class="comment">//</span>
01191                 <span class="comment">//  If we are not watching the subtree of this directory then continue.</span>
01192                 <span class="comment">//</span>
01193 
01194                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a1">NOTIFY_WATCH_TREE</a> )) {
01195 
01196                     <span class="keywordflow">continue</span>;
01197 
01198                 <span class="comment">//</span>
01199                 <span class="comment">//  The watched directory can only be an ancestor of the modified</span>
01200                 <span class="comment">//  file.  Make sure that there is legal pathname separator immediately</span>
01201                 <span class="comment">//  after the end of the watched directory name within the normalized name.</span>
01202                 <span class="comment">//  If the watched directory is the root then we know this condition is TRUE.</span>
01203                 <span class="comment">//</span>
01204 
01205                 } <span class="keywordflow">else</span> {
01206 
01207                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a5">NOTIFY_DIR_IS_ROOT</a> )) {
01208 
01209                         <span class="comment">//</span>
01210                         <span class="comment">//  Check for the character size.</span>
01211                         <span class="comment">//</span>
01212 
01213                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01214 
01215                             <span class="keywordflow">if</span> (*(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01216                                            Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length,
01217                                            PCHAR )) != <span class="charliteral">'\\'</span>) {
01218 
01219                                 <span class="keywordflow">continue</span>;
01220                             }
01221 
01222                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01223                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length,
01224                                               PWCHAR )) != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01225 
01226                             <span class="keywordflow">continue</span>;
01227                         }
01228                     }
01229 
01230                     NotifyIsParent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01231                 }
01232 
01233                 <span class="comment">//</span>
01234                 <span class="comment">//  We now have a correct match of the name lengths.  Now verify that the</span>
01235                 <span class="comment">//  characters match exactly.</span>
01236                 <span class="comment">//</span>
01237 
01238                 <span class="keywordflow">if</span> (!RtlEqualMemory( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer,
01239                                      NormalizedParentName-&gt;Buffer,
01240                                      Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length )) {
01241 
01242                     <span class="keywordflow">continue</span>;
01243                 }
01244 
01245                 <span class="comment">//</span>
01246                 <span class="comment">//  The characters are correct.  Now check in the case of a non-parent</span>
01247                 <span class="comment">//  notify that we have traverse callback.</span>
01248                 <span class="comment">//</span>
01249 
01250                 <span class="keywordflow">if</span> (!NotifyIsParent &amp;&amp;
01251                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01252                     !Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a>,
01253                                                TargetContext,
01254                                                Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a> )) {
01255 
01256                     <span class="keywordflow">continue</span>;
01257                 }
01258             }
01259 
01260             <span class="comment">//</span>
01261             <span class="comment">//  If this entry is going into a buffer then check that</span>
01262             <span class="comment">//  it will fit.</span>
01263             <span class="comment">//</span>
01264 
01265             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> )
01266                 &amp;&amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a> != 0) {
01267 
01268                 ULONG AllocationLength;
01269 
01270                 AllocationLength = 0;
01271                 NotifyIrp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01272 
01273                 <span class="comment">//</span>
01274                 <span class="comment">//  If we don't already have a buffer then check to see</span>
01275                 <span class="comment">//  if we have any Irps in the list and use the buffer</span>
01276                 <span class="comment">//  length in the Irp.</span>
01277                 <span class="comment">//</span>
01278 
01279                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> == 0) {
01280 
01281                     <span class="comment">//</span>
01282                     <span class="comment">//  If there is an entry in the list then get the length.</span>
01283                     <span class="comment">//</span>
01284 
01285                     <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01286 
01287                         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01288 
01289                         NotifyIrp = CONTAINING_RECORD( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>.Flink,
01290                                                        <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
01291                                                        Tail.Overlay.ListEntry );
01292 
01293                         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NotifyIrp );
01294 
01295                         AllocationLength = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length;
01296 
01297                     <span class="comment">//</span>
01298                     <span class="comment">//  Otherwise use the caller's last buffer size.</span>
01299                     <span class="comment">//</span>
01300 
01301                     } <span class="keywordflow">else</span> {
01302 
01303                         AllocationLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>;
01304                     }
01305 
01306                 <span class="comment">//</span>
01307                 <span class="comment">//  Otherwise use the length of the current buffer.</span>
01308                 <span class="comment">//</span>
01309 
01310                 } <span class="keywordflow">else</span> {
01311 
01312                     AllocationLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a>;
01313                 }
01314 
01315                 <span class="comment">//</span>
01316                 <span class="comment">//  Build the strings for the relative name.  This includes</span>
01317                 <span class="comment">//  the strings for the parent name, file name and stream</span>
01318                 <span class="comment">//  name.</span>
01319                 <span class="comment">//</span>
01320 
01321                 <span class="keywordflow">if</span> (!NotifyIsParent) {
01322 
01323                     <span class="comment">//</span>
01324                     <span class="comment">//  We need to find the string for the ancestor of this</span>
01325                     <span class="comment">//  file from the watched directory.  If the normalized parent</span>
01326                     <span class="comment">//  name is the same as the parent name then we can use</span>
01327                     <span class="comment">//  the tail of the parent directly.  Otherwise we need to</span>
01328                     <span class="comment">//  count the matching name components and capture the</span>
01329                     <span class="comment">//  final components.</span>
01330                     <span class="comment">//</span>
01331 
01332                     <span class="keywordflow">if</span> (!ViewIndex) {
01333 
01334                         <span class="comment">//</span>
01335                         <span class="comment">//  If the watched directory is the root then we just use the full</span>
01336                         <span class="comment">//  parent name.</span>
01337                         <span class="comment">//</span>
01338 
01339                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a5">NOTIFY_DIR_IS_ROOT</a> ) ||
01340                             NormalizedParentName-&gt;Buffer != FullTargetName-&gt;Buffer) {
01341 
01342                             <span class="comment">//</span>
01343                             <span class="comment">//  If we don't have a string for the parent then construct</span>
01344                             <span class="comment">//  it now.</span>
01345                             <span class="comment">//</span>
01346 
01347                             <span class="keywordflow">if</span> (ParentName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01348 
01349                                 ParentName.Buffer = FullTargetName-&gt;Buffer;
01350                                 ParentName.Length = TargetNameOffset;
01351 
01352                                 <span class="keywordflow">if</span> (ParentName.Length != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
01353 
01354                                     ParentName.Length -= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01355                                 }
01356 
01357                                 ParentName.MaximumLength = ParentName.Length;
01358                             }
01359 
01360                             <span class="comment">//</span>
01361                             <span class="comment">//  Count through the components of the parent until we have</span>
01362                             <span class="comment">//  swallowed the same number of name components as in the</span>
01363                             <span class="comment">//  watched directory name.  We have the unicode version and</span>
01364                             <span class="comment">//  the Ansi version to watch for.</span>
01365                             <span class="comment">//</span>
01366 
01367                             ComponentCount = 0;
01368                             CurrentOffset = 0;
01369 
01370                             <span class="comment">//</span>
01371                             <span class="comment">//  If this is the root then there is no more to do.</span>
01372                             <span class="comment">//</span>
01373 
01374                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a5">NOTIFY_DIR_IS_ROOT</a> )) {
01375 
01376                                 NOTHING;
01377 
01378                             } <span class="keywordflow">else</span> {
01379 
01380                                 ULONG ParentComponentCount;
01381                                 ULONG ParentOffset;
01382 
01383                                 ParentComponentCount = 1;
01384                                 ParentOffset = 0;
01385 
01386                                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01387 
01388                                     <span class="comment">//</span>
01389                                     <span class="comment">//  Find the number of components in the parent.  We</span>
01390                                     <span class="comment">//  have to do this for each one because this name and</span>
01391                                     <span class="comment">//  the number of components could have changed.</span>
01392                                     <span class="comment">//</span>
01393 
01394                                     <span class="keywordflow">while</span> (ParentOffset &lt; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length) {
01395 
01396                                         <span class="keywordflow">if</span> (*((PCHAR) Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer + ParentOffset) == <span class="charliteral">'\\'</span>) {
01397 
01398                                             ParentComponentCount += 1;
01399                                         }
01400 
01401                                         ParentOffset += 1;
01402                                     }
01403 
01404                                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01405 
01406                                         <span class="keywordflow">if</span> (*((PCHAR) ParentName.Buffer + CurrentOffset) == <span class="charliteral">'\\'</span>) {
01407 
01408                                             ComponentCount += 1;
01409 
01410                                             <span class="keywordflow">if</span> (ComponentCount == ParentComponentCount) {
01411 
01412                                                 <span class="keywordflow">break</span>;
01413                                             }
01414 
01415                                         }
01416 
01417                                         CurrentOffset += 1;
01418                                     }
01419 
01420                                 } <span class="keywordflow">else</span> {
01421 
01422                                     <span class="comment">//</span>
01423                                     <span class="comment">//  Find the number of components in the parent.  We</span>
01424                                     <span class="comment">//  have to do this for each one because this name and</span>
01425                                     <span class="comment">//  the number of components could have changed.</span>
01426                                     <span class="comment">//</span>
01427 
01428                                     <span class="keywordflow">while</span> (ParentOffset &lt; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length / <span class="keyword">sizeof</span>( WCHAR )) {
01429 
01430                                         <span class="keywordflow">if</span> (*((PWCHAR) Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer + ParentOffset) == <span class="charliteral">'\\'</span>) {
01431 
01432                                             ParentComponentCount += 1;
01433                                         }
01434 
01435                                         ParentOffset += 1;
01436                                     }
01437 
01438                                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01439 
01440                                         <span class="keywordflow">if</span> (*((PWCHAR) ParentName.Buffer + CurrentOffset) == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01441 
01442                                             ComponentCount += 1;
01443 
01444                                             <span class="keywordflow">if</span> (ComponentCount == ParentComponentCount) {
01445 
01446                                                 <span class="keywordflow">break</span>;
01447                                             }
01448                                         }
01449 
01450                                         CurrentOffset += 1;
01451                                     }
01452 
01453                                     <span class="comment">//</span>
01454                                     <span class="comment">//  Convert characters to bytes.</span>
01455                                     <span class="comment">//</span>
01456 
01457                                     CurrentOffset *= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01458                                 }
01459                             }
01460 
01461                             <span class="comment">//</span>
01462                             <span class="comment">//  We now know the offset into the parent name of the separator</span>
01463                             <span class="comment">//  immediately preceding the relative parent name.  Construct the</span>
01464                             <span class="comment">//  target parent name for the buffer.</span>
01465                             <span class="comment">//</span>
01466 
01467                             CurrentOffset += Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01468 
01469                             TargetParent.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ParentName.Buffer,
01470                                                            CurrentOffset,
01471                                                            PCHAR );
01472                             TargetParent.MaximumLength =
01473                             TargetParent.Length = ParentName.Length - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) CurrentOffset;
01474 
01475                         <span class="comment">//</span>
01476                         <span class="comment">//  If the normalized is the same as the parent name use the portion</span>
01477                         <span class="comment">//  after the match with the watched directory.</span>
01478                         <span class="comment">//</span>
01479 
01480                         } <span class="keywordflow">else</span> {
01481 
01482                             TargetParent.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01483                                                            (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length +
01484                                                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>),
01485                                                            PCHAR );
01486 
01487                             TargetParent.MaximumLength =
01488                             TargetParent.Length = NormalizedParentName-&gt;Length -
01489                                                   Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length -
01490                                                   Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01491 
01492                         }
01493                     }
01494 
01495                 } <span class="keywordflow">else</span> {
01496 
01497                     <span class="comment">//</span>
01498                     <span class="comment">//  The length of the target parent is zero.</span>
01499                     <span class="comment">//</span>
01500 
01501                     TargetParent.Length = 0;
01502                 }
01503 
01504                 <span class="comment">//</span>
01505                 <span class="comment">//  Compute how much buffer space this report will take.</span>
01506                 <span class="comment">//</span>
01507 
01508                 SizeOfEntry = FIELD_OFFSET( FILE_NOTIFY_INFORMATION, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> );
01509 
01510                 <span class="keywordflow">if</span> (ViewIndex) {
01511 
01512                     <span class="comment">//</span>
01513                     <span class="comment">//  In the view index case, the information to copy to the</span>
01514                     <span class="comment">//  buffer comes to us in the stream name, and that is all</span>
01515                     <span class="comment">//  the room we need to worry about having.</span>
01516                     <span class="comment">//</span>
01517 
01518                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT( StreamName ));
01519 
01520                     SizeOfEntry += StreamName-&gt;Length;
01521 
01522                 } <span class="keywordflow">else</span> {
01523 
01524                     <span class="comment">//</span>
01525                     <span class="comment">//  If there is a parent to report, find the size and include a separator</span>
01526                     <span class="comment">//  character.</span>
01527                     <span class="comment">//</span>
01528 
01529                     <span class="keywordflow">if</span> (!NotifyIsParent) {
01530 
01531                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01532 
01533                             SizeOfEntry += RtlOemStringToCountedUnicodeSize( &amp;TargetParent );
01534 
01535                         } <span class="keywordflow">else</span> {
01536 
01537                             SizeOfEntry += TargetParent.Length;
01538                         }
01539 
01540                         <span class="comment">//</span>
01541                         <span class="comment">//  Include the separator.  This is always a unicode character.</span>
01542                         <span class="comment">//</span>
01543 
01544                         SizeOfEntry += <span class="keyword">sizeof</span>( WCHAR );
01545                     }
01546 
01547                     <span class="comment">//</span>
01548                     <span class="comment">//  If we don't have the string for the target then construct it now.</span>
01549                     <span class="comment">//</span>
01550 
01551                     <span class="keywordflow">if</span> (TargetName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01552 
01553                         TargetName.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( FullTargetName-&gt;Buffer, TargetNameOffset, PCHAR );
01554                         TargetName.MaximumLength =
01555                         TargetName.Length = FullTargetName-&gt;Length - TargetNameOffset;
01556                     }
01557 
01558                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01559 
01560                         SizeOfEntry += RtlOemStringToCountedUnicodeSize( &amp;TargetName );
01561 
01562                     } <span class="keywordflow">else</span> {
01563 
01564                         SizeOfEntry += TargetName.Length;
01565                     }
01566 
01567                     <span class="comment">//</span>
01568                     <span class="comment">//  If there is a stream name then add the bytes needed</span>
01569                     <span class="comment">//  for that.</span>
01570                     <span class="comment">//</span>
01571 
01572                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StreamName )) {
01573 
01574                         <span class="comment">//</span>
01575                         <span class="comment">//  Add the space needed for the ':' separator.</span>
01576                         <span class="comment">//</span>
01577 
01578                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( WCHAR )) {
01579 
01580                             SizeOfEntry += (StreamName-&gt;Length + <span class="keyword">sizeof</span>( WCHAR ));
01581 
01582                         } <span class="keywordflow">else</span> {
01583 
01584                             SizeOfEntry += (RtlOemStringToCountedUnicodeSize( StreamName )
01585                                             + <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ));
01586                         }
01587                     }
01588                 }
01589 
01590                 <span class="comment">//</span>
01591                 <span class="comment">//  Remember if this report would overflow the buffer.</span>
01592                 <span class="comment">//</span>
01593 
01594                 NextEntryOffset = (ULONG)<a class="code" href="../../d3/d8/fsrtlp_8h.html#a10">LongAlign</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> );
01595 
01596                 <span class="keywordflow">if</span> (SizeOfEntry &lt;= AllocationLength
01597                     &amp;&amp; (NextEntryOffset + SizeOfEntry) &lt;= AllocationLength) {
01598 
01599                     PFILE_NOTIFY_INFORMATION NotifyInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01600 
01601                     <span class="comment">//</span>
01602                     <span class="comment">//  If there is already a notify buffer, we append this</span>
01603                     <span class="comment">//  data to it.</span>
01604                     <span class="comment">//</span>
01605 
01606                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01607 
01608                         NotifyInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>,
01609                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>,
01610                                               PFILE_NOTIFY_INFORMATION );
01611 
01612                         NotifyInfo-&gt;NextEntryOffset = NextEntryOffset - Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>;
01613 
01614                         Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = NextEntryOffset;
01615 
01616                         NotifyInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>,
01617                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>,
01618                                               PFILE_NOTIFY_INFORMATION );
01619 
01620                     <span class="comment">//</span>
01621                     <span class="comment">//  If there is an Irp list we check whether we will need</span>
01622                     <span class="comment">//  to allocate a new buffer.</span>
01623                     <span class="comment">//</span>
01624 
01625                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01626 
01627                         <span class="keywordflow">if</span> (NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01628 
01629                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> =
01630                             NotifyInfo = NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
01631 
01632                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01633 
01634                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01635 
01636                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> =
01637                             NotifyInfo = <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
01638 
01639                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01640                         }
01641                     }
01642 
01643                     <span class="comment">//</span>
01644                     <span class="comment">//  If we need to allocate a buffer, we will charge quota</span>
01645                     <span class="comment">//  to the original process and allocate paged pool.</span>
01646                     <span class="comment">//</span>
01647 
01648                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01649 
01650                         BOOLEAN ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01651 
01652                         <span class="keywordflow">try</span> {
01653 
01654                             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01655                                                <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01656                                                AllocationLength );
01657 
01658                             ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01659 
01660                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> =
01661                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01662                                                                  AllocationLength );
01663 
01664                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01665 
01666                             NotifyInfo = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>;
01667 
01668                         } except(( ExceptionCode = GetExceptionCode(), <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(ExceptionCode))
01669                                   ? <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>
01670                                   : <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> ) {
01671 
01672                             
01673                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ExceptionCode == STATUS_INSUFFICIENT_RESOURCES) ||
01674                                     (ExceptionCode == STATUS_QUOTA_EXCEEDED) );
01675 
01676                             <span class="comment">//</span>
01677                             <span class="comment">//  Return quota if we allocated the buffer.</span>
01678                             <span class="comment">//</span>
01679 
01680                             <span class="keywordflow">if</span> (ChargedQuota) {
01681 
01682                                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01683                                                    <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01684                                                    AllocationLength );
01685 
01686                             }
01687 
01688                             <span class="comment">//</span>
01689                             <span class="comment">//  Forget any current buffer and resort to immediate</span>
01690                             <span class="comment">//  notify.</span>
01691                             <span class="comment">//</span>
01692 
01693                             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> );
01694                         }
01695                     }
01696 
01697                     <span class="comment">//</span>
01698                     <span class="comment">//  If we have a buffer then fill in the results</span>
01699                     <span class="comment">//  from this operation.  Otherwise we remember</span>
01700                     <span class="comment">//  to simply alert the caller.</span>
01701                     <span class="comment">//</span>
01702 
01703                     <span class="keywordflow">if</span> (NotifyInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01704 
01705                         <span class="comment">//</span>
01706                         <span class="comment">//  Update the buffer with the current data.</span>
01707                         <span class="comment">//</span>
01708 
01709                         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/notify_8c.html#a21">FsRtlNotifyUpdateBuffer</a>( NotifyInfo,
01710                                                      <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>,
01711                                                      &amp;TargetParent,
01712                                                      &amp;TargetName,
01713                                                      StreamName,
01714                                                      (BOOLEAN) (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( WCHAR )),
01715                                                      SizeOfEntry )) {
01716 
01717                             <span class="comment">//</span>
01718                             <span class="comment">//  Update the buffer data length.</span>
01719                             <span class="comment">//</span>
01720 
01721                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = NextEntryOffset + SizeOfEntry;
01722 
01723                         <span class="comment">//</span>
01724                         <span class="comment">//  We couldn't copy the data into the buffer.  Just</span>
01725                         <span class="comment">//  notify without any additional information.</span>
01726                         <span class="comment">//</span>
01727 
01728                         } <span class="keywordflow">else</span> {
01729 
01730                             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> );
01731                         }
01732                     }
01733 
01734                 } <span class="keywordflow">else</span> {
01735 
01736                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> );
01737                 }
01738 
01739                 <span class="comment">//</span>
01740                 <span class="comment">//  If we have a buffer but can't use it then clear all of the</span>
01741                 <span class="comment">//  buffer related fields.  Also deallocate any buffer allocated</span>
01742                 <span class="comment">//  by us.</span>
01743                 <span class="comment">//</span>
01744 
01745                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> )
01746                     &amp;&amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01747 
01748                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01749 
01750                         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01751                                            <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01752                                            Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> );
01753 
01754                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> );
01755                     }
01756 
01757                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01758 
01759                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = 0;
01760                 }
01761             }
01762 
01763             <span class="comment">//</span>
01764             <span class="comment">//  Complete the next entry on the list if we aren't holding</span>
01765             <span class="comment">//  up notification.</span>
01766             <span class="comment">//</span>
01767 
01768             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == FILE_ACTION_RENAMED_OLD_NAME) {
01769 
01770                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a4">NOTIFY_DEFER_NOTIFY</a> );
01771 
01772             } <span class="keywordflow">else</span> {
01773 
01774                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a4">NOTIFY_DEFER_NOTIFY</a> );
01775 
01776                 <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01777 
01778                     <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a>( Notify, STATUS_SUCCESS );
01779                 }
01780             }
01781         }
01782 
01783     } finally {
01784 
01785         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
01786 
01787         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Exit\n"</span>, 0 );
01788     }
01789 
01790     <span class="keywordflow">return</span>;
01791 }
01792 
01793 
01794 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01795"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a175">01795</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a175">FsRtlNotifyCleanup</a> (
01796     IN PNOTIFY_SYNC NotifySync,
01797     IN PLIST_ENTRY NotifyList,
01798     IN PVOID FsContext
01799     )
01800 
01801 <span class="comment">/*++</span>
01802 <span class="comment"></span>
01803 <span class="comment">Routine Description:</span>
01804 <span class="comment"></span>
01805 <span class="comment">    This routine is called for a cleanup of a user directory handle.  We</span>
01806 <span class="comment">    walk through our notify structures looking for a matching context field.</span>
01807 <span class="comment">    We complete all the pending notify Irps for this Notify structure, remove</span>
01808 <span class="comment">    the notify structure and deallocate it.</span>
01809 <span class="comment"></span>
01810 <span class="comment">Arguments:</span>
01811 <span class="comment"></span>
01812 <span class="comment">    NotifySync  -  This is the controlling fast mutex for this notify list.</span>
01813 <span class="comment">        It is stored here so that it can be found for an Irp which is being</span>
01814 <span class="comment">        cancelled.</span>
01815 <span class="comment"></span>
01816 <span class="comment">    NotifyList  -  This is the start of the notify list to add this</span>
01817 <span class="comment">                   structure to.</span>
01818 <span class="comment"></span>
01819 <span class="comment">    FsContext  -  This is a unique value assigned by the file system to</span>
01820 <span class="comment">                  identify a particular notify structure.</span>
01821 <span class="comment"></span>
01822 <span class="comment">Return Value:</span>
01823 <span class="comment"></span>
01824 <span class="comment">    None.</span>
01825 <span class="comment"></span>
01826 <span class="comment">--*/</span>
01827 
01828 {
01829     <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a> Notify;
01830     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01831 
01832     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01833 
01834     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyCleanup:  Entered\n"</span>, 0 );
01835     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Mutex             -&gt; %08lx\n"</span>, Mutex );
01836     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Notify List       -&gt; %08lx\n"</span>, NotifyList );
01837     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsContext         -&gt; %08lx\n"</span>, FsContext );
01838 
01839     <span class="comment">//</span>
01840     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
01841     <span class="comment">//</span>
01842 
01843     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
01844 
01845     <span class="comment">//</span>
01846     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01847     <span class="comment">//</span>
01848 
01849     <span class="keywordflow">try</span> {
01850 
01851         <span class="comment">//</span>
01852         <span class="comment">//  Search for a match on the list.</span>
01853         <span class="comment">//</span>
01854 
01855         Notify = <a class="code" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a>( NotifyList, FsContext );
01856 
01857         <span class="comment">//</span>
01858         <span class="comment">//  If found, then complete all the Irps with STATUS_NOTIFY_CLEANUP</span>
01859         <span class="comment">//</span>
01860 
01861         <span class="keywordflow">if</span> (Notify != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01862 
01863             <span class="comment">//</span>
01864             <span class="comment">//  Set the flag to indicate that we have been called with cleanup.</span>
01865             <span class="comment">//</span>
01866 
01867             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a3">NOTIFY_CLEANUP_CALLED</a> );
01868 
01869             <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01870 
01871                 <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a>( Notify, STATUS_NOTIFY_CLEANUP );
01872             }
01873 
01874             RemoveEntryList( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o6">NotifyList</a> );
01875 
01876             InterlockedDecrement( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> );
01877 
01878             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> == 0) {
01879                 
01880                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01881 
01882                     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01883                                        <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01884                                        Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> );
01885 
01886                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> );
01887                 }
01888 
01889                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01890 
01891                     SubjectContext = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>;
01892                 }
01893 
01894                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify );
01895             }
01896         }
01897 
01898     } finally {
01899 
01900         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
01901 
01902         <span class="keywordflow">if</span> (SubjectContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01903 
01904             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( SubjectContext );
01905             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContext );
01906         }
01907 
01908         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyCleanup:  Exit\n"</span>, 0 );
01909     }
01910 
01911     <span class="keywordflow">return</span>;
01912 }
01913 
01914 
01915 <span class="comment">//</span>
01916 <span class="comment">//  Local support routine</span>
01917 <span class="comment">//</span>
01918 
01919 <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>
<a name="l01920"></a><a class="code" href="../../d2/d7/notify_8c.html#a18">01920</a> <a class="code" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a> (
01921     IN PLIST_ENTRY NotifyListHead,
01922     IN PVOID FsContext
01923     )
01924 
01925 <span class="comment">/*++</span>
01926 <span class="comment"></span>
01927 <span class="comment">Routine Description:</span>
01928 <span class="comment"></span>
01929 <span class="comment">    This routine is called to walk through a notify list searching for</span>
01930 <span class="comment">    a member associated with the FsContext value.</span>
01931 <span class="comment"></span>
01932 <span class="comment">Arguments:</span>
01933 <span class="comment"></span>
01934 <span class="comment">    NotifyListHead  -  This is the start of the notify list.</span>
01935 <span class="comment"></span>
01936 <span class="comment">    FsContext  -  This is supplied by the file system so that this notify</span>
01937 <span class="comment">                  structure can be uniquely identified.</span>
01938 <span class="comment"></span>
01939 <span class="comment">Return Value:</span>
01940 <span class="comment"></span>
01941 <span class="comment">    PNOTIFY_CHANGE - A pointer to the matching structure is returned.  NULL</span>
01942 <span class="comment">                     is returned if the structure isn't present.</span>
01943 <span class="comment"></span>
01944 <span class="comment">--*/</span>
01945 
01946 {
01947     PLIST_ENTRY Link;
01948 
01949     <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a> ThisNotify;
01950     <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a> Notify;
01951 
01952     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01953 
01954     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlIsNotifyOnList:  Entered\n"</span>, 0 );
01955 
01956     <span class="comment">//</span>
01957     <span class="comment">//  Assume we won't have a match.</span>
01958     <span class="comment">//</span>
01959 
01960     Notify = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01961 
01962     <span class="comment">//</span>
01963     <span class="comment">//  Walk through all the entries on the list looking for a match.</span>
01964     <span class="comment">//</span>
01965 
01966     <span class="keywordflow">for</span> (Link = NotifyListHead-&gt;Flink;
01967          Link != NotifyListHead;
01968          Link = Link-&gt;Flink) {
01969 
01970         <span class="comment">//</span>
01971         <span class="comment">//  Obtain the notify structure from the link.</span>
01972         <span class="comment">//</span>
01973 
01974         ThisNotify = CONTAINING_RECORD( Link, <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>, NotifyList );
01975 
01976         <span class="comment">//</span>
01977         <span class="comment">//  If the context field matches, remember this structure and</span>
01978         <span class="comment">//  exit.</span>
01979         <span class="comment">//</span>
01980 
01981         <span class="keywordflow">if</span> (ThisNotify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a> == FsContext) {
01982 
01983             Notify = ThisNotify;
01984             <span class="keywordflow">break</span>;
01985         }
01986     }
01987 
01988     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Notify Structure  -&gt; %08lx\n"</span>, Notify );
01989     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlIsNotifyOnList:  Exit\n"</span>, 0 );
01990 
01991     <span class="keywordflow">return</span> Notify;
01992 }
01993 
01994 
01995 <span class="comment">//</span>
01996 <span class="comment">//  Local support routine</span>
01997 <span class="comment">//</span>
01998 
01999 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02000"></a><a class="code" href="../../d2/d7/notify_8c.html#a19">02000</a> <a class="code" href="../../d2/d7/notify_8c.html#a19">FsRtlNotifyCompleteIrp</a> (
02001     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp,
02002     IN PNOTIFY_CHANGE Notify,
02003     IN ULONG DataLength,
02004     IN NTSTATUS Status,
02005     IN ULONG CheckCancel
02006     )
02007 
02008 <span class="comment">/*++</span>
02009 <span class="comment"></span>
02010 <span class="comment">Routine Description:</span>
02011 <span class="comment"></span>
02012 <span class="comment">    This routine is called to complete an Irp with the data in the NOTIFY_CHANGE</span>
02013 <span class="comment">    structure.</span>
02014 <span class="comment"></span>
02015 <span class="comment">Arguments:</span>
02016 <span class="comment"></span>
02017 <span class="comment">    NotifyIrp  -  Irp to complete.</span>
02018 <span class="comment"></span>
02019 <span class="comment">    Notify  -  Notify structure which contains the data.</span>
02020 <span class="comment"></span>
02021 <span class="comment">    DataLength  -  This is the length of the data in the buffer in the notify</span>
02022 <span class="comment">        structure.  A value of zero indicates that we should complete the</span>
02023 <span class="comment">        request with STATUS_NOTIFY_ENUM_DIR.</span>
02024 <span class="comment"></span>
02025 <span class="comment">    Status  -  Indicates the status to complete the Irp with.</span>
02026 <span class="comment"></span>
02027 <span class="comment">    CheckCancel - Indicates if we should only complete the irp if we clear the cancel routine</span>
02028 <span class="comment">        ourselves.</span>
02029 <span class="comment"></span>
02030 <span class="comment">Return Value:</span>
02031 <span class="comment"></span>
02032 <span class="comment">    None.</span>
02033 <span class="comment"></span>
02034 <span class="comment">--*/</span>
02035 
02036 {
02037     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
02038 
02039     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02040 
02041     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlIsNotifyCompleteIrp:  Entered\n"</span>, 0 );
02042 
02043     <span class="comment">//</span>
02044     <span class="comment">//  Attempt to clear the cancel routine.  If this routine owns the cancel</span>
02045     <span class="comment">//  routine then it can complete the irp.  Otherwise there is a cancel underway</span>
02046     <span class="comment">//  on this.</span>
02047     <span class="comment">//</span>
02048 
02049     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/notify_8c.html#a20">FsRtlNotifySetCancelRoutine</a>( NotifyIrp, Notify ) || !CheckCancel) {
02050 
02051         <span class="comment">//</span>
02052         <span class="comment">//  We only process the buffer if the status is STATUS_SUCCESS.</span>
02053         <span class="comment">//</span>
02054 
02055         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02056 
02057             <span class="comment">//</span>
02058             <span class="comment">//  Get the current Stack location</span>
02059             <span class="comment">//</span>
02060 
02061             IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NotifyIrp );
02062 
02063             <span class="comment">//</span>
02064             <span class="comment">//  If the data won't fit in the user's buffer or there was already a</span>
02065             <span class="comment">//  buffer overflow then return the alternate status code.  If the data</span>
02066             <span class="comment">//  was already stored in the Irp buffer then we know that we won't</span>
02067             <span class="comment">//  take this path.  Otherwise we wouldn't be cleaning up the Irp</span>
02068             <span class="comment">//  correctly.</span>
02069             <span class="comment">//</span>
02070 
02071             <span class="keywordflow">if</span> (DataLength == 0
02072                 || IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length &lt; DataLength) {
02073 
02074                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOTIFY_ENUM_DIR;
02075 
02076             <span class="comment">//</span>
02077             <span class="comment">//  We have to carefully return the buffer to the user and handle all</span>
02078             <span class="comment">//  of the different buffer cases.  If there is no allocated buffer</span>
02079             <span class="comment">//  in the notify structure it means that we have already used the</span>
02080             <span class="comment">//  caller's buffer.</span>
02081             <span class="comment">//</span>
02082             <span class="comment">//  1 - If the system allocated an associated system buffer we</span>
02083             <span class="comment">//      can simply fill that in.</span>
02084             <span class="comment">//</span>
02085             <span class="comment">//  2 - If there is an Mdl then we get a system address for the Mdl</span>
02086             <span class="comment">//      and copy the data into it.</span>
02087             <span class="comment">//</span>
02088             <span class="comment">//  3 - If there is only a user's buffer and pending has not been</span>
02089             <span class="comment">//      returned, we can fill the user's buffer in directly.</span>
02090             <span class="comment">//</span>
02091             <span class="comment">//  4 - If there is only a user's buffer and pending has been returned</span>
02092             <span class="comment">//      then we are not in the user's address space.  We dress up</span>
02093             <span class="comment">//      the Irp with our system buffer and let the Io system</span>
02094             <span class="comment">//      copy the data in.</span>
02095             <span class="comment">//</span>
02096 
02097             } <span class="keywordflow">else</span> {
02098 
02099                 <span class="keywordflow">if</span> (Notify-&gt;AllocatedBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02100 
02101                     <span class="comment">//</span>
02102                     <span class="comment">//  Protect the copy with a try-except and ignore the buffer</span>
02103                     <span class="comment">//  if we have some error in copying it to the buffer.</span>
02104                     <span class="comment">//</span>
02105 
02106                     <span class="keywordflow">try</span> {
02107 
02108                         <span class="keywordflow">if</span> (NotifyIrp-&gt;AssociatedIrp.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02109 
02110                             RtlCopyMemory( NotifyIrp-&gt;AssociatedIrp.SystemBuffer,
02111                                            Notify-&gt;AllocatedBuffer,
02112                                            DataLength );
02113 
02114                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp-&gt;MdlAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02115 
02116                             RtlCopyMemory( <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( NotifyIrp-&gt;MdlAddress ),
02117                                            Notify-&gt;AllocatedBuffer,
02118                                            DataLength );
02119 
02120                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a>, <a class="code" href="../../d0/d5/io_8h.html#a194">SL_PENDING_RETURNED</a> )) {
02121 
02122                             RtlCopyMemory( NotifyIrp-&gt;UserBuffer,
02123                                            Notify-&gt;AllocatedBuffer,
02124                                            DataLength );
02125 
02126                         } <span class="keywordflow">else</span> {
02127 
02128                             NotifyIrp-&gt;Flags |= (<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>);
02129                             NotifyIrp-&gt;AssociatedIrp.SystemBuffer = Notify-&gt;AllocatedBuffer;
02130 
02131                         }
02132 
02133                     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
02134 
02135                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOTIFY_ENUM_DIR;
02136                         DataLength = 0;
02137                     }
02138 
02139                     <span class="comment">//</span>
02140                     <span class="comment">//  Return the quota and deallocate the buffer if we didn't pass it</span>
02141                     <span class="comment">//  back via the irp.</span>
02142                     <span class="comment">//</span>
02143 
02144                     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;OwningProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Notify-&gt;ThisBufferLength );
02145 
02146                     <span class="keywordflow">if</span> (Notify-&gt;AllocatedBuffer != NotifyIrp-&gt;AssociatedIrp.SystemBuffer
02147                         &amp;&amp; Notify-&gt;AllocatedBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02148 
02149                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;AllocatedBuffer );
02150                     }
02151 
02152                     Notify-&gt;AllocatedBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02153                     Notify-&gt;ThisBufferLength = 0;
02154                 }
02155 
02156                 <span class="comment">//</span>
02157                 <span class="comment">//  Update the data length in the Irp.</span>
02158                 <span class="comment">//</span>
02159 
02160                 NotifyIrp-&gt;IoStatus.Information = DataLength;
02161 
02162                 <span class="comment">//</span>
02163                 <span class="comment">//  Show that there is no buffer in the notify package</span>
02164                 <span class="comment">//  anymore.</span>
02165                 <span class="comment">//</span>
02166 
02167                 Notify-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02168             }
02169         }
02170 
02171         <span class="comment">//</span>
02172         <span class="comment">//  Make sure the Irp is marked as pending returned.</span>
02173         <span class="comment">//</span>
02174 
02175         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
02176 
02177         <span class="comment">//</span>
02178         <span class="comment">//  Now complete the request.</span>
02179         <span class="comment">//</span>
02180 
02181         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02182     }
02183 
02184     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlIsNotifyCompleteIrp:  Exit\n"</span>, 0 );
02185 
02186     <span class="keywordflow">return</span>;
02187 }
02188 
02189 
02190 <span class="comment">//</span>
02191 <span class="comment">//  Local support routine</span>
02192 <span class="comment">//</span>
02193 
02194 BOOLEAN
<a name="l02195"></a><a class="code" href="../../d2/d7/notify_8c.html#a20">02195</a> <a class="code" href="../../d2/d7/notify_8c.html#a20">FsRtlNotifySetCancelRoutine</a> (
02196     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp,
02197     IN PNOTIFY_CHANGE Notify OPTIONAL
02198     )
02199 
02200 <span class="comment">/*++</span>
02201 <span class="comment"></span>
02202 <span class="comment">Routine Description:</span>
02203 <span class="comment"></span>
02204 <span class="comment">    This is a separate routine because it cannot be paged.</span>
02205 <span class="comment"></span>
02206 <span class="comment">Arguments:</span>
02207 <span class="comment"></span>
02208 <span class="comment">    NotifyIrp  -  Set the cancel routine in this Irp.</span>
02209 <span class="comment"></span>
02210 <span class="comment">    Notify - If NULL then we are setting the cancel routine.  If not-NULL then we</span>
02211 <span class="comment">        are clearing the cancel routine.  If the cancel routine is not-null then</span>
02212 <span class="comment">        we need to decrement the reference count on this Notify structure</span>
02213 <span class="comment"></span>
02214 <span class="comment">Return Value:</span>
02215 <span class="comment"></span>
02216 <span class="comment">    BOOLEAN - Only meaningfull if Notify is specified.  It indicates if this</span>
02217 <span class="comment">        routine cleared the cancel routine.  FALSE indicates that the cancel</span>
02218 <span class="comment">        routine is processing the Irp.</span>
02219 <span class="comment"></span>
02220 <span class="comment">--*/</span>
02221 
02222 {
02223     BOOLEAN ClearedCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02224     <a class="code" href="../../d0/d5/io_8h.html#a286">PDRIVER_CANCEL</a> CurrentCancel;
02225 
02226     <span class="comment">//</span>
02227     <span class="comment">//  Grab the cancel spinlock and set our cancel routine in the Irp.</span>
02228     <span class="comment">//</span>
02229 
02230     <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;NotifyIrp-&gt;CancelIrql );
02231 
02232     <span class="comment">//</span>
02233     <span class="comment">//  If we are completing an Irp then clear the cancel routine and</span>
02234     <span class="comment">//  the information field.</span>
02235     <span class="comment">//</span>
02236 
02237     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Notify )) {
02238 
02239         CurrentCancel = <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( NotifyIrp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02240         NotifyIrp-&gt;IoStatus.Information = 0;
02241 
02242         <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( NotifyIrp-&gt;CancelIrql );
02243 
02244         <span class="comment">//</span>
02245         <span class="comment">//  If the current cancel routine is non-NULL then decrement the reference count</span>
02246         <span class="comment">//  in the Notify.</span>
02247         <span class="comment">//</span>
02248 
02249         <span class="keywordflow">if</span> (CurrentCancel != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02250 
02251             InterlockedDecrement( &amp;Notify-&gt;ReferenceCount );
02252             ClearedCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02253         }
02254 
02255     <span class="comment">//</span>
02256     <span class="comment">//  If the cancel flag is set, we complete the Irp with cancelled</span>
02257     <span class="comment">//  status and exit.</span>
02258     <span class="comment">//</span>
02259 
02260     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp-&gt;Cancel) {
02261 
02262             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp has been cancelled\n"</span>, 0 );
02263 
02264             <a class="code" href="../../d2/d7/notify_8c.html#a23">FsRtlCancelNotify</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, NotifyIrp );
02265 
02266     } <span class="keywordflow">else</span> {
02267 
02268         <span class="comment">//</span>
02269         <span class="comment">//  Set our cancel routine in the Irp.</span>
02270         <span class="comment">//</span>
02271 
02272         <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( NotifyIrp, <a class="code" href="../../d2/d7/notify_8c.html#a23">FsRtlCancelNotify</a> );
02273 
02274         <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( NotifyIrp-&gt;CancelIrql );
02275     }
02276 
02277     <span class="keywordflow">return</span> ClearedCancel;
02278 }
02279 
02280 
02281 <span class="comment">//</span>
02282 <span class="comment">//  Local support routine</span>
02283 <span class="comment">//</span>
02284 
02285 BOOLEAN
<a name="l02286"></a><a class="code" href="../../d2/d7/notify_8c.html#a21">02286</a> <a class="code" href="../../d2/d7/notify_8c.html#a21">FsRtlNotifyUpdateBuffer</a> (
02287     IN PFILE_NOTIFY_INFORMATION NotifyInfo,
02288     IN ULONG FileAction,
02289     IN PSTRING ParentName,
02290     IN PSTRING TargetName,
02291     IN PSTRING StreamName OPTIONAL,
02292     IN BOOLEAN UnicodeName,
02293     IN ULONG SizeOfEntry
02294     )
02295 
02296 <span class="comment">/*++</span>
02297 <span class="comment"></span>
02298 <span class="comment">Routine Description:</span>
02299 <span class="comment"></span>
02300 <span class="comment">    This routine is called to fill in a FILE_NOTIFY_INFORMATION structure for a</span>
02301 <span class="comment">    notify change event.  The main work is in converting an OEM string to Unicode.</span>
02302 <span class="comment"></span>
02303 <span class="comment">Arguments:</span>
02304 <span class="comment"></span>
02305 <span class="comment">    NotifyInfo  -  Information structure to complete.</span>
02306 <span class="comment"></span>
02307 <span class="comment">    FileAction  -  Action which triggered the notification event.</span>
02308 <span class="comment"></span>
02309 <span class="comment">    ParentName  -  Relative path to the parent of the changed file from the</span>
02310 <span class="comment">        directory being watched.  The length for this will be zero if the modified</span>
02311 <span class="comment">        file is in the watched directory.</span>
02312 <span class="comment"></span>
02313 <span class="comment">    TargetName  -  This is the name of the modified file.</span>
02314 <span class="comment"></span>
02315 <span class="comment">    StreamName  -  If present there is a stream name to append to the filename.</span>
02316 <span class="comment"></span>
02317 <span class="comment">    UnicodeName  -  Indicates if the above name is Unicode or Oem.</span>
02318 <span class="comment"></span>
02319 <span class="comment">    SizeOfEntry  -  Indicates the number of bytes to be used in the buffer.</span>
02320 <span class="comment"></span>
02321 <span class="comment">Return Value:</span>
02322 <span class="comment"></span>
02323 <span class="comment">    BOOLEAN - TRUE if we were able to update the buffer, FALSE otherwise.</span>
02324 <span class="comment"></span>
02325 <span class="comment">--*/</span>
02326 
02327 {
02328     BOOLEAN CopiedToBuffer;
02329     ULONG BufferOffset = 0;
02330 
02331     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02332 
02333     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyUpdateBuffer:  Entered\n"</span>, 0 );
02334 
02335     <span class="comment">//</span>
02336     <span class="comment">//  Protect the entire call with a try-except.  If we had an error</span>
02337     <span class="comment">//  we will assume that we have a bad buffer and we won't return</span>
02338     <span class="comment">//  the data in the buffer.</span>
02339     <span class="comment">//</span>
02340 
02341     <span class="keywordflow">try</span> {
02342 
02343         <span class="comment">//</span>
02344         <span class="comment">//  Update the common fields in the notify information.</span>
02345         <span class="comment">//</span>
02346 
02347         NotifyInfo-&gt;NextEntryOffset = 0;
02348         NotifyInfo-&gt;Action = FileAction;
02349 
02350         NotifyInfo-&gt;FileNameLength = SizeOfEntry - FIELD_OFFSET( FILE_NOTIFY_INFORMATION, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> );
02351 
02352         <span class="comment">//</span>
02353         <span class="comment">//  If we have a unicode name, then copy the data directly into the output buffer.</span>
02354         <span class="comment">//</span>
02355 
02356         <span class="keywordflow">if</span> (UnicodeName) {
02357 
02358             <span class="keywordflow">if</span> (ParentName-&gt;Length != 0) {
02359 
02360                 RtlCopyMemory( NotifyInfo-&gt;FileName,
02361                                ParentName-&gt;Buffer,
02362                                ParentName-&gt;Length );
02363 
02364                 *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName, ParentName-&gt;Length, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
02365                 BufferOffset = ParentName-&gt;Length + <span class="keyword">sizeof</span>( WCHAR );
02366             }
02367 
02368             RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02369                                     BufferOffset,
02370                                     PVOID ),
02371                            TargetName-&gt;Buffer,
02372                            TargetName-&gt;Length );
02373 
02374             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StreamName )) {
02375 
02376                 BufferOffset += TargetName-&gt;Length;
02377 
02378                 *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName, BufferOffset, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>;
02379 
02380                 RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02381                                         BufferOffset + <span class="keyword">sizeof</span>( WCHAR ),
02382                                         PVOID ),
02383                                StreamName-&gt;Buffer,
02384                                StreamName-&gt;Length );
02385             }
02386 
02387         <span class="comment">//</span>
02388         <span class="comment">//  For a non-unicode name, use the conversion routines.</span>
02389         <span class="comment">//</span>
02390 
02391         } <span class="keywordflow">else</span> {
02392 
02393             ULONG BufferLength;
02394 
02395             <span class="keywordflow">if</span> (ParentName-&gt;Length != 0) {
02396 
02397                 <a class="code" href="../../d9/d6/nlsxlat_8c.html#a34">RtlOemToUnicodeN</a>( NotifyInfo-&gt;FileName,
02398                                   NotifyInfo-&gt;FileNameLength,
02399                                   &amp;BufferLength,
02400                                   ParentName-&gt;Buffer,
02401                                   ParentName-&gt;Length );
02402 
02403                 *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName, BufferLength, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
02404 
02405                 BufferOffset = BufferLength + <span class="keyword">sizeof</span>( WCHAR );
02406             }
02407 
02408             <span class="comment">//</span>
02409             <span class="comment">//  For view indices, we do not have a parent name.</span>
02410             <span class="comment">//</span>
02411 
02412             <span class="keywordflow">if</span> (ParentName-&gt;Length == 0) {
02413 
02414                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT( StreamName ));
02415 
02416                 RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02417                                            BufferOffset,
02418                                            PCHAR ),
02419                                StreamName-&gt;Buffer,
02420                                StreamName-&gt;Length );
02421 
02422             } <span class="keywordflow">else</span> {
02423 
02424                 <a class="code" href="../../d9/d6/nlsxlat_8c.html#a34">RtlOemToUnicodeN</a>( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02425                                            BufferOffset,
02426                                            PWCHAR ),
02427                                   NotifyInfo-&gt;FileNameLength,
02428                                   &amp;BufferLength,
02429                                   TargetName-&gt;Buffer,
02430                                   TargetName-&gt;Length );
02431 
02432                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StreamName )) {
02433 
02434                     BufferOffset += BufferLength;
02435 
02436                     *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName, BufferOffset, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>;
02437 
02438                     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a34">RtlOemToUnicodeN</a>( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02439                                                BufferOffset + <span class="keyword">sizeof</span>( WCHAR ),
02440                                                PWCHAR ),
02441                                       NotifyInfo-&gt;FileNameLength,
02442                                       &amp;BufferLength,
02443                                       StreamName-&gt;Buffer,
02444                                       StreamName-&gt;Length );
02445                 }
02446             }
02447         }
02448 
02449         CopiedToBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02450 
02451     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
02452 
02453         CopiedToBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02454     }
02455 
02456     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyUpdateBuffer:  Exit\n"</span>, 0 );
02457 
02458     <span class="keywordflow">return</span> CopiedToBuffer;
02459 }
02460 
02461 
02462 <span class="comment">//</span>
02463 <span class="comment">//  Local support routine</span>
02464 <span class="comment">//</span>
02465 
02466 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02467"></a><a class="code" href="../../d2/d7/notify_8c.html#a32">02467</a> <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a> (
02468     IN OUT PNOTIFY_CHANGE Notify,
02469     IN NTSTATUS Status
02470     )
02471 
02472 <span class="comment">/*++</span>
02473 <span class="comment"></span>
02474 <span class="comment">Routine Description:</span>
02475 <span class="comment"></span>
02476 <span class="comment">    This routine walks through the Irps for a particular notify structure</span>
02477 <span class="comment">    and completes the Irps with the indicated status.  If the status is</span>
02478 <span class="comment">    STATUS_SUCCESS then we are completing an Irp because of a notification event.</span>
02479 <span class="comment">    In that case we look at the notify structure to decide if we can return the</span>
02480 <span class="comment">    data to the user.</span>
02481 <span class="comment"></span>
02482 <span class="comment">Arguments:</span>
02483 <span class="comment"></span>
02484 <span class="comment">    Notify  -  This is the notify change structure.</span>
02485 <span class="comment"></span>
02486 <span class="comment">    Status  -  Indicates the status used to complete the request.  If this status</span>
02487 <span class="comment">        is STATUS_SUCCESS then we only want to complete one Irp.  Otherwise we</span>
02488 <span class="comment">        want complete all the Irps in the list.</span>
02489 <span class="comment"></span>
02490 <span class="comment">Return Value:</span>
02491 <span class="comment"></span>
02492 <span class="comment">    None.</span>
02493 <span class="comment"></span>
02494 <span class="comment">--*/</span>
02495 
02496 {
02497     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02498     ULONG DataLength;
02499 
02500     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyCompleteIrpList:  Entered\n"</span>, 0 );
02501 
02502     DataLength = Notify-&gt;DataLength;
02503 
02504     <span class="comment">//</span>
02505     <span class="comment">//  Clear the fields to indicate that there is no more data to return.</span>
02506     <span class="comment">//</span>
02507 
02508     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Notify-&gt;Flags, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> );
02509     Notify-&gt;DataLength = 0;
02510     Notify-&gt;LastEntry = 0;
02511 
02512     <span class="comment">//</span>
02513     <span class="comment">//  Walk through all the Irps in the list.  We are never called unless</span>
02514     <span class="comment">//  there is at least one irp.</span>
02515     <span class="comment">//</span>
02516 
02517     <span class="keywordflow">do</span> {
02518 
02519         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( Notify-&gt;NotifyIrps.Flink, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry );
02520 
02521         RemoveHeadList( &amp;Notify-&gt;NotifyIrps );
02522 
02523         <span class="comment">//</span>
02524         <span class="comment">//  Call our completion routine to complete the request.</span>
02525         <span class="comment">//</span>
02526 
02527         <a class="code" href="../../d2/d7/notify_8c.html#a19">FsRtlNotifyCompleteIrp</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
02528                                 Notify,
02529                                 DataLength,
02530                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
02531                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02532 
02533         <span class="comment">//</span>
02534         <span class="comment">//  If we were only to complete one Irp then break now.</span>
02535         <span class="comment">//</span>
02536 
02537         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02538 
02539             <span class="keywordflow">break</span>;
02540         }
02541 
02542     } <span class="keywordflow">while</span> (!IsListEmpty( &amp;Notify-&gt;NotifyIrps ));
02543 
02544     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlNotifyCompleteIrpList:  Exit\n"</span>, 0 );
02545 
02546     <span class="keywordflow">return</span>;
02547 }
02548 
02549 
02550 <span class="comment">//</span>
02551 <span class="comment">//  Local support routine</span>
02552 <span class="comment">//</span>
02553 
02554 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02555"></a><a class="code" href="../../d2/d7/notify_8c.html#a23">02555</a> <a class="code" href="../../d2/d7/notify_8c.html#a23">FsRtlCancelNotify</a> (
02556     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
02557     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> ThisIrp
02558     )
02559 
02560 <span class="comment">/*++</span>
02561 <span class="comment"></span>
02562 <span class="comment">Routine Description:</span>
02563 <span class="comment"></span>
02564 <span class="comment">    This routine is for an Irp which is being cancelled.  We Null the cancel</span>
02565 <span class="comment">    routine and then walk through the Irps for this notify structure and</span>
02566 <span class="comment">    complete all cancelled Irps.  It is possible there is pending notify</span>
02567 <span class="comment">    stored in the buffer for this Irp.  In this case we want to copy the</span>
02568 <span class="comment">    data to a system buffer if possible.</span>
02569 <span class="comment"></span>
02570 <span class="comment">Arguments:</span>
02571 <span class="comment"></span>
02572 <span class="comment">    DeviceObject - Ignored.</span>
02573 <span class="comment"></span>
02574 <span class="comment">    ThisIrp  -  This is the Irp to cancel.</span>
02575 <span class="comment"></span>
02576 <span class="comment">Return Value:</span>
02577 <span class="comment"></span>
02578 <span class="comment">    None.</span>
02579 <span class="comment"></span>
02580 <span class="comment">--*/</span>
02581 
02582 {
02583     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02584 
02585     <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a> Notify;
02586     <a class="code" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync;
02587     LONG ExceptionCode;
02588 
02589     UNREFERENCED_PARAMETER( DeviceObject );
02590 
02591     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelNotify:  Entered\n"</span>, 0 );
02592     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Irp   -&gt; %08lx\n"</span>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02593 
02594     <span class="comment">//</span>
02595     <span class="comment">//  Capture the notify structure.</span>
02596     <span class="comment">//</span>
02597 
02598     Notify = (<a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>) ThisIrp-&gt;IoStatus.Information;
02599 
02600     <span class="comment">//</span>
02601     <span class="comment">//  Void the cancel routine and release the cancel spinlock.</span>
02602     <span class="comment">//</span>
02603 
02604     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( ThisIrp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02605     ThisIrp-&gt;IoStatus.Information = 0;
02606     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( ThisIrp-&gt;CancelIrql );
02607 
02608     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
02609 
02610     <span class="comment">//</span>
02611     <span class="comment">//  Grab the mutex for this structure.</span>
02612     <span class="comment">//</span>
02613 
02614     NotifySync = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o0">NotifySync</a>;
02615     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
02616 
02617     <span class="comment">//</span>
02618     <span class="comment">//  Use a try finally to faciltate cleanup.</span>
02619     <span class="comment">//</span>
02620 
02621     <span class="keywordflow">try</span> {
02622 
02623         <span class="comment">//</span>
02624         <span class="comment">//  Remove the Irp from the queue.</span>
02625         <span class="comment">//</span>
02626 
02627         RemoveEntryList( &amp;ThisIrp-&gt;Tail.Overlay.ListEntry );
02628 
02629         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( ThisIrp );
02630 
02631         <span class="comment">//</span>
02632         <span class="comment">//  We now have the Irp.  Check to see if there is data stored</span>
02633         <span class="comment">//  in the buffer for this Irp.</span>
02634         <span class="comment">//</span>
02635 
02636         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02637             &amp;&amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02638 
02639             &amp;&amp; ((ThisIrp-&gt;MdlAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02640                  &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( ThisIrp-&gt;MdlAddress ) == Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>)
02641 
02642                 || (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> == ThisIrp-&gt;AssociatedIrp.SystemBuffer))) {
02643 
02644             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NextIrp;
02645             PVOID NewBuffer;
02646             ULONG NewBufferLength;
02647             <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>  IrpSp;
02648 
02649             <span class="comment">//</span>
02650             <span class="comment">//  Initialize the above values.</span>
02651             <span class="comment">//</span>
02652 
02653             NewBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02654             NewBufferLength = 0;
02655 
02656             <span class="comment">//</span>
02657             <span class="comment">//  Remember the next Irp on the list.  Find the length of any</span>
02658             <span class="comment">//  buffer it might have.  Also keep a pointer to the buffer</span>
02659             <span class="comment">//  if present.</span>
02660             <span class="comment">//</span>
02661 
02662             <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
02663 
02664                 NextIrp = CONTAINING_RECORD( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>.Flink,
02665                                              <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
02666                                              Tail.Overlay.ListEntry );
02667 
02668                 IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NextIrp );
02669 
02670                 <span class="comment">//</span>
02671                 <span class="comment">//  If the buffer here is large enough to hold the data we</span>
02672                 <span class="comment">//  can use that buffer.</span>
02673                 <span class="comment">//</span>
02674 
02675                 <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length &gt;= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a>) {
02676 
02677                     <span class="comment">//</span>
02678                     <span class="comment">//  If there is a system buffer or Mdl then get a new</span>
02679                     <span class="comment">//  buffer there.</span>
02680                     <span class="comment">//</span>
02681 
02682                     <span class="keywordflow">if</span> (NextIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02683 
02684                         NewBuffer = NextIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
02685 
02686                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NextIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02687 
02688                         NewBuffer = <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( NextIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
02689                     }
02690 
02691                     NewBufferLength = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length;
02692 
02693                     <span class="keywordflow">if</span> (NewBufferLength &gt; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>) {
02694 
02695                         NewBufferLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>;
02696                     }
02697                 }
02698 
02699             <span class="comment">//</span>
02700             <span class="comment">//  Otherwise check if the user's original buffer is larger than</span>
02701             <span class="comment">//  the current buffer.</span>
02702             <span class="comment">//</span>
02703 
02704             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a> &gt;= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a>) {
02705 
02706                 NewBufferLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>;
02707             }
02708 
02709             <span class="comment">//</span>
02710             <span class="comment">//  If we have a new buffer length then we either have a new</span>
02711             <span class="comment">//  buffer or need to allocate one.  We will do this under</span>
02712             <span class="comment">//  the protection of a try-except in order to continue in the</span>
02713             <span class="comment">//  event of a failure.</span>
02714             <span class="comment">//</span>
02715 
02716             <span class="keywordflow">if</span> (NewBufferLength != 0) {
02717 
02718                 BOOLEAN ChargedQuota;
02719 
02720                 <span class="keywordflow">try</span> {
02721 
02722                     ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02723 
02724                     <span class="keywordflow">if</span> (NewBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02725 
02726                         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
02727                                            <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02728                                            NewBufferLength );
02729 
02730                         ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02731 
02732                         <span class="comment">//</span>
02733                         <span class="comment">//  If we didn't get an error then attempt to</span>
02734                         <span class="comment">//  allocate the pool.  If there is an error</span>
02735                         <span class="comment">//  don't forget to release the quota.</span>
02736                         <span class="comment">//</span>
02737 
02738                         NewBuffer = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02739                                                         NewBufferLength );
02740 
02741                         Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> = NewBuffer;
02742                     }
02743 
02744                     <span class="comment">//</span>
02745                     <span class="comment">//  Now copy the data over to the new buffer.</span>
02746                     <span class="comment">//</span>
02747 
02748                     RtlCopyMemory( NewBuffer,
02749                                    Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>,
02750                                    Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> );
02751 
02752                     <span class="comment">//</span>
02753                     <span class="comment">//  It is possible that the buffer size changed.</span>
02754                     <span class="comment">//</span>
02755 
02756                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = NewBufferLength;
02757                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = NewBuffer;
02758 
02759                 } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>( ExceptionCode = GetExceptionCode()) ?
02760                           <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> :
02761                           <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> ) {
02762 
02763                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ExceptionCode == STATUS_INSUFFICIENT_RESOURCES) ||
02764                             (ExceptionCode == STATUS_QUOTA_EXCEEDED) );
02765                     
02766                     <span class="comment">//</span>
02767                     <span class="comment">//  Return quota if we allocated the buffer.</span>
02768                     <span class="comment">//</span>
02769 
02770                     <span class="keywordflow">if</span> (ChargedQuota) {
02771 
02772                         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
02773                                            <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02774                                            NewBufferLength );
02775                     }
02776 
02777                     <span class="comment">//</span>
02778                     <span class="comment">//  Forget any current buffer and resort to immediate</span>
02779                     <span class="comment">//  notify.</span>
02780                     <span class="comment">//</span>
02781 
02782                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> );
02783                 }
02784 
02785             <span class="comment">//</span>
02786             <span class="comment">//  Otherwise set the immediate notify flag.</span>
02787             <span class="comment">//</span>
02788 
02789             } <span class="keywordflow">else</span> {
02790 
02791                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> );
02792             }
02793 
02794             <span class="comment">//</span>
02795             <span class="comment">//  If the immediate notify flag is set then clear the other</span>
02796             <span class="comment">//  values in the notify structures.</span>
02797             <span class="comment">//</span>
02798 
02799             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a> )) {
02800 
02801                 <span class="comment">//</span>
02802                 <span class="comment">//  Forget any current buffer and resort to immediate</span>
02803                 <span class="comment">//  notify.</span>
02804                 <span class="comment">//</span>
02805 
02806                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02807 
02808                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> =
02809                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = 0;
02810             }
02811         }
02812 
02813         <span class="comment">//</span>
02814         <span class="comment">//  Complete the Irp with status cancelled.</span>
02815         <span class="comment">//</span>
02816 
02817         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( ThisIrp, STATUS_CANCELLED );
02818 
02819         <span class="comment">//</span>
02820         <span class="comment">//  Decrement the count of Irps that might go through the cancel path.</span>
02821         <span class="comment">//</span>
02822 
02823         InterlockedDecrement( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> );
02824 
02825         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> == 0) {
02826 
02827             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02828 
02829                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
02830                                    <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02831                                    Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> );
02832 
02833                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> );
02834             }
02835 
02836             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02837 
02838                 SubjectContext = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>;
02839             }
02840 
02841             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify );
02842             Notify = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02843         }
02844 
02845     } finally {
02846 
02847         <span class="comment">//</span>
02848         <span class="comment">//  No matter how we exit, we release the mutex.</span>
02849         <span class="comment">//</span>
02850 
02851         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
02852 
02853         <span class="keywordflow">if</span> (SubjectContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02854 
02855             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( SubjectContext );
02856             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContext );
02857         }
02858 
02859         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
02860 
02861         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FsRtlCancelNotify:  Exit\n"</span>, 0 );
02862     }
02863 
02864     <span class="keywordflow">return</span>;
02865 }
02866 
02867 
02868 <span class="comment">//</span>
02869 <span class="comment">//  Local support routine</span>
02870 <span class="comment">//</span>
02871 
02872 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02873"></a><a class="code" href="../../d2/d7/notify_8c.html#a24">02873</a> <a class="code" href="../../d2/d7/notify_8c.html#a24">FsRtlCheckNotifyForDelete</a> (
02874     IN PLIST_ENTRY NotifyListHead,
02875     IN PVOID StreamID
02876     )
02877 
02878 <span class="comment">/*++</span>
02879 <span class="comment"></span>
02880 <span class="comment">Routine Description:</span>
02881 <span class="comment"></span>
02882 <span class="comment">    This routine is called when a stream is being marked for delete.  We will</span>
02883 <span class="comment">    walk through the notify structures looking for an Irp for the same stream.</span>
02884 <span class="comment">    We will complete these Irps with STATUS_DELETE_PENDING.</span>
02885 <span class="comment"></span>
02886 <span class="comment">Arguments:</span>
02887 <span class="comment"></span>
02888 <span class="comment">    NotifyListHead  -  This is the start of the notify list.</span>
02889 <span class="comment"></span>
02890 <span class="comment">    StreamID  -  This is the Context ID used to identify the stream.</span>
02891 <span class="comment"></span>
02892 <span class="comment">Return Value:</span>
02893 <span class="comment"></span>
02894 <span class="comment">    None.</span>
02895 <span class="comment"></span>
02896 <span class="comment">--*/</span>
02897 
02898 {
02899     PLIST_ENTRY Link;
02900 
02901     <a class="code" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a> ThisNotify;
02902 
02903     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02904 
02905     <span class="comment">//</span>
02906     <span class="comment">//  Walk through all the entries on the list looking for a match.</span>
02907     <span class="comment">//</span>
02908 
02909     <span class="keywordflow">for</span> (Link = NotifyListHead-&gt;Flink;
02910          Link != NotifyListHead;
02911          Link = Link-&gt;Flink) {
02912 
02913         <span class="comment">//</span>
02914         <span class="comment">//  Obtain the notify structure from the link.</span>
02915         <span class="comment">//</span>
02916 
02917         ThisNotify = CONTAINING_RECORD( Link, <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>, NotifyList );
02918 
02919         <span class="comment">//</span>
02920         <span class="comment">//  If the context field matches, then complete any waiting Irps.</span>
02921         <span class="comment">//</span>
02922 
02923         <span class="keywordflow">if</span> (ThisNotify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o2">StreamID</a> == StreamID) {
02924 
02925             <span class="comment">//</span>
02926             <span class="comment">//  Start by marking the notify structure as file deleted.</span>
02927             <span class="comment">//</span>
02928 
02929             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ThisNotify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, <a class="code" href="../../d2/d7/notify_8c.html#a6">NOTIFY_STREAM_IS_DELETED</a> );
02930 
02931             <span class="comment">//</span>
02932             <span class="comment">//  Now complete all of the Irps on this list.</span>
02933             <span class="comment">//</span>
02934 
02935             <span class="keywordflow">if</span> (!IsListEmpty( &amp;ThisNotify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
02936 
02937                 <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a>( ThisNotify, STATUS_DELETE_PENDING );
02938             }
02939         }
02940     }
02941 
02942     <span class="keywordflow">return</span>;
02943 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
