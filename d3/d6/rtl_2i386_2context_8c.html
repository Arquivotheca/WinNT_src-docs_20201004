<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtl/i386/context.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c File Reference</h1><code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>

<p>
<a href="../../d4/d5/rtl_2i386_2context_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/rtl_2i386_2context_8c.html#a0">RtlInitializeContext</a> (IN HANDLE Process, OUT PCONTEXT Context, IN PVOID Parameter OPTIONAL, IN PVOID InitialPc OPTIONAL, IN PVOID InitialSp OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/rtl_2i386_2context_8c.html#a1">RtlRemoteCall</a> (HANDLE Process, HANDLE Thread, PVOID CallSite, ULONG ArgumentCount, PULONG Arguments, BOOLEAN PassContext, BOOLEAN AlreadySuspended)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="rtl/i386/context.c::RtlInitializeContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlInitializeContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Parameter&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InitialPc&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InitialSp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/rtl_2i386_2context_8c-source.html#l00036">36</a> of file <a class="el" href="../../d4/d5/rtl_2i386_2context_8c-source.html">rtl/i386/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00046                    :
00047 
00048     This function initializes a context structure so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can
00049     be used in a subsequent call to <a class="code" href="../../d2/d8/ps_2create_8c.html#a10">NtCreateThread</a>.
00050 
00051 Arguments:
00052 
00053     Context - Supplies a context buffer to be initialized by <span class="keyword">this</span> routine.
00054 
00055     InitialPc - Supplies an initial program counter value.
00056 
00057     InitialSp - Supplies an initial stack pointer value.
00058 
00059 Return Value:
00060 
00061     Raises STATUS_BAD_INITIAL_STACK <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of InitialSp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly
00062            aligned.
00063 
00064     Raises STATUS_BAD_INITIAL_PC <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of InitialPc <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly
00065            aligned.
00066 
00067 --*/
00068 
00069 {
00070     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00071 
00072     Context-&gt;Eax = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00073     Context-&gt;Ebx = 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00074     Context-&gt;Ecx = 2<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00075     Context-&gt;Edx = 3<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00076     Context-&gt;Esi = 4<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00077     Context-&gt;Edi = 5<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00078     Context-&gt;Ebp = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00079 
00080     Context-&gt;SegGs = 0;
00081     Context-&gt;SegFs = KGDT_R3_TEB;
00082     Context-&gt;SegEs = KGDT_R3_DATA;
00083     Context-&gt;SegDs = KGDT_R3_DATA;
00084     Context-&gt;SegSs = KGDT_R3_DATA;
00085     Context-&gt;SegCs = KGDT_R3_CODE;
00086 
00087     Context-&gt;EFlags = 0x200<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;       <span class="comment">// force interrupts on, clear all else.</span>
00088 
00089     <span class="comment">//</span>
00090     <span class="comment">// Even though these are optional, they are used as is, since NULL</span>
00091     <span class="comment">// is what these would have been initialized to anyway</span>
00092     <span class="comment">//</span>
00093 
00094     Context-&gt;Esp = (ULONG) InitialSp;
00095     Context-&gt;Eip = (ULONG) InitialPc;
00096 
00097     <span class="comment">//</span>
00098     <span class="comment">// add code to check alignment and raise exception...</span>
00099     <span class="comment">//</span>
00100 
00101     Context-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>|<a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>|CONTEXT_SEGMENTS;
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Set the initial context of the thread in a machine specific way.</span>
00105     <span class="comment">// ie, pass the initial parameter to the start address</span>
00106     <span class="comment">//</span>
00107 
00108     Context-&gt;Esp -= <span class="keyword">sizeof</span>(Parameter);
00109     ZwWriteVirtualMemory(Process,
00110                          (PVOID)Context-&gt;Esp,
00111                          (PVOID)&amp;Parameter,
00112                          <span class="keyword">sizeof</span>(Parameter),
00113                          NULL);
00114     Context-&gt;Esp -= <span class="keyword">sizeof</span>(Parameter); <span class="comment">// Reserve room for ret address</span>
00115 
00116 
00117 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="rtl/i386/context.c::RtlRemoteCall" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlRemoteCall           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallSite</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ArgumentCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Arguments</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PassContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadySuspended</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/rtl_2i386_2context_8c-source.html#l00122">122</a> of file <a class="el" href="../../d4/d5/rtl_2i386_2context_8c-source.html">rtl/i386/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00033">NtSuspendThread()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00134                    :
00135 
00136     This function calls a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> in another thread/process, <span class="keyword">using</span>
00137     NtGetContext and NtSetContext.  Parameters are passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00138     target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> via its stack.
00139 
00140 Arguments:
00141 
00142     Process - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process
00143 
00144     Thread - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread within that process
00145 
00146     CallSite - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to call in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process.
00147 
00148     ArgumentCount - Number of 32 bit parameters to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00149                     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>.
00150 
00151     Arguments - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array of 32 bit parameters to pass.
00152 
00153     PassContext - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> an additional parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be passed that
00154         points to a context record.
00155 
00156     AlreadySuspended - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in a suspended
00157                        or waiting state.
00158 
00159 Return Value:
00160 
00161     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value
00162 
00163 --*/
00164 
00165 {
00166     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00167     CONTEXT Context;
00168     ULONG NewSp;
00169     ULONG ArgumentsCopy[5];
00170 
00171     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00172 
00173     <span class="keywordflow">if</span> (ArgumentCount &gt; 4)
00174         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00175 
00176     <span class="comment">//</span>
00177     <span class="comment">// If necessary, suspend the guy before with we mess with his stack.</span>
00178     <span class="comment">//</span>
00179     <span class="keywordflow">if</span> (!AlreadySuspended) {
00180         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>( Thread, NULL );
00181         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00182             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00183             }
00184         }
00185 
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Get the context record for the target thread.</span>
00189     <span class="comment">//</span>
00190 
00191     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00192     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>( Thread, &amp;Context );
00193     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00194         <span class="keywordflow">if</span> (!AlreadySuspended) {
00195             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( Thread, NULL );
00196             }
00197         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00198         }
00199 
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">//  Pass all parameters on the stack, regardless of whether a</span>
00203     <span class="comment">//  a context record is passed.</span>
00204     <span class="comment">//</span>
00205 
00206     <span class="comment">//</span>
00207     <span class="comment">//  Put Context Record on stack first, so it is above other args.</span>
00208     <span class="comment">//</span>
00209     NewSp = Context.Esp;
00210     <span class="keywordflow">if</span> (PassContext) {
00211         NewSp -= <span class="keyword">sizeof</span>( CONTEXT );
00212         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>( Process,
00213                                        (PVOID)NewSp,
00214                                        &amp;Context,
00215                                        <span class="keyword">sizeof</span>( CONTEXT ),
00216                                        NULL
00217                                     );
00218         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00219             <span class="keywordflow">if</span> (!AlreadySuspended) {
00220                 <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( Thread, NULL );
00221                 }
00222             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00223             }
00224         ArgumentsCopy[0] = NewSp;   <span class="comment">// pass pointer to context</span>
00225         RtlMoveMemory(&amp;(ArgumentsCopy[1]),Arguments,ArgumentCount*<span class="keyword">sizeof</span>( ULONG ));
00226         ArgumentCount++;
00227         }
00228     <span class="keywordflow">else</span> {
00229         RtlMoveMemory(ArgumentsCopy,Arguments,ArgumentCount*<span class="keyword">sizeof</span>( ULONG ));
00230         }
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">//  Copy the arguments onto the target stack</span>
00234     <span class="comment">//</span>
00235     <span class="keywordflow">if</span> (ArgumentCount) {
00236         NewSp -= ArgumentCount * <span class="keyword">sizeof</span>( ULONG );
00237         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>( Process,
00238                                        (PVOID)NewSp,
00239                                        ArgumentsCopy,
00240                                        ArgumentCount * <span class="keyword">sizeof</span>( ULONG ),
00241                                        NULL
00242                                      );
00243         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00244             <span class="keywordflow">if</span> (!AlreadySuspended) {
00245                 <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( Thread, NULL );
00246                 }
00247             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00248             }
00249         }
00250 
00251     <span class="comment">//</span>
00252     <span class="comment">// Set the address of the target code into Eip, the new target stack</span>
00253     <span class="comment">// into Esp, and reload context to make it happen.</span>
00254     <span class="comment">//</span>
00255     Context.Esp = NewSp;
00256     Context.Eip = (ULONG)CallSite;
00257     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>( Thread, &amp;Context );
00258     <span class="keywordflow">if</span> (!AlreadySuspended) {
00259         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( Thread, NULL );
00260         }
00261 
00262     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00263 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
