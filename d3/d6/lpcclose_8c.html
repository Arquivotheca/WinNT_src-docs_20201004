<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpcclose.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpcclose.c File Reference</h1><code>#include "<a class="el" href="../../d1/d6/lpcp_8h-source.html">lpcp.h</a>"</code><br>

<p>
<a href="../../d4/d5/lpcclose_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/lpcclose_8c.html#a0">LpcpClosePort</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL, IN PVOID Object, IN ACCESS_MASK GrantedAccess, IN ULONG ProcessHandleCount, IN ULONG SystemHandleCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/lpcclose_8c.html#a1">LpcpDeletePort</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/lpcclose_8c.html#a2">LpcExitThread</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="lpcclose.c::LpcExitThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LpcExitThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00281">281</a> of file <a class="el" href="../../d4/d5/lpcclose_8c-source.html">lpcclose.c</a>.
<p>
References <a class="el" href="../../d3/d5/lpc_8h-source.html#l00142">_LPCP_MESSAGE::Entry</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00447">_ETHREAD::LpcExitThreadCalled</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00642">LpcpFreeToPortZone()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00371">_ETHREAD::LpcReplyChain</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00395">_ETHREAD::LpcReplyMessage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00396">_ETHREAD::LpcReplyMessageId</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00151">_LPCP_MESSAGE::RepliedToThread</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>00287                    :
00288 
00289     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> exiting and need to cleanup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00290     lpc port <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00291 
00292 Arguments:
00293 
00294     Thread - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread being terminated
00295 
00296 Return Value:
00297 
00298     None.
00299 
00300 --*/
00301 
00302 {
00303     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00304 
00305     <span class="comment">//</span>
00306     <span class="comment">//  Acquire the mutex that protects the LpcReplyMessage field of</span>
00307     <span class="comment">//  the thread.  Zero the field so nobody else tries to process it</span>
00308     <span class="comment">//  when we release the lock.</span>
00309     <span class="comment">//</span>
00310 
00311     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00312 
00313     <span class="keywordflow">if</span> (!IsListEmpty( &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
00314 
00315         RemoveEntryList( &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00316     }
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">//  Indicate that this thread is exiting</span>
00320     <span class="comment">//</span>
00321 
00322     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o32">LpcExitThreadCalled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00323     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">//  If we need to reply to a message then if the thread that we need to reply</span>
00327     <span class="comment">//  to is still around we want to dereference the thread and free the message</span>
00328     <span class="comment">//</span>
00329 
00330     Msg = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>;
00331 
00332     <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00333 
00334         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335 
00336         <span class="keywordflow">if</span> (Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00337 
00338             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> );
00339 
00340             Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341         }
00342 
00343         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Cleanup Msg %lx (%d) for Thread %lx allocated\n"</span>, Msg, IsListEmpty( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> ), Thread ));
00344 
00345         <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
00346     }
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">//  Free the global lpc lock</span>
00350     <span class="comment">//</span>
00351 
00352     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">//  And return to our caller</span>
00356     <span class="comment">//</span>
00357 
00358     <span class="keywordflow">return</span>;
00359 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="lpcclose.c::LpcpClosePort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LpcpClosePort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandleCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemHandleCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00031">31</a> of file <a class="el" href="../../d4/d5/lpcclose_8c-source.html">lpcclose.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00104">LpcpDestroyPortQueue()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00131">SERVER_CONNECTION_PORT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00076">LpcInitSystem()</a>.
<p>
<pre class="fragment"><div>00041                    :
00042 
00043     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback used <span class="keywordflow">for</span> closing a port object.
00044 
00045 Arguments:
00046 
00047     Process - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose port <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00048         closed
00049 
00050     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port object being closed
00051 
00052     GrantedAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle closing port
00053         object
00054 
00055     ProcessHandleCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of process handles remaining to
00056         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00057 
00058     SystemHandleCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of system handles remaining to
00059         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00060 
00061 Return Value:
00062 
00063     None.
00064 
00065 --*/
00066 
00067 {
00068     <span class="comment">//</span>
00069     <span class="comment">//  Translate the object to what it really is, an LPCP port object</span>
00070     <span class="comment">//</span>
00071 
00072     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> Port = Object;
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">//  We only have work to do if the object is a server communication port</span>
00076     <span class="comment">//</span>
00077 
00078     <span class="keywordflow">if</span> ( (Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a> ) {
00079 
00080         <span class="comment">//</span>
00081         <span class="comment">//  If this is a server commucation port without any system handles</span>
00082         <span class="comment">//  then we can completely destroy the communication queue for the</span>
00083         <span class="comment">//  port</span>
00084         <span class="comment">//</span>
00085 
00086         <span class="keywordflow">if</span> ( SystemHandleCount == 0 ) {
00087 
00088             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a1">LpcpDestroyPortQueue</a>( Port, TRUE );
00089 
00090         <span class="comment">//</span>
00091         <span class="comment">//  If there is only one system handle left then we'll reset the</span>
00092         <span class="comment">//  communication queue for the port</span>
00093         <span class="comment">//</span>
00094 
00095         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( SystemHandleCount == 1 ) {
00096 
00097             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a1">LpcpDestroyPortQueue</a>( Port, FALSE );
00098         }
00099 
00100         <span class="comment">//</span>
00101         <span class="comment">//  Otherwise we do nothing</span>
00102         <span class="comment">//</span>
00103     }
00104 
00105     <span class="keywordflow">return</span>;
00106 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lpcclose.c::LpcpDeletePort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LpcpDeletePort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">110</a> of file <a class="el" href="../../d4/d5/lpcclose_8c-source.html">lpcclose.c</a>.
<p>
References <a class="el" href="../../d3/d5/lpc_8h-source.html#l00134">CLIENT_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00111">_LPCP_PORT_OBJECT::ClientSectionBase</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00116">_LPCP_PORT_OBJECT::ClientThread</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00107">_LPCP_PORT_OBJECT::ConnectionPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00142">_LPCP_MESSAGE::Entry</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00120">_LPCP_PORT_OBJECT::LpcDataInfoChainHead</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00104">LpcpDestroyPortQueue()</a>, <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00296">LpcpFreePortClientSecurity()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00642">LpcpFreeToPortZone()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00151">LpcpPortExtraDataDestroy</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01181">LpcRequestPort()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00154">_LPCP_MESSAGE::Request</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00133">SERVER_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00131">SERVER_CONNECTION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00121">_LPCP_PORT_OBJECT::ServerProcess</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00112">_LPCP_PORT_OBJECT::ServerSectionBase</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00076">LpcInitSystem()</a>.
<p>
<pre class="fragment"><div>00116                    :
00117 
00118     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback used <span class="keywordflow">for</span> deleting a port object.
00119 
00120 Arguments:
00121 
00122     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port object being deleted
00123 
00124 Return Value:
00125 
00126     None.
00127 
00128 --*/
00129 
00130 {
00131     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> Port = Object;
00132     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ConnectionPort;
00133     LPC_CLIENT_DIED_MSG ClientPortClosedDatagram;
00134     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00135     PLIST_ENTRY Head, Next;
00136     HANDLE CurrentProcessId;
00137 
00138     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">//  If the port is a server communication port then make sure that if</span>
00142     <span class="comment">//  there is a dangling client thread that we get rid of it.  This</span>
00143     <span class="comment">//  handles the case of someone calling NtAcceptConnectPort and not</span>
00144     <span class="comment">//  calling NtCompleteConnectPort</span>
00145     <span class="comment">//</span>
00146 
00147     <a class="code" href="../../d0/d7/lpcp_8h.html#a6">LpcpPortExtraDataDestroy</a>( Port );
00148 
00149     <span class="keywordflow">if</span> ((Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
00150 
00151         <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00152 
00153         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00154 
00155         <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o11">ClientThread</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00156 
00157             Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o11">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00158 
00159             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00160 
00161             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00162 
00163         } <span class="keywordflow">else</span> {
00164 
00165             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00166         }
00167     }
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">//  Send an LPC_PORT_CLOSED datagram to whoever is connected</span>
00171     <span class="comment">//  to this port so they know they are no longer connected.</span>
00172     <span class="comment">//</span>
00173 
00174     <span class="keywordflow">if</span> ((Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
00175 
00176         ClientPortClosedDatagram.PortMsg.u1.s1.TotalLength = <span class="keyword">sizeof</span>( ClientPortClosedDatagram );
00177         ClientPortClosedDatagram.PortMsg.u1.s1.DataLength = <span class="keyword">sizeof</span>( ClientPortClosedDatagram.CreateTime );
00178 
00179         ClientPortClosedDatagram.PortMsg.u2.s2.Type = LPC_PORT_CLOSED;
00180         ClientPortClosedDatagram.PortMsg.u2.s2.DataInfoOffset = 0;
00181 
00182         ClientPortClosedDatagram.CreateTime = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;CreateTime;
00183 
00184         <a class="code" href="../../d6/d7/lpcsend_8c.html#a2">LpcRequestPort</a>( Port, (PPORT_MESSAGE)&amp;ClientPortClosedDatagram );
00185     }
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">//  If connected, disconnect the port, and then scan the message queue</span>
00189     <span class="comment">//  for this port and dereference any messages in the queue.</span>
00190     <span class="comment">//</span>
00191 
00192     <a class="code" href="../../d3/d7/lpcqueue_8c.html#a1">LpcpDestroyPortQueue</a>( Port, TRUE );
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">//  If the client has a port memory view, then unmap it</span>
00196     <span class="comment">//</span>
00197 
00198     <span class="keywordflow">if</span> (Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o6">ClientSectionBase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00199 
00200         <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00201                               Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o6">ClientSectionBase</a> );
00202 
00203     }
00204 
00205     <span class="comment">//</span>
00206     <span class="comment">//  If the server has a port memory view, then unmap it</span>
00207     <span class="comment">//</span>
00208 
00209     <span class="keywordflow">if</span> (Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o7">ServerSectionBase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00210 
00211         <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00212                               Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o7">ServerSectionBase</a>  );
00213 
00214     }
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Dereference the pointer to the connection port if it is not</span>
00218     <span class="comment">//  this port.</span>
00219     <span class="comment">//</span>
00220 
00221     <span class="keywordflow">if</span> (ConnectionPort = Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>) {
00222 
00223         CurrentProcessId = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess;
00224 
00225         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00226 
00227         Head = &amp;ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o15">LpcDataInfoChainHead</a>;
00228         Next = Head-&gt;Flink;
00229 
00230         <span class="keywordflow">while</span> (Next != Head) {
00231 
00232             Msg = CONTAINING_RECORD( Next, <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">LPCP_MESSAGE</a>, Entry );
00233             Next = Next-&gt;Flink;
00234 
00235             <span class="keywordflow">if</span> (Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.ClientId.UniqueProcess == CurrentProcessId) {
00236 
00237                 <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Freeing DataInfo Message %lx (%u.%u)  Port: %lx\n"</span>,
00238                             <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00239                             Msg,
00240                             Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
00241                             Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId,
00242                             ConnectionPort ));
00243 
00244                 RemoveEntryList( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> );
00245 
00246                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
00247             }
00248         }
00249 
00250         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00251 
00252         <span class="keywordflow">if</span> (ConnectionPort != Port) {
00253 
00254             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00255         }
00256     }
00257 
00258     <span class="keywordflow">if</span> (((Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) &amp;&amp;
00259         (ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o16">ServerProcess</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00260 
00261         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o16">ServerProcess</a> );
00262 
00263         ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o16">ServerProcess</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00264     }
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">//  Free any static client security context</span>
00268     <span class="comment">//</span>
00269 
00270     <a class="code" href="../../d1/d7/lpcpriv_8c.html#a1">LpcpFreePortClientSecurity</a>( Port );
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  And return to our caller</span>
00274     <span class="comment">//</span>
00275 
00276     <span class="keywordflow">return</span>;
00277 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
