<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: allocvm.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>allocvm.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d4/d5/allocvm_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a2">MiResetVirtualMemory</a> (IN PVOID StartingAddress, IN PVOID EndingAddress, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a3">MiCreatePageTablesForPhysicalRange</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID StartingAddress, IN PVOID EndingAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a4">MiPhysicalViewInserter</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a5">MiFlushAcquire</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a6">MiFlushRelease</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a> (IN HANDLE ProcessHandle, IN OUT PVOID *BaseAddress, IN ULONG_PTR ZeroBits, IN OUT PSIZE_T RegionSize, IN ULONG AllocationType, IN ULONG Protect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a8">MiDeletePageTablesForPhysicalRange</a> (IN PVOID StartingAddress, IN PVOID EndingAddress)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a0">MMVADKEY</a> = ' daV'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/allocvm_8c.html#a1">MmSupportWriteWatch</a> = FALSE</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="allocvm.c::MiCreatePageTablesForPhysicalRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCreatePageTablesForPhysicalRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/allocvm_8c-source.html#l02188">2188</a> of file <a class="el" href="../../d4/d5/allocvm_8c-source.html">allocvm.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01359">MI_INCREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">MiMakePdeExistAndMakeValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03591">MiMakePpeExistAndMakeValid</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02196                    :
02197 
02198     This routine initializes page directory and page table pages <span class="keywordflow">for</span> a
02199     user-controlled physical range of pages.
02200 
02201 Arguments:
02202 
02203     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
02204 
02205     StartingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
02206 
02207     EndingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
02208 
02209 Return Value:
02210 
02211     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page tables were created, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
02212 
02213 Environment:
02214 
02215     Kernel mode, APCs disabled, WorkingSetMutex and AddressCreation mutexes
02216     held.
02217 
02218 --*/
02219 
02220 {
02221     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02222     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02223     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPde;
02224     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02225     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02226     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
02227     PUCHAR Va;
02228     PVOID UsedPageDirectoryHandle;
02229     PVOID UsedPageTableHandle;
02230     LOGICAL FirstTime;
02231     KIRQL OldIrql;
02232     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02233     ULONG PagesNeeded;
02234 
02235     FirstTime = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02236     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
02237     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
02238     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
02239     LastPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (EndingAddress);
02240     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
02241 
02242     <span class="comment">//</span>
02243     <span class="comment">// Charge resident available pages for all of the page directory and table</span>
02244     <span class="comment">// pages as they will not be paged until the VAD is freed.</span>
02245     <span class="comment">//</span>
02246 
02247     <span class="keywordflow">if</span> (LastPte != PointerPte) {
02248         PagesNeeded = <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a> (PointerPte,
02249                                (ULONG)(LastPte - PointerPte) * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
02250 
02251 <span class="preprocessor">#if defined (_WIN64)</span>
02252 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (LastPde != PointerPde) {
02253             PagesNeeded += <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a> (PointerPde,
02254                                    (ULONG)(LastPde - PointerPde) * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
02255         }
02256 <span class="preprocessor">#endif</span>
02257 <span class="preprocessor"></span>    }
02258     <span class="keywordflow">else</span> {
02259         PagesNeeded = 1;
02260 <span class="preprocessor">#if defined (_WIN64)</span>
02261 <span class="preprocessor"></span>        PagesNeeded += 1;
02262 <span class="preprocessor">#endif</span>
02263 <span class="preprocessor"></span>    }
02264 
02265     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02266 
02267     <span class="keywordflow">if</span> ((SPFN_NUMBER)PagesNeeded &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 20) {
02268         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02269         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02270     }
02271 
02272     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= PagesNeeded;
02273     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(58, PagesNeeded);
02274     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02275 
02276     <span class="comment">//</span>
02277     <span class="comment">// Fill in all the page directory and page table pages with the zero PTE.</span>
02278     <span class="comment">//</span>
02279 
02280 <span class="preprocessor">#if defined (_WIN64)</span>
02281 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
02282     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
02283         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
02284         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
02285     }
02286 <span class="preprocessor">#endif</span>
02287 <span class="preprocessor"></span>
02288     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
02289 
02290     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02291 
02292         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte) || FirstTime == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02293 
02294             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
02295             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
02296 
02297 <span class="preprocessor">#if defined (_WIN64)</span>
02298 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte) || FirstTime == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02299                 <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
02300 
02301                 <span class="comment">//</span>
02302                 <span class="comment">// Up the sharecount so the page directory page will not get</span>
02303                 <span class="comment">// trimmed even if it has no currently valid entries.</span>
02304                 <span class="comment">//</span>
02305 
02306                 PteContents = *PointerPpe;
02307                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02308                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02309                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02310                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02311             }
02312 <span class="preprocessor">#endif</span>
02313 <span class="preprocessor"></span>
02314             FirstTime = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02315 
02316 <span class="preprocessor">#if defined (_WIN64)</span>
02317 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
02318                 UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
02319                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
02320             }
02321 <span class="preprocessor">#endif</span>
02322 <span class="preprocessor"></span>
02323             <span class="comment">//</span>
02324             <span class="comment">// Pointing to the next page table page, make</span>
02325             <span class="comment">// a page table page exist and make it valid.</span>
02326             <span class="comment">//</span>
02327 
02328             <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
02329 
02330             <span class="comment">//</span>
02331             <span class="comment">// Up the sharecount so the page table page will not get</span>
02332             <span class="comment">// trimmed even if it has no currently valid entries.</span>
02333             <span class="comment">//</span>
02334 
02335             PteContents = *PointerPde;
02336             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02337             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02338             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02339             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02340         }
02341 
02342         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Long == 0);
02343 
02344         <span class="comment">//</span>
02345         <span class="comment">// Increment the count of non-zero page table entries</span>
02346         <span class="comment">// for this page table - even though this entry is still zero,</span>
02347         <span class="comment">// this is a special case.</span>
02348         <span class="comment">//</span>
02349 
02350         Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02351         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (Va);
02352 
02353         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
02354 
02355         PointerPte += 1;
02356     }
02357     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02358 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="allocvm.c::MiDeletePageTablesForPhysicalRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDeletePageTablesForPhysicalRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/allocvm_8c-source.html#l02361">2361</a> of file <a class="el" href="../../d4/d5/allocvm_8c-source.html">allocvm.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01362">MI_DECREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01357">MI_GET_USED_PTES_FROM_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02368                    :
02369 
02370     This routine deletes page directory and page table pages <span class="keywordflow">for</span> a
02371     user-controlled physical range of pages.
02372 
02373     Even though PTEs may be zero in <span class="keyword">this</span> range, UsedPageTable counts were
02374     incremented <span class="keywordflow">for</span> these special ranges and must be decremented now.
02375 
02376 Arguments:
02377 
02378     StartingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
02379 
02380     EndingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
02381 
02382 Return Value:
02383 
02384     None.
02385 
02386 Environment:
02387 
02388     Kernel mode, APCs disabled, WorkingSetMutex and AddressCreation mutexes
02389     held.
02390 
02391 --*/
02392 
02393 {
02394     PVOID TempVa;
02395     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02396     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02397     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPde;
02398     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02399     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02400     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
02401     ULONG PagesNeeded;
02402     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
02403     PVOID UsedPageTableHandle;
02404     PVOID UsedPageDirectoryHandle;
02405     KIRQL OldIrql;
02406     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02407 
02408     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02409 
02410     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
02411     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
02412     LastPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (EndingAddress);
02413     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
02414 
02415     UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (StartingAddress);
02416 
02417     <span class="comment">//</span>
02418     <span class="comment">// Each PTE is already zeroed - just delete the containing pages.</span>
02419     <span class="comment">//</span>
02420 
02421     <span class="comment">//</span>
02422     <span class="comment">// Restore resident available pages for all of the page directory and table</span>
02423     <span class="comment">// pages as they can now be paged again.</span>
02424     <span class="comment">//</span>
02425 
02426     <span class="keywordflow">if</span> (LastPte != PointerPte) {
02427         PagesNeeded = <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a> (PointerPte,
02428                                (ULONG)(LastPte - PointerPte) * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
02429 
02430 <span class="preprocessor">#if defined (_WIN64)</span>
02431 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (LastPde != PointerPde) {
02432             PagesNeeded += <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a> (PointerPde,
02433                                    (ULONG)(LastPde - PointerPde) * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
02434         }
02435 <span class="preprocessor">#endif</span>
02436 <span class="preprocessor"></span>    }
02437     <span class="keywordflow">else</span> {
02438         PagesNeeded = 1;
02439 <span class="preprocessor">#if defined (_WIN64)</span>
02440 <span class="preprocessor"></span>        PagesNeeded += 1;
02441 <span class="preprocessor">#endif</span>
02442 <span class="preprocessor"></span>    }
02443 
02444     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02445 
02446     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesNeeded;
02447     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(59, PagesNeeded);
02448 
02449     <span class="keywordflow">while</span> (StartingAddress &lt;= EndingAddress) {
02450 
02451         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Long == 0);
02452 
02453         PointerPte += 1;
02454 
02455         <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
02456 
02457         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) || (PointerPte &gt; LastPte)) {
02458 
02459             <span class="comment">//</span>
02460             <span class="comment">// The virtual address is on a page directory boundary or it is</span>
02461             <span class="comment">// the last address in the entire range.</span>
02462             <span class="comment">//</span>
02463             <span class="comment">// If all the entries have been eliminated from the previous</span>
02464             <span class="comment">// page table page, delete the page table page itself.</span>
02465             <span class="comment">//</span>
02466 
02467             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte - 1);
02468             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02469 
02470             <span class="comment">//</span>
02471             <span class="comment">// Down the sharecount on the finished page table page.</span>
02472             <span class="comment">//</span>
02473 
02474             PteContents = *PointerPde;
02475             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02476             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt; 1);
02477             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
02478 
02479             <span class="comment">//</span>
02480             <span class="comment">// If all the entries have been eliminated from the previous</span>
02481             <span class="comment">// page table page, delete the page table page itself.</span>
02482             <span class="comment">//</span>
02483 
02484             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageTableHandle) == 0) {
02485 
02486                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
02487                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
02488                              TempVa,
02489                              FALSE,
02490                              CurrentProcess,
02491                              NULL,
02492                              NULL);
02493 
02494 <span class="preprocessor">#if defined (_WIN64)</span>
02495 <span class="preprocessor"></span>                UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte - 1);
02496                 <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
02497 <span class="preprocessor">#endif</span>
02498 <span class="preprocessor"></span>            }
02499 
02500 <span class="preprocessor">#if defined (_WIN64)</span>
02501 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) || (PointerPte &gt; LastPte)) {
02502 
02503                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
02504                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02505 
02506                 UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte - 1);
02507                 <span class="comment">//</span>
02508                 <span class="comment">// Down the sharecount on the finished page directory page.</span>
02509                 <span class="comment">//</span>
02510 
02511                 PteContents = *PointerPpe;
02512                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02513                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt; 1);
02514                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
02515 
02516                 <span class="comment">//</span>
02517                 <span class="comment">// If all the entries have been eliminated from the previous</span>
02518                 <span class="comment">// page directory page, delete the page directory page itself.</span>
02519                 <span class="comment">//</span>
02520 
02521                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0) {
02522                     TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
02523                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
02524                                  TempVa,
02525                                  FALSE,
02526                                  CurrentProcess,
02527                                  NULL,
02528                                  NULL);
02529                 }
02530             }
02531 <span class="preprocessor">#endif</span>
02532 <span class="preprocessor"></span>
02533             <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
02534                 <span class="keywordflow">break</span>;
02535             }
02536 
02537             <span class="comment">//</span>
02538             <span class="comment">// Release the PFN lock.  This prevents a single thread</span>
02539             <span class="comment">// from forcing other high priority threads from being</span>
02540             <span class="comment">// blocked while a large address range is deleted.</span>
02541             <span class="comment">//</span>
02542 
02543             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02544             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> ((PVOID)((PUCHAR)StartingAddress + PAGE_SIZE));
02545             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02546         }
02547 
02548         StartingAddress = (PVOID)((PUCHAR)StartingAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02549     }
02550 
02551     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02552 
02553     <span class="comment">//</span>
02554     <span class="comment">// All done, return.</span>
02555     <span class="comment">//</span>
02556 
02557     <span class="keywordflow">return</span>;
02558 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="allocvm.c::MiFlushAcquire" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFlushAcquire           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ControlArea</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00223">223</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00229                    :
00230 
00231     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a helper routine to reference count <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">if</span> needed
00232     during a flush section call to prevent <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object from being
00233     deleted <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ongoing.
00234 
00235 Arguments:
00236 
00237     ControlArea - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area.
00238 
00239 Return Value:
00240 
00241     None.
00242 
00243 --*/
00244 
00245 {
00246     KIRQL OldIrql;
00247 
00248     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00249 
00250     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfMappedViews &gt;= 1);
00251     ControlArea-&gt;NumberOfMappedViews += 1;
00252 
00253     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00254 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="allocvm.c::MiFlushRelease" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFlushRelease           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ControlArea</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00258">258</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00264                    :
00265 
00266     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a helper routine to release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area reference needed
00267     during a flush section call.
00268 
00269 Arguments:
00270 
00271     ControlArea - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area.
00272 
00273 Return Value:
00274 
00275     None.
00276 
00277 --*/
00278 
00279 {
00280     KIRQL OldIrql;
00281 
00282     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00283 
00284     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfMappedViews &gt;= 1);
00285     ControlArea-&gt;NumberOfMappedViews -= 1;
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// Check to see if the control area should be deleted.  This</span>
00289     <span class="comment">// will release the PFN lock.</span>
00290     <span class="comment">//</span>
00291 
00292     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="allocvm.c::MiPhysicalViewInserter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiPhysicalViewInserter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalView</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02583">2583</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00922">LOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02440">MiActiveWriteWatch</a>, <a class="el" href="../../d4/d8/mi_8h.html#a773">MiMarkProcessAsWriteWatch()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00925">UNLOCK_AWE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02590                    :
02591 
02592     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a nonpaged wrapper which acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN lock to insert
02593     a physical VAD into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process chain.
02594 
02595 Arguments:
02596 
02597     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical VAD to.
02598 
02599     PhysicalView - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical view data to link in.
02600 
02601 Return Value:
02602 
02603     None.
02604 
02605 Environment:
02606 
02607     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, working set and address space mutexes held.
02608 
02609 --*/
02610 {
02611     KIRQL OldIrql;
02612     KIRQL OldIrql2;
02613 
02614     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
02615 
02616     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
02617 
02618     InsertHeadList (&amp;Process-&gt;PhysicalVadList, &amp;PhysicalView-&gt;ListEntry);
02619 
02620     <span class="keywordflow">if</span> (PhysicalView-&gt;Vad-&gt;u.VadFlags.WriteWatch == 1) {
02621         <a class="code" href="../../d4/d8/mi_8h.html#a495">MiActiveWriteWatch</a> += 1;
02622     }
02623 
02624     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
02625 
02626     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
02627 
02628     <span class="keywordflow">if</span> (PhysicalView-&gt;Vad-&gt;u.VadFlags.WriteWatch == 1) {
02629 
02630         <span class="comment">//</span>
02631         <span class="comment">// Mark this process as forever containing write-watch</span>
02632         <span class="comment">// address space(s).</span>
02633 
02634         <span class="keywordflow">if</span> (Process-&gt;Vm.u.Flags.WriteWatch == 0) {
02635             <a class="code" href="../../d4/d8/mi_8h.html#a773">MiMarkProcessAsWriteWatch</a> (Process);
02636         }
02637     }
02638 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="allocvm.c::MiResetVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiResetVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vad</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/allocvm_8c-source.html#l01953">1953</a> of file <a class="el" href="../../d4/d5/allocvm_8c-source.html">allocvm.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00757">MI_IS_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00733">MI_SET_PTE_CLEAN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03696">MiGetProtoPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00837">MiMakeSystemAddressValidPfnWs()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>01962                    :
01963 
01964 
01965 Arguments:
01966 
01967     StartingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
01968 
01969     RegionsSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size.
01970 
01971     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
01972 
01973 Return Value:
01974 
01975 Environment:
01976 
01977     Kernel mode, APCs disabled, WorkingSetMutex and AddressCreation mutexes
01978     held.
01979 
01980 --*/
01981 
01982 {
01983     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01984     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
01985     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01986     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01987     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01988     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01989     ULONG Waited;
01990     ULONG PfnHeld;
01991     ULONG First;
01992     KIRQL OldIrql;
01993     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01994 
01995     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.PrivateMemory == 0) {
01996 
01997         <span class="keywordflow">if</span> (Vad-&gt;ControlArea-&gt;FilePointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01998 
01999             <span class="comment">//</span>
02000             <span class="comment">// Only page file backed sections can be committed.</span>
02001             <span class="comment">//</span>
02002 
02003             <span class="keywordflow">return</span> STATUS_USER_MAPPED_FILE;
02004         }
02005     }
02006 
02007     PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02008 
02009     First = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02010     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
02011     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
02012 
02013     <span class="comment">//</span>
02014     <span class="comment">// Examine all the PTEs in the range.</span>
02015     <span class="comment">//</span>
02016 
02017     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02018 
02019         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte) || (First)) {
02020 
02021             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte)) {
02022 
02023                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
02024 
02025                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a>(PointerPpe,
02026                                                 Process,
02027                                                 (BOOLEAN)PfnHeld,
02028                                                 &amp;Waited)) {
02029 
02030                     <span class="comment">//</span>
02031                     <span class="comment">// This page directory parent entry is empty,</span>
02032                     <span class="comment">// go to the next one.</span>
02033                     <span class="comment">//</span>
02034 
02035                     PointerPpe += 1;
02036                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
02037                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
02038                     <span class="keywordflow">continue</span>;
02039                 }
02040             }
02041 
02042             <span class="comment">//</span>
02043             <span class="comment">// Pointing to the next page table page, make</span>
02044             <span class="comment">// a page table page exist and make it valid.</span>
02045             <span class="comment">//</span>
02046 
02047             First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02048             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
02049             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde,
02050                                             Process,
02051                                             (BOOLEAN)PfnHeld,
02052                                             &amp;Waited)) {
02053 
02054                 <span class="comment">//</span>
02055                 <span class="comment">// This page directory entry is empty, go to the next one.</span>
02056                 <span class="comment">//</span>
02057 
02058                 PointerPde += 1;
02059                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
02060                 <span class="keywordflow">continue</span>;
02061             }
02062         }
02063 
02064         PteContents = *PointerPte;
02065         ProtoPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02066 
02067         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) &amp;&amp;
02068             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1))  {
02069 
02070             <span class="comment">//</span>
02071             <span class="comment">// This is a prototype PTE, evaluate the prototype PTE.</span>
02072             <span class="comment">//</span>
02073 
02074             ProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad,
02075                                             MI_VA_TO_VPN (
02076                                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte)));
02077             <span class="keywordflow">if</span> (!PfnHeld) {
02078                 PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02079                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02080             }
02081 
02082             <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (ProtoPte, Process);
02083 
02084             <span class="comment">//</span>
02085             <span class="comment">// The working set mutex may be released in order to make the</span>
02086             <span class="comment">// prototype PTE which resides in paged pool resident.  If this</span>
02087             <span class="comment">// occurs, the page directory and/or page table of the original</span>
02088             <span class="comment">// user address may get trimmed.  Account for that here.</span>
02089             <span class="comment">//</span>
02090 
02091             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (ProtoPte, Process) != 0) {
02092 
02093                 <span class="comment">//</span>
02094                 <span class="comment">// Working set mutex was released, restart from the top.</span>
02095                 <span class="comment">//</span>
02096 
02097                 First = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02098                 <span class="keywordflow">continue</span>;
02099             }
02100 
02101             PteContents = *ProtoPte;
02102         }
02103         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02104             <span class="keywordflow">if</span> (!PfnHeld) {
02105                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02106                 PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02107                 <span class="keywordflow">continue</span>;
02108             }
02109 
02110             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02111             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1) {
02112 
02113                 <span class="comment">//</span>
02114                 <span class="comment">// Only this process has the page mapped.</span>
02115                 <span class="comment">//</span>
02116 
02117                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
02118                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02119                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
02120             }
02121 
02122             <span class="keywordflow">if</span> ((!ProtoPte) &amp;&amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents))) {
02123 
02124                 <span class="comment">//</span>
02125                 <span class="comment">// Clear the dirty bit and flush tb if it is NOT a prototype</span>
02126                 <span class="comment">// PTE.</span>
02127                 <span class="comment">//</span>
02128 
02129                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a113">MI_SET_PTE_CLEAN</a> (PteContents);
02130                 <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (MiGetVirtualAddressMappedByPte (PointerPte),
02131                                  TRUE,
02132                                  FALSE,
02133                                  (PHARDWARE_PTE)PointerPte,
02134                                  PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
02135             }
02136 
02137         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
02138             <span class="keywordflow">if</span> (!PfnHeld) {
02139                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02140                 PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02141                 <span class="keywordflow">continue</span>;
02142             }
02143             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
02144             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>) &amp;&amp;
02145                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0)) {
02146 
02147                 <span class="comment">//</span>
02148                 <span class="comment">// Remove from the modified list, release the page</span>
02149                 <span class="comment">// file space and insert on the standby list.</span>
02150                 <span class="comment">//</span>
02151 
02152                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
02153                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
02154                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02155                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
02156                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[StandbyPageList],
02157                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;PteContents));
02158             }
02159         } <span class="keywordflow">else</span> {
02160             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != 0) {
02161                 <span class="keywordflow">if</span> (!PfnHeld) {
02162                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02163                 }
02164                 PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02165                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
02166                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02167                 <span class="keywordflow">if</span> (ProtoPte) {
02168                     ProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
02169                 } <span class="keywordflow">else</span> {
02170                     PointerPte-&gt;u.Soft.PageFileHigh = 0;
02171                 }
02172             } <span class="keywordflow">else</span> {
02173                 <span class="keywordflow">if</span> (PfnHeld) {
02174                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02175                 }
02176                 PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02177             }
02178         }
02179         PointerPte += 1;
02180     }
02181     <span class="keywordflow">if</span> (PfnHeld) {
02182         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02183     }
02184     <span class="keywordflow">return</span> STATUS_SUCCESS;
02185 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="allocvm.c::NtAllocateVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAllocateVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Protect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">75</a> of file <a class="el" href="../../d4/d5/allocvm_8c-source.html">allocvm.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l03244">ALT_ALLOCATE</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l03245">ALT_COMMIT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02430">_MI_PHYSICAL_VIEW::BitMap</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00186">_EPROCESS::CommitCharge</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00304">_EPROCESS::CommitChargeLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00305">_EPROCESS::CommitChargePeak</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02429">_MI_PHYSICAL_VIEW::EndVa</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02294">_SECTION::InitialPageProtection</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00285">_EPROCESS::Job</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00025">MEM_CHECK_COMMIT_STATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00360">MI_64K_ALIGN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01359">MI_INCREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00280">MI_IS_PTE_PROTECTION_COPY_WRITE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a493">MI_PHYSICAL_VIEW</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02433">MI_PHYSICAL_VIEW_KEY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02434">MI_WRITEWATCH_VIEW_KEY</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00519">MiCalculatePageCommitment()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00058">MiChargePageFileQuota()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02244">MiCheckSecuredVad()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l02188">MiCreatePageTablesForPhysicalRange()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00431">MiFindEmptyAddressRange()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00451">MiFindEmptyAddressRangeDown</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00223">MiFlushAcquire()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00258">MiFlushRelease()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01874">MiGetPageProtection()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03696">MiGetProtoPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a907">MiIsEntireRangeDecommitted()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">MiMakePdeExistAndMakeValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03591">MiMakePpeExistAndMakeValid</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a317">MiMakeProtectForNativePage()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02583">MiPhysicalViewInserter()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l01953">MiResetVirtualMemory()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00133">MiReturnPageFileQuota()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04250">MM_DBG_COMMIT_ALLOCVM1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04251">MM_DBG_COMMIT_ALLOCVM2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04279">MM_DBG_COMMIT_RETURN_ALLOCVM1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04280">MM_DBG_COMMIT_RETURN_ALLOCVM2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04281">MM_DBG_COMMIT_RETURN_ALLOCVM3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00189">MM_DBG_SHOW_NT_CALLS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00144">MM_DECOMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00096">MM_HIGHEST_VAD_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02338">MM_MAX_COMMIT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00133">MM_MAXIMUM_ZERO_BITS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00154">MM_PROTECTION_COPY_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00132">MM_USER_ADDRESS_RANGE_LIMIT</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00201">MmExtendSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04827">MmSectionCommitMutex</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00074">MmSharedCommit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00091">MmSupportWriteWatch</a>, <a class="el" href="../../d4/d8/mi_8h.html#a491">MMVAD_SHORT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02009">_SEGMENT::NumberOfCommittedPages</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l03208">PAGE_4K</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l03211">PAGE_4K_ALIGN</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00193">_EPROCESS::PeakVirtualSize</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01598">ProbeForWritePointer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01666">ProbeForWriteUlong_ptr</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00318">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02823">PsChangeJobMemoryUsage()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02901">PsReportProcessMemoryLimitViolation()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l03212">ROUND_TO_4K_PAGES</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00266">RtlClearAllBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02923">RtlFindMostSignificantBit()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a479">SECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02288">_SECTION::Segment</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02010">_SEGMENT::SegmentPteTemplate</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02428">_MI_PHYSICAL_VIEW::StartVa</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d5/d0/struct__SECTION.html#o5">_SECTION::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00194">_EPROCESS::VirtualSize</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00295">_EPROCESS::Wow64Process</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00278">ExAllocatePool()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d6/d3/tprofile_8c-source.html#l00024">main()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00259">RegLoadAsciiFileAsUnicode()</a>, <a class="el" href="../../d2/d7/rtl_2handle_8c-source.html#l00060">RtlAllocateHandle()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00316">RtlCreateQueryDebugBuffer()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05954">RtlpAllocateHeapUsageEntry()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05225">RtlpAllocateTags()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00260">RtlpCommitQueryDebugInfo()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l02025">RtlpValidateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00112">RtlpValidateHeapHeaders()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02976">RtlUsageHeap()</a>.
<p>
<pre class="fragment"><div>00086                    :
00087 
00088     This function creates a region of pages within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address
00089     space of a subject process.
00090 
00091 Arguments:
00092 
00093     ProcessHandle - Supplies an open handle to a process object.
00094 
00095     BaseAddress - Supplies a pointer to a variable that will receive
00096                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated region of pages.
00097                   If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null,
00098                   then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region will be allocated starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00099                   specified <span class="keyword">virtual</span> address rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next
00100                   host page size address boundary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial
00101                   value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating
00102                   system will determine where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region.
00103         
00104     ZeroBits - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> order address bits that
00105                must be zero in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section view. The
00106                value of <span class="keyword">this</span> argument must be less than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00107                maximum number of zero bits and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used when memory
00108                management determines where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view (i.e. when
00109                BaseAddress is null).
00110 
00111                If ZeroBits <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then no zero bit constraints are applied.
00112 
00113                If ZeroBits <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than 0 and less than 32, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00114                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of leading zero bits from bit 31.  Bits 63:32 are
00115                also required to be zero.  This retains compatibility
00116                with 32-bit systems.
00117                 
00118                If ZeroBits <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than 32, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> considered as
00119                a mask and then number of leading zero are counted <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>
00120                in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask.  This then becomes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zero bits argument.
00121 
00122     RegionSize - Supplies a pointer to a variable that will receive
00123                  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated region
00124                  of pages. The initial value of <span class="keyword">this</span> argument
00125                  specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00126                  rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00127 
00128     AllocationType - Supplies a set of flags that describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
00129                      of allocation that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be performed <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00130                      specified region of pages. Flags are:
00131             
00132 
00133          MEM_COMMIT - The specified region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00134               be committed.
00135 
00136          MEM_RESERVE - The specified region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00137               be reserved.
00138 
00139          MEM_TOP_DOWN - The specified region should be created at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00140               highest <span class="keyword">virtual</span> address possible based on ZeroBits.
00141 
00142          MEM_RESET - Reset <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified region so
00143               that <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are in page paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, they
00144               are discarded and pages of zeroes are brought in.
00145               If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are in memory and modified, they are marked
00146               as not modified so they will not be written <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> to
00147               <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The contents are NOT zeroed.
00148 
00149               The Protect argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored, but a valid protection
00150               must be specified.
00151 
00152     Protect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection desired <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed
00153               region of pages.
00154 
00155         Protect Values:
00156 
00157 
00158          PAGE_NOACCESS - No access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region
00159               of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An attempt to read,
00160               write, or execute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region
00161               results in an access violation (i.e. a GP
00162               fault).
00163 
00164          PAGE_EXECUTE - Execute access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed
00165               region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An attempt to
00166               read or write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region results in
00167               an access violation.
00168 
00169          PAGE_READONLY - Read <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> and execute access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00170               committed region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. An
00171               attempt to write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region results
00172               in an access violation.
00173 
00174          PAGE_READWRITE - Read, write, and execute access to
00175               <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> committed region of pages <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed. If
00176               write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00177               allowed, then a single copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are
00178               shared. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are shared read
00179               <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>/copy on write.
00180 
00181          PAGE_NOCACHE - The region of pages should be allocated
00182               as non-cachable.
00183 
00184 Return Value:
00185 
00186     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> codes.
00187 
00188 --*/
00189 
00190 {
00191     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00192     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad;
00193     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00194     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00195     PVOID StartingAddress;
00196     PVOID EndingAddress;
00197     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198     PVOID TopAddress;
00199     PVOID CapturedBase;
00200     SIZE_T CapturedRegionSize;
00201     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00202     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CommitLimitPte;
00203     ULONG ProtectionMask;
00204     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00205     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00206     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00207     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte;
00208     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00209     ULONG OldProtect;
00210     SSIZE_T QuotaCharge;
00211     SIZE_T QuotaFree;
00212     SIZE_T CopyOnWriteCharge;
00213     BOOLEAN PageFileChargeSucceeded;
00214     BOOLEAN Attached;
00215     LOGICAL ChargedExactQuota;
00216     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> DecommittedPte;
00217     ULONG ChangeProtection;
00218     PVOID UsedPageDirectoryHandle;
00219     PVOID UsedPageTableHandle;
00220     PUCHAR Va;
00221     LOGICAL ChargedJobCommit;
00222     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00223     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00224     ULONG BitMapSize;
00225     ULONG BitMapBits;
00226 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00227 <span class="preprocessor"></span>    PVOID OriginalBase;
00228     SIZE_T OriginalRegionSize;
00229     BOOLEAN EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00230     PVOID StartingAddressFor4k;
00231     PVOID EndingAddressFor4k;
00232     SIZE_T CapturedRegionSizeFor4k;
00233     ULONG CapturedOldProtectFor4k;
00234     ULONG OriginalProtectionMask;
00235     ULONG AltFlags;
00236 <span class="preprocessor">#endif</span>
00237 <span class="preprocessor"></span>
00238     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00239 
00240     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00241 
00242     <span class="comment">//</span>
00243     <span class="comment">// Check the zero bits argument for correctness.</span>
00244     <span class="comment">//</span>
00245 
00246 <span class="preprocessor">#if defined (_WIN64)</span>
00247 <span class="preprocessor"></span>
00248     <span class="keywordflow">if</span> (ZeroBits &gt;= 32) {
00249 
00250         <span class="comment">//</span>
00251         <span class="comment">// ZeroBits is a mask instead of a count.  Translate it to a count now.</span>
00252         <span class="comment">//</span>
00253 
00254         ZeroBits = 64 - <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a44">RtlFindMostSignificantBit</a> (ZeroBits);        
00255     }
00256     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ZeroBits) {
00257         ZeroBits += 32;
00258     }
00259 
00260 <span class="preprocessor">#endif</span>
00261 <span class="preprocessor"></span>
00262     <span class="keywordflow">if</span> (ZeroBits &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a10">MM_MAXIMUM_ZERO_BITS</a>) {
00263         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00264     }
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// Check the AllocationType for correctness.</span>
00268     <span class="comment">//</span>
00269 
00270     <span class="keywordflow">if</span> ((AllocationType &amp; ~(MEM_COMMIT | MEM_RESERVE | MEM_PHYSICAL |
00271                             MEM_TOP_DOWN | MEM_RESET | MEM_WRITE_WATCH)) != 0) {
00272         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_5;
00273     }
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// One of MEM_COMMIT, MEM_RESET or MEM_RESERVE must be set.</span>
00277     <span class="comment">//</span>
00278 
00279     <span class="keywordflow">if</span> ((AllocationType &amp; (MEM_COMMIT | MEM_RESERVE | MEM_RESET)) == 0) {
00280         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_5;
00281     }
00282 
00283     <span class="keywordflow">if</span> ((AllocationType &amp; MEM_RESET) &amp;&amp; (AllocationType != MEM_RESET)) {
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">// MEM_RESET may not be used with any other flag.</span>
00287         <span class="comment">//</span>
00288 
00289         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_5;
00290     }
00291 
00292     <span class="keywordflow">if</span> (AllocationType &amp; MEM_WRITE_WATCH) {
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">// Write watch address spaces can only be created with MEM_RESERVE.</span>
00296         <span class="comment">//</span>
00297 
00298         <span class="keywordflow">if</span> ((AllocationType &amp; MEM_RESERVE) == 0) {
00299             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_5;
00300         }
00301 
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a35">MmSupportWriteWatch</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00303             <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00304         }
00305     }
00306 
00307     <span class="keywordflow">if</span> (AllocationType &amp; MEM_PHYSICAL) {
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">// MEM_PHYSICAL must be used with MEM_RESERVE and no other flags.</span>
00311         <span class="comment">// This memory is always read-write when allocated.</span>
00312         <span class="comment">//</span>
00313 
00314         <span class="keywordflow">if</span> (AllocationType != (MEM_RESERVE | MEM_PHYSICAL)) {
00315             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_5;
00316         }
00317 
00318         <span class="keywordflow">if</span> (Protect != PAGE_READWRITE) {
00319             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_6;
00320         }
00321     }
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00325     <span class="comment">//</span>
00326 
00327     <span class="keywordflow">try</span> {
00328         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (Protect);
00329     } except (EXCEPTION_EXECUTE_HANDLER) {
00330         <span class="keywordflow">return</span> GetExceptionCode();
00331     }
00332 
00333     ChangeProtection = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00334 
00335     PreviousMode = KeGetPreviousMode();
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">// Establish an exception handler, probe the specified addresses</span>
00339     <span class="comment">// for write access and capture the initial values.</span>
00340     <span class="comment">//</span>
00341 
00342     <span class="keywordflow">try</span> {
00343 
00344         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00345 
00346             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> (BaseAddress);
00347             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00348         }
00349 
00350         <span class="comment">//</span>
00351         <span class="comment">// Capture the base address.</span>
00352         <span class="comment">//</span>
00353 
00354         CapturedBase = *BaseAddress;
00355 
00356         <span class="comment">//</span>
00357         <span class="comment">// Capture the region size.</span>
00358         <span class="comment">//</span>
00359 
00360         CapturedRegionSize = *RegionSize;
00361 
00362     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00363 
00364         <span class="comment">//</span>
00365         <span class="comment">// If an exception occurs during the probe or capture</span>
00366         <span class="comment">// of the initial values, then handle the exception and</span>
00367         <span class="comment">// return the exception code as the status value.</span>
00368         <span class="comment">//</span>
00369 
00370         <span class="keywordflow">return</span> GetExceptionCode();
00371     }
00372 
00373 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00374 <span class="preprocessor"></span>
00375     OriginalBase = CapturedBase;
00376     OriginalRegionSize = CapturedRegionSize;
00377 
00378 <span class="preprocessor">#endif</span>
00379 <span class="preprocessor"></span>
00380 <span class="preprocessor">#if DBG</span>
00381 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00382         <span class="keywordflow">if</span> ( MmWatchProcess ) {
00383             ;
00384         } <span class="keywordflow">else</span> {
00385             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"allocvm process handle %lx base address %lx zero bits %lx\n"</span>,
00386                 ProcessHandle, CapturedBase, ZeroBits);
00387             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    region size %lx alloc type %lx protect %lx\n"</span>,
00388                 CapturedRegionSize, AllocationType, Protect);
00389         }
00390     }
00391 <span class="preprocessor">#endif</span>
00392 <span class="preprocessor"></span>
00393     <span class="comment">//</span>
00394     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00395     <span class="comment">// within the user part of the virtual address space.</span>
00396     <span class="comment">//</span>
00397 
00398     <span class="keywordflow">if</span> (CapturedBase &gt; <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) {
00399 
00400         <span class="comment">//</span>
00401         <span class="comment">// Invalid base address.</span>
00402         <span class="comment">//</span>
00403 
00404         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00405     }
00406 
00407     <span class="keywordflow">if</span> ((((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1) - (ULONG_PTR)CapturedBase) &lt;
00408             CapturedRegionSize) {
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// Invalid region size;</span>
00412         <span class="comment">//</span>
00413 
00414         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00415     }
00416 
00417     <span class="keywordflow">if</span> (CapturedRegionSize == 0) {
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">// Region size cannot be 0.</span>
00421         <span class="comment">//</span>
00422 
00423         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00424     }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Reference the specified process handle for VM_OPERATION access.</span>
00428     <span class="comment">//</span>
00429 
00430     <span class="keywordflow">if</span> ( ProcessHandle == NtCurrentProcess() ) {
00431         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00432     } <span class="keywordflow">else</span> {
00433         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00434                                              PROCESS_VM_OPERATION,
00435                                              PsProcessType,
00436                                              PreviousMode,
00437                                              (PVOID *)&amp;Process,
00438                                              NULL );
00439 
00440         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00441             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00442         }
00443     }
00444 
00445     <span class="comment">//</span>
00446     <span class="comment">// If the specified process is not the current process, attach</span>
00447     <span class="comment">// to the specified process.</span>
00448     <span class="comment">//</span>
00449 
00450     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00451         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00452         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00453     }
00454 
00455     <span class="comment">//</span>
00456     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
00457     <span class="comment">// creating or deleting address space at the same time and</span>
00458     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
00459     <span class="comment">// be inserted and walked.  Block APCs so an APC which takes a page</span>
00460     <span class="comment">// fault does not corrupt various structures.</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00467     <span class="comment">//</span>
00468 
00469     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
00470         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00471         <span class="keywordflow">goto</span> ErrorReturn;
00472     }
00473 
00474     <span class="keywordflow">if</span> ((CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (AllocationType &amp; MEM_RESERVE)) {
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// PAGE_WRITECOPY is not valid for private pages.</span>
00478         <span class="comment">//</span>
00479 
00480         <span class="keywordflow">if</span> ((Protect &amp; PAGE_WRITECOPY) ||
00481             (Protect &amp; PAGE_EXECUTE_WRITECOPY)) {
00482             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
00483             <span class="keywordflow">goto</span> ErrorReturn;
00484         }
00485 
00486         <span class="comment">//</span>
00487         <span class="comment">// Reserve the address space.</span>
00488         <span class="comment">//</span>
00489 
00490         <span class="keywordflow">if</span> (CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00491 
00492             <span class="comment">//</span>
00493             <span class="comment">// No base address was specified.  This MUST be a reserve or</span>
00494             <span class="comment">// reserve and commit.</span>
00495             <span class="comment">//</span>
00496 
00497             CapturedRegionSize = <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedRegionSize);
00498 
00499             <span class="comment">//</span>
00500             <span class="comment">// If the number of zero bits is greater than zero, then calculate</span>
00501             <span class="comment">// the highest address.</span>
00502             <span class="comment">//</span>
00503 
00504             <span class="keywordflow">if</span> (ZeroBits != 0) {
00505                 TopAddress = (PVOID)(((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a9">MM_USER_ADDRESS_RANGE_LIMIT</a>) &gt;&gt; ZeroBits);
00506 
00507                 <span class="comment">//</span>
00508                 <span class="comment">// Keep the top address below the highest user vad address</span>
00509                 <span class="comment">// regardless.</span>
00510                 <span class="comment">//</span>
00511 
00512                 <span class="keywordflow">if</span> (TopAddress &gt; <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) {
00513                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00514                     <span class="keywordflow">goto</span> ErrorReturn;
00515                 }
00516 
00517             } <span class="keywordflow">else</span> {
00518                 TopAddress = (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>;
00519             }
00520 
00521 <span class="preprocessor">#if defined (_WIN64)</span>
00522 <span class="preprocessor"></span>
00523             <span class="comment">//</span>
00524             <span class="comment">// BUGBUG:</span>
00525             <span class="comment">// For testing purposes, always set the MEM_TOP_DOWN flag to reduce</span>
00526             <span class="comment">// the number of low 4GB address allocations.  This helps the</span>
00527             <span class="comment">// compiler people catch address truncation errors.</span>
00528             <span class="comment">// This must be removed before the final build.</span>
00529             <span class="comment">//</span>
00530 
00531             AllocationType |= MEM_TOP_DOWN;
00532 
00533 <span class="preprocessor">#endif</span>
00534 <span class="preprocessor"></span>            <span class="comment">//</span>
00535             <span class="comment">// Establish exception handler as MiFindEmptyAddressRange</span>
00536             <span class="comment">// will raise an exception if it fails.</span>
00537             <span class="comment">//</span>
00538 
00539             <span class="keywordflow">try</span> {
00540 
00541                 <span class="keywordflow">if</span> (AllocationType &amp; MEM_TOP_DOWN) {
00542 
00543                     <span class="comment">//</span>
00544                     <span class="comment">// Start from the top of memory downward.</span>
00545                     <span class="comment">//</span>
00546 
00547                     StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a94">MiFindEmptyAddressRangeDown</a> (
00548                                                   CapturedRegionSize,
00549                                                   TopAddress,
00550                                                   X64K);
00551 
00552                 } <span class="keywordflow">else</span> {
00553 
00554                     StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (
00555                                                     CapturedRegionSize,
00556                                                     X64K,
00557                                                     (ULONG)ZeroBits );
00558                 }
00559 
00560             } except (EXCEPTION_EXECUTE_HANDLER) {
00561                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00562                 <span class="keywordflow">goto</span> ErrorReturn;
00563             }
00564 
00565             <span class="comment">//</span>
00566             <span class="comment">// Calculate the ending address based on the top address.</span>
00567             <span class="comment">//</span>
00568 
00569             EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
00570                                   CapturedRegionSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00571 
00572             <span class="keywordflow">if</span> (EndingAddress &gt; TopAddress) {
00573 
00574                 <span class="comment">//</span>
00575                 <span class="comment">// The allocation does not honor the zero bits argument.</span>
00576                 <span class="comment">//</span>
00577 
00578                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00579                 <span class="keywordflow">goto</span> ErrorReturn;
00580             }
00581 
00582         } <span class="keywordflow">else</span> {
00583 
00584             <span class="comment">//</span>
00585             <span class="comment">// A non-NULL base address was specified. Check to make sure</span>
00586             <span class="comment">// the specified base address to ending address is currently</span>
00587             <span class="comment">// unused.</span>
00588             <span class="comment">//</span>
00589 
00590             EndingAddress = (PVOID)(((ULONG_PTR)CapturedBase +
00591                                   CapturedRegionSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00592 
00593             <span class="comment">//</span>
00594             <span class="comment">// Align the starting address on a 64k boundary.</span>
00595             <span class="comment">//</span>
00596 
00597             StartingAddress = (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(CapturedBase);
00598 
00599             <span class="comment">//</span>
00600             <span class="comment">// See if a VAD overlaps with this starting/ending address pair.</span>
00601             <span class="comment">//</span>
00602 
00603             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress) !=
00604                     (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00605 
00606                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00607                 <span class="keywordflow">goto</span> ErrorReturn;
00608             }
00609         }
00610 
00611         <span class="comment">//</span>
00612         <span class="comment">// Calculate the page file quota for this address range.</span>
00613         <span class="comment">//</span>
00614 
00615         <span class="keywordflow">if</span> (AllocationType &amp; MEM_COMMIT) {
00616             QuotaCharge = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((PCHAR)EndingAddress -
00617                                           (PCHAR)StartingAddress);
00618 
00619         } <span class="keywordflow">else</span> {
00620             QuotaCharge = 0;
00621         }
00622 
00623         <span class="comment">//</span>
00624         <span class="comment">// An unoccupied address range has been found, build the virtual</span>
00625         <span class="comment">// address descriptor to describe this range.</span>
00626         <span class="comment">//</span>
00627         <span class="comment">// Allocate and initialize a VAD for the specified address range.</span>
00628         <span class="comment">//</span>
00629 
00630         BitMapSize = 0;
00631 
00632         <span class="keywordflow">if</span> (AllocationType &amp; MEM_PHYSICAL) {
00633 
00634             <span class="keywordflow">if</span> (AllocationType &amp; MEM_WRITE_WATCH) {
00635                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_5;
00636                 <span class="keywordflow">goto</span> ErrorReturn;
00637             }
00638 
00639             PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00640                                                    NonPagedPool,
00641                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
00642                                                    MI_PHYSICAL_VIEW_KEY);
00643 
00644             <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00645                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00646                 <span class="keywordflow">goto</span> ErrorReturn;
00647             }
00648         }
00649         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AllocationType &amp; MEM_WRITE_WATCH) {
00650 
00651             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocationType &amp; MEM_RESERVE);
00652 
00653             BitMapBits = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((PCHAR)EndingAddress -
00654                                          (PCHAR)StartingAddress);
00655 
00656             BitMapSize = <span class="keyword">sizeof</span>(RTL_BITMAP) + (ULONG)(((BitMapBits + 31) / 32) * 4);
00657 
00658             <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, BitMapSize, 'wwmM');
00659 
00660             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00661                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00662                 <span class="keywordflow">goto</span> ErrorReturn;
00663             }
00664 
00665             <span class="keywordflow">try</span> {
00666     
00667                 <span class="comment">//</span>
00668                 <span class="comment">// Charge quota for the nonpaged pool for the bitmap.  This is</span>
00669                 <span class="comment">// done here rather than by using ExAllocatePoolWithQuota</span>
00670                 <span class="comment">// so the process object is not referenced by the quota charge.</span>
00671                 <span class="comment">//</span>
00672     
00673                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (Process, NonPagedPool, BitMapSize);
00674     
00675             } except (EXCEPTION_EXECUTE_HANDLER) {
00676                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00677                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BitMap);
00678                 <span class="keywordflow">goto</span> ErrorReturn;
00679             }
00680 
00681             PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00682                                                    NonPagedPool,
00683                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
00684                                                    MI_WRITEWATCH_VIEW_KEY);
00685 
00686             <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00687                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BitMap);
00688                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (Process, NonPagedPool, BitMapSize);
00689                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00690                 <span class="keywordflow">goto</span> ErrorReturn;
00691             }
00692 
00693             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a> (BitMap,
00694                                  (PULONG)(BitMap + 1),
00695                                  BitMapBits);
00696     
00697             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (BitMap);
00698         }
00699 
00700         Vad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00701                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">MMVAD_SHORT</a>),
00702                                      'SdaV');
00703 
00704         <span class="keywordflow">try</span>  {
00705 
00706             <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00707                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
00708             }
00709 
00710             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
00711             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
00712 
00713             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags = 0;
00714             <span class="keywordflow">if</span> (AllocationType &amp; MEM_COMMIT) {
00715                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.MemCommit = 1;
00716             }
00717 
00718             <span class="keywordflow">if</span> (AllocationType &amp; MEM_PHYSICAL) {
00719                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages = 1;
00720             }
00721 
00722             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
00723             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory = 1;
00724 
00725             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge = QuotaCharge;
00726 
00727             <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
00728 
00729         } except (EXCEPTION_EXECUTE_HANDLER) {
00730 
00731             <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00732 
00733                 <span class="comment">//</span>
00734                 <span class="comment">// The pool allocation succeeded, but the quota charge</span>
00735                 <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
00736                 <span class="comment">// an error.</span>
00737                 <span class="comment">//</span>
00738 
00739                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00740                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00741 
00742             } <span class="keywordflow">else</span> {
00743                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00744             }
00745 
00746             <span class="keywordflow">if</span> (AllocationType &amp; MEM_PHYSICAL) {
00747                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
00748             }
00749             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (BitMapSize != 0) {
00750                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
00751                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BitMap);
00752                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (Process, NonPagedPool, BitMapSize);
00753             }
00754 
00755             <span class="keywordflow">goto</span> ErrorReturn;
00756         }
00757 
00758         <span class="comment">//</span>
00759         <span class="comment">// Initialize page directory and table pages for the physical range.</span>
00760         <span class="comment">//</span>
00761 
00762         <span class="keywordflow">if</span> (AllocationType &amp; MEM_PHYSICAL) {
00763 
00764             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/allocvm_8c.html#a3">MiCreatePageTablesForPhysicalRange</a> (Process,
00765                                                     StartingAddress,
00766                                                     EndingAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00767 
00768                 <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (Vad);
00769                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00770                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
00771                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00772                 <span class="keywordflow">goto</span> ErrorReturn;
00773             }
00774 
00775             PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
00776             PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = StartingAddress;
00777             PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
00778 
00779             <span class="comment">//</span>
00780             <span class="comment">// Insert the physical view into this process' list using a</span>
00781             <span class="comment">// nonpaged wrapper since the PFN lock is required.</span>
00782             <span class="comment">//</span>
00783 
00784             <a class="code" href="../../d5/d6/iosup_8c.html#a53">MiPhysicalViewInserter</a> (Process, PhysicalView);
00785         }
00786         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (BitMapSize != 0) {
00787 
00788             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.WriteWatch = 1;
00789 
00790             PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
00791             PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = StartingAddress;
00792             PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
00793             PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o4">BitMap</a> = <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>;
00794 
00795             <a class="code" href="../../d5/d6/iosup_8c.html#a53">MiPhysicalViewInserter</a> (Process, PhysicalView);
00796         }
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">// Unlock the working set lock, page faults can now be taken.</span>
00800         <span class="comment">//</span>
00801 
00802         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00803 
00804         <span class="comment">//</span>
00805         <span class="comment">// Update the current virtual size in the process header, the</span>
00806         <span class="comment">// address space lock protects this operation.</span>
00807         <span class="comment">//</span>
00808 
00809         CapturedRegionSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00810         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o15">VirtualSize</a> += CapturedRegionSize;
00811 
00812         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o15">VirtualSize</a> &gt; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o14">PeakVirtualSize</a>) {
00813             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o14">PeakVirtualSize</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o15">VirtualSize</a>;
00814         }
00815 
00816 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00817 <span class="preprocessor"></span>
00818         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00819 
00820             <span class="keywordflow">if</span> (OriginalBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00821 
00822                 OriginalRegionSize = <a class="code" href="../../d2/d9/miia64_8h.html#a231">ROUND_TO_4K_PAGES</a>(OriginalRegionSize);
00823 
00824                 EndingAddress =  (PVOID)(((ULONG_PTR) StartingAddress +
00825                                 OriginalRegionSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00826 
00827             } <span class="keywordflow">else</span> {
00828 
00829                 EndingAddress = (PVOID)(((ULONG_PTR)OriginalBase +
00830                                 OriginalRegionSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00831             }
00832 
00833             CapturedRegionSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00834 
00835             <span class="comment">//</span>
00836             <span class="comment">// Set the alternate permission table</span>
00837             <span class="comment">//</span>
00838 
00839             AltFlags = (AllocationType &amp; MEM_COMMIT) ? <a class="code" href="../../d2/d9/miia64_8h.html#a241">ALT_COMMIT</a> : 0;
00840 
00841             <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a> (StartingAddress,
00842                                 CapturedRegionSize,
00843                                 ProtectionMask,
00844                                 ALT_ALLOCATE|AltFlags,
00845                                 Process);
00846         }
00847 
00848 <span class="preprocessor">#endif</span>
00849 <span class="preprocessor"></span>
00850         <span class="comment">//</span>
00851         <span class="comment">// Release the address space lock, lower IRQL, detach, and dereference</span>
00852         <span class="comment">// the process object.</span>
00853         <span class="comment">//</span>
00854 
00855         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a>(Process);
00856         <span class="keywordflow">if</span> (Attached) {
00857             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00858         }
00859 
00860         <span class="keywordflow">if</span> (ProcessHandle != NtCurrentProcess()) {
00861             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00862         }
00863 
00864         <span class="comment">//</span>
00865         <span class="comment">// Establish an exception handler and write the size and base</span>
00866         <span class="comment">// address.</span>
00867         <span class="comment">//</span>
00868 
00869         <span class="keywordflow">try</span> {
00870 
00871             *RegionSize = CapturedRegionSize;
00872             *BaseAddress = StartingAddress;
00873 
00874         } except (EXCEPTION_EXECUTE_HANDLER) {
00875 
00876             <span class="comment">//</span>
00877             <span class="comment">// Return success at this point even if the results</span>
00878             <span class="comment">// cannot be written.</span>
00879             <span class="comment">//</span>
00880 
00881             NOTHING;
00882         }
00883 
00884 <span class="preprocessor">#if DBG</span>
00885 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00886             <span class="keywordflow">if</span> ( MmWatchProcess ) {
00887                 <span class="keywordflow">if</span> ( MmWatchProcess == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00888                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n+++ ALLOC Type %lx Base %lx Size %lx\n"</span>,
00889                         AllocationType,StartingAddress, CapturedRegionSize);
00890                     MmFooBar();
00891                 }
00892             } <span class="keywordflow">else</span> {
00893                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"return allocvm status %lx baseaddr %lx size %lx\n"</span>,
00894                     Status, StartingAddress, CapturedRegionSize);
00895             }
00896         }
00897 <span class="preprocessor">#endif</span>
00898 <span class="preprocessor"></span>
00899         <span class="keywordflow">return</span> STATUS_SUCCESS;
00900 
00901     } <span class="keywordflow">else</span> {
00902 
00903         <span class="comment">//</span>
00904         <span class="comment">// Commit previously reserved pages.  Note that these pages could</span>
00905         <span class="comment">// be either private or a section.</span>
00906         <span class="comment">//</span>
00907 
00908         <span class="keywordflow">if</span> (AllocationType == MEM_RESET) {
00909 
00910             <span class="comment">//</span>
00911             <span class="comment">// Round up to page boundaries so good data is not reset.</span>
00912             <span class="comment">//</span>
00913 
00914             EndingAddress = (PVOID)((ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> ((ULONG_PTR)CapturedBase +
00915                                     CapturedRegionSize) - 1);
00916             StartingAddress = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>((PUCHAR)CapturedBase + PAGE_SIZE - 1);
00917             <span class="keywordflow">if</span> (StartingAddress &gt; EndingAddress) {
00918                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00919                 <span class="keywordflow">goto</span> ErrorReturn;
00920             }
00921         } <span class="keywordflow">else</span> {
00922             EndingAddress = (PVOID)(((ULONG_PTR)CapturedBase +
00923                                     CapturedRegionSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00924             StartingAddress = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(CapturedBase);
00925         }
00926 
00927         CapturedRegionSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1;
00928 
00929         FoundVad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
00930 
00931 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00932 <span class="preprocessor"></span>
00933         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00934 
00935             EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00936 
00937             OriginalProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a>(Protect);
00938 
00939             <span class="comment">//</span>
00940             <span class="comment">// if it is allowed to change the protection, relax the protection</span>
00941             <span class="comment">//</span>
00942 
00943             <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 0) {
00944 
00945                 Protect = <a class="code" href="../../d2/d9/miia64_8h.html#a317">MiMakeProtectForNativePage</a>(StartingAddress,
00946                                                      Protect,
00947                                                      Process);
00948 
00949                 ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (Protect);
00950             }
00951 
00952         }
00953 
00954 <span class="preprocessor">#endif</span>
00955 <span class="preprocessor"></span>
00956         <span class="keywordflow">if</span> (FoundVad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00957 
00958             <span class="comment">//</span>
00959             <span class="comment">// No virtual address is reserved at the specified base address,</span>
00960             <span class="comment">// return an error.</span>
00961             <span class="comment">//</span>
00962 
00963             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00964             <span class="keywordflow">goto</span> ErrorReturn;
00965         }
00966 
00967         <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00968             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00969             <span class="keywordflow">goto</span> ErrorReturn;
00970         }
00971 
00972         <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge == <a class="code" href="../../d4/d8/mi_8h.html#a227">MM_MAX_COMMIT</a>) {
00973 
00974             <span class="comment">//</span>
00975             <span class="comment">// This is a special VAD, don't let any commits occur.</span>
00976             <span class="comment">//</span>
00977 
00978             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00979             <span class="keywordflow">goto</span> ErrorReturn;
00980         }
00981 
00982         <span class="comment">//</span>
00983         <span class="comment">// Ensure that the starting and ending addresses are all within</span>
00984         <span class="comment">// the same virtual address descriptor.</span>
00985         <span class="comment">//</span>
00986 
00987         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress) &lt; FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
00988             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress) &gt; FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
00989 
00990             <span class="comment">//</span>
00991             <span class="comment">// Not within the section virtual address descriptor,</span>
00992             <span class="comment">// return an error.</span>
00993             <span class="comment">//</span>
00994 
00995             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00996             <span class="keywordflow">goto</span> ErrorReturn;
00997         }
00998 
00999         <span class="keywordflow">if</span> (AllocationType == MEM_RESET) {
01000             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d6/allocvm_8c.html#a2">MiResetVirtualMemory</a> (StartingAddress,
01001                                            EndingAddress,
01002                                            FoundVad,
01003                                            Process);
01004             <span class="keywordflow">goto</span> done;
01005 
01006         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0) {
01007 
01008 
01009             <span class="comment">//</span>
01010             <span class="comment">// The no cache option is not allowed for sections.</span>
01011             <span class="comment">//</span>
01012 
01013             <span class="keywordflow">if</span> (Protect &amp; PAGE_NOCACHE) {
01014                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
01015                 <span class="keywordflow">goto</span> ErrorReturn;
01016             }
01017 
01018             <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1) {
01019 
01020                 <span class="comment">//</span>
01021                 <span class="comment">// An attempt is made at changing the protection</span>
01022                 <span class="comment">// of a SEC_NO_CHANGE section.</span>
01023                 <span class="comment">//</span>
01024 
01025                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> (FoundVad,
01026                                             CapturedBase,
01027                                             CapturedRegionSize,
01028                                             ProtectionMask);
01029 
01030                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
01031                     <span class="keywordflow">goto</span> ErrorReturn;
01032                 }
01033             }
01034 
01035             <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01036                 <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ExtendableFile == 0) {
01037 
01038                     <span class="comment">//</span>
01039                     <span class="comment">// Only page file backed sections can be committed.</span>
01040                     <span class="comment">//</span>
01041 
01042                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ALREADY_COMMITTED;
01043                     <span class="keywordflow">goto</span> ErrorReturn;
01044                 } <span class="keywordflow">else</span> {
01045 
01046                     <span class="comment">//</span>
01047                     <span class="comment">// Commit the requested portions of the extendable file.</span>
01048                     <span class="comment">//</span>
01049 
01050                     <a class="code" href="../../d5/d0/struct__SECTION.html">SECTION</a> Section;
01051                     LARGE_INTEGER NewSize;
01052                     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
01053 
01054                     RtlZeroMemory (&amp;Section, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/struct__SECTION.html">SECTION</a>));
01055                     ControlArea = FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>;
01056                     Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o1">Segment</a> = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>;
01057                     Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o5">u</a>.LongFlags = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.LongFlags;
01058                     Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o6">InitialPageProtection</a> = PAGE_READWRITE;
01059                     NewSize.QuadPart = FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.FileOffset;
01060                     NewSize.QuadPart = NewSize.QuadPart &lt;&lt; 16;
01061                     NewSize.QuadPart += 1 +
01062                            ((PCHAR)EndingAddress - (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>));
01063                 
01064                     <span class="comment">//</span>
01065                     <span class="comment">// The working set and address space mutexes must be</span>
01066                     <span class="comment">// released prior to calling MmExtendSection otherwise</span>
01067                     <span class="comment">// a deadlock with the filesystem can occur.</span>
01068                     <span class="comment">//</span>
01069                     <span class="comment">// Prevent the control area from being deleted while</span>
01070                     <span class="comment">// the (potential) extension is ongoing.</span>
01071                     <span class="comment">//</span>
01072 
01073                     <a class="code" href="../../d6/d5/flushsec_8c.html#a5">MiFlushAcquire</a> (ControlArea);
01074 
01075                     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01076                     
01077                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/extsect_8c.html#a1">MmExtendSection</a> (&amp;Section,
01078                                               &amp;NewSize,
01079                                               FALSE);
01080                 
01081                     <a class="code" href="../../d6/d5/flushsec_8c.html#a6">MiFlushRelease</a> (ControlArea);
01082 
01083                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01084 
01085                         <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01086 
01087                         <span class="comment">//</span>
01088                         <span class="comment">// The Vad and/or the control area may have been changed</span>
01089                         <span class="comment">// or deleted before the mutexes were regained above.</span>
01090                         <span class="comment">// So everything must be revalidated.  Note that</span>
01091                         <span class="comment">// if anything has changed, success is silently</span>
01092                         <span class="comment">// returned just as if the protection change had failed.</span>
01093                         <span class="comment">// It is the caller's fault if any of these has gone</span>
01094                         <span class="comment">// away and they will suffer.</span>
01095                         <span class="comment">//</span>
01096 
01097                         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
01098                             <span class="comment">// Status = STATUS_PROCESS_IS_TERMINATING;</span>
01099                             <span class="keywordflow">goto</span> ErrorReturn;
01100                         }
01101 
01102                         FoundVad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress,
01103                                                              EndingAddress);
01104                 
01105                         <span class="keywordflow">if</span> (FoundVad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01106                 
01107                             <span class="comment">//</span>
01108                             <span class="comment">// No virtual address is reserved at the specified</span>
01109                             <span class="comment">// base address, return an error.</span>
01110                             <span class="comment">//</span>
01111                             <span class="comment">// Status = STATUS_CONFLICTING_ADDRESSES;</span>
01112 
01113                             <span class="keywordflow">goto</span> ErrorReturn;
01114                         }
01115                 
01116                         <span class="keywordflow">if</span> (ControlArea != FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>) {
01117                             <span class="keywordflow">goto</span> ErrorReturn;
01118                         }
01119 
01120                         <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
01121                             <span class="comment">// Status = STATUS_CONFLICTING_ADDRESSES;</span>
01122 
01123                             <span class="keywordflow">goto</span> ErrorReturn;
01124                         }
01125                 
01126                         <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge == <a class="code" href="../../d4/d8/mi_8h.html#a227">MM_MAX_COMMIT</a>) {
01127                             <span class="comment">//</span>
01128                             <span class="comment">// This is a special VAD, no commits are allowed.</span>
01129                             <span class="comment">//</span>
01130                             <span class="comment">// Status = STATUS_CONFLICTING_ADDRESSES;</span>
01131 
01132                             <span class="keywordflow">goto</span> ErrorReturn;
01133                         }
01134                 
01135                         <span class="comment">//</span>
01136                         <span class="comment">// Ensure that the starting and ending addresses are</span>
01137                         <span class="comment">// all within the same virtual address descriptor.</span>
01138                         <span class="comment">//</span>
01139                 
01140                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress) &lt; FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
01141                             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress) &gt; FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
01142                 
01143                             <span class="comment">//</span>
01144                             <span class="comment">// Not within the section virtual address</span>
01145                             <span class="comment">// descriptor, return an error.</span>
01146                             <span class="comment">//</span>
01147                             <span class="comment">// Status = STATUS_CONFLICTING_ADDRESSES;</span>
01148 
01149                             <span class="keywordflow">goto</span> ErrorReturn;
01150                         }
01151 
01152                         <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1) {
01153             
01154                             <span class="comment">//</span>
01155                             <span class="comment">// An attempt is made at changing the protection</span>
01156                             <span class="comment">// of a SEC_NO_CHANGE section.</span>
01157                             <span class="comment">//</span>
01158             
01159                             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> Status2;
01160 
01161                             Status2 = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> (FoundVad,
01162                                                          CapturedBase,
01163                                                          CapturedRegionSize,
01164                                                          ProtectionMask);
01165             
01166                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status2)) {
01167                                 <span class="keywordflow">goto</span> ErrorReturn;
01168                             }
01169                         }
01170             
01171                         <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01172                             <span class="keywordflow">goto</span> ErrorReturn;
01173                         }
01174 
01175                         <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ExtendableFile == 0) {
01176                             <span class="keywordflow">goto</span> ErrorReturn;
01177                         }
01178 
01179 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01180 <span class="preprocessor"></span>
01181                         <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01182 
01183                            <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a>(Process);
01184 
01185                            StartingAddressFor4k = (PVOID)<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(OriginalBase);
01186 
01187                            EndingAddressFor4k = (PVOID)(((ULONG_PTR)OriginalBase +
01188                                                  OriginalRegionSize - 1) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1));
01189 
01190                            CapturedRegionSizeFor4k = (ULONG_PTR)EndingAddressFor4k -
01191                                                 (ULONG_PTR)StartingAddressFor4k + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01192 
01193                            <span class="keywordflow">if</span> ((FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1) ||
01194                                (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite == 1)) {
01195 
01196                                OriginalProtectionMask |= <a class="code" href="../../d4/d8/mi_8h.html#a52">MM_PROTECTION_COPY_MASK</a>;
01197 
01198                            }
01199 
01200                            <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a> (StartingAddressFor4k,
01201                                                CapturedRegionSizeFor4k,
01202                                                OriginalProtectionMask,
01203                                                ALT_COMMIT,
01204                                                Process);
01205 
01206                            <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a>(Process);
01207                         }
01208 
01209 <span class="preprocessor">#endif</span>
01210 <span class="preprocessor"></span>
01211                         <span class="keywordflow">try</span> {
01212                             <a class="code" href="../../d0/d9/protect_8c.html#a6">MiSetProtectionOnSection</a> (Process,
01213                                                       FoundVad,
01214                                                       StartingAddress,
01215                                                       EndingAddress,
01216                                                       Protect,
01217                                                       &amp;OldProtect,
01218                                                       TRUE);
01219                         } except (EXCEPTION_EXECUTE_HANDLER) {
01220                             NOTHING;
01221                         }
01222 
01223                         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01224                     }
01225 
01226                     <span class="keywordflow">goto</span> ErrorReturn1;
01227                 }
01228             }
01229 
01230             StartingPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
01231                                                 <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(StartingAddress));
01232             PointerPte = StartingPte;
01233             LastPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
01234                                             <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(EndingAddress));
01235 
01236             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
01237 
01238             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
01239 
01240 <span class="preprocessor">#if 0</span>
01241 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (AllocationType &amp; <a class="code" href="../../d3/d7/freevm_8c.html#a0">MEM_CHECK_COMMIT_STATE</a>) {
01242 
01243                 <span class="comment">//</span>
01244                 <span class="comment">// Make sure none of the pages are already committed.</span>
01245                 <span class="comment">//</span>
01246 
01247                 <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01248 
01249                     <span class="comment">//</span>
01250                     <span class="comment">// Check to see if the prototype PTE is committed.</span>
01251                     <span class="comment">// Note that prototype PTEs cannot be decommitted so</span>
01252                     <span class="comment">// the PTEs only need to be checked for zeroes.</span>
01253                     <span class="comment">//</span>
01254                     <span class="comment">//</span>
01255 
01256                     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
01257                         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
01258                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ALREADY_COMMITTED;
01259                         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
01260                         <span class="keywordflow">goto</span> ErrorReturn1;
01261                     }
01262                     PointerPte += 1;
01263                 }
01264             }
01265 <span class="preprocessor">#endif //0</span>
01266 <span class="preprocessor"></span>
01267             PointerPte = StartingPte;
01268 
01269             <span class="comment">//</span>
01270             <span class="comment">// Check to ensure these pages can be committed if this</span>
01271             <span class="comment">// is a page file backed segment.  Note that page file quota</span>
01272             <span class="comment">// has already been charged for this.</span>
01273             <span class="comment">//</span>
01274 
01275             QuotaCharge = 1 + LastPte - StartingPte;
01276 
01277             CopyOnWriteCharge = 0;
01278 
01279             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a88">MI_IS_PTE_PROTECTION_COPY_WRITE</a>(ProtectionMask)) {
01280 
01281                 <span class="comment">//</span>
01282                 <span class="comment">// If the protection is copy on write, charge for</span>
01283                 <span class="comment">// the copy on writes.</span>
01284                 <span class="comment">//</span>
01285 
01286                 CopyOnWriteCharge = QuotaCharge;
01287             }
01288 
01289             <span class="comment">//</span>
01290             <span class="comment">// Charge commitment for the range.  Establish an</span>
01291             <span class="comment">// exception handler as this could raise an exception.</span>
01292             <span class="comment">//</span>
01293 
01294             QuotaFree = 0;
01295             ChargedExactQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01296             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01297             ChargedJobCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01298 
01299             <span class="keywordflow">for</span> (; ; ) {
01300                 <span class="keywordflow">try</span> {
01301                     PageFileChargeSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01302 
01303                     <span class="keywordflow">if</span> (CopyOnWriteCharge != 0) {
01304                         <a class="code" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (CopyOnWriteCharge, Process);
01305                     }
01306 
01307                     PageFileChargeSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01308 
01309                     <span class="comment">//</span>
01310                     <span class="comment">// Note this job charging is unusual because it is not</span>
01311                     <span class="comment">// followed by an immediate process charge.</span>
01312                     <span class="comment">//</span>
01313 
01314                     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a>) {
01315                         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> + CopyOnWriteCharge &gt; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a>) {
01316                             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>) {
01317                                 <a class="code" href="../../d1/d1/psjob_8c.html#a21">PsReportProcessMemoryLimitViolation</a> ();
01318                             }
01319                             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01320                         }
01321                     }
01322                     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
01323                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(CopyOnWriteCharge) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01324                             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01325                         }
01326                         ChargedJobCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01327                     }
01328     
01329                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (QuotaCharge + CopyOnWriteCharge, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01330                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01331                     }
01332 
01333                     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_ALLOCVM1, QuotaCharge + CopyOnWriteCharge);
01334 
01335                     <span class="keywordflow">break</span>;
01336 
01337                 } except (EXCEPTION_EXECUTE_HANDLER) {
01338 
01339                     <span class="comment">//</span>
01340                     <span class="comment">// An exception has occurred during the charging</span>
01341                     <span class="comment">// of commitment.  Release the held mutexes and return</span>
01342                     <span class="comment">// the exception status to the user.</span>
01343                     <span class="comment">//</span>
01344 
01345                     <span class="keywordflow">if</span> (PageFileChargeSucceeded &amp;&amp; CopyOnWriteCharge != 0) {
01346                         <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (CopyOnWriteCharge, Process);
01347                     }
01348 
01349                     <span class="keywordflow">if</span> (ChargedJobCommit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01350 
01351                         <span class="comment">//</span>
01352                         <span class="comment">// Temporarily up the process commit charge as the</span>
01353                         <span class="comment">// job code will be referencing it as though everything</span>
01354                         <span class="comment">// has succeeded.</span>
01355                         <span class="comment">//</span>
01356 
01357                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> += CopyOnWriteCharge;
01358                         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (-(SSIZE_T)CopyOnWriteCharge);
01359                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= CopyOnWriteCharge;
01360                     }
01361 
01362                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS || PageFileChargeSucceeded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01363 
01364                         <span class="comment">//</span>
01365                         <span class="comment">// We have already tried for the precise charge or the</span>
01366                         <span class="comment">// attempt to charge pagefile quota failed, so just</span>
01367                         <span class="comment">// return an error.</span>
01368                         <span class="comment">//</span>
01369 
01370                         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
01371                         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
01372                         <span class="keywordflow">goto</span> ErrorReturn1;
01373                     }
01374 
01375                     <span class="comment">//</span>
01376                     <span class="comment">// The commitment charging of quota failed, calculate the</span>
01377                     <span class="comment">// exact quota taking into account pages that may already be</span>
01378                     <span class="comment">// committed and retry the operation.</span>
01379                     <span class="comment">//</span>
01380 
01381                     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01382 
01383                         <span class="comment">//</span>
01384                         <span class="comment">// Check to see if the prototype PTE is committed.</span>
01385                         <span class="comment">// Note that prototype PTEs cannot be decommitted so</span>
01386                         <span class="comment">// PTEs only need to be checked for zeroes.</span>
01387                         <span class="comment">//</span>
01388 
01389                         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
01390                             QuotaFree -= 1;
01391                         }
01392                         PointerPte += 1;
01393                     }
01394 
01395                     PointerPte = StartingPte;
01396 
01397                     QuotaCharge += QuotaFree;
01398                     ChargedExactQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01399                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01400                 }
01401             }
01402 
01403             FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a> +=
01404                                                         QuotaCharge;
01405 
01406             FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge += CopyOnWriteCharge;
01407             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> += CopyOnWriteCharge;
01408             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> &gt; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a>) {
01409                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a>;
01410             }
01411             <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> += QuotaCharge;
01412 
01413             <span class="comment">//</span>
01414             <span class="comment">// Commit all the pages.</span>
01415             <span class="comment">//</span>
01416 
01417             TempPte = FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o9">SegmentPteTemplate</a>;
01418 
01419             QuotaFree = 0;
01420 
01421             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01422 
01423                 <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
01424 
01425                     <span class="comment">//</span>
01426                     <span class="comment">// Page is already committed, back out commitment.</span>
01427                     <span class="comment">//</span>
01428 
01429                     QuotaFree += 1;
01430                 } <span class="keywordflow">else</span> {
01431                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
01432                 }
01433                 PointerPte += 1;
01434             }
01435 
01436             <span class="keywordflow">if</span> (ChargedExactQuota == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; QuotaFree != 0) {
01437 
01438                 FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a> -= QuotaFree;
01439                 <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> -= QuotaFree;
01440                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">NumberOfCommittedPages</a> &gt;= 0);
01441 
01442                 <span class="keywordflow">if</span> (CopyOnWriteCharge != 0) {
01443                     FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge -= QuotaFree;
01444                     <span class="keywordflow">if</span> (ChargedJobCommit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01445                         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (-(SSIZE_T)QuotaFree);
01446                     }
01447                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= QuotaFree;
01448                     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
01449                     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaFree, Process);
01450                 }
01451                 <span class="keywordflow">else</span> {
01452                     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
01453                 }
01454 
01455                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SSIZE_T)FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge &gt;= 0);
01456 
01457                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (
01458                         (CopyOnWriteCharge ? 2*QuotaFree : QuotaFree));
01459 
01460                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_ALLOCVM1,
01461                         (CopyOnWriteCharge ? 2*QuotaFree : QuotaFree));
01462             }
01463             <span class="keywordflow">else</span> {
01464                 <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
01465             }
01466 
01467 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01468 <span class="preprocessor"></span>
01469             <span class="comment">//</span>
01470             <span class="comment">// We need to change the alternate table before PTEs are created</span>
01471             <span class="comment">// for the protection change.</span>
01472             <span class="comment">//</span>
01473 
01474             <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01475 
01476                 StartingAddressFor4k = (PVOID)<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(OriginalBase);
01477 
01478                 EndingAddressFor4k = (PVOID)(((ULONG_PTR)OriginalBase +
01479                                               OriginalRegionSize - 1) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1));
01480 
01481                 CapturedRegionSizeFor4k = (ULONG_PTR)EndingAddressFor4k -
01482                     (ULONG_PTR)StartingAddressFor4k + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01483 
01484                 <span class="keywordflow">if</span> ((FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1) ||
01485                     (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite == 1)) {
01486 
01487                     OriginalProtectionMask |= <a class="code" href="../../d4/d8/mi_8h.html#a52">MM_PROTECTION_COPY_MASK</a>;
01488 
01489                 }
01490 
01491                 <span class="comment">//</span>
01492                 <span class="comment">// Set the alternate permission table</span>
01493                 <span class="comment">//</span>
01494 
01495                 <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a> (StartingAddressFor4k,
01496                                     CapturedRegionSizeFor4k,
01497                                     OriginalProtectionMask,
01498                                     ALT_COMMIT,
01499                                     Process);
01500             }
01501 <span class="preprocessor">#endif</span>
01502 <span class="preprocessor"></span>
01503             <span class="comment">//</span>
01504             <span class="comment">// Change all the protection to be protected as specified.</span>
01505             <span class="comment">//</span>
01506 
01507             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01508 
01509             <span class="keywordflow">try</span> {
01510                 <a class="code" href="../../d0/d9/protect_8c.html#a6">MiSetProtectionOnSection</a> (Process,
01511                                           FoundVad,
01512                                           StartingAddress,
01513                                           EndingAddress,
01514                                           Protect,
01515                                           &amp;OldProtect,
01516                                           TRUE);
01517             } except (EXCEPTION_EXECUTE_HANDLER) {
01518                 NOTHING;
01519             }
01520 
01521             <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01522 
01523             <span class="keywordflow">if</span> (Attached) {
01524                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01525             }
01526             <span class="keywordflow">if</span> ( ProcessHandle != NtCurrentProcess() ) {
01527                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
01528             }
01529 
01530             <span class="keywordflow">try</span> {
01531 
01532                 *RegionSize = CapturedRegionSize;
01533                 *BaseAddress = StartingAddress;
01534 
01535             } except (EXCEPTION_EXECUTE_HANDLER) {
01536 
01537                 <span class="comment">//</span>
01538                 <span class="comment">// Return success at this point even if the results</span>
01539                 <span class="comment">// cannot be written.</span>
01540                 <span class="comment">//</span>
01541 
01542                 NOTHING;
01543             }
01544 
01545 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01546 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01547                 CapturedRegionSize = CapturedRegionSizeFor4k;
01548                 StartingAddress = StartingAddressFor4k;
01549             }
01550 <span class="preprocessor">#endif</span>
01551 <span class="preprocessor"></span>
01552 <span class="preprocessor">#if DBG</span>
01553 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
01554                 <span class="keywordflow">if</span> ( MmWatchProcess ) {
01555                     <span class="keywordflow">if</span> ( MmWatchProcess == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
01556                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n+++ ALLOC Type %lx Base %lx Size %lx\n"</span>,
01557                             AllocationType,StartingAddress, CapturedRegionSize);
01558                         MmFooBar();
01559                     }
01560                 } <span class="keywordflow">else</span> {
01561                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"return allocvm status %lx baseaddr %lx size %lx\n"</span>,
01562                         Status, CapturedRegionSize, StartingAddress);
01563                 }
01564             }
01565 <span class="preprocessor">#endif</span>
01566 <span class="preprocessor"></span>
01567             <span class="keywordflow">return</span> STATUS_SUCCESS;
01568 
01569         } <span class="keywordflow">else</span> {
01570 
01571             <span class="comment">//</span>
01572             <span class="comment">// PAGE_WRITECOPY is not valid for private pages.</span>
01573             <span class="comment">//</span>
01574 
01575             <span class="keywordflow">if</span> ((Protect &amp; PAGE_WRITECOPY) ||
01576                 (Protect &amp; PAGE_EXECUTE_WRITECOPY)) {
01577                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
01578                 <span class="keywordflow">goto</span> ErrorReturn;
01579             }
01580 
01581             <span class="comment">//</span>
01582             <span class="comment">// Ensure none of the pages are already committed as described</span>
01583             <span class="comment">// in the virtual address descriptor.</span>
01584             <span class="comment">//</span>
01585 <span class="preprocessor">#if 0</span>
01586 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (AllocationType &amp; <a class="code" href="../../d3/d7/freevm_8c.html#a0">MEM_CHECK_COMMIT_STATE</a>) {
01587                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d8/mi_8h.html#a907">MiIsEntireRangeDecommitted</a>(StartingAddress,
01588                                                  EndingAddress,
01589                                                  FoundVad,
01590                                                  Process)) {
01591 
01592                     <span class="comment">//</span>
01593                     <span class="comment">// Previously reserved pages have been committed, or</span>
01594                     <span class="comment">// an error occurred, release mutex and return status.</span>
01595                     <span class="comment">//</span>
01596 
01597                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ALREADY_COMMITTED;
01598                     <span class="keywordflow">goto</span> ErrorReturn;
01599                 }
01600             }
01601 <span class="preprocessor">#endif //0</span>
01602 <span class="preprocessor"></span>
01603             <span class="comment">//</span>
01604             <span class="comment">// The address range has not been committed, commit it now.</span>
01605             <span class="comment">// Note, that for private pages, commitment is handled by</span>
01606             <span class="comment">// explicitly updating PTEs to contain Demand Zero entries.</span>
01607             <span class="comment">//</span>
01608 
01609             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
01610             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
01611             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
01612             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
01613 
01614             <span class="comment">//</span>
01615             <span class="comment">// Check to ensure these pages can be committed.</span>
01616             <span class="comment">//</span>
01617 
01618             QuotaCharge = 1 + LastPte - PointerPte;
01619 
01620             <span class="comment">//</span>
01621             <span class="comment">// Charge quota and commitment for the range.  Establish an</span>
01622             <span class="comment">// exception handler as this could raise an exception.</span>
01623             <span class="comment">//</span>
01624 
01625             QuotaFree = 0;
01626             ChargedExactQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01627             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01628             ChargedJobCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01629 
01630             <span class="keywordflow">for</span> (; ; ) {
01631                 <span class="keywordflow">try</span> {
01632                     PageFileChargeSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01633 
01634                     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a>) {
01635                         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> + QuotaCharge &gt; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a>) {
01636                             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>) {
01637                                 <a class="code" href="../../d1/d1/psjob_8c.html#a21">PsReportProcessMemoryLimitViolation</a> ();
01638                             }
01639                             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01640                         }
01641                     }
01642                     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
01643                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(QuotaCharge) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01644                             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01645                         }
01646                         ChargedJobCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01647                     }
01648 
01649                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (QuotaCharge, Process) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01650                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01651                     }
01652 
01653                     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_ALLOCVM2, QuotaCharge);
01654 
01655                     PageFileChargeSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01656                     <a class="code" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (QuotaCharge, Process);
01657 
01658                     FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge += QuotaCharge;
01659                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> += QuotaCharge;
01660                     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> &gt; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a>) {
01661                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a>;
01662                     }
01663                     <span class="keywordflow">break</span>;
01664 
01665                 } except (EXCEPTION_EXECUTE_HANDLER) {
01666 
01667                     <span class="comment">//</span>
01668                     <span class="comment">// An exception has occurred during the charging</span>
01669                     <span class="comment">// of commitment.  Release the held mutexes and return</span>
01670                     <span class="comment">// the exception status to the user.</span>
01671                     <span class="comment">//</span>
01672 
01673                     <span class="keywordflow">if</span> (ChargedJobCommit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01674 
01675                         <span class="comment">//</span>
01676                         <span class="comment">// Temporarily up the process commit charge as the</span>
01677                         <span class="comment">// job code will be referencing it as though everything</span>
01678                         <span class="comment">// has succeeded.</span>
01679                         <span class="comment">//</span>
01680 
01681                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> += QuotaCharge;
01682                         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (-QuotaCharge);
01683                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= QuotaCharge;
01684                     }
01685 
01686                     <span class="keywordflow">if</span> (PageFileChargeSucceeded) {
01687                         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (QuotaCharge);
01688                         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_ALLOCVM2, QuotaCharge);
01689                     }
01690 
01691                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
01692 
01693                         <span class="comment">//</span>
01694                         <span class="comment">// We have already tried for the precise charge,</span>
01695                         <span class="comment">// return an error.</span>
01696                         <span class="comment">//</span>
01697 
01698                         <span class="keywordflow">goto</span> ErrorReturn;
01699                     }
01700 
01701                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01702 
01703                     <span class="comment">//</span>
01704                     <span class="comment">// Quota charge failed, calculate the exact quota</span>
01705                     <span class="comment">// taking into account pages that may already be</span>
01706                     <span class="comment">// committed and retry the operation.</span>
01707                     <span class="comment">//</span>
01708 
01709                     QuotaFree = -(LONG)<a class="code" href="../../d6/d1/mmquota_8c.html#a20">MiCalculatePageCommitment</a> (
01710                                                         StartingAddress,
01711                                                         EndingAddress,
01712                                                         FoundVad,
01713                                                         Process);
01714 
01715                     <span class="keywordflow">if</span> (QuotaFree == 0) {
01716                         <span class="keywordflow">goto</span> ErrorReturn;
01717                     }
01718 
01719                     ChargedExactQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01720                     QuotaCharge += QuotaFree;
01721                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (QuotaCharge &gt;= 0);
01722                 }
01723             }
01724 
01725 
01726             <span class="comment">//</span>
01727             <span class="comment">// Build a demand zero PTE with the proper protection.</span>
01728             <span class="comment">//</span>
01729 
01730             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
01731             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
01732 
01733             DecommittedPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
01734             DecommittedPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a45">MM_DECOMMIT</a>;
01735 
01736             <span class="comment">//</span>
01737             <span class="comment">// Fill in all the page directory and page table pages with the</span>
01738             <span class="comment">// demand zero PTE.</span>
01739             <span class="comment">//</span>
01740 
01741 <span class="preprocessor">#if defined (_WIN64)</span>
01742 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
01743             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01744                 UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01745                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01746             }
01747 <span class="preprocessor">#endif</span>
01748 <span class="preprocessor"></span>
01749             <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
01750 
01751             <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.MemCommit) {
01752                 CommitLimitPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MI_VPN_TO_VA (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>));
01753             } <span class="keywordflow">else</span> {
01754                 CommitLimitPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01755             }
01756 
01757             QuotaFree = 0;
01758 
01759             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01760 
01761                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01762 
01763                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01764                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01765 
01766                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte)) {
01767                         <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
01768                     }
01769 
01770 <span class="preprocessor">#if defined (_WIN64)</span>
01771 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01772                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPde, TempPte);
01773                         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01774 
01775                         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01776                     }
01777 <span class="preprocessor">#endif</span>
01778 <span class="preprocessor"></span>
01779                     <span class="comment">//</span>
01780                     <span class="comment">// Pointing to the next page table page, make</span>
01781                     <span class="comment">// a page table page exist and make it valid.</span>
01782                     <span class="comment">//</span>
01783 
01784                     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
01785                 }
01786 
01787                 <span class="keywordflow">if</span> (PointerPte-&gt;u.Long == 0) {
01788 
01789                     <span class="keywordflow">if</span> (PointerPte &lt;= CommitLimitPte) {
01790 
01791                         <span class="comment">//</span>
01792                         <span class="comment">// This page is implicitly committed.</span>
01793                         <span class="comment">//</span>
01794 
01795                         QuotaFree += 1;
01796 
01797                     }
01798 
01799                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
01800 
01801                     <span class="comment">//</span>
01802                     <span class="comment">// Increment the count of non-zero page table entries</span>
01803                     <span class="comment">// for this page table and the number of private pages</span>
01804                     <span class="comment">// for the process.</span>
01805                     <span class="comment">//</span>
01806 
01807                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01808                     UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (Va);
01809 
01810                     <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01811                 } <span class="keywordflow">else</span> {
01812                     <span class="keywordflow">if</span> (PointerPte-&gt;u.Long == DecommittedPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01813 
01814                         <span class="comment">//</span>
01815                         <span class="comment">// Only commit the page if it is already decommitted.</span>
01816                         <span class="comment">//</span>
01817 
01818                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
01819                     } <span class="keywordflow">else</span> {
01820                         QuotaFree += 1;
01821 
01822                         <span class="comment">//</span>
01823                         <span class="comment">// Make sure the protection for the page is</span>
01824                         <span class="comment">// right.</span>
01825                         <span class="comment">//</span>
01826 
01827                         <span class="keywordflow">if</span> (!ChangeProtection &amp;&amp;
01828                             (Protect != <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (PointerPte,
01829                                                             Process))) {
01830                             ChangeProtection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01831                         }
01832                     }
01833                 }
01834                 PointerPte += 1;
01835             }
01836         }
01837 
01838         <span class="keywordflow">if</span> (ChargedExactQuota == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; QuotaFree != 0) {
01839             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (QuotaFree &gt;= 0);
01840             <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (QuotaFree);
01841             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_ALLOCVM3, QuotaFree);
01842             <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaFree, Process);
01843             FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge -= QuotaFree;
01844             <span class="keywordflow">if</span> (ChargedJobCommit) {
01845                 <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (-(SSIZE_T)QuotaFree);
01846             }
01847             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= QuotaFree;
01848             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge &gt;= 0);
01849         }
01850 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01851 <span class="preprocessor"></span>
01852         <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01853 
01854             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
01855 
01856             StartingAddress = (PVOID) <a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(OriginalBase);
01857 
01858             EndingAddress = (PVOID)(((ULONG_PTR)OriginalBase +
01859                                     OriginalRegionSize - 1) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1));
01860 
01861             CapturedRegionSize = (ULONG_PTR)EndingAddress -
01862                                       (ULONG_PTR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01863             <span class="comment">//</span>
01864             <span class="comment">// Set the alternate permission table</span>
01865             <span class="comment">//</span>
01866 
01867             <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a> (StartingAddress,
01868                                 CapturedRegionSize,
01869                                 OriginalProtectionMask,
01870                                 ALT_COMMIT,
01871                                 Process);
01872 
01873             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01874         }
01875 <span class="preprocessor">#endif</span>
01876 <span class="preprocessor"></span>
01877         <span class="comment">//</span>
01878         <span class="comment">// Previously reserved pages have been committed, or an error occurred,</span>
01879         <span class="comment">// release working set lock, address creation lock, detach,</span>
01880         <span class="comment">// dereference process and return status.</span>
01881         <span class="comment">//</span>
01882 
01883 done:
01884         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01885 
01886         <span class="keywordflow">if</span> (ChangeProtection) {
01887             PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
01888             SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01889             ULONG LastProtect;
01890 
01891             <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = StartingAddress;
01892             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = CapturedRegionSize;
01893             <a class="code" href="../../d0/d9/protect_8c.html#a5">MiProtectVirtualMemory</a> (Process,
01894                                     &amp;Start,
01895                                     &amp;Size,
01896                                     Protect,
01897                                     &amp;LastProtect);
01898         }
01899 
01900         <span class="keywordflow">if</span> (Attached) {
01901             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01902         }
01903         <span class="keywordflow">if</span> ( ProcessHandle != NtCurrentProcess() ) {
01904             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
01905         }
01906 
01907         <span class="comment">//</span>
01908         <span class="comment">// Establish an exception handler and write the size and base</span>
01909         <span class="comment">// address.</span>
01910         <span class="comment">//</span>
01911 
01912         <span class="keywordflow">try</span> {
01913 
01914             *RegionSize = CapturedRegionSize;
01915             *BaseAddress = StartingAddress;
01916 
01917         } except (EXCEPTION_EXECUTE_HANDLER) {
01918             <span class="keywordflow">return</span> GetExceptionCode();
01919         }
01920 
01921 <span class="preprocessor">#if DBG</span>
01922 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
01923             <span class="keywordflow">if</span> ( MmWatchProcess ) {
01924                 <span class="keywordflow">if</span> ( MmWatchProcess == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
01925                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n+++ ALLOC Type %lx Base %lx Size %lx\n"</span>,
01926                         AllocationType,StartingAddress, CapturedRegionSize);
01927                     MmFooBar();
01928                 }
01929             } <span class="keywordflow">else</span> {
01930                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"return allocvm status %lx baseaddr %lx size %lx\n"</span>,
01931                     Status, CapturedRegionSize, StartingAddress);
01932             }
01933         }
01934 <span class="preprocessor">#endif</span>
01935 <span class="preprocessor"></span>
01936         <span class="keywordflow">return</span> STATUS_SUCCESS;
01937     }
01938 
01939 ErrorReturn:
01940         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01941 
01942 ErrorReturn1:
01943         <span class="keywordflow">if</span> (Attached) {
01944             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01945         }
01946         <span class="keywordflow">if</span> ( ProcessHandle != NtCurrentProcess() ) {
01947             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
01948         }
01949         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01950 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="allocvm.c::MmSupportWriteWatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d3/d6/allocvm_8c.html#a1">MmSupportWriteWatch</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00036">36</a> of file <a class="el" href="../../d4/d5/allocvm_8c-source.html">allocvm.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="allocvm.c::MMVADKEY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d6/vlm_8c.html#a0">MMVADKEY</a> = ' daV'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00030">30</a> of file <a class="el" href="../../d4/d5/allocvm_8c-source.html">allocvm.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01028">MiMapViewOfPhysicalSection()</a>, and <a class="el" href="../../d4/d4/mapview_8c-source.html#l04177">MmSecureVirtualMemory()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
