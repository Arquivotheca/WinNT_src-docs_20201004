<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: class.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>class.c</h1><a href="../../d2/d7/class_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: class.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains RegisterClass and the related window class management</span>
00007 <span class="comment">* functions.</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">* 10-16-90 DarrinM      Ported functions from Win 3.0 sources.</span>
00011 <span class="comment">* 02-01-91 mikeke       Added Revalidation code (None)</span>
00012 <span class="comment">* 04-08-91 DarrinM      C-S-ized and removed global/public class support.</span>
00013 <span class="comment">\***************************************************************************/</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00016 <span class="preprocessor">#pragma hdrstop</span>
00017 <span class="preprocessor"></span>
00018 <span class="comment">/*</span>
00019 <span class="comment"> * These arrays are used by Get/SetClassWord/Long.</span>
00020 <span class="comment"> */</span>
00021 
00022 <span class="comment">// !!! can't we get rid of this and just special case GCW_ATOM</span>
00023 
<a name="l00024"></a><a class="code" href="../../d2/d7/class_8c.html#a1">00024</a> CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d5/d7/classc_8c.html#a1">afClassDWord</a>[] = {
00025      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, spicnSm),          <span class="comment">// GCL_HICONSM       (-34)</span>
00026      0,
00027      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, atomClassName),    <span class="comment">// GCW_ATOM          (-32)</span>
00028      0,
00029      0,
00030      0,
00031      0,
00032      0,
00033      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, style),            <span class="comment">// GCL_STYLE         (-26)</span>
00034      0,
00035      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, lpfnWndProc),      <span class="comment">// GCL_WNDPROC       (-24)</span>
00036      0,
00037      0,
00038      0,
00039      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, cbclsExtra),       <span class="comment">// GCL_CBCLSEXTRA    (-20)</span>
00040      0,
00041      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, cbwndExtra),       <span class="comment">// GCL_CBWNDEXTRA    (-18)</span>
00042      0,
00043      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, hModule),          <span class="comment">// GCL_HMODULE       (-16)</span>
00044      0,
00045      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, spicn),            <span class="comment">// GCL_HICON         (-14)</span>
00046      0,
00047      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, spcur),            <span class="comment">// GCL_HCURSOR       (-12)</span>
00048      0,
00049      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, hbrBackground),    <span class="comment">// GCL_HBRBACKGROUND (-10)</span>
00050      0,
00051      <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, lpszMenuName)      <span class="comment">// GCL_HMENUNAME      (-8)</span>
00052 };
00053 
<a name="l00054"></a><a class="code" href="../../d2/d7/class_8c.html#a2">00054</a> CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d5/d7/classc_8c.html#a2">aiClassOffset</a>[] = {
00055     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, spicnSm),         <span class="comment">// GCL_HICONSM</span>
00056     0,
00057     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, atomClassName),   <span class="comment">// GCW_ATOM</span>
00058     0,
00059     0,
00060     0,
00061     0,
00062     0,
00063     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, style),           <span class="comment">// GCL_STYLE</span>
00064     0,
00065     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, lpfnWndProc),     <span class="comment">// GCL_WNDPROC</span>
00066     0,
00067     0,
00068     0,
00069     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, cbclsExtra),      <span class="comment">// GCL_CBCLSEXTRA</span>
00070     0,
00071     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, cbwndExtra),      <span class="comment">// GCL_CBWNDEXTRA</span>
00072     0,
00073     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, hModule),         <span class="comment">// GCL_HMODULE</span>
00074     0,
00075     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, spicn),           <span class="comment">// GCL_HICON</span>
00076     0,
00077     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, spcur),           <span class="comment">// GCL_HCURSOR</span>
00078     0,
00079     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, hbrBackground),   <span class="comment">// GCL_HBRBACKGROUND</span>
00080     0,
00081     FIELD_OFFSET(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>, lpszMenuName)     <span class="comment">// GCL_MENUNAME</span>
00082 };
00083 
00084 <span class="comment">/*</span>
00085 <span class="comment"> * INDEX_OFFSET must refer to the first entry of afClassDWord[]</span>
00086 <span class="comment"> */</span>
<a name="l00087"></a><a class="code" href="../../d2/d7/class_8c.html#a0">00087</a> <span class="preprocessor">#define INDEX_OFFSET GCLP_HICONSM</span>
00088 <span class="preprocessor"></span>
00089 <span class="comment">/***************************************************************************\</span>
00090 <span class="comment">* _RegisterClass (API)</span>
00091 <span class="comment">*</span>
00092 <span class="comment">* This stub calls InternalRegisterClass to do its work and then does some</span>
00093 <span class="comment">* additional work to save a pointer to the client-side menu name string.</span>
00094 <span class="comment">* The menu string is returned by _GetClassInfo so the client can fix up</span>
00095 <span class="comment">* a valid entry for the WNDCLASS lpszMenuName field.</span>
00096 <span class="comment">*</span>
00097 <span class="comment">* History:</span>
00098 <span class="comment">* 04-26-91 DarrinM      Created.</span>
00099 <span class="comment">\***************************************************************************/</span>
00100 
<a name="l00101"></a><a class="code" href="../../d4/d1/userk_8h.html#a1898">00101</a> ATOM <a class="code" href="../../d4/d1/userk_8h.html#a1898">xxxRegisterClassEx</a>(
00102     LPWNDCLASSEX cczpwc,
00103     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">PCLSMENUNAME</a> pcmn,
00104     WORD fnid,
00105     DWORD dwFlags,
00106     LPDWORD pdwWOW )
00107 {
00108     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00109     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00110 
00111     <span class="comment">/*</span>
00112 <span class="comment">     * NOTE -- lpszClassName and lpszMenuName in the wndclass may be client-side</span>
00113 <span class="comment">     *         pointers.  Use of those fields must be protected in try blocks.</span>
00114 <span class="comment">     */</span>
00115 
00116     <span class="comment">/*</span>
00117 <span class="comment">     * Convert a possible CallProc Handle into a real address.  They may</span>
00118 <span class="comment">     * have kept the CallProc Handle from some previous mixed GetClassinfo</span>
00119 <span class="comment">     * or SetWindowLong.</span>
00120 <span class="comment">     */</span>
00121     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a468">ISCPDTAG</a>(cczpwc-&gt;lpfnWndProc)) {
00122         <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD;
00123         <span class="keywordflow">if</span>  (pCPD = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HANDLE)cczpwc-&gt;lpfnWndProc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>)) {
00124             cczpwc-&gt;lpfnWndProc = (WNDPROC)pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o2">pfnClientPrevious</a>;
00125         }
00126     }
00127 
00128     pcls = <a class="code" href="../../d4/d1/userk_8h.html#a1569">InternalRegisterClassEx</a>(cczpwc, fnid, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> | ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a496">CSF_WOWCLASS</a> : 0) );
00129     <span class="keywordflow">if</span> (pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00130 
00131         pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o9">lpszClientUnicodeMenuName</a> = pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>;
00132         pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o8">lpszClientAnsiMenuName</a> = pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>;
00133 
00134         <span class="comment">/*</span>
00135 <span class="comment">         * copy 5 WOW dwords.</span>
00136 <span class="comment">         */</span>
00137         <span class="keywordflow">if</span> (pdwWOW) {
00138             RtlCopyMemory (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a491">PWCFromPCLS</a>(pcls), pdwWOW, <span class="keyword">sizeof</span>(WC));
00139         }
00140 
00141         <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>) {
00142             pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o6">hTaskWow</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a>;
00143         } <span class="keywordflow">else</span> {
00144             pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o6">hTaskWow</a> = 0;
00145         }
00146 
00147         <span class="comment">/*</span>
00148 <span class="comment">         * For some (presumably good) reason Win 3.1 changed RegisterClass</span>
00149 <span class="comment">         * to return the classes classname atom.</span>
00150 <span class="comment">         */</span>
00151         <span class="keywordflow">return</span> pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a>;
00152     } <span class="keywordflow">else</span> {
00153         <span class="keywordflow">return</span> 0;
00154     }
00155 }
00156 
00157 
00158 <span class="comment">/***************************************************************************\</span>
00159 <span class="comment">* ClassAlloc</span>
00160 <span class="comment">* ClassFree</span>
00161 <span class="comment">*</span>
00162 <span class="comment">* Generic allocation routines that discriminate between desktop heap</span>
00163 <span class="comment">* and pool.</span>
00164 <span class="comment">*</span>
00165 <span class="comment">* History:</span>
00166 <span class="comment">* 08-07-95 JimA         Created</span>
00167 <span class="comment">\***************************************************************************/</span>
00168 
<a name="l00169"></a><a class="code" href="../../d2/d7/class_8c.html#a4">00169</a> PVOID <a class="code" href="../../d2/d7/class_8c.html#a4">ClassAlloc</a>(
00170     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk,
00171     DWORD cbAlloc)
00172 {
00173     PVOID pvalloc;
00174 
00175     <span class="keywordflow">if</span> (pdesk)
00176         <span class="comment">/*</span>
00177 <span class="comment">         * Later5.0 GerardoB. Make this allocation directly to avoid</span>
00178 <span class="comment">         *  DesktopAlloc from failing it when the desktop is destroyed.</span>
00179 <span class="comment">         * When destroying a locked window, we might need to clone the</span>
00180 <span class="comment">         *  zombie class which requires an allocation on the wnd's desktop.</span>
00181 <span class="comment">         * We need to make sure that the client side doesn't get to the</span>
00182 <span class="comment">         *  class of a zombie window; then we won't need to make the heap</span>
00183 <span class="comment">         *  allocation; or is there any other reason for that allocation?</span>
00184 <span class="comment">         */</span>
00185         pvalloc = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)<a class="code" href="../../d4/d1/userk_8h.html#a312">DesktopAllocAlways</a>(pdesk, cbAlloc, <a class="code" href="../../d4/d1/userk_8h.html#a302">DTAG_CLASS</a>);
00186     <span class="keywordflow">else</span> {
00187         pvalloc = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)UserAllocPoolWithQuotaZInit(cbAlloc, TAG_CLASS);
00188     }
00189 
00190     <span class="keywordflow">return</span> pvalloc;
00191 }
00192 
<a name="l00193"></a><a class="code" href="../../d2/d7/class_8c.html#a5">00193</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d7/class_8c.html#a5">ClassFree</a>(
00194     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk,
00195     PVOID pvfree)
00196 {
00197     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00198         <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pdesk, pvfree);
00199     <span class="keywordflow">else</span>
00200         UserFreePool(pvfree);
00201 }
00202 
00203 <span class="comment">/***************************************************************************\</span>
00204 <span class="comment">* ValidateAndLockCursor</span>
00205 <span class="comment">*</span>
00206 <span class="comment">* Win95 comaptible validation</span>
00207 <span class="comment">*</span>
00208 <span class="comment">* History:</span>
00209 <span class="comment">* 12-19-95 GerardoB     Created</span>
00210 <span class="comment">\***************************************************************************/</span>
<a name="l00211"></a><a class="code" href="../../d2/d7/class_8c.html#a6">00211</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d7/class_8c.html#a6">ValidateAndLockCursor</a> (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> * ppcursor, BOOL fIs40Compat)
00212 {
00213     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
00214 
00215     <span class="keywordflow">if</span> (*ppcursor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00216         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00217     }
00218 
00219     pcur = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a7">HMValidateHandleNoSecure</a>(*ppcursor, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>);
00220     <span class="keywordflow">if</span> (pcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00221         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ValidateAndLockCursor: Invalid Cursor or Icon:%#p"</span>, *ppcursor);
00222         <span class="keywordflow">if</span> (fIs40Compat) {
00223             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">"RegisterClass: Invalid Parameter"</span>);
00224             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00225         }
00226     }
00227 
00228     *ppcursor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00229     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(ppcursor, pcur);
00230     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00231 }
00232 <span class="comment">/***************************************************************************\</span>
00233 <span class="comment">* InternalRegisterClass</span>
00234 <span class="comment">*</span>
00235 <span class="comment">* This API is called by applications or the system to register private or</span>
00236 <span class="comment">* global (public) window classes.  If a class with the same name already</span>
00237 <span class="comment">* exists the call will fail, except in the special case where an application</span>
00238 <span class="comment">* registers a private class with the same name as a global class.  In this</span>
00239 <span class="comment">* case the private class supercedes the global class for that application.</span>
00240 <span class="comment">*</span>
00241 <span class="comment">* History:</span>
00242 <span class="comment">* 10-15-90 DarrinM      Ported from Win 3.0 sources.</span>
00243 <span class="comment">\***************************************************************************/</span>
<a name="l00244"></a><a class="code" href="../../d4/d1/userk_8h.html#a1569">00244</a> <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1569">InternalRegisterClassEx</a>(
00245     LPWNDCLASSEX cczlpwndcls,
00246     WORD fnid,
00247     DWORD CSF_flags
00248     )
00249 {
00250     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIs40Compat;
00251     ULONG_PTR dwT;
00252     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00253     LPWSTR pszT1;
00254     ATOM atomT;
00255     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00256     HANDLE hModule;
00257     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
00258     ULONG cch;
00259     UNICODE_STRING UString;
00260     ANSI_STRING AString;
00261 
00262     <span class="comment">/*</span>
00263 <span class="comment">     * NOTE -- lpszClassName and lpszMenuName in the wndclass may be client-side</span>
00264 <span class="comment">     *         pointers.  Use of those fields must be protected in try blocks.</span>
00265 <span class="comment">     */</span>
00266     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00267 
00268     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00269 
00270     <span class="comment">/*</span>
00271 <span class="comment">     * Don't allow 4.0 apps to register a class using hModuleWin</span>
00272 <span class="comment">     * LATER GerardoB: Our client side classes use hmodUser (USER32) while</span>
00273 <span class="comment">     *  our server side classes use hWinInstance (WIN32K). We should change</span>
00274 <span class="comment">     * CreateThreadInfo and LW_RegisterWindows so all classes use hModUser.</span>
00275 <span class="comment">     */</span>
00276     hModule = cczlpwndcls-&gt;hInstance;
00277      <span class="keywordflow">if</span> (!(CSF_flags &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a495">CSF_SYSTEMCLASS</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>))
00278             &amp;&amp; (hModule == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>)
00279             &amp;&amp; (LOWORD(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a>) &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>)) {
00280 
00281          RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"InternalRegisterClassEx: Invalid hInstance (Cannot use system's hInstance)"</span>);
00282          <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00283      }
00284 
00285 
00286     <span class="comment">/*</span>
00287 <span class="comment">     * As of NT 4.0 we no longer honor CS_BYTEALIGNCLIENT or CS_BYTEALIGNWINDOW</span>
00288 <span class="comment">     */</span>
00289     <span class="keywordflow">if</span> (cczlpwndcls-&gt;style &amp; (CS_BYTEALIGNCLIENT | CS_BYTEALIGNWINDOW)) {
00290         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"CS_BYTEALIGNCLIENT and CS_BYTEALIGNWINDOW styles no longer honored."</span>);
00291     }
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     * Does this class exist as a private class?  If so, fail.</span>
00295 <span class="comment">     */</span>
00296     atomT = <a class="code" href="../../d4/d1/userk_8h.html#a523">FindClassAtom</a>(cczlpwndcls-&gt;lpszClassName);
00297 
00298     <span class="keywordflow">if</span> (atomT != 0 &amp;&amp; !(CSF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>)) {
00299         <span class="comment">/*</span>
00300 <span class="comment">         * First check private classes. If already exists, return error.</span>
00301 <span class="comment">         */</span>
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atomT, &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>,
00303                 hModule) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00304             RIPERR1(ERROR_CLASS_ALREADY_EXISTS, RIP_VERBOSE, <span class="stringliteral">"RegisterClass: Class already exists %lx"</span>, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)atomT);
00305             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00306         }
00307 
00308         <span class="comment">/*</span>
00309 <span class="comment">         * Now only check public classes if CS_GLOBALCLASS is set. If it</span>
00310 <span class="comment">         * isn't set, then this will allow an application to re-register</span>
00311 <span class="comment">         * a private class to take precedence over a public class.</span>
00312 <span class="comment">         */</span>
00313         <span class="keywordflow">if</span> (cczlpwndcls-&gt;style &amp; CS_GLOBALCLASS) {
00314             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atomT, &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00315                 RIPERR0(ERROR_CLASS_ALREADY_EXISTS, RIP_VERBOSE, <span class="stringliteral">"RegisterClass: Global Class already exists"</span>);
00316                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00317             }
00318         }
00319     }
00320 
00321     <span class="comment">/*</span>
00322 <span class="comment">     * Alloc space for the class.</span>
00323 <span class="comment">     */</span>
00324     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) {
00325         pdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00326     } <span class="keywordflow">else</span> {
00327         pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
00328     }
00329     pcls = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)<a class="code" href="../../d2/d7/class_8c.html#a4">ClassAlloc</a>(pdesk, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>) + cczlpwndcls-&gt;cbClsExtra + (CSF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a496">CSF_WOWCLASS</a> ? <span class="keyword">sizeof</span>(WC):0));
00330     <span class="keywordflow">if</span> (pcls == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00331         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00332     }
00333 
00334     <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a>, pdesk, LDL_CLS_DESKPARENT1, (ULONG_PTR)pcls);
00335     pcls-&gt;pclsBase = pcls;
00336 
00337     <span class="comment">/*</span>
00338 <span class="comment">     * Copy over the shared part of the class structure.</span>
00339 <span class="comment">     */</span>
00340     UserAssert(FIELD_OFFSET(WNDCLASSEX, style) == FIELD_OFFSET(<a class="code" href="../../d1/d1/structtagCOMMON__WNDCLASS.html">COMMON_WNDCLASS</a>, style));
00341     RtlCopyMemory(&amp;pcls-&gt;style, &amp;(cczlpwndcls-&gt;style),
00342                   <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1034">COMMON_WNDCLASS</a>) - FIELD_OFFSET(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1034">COMMON_WNDCLASS</a>, style));
00343 
00344     <span class="comment">/*</span>
00345 <span class="comment">     * Copy CSF_SERVERSIDEPROC, CSF_ANSIPROC (etc.) flags</span>
00346 <span class="comment">     */</span>
00347     pcls-&gt;CSF_flags = LOWORD(CSF_flags);
00348     pcls-&gt;fnid = fnid;
00349     <span class="keywordflow">if</span> (fnid) {
00350         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a231">CBFNID</a>(fnid) = (WORD)(pcls-&gt;cbwndExtra + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>));
00351 
00352         <span class="keywordflow">if</span> (!(pcls-&gt;CSF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>) &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00353             <span class="comment">/*</span>
00354 <span class="comment">             * Clear the bit so new threads in this process</span>
00355 <span class="comment">             * won't bother to reregister the client-side USER classes.</span>
00356 <span class="comment">             */</span>
00357             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a117">CI_REGISTERCLASSES</a>;
00358         }
00359     }
00360 
00361     <span class="comment">/*</span>
00362 <span class="comment">     * If this wndproc happens to be a client wndproc stub for a server</span>
00363 <span class="comment">     * wndproc, then remember the server wndproc! This should be rare: why</span>
00364 <span class="comment">     * would an application re-register a class that isn't "subclassed"?</span>
00365 <span class="comment">     */</span>
00366     <span class="keywordflow">if</span> (!(pcls-&gt;CSF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>)) {
00367         dwT = <a class="code" href="../../d4/d1/userk_8h.html#a1155">MapClientToServerPfn</a>((ULONG_PTR)pcls-&gt;lpfnWndProc);
00368         <span class="keywordflow">if</span> (dwT != 0) {
00369             pcls-&gt;CSF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>;
00370             pcls-&gt;CSF_flags &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>;
00371             pcls-&gt;lpfnWndProc = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)dwT;
00372         }
00373     }
00374 
00375     <span class="comment">/*</span>
00376 <span class="comment">     * Win95 compatible validation.</span>
00377 <span class="comment">     *</span>
00378 <span class="comment">     * hbrBackground was validated by GDI in the client side</span>
00379 <span class="comment">     * NULL hInstances are mapped to GetModuleHandle(NULL) in the client</span>
00380 <span class="comment">     * side</span>
00381 <span class="comment">     */</span>
00382 
00383     fIs40Compat = (CSF_flags &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a491">CSF_WIN40COMPAT</a>) != 0;
00384 
00385     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/class_8c.html#a6">ValidateAndLockCursor</a>(&amp;pcls-&gt;spcur, fIs40Compat)) {
00386         <span class="keywordflow">goto</span> ValidateError1;
00387     }
00388 
00389     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/class_8c.html#a6">ValidateAndLockCursor</a>(&amp;pcls-&gt;spicn, fIs40Compat)) {
00390         <span class="keywordflow">goto</span> ValidateError2;
00391     }
00392 
00393     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/class_8c.html#a6">ValidateAndLockCursor</a>(&amp;pcls-&gt;spicnSm, fIs40Compat)) {
00394         <span class="keywordflow">goto</span> ValidateError3;
00395     }
00396 
00397     <span class="comment">/*</span>
00398 <span class="comment">     * Add the class name to the atom table.</span>
00399 <span class="comment">     */</span>
00400 
00401     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cczlpwndcls-&gt;lpszClassName))
00402         atomT = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(cczlpwndcls-&gt;lpszClassName, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00403     <span class="keywordflow">else</span>
00404         atomT = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(cczlpwndcls-&gt;lpszClassName);
00405 
00406     <span class="keywordflow">if</span> (atomT == 0) {
00407         <span class="keywordflow">goto</span> AtomError;
00408     }
00409     pcls-&gt;atomClassName = atomT;
00410 
00411     <span class="comment">/*</span>
00412 <span class="comment">     * Make an ANSI version of the class name to optimize</span>
00413 <span class="comment">     * GetClassNameA for WOW.</span>
00414 <span class="comment">     */</span>
00415     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cczlpwndcls-&gt;lpszClassName)) {
00416         <span class="keywordflow">try</span> {
00417             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UString, cczlpwndcls-&gt;lpszClassName);
00418         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00419             <span class="keywordflow">goto</span> MemError2;
00420         }
00421 <span class="preprocessor">#ifdef FE_SB // InternalRegisterClassEx()</span>
00422 <span class="preprocessor"></span>        cch = UString.Length + 1;
00423 <span class="preprocessor">#else</span>
00424 <span class="preprocessor"></span>        cch = UString.Length / <span class="keyword">sizeof</span>(WCHAR) + 1;
00425 <span class="preprocessor">#endif // FE_SB</span>
00426 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00427         cch = 7; <span class="comment">// 1 char for '#', 5 for '65536'.</span>
00428     }
00429 
00430     <span class="comment">/*</span>
00431 <span class="comment">     * Allocate the ANSI name buffer and convert the unicode name</span>
00432 <span class="comment">     * to ANSI.</span>
00433 <span class="comment">     */</span>
00434     pcls-&gt;lpszAnsiClassName = (LPSTR)<a class="code" href="../../d2/d7/class_8c.html#a4">ClassAlloc</a>(pdesk, cch);
00435     <span class="keywordflow">if</span> (pcls-&gt;lpszAnsiClassName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00436         <span class="keywordflow">goto</span> MemError2;
00437     }
00438 
00439     <span class="comment">/*</span>
00440 <span class="comment">     * Form the ANSI class name.</span>
00441 <span class="comment">     */</span>
00442     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cczlpwndcls-&gt;lpszClassName)) {
00443 
00444         <span class="comment">/*</span>
00445 <span class="comment">         * Class name is a string.</span>
00446 <span class="comment">         */</span>
00447         AString.Length = 0;
00448         AString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cch;
00449         AString.Buffer = pcls-&gt;lpszAnsiClassName;
00450         <span class="keywordflow">try</span> {
00451             <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;AString, &amp;UString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00452         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00453             <span class="keywordflow">goto</span> MemError3;
00454         }
00455     } <span class="keywordflow">else</span> {
00456 
00457         <span class="comment">/*</span>
00458 <span class="comment">         * Class name is an integer atom.</span>
00459 <span class="comment">         */</span>
00460         pcls-&gt;lpszAnsiClassName[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'#'</span>;
00461         <a class="code" href="../../d9/d3/cnvint_8c.html#a2">RtlIntegerToChar</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(cczlpwndcls-&gt;lpszClassName), 10, cch - 1,
00462                 &amp;pcls-&gt;lpszAnsiClassName[1]);
00463     }
00464 
00465     <span class="comment">/*</span>
00466 <span class="comment">     * Make local copy of menu name.</span>
00467 <span class="comment">     */</span>
00468     pszT1 = pcls-&gt;lpszMenuName;
00469 
00470     <span class="keywordflow">if</span> (pszT1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00471         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pszT1)) {
00472             <span class="keywordflow">try</span> {
00473                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UString, pszT1);
00474             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00475                 <span class="keywordflow">goto</span> MemError3;
00476             }
00477             <span class="keywordflow">if</span> (UString.Length == 0) {
00478 
00479                 <span class="comment">/*</span>
00480 <span class="comment">                 * app passed an empty string for the name</span>
00481 <span class="comment">                 */</span>
00482                 pcls-&gt;lpszMenuName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00483             } <span class="keywordflow">else</span> {
00484                 UNICODE_STRING strMenuName;
00485 
00486                 <span class="comment">/*</span>
00487 <span class="comment">                 * Alloc space for the Menu Name.</span>
00488 <span class="comment">                 */</span>
00489                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1533">AllocateUnicodeString</a>(&amp;strMenuName, &amp;UString)) {
00490 MemError3:
00491                     <a class="code" href="../../d2/d7/class_8c.html#a5">ClassFree</a>(pdesk, pcls-&gt;lpszAnsiClassName);
00492 MemError2:
00493                     <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>(pcls-&gt;atomClassName);
00494 AtomError:
00495                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pcls-&gt;spicnSm);
00496 ValidateError3:
00497                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pcls-&gt;spicn);
00498 ValidateError2:
00499                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pcls-&gt;spcur);
00500 ValidateError1:
00501                     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;pcls-&gt;rpdeskParent, LDU_CLS_DESKPARENT1, (ULONG_PTR)pcls);
00502                     <a class="code" href="../../d2/d7/class_8c.html#a5">ClassFree</a>(pdesk, pcls);
00503                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00504                 }
00505 
00506                 pcls-&gt;lpszMenuName = strMenuName.Buffer;
00507             }
00508         }
00509     }
00510 
00511     <span class="keywordflow">if</span> ((CSF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>) || (pcls-&gt;style &amp; CS_GLOBALCLASS)) {
00512         <span class="keywordflow">if</span> (pcls-&gt;CSF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a495">CSF_SYSTEMCLASS</a>) {
00513             pcls-&gt;pclsNext = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a154">gpclsList</a>;
00514             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a154">gpclsList</a> = pcls;
00515         } <span class="keywordflow">else</span> {
00516             pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>;
00517             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a> = pcls;
00518         }
00519     } <span class="keywordflow">else</span> {
00520         pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>;
00521         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a> = pcls;
00522     }
00523 
00524     <span class="comment">/*</span>
00525 <span class="comment">     * Because Memory is allocated with ZEROINIT, the pcls-&gt;cWndReferenceCount</span>
00526 <span class="comment">     * field is automatically initialised to zero.</span>
00527 <span class="comment">     */</span>
00528 
00529     <span class="keywordflow">return</span> pcls;
00530 }
00531 
00532 
00533 <span class="comment">/***************************************************************************\</span>
00534 <span class="comment">* _UnregisterClass (API)</span>
00535 <span class="comment">*</span>
00536 <span class="comment">* This API function is used to unregister a window class previously</span>
00537 <span class="comment">* registered by the Application.</span>
00538 <span class="comment">*</span>
00539 <span class="comment">* Returns:</span>
00540 <span class="comment">*     TRUE  if successful.</span>
00541 <span class="comment">*     FALSE otherwise.</span>
00542 <span class="comment">*</span>
00543 <span class="comment">* NOTE:</span>
00544 <span class="comment">*  1. The class name must have been registered earlier by this client</span>
00545 <span class="comment">*     through RegisterClass().</span>
00546 <span class="comment">*  2. The class name should not be one of the predefined control classes.</span>
00547 <span class="comment">*  3. All windows created with this class must be destroyed before calling</span>
00548 <span class="comment">*     this function.</span>
00549 <span class="comment">*</span>
00550 <span class="comment">* History:</span>
00551 <span class="comment">* 10-15-90 DarrinM      Ported from Win 3.0 sources.</span>
00552 <span class="comment">* 03-09-94 BradG        Fixed bug when ATOM was passed in</span>
00553 <span class="comment">\***************************************************************************/</span>
00554 
<a name="l00555"></a><a class="code" href="../../d4/d1/userk_8h.html#a1901">00555</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1901">_UnregisterClass</a>(
00556     LPCWSTR ccxlpszClassName,
00557     HANDLE hModule,
00558     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">PCLSMENUNAME</a> pcmn)
00559 {
00560     ATOM atomT;
00561     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls;
00562     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00563 
00564     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00565 
00566     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00567 
00568     <span class="comment">/*</span>
00569 <span class="comment">     * Check whether the given ClassName is already registered by the</span>
00570 <span class="comment">     * Application with the given handle.</span>
00571 <span class="comment">     * Return error, if either the Class does not exist or it does not</span>
00572 <span class="comment">     * belong to the calling process.</span>
00573 <span class="comment">     */</span>
00574 
00575     <span class="comment">/*</span>
00576 <span class="comment">     * bradg (3/9/95) - Must first check to see if an ATOM has been passed</span>
00577 <span class="comment">     */</span>
00578     atomT = <a class="code" href="../../d4/d1/userk_8h.html#a523">FindClassAtom</a>(ccxlpszClassName);
00579 
00580     ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atomT, &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>, hModule);
00581     <span class="keywordflow">if</span> (ppcls == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00582         <span class="comment">/*</span>
00583 <span class="comment">         * Maybe this is a public class.</span>
00584 <span class="comment">         */</span>
00585         ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atomT, &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00586         <span class="keywordflow">if</span> (ppcls == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00587             RIPERR1(ERROR_CLASS_DOES_NOT_EXIST, RIP_WARNING, <span class="stringliteral">"UnregisterClass: Class does not exist; atom=%lX"</span>, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)atomT);
00588             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00589         }
00590     }
00591 
00592     <span class="comment">/*</span>
00593 <span class="comment">     * If any windows created with this class still exist return an error.</span>
00594 <span class="comment">     */</span>
00595     <span class="keywordflow">if</span> ((*ppcls)-&gt;cWndReferenceCount != 0) {
00596         RIPERR0(ERROR_CLASS_HAS_WINDOWS, RIP_WARNING, <span class="stringliteral">"UnregisterClass: Class still has window"</span>);
00597         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00598     }
00599 
00600     <span class="comment">/*</span>
00601 <span class="comment">     * Return client side pointers for cleanup</span>
00602 <span class="comment">     */</span>
00603     pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a> = (*ppcls)-&gt;lpszClientAnsiMenuName;
00604     pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a> = (*ppcls)-&gt;lpszClientUnicodeMenuName;
00605     pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00606 
00607     <span class="comment">/*</span>
00608 <span class="comment">     * Release the Window class and related information.</span>
00609 <span class="comment">     */</span>
00610     <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppcls);
00611 
00612     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00613 }
00614 
00615 
<a name="l00616"></a><a class="code" href="../../d4/d1/userk_8h.html#a1904">00616</a> <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1904">_GetWOWClass</a>(
00617     HANDLE hModule,
00618     LPCWSTR ccxlpszClassName)
00619 {
00620     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00621     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00622     ATOM atomT;
00623     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00624 
00625     <a class="code" href="../../d4/d1/userk_8h.html#a156">CheckCritInShared</a>();
00626 
00627     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00628 
00629     <span class="comment">/*</span>
00630 <span class="comment">     * Is this class registered as a private class?</span>
00631 <span class="comment">     */</span>
00632     atomT = <a class="code" href="../../d4/d1/userk_8h.html#a1298">UserFindAtom</a>(ccxlpszClassName);
00633     <span class="keywordflow">if</span> (atomT != 0)
00634         ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1152">GetClassPtr</a>(atomT, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, hModule);
00635     <span class="keywordflow">if</span> (ppcls == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00636         RIPERR0(ERROR_CLASS_DOES_NOT_EXIST, RIP_VERBOSE, <span class="stringliteral">""</span>);
00637         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00638     }
00639 
00640     pcls = *ppcls;
00641 
00642     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a>) {
00643         pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
00644         <span class="keywordflow">while</span> (pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00645             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a>) {
00646                 <span class="keywordflow">goto</span> Done;
00647             }
00648             pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
00649         }
00650         RIPERR0(ERROR_CLASS_DOES_NOT_EXIST, RIP_VERBOSE, <span class="stringliteral">""</span>);
00651         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00652     }
00653 Done:
00654     <span class="keywordflow">return</span> pcls;
00655 }
00656 
00657 <span class="comment">/***************************************************************************\</span>
00658 <span class="comment">* GetClassInfo (API)</span>
00659 <span class="comment">*</span>
00660 <span class="comment">* This function checks if the given class name is registered already.  If the</span>
00661 <span class="comment">* class is not found, it returns 0;  If the class is found, then all the</span>
00662 <span class="comment">* relevant information from the CLS structure is copied into the WNDCLASS</span>
00663 <span class="comment">* structure pointed to by the lpWndCls argument.  If successful, it returns</span>
00664 <span class="comment">* the class name atom</span>
00665 <span class="comment">*</span>
00666 <span class="comment">* NOTE: hmod was used to distinguish between different task's public classes.</span>
00667 <span class="comment">* Now that public classes are gone, hmod isn't used anymore.  We just search</span>
00668 <span class="comment">* the applications private class for a match and if none is found we search</span>
00669 <span class="comment">* the system classes.</span>
00670 <span class="comment">*</span>
00671 <span class="comment">* History:</span>
00672 <span class="comment">* 10-15-90 DarrinM      Ported from Win 3.0 sources.</span>
00673 <span class="comment">* 04-08-91 DarrinM      Removed public classes.</span>
00674 <span class="comment">* 04-26-91 DarrinM      Streamlined to work with the client-side API.</span>
00675 <span class="comment">* 03-09-95 BradG        Fixed bug when ATOM was passed in</span>
00676 <span class="comment">\***************************************************************************/</span>
00677 
<a name="l00678"></a><a class="code" href="../../d4/d1/userk_8h.html#a1902">00678</a> ATOM <a class="code" href="../../d4/d1/userk_8h.html#a1902">_GetClassInfoEx</a>(
00679     HANDLE hModule,
00680     LPCWSTR ccxlpszClassName,
00681     LPWNDCLASSEX pwc,
00682     LPWSTR *ppszMenuName,
00683     BOOL bAnsi)
00684 {
00685     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00686     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls;
00687     ATOM atomT;
00688     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00689     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCPDType = 0;
00690 
00691     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00692 
00693     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00694 
00695     <span class="comment">/*</span>
00696 <span class="comment">     * These are done first so if we don't find the class, and therefore</span>
00697 <span class="comment">     * fail, the return thank won't try to copy back these (nonexistant)</span>
00698 <span class="comment">     * strings.</span>
00699 <span class="comment">     */</span>
00700     pwc-&gt;lpszMenuName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00701     pwc-&gt;lpszClassName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00702 
00703     <span class="comment">/*</span>
00704 <span class="comment">     * Is this class registered as a private class?</span>
00705 <span class="comment">     */</span>
00706 
00707     <span class="comment">/*</span>
00708 <span class="comment">     * bradg (3/9/95) - Must first check to see if an ATOM has been passed.</span>
00709 <span class="comment">     */</span>
00710     atomT = <a class="code" href="../../d4/d1/userk_8h.html#a523">FindClassAtom</a>(ccxlpszClassName);
00711 
00712     <span class="comment">/*</span>
00713 <span class="comment">     * Windows 3.1 does not perform the class search with</span>
00714 <span class="comment">     * a null hModule.  If an application supplies a NULL</span>
00715 <span class="comment">     * hModule, they search on hModuleWin instead.</span>
00716 <span class="comment">     */</span>
00717 
00718     <span class="keywordflow">if</span> (hModule == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00719         hModule = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a274">hModClient</a>;
00720 
00721     ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1152">GetClassPtr</a>(atomT, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, hModule);
00722 
00723 
00724     <span class="keywordflow">if</span> (ppcls == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00725         RIPERR0(ERROR_CLASS_DOES_NOT_EXIST, RIP_VERBOSE, <span class="stringliteral">"GetClassInfo: Class does not exist"</span>);
00726         <span class="keywordflow">return</span> 0;
00727     }
00728 
00729     pcls = *ppcls;
00730 
00731     <span class="comment">/*</span>
00732 <span class="comment">     * Copy all the fields common to CLS and WNDCLASS structures except</span>
00733 <span class="comment">     * the lpszMenuName and lpszClassName which will be filled in by the</span>
00734 <span class="comment">     * client-side piece of GetClassInfo.</span>
00735 <span class="comment">     */</span>
00736 
00737      <span class="comment">/*</span>
00738 <span class="comment">      * Return public bits only</span>
00739 <span class="comment">      */</span>
00740     pwc-&gt;style = pcls-&gt;style &amp; CS_VALID;
00741 
00742     <span class="comment">/*</span>
00743 <span class="comment">     * Corel Depth 6.0 calls GetClassInfo (COMBOBOX) and registers a class</span>
00744 <span class="comment">     *  using the same name and style bits. This works OK on Win95 because</span>
00745 <span class="comment">     *  their "system" (combo, edit, etc) classes are not CS_GLOBALCLASS</span>
00746 <span class="comment">     * So we got to mask this bit out for our classes</span>
00747 <span class="comment">     */</span>
00748 
00749      <span class="comment">/*</span>
00750 <span class="comment">     * Bug 17998.  If the app is 32bit and WinVer is less than 4.0 don't mask</span>
00751 <span class="comment">     * out the CS_GLOBALCLASS bit.</span>
00752 <span class="comment">     */</span>
00753 
00754     <span class="keywordflow">if</span>  ( (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a> != 0) &amp;&amp;
00755             ((LOWORD(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a>) &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) ) {
00756         pwc-&gt;style &amp;= ~CS_GLOBALCLASS;
00757     }
00758 
00759 
00760     pwc-&gt;cbClsExtra = pcls-&gt;cbclsExtra;
00761     pwc-&gt;cbWndExtra = pcls-&gt;cbwndExtra;
00762 
00763     <span class="comment">/*</span>
00764 <span class="comment">     * Stop 32-bit apps from inadvertantly using hModuleWin as their hInstance</span>
00765 <span class="comment">     * when they register a window class.  FritzS</span>
00766 <span class="comment">     */</span>
00767 
00768     <span class="keywordflow">if</span> (LOWORD(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a>) &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
00769         <span class="comment">/*</span>
00770 <span class="comment">         * This is actually, Win95 behavior -- the USER.EXE hModule gets thunked to NULL on</span>
00771 <span class="comment">         * the way out of the 16-&gt;32 bit thunk.  Note -- if we ever need to support 16-bit</span>
00772 <span class="comment">         * 4.0 apps (shudder), this may need to change.  FritzS</span>
00773 <span class="comment">         */</span>
00774         <span class="keywordflow">if</span> (hModule == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a274">hModClient</a>) {
00775             pwc-&gt;hInstance = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00776         } <span class="keywordflow">else</span> {
00777             pwc-&gt;hInstance = hModule;
00778         }
00779     } <span class="keywordflow">else</span> {
00780         <span class="comment">/*</span>
00781 <span class="comment">         * Win NT 3.1/3.51 returned the hInstance from the class.</span>
00782 <span class="comment">         * Note that this is incompatible with Win 3.1. WoW has hacks for 16-bit apps.</span>
00783 <span class="comment">         */</span>
00784 
00785         <span class="keywordflow">if</span> ((pcls-&gt;hModule == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>) || (pcls-&gt;hModule == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a274">hModClient</a>)) {
00786             pwc-&gt;hInstance = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a274">hModClient</a>;
00787         } <span class="keywordflow">else</span> {
00788             pwc-&gt;hInstance = pcls-&gt;hModule;
00789         }
00790     }
00791 
00792     pwc-&gt;hIcon = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pcls-&gt;spicn);
00793     pwc-&gt;hCursor = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pcls-&gt;spcur);
00794     pwc-&gt;hbrBackground = pcls-&gt;hbrBackground;
00795 
00796     <span class="comment">/*</span>
00797 <span class="comment">     * Need to hide the small icon if it's USER created</span>
00798 <span class="comment">     */</span>
00799     <span class="keywordflow">if</span> (pcls-&gt;spicnSm &amp;&amp; (pcls-&gt;spicnSm-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a540">CURSORF_SECRET</a>))
00800         pwc-&gt;hIconSm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00801     <span class="keywordflow">else</span>
00802         pwc-&gt;hIconSm = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pcls-&gt;spicnSm);
00803 
00804     <span class="comment">/*</span>
00805 <span class="comment">     * If its a server proc then map it to a client proc.  If not we may have</span>
00806 <span class="comment">     * to create a CPD.</span>
00807 <span class="comment">     */</span>
00808     <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>) {
00809         pwc-&gt;lpfnWndProc =
00810                 (WNDPROC)<a class="code" href="../../d2/d5/ntuser_2rtl_2getset_8c.html#a0">MapServerToClientPfn</a>((ULONG_PTR)pcls-&gt;lpfnWndProc, bAnsi);
00811     } <span class="keywordflow">else</span> {
00812         pwc-&gt;lpfnWndProc = (WNDPROC)<a class="code" href="../../d2/d5/ntuser_2rtl_2getset_8c.html#a1">MapClientNeuterToClientPfn</a>(pcls, 0, bAnsi);
00813 
00814         <span class="comment">/*</span>
00815 <span class="comment">         * If the client mapping didn't change the window proc then see if</span>
00816 <span class="comment">         * we need a callproc handle.</span>
00817 <span class="comment">         */</span>
00818         <span class="keywordflow">if</span> (pwc-&gt;lpfnWndProc == (WNDPROC)pcls-&gt;lpfnWndProc) {
00819             <span class="comment">/*</span>
00820 <span class="comment">             * Need to return a CallProc handle if there is an Ansi/Unicode mismatch</span>
00821 <span class="comment">             */</span>
00822             <span class="keywordflow">if</span> (bAnsi != !!(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>)) {
00823                 dwCPDType |= bAnsi ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a459">CPD_ANSI_TO_UNICODE</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>;
00824             }
00825         }
00826     }
00827 
00828     <span class="keywordflow">if</span> (dwCPDType) {
00829         ULONG_PTR dwCPD;
00830 
00831         dwCPD = <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a7">GetCPD</a>(pcls, dwCPDType | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a462">CPD_CLASS</a>, (ULONG_PTR)pwc-&gt;lpfnWndProc);
00832 
00833         <span class="keywordflow">if</span> (dwCPD) {
00834             pwc-&gt;lpfnWndProc = (WNDPROC)dwCPD;
00835         } <span class="keywordflow">else</span> {
00836             RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetClassInfo unable to alloc CPD returning handle\n"</span>);
00837         }
00838     }
00839 
00840     <span class="comment">/*</span>
00841 <span class="comment">     * Return the stashed pointer to the client-side menu name string.</span>
00842 <span class="comment">     */</span>
00843     <span class="keywordflow">if</span> (bAnsi) {
00844         *ppszMenuName = (LPWSTR)pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o8">lpszClientAnsiMenuName</a>;
00845     } <span class="keywordflow">else</span> {
00846         *ppszMenuName = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o9">lpszClientUnicodeMenuName</a>;
00847     }
00848     <span class="keywordflow">return</span> pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a>;
00849 }
00850 
00851 
00852 <span class="comment">/***************************************************************************\</span>
00853 <span class="comment">* _SetClassWord (API)</span>
00854 <span class="comment">*</span>
00855 <span class="comment">* Set a class word.  Positive index values set application class words</span>
00856 <span class="comment">* while negative index values set system class words.  The negative</span>
00857 <span class="comment">* indices are published in WINDOWS.H.</span>
00858 <span class="comment">*</span>
00859 <span class="comment">* History:</span>
00860 <span class="comment">* 10-16-90 darrinm      Wrote.</span>
00861 <span class="comment">\***************************************************************************/</span>
00862 
<a name="l00863"></a><a class="code" href="../../d4/d1/userk_8h.html#a1896">00863</a> WORD <a class="code" href="../../d4/d1/userk_8h.html#a1896">_SetClassWord</a>(
00864     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00865     <span class="keywordtype">int</span> index,
00866     WORD value)
00867 {
00868     WORD wOld;
00869     WORD UNALIGNED *pw;
00870     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00871 
00872     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00873 
00874     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
00875         RIPERR1(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"SetClassWord: different process: index 0x%lx"</span>, index);
00876         <span class="keywordflow">return</span> 0;
00877     }
00878 
00879     pcls = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>;
00880     <span class="keywordflow">if</span> ((index &lt; 0) || (index + (int)sizeof(WORD) &gt; pcls-&gt;cbclsExtra)) {
00881         RIPERR0(ERROR_INVALID_INDEX, RIP_WARNING, <span class="stringliteral">"SetClassWord: invalid index"</span>);
00882         <span class="keywordflow">return</span> 0;
00883     } <span class="keywordflow">else</span> {
00884         pw = (WORD UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pcls + 1) + index);
00885         wOld = *pw;
00886         *pw = value;
00887         pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
00888         <span class="keywordflow">while</span> (pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00889             pw = (WORD UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pcls + 1) + index);
00890             *pw = value;
00891             pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
00892         }
00893         <span class="keywordflow">return</span> wOld;
00894     }
00895 }
00896 
00897 
00898 <span class="comment">/***************************************************************************\</span>
00899 <span class="comment">* xxxSetClassLong (API)</span>
00900 <span class="comment">*</span>
00901 <span class="comment">* Set a class long.  Positive index values set application class longs</span>
00902 <span class="comment">* while negative index values set system class longs.  The negative</span>
00903 <span class="comment">* indices are published in WINDOWS.H.</span>
00904 <span class="comment">*</span>
00905 <span class="comment">* History:</span>
00906 <span class="comment">* 10-16-90 darrinm      Wrote.</span>
00907 <span class="comment">\***************************************************************************/</span>
00908 
<a name="l00909"></a><a class="code" href="../../d2/d7/class_8c.html#a12">00909</a> ULONG_PTR <a class="code" href="../../d4/d1/userk_8h.html#a606">xxxSetClassLongPtr</a>(
00910     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00911     <span class="keywordtype">int</span> index,
00912     ULONG_PTR value,
00913     BOOL bAnsi)
00914 {
00915     ULONG_PTR dwOld;
00916     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00917 
00918     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00919     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00920 
00921     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
00922         RIPERR1(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"SetClassLongPtr: different process: index 0x%lx"</span>, index);
00923         <span class="keywordflow">return</span> 0;
00924     }
00925 
00926     <span class="keywordflow">if</span> (index &lt; 0) {
00927         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1572">xxxSetClassData</a>(pwnd, index, value, bAnsi);
00928     } <span class="keywordflow">else</span> {
00929         pcls = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>;
00930         <span class="keywordflow">if</span> (index + (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(ULONG_PTR) &gt; pcls-&gt;cbclsExtra) {
00931             RIPERR0(ERROR_INVALID_INDEX, RIP_WARNING, <span class="stringliteral">"SetClassLongPtr: invalid index"</span>);
00932             <span class="keywordflow">return</span> 0;
00933         } <span class="keywordflow">else</span> {
00934             ULONG_PTR UNALIGNED *pudw;
00935             pudw = (ULONG_PTR UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pcls + 1) + index);
00936             dwOld = *pudw;
00937             *pudw = value;
00938             pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
00939             <span class="keywordflow">while</span> (pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00940                 pudw = (ULONG_PTR UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pcls + 1) + index);
00941                 *pudw = value;
00942                 pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
00943             }
00944             <span class="keywordflow">return</span> dwOld;
00945         }
00946     }
00947 }
00948 
00949 
00950 <span class="preprocessor">#ifdef _WIN64</span>
00951 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1897">xxxSetClassLong</a>(
00952     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00953     <span class="keywordtype">int</span> index,
00954     DWORD value,
00955     BOOL bAnsi)
00956 {
00957     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOld;
00958     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00959 
00960     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00961     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00962 
00963     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
00964         RIPERR1(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"SetClassLong: different process: index 0x%lx"</span>, index);
00965         <span class="keywordflow">return</span> 0;
00966     }
00967 
00968     <span class="keywordflow">if</span> (index &lt; 0) {
00969         <span class="keywordflow">if</span> (index &lt; <a class="code" href="../../d5/d7/classc_8c.html#a0">INDEX_OFFSET</a> || <a class="code" href="../../d5/d7/classc_8c.html#a1">afClassDWord</a>[index - <a class="code" href="../../d5/d7/classc_8c.html#a0">INDEX_OFFSET</a>] &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
00970             RIPERR1(ERROR_INVALID_INDEX, RIP_WARNING, <span class="stringliteral">"SetClassLong: invalid index %d"</span>, index);
00971             <span class="keywordflow">return</span> 0;
00972         }
00973         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1572">xxxSetClassData</a>(pwnd, index, value, bAnsi);
00974     } <span class="keywordflow">else</span> {
00975         pcls = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>;
00976         <span class="keywordflow">if</span> (index + (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &gt; pcls-&gt;cbclsExtra) {
00977             RIPERR0(ERROR_INVALID_INDEX, RIP_WARNING, <span class="stringliteral">"SetClassLong: invalid index"</span>);
00978             <span class="keywordflow">return</span> 0;
00979         } <span class="keywordflow">else</span> {
00980             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *pudw;
00981             pudw = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pcls + 1) + index);
00982             dwOld = *pudw;
00983             *pudw = value;
00984             pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
00985             <span class="keywordflow">while</span> (pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00986                 pudw = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pcls + 1) + index);
00987                 *pudw = value;
00988                 pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
00989             }
00990             <span class="keywordflow">return</span> dwOld;
00991         }
00992     }
00993 }
00994 <span class="preprocessor">#endif</span>
00995 <span class="preprocessor"></span>
00996 
<a name="l00997"></a><a class="code" href="../../d4/d1/userk_8h.html#a1917">00997</a> <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(
00998     ATOM atom,
00999     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls,
01000     HANDLE hModule)
01001 {
01002     <span class="keywordflow">if</span> (atom == 0)
01003         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01004 
01005     <span class="keywordflow">while</span> (*ppcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01006         <span class="keywordflow">if</span> ((*ppcls)-&gt;atomClassName == atom &amp;&amp;
01007                 (hModule == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || HIWORD((ULONG_PTR)(*ppcls)-&gt;hModule) == HIWORD((ULONG_PTR)hModule)) &amp;&amp;
01008                 !((*ppcls)-&gt;CSF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a494">CSF_WOWDEFERDESTROY</a>)) {
01009             <span class="keywordflow">return</span> ppcls;
01010         }
01011 
01012         ppcls = (<a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a>)*ppcls;
01013     }
01014 
01015     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01016 }
01017 
01018 
01019 <span class="comment">/***************************************************************************\</span>
01020 <span class="comment">* GetClassPtr</span>
01021 <span class="comment">*</span>
01022 <span class="comment">* Note: This returns a "pointer-to-PCLS" and not "PCLS".</span>
01023 <span class="comment">*</span>
01024 <span class="comment">* Scan the passed-in class list for the specified class.  Return NULL if</span>
01025 <span class="comment">* the class isn't in the list.</span>
01026 <span class="comment">*</span>
01027 <span class="comment">* History:</span>
01028 <span class="comment">* 10-16-90 darrinm      Ported this puppy.</span>
01029 <span class="comment">* 04-08-91 DarrinM      Rewrote to remove global classes.</span>
01030 <span class="comment">* 08-14-92 FritzS     Changed check to HIWORD only to allow Wow apps to</span>
01031 <span class="comment">*                     share window classes between instances of an app.</span>
01032 <span class="comment">                      (For Wow apps, HiWord of hInstance is 16-bit module,</span>
01033 <span class="comment">                       and LoWord is 16-bit hInstance</span>
01034 <span class="comment">\***************************************************************************/</span>
01035 
<a name="l01036"></a><a class="code" href="../../d4/d1/userk_8h.html#a1152">01036</a> <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1152">GetClassPtr</a>(
01037     ATOM atom,
01038     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi,
01039     HANDLE hModule)
01040 {
01041     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls;
01042 
01043     <span class="comment">/*</span>
01044 <span class="comment">     * First search public then private then usersrv registered classes</span>
01045 <span class="comment">     */</span>
01046     ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atom, &amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>, hModule);
01047     <span class="keywordflow">if</span> (ppcls)
01048         <span class="keywordflow">return</span> ppcls;
01049 
01050     ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atom, &amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01051     <span class="keywordflow">if</span> (ppcls)
01052         <span class="keywordflow">return</span> ppcls;
01053 
01054     <span class="comment">/*</span>
01055 <span class="comment">     * Next seach public and private classes and override hmodule;</span>
01056 <span class="comment">     * some apps (bunny) do a GetClassInfo(dialog) and RegisterClass</span>
01057 <span class="comment">     * and only change the wndproc which set the hmodule to be just</span>
01058 <span class="comment">     * like usersrv created it even though it is in the app's public</span>
01059 <span class="comment">     * or private class list</span>
01060 <span class="comment">     */</span>
01061 
01062     <span class="comment">/*</span>
01063 <span class="comment">     * Later -- since we are no longer returning hModuleWin to any app,</span>
01064 <span class="comment">     * we may only need to check for hModClient.  Check this out.</span>
01065 <span class="comment">     *      FritzS</span>
01066 <span class="comment">     */</span>
01067 
01068     ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atom, &amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a274">hModClient</a>);
01069     <span class="keywordflow">if</span> (ppcls)
01070         <span class="keywordflow">return</span> ppcls;
01071 
01072     ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atom, &amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a274">hModClient</a>);
01073     <span class="keywordflow">if</span> (ppcls)
01074         <span class="keywordflow">return</span> ppcls;
01075 
01076     <span class="comment">/*</span>
01077 <span class="comment">     * Search the system class list</span>
01078 <span class="comment">     */</span>
01079     ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1917">_InnerGetClassPtr</a>(atom, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a154">gpclsList</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01080     <span class="keywordflow">return</span> ppcls;
01081 }
01082 
01083 <span class="comment">/***************************************************************************\</span>
01084 <span class="comment"> * UnlockAndFreeCPDs -</span>
01085 <span class="comment"> *</span>
01086 <span class="comment"> * Safe way to unlock and free a linked list of CPDs.  Need to do it this</span>
01087 <span class="comment"> * way in case the Thread's objects have already been marked for destruction.</span>
01088 <span class="comment"> *</span>
01089 <span class="comment"> * History 2/10/95  SanfordS    Created</span>
01090 <span class="comment">\***************************************************************************/</span>
01091 
<a name="l01092"></a><a class="code" href="../../d2/d7/class_8c.html#a15">01092</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d7/class_8c.html#a15">UnlockAndFreeCPDs</a>(
01093 <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> *ppCPD)
01094 {
01095     <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD;
01096 
01097     <span class="keywordflow">while</span> ((pCPD = *ppCPD) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01098         <span class="comment">/*</span>
01099 <span class="comment">         * Unlink the CPD from the list.</span>
01100 <span class="comment">         */</span>
01101         *ppCPD = pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o5">spcpdNext</a>;
01102         pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o5">spcpdNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01103 
01104         <span class="comment">/*</span>
01105 <span class="comment">         * Mark it for destruction.</span>
01106 <span class="comment">         */</span>
01107         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pCPD)) {
01108             <a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pCPD);
01109         }
01110 
01111         <span class="comment">/*</span>
01112 <span class="comment">         * Unlock it and it will be destroyed.</span>
01113 <span class="comment">         */</span>
01114         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pCPD);
01115     }
01116 }
01117 
01118 <span class="comment">/***************************************************************************\</span>
01119 <span class="comment">* DestroyClassBrush</span>
01120 <span class="comment">*</span>
01121 <span class="comment">* Destroy the brush of the class if it's a brush, it's not a system</span>
01122 <span class="comment">* brush and no other class is using it</span>
01123 <span class="comment">*</span>
01124 <span class="comment">* History:</span>
01125 <span class="comment">* 4-10-96 CLupu  Created</span>
01126 <span class="comment">\***************************************************************************/</span>
01127 
<a name="l01128"></a><a class="code" href="../../d2/d7/class_8c.html#a16">01128</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d7/class_8c.html#a16">DestroyClassBrush</a>(
01129     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls)
01130 {
01131     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01132     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>         pclsWalk;
01133     <span class="keywordtype">int</span>          nInd;
01134     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         bRet;
01135     <span class="comment">/*</span>
01136 <span class="comment">     * Return if it's not a real brush</span>
01137 <span class="comment">     */</span>
01138     <span class="keywordflow">if</span> (pcls-&gt;hbrBackground &lt;= (HBRUSH)(COLOR_MAX))
01139         <span class="keywordflow">return</span>;
01140 
01141     <span class="comment">/*</span>
01142 <span class="comment">     * Don't delete the system brushes</span>
01143 <span class="comment">     */</span>
01144     <span class="keywordflow">for</span> (nInd = 0; nInd &lt; COLOR_MAX; nInd++) {
01145         <span class="keywordflow">if</span> (pcls-&gt;hbrBackground == <a class="code" href="../../d1/d0/inc_2user_8h.html#a15">SYSHBRUSH</a>(nInd))
01146             <span class="keywordflow">return</span>;
01147     }
01148 
01149 
01150     <span class="comment">/*</span>
01151 <span class="comment">     * Walk the process public public list</span>
01152 <span class="comment">     */</span>
01153     pclsWalk = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>;
01154 
01155     <span class="keywordflow">while</span> (pclsWalk) {
01156         <span class="keywordflow">if</span> (pclsWalk != pcls &amp;&amp; pclsWalk-&gt;hbrBackground == pcls-&gt;hbrBackground)
01157             <span class="keywordflow">return</span>;
01158 
01159         pclsWalk = pclsWalk-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
01160     }
01161 
01162     <span class="comment">/*</span>
01163 <span class="comment">     * Walk the process private class list</span>
01164 <span class="comment">     */</span>
01165     pclsWalk = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>;
01166 
01167     <span class="keywordflow">while</span> (pclsWalk) {
01168         <span class="keywordflow">if</span> (pclsWalk != pcls &amp;&amp; pclsWalk-&gt;hbrBackground == pcls-&gt;hbrBackground)
01169             <span class="keywordflow">return</span>;
01170 
01171         pclsWalk = pclsWalk-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
01172     }
01173 
01174     <span class="comment">/*</span>
01175 <span class="comment">     * Finaly walk the system class list</span>
01176 <span class="comment">     */</span>
01177     pclsWalk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a154">gpclsList</a>;
01178 
01179     <span class="keywordflow">while</span> (pclsWalk) {
01180         <span class="keywordflow">if</span> (pclsWalk != pcls &amp;&amp; pclsWalk-&gt;hbrBackground == pcls-&gt;hbrBackground)
01181             <span class="keywordflow">return</span>;
01182 
01183         pclsWalk = pclsWalk-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
01184     }
01185 
01186     bRet = GreDeleteObject(pcls-&gt;hbrBackground);
01187 
01188 <span class="preprocessor">#if DBG</span>
01189 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!bRet)
01190         RIPERR1(ERROR_INVALID_HANDLE, RIP_WARNING,
01191             <span class="stringliteral">"DestroyClassBrush: failed to destroy brush %#p"</span>, pcls-&gt;hbrBackground);
01192 <span class="preprocessor">#endif</span>
01193 <span class="preprocessor"></span>}
01194 
01195 <span class="comment">/***************************************************************************\</span>
01196 <span class="comment">* DestroyClass</span>
01197 <span class="comment">*</span>
01198 <span class="comment">* Delete the window class.  First, destroy any DCs that are attached to the</span>
01199 <span class="comment">* class.  Then delete classname atom.  Then free the other stuff that was</span>
01200 <span class="comment">* allocated when the class was registered and unlink the class from the</span>
01201 <span class="comment">* master class list.</span>
01202 <span class="comment">*</span>
01203 <span class="comment">* History:</span>
01204 <span class="comment">* 10-16-90 darrinm      Ported this puppy.</span>
01205 <span class="comment">\***************************************************************************/</span>
01206 
<a name="l01207"></a><a class="code" href="../../d4/d1/userk_8h.html#a1551">01207</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(
01208     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls)
01209 {
01210     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppclsClone;
01211     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
01212     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> rpdesk;
01213 
01214     pcls = *ppcls;
01215 
01216     UserAssert(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a> == 0);
01217 
01218     <span class="comment">/*</span>
01219 <span class="comment">     * If this is a base class, destroy all clones before deleting</span>
01220 <span class="comment">     * stuff.</span>
01221 <span class="comment">     */</span>
01222     <span class="keywordflow">if</span> (pcls == pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>) {
01223         ppclsClone = &amp;pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
01224         <span class="keywordflow">while</span> (*ppclsClone != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01225             <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppclsClone);
01226         }
01227 
01228         <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a>);
01229 
01230         <span class="comment">/*</span>
01231 <span class="comment">         * No freeing if it's an integer resource.</span>
01232 <span class="comment">         */</span>
01233         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pcls-&gt;lpszMenuName)) {
01234             UserFreePool(pcls-&gt;lpszMenuName);
01235         }
01236 
01237         <span class="comment">/*</span>
01238 <span class="comment">         * Free up the class dc if there is one.</span>
01239 <span class="comment">         */</span>
01240         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o4">pdce</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01241             <a class="code" href="../../d4/d1/userk_8h.html#a1700">DestroyCacheDC</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o4">pdce</a>-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>);
01242 
01243         <span class="comment">/*</span>
01244 <span class="comment">         * Delete the hBrBackground brush if nobody else is</span>
01245 <span class="comment">         * using it.</span>
01246 <span class="comment">         */</span>
01247         <a class="code" href="../../d2/d7/class_8c.html#a16">DestroyClassBrush</a>(pcls);
01248     }
01249 
01250     <span class="comment">/*</span>
01251 <span class="comment">     * If we created the small icon delete it</span>
01252 <span class="comment">     */</span>
01253     <a class="code" href="../../d4/d1/userk_8h.html#a1450">DestroyClassSmIcon</a>(pcls);
01254 
01255     <span class="comment">/*</span>
01256 <span class="comment">     * Unlock cursor and icon</span>
01257 <span class="comment">     */</span>
01258     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pcls-&gt;spicn);
01259     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pcls-&gt;spicnSm);
01260     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pcls-&gt;spcur);
01261 
01262     <span class="comment">/*</span>
01263 <span class="comment">     * Free any CallProcData objects associated with this class</span>
01264 <span class="comment">     */</span>
01265     <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o10">spcpdFirst</a>) {
01266         <a class="code" href="../../d2/d7/class_8c.html#a15">UnlockAndFreeCPDs</a>(&amp;pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o10">spcpdFirst</a>);
01267     }
01268 
01269     <span class="comment">/*</span>
01270 <span class="comment">     * Point the previous guy at the guy we currently point to.</span>
01271 <span class="comment">     */</span>
01272     *ppcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
01273 
01274     <span class="comment">/*</span>
01275 <span class="comment">     * Lock the desktop.  Do not use a thread lock because</span>
01276 <span class="comment">     * this may be called during process cleanup when thread</span>
01277 <span class="comment">     * locks are no longer usable.</span>
01278 <span class="comment">     */</span>
01279     rpdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01280     <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;rpdesk, pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a>, LDL_FN_DESTROYCLASS, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01281     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a>, LDU_CLS_DESKPARENT2, (ULONG_PTR)pcls);
01282     <a class="code" href="../../d2/d7/class_8c.html#a5">ClassFree</a>(rpdesk, pcls-&gt;lpszAnsiClassName);
01283     <a class="code" href="../../d2/d7/class_8c.html#a5">ClassFree</a>(rpdesk, pcls);
01284     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;rpdesk, LDU_FN_DESTROYCLASS, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
01285 }
01286 
01287 <span class="comment">/***************************************************************************\</span>
01288 <span class="comment">* GetClassIcoCur</span>
01289 <span class="comment">*</span>
01290 <span class="comment">* Returns the pwnd's class icon/cursor. This is called by _GetClassData</span>
01291 <span class="comment">*  from the client side because PCURSORs are allocated from POOL (so the</span>
01292 <span class="comment">*  client cannot do PtoH on them). NtUserCallHwndParam does the PtoH translation</span>
01293 <span class="comment">*</span>
01294 <span class="comment">* History:</span>
01295 <span class="comment">* 11-19-90 darrinm      Wrote.</span>
01296 <span class="comment">\***************************************************************************/</span>
<a name="l01297"></a><a class="code" href="../../d4/d1/userk_8h.html#a1570">01297</a> <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> <a class="code" href="../../d4/d1/userk_8h.html#a1570">GetClassIcoCur</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> index)
01298 {
01299     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>;
01300     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
01301 
01302     <span class="keywordflow">switch</span> (index) {
01303         <span class="keywordflow">case</span> GCLP_HICON:
01304             pcur = pcls-&gt;spicn;
01305             <span class="keywordflow">break</span>;
01306 
01307         <span class="keywordflow">case</span> GCLP_HCURSOR:
01308             pcur = pcls-&gt;spcur;
01309             <span class="keywordflow">break</span>;
01310 
01311         <span class="keywordflow">case</span> GCLP_HICONSM:
01312             pcur = pcls-&gt;spicnSm;
01313             <span class="keywordflow">break</span>;
01314 
01315         <span class="keywordflow">default</span>:
01316             RIPMSG2(RIP_WARNING, <span class="stringliteral">"GetWndIcoCur: Invalid index:%#lx. pwnd:%#p"</span>,
01317                     index, pwnd);
01318             pcur = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01319     }
01320 
01321     <span class="keywordflow">return</span> pcur;
01322 }
01323 
01324 <span class="comment">/***************************************************************************\</span>
01325 <span class="comment">* SetClassCursor</span>
01326 <span class="comment">*</span>
01327 <span class="comment">* History:</span>
01328 <span class="comment">\***************************************************************************/</span>
<a name="l01329"></a><a class="code" href="../../d4/d1/userk_8h.html#a1573">01329</a> ULONG_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1573">SetClassCursor</a>(
01330     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
01331     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>  pcls,
01332     DWORD index,
01333     ULONG_PTR dwData)
01334 {
01335     ULONG_PTR dwOld;
01336 
01337     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01338 
01339     <span class="keywordflow">if</span> ((HANDLE)dwData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01340         dwData = (ULONG_PTR)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>((HANDLE)dwData, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>);
01341         <span class="keywordflow">if</span> ((PVOID)dwData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01342             <span class="keywordflow">if</span> (index == GCLP_HICON || index == GCLP_HICONSM) {
01343                 RIPERR0(ERROR_INVALID_ICON_HANDLE, RIP_WARNING, <span class="stringliteral">"SetClassData: invalid icon"</span>);
01344             } <span class="keywordflow">else</span> {
01345                 RIPERR0(ERROR_INVALID_CURSOR_HANDLE, RIP_WARNING, <span class="stringliteral">"SetClassData: invalid cursor"</span>);
01346             }
01347         }
01348     }
01349 
01350     <span class="comment">/*</span>
01351 <span class="comment">     * Handle the locking issue.</span>
01352 <span class="comment">     */</span>
01353     pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>;
01354     <span class="keywordflow">switch</span> (index) {
01355     <span class="keywordflow">case</span> GCLP_HICON:
01356     <span class="keywordflow">case</span> GCLP_HICONSM:
01357         dwOld = (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a1571">xxxSetClassIcon</a>(pwnd, pcls, (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)dwData, index);
01358         <span class="keywordflow">break</span>;
01359 
01360     <span class="keywordflow">case</span> GCLP_HCURSOR:
01361         dwOld = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pcls-&gt;spcur, dwData);
01362         <span class="keywordflow">break</span>;
01363     }
01364 
01365     <span class="comment">/*</span>
01366 <span class="comment">     * Now set it for each clone class.</span>
01367 <span class="comment">     */</span>
01368     pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
01369     <span class="keywordflow">while</span> (pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01370         <span class="keywordflow">switch</span>(index) {
01371         <span class="keywordflow">case</span> GCLP_HICON:
01372         <span class="keywordflow">case</span> GCLP_HICONSM:
01373             <a class="code" href="../../d4/d1/userk_8h.html#a1571">xxxSetClassIcon</a>(pwnd, pcls, (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)dwData, index);
01374             <span class="keywordflow">break</span>;
01375 
01376         <span class="keywordflow">case</span> GCLP_HCURSOR:
01377             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pcls-&gt;spcur, dwData);
01378             <span class="keywordflow">break</span>;
01379         }
01380         pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
01381     }
01382 
01383     <span class="keywordflow">return</span> (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>((PVOID)dwOld);
01384 }
01385 
01386 <span class="comment">/***************************************************************************\</span>
01387 <span class="comment">* SetClassData</span>
01388 <span class="comment">*</span>
01389 <span class="comment">* SetClassWord and SetClassLong are now identical routines because they both</span>
01390 <span class="comment">* can return DWORDs.  This single routine performs the work for them both</span>
01391 <span class="comment">* by using two arrays; afClassDWord to determine whether the result should be</span>
01392 <span class="comment">* a WORD or a DWORD, and aiClassOffset to find the correct offset into the</span>
01393 <span class="comment">* CLS structure for a given GCL_ or GCL_ index.</span>
01394 <span class="comment">*</span>
01395 <span class="comment">* History:</span>
01396 <span class="comment">* 11-19-90 darrinm      Wrote.</span>
01397 <span class="comment">\***************************************************************************/</span>
01398 
<a name="l01399"></a><a class="code" href="../../d4/d1/userk_8h.html#a1572">01399</a> ULONG_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1572">xxxSetClassData</a>(
01400     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01401     <span class="keywordtype">int</span> index,
01402     ULONG_PTR dwData,
01403     BOOL bAnsi)
01404 {
01405     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>;
01406     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *pb;
01407     ULONG_PTR dwT;
01408     ULONG_PTR dwOld;
01409     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCPDType = 0;
01410     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">PCLSMENUNAME</a> pcmn;
01411     UNICODE_STRING strMenuName, UString;
01412 
01413     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01414 
01415     <span class="keywordflow">switch</span>(index) {
01416     <span class="keywordflow">case</span> GCLP_WNDPROC:
01417 
01418         <span class="comment">/*</span>
01419 <span class="comment">         * If the application (client) subclasses a class that has a server -</span>
01420 <span class="comment">         * side window proc we must return a client side proc stub that it</span>
01421 <span class="comment">         * can call.</span>
01422 <span class="comment">         */</span>
01423         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>) {
01424             dwOld = <a class="code" href="../../d2/d5/ntuser_2rtl_2getset_8c.html#a0">MapServerToClientPfn</a>((ULONG_PTR)pcls-&gt;lpfnWndProc, bAnsi);
01425             pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>;
01426 
01427             UserAssert(!(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>));
01428             <span class="keywordflow">if</span> (bAnsi) {
01429                 pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>;
01430             }
01431         } <span class="keywordflow">else</span> {
01432             dwOld = <a class="code" href="../../d2/d5/ntuser_2rtl_2getset_8c.html#a1">MapClientNeuterToClientPfn</a>(pcls, 0, bAnsi);
01433 
01434             <span class="comment">/*</span>
01435 <span class="comment">             * If the client mapping didn't change the window proc then see if</span>
01436 <span class="comment">             * we need a callproc handle.</span>
01437 <span class="comment">             */</span>
01438             <span class="keywordflow">if</span> (dwOld == (ULONG_PTR)pcls-&gt;lpfnWndProc) {
01439                 <span class="comment">/*</span>
01440 <span class="comment">                 * Need to return a CallProc handle if there is an Ansi/Unicode mismatch</span>
01441 <span class="comment">                 */</span>
01442                 <span class="keywordflow">if</span> (bAnsi != !!(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>)) {
01443                     dwCPDType |= bAnsi ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a459">CPD_ANSI_TO_UNICODE</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>;
01444                 }
01445             }
01446         }
01447 
01448         <span class="keywordflow">if</span> (dwCPDType) {
01449             ULONG_PTR dwCPD;
01450 
01451             dwCPD = <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a7">GetCPD</a>(pcls, dwCPDType | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a462">CPD_CLASS</a>, dwOld);
01452 
01453             <span class="keywordflow">if</span> (dwCPD) {
01454                 dwOld = dwCPD;
01455             } <span class="keywordflow">else</span> {
01456                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetClassLong unable to alloc CPD returning handle\n"</span>);
01457             }
01458         }
01459 
01460         <span class="comment">/*</span>
01461 <span class="comment">         * Convert a possible CallProc Handle into a real address.  They may</span>
01462 <span class="comment">         * have kept the CallProc Handle from some previous mixed GetClassinfo</span>
01463 <span class="comment">         * or SetWindowLong.</span>
01464 <span class="comment">         */</span>
01465         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a468">ISCPDTAG</a>(dwData)) {
01466             <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD;
01467             <span class="keywordflow">if</span>  (pCPD = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HANDLE)dwData, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>)) {
01468                 dwData = pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o2">pfnClientPrevious</a>;
01469             }
01470         }
01471 
01472         <span class="comment">/*</span>
01473 <span class="comment">         * If an app 'unsubclasses' a server-side window proc we need to</span>
01474 <span class="comment">         * restore everything so SendMessage and friends know that it's</span>
01475 <span class="comment">         * a server-side proc again.  Need to check against client side</span>
01476 <span class="comment">         * stub addresses.</span>
01477 <span class="comment">         */</span>
01478         pcls-&gt;lpfnWndProc = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)dwData;
01479         <span class="keywordflow">if</span> ((dwT = <a class="code" href="../../d4/d1/userk_8h.html#a1155">MapClientToServerPfn</a>(dwData)) != 0) {
01480             pcls-&gt;lpfnWndProc = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)dwT;
01481             pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>;
01482             pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>;
01483         } <span class="keywordflow">else</span> {
01484             <span class="keywordflow">if</span> (bAnsi) {
01485                 pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>;
01486             } <span class="keywordflow">else</span> {
01487                 pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>;
01488             }
01489         }
01490         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a496">CSF_WOWCLASS</a>) {
01491             PWC pwc = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a491">PWCFromPCLS</a>(pcls);
01492             pwc-&gt;hMod16 = (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a>) ? 0:<a class="code" href="../../d4/d1/userk_8h.html#a1281">xxxClientWOWGetProcModule</a>(pcls-&gt;lpfnWndProc);
01493         }
01494 
01495         <span class="keywordflow">return</span> dwOld;
01496         <span class="keywordflow">break</span>;
01497 
01498     <span class="keywordflow">case</span> GCLP_HICON:
01499     <span class="keywordflow">case</span> GCLP_HICONSM:
01500     <span class="keywordflow">case</span> GCLP_HCURSOR:
01501         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1573">SetClassCursor</a>(pwnd, pcls, index, dwData);
01502         <span class="keywordflow">break</span>;
01503 
01504 
01505     <span class="keywordflow">case</span> GCL_WOWMENUNAME:
01506         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a496">CSF_WOWCLASS</a>) {
01507             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a491">PWCFromPCLS</a>(pcls)-&gt;vpszMenu = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)dwData;
01508         } <span class="keywordflow">else</span> {
01509             UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01510         }
01511         <span class="keywordflow">break</span>;
01512 
01513     <span class="keywordflow">case</span> GCL_CBCLSEXTRA:
01514         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a496">CSF_WOWCLASS</a>) {
01515         <span class="comment">/*</span>
01516 <span class="comment">         * yes -- we can do this for WOW classes only.</span>
01517 <span class="comment">         */</span>
01518             <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a497">CSF_WOWEXTRA</a>) {
01519                 dwOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a491">PWCFromPCLS</a>(pcls)-&gt;iClsExtra;
01520                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a491">PWCFromPCLS</a>(pcls)-&gt;iClsExtra = LOWORD(dwData);
01521                 <span class="keywordflow">return</span> dwOld;
01522             } <span class="keywordflow">else</span> {
01523                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a491">PWCFromPCLS</a>(pcls)-&gt;iClsExtra = LOWORD(dwData);
01524                 pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a497">CSF_WOWEXTRA</a>;
01525                 <span class="keywordflow">return</span> pcls-&gt;cbclsExtra;
01526             }
01527         }
01528         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Attempt to change cbClsExtra\n"</span>);
01529         <span class="keywordflow">break</span>;
01530 
01531     <span class="keywordflow">case</span> GCLP_MENUNAME:
01532         pcmn = (<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">PCLSMENUNAME</a>) dwData;
01533 
01534         <span class="comment">/*</span>
01535 <span class="comment">         * pcmn-&gt;pusMenuName-&gt;Buffer is a client-side address.</span>
01536 <span class="comment">         */</span>
01537 
01538         dwOld = (ULONG_PTR) pcls-&gt;lpszMenuName;
01539         <span class="comment">/* Is it a string? */</span>
01540         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a>-&gt;Buffer)) {
01541             <span class="keywordflow">try</span> {
01542                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UString, pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a>-&gt;Buffer);
01543             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
01544                 <span class="keywordflow">break</span>;
01545             }
01546             <span class="comment">/* Empty String? */</span>
01547             <span class="keywordflow">if</span> (UString.Length == 0) {
01548                 pcls-&gt;lpszMenuName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01549             } <span class="keywordflow">else</span> {
01550                 <span class="comment">/* Make a copy of the string */</span>
01551                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1533">AllocateUnicodeString</a>(&amp;strMenuName, &amp;UString)) {
01552                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxSetClassData: GCL_MENUNAME AllocateUnicodeString failed\n"</span>);
01553                     <span class="keywordflow">break</span>;
01554                 }
01555 
01556                 pcls-&gt;lpszMenuName = strMenuName.Buffer;
01557             }
01558         } <span class="keywordflow">else</span> {
01559             <span class="comment">/* Just copy the id */</span>
01560             pcls-&gt;lpszMenuName = pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a>-&gt;Buffer;
01561         }
01562         <span class="comment">/* Don't return the kernel side pointer */</span>
01563         pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01564 
01565         <span class="comment">/* Free old string, if any */</span>
01566         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(dwOld)) {
01567             UserFreePool((PVOID)dwOld);
01568         }
01569 
01570         <span class="comment">/* Return client side pointers */</span>
01571         dwOld = (ULONG_PTR) pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o8">lpszClientAnsiMenuName</a>;
01572         pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o8">lpszClientAnsiMenuName</a> = pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>;
01573         pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a> = (LPSTR)dwOld;
01574 
01575         dwOld = (ULONG_PTR) pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o9">lpszClientUnicodeMenuName</a>;
01576         pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o9">lpszClientUnicodeMenuName</a> = pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>;
01577         pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a> = (LPWSTR)dwOld;
01578 
01579         <span class="keywordflow">return</span> (bAnsi ? (ULONG_PTR) pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a> : (ULONG_PTR) pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>);
01580 
01581     <span class="keywordflow">default</span>:
01582         <span class="comment">/*</span>
01583 <span class="comment">         * All other indexes go here...</span>
01584 <span class="comment">         */</span>
01585         index -= <a class="code" href="../../d5/d7/classc_8c.html#a0">INDEX_OFFSET</a>;
01586 
01587         <span class="comment">/*</span>
01588 <span class="comment">         * Only let valid indices go through; if aiClassOffset is zero</span>
01589 <span class="comment">         * then we have no mapping for this negative index so it must</span>
01590 <span class="comment">         * be a bogus index</span>
01591 <span class="comment">         */</span>
01592         <span class="keywordflow">if</span> ((index &lt; 0) || (<a class="code" href="../../d5/d7/classc_8c.html#a2">aiClassOffset</a>[index] == 0)) {
01593             RIPERR0(ERROR_INVALID_INDEX, RIP_WARNING, <span class="stringliteral">"GetClassLong: invalid index"</span>);
01594             <span class="keywordflow">return</span> 0;
01595         }
01596 
01597         pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>;
01598         pb = ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)pcls) + <a class="code" href="../../d5/d7/classc_8c.html#a2">aiClassOffset</a>[index];
01599 
01600         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7/classc_8c.html#a1">afClassDWord</a>[index] == <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
01601             dwOld = *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)pb;
01602             *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)pb = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)dwData;
01603         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7/classc_8c.html#a1">afClassDWord</a>[index] == <span class="keyword">sizeof</span>(ULONG_PTR)) {
01604             dwOld = *(ULONG_PTR *)pb;
01605             *(ULONG_PTR *)pb = dwData;
01606         } <span class="keywordflow">else</span> {
01607             dwOld = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*(WORD *)pb;
01608             *(WORD *)pb = (WORD)dwData;
01609         }
01610 
01611         pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
01612         <span class="keywordflow">while</span> (pcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01613             pb = ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)pcls) + <a class="code" href="../../d5/d7/classc_8c.html#a2">aiClassOffset</a>[index];
01614 
01615             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7/classc_8c.html#a1">afClassDWord</a>[index] == <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
01616                 dwOld = *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)pb;
01617                 *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)pb = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)dwData;
01618             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7/classc_8c.html#a1">afClassDWord</a>[index] == <span class="keyword">sizeof</span>(ULONG_PTR)) {
01619                 dwOld = *(ULONG_PTR *)pb;
01620                 *(ULONG_PTR *)pb = dwData;
01621             } <span class="keywordflow">else</span> {
01622                 dwOld = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*(WORD *)pb;
01623                 *(WORD *)pb = (WORD)dwData;
01624             }
01625             pcls = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
01626         }
01627 
01628         <span class="keywordflow">return</span> dwOld;
01629     }
01630 
01631     <span class="keywordflow">return</span> 0;
01632 }
01633 
01634 
01635 <span class="comment">/***************************************************************************\</span>
01636 <span class="comment">* ReferenceClass</span>
01637 <span class="comment">*</span>
01638 <span class="comment">* Clones the class if it is a different desktop than the new window and</span>
01639 <span class="comment">* increments the class window count(s).</span>
01640 <span class="comment">*</span>
01641 <span class="comment">* History:</span>
01642 <span class="comment">* 12-11-93 JimA         Created.</span>
01643 <span class="comment">\***************************************************************************/</span>
01644 
<a name="l01645"></a><a class="code" href="../../d4/d1/userk_8h.html#a1153">01645</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1153">ReferenceClass</a>(
01646     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls,
01647     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01648 {
01649     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbName;
01650     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pclsClone;
01651     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
01652 
01653     <span class="comment">/*</span>
01654 <span class="comment">     * If the window is on the same desktop as the base class, just</span>
01655 <span class="comment">     * increment the window count.</span>
01656 <span class="comment">     */</span>
01657     <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a> == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk) {
01658         pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a>++;
01659         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01660     }
01661 
01662     <span class="comment">/*</span>
01663 <span class="comment">     * The window is not on the base desktop.  Try to find a cloned</span>
01664 <span class="comment">     * class.</span>
01665 <span class="comment">     */</span>
01666     <span class="keywordflow">for</span> (pclsClone = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>; pclsClone != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01667             pclsClone = pclsClone-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>) {
01668         <span class="keywordflow">if</span> (pclsClone-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a> == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk)
01669             <span class="keywordflow">break</span>;
01670     }
01671 
01672     <span class="comment">/*</span>
01673 <span class="comment">     * If we can't find one, clone the base class.</span>
01674 <span class="comment">     */</span>
01675     <span class="keywordflow">if</span> (pclsClone == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01676         pdesk = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk;
01677         pclsClone = <a class="code" href="../../d2/d7/class_8c.html#a4">ClassAlloc</a>(pdesk, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d0/structtagCLS.html">CLS</a>) + pcls-&gt;cbclsExtra + (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a496">CSF_WOWCLASS</a> ?<span class="keyword">sizeof</span>(WC):0));
01678         <span class="keywordflow">if</span> (pclsClone == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01679             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ReferenceClass: Failed Clone-Class Allocation\n"</span>);
01680             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01681         }
01682 
01683         RtlCopyMemory(pclsClone, pcls, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1037">CLS</a>) + pcls-&gt;cbclsExtra + (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a496">CSF_WOWCLASS</a>?<span class="keyword">sizeof</span>(WC):0));
01684         cbName = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(pcls-&gt;lpszAnsiClassName) + 1;
01685         pclsClone-&gt;lpszAnsiClassName = <a class="code" href="../../d2/d7/class_8c.html#a4">ClassAlloc</a>(pdesk, cbName);
01686         <span class="keywordflow">if</span> (pclsClone-&gt;lpszAnsiClassName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01687             <a class="code" href="../../d2/d7/class_8c.html#a5">ClassFree</a>(pdesk, pclsClone);
01688             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ReferenceClass: No Clone Class Name\n"</span>);
01689             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01690         }
01691 
01692         <span class="comment">/*</span>
01693 <span class="comment">         * Everything has been allocated, now lock everything down.</span>
01694 <span class="comment">         * NULL pointers in clone to prevent Lock() from incorrectly</span>
01695 <span class="comment">         * decrementing object reference count</span>
01696 <span class="comment">         */</span>
01697         pclsClone-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01698         <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pclsClone-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o3">rpdeskParent</a>, pdesk,
01699                     LDL_CLS_DESKPARENT2, (ULONG_PTR)pclsClone);
01700         pclsClone-&gt;pclsNext = pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
01701         pclsClone-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01702         pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a> = pclsClone;
01703         RtlCopyMemory(pclsClone-&gt;lpszAnsiClassName, pcls-&gt;lpszAnsiClassName, cbName);
01704 
01705         pclsClone-&gt;spicn = pclsClone-&gt;spicnSm = pclsClone-&gt;spcur = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01706 
01707         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pclsClone-&gt;spicn, pcls-&gt;spicn);
01708         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pclsClone-&gt;spicnSm, pcls-&gt;spicnSm);
01709         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pclsClone-&gt;spcur, pcls-&gt;spcur);
01710         pclsClone-&gt;spcpdFirst =  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01711         pclsClone-&gt;cWndReferenceCount = 0;
01712     }
01713 
01714     <span class="comment">/*</span>
01715 <span class="comment">     * Increment reference counts.</span>
01716 <span class="comment">     */</span>
01717     pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a>++;
01718     pclsClone-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a>++;
01719     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a> = pclsClone;
01720 
01721     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01722 }
01723 
01724 
01725 <span class="comment">/***************************************************************************\</span>
01726 <span class="comment">* DereferenceClass</span>
01727 <span class="comment">*</span>
01728 <span class="comment">* Decrements the class window count in the base class.  If it's the</span>
01729 <span class="comment">* last window of a clone class, destroy the clone.</span>
01730 <span class="comment">*</span>
01731 <span class="comment">* History:</span>
01732 <span class="comment">* 12-11-93 JimA         Created.</span>
01733 <span class="comment">\***************************************************************************/</span>
01734 
<a name="l01735"></a><a class="code" href="../../d4/d1/userk_8h.html#a1154">01735</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1154">DereferenceClass</a>(
01736     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01737 {
01738     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>;
01739     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls;
01740 
01741     UserAssert(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a> &gt;= 1);
01742 
01743     pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a>--;
01744     <span class="keywordflow">if</span> (pcls != pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>) {
01745 
01746         UserAssert(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a> &gt;= 1);
01747 
01748         pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a>--;
01749 
01750         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a> == 0) {
01751             ppcls = &amp;pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o11">pclsBase</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o12">pclsClone</a>;
01752             <span class="keywordflow">while</span> ((*ppcls) != pcls)
01753                 ppcls = &amp;(*ppcls)-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o0">pclsNext</a>;
01754             UserAssert(ppcls);
01755             <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppcls);
01756         }
01757     }
01758 }
01759 
01760 
01761 <span class="comment">/***************************************************************************\</span>
01762 <span class="comment">* DestroyProcessesClasses</span>
01763 <span class="comment">*</span>
01764 <span class="comment">* History:</span>
01765 <span class="comment">* 04-07-91 DarrinM      Created.</span>
01766 <span class="comment">\***************************************************************************/</span>
01767 
<a name="l01768"></a><a class="code" href="../../d4/d1/userk_8h.html#a1554">01768</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1554">DestroyProcessesClasses</a>(
01769     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)
01770 {
01771     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls;
01772 
01773     <span class="comment">/*</span>
01774 <span class="comment">     * Destroy the private classes first</span>
01775 <span class="comment">     */</span>
01776     ppcls = &amp;(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o4">pclsPrivateList</a>);
01777     <span class="keywordflow">while</span> (*ppcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01778         <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppcls);
01779     }
01780 
01781     <span class="comment">/*</span>
01782 <span class="comment">     * Then the cloned public classes</span>
01783 <span class="comment">     */</span>
01784     ppcls = &amp;(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o5">pclsPublicList</a>);
01785     <span class="keywordflow">while</span> (*ppcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01786         <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppcls);
01787     }
01788 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
