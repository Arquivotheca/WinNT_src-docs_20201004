<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: devctrl.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>devctrl.c</h1><a href="../../d2/d7/udfs_2devctrl_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    DevCtrl.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the File System Device Control routines for Udfs</span>
00012 <span class="comment">    called by the dispatch driver.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    {DanLo]     28-Jan-1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_DEVCTRL)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_DEVCTRL)</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  Local support routines</span>
00038 <span class="comment">//</span>
00039 
00040 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00041 <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a2">UdfDvdReadStructure</a> (
00042     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00043     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00044     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb
00045     );
00046 
00047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00048 <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a3">UdfDvdTransferKey</a> (
00049     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00050     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00051     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb
00052     );
00053 
00054 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00055 <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a4">UdfDevCtrlCompletionRoutine</a> (
00056     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00057     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00058     IN PVOID Contxt
00059     );
00060 
00061 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonDevControl)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfDvdReadStructure)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfDvdTransferKey)</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00066 <span class="preprocessor"></span>
00067 
00068 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00069"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a254">00069</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a254">UdfCommonDevControl</a> (
00070     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00071     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00072     )
00073 
00074 <span class="comment">/*++</span>
00075 <span class="comment"></span>
00076 <span class="comment">Routine Description:</span>
00077 <span class="comment"></span>
00078 <span class="comment">    This is the common routine for doing Device control operations called</span>
00079 <span class="comment">    by both the fsd and fsp threads</span>
00080 <span class="comment"></span>
00081 <span class="comment">Arguments:</span>
00082 <span class="comment"></span>
00083 <span class="comment">    Irp - Supplies the Irp to process</span>
00084 <span class="comment"></span>
00085 <span class="comment">Return Value:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    NTSTATUS - The return status for the operation</span>
00088 <span class="comment"></span>
00089 <span class="comment">--*/</span>
00090 
00091 {
00092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00093 
00094     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00095     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00096     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00097 
00098     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00099 
00100     PVOID TargetBuffer;
00101 
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">//  Extract and decode the file object.</span>
00106     <span class="comment">//</span>
00107 
00108     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00109 
00110     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00111                                       &amp;Fcb,
00112                                       &amp;Ccb );
00113 
00114     <span class="comment">//</span>
00115     <span class="comment">//  A few IOCTLs actually require some intervention on our part to</span>
00116     <span class="comment">//  translate some information from file-based to device-based units.</span>
00117     <span class="comment">//</span>
00118 
00119     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00120 
00121         <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode) {
00122             <span class="keywordflow">case</span> IOCTL_DVD_READ_KEY:
00123             <span class="keywordflow">case</span> IOCTL_DVD_SEND_KEY:
00124 
00125                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a3">UdfDvdTransferKey</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, Fcb );
00126                 <span class="keywordflow">break</span>;
00127 
00128             <span class="keywordflow">case</span> IOCTL_DVD_READ_STRUCTURE:
00129 
00130                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a2">UdfDvdReadStructure</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, Fcb );
00131                 <span class="keywordflow">break</span>;
00132 
00133             <span class="keywordflow">case</span> IOCTL_STORAGE_SET_READ_AHEAD:
00134 
00135                 <span class="comment">//</span>
00136                 <span class="comment">//  We're just going to no-op this for now.</span>
00137                 <span class="comment">//</span>
00138                 
00139                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00140                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00141                 <span class="keywordflow">break</span>;
00142 
00143             <span class="keywordflow">default</span>:
00144 
00145                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00146                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00147                 <span class="keywordflow">break</span>;
00148         }
00149 
00150         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00151     }
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">//  Now the only type of opens we accept are user volume opens.</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00158 
00159         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_PARAMETER );
00160         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00161     }
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">//  Handle the case of the disk type ourselves.  We're really just going to</span>
00165     <span class="comment">//  lie about this, but it is a good lie.</span>
00166     <span class="comment">//</span>
00167 
00168     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode == IOCTL_CDROM_DISK_TYPE) {
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">//  Verify the Vcb in this case to detect if the volume has changed.</span>
00172         <span class="comment">//</span>
00173 
00174         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> );
00175 
00176         <span class="comment">//</span>
00177         <span class="comment">//  Check the size of the output buffer.</span>
00178         <span class="comment">//</span>
00179 
00180         <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.OutputBufferLength &lt; <span class="keyword">sizeof</span>( CDROM_DISK_DATA )) {
00181 
00182             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_BUFFER_TOO_SMALL );
00183             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00184         }
00185 
00186         <span class="comment">//</span>
00187         <span class="comment">//  Copy the data from the Vcb.</span>
00188         <span class="comment">//</span>
00189 
00190         ((PCDROM_DISK_DATA) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer)-&gt;DiskData = CDROM_DISK_DATA_TRACK;
00191 
00192         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <span class="keyword">sizeof</span>( CDROM_DISK_DATA );
00193         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00194         <span class="keywordflow">return</span> STATUS_SUCCESS;
00195     }
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">//  Copy the arguments and set up the completion routine</span>
00199     <span class="comment">//</span>
00200 
00201     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00202     
00203     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00204                             <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a4">UdfDevCtrlCompletionRoutine</a>,
00205                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00206                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00207                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00208                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">//  Send the request.</span>
00212     <span class="comment">//</span>
00213 
00214     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STATUS_SUCCESS );
00221 
00222     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00223 }
00224 
00225 
00226 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00227"></a><a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a3">00227</a> <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a3">UdfDvdTransferKey</a> (
00228     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00229     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00230     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb
00231     )
00232 
00233 <span class="comment">/*++</span>
00234 <span class="comment"></span>
00235 <span class="comment">Routine Description:</span>
00236 <span class="comment"></span>
00237 <span class="comment">    This routine handles the special form of the Dvd key negotiation IOCTLs</span>
00238 <span class="comment">    performed in the context of a file.  For these IOCTLs, the incoming parameter</span>
00239 <span class="comment">    is in file-relative form, which must be translated to a device-relatvie form</span>
00240 <span class="comment">    before it can continue.</span>
00241 <span class="comment"></span>
00242 <span class="comment">Arguments:</span>
00243 <span class="comment"></span>
00244 <span class="comment">    Irp - Supplies the Irp to process</span>
00245 <span class="comment">    </span>
00246 <span class="comment">    Fcb - Supplies the file being operated with</span>
00247 <span class="comment"></span>
00248 <span class="comment">Return Value:</span>
00249 <span class="comment"></span>
00250 <span class="comment">    NTSTATUS - The return status for the operation</span>
00251 <span class="comment"></span>
00252 <span class="comment">--*/</span>
00253 
00254 {
00255     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00256     PDVD_COPY_PROTECT_KEY TransferKey;
00257 
00258     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00259     BOOLEAN Result;
00260 
00261     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  Grab the input buffer and confirm basic validity.</span>
00265     <span class="comment">//</span>
00266     
00267     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00268     TransferKey = (PDVD_COPY_PROTECT_KEY) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00269 
00270     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.InputBufferLength &lt; <span class="keyword">sizeof</span>(DVD_COPY_PROTECT_KEY) ||
00271         TransferKey-&gt;Parameters.TitleOffset.QuadPart &gt; Fcb-&gt;FileSize.QuadPart) {
00272 
00273         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00274         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">//  Now, convert the file byte offset in the structure to a physical sector.</span>
00279     <span class="comment">//</span>
00280 
00281     Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( &amp;Fcb-&gt;Mcb,
00282                                        <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( Fcb-&gt;Vcb, TransferKey-&gt;Parameters.TitleOffset.QuadPart ),
00283                                        &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart,
00284                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00285                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00286                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00287                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">//  If we failed the lookup, we know that this must be some form of unrecorded</span>
00291     <span class="comment">//  extent on the media.  This IOCTL is ill-defined at this point, so we have</span>
00292     <span class="comment">//  to give up.</span>
00293     <span class="comment">//</span>
00294     
00295     <span class="keywordflow">if</span> (!Result || <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart == -1) {
00296         
00297         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00298         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00299     }
00300     
00301     <span class="comment">//</span>
00302     <span class="comment">//  The input is buffered from user space, so we know we can just rewrite it.</span>
00303     <span class="comment">//</span>
00304 
00305     TransferKey-&gt;Parameters.TitleOffset.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Fcb-&gt;Vcb, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart );
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">//  Copy the arguments and set up the completion routine</span>
00309     <span class="comment">//</span>
00310 
00311     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00312 
00313     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00314                             <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a4">UdfDevCtrlCompletionRoutine</a>,
00315                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00316                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00317                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00318                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">//  Send the request.</span>
00322     <span class="comment">//</span>
00323 
00324     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00328     <span class="comment">//</span>
00329 
00330     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STATUS_SUCCESS );
00331 
00332     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00333 }
00334 
00335 
00336 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00337"></a><a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a2">00337</a> <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a2">UdfDvdReadStructure</a> (
00338     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00339     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00340     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb
00341 
00342     )
00343 
00344 <span class="comment">/*++</span>
00345 <span class="comment"></span>
00346 <span class="comment">Routine Description:</span>
00347 <span class="comment"></span>
00348 <span class="comment">    This routine handles the special form of the Dvd structure reading IOCTLs</span>
00349 <span class="comment">    performed in the context of a file.  For these IOCTLs, the incoming parameter</span>
00350 <span class="comment">    is in file-relative form, which must be translated to a device-relatvie form</span>
00351 <span class="comment">    before it can continue.</span>
00352 <span class="comment"></span>
00353 <span class="comment">Arguments:</span>
00354 <span class="comment"></span>
00355 <span class="comment">    Irp - Supplies the Irp to process</span>
00356 <span class="comment">    </span>
00357 <span class="comment">    Fcb - Supplies the file being operated with</span>
00358 <span class="comment"></span>
00359 <span class="comment">Return Value:</span>
00360 <span class="comment"></span>
00361 <span class="comment">    NTSTATUS - The return status for the operation</span>
00362 <span class="comment"></span>
00363 <span class="comment">--*/</span>
00364 
00365 {
00366     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00367     PDVD_READ_STRUCTURE ReadStructure;
00368 
00369     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00370     BOOLEAN Result;
00371 
00372     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00373     
00374     <span class="comment">//</span>
00375     <span class="comment">//  Grab the input buffer and confirm basic validity.</span>
00376     <span class="comment">//</span>
00377     
00378     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00379     ReadStructure = (PDVD_READ_STRUCTURE) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00380 
00381     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.InputBufferLength != <span class="keyword">sizeof</span>(DVD_READ_STRUCTURE)) {
00382 
00383         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00384         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00385     }
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">//  Now, convert the file byte offset in the structure to a physical sector.</span>
00389     <span class="comment">//</span>
00390 
00391     Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( &amp;Fcb-&gt;Mcb,
00392                                        <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( Fcb-&gt;Vcb, ReadStructure-&gt;BlockByteOffset.QuadPart ),
00393                                        &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart,
00394                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00395                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00396                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00397                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  If we failed the lookup, we know that this must be some form of unrecorded</span>
00401     <span class="comment">//  extent on the media.  This IOCTL is ill-defined at this point, so we have</span>
00402     <span class="comment">//  to give up.</span>
00403     <span class="comment">//</span>
00404     
00405     <span class="keywordflow">if</span> (!Result || <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart == -1) {
00406         
00407         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00408         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00409     }
00410     
00411     <span class="comment">//</span>
00412     <span class="comment">//  The input is buffered from user space, so we know we can just rewrite it.</span>
00413     <span class="comment">//</span>
00414 
00415     ReadStructure-&gt;BlockByteOffset.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Fcb-&gt;Vcb, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart );
00416 
00417     <span class="comment">//</span>
00418     <span class="comment">//  Copy the arguments and set up the completion routine</span>
00419     <span class="comment">//</span>
00420 
00421     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00422 
00423     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00424                             <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a4">UdfDevCtrlCompletionRoutine</a>,
00425                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00426                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00427                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00428                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">//  Send the request.</span>
00432     <span class="comment">//</span>
00433 
00434     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00438     <span class="comment">//</span>
00439 
00440     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STATUS_SUCCESS );
00441 
00442     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00443 }
00444 
00445 
00446 <span class="comment">//</span>
00447 <span class="comment">//  Local support routine</span>
00448 <span class="comment">//</span>
00449 
00450 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00451"></a><a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a4">00451</a> <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a4">UdfDevCtrlCompletionRoutine</a> (
00452     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00453     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00454     IN PVOID Contxt
00455     )
00456 
00457 {
00458     <span class="comment">//</span>
00459     <span class="comment">//  Add the hack-o-ramma to fix formats.</span>
00460     <span class="comment">//</span>
00461 
00462     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a>) {
00463 
00464         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00465     }
00466 
00467     <span class="keywordflow">return</span> STATUS_SUCCESS;
00468 
00469     UNREFERENCED_PARAMETER( DeviceObject );
00470     UNREFERENCED_PARAMETER( Contxt );
00471 }
00472 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
