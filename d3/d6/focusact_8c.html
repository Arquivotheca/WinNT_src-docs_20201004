<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: focusact.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>focusact.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d4/d5/focusact_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a0">RemoveEventMessage</a> (<a class="el" href="../../d7/d4/structtagQ.html">PQ</a> pq, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwQEvent, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwQEventStop)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a1">xxxDeactivate</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> tidSetForeground)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a2">xxxSendFocusMessages</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndReceive)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a3">xxxActivateApp</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="el" href="../../d8/d7/structtagAAS.html">AAS</a> *paas)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a4">FBadWindow</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a5">xxxUpdateTray</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a6">xxxActivateThisWindow</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> tidLoseForeground, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a7">CanForceForeground</a> (<a class="el" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a8">xxxAllowSetForegroundWindow</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwProcessId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a9">_LockSetForegroundWindow</a> (UINT uLockCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a10">CleanupDecSFWLockCount</a> (PVOID pIgnore)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a11">xxxStubSetForegroundWindow</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a12">xxxSetForegroundWindow</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, BOOL fFlash)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a13">xxxSetForegroundWindow2</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a14">FRemoveForegroundActivate</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a15">FAllowForegroundActivate</a> (<a class="el" href="../../d7/d4/structtagQ.html">PQ</a> pq, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a16">xxxSetFocus</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a17">xxxSetActiveWindow</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a18">xxxActivateWindow</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT cmd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a19">GNT_NextTopScan</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a20">NTW_GetNextTop</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a21">NTW_GetPrevTop</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndCurrent)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a22">CheckTopLevelOnly</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a23">NextTopWindow</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndSkip, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a24">xxxCheckFocus</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a25">SetForegroundThread</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a26">SetForegroundPriorityProcess</a> (<a class="el" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi, <a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, BOOL fSetForeground)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/focusact_8c.html#a27">SetForegroundPriority</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, BOOL fSetForeground)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a9" doxytag="focusact.c::_LockSetForegroundWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _LockSetForegroundWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UINT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>uLockCode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01167">1167</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01056">CanForceForeground()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00201">gppiLockSFW</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00084">PpiCurrent</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01169 {
01170     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
01171     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01172 
01173     <span class="keywordflow">switch</span> (uLockCode) {
01174         <span class="keywordflow">case</span> LSFW_LOCK:
01175             <span class="comment">/*</span>
01176 <span class="comment">             * If the caller cannot lock it or already locked, fail the call</span>
01177 <span class="comment">             */</span>
01178             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1663">CanForceForeground</a>(ppiCurrent) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01179                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> = ppiCurrent;
01180                 TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"_LockSetForegroundWindow locked by %#p"</span>, ppiCurrent);
01181             } <span class="keywordflow">else</span> {
01182                 dwError = ERROR_ACCESS_DENIED;
01183                 <span class="keywordflow">goto</span> FailIt;
01184             }
01185             <span class="keywordflow">break</span>;
01186 
01187         <span class="keywordflow">case</span> LSFW_UNLOCK:
01188             <span class="comment">/*</span>
01189 <span class="comment">             * If the caller didn't lock it, fail the call</span>
01190 <span class="comment">             */</span>
01191             <span class="keywordflow">if</span> (ppiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a>) {
01192                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01193                 TAGMSG0(DBGTAG_FOREGROUND, <span class="stringliteral">"_LockSetForegroundWindow UNLOCKED"</span>);
01194             } <span class="keywordflow">else</span> {
01195                 dwError = ERROR_ACCESS_DENIED;
01196                 <span class="keywordflow">goto</span> FailIt;
01197             }
01198             <span class="keywordflow">break</span>;
01199 
01200         <span class="keywordflow">default</span>:
01201             dwError = ERROR_INVALID_PARAMETER;
01202             <span class="keywordflow">goto</span> FailIt;
01203     }
01204 
01205     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01206 
01207 FailIt:
01208     RIPERR0(dwError, RIP_VERBOSE, <span class="stringliteral">""</span>);
01209     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01210 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="focusact.c::CanForceForeground" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL CanForceForeground           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ppi</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01056">1056</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00198">glinp</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00200">gppiInputProvider</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00091">gptiForeground</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07001">IsTimeFromLastRITEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03262">tagLASTINPUT::ptiLastWoken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07066">UP</a>, and <a class="el" href="../../d9/d4/consrv_8h-source.html#l02268">W32PF_ALLOWSETFOREGROUND</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l01167">_LockSetForegroundWindow()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l00222">CheckAllowForeground()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l02400">NtUserSystemParametersInfo()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01101">xxxAllowSetForegroundWindow()</a>, <a class="el" href="../../d9/d3/w32_2ntuser_2kernel_2random_8c-source.html#l00276">xxxHardErrorControl()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00315">xxxSendBSMtoDesktop()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01235">xxxSetForegroundWindow()</a>.
<p>
<pre class="fragment"><div>01057 {
01058 
01059     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01060             &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ppi)
01061             &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01062             &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ppi)
01063             &amp;&amp; !(ppi-&gt;W32PF_Flags &amp; (W32PF_ALLOWFOREGROUNDACTIVATE | <a class="code" href="../../d8/d5/consrv_8h.html#a57">W32PF_ALLOWSETFOREGROUND</a>))
01064             &amp;&amp; (ppi != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a80">gppiInputProvider</a>)
01065             &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01066             &amp;&amp;
01067 <span class="preprocessor">        #if DBG</span>
01068 <span class="preprocessor"></span>            <span class="comment">/*</span>
01069 <span class="comment">             * When attaching the debugger to the foreground app, this function always</span>
01070 <span class="comment">             *  returns TRUE. In order to be able to debug anything related to this</span>
01071 <span class="comment">             *  function in such case, set this global to TRUE.</span>
01072 <span class="comment">             */</span>
01073                (gfDebugForegroundIgnoreDebugPort
01074                 || (
01075 <span class="preprocessor">        #endif</span>
01076 <span class="preprocessor"></span>                       (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;Process-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01077                     &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;Process-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01078 <span class="preprocessor">        #if DBG</span>
01079 <span class="preprocessor"></span>                ))
01080 <span class="preprocessor">        #endif</span>
01081 <span class="preprocessor"></span>            &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a2024">IsTimeFromLastRITEvent</a>(<a class="code" href="../../d4/d1/userk_8h.html#a743">UP</a>(FOREGROUNDLOCKTIMEOUT))) {
01082 
01083         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01084     } <span class="keywordflow">else</span> {
01085         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01086     }
01087 
01088 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="focusact.c::CheckTopLevelOnly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> CheckTopLevelOnly           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02416">2416</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00787">FNID_DESKTOP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00843">GETFNID</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l02431">NextTopWindow()</a>.
<p>
<pre class="fragment"><div>02418 {
02419     <span class="comment">/*</span>
02420 <span class="comment">     * fnid == -1 means this is a desktop window - find the first child</span>
02421 <span class="comment">     * of this desktop, if it is one.</span>
02422 <span class="comment">     */</span>
02423     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
02424         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
02425     }
02426 
02427     <span class="keywordflow">return</span> pwnd;
02428 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="focusact.c::CleanupDecSFWLockCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void CleanupDecSFWLockCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pIgnore</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01218">1218</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l07053">DecSFWLockCount()</a>.
<p>
<pre class="fragment"><div>01219 {
01220     <a class="code" href="../../d4/d1/userk_8h.html#a2028">DecSFWLockCount</a>();
01221     UNREFERENCED_PARAMETER(pIgnore);
01222 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="focusact.c::FAllowForegroundActivate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL FAllowForegroundActivate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d4/structtagQ.html">PQ</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pq</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01761">1761</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01717">FRemoveForegroundActivate()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00456">grpdeskRitInput</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07022">IsForegroundLocked()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02561">TestwndChild</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02534">WEFNOACTIVATE</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">xxxActivateWindow()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01815">xxxSetFocus()</a>.
<p>
<pre class="fragment"><div>01764 {
01765     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01766     UserAssert(pwnd != NULL);
01767     <span class="comment">/*</span>
01768 <span class="comment">     * Bail if this guy doesn't have the foreground activate right.</span>
01769 <span class="comment">     */</span>
01770     TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"FAllowForegroundActivate FRemoveForegroundActivate %#p"</span>, ptiCurrent);
01771     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1939">FRemoveForegroundActivate</a>(ptiCurrent)) {
01772         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01773     }
01774     <span class="comment">/*</span>
01775 <span class="comment">     * Don't try to foreground activate if:</span>
01776 <span class="comment">     *  we're not on the right desktop.</span>
01777 <span class="comment">     *  we're already in the foreground</span>
01778 <span class="comment">     *  the foreground is locked</span>
01779 <span class="comment">     * It'll fail in SetForegroundWindow2() anyway. This way</span>
01780 <span class="comment">     * ActivateWindow() will still locally activate the window.</span>
01781 <span class="comment">     */</span>
01782     <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>)
01783             || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == pq)
01784             || <a class="code" href="../../d4/d1/userk_8h.html#a2025">IsForegroundLocked</a>()) {
01785         TAGMSG0(DBGTAG_FOREGROUND, <span class="stringliteral">"FAllowForegroundActivate FALSE due to addtional checks"</span>);
01786         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01787     }
01788     <span class="comment">/*</span>
01789 <span class="comment">     * noactivate windows cannot take the foreground unless explicitly requested.</span>
01790 <span class="comment">     * Note that windows passed to this function are expected to be toplevel, which is</span>
01791 <span class="comment">     *  where this style has meaning. This might not be the case if AW_SKIP picked an</span>
01792 <span class="comment">     *  owner window which is not top level. Since noactivate doesn't apply to the owner</span>
01793 <span class="comment">     *  chain, it's OK to ignore this.</span>
01794 <span class="comment">     */</span>
01795 <span class="preprocessor">    #if DBG</span>
01796 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
01797         RIPMSG1(RIP_WARNING, <span class="stringliteral">"FAllowForegroundActivate pwnd %#p is not top level"</span>, pwnd);
01798     }
01799 <span class="preprocessor">    #endif</span>
01800 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFNOACTIVATE)) {
01801         TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"FAllowForegroundActivate noactivate window:%#p"</span>, pwnd);
01802         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01803     }
01804 
01805     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01806 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="focusact.c::FBadWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL FBadWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l00365">365</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02418">WFDISABLED</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">xxxActivateWindow()</a>, and <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l04022">xxxMenuWindowProc()</a>.
<p>
<pre class="fragment"><div>00367 {
00368     <span class="keywordflow">return</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00369             || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFVISIBLE)
00370             || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDISABLED));
00371 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="focusact.c::FRemoveForegroundActivate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL FRemoveForegroundActivate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pti</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01717">1717</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l01131">ClearAppStarting()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02831">TIF_ALLOWFOREGROUNDACTIVATE</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l01761">FAllowForegroundActivate()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01235">xxxSetForegroundWindow()</a>.
<p>
<pre class="fragment"><div>01718 {
01719     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRemoved;
01720     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
01721     <span class="comment">/*</span>
01722 <span class="comment">     * W32PF_APPSTARTING gets turned off the first activate this process does.</span>
01723 <span class="comment">     * We assume it's ready now for action.</span>
01724 <span class="comment">     */</span>
01725     ppi = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
01726     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_APPSTARTING) {
01727         <a class="code" href="../../d4/d1/userk_8h.html#a1832">ClearAppStarting</a>(ppi);
01728     }
01729 
01730     <span class="comment">/*</span>
01731 <span class="comment">     * Remove the right if present.</span>
01732 <span class="comment">     */</span>
01733     fRemoved =  (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>);
01734     <span class="keywordflow">if</span> (fRemoved) {
01735         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a> ;
01736         TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"FRemoveForegroundActivate clear TIF %#p"</span>, pti);
01737     } <span class="keywordflow">else</span> {
01738         fRemoved = (ppi-&gt;W32PF_Flags &amp; W32PF_ALLOWFOREGROUNDACTIVATE);
01739     }
01740     <span class="keywordflow">if</span> (fRemoved) {
01741         ppi-&gt;W32PF_Flags &amp;= ~W32PF_ALLOWFOREGROUNDACTIVATE;
01742         TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"FRemoveForegroundActivate clear W32PF %#p"</span>, ppi);
01743     }
01744 
01745     <span class="keywordflow">return</span> fRemoved;
01746 
01747 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="focusact.c::GNT_NextTopScan" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> GNT_NextTopScan           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndOwner</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02300">2300</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02579">DF_DESKWNDDESTROYED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02650">tagDESKTOP::dwDTFlags</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01744">tagWND::spwndNext</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01747">tagWND::spwndOwner</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l02431">NextTopWindow()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l02332">NTW_GetNextTop()</a>.
<p>
<pre class="fragment"><div>02304 {
02305     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02306         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != NULL &amp;&amp;
02307                    (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; DF_DESKWNDDESTROYED) == 0);
02308         pwnd = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
02309     } <span class="keywordflow">else</span> {
02310         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
02311     }
02312 
02313     <span class="keywordflow">for</span> (; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
02314         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> == pwndOwner)
02315             <span class="keywordflow">break</span>;
02316     }
02317 
02318     <span class="keywordflow">return</span> pwnd;
02319 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="focusact.c::NextTopWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> NextTopWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndSkip</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02431">2431</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02416">CheckTopLevelOnly()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02300">GNT_NextTopScan()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02332">NTW_GetNextTop()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02382">NTW_GetPrevTop()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04454">NTW_IGNORETOOLWINDOW</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04453">NTW_PREVIOUS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02790">PWNDDESKTOP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02534">WEFNOACTIVATE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02364">WEFTOOLWINDOW</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02418">WFDISABLED</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/palette_8c-source.html#l00025">IsTopmostRealApp()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">xxxActivateWindow()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l04022">xxxMenuWindowProc()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01675">xxxNextWindow()</a>, and <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l02121">xxxOldNextWindow()</a>.
<p>
<pre class="fragment"><div>02436 {
02437     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFoundFirstUnowned;
02438     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPrev;
02439     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndStart = pwnd;
02440     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFirstUnowned;
02441 
02442     <span class="comment">/*</span>
02443 <span class="comment">     * If the search gets to the first unowned window TWICE (See NTW_GetNextTop),</span>
02444 <span class="comment">     * we couldn't find a window</span>
02445 <span class="comment">     */</span>
02446     pwndFirstUnowned = <a class="code" href="../../d3/d6/focusact_8c.html#a19">GNT_NextTopScan</a>(pti, NULL, NULL);
02447     fFoundFirstUnowned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02448 
02449     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02450         pwnd = <a class="code" href="../../d3/d6/focusact_8c.html#a20">NTW_GetNextTop</a>(pti, NULL);
02451 
02452         <span class="comment">/*</span>
02453 <span class="comment">         * Don't allow desktop windows.</span>
02454 <span class="comment">         */</span>
02455         pwnd = pwndStart = <a class="code" href="../../d3/d6/focusact_8c.html#a22">CheckTopLevelOnly</a>(pwnd);
02456 
02457         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02458             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// No more windows owned by the thread</span>
02459 
02460         <span class="keywordflow">goto</span> Loop;
02461     }
02462 
02463     <span class="comment">/*</span>
02464 <span class="comment">     * Don't allow desktop windows.</span>
02465 <span class="comment">     */</span>
02466     pwnd = pwndStart = <a class="code" href="../../d3/d6/focusact_8c.html#a22">CheckTopLevelOnly</a>(pwnd);
02467     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02468         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// No more windows owned by this thread</span>
02469 
02470     <span class="comment">/*</span>
02471 <span class="comment">     * Don't allow desktop windows.</span>
02472 <span class="comment">     */</span>
02473     pwndSkip = <a class="code" href="../../d3/d6/focusact_8c.html#a22">CheckTopLevelOnly</a>(pwndSkip);
02474 
02475 
02476 
02477     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02478         pwndPrev = pwnd;
02479         pwnd = ((flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a515">NTW_PREVIOUS</a>) ? <a class="code" href="../../d3/d6/focusact_8c.html#a21">NTW_GetPrevTop</a>(pti, pwnd) : <a class="code" href="../../d3/d6/focusact_8c.html#a20">NTW_GetNextTop</a>(pti, pwnd));
02480 
02481         <span class="comment">/*</span>
02482 <span class="comment">         * If we've cycled to where we started, couldn't find one: return NULL</span>
02483 <span class="comment">         */</span>
02484         <span class="keywordflow">if</span> (pwnd == pwndStart)
02485             <span class="keywordflow">break</span>;
02486 
02487         <span class="keywordflow">if</span> (pwnd == pwndFirstUnowned) {
02488             <span class="keywordflow">if</span> (fFoundFirstUnowned) {
02489                 <span class="keywordflow">break</span>;
02490             } <span class="keywordflow">else</span> {
02491                 fFoundFirstUnowned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02492             }
02493         }
02494 
02495         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02496             <span class="keywordflow">break</span>;
02497 
02498         <span class="comment">/*</span>
02499 <span class="comment">         * If we've cycled over desktops, then return NULL because we'll</span>
02500 <span class="comment">         * never hit pwndStart.</span>
02501 <span class="comment">         */</span>
02502         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndStart) != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))
02503             <span class="keywordflow">break</span>;
02504 
02505         <span class="comment">/*</span>
02506 <span class="comment">         * going nowhere is a bad sign.</span>
02507 <span class="comment">         */</span>
02508         <span class="keywordflow">if</span> (pwndPrev == pwnd) {
02509             <span class="comment">/*</span>
02510 <span class="comment">             * This is a temporary fix chosen because its safe.  This case</span>
02511 <span class="comment">             * was hit when a window failed the NCCREATE message and fell</span>
02512 <span class="comment">             * into xxxFreeWindow and left the critical section after being</span>
02513 <span class="comment">             * unlinked.  The app then died and entered cleanup code and</span>
02514 <span class="comment">             * tried to destroy this window again.</span>
02515 <span class="comment">             */</span>
02516             <span class="keywordflow">break</span>;
02517         }
02518 
02519 Loop:
02520         <span class="keywordflow">if</span> (pwnd == pwndSkip)
02521             <span class="keywordflow">continue</span>;
02522 
02523         <span class="comment">/*</span>
02524 <span class="comment">         *  If it's visible, not disabled, not a noactivate window</span>
02525 <span class="comment">         *   and either we're not ignoringtool windows or it's not a</span>
02526 <span class="comment">         *  tool window, then we've got it.</span>
02527 <span class="comment">         */</span>
02528         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFVISIBLE) &amp;&amp;
02529             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDISABLED) &amp;&amp;
02530             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFNOACTIVATE) &amp;&amp;
02531             (!(flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a516">NTW_IGNORETOOLWINDOW</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFTOOLWINDOW))) {
02532 
02533             <span class="keywordflow">return</span> pwnd;
02534         }
02535     }
02536 
02537     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02538 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="focusact.c::NTW_GetNextTop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> NTW_GetNextTop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02332">2332</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d4/d5/focusact_8c-source.html#l02300">GNT_NextTopScan()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01747">tagWND::spwndOwner</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l02431">NextTopWindow()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l02382">NTW_GetPrevTop()</a>.
<p>
<pre class="fragment"><div>02335 {
02336     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner;
02337 
02338     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02339         <span class="keywordflow">goto</span> ReturnFirst;
02340     }
02341 
02342     <span class="comment">/*</span>
02343 <span class="comment">     * First look for any windows owned by this window</span>
02344 <span class="comment">     * If that fails, then go up one level to our owner,</span>
02345 <span class="comment">     * and look for next window owned by his owner.</span>
02346 <span class="comment">     * This results in a depth-first ordering of the windows.</span>
02347 <span class="comment">     */</span>
02348 
02349     pwndOwner = pwnd;
02350     pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02351 
02352     <span class="keywordflow">do</span> {
02353         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d3/d6/focusact_8c.html#a19">GNT_NextTopScan</a>(pti, pwnd, pwndOwner)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02354             <span class="keywordflow">return</span> pwnd;
02355         }
02356 
02357         pwnd = pwndOwner;
02358         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02359             pwndOwner = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
02360 
02361     } <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02362 
02363 ReturnFirst:
02364 
02365     <span class="comment">/*</span>
02366 <span class="comment">     * If no more windows to enumerate, return the first unowned window.</span>
02367 <span class="comment">     */</span>
02368     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/focusact_8c.html#a19">GNT_NextTopScan</a>(pti, NULL, NULL);
02369 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="focusact.c::NTW_GetPrevTop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> NTW_GetPrevTop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndCurrent</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02382">2382</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d4/d5/focusact_8c-source.html#l02332">NTW_GetNextTop()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l02431">NextTopWindow()</a>.
<p>
<pre class="fragment"><div>02385 {
02386     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02387     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPrev;
02388 
02389     <span class="comment">/*</span>
02390 <span class="comment">     * Starting from beginning, loop thru the windows, saving the previous</span>
02391 <span class="comment">     * one, until we find the window we're currently at.</span>
02392 <span class="comment">     */</span>
02393     pwndPrev = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02394 
02395     <span class="keywordflow">do</span> {
02396         pwnd = <a class="code" href="../../d3/d6/focusact_8c.html#a20">NTW_GetNextTop</a>(pti, pwndPrev);
02397         <span class="keywordflow">if</span> (pwnd == pwndCurrent &amp;&amp; pwndPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02398             <span class="keywordflow">break</span>;
02399         }
02400     } <span class="keywordflow">while</span> ((pwndPrev = pwnd) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02401 
02402     <span class="keywordflow">return</span> pwndPrev;
02403 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="focusact.c::RemoveEventMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL RemoveEventMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d4/structtagQ.html">PQ</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pq</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwQEvent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwQEventStop</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01004">1004</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03253">DelQEntry()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02981">tagQMSG::dwQEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03104">tagQ::idSysPeek</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03100">tagQ::mlInput</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02978">tagQMSG::pqmsgPrev</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03089">tagMLIST::pqmsgWriteLast</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
<pre class="fragment"><div>01008 {
01009     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgT;
01010     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgPrev;
01011     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRemovedEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01012 
01013     <span class="comment">/*</span>
01014 <span class="comment">     * Remove all events dwQEvent until finding dwQEventStop.</span>
01015 <span class="comment">     */</span>
01016     <span class="keywordflow">for</span> (pqmsgT = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>; pqmsgT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
01017 
01018         <span class="keywordflow">if</span> (pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a> == dwQEventStop)
01019             <span class="keywordflow">return</span>(bRemovedEvent);
01020 
01021         pqmsgPrev = pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a>;
01022 
01023         <span class="comment">/*</span>
01024 <span class="comment">         * If the event is found and is not the one being peeked,</span>
01025 <span class="comment">         * delete it.</span>
01026 <span class="comment">         */</span>
01027         <span class="keywordflow">if</span> (pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a> == dwQEvent &amp;&amp;
01028                 pqmsgT != (<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>) {
01029             <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(&amp;(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>), pqmsgT);
01030             bRemovedEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01031         }
01032         pqmsgT = pqmsgPrev;
01033     }
01034     <span class="keywordflow">return</span>(bRemovedEvent);
01035 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="focusact.c::SetForegroundPriority" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SetForegroundPriority           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fSetForeground</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02708">2708</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02648">SetForegroundPriorityProcess()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02829">TIF_CSRSSTHREAD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02828">TIF_SYSTEMTHREAD</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00155">CheckProcessForeground()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07022">NtUserYieldTask()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02588">SetForegroundThread()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04578">SetWakeBit()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l01501">xxxCreateThreadInfo()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00213">xxxInternalGetMessage()</a>, and <a class="el" href="../../d9/d2/movesize_8c-source.html#l01053">xxxMoveSize()</a>.
<p>
<pre class="fragment"><div>02711 {
02712     UserAssert(pti != NULL);
02713 
02714     <span class="comment">/*</span>
02715 <span class="comment">     * We don't want to change the priority of system or console threads</span>
02716 <span class="comment">     */</span>
02717     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>))
02718         <span class="keywordflow">return</span>;
02719 
02720     <a class="code" href="../../d4/d1/userk_8h.html#a1333">SetForegroundPriorityProcess</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, pti, fSetForeground);
02721 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="focusact.c::SetForegroundPriorityProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SetForegroundPriorityProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ppi</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fSetForeground</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02648">2648</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00257">gppiForegroundOld</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00423">gppiScreenSaver</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00276">_EPROCESS::PriorityClass</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a108">PsProcessPriorityBackground</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a109">PsProcessPriorityForeground</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a110">PsProcessPrioritySpinning</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02844">TIF_GLOBALHOOKER</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l05120">IdleTimerProc()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02708">SetForegroundPriority()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>.
<p>
<pre class="fragment"><div>02652 {
02653     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02654     UCHAR PriorityClassSave;
02655 
02656     UserAssert(ppi != NULL);
02657 
02658     Process = ppi-&gt;Process;
02659     UserAssert(ppi-&gt;Process != NULL);
02660 
02661     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_IDLESCREENSAVER) {
02662         fSetForeground = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02663         PriorityClassSave = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a>;
02664         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> = PROCESS_PRIORITY_CLASS_IDLE;
02665     }
02666 
02667     <span class="comment">/*</span>
02668 <span class="comment">     * If we previously delayed setting some process to the background</span>
02669 <span class="comment">     * because a screen saver was starting up, do it now.</span>
02670 <span class="comment">     */</span>
02671     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a112">gppiForegroundOld</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02672         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a112">gppiForegroundOld</a> == ppi) {
02673             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a112">gppiForegroundOld</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02674         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppi != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>) {
02675             <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a112">gppiForegroundOld</a>-&gt;Process, PsProcessPriorityBackground);
02676             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a112">gppiForegroundOld</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02677         }
02678     }
02679 
02680     <span class="comment">/*</span>
02681 <span class="comment">     * If this app should be background, don't let it go foreground.</span>
02682 <span class="comment">     * Foreground apps run at a higher base priority.</span>
02683 <span class="comment">     */</span>
02684     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_FORCEBACKGROUNDPRIORITY) {
02685         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a812">TIF_GLOBALHOOKER</a>)) {
02686             <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(Process, PsProcessPrioritySpinning);
02687         }
02688     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fSetForeground) {
02689         <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(Process, PsProcessPriorityForeground);
02690     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a812">TIF_GLOBALHOOKER</a>)) {
02691         <span class="comment">/*</span>
02692 <span class="comment">         * Don't adjust the priority of the current foreground process if</span>
02693 <span class="comment">         * the new foreground process is a screen saver.</span>
02694 <span class="comment">         */</span>
02695         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> != ppi) {
02696             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a112">gppiForegroundOld</a> = ppi;
02697         } <span class="keywordflow">else</span> {
02698             <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(Process, PsProcessPriorityBackground);
02699         }
02700     }
02701 
02702     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_IDLESCREENSAVER) {
02703         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> = PriorityClassSave;
02704     }
02705 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="focusact.c::SetForegroundThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SetForegroundThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pti</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02588">2588</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02932">CBKEYSTATERECENTDOWN</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00982">ChangeForegroundKeyboardTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00577">gafAsyncKeyStateRecentDown</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00091">gptiForeground</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02708">SetForegroundPriority()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03323">tagTHREADINFO::spklActive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00220">xxxSendFocusMessages()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
<pre class="fragment"><div>02590 {
02591     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklPrev;
02592 
02593     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>)
02594         <span class="keywordflow">return</span>;
02595 
02596     <span class="comment">/*</span>
02597 <span class="comment">     * The foregorund thread must be on the foreground queue.</span>
02598 <span class="comment">     * xxxSendFocusMessages obtains this pti from a window</span>
02599 <span class="comment">     *  received as a parameter. If the owner of the window</span>
02600 <span class="comment">     *  exited during a callback (in the caller), then the pti</span>
02601 <span class="comment">     *  will be gptiRit,which might not be in the foreground queue</span>
02602 <span class="comment">     */</span>
02603     UserAssert((pti == NULL)
02604                 || (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == gpqForeground)
02605                 || (pti == gptiRit));
02606 
02607     <span class="comment">/*</span>
02608 <span class="comment">     * If we're changing gptiForeground to another process,</span>
02609 <span class="comment">     * change the base priorities of the two processes.  We</span>
02610 <span class="comment">     * know that if either 'pti' or 'gptiForeground' is NULL</span>
02611 <span class="comment">     * that both aren't NULL due to the first test in this</span>
02612 <span class="comment">     * function.</span>
02613 <span class="comment">     */</span>
02614     <span class="keywordflow">if</span> ((pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02615             (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)) {
02616         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02617             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp;= ~W32PF_FORCEBACKGROUNDPRIORITY;
02618             <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(gptiForeground, FALSE);
02619         }
02620 
02621         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02622             <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(pti, TRUE);
02623         }
02624     }
02625 
02626     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>) {
02627         pklPrev = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>;
02628     } <span class="keywordflow">else</span> {
02629         pklPrev = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02630     }
02631     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> = pti;
02632     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>) {
02633         <a class="code" href="../../d4/d1/userk_8h.html#a1301">ChangeForegroundKeyboardTable</a>(pklPrev, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>);
02634     }
02635 
02636     <span class="comment">/*</span>
02637 <span class="comment">     * Clear recent down information in the async key state to prevent</span>
02638 <span class="comment">     * spying by apps.</span>
02639 <span class="comment">     */</span>
02640     RtlZeroMemory(gafAsyncKeyStateRecentDown, CBKEYSTATERECENTDOWN);
02641 
02642     <span class="comment">/*</span>
02643 <span class="comment">     * Update the async key cache index.</span>
02644 <span class="comment">     */</span>
02645     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwAsyncKeyCache++;
02646 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="focusact.c::xxxActivateApp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxActivateApp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d7/structtagAAS.html">AAS</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>paas</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l00336">336</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02336">tagAAS::fActivating</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02337">tagAAS::fQueueNotify</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02334">tagAAS::ptiNotify</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00969">QueueNotifyMessage()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02335">tagAAS::tidActDeact</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l05671">CancelInputState()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l00034">xxxDeactivate()</a>.
<p>
<pre class="fragment"><div>00339 {
00340     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00341 
00342     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == paas-&gt;<a class="code" href="../../d8/d7/structtagAAS.html#o0">ptiNotify</a>) {
00343 
00344         <span class="keywordflow">if</span> (paas-&gt;<a class="code" href="../../d8/d7/structtagAAS.html#o3">fQueueNotify</a>) {
00345             <a class="code" href="../../d4/d1/userk_8h.html#a1582">QueueNotifyMessage</a>(pwnd, WM_ACTIVATEAPP, paas-&gt;<a class="code" href="../../d8/d7/structtagAAS.html#o2">fActivating</a>,
00346                     paas-&gt;<a class="code" href="../../d8/d7/structtagAAS.html#o1">tidActDeact</a>);
00347         } <span class="keywordflow">else</span> {
00348             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ACTIVATEAPP, paas-&gt;<a class="code" href="../../d8/d7/structtagAAS.html#o2">fActivating</a>,
00349                     paas-&gt;<a class="code" href="../../d8/d7/structtagAAS.html#o1">tidActDeact</a>);
00350         }
00351     }
00352 
00353     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00354 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="focusact.c::xxxActivateThisWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxActivateThisWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>tidLoseForeground</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>fFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">472</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l04446">ATW_ASYNC</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04444">ATW_MOUSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04447">ATW_NOZORDER</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04445">ATW_SETFOCUS</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03634">BWL_ENUMLIST</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02557">ClrWF</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02336">tagAAS::fActivating</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02337">tagAAS::fQueueNotify</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01265">FWINABLE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00817">GetTopLevelWindow()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00198">glinp</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00423">gppiScreenSaver</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00100">gpqForegroundPrev</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00456">grpdeskRitInput</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01827">tagWND::head</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01477">HMIsMarkDestroy</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01515">HWq</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l01266">IsHooked</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00537">IsVisible()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03475">tagPROCESSINFO::ptiMainThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02334">tagAAS::ptiNotify</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01071">PUSIF_PALETTEDISPLAY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03833">PWND_BROADCAST</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03828">PWND_TOP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02790">PWNDDESKTOP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02993">QEVENT_ACTIVATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02992">QEVENT_DEACTIVATE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03003">QF_ACTIVATIONCHANGE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03023">QF_EVENTDEACTIVATEREMOVED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03129">tagQ::QF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03021">QF_FOCUSNULLSINCEACTIVE</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01004">RemoveEventMessage()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03476">tagPROCESSINFO::rpdeskStartup</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02648">SetForegroundPriorityProcess()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02556">SetWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03112">tagQ::spwndActivePrev</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03110">tagQ::spwndFocus</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01759">tagWND::spwndLastActive</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01744">tagWND::spwndNext</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01747">tagWND::spwndOwner</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01076">TEST_PUSIF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01692">ThreadLockPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01699">ThreadUnlockPti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02335">tagAAS::tidActDeact</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01175">TIDq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02835">TIF_INACTIVATEAPPMSG</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03260">tagLASTINPUT::timeLastInputMessage</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06464">WEF_USEPWNDTHREAD</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02287">WFBEINGACTIVATED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02421">WFCHILD</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02304">WFDESTROYED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02267">WFFRAMEON</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02420">WFMINIMIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02269">WFNONCPAINT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02037">WHF_CBT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00847">WNDENUMPROC_PWND</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00336">xxxActivateApp()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d5/d6/enumwin_8c-source.html#l00040">xxxInternalEnumWindow()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00166">xxxMakeWindowForegroundWithState()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00220">xxxSendFocusMessages()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01069">xxxSendNotifyMessage()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01468">xxxSetWindowPos()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00374">xxxUpdateTray()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00274">xxxWindowEvent()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">xxxActivateWindow()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02327">xxxActiveWindowTracking()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l04022">xxxMenuWindowProc()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l02517">xxxMNCloseHierarchy()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00265">xxxMNEndMenuState()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01815">xxxSetFocus()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
<pre class="fragment"><div>00476 {
00477     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00478     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT, pwndActivePrev, pwndActiveSave;
00479     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndActive;
00480     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndChild;
00481     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndActivePrev;
00482     WPARAM wParam;
00483     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSetActivateAppBit;
00484 
00485     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fMouse = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a511">ATW_MOUSE</a>);
00486     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSetFocus = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a512">ATW_SETFOCUS</a>);
00487     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAsync = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a513">ATW_ASYNC</a>);
00488 
00489 <span class="preprocessor">#if DBG</span>
00490 <span class="preprocessor"></span>    <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqSave = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00491 <span class="preprocessor">#endif</span>
00492 <span class="preprocessor"></span>
00493 
00494     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00495 
00496     <span class="comment">/*</span>
00497 <span class="comment">     * If pwnd is NULL, then we can't do anything.</span>
00498 <span class="comment">     */</span>
00499     <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))) {
00500         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00501     }
00502 
00503     <span class="comment">/*</span>
00504 <span class="comment">     * Don't activate a window that has been destroyed.</span>
00505 <span class="comment">     */</span>
00506     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pwnd))
00507         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00508 
00509     <span class="comment">/*</span>
00510 <span class="comment">     * We don't activate top-level windows of a different queue.</span>
00511 <span class="comment">     */</span>
00512     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
00513         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00514     }
00515 
00516     pwndActiveSave = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
00517 
00518     <span class="comment">/*</span>
00519 <span class="comment">     * Do the change-in-activation if the two-windows are different,</span>
00520 <span class="comment">     * and if we're not recursing</span>
00521 <span class="comment">     */</span>
00522     <span class="keywordflow">if</span> ((pwnd != pwndActiveSave) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFBEINGACTIVATED)) {
00523 
00524         <span class="comment">/*</span>
00525 <span class="comment">         * Ask the CBT hook whether it is OK to activate this window.</span>
00526 <span class="comment">         */</span>
00527         {
00528             CBTACTIVATESTRUCT CbtActivateParams;
00529 
00530             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_CBT)) {
00531 
00532                 CbtActivateParams.fMouse     = fMouse;
00533                 CbtActivateParams.hWndActive = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndActiveSave);
00534 
00535                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_ACTIVATE,
00536                         (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), (LPARAM)&amp;CbtActivateParams, WH_CBT)) {
00537                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00538                 }
00539             }
00540         }
00541 
00542         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a868">QF_EVENTDEACTIVATEREMOVED</a>;
00543 
00544         <span class="comment">/*</span>
00545 <span class="comment">         * If the active window went away but somehow was left referenced</span>
00546 <span class="comment">         * in the queue, then we do not want to do any deactivation of</span>
00547 <span class="comment">         * that window.</span>
00548 <span class="comment">         *</span>
00549 <span class="comment">         * Don't thread lock this because the next thing we do with it</span>
00550 <span class="comment">         * is just an equality check.</span>
00551 <span class="comment">         *</span>
00552 <span class="comment">         * A DBG check is placed in xxxDestroyWindow to attempt to</span>
00553 <span class="comment">         * catch the situation where we return from the function with</span>
00554 <span class="comment">         * the destroyed window set in the active (pq).  If that situation</span>
00555 <span class="comment">         * can be detected and solved, then this conditional might be</span>
00556 <span class="comment">         * removed: ChrisWil - 08/22/95.</span>
00557 <span class="comment">         */</span>
00558         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WFDESTROYED)) {
00559             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, NULL);
00560         } <span class="keywordflow">else</span> {
00561             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
00562         }
00563         pwndActivePrev = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
00564 
00565         <span class="comment">/*</span>
00566 <span class="comment">         * If there was a previously active window,</span>
00567 <span class="comment">         * and we're in the foreground then assign</span>
00568 <span class="comment">         * gpqForegroundPrev to ourself.</span>
00569 <span class="comment">         */</span>
00570         <span class="keywordflow">if</span> ((pwndActivePrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)) {
00571             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00572         }
00573 
00574         <span class="comment">/*</span>
00575 <span class="comment">         * Deactivate currently active window if possible.</span>
00576 <span class="comment">         */</span>
00577         <span class="keywordflow">if</span> (pwndActivePrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00578             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndActivePrev, &amp;tlpwndActive);
00579 
00580             <span class="comment">/*</span>
00581 <span class="comment">             * The active window can prevent itself from losing the</span>
00582 <span class="comment">             * activation by returning FALSE to this WM_NCACTIVATE message</span>
00583 <span class="comment">             */</span>
00584             wParam = MAKELONG(WA_INACTIVE, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndActivePrev, WFMINIMIZED));
00585             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndActivePrev, WM_NCACTIVATE,
00586                     wParam, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd))) {
00587                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActive);
00588                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00589             }
00590 
00591             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndActivePrev, WM_ACTIVATE, wParam, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd));
00592 
00593             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActive);
00594         }
00595 
00596         <span class="comment">/*</span>
00597 <span class="comment">         * If the activation changed while we were gone, we'd better</span>
00598 <span class="comment">         * not send any more messages, since they'd go to the wrong window.</span>
00599 <span class="comment">         * (and, they've already been sent anyhow)</span>
00600 <span class="comment">         */</span>
00601         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> ||
00602                 pwndActiveSave != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) {
00603 <span class="preprocessor">#if DBG</span>
00604 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) {
00605                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxActivateThisWindow: ptiCurrent-&gt;pq-&gt;spwndActive changed in callbacks"</span>);
00606             }
00607 <span class="preprocessor">#endif</span>
00608 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00609         }
00610 
00611         <span class="comment">/*</span>
00612 <span class="comment">         * If the window being activated has been destroyed, don't</span>
00613 <span class="comment">         * do anything else.  Making it the active window in this</span>
00614 <span class="comment">         * case can cause console to hang during shutdown.</span>
00615 <span class="comment">         */</span>
00616         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pwnd))
00617             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00618 
00619         <span class="comment">/*</span>
00620 <span class="comment">         * Before we lock the new pwndActivate, make sure we're still</span>
00621 <span class="comment">         *  on the same queue.</span>
00622 <span class="comment">         */</span>
00623         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
00624             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxActivateThisWindow: Queue unattached:%#p"</span>, pqSave);
00625             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00626         }
00627 
00628         <span class="comment">/*</span>
00629 <span class="comment">         * This bit, which means the app set the focus to NULL after becoming</span>
00630 <span class="comment">         * active, doesn't make sense if the app is just becoming active, so</span>
00631 <span class="comment">         * clear it in this case. It is used below in this routine to</span>
00632 <span class="comment">         * determine whether to send focus messages (read comment in this</span>
00633 <span class="comment">         * routine).</span>
00634 <span class="comment">         */</span>
00635         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00636             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a866">QF_FOCUSNULLSINCEACTIVE</a>;
00637 
00638         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, pwnd);
00639 
00640         <span class="comment">/*</span>
00641 <span class="comment">         * Tp prevent recursion, set pwnd's WFBEINGACTIVATED bit.</span>
00642 <span class="comment">         * Recursion can happen if we have an activation battle with other</span>
00643 <span class="comment">         * threads which keep changing ptiCurrent-&gt;pq-&gt;spwndActive behind our</span>
00644 <span class="comment">         * callbacks.</span>
00645 <span class="comment">         * WARNING: Do NOT return from this routine without clearing this bit!</span>
00646 <span class="comment">         */</span>
00647         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, WFBEINGACTIVATED);
00648 
00649         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00650             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_FOREGROUND, pwnd, OBJID_WINDOW, INDEXID_OBJECT, WEF_USEPWNDTHREAD);
00651         }
00652 
00653         <span class="comment">/*</span>
00654 <span class="comment">         * Remove all async activates up to the next async deactivate. We</span>
00655 <span class="comment">         * do this so that any queued activates don't reset this synchronous</span>
00656 <span class="comment">         * activation state we're now setting. Only remove up till the next</span>
00657 <span class="comment">         * deactivate because active state is synchronized with reading</span>
00658 <span class="comment">         * input from the input queue.</span>
00659 <span class="comment">         *</span>
00660 <span class="comment">         * For example, an activate event gets put in an apps queue. Before</span>
00661 <span class="comment">         * processing it the app calls ActivateWindow(), which is synchronous.</span>
00662 <span class="comment">         * You want the ActivateWindow() to win because it is newer</span>
00663 <span class="comment">         * information.</span>
00664 <span class="comment">         *</span>
00665 <span class="comment">         * msmail32 demonstrates this. Minimize msmail. Alt-tab to it. It</span>
00666 <span class="comment">         * brings up the password dialog, but it isn't active. It correctly</span>
00667 <span class="comment">         * activates the password dialog but then processes an old activate</span>
00668 <span class="comment">         * event activating the icon, so the password dialog is not active.</span>
00669 <span class="comment">         */</span>
00670         <a class="code" href="../../d3/d6/focusact_8c.html#a0">RemoveEventMessage</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, QEVENT_ACTIVATE, QEVENT_DEACTIVATE);
00671 
00672         <a class="code" href="../../d4/d1/userk_8h.html#a1756">xxxMakeWindowForegroundWithState</a>(NULL, 0);
00673 
00674         pwndActivePrev = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>;
00675         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndActivePrev, &amp;tlpwndActivePrev);
00676 
00677         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(PUSIF_PALETTEDISPLAY) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_QUERYNEWPALETTE, 0, 0)) {
00678             <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(PWND_BROADCAST, WM_PALETTEISCHANGING,
00679                     (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), 0);
00680         }
00681 
00682         <span class="comment">/*</span>
00683 <span class="comment">         * If the window becoming active is not already the top window in the</span>
00684 <span class="comment">         * Z-order, then call xxxBringWindowToTop() to do so.</span>
00685 <span class="comment">         */</span>
00686 
00687         <span class="comment">/*</span>
00688 <span class="comment">         * If this isn't a child window, first check to see if the</span>
00689 <span class="comment">         * window isn't already 'on top'.  If not, then call</span>
00690 <span class="comment">         * xxxBringWindowToTop().</span>
00691 <span class="comment">         */</span>
00692         <span class="keywordflow">if</span> (!(fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a514">ATW_NOZORDER</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFCHILD)) {
00693 
00694             <span class="comment">/*</span>
00695 <span class="comment">             * Look for the first visible child of the desktop.</span>
00696 <span class="comment">             * ScottLu changed this to start looking at the desktop</span>
00697 <span class="comment">             * window. Since the desktop window was always visible,</span>
00698 <span class="comment">             * BringWindowToTop was always called regardless of whether</span>
00699 <span class="comment">             * it was needed or not. No one can remember why this</span>
00700 <span class="comment">             * change was made, so I'll change it back to the way it</span>
00701 <span class="comment">             * was in Windows 3.1. - JerrySh</span>
00702 <span class="comment">             */</span>
00703             pwndT = <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)-&gt;spwndChild;
00704 
00705             <span class="keywordflow">while</span> (pwndT &amp;&amp; (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WFVISIBLE))) {
00706                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00707             }
00708 
00709             <span class="comment">/*</span>
00710 <span class="comment">             * If this activation came from an async call (i.e.</span>
00711 <span class="comment">             * xxxProcessEventMessage), we need to check to see</span>
00712 <span class="comment">             * if the thread is the foreground-queue.  If not, then</span>
00713 <span class="comment">             * we do not want to bring the window to the top.  This</span>
00714 <span class="comment">             * is because another window could have already been</span>
00715 <span class="comment">             * place on top w/foreground.  Bringing the window to</span>
00716 <span class="comment">             * the top in this case would result in a top-level window</span>
00717 <span class="comment">             * without activation. - ChrisWil</span>
00718 <span class="comment">             *</span>
00719 <span class="comment">             * Added a check to see if the previous-active window went</span>
00720 <span class="comment">             * invisible during the deactivation time.  This will ensure</span>
00721 <span class="comment">             * that we bring the new window to the top.  Otherwise, we</span>
00722 <span class="comment">             * could end up skipping over the previous-window from the</span>
00723 <span class="comment">             * above tests.  Office95 apps demonstrate this behaviour by</span>
00724 <span class="comment">             * turning their windows invisible during the painting of their</span>
00725 <span class="comment">             * captionbars.  By the time we use to get here, we failed to</span>
00726 <span class="comment">             * bring the new window to top.</span>
00727 <span class="comment">             */</span>
00728             <span class="keywordflow">if</span> ((pwnd != pwndT) || (pwndActivePrev &amp;&amp; !<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwndActivePrev))) {
00729 
00730                 <span class="keywordflow">if</span> (!(fAsync &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>))) {
00731                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00732 
00733                     <span class="comment">/*</span>
00734 <span class="comment">                     * Bring the window to the top.  If we're already</span>
00735 <span class="comment">                     * activating the window, don't reactivate it.</span>
00736 <span class="comment">                     */</span>
00737                     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = SWP_NOSIZE | SWP_NOMOVE;
00738                     <span class="keywordflow">if</span> (pwnd == pwndT)
00739                         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= SWP_NOACTIVATE;
00740 
00741                     <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd, PWND_TOP, 0, 0, 0, 0, dwFlags);
00742                 }
00743             }
00744         }
00745 
00746         <span class="comment">/*</span>
00747 <span class="comment">         * If there was no previous active window, or if the</span>
00748 <span class="comment">         * previously active window belonged to another thread</span>
00749 <span class="comment">         * send the WM_ACTIVATEAPP messages.  The fActivate == FALSE</span>
00750 <span class="comment">         * case is handled in xxxDeactivate when 'hwndActivePrev == NULL'.</span>
00751 <span class="comment">         *</span>
00752 <span class="comment">         * Harvard Graphics/Windows setup calls SetActiveWindow when it</span>
00753 <span class="comment">         * receives a deactivationg WM_ACTIVATEAPP.  The TIF_INACTIVATEAPPMSG</span>
00754 <span class="comment">         * prevents an activating WM_ACTIVATEAPP(TRUE) from being sent while</span>
00755 <span class="comment">         * deactivation is occuring.</span>
00756 <span class="comment">         */</span>
00757         fSetActivateAppBit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00758         <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a803">TIF_INACTIVATEAPPMSG</a>) &amp;&amp;
00759                 ((pwndActivePrev == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00760                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndActivePrev) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)))) {
00761             <a class="code" href="../../d8/d7/structtagAAS.html">AAS</a> aas;
00762 
00763             <span class="comment">/*</span>
00764 <span class="comment">             * First send the deactivating WM_ACTIVATEAPP if there</span>
00765 <span class="comment">             * was a previously active window of another thread in</span>
00766 <span class="comment">             * the current queue.</span>
00767 <span class="comment">             */</span>
00768             <span class="keywordflow">if</span> (pwndActivePrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00769                 <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiPrev = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndActivePrev);
00770                 <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlptiPrev;
00771 
00772                 <span class="comment">/*</span>
00773 <span class="comment">                 * Ensure that the other thread can't recurse</span>
00774 <span class="comment">                 * and send more WM_ACTIVATEAPP msgs.</span>
00775 <span class="comment">                 */</span>
00776                 ptiPrev-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a803">TIF_INACTIVATEAPPMSG</a>;
00777 
00778                 aas.<a class="code" href="../../d8/d7/structtagAAS.html#o0">ptiNotify</a> = ptiPrev;
00779                 aas.<a class="code" href="../../d8/d7/structtagAAS.html#o1">tidActDeact</a> = <a class="code" href="../../d4/d1/userk_8h.html#a107">TIDq</a>(ptiCurrent);
00780                 aas.<a class="code" href="../../d8/d7/structtagAAS.html#o2">fActivating</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00781                 aas.<a class="code" href="../../d8/d7/structtagAAS.html#o3">fQueueNotify</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00782 
00783                 <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, ptiPrev, &amp;tlptiPrev);
00784                 <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndActivePrev-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwnd-&gt;spwndChild, &amp;tlpwndChild);
00785                 <a class="code" href="../../d4/d1/userk_8h.html#a1428">xxxInternalEnumWindow</a>(pwndActivePrev-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwnd-&gt;spwndChild,
00786                         (WNDENUMPROC_PWND)xxxActivateApp, (LPARAM)&amp;aas, BWL_ENUMLIST);
00787                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndChild);
00788                 ptiPrev-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a803">TIF_INACTIVATEAPPMSG</a>;
00789                 <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlptiPrev);
00790             }
00791 
00792             <span class="comment">/*</span>
00793 <span class="comment">             * This will ensure that the current thread will not</span>
00794 <span class="comment">             * send any more WM_ACTIVATEAPP messages until it</span>
00795 <span class="comment">             * is done performing its activation.</span>
00796 <span class="comment">             */</span>
00797             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a803">TIF_INACTIVATEAPPMSG</a>;
00798             fSetActivateAppBit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00799 
00800             aas.<a class="code" href="../../d8/d7/structtagAAS.html#o0">ptiNotify</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00801             aas.<a class="code" href="../../d8/d7/structtagAAS.html#o1">tidActDeact</a> = tidLoseForeground;
00802             aas.<a class="code" href="../../d8/d7/structtagAAS.html#o2">fActivating</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00803             aas.<a class="code" href="../../d8/d7/structtagAAS.html#o3">fQueueNotify</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00804 
00805             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, &amp;tlpwndChild);
00806             <a class="code" href="../../d4/d1/userk_8h.html#a1428">xxxInternalEnumWindow</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>,
00807                     (WNDENUMPROC_PWND)xxxActivateApp, (LPARAM)&amp;aas, BWL_ENUMLIST);
00808             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndChild);
00809         }
00810 
00811         <span class="comment">/*</span>
00812 <span class="comment">         * If this window has already been drawn as active, set the</span>
00813 <span class="comment">         * flag so that we don't draw it again.</span>
00814 <span class="comment">         */</span>
00815         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFFRAMEON)) {
00816             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, WFNONCPAINT);
00817         }
00818 
00819         <span class="comment">/*</span>
00820 <span class="comment">         * If the window is marked for destruction, don't do</span>
00821 <span class="comment">         * the lock because xxxFreeWindow has already been called</span>
00822 <span class="comment">         * and a lock here will result in the window locking itself</span>
00823 <span class="comment">         * and never being freed.</span>
00824 <span class="comment">         */</span>
00825         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pwnd)) {
00826 
00827             <span class="comment">/*</span>
00828 <span class="comment">             * Set most recently active window in owner/ownee list.</span>
00829 <span class="comment">             */</span>
00830             pwndT = pwnd;
00831             <span class="keywordflow">while</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00832                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
00833             }
00834             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>, pwnd);
00835         }
00836 
00837 
00838         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_NCACTIVATE,
00839                 MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq == gpqForeground,
00840                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != NULL ?
00841                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WFMINIMIZED) : 0),
00842                 (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndActivePrev));
00843 
00844         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00845             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ACTIVATE,
00846                     MAKELONG((fMouse ? WA_CLICKACTIVE : WA_ACTIVE),
00847                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WFMINIMIZED)),
00848                     (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndActivePrev));
00849         } <span class="keywordflow">else</span> {
00850             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ACTIVATE,
00851                     MAKELONG((fMouse ? WA_CLICKACTIVE : WA_ACTIVE), 0),
00852                     (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndActivePrev));
00853         }
00854 
00855         <a class="code" href="../../d4/d1/userk_8h.html#a1335">xxxUpdateTray</a>(pwnd);
00856 
00857         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActivePrev);
00858 
00859         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, WFNONCPAINT);
00860 
00861         <span class="comment">/*</span>
00862 <span class="comment">         * If xxxActivateThisWindow() is called from xxxSetFocus() then</span>
00863 <span class="comment">         * fSetFocus is FALSE.  In this case, we don't set the focus since</span>
00864 <span class="comment">         * xxxSetFocus() will do that for us.  Otherwise, we set the focus</span>
00865 <span class="comment">         * to the newly activated window if the window with the focus is</span>
00866 <span class="comment">         * not the new active window or one of its children.  Normally,</span>
00867 <span class="comment">         * xxxDefWindowProc() will set the focus.</span>
00868 <span class="comment">         */</span>
00869         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, &amp;tlpwndActive);
00870 
00871         <span class="comment">/*</span>
00872 <span class="comment">         * Win3.1 checks spwndFocus != NULL - we check QF_FOCUSNULLSINCEACTIVE,</span>
00873 <span class="comment">         * which is the win32 equivalent. On win32, 32 bit apps each have their</span>
00874 <span class="comment">         * own focus. If the app is not foreground, most of the time spwndFocus</span>
00875 <span class="comment">         * is NULL when the window is being activated and brought to the</span>
00876 <span class="comment">         * foreground. It wouldn't go through this code in this case. Win3.1 in</span>
00877 <span class="comment">         * effect is checking if the previous active application had an</span>
00878 <span class="comment">         * hwndFocus != NULL. Win32 effectively assumes the last window has a</span>
00879 <span class="comment">         * non-NULL hwndFocus, so win32 instead checks to see if the focus has</span>
00880 <span class="comment">         * been set to NULL since this application became active (meaning, did</span>
00881 <span class="comment">         * it purposefully set the focus to NULL). If it did, don't go through</span>
00882 <span class="comment">         * this codepath (like win3.1). If it didn't, go through this code path</span>
00883 <span class="comment">         * because the previous application had an hwndFocus != NULL</span>
00884 <span class="comment">         * (like win3.1). Effectively it is the same check as win3.1, but</span>
00885 <span class="comment">         * updated to deal with async input.</span>
00886 <span class="comment">         *</span>
00887 <span class="comment">         * Case in point: bring up progman, hit f1 (to get win32 help). Click</span>
00888 <span class="comment">         * history to get a popup (has the focus in a listbox in the client</span>
00889 <span class="comment">         * area). Activate another app, now click on title bar only of history</span>
00890 <span class="comment">         * popup. The focus should get set by going through this code path.</span>
00891 <span class="comment">         *</span>
00892 <span class="comment">         * Alternate case: Ventura Publisher brings up "Special Effects"</span>
00893 <span class="comment">         * dialog. If "Bullet" from this dialog was clicked last time the</span>
00894 <span class="comment">         * dialog was brought up, sending focus messages here when</span>
00895 <span class="comment">         * hwndFocus == NULL, would reset the focus to "None" incorrectly</span>
00896 <span class="comment">         * because Ventura does its state setting when it gets the focus</span>
00897 <span class="comment">         * messages. The real focus messages it is depending on are the</span>
00898 <span class="comment">         * ones that come from the SetFocus() call in DlgSetFocus() in</span>
00899 <span class="comment">         * the dialog management code. (In this case, before the dialog</span>
00900 <span class="comment">         * comes up, focus == active window. When the dialog comes up</span>
00901 <span class="comment">         * and EnableWindow(hwndOwner, FALSE) is called, EnableWindow() calls</span>
00902 <span class="comment">         * SetFocus(NULL) (because it is disabling the window that is also</span>
00903 <span class="comment">         * the focus window). When the dialog comes up it gets activated via</span>
00904 <span class="comment">         * SwpActivate(), but since the focus is NULL vpwin does not expect</span>
00905 <span class="comment">         * to go through this code path.)</span>
00906 <span class="comment">         *</span>
00907 <span class="comment">         * - scottlu</span>
00908 <span class="comment">         */</span>
00909 <span class="preprocessor">#if 0</span>
00910 <span class="preprocessor"></span><span class="comment">// this is what win3.1 does - which won't work for win32</span>
00911 
00912         <span class="keywordflow">if</span> (fSetFocus &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> !=
00913                 <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>))
00914 <span class="preprocessor">#else</span>
00915 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fSetFocus &amp;&amp; !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a866">QF_FOCUSNULLSINCEACTIVE</a>) &amp;&amp;
00916                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>)) {
00917 <span class="preprocessor">#endif</span>
00918 <span class="preprocessor"></span>
00919             <a class="code" href="../../d4/d1/userk_8h.html#a1227">xxxSendFocusMessages</a>(ptiCurrent,
00920                     (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != NULL &amp;&amp;
00921                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WFMINIMIZED)) ?
00922                     NULL : ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
00923         }
00924 
00925         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActive);
00926 
00927         <span class="comment">/*</span>
00928 <span class="comment">         * This flag is examined in the menu loop code so that we exit from</span>
00929 <span class="comment">         * menu mode if another window was activated while we were tracking</span>
00930 <span class="comment">         * menus.</span>
00931 <span class="comment">         */</span>
00932         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a861">QF_ACTIVATIONCHANGE</a>;
00933 
00934         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00935 
00936             <span class="comment">/*</span>
00937 <span class="comment">             * Activation has occurred, update our last idle time counter if</span>
00938 <span class="comment">             * we're on the input desktop.</span>
00939 <span class="comment">             */</span>
00940             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
00941                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o0">timeLastInputMessage</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00942             }
00943 
00944         } <span class="keywordflow">else</span> {
00945 
00946             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>) {
00947                 <span class="comment">/*</span>
00948 <span class="comment">                 * Activation ocurred by an app other than the screen saver.</span>
00949 <span class="comment">                 * Update the idle time counter and mark our screen saver as</span>
00950 <span class="comment">                 * active (so it can quit).</span>
00951 <span class="comment">                 */</span>
00952 
00953 <span class="preprocessor">#if 0</span>
00954 <span class="preprocessor"></span><span class="comment">// LATER</span>
00955                 <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>) {
00956                     <span class="comment">/*</span>
00957 <span class="comment">                     * Activation is occurring on different desktops, let WinLogon decide</span>
00958 <span class="comment">                     * if it wants to switch.</span>
00959 <span class="comment">                     */</span>
00960                 }
00961 <span class="preprocessor">#endif</span>
00962 <span class="preprocessor"></span>
00963                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o0">timeLastInputMessage</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00964                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>-&gt;W32PF_Flags &amp;= ~W32PF_IDLESCREENSAVER;
00965                 <a class="code" href="../../d4/d1/userk_8h.html#a1333">SetForegroundPriorityProcess</a>(gppiScreenSaver, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a>, TRUE);
00966             }
00967         }
00968 
00969         <span class="comment">/*</span>
00970 <span class="comment">         * If WM_ACTIVATEAPP messages were sent, it is now</span>
00971 <span class="comment">         * safe to allow them to be sent again.</span>
00972 <span class="comment">         */</span>
00973         <span class="keywordflow">if</span> (fSetActivateAppBit)
00974             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a803">TIF_INACTIVATEAPPMSG</a>;
00975 
00976 
00977     } <span class="keywordflow">else</span> {
00978 <span class="preprocessor">#if DBG</span>
00979 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFBEINGACTIVATED)) {
00980             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxActivateThisWindow recursing on pwnd %#p\n"</span>, pwnd);
00981         }
00982 <span class="preprocessor">#endif</span>
00983 <span class="preprocessor"></span>        ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a868">QF_EVENTDEACTIVATEREMOVED</a>;
00984         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(PUSIF_PALETTEDISPLAY) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_QUERYNEWPALETTE, 0, 0)) {
00985             <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(PWND_BROADCAST, WM_PALETTEISCHANGING,
00986                     (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), 0);
00987         }
00988     }
00989 
00990     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, WFBEINGACTIVATED);
00991     <span class="keywordflow">return</span> ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == pwnd;
00992 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="focusact.c::xxxActivateWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxActivateWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>cmd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">2060</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l04444">ATW_MOUSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04445">ATW_SETFOCUS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02325">AW_SKIP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02327">AW_SKIP2</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02324">AW_TRY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02326">AW_TRY2</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02323">AW_USE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02328">AW_USE2</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03391">tagTHREADINFO::cVisWindows</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01761">FAllowForegroundActivate()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00365">FBadWindow()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00100">gpqForegroundPrev</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02431">NextTopWindow()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04454">NTW_IGNORETOOLWINDOW</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03112">tagQ::spwndActivePrev</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01759">tagWND::spwndLastActive</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01747">tagWND::spwndOwner</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02561">TestwndChild</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02565">TestwndPopup</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00365">ThreadLockAlwaysWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02831">TIF_ALLOWFOREGROUNDACTIVATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02310">WFBOTTOMMOST</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01235">xxxSetForegroundWindow()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/createw_8c-source.html#l01591">xxxDestroyWindow()</a>, <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00023">xxxHandleNCMouseGuys()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l04022">xxxMenuWindowProc()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02444">xxxMouseActivate()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01990">xxxSetActiveWindow()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01235">xxxSetForegroundWindow()</a>, <a class="el" href="../../d1/d8/showwin_8c-source.html#l00085">xxxShowWindow()</a>, and <a class="el" href="../../d3/d7/swp_8c-source.html#l01586">xxxSwpActivate()</a>.
<p>
<pre class="fragment"><div>02063 {
02064     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fFlags = <a class="code" href="../../d4/d1/userk_8h.html#a512">ATW_SETFOCUS</a>;
02065     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02066     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
02067     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess;
02068     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAllowForeground, fSetForegroundRight;
02069 
02070     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
02071 
02072 
02073     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02074 
02075         <span class="comment">/*</span>
02076 <span class="comment">         * See if this window is OK to activate</span>
02077 <span class="comment">         * (Cannot activate child windows).</span>
02078 <span class="comment">         */</span>
02079         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd))
02080             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02081 
02082     } <span class="keywordflow">else</span> {
02083         cmd = <a class="code" href="../../d4/d1/userk_8h.html#a254">AW_SKIP2</a>;
02084     }
02085 
02086     <span class="keywordflow">switch</span> (cmd) {
02087 
02088     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a253">AW_TRY2</a>:
02089         fFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a511">ATW_MOUSE</a>;
02090 
02091     <span class="comment">/*</span>
02092 <span class="comment">     *** FALL THRU **</span>
02093 <span class="comment">     */</span>
02094     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a251">AW_TRY</a>:
02095 
02096         <span class="comment">/*</span>
02097 <span class="comment">         * See if this window is OK to activate.</span>
02098 <span class="comment">         */</span>
02099         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1228">FBadWindow</a>(pwnd)) {
02100             <span class="keywordflow">break</span>;
02101         }
02102 
02103     <span class="comment">/*</span>
02104 <span class="comment">     * If pwnd can not be activated, drop into the AW_SKIP case.</span>
02105 <span class="comment">     */</span>
02106     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a252">AW_SKIP</a>:
02107 
02108         <span class="comment">/*</span>
02109 <span class="comment">         * Try the owner of this popup.</span>
02110 <span class="comment">         */</span>
02111         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a739">TestwndPopup</a>(pwnd) &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a1228">FBadWindow</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>)) {
02112             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
02113             <span class="keywordflow">break</span>;
02114         }
02115 
02116         <span class="comment">/*</span>
02117 <span class="comment">         * fall through</span>
02118 <span class="comment">         */</span>
02119 
02120     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a254">AW_SKIP2</a>:
02121 
02122         <span class="comment">/*</span>
02123 <span class="comment">         * Try the previously active window but don't activate a shell window</span>
02124 <span class="comment">         */</span>
02125         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02126                 &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a1228">FBadWindow</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>)
02127                 <span class="comment">/*</span>
02128 <span class="comment">                 * Bug 290129 - joejo</span>
02129 <span class="comment">                 *</span>
02130 <span class="comment">                 * Test for WFBOTTOMMOST as opposed to WEFTOOLWINDOW to fix</span>
02131 <span class="comment">                 * issue with Office2000 assistant and balloon help.</span>
02132 <span class="comment">                 */</span>
02133                 &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>, WFBOTTOMMOST)) {
02134 
02135             pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>;
02136             <span class="keywordflow">break</span>;
02137         }
02138 
02139         {
02140             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSave = pwnd;
02141             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags = <a class="code" href="../../d4/d1/userk_8h.html#a516">NTW_IGNORETOOLWINDOW</a>;
02142 
02143 TryAgain:
02144             <span class="comment">/*</span>
02145 <span class="comment">             * Find a new active window from the top-level window list,</span>
02146 <span class="comment">             * skip tool windows the first time through.</span>
02147 <span class="comment">             */</span>
02148             pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1231">NextTopWindow</a>(ptiCurrent, pwndSave, (cmd == AW_SKIP ? pwndSave : NULL),
02149                                  flags);
02150 
02151             <span class="keywordflow">if</span> (pwnd) {
02152                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1228">FBadWindow</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>))
02153                     pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>;
02154             } <span class="keywordflow">else</span> {
02155                 <span class="keywordflow">if</span> (flags == <a class="code" href="../../d4/d1/userk_8h.html#a516">NTW_IGNORETOOLWINDOW</a>) {
02156                     flags = 0;
02157                     <span class="keywordflow">goto</span> TryAgain;
02158                 }
02159             }
02160         }
02161 
02162 
02163     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a250">AW_USE</a>:
02164         <span class="keywordflow">break</span>;
02165 
02166     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a255">AW_USE2</a>:
02167         fFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a511">ATW_MOUSE</a>;
02168         <span class="keywordflow">break</span>;
02169 
02170     <span class="keywordflow">default</span>:
02171         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02172     }
02173 
02174     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02175         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02176 
02177     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
02178 
02179     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
02180         <span class="comment">/*</span>
02181 <span class="comment">         * Activation is within this queue. Usually this means just do</span>
02182 <span class="comment">         * all the normal message sending. But if this queue isn't the</span>
02183 <span class="comment">         * foreground queue, check to see if it is allowed to become</span>
02184 <span class="comment">         * foreground.</span>
02185 <span class="comment">         */</span>
02186 
02187         <span class="comment">/*</span>
02188 <span class="comment">         * Sometimes processes are granted the right to foreground</span>
02189 <span class="comment">         * activate themselves, if they aren't foreground, like</span>
02190 <span class="comment">         * when starting up (there are other cases). Grant this if</span>
02191 <span class="comment">         * this process is allowed.</span>
02192 <span class="comment">         */</span>
02193 
02194          <span class="comment">/*</span>
02195 <span class="comment">          * Removed the first clause from the following if statement</span>
02196 <span class="comment">          * if (pti-&gt;pq == gpqForeground || !FAllowForegroundActivate(pti-&gt;pq)) {</span>
02197 <span class="comment">          * This fixes the problem where foreground app A activates app B</span>
02198 <span class="comment">          * the user switches to app C, then B does something to activate A</span>
02199 <span class="comment">          * (like destroy an owned window).  A now comes to the foreground</span>
02200 <span class="comment">          * unexpectedly. This clause is not in Win95 code and was added in</span>
02201 <span class="comment">          * 3.51 code to fix some test script hang (Bug 7461)</span>
02202 <span class="comment">          */</span>
02203 
02204         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/focusact_8c.html#a15">FAllowForegroundActivate</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, pwnd)) {
02205             fSuccess = <a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(pwnd, 0, fFlags);
02206             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02207             <span class="keywordflow">return</span> fSuccess;
02208         }
02209 
02210         fAllowForeground = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02211         <span class="comment">/*</span>
02212 <span class="comment">         * If this thread doesn't have any top-level non-minimized visible windows,</span>
02213 <span class="comment">         *  let it keep the right since it's probably not done with activation yet.</span>
02214 <span class="comment">         * Bug 274383 - joejo</span>
02215 <span class="comment">         */</span>
02216         fSetForegroundRight = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a> == 0);
02217 
02218     } <span class="keywordflow">else</span> {
02219         <span class="comment">/*</span>
02220 <span class="comment">         * If the caller is in the foreground, it has the right to change</span>
02221 <span class="comment">         * the foreground itself.</span>
02222 <span class="comment">         */</span>
02223         fAllowForeground = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)
02224                                 || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02225         <span class="comment">/*</span>
02226 <span class="comment">         * Give the right to change the foreground to this thread only if it already</span>
02227 <span class="comment">         *  has it, it has more visible windows or this is an explicit request to</span>
02228 <span class="comment">         *  activate the given window.</span>
02229 <span class="comment">         * When an app destroys/hides the active (foreground) window, we choose a new</span>
02230 <span class="comment">         *  active window and will probably hit this code. We don't want to give them the</span>
02231 <span class="comment">         *  right to change the foreground in this case since it's us making the activation</span>
02232 <span class="comment">         *  (See comments below). We let them keep the right so apps destroying their last</span>
02233 <span class="comment">         *  visible window (ie a splash initialization window) can take the foreground again</span>
02234 <span class="comment">         *  when they create another window (the main window).</span>
02235 <span class="comment">         */</span>
02236         <span class="keywordflow">if</span> (fAllowForeground) {
02237             fSetForegroundRight = ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>)
02238                                         || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a> != 0)
02239                                         || (cmd == <a class="code" href="../../d4/d1/userk_8h.html#a250">AW_USE</a>));
02240         } <span class="keywordflow">else</span> {
02241             fSetForegroundRight = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02242         }
02243     }
02244 
02245     fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02246     <span class="keywordflow">if</span> (fAllowForeground) {
02247         <span class="comment">/*</span>
02248 <span class="comment">         * Hack! Temporarily give this thread a foreground right to make sure</span>
02249 <span class="comment">         *  this call succeds.</span>
02250 <span class="comment">         */</span>
02251         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
02252         TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxActivateWindow temporarly set TIF %#p"</span>, ptiCurrent);
02253         fSuccess = <a class="code" href="../../d4/d1/userk_8h.html#a1665">xxxSetForegroundWindow</a>(pwnd, (cmd == AW_USE));
02254 
02255         <span class="keywordflow">if</span> (fSetForegroundRight) {
02256             <span class="comment">/*</span>
02257 <span class="comment">             * We activated some other app on purpose. If so that means this</span>
02258 <span class="comment">             * thread is probably controlling this window and will probably want</span>
02259 <span class="comment">             * to set itself active and foreground really soon again (for example,</span>
02260 <span class="comment">             * a setup program doing dde to progman). A real live case: wingz -</span>
02261 <span class="comment">             * bring up page setup..., options..., ok, ok. Under Win3.1 the</span>
02262 <span class="comment">             * activation goes somewhere strange and then wingz calls</span>
02263 <span class="comment">             * SetActiveWindow() to bring it back. This'll make sure that works.</span>
02264 <span class="comment">             *</span>
02265 <span class="comment">             * We used to set this before calling xxxSetForegeroundWindow above.</span>
02266 <span class="comment">             * This would cause callers doing an intra-queue activation to</span>
02267 <span class="comment">             *  retain their foreground right eventhough it is supposed to be</span>
02268 <span class="comment">             *  a one shot deal (that's why FAllowForeground clears the bits).</span>
02269 <span class="comment">             * In addtion, xxxSetForegroundWindow might clear the bits (it didnt'</span>
02270 <span class="comment">             *  used to); so we do it here, and only if we did an inter-queue</span>
02271 <span class="comment">             *  activation</span>
02272 <span class="comment">             */</span>
02273             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
02274             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxActivateWindow set TIF %#p"</span>, ptiCurrent);
02275         } <span class="keywordflow">else</span> {
02276             <span class="comment">/*</span>
02277 <span class="comment">             * Make sure to remove the temporary right.</span>
02278 <span class="comment">             */</span>
02279             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
02280             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxActivateWindow clear TIF %#p"</span>, ptiCurrent);
02281         }
02282     }
02283 
02284     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02285     <span class="keywordflow">return</span> fSuccess;
02286 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="focusact.c::xxxAllowSetForegroundWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxAllowSetForegroundWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>dwProcessId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01101">1101</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01056">CanForceForeground()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00198">glinp</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04503">LockProcessByClientId()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00084">PpiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00089">PpiFromProcess</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03262">tagLASTINPUT::ptiLastWoken</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03474">tagPROCESSINFO::ptiList</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l04486">UnlockProcess</a>.
<p>
<pre class="fragment"><div>01103 {
01104     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
01105     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>;
01106     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01107     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
01108     <span class="comment">/*</span>
01109 <span class="comment">     * Get the ppi for dwProcessId</span>
01110 <span class="comment">     * ASFW_ANY NULLs out the input owner so any process can take the foreground</span>
01111 <span class="comment">     */</span>
01112     <span class="keywordflow">if</span> (dwProcessId != ASFW_ANY) {
01113         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01114         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1258">LockProcessByClientId</a>((HANDLE)LongToHandle( dwProcessId ), &amp;pep);
01115         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01116         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01117             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
01118             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01119         }
01120         ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(pep);
01121         <span class="keywordflow">if</span> (ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01122             dwError = ERROR_INVALID_PARAMETER;
01123             <span class="keywordflow">goto</span> UnlockAndFail;
01124         }
01125     }
01126     <span class="comment">/*</span>
01127 <span class="comment">     * Do nothing if the current process cannot force a foreground change.</span>
01128 <span class="comment">     * We could have checked this upfront but we didn't since we had to</span>
01129 <span class="comment">     *  leave the crit section and the state could have changed.</span>
01130 <span class="comment">     */</span>
01131     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1663">CanForceForeground</a>(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>())) {
01132         dwError = ERROR_ACCESS_DENIED;
01133         <span class="keywordflow">goto</span> UnlockAndFail;
01134     }
01135     <span class="comment">/*</span>
01136 <span class="comment">     * Let's make a thread (if any) of this process be the last input owner</span>
01137 <span class="comment">     */</span>
01138     <span class="keywordflow">if</span> (dwProcessId != ASFW_ANY) {
01139         TAGMSG2(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxAllowSetForegroundWindow by %#p to %#p"</span>, <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>(), ppi);
01140         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>;
01141         <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(pep);
01142     } <span class="keywordflow">else</span> {
01143         TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxAllowSetForegroundWindow by %#p to ANY"</span>, <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>());
01144         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01145     }
01146     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01147 
01148 UnlockAndFail:
01149     <span class="keywordflow">if</span> (dwProcessId != ASFW_ANY) {
01150         <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(pep);
01151     }
01152     RIPERR0(dwError, RIP_VERBOSE, <span class="stringliteral">""</span>);
01153     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01154 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="focusact.c::xxxCheckFocus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxCheckFocus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l02549">2549</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03124">tagQ::caret</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02901">tagCARET::spwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03110">tagQ::spwndFocus</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01745">tagWND::spwndParent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02561">TestwndChild</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01815">xxxSetFocus()</a>, and <a class="el" href="../../d5/d4/caret_8c-source.html#l00234">zzzDestroyCaret()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/createw_8c-source.html#l02053">xxxDW_SendDestroyMessages()</a>, and <a class="el" href="../../d1/d8/showwin_8c-source.html#l00085">xxxShowWindow()</a>.
<p>
<pre class="fragment"><div>02551 {
02552     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
02553     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
02554 
02555     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
02556 
02557     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02558 
02559     <span class="keywordflow">if</span> (pwnd == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>) {
02560 
02561         <span class="comment">/*</span>
02562 <span class="comment">         * Set focus to parent of child window.</span>
02563 <span class="comment">         */</span>
02564         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
02565             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, &amp;tlpwndParent);
02566             <a class="code" href="../../d4/d1/userk_8h.html#a1662">xxxSetFocus</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>);
02567             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
02568         } <span class="keywordflow">else</span> {
02569             <a class="code" href="../../d4/d1/userk_8h.html#a1662">xxxSetFocus</a>(NULL);
02570         }
02571     }
02572 
02573     <span class="keywordflow">if</span> (pwnd == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>.<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a>) {
02574         <a class="code" href="../../d4/d5/caret_8c.html#a3">zzzDestroyCaret</a>();
02575     }
02576 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="focusact.c::xxxDeactivate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxDeactivate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>tidSetForeground</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l00034">34</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d4/d1/userk_8h.html#a816">AAS</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03634">BWL_ENUMLIST</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02557">ClrWF</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02336">tagAAS::fActivating</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02337">tagAAS::fQueueNotify</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00591">IS_IME_ENABLED</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02334">tagAAS::ptiNotify</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04578">SetWakeBit()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03112">tagQ::spwndActivePrev</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03109">tagQ::spwndCapture</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03110">tagQ::spwndFocus</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00365">ThreadLockAlwaysWithPti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01692">ThreadLockPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01699">ThreadUnlockPti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02335">tagAAS::tidActDeact</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02835">TIF_INACTIVATEAPPMSG</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02267">WFFRAMEON</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02420">WFMINIMIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00847">WNDENUMPROC_PWND</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00336">xxxActivateApp()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00405">xxxFocusSetInputContext()</a>, <a class="el" href="../../d5/d6/enumwin_8c-source.html#l00040">xxxInternalEnumWindow()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
<pre class="fragment"><div>00037 {
00038     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndLose;
00039     <a class="code" href="../../d8/d7/structtagAAS.html">AAS</a> aas;
00040     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndCapture;
00041     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndChild;
00042     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndLose;
00043     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpti;
00044     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlptiLose;
00045     WPARAM wParam;
00046     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiLose;
00047     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00048     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSetActivateAppBit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00049 
00050     <span class="comment">/*</span>
00051 <span class="comment">     * If we're not active, we have nothing to deactivate, so just return.</span>
00052 <span class="comment">     * If we don't return, we'll send redundant WM_ACTIVATEAPP messages.</span>
00053 <span class="comment">     * Micrografx Draw, for example, calls FreeProcInstance() twice when</span>
00054 <span class="comment">     * this occurs, thereby crashing.</span>
00055 <span class="comment">     */</span>
00056     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00057         <span class="keywordflow">return</span>;
00058 
00059     <span class="comment">/*</span>
00060 <span class="comment">     * If pti != ptiCurrent, thread lock pti because we may leave</span>
00061 <span class="comment">     * the critical section.</span>
00062 <span class="comment">     */</span>
00063     <span class="keywordflow">if</span> (pti != ptiCurrent)
00064         <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, pti, &amp;tlpti);
00065 
00066     <span class="comment">/*</span>
00067 <span class="comment">     * Prevent an activating WM_ACTIVATEAPP from being sent</span>
00068 <span class="comment">     * while we're processing this event.</span>
00069 <span class="comment">     */</span>
00070     <span class="keywordflow">if</span> (!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a803">TIF_INACTIVATEAPPMSG</a>)) {
00071         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a803">TIF_INACTIVATEAPPMSG</a>;
00072         fSetActivateAppBit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00073     }
00074 
00075     <span class="comment">/*</span>
00076 <span class="comment">     * Cancel any modes like move/size and menu tracking.</span>
00077 <span class="comment">     */</span>
00078     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00079         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>, &amp;tlpwndCapture);
00080         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>, WM_CANCELMODE, 0, 0);
00081         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndCapture);
00082 
00083         <span class="comment">/*</span>
00084 <span class="comment">         * Set QS_MOUSEMOVE so any sleeping modal loops,</span>
00085 <span class="comment">         * like the move/size code, will wake up and figure</span>
00086 <span class="comment">         * out that it should abort.</span>
00087 <span class="comment">         */</span>
00088         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_MOUSEMOVE);
00089     }
00090 
00091     <span class="comment">/*</span>
00092 <span class="comment">     * See the comments in xxxActivateThisWindow about Harvard Graphics.</span>
00093 <span class="comment">     * WinWord's Equation editor does some games when it gets the WM_ACTIVATE</span>
00094 <span class="comment">     * so we have to remember to send the WM_ACTIVATEAPP to ptiLose. 22510</span>
00095 <span class="comment">     */</span>
00096     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00097         pwndLose = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
00098         ptiLose = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndLose);
00099 
00100         <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, ptiLose, &amp;tlptiLose);
00101         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndLose, &amp;tlpwndLose);
00102         wParam = MAKELONG(WA_INACTIVE, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndLose, WFMINIMIZED));
00103         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndLose, WM_NCACTIVATE, WA_INACTIVE, 0)) {
00104             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndLose);
00105             <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlptiLose);
00106             <span class="keywordflow">goto</span> Exit;
00107         }
00108         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndLose, WM_ACTIVATE, wParam, 0);
00109 
00110         <span class="comment">/*</span>
00111 <span class="comment">         * Only update the queue's active windows if they weren't</span>
00112 <span class="comment">         * changed while we were off calling SendMessage.</span>
00113 <span class="comment">         */</span>
00114         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == pwndLose) {
00115             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
00116             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
00117         }
00118 
00119         <span class="comment">/*</span>
00120 <span class="comment">         * The flag WFFRAMEON is cleared in the default processing of</span>
00121 <span class="comment">         * WM_NCACTIVATE message.</span>
00122 <span class="comment">         * We want to clear this flag again here since it might of been</span>
00123 <span class="comment">         * set in xxxSendNCPaint.</span>
00124 <span class="comment">         * Pbrush calls DrawMenuBar when it gets the WM_ACTIVATE message</span>
00125 <span class="comment">         * sent above and this causes xxxSendNCPaint to get called and the</span>
00126 <span class="comment">         * WFFRAMEON flag gets reset.</span>
00127 <span class="comment">         */</span>
00128         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndLose, WFFRAMEON);
00129         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndLose);
00130 
00131         <span class="comment">/*</span>
00132 <span class="comment">         * Revalidate ptiLose because the thread may have gone away</span>
00133 <span class="comment">         * when the activation messages were sent above.</span>
00134 <span class="comment">         */</span>
00135         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o0">ptiNotify</a> = (ptiLose-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : ptiLose;
00136         <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlptiLose);
00137     } <span class="keywordflow">else</span> {
00138 
00139         <span class="comment">/*</span>
00140 <span class="comment">         * Use a non-NULL special value for the test after</span>
00141 <span class="comment">         * the xxxActivateApp calls.</span>
00142 <span class="comment">         */</span>
00143         pwndLose = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)-1;
00144         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o0">ptiNotify</a> = pti;
00145     }
00146 
00147     <span class="keywordflow">if</span> (aas.<a class="code" href="../../d8/d7/structtagAAS.html#o0">ptiNotify</a>) {
00148         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o1">tidActDeact</a> = tidSetForeground;
00149         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o2">fActivating</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00150         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o3">fQueueNotify</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00151 
00152         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent,
00153                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, &amp;tlpwndChild);
00154         <a class="code" href="../../d4/d1/userk_8h.html#a1428">xxxInternalEnumWindow</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>,
00155                 (WNDENUMPROC_PWND)xxxActivateApp, (LPARAM)&amp;aas, BWL_ENUMLIST);
00156         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndChild);
00157     }
00158 
00159     <span class="comment">/*</span>
00160 <span class="comment">     * If an app (i.e. Harvard Graphics/Windows Install) tries to</span>
00161 <span class="comment">     * reactivate itself during a deactivating WM_ACTIVATEAPP</span>
00162 <span class="comment">     * message, force deactivation.</span>
00163 <span class="comment">     */</span>
00164     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == pwndLose) {
00165 
00166         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndLose, &amp;tlpwndLose);
00167         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndLose, WM_NCACTIVATE, WA_INACTIVE, 0)) {
00168             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndLose);
00169             <span class="keywordflow">goto</span> Exit;
00170         }
00171         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndLose, WM_ACTIVATE, WA_INACTIVE, 0);
00172         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndLose);
00173 
00174         <span class="comment">/*</span>
00175 <span class="comment">         * Only update the queue's active windows if they weren't</span>
00176 <span class="comment">         * changed while we were off calling SendMessage.</span>
00177 <span class="comment">         */</span>
00178         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == pwndLose) {
00179             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
00180             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
00181         }
00182     }
00183 
00184     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00185         pwndLose = <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
00186         <span class="keywordflow">if</span> (pwndLose != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00187             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndLose, &amp;tlpwndLose);
00188             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndLose, WM_KILLFOCUS, 0, 0);
00189 <span class="preprocessor">#ifdef FE_IME</span>
00190 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00191                 <a class="code" href="../../d4/d1/userk_8h.html#a2036">xxxFocusSetInputContext</a>(pwndLose, FALSE, FALSE);
00192             }
00193 <span class="preprocessor">#endif</span>
00194 <span class="preprocessor"></span>            <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndLose);
00195         }
00196     }
00197 
00198 Exit:
00199     <span class="keywordflow">if</span> (fSetActivateAppBit) {
00200         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a803">TIF_INACTIVATEAPPMSG</a>;
00201     }
00202     <span class="keywordflow">if</span> (pti != ptiCurrent)
00203         <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlpti);
00204 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="focusact.c::xxxSendFocusMessages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxSendFocusMessages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndReceive</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l00220">220</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01265">FWINABLE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01515">HWq</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00591">IS_IME_ENABLED</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03129">tagQ::QF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03021">QF_FOCUSNULLSINCEACTIVE</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02588">SetForegroundThread()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03110">tagQ::spwndFocus</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02304">WFDESTROYED</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00405">xxxFocusSetInputContext()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00274">xxxWindowEvent()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01815">xxxSetFocus()</a>.
<p>
<pre class="fragment"><div>00223 {
00224     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndLose;
00225     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndLose;
00226 
00227     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndReceive);
00228 
00229     <span class="comment">/*</span>
00230 <span class="comment">     * Remember if this app set the focus to NULL on purpose after it was</span>
00231 <span class="comment">     * activated (needed in ActivateThisWindow()).</span>
00232 <span class="comment">     */</span>
00233     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a866">QF_FOCUSNULLSINCEACTIVE</a>;
00234     <span class="keywordflow">if</span> (pwndReceive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00235         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a866">QF_FOCUSNULLSINCEACTIVE</a>;
00236 
00237     pwndLose = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
00238     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, pwndLose, &amp;tlpwndLose);
00239 
00240     <span class="comment">/*</span>
00241 <span class="comment">     * We shouldn't be locking a valid pwnd from another queue.</span>
00242 <span class="comment">     */</span>
00243     UserAssert((pwndReceive == NULL)
00244                     || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndReceive, WFDESTROYED)
00245                     || (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndReceive)-&gt;pq));
00246     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>, pwndReceive);
00247 
00248     <span class="keywordflow">if</span> (pwndReceive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00249         <span class="keywordflow">if</span> (pwndLose != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00250             <span class="comment">/*</span>
00251 <span class="comment">             * Tell the client that nobody is gaining focus.</span>
00252 <span class="comment">             */</span>
00253             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00254                 <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_FOCUS, NULL, OBJID_CLIENT, INDEXID_OBJECT, 0);
00255             }
00256             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndLose, WM_KILLFOCUS, 0, 0);
00257 <span class="preprocessor">#ifdef FE_IME</span>
00258 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00259                 <a class="code" href="../../d4/d1/userk_8h.html#a2036">xxxFocusSetInputContext</a>(pwndLose, FALSE, FALSE);
00260             }
00261 <span class="preprocessor">#endif</span>
00262 <span class="preprocessor"></span>        }
00263     } <span class="keywordflow">else</span> {
00264 
00265         <span class="comment">/*</span>
00266 <span class="comment">         * Make this thread foreground so its base</span>
00267 <span class="comment">         * priority get set higher.</span>
00268 <span class="comment">         */</span>
00269         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)
00270             <a class="code" href="../../d4/d1/userk_8h.html#a1226">SetForegroundThread</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndReceive));
00271 
00272         <span class="keywordflow">if</span> (pwndLose != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00273             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndLose, WM_KILLFOCUS, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndReceive), 0);
00274 <span class="preprocessor">#ifdef FE_IME</span>
00275 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00276                 <a class="code" href="../../d4/d1/userk_8h.html#a2036">xxxFocusSetInputContext</a>(pwndLose, FALSE, FALSE);
00277             }
00278 <span class="preprocessor">#endif</span>
00279 <span class="preprocessor"></span>        }
00280 
00281         <span class="comment">/*</span>
00282 <span class="comment">         * Send the WM_SETFOCUS message, but only if the window we're</span>
00283 <span class="comment">         * setting the focus to still has the focus!  This allows apps</span>
00284 <span class="comment">         * to prevent themselves from losing the focus by catching</span>
00285 <span class="comment">         * the WM_NCACTIVATE message and returning FALSE or by calling</span>
00286 <span class="comment">         * SetFocus() inside their WM_KILLFOCUS handler.</span>
00287 <span class="comment">         */</span>
00288         <span class="keywordflow">if</span> (pwndReceive == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>) {
00289 <span class="preprocessor">#ifdef FE_IME</span>
00290 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00291                 <a class="code" href="../../d4/d1/userk_8h.html#a2036">xxxFocusSetInputContext</a>(pwndReceive, TRUE, FALSE);
00292             }
00293 <span class="preprocessor">#endif</span>
00294 <span class="preprocessor"></span>            <span class="comment">/*</span>
00295 <span class="comment">             * We have to do this BEFORE sending the WM_SETFOCUS message.</span>
00296 <span class="comment">             * The app, upon receiving it, very well may turn around and</span>
00297 <span class="comment">             * SetFocus() to a child window.</span>
00298 <span class="comment">             */</span>
00299             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00300                 <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_FOCUS, pwndReceive, OBJID_CLIENT,
00301                         INDEXID_OBJECT, 0);
00302             }
00303             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndReceive, WM_SETFOCUS, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndLose), 0);
00304         }
00305     }
00306 
00307     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndLose);
00308 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="focusact.c::xxxSetActiveWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> xxxSetActiveWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01990">1990</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02323">AW_USE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00194">RevalidateHwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">xxxActivateWindow()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05801">NtUserSetActiveWindow()</a>, and <a class="el" href="../../d9/d2/dwp_8c-source.html#l00402">xxxDWP_SetCursor()</a>.
<p>
<pre class="fragment"><div>01992 {
01993     HWND hwndActiveOld;
01994     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01995 
01996     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01997 
01998     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01999 
02000     <span class="comment">/*</span>
02001 <span class="comment">     * 32 bit apps must call SetForegroundWindow (to be NT 3.1 compatible)</span>
02002 <span class="comment">     * but 16 bit apps that are foreground can make other apps foreground.</span>
02003 <span class="comment">     * xxxActivateWindow makes sure an app is foreground.</span>
02004 <span class="comment">     */</span>
02005     <span class="keywordflow">if</span> (!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)) {
02006         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02007     }
02008 
02009     hwndActiveOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
02010 
02011     <a class="code" href="../../d4/d1/userk_8h.html#a1230">xxxActivateWindow</a>(pwnd, AW_USE);
02012 
02013     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndActiveOld);
02014 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="focusact.c::xxxSetFocus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> xxxSetFocus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01815">1815</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01761">FAllowForegroundActivate()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00165">gLCIDSentToShell</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02508">tagKL::hkl</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01515">HWq</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l01266">IsHooked</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00194">RevalidateHwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04437">SFW_SETFOCUS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03323">tagTHREADINFO::spklActive</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03110">tagQ::spwndFocus</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01745">tagWND::spwndParent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02561">TestwndChild</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02418">WFDISABLED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02420">WFMINIMIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02037">WHF_CBT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02042">WHF_SHELL</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00220">xxxSendFocusMessages()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05902">NtUserSetFocus()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02549">xxxCheckFocus()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l00228">xxxDWP_ProcessVirtKey()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00184">xxxEnableWindow()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, and <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02582">xxxSBWndProc()</a>.
<p>
<pre class="fragment"><div>01817 {
01818     HWND hwndTemp;
01819     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01820     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiActiveKL;
01821     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTemp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01822     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndTemp;
01823 
01824     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01825     <span class="comment">/*</span>
01826 <span class="comment">     * Special case if we are setting the focus to a null window.</span>
01827 <span class="comment">     */</span>
01828     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01829         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_CBT) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_SETFOCUS, 0,
01830                 (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>), WH_CBT)) {
01831             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01832         }
01833 
01834         <span class="comment">/*</span>
01835 <span class="comment">         * Save old focus so that we can return it.</span>
01836 <span class="comment">         */</span>
01837         hwndTemp = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
01838         <a class="code" href="../../d4/d1/userk_8h.html#a1227">xxxSendFocusMessages</a>(ptiCurrent, pwnd);
01839         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndTemp);
01840     }
01841 
01842     <span class="comment">/*</span>
01843 <span class="comment">     * We no longer allow inter-thread set focuses.</span>
01844 <span class="comment">     */</span>
01845     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01846         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01847     }
01848 
01849     <span class="comment">/*</span>
01850 <span class="comment">     * If the window recieving the focus or any of its ancestors is either</span>
01851 <span class="comment">     * minimized or disabled, don't set the focus.</span>
01852 <span class="comment">     */</span>
01853     <span class="keywordflow">for</span> (pwndTemp = pwnd; pwndTemp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndTemp = pwndTemp-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
01854         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTemp, WFMINIMIZED) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTemp, WFDISABLED)) {
01855 
01856             <span class="comment">/*</span>
01857 <span class="comment">             * Don't change the focus if going to a minimized or disabled</span>
01858 <span class="comment">             * window.</span>
01859 <span class="comment">             */</span>
01860             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01861         }
01862 
01863         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndTemp)) {
01864             <span class="keywordflow">break</span>;
01865         }
01866     }
01867     UserAssert(pwndTemp != NULL);
01868 
01869     <span class="comment">/*</span>
01870 <span class="comment">     * pwndTemp should now be the top level ancestor of pwnd.</span>
01871 <span class="comment">     */</span>
01872     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndTemp, &amp;tlpwndTemp);
01873     <span class="keywordflow">if</span> (pwnd != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>) {
01874         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_CBT) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_SETFOCUS, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd),
01875                 (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>), WH_CBT)) {
01876             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTemp);
01877             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01878         }
01879 
01880         <span class="comment">/*</span>
01881 <span class="comment">         * Activation must follow the focus.  That is, setting the focus to</span>
01882 <span class="comment">         * a particualr window means that the top-level parent of this window</span>
01883 <span class="comment">         * must be the active window (top-level parent is determined by</span>
01884 <span class="comment">         * following the parent chain until you hit a top-level guy).  So,</span>
01885 <span class="comment">         * we must activate this top-level parent if it is different than</span>
01886 <span class="comment">         * the current active window.</span>
01887 <span class="comment">         *</span>
01888 <span class="comment">         * Only change activation if top-level parent is not the currently</span>
01889 <span class="comment">         * active window.</span>
01890 <span class="comment">         */</span>
01891         <span class="keywordflow">if</span> (pwndTemp != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) {
01892 
01893             <span class="comment">/*</span>
01894 <span class="comment">             * If this app is not in the foreground, see if foreground</span>
01895 <span class="comment">             * activation is allowed.</span>
01896 <span class="comment">             */</span>
01897             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/focusact_8c.html#a15">FAllowForegroundActivate</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, pwndTemp)) {
01898                 <span class="comment">/*</span>
01899 <span class="comment">                 * If the process lost the foreground activation right by giving</span>
01900 <span class="comment">                 * focus to a hidden window, then give it the right back. See</span>
01901 <span class="comment">                 * bug #401932 for how this might affect an app</span>
01902 <span class="comment">                 */</span>
01903                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTemp, WFVISIBLE)){
01904                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags |= W32PF_ALLOWFOREGROUNDACTIVATE;
01905                 }
01906                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwndTemp, ptiCurrent, SFW_SETFOCUS)) {
01907                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTemp);
01908                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01909                 }
01910             }
01911 
01912             <span class="comment">/*</span>
01913 <span class="comment">             * This will return FALSE if something goes wrong.</span>
01914 <span class="comment">             */</span>
01915             <span class="keywordflow">if</span> (pwndTemp != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) {
01916                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(pwndTemp, 0, 0)) {
01917                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTemp);
01918                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01919                 }
01920             }
01921         }
01922 
01923         <span class="comment">/*</span>
01924 <span class="comment">         * Save current pwndFocus since we must return this.</span>
01925 <span class="comment">         */</span>
01926         pwndTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
01927         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTemp);
01928         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndTemp, &amp;tlpwndTemp);
01929 
01930         <span class="comment">/*</span>
01931 <span class="comment">         * Change the global pwndFocus and send the WM_{SET/KILL}FOCUS</span>
01932 <span class="comment">         * messages.</span>
01933 <span class="comment">         */</span>
01934         <a class="code" href="../../d4/d1/userk_8h.html#a1227">xxxSendFocusMessages</a>(ptiCurrent, pwnd);
01935 
01936     } <span class="keywordflow">else</span> {
01937         pwndTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
01938     }
01939 
01940     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>) {
01941         <span class="comment">/*</span>
01942 <span class="comment">         * For the shell notification hook, we should use the pti-&gt;spkl</span>
01943 <span class="comment">         * of the window with the focus. This could be a different thread,</span>
01944 <span class="comment">         * (or even different process) when the queue is attached. The typical</span>
01945 <span class="comment">         * case would be OLE out-of-process server.</span>
01946 <span class="comment">         * #352877</span>
01947 <span class="comment">         */</span>
01948         ptiActiveKL = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
01949     } <span class="keywordflow">else</span> {
01950         <span class="comment">/*</span>
01951 <span class="comment">         * Preserving the NT4 behavior, otherwise.</span>
01952 <span class="comment">         */</span>
01953         ptiActiveKL = ptiCurrent;
01954     }
01955     UserAssert(ptiActiveKL);
01956 
01957     <span class="comment">/*</span>
01958 <span class="comment">     * Update the keyboard icon on the tray if the layout changed during focus change.</span>
01959 <span class="comment">     * Before winlogon loads kbd layouts, pti-&gt;spkActive is NULL. #99321</span>
01960 <span class="comment">     */</span>
01961     <span class="keywordflow">if</span> (ptiActiveKL-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>) {
01962         HKL hklActive = ptiActiveKL-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01963 
01964         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a63">gLCIDSentToShell</a> != hklActive) &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_SHELL)) {
01965             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a63">gLCIDSentToShell</a> = hklActive;
01966             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_LANGUAGE, (WPARAM)NULL, (LPARAM)hklActive, WH_SHELL);
01967         }
01968     }
01969 
01970     hwndTemp = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndTemp);
01971     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTemp);
01972 
01973     <span class="comment">/*</span>
01974 <span class="comment">     * Return the pwnd of the window that lost the focus.</span>
01975 <span class="comment">     * Return the validated hwndTemp: since we locked/unlocked pwndTemp,</span>
01976 <span class="comment">     * it may be gone.</span>
01977 <span class="comment">     */</span>
01978     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndTemp);
01979 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="focusact.c::xxxSetForegroundWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxSetForegroundWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fFlash</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01235">1235</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02323">AW_USE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01056">CanForceForeground()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00069">DSW_GetTopLevelCreatorWindow()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01717">FRemoveForegroundActivate()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00817">GetTopLevelWindow()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07033">GiveUpForeground()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00200">gppiInputProvider</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00256">gppiWantForegroundPriority</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01515">HWq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07022">IsForegroundLocked()</a>, <a class="el" href="../../d9/d6/winloop2_8c-source.html#l00062">IsTrayWindow()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02068">PostEventMessage()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02993">QEVENT_ACTIVATE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02831">TIF_ALLOWFOREGROUNDACTIVATE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02829">TIF_CSRSSTHREAD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02828">TIF_SYSTEMTHREAD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07066">UP</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">xxxActivateWindow()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00027">xxxFlashWindow()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/minmax_8c-source.html#l01218">xxxActivateOnMinimize()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">xxxActivateWindow()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l04022">xxxMenuWindowProc()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l02121">xxxOldNextWindow()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01230">xxxStubSetForegroundWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00253">xxxSwitchToThisWindow()</a>, and <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00193">xxxSysCommand()</a>.
<p>
<pre class="fragment"><div>01238 {
01239     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNiceCall = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01240     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSyncActivate, fActive;
01241     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFlashFlags;
01242     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01243     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFlash;
01244     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndFlash;
01245 
01246     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01247 
01248     <span class="comment">/*</span>
01249 <span class="comment">     * If we're trying to set a window on our own thread to the foreground,</span>
01250 <span class="comment">     * and we're already in the foreground, treat it just like a call to</span>
01251 <span class="comment">     * SetActiveWindow().</span>
01252 <span class="comment">     */</span>
01253     <span class="keywordflow">if</span> ((pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)) {
01254         fSyncActivate = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
01255         <span class="keywordflow">if</span> (fSyncActivate) {
01256             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a111">gppiWantForegroundPriority</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
01257         } <span class="keywordflow">else</span> {
01258             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a111">gppiWantForegroundPriority</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi;
01259         }
01260 
01261         <span class="keywordflow">goto</span> JustActivateIt;
01262     }
01263     <span class="comment">/*</span>
01264 <span class="comment">     * If the foregrond is not locked</span>
01265 <span class="comment">     *     and this thread has the right to changethe foreground,</span>
01266 <span class="comment">     * then remove the activation right (it's a one-shot deal)</span>
01267 <span class="comment">     *      and do it.</span>
01268 <span class="comment">     */</span>
01269 
01270     <span class="comment">/*</span>
01271 <span class="comment">     * Bug 247768 - joejo</span>
01272 <span class="comment">     * Add compatibility hack for foreground activation problems.</span>
01273 <span class="comment">     *</span>
01274 <span class="comment">     * To Fix Winstone99, ignore the foreground lock if the input</span>
01275 <span class="comment">     *  provider is making this call. GerardoB.</span>
01276 <span class="comment">     *</span>
01277 <span class="comment">     */</span>
01278 
01279     <span class="keywordflow">if</span> ((!<a class="code" href="../../d4/d1/userk_8h.html#a2025">IsForegroundLocked</a>() || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a80">gppiInputProvider</a>))
01280             &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)
01281                 || <a class="code" href="../../d4/d1/userk_8h.html#a1663">CanForceForeground</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)
01282                 || <a class="code" href="../../d4/d1/userk_8h.html#a2026">GiveUpForeground</a>())) {
01283 
01284         TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxSetForegroundWindow FRemoveForegroundActivate %#p"</span>, ptiCurrent);
01285 
01286         <a class="code" href="../../d4/d1/userk_8h.html#a1939">FRemoveForegroundActivate</a>(ptiCurrent);
01287         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwnd, ptiCurrent, 0);
01288     }
01289     fNiceCall = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01290     TAGMSG3(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxSetForegroundWindow: rude call by %#p to %#p-%#p"</span>,
01291             ptiCurrent, pwnd, (pwnd != NULL ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) : NULL));
01292     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01293         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01294     }
01295     <span class="comment">/*</span>
01296 <span class="comment">     * Notify the user that this pwnd wants to come to the foreground.</span>
01297 <span class="comment">     * Try to flash a tray button only; otherwise, flash pwnd</span>
01298 <span class="comment">     */</span>
01299     <span class="keywordflow">if</span> (fFlash) {
01300         pwndFlash = <a class="code" href="../../d4/d1/userk_8h.html#a1530">DSW_GetTopLevelCreatorWindow</a>(<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwnd));
01301         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwndFlash)) {
01302             dwFlashFlags = FLASHW_TRAY;
01303         } <span class="keywordflow">else</span> {
01304             pwndFlash = pwnd;
01305             dwFlashFlags = FLASHW_ALL;
01306         }
01307         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndFlash, &amp;tlpwndFlash);
01308         <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a2">xxxFlashWindow</a>(pwndFlash,
01309                        MAKELONG(dwFlashFlags | FLASHW_TIMERNOFG, <a class="code" href="../../d4/d1/userk_8h.html#a743">UP</a>(FOREGROUNDFLASHCOUNT)),
01310                        0);
01311         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndFlash);
01312     }
01313     <span class="comment">/*</span>
01314 <span class="comment">     * Activate the window.</span>
01315 <span class="comment">     */</span>
01316     fSyncActivate = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq);
01317 
01318 JustActivateIt:
01319 
01320     <span class="keywordflow">if</span> (fSyncActivate) {
01321         fActive = <a class="code" href="../../d4/d1/userk_8h.html#a1230">xxxActivateWindow</a>(pwnd, AW_USE);
01322     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq-&gt;spwndActive) {
01323         fActive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01324     } <span class="keywordflow">else</span> {
01325         fActive = <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq,
01326                                 QEVENT_ACTIVATE, NULL, 0,
01327                                 0, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd)) ;
01328     }
01329 
01330     <span class="comment">/*</span>
01331 <span class="comment">     * Return FALSE if we failed the set foreground request.</span>
01332 <span class="comment">     */</span>
01333     <span class="keywordflow">return</span> fNiceCall &amp;&amp; fActive;
01334 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="focusact.c::xxxSetForegroundWindow2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxSetForegroundWindow2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>fFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">1342</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d7/d2/queue_8c-source.html#l03208">AllocQEntry()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04445">ATW_SETFOCUS</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03506">CMSHUNGAPPTIMEOUT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03131">tagQ::cThreads</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00080">FHungApp()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00201">gppiLockSFW</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00256">gppiWantForegroundPriority</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00100">gpqForegroundPrev</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00091">gptiForeground</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00456">grpdeskRitInput</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01827">tagWND::head</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01477">HMIsMarkDestroy</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00802">LockWindowUpdate2()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03100">tagQ::mlInput</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03018">PEM_ACTIVATE_NOZORDER</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03017">PEM_ACTIVATE_RESTORE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03107">tagQ::ptiKeyboard</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03106">tagQ::ptiMouse</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03828">PWND_TOP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02993">QEVENT_ACTIVATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02992">QEVENT_DEACTIVATE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03023">QF_EVENTDEACTIVATEREMOVED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03129">tagQ::QF_flags</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01004">RemoveEventMessage()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02588">SetForegroundThread()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00026">SetHungFlag()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04578">SetWakeBit()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04438">SFW_ACTIVATERESTORE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04436">SFW_NOZORDER</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04437">SFW_SETFOCUS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04434">SFW_STARTUP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04435">SFW_SWITCH</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04831">StoreQMessage()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05138">StoreQMessagePti()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05262">TestUP</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00365">ThreadLockAlwaysWithPti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01692">ThreadLockPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01699">ThreadUnlockPti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01174">TID</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01175">TIDq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02299">WFREDRAWFRAMEIFHUNG</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01891">xxxCancelTracking()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00034">xxxDeactivate()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00166">xxxMakeWindowForegroundWithState()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00107">xxxRedrawHungWindowFrame()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01468">xxxSetWindowPos()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00374">xxxUpdateTray()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02187">zzzActiveCursorTracking()</a>, and <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00216">zzzClipCursor()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02327">xxxActiveWindowTracking()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00472">xxxButtonEvent()</a>, <a class="el" href="../../d4/d1/hotkeys_8c-source.html#l00434">xxxDoHotKeyStuff()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01338">xxxKeyEvent()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01675">xxxNextWindow()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01815">xxxSetFocus()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01235">xxxSetForegroundWindow()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04033">xxxSetThreadDesktop()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l03358">xxxSwitchDesktop()</a>.
<p>
<pre class="fragment"><div>01346 {
01347     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiForegroundOld;
01348     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiForegroundNew;
01349     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqForegroundOld, pqForegroundNew, pqCurrent;
01350     HWND hwnd;
01351     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgDeactivate, pqmsgActivate;
01352     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRemovedEvent;
01353     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01354     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01355     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uMsg;
01356     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01357 
01358     <span class="comment">/*</span>
01359 <span class="comment">     * Queue pointers and threadinfo pointers can go away when calling xxx</span>
01360 <span class="comment">     * calls. Also, queues can get recalced via AttachThreadInput() during</span>
01361 <span class="comment">     * xxx calls - so we want to reference the application becoming foreground.</span>
01362 <span class="comment">     * PQs cannot be refcount locked (either thread locked or structure locked)</span>
01363 <span class="comment">     * so must (re)calculate them after returning from xxx calls.</span>
01364 <span class="comment">     *</span>
01365 <span class="comment">     * NOTE: gpqForeground and gpqForegroundPrev are always current and don't</span>
01366 <span class="comment">     *       need special handling.</span>
01367 <span class="comment">     */</span>
01368 
01369     <span class="comment">/*</span>
01370 <span class="comment">     * Don't allow the foreground to be set to a window that is not</span>
01371 <span class="comment">     * on the current desktop.</span>
01372 <span class="comment">     */</span>
01373     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> ||
01374             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pwnd))) {
01375         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01376     }
01377 
01378     <span class="comment">/*</span>
01379 <span class="comment">     * Unlock SetForegroundWindow (if someone had it locked)</span>
01380 <span class="comment">     */</span>
01381     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01382     TAGMSG3(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxSetForegroundWindow2 by %#p to %#p-%#p"</span>,
01383             ptiCurrent, pwnd, (pwnd != NULL ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) : NULL));
01384 
01385     <span class="comment">/*</span>
01386 <span class="comment">     * Calculate who is becoming foreground. Also, remember who we want</span>
01387 <span class="comment">     * foreground (for priority setting reasons).</span>
01388 <span class="comment">     */</span>
01389     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
01390         ptiForegroundOld = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>;
01391     } <span class="keywordflow">else</span> {
01392         ptiForegroundOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01393     }
01394     pqForegroundOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01395     pqForegroundNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01396     pqCurrent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01397 
01398     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>;
01399 
01400     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01401         ptiForegroundNew = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
01402         UserAssert(ptiForegroundNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == grpdeskRitInput);
01403         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a111">gppiWantForegroundPriority</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi;
01404         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq;
01405         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> != 0);
01406         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == grpdeskRitInput);
01407         <span class="comment">// Assert to catch AV in xxxNextWindow doing Alt-Esc: If we have a non-NULL</span>
01408         <span class="comment">// gpqForeground, its kbd input thread better have an rpdesk!  -IanJa</span>
01409         UserAssert(!gpqForeground || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>));
01410         <a class="code" href="../../d4/d1/userk_8h.html#a1226">SetForegroundThread</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd));
01411     } <span class="keywordflow">else</span> {
01412         ptiForegroundNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01413         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a111">gppiWantForegroundPriority</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01414         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01415         <a class="code" href="../../d4/d1/userk_8h.html#a1226">SetForegroundThread</a>(NULL);
01416     }
01417 
01418     <span class="comment">/*</span>
01419 <span class="comment">     * Are we switching the foreground queue?</span>
01420 <span class="comment">     */</span>
01421     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>) {
01422         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlptiForegroundOld;
01423         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlptiForegroundNew;
01424         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpti;
01425 
01426         <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, ptiForegroundOld, &amp;tlptiForegroundOld);
01427         <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, ptiForegroundNew, &amp;tlptiForegroundNew);
01428         <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, pti, &amp;tlpti);
01429 
01430         <span class="comment">/*</span>
01431 <span class="comment">         * If this call didn't come from the RIT, cancel tracking</span>
01432 <span class="comment">         * and other global states.</span>
01433 <span class="comment">         */</span>
01434         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01435 
01436             <span class="comment">/*</span>
01437 <span class="comment">             * Clear any visible tracking going on in system.</span>
01438 <span class="comment">             */</span>
01439             <a class="code" href="../../d4/d1/userk_8h.html#a1514">xxxCancelTracking</a>();
01440 
01441             <span class="comment">/*</span>
01442 <span class="comment">             * Remove the clip cursor rectangle - it is a global mode that</span>
01443 <span class="comment">             * gets removed when switching.  Also remove any LockWindowUpdate()</span>
01444 <span class="comment">             * that's still around.</span>
01445 <span class="comment">             */</span>
01446             <a class="code" href="../../d4/d1/userk_8h.html#a1788">zzzClipCursor</a>(NULL);
01447             <a class="code" href="../../d4/d1/userk_8h.html#a1772">LockWindowUpdate2</a>(NULL, TRUE);
01448 
01449             <span class="comment">/*</span>
01450 <span class="comment">             * Make sure the desktop of the newly activated window is the</span>
01451 <span class="comment">             * foreground fullscreen window</span>
01452 <span class="comment">             */</span>
01453             <a class="code" href="../../d4/d1/userk_8h.html#a1756">xxxMakeWindowForegroundWithState</a>(NULL, 0);
01454         }
01455 
01456         <span class="comment">/*</span>
01457 <span class="comment">         * We've potentially done callbacks. Calculate pqForegroundOld</span>
01458 <span class="comment">         * based on our locked local variable ptiForegroundOld.</span>
01459 <span class="comment">         */</span>
01460         pqForegroundOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01461         <span class="keywordflow">if</span> (ptiForegroundOld &amp;&amp; !(ptiForegroundOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
01462             pqForegroundOld = ptiForegroundOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
01463         }
01464 
01465         pqCurrent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01466         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01467             pqCurrent = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
01468 
01469         <span class="comment">/*</span>
01470 <span class="comment">         * Now allocate message for the deactivation</span>
01471 <span class="comment">         */</span>
01472         pqmsgDeactivate = pqmsgActivate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01473 
01474         <span class="keywordflow">if</span> ((pqForegroundOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pqForegroundOld != pqCurrent)) {
01475             <span class="keywordflow">if</span> ((pqmsgDeactivate = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pqForegroundOld-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>)) ==
01476                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01477                 retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01478                 <span class="keywordflow">goto</span> Exit;
01479             }
01480         }
01481 
01482         <span class="comment">/*</span>
01483 <span class="comment">         * Do any appropriate deactivation.</span>
01484 <span class="comment">         */</span>
01485         <span class="keywordflow">if</span> (pqForegroundOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01486 
01487             <span class="comment">/*</span>
01488 <span class="comment">             * If we're already on the foreground queue we'll call</span>
01489 <span class="comment">             * xxxDeactivate() directly later in this routine since</span>
01490 <span class="comment">             * it'll cause us to leave the critical section.</span>
01491 <span class="comment">             */</span>
01492             <span class="keywordflow">if</span> (pqForegroundOld != pqCurrent) {
01493                 <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsgDeactivate, NULL, 0,
01494                         gptiForeground != NULL ? (WPARAM)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;pEThread-&gt;Cid.UniqueThread : 0,
01495                         0, 0, QEVENT_DEACTIVATE, 0);
01496 
01497                 <span class="comment">/*</span>
01498 <span class="comment">                 * If there was an old foreground thread, make it perform</span>
01499 <span class="comment">                 * the deactivation.  Otherwise, any thread on the queue</span>
01500 <span class="comment">                 * can perform the deactivation.</span>
01501 <span class="comment">                 */</span>
01502                 <span class="keywordflow">if</span> (ptiForegroundOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01503                     <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiForegroundOld, QS_EVENTSET);
01504 
01505                     <a class="code" href="../../d4/d1/userk_8h.html#a1504">StoreQMessagePti</a>(pqmsgDeactivate, ptiForegroundOld);
01506 
01507                 }
01508 
01509                 <span class="keywordflow">if</span> (pqForegroundOld-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01510                     <span class="keywordflow">if</span> (ptiForegroundOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(ptiForegroundOld, CMSHUNGAPPTIMEOUT)) {
01511                         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01512                         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pqForegroundOld-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, &amp;tlpwnd);
01513                         <a class="code" href="../../d4/d1/userk_8h.html#a1652">xxxRedrawHungWindowFrame</a>(pqForegroundOld-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, FALSE);
01514                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01515                     } <span class="keywordflow">else</span> {
01516                         <a class="code" href="../../d4/d1/userk_8h.html#a1125">SetHungFlag</a>(pqForegroundOld-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WFREDRAWFRAMEIFHUNG);
01517                     }
01518                 }
01519             }
01520         }
01521 
01522         <span class="comment">/*</span>
01523 <span class="comment">         * We've potentially done callbacks. Calculate pqForegroundNew</span>
01524 <span class="comment">         * based on our locked local variable ptiForegroundNew.</span>
01525 <span class="comment">         */</span>
01526         pqForegroundNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01527         <span class="keywordflow">if</span> (ptiForegroundNew &amp;&amp; !(ptiForegroundNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
01528             pqForegroundNew = ptiForegroundNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
01529         }
01530 
01531         <span class="comment">/*</span>
01532 <span class="comment">         * Update pqCurrent since we may have made an xxx call,</span>
01533 <span class="comment">         * and this variable may be invalid.</span>
01534 <span class="comment">         */</span>
01535         pqCurrent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01536         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01537             pqCurrent = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
01538         }
01539 
01540         <span class="keywordflow">if</span> ((pqForegroundNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pqForegroundNew != pqCurrent)) {
01541             pqmsgActivate = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pqForegroundNew-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>);
01542             <span class="keywordflow">if</span> (pqmsgActivate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01543                 retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01544                 <span class="keywordflow">goto</span> Exit;
01545             }
01546         }
01547 
01548         <span class="comment">/*</span>
01549 <span class="comment">         * Do any appropriate activation.</span>
01550 <span class="comment">         */</span>
01551         <span class="keywordflow">if</span> (pqForegroundNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01552             <span class="comment">/*</span>
01553 <span class="comment">             * We're going to activate (synchronously or async with an activate</span>
01554 <span class="comment">             * event). We want to remove the last deactivate event if there is</span>
01555 <span class="comment">             * one because this is new state. If we don't, then 1&gt; we could</span>
01556 <span class="comment">             * synchronously activate and then asynchronously deactivate,</span>
01557 <span class="comment">             * thereby processing these events out of order, or 2&gt; we could</span>
01558 <span class="comment">             * pile up a chain of deactivate / activate events which would</span>
01559 <span class="comment">             * make the titlebar flash alot if the app wasn't responding to</span>
01560 <span class="comment">             * input for awhile (in this case, it doesn't matter if we</span>
01561 <span class="comment">             * put a redundant activate in the queue, since the app is already</span>
01562 <span class="comment">             * active. Remove all deactivate events because this app is</span>
01563 <span class="comment">             * setting a state that is not meant to be synchronized with</span>
01564 <span class="comment">             * existing queued input.</span>
01565 <span class="comment">             *</span>
01566 <span class="comment">             * Case: run setup, switch away (it gets deactivate event). setup</span>
01567 <span class="comment">             * is not reading messages so it hasn't go it yet. It finally</span>
01568 <span class="comment">             * comes up, calls SetForegroundWindow(). It's synchronous,</span>
01569 <span class="comment">             * it activates ok and sets foreground. Then the app calls</span>
01570 <span class="comment">             * GetMessage() and gets the deactivate. Now it isn't active.</span>
01571 <span class="comment">             */</span>
01572             bRemovedEvent = <a class="code" href="../../d3/d6/focusact_8c.html#a0">RemoveEventMessage</a>(pqForegroundNew, QEVENT_DEACTIVATE, (DWORD)-1);
01573 
01574             <span class="comment">/*</span>
01575 <span class="comment">             * Now do any appropriate activation.  See comment below</span>
01576 <span class="comment">             * for special cases.  If we're already on the foreground</span>
01577 <span class="comment">             * queue we'll call xxxActivateThisWindow() directly.</span>
01578 <span class="comment">             */</span>
01579             <span class="keywordflow">if</span> (pqForegroundNew != pqCurrent) {
01580 
01581                 <span class="comment">/*</span>
01582 <span class="comment">                 * We do the 'pqCurrent == NULL' test to see if we're being</span>
01583 <span class="comment">                 * called from the RIT.  In this case we pass NULL for the</span>
01584 <span class="comment">                 * HWND which will check to see if there is already an active</span>
01585 <span class="comment">                 * window for the thread and redraw its frame as truly active</span>
01586 <span class="comment">                 * since it's in the foreground now.  It will also cancel any</span>
01587 <span class="comment">                 * global state like LockWindowUpdate() and ClipRect().</span>
01588 <span class="comment">                 */</span>
01589                 <span class="keywordflow">if</span> ((pqCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (!(fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a507">SFW_SWITCH</a>))) {
01590                     hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01591                 } <span class="keywordflow">else</span> {
01592                     hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
01593                 }
01594 
01595                 <span class="keywordflow">if</span> (bRemovedEvent) {
01596                     pqForegroundNew-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a868">QF_EVENTDEACTIVATEREMOVED</a>;
01597                 }
01598                 <span class="comment">/*</span>
01599 <span class="comment">                 * MSMail relies on a specific order to how win3.1 does</span>
01600 <span class="comment">                 * fast switch alt-tab activation. On win3.1, it essentially</span>
01601 <span class="comment">                 * activates the window, then restores it. MsMail gets confused</span>
01602 <span class="comment">                 * if it isn't active when it gets restored, so this logic</span>
01603 <span class="comment">                 * will make sure msmail gets restore after it gets activated.</span>
01604 <span class="comment">                 *</span>
01605 <span class="comment">                 * Click on a message line in the in-box, minimize msmail,</span>
01606 <span class="comment">                 * alt-tab to it. The same line should have the focus if msmail</span>
01607 <span class="comment">                 * got restored after it got activated.</span>
01608 <span class="comment">                 *</span>
01609 <span class="comment">                 * This is the history behind SFW_ACTIVATERESTORE.</span>
01610 <span class="comment">                 */</span>
01611                 <span class="keywordflow">if</span> (fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a510">SFW_ACTIVATERESTORE</a>) {
01612                     uMsg = <a class="code" href="../../d4/d1/userk_8h.html#a357">PEM_ACTIVATE_RESTORE</a>;
01613                 } <span class="keywordflow">else</span> {
01614                     uMsg = 0;
01615                 }
01616 
01617                 <span class="keywordflow">if</span> (fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a508">SFW_NOZORDER</a>) {
01618                     uMsg |= <a class="code" href="../../d4/d1/userk_8h.html#a358">PEM_ACTIVATE_NOZORDER</a>;
01619                 }
01620 
01621                 <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsgActivate, NULL, uMsg,
01622                         (fFlags &amp; SFW_STARTUP) ? 0 : (WPARAM)<a class="code" href="../../d4/d1/userk_8h.html#a106">TID</a>(ptiForegroundOld),
01623                         (LPARAM)hwnd, 0, QEVENT_ACTIVATE, 0);
01624 
01625 
01626                 <span class="comment">/*</span>
01627 <span class="comment">                 * Signal the window's thread to perform activation.  We</span>
01628 <span class="comment">                 * know that ptiForegroundNew is valid because pqForegroundNew</span>
01629 <span class="comment">                 * is not NULL.</span>
01630 <span class="comment">                 */</span>
01631 
01632                 <a class="code" href="../../d4/d1/userk_8h.html#a1504">StoreQMessagePti</a>(pqmsgActivate, ptiForegroundNew);
01633 
01634                 <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiForegroundNew, QS_EVENTSET);
01635 
01636                 <span class="keywordflow">if</span> (pqForegroundNew-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01637                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(ptiForegroundNew, CMSHUNGAPPTIMEOUT)) {
01638                         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01639                         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pqForegroundNew-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, &amp;tlpwnd);
01640                         <a class="code" href="../../d4/d1/userk_8h.html#a1652">xxxRedrawHungWindowFrame</a>(pqForegroundNew-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, TRUE);
01641                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01642                     } <span class="keywordflow">else</span> {
01643                         <a class="code" href="../../d4/d1/userk_8h.html#a1125">SetHungFlag</a>(pqForegroundNew-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WFREDRAWFRAMEIFHUNG);
01644                     }
01645                 }
01646 
01647             } <span class="keywordflow">else</span> {
01648                 <span class="keywordflow">if</span> (pwnd != pqCurrent-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) {
01649                     <span class="keywordflow">if</span> (!(fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a506">SFW_STARTUP</a>)) {
01650                         retval = <a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a106">TID</a>(ptiForegroundOld),
01651                                 ((fFlags &amp; SFW_SETFOCUS) ? 0 : ATW_SETFOCUS));
01652 
01653                         <span class="comment">/*</span>
01654 <span class="comment">                         * Make sure the mouse is on this window.</span>
01655 <span class="comment">                         */</span>
01656                         <span class="keywordflow">if</span> (retval &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWINDOWTRACKING)) {
01657                             <a class="code" href="../../d4/d1/userk_8h.html#a1653">zzzActiveCursorTracking</a>(pwnd);
01658                         }
01659                         <span class="keywordflow">goto</span> Exit;
01660                     }
01661 
01662                 } <span class="keywordflow">else</span> {
01663 
01664                     <span class="comment">/*</span>
01665 <span class="comment">                     * If pwnd is already the active window, just make sure</span>
01666 <span class="comment">                     * it's drawn active and on top (if requested).</span>
01667 <span class="comment">                     */</span>
01668                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_NCACTIVATE,
01669                             TRUE,
01670                             (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd));
01671                     <a class="code" href="../../d4/d1/userk_8h.html#a1335">xxxUpdateTray</a>(pwnd);
01672                     <span class="keywordflow">if</span> (!(fFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a508">SFW_NOZORDER</a>)) {
01673                         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd, PWND_TOP, 0, 0, 0, 0, SWP_NOMOVE | SWP_NOSIZE);
01674                     }
01675                 }
01676             }
01677 
01678 
01679         } <span class="comment">/* if (pqForegroundNew != NULL) */</span>
01680 
01681         <span class="comment">/*</span>
01682 <span class="comment">         * First update pqForegroundOld and pqCurrent since we may have</span>
01683 <span class="comment">         * made an xxx call, and these variables may be invalid.</span>
01684 <span class="comment">         */</span>
01685         pqForegroundOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01686         <span class="keywordflow">if</span> (ptiForegroundOld &amp;&amp; !(ptiForegroundOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
01687             pqForegroundOld = ptiForegroundOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
01688         }
01689 
01690         pqCurrent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01691         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01692             pqCurrent = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
01693 
01694         <span class="comment">/*</span>
01695 <span class="comment">         * Now check to see if we needed to do any 'local' deactivation.</span>
01696 <span class="comment">         * (ie.  were we on the queue that is being deactivated by this</span>
01697 <span class="comment">         * SetForegroundWindow() call?)</span>
01698 <span class="comment">         */</span>
01699         <span class="keywordflow">if</span> ((pqForegroundOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pqForegroundOld == pqCurrent)) {
01700             <a class="code" href="../../d4/d1/userk_8h.html#a1224">xxxDeactivate</a>(pti, (pwnd != NULL) ? <a class="code" href="../../d4/d1/userk_8h.html#a107">TIDq</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) : 0);
01701         }
01702 Exit:
01703         <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlpti);
01704         <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlptiForegroundNew);
01705         <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlptiForegroundOld);
01706     }
01707 
01708     <span class="keywordflow">return</span> retval;
01709 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="focusact.c::xxxStubSetForegroundWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxStubSetForegroundWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l01230">1230</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01235">xxxSetForegroundWindow()</a>.
<p>
<pre class="fragment"><div>01232 {
01233     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1665">xxxSetForegroundWindow</a>(pwnd, TRUE);
01234 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="focusact.c::xxxUpdateTray" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxUpdateTray           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/focusact_8c-source.html#l00374">374</a> of file <a class="el" href="../../d4/d5/focusact_8c-source.html">focusact.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05831">FCallHookTray</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05830">FDoTray</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05845">FHas31TrayStyles</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05832">FPostTray</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05844">FTopLevel</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01827">tagWND::head</a>, <a class="el" href="../../d9/d6/winloop2_8c-source.html#l00040">Is31TrayWindow()</a>, <a class="el" href="../../d9/d6/winloop2_8c-source.html#l00062">IsTrayWindow()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01759">tagWND::spwndLastActive</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01747">tagWND::spwndOwner</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02364">WEFTOOLWINDOW</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02319">WFWIN40COMPAT</a>, and <a class="el" href="../../d9/d6/winloop2_8c-source.html#l00100">xxxSetTrayWindow()</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
<pre class="fragment"><div>00375 {
00376     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00377 
00378     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00379     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFVISIBLE)) {
00380         <span class="keywordflow">return</span>;
00381     }
00382 
00383     <span class="keywordflow">for</span> (pwndT = pwnd; pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
00384     }
00385 
00386     <span class="comment">// Notify the shell hook about this activation change</span>
00387     <span class="keywordflow">if</span> (    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)-&gt;pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp;
00388             <a class="code" href="../../d4/d1/userk_8h.html#a592">FDoTray</a>() &amp;&amp;
00389             (<a class="code" href="../../d4/d1/userk_8h.html#a593">FCallHookTray</a>() || <a class="code" href="../../d4/d1/userk_8h.html#a594">FPostTray</a>(pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk)) &amp;&amp;
00390             <a class="code" href="../../d4/d1/userk_8h.html#a596">FTopLevel</a>(pwndT) &amp;&amp;
00391             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WFVISIBLE))
00392     {
00393         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fFirstTry;
00394         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fTryAgain;
00395         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndArg;
00396         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndArg;
00397 
00398         fFirstTry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00399         <span class="keywordflow">do</span> {
00400             fTryAgain = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00401             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WFWIN40COMPAT)) {
00402                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFWIN40COMPAT) &amp;&amp; <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) {
00403                     pwndArg = pwnd;
00404                 } <span class="keywordflow">else</span> {
00405                     pwndArg = <a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwndT) ? pwndT : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00406                 }
00407             } <span class="keywordflow">else</span> {
00408                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WEFTOOLWINDOW)) {
00409                     pwndArg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00410                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a597">FHas31TrayStyles</a>(pwndT)) {
00411                     pwndArg = <a class="code" href="../../d8/d7/winloop2_8c.html#a1">Is31TrayWindow</a>(pwndT) ? pwndT : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00412                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fFirstTry &amp;&amp; (pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>)) {
00413                     fFirstTry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00414                     fTryAgain = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00415                 } <span class="keywordflow">else</span> {
00416                     <span class="keywordflow">return</span>;
00417                 }
00418             }
00419         } <span class="keywordflow">while</span> (fTryAgain);
00420 
00421         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndArg, &amp;tlpwndArg);
00422         <a class="code" href="../../d8/d7/winloop2_8c.html#a3">xxxSetTrayWindow</a>(
00423                 (pwndArg) ? pwndArg-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk : pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk,
00424                 pwndArg,
00425                 NULL);
00426 
00427         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndArg);
00428     }
00429 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
