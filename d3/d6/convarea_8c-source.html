<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: convarea.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>convarea.c</h1><a href="../../d2/d7/convarea_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    convarea.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">Author:</span>
00012 <span class="comment"></span>
00013 <span class="comment">    KazuM Mar.8,1993</span>
00014 <span class="comment"></span>
00015 <span class="comment">Revision History:</span>
00016 <span class="comment"></span>
00017 <span class="comment">--*/</span>
00018 
00019 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00020 <span class="preprocessor">#pragma hdrstop</span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor">#if defined(FE_IME)</span>
00023 <span class="preprocessor"></span>
00024 
00025 
00026 
00027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00028 LinkConversionArea(
00029     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00030     IN PCONVERSIONAREA_INFORMATION ConvAreaInfo
00031     )
00032 {
00033     PCONVERSIONAREA_INFORMATION PrevConvAreaInfo;
00034 
00035     <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.ConvAreaRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00036         Console-&gt;ConsoleIme.ConvAreaRoot = ConvAreaInfo;
00037     }
00038     <span class="keywordflow">else</span> {
00039         PrevConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot;
00040         <span class="keywordflow">while</span> (PrevConvAreaInfo-&gt;ConvAreaNext)
00041             PrevConvAreaInfo = PrevConvAreaInfo-&gt;ConvAreaNext;
00042         PrevConvAreaInfo-&gt;ConvAreaNext = ConvAreaInfo;
00043     }
00044 }
00045 
00046 
00047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00048 FreeConvAreaScreenBuffer(
00049     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00050     )
00051 
00052 <span class="comment">/*++</span>
00053 <span class="comment"></span>
00054 <span class="comment">Routine Description:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    This routine frees the memory associated with a screen buffer.</span>
00057 <span class="comment"></span>
00058 <span class="comment">Arguments:</span>
00059 <span class="comment"></span>
00060 <span class="comment">    ScreenInfo - screen buffer data to free.</span>
00061 <span class="comment"></span>
00062 <span class="comment">Return Value:</span>
00063 <span class="comment"></span>
00064 <span class="comment">Note: console handle table lock must be held when calling this routine</span>
00065 <span class="comment"></span>
00066 <span class="comment">--*/</span>
00067 
00068 {
00069     <span class="keywordflow">return</span> <a class="code" href="../../d6/d2/output_8c.html#a46">FreeScreenBuffer</a>(ScreenInfo);
00070 }
00071 
00072 
00073 
00074 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00075 AllocateConversionArea(
00076     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00077     IN COORD dwScreenBufferSize,
00078     OUT PCONVERSIONAREA_INFORMATION *ConvAreaInfo
00079     )
00080 {
00081     COORD dwWindowSize;
00082     CHAR_INFO Fill, PopupFill;
00083     PCONVERSIONAREA_INFORMATION ca;
00084     <span class="keywordtype">int</span> FontIndex;
00085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// allocate console data</span>
00089     <span class="comment">//</span>
00090 
00091     ca = (PCONVERSIONAREA_INFORMATION)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
00092                                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( CONVAREA_TAG ),
00093                                                 <span class="keyword">sizeof</span>(CONVERSIONAREA_INFORMATION));
00094     <span class="keywordflow">if</span> (ca == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00095         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00096     }
00097 
00098     dwWindowSize.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Console-&gt;CurrentScreenBuffer);
00099     dwWindowSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Console-&gt;CurrentScreenBuffer);
00100     Fill.Attributes = Console-&gt;CurrentScreenBuffer-&gt;Attributes;
00101     PopupFill.Attributes = Console-&gt;CurrentScreenBuffer-&gt;PopupAttributes;
00102     FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a26">CON_FAMILY</a>(Console),
00103                                <a class="code" href="../../d8/d5/consrv_8h.html#a28">CON_FACENAME</a>(Console),
00104                                <a class="code" href="../../d8/d5/consrv_8h.html#a29">CON_FONTSIZE</a>(Console),
00105                                <a class="code" href="../../d8/d5/consrv_8h.html#a30">CON_FONTWEIGHT</a>(Console),
00106                                <a class="code" href="../../d8/d5/consrv_8h.html#a31">CON_FONTCODEPAGE</a>(Console)
00107                               );
00108     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a42">CreateScreenBuffer</a>(&amp;ca-&gt;ScreenBuffer,
00109                                 dwWindowSize,
00110                                 FontIndex,
00111                                 dwScreenBufferSize,
00112                                 Fill,
00113                                 PopupFill,
00114                                 Console,
00115                                 CONSOLE_TEXTMODE_BUFFER,
00116                                 NULL,
00117                                 NULL,
00118                                 NULL,
00119                                 CURSOR_SMALL_SIZE,
00120                                 NULL
00121                                );
00122     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00123         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ca);
00124         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00125     }
00126 
00127     *ConvAreaInfo = ca;
00128 
00129     <span class="keywordflow">return</span> STATUS_SUCCESS;
00130 }
00131 
00132 
00133 
00134 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00135 SetUpConversionArea(
00136     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00137     IN COORD coordCaBuffer,
00138     IN SMALL_RECT rcViewCaWindow,
00139     IN COORD coordConView,
00140     IN DWORD dwOption,
00141     OUT PCONVERSIONAREA_INFORMATION *ConvAreaInfo
00142     )
00143 {
00144     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00145     PCONVERSIONAREA_INFORMATION ca;
00146 
00147     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = AllocateConversionArea(Console, coordCaBuffer, &amp;ca);
00148     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00149         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00150     }
00151 
00152     ca-&gt;ConversionAreaMode    = dwOption;
00153     ca-&gt;CaInfo.coordCaBuffer  = coordCaBuffer;
00154     ca-&gt;CaInfo.rcViewCaWindow = rcViewCaWindow;
00155     ca-&gt;CaInfo.coordConView   = coordConView;
00156 
00157     ca-&gt;ConvAreaNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00158 
00159     ca-&gt;ScreenBuffer-&gt;ConvScreenInfo = ca;
00160 
00161     LinkConversionArea(Console, ca);
00162 
00163     SetUndetermineAttribute( Console ) ;
00164 
00165     *ConvAreaInfo = ca;
00166 
00167     <span class="keywordflow">return</span> STATUS_SUCCESS;
00168 }
00169 
00170 
00171 
00172 
00173 
00174 
00175 
00176 
00177 
00178 
00179 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00180 WriteConvRegionToScreen(
00181     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00182     IN PCONVERSIONAREA_INFORMATION ConvAreaInfo,
00183     IN PSMALL_RECT ConvRegion
00184     )
00185 
00186 <span class="comment">/*++</span>
00187 <span class="comment"></span>
00188 <span class="comment">Routine Description:</span>
00189 <span class="comment"></span>
00190 <span class="comment">Arguments:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    ClippedRegion - Rectangle of region by screen coordinate.</span>
00193 <span class="comment"></span>
00194 <span class="comment">Return Value:</span>
00195 <span class="comment"></span>
00196 <span class="comment">--*/</span>
00197 
00198 {
00199     SMALL_RECT Region;
00200     SMALL_RECT ClippedRegion;
00201 
00202     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)
00203         <span class="keywordflow">return</span>;
00204 
00205     <span class="keywordflow">while</span> (ConvAreaInfo) {
00206 
00207         <span class="keywordflow">if</span> ((ConvAreaInfo-&gt;ConversionAreaMode &amp; (CA_HIDDEN+CA_HIDE_FOR_SCROLL))==0) {
00208             <span class="comment">//</span>
00209             <span class="comment">// Do clipping region</span>
00210             <span class="comment">//</span>
00211             Region.Left   = ScreenInfo-&gt;Window.Left +
00212                             ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Left +
00213                             ConvAreaInfo-&gt;CaInfo.coordConView.X;
00214             Region.Right  = Region.Left +
00215                             (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Right -
00216                              ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Left);
00217             Region.Top    = ScreenInfo-&gt;Window.Top +
00218                             ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top +
00219                             ConvAreaInfo-&gt;CaInfo.coordConView.Y;
00220             Region.Bottom = Region.Top +
00221                             (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Bottom -
00222                              ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top);
00223             ClippedRegion.Left   = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Region.Left,   ScreenInfo-&gt;Window.Left);
00224             ClippedRegion.Top    = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Region.Top,    ScreenInfo-&gt;Window.Top);
00225             ClippedRegion.Right  = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Region.Right,  ScreenInfo-&gt;Window.Right);
00226             ClippedRegion.Bottom = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Region.Bottom, ScreenInfo-&gt;Window.Bottom);
00227             <span class="keywordflow">if</span> (ClippedRegion.Right &lt; ClippedRegion.Left ||
00228                 ClippedRegion.Bottom &lt; ClippedRegion.Top) {
00229                 ;
00230             }
00231             <span class="keywordflow">else</span> {
00232                 Region = ClippedRegion;
00233                 ClippedRegion.Left   = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Region.Left,   ConvRegion-&gt;Left);
00234                 ClippedRegion.Top    = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Region.Top,    ConvRegion-&gt;Top);
00235                 ClippedRegion.Right  = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Region.Right,  ConvRegion-&gt;Right);
00236                 ClippedRegion.Bottom = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Region.Bottom, ConvRegion-&gt;Bottom);
00237                 <span class="keywordflow">if</span> (ClippedRegion.Right &lt; ClippedRegion.Left ||
00238                     ClippedRegion.Bottom &lt; ClippedRegion.Top) {
00239                     ;
00240                 }
00241                 <span class="keywordflow">else</span> {
00242                     ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00243                     ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.Flags |= CONSOLE_CONVERSION_AREA_REDRAW;
00244                     <a class="code" href="../../d6/d8/dispatch_8h.html#a5">WriteRegionToScreen</a>(ConvAreaInfo-&gt;ScreenBuffer,
00245                                         &amp;ClippedRegion
00246                                        );
00247                     ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.Flags &amp;= ~CONSOLE_CONVERSION_AREA_REDRAW;
00248                 }
00249             }
00250         }
00251         ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext;
00252     }
00253 }
00254 
00255 
00256 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00257 ConsoleImeBottomLineUse(
00258     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00259     IN SHORT ScrollOffset
00260     )
00261 
00262 <span class="comment">/*++</span>
00263 <span class="comment"></span>
00264 <span class="comment">Routine Description:</span>
00265 <span class="comment"></span>
00266 <span class="comment">Arguments:</span>
00267 <span class="comment"></span>
00268 <span class="comment">    ScreenInfo -</span>
00269 <span class="comment"></span>
00270 <span class="comment">    ScrollOffset -</span>
00271 <span class="comment"></span>
00272 <span class="comment">Return Value:</span>
00273 <span class="comment"></span>
00274 <span class="comment">--*/</span>
00275 
00276 {
00277     SMALL_RECT ScrollRectangle;
00278     COORD DestinationOrigin;
00279     CHAR_INFO Fill;
00280     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00281     SMALL_RECT WriteRegion;
00282     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00283 
00284     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Console-&gt;ConsoleIme.ScrollFlag &amp; HIDE_FOR_SCROLL)) {
00285         ScreenInfo-&gt;Console-&gt;ConsoleIme.ScrollFlag |= HIDE_FOR_SCROLL;
00286         <span class="keywordflow">if</span> (ConvAreaInfo = ScreenInfo-&gt;Console-&gt;ConsoleIme.ConvAreaRoot) {
00287             <span class="keywordflow">do</span> {
00288                 <span class="keywordflow">if</span> ((ConvAreaInfo-&gt;ConversionAreaMode &amp; (CA_STATUS_LINE))==0) {
00289                     ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDE_FOR_SCROLL;
00290                     fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00291                 }
00292             } <span class="keywordflow">while</span> (ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext);
00293 
00294             <span class="keywordflow">if</span> (fRedraw) {
00295                 <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
00296                 <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)
00297                 {
00298                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00299                 }
00300                 <span class="keywordflow">else</span> {
00301                     WriteRegion = ScreenInfo-&gt;Window;
00302                     WriteRegion.Bottom--;
00303                     ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00304                     ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= CONSOLE_CONVERSION_AREA_REDRAW;
00305                     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;WriteRegion);
00306                     ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~CONSOLE_CONVERSION_AREA_REDRAW;
00307                 }
00308             }
00309         }
00310     }
00311 
00312     <span class="keywordflow">if</span> (ScrollOffset) {
00313         ScrollRectangle.Top = 1 ;
00314         ScrollRectangle.Left = 0 ;
00315         ScrollRectangle.Right = ScreenInfo-&gt;ScreenBufferSize.X-1;
00316         ScrollRectangle.Bottom = ScreenInfo-&gt;ScreenBufferSize.Y-1;
00317         ScrollRectangle.Bottom -= (ScrollOffset-1);
00318         DestinationOrigin.X = ScrollRectangle.Left;
00319         DestinationOrigin.Y = ScrollRectangle.Top-1;
00320         Fill.Char.UnicodeChar = <span class="charliteral">'\0'</span>;
00321         Fill.Attributes = 0;
00322         <a class="code" href="../../d6/d2/output_8c.html#a65">ScrollRegion</a>(ScreenInfo,
00323                      &amp;ScrollRectangle,
00324                      NULL,
00325                      DestinationOrigin,
00326                      Fill
00327                     );
00328 <span class="preprocessor">#if defined(FE_SB)</span>
00329 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_IME)</span>
00330 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( ! (ScreenInfo-&gt;Console-&gt;InputBuffer.ImeMode.Disable) &amp;&amp;
00331              ! (ScreenInfo-&gt;Console-&gt;InputBuffer.ImeMode.Unavailable) &amp;&amp;
00332              (ScreenInfo-&gt;Console-&gt;InputBuffer.ImeMode.Open) &amp;&amp;
00333              (ScrollRectangle.Left == ScreenInfo-&gt;Window.Left) &amp;&amp;
00334              (ScrollRectangle.Right == ScreenInfo-&gt;Window.Right) ) {
00335             ScrollRectangle.Top = ScreenInfo-&gt;Window.Bottom ;
00336             ScrollRectangle.Bottom = ScreenInfo-&gt;Window.Bottom ;
00337             <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;ScrollRectangle);
00338             WriteConvRegionToScreen(ScreenInfo,
00339                                     ScreenInfo-&gt;Console-&gt;ConsoleIme.ConvAreaRoot,
00340                                     &amp;ScrollRectangle);
00341         }
00342 <span class="preprocessor">#endif</span>
00343 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>    }
00345     <span class="keywordflow">else</span> {
00346         ScreenInfo-&gt;Console-&gt;ConsoleIme.ScrollWaitCountDown = ScreenInfo-&gt;Console-&gt;ConsoleIme.ScrollWaitTimeout;
00347     }
00348     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00349 }
00350 
00351 
00352 
00353 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00354 ConsoleImeBottomLineInUse(
00355     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00356     )
00357 
00358 <span class="comment">/*++</span>
00359 <span class="comment"></span>
00360 <span class="comment">Routine Description:</span>
00361 <span class="comment"></span>
00362 <span class="comment">Arguments:</span>
00363 <span class="comment"></span>
00364 <span class="comment">    ScreenInfo -</span>
00365 <span class="comment"></span>
00366 <span class="comment">Return Value:</span>
00367 <span class="comment"></span>
00368 <span class="comment">--*/</span>
00369 
00370 {
00371     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00372     SMALL_RECT WriteRegion;
00373     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00374     COORD CursorPosition;
00375 
00376     ScreenInfo-&gt;Console-&gt;ConsoleIme.ScrollFlag &amp;= ~HIDE_FOR_SCROLL;
00377     <span class="keywordflow">if</span> (ConvAreaInfo = ScreenInfo-&gt;Console-&gt;ConsoleIme.ConvAreaRoot) {
00378         <span class="keywordflow">do</span> {
00379             <span class="keywordflow">if</span> (ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDE_FOR_SCROLL) {
00380                 ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDE_FOR_SCROLL;
00381                 fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00382             }
00383         } <span class="keywordflow">while</span> (ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext);
00384 
00385         <span class="keywordflow">if</span> (fRedraw) {
00386             <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
00387             <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)
00388             {
00389                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00390             }
00391             <span class="keywordflow">else</span> {
00392                 <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y == (ScreenInfo-&gt;ScreenBufferSize.Y-1)) {
00393                     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
00394                     ConsoleImeBottomLineUse(ScreenInfo,1);
00395                     CursorPosition = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
00396                     CursorPosition.Y--;
00397                     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(ScreenInfo,CursorPosition,TRUE);
00398                     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;lpCookedReadData) {
00399                         ((<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)(ScreenInfo-&gt;Console-&gt;lpCookedReadData))-&gt;OriginalCursorPosition.Y--;
00400                     }
00401                     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
00402                 }
00403                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y == ScreenInfo-&gt;Window.Bottom) {
00404                     ;
00405                 }
00406 
00407                 WriteRegion.Top = 0;
00408                 WriteRegion.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y-1);
00409                 WriteRegion.Left = 0;
00410                 WriteRegion.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
00411                 ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00412                 ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= CONSOLE_CONVERSION_AREA_REDRAW;
00413                 <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;WriteRegion);
00414                 ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~CONSOLE_CONVERSION_AREA_REDRAW;
00415             }
00416         }
00417     }
00418 }
00419 
00420 
00421 
00422 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00423 CreateConvAreaUndetermine(
00424     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00425     )
00426 {
00427     PCONSOLE_IME_INFORMATION ConsoleIme = &amp;Console-&gt;ConsoleIme;
00428     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00429     COORD coordCaBuffer;
00430     SMALL_RECT rcViewCaWindow;
00431     COORD coordConView;
00432     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00433 
00434     <span class="keywordflow">if</span> (ConsoleIme-&gt;ConvAreaCompStr) {
00435         ConsoleIme-&gt;ConvAreaCompStr =
00436             <a class="code" href="../../d8/d5/consrv_8h.html#a37">ConsoleHeapReAlloc</a>(
00437                         0,
00438                         ConsoleIme-&gt;ConvAreaCompStr,
00439                         <a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(
00440                                  ConsoleIme-&gt;ConvAreaCompStr)+<span class="keyword">sizeof</span>(PCONVERSIONAREA_INFORMATION));
00441         <span class="keywordflow">if</span> (ConsoleIme-&gt;ConvAreaCompStr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00442             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00443     }
00444     <span class="keywordflow">else</span> {
00445         ConsoleIme-&gt;ConvAreaCompStr =
00446             <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
00447                       <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( CONVAREA_TAG ),
00448                       <span class="keyword">sizeof</span>(PCONVERSIONAREA_INFORMATION));
00449         <span class="keywordflow">if</span> (ConsoleIme-&gt;ConvAreaCompStr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00450             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00451     }
00452 
00453     coordCaBuffer = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>;
00454     coordCaBuffer.Y = 1;
00455     rcViewCaWindow.Top    = 0;
00456     rcViewCaWindow.Left   = 0;
00457     rcViewCaWindow.Bottom = 0;
00458     rcViewCaWindow.Right  = 0;
00459     coordConView.X = 0;
00460     coordConView.Y = 0;
00461     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetUpConversionArea(Console,
00462                                  coordCaBuffer,
00463                                  rcViewCaWindow,
00464                                  coordConView,
00465                                  (Console-&gt;ConsoleIme.ScrollFlag &amp; HIDE_FOR_SCROLL) ?
00466                                      CA_HIDE_FOR_SCROLL :
00467                                      CA_HIDDEN,
00468                                  &amp;ConvAreaInfo
00469                                 );
00470     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00471         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00472     }
00473 
00474     ConsoleIme-&gt;ConvAreaCompStr[ConsoleIme-&gt;NumberOfConvAreaCompStr] = ConvAreaInfo;
00475     ConsoleIme-&gt;NumberOfConvAreaCompStr++;
00476 
00477     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00478 }
00479 
00480 
00481 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00482 CreateConvAreaModeSystem(
00483     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00484     )
00485 {
00486     PCONSOLE_IME_INFORMATION ConsoleIme = &amp;Console-&gt;ConsoleIme;
00487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00488     COORD coordCaBuffer;
00489     SMALL_RECT rcViewCaWindow;
00490     COORD coordConView;
00491     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00492 
00493     <span class="comment">/*</span>
00494 <span class="comment">     * Create mode text buffer</span>
00495 <span class="comment">     */</span>
00496     coordCaBuffer = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>;
00497     coordCaBuffer.Y = 1;
00498     rcViewCaWindow.Top    = 0;
00499     rcViewCaWindow.Left   = 0;
00500     rcViewCaWindow.Bottom = 0;
00501     rcViewCaWindow.Right  = 0;
00502     coordConView.X = 0;
00503     coordConView.Y = 0;
00504     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetUpConversionArea(Console,
00505                                  coordCaBuffer,
00506                                  rcViewCaWindow,
00507                                  coordConView,
00508                                  CA_HIDDEN+CA_STATUS_LINE,
00509                                  &amp;ConvAreaInfo
00510                                 );
00511     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00512         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00513     }
00514 
00515     ConsoleIme-&gt;ConvAreaMode = ConvAreaInfo;
00516 
00517     <span class="comment">/*</span>
00518 <span class="comment">     * Create system text buffer</span>
00519 <span class="comment">     */</span>
00520     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetUpConversionArea(Console,
00521                                  coordCaBuffer,
00522                                  rcViewCaWindow,
00523                                  coordConView,
00524                                  CA_HIDDEN+CA_STATUS_LINE,
00525                                  &amp;ConvAreaInfo
00526                                 );
00527     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00528         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00529     }
00530 
00531     ConsoleIme-&gt;ConvAreaSystem = ConvAreaInfo;
00532 
00533     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00534 }
00535 
00536 
00537 <span class="preprocessor">#define LOCAL_BUFFER_SIZE 100</span>
00538 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00539 WriteUndetermineChars(
00540     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00541     LPWSTR lpString,
00542     PBYTE  lpAtr,
00543     PWORD  lpAtrIdx,
00544     DWORD  NumChars  <span class="comment">// character count</span>
00545     )
00546 {
00547     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00548     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ConvScreenInfo;
00549     WCHAR LocalBuffer[<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>];
00550     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> LocalBufferA[<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>];
00551     PWCHAR LocalBufPtr;
00552     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> LocalBufPtrA;
00553     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00554     COORD Position;
00555     ULONG i;
00556     SMALL_RECT Region;
00557     COORD CursorPosition;
00558     WCHAR Char;
00559     WORD Attr;
00560     PCONSOLE_IME_INFORMATION ConsoleIme;
00561     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00562     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ConvAreaIndex;
00563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00564     ULONG NumStr ;
00565     <span class="keywordtype">int</span> WholeLen ;
00566     <span class="keywordtype">int</span> WholeRow ;
00567     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> PosY ;
00568     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> UndetAreaUp = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00569 
00570     ConsoleIme = &amp;Console-&gt;ConsoleIme;
00571     ScreenInfo = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>;
00572 
00573     <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
00574     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; CONSOLE_GRAPHICS_BUFFER));
00575 
00576     Position = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition;
00577 
00578         <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left &lt;= Position.X &amp;&amp; Position.X &lt;= ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right) &amp;&amp;
00579             (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top  &lt;= Position.Y &amp;&amp; Position.Y &lt;= ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom)  ) {
00580             Position.X = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X - ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
00581             Position.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y - ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00582         }
00583         <span class="keywordflow">else</span> {
00584             Position.X = 0;
00585             Position.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) - 2;
00586         }
00587 
00588     PosY = Position.Y ;
00589     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a36">RtlUnicodeToMultiByteSize</a>(&amp;NumStr, lpString, NumChars*<span class="keyword">sizeof</span>(WCHAR));
00590 
00591     WholeLen = (<span class="keywordtype">int</span>)Position.X + (<span class="keywordtype">int</span>)NumStr ;
00592     WholeRow = WholeLen / <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
00593     <span class="keywordflow">if</span> ( ( PosY + WholeRow ) &gt; ( <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) - 2) ) {
00594         PosY = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) - 2 - WholeRow ;
00595         <span class="keywordflow">if</span> (PosY &lt; 0) {
00596             PosY = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top ;
00597         }
00598     }
00599     <span class="keywordflow">if</span> (PosY != Position.Y) {
00600         Position.Y = PosY ;
00601         UndetAreaUp = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00602     }
00603 
00604     ConvAreaIndex = 0;
00605 
00606     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = NumChars;
00607     NumChars = 0;
00608 
00609     <span class="keywordflow">for</span> (ConvAreaIndex = 0; NumChars &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>; ConvAreaIndex++) {
00610 
00611         <span class="keywordflow">if</span> (ConvAreaIndex+1 &gt; ConsoleIme-&gt;NumberOfConvAreaCompStr) {
00612             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = CreateConvAreaUndetermine(Console);
00613             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00614                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00615             }
00616         }
00617         ConvAreaInfo = ConsoleIme-&gt;ConvAreaCompStr[ConvAreaIndex];
00618         ConvScreenInfo = ConvAreaInfo-&gt;ScreenBuffer;
00619         ConvScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X = Position.X;
00620 
00621         <span class="keywordflow">if</span> ((ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN) ||
00622             (UndetAreaUp)) {
00623             <span class="comment">/*</span>
00624 <span class="comment">             * This conversion area need positioning onto cursor position.</span>
00625 <span class="comment">             */</span>
00626             CursorPosition.X = 0;
00627             CursorPosition.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Position.Y + ConvAreaIndex);
00628             ConsoleImeViewInfo(Console,ConvAreaInfo,CursorPosition);
00629         }
00630 
00631         Region.Left = ConvScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X;
00632         Region.Top = 0;
00633         Region.Bottom = 0;
00634 
00635         <span class="keywordflow">while</span> (NumChars &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
00636             i=0;
00637             LocalBufPtr = LocalBuffer;
00638             LocalBufPtrA = LocalBufferA;
00639 
00640             <span class="keywordflow">while</span> (NumChars &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &amp;&amp;
00641                    i &lt; <a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a> &amp;&amp;
00642                    Position.X &lt; <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)) {
00643                 Char = *lpString;
00644                 Attr = *lpAtr;
00645                 <span class="keywordflow">if</span> (Char &gt;= (WCHAR)<span class="charliteral">' '</span>) {
00646                     <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>,Char)) {
00647                         <span class="keywordflow">if</span> (i &lt; (<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>-1) &amp;&amp;
00648                             Position.X &lt; <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)-1) {
00649                             *LocalBufPtr++ = Char;
00650                             *LocalBufPtrA++ = ATTR_LEADING_BYTE;
00651                             *LocalBufPtr++ = Char;
00652                             *LocalBufPtrA++ = ATTR_TRAILING_BYTE;
00653                             Position.X+=2;
00654                             i+=2;
00655                         }
00656                         <span class="keywordflow">else</span> {
00657                             Position.X++;
00658                             <span class="keywordflow">break</span>;
00659                         }
00660                     }
00661                     <span class="keywordflow">else</span> {
00662                         *LocalBufPtr++ = Char;
00663                         *LocalBufPtrA++ = 0;
00664                         Position.X++;
00665                         i++;
00666                     }
00667                 }
00668                 lpString++;
00669                 lpAtr++;
00670                 NumChars++;
00671 
00672                 <span class="keywordflow">if</span> (NumChars &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &amp;&amp;
00673                     Attr != *lpAtr)
00674                     <span class="keywordflow">break</span>;
00675             }
00676             <span class="keywordflow">if</span> (i != 0) {
00677                 ConvScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a> = lpAtrIdx[Attr &amp; 0x07];
00678                 <span class="keywordflow">if</span> (Attr &amp; 0x10)
00679                     ConvScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a> |= (COMMON_LVB_GRID_SINGLEFLAG + COMMON_LVB_GRID_RVERTICAL) ;
00680                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Attr &amp; 0x20)
00681                     ConvScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a> |= (COMMON_LVB_GRID_SINGLEFLAG + COMMON_LVB_GRID_LVERTICAL) ;
00682                 StreamWriteToScreenBufferIME(LocalBuffer,
00683                                           (SHORT)i,
00684                                           ConvScreenInfo,
00685                                           LocalBufferA
00686                                          );
00687 
00688                 ConvScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)i;
00689 
00690                 <span class="keywordflow">if</span> (NumChars == <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> ||
00691                     Position.X &gt;= <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo) ||
00692                     ( (Char &gt;= (WCHAR)<span class="charliteral">' '</span> &amp;&amp;
00693                       IsConsoleFullWidth(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>,Char) &amp;&amp;
00694                       Position.X &gt;= <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)-1) )
00695                    ) {
00696 
00697                     Region.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ConvScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X - 1);
00698                     ConsoleImeWindowInfo(Console,ConvAreaInfo,Region);
00699 
00700                     ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN;
00701 
00702                     ConsoleImePaint(Console,ConvAreaInfo);
00703 
00704                     Position.X = 0;
00705                     <span class="keywordflow">break</span>;
00706                 }
00707 
00708                 <span class="keywordflow">if</span> (NumChars == <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
00709                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00710                 }
00711                 <span class="keywordflow">continue</span>;
00712 
00713             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumChars == <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
00714                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00715             }
00716             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00717                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00718             }
00719             <span class="keywordflow">if</span> (Position.X &gt;= <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)) {
00720                 Position.X = 0;
00721                 <span class="keywordflow">break</span>;
00722             }
00723         }
00724 
00725     }
00726 
00727     <span class="keywordflow">for</span> ( ; ConvAreaIndex &lt; ConsoleIme-&gt;NumberOfConvAreaCompStr; ConvAreaIndex++) {
00728         ConvAreaInfo = ConsoleIme-&gt;ConvAreaCompStr[ConvAreaIndex];
00729         <span class="keywordflow">if</span> (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN)) {
00730             ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
00731             ConsoleImePaint(Console,ConvAreaInfo);
00732         }
00733     }
00734 
00735     <span class="keywordflow">return</span> STATUS_SUCCESS;
00736 }
00737 
00738 
00739 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00740 WriteModeSystemChars(
00741     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00742     PCONVERSIONAREA_INFORMATION ConvAreaInfo,
00743     PCHAR_INFO Buffer,
00744     DWORD NumberOfChars,
00745     DWORD ViewPosition
00746     )
00747 {
00748     SMALL_RECT CharRegion;
00749     COORD CursorPosition;
00750 
00751     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00752         CharRegion.Left   = 0;
00753         CharRegion.Top    = 0;
00754         CharRegion.Right  = CalcWideCharToColumn(Console,Buffer,NumberOfChars);
00755         CharRegion.Right  = (CharRegion.Right ? CharRegion.Right-1 : 0);
00756         CharRegion.Bottom = 0;
00757     }
00758     <span class="keywordflow">else</span> {
00759         CharRegion = ConvAreaInfo-&gt;CaInfo.rcViewCaWindow;
00760     }
00761     <span class="keywordflow">if</span> (ConvAreaInfo) {
00762         <span class="keywordflow">if</span> (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN)) {
00763             <span class="keywordflow">if</span> (CharRegion.Left   != ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Left ||
00764                 CharRegion.Top    != ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top ||
00765                 CharRegion.Right  != ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Right ||
00766                 CharRegion.Bottom != ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Bottom) {
00767                 <span class="keywordflow">switch</span> (ViewPosition) {
00768                     <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a1">VIEW_LEFT</a>:
00769                         CursorPosition.X = 0;
00770                         <span class="keywordflow">break</span>;
00771                     <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a2">VIEW_RIGHT</a>:
00772                         CursorPosition.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) - (CharRegion.Right + 1);
00773                         <span class="keywordflow">break</span>;
00774                 }
00775                 CursorPosition.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) - 1;
00776                 ConsoleImeViewInfo(Console,ConvAreaInfo,CursorPosition);
00777 
00778                 ConsoleImeWindowInfo(Console,ConvAreaInfo,CharRegion);
00779             }
00780         }
00781         <span class="keywordflow">else</span> {
00782             <span class="comment">/*</span>
00783 <span class="comment">             * This conversion area need positioning onto cursor position.</span>
00784 <span class="comment">             */</span>
00785             <span class="keywordflow">switch</span> (ViewPosition) {
00786                 <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a1">VIEW_LEFT</a>:
00787                     CursorPosition.X = 0;
00788                     <span class="keywordflow">break</span>;
00789                 <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a2">VIEW_RIGHT</a>:
00790                     CursorPosition.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) - (CharRegion.Right + 1);
00791                     <span class="keywordflow">break</span>;
00792             }
00793             CursorPosition.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) - 1;
00794             ConsoleImeViewInfo(Console,ConvAreaInfo,CursorPosition);
00795 
00796             ConsoleImeWindowInfo(Console,ConvAreaInfo,CharRegion);
00797         }
00798 
00799         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00800             ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN;
00801             ConsoleImeWriteOutput(Console,ConvAreaInfo,Buffer,CharRegion,TRUE);
00802         }
00803         <span class="keywordflow">else</span> {
00804             ConsoleImePaint(Console,ConvAreaInfo);
00805         }
00806     }
00807 }
00808 
00809 
00810 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00811 FillUndetermineChars(
00812     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00813     PCONVERSIONAREA_INFORMATION ConvAreaInfo
00814     )
00815 {
00816     COORD Coord;
00817     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CharsToWrite;
00818 
00819     ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
00820     Coord.X = 0;
00821     Coord.Y = 0;
00822     CharsToWrite = ConvAreaInfo-&gt;ScreenBuffer-&gt;ScreenBufferSize.X;
00823     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ConvAreaInfo-&gt;ScreenBuffer,
00824                (WCHAR)<span class="charliteral">' '</span>,
00825                Coord,
00826                CONSOLE_FALSE_UNICODE, <span class="comment">// faster than real unicode</span>
00827                &amp;CharsToWrite
00828               );
00829     CharsToWrite = ConvAreaInfo-&gt;ScreenBuffer-&gt;ScreenBufferSize.X;
00830     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ConvAreaInfo-&gt;ScreenBuffer,
00831                Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a>,
00832                Coord,
00833                CONSOLE_ATTRIBUTE,
00834                &amp;CharsToWrite
00835               );
00836     ConsoleImePaint(Console,ConvAreaInfo);
00837     <span class="keywordflow">return</span> STATUS_SUCCESS;
00838 }
00839 
00840 
00841 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00842 ConsoleImeCompStr(
00843     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00844     IN <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> CompStr
00845     )
00846 {
00847     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
00848     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00849 
00850     <span class="keywordflow">if</span> (CompStr-&gt;dwCompStrLen == 0 ||
00851         CompStr-&gt;dwResultStrLen != 0
00852        ) {
00853 
00854         <span class="comment">// Cursor turn ON.</span>
00855         <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) &amp;&amp;
00856              Console-&gt;ConsoleIme.SavedCursorVisible                             )
00857         {
00858             Console-&gt;ConsoleIme.SavedCursorVisible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00859             <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a4">SetCursorInformation</a>(Console-&gt;CurrentScreenBuffer,
00860                                  Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.CursorSize,
00861                                  TRUE);
00862         }
00863 
00864         <span class="comment">/*</span>
00865 <span class="comment">         * Determine string.</span>
00866 <span class="comment">         */</span>
00867         <span class="keywordflow">for</span> (i=0; i&lt;Console-&gt;ConsoleIme.NumberOfConvAreaCompStr; i++) {
00868             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaCompStr[i];
00869             <span class="keywordflow">if</span> (ConvAreaInfo &amp;&amp;
00870                 (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN))) {
00871                 FillUndetermineChars(Console,ConvAreaInfo);
00872             }
00873         }
00874 
00875         <span class="keywordflow">if</span> (CompStr-&gt;dwResultStrLen != 0)
00876         {
00877             <span class="keywordflow">if</span> (!InsertConverTedString(Console, (LPWSTR)((PBYTE)CompStr + CompStr-&gt;dwResultStrOffset))) {
00878                 <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00879             }
00880         }
00881         <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.CompStrData) {
00882             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;ConsoleIme.CompStrData);
00883             Console-&gt;ConsoleIme.CompStrData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00884         }
00885     }
00886     <span class="keywordflow">else</span> {
00887         LPWSTR lpStr;
00888         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>  lpAtr;
00889         PWORD  lpAtrIdx;
00890 
00891         <span class="comment">// Cursor turn OFF.</span>
00892         <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) &amp;&amp;
00893              Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.CursorVisible  )
00894         {
00895             Console-&gt;ConsoleIme.SavedCursorVisible = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00896             <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a4">SetCursorInformation</a>(Console-&gt;CurrentScreenBuffer,
00897                                  Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.CursorSize,
00898                                  FALSE);
00899         }
00900 
00901         <span class="comment">/*</span>
00902 <span class="comment">         * Composition string.</span>
00903 <span class="comment">         */</span>
00904         <span class="keywordflow">for</span> (i=0; i&lt;Console-&gt;ConsoleIme.NumberOfConvAreaCompStr; i++) {
00905             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaCompStr[i];
00906             <span class="keywordflow">if</span> (ConvAreaInfo &amp;&amp;
00907                 (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN))) {
00908                 FillUndetermineChars(Console,ConvAreaInfo);
00909             }
00910         }
00911 
00912         lpStr = (LPWSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CompStr + CompStr-&gt;dwCompStrOffset);
00913         lpAtr = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CompStr + CompStr-&gt;dwCompAttrOffset;
00914         lpAtrIdx = (PWORD)CompStr-&gt;CompAttrColor ;
00915         WriteUndetermineChars(Console, lpStr, lpAtr, lpAtrIdx, CompStr-&gt;dwCompStrLen / <span class="keyword">sizeof</span>(WCHAR));
00916     }
00917 
00918     <span class="keywordflow">return</span> STATUS_SUCCESS;
00919 }
00920 
00921 
00922 
00923 
00924 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00925 ConsoleImeResizeModeSystemView(
00926     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00927     SMALL_RECT WindowRect
00928     )
00929 {
00930     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00931     SMALL_RECT CharRegion;
00932     COORD CursorPosition;
00933 
00934     <span class="comment">/*</span>
00935 <span class="comment">     * Mode string</span>
00936 <span class="comment">     */</span>
00937 
00938     ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaMode;
00939  
00940     <span class="keywordflow">if</span> (ConvAreaInfo &amp;&amp;
00941         (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN))) {
00942         ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
00943         ConsoleImePaint(Console,ConvAreaInfo);
00944         CharRegion = ConvAreaInfo-&gt;CaInfo.rcViewCaWindow;
00945 
00946         <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.ConvAreaModePosition == <a class="code" href="../../d3/d5/conime_8h.html#a1">VIEW_LEFT</a>){
00947             CursorPosition.X = 0;
00948         }
00949         <span class="keywordflow">else</span>{
00950             CursorPosition.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) - (CharRegion.Right + 1);
00951         }
00952 
00953         CursorPosition.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) - 1;
00954         ConsoleImeViewInfo(Console,ConvAreaInfo,CursorPosition);
00955         ConsoleImeWindowInfo(Console,ConvAreaInfo,CharRegion);
00956         ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN;
00957 
00958         WriteModeSystemChars(Console,
00959                              Console-&gt;ConsoleIme.ConvAreaMode,
00960                              NULL,
00961                              0,
00962                              Console-&gt;ConsoleIme.ConvAreaModePosition);
00963     }
00964 
00965     <span class="comment">/*</span>
00966 <span class="comment">     * System string</span>
00967 <span class="comment">     */</span>
00968     ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaSystem;
00969     <span class="keywordflow">if</span> (ConvAreaInfo &amp;&amp;
00970         (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN))) {
00971 
00972         ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
00973         ConsoleImePaint(Console,ConvAreaInfo);
00974 
00975         CharRegion = ConvAreaInfo-&gt;CaInfo.rcViewCaWindow;
00976         CursorPosition.X = 0;
00977         CursorPosition.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) - 1;
00978         ConsoleImeViewInfo(Console,ConvAreaInfo,CursorPosition);
00979         ConsoleImeWindowInfo(Console,ConvAreaInfo,CharRegion);
00980         ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN;
00981 
00982         WriteModeSystemChars(Console,
00983                              Console-&gt;ConsoleIme.ConvAreaSystem,
00984                              NULL,
00985                              0,
00986                              VIEW_LEFT);
00987     }
00988 
00989     <span class="keywordflow">return</span> STATUS_SUCCESS;
00990     UNREFERENCED_PARAMETER(WindowRect);
00991 }
00992 
00993 
00994 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00995 ConsoleImeResizeCompStrView(
00996     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00997     SMALL_RECT WindowRect
00998     )
00999 {
01000     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
01001     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
01002     <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> CompStr;
01003     LPWSTR lpStr;
01004     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>  lpAtr;
01005     PWORD  lpAtrIdx;
01006 
01007     <span class="comment">/*</span>
01008 <span class="comment">     * Compositon string</span>
01009 <span class="comment">     */</span>
01010     CompStr = Console-&gt;ConsoleIme.CompStrData;
01011     <span class="keywordflow">if</span> (CompStr) {
01012         <span class="keywordflow">for</span> (i=0; i&lt;Console-&gt;ConsoleIme.NumberOfConvAreaCompStr; i++) {
01013             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaCompStr[i];
01014             <span class="keywordflow">if</span> (ConvAreaInfo &amp;&amp;
01015                 (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN))) {
01016                 FillUndetermineChars(Console,ConvAreaInfo);
01017             }
01018         }
01019 
01020         lpStr = (LPWSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CompStr + CompStr-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o4">dwCompStrOffset</a>);
01021         lpAtr = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CompStr + CompStr-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o2">dwCompAttrOffset</a>;
01022         lpAtrIdx = (PWORD)CompStr-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o7">CompAttrColor</a> ;
01023 
01024         WriteUndetermineChars(Console, lpStr, lpAtr, lpAtrIdx, CompStr-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a> / <span class="keyword">sizeof</span>(WCHAR));
01025     }
01026     <span class="keywordflow">return</span> STATUS_SUCCESS;
01027     UNREFERENCED_PARAMETER(WindowRect);
01028 }
01029 
01030 
01031 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01032 ConsoleImeResizeModeSystemScreenBuffer(
01033     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01034     COORD NewScreenSize
01035     )
01036 {
01037     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01038     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
01039 
01040     <span class="comment">/*</span>
01041 <span class="comment">     * Mode string</span>
01042 <span class="comment">     */</span>
01043     ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaMode;
01044     <span class="keywordflow">if</span> (ConvAreaInfo) {
01045         <span class="keywordflow">if</span> (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN)) {
01046             ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
01047             ConsoleImePaint(Console,ConvAreaInfo);
01048             ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN; 
01049         }
01050 
01051         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ConsoleImeResizeScreenBuffer(ConvAreaInfo-&gt;ScreenBuffer,NewScreenSize,ConvAreaInfo);
01052         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01053             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01054     }
01055 
01056     <span class="comment">/*</span>
01057 <span class="comment">     * System string</span>
01058 <span class="comment">     */</span>
01059     ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaSystem;
01060     <span class="keywordflow">if</span> (ConvAreaInfo) {
01061         <span class="keywordflow">if</span> (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN)) {
01062             ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
01063             ConsoleImePaint(Console,ConvAreaInfo);
01064             ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN; 
01065         }
01066 
01067         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ConsoleImeResizeScreenBuffer(ConvAreaInfo-&gt;ScreenBuffer,NewScreenSize,ConvAreaInfo);
01068         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01069             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01070     }
01071 
01072     <span class="keywordflow">return</span> STATUS_SUCCESS;
01073 }
01074 
01075 
01076 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01077 ConsoleImeResizeCompStrScreenBuffer(
01078     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01079     COORD NewScreenSize
01080     )
01081 {
01082     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01083     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
01084     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
01085 
01086     <span class="comment">/*</span>
01087 <span class="comment">     * Compositon string</span>
01088 <span class="comment">     */</span>
01089     <span class="keywordflow">for</span> (i=0; i&lt;Console-&gt;ConsoleIme.NumberOfConvAreaCompStr; i++) {
01090         ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaCompStr[i];
01091 
01092         <span class="keywordflow">if</span> (ConvAreaInfo) {
01093             <span class="keywordflow">if</span> (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN)) {
01094                 ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
01095                 ConsoleImePaint(Console,ConvAreaInfo);
01096             }
01097 
01098             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ConsoleImeResizeScreenBuffer(ConvAreaInfo-&gt;ScreenBuffer,NewScreenSize,ConvAreaInfo);
01099             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01100                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01101         }
01102 
01103     }
01104     <span class="keywordflow">return</span> STATUS_SUCCESS;
01105 }
01106 
01107 
01108 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>
01109 CalcWideCharToColumn(
01110     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01111     IN PCHAR_INFO Buffer,
01112     IN DWORD NumberOfChars
01113     )
01114 {
01115     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> Column = 0;
01116 
01117     <span class="keywordflow">while</span> (NumberOfChars--) {
01118         <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,Console-&gt;OutputCP,<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Char.UnicodeChar))
01119             Column += 2;
01120         <span class="keywordflow">else</span>
01121             Column++;
01122         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
01123     }
01124     <span class="keywordflow">return</span> Column;
01125 }
01126 
01127 
01128 
01129 
01130 
01131 
01132 
01133 
01134 
01135 
01136 
01137 
01138 
01139 LONG
01140 ConsoleImePaint(
01141     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01142     IN PCONVERSIONAREA_INFORMATION ConvAreaInfo
01143     )
01144 
01145 <span class="comment">/*++</span>
01146 <span class="comment"></span>
01147 <span class="comment">    This routine</span>
01148 <span class="comment"></span>
01149 <span class="comment">--*/</span>
01150 
01151 {
01152     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
01153     SMALL_RECT WriteRegion;
01154     COORD CursorPosition;
01155 
01156     <span class="keywordflow">if</span> (!ConvAreaInfo)
01157         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01158 
01159     ScreenInfo = Console-&gt;CurrentScreenBuffer;
01160     <span class="keywordflow">if</span> (!ScreenInfo)
01161         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01162 
01163     <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01164     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; CONSOLE_GRAPHICS_BUFFER));
01165 
01166     WriteRegion.Left   = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left
01167                          + ConvAreaInfo-&gt;CaInfo.coordConView.X
01168                          + ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Left;
01169     WriteRegion.Right  = WriteRegion.Left
01170                          + (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Right - ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Left);
01171     WriteRegion.Top    = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top
01172                          + ConvAreaInfo-&gt;CaInfo.coordConView.Y
01173                          + ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top;
01174     WriteRegion.Bottom = WriteRegion.Top
01175                          + (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Bottom - ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top);
01176 
01177     <span class="keywordflow">if</span> ((ConvAreaInfo-&gt;ConversionAreaMode &amp; (CA_HIDDEN+CA_STATUS_LINE))==(CA_STATUS_LINE)) {
01178         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y == (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y-1)) {
01179             <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
01180             ConsoleImeBottomLineUse(ScreenInfo,1);
01181             CursorPosition = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition;
01182             CursorPosition.Y--;
01183             <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(ScreenInfo,CursorPosition,TRUE);
01184             <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;lpCookedReadData) {
01185                 ((<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;lpCookedReadData))-&gt;OriginalCursorPosition.Y--;
01186             }
01187             <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
01188         }
01189         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y == ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom) {
01190             WriteRegion.Top    = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top
01191                                  + ConvAreaInfo-&gt;CaInfo.coordConView.Y
01192                                  + ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top;
01193             WriteRegion.Bottom = WriteRegion.Top
01194                                  + (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Bottom - ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top);
01195         }
01196     }
01197 
01198     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01199     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags |= CONSOLE_CONVERSION_AREA_REDRAW;
01200     <span class="keywordflow">if</span> (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; (CA_HIDDEN | CA_HIDE_FOR_SCROLL))) {
01201         WriteConvRegionToScreen(ScreenInfo,
01202                                 ConvAreaInfo,
01203                                 &amp;WriteRegion
01204                                );
01205     }
01206     <span class="keywordflow">else</span> {
01207         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;WriteRegion);
01208     }
01209     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~CONSOLE_CONVERSION_AREA_REDRAW;
01210 
01211     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01212 }
01213 
01214 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01215 ConsoleImeViewInfo(
01216     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01217     IN PCONVERSIONAREA_INFORMATION ConvAreaInfo,
01218     IN COORD coordConView
01219     )
01220 {
01221     SMALL_RECT OldRegion;
01222     SMALL_RECT NewRegion;
01223 
01224     <span class="keywordflow">if</span> (ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN) {
01225         ConvAreaInfo-&gt;CaInfo.coordConView = coordConView;
01226         NewRegion = ConvAreaInfo-&gt;CaInfo.rcViewCaWindow;
01227         NewRegion.Left   += ConvAreaInfo-&gt;CaInfo.coordConView.X;
01228         NewRegion.Right  += ConvAreaInfo-&gt;CaInfo.coordConView.X;
01229         NewRegion.Top    += ConvAreaInfo-&gt;CaInfo.coordConView.Y;
01230         NewRegion.Bottom += ConvAreaInfo-&gt;CaInfo.coordConView.Y;
01231     }
01232     <span class="keywordflow">else</span> {
01233         OldRegion = ConvAreaInfo-&gt;CaInfo.rcViewCaWindow;
01234         OldRegion.Left   += ConvAreaInfo-&gt;CaInfo.coordConView.X;
01235         OldRegion.Right  += ConvAreaInfo-&gt;CaInfo.coordConView.X;
01236         OldRegion.Top    += ConvAreaInfo-&gt;CaInfo.coordConView.Y;
01237         OldRegion.Bottom += ConvAreaInfo-&gt;CaInfo.coordConView.Y;
01238         ConvAreaInfo-&gt;CaInfo.coordConView = coordConView;
01239 
01240         <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01241         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; CONSOLE_GRAPHICS_BUFFER));
01242 
01243         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01244         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.Flags |= CONSOLE_CONVERSION_AREA_REDRAW;
01245         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(Console-&gt;CurrentScreenBuffer,&amp;OldRegion);
01246 
01247         NewRegion = ConvAreaInfo-&gt;CaInfo.rcViewCaWindow;
01248         NewRegion.Left   += ConvAreaInfo-&gt;CaInfo.coordConView.X;
01249         NewRegion.Right  += ConvAreaInfo-&gt;CaInfo.coordConView.X;
01250         NewRegion.Top    += ConvAreaInfo-&gt;CaInfo.coordConView.Y;
01251         NewRegion.Bottom += ConvAreaInfo-&gt;CaInfo.coordConView.Y;
01252         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01253         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(Console-&gt;CurrentScreenBuffer,&amp;NewRegion);
01254         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.Flags &amp;= ~CONSOLE_CONVERSION_AREA_REDRAW;
01255     }
01256 }
01257 
01258 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01259 ConsoleImeWindowInfo(
01260     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01261     IN PCONVERSIONAREA_INFORMATION ConvAreaInfo,
01262     IN SMALL_RECT rcViewCaWindow
01263     )
01264 {
01265     <span class="keywordflow">if</span> (rcViewCaWindow.Left   != ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Left ||
01266         rcViewCaWindow.Top    != ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top ||
01267         rcViewCaWindow.Right  != ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Right ||
01268         rcViewCaWindow.Bottom != ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Bottom) {
01269         <span class="keywordflow">if</span> (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN)) {
01270             ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
01271             ConsoleImePaint(Console,ConvAreaInfo);
01272 
01273             ConvAreaInfo-&gt;CaInfo.rcViewCaWindow = rcViewCaWindow;
01274             ConvAreaInfo-&gt;ConversionAreaMode &amp;= ~CA_HIDDEN;
01275             ConvAreaInfo-&gt;ScreenBuffer-&gt;BisectFlag &amp;= ~(BISECT_LEFT | BISECT_RIGHT | BISECT_TOP | BISECT_BOTTOM);
01276             ConsoleImePaint(Console,ConvAreaInfo);
01277         }
01278         <span class="keywordflow">else</span>
01279             ConvAreaInfo-&gt;CaInfo.rcViewCaWindow = rcViewCaWindow;
01280     }
01281 }
01282 
01283 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01284 ConsoleImeResizeScreenBuffer(
01285     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01286     IN COORD NewScreenSize,
01287     PCONVERSIONAREA_INFORMATION ConvAreaInfo
01288     )
01289 {
01290     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01291 
01292     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a58">ResizeScreenBuffer</a>(ScreenInfo,
01293                                 NewScreenSize,
01294                                 FALSE);
01295     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01296         ConvAreaInfo-&gt;CaInfo.coordCaBuffer = NewScreenSize;
01297         <span class="keywordflow">if</span> (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Left   &gt; NewScreenSize.X-1)
01298             ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Left   = NewScreenSize.X-1;
01299         <span class="keywordflow">if</span> (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Right  &gt; NewScreenSize.X-1)
01300             ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Right  = NewScreenSize.X-1;
01301         <span class="keywordflow">if</span> (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top    &gt; NewScreenSize.Y-1)
01302             ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Top    = NewScreenSize.Y-1;
01303         <span class="keywordflow">if</span> (ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Bottom &gt; NewScreenSize.Y-1)
01304             ConvAreaInfo-&gt;CaInfo.rcViewCaWindow.Bottom = NewScreenSize.Y-1;
01305 
01306     }
01307 
01308     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01309 }
01310 
01311 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01312 ConsoleImeWriteOutput(
01313     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01314     IN PCONVERSIONAREA_INFORMATION ConvAreaInfo,
01315     IN PCHAR_INFO Buffer,
01316     IN SMALL_RECT CharRegion,
01317     IN BOOL fUnicode
01318     )
01319 {
01320     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01321     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
01322     COORD <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01323     SMALL_RECT ConvRegion;
01324     COORD CursorPosition;
01325 
01326     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CharRegion.Right - CharRegion.Left + 1);
01327     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CharRegion.Bottom - CharRegion.Top + 1);
01328 
01329     ConvRegion = CharRegion;
01330 
01331     ScreenInfo = ConvAreaInfo-&gt;ScreenBuffer;
01332 
01333     <span class="keywordflow">if</span> (!fUnicode) {
01334         <a class="code" href="../../d6/d8/dispatch_8h.html#a11">TranslateOutputToUnicode</a>(Console,
01335                                  Buffer,
01336                                  BufferSize
01337                                 );
01338         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a53">WriteScreenBuffer</a>(ScreenInfo,
01339                                    Buffer,
01340                                    &amp;ConvRegion
01341                                   );
01342     } <span class="keywordflow">else</span> {
01343         CHAR_INFO StackBuffer[<a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a> * 2];
01344         PCHAR_INFO TransBuffer;
01345         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> StackBufferF = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01346 
01347         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y * <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X &lt;= <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01348             TransBuffer = StackBuffer;
01349             StackBufferF = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01350         } <span class="keywordflow">else</span> {
01351             TransBuffer = (PCHAR_INFO)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),(<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.Y * <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>.X) * 2 * <span class="keyword">sizeof</span>(CHAR_INFO));
01352             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01353                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01354             }
01355         }
01356         <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01357                 ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01358             <a class="code" href="../../d6/d8/dispatch_8h.html#a13">TranslateOutputToAnsiUnicode</a>(Console,
01359                                          Buffer,
01360                                          BufferSize,
01361                                          &amp;TransBuffer[0]
01362                                         );
01363         }
01364         <span class="keywordflow">else</span> {
01365             <a class="code" href="../../d2/d8/directio_8c.html#a11">TranslateOutputToPaddingUnicode</a>(Console,
01366                                             Buffer,
01367                                             BufferSize,
01368                                             &amp;TransBuffer[0]
01369                                            );
01370         }
01371 
01372         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a53">WriteScreenBuffer</a>(ScreenInfo,
01373                                    &amp;TransBuffer[0],
01374                                    &amp;ConvRegion
01375                                   );
01376         <span class="keywordflow">if</span> (!StackBufferF)
01377             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01378     }
01379 
01380     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01381 
01382         ScreenInfo = Console-&gt;CurrentScreenBuffer;
01383 
01384 
01385         <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01386         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
01387             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
01388         }
01389         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ConvAreaInfo-&gt;ConversionAreaMode &amp; (CA_HIDDEN+CA_STATUS_LINE))==(CA_STATUS_LINE)) {
01390             <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y == (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y-1)
01391                )
01392             {
01393                 <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
01394                 ConsoleImeBottomLineUse(ScreenInfo,1);
01395                 CursorPosition = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition;
01396                 CursorPosition.Y--;
01397                 <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(ScreenInfo,CursorPosition,TRUE);
01398                 <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;lpCookedReadData) {
01399                     ((<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;lpCookedReadData))-&gt;OriginalCursorPosition.Y--;
01400                 }
01401                 <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
01402             }
01403             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y == ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom) {
01404                 COORD WindowOrigin ;
01405                 WindowOrigin.X = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left ;
01406                 WindowOrigin.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top+1 ;
01407                 <a class="code" href="../../d6/d2/output_8c.html#a66">SetWindowOrigin</a>(ScreenInfo, TRUE, WindowOrigin) ;
01408                 <span class="keywordflow">if</span> ( ! (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Disable) &amp;&amp;
01409                      ! (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Unavailable) &amp;&amp;
01410                      (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Open) ) {
01411                     SMALL_RECT Rectangle;
01412                     Rectangle.Left = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left ;
01413                     Rectangle.Right = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right ;
01414                     Rectangle.Top = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom ;
01415                     Rectangle.Bottom = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom ;
01416                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01417                     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;Rectangle);
01418                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01419                     WriteConvRegionToScreen(ScreenInfo,
01420                                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;ConsoleIme.ConvAreaRoot,
01421                                             &amp;Rectangle);
01422                 }
01423             }
01424         }
01425 
01426         <span class="comment">//</span>
01427         <span class="comment">// cause screen to be updated</span>
01428         <span class="comment">//</span>
01429         ConvRegion.Left   += (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left + ConvAreaInfo-&gt;CaInfo.coordConView.X);
01430         ConvRegion.Right  += (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left + ConvAreaInfo-&gt;CaInfo.coordConView.X);
01431         ConvRegion.Top    += (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top + ConvAreaInfo-&gt;CaInfo.coordConView.Y);
01432         ConvRegion.Bottom += (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top + ConvAreaInfo-&gt;CaInfo.coordConView.Y);
01433 
01434 
01435         <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01436         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
01437             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
01438         }
01439         <span class="keywordflow">else</span>
01440             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01441         WriteConvRegionToScreen(ScreenInfo,
01442                                 ConvAreaInfo,
01443                                 &amp;ConvRegion
01444                                );
01445         ConvAreaInfo-&gt;ScreenBuffer-&gt;BisectFlag &amp;= ~(BISECT_LEFT | BISECT_RIGHT | BISECT_TOP | BISECT_BOTTOM);
01446     }
01447     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01448 }
01449 
01450 
01451 
01452 
01453 
01454 
01455 
01456 
01457 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01458 ImeControl(
01459     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01460     IN HWND hWndConsoleIME,
01461     IN PCOPYDATASTRUCT lParam
01462     )
01463 
01464 <span class="comment">/*++</span>
01465 <span class="comment"></span>
01466 <span class="comment">Routine Description:</span>
01467 <span class="comment"></span>
01468 <span class="comment">    This routine handle WM_COPYDATA message.</span>
01469 <span class="comment"></span>
01470 <span class="comment">Arguments:</span>
01471 <span class="comment"></span>
01472 <span class="comment">    Console - Pointer to console information structure.</span>
01473 <span class="comment"></span>
01474 <span class="comment">    wParam -</span>
01475 <span class="comment"></span>
01476 <span class="comment">    lParam -</span>
01477 <span class="comment"></span>
01478 <span class="comment">Return Value:</span>
01479 <span class="comment"></span>
01480 <span class="comment">--*/</span>
01481 
01482 {
01483     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
01484     PCONVERSIONAREA_INFORMATION ConvAreaInfo;
01485     PCHAR_INFO SystemString ;
01486     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i ;
01487     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j ;
01488 
01489     <span class="keywordflow">if</span> (lParam == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01490         <span class="comment">// fail safe.</span>
01491         <span class="keywordflow">return</span> STATUS_SUCCESS;
01492     }
01493 
01494     ScreenInfo = Console-&gt;CurrentScreenBuffer;
01495     <span class="keywordflow">switch</span> ((LONG)lParam-&gt;dwData) {
01496         <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a4">CI_CONIMECOMPOSITION</a>:
01497             <span class="keywordflow">if</span> (lParam-&gt;cbData &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>)) {
01498                 <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> CompStr;
01499 
01500                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV: Get IR_CONIMECOMPOSITION Message\n"</span>));
01501                 CompStr = (<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a>)lParam-&gt;lpData;
01502                 <span class="keywordflow">if</span> (CompStr &amp;&amp; CompStr-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> == lParam-&gt;cbData) {
01503                     <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.CompStrData)
01504                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;ConsoleIme.CompStrData);
01505                     Console-&gt;ConsoleIme.CompStrData = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01506                                                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( IME_TAG ),
01507                                                                 CompStr-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>);
01508                     <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.CompStrData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01509                         <span class="keywordflow">break</span>;
01510                     memmove(Console-&gt;ConsoleIme.CompStrData,CompStr,CompStr-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>);
01511                     ConsoleImeCompStr(Console, Console-&gt;ConsoleIme.CompStrData);
01512                 }
01513             }
01514             <span class="keywordflow">break</span>;
01515         <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>:
01516             <span class="keywordflow">if</span> (lParam-&gt;cbData == <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>)) {
01517                 <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo ;
01518 
01519                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV: Get IR_CONIMEMODEINFO Message\n"</span>));
01520 
01521                 lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)lParam-&gt;lpData ;
01522                 <span class="keywordflow">if</span> (lpModeInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01523                     <span class="keywordflow">if</span> (! Console-&gt;InputBuffer.ImeMode.Disable) {
01524                         <span class="keywordflow">if</span> (lpModeInfo-&gt;<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html#o0">ModeStringLen</a> != 0){
01525                             <span class="keywordflow">for</span> (j = 0 ; j &lt; lpModeInfo-&gt;<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html#o0">ModeStringLen</a> ; j++ )
01526                                 lpModeInfo-&gt;<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html#o2">ModeString</a>[j].Attributes = Console-&gt;CurrentScreenBuffer-&gt;Attributes ;
01527                             Console-&gt;ConsoleIme.ConvAreaModePosition = lpModeInfo-&gt;<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html#o1">Position</a>;
01528                             WriteModeSystemChars(Console,
01529                                                  Console-&gt;ConsoleIme.ConvAreaMode,
01530                                                  (PCHAR_INFO)&amp;lpModeInfo-&gt;<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html#o2">ModeString</a>,
01531                                                  lpModeInfo-&gt;<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html#o0">ModeStringLen</a>,
01532                                                  Console-&gt;ConsoleIme.ConvAreaModePosition);
01533                         }
01534                         <span class="keywordflow">else</span>{
01535                             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaMode;
01536                             <span class="keywordflow">if</span> (ConvAreaInfo &amp;&amp;
01537                                 (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN))) {
01538                                 FillUndetermineChars(Console,ConvAreaInfo);
01539                             }
01540                             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaSystem ;
01541                             <span class="keywordflow">if</span> (ConvAreaInfo &amp;&amp;
01542                                 (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN))) {
01543                                 FillUndetermineChars(Console,ConvAreaInfo);
01544                             }
01545                         }
01546                     }
01547                 }
01548             }
01549             <span class="keywordflow">break</span>;
01550         <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a6">CI_CONIMESYSINFO</a>: {
01551             PWCHAR <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> ;
01552 
01553             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV: Get IR_CONIMESYSINFO Message\n"</span>));
01554 
01555             <span class="keywordflow">if</span> ((lParam-&gt;cbData != 0) &amp;&amp;
01556                 (lParam-&gt;lpData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01557                 (! Console-&gt;InputBuffer.ImeMode.Disable)) {
01558                 i = (lParam-&gt;cbData / <span class="keyword">sizeof</span>(WCHAR))-1 ;
01559                 <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> = ((<a class="code" href="../../d0/d9/struct__CONIME__UIMESSAGE.html">LPCONIME_UIMESSAGE</a>)(lParam-&gt;lpData))-&gt;String ;
01560                 SystemString = (PCHAR_INFO)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01561                                                  <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( IME_TAG ),
01562                                                  <span class="keyword">sizeof</span>(CHAR_INFO)*i) ;
01563                 <span class="keywordflow">if</span> (SystemString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01564                     <span class="keywordflow">break</span> ;
01565                 }
01566                 <span class="keywordflow">for</span> (j = 0 ; j &lt; i ; j++ ) {
01567                     SystemString[j].Char.UnicodeChar = *<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> ;
01568                     SystemString[j].Attributes = Console-&gt;CurrentScreenBuffer-&gt;Attributes ;
01569                     <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>++ ;
01570                 }
01571                 WriteModeSystemChars(Console,
01572                                      Console-&gt;ConsoleIme.ConvAreaSystem,
01573                                      (PCHAR_INFO)SystemString,
01574                                      i,
01575                                      VIEW_LEFT);
01576                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(SystemString);
01577             }
01578             <span class="keywordflow">else</span> {
01579                 ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaSystem ;
01580                 <span class="keywordflow">if</span> (ConvAreaInfo &amp;&amp;
01581                     (!(ConvAreaInfo-&gt;ConversionAreaMode &amp; CA_HIDDEN))) {
01582                     FillUndetermineChars(Console,ConvAreaInfo);
01583                 }
01584             }
01585             <span class="keywordflow">break</span>;
01586         }
01587         <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a7">CI_CONIMECANDINFO</a>:{
01588             PWCHAR <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>;
01589             PUCHAR SourceAttr;
01590             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> LengthToWrite;
01591             <a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a> CandInfo = (<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a>)(lParam-&gt;lpData);
01592 
01593             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV: Get IR_CONIMESYSINFO Message\n"</span>));
01594 
01595             <span class="keywordflow">if</span> ((lParam-&gt;cbData != 0) &amp;&amp;
01596                 (CandInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ){
01597                 <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> = CandInfo-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o1">String</a>;
01598                 SourceAttr = (PUCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CandInfo + CandInfo-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a>);
01599                 LengthToWrite = lstrlenW(SourceString);
01600                 SystemString = (PCHAR_INFO)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01601                                                  <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( IME_TAG ),
01602                                                  <span class="keyword">sizeof</span>(CHAR_INFO) * LengthToWrite);
01603                 <span class="keywordflow">if</span> (SystemString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01604                     <span class="keywordflow">break</span> ;
01605                 }
01606                 <span class="keywordflow">for</span> (j = 0 ; j &lt; LengthToWrite ; j++ ) {
01607                     SystemString[j].Char.UnicodeChar = *<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> ;
01608                     <span class="keywordflow">if</span> (*SourceAttr == 1 &amp;&amp;
01609                         Console-&gt;ConsoleIme.CompStrData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01610                         SystemString[j].Attributes = Console-&gt;ConsoleIme.CompStrData-&gt;CompAttrColor[1];
01611                     }
01612                     <span class="keywordflow">else</span> {
01613                         SystemString[j].Attributes = Console-&gt;CurrentScreenBuffer-&gt;Attributes ;
01614                     }
01615                     <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>++ ;
01616                     SourceAttr++ ;
01617                 }
01618                 WriteModeSystemChars(Console,
01619                                      Console-&gt;ConsoleIme.ConvAreaSystem,
01620                                      (PCHAR_INFO)SystemString,
01621                                      LengthToWrite,
01622                                      VIEW_LEFT);
01623                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(SystemString);
01624             }
01625             <span class="keywordflow">else</span> {
01626                 ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaSystem;
01627                 <span class="keywordflow">if</span> (ConvAreaInfo) {
01628                     SMALL_RECT rcViewCaWindow = {0, 0, 0, 0};
01629                     FillUndetermineChars(Console,ConvAreaInfo);
01630                     ConvAreaInfo-&gt;ConversionAreaMode |= CA_HIDDEN;
01631                     ConsoleImeWindowInfo(Console,ConvAreaInfo,rcViewCaWindow);
01632                 }
01633             }
01634             <span class="keywordflow">break</span>;
01635         }
01636         <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a8">CI_CONIMEPROPERTYINFO</a>:{
01637             WPARAM* wParam = (WPARAM*)(lParam-&gt;lpData);
01638 
01639             <span class="keywordflow">if</span> ((lParam-&gt;cbData != 0) &amp;&amp;
01640                 (wParam != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ){
01641                 <span class="keywordflow">switch</span> (*wParam) {
01642                     <span class="keywordflow">case</span> IMS_OPENPROPERTYWINDOW:
01643                         Console-&gt;InputBuffer.hWndConsoleIME = hWndConsoleIME;
01644                         <span class="keywordflow">break</span>;
01645                     <span class="keywordflow">case</span> IMS_CLOSEPROPERTYWINDOW:
01646                         Console-&gt;InputBuffer.hWndConsoleIME = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01647                         <a class="code" href="../../d3/d0/user32_8def.html#a43">SetFocus</a>(Console-&gt;hWnd);
01648                         <span class="keywordflow">break</span>;
01649                 }
01650             }
01651             <span class="keywordflow">break</span>;
01652         }
01653     }
01654 
01655     <span class="keywordflow">return</span> STATUS_SUCCESS;
01656 }
01657 
01658 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
01659 InsertConverTedString(
01660     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01661     LPWSTR lpStr
01662     )
01663 {
01664     ULONG EventsWritten;
01665     PINPUT_RECORD InputEvent,TmpInputEvent;
01666     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwControlKeyState;
01667     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen;
01668     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwConversion;
01669     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01670 
01671     <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01672     <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
01673         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
01674     }
01675     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.CursorOn){
01676         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a6">CursorTimerRoutine</a>(Console-&gt;CurrentScreenBuffer) ;
01677     }
01678 
01679     dwLen = wcslen(lpStr)+1;
01680     InputEvent = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( IME_TAG ),<span class="keyword">sizeof</span>(INPUT_RECORD)*dwLen);
01681     <span class="keywordflow">if</span> (InputEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01682         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01683     }
01684 
01685     TmpInputEvent = InputEvent;
01686     dwControlKeyState = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a42">GetControlKeyState</a>(0);
01687 
01688     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(GetImeKeyState(Console, &amp;dwConversion))) {
01689         <span class="keywordflow">goto</span> skip_and_return;
01690     }
01691 
01692     dwControlKeyState |= <a class="code" href="../../d0/d3/dbcs_8h.html#a54">ImmConversionToConsole</a>(dwConversion);
01693 
01694     <span class="keywordflow">while</span> (*lpStr) {
01695         TmpInputEvent-&gt;EventType = KEY_EVENT;
01696         TmpInputEvent-&gt;Event.KeyEvent.bKeyDown = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01697         TmpInputEvent-&gt;Event.KeyEvent.wVirtualKeyCode = 0;
01698         TmpInputEvent-&gt;Event.KeyEvent.wVirtualScanCode = 0;
01699         TmpInputEvent-&gt;Event.KeyEvent.dwControlKeyState = dwControlKeyState;
01700         TmpInputEvent-&gt;Event.KeyEvent.uChar.UnicodeChar = *lpStr++;
01701         TmpInputEvent-&gt;Event.KeyEvent.wRepeatCount = 1;
01702         TmpInputEvent++;
01703     }
01704 
01705     EventsWritten = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>( Console,
01706                                       &amp;Console-&gt;InputBuffer,
01707                                       InputEvent,
01708                                       dwLen-1
01709                                      );
01710 
01711     fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01712 
01713 skip_and_return:
01714     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(InputEvent);
01715     <span class="keywordflow">return</span> fResult;
01716 }
01717 
01718 
01719 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01720 SetUndetermineAttribute(
01721     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
01722     )
01723 {
01724 
01725     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
01726     PCONVERSIONAREA_INFORMATION ConvAreaInfo ;
01727 
01728     ScreenInfo = Console-&gt;CurrentScreenBuffer;
01729 
01730     ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot ;
01731     <span class="keywordflow">if</span> (ConvAreaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01732         <span class="keywordflow">do</span> {
01733             ConvAreaInfo-&gt;ScreenBuffer-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a> = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a>;
01734             ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext ;
01735         } <span class="keywordflow">while</span> (ConvAreaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01736     }
01737 
01738     <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.ConvAreaMode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01739         Console-&gt;ConsoleIme.ConvAreaMode-&gt;ScreenBuffer-&gt;Attributes = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a>;
01740 
01741     <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.ConvAreaSystem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01742         Console-&gt;ConsoleIme.ConvAreaSystem-&gt;ScreenBuffer-&gt;Attributes = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a>;
01743 }
01744 
01745 
01746 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01747 StreamWriteToScreenBufferIME(
01748     IN PWCHAR String,
01749     IN SHORT StringLength,
01750     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01751     IN PCHAR StringA
01752     )
01753 {
01754     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
01755     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
01756     PWCHAR Char;
01757     COORD TargetPoint;
01758 
01759     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"StreamWriteToScreenBuffer\n"</span>));
01760 
01761     <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01762     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(ScreenInfo-&gt;Flags &amp; CONSOLE_GRAPHICS_BUFFER));
01763 
01764     ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01765     TargetPoint = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
01766     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TargetPoint.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
01767     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01768     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"RowIndex = %lx, Row = %lx, TargetPoint = (%d,%d)\n"</span>,
01769             RowIndex, Row, TargetPoint.X, TargetPoint.Y));
01770 
01771     <span class="comment">//</span>
01772     <span class="comment">// copy chars</span>
01773     <span class="comment">//</span>
01774 
01775 <span class="comment">//#if defined(FE_SB)</span>
01776     <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>(StringLength,TargetPoint,ScreenInfo);
01777     <span class="keywordflow">if</span> (TargetPoint.Y == ScreenInfo-&gt;ScreenBufferSize.Y-1 &amp;&amp;
01778         TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> &gt;= ScreenInfo-&gt;ScreenBufferSize.X &amp;&amp;
01779         *(StringA+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X-1) &amp; ATTR_LEADING_BYTE
01780        ) {
01781         *(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01782         *(StringA+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X-1) = 0;
01783         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> &gt; ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X-1) {
01784             *(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01785             *(StringA+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X) = 0;
01786         }
01787     }
01788 <span class="comment">//#endif</span>
01789     RtlCopyMemory(&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X],String,StringLength*<span class="keyword">sizeof</span>(WCHAR));
01790 <span class="comment">//#if defined(FE_SB)</span>
01791     RtlCopyMemory(&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X],StringA,StringLength*<span class="keyword">sizeof</span>(CHAR));
01792 <span class="comment">//#endif</span>
01793 
01794     <span class="comment">// recalculate first and last non-space char</span>
01795 
01796     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;
01797     <span class="keywordflow">if</span> (TargetPoint.X &lt; Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>) {
01798 <span class="comment">//#if defined(FE_SB)</span>
01799         <span class="comment">/*</span>
01800 <span class="comment">         * CharRow.Left is leftmost bound of chars in Chars array (array will be full width)</span>
01801 <span class="comment">         * i.e. type is COORD</span>
01802 <span class="comment">         */</span>
01803         PWCHAR LastChar = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[ScreenInfo-&gt;ScreenBufferSize.X-1];
01804 <span class="comment">//#else</span>
01805 <span class="comment">//        PWCHAR LastChar = &amp;Row-&gt;CharRow.Chars[ScreenInfo-&gt;ScreenBufferSize.X];</span>
01806 <span class="comment">//#endif</span>
01807 
01808         <span class="keywordflow">for</span> (Char=&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X];Char &lt; LastChar &amp;&amp; *Char==(WCHAR)<span class="charliteral">' '</span>;Char++)
01809             ;
01810         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Char-Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>);
01811     }
01812 
01813     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>;
01814     <span class="keywordflow">if</span> ((TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>) &gt;= Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>) {
01815         PWCHAR FirstChar = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>;
01816 
01817         <span class="keywordflow">for</span> (Char=&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>-1];*Char==(WCHAR)<span class="charliteral">' '</span> &amp;&amp; Char &gt;= FirstChar;Char--)
01818             ;
01819         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Char+1-FirstChar);
01820     }
01821 
01822     <span class="comment">//</span>
01823     <span class="comment">// see if attr string is different.  if so, allocate a new</span>
01824     <span class="comment">// attr buffer and merge the two strings.</span>
01825     <span class="comment">//</span>
01826 
01827     <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1 ||
01828         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> != ScreenInfo-&gt;Attributes) {
01829         <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> NewAttrs;
01830         WORD NewAttrsLength;
01831         <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a> Attrs;
01832 
01833 <span class="comment">//#if defined(FE_SB) &amp;&amp; defined(FE_IME)</span>
01834         <span class="keywordflow">if</span> ((ScreenInfo-&gt;Attributes &amp; (COMMON_LVB_GRID_SINGLEFLAG + COMMON_LVB_GRID_RVERTICAL)) ==
01835             (COMMON_LVB_GRID_SINGLEFLAG + COMMON_LVB_GRID_RVERTICAL)){
01836             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i ;
01837             <span class="keywordflow">for</span> (i = 0 ; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> ; i++ ) {
01838                 Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 1 ;
01839                 <span class="keywordflow">if</span> (*(StringA + i) &amp; ATTR_LEADING_BYTE)
01840                     Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = ScreenInfo-&gt;Attributes &amp; ~(COMMON_LVB_GRID_SINGLEFLAG + COMMON_LVB_GRID_RVERTICAL) ;
01841                 <span class="keywordflow">else</span>
01842                     Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = ScreenInfo-&gt;Attributes &amp; ~COMMON_LVB_GRID_SINGLEFLAG ;
01843 
01844                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
01845                                  Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a>,
01846                                  &amp;Attrs,
01847                                  1,
01848                                  &amp;NewAttrs,
01849                                  &amp;NewAttrsLength,
01850                                  (SHORT)(TargetPoint.X+i),
01851                                  (SHORT)(TargetPoint.X+i),
01852                                  Row,
01853                                  ScreenInfo
01854                                 ))) {
01855                     <span class="keywordflow">return</span>;
01856                 }
01857                 <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> &gt; 1) {
01858                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
01859                 }
01860                 <span class="keywordflow">else</span> {
01861                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> == &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>);
01862                 }
01863                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = NewAttrs;
01864                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = NewAttrsLength;
01865             }
01866             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01867             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01868         }
01869         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ScreenInfo-&gt;Attributes &amp; (COMMON_LVB_GRID_SINGLEFLAG + COMMON_LVB_GRID_LVERTICAL)) ==
01870             (COMMON_LVB_GRID_SINGLEFLAG + COMMON_LVB_GRID_LVERTICAL)){
01871             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i ;
01872             <span class="keywordflow">for</span> (i = 0 ; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> ; i++ ) {
01873                 Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 1 ;
01874                 <span class="keywordflow">if</span> (*(StringA + i) &amp; ATTR_TRAILING_BYTE)
01875                     Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = ScreenInfo-&gt;Attributes &amp; ~(COMMON_LVB_GRID_SINGLEFLAG + COMMON_LVB_GRID_LVERTICAL);
01876                 <span class="keywordflow">else</span>
01877                     Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = ScreenInfo-&gt;Attributes &amp; ~COMMON_LVB_GRID_SINGLEFLAG ;
01878 
01879                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
01880                                  Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a>,
01881                                  &amp;Attrs,
01882                                  1,
01883                                  &amp;NewAttrs,
01884                                  &amp;NewAttrsLength,
01885                                  (SHORT)(TargetPoint.X+i),
01886                                  (SHORT)(TargetPoint.X+i),
01887                                  Row,
01888                                  ScreenInfo
01889                                 ))) {
01890                     <span class="keywordflow">return</span>;
01891                 }
01892                 <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> &gt; 1) {
01893                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
01894                 }
01895                 <span class="keywordflow">else</span> {
01896                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> == &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>);
01897                 }
01898                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = NewAttrs;
01899                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = NewAttrsLength;
01900             }
01901             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01902             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01903         }
01904         <span class="keywordflow">else</span>{
01905 <span class="comment">//#endif</span>
01906         Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>;
01907         Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = ScreenInfo-&gt;Attributes;
01908         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
01909                          Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a>,
01910                          &amp;Attrs,
01911                          1,
01912                          &amp;NewAttrs,
01913                          &amp;NewAttrsLength,
01914                          TargetPoint.X,
01915                          (SHORT)(TargetPoint.X+StringLength-1),
01916                          Row,
01917                          ScreenInfo
01918                         ))) {
01919             <span class="keywordflow">return</span>;
01920         }
01921         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> &gt; 1) {
01922             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
01923         }
01924         <span class="keywordflow">else</span> {
01925             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> == &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>);
01926         }
01927         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = NewAttrs;
01928         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = NewAttrsLength;
01929         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01930         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01931 <span class="comment">//#if defined(FE_SB) &amp;&amp; defined(FE_IME)</span>
01932     }
01933 <span class="comment">//#endif</span>
01934     }
01935     <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,TargetPoint.Y,TargetPoint.Y);
01936 }
01937 
01938 <span class="preprocessor">#endif // FE_IME</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
