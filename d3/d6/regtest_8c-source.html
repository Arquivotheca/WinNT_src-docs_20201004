<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: regtest.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>regtest.c</h1><a href="../../d2/d7/regtest_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    regtest.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   Test for quick and dirty registry test (very basic)</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 30-Apr-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    User mode.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "stdio.h"</span>
00026 <span class="preprocessor">#include "nt.h"</span>
00027 
00028 <span class="keywordtype">int</span> <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(PUCHAR);
00029 <span class="keywordtype">void</span> <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>();
00030 
00031 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d7/regtest_8c.html#a4">DoTest</a>(HANDLE RootKey);
00032 
<a name="l00033"></a><a class="code" href="../../d2/d7/regtest_8c.html#a0">00033</a> <span class="preprocessor">#define MAX_VALUE   256</span>
<a name="l00034"></a><a class="code" href="../../d2/d7/regtest_8c.html#a1">00034</a> <span class="preprocessor"></span>UCHAR <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>[<a class="code" href="../../d2/d7/regtest_8c.html#a0">MAX_VALUE</a>];
00035 
00036 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00037 <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>()
00038 {
00039     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Machine\n"</span>);
00040     <a class="code" href="../../d2/d7/regtest_8c.html#a4">DoTest</a>((HANDLE)REG_LOCAL_MACHINE);
00041     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"User\n"</span>);
00042     <a class="code" href="../../d2/d7/regtest_8c.html#a4">DoTest</a>((HANDLE)REG_LOCAL_USER);
00043 }
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00045"></a><a class="code" href="../../d2/d7/regtest_8c.html#a4">00045</a> <a class="code" href="../../d2/d7/regtest_8c.html#a4">DoTest</a>(
00046     HANDLE  RootKey
00047     )
00048 {
00049     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> rc;
00050     STRING <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>;
00051     UCHAR Value1[] = <span class="stringliteral">"This string is value 1."</span>;
00052     UCHAR Value2[] = <span class="stringliteral">"Value 2 is represented by this string."</span>;
00053     HANDLE Handle1;
00054     HANDLE Handle2;
00055     ULONG ValueLength;
00056     ULONG Type;
00057     LARGE_INTEGER <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>;
00058 
00059     <span class="comment">//</span>
00060     <span class="comment">// Create parent node</span>
00061     <span class="comment">//</span>
00062 
00063     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part1\n"</span>);
00064     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;<a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>,  <span class="stringliteral">"Test1"</span>);
00065     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00066         RootKey,
00067         &amp;<a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>,
00068         0,
00069         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00070         GENERIC_READ|GENERIC_WRITE,
00071         &amp;Handle1
00072         );
00073 
00074     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00075         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"1:CreateKey failed rc  = %08lx"</span>, rc);
00076         <span class="keywordflow">return</span>;
00077     }
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">// Set data into parent</span>
00081     <span class="comment">//</span>
00082 
00083     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part2\n"</span>);
00084     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00085         Handle1,
00086         1,              <span class="comment">// type</span>
00087         Value1,
00088         <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(Value1)
00089         );
00090 
00091     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00092         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"2:SetValueKey failed rc  = %08lx"</span>, rc);
00093         <span class="keywordflow">return</span>;
00094     }
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">// Query and compare data from parent</span>
00098     <span class="comment">//</span>
00099 
00100     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part2b\n"</span>);
00101     ValueLength = <a class="code" href="../../d2/d7/regtest_8c.html#a0">MAX_VALUE</a>;
00102     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00103         Handle1,
00104         &amp;Type,
00105         <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
00106         &amp;ValueLength,
00107         &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>
00108         );
00109 
00110     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00111         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"2b:QueryValueKey failed rc  = %08lx"</span>, rc);
00112         <span class="keywordflow">return</span>;
00113     }
00114 
00115     <span class="keywordflow">if</span> (ValueLength != (ULONG)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(Value1)) {
00116         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"2b1:Wrong value length\n"</span>);
00117         <span class="keywordflow">return</span>;
00118     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RtlCompareMemory(
00119                 <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>, Value1, ValueLength) != ValueLength) {
00120         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"2b2:Wrong value\n"</span>);
00121         <span class="keywordflow">return</span>;
00122     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Type != 1) {
00123         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"2b3:Wrong type\n"</span>);
00124         <span class="keywordflow">return</span>;
00125     }
00126 
00127 
00128     <span class="comment">//</span>
00129     <span class="comment">// Close parent</span>
00130     <span class="comment">//</span>
00131 
00132     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part3\n"</span>);
00133     NtCloseKey(Handle1);
00134 
00135     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00136         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"3:CloseKey failed rc  = %08lx"</span>, rc);
00137         <span class="keywordflow">return</span>;
00138     }
00139 
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">// Reopen parent</span>
00143     <span class="comment">//</span>
00144 
00145     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part4\n"</span>);
00146     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00147         RootKey,
00148         &amp;<a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>,
00149         0,
00150         GENERIC_READ|GENERIC_WRITE,
00151         &amp;Handle1
00152         );
00153 
00154     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00155         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"4:OpenKey failed rc  = %08lx"</span>, rc);
00156         <span class="keywordflow">return</span>;
00157     }
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// Create child</span>
00161     <span class="comment">//</span>
00162 
00163     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part5\n"</span>);
00164     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;<a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>,  <span class="stringliteral">"Test2"</span>);
00165     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00166         Handle1,
00167         &amp;<a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>,
00168         0,
00169         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00170         GENERIC_READ|GENERIC_WRITE,
00171         &amp;Handle2
00172         );
00173 
00174     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00175         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"5:CreateKey failed rc  = %08lx"</span>, rc);
00176         <span class="keywordflow">return</span>;
00177     }
00178 
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">// Set data into child</span>
00182     <span class="comment">//</span>
00183 
00184     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part6\n"</span>);
00185     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00186         Handle2,
00187         2,              <span class="comment">// type</span>
00188         Value2,
00189         <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(Value2)
00190         );
00191 
00192     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00193         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"6:SetValueKey failed rc  = %08lx"</span>, rc);
00194         <span class="keywordflow">return</span>;
00195     }
00196 
00197 
00198     <span class="comment">//</span>
00199     <span class="comment">// Query and compare data from child</span>
00200     <span class="comment">//</span>
00201 
00202     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part7\n"</span>);
00203     ValueLength = <a class="code" href="../../d2/d7/regtest_8c.html#a0">MAX_VALUE</a>;
00204     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00205         Handle2,
00206         &amp;Type,
00207         <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
00208         &amp;ValueLength,
00209         &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>
00210         );
00211 
00212     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00213         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"7:QueryValueKey failed rc  = %08lx"</span>, rc);
00214         <span class="keywordflow">return</span>;
00215     }
00216 
00217     <span class="keywordflow">if</span> (ValueLength != (ULONG)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(Value2)) {
00218         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"7.1:Wrong value length\n"</span>);
00219         <span class="keywordflow">return</span>;
00220     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RtlCompareMemory(
00221                 <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>, Value2, ValueLength) != ValueLength) {
00222         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"7.2:Wrong value\n"</span>);
00223         <span class="keywordflow">return</span>;
00224     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Type != 2) {
00225         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"7.3:Wrong type\n"</span>);
00226         <span class="keywordflow">return</span>;
00227     }
00228 
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">// Query and compare data from parent again</span>
00232     <span class="comment">//</span>
00233 
00234     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part8\n"</span>);
00235     ValueLength = <a class="code" href="../../d2/d7/regtest_8c.html#a0">MAX_VALUE</a>;
00236     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00237         Handle1,
00238         &amp;Type,
00239         <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
00240         &amp;ValueLength,
00241         &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>
00242         );
00243 
00244     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00245         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"8:QueryValueKey failed rc  = %08lx"</span>, rc);
00246         <span class="keywordflow">return</span>;
00247     }
00248 
00249     <span class="keywordflow">if</span> (ValueLength != (ULONG)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(Value1)) {
00250         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"8.1:Wrong value length\n"</span>);
00251         <span class="keywordflow">return</span>;
00252     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RtlCompareMemory(
00253                 <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>, Value1, ValueLength) != ValueLength) {
00254         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"8.2:Wrong value\n"</span>);
00255         <span class="keywordflow">return</span>;
00256     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Type != 1) {
00257         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"8.3:Wrong type\n"</span>);
00258         <span class="keywordflow">return</span>;
00259     }
00260 
00261 
00262     <span class="comment">//</span>
00263     <span class="comment">// Reset parent data</span>
00264     <span class="comment">//</span>
00265 
00266     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part9\n"</span>);
00267     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00268         Handle1,
00269         1,              <span class="comment">// type</span>
00270         Value2,
00271         <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(Value2)
00272         );
00273 
00274     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00275         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"9:SetValueKey failed rc  = %08lx"</span>, rc);
00276         <span class="keywordflow">return</span>;
00277     }
00278 
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">// Query and compare reset data</span>
00282     <span class="comment">//</span>
00283 
00284     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part10\n"</span>);
00285     ValueLength = <a class="code" href="../../d2/d7/regtest_8c.html#a0">MAX_VALUE</a>;
00286     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00287         Handle1,
00288         &amp;Type,
00289         <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
00290         &amp;ValueLength,
00291         &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>
00292         );
00293 
00294     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00295         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"10:QueryValueKey failed rc  = %08lx"</span>, rc);
00296         <span class="keywordflow">return</span>;
00297     }
00298 
00299     <span class="keywordflow">if</span> (ValueLength != (ULONG)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(Value2)) {
00300         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"10.1:Wrong value length\n"</span>);
00301         <span class="keywordflow">return</span>;
00302     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RtlCompareMemory(
00303                 <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>, Value2, ValueLength) != ValueLength) {
00304         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"10.2:Wrong value\n"</span>);
00305         <span class="keywordflow">return</span>;
00306     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Type != 1) {
00307         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"10.3:Wrong type\n"</span>);
00308         <span class="keywordflow">return</span>;
00309     }
00310 
00311     <span class="comment">//</span>
00312     <span class="comment">// Close off handles and return</span>
00313     <span class="comment">//</span>
00314 
00315     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part11\n"</span>);
00316     rc = NtCloseKey(Handle1);
00317 
00318     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00319         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"11:CloseKey failed rc  = %08lx"</span>, rc);
00320         <span class="keywordflow">return</span>;
00321     }
00322 
00323     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Part12\n"</span>);
00324     rc = NtCloseKey(Handle2);
00325     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(rc)) {
00326         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"12:CloseKey failed rc  = %08lx"</span>, rc);
00327         <span class="keywordflow">return</span>;
00328     }
00329 
00330     <span class="keywordflow">return</span>;
00331 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
