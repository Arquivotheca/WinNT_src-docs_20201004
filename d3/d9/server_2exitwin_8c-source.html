<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: exitwin.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exitwin.c</h1><a href="../../d2/d0/server_2exitwin_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: exitwin.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* NT: Logoff user</span>
00007 <span class="comment">* DOS: Exit windows</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">* 07-23-92 ScottLu      Created.</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d2/d4/w32_2ntuser_2server_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
<a name="l00016"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a0">00016</a> <span class="preprocessor">#define BEGIN_LPC_RECV(API)                                                 \</span>
00017 <span class="preprocessor">    P##API##MSG a = (P##API##MSG)&amp;m-&gt;u.ApiMessageData;                      \</span>
00018 <span class="preprocessor">    PCSR_THREAD pcsrt;                                                      \</span>
00019 <span class="preprocessor">    PTEB Teb = NtCurrentTeb();                                              \</span>
00020 <span class="preprocessor">    NTSTATUS Status = STATUS_SUCCESS;                                       \</span>
00021 <span class="preprocessor">    UNREFERENCED_PARAMETER(ReplyStatus);                                    \</span>
00022 <span class="preprocessor">                                                                            \</span>
00023 <span class="preprocessor">    Teb-&gt;LastErrorValue = 0;                                                \</span>
00024 <span class="preprocessor">    pcsrt = CSR_SERVER_QUERYCLIENTTHREAD();</span>
00025 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a1">00026</a> <span class="preprocessor">#define END_LPC_RECV()                                                  \</span>
00027 <span class="preprocessor">    a-&gt;dwLastError = Teb-&gt;LastErrorValue;                               \</span>
00028 <span class="preprocessor">    return Status;</span>
00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a2">00030</a> <span class="preprocessor">#define CCHMSGMAX   256</span>
<a name="l00031"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a3">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define CCHBODYMAX  512</span>
00032 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a4">00033</a> <span class="preprocessor">#define CSR_THREAD_SHUTDOWNSKIP 0x00000008</span>
00034 <span class="preprocessor"></span>
00035 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a8">WowExitTask</a>(PCSR_THREAD pcsrt);
00036 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a37">UserClientShutdown</a>(PCSR_PROCESS pcsrp, ULONG dwFlags, BOOLEAN fFirstPass);
00037 
00038 <span class="comment">/***************************************************************************\</span>
00039 <span class="comment">* _ExitWindowsEx</span>
00040 <span class="comment">*</span>
00041 <span class="comment">* Determines whether shutdown is allowed, and if so calls CSR to start</span>
00042 <span class="comment">* shutting down processes. If this succeeds all the way through, tell winlogon</span>
00043 <span class="comment">* so it'll either logoff or reboot the system. Shuts down the processes in</span>
00044 <span class="comment">* the caller's sid.</span>
00045 <span class="comment">*</span>
00046 <span class="comment">* History</span>
00047 <span class="comment">* 07-23-92 ScottLu      Created.</span>
00048 <span class="comment">\***************************************************************************/</span>
00049 
<a name="l00050"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a10">00050</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a10">_ExitWindowsEx</a>(
00051     PCSR_THREAD pcsrt,
00052     UINT dwFlags,
00053     DWORD dwReserved)
00054 {
00055     LUID luidCaller;
00056     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00057 
00058     UNREFERENCED_PARAMETER(dwReserved);
00059 
00060     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_REBOOT) || (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_POWEROFF)) {
00061         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= EWX_SHUTDOWN;
00062     }
00063 
00064     <span class="comment">//</span>
00065     <span class="comment">// Only winlogon gets to set the high flags:</span>
00066     <span class="comment">//</span>
00067 
00068     <span class="keywordflow">if</span> ( ( <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; ( ~ ( EWX_VALID ) ) ) != 0 )
00069     {
00070         <span class="keywordflow">if</span> ( HandleToUlong(pcsrt-&gt;ClientId.UniqueProcess) != <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a10">gIdLogon</a> )
00071         {
00072             KdPrint(( <span class="stringliteral">"Process %x tried to call ExitWindowsEx with flags %x\n"</span>,
00073                         pcsrt-&gt;ClientId.UniqueProcess, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> ));
00074 
00075             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED ;
00076         }
00077     }
00078 
00079     <span class="comment">/*</span>
00080 <span class="comment">     * Find out the callers sid. Only want to shutdown processes in the</span>
00081 <span class="comment">     * callers sid.</span>
00082 <span class="comment">     */</span>
00083     <span class="keywordflow">if</span> (!CsrImpersonateClient(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00084         <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00085     }
00086 
00087     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = CsrGetProcessLuid(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;luidCaller);
00088     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00089         CsrRevertToSelf();
00090         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00091     }
00092 
00093     <span class="comment">/*</span>
00094 <span class="comment">     * Loop until we can do the shutdown; if we cannot do it,</span>
00095 <span class="comment">     *  we'll go to fastexit and bail.</span>
00096 <span class="comment">     */</span>
00097     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00098 
00099         LARGE_INTEGER li;
00100 
00101         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(pcsrt-&gt;ThreadHandle,
00102                                             UserThreadInitiateShutdown,
00103                                             &amp;<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>));
00104 
00105         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00106         <span class="keywordflow">case</span> STATUS_PENDING:
00107             <span class="comment">/*</span>
00108 <span class="comment">             * The logoff/shutdown is in progress and nothing</span>
00109 <span class="comment">             * more needs to be done.</span>
00110 <span class="comment">             */</span>
00111             <span class="keywordflow">goto</span> fastexit;
00112 
00113         <span class="keywordflow">case</span> STATUS_RETRY:
00114             <span class="comment">/*</span>
00115 <span class="comment">             * Another logoff/shutdown is in progress and we need</span>
00116 <span class="comment">             * to cancel it so we can do an override.</span>
00117 <span class="comment">             *</span>
00118 <span class="comment">             * if someone else is trying to cancel shutdown, exit</span>
00119 <span class="comment">             */</span>
00120             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00121             li.QuadPart  = 0;
00122             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a20">gheventCancel</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;li) == WAIT_OBJECT_0) {
00123                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
00124                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00125                 <span class="keywordflow">goto</span> fastexit;
00126             }
00127             <span class="comment">/*</span>
00128 <span class="comment">             * If no one will set gheventCancelled, don't wait.</span>
00129 <span class="comment">             */</span>
00130             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> == 0) {
00131                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00132                 <span class="keywordflow">continue</span>;
00133             }
00134 
00135             <a class="code" href="../../d0/d8/ex_2event_8c.html#a4">NtClearEvent</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a21">gheventCancelled</a>);
00136             <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a20">gheventCancel</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00137             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00138             <span class="comment">/*</span>
00139 <span class="comment">             * Wait for the other guy to be cancelled</span>
00140 <span class="comment">             */</span>
00141             <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a21">gheventCancelled</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00142 
00143             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00144             <span class="comment">/*</span>
00145 <span class="comment">             * This signals that we are no longer trying to cancel a</span>
00146 <span class="comment">             * shutdown</span>
00147 <span class="comment">             */</span>
00148             <a class="code" href="../../d0/d8/ex_2event_8c.html#a4">NtClearEvent</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a20">gheventCancel</a>);
00149             <span class="comment">/*</span>
00150 <span class="comment">             * If someone managed to start a shutdown again, exit</span>
00151 <span class="comment">             *  Can this happen? Let's assert to check it out.</span>
00152 <span class="comment">             */</span>
00153             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> != 0) {
00154                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> == 0);
00155                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
00156                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00157                 <span class="keywordflow">goto</span> fastexit;
00158             }
00159             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00160             <span class="keywordflow">continue</span>;
00161 
00162         <span class="keywordflow">case</span> STATUS_CANT_WAIT:
00163 
00164             <span class="comment">/*</span>
00165 <span class="comment">             * There is no notify window and the calling thread has</span>
00166 <span class="comment">             * windows that prevent this request from succeeding.</span>
00167 <span class="comment">             * The client handles this by starting another thread</span>
00168 <span class="comment">             * to recall ExitWindowsEx.</span>
00169 <span class="comment">             */</span>
00170             <span class="keywordflow">goto</span> fastexit;
00171 
00172         <span class="keywordflow">default</span>:
00173             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00174                 SetLastError(<a class="code" href="../../d6/d7/error_8c.html#a0">RtlNtStatusToDosError</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00175                 <span class="keywordflow">goto</span> fastexit;
00176             }
00177         }
00178         <span class="keywordflow">break</span>;
00179     }
00180 
00181     <span class="comment">/*</span>
00182 <span class="comment">     * This thread is doing the shutdown</span>
00183 <span class="comment">     */</span>
00184     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00185     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> == 0);
00186     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> = HandleToUlong(pcsrt-&gt;ClientId.UniqueThread);
00187     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00188 
00189     <span class="comment">/*</span>
00190 <span class="comment">     * Call csr to loop through the processes shutting them down.</span>
00191 <span class="comment">     */</span>
00192     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = CsrShutdownProcesses(&amp;luidCaller, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00193     <span class="comment">/*</span>
00194 <span class="comment">     * Tell win32k.sys we're done.</span>
00195 <span class="comment">     */</span>
00196     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(pcsrt-&gt;ThreadHandle, UserThreadEndShutdown, &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00197 
00198     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00199     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> = 0;
00200     <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a21">gheventCancelled</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00201     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00202 
00203 fastexit:
00204     CsrRevertToSelf();
00205 
00206     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00207 }
00208 
00209 <span class="comment">/***************************************************************************\</span>
00210 <span class="comment">* UserClientShutdown</span>
00211 <span class="comment">*</span>
00212 <span class="comment">* This gets called from CSR. If we recognize the application (i.e., it has a</span>
00213 <span class="comment">* top level window), then send queryend/end session messages to it. Otherwise</span>
00214 <span class="comment">* say we don't recognize it.</span>
00215 <span class="comment">*</span>
00216 <span class="comment">* 07-23-92 ScottLu      Created.</span>
00217 <span class="comment">\***************************************************************************/</span>
00218 
<a name="l00219"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a9">00219</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a37">UserClientShutdown</a>(
00220     PCSR_PROCESS pcsrp,
00221     ULONG dwFlags,
00222     BOOLEAN fFirstPass)
00223 {
00224     PLIST_ENTRY ListHead, ListNext;
00225     PCSR_PROCESS Process;
00226     PCSR_THREAD Thread;
00227     USERTHREAD_SHUTDOWN_INFORMATION ShutdownInfo;
00228     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNoMsgs;
00229     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNoMsgsEver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00230     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Forced = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00231     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDoBlock;
00232     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNoRetry;
00233     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cmd = 0, dwClientFlags;
00234     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00235     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TerminateStatus = STATUS_ACCESS_DENIED;
00236     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cThreads;
00237     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSendEndSession = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00238 
00239 <span class="preprocessor">#if DBG</span>
00240 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLocalThreadEndSession = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a>;
00241 <span class="preprocessor">#endif</span>
00242 <span class="preprocessor"></span>
00243     <span class="comment">/*</span>
00244 <span class="comment">     * If this is a logoff and the process does not belong to</span>
00245 <span class="comment">     * the account doing the logoff and is not LocalSystem,</span>
00246 <span class="comment">     * do not send end-session messages.  Console will notify</span>
00247 <span class="comment">     * the app of the logoff.</span>
00248 <span class="comment">     */</span>
00249     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_SHUTDOWN) &amp;&amp; (pcsrp-&gt;ShutdownFlags &amp; SHUTDOWN_OTHERCONTEXT)) {
00250         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
00251         <span class="keywordflow">goto</span> CleanupAndExit;
00252     }
00253 
00254     <span class="comment">/*</span>
00255 <span class="comment">     * Calculate whether to allow exit and force-exit this process before</span>
00256 <span class="comment">     * we unlock pcsrp.</span>
00257 <span class="comment">     */</span>
00258     fNoRetry = (pcsrp-&gt;ShutdownFlags &amp; SHUTDOWN_NORETRY) ||
00259             (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_FORCE);
00260 
00261     <span class="comment">/*</span>
00262 <span class="comment">     * Setup flags for WM_CLIENTSHUTDOWN</span>
00263 <span class="comment">     * -Assume the process is going to OK the WM_QUERYENDSESSION (WMCS_EXIT)</span>
00264 <span class="comment">     * -NT's shutdown always starts with a logoff.</span>
00265 <span class="comment">     * -Shutdown or logoff? (WMCS_SHUTDOWN)</span>
00266 <span class="comment">     * -Should display dialog for hung apps? (WMCS_NODLGIFHUNG)</span>
00267 <span class="comment">     * -is this process in the context being logged off? (WMCS_CONTEXTLOGOFF)</span>
00268 <span class="comment">     */</span>
00269     dwClientFlags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a> | (fNoRetry ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a136">WMCS_NORETRY</a> : 0);
00270     <span class="comment">//}</span>
00271 
00272     <span class="comment">/*</span>
00273 <span class="comment">     * Check the flags originally passed by the ExitWindows caller to see if we're</span>
00274 <span class="comment">     *  really just logging off.</span>
00275 <span class="comment">     */</span>
00276     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; (EWX_WINLOGON_OLD_REBOOT | EWX_WINLOGON_OLD_SHUTDOWN))) {
00277         dwClientFlags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a137">WMCS_LOGOFF</a>;
00278     }
00279 
00280     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_FORCEIFHUNG) {
00281         dwClientFlags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a135">WMCS_NODLGIFHUNG</a>;
00282     }
00283     <span class="keywordflow">if</span> (!(pcsrp-&gt;ShutdownFlags &amp; (SHUTDOWN_SYSTEMCONTEXT | SHUTDOWN_OTHERCONTEXT))) {
00284         dwClientFlags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a132">WMCS_CONTEXTLOGOFF</a>;
00285     }
00286 
00287 
00288     <span class="comment">/*</span>
00289 <span class="comment">     * Lock the process while we walk the thread list.  We know</span>
00290 <span class="comment">     * that the process is valid and therefore do not need to</span>
00291 <span class="comment">     * check the return status.</span>
00292 <span class="comment">     */</span>
00293     CsrLockProcessByClientId(pcsrp-&gt;ClientId.UniqueProcess, &amp;Process);
00294 
00295     ShutdownInfo.StatusShutdown = <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
00296 
00297     <span class="comment">/*</span>
00298 <span class="comment">     * Go through the thread list and mark them as not</span>
00299 <span class="comment">     * shutdown yet.</span>
00300 <span class="comment">     */</span>
00301     ListHead = &amp;pcsrp-&gt;ThreadList;
00302     ListNext = ListHead-&gt;Flink;
00303     <span class="keywordflow">while</span> (ListNext != ListHead) {
00304         Thread = CONTAINING_RECORD( ListNext, CSR_THREAD, Link );
00305         Thread-&gt;Flags &amp;= ~<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a4">CSR_THREAD_SHUTDOWNSKIP</a>;
00306         ListNext = ListNext-&gt;Flink;
00307     }
00308 
00309     <span class="comment">/*</span>
00310 <span class="comment">     * Perform the proper shutdown operation on each thread.  Keep</span>
00311 <span class="comment">     * a count of the number of gui threads found.</span>
00312 <span class="comment">     */</span>
00313     cThreads = 0;
00314     ShutdownInfo.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00315     ShutdownInfo.drdRestore.hdeskNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00316     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00317         ListNext = ListHead-&gt;Flink;
00318         <span class="keywordflow">while</span> (ListNext != ListHead) {
00319             Thread = CONTAINING_RECORD( ListNext, CSR_THREAD, Link );
00320             <span class="comment">/*</span>
00321 <span class="comment">             * Skip the thread doing the shutdown.  Assume that it's</span>
00322 <span class="comment">             * ready.</span>
00323 <span class="comment">             * gdwThreadEndSession shouldn't change while the shutdown</span>
00324 <span class="comment">             *  is in progress; so this should be thread safe.</span>
00325 <span class="comment">             */</span>
00326             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> == dwLocalThreadEndSession);
00327             <span class="keywordflow">if</span> (HandleToUlong(Thread-&gt;ClientId.UniqueThread) == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a>) {
00328                 Thread-&gt;Flags |= <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a4">CSR_THREAD_SHUTDOWNSKIP</a>;
00329             }
00330 
00331             <span class="keywordflow">if</span> (!(Thread-&gt;Flags &amp;
00332                     (CSR_THREAD_DESTROYED | <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a4">CSR_THREAD_SHUTDOWNSKIP</a>))) {
00333                 <span class="keywordflow">break</span>;
00334             }
00335             ListNext = ListNext-&gt;Flink;
00336         }
00337         <span class="keywordflow">if</span> (ListNext == ListHead)
00338             <span class="keywordflow">break</span>;
00339 
00340         Thread-&gt;Flags |= <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a4">CSR_THREAD_SHUTDOWNSKIP</a>;
00341         ShutdownInfo.dwFlags = dwClientFlags;
00342 
00343         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a276">NtUserQueryInformationThread</a>(Thread-&gt;ThreadHandle,
00344                 UserThreadShutdownInformation, &amp;ShutdownInfo, <span class="keyword">sizeof</span>(ShutdownInfo), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00345 
00346         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00347             <span class="keywordflow">continue</span>;
00348         <span class="keywordflow">if</span> (ShutdownInfo.StatusShutdown == <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>)
00349             <span class="keywordflow">continue</span>;
00350         <span class="keywordflow">if</span> (ShutdownInfo.StatusShutdown == <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>) {
00351             CsrUnlockProcess(Process);
00352             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
00353             <span class="keywordflow">goto</span> RestoreDesktop;
00354         }
00355 
00356         <span class="comment">/*</span>
00357 <span class="comment">         * If this process is not in the account being logged off and it</span>
00358 <span class="comment">         * is not on the windowstation being logged off, don't send</span>
00359 <span class="comment">         * the end session messages.</span>
00360 <span class="comment">         */</span>
00361         <span class="keywordflow">if</span> (!(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a132">WMCS_CONTEXTLOGOFF</a>) &amp;&amp; (ShutdownInfo.hwndDesktop == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00362             <span class="comment">/*</span>
00363 <span class="comment">             * This process is not in the context being logged off.  Do</span>
00364 <span class="comment">             * not terminate it and let console send an event to the process.</span>
00365 <span class="comment">             */</span>
00366             ShutdownInfo.StatusShutdown = <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
00367             <span class="keywordflow">continue</span>;
00368         }
00369 
00370         <span class="comment">/*</span>
00371 <span class="comment">         * Shut down this process.</span>
00372 <span class="comment">         */</span>
00373         cThreads++;
00374 
00375         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00376             Forced = (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_FORCE);
00377             fNoMsgs =  (pcsrp-&gt;ShutdownFlags &amp; SHUTDOWN_NORETRY) ||
00378                        !(ShutdownInfo.dwFlags &amp; USER_THREAD_GUI);
00379             fNoMsgsEver &amp;= fNoMsgs;
00380             <span class="keywordflow">if</span> (Forced &amp;&amp; (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_NONOTIFY) || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> != 0)))  {
00381                 dwClientFlags &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a137">WMCS_LOGOFF</a>; <span class="comment">// WinStation Reset or Shutdown. Don't do this for console session.</span>
00382             }
00383 
00384             <span class="keywordflow">if</span> (fNoMsgs || Forced) {
00385                 <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>((ULONG_PTR)Thread-&gt;ClientId.UniqueProcess, <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>);
00386             }
00387             bDoBlock = (fNoMsgs == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00388 
00389         } <span class="keywordflow">else</span> {
00390             <span class="keywordflow">if</span> (fNoRetry || !(ShutdownInfo.dwFlags &amp; USER_THREAD_GUI)) {
00391 
00392                 <span class="comment">/*</span>
00393 <span class="comment">                 * Dispose of any hard errors.</span>
00394 <span class="comment">                 */</span>
00395                 <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>((ULONG_PTR)Thread-&gt;ClientId.UniqueProcess, <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>);
00396                 bDoBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00397             } <span class="keywordflow">else</span> {
00398                 bDoBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00399             }
00400         }
00401 
00402         <span class="keywordflow">if</span> (bDoBlock) {
00403             CsrReferenceThread(Thread);
00404             CsrUnlockProcess(Process);
00405 
00406             <span class="comment">/*</span>
00407 <span class="comment">             * There are problems in changing shutdown to send all the</span>
00408 <span class="comment">             * QUERYENDSESSIONs at once before doing any ENDSESSIONs, like</span>
00409 <span class="comment">             * Windows does. The whole machine needs to be modal if you do this.</span>
00410 <span class="comment">             * If it isn't modal, then you have this problem. Imagine app 1 and 2.</span>
00411 <span class="comment">             * 1 gets the queryendsession, no problem. 2 gets it and brings up a</span>
00412 <span class="comment">             * dialog. Now being a simple user, you decide you need to change the</span>
00413 <span class="comment">             * document in app 1. Now you switch back to app 2, hit ok, and</span>
00414 <span class="comment">             * everything goes away - including app 1 without saving its changes.</span>
00415 <span class="comment">             * Also, apps expect that once they've received the QUERYENDSESSION,</span>
00416 <span class="comment">             * they are not going to get anything else of any particular interest</span>
00417 <span class="comment">             * (unless it is a WM_ENDSESSION with FALSE) We had bugs pre 511 where</span>
00418 <span class="comment">             * apps were blowing up because of this.</span>
00419 <span class="comment">             * If this change is made, the entire system must be modal</span>
00420 <span class="comment">             * while this is going on. - ScottLu 6/30/94</span>
00421 <span class="comment">             */</span>
00422             cmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a54">ThreadShutdownNotify</a>(dwClientFlags | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a130">WMCS_QUERYEND</a>, (ULONG_PTR)Thread, 0);
00423 
00424             CsrLockProcessByClientId(pcsrp-&gt;ClientId.UniqueProcess, &amp;Process);
00425             CsrDereferenceThread(Thread);
00426 
00427             <span class="comment">/*</span>
00428 <span class="comment">             * If shutdown has been cancelled, let csr know about it.</span>
00429 <span class="comment">             */</span>
00430             <span class="keywordflow">switch</span> (cmd) {
00431             <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a19">TSN_USERSAYSCANCEL</a>:
00432             <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a17">TSN_APPSAYSNOTOK</a>:
00433                 <span class="keywordflow">if</span> (!Forced) {
00434                     dwClientFlags &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a>;
00435                 }
00436 
00437                 <span class="comment">/*</span>
00438 <span class="comment">                 * Fall through.</span>
00439 <span class="comment">                 */</span>
00440             <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a16">TSN_APPSAYSOK</a>:
00441                 fSendEndSession = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00442                 <span class="keywordflow">break</span>;
00443 
00444             <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a18">TSN_USERSAYSKILL</a>:
00445                 <span class="comment">/*</span>
00446 <span class="comment">                 * Since we cannot just kill one thread, the whole process</span>
00447 <span class="comment">                 *  is going down. Hence, there is no point on continuing</span>
00448 <span class="comment">                 *  checking other threads. Also, the user wants it killed</span>
00449 <span class="comment">                 *  so we won't waste any time sending more messages</span>
00450 <span class="comment">                 */</span>
00451                 dwClientFlags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a>;
00452                 <span class="keywordflow">goto</span> KillIt;
00453 
00454             <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a20">TSN_NOWINDOW</a>:
00455                 <span class="comment">/*</span>
00456 <span class="comment">                 * Did this process have a window?</span>
00457 <span class="comment">                 * If this is the second pass we terminate the process even if it did</span>
00458 <span class="comment">                 * not have any windows in case the app was just starting up.</span>
00459 <span class="comment">                 * WOW hits this often when because it takes so long to start up.</span>
00460 <span class="comment">                 * Logon (with WOW auto-starting) then logoff WOW won't die but will</span>
00461 <span class="comment">                 * lock some files open so you can't logon next time.</span>
00462 <span class="comment">                 */</span>
00463                 <span class="keywordflow">if</span> (fFirstPass) {
00464                     cThreads--;
00465                 }
00466                 <span class="keywordflow">break</span>;
00467             }
00468         }
00469     }
00470 
00471     <span class="comment">/*</span>
00472 <span class="comment">     * If end session message need to be sent, do it now.</span>
00473 <span class="comment">     */</span>
00474     <span class="keywordflow">if</span> (fSendEndSession) {
00475 
00476         <span class="comment">/*</span>
00477 <span class="comment">         * Go through the thread list and mark them as not</span>
00478 <span class="comment">         * shutdown yet.</span>
00479 <span class="comment">         */</span>
00480         ListNext = ListHead-&gt;Flink;
00481         <span class="keywordflow">while</span> (ListNext != ListHead) {
00482             Thread = CONTAINING_RECORD( ListNext, CSR_THREAD, Link );
00483             Thread-&gt;Flags &amp;= ~<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a4">CSR_THREAD_SHUTDOWNSKIP</a>;
00484             ListNext = ListNext-&gt;Flink;
00485         }
00486 
00487         <span class="comment">/*</span>
00488 <span class="comment">         * Perform the proper shutdown operation on each thread.</span>
00489 <span class="comment">         */</span>
00490         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00491             ListHead = &amp;pcsrp-&gt;ThreadList;
00492             ListNext = ListHead-&gt;Flink;
00493             <span class="keywordflow">while</span> (ListNext != ListHead) {
00494                 Thread = CONTAINING_RECORD( ListNext, CSR_THREAD, Link );
00495                 <span class="keywordflow">if</span> (!(Thread-&gt;Flags &amp;
00496                         (CSR_THREAD_DESTROYED | <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a4">CSR_THREAD_SHUTDOWNSKIP</a>))) {
00497                     <span class="keywordflow">break</span>;
00498                 }
00499                 ListNext = ListNext-&gt;Flink;
00500             }
00501             <span class="keywordflow">if</span> (ListNext == ListHead)
00502                 <span class="keywordflow">break</span>;
00503 
00504             Thread-&gt;Flags |= <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a4">CSR_THREAD_SHUTDOWNSKIP</a>;
00505             ShutdownInfo.dwFlags = dwClientFlags;
00506 
00507             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a276">NtUserQueryInformationThread</a>(Thread-&gt;ThreadHandle,
00508                     UserThreadShutdownInformation, &amp;ShutdownInfo, <span class="keyword">sizeof</span>(ShutdownInfo), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00509 
00510             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00511                 <span class="keywordflow">continue</span>;
00512 
00513             <span class="keywordflow">if</span> (ShutdownInfo.StatusShutdown == <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a> ||
00514                     !(ShutdownInfo.dwFlags &amp; USER_THREAD_GUI))
00515                 <span class="keywordflow">continue</span>;
00516 
00517             <span class="comment">/*</span>
00518 <span class="comment">             * Send the end session messages to the thread.</span>
00519 <span class="comment">             */</span>
00520             CsrReferenceThread(Thread);
00521             CsrUnlockProcess(Process);
00522 
00523             <span class="comment">/*</span>
00524 <span class="comment">             * If the user says kill it, the user wants it to go away now</span>
00525 <span class="comment">             * no matter what. If the user didn't say kill, then call again</span>
00526 <span class="comment">             * because we need to send WM_ENDSESSION messages.</span>
00527 <span class="comment">             */</span>
00528             <a class="code" href="../../d7/d1/usersrv_8h.html#a54">ThreadShutdownNotify</a>(dwClientFlags, (ULONG_PTR)Thread, 0);
00529 
00530             CsrLockProcessByClientId(pcsrp-&gt;ClientId.UniqueProcess, &amp;Process);
00531             CsrDereferenceThread(Thread);
00532         }
00533     }
00534 
00535 KillIt:
00536     CsrUnlockProcess(Process);
00537 
00538     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00539         bDoBlock = (!fNoMsgsEver &amp;&amp; !(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a>));
00540     } <span class="keywordflow">else</span> {
00541         bDoBlock = (!fNoRetry &amp;&amp; !(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a>));
00542     }
00543 
00544     <span class="keywordflow">if</span> (bDoBlock) {
00545         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a15">SHUTDOWN_CANCEL</a>;
00546         <span class="keywordflow">goto</span> RestoreDesktop;
00547     }
00548 
00549     <span class="comment">/*</span>
00550 <span class="comment">     * Set the final shutdown status according to the number of gui</span>
00551 <span class="comment">     * threads found.  If the count is zero, we have an unknown process.</span>
00552 <span class="comment">     */</span>
00553     <span class="keywordflow">if</span> (cThreads == 0)
00554         ShutdownInfo.StatusShutdown = <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
00555     <span class="keywordflow">else</span>
00556         ShutdownInfo.StatusShutdown = <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
00557 
00558     <span class="keywordflow">if</span> (ShutdownInfo.StatusShutdown == <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a> ||
00559             !(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a132">WMCS_CONTEXTLOGOFF</a>)) {
00560 
00561         <span class="comment">/*</span>
00562 <span class="comment">         * This process is not in the context being logged off.  Do</span>
00563 <span class="comment">         * not terminate it and let console send an event to the process.</span>
00564 <span class="comment">         */</span>
00565         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
00566 
00567         <span class="keywordflow">if</span> (ShutdownInfo.drdRestore.hdeskNew) {
00568             <span class="keywordflow">goto</span> RestoreDesktop;
00569         }
00570         <span class="keywordflow">goto</span> CleanupAndExit;
00571     }
00572 
00573     <span class="comment">/*</span>
00574 <span class="comment">     * Calling ExitProcess() in the app's context will not always work</span>
00575 <span class="comment">     * because the app may have .dll termination deadlocks: so the thread</span>
00576 <span class="comment">     * will hang with the rest of the process. To ensure apps go away,</span>
00577 <span class="comment">     * we terminate the process with NtTerminateProcess().</span>
00578 <span class="comment">     *</span>
00579 <span class="comment">     * Pass this special value, DBG_TERMINATE_PROCESS, which tells</span>
00580 <span class="comment">     * NtTerminateProcess() to return failure if it can't terminate the</span>
00581 <span class="comment">     * process because the app is being debugged.</span>
00582 <span class="comment">     */</span>
00583 
00584     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00585         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExitStatus;
00586         HANDLE <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>;
00587 
00588         ExitStatus = DBG_TERMINATE_PROCESS;
00589         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a>(NtCurrentProcess(),
00590                                                  ProcessDebugPort,
00591                                                  &amp;<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00592                                                  <span class="keyword">sizeof</span>(HANDLE),
00593                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) &amp;&amp;
00594             (<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00595             <span class="comment">// Csr is being debugged - go ahead and kill the process</span>
00596             ExitStatus = 0;
00597         }
00598         TerminateStatus = <a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(pcsrp-&gt;ProcessHandle, ExitStatus);
00599     } <span class="keywordflow">else</span> {
00600         TerminateStatus = <a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(pcsrp-&gt;ProcessHandle, DBG_TERMINATE_PROCESS);
00601     }
00602 
00603     pcsrp-&gt;Flags |= CSR_PROCESS_TERMINATED;
00604 
00605 
00606     <span class="comment">/*</span>
00607 <span class="comment">     * Let csr know we know about this process - meaning it was our</span>
00608 <span class="comment">     * responsibility to shut it down.</span>
00609 <span class="comment">     */</span>
00610     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
00611 
00612 RestoreDesktop:
00613 
00614     <span class="comment">/*</span>
00615 <span class="comment">     * Release the desktop that was used.</span>
00616 <span class="comment">     */</span>
00617     {
00618         USERTHREAD_USEDESKTOPINFO utudi;
00619         utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00620         RtlCopyMemory(&amp;(utudi.drdRestore), &amp;(ShutdownInfo.drdRestore), <span class="keyword">sizeof</span>(DESKRESTOREDATA));
00621 
00622         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(), UserThreadUseDesktop,
00623                 &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00624     }
00625 
00626     <span class="comment">/*</span>
00627 <span class="comment">     * Now that we're done with the process handle, derefence the csr</span>
00628 <span class="comment">     * process structure.</span>
00629 <span class="comment">     */</span>
00630     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>) {
00631 
00632         <span class="comment">/*</span>
00633 <span class="comment">                 * If TerminateProcess returned STATUS_ACCESS_DENIED, then the process</span>
00634 <span class="comment">                 * is being debugged and it wasn't terminated.Otherwise we need to wait</span>
00635 <span class="comment">                 * anyway since TerminateProcess might return failure when the process</span>
00636 <span class="comment">                 * is going away (ie STATUS_PROCESS_IS_TERMINATING).If termination</span>
00637 <span class="comment">                 * indeed fail, something is wrong anyway so waiting a bit won't</span>
00638 <span class="comment">                 * hurt much.</span>
00639 <span class="comment">         * If we wait give the process whatever exit timeout value configured</span>
00640 <span class="comment">                 * in the registry, but no less  than the 5 second Hung App timeout.</span>
00641 <span class="comment"></span>
00642 <span class="comment">         */</span>
00643         <span class="keywordflow">if</span> (TerminateStatus != STATUS_ACCESS_DENIED) {
00644             LARGE_INTEGER li;
00645 
00646             li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a9">gdwProcessTerminateTimeout</a>;
00647             TerminateStatus = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(pcsrp-&gt;ProcessHandle,
00648                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00649                                            &amp;li);
00650             <span class="keywordflow">if</span> (TerminateStatus != STATUS_WAIT_0) {
00651                 RIPMSG2(RIP_WARNING,
00652                         <span class="stringliteral">"UserClientShutdown: wait for process %x failed with status %x"</span>,
00653                         pcsrp-&gt;ClientId.UniqueProcess, TerminateStatus);
00654             }
00655         }
00656 
00657         CsrDereferenceProcess(pcsrp);
00658     }
00659 
00660 
00661 CleanupAndExit:
00662 
00663     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00664 }
00665 
00666 <span class="comment">/***************************************************************************\</span>
00667 <span class="comment">* WMCSCallback</span>
00668 <span class="comment">*</span>
00669 <span class="comment">* This function is passed to SendMessageCallback when sending the</span>
00670 <span class="comment">*  WM_CLIENTSHUTDOWN message. It propagates the return value back</span>
00671 <span class="comment">*  if ThreadShutdownNotify is still waiting for it; otherwise,</span>
00672 <span class="comment">*  it just frees the memory.</span>
00673 <span class="comment">*</span>
00674 <span class="comment">* 03-04-97 GerardoB     Created.</span>
00675 <span class="comment">\***************************************************************************/</span>
<a name="l00676"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a11">00676</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> CALLBACK <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a11">WMCSCallback</a>(HWND hwnd, UINT uMsg, ULONG_PTR dwData, LRESULT lResult)
00677 {
00678     <a class="code" href="../../d5/d9/structtagWMCSDATA.html">PWMCSDATA</a> pwmcsd = (<a class="code" href="../../d5/d9/structtagWMCSDATA.html">PWMCSDATA</a>)dwData;
00679     <span class="keywordflow">if</span> (pwmcsd-&gt;<a class="code" href="../../d5/d9/structtagWMCSDATA.html#o0">dwFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a32">WMCSD_IGNORE</a>) {
00680         LocalFree(pwmcsd);
00681         <span class="keywordflow">return</span>;
00682     }
00683 
00684     pwmcsd-&gt;<a class="code" href="../../d5/d9/structtagWMCSDATA.html#o0">dwFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a33">WMCSD_REPLY</a>;
00685     pwmcsd-&gt;<a class="code" href="../../d5/d9/structtagWMCSDATA.html#o1">dwRet</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lResult;
00686 
00687     UNREFERENCED_PARAMETER(hwnd);
00688     UNREFERENCED_PARAMETER(uMsg);
00689 }
00690 <span class="comment">/***************************************************************************\</span>
00691 <span class="comment">* GetInputWindow</span>
00692 <span class="comment">*</span>
00693 <span class="comment">* We assume a thread is waiting for input if it's not hung, the (main)</span>
00694 <span class="comment">*  window is disabled and it owns an enabled popup.</span>
00695 <span class="comment">*</span>
00696 <span class="comment">* 03-06-97 GerardoB     Created.</span>
00697 <span class="comment">\***************************************************************************/</span>
<a name="l00698"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a12">00698</a> HWND <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a12">GetInputWindow</a> (PCSR_THREAD pcsrt, HWND hwnd)
00699 {
00700     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTimeout;
00701     HWND hwndPopup;
00702     <span class="comment">/*</span>
00703 <span class="comment">     * Ask the kernel if the thread is hung</span>
00704 <span class="comment">     */</span>
00705     dwTimeout = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a>;
00706     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a276">NtUserQueryInformationThread</a>(pcsrt-&gt;ThreadHandle,
00707        UserThreadHungStatus, &amp;dwTimeout, <span class="keyword">sizeof</span>(dwTimeout), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00708 
00709     <span class="comment">/*</span>
00710 <span class="comment">     * If not hung and disabled, see if it owns an enabled popup</span>
00711 <span class="comment">     */</span>
00712     <span class="keywordflow">if</span> (!dwTimeout &amp;&amp; !<a class="code" href="../../d3/d9/client_2wow_8c.html#a20">IsWindowEnabled</a>(hwnd)) {
00713         hwndPopup = <a class="code" href="../../d3/d9/client_2wow_8c.html#a12">GetWindow</a>(hwnd, GW_ENABLEDPOPUP);
00714         <span class="keywordflow">if</span> ((hwndPopup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (hwndPopup != hwnd)) {
00715             <span class="keywordflow">return</span> hwndPopup;
00716         }
00717     }
00718 
00719     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00720 }
00721 <span class="comment">/***************************************************************************\</span>
00722 <span class="comment">* GetApplicationText</span>
00723 <span class="comment">*</span>
00724 <span class="comment">* Gets the text that identifies the given window or thread</span>
00725 <span class="comment">*</span>
00726 <span class="comment">* 08-01-97 GerardoB     Created.</span>
00727 <span class="comment">\***************************************************************************/</span>
<a name="l00728"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a13">00728</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a13">GetApplicationText</a> (HWND hwnd, HANDLE hThread, WCHAR *pwcText, UINT uLen)
00729 {
00730     <span class="comment">/*</span>
00731 <span class="comment">     * GetWindowText doesn't call the hwnd's proc; otherwise, we could</span>
00732 <span class="comment">     *  get blocked here for good.</span>
00733 <span class="comment">     */</span>
00734     <a class="code" href="../../d5/d9/cltxt_8h.html#a21">GetWindowText</a>(hwnd, pwcText, uLen);
00735     <span class="keywordflow">if</span> (*pwcText == 0) {
00736         <span class="comment">/*</span>
00737 <span class="comment">         * We couldn't get window title; let's try thread name</span>
00738 <span class="comment">         */</span>
00739         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a276">NtUserQueryInformationThread</a>(hThread, UserThreadTaskName,
00740                                      pwcText, uLen * <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00741     }
00742 }
00743 <span class="comment">/***************************************************************************\</span>
00744 <span class="comment">* ThreadShutdownNotify</span>
00745 <span class="comment">*</span>
00746 <span class="comment">* This function notifies a given thread that it's time (or about time)</span>
00747 <span class="comment">*  to go away. This is called from _EndTask to post the WM_CLOSE message</span>
00748 <span class="comment">*  or from UserClientShutdown to send the WM_QUERYENDSESSION and</span>
00749 <span class="comment">*  WM_ENDSESSION messages. If the thread fails to respond, then the</span>
00750 <span class="comment">*  "End Application" dialog is brought up. This function is also called</span>
00751 <span class="comment">*  from Console to display that dialog too.</span>
00752 <span class="comment">*</span>
00753 <span class="comment">* 03-07-97 GerardoB     Created to replace SendShutdownMessages,</span>
00754 <span class="comment">*                        MySendEndSessionMessages and DoEndTaskDialog</span>
00755 <span class="comment">\***************************************************************************/</span>
00756 
<a name="l00757"></a><a class="code" href="../../d7/d1/usersrv_8h.html#a54">00757</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d1/usersrv_8h.html#a54">ThreadShutdownNotify</a>(DWORD dwClientFlags, ULONG_PTR dwThread, LPARAM lParam)
00758 {
00759     HWND hwnd, hwndOwner;
00760     <a class="code" href="../../d5/d9/structtagWMCSDATA.html">PWMCSDATA</a> pwmcsd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00761     HWND hwndDlg;
00762     <a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a> edp;
00763     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet, dwRealTimeout, dwTimeout, dwStartTiming, dwCmd;
00764     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00765     PCSR_THREAD pcsrt;
00766     HANDLE hThread;
00767     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fEndTaskNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00768 
00769 <span class="preprocessor">#define ESMH_CANCELEVENT     0</span>
00770 <span class="preprocessor"></span><span class="preprocessor">#define ESMH_THREAD          1</span>
00771 <span class="preprocessor"></span><span class="preprocessor">#define ESMH_HANDLECOUNT     2</span>
00772 <span class="preprocessor"></span>    HANDLE ahandles[<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a7">ESMH_HANDLECOUNT</a>];
00773 
00774     <span class="comment">/*</span>
00775 <span class="comment">     * If this is console, just set up the wait loop and</span>
00776 <span class="comment">     *   bring the dialog up right away. Otherwise, find</span>
00777 <span class="comment">     *   the notification window, notify it and go wait.</span>
00778 <span class="comment">     */</span>
00779     <span class="keywordflow">if</span> (dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>) {
00780         hThread = (HANDLE)dwThread;
00781         dwRealTimeout = 0;
00782         <span class="keywordflow">goto</span> SetupWaitLoop;
00783     } <span class="keywordflow">else</span> {
00784         pcsrt = (PCSR_THREAD)dwThread;
00785         hThread = pcsrt-&gt;ThreadHandle;
00786         hwnd = (HWND)lParam;
00787     }
00788 
00789     <span class="comment">/*</span>
00790 <span class="comment">     * If no window was provided,</span>
00791 <span class="comment">     *  find a top-level window owned by the thread</span>
00792 <span class="comment">     */</span>
00793     <span class="keywordflow">if</span> (hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00794         <a class="code" href="../../d0/d8/clenum_8c.html#a9">EnumThreadWindows</a>(HandleToUlong(pcsrt-&gt;ClientId.UniqueThread),
00795                             &amp;<a class="code" href="../../d0/d7/server_2server_8c.html#a54">FindWindowFromThread</a>, (LPARAM)&amp;hwnd);
00796     }
00797     <span class="keywordflow">if</span> (hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00798         <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a20">TSN_NOWINDOW</a>;
00799     }
00800     <span class="comment">/*</span>
00801 <span class="comment">     * Find the root owner (we'll guess this is the "main" window)</span>
00802 <span class="comment">     */</span>
00803     <span class="keywordflow">while</span> ((hwndOwner = <a class="code" href="../../d3/d9/client_2wow_8c.html#a12">GetWindow</a>(hwnd, GW_OWNER)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00804         hwnd = hwndOwner;
00805     }
00806 
00807 <span class="preprocessor">#if defined(FE_IME)</span>
00808 <span class="preprocessor"></span>    <span class="comment">/*</span>
00809 <span class="comment">     * If this is a console window, then just returns TSN_APPSAYSOK.</span>
00810 <span class="comment">     * In this routine:</span>
00811 <span class="comment">     * Normally windows NT environment, hwnd never point to console window.</span>
00812 <span class="comment">     * However, In ConIme process, its owner window point to console window.</span>
00813 <span class="comment">     */</span>
00814     <span class="keywordflow">if</span> (!(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a133">WMCS_ENDTASK</a>)) {
00815         <span class="keywordflow">if</span> ((HANDLE)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, GWLP_HINSTANCE) == <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>) {
00816             <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a16">TSN_APPSAYSOK</a>;
00817         }
00818     }
00819 <span class="preprocessor">#endif</span>
00820 <span class="preprocessor"></span>
00821     <span class="comment">/*</span>
00822 <span class="comment">     * If this is an EndTask request but the window is disabled,</span>
00823 <span class="comment">     *   then we want to bring the dialog up right way (the app</span>
00824 <span class="comment">     *   is probably waiting for input).</span>
00825 <span class="comment">     * Otherwise, we bring the window to the foreground, send/post</span>
00826 <span class="comment">     *  the request and wait</span>
00827 <span class="comment">     */</span>
00828 
00829 
00830     <span class="comment">/*</span>
00831 <span class="comment">     * Bug 296188 - joejo</span>
00832 <span class="comment">     *</span>
00833 <span class="comment">     * Make sure we respond to the user ASAP when they</span>
00834 <span class="comment">     * attempt to shutdown an application that we know is hung.</span>
00835 <span class="comment">     */</span>
00836 
00837     <span class="keywordflow">if</span> ((dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a133">WMCS_ENDTASK</a>)) {
00838 
00839         dwTimeout = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a>;
00840         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a276">NtUserQueryInformationThread</a>(pcsrt-&gt;ThreadHandle, UserThreadHungStatus, &amp;dwTimeout, <span class="keyword">sizeof</span>(dwTimeout), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00841 
00842         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a20">IsWindowEnabled</a>(hwnd) || dwTimeout){
00843             dwRealTimeout = 0;
00844             fEndTaskNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00845         }
00846 
00847 
00848     }
00849 
00850     <span class="keywordflow">if</span> (!fEndTaskNow) {
00851 
00852         <a class="code" href="../../d3/d8/client_8c.html#a131">SetForegroundWindow</a>(hwnd);
00853         dwRealTimeout = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a>;
00854         <span class="keywordflow">if</span> (dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a133">WMCS_ENDTASK</a>) {
00855             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwnd, WM_CLOSE, 0, 0);
00856         } <span class="keywordflow">else</span> {
00857             <span class="comment">/*</span>
00858 <span class="comment">             * If the shutdown was canceled, we don't need to wait.</span>
00859 <span class="comment">             *  (we're just sending the WM_ENDSESSION(FALSE))</span>
00860 <span class="comment">             */</span>
00861             <span class="keywordflow">if</span> (!(dwClientFlags &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a130">WMCS_QUERYEND</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a>))) {
00862                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a28">SendNotifyMessage</a>(hwnd, WM_CLIENTSHUTDOWN, dwClientFlags, 0);
00863                 <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a16">TSN_APPSAYSOK</a>;
00864             }
00865             <span class="comment">/*</span>
00866 <span class="comment">             * Allocate callback data. If out of memory, kill it.</span>
00867 <span class="comment">             */</span>
00868             pwmcsd = (<a class="code" href="../../d5/d9/structtagWMCSDATA.html">PWMCSDATA</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/structtagWMCSDATA.html">WMCSDATA</a>));
00869             <span class="keywordflow">if</span> (pwmcsd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00870                 <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a18">TSN_USERSAYSKILL</a>;
00871             }
00872 
00873             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a27">SendMessageCallback</a>(hwnd, WM_CLIENTSHUTDOWN, dwClientFlags, 0,
00874                                 <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a11">WMCSCallback</a>, (ULONG_PTR)pwmcsd);
00875         }
00876     }
00877 
00878 SetupWaitLoop:
00879     <span class="comment">/*</span>
00880 <span class="comment">     * This tells us if the hwndDlg is valid. This is set/cleared by</span>
00881 <span class="comment">     *  EndTaskDlgProc</span>
00882 <span class="comment">     */</span>
00883     ZeroMemory(&amp;edp, <span class="keyword">sizeof</span>(edp));
00884     edp.dwFlags = <a class="code" href="../../d7/d1/usersrv_8h.html#a11">EDPF_NODLG</a>;
00885     <span class="comment">/*</span>
00886 <span class="comment">     * Loop until the hwnd replies, the request is canceled</span>
00887 <span class="comment">     *  or the thread goes away. It time out, bring up the</span>
00888 <span class="comment">     *  dialog and wait until the user tells us what to do.</span>
00889 <span class="comment">     */</span>
00890     *(ahandles + <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a5">ESMH_CANCELEVENT</a>) = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a20">gheventCancel</a>;
00891     *(ahandles + <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a6">ESMH_THREAD</a>) = hThread;
00892     dwStartTiming = GetTickCount();
00893     dwCmd = 0;
00894     <span class="keywordflow">while</span> (dwCmd == 0) {
00895         <span class="comment">/*</span>
00896 <span class="comment">         * Calculate how long we have to wait.</span>
00897 <span class="comment">         */</span>
00898         dwTimeout = dwRealTimeout;
00899         <span class="keywordflow">if</span> ((dwTimeout != 0) &amp;&amp; (dwTimeout != INFINITE)) {
00900             dwTimeout -= (GetTickCount() - dwStartTiming);
00901             <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)dwTimeout &lt; 0) {
00902                 dwTimeout = 0;
00903             }
00904         }
00905 
00906         dwRet = <a class="code" href="../../d3/d8/client_8c.html#a57">MsgWaitForMultipleObjects</a>(<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a7">ESMH_HANDLECOUNT</a>, ahandles, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, dwTimeout, QS_ALLINPUT);
00907 
00908         <span class="keywordflow">switch</span> (dwRet) {
00909             <span class="keywordflow">case</span> WAIT_OBJECT_0 + <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a5">ESMH_CANCELEVENT</a>:
00910                 <span class="comment">/*</span>
00911 <span class="comment">                 * The request has been canceled.</span>
00912 <span class="comment">                 */</span>
00913                 dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a19">TSN_USERSAYSCANCEL</a>;
00914                 <span class="keywordflow">break</span>;
00915 
00916             <span class="keywordflow">case</span> WAIT_OBJECT_0 + <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a6">ESMH_THREAD</a>:
00917                 <span class="comment">/*</span>
00918 <span class="comment">                 * The thread is gone.</span>
00919 <span class="comment">                 */</span>
00920                 dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a16">TSN_APPSAYSOK</a>;
00921                 <span class="keywordflow">break</span>;
00922 
00923             <span class="keywordflow">case</span> WAIT_OBJECT_0 + <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a7">ESMH_HANDLECOUNT</a>:
00924                 <span class="comment">/*</span>
00925 <span class="comment">                 * We got some input; process it.</span>
00926 <span class="comment">                 */</span>
00927                 <span class="keywordflow">while</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_REMOVE)) {
00928                     <span class="keywordflow">if</span> ((edp.dwFlags &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a11">EDPF_NODLG</a>)
00929                             || !<a class="code" href="../../d3/d0/user32_8def.html#a39">IsDialogMessage</a>(hwndDlg, &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>)) {
00930 
00931                         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a21">TranslateMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
00932                         <a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
00933                     }
00934                 }
00935                 <span class="comment">/*</span>
00936 <span class="comment">                 * If we got a reply to the message, act on it</span>
00937 <span class="comment">                 */</span>
00938                 <span class="keywordflow">if</span> ((pwmcsd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwmcsd-&gt;<a class="code" href="../../d5/d9/structtagWMCSDATA.html#o0">dwFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a33">WMCSD_REPLY</a>)) {
00939 
00940                     <span class="keywordflow">switch</span> (pwmcsd-&gt;<a class="code" href="../../d5/d9/structtagWMCSDATA.html#o1">dwRet</a>) {
00941                         <span class="keywordflow">default</span>:
00942                             <span class="comment">/*</span>
00943 <span class="comment">                             * If the message was not processed (the thread</span>
00944 <span class="comment">                             *  exited) or someone processed it and returned</span>
00945 <span class="comment">                             *  a bogus value, just shut them down.</span>
00946 <span class="comment">                             * Fall through</span>
00947 <span class="comment">                             */</span>
00948                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a138">WMCSR_ALLOWSHUTDOWN</a>:
00949                             <span class="comment">/*</span>
00950 <span class="comment">                             * We're going to nuke this app, so get rid of</span>
00951 <span class="comment">                             *  any pending harderror boxes he might have</span>
00952 <span class="comment">                             */</span>
00953                             <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>((ULONG_PTR)pcsrt-&gt;ClientId.UniqueProcess, <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>);
00954                             <span class="comment">/*</span>
00955 <span class="comment">                             * Fall through.</span>
00956 <span class="comment">                             */</span>
00957                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a139">WMCSR_DONE</a>:
00958                             dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a16">TSN_APPSAYSOK</a>;
00959                             <span class="keywordflow">break</span>;
00960 
00961                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a140">WMCSR_CANCEL</a>:
00962                             dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a17">TSN_APPSAYSNOTOK</a>;
00963                             <span class="keywordflow">break</span>;
00964                     }
00965                 }
00966                 <span class="comment">/*</span>
00967 <span class="comment">                 * Else if the dialog is still up, keep waiting for the user</span>
00968 <span class="comment">                 *  to tell us what to do</span>
00969 <span class="comment">                 */</span>
00970                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(edp.dwFlags &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a11">EDPF_NODLG</a>)) {
00971                     <span class="keywordflow">break</span>;
00972                 }
00973                 <span class="comment">/*</span>
00974 <span class="comment">                 * Else if the user dismissed the dialog, act on his response</span>
00975 <span class="comment">                 */</span>
00976                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (edp.dwFlags &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a12">EDPF_RESPONSE</a>) {
00977                     <span class="keywordflow">switch</span>(edp.dwRet) {
00978                         <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a4">IDC_ENDNOW</a>:
00979                             <span class="comment">/*</span>
00980 <span class="comment">                             * The user wants us to kill it</span>
00981 <span class="comment">                             */</span>
00982                             dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a18">TSN_USERSAYSKILL</a>;
00983                             <span class="keywordflow">break</span>;
00984 
00985                         <span class="comment">/* case IDCANCEL: */</span>
00986                         <span class="keywordflow">default</span>:
00987                             dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a19">TSN_USERSAYSCANCEL</a>;
00988                             <span class="keywordflow">break</span>;
00989                     }
00990                 }
00991                 <span class="keywordflow">break</span>;
00992 
00993             <span class="keywordflow">case</span> WAIT_TIMEOUT:
00994 
00995                 <span class="keywordflow">if</span> (dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a136">WMCS_NORETRY</a>) {
00996 
00997                     <span class="comment">/*</span>
00998 <span class="comment">                     * We come here only for Terminal Server case. We return</span>
00999 <span class="comment">                     * TSN_APPSAYSOK as Terminal Server 4 did in this case.</span>
01000 <span class="comment">                     */</span>
01001                     UserAssert(<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>());
01002 
01003                     dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a16">TSN_APPSAYSOK</a>;
01004                     <span class="keywordflow">break</span>;
01005                 }
01006 
01007 
01008                 <span class="comment">/*</span>
01009 <span class="comment">                 * Once we time out, we bring up the dialog and let</span>
01010 <span class="comment">                 *  its timer take over.</span>
01011 <span class="comment">                 */</span>
01012                 dwRealTimeout = INFINITE;
01013                 <span class="comment">/*</span>
01014 <span class="comment">                 * Check if the windows app is waiting for input;</span>
01015 <span class="comment">                 *  if not, we assume it is hung for EndTask;</span>
01016 <span class="comment">                 *   otherwise we enter a wait mode that brings the</span>
01017 <span class="comment">                 *   dialog up just to provide some (waiting) feedback</span>
01018 <span class="comment">                 * Console just gets the dialog right away</span>
01019 <span class="comment">                 */</span>
01020                 <span class="keywordflow">if</span> (!(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>)) {
01021                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>((ULONG_PTR)pcsrt-&gt;ClientId.UniqueProcess, <a class="code" href="../../d7/d1/usersrv_8h.html#a31">BHE_TEST</a>)
01022                            || (<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a12">GetInputWindow</a>(pcsrt, hwnd) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01023 
01024                         edp.dwFlags |= <a class="code" href="../../d7/d1/usersrv_8h.html#a15">EDPF_INPUT</a>;
01025                     } <span class="keywordflow">else</span> {
01026                         <span class="comment">/*</span>
01027 <span class="comment">                         * EWX_FORCEIFHUNG support.</span>
01028 <span class="comment">                         * Also, if this is an ExitWindows call and the process is not in</span>
01029 <span class="comment">                         * the context being logged off, we won't kill it.</span>
01030 <span class="comment">                         * So don't bother asking the user what to do</span>
01031 <span class="comment">                         */</span>
01032                         <span class="keywordflow">if</span> ((dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a135">WMCS_NODLGIFHUNG</a>)
01033                                 || (!(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a133">WMCS_ENDTASK</a>)
01034                                         &amp;&amp; !(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a132">WMCS_CONTEXTLOGOFF</a>))) {
01035 
01036                             dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a18">TSN_USERSAYSKILL</a>;
01037                             <span class="keywordflow">break</span>;
01038                         }
01039                         <span class="comment">/*</span>
01040 <span class="comment">                         * Hung or Wait?</span>
01041 <span class="comment">                         */</span>
01042                         <span class="keywordflow">if</span> (dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a133">WMCS_ENDTASK</a>) {
01043                             edp.dwFlags |= <a class="code" href="../../d7/d1/usersrv_8h.html#a13">EDPF_HUNG</a>;
01044                         } <span class="keywordflow">else</span> {
01045                             edp.dwFlags |= <a class="code" href="../../d7/d1/usersrv_8h.html#a14">EDPF_WAIT</a>;
01046                         }
01047                     }
01048                 }
01049 
01050                 <span class="comment">/*</span>
01051 <span class="comment">                 * If the registry says no dialog, then tell the caller</span>
01052 <span class="comment">                 *  the user wants to kill the app.</span>
01053 <span class="comment">                 */</span>
01054                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a5">gfAutoEndTask</a>) {
01055                     dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a18">TSN_USERSAYSKILL</a>;
01056                     <span class="keywordflow">break</span>;
01057                 }
01058                 <span class="comment">/*</span>
01059 <span class="comment">                 * Setup the parameters needed by EndTaskDlgProc</span>
01060 <span class="comment">                 */</span>
01061                 edp.dwRet = 0;
01062                 edp.dwClientFlags = dwClientFlags;
01063                 <span class="keywordflow">if</span> (dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>) {
01064                     edp.pcsrt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01065                     edp.lParam = lParam;
01066                 } <span class="keywordflow">else</span> {
01067                     edp.pcsrt = pcsrt;
01068                     edp.lParam = (LPARAM)hwnd;
01069                 }
01070 
01071                 hwndDlg = CreateDialogParam (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, MAKEINTRESOURCE(<a class="code" href="../../d7/d1/usersrv_8h.html#a0">IDD_ENDTASK</a>),
01072                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a16">EndTaskDlgProc</a>, (LPARAM)(&amp;edp));
01073                 <span class="comment">/*</span>
01074 <span class="comment">                 * If we cannot ask the user, then kill the app.</span>
01075 <span class="comment">                 */</span>
01076                 <span class="keywordflow">if</span> (hwndDlg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01077                     edp.dwFlags |= <a class="code" href="../../d7/d1/usersrv_8h.html#a11">EDPF_NODLG</a>;
01078                     dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a18">TSN_USERSAYSKILL</a>;
01079                     <span class="keywordflow">break</span>;
01080                 }
01081                 <span class="keywordflow">break</span>;
01082 
01083             <span class="keywordflow">default</span>:
01084                 <span class="comment">/*</span>
01085 <span class="comment">                 * Unexpected return; something is wrong. Kill the app.</span>
01086 <span class="comment">                 */</span>
01087                 UserAssert(dwRet != dwRet);
01088                 dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a18">TSN_USERSAYSKILL</a>;
01089                 <span class="keywordflow">break</span>;
01090         } <span class="comment">/* switch (dwRet) */</span>
01091     } <span class="comment">/* while (dwCmd == 0) */</span>
01092 
01093 
01094     <span class="comment">/*</span>
01095 <span class="comment">     * If the dialog is up, nuke it.</span>
01096 <span class="comment">     */</span>
01097     <span class="keywordflow">if</span> (!(edp.dwFlags &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a11">EDPF_NODLG</a>)) {
01098         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a3">DestroyWindow</a>(hwndDlg);
01099     }
01100     <span class="comment">/*</span>
01101 <span class="comment">     * Make sure pwmcsd is freed or marked to be freed by WMCSCallback</span>
01102 <span class="comment">     *  when the reply comes</span>
01103 <span class="comment">     */</span>
01104     <span class="keywordflow">if</span> (pwmcsd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01105         <span class="keywordflow">if</span> (pwmcsd-&gt;<a class="code" href="../../d5/d9/structtagWMCSDATA.html#o0">dwFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a33">WMCSD_REPLY</a>) {
01106             LocalFree(pwmcsd);
01107         } <span class="keywordflow">else</span> {
01108             pwmcsd-&gt;<a class="code" href="../../d5/d9/structtagWMCSDATA.html#o0">dwFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a32">WMCSD_IGNORE</a>;
01109         }
01110     }
01111 <span class="preprocessor">#if DBG</span>
01112 <span class="preprocessor"></span>    <span class="comment">/*</span>
01113 <span class="comment">     * If Canceling, let's the name the app that doesn't let us log off</span>
01114 <span class="comment">     */</span>
01115     <span class="keywordflow">if</span> ((dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a>) &amp;&amp; (dwCmd == <a class="code" href="../../d7/d1/usersrv_8h.html#a17">TSN_APPSAYSNOTOK</a>)) {
01116         WCHAR achTitle[<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a3">CCHBODYMAX</a>];
01117         WCHAR *pwcText;
01118         UserAssert(!(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>));
01119         pwcText = achTitle;
01120         *(achTitle + <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a3">CCHBODYMAX</a> - 1) = (WCHAR)0;
01121         <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a13">GetApplicationText</a>(hwnd, hThread, pwcText, <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a3">CCHBODYMAX</a> - 1);
01122         KdPrint((<span class="stringliteral">"Log off canceled by pid:%#lx tid:%#lx - '%ws'.\n"</span>,
01123                     HandleToUlong(pcsrt-&gt;ClientId.UniqueProcess),
01124                     HandleToUlong(pcsrt-&gt;ClientId.UniqueThread),
01125                     pwcText));
01126     }
01127 <span class="preprocessor">#endif</span>
01128 <span class="preprocessor"></span>    <span class="comment">/*</span>
01129 <span class="comment">     * If we're killing this dude, clean any hard errors.</span>
01130 <span class="comment">     * Also if wow takes care of it, then our caller doesn't need to</span>
01131 <span class="comment">     */</span>
01132     <span class="keywordflow">if</span> ((dwCmd == <a class="code" href="../../d7/d1/usersrv_8h.html#a18">TSN_USERSAYSKILL</a>) &amp;&amp; !(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>)) {
01133 
01134         <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>((ULONG_PTR)pcsrt-&gt;ClientId.UniqueProcess, <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>);
01135 
01136         <span class="keywordflow">if</span> (!(pcsrt-&gt;Flags &amp; CSR_THREAD_DESTROYED) &amp;&amp; <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a8">WowExitTask</a>(pcsrt)) {
01137             dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a16">TSN_APPSAYSOK</a>;
01138         }
01139     }
01140 
01141     <span class="keywordflow">return</span> dwCmd;
01142 }
01143 
01144 <span class="comment">/***************************************************************************\</span>
01145 <span class="comment">* SetEndTaskDlgStatus</span>
01146 <span class="comment">*</span>
01147 <span class="comment">* Displays the appropiate message and shows the dialog</span>
01148 <span class="comment">*</span>
01149 <span class="comment">* 03-11-97 GerardoB     Created</span>
01150 <span class="comment">\***************************************************************************/</span>
<a name="l01151"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a15">01151</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a15">SetEndTaskDlgStatus</a>(<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a> *pedp, HWND hwndDlg, UINT uStrId, BOOL fInit)
01152 {
01153     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> f, fIsWaiting, fWasWaiting;
01154     WCHAR *pwcText;
01155 
01156     fWasWaiting = (pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o3">uStrId</a> == STR_ENDTASK_WAIT);
01157     fIsWaiting = (pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o0">dwFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a14">EDPF_WAIT</a>);
01158     <span class="comment">/*</span>
01159 <span class="comment">     * Store the current message id, load it and show it</span>
01160 <span class="comment">     */</span>
01161     pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o3">uStrId</a> = uStrId;
01162     pwcText = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, uStrId, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;f);
01163     <span class="keywordflow">if</span> (pwcText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01164         <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(hwndDlg, <a class="code" href="../../d7/d1/usersrv_8h.html#a2">IDC_STATUSMSG</a>, pwcText);
01165         LocalFree(pwcText);
01166     }
01167     <span class="comment">/*</span>
01168 <span class="comment">     * If we haven't decided that the app is hung, set a</span>
01169 <span class="comment">     *  timer to keep an eye on it.</span>
01170 <span class="comment">     */</span>
01171     <span class="keywordflow">if</span> (!(pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o0">dwFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a13">EDPF_HUNG</a>) &amp;&amp; !(pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o1">dwClientFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>)) {
01172         <a class="code" href="../../d3/d0/user32_8def.html#a56">SetTimer</a>(hwndDlg, <a class="code" href="../../d7/d1/usersrv_8h.html#a9">IDT_CHECKAPPSTATE</a>, <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01173     }
01174     <span class="comment">/*</span>
01175 <span class="comment">     * If initializing or switching to/from the wait mode,</span>
01176 <span class="comment">     *  set the proper status for IDC_STATUSCANCEL, IDCANCEL,</span>
01177 <span class="comment">     *  IDC_ENDNOW and  the start/stop the progress bar.</span>
01178 <span class="comment">     *  Invalidate paint if/as needed</span>
01179 <span class="comment">     */</span>
01180     <span class="keywordflow">if</span> (fInit || (fIsWaiting ^ fWasWaiting)) {
01181         RECT rc;
01182         HWND hwndStatusCancel = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwndDlg, <a class="code" href="../../d7/d1/usersrv_8h.html#a3">IDC_STATUSCANCEL</a>);
01183         HWND hwndCancelButton = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwndDlg, IDCANCEL);
01184         HWND hwndEndButton = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwndDlg, <a class="code" href="../../d7/d1/usersrv_8h.html#a4">IDC_ENDNOW</a>);
01185         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSwpFlags;
01186         <span class="comment">/*</span>
01187 <span class="comment">         * If on wait mode, we hide the cancel button and its</span>
01188 <span class="comment">         *  explanatory text. The End button will be moved to</span>
01189 <span class="comment">         *  the cancel button position.</span>
01190 <span class="comment">         */</span>
01191         dwSwpFlags = ((fIsWaiting ? SWP_HIDEWINDOW : SWP_SHOWWINDOW)
01192                                 | SWP_NOREDRAW | SWP_NOSIZE | SWP_NOMOVE
01193                                 | SWP_NOZORDER | SWP_NOSENDCHANGING
01194                                 | SWP_NOACTIVATE);
01195         <span class="comment">/*</span>
01196 <span class="comment">         * If we're hiding the cancel button, give focus/def id to</span>
01197 <span class="comment">         *  the End button.</span>
01198 <span class="comment">         * Note that DM_SETDEIF won't do the right thing unless</span>
01199 <span class="comment">         *  both Cancel/End buttons are visible.</span>
01200 <span class="comment">         */</span>
01201         <span class="keywordflow">if</span> (fIsWaiting) {
01202             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndDlg, DM_SETDEFID, <a class="code" href="../../d7/d1/usersrv_8h.html#a4">IDC_ENDNOW</a>, 0);
01203             <a class="code" href="../../d3/d0/user32_8def.html#a43">SetFocus</a>(hwndEndButton);
01204         }
01205         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a0">SetWindowPos</a>(hwndStatusCancel, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, dwSwpFlags);
01206         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a0">SetWindowPos</a>(hwndCancelButton, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, dwSwpFlags);
01207         <span class="comment">/*</span>
01208 <span class="comment">         * If the cancel button is visible, give it focus/def id.</span>
01209 <span class="comment">         */</span>
01210         <span class="keywordflow">if</span> (!fIsWaiting) {
01211             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndDlg, DM_SETDEFID, IDCANCEL, 0);
01212             <a class="code" href="../../d3/d0/user32_8def.html#a43">SetFocus</a>(hwndCancelButton);
01213         }
01214         <span class="comment">/*</span>
01215 <span class="comment">         * Initialize progress bar (first time around)</span>
01216 <span class="comment">         */</span>
01217         <span class="keywordflow">if</span> (fIsWaiting &amp;&amp; (pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o14">hbrProgress</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01218             <span class="keywordtype">int</span> iMagic;
01219             <span class="comment">/*</span>
01220 <span class="comment">             * Initialize progress bar stuff.</span>
01221 <span class="comment">             * The size and location calculations below were made up</span>
01222 <span class="comment">             *  to make it look good(?).</span>
01223 <span class="comment">             * We need that location on dialog coordiantes since the</span>
01224 <span class="comment">             *  progress bar is painted on the dialog's WM_PAINT.</span>
01225 <span class="comment">             */</span>
01226             <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(hwndStatusCancel, &amp;pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o10">rcBar</a>);
01227             iMagic = (pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o10">rcBar</a>.bottom - pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o10">rcBar</a>.top) / 4;
01228             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o10">rcBar</a>, 0, -iMagic + <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYEDGE));
01229             pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o10">rcBar</a>.right -= (5 * iMagic);
01230             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o10">rcBar</a>, 0, -iMagic);
01231             <a class="code" href="../../d3/d8/winmgrc_8c.html#a15">MapWindowPoints</a>(hwndStatusCancel, hwndDlg, (LPPOINT)&amp;pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o10">rcBar</a>, 2);
01232             <span class="comment">/*</span>
01233 <span class="comment">             * Calculate drawing rectangle and dimensions.</span>
01234 <span class="comment">             *  We kind of make it look like comctrl's progress bar.</span>
01235 <span class="comment">             */</span>
01236             pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o11">rcProgress</a> = pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o10">rcBar</a>;
01237             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o11">rcProgress</a>, -<a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXEDGE), -<a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYEDGE));
01238             pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o12">iProgressStop</a> = pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o11">rcProgress</a>.right;
01239             pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o13">iProgressWidth</a> = ((2 * (pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o11">rcProgress</a>.bottom - pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o11">rcProgress</a>.top)) / 3);
01240 
01241             pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o11">rcProgress</a>.right = pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o11">rcProgress</a>.left + pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o13">iProgressWidth</a> - 1;
01242 
01243             pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o14">hbrProgress</a> = CreateSolidBrush(<a class="code" href="../../d3/d9/client_2wow_8c.html#a15">GetSysColor</a>(COLOR_ACTIVECAPTION));
01244             <span class="comment">/*</span>
01245 <span class="comment">             * Remember the End button position.</span>
01246 <span class="comment">             */</span>
01247             <a class="code" href="../../d3/d9/client_2wow_8c.html#a26">GetWindowRect</a>(hwndEndButton, &amp;pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o15">rcEndButton</a>);
01248             <a class="code" href="../../d3/d8/winmgrc_8c.html#a15">MapWindowPoints</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwndDlg, (LPPOINT)&amp;pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o15">rcEndButton</a>, 2);
01249         }
01250         <span class="comment">/*</span>
01251 <span class="comment">         * Start/Stop progress bar and set End button position</span>
01252 <span class="comment">         */</span>
01253         <span class="keywordflow">if</span> (fIsWaiting) {
01254             RECT rcEndButton;
01255             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uTimeout = (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a4">gdwHungToKillCount</a> * <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a>)
01256                             / ((pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o12">iProgressStop</a> - pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o11">rcProgress</a>.left) / pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o13">iProgressWidth</a>);
01257             <a class="code" href="../../d3/d0/user32_8def.html#a56">SetTimer</a>(hwndDlg, <a class="code" href="../../d7/d1/usersrv_8h.html#a10">IDT_PROGRESS</a>, uTimeout, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01258             <span class="comment">/*</span>
01259 <span class="comment">             * The Cancel and the End buttons might have different widths when</span>
01260 <span class="comment">             *  localized. So make sure we position it inside the dialog and</span>
01261 <span class="comment">             *  to the right end of the dialog.</span>
01262 <span class="comment">             */</span>
01263             <a class="code" href="../../d3/d9/client_2wow_8c.html#a26">GetWindowRect</a>(hwndCancelButton, &amp;rc);
01264             <a class="code" href="../../d3/d9/client_2wow_8c.html#a26">GetWindowRect</a>(hwndEndButton, &amp;rcEndButton);
01265             rc.left = rc.right - (rcEndButton.right - rcEndButton.left);
01266             <a class="code" href="../../d3/d8/winmgrc_8c.html#a15">MapWindowPoints</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hwndDlg, (LPPOINT)&amp;rc, 2);
01267         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fWasWaiting) {
01268             KillTimer(hwndDlg, <a class="code" href="../../d7/d1/usersrv_8h.html#a10">IDT_PROGRESS</a>);
01269             rc = pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o15">rcEndButton</a>;
01270         }
01271         <span class="comment">/*</span>
01272 <span class="comment">         * Move the End button if needed</span>
01273 <span class="comment">         */</span>
01274         <span class="keywordflow">if</span> (fIsWaiting || fWasWaiting) {
01275             <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a0">SetWindowPos</a>(hwndEndButton, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, rc.left, rc.top, 0, 0,
01276                             SWP_NOREDRAW | SWP_NOSIZE | SWP_NOACTIVATE
01277                             | SWP_NOZORDER | SWP_NOSENDCHANGING);
01278         }
01279         <span class="comment">/*</span>
01280 <span class="comment">         * Make sure we repaint if needed</span>
01281 <span class="comment">         */</span>
01282         <span class="keywordflow">if</span> (!fInit) {
01283             InvalidateRect(hwndDlg, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01284         }
01285     } <span class="comment">/* if (fInit || (fIsWaiting ^ fWasWaiting)) */</span>
01286     <span class="comment">/*</span>
01287 <span class="comment">     * If initializing or in hung mode, make sure the user can</span>
01288 <span class="comment">     * see the dialog; only bring it to the foreground on</span>
01289 <span class="comment">     * initialization (no rude focus stealing)</span>
01290 <span class="comment">     */</span>
01291     <span class="keywordflow">if</span> (fInit || (pedp-&gt;<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html#o0">dwFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a13">EDPF_HUNG</a>)) {
01292         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a0">SetWindowPos</a>(hwndDlg, HWND_TOPMOST, 0, 0, 0, 0,
01293                      SWP_NOMOVE | SWP_NOSIZE | SWP_SHOWWINDOW
01294                      | SWP_NOACTIVATE | SWP_NOSENDCHANGING);
01295 
01296         <span class="keywordflow">if</span> (fInit) {
01297             <a class="code" href="../../d3/d8/client_8c.html#a131">SetForegroundWindow</a>(hwndDlg);
01298         }
01299     }
01300 }
01301 <span class="comment">/***************************************************************************\</span>
01302 <span class="comment">* EndTaskDlgProc</span>
01303 <span class="comment">*</span>
01304 <span class="comment">* This is the dialog procedure for the dialog that comes up when an app is</span>
01305 <span class="comment">* not responding.</span>
01306 <span class="comment">*</span>
01307 <span class="comment">* 03-06-97 GerardoB     Rewrote it once again. New template though</span>
01308 <span class="comment">* 07-23-92 ScottLu      Rewrote it, but used same dialog template.</span>
01309 <span class="comment">* 04-28-92 JonPa        Created.</span>
01310 <span class="comment">\***************************************************************************/</span>
01311 
<a name="l01312"></a><a class="code" href="../../d7/d1/usersrv_8h.html#a52">01312</a> INT_PTR <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d7/d1/usersrv_8h.html#a52">EndTaskDlgProc</a>(
01313     HWND hwndDlg,
01314     UINT msg,
01315     WPARAM wParam,
01316     LPARAM lParam)
01317 {
01318     <a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a>* pedp;
01319     WCHAR achTitle[<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a3">CCHBODYMAX</a>];
01320     WCHAR *pwcText, *pwcTemp;
01321     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uLen;
01322     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uStrId;
01323     PAINTSTRUCT ps;
01324     HDC hdc, hdcMem;
01325     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIsInput, fWasInput;
01326 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01327 <span class="preprocessor"></span>    <span class="keywordtype">int</span> iOldLayout;
01328 <span class="preprocessor">#endif</span>
01329 <span class="preprocessor"></span>
01330     <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
01331     <span class="keywordflow">case</span> WM_INITDIALOG:
01332         <span class="comment">/*</span>
01333 <span class="comment">         * Save parameters</span>
01334 <span class="comment">         */</span>
01335         pedp = (<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a>*)lParam;
01336         <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwndDlg, GWLP_USERDATA, (ULONG_PTR)pedp);
01337         <span class="comment">/*</span>
01338 <span class="comment">         * This tells the caller that the dialog is up</span>
01339 <span class="comment">         */</span>
01340         pedp-&gt;dwFlags &amp;= ~<a class="code" href="../../d7/d1/usersrv_8h.html#a11">EDPF_NODLG</a>;
01341         <span class="comment">/*</span>
01342 <span class="comment">         * Build the dialog title making sure that</span>
01343 <span class="comment">         *  we end up with a NULL terminated string.</span>
01344 <span class="comment">         */</span>
01345         *(achTitle + <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a3">CCHBODYMAX</a> - 1) = (WCHAR)0;
01346         uLen = <a class="code" href="../../d5/d9/cltxt_8h.html#a21">GetWindowText</a>(hwndDlg, achTitle, <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a3">CCHBODYMAX</a> - 1);
01347         pwcText = achTitle + uLen;
01348         uLen = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a3">CCHBODYMAX</a> - 1 - uLen;
01349         <span class="comment">/*</span>
01350 <span class="comment">         * Console provides the title; we figure it out for windows apps.</span>
01351 <span class="comment">         */</span>
01352         <span class="keywordflow">if</span> (pedp-&gt;dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>) {
01353             pwcTemp = (WCHAR *)pedp-&gt;lParam;
01354             <span class="keywordflow">while</span> (uLen-- &amp;&amp; (*pwcText++ = *pwcTemp++));
01355         } <span class="keywordflow">else</span> {
01356             <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a13">GetApplicationText</a>((HWND)pedp-&gt;lParam, pedp-&gt;pcsrt-&gt;ThreadHandle, pwcText, uLen);
01357         }
01358 
01359         <a class="code" href="../../d5/d9/cltxt_8h.html#a23">SetWindowText</a>(hwndDlg, achTitle);
01360         <span class="comment">/*</span>
01361 <span class="comment">         * Get the app's icon: first look for atomIconProperty</span>
01362 <span class="comment">         * if not available, try the class icon.</span>
01363 <span class="comment">         * else, use the default icon.</span>
01364 <span class="comment">         */</span>
01365         pedp-&gt;hIcon = (HICON)<a class="code" href="../../d5/d9/cltxt_8h.html#a27">GetProp</a>((HWND)pedp-&gt;lParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a3">ICON_PROP_NAME</a>);
01366 
01367         <span class="keywordflow">if</span> (pedp-&gt;hIcon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01368 
01369             pedp-&gt;hIcon = (HICON)<a class="code" href="../../d5/d9/cltxt_8h.html#a13">GetClassLongPtr</a>((HWND)pedp-&gt;lParam, GCLP_HICON);
01370 
01371             <span class="keywordflow">if</span> (pedp-&gt;hIcon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01372 
01373                 <span class="keywordflow">if</span> (pedp-&gt;dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>) {
01374                     pedp-&gt;hIcon = LoadIcon(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, MAKEINTRESOURCE(<a class="code" href="../../d7/d1/usersrv_8h.html#a5">IDI_CONSOLE</a>));
01375                 }
01376                 <span class="keywordflow">else</span> {
01377                     pedp-&gt;hIcon = LoadIcon(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, IDI_APPLICATION);
01378                 }
01379             }
01380         }
01381 
01382         <span class="comment">/*</span>
01383 <span class="comment">         * Figure out what message the caller wants initially</span>
01384 <span class="comment">         */</span>
01385         <span class="keywordflow">if</span> (pedp-&gt;dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>) {
01386             uStrId = STR_ENDTASK_CONSOLE;
01387         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pedp-&gt;dwFlags &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a15">EDPF_INPUT</a>) {
01388             uStrId = STR_ENDTASK_INPUT;
01389         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pedp-&gt;dwFlags &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a14">EDPF_WAIT</a>) {
01390             uStrId = STR_ENDTASK_WAIT;
01391         } <span class="keywordflow">else</span> {
01392             uStrId = STR_ENDTASK_HUNG;
01393         }
01394         <span class="comment">/*</span>
01395 <span class="comment">         * Display the message, set the focus and show the dialog</span>
01396 <span class="comment">         */</span>
01397         <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a15">SetEndTaskDlgStatus</a>(pedp, hwndDlg, uStrId, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01398         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01399 
01400 
01401     <span class="keywordflow">case</span> WM_PAINT:
01402         pedp = (<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a>*)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndDlg, GWLP_USERDATA);
01403         <span class="keywordflow">if</span> ((pedp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pedp-&gt;hIcon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01404             <span class="keywordflow">break</span>;
01405         }
01406         <span class="comment">/*</span>
01407 <span class="comment">         * Draw the icon</span>
01408 <span class="comment">         */</span>
01409         hdc = <a class="code" href="../../d3/d0/user32_8def.html#a41">BeginPaint</a>(hwndDlg, &amp;ps);
01410 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01411 <span class="preprocessor"></span>        iOldLayout = GetLayout(hdc);
01412         <span class="keywordflow">if</span> (iOldLayout != GDI_ERROR) {
01413             SetLayout(hdc, iOldLayout|LAYOUT_BITMAPORIENTATIONPRESERVED);
01414         }
01415 <span class="preprocessor">#endif</span>
01416 <span class="preprocessor"></span>        <a class="code" href="../../d3/d8/client_8c.html#a49">DrawIcon</a>(hdc, <a class="code" href="../../d7/d1/usersrv_8h.html#a6">ETD_XICON</a>, <a class="code" href="../../d7/d1/usersrv_8h.html#a7">ETD_YICON</a>, pedp-&gt;hIcon);
01417 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01418 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (iOldLayout != GDI_ERROR) {
01419             SetLayout(hdc, iOldLayout);
01420         }
01421 <span class="preprocessor">#endif</span>
01422 <span class="preprocessor"></span>        <span class="comment">/*</span>
01423 <span class="comment">         * If waiting, draw the progress bar;</span>
01424 <span class="comment">         *  else draw the warning sign</span>
01425 <span class="comment">         */</span>
01426         <span class="keywordflow">if</span> (pedp-&gt;dwFlags &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a14">EDPF_WAIT</a>) {
01427             RECT rc;
01428             <span class="comment">/*</span>
01429 <span class="comment">             * Draw a client-edge-looking border.</span>
01430 <span class="comment">             */</span>
01431             rc = pedp-&gt;rcBar;
01432             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a15">DrawEdge</a>(hdc, &amp;rc, BDR_SUNKENOUTER, BF_RECT | BF_ADJUST);
01433             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rc, -1, -1);
01434             <span class="comment">/*</span>
01435 <span class="comment">             * Draw the blocks up to current position</span>
01436 <span class="comment">             */</span>
01437             rc.right = rc.left + pedp-&gt;iProgressWidth - 1;
01438             <span class="keywordflow">while</span> (rc.left &lt; pedp-&gt;rcProgress.left) {
01439                 <span class="keywordflow">if</span> (rc.right &gt; pedp-&gt;iProgressStop) {
01440                     rc.right = pedp-&gt;iProgressStop;
01441                     <span class="keywordflow">if</span> (rc.left &gt;= rc.right) {
01442                         <span class="keywordflow">break</span>;
01443                     }
01444                 }
01445                 <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rc, pedp-&gt;hbrProgress);
01446                 rc.left += pedp-&gt;iProgressWidth;
01447                 rc.right += pedp-&gt;iProgressWidth;
01448             }
01449         } <span class="keywordflow">else</span> {
01450             <span class="comment">/*</span>
01451 <span class="comment">             * Load the bitmap the first time around and</span>
01452 <span class="comment">             *  figure out where it goes</span>
01453 <span class="comment">            */</span>
01454             <span class="keywordflow">if</span> (pedp-&gt;hbmpWarning == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01455                 BITMAP bmp;
01456                 pedp-&gt;hbmpWarning = LoadBitmap(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, MAKEINTRESOURCE(<a class="code" href="../../d7/d1/usersrv_8h.html#a8">IDB_WARNING</a>));
01457                 <span class="keywordflow">if</span> (GetObject(pedp-&gt;hbmpWarning, <span class="keyword">sizeof</span>(bmp), &amp;bmp)) {
01458                     pedp-&gt;rcWarning.left = <a class="code" href="../../d7/d1/usersrv_8h.html#a6">ETD_XICON</a>;
01459                     pedp-&gt;rcWarning.top = <a class="code" href="../../d7/d1/usersrv_8h.html#a6">ETD_XICON</a> + 32 - bmp.bmHeight;
01460                     pedp-&gt;rcWarning.right = bmp.bmWidth;
01461                     pedp-&gt;rcWarning.bottom = bmp.bmHeight;
01462                 }
01463             }
01464             <span class="comment">/*</span>
01465 <span class="comment">             * Blit it</span>
01466 <span class="comment">             */</span>
01467             hdcMem = CreateCompatibleDC(hdc);
01468             SelectObject(hdcMem, pedp-&gt;hbmpWarning);
01469             GdiTransparentBlt(hdc, pedp-&gt;rcWarning.left, pedp-&gt;rcWarning.top,
01470                    pedp-&gt;rcWarning.right, pedp-&gt;rcWarning.bottom,
01471                    hdcMem, 0, 0, pedp-&gt;rcWarning.right, pedp-&gt;rcWarning.bottom, RGB(255, 0, 255));
01472             DeleteDC(hdcMem);
01473         }
01474 
01475         EndPaint(hwndDlg, &amp;ps);
01476         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01477 
01478     <span class="keywordflow">case</span> WM_TIMER:
01479         pedp = (<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a>*)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndDlg, GWLP_USERDATA);
01480         <span class="keywordflow">if</span> (pedp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01481             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01482         }
01483         <span class="keywordflow">switch</span> (wParam) {
01484         <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a9">IDT_CHECKAPPSTATE</a>:
01485             pedp-&gt;dwCheckTimerCount++;
01486             <span class="comment">/*</span>
01487 <span class="comment">             * Check if the app has switched from/to a waiting-for-input</span>
01488 <span class="comment">             *  mode. If so, update the dialog and wait a little longer</span>
01489 <span class="comment">             */</span>
01490             fIsInput = (<a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>((ULONG_PTR)pedp-&gt;pcsrt-&gt;ClientId.UniqueProcess, <a class="code" href="../../d7/d1/usersrv_8h.html#a31">BHE_TEST</a>)
01491                         || (<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a12">GetInputWindow</a>(pedp-&gt;pcsrt, (HWND)pedp-&gt;lParam) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
01492             fWasInput = (pedp-&gt;dwFlags &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a15">EDPF_INPUT</a>);
01493             <span class="keywordflow">if</span> (fIsInput ^ fWasInput) {
01494                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uProgress;
01495                 pedp-&gt;dwFlags &amp;= ~(<a class="code" href="../../d7/d1/usersrv_8h.html#a15">EDPF_INPUT</a> | <a class="code" href="../../d7/d1/usersrv_8h.html#a14">EDPF_WAIT</a>);
01496                 pedp-&gt;dwFlags |= (fIsInput ? <a class="code" href="../../d7/d1/usersrv_8h.html#a15">EDPF_INPUT</a> : <a class="code" href="../../d7/d1/usersrv_8h.html#a14">EDPF_WAIT</a>);
01497                 <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a15">SetEndTaskDlgStatus</a>(pedp, hwndDlg,
01498                                     (fIsInput ? STR_ENDTASK_INPUT : STR_ENDTASK_WAIT),
01499                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01500                 pedp-&gt;dwCheckTimerCount /= 2;
01501                 uProgress = pedp-&gt;rcProgress.left - pedp-&gt;rcBar.left - <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXEDGE);
01502                 uProgress /= 2;
01503                 pedp-&gt;rcProgress.left -= uProgress;
01504                 pedp-&gt;rcProgress.right -= uProgress;
01505             }
01506             <span class="comment">/*</span>
01507 <span class="comment">             * Is it time to declare it hung?</span>
01508 <span class="comment">             */</span>
01509             <span class="keywordflow">if</span> (pedp-&gt;dwCheckTimerCount &gt;= <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a4">gdwHungToKillCount</a>) {
01510                 KillTimer(hwndDlg, <a class="code" href="../../d7/d1/usersrv_8h.html#a9">IDT_CHECKAPPSTATE</a>);
01511                 pedp-&gt;dwFlags &amp;= ~(<a class="code" href="../../d7/d1/usersrv_8h.html#a15">EDPF_INPUT</a> | <a class="code" href="../../d7/d1/usersrv_8h.html#a14">EDPF_WAIT</a>);
01512                 pedp-&gt;dwFlags |= <a class="code" href="../../d7/d1/usersrv_8h.html#a13">EDPF_HUNG</a>;
01513                 <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a15">SetEndTaskDlgStatus</a>(pedp, hwndDlg, STR_ENDTASK_HUNG, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01514             }
01515         <span class="keywordflow">break</span>;
01516 
01517         <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a10">IDT_PROGRESS</a>:
01518             <span class="comment">/*</span>
01519 <span class="comment">             * Draw the next block in the progress bar.</span>
01520 <span class="comment">             */</span>
01521             <span class="keywordflow">if</span> (pedp-&gt;rcProgress.right &gt;= pedp-&gt;iProgressStop) {
01522                 pedp-&gt;rcProgress.right = pedp-&gt;iProgressStop;
01523                 <span class="keywordflow">if</span> (pedp-&gt;rcProgress.left &gt;= pedp-&gt;rcProgress.right) {
01524                     <span class="keywordflow">break</span>;
01525                 }
01526             }
01527             hdc = <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a1">GetDC</a>(hwndDlg);
01528             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;pedp-&gt;rcProgress, pedp-&gt;hbrProgress);
01529             <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(hwndDlg, hdc);
01530             pedp-&gt;rcProgress.left += pedp-&gt;iProgressWidth;
01531             pedp-&gt;rcProgress.right += pedp-&gt;iProgressWidth;
01532         <span class="keywordflow">break</span>;
01533         }
01534         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01535 
01536 
01537     <span class="keywordflow">case</span> WM_NCACTIVATE:
01538         <span class="comment">/*</span>
01539 <span class="comment">         * Make sure we're uncovered when active and not covering the app</span>
01540 <span class="comment">         *  when inactive</span>
01541 <span class="comment">         */</span>
01542         pedp = (<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a>*)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndDlg, GWLP_USERDATA);
01543         <span class="keywordflow">if</span> (pedp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01544             HWND hwnd;
01545             <span class="keywordflow">if</span> (wParam) {
01546                 hwnd = HWND_TOPMOST;
01547             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pedp-&gt;dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>) {
01548                 hwnd = HWND_TOP;
01549             } <span class="keywordflow">else</span> {
01550                 hwnd = (HWND)pedp-&gt;lParam;
01551             }
01552             <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a0">SetWindowPos</a>(hwndDlg, hwnd,
01553                          0, 0, 0, 0, SWP_NOMOVE | SWP_NOSIZE);
01554         }
01555         <span class="keywordflow">break</span>;
01556 
01557 
01558     <span class="keywordflow">case</span> WM_COMMAND:
01559         <span class="comment">/*</span>
01560 <span class="comment">         * The user has made a choice, we're done.</span>
01561 <span class="comment">         */</span>
01562         pedp = (<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a>*)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndDlg, GWLP_USERDATA);
01563         <span class="keywordflow">if</span> (pedp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01564             pedp-&gt;dwRet = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)wParam;
01565         }
01566         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a3">DestroyWindow</a>(hwndDlg);
01567         <span class="keywordflow">break</span>;
01568 
01569 
01570     <span class="keywordflow">case</span> WM_DESTROY:
01571         <span class="comment">/*</span>
01572 <span class="comment">         * We're dead. Make sure the caller knows we're history</span>
01573 <span class="comment">         */</span>
01574         pedp = (<a class="code" href="../../d4/d3/struct__ENDDLGPARAMS.html">ENDDLGPARAMS</a>*)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndDlg, GWLP_USERDATA);
01575         <span class="keywordflow">if</span> (pedp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01576             pedp-&gt;dwFlags |= (<a class="code" href="../../d7/d1/usersrv_8h.html#a11">EDPF_NODLG</a> | <a class="code" href="../../d7/d1/usersrv_8h.html#a12">EDPF_RESPONSE</a>);
01577             <span class="keywordflow">if</span> (pedp-&gt;hbmpWarning != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01578                 DeleteObject(pedp-&gt;hbmpWarning);
01579             }
01580             <span class="keywordflow">if</span> (pedp-&gt;hbrProgress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01581                 DeleteObject(pedp-&gt;hbrProgress);
01582             }
01583         }
01584         <span class="keywordflow">break</span>;
01585     }
01586 
01587     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01588 }
01589 
01590 <span class="comment">/***************************************************************************\</span>
01591 <span class="comment">* _EndTask</span>
01592 <span class="comment">*</span>
01593 <span class="comment">* This routine is called from the task manager to end an application - for</span>
01594 <span class="comment">* gui apps, either a win32 app or a win16 app. Note: Multiple console</span>
01595 <span class="comment">* processes can live in a single console window. We'll pass these requests</span>
01596 <span class="comment">* for destruction to console.</span>
01597 <span class="comment">*</span>
01598 <span class="comment">* 07-25-92 ScottLu      Created.</span>
01599 <span class="comment">\***************************************************************************/</span>
01600 
<a name="l01601"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a17">01601</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a17">_EndTask</a>(
01602     HWND hwnd,
01603     BOOL fShutdown,
01604     BOOL fMeanKill)
01605 {
01606     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01607     PCSR_THREAD pcsrt = CSR_SERVER_QUERYCLIENTTHREAD();
01608     PCSR_THREAD pcsrtKill;
01609     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadId;
01610     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwProcessId;
01611     LPWSTR lpszMsg;
01612     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAllocated;
01613     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCmd;
01614     USERTHREAD_USEDESKTOPINFO utudi;
01615     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01616 
01617     <span class="comment">/*</span>
01618 <span class="comment">     * Note: fShutdown isn't used for anything in this routine!</span>
01619 <span class="comment">     * They are still there because I haven't removed them: the old endtask</span>
01620 <span class="comment">     * code relied on them.</span>
01621 <span class="comment">     */</span>
01622     UNREFERENCED_PARAMETER(fShutdown);
01623 
01624     <span class="comment">/*</span>
01625 <span class="comment">     * Set the current work thread to a desktop so we can</span>
01626 <span class="comment">     *  go safely into win32k.sys</span>
01627 <span class="comment">     */</span>
01628     utudi.hThread = pcsrt-&gt;ThreadHandle;
01629     utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01630 
01631     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
01632             UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
01633     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01634         <span class="comment">/*</span>
01635 <span class="comment">         * We were unable to get the thread's desktop. Game over</span>
01636 <span class="comment">         */</span>
01637         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01638     }
01639 
01640 
01641     <span class="comment">/*</span>
01642 <span class="comment">     * Get the process and thread that owns hwnd.</span>
01643 <span class="comment">     */</span>
01644     dwThreadId = <a class="code" href="../../d3/d8/winmgrc_8c.html#a18">GetWindowThreadProcessId</a>(hwnd, &amp;dwProcessId);
01645     <span class="keywordflow">if</span> (dwThreadId == 0) {
01646         <span class="keywordflow">goto</span> RestoreDesktop;
01647     }
01648 
01649     <span class="comment">/*</span>
01650 <span class="comment">     * Don't allow destruction of winlogon</span>
01651 <span class="comment">     */</span>
01652     <span class="keywordflow">if</span> (dwProcessId == <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a10">gIdLogon</a>) {
01653         <span class="keywordflow">goto</span> RestoreDesktop;
01654     }
01655 
01656     <span class="comment">/*</span>
01657 <span class="comment">     * If this is a console window, then just send the close message to</span>
01658 <span class="comment">     * it, and let console clean up the processes in it.</span>
01659 <span class="comment">     */</span>
01660     <span class="keywordflow">if</span> ((HANDLE)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, GWLP_HINSTANCE) == <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>) {
01661         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwnd, WM_CLOSE, 0, 0);
01662         <span class="keywordflow">goto</span> RestoreDesktop;
01663     }
01664 
01665     <span class="comment">/*</span>
01666 <span class="comment">     * Find the CSR_THREAD for the window.</span>
01667 <span class="comment">     */</span>
01668     CsrLockThreadByClientId((HANDLE)LongToHandle( dwThreadId ), &amp;pcsrtKill);
01669     <span class="keywordflow">if</span> (pcsrtKill == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01670         <span class="keywordflow">goto</span> RestoreDesktop;
01671     }
01672     CsrReferenceThread(pcsrtKill);
01673     CsrUnlockThread(pcsrtKill);
01674 
01675     <span class="comment">/*</span>
01676 <span class="comment">     * If this is a WOW app, then shutdown just this wow application.</span>
01677 <span class="comment">     */</span>
01678     <span class="keywordflow">if</span> (!fMeanKill) {
01679         <span class="comment">/*</span>
01680 <span class="comment">         * Find out what to do now - did the user cancel or the app cancel,</span>
01681 <span class="comment">         * etc? Only allow cancelling if we are not forcing the app to</span>
01682 <span class="comment">         * exit.</span>
01683 <span class="comment">         */</span>
01684         dwCmd = <a class="code" href="../../d7/d1/usersrv_8h.html#a54">ThreadShutdownNotify</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a133">WMCS_ENDTASK</a>, (ULONG_PTR)pcsrtKill, (LPARAM)hwnd);
01685 
01686         <span class="keywordflow">switch</span> (dwCmd) {
01687         <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a17">TSN_APPSAYSNOTOK</a>:
01688             <span class="comment">/*</span>
01689 <span class="comment">             * App says not ok - this'll let taskman bring up the "are you sure?"</span>
01690 <span class="comment">             * dialog to the user.</span>
01691 <span class="comment">             */</span>
01692             CsrDereferenceThread(pcsrtKill);
01693             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01694             <span class="keywordflow">goto</span> RestoreDesktop;
01695 
01696         <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a19">TSN_USERSAYSCANCEL</a>:
01697             <span class="comment">/*</span>
01698 <span class="comment">             * User hit cancel on the timeout dialog - so the user really meant</span>
01699 <span class="comment">             * it. Let taskman know everything is ok by returning TRUE.</span>
01700 <span class="comment">             */</span>
01701             CsrDereferenceThread(pcsrtKill);
01702             <span class="keywordflow">goto</span> RestoreDesktop;
01703         }
01704     }
01705 
01706     <span class="comment">/*</span>
01707 <span class="comment">     * Kill the application now.  If the thread has not been destroyed,</span>
01708 <span class="comment">     * nuke the task.  If WowExitTask returns that the thread is not</span>
01709 <span class="comment">     * a WOW task, terminate the process.</span>
01710 <span class="comment">     */</span>
01711     <span class="keywordflow">if</span> (!(pcsrtKill-&gt;Flags &amp; CSR_THREAD_DESTROYED) &amp;&amp; !<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a8">WowExitTask</a>(pcsrtKill)) {
01712 
01713         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDoBlock;
01714 
01715         <span class="comment">/*</span>
01716 <span class="comment">         * Calling ExitProcess() in the app's context will not always work</span>
01717 <span class="comment">         * because the app may have .dll termination deadlocks: so the thread</span>
01718 <span class="comment">         * will hang with the rest of the process. To ensure apps go away,</span>
01719 <span class="comment">         * we terminate the process with NtTerminateProcess().</span>
01720 <span class="comment">         *</span>
01721 <span class="comment">         * Pass this special value, DBG_TERMINATE_PROCESS, which tells</span>
01722 <span class="comment">         * NtTerminateProcess() to return failure if it can't terminate the</span>
01723 <span class="comment">         * process because the app is being debugged.</span>
01724 <span class="comment">         */</span>
01725         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01726             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExitStatus;
01727             HANDLE <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>;
01728 
01729             ExitStatus = DBG_TERMINATE_PROCESS;
01730             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a>(NtCurrentProcess(),
01731                                                      ProcessDebugPort,
01732                                                      &amp;<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
01733                                                      <span class="keyword">sizeof</span>(HANDLE),
01734                                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) &amp;&amp;
01735                 (<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01736                 <span class="comment">// Csr is being debugged - go ahead and kill the process</span>
01737                 ExitStatus = 0;
01738             }
01739             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(pcsrtKill-&gt;Process-&gt;ProcessHandle,
01740                     ExitStatus))) {
01741 
01742                 bDoBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01743             } <span class="keywordflow">else</span> {
01744                 bDoBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01745             }
01746         } <span class="keywordflow">else</span> {
01747             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(pcsrtKill-&gt;Process-&gt;ProcessHandle,
01748                     DBG_TERMINATE_PROCESS))) {
01749                 bDoBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01750             } <span class="keywordflow">else</span> {
01751                 bDoBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01752             }
01753         }
01754 
01755         <span class="keywordflow">if</span> (bDoBlock) {
01756 
01757             <span class="comment">/*</span>
01758 <span class="comment">             * If the app is being debugged, don't close it - because that can</span>
01759 <span class="comment">             * cause a hang to the NtTerminateProcess() call.</span>
01760 <span class="comment">             */</span>
01761             lpszMsg = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, STR_APPDEBUGGED,
01762                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;fAllocated);
01763             <span class="keywordflow">if</span> (lpszMsg) {
01764                 MessageBoxEx(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpszMsg, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, MB_OK | MB_SETFOREGROUND, 0);
01765                 LocalFree(lpszMsg);
01766             }
01767         } <span class="keywordflow">else</span> {
01768             pcsrtKill-&gt;Process-&gt;Flags |= CSR_PROCESS_TERMINATED;
01769         }
01770     }
01771     CsrDereferenceThread(pcsrtKill);
01772 
01773 RestoreDesktop:
01774     utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01775     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
01776             UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
01777     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01778 
01779     <span class="keywordflow">return</span> fRet;
01780 }
01781 
01782 <span class="comment">/***************************************************************************\</span>
01783 <span class="comment">* WowExitTask</span>
01784 <span class="comment">*</span>
01785 <span class="comment">* Calls wow back to make sure a specific task has exited.  Returns</span>
01786 <span class="comment">* TRUE if the thread is a WOW task, FALSE if not.</span>
01787 <span class="comment">*</span>
01788 <span class="comment">* 08-02-92 ScottLu      Created.</span>
01789 <span class="comment">\***************************************************************************/</span>
01790 
<a name="l01791"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a8">01791</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a8">WowExitTask</a>(
01792     PCSR_THREAD pcsrt)
01793 {
01794     HANDLE ahandle[2];
01795     USERTHREAD_WOW_INFORMATION WowInfo;
01796     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01797 
01798     ahandle[1] = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a20">gheventCancel</a>;
01799 
01800     <span class="comment">/*</span>
01801 <span class="comment">     * Query task id and exit function.</span>
01802 <span class="comment">     */</span>
01803     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a276">NtUserQueryInformationThread</a>(pcsrt-&gt;ThreadHandle,
01804             UserThreadWOWInformation, &amp;WowInfo, <span class="keyword">sizeof</span>(WowInfo), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01805     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01806         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01807 
01808     <span class="comment">/*</span>
01809 <span class="comment">     * If no task id was returned, it is not a WOW task</span>
01810 <span class="comment">     */</span>
01811     <span class="keywordflow">if</span> (WowInfo.hTaskWow == 0)
01812         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01813 
01814     <span class="comment">/*</span>
01815 <span class="comment">     * Try to make it exit itself. This will work most of the time.</span>
01816 <span class="comment">     * If this doesn't work, terminate this process.</span>
01817 <span class="comment">     */</span>
01818     ahandle[0] = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a19">InternalCreateCallbackThread</a>(pcsrt-&gt;Process-&gt;ProcessHandle,
01819                                               (ULONG_PTR)WowInfo.lpfnWowExitTask,
01820                                               (ULONG_PTR)WowInfo.hTaskWow);
01821     <span class="keywordflow">if</span> (ahandle[0] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01822         <a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(pcsrt-&gt;Process-&gt;ProcessHandle, 0);
01823         pcsrt-&gt;Process-&gt;Flags |= CSR_PROCESS_TERMINATED;
01824         <span class="keywordflow">goto</span> Exit;
01825     }
01826 
01827     WaitForMultipleObjects(2, ahandle, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, INFINITE);
01828     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ahandle[0]);
01829 
01830 Exit:
01831     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01832 }
01833 
01834 <span class="comment">/***************************************************************************\</span>
01835 <span class="comment">* InternalWaitCancel</span>
01836 <span class="comment">*</span>
01837 <span class="comment">* Console calls this to wait for objects or shutdown to be cancelled</span>
01838 <span class="comment">*</span>
01839 <span class="comment">* 29-Oct-1992 mikeke    Created</span>
01840 <span class="comment">\***************************************************************************/</span>
01841 
<a name="l01842"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a18">01842</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a18">InternalWaitCancel</a>(
01843     HANDLE handle,
01844     DWORD dwMilliseconds)
01845 {
01846     HANDLE ahandle[2];
01847 
01848     ahandle[0] = handle;
01849     ahandle[1] = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a20">gheventCancel</a>;
01850 
01851     <span class="keywordflow">return</span> WaitForMultipleObjects(2, ahandle, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, dwMilliseconds);
01852 }
01853 
01854 
01855 <span class="comment">/***************************************************************************\</span>
01856 <span class="comment">* InternalCreateCallbackThread</span>
01857 <span class="comment">*</span>
01858 <span class="comment">* This routine creates a remote thread in the context of a given process.</span>
01859 <span class="comment">* It is used to call the console control routine, as well as ExitProcess when</span>
01860 <span class="comment">* forcing an exit. Returns a thread handle.</span>
01861 <span class="comment">*</span>
01862 <span class="comment">* 07-28-92 ScottLu      Created.</span>
01863 <span class="comment">\***************************************************************************/</span>
01864 
<a name="l01865"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a19">01865</a> HANDLE <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a19">InternalCreateCallbackThread</a>(
01866     HANDLE hProcess,
01867     ULONG_PTR lpfn,
01868     ULONG_PTR dwData)
01869 {
01870     LONG BasePriority;
01871     HANDLE hThread, hToken;
01872     PTOKEN_DEFAULT_DACL lpDaclDefault;
01873     TOKEN_DEFAULT_DACL daclDefault;
01874     ULONG cbDacl;
01875     SECURITY_ATTRIBUTES attrThread;
01876     SECURITY_DESCRIPTOR sd;
01877     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idThread;
01878     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01879 
01880     hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01881 
01882     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(hProcess, TOKEN_QUERY, &amp;hToken);
01883     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01884         KdPrint((<span class="stringliteral">"NtOpenProcessToken failed, status = %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01885         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01886     }
01887 
01888     cbDacl = 0;
01889     <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(hToken,
01890             TokenDefaultDacl,
01891             &amp;daclDefault,
01892             <span class="keyword">sizeof</span>(daclDefault),
01893             &amp;cbDacl);
01894 
01895     lpDaclDefault = (PTOKEN_DEFAULT_DACL)LocalAlloc(LMEM_FIXED, cbDacl);
01896     <span class="keywordflow">if</span> (lpDaclDefault == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01897         KdPrint((<span class="stringliteral">"LocalAlloc failed for lpDaclDefault"</span>));
01898         <span class="keywordflow">goto</span> closeexit;
01899     }
01900 
01901     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(hToken,
01902             TokenDefaultDacl,
01903             lpDaclDefault,
01904             cbDacl,
01905             &amp;cbDacl);
01906     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01907         KdPrint((<span class="stringliteral">"NtQueryInformationToken failed, status = %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01908         <span class="keywordflow">goto</span> freeexit;
01909     }
01910 
01911     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(&amp;sd,
01912             SECURITY_DESCRIPTOR_REVISION1))) {
01913         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01914         <span class="keywordflow">goto</span> freeexit;
01915     }
01916 
01917     <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(&amp;sd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, lpDaclDefault-&gt;DefaultDacl, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01918 
01919     attrThread.nLength = <span class="keyword">sizeof</span>(attrThread);
01920     attrThread.lpSecurityDescriptor = &amp;sd;
01921     attrThread.bInheritHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01922 
01923     GetLastError();
01924     hThread = CreateRemoteThread(hProcess,
01925         &amp;attrThread,
01926         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01927         (LPTHREAD_START_ROUTINE)lpfn,
01928         (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)dwData,
01929         0,
01930         &amp;idThread);
01931 
01932     <span class="keywordflow">if</span> (hThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01933         BasePriority = THREAD_PRIORITY_HIGHEST;
01934         <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(hThread,
01935                                ThreadBasePriority,
01936                                &amp;BasePriority,
01937                                <span class="keyword">sizeof</span>(LONG));
01938     }
01939 
01940 freeexit:
01941     LocalFree((HANDLE)lpDaclDefault);
01942 
01943 closeexit:
01944     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hToken);
01945 
01946     <span class="keywordflow">return</span> hThread;
01947 }
01948 
01949 ULONG
<a name="l01950"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a24">01950</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a24">SrvExitWindowsEx</a>(
01951     IN OUT PCSR_API_MSG m,
01952     IN OUT PCSR_REPLY_STATUS ReplyStatus)
01953 {
01954     <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a0">BEGIN_LPC_RECV</a>(EXITWINDOWSEX);
01955 
01956     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a10">_ExitWindowsEx</a>(pcsrt, a-&gt;uFlags, a-&gt;dwReserved);
01957     a-&gt;fSuccess = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01958 
01959     <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a1">END_LPC_RECV</a>();
01960 }
01961 
01962 ULONG
<a name="l01963"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a25">01963</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a25">SrvEndTask</a>(
01964     IN OUT PCSR_API_MSG m,
01965     IN OUT PCSR_REPLY_STATUS ReplyStatus)
01966 {
01967     <a class="code" href="../../d5/d3/struct__ENDTASKMSG.html">PENDTASKMSG</a> petm = (<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html">PENDTASKMSG</a>)&amp;m-&gt;u.ApiMessageData;
01968     PCSR_THREAD pcsrt;
01969     PTEB Teb = NtCurrentTeb();
01970 
01971     Teb-&gt;LastErrorValue = 0;
01972     pcsrt = CSR_SERVER_QUERYCLIENTTHREAD();
01973     <span class="comment">/*</span>
01974 <span class="comment">     * Don't block the client so it can respond to messages while we</span>
01975 <span class="comment">     *  process this request -- we might bring up the End Application</span>
01976 <span class="comment">     *  dialog or the hwnd being shutdown might request some user action.</span>
01977 <span class="comment">     */</span>
01978     <span class="keywordflow">if</span> (pcsrt-&gt;Process-&gt;ClientPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01979         m-&gt;ReturnValue = STATUS_SUCCESS;
01980         petm-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o0">dwLastError</a> = 0;
01981         petm-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o4">fSuccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01982         <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(pcsrt-&gt;Process-&gt;ClientPort, (PPORT_MESSAGE)m);
01983         *ReplyStatus = CsrServerReplied;
01984     }
01985 
01986     petm-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o4">fSuccess</a> = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a17">_EndTask</a>(petm-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o1">hwnd</a>, petm-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o2">fShutdown</a>, petm-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o3">fForce</a>);
01987 
01988     petm-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o0">dwLastError</a> = Teb-&gt;LastErrorValue;
01989     <span class="keywordflow">return</span> STATUS_SUCCESS;
01990 }
01991 
01992 <span class="comment">/***************************************************************************\</span>
01993 <span class="comment">* IsPrivileged</span>
01994 <span class="comment">*</span>
01995 <span class="comment">* Check to see if the client has the specified privileges</span>
01996 <span class="comment">*</span>
01997 <span class="comment">* History:</span>
01998 <span class="comment">* 01-02-91 JimA       Created.</span>
01999 <span class="comment">\***************************************************************************/</span>
02000 
<a name="l02001"></a><a class="code" href="../../d2/d0/server_2exitwin_8c.html#a22">02001</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a22">IsPrivileged</a>(
02002     PPRIVILEGE_SET ppSet)
02003 {
02004     HANDLE hToken;
02005     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02006     BOOLEAN bResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02007     UNICODE_STRING strSubSystem;
02008 
02009     <span class="comment">/*</span>
02010 <span class="comment">     * Impersonate the client</span>
02011 <span class="comment">     */</span>
02012     <span class="keywordflow">if</span> (!CsrImpersonateClient(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
02013         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02014 
02015     <span class="comment">/*</span>
02016 <span class="comment">     * Open the client's token</span>
02017 <span class="comment">     */</span>
02018     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strSubSystem, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"USER32"</span>);
02019     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(NtCurrentThread(), TOKEN_QUERY,
02020             (BOOLEAN)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;hToken))) {
02021 
02022         <span class="comment">/*</span>
02023 <span class="comment">         * Perform the check</span>
02024 <span class="comment">         */</span>
02025         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d4/privileg_8c.html#a2">NtPrivilegeCheck</a>(hToken, ppSet, &amp;bResult);
02026         <a class="code" href="../../d3/d5/seaudit_8c.html#a12">NtPrivilegeObjectAuditAlarm</a>(&amp;strSubSystem, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hToken,
02027                 0, ppSet, bResult);
02028         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hToken);
02029         <span class="keywordflow">if</span> (!bResult) {
02030             SetLastError(ERROR_ACCESS_DENIED);
02031         }
02032     }
02033     CsrRevertToSelf();
02034     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
02035         SetLastError(<a class="code" href="../../d6/d7/error_8c.html#a0">RtlNtStatusToDosError</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02036 
02037     <span class="comment">/*</span>
02038 <span class="comment">     * Return result of privilege check</span>
02039 <span class="comment">     */</span>
02040     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(bResult &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02041 }
02042 
02043 <span class="comment">/***************************************************************************\</span>
02044 <span class="comment">* _RegisterServicesProcess</span>
02045 <span class="comment">*</span>
02046 <span class="comment">* Register the services process.</span>
02047 <span class="comment">*</span>
02048 <span class="comment">* History:</span>
02049 <span class="comment">* 05-05-95 BradG         Created.</span>
02050 <span class="comment">\***************************************************************************/</span>
02051 
02052 ULONG
<a name="l02053"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a27">02053</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a27">SrvRegisterServicesProcess</a>(
02054     IN OUT PCSR_API_MSG m,
02055     IN OUT PCSR_REPLY_STATUS ReplyStatus)
02056 {
02057     PRIVILEGE_SET <a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a248">psTcb</a> = { 1, PRIVILEGE_SET_ALL_NECESSARY,
02058         { SE_TCB_PRIVILEGE, 0 }
02059     };
02060 
02061     <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a0">BEGIN_LPC_RECV</a>(REGISTERSERVICESPROCESS);
02062 
02063     <span class="comment">/*</span>
02064 <span class="comment">     * Allow only one services process and then only if it has TCB</span>
02065 <span class="comment">     * privilege.</span>
02066 <span class="comment">     */</span>
02067     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02068     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a7">gdwServicesProcessId</a> != 0) || !<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a22">IsPrivileged</a>(&amp;<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a248">psTcb</a>)) {
02069         SetLastError(ERROR_ACCESS_DENIED);
02070         a-&gt;fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02071     } <span class="keywordflow">else</span> {
02072         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a7">gdwServicesProcessId</a> = a-&gt;dwProcessId;
02073         a-&gt;fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02074     }
02075     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02076 
02077     <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a1">END_LPC_RECV</a>();
02078 }
02079 
02080 <span class="preprocessor">#if defined(FE_IME)</span>
02081 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
02082 <span class="comment">* IsImeWindow</span>
02083 <span class="comment">*</span>
02084 <span class="comment">* return TRUE if it's IME window</span>
02085 <span class="comment">*</span>
02086 <span class="comment">* History:</span>
02087 <span class="comment">* 06-05-96 KazuM         Created.</span>
02088 <span class="comment">\***************************************************************************/</span>
02089 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
02090 IsImeWindow(
02091     HWND hwnd
02092     )
02093 {
02094     <span class="keywordtype">int</span> num;
02095     WCHAR ClassName[16];
02096     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ClassStyle;
02097 
02098     num = GetClassName(hwnd, ClassName, <span class="keyword">sizeof</span>(ClassName)/<span class="keyword">sizeof</span>(WCHAR)-1);
02099     <span class="keywordflow">if</span> (num == 0)
02100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02101 
02102     ClassName[num] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
02103     <span class="keywordflow">if</span> (wcsncmp(ClassName, L<span class="stringliteral">"IME"</span>, 3) == 0)
02104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02105 
02106     ClassStyle = GetClassLong(hwnd, GCL_STYLE);
02107     <span class="keywordflow">if</span> (ClassStyle &amp; CS_IME)
02108         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02109     <span class="keywordflow">else</span>
02110         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02111 }
02112 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
