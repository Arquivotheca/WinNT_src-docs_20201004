<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: imemenu.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>imemenu.c</h1><a href="../../d2/d0/imemenu_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">// imemenu.c -     IME Menu APIs</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// handles IME specific menu retrieval</span>
00005 <span class="comment">//</span>
00006 <span class="comment">// Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">//</span>
00008 <span class="comment">// History:</span>
00009 <span class="comment">// 23-Mar-1997 hiroyama Created</span>
00011 <span class="comment"></span>
00012 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00013 
00014 <span class="preprocessor">#ifdef HIRO_DEBUG</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define D(x)    x</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00017"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a0">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define D(x)</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00019 <span class="preprocessor"></span>
<a name="l00020"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a1">00020</a> <span class="preprocessor">#define IME_MENU_FILE_NAME  L"ImmMenuInfo"</span>
<a name="l00021"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a2">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define IME_MENU_MAXMEM     (128 * 1024)   // maximum size of mapped file</span>
00022 <span class="preprocessor"></span>
00024 <span class="comment">// private structurs for inter process communication</span>
00025 <span class="comment">//</span>
00026 <span class="comment">// NOTE for NT50: these are dedicated to internat.exe</span>
00027 <span class="comment">//</span>
00028 <span class="comment">// uses memory mapped file as shared buffer</span>
00029 <span class="comment">// all strings expect UNICODE</span>
00030 <span class="comment">// HBITMAP is de-compiled and then compiled again using</span>
00031 <span class="comment">// internat.exe's context</span>
00032 <span class="comment">//</span>
00034 <span class="comment"></span>
<a name="l00035"></a><a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">00035</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">_IMEMENU_BMP_HEADER</a> {
<a name="l00036"></a><a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">00036</a>     <span class="keyword">struct </span><a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">_IMEMENU_BMP_HEADER</a>* <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">lpNext</a>;
<a name="l00037"></a><a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">00037</a>     HBITMAP <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a>;
<a name="l00038"></a><a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">00038</a>     LPBYTE <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">pBits</a>;
<a name="l00039"></a><a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o3">00039</a>     BITMAPINFO <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o3">bmi</a>;
00040 } <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>;
00041 
<a name="l00042"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html">00042</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00043"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o0">00043</a>     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbSize;
<a name="l00044"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o1">00044</a>     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fType;
<a name="l00045"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o2">00045</a>     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fState;
<a name="l00046"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o3">00046</a>     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wID;
<a name="l00047"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o4">00047</a>     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* lpBmpChecked;
<a name="l00048"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o5">00048</a>     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* lpBmpUnchecked;
<a name="l00049"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o6">00049</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwItemData;
<a name="l00050"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o7">00050</a>     WCHAR szString[IMEMENUITEM_STRING_SIZE];    <span class="comment">// menu string: always UNICODE.</span>
<a name="l00051"></a><a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o8">00051</a>     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* lpBmpItem;   <span class="comment">// NULL means no bitmap in this menu</span>
00052 } <a class="code" href="../../d1/d7/structIMEMENU__ITEM.html">IMEMENU_ITEM</a>;
00053 
<a name="l00054"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html">00054</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00055"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o0">00055</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwVersion;                <span class="comment">// holds version of this memory chunk</span>
<a name="l00056"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o1">00056</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwMemSize;                <span class="comment">// size of memory buffer allocated</span>
<a name="l00057"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o2">00057</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;                  <span class="comment">// flags returned from IME</span>
<a name="l00058"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o3">00058</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwType;
<a name="l00059"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">00059</a>     <a class="code" href="../../d1/d7/structIMEMENU__ITEM.html">IMEMENU_ITEM</a>* lpImeParentMenu;  <span class="comment">// parent menu's offset (if any) passed from requester</span>
<a name="l00060"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o5">00060</a>     <a class="code" href="../../d1/d7/structIMEMENU__ITEM.html">IMEMENU_ITEM</a>* lpImeMenu;        <span class="comment">// offset to first menu item (will be set by IME side)</span>
<a name="l00061"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">00061</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;                   <span class="comment">// number of menus to fill (not byte count)</span>
<a name="l00062"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">00062</a>     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* lpBmp;      <span class="comment">// offset to first bitmap header</span>
<a name="l00063"></a><a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o8">00063</a>     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* lpBmpNext;  <span class="comment">// points next available location for bmp buffer</span>
00064 } <a class="code" href="../../d0/d7/structIMEMENU__HEADER.html">IMEMENU_HEADER</a>;
00065 
00066 
00067 <span class="comment">// address conversion</span>
<a name="l00068"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a3">00068</a> <span class="preprocessor">#define CONVTO_OFFSET(x)    ((x) = (LPVOID)((x) ? ((LPBYTE)(x) - offset) : NULL))</span>
<a name="l00069"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a4">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define CONVTO_PTR(x)       ((x) = (LPVOID)((x) ? ((LPBYTE)(x) + offset) : NULL))</span>
00070 <span class="preprocessor"></span>
00071 <span class="preprocessor">#if DBG</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#define CHK_OFFSET(x)       if ((ULONG_PTR)(x) &gt;= pHeader-&gt;dwMemSize) { \</span>
00073 <span class="preprocessor">                                RIPMSG2(RIP_WARNING, "CHK_OFFSET(%s=%lx) is out of range.", #x, (ULONG_PTR)(x)); \</span>
00074 <span class="preprocessor">                            }</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#define CHK_PTR(x)          if ((LPVOID)(x) &lt; (LPVOID)pHeader || (LPBYTE)(x) &gt; (LPBYTE)pHeader + pHeader-&gt;dwMemSize) { \</span>
00076 <span class="preprocessor">                                if ((x) != NULL) { \</span>
00077 <span class="preprocessor">                                    RIPMSG2(RIP_WARNING, "CHK_PTR(%s=%lx) is out of range.", #x, (ULONG_PTR)(x)); \</span>
00078 <span class="preprocessor">                                    DebugBreak(); \</span>
00079 <span class="preprocessor">                                } \</span>
00080 <span class="preprocessor">                            }</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00082"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a5">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define CHK_OFFSET(x)</span>
<a name="l00083"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a6">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define CHK_PTR(x)          if ((x) != NULL) { \</span>
00084 <span class="preprocessor">                                if ((LPVOID)(x) &lt; (LPVOID)pHeader || (LPBYTE)(x) &gt; (LPBYTE)pHeader + pHeader-&gt;dwMemSize) { \</span>
00085 <span class="preprocessor">                                    goto cleanup; \</span>
00086 <span class="preprocessor">                                } \</span>
00087 <span class="preprocessor">                            }</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
<a name="l00090"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a9">00090</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d0/imemenu_8c.html#a9">ConvertImeMenuItemInfoAtoW</a>(LPIMEMENUITEMINFOA lpA, LPIMEMENUITEMINFOW lpW, <span class="keywordtype">int</span> nCP, BOOL copyBmp)
00091 {
00092     <span class="keywordtype">int</span> i;
00093 
00094     lpW-&gt;cbSize         = lpA-&gt;cbSize;
00095     lpW-&gt;fType          = lpA-&gt;fType;
00096     lpW-&gt;fState         = lpA-&gt;fState;
00097     lpW-&gt;wID            = lpA-&gt;wID;
00098     <span class="keywordflow">if</span> (copyBmp) {
00099         lpW-&gt;hbmpChecked    = lpA-&gt;hbmpChecked;
00100         lpW-&gt;hbmpUnchecked  = lpA-&gt;hbmpUnchecked;
00101         lpW-&gt;hbmpItem       = lpA-&gt;hbmpItem;
00102     }
00103     lpW-&gt;dwItemData     = lpA-&gt;dwItemData;
00104 
00105     i = MultiByteToWideChar(nCP,
00106                             0,
00107                             lpA-&gt;szString,
00108                             lstrlenA(lpA-&gt;szString),
00109                             lpW-&gt;szString,
00110                             IMEMENUITEM_STRING_SIZE);
00111 
00112     lpW-&gt;szString[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00113 }
00114 
<a name="l00115"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a10">00115</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d0/imemenu_8c.html#a10">ConvertImeMenuItemInfoWtoA</a>(LPIMEMENUITEMINFOW lpW, LPIMEMENUITEMINFOA lpA, <span class="keywordtype">int</span> nCP)
00116 {
00117     <span class="keywordtype">int</span> i;
00118     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bUDC;
00119 
00120     lpA-&gt;cbSize         = lpW-&gt;cbSize;
00121     lpA-&gt;fType          = lpW-&gt;fType;
00122     lpA-&gt;fState         = lpW-&gt;fState;
00123     lpA-&gt;wID            = lpW-&gt;wID;
00124     lpA-&gt;hbmpChecked    = lpW-&gt;hbmpChecked;
00125     lpA-&gt;hbmpUnchecked  = lpW-&gt;hbmpUnchecked;
00126     lpA-&gt;dwItemData     = lpW-&gt;dwItemData;
00127     lpA-&gt;hbmpItem       = lpW-&gt;hbmpItem;
00128 
00129 
00130     i = WideCharToMultiByte(nCP,
00131                             0,
00132                             lpW-&gt;szString,
00133                             wcslen(lpW-&gt;szString),
00134                             lpA-&gt;szString,
00135                             IMEMENUITEM_STRING_SIZE,
00136                             (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00137                             &amp;bUDC);
00138 
00139     lpA-&gt;szString[i] = <span class="charliteral">'\0'</span>;
00140 }
00141 
00142 
00143 <span class="preprocessor">#if DBG</span>
00144 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d2/d0/imemenu_8c.html#a7">DumpBytes</a>(LPBYTE pb, UINT size)
00145 {
00146     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
00147     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"\npbmi dump:"</span>));
00148     <span class="keywordflow">for</span> (i = 0; i &lt; size; ++i) {
00149         <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"%02X "</span>, pb[i] &amp; 0xff));
00150     }
00151     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"\n"</span>));
00152     UNREFERENCED_PARAMETER(pb); <span class="comment">// just in case</span>
00153 }
00154 <span class="preprocessor">#else</span>
<a name="l00155"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a7">00155</a> <span class="preprocessor"></span><span class="preprocessor">#define DumpBytes(a,b)</span>
00156 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00157 <span class="preprocessor"></span>
00159 <span class="comment">// SaveBitmapToMemory</span>
00160 
<a name="l00161"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a11">00161</a> <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* <a class="code" href="../../d2/d0/imemenu_8c.html#a11">SaveBitmapToMemory</a>(HDC hDC, HBITMAP hBmp, <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* lpBH, <a class="code" href="../../d0/d7/structIMEMENU__HEADER.html">IMEMENU_HEADER</a>* pHeader)
00162 {
00163     HBITMAP hTmpBmp, hBmpOld;
00164     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* lpNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00165     PBITMAPINFO pbmi = &amp;lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o3">bmi</a>;
00166     ULONG sizBMI;
00167 
00168 
00169     <span class="keywordflow">if</span> (!hBmp) {
00170         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SaveBitmapToMemory: hBmp == NULL"</span>);
00171         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00172     }
00173     UserAssert(lpBH != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">// Let the graphics engine to retrieve the dimension of the bitmap for us</span>
00177     <span class="comment">// GetDIBits uses the size to determine if it's BITMAPCOREINFO or BITMAPINFO</span>
00178     <span class="comment">// if BitCount != 0, color table will be retrieved</span>
00179     <span class="comment">//</span>
00180     pbmi-&gt;bmiHeader.biSize = <span class="keyword">sizeof</span> pbmi-&gt;bmiHeader;
00181     pbmi-&gt;bmiHeader.biBitCount = 0;             <span class="comment">// don't get the color table</span>
00182     <span class="keywordflow">if</span> ((GetDIBits(hDC, hBmp, 0, 0, (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pbmi, DIB_RGB_COLORS)) == 0) {
00183         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SaveBitmapToMemory: failed to GetDIBits(NULL)"</span>);
00184        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00185     }
00186 
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Note: 24 bits per pixel has no color table.  So, we don't have to</span>
00190     <span class="comment">// allocate memory for retrieving that.  Otherwise, we do.</span>
00191     <span class="comment">//</span>
00192     <span class="keywordflow">switch</span> (pbmi-&gt;bmiHeader.biBitCount) {
00193         <span class="keywordflow">case</span> 24:                                      <span class="comment">// has color table</span>
00194             sizBMI = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
00195             <span class="keywordflow">break</span>;
00196         <span class="keywordflow">case</span> 16:
00197         <span class="keywordflow">case</span> 32:
00198             sizBMI = <span class="keyword">sizeof</span>(BITMAPINFOHEADER) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) * 3;
00199             <span class="keywordflow">break</span>;
00200         <span class="keywordflow">default</span>:
00201             sizBMI = <span class="keyword">sizeof</span>(BITMAPINFOHEADER) + <span class="keyword">sizeof</span>(RGBQUAD) * (1 &lt;&lt; pbmi-&gt;bmiHeader.biBitCount);
00202             <span class="keywordflow">break</span>;
00203 
00204     }
00205 
00206     <span class="comment">//</span>
00207     <span class="comment">// check if the buffer has enough space to put bitmap</span>
00208     <span class="comment">//</span>
00209     <span class="keywordflow">if</span> ((LPBYTE)pHeader + pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o1">dwMemSize</a> &lt; (LPBYTE)lpBH + <span class="keyword">sizeof</span> lpBH + sizBMI + pbmi-&gt;bmiHeader.biSizeImage) {
00210         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SaveBitmapToMemory: size of bmp image(s) exceed limit "</span>);
00211         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00212     }
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// Now that we know the size of the image, let pBits point the given buffer</span>
00216     <span class="comment">//</span>
00217     lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">pBits</a> = (LPBYTE)pbmi + sizBMI;
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// Bitmap can't be selected into a DC when calling GetDIBits</span>
00221     <span class="comment">// Assume that the hDC is the DC where the bitmap would have been selected</span>
00222     <span class="comment">// if indeed it has been selected</span>
00223     <span class="comment">//</span>
00224     <span class="keywordflow">if</span> (hTmpBmp = CreateCompatibleBitmap(hDC, pbmi-&gt;bmiHeader.biWidth, pbmi-&gt;bmiHeader.biHeight)) {
00225         hBmpOld = SelectObject(hDC, hTmpBmp);
00226         <span class="keywordflow">if</span> (GetDIBits(hDC, hBmp, 0, pbmi-&gt;bmiHeader.biHeight, (LPSTR)lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">pBits</a>, pbmi, DIB_RGB_COLORS) == 0){
00227             SelectObject(hDC, hBmpOld);
00228             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SaveBitmapToMemory: GetDIBits() failed."</span>);
00229             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00230         }
00231         lpNext = (<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>*)((LPBYTE)pbmi + sizBMI + pbmi-&gt;bmiHeader.biSizeImage);
00232 
00233         <a class="code" href="../../d2/d0/imemenu_8c.html#a7">DumpBytes</a>((LPBYTE)pbmi, <span class="keyword">sizeof</span> *pbmi);
00234     } <span class="keywordflow">else</span> {
00235         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SaveBitmapToMemory: CreateCompatibleBitmap() failed."</span>);
00236         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237     }
00238 
00239     SelectObject(hDC, hBmpOld);
00240     DeleteObject(hTmpBmp);
00241     <span class="keywordflow">return</span> lpNext;
00242 }
00243 
00245 <span class="comment">// DecompileBitmap()</span>
00246 <span class="comment">//</span>
00247 <span class="comment">// decompile given hBitmap into IMEMENU_BMP_HEADER</span>
00248 <span class="comment">// manupilate IMEMENU_BMP_HEADER links in IMEMENU_HEADER</span>
00249 <span class="comment">//</span>
00250 <span class="comment">// History:</span>
00251 <span class="comment">// 23-Mar-1997 HiroYama Created</span>
00253 <span class="comment"></span>
<a name="l00254"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a12">00254</a> <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* <a class="code" href="../../d2/d0/imemenu_8c.html#a12">DecompileBitmap</a>(<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html">IMEMENU_HEADER</a>* pHeader, HBITMAP hBitmap)
00255 {
00256     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* pBmp = pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">lpBmp</a>;
00257     HDC hDC;
00258 
00259     <span class="comment">// first search handled bitmap</span>
00260     <span class="keywordflow">while</span> (pBmp) {
00261         <span class="keywordflow">if</span> (pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a> == hBitmap) {
00262             <span class="comment">// if hBitmap is already de-compiled, return it</span>
00263             <span class="keywordflow">return</span> pBmp;
00264         }
00265         pBmp = pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">lpNext</a>;
00266     }
00267 
00268     <span class="comment">// not yet allocated, so prepare memory buffer</span>
00269     pBmp = pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o8">lpBmpNext</a>;
00270     UserAssert(pBmp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00271     <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pBmp);
00272     <span class="keywordflow">if</span> (pBmp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00273         RIPMSG1(RIP_WARNING, <span class="stringliteral">"DecompileBitmap: pBmp == NULL in L%d"</span>, __LINE__);
00274         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00275     }
00276 
00277     <span class="comment">// use desktop's DC</span>
00278     hDC = <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a1">GetDC</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>());
00279     <span class="keywordflow">if</span> (hDC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00280         RIPMSG1(RIP_WARNING, <span class="stringliteral">"DecompileBitmap: hDC == NULL in L%d"</span>, __LINE__);
00281         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00282     }
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// decompile hBitmap</span>
00286     <span class="comment">//</span>
00287     pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">lpNext</a> = pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">lpBmp</a>;
00288     pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o8">lpBmpNext</a> = <a class="code" href="../../d2/d0/imemenu_8c.html#a11">SaveBitmapToMemory</a>(hDC, hBitmap, pBmp, pHeader);
00289     <span class="keywordflow">if</span> (pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o8">lpBmpNext</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00290         RIPMSG1(RIP_WARNING, <span class="stringliteral">"DecompileBitmap: pHeader-&gt;lpBmpNext == NULL in L%d"</span>, __LINE__);
00291         <span class="comment">// error case. restore bmp link, then returns NULL</span>
00292         pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o8">lpBmpNext</a> = pBmp;
00293         pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">lpBmp</a> = pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">lpNext</a>;
00294         pBmp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00295         <span class="keywordflow">goto</span> cleanup;
00296     }
00297 
00298     <span class="comment">// if succeeded, mark this BITMAP_HEADER with hBitmap</span>
00299     pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a> = hBitmap;
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">// put this BITMAP_HEADER in linked list</span>
00303     <span class="comment">//</span>
00304     pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">lpBmp</a> = pBmp;
00305 
00306 cleanup:
00307     <span class="keywordflow">if</span> (hDC)
00308         <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>(), hDC);
00309     <span class="keywordflow">return</span> pBmp;
00310 }
00311 
00313 <span class="comment">// ImmPutImeMenuItemsIntoMappedFile()</span>
00314 <span class="comment">//</span>
00315 <span class="comment">// Interprocess IME Menu handler</span>
00316 <span class="comment">//</span>
00317 <span class="comment">// called from ImeSystemHandler() in user32.dll</span>
00318 <span class="comment">//</span>
00319 <span class="comment">// handler of WM_IME_SYSTEM:IMS_MENU_ITEM</span>
00320 <span class="comment">//</span>
00321 <span class="comment">// History:</span>
00322 <span class="comment">// 23-Mar-1997 HiroYama Created</span>
00324 <span class="comment"></span>
<a name="l00325"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a13">00325</a> LRESULT <a class="code" href="../../d2/d0/imemenu_8c.html#a13">ImmPutImeMenuItemsIntoMappedFile</a>(HIMC hImc)
00326 {
00327     HANDLE hMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00328     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> lpMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00329     <a class="code" href="../../d0/d7/structIMEMENU__HEADER.html">IMEMENU_HEADER</a>* pHeader;
00330     LPIMEMENUITEMINFO lpBuf = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00331     <a class="code" href="../../d1/d7/structIMEMENU__ITEM.html">IMEMENU_ITEM</a>* pMenu;
00332     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* pBmp;
00333     LRESULT lRet = 0;
00334     ULONG_PTR offset;
00335     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00336 
00337     <span class="comment">// Open memory mapped file</span>
00338     hMap = OpenFileMapping(FILE_MAP_ALL_ACCESS, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d2/d0/imemenu_8c.html#a1">IME_MENU_FILE_NAME</a>);
00339     <span class="keywordflow">if</span> (hMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00340         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: cannot open mapped file."</span>);
00341         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00342     }
00343 
00344     <span class="comment">// Map entire view of the file into the process memory space</span>
00345     lpMap = MapViewOfFile(hMap, FILE_MAP_ALL_ACCESS, 0, 0, 0);
00346     <span class="keywordflow">if</span> (lpMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00347         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: cannot map view of file."</span>);
00348         <span class="keywordflow">goto</span> cleanup;
00349         <span class="comment">// I wish if I could use C++...</span>
00350     }
00351 
00352     pHeader = (<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html">IMEMENU_HEADER</a>*)lpMap;
00353 
00355     <span class="comment">// Version check</span>
00357 <span class="comment"></span>    <span class="keywordflow">if</span> (pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o0">dwVersion</a> != 1) {
00358         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: dwVersion(%d) does not match."</span>,
00359                 pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o0">dwVersion</a>);
00360         <span class="keywordflow">goto</span> cleanup;
00361     }
00362 
00364     <span class="comment">// convert offset to pointer</span>
00365     offset = (ULONG_PTR)pHeader;
00366     <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">lpImeParentMenu</a>);
00367     <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">lpImeParentMenu</a>);
00368     pMenu = <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o5">lpImeMenu</a>);
00369     <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o5">lpImeMenu</a>);
00370     <span class="keywordflow">if</span> (pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">dwSize</a>) {
00371         UserAssert(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o5">lpImeMenu</a>);    <span class="comment">// if dwSize is specified, we need real buffer here</span>
00372         lpBuf = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">dwSize</a> * <span class="keyword">sizeof</span>(IMEMENUITEMINFOW));
00373         <span class="keywordflow">if</span> (lpBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00374             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: not enough memory for receiver's buffer."</span>);
00375             <span class="keywordflow">goto</span> cleanup;
00376         }
00377     }
00378 
00379 
00380     <span class="comment">// preparation</span>
00381 <span class="preprocessor">#if DBG</span>
00382 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">lpImeParentMenu</a>) {
00383         UserAssert(!pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">lpImeParentMenu</a>-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o4">lpBmpChecked</a> &amp;&amp;
00384                    !pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">lpImeParentMenu</a>-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o5">lpBmpUnchecked</a> &amp;&amp;
00385                    !pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">lpImeParentMenu</a>-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o8">lpBmpItem</a>);
00386     }
00387 <span class="preprocessor">#endif</span>
00388 <span class="preprocessor"></span>
00390     <span class="comment">// Get IME menus</span>
00391     pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">dwSize</a> = <a class="code" href="../../d2/d0/imemenu_8c.html#a18">ImmGetImeMenuItemsW</a>(hImc, pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o2">dwFlags</a>, pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o3">dwType</a>,
00392                                  (LPIMEMENUITEMINFOW)pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">lpImeParentMenu</a>, lpBuf,
00393                                   pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">dwSize</a> * <span class="keyword">sizeof</span>(IMEMENUITEMINFOW));
00394     <span class="comment">// now, pHeader-&gt;dwSize contains number of menu items rather than byte size</span>
00395     <span class="keywordflow">if</span> (pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">dwSize</a> == 0) {
00396         <span class="keywordflow">goto</span> cleanup;
00397     }
00399 
00400     <span class="comment">//</span>
00401     <span class="comment">// Copy back the information</span>
00402     <span class="comment">//</span>
00403     <span class="comment">// if lpBuf != NULL, we need to copy back information</span>
00404     <span class="comment">//</span>
00405     <span class="keywordflow">if</span> (lpBuf) {
00406         LPIMEMENUITEMINFO lpMenuW = lpBuf;
00407 
00408         pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">lpBmp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00409         <span class="comment">// lpBmpNext will point first possible memory for bmp de-compile</span>
00410         pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o8">lpBmpNext</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)((LPBYTE)pHeader + (pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">dwSize</a> + 1) * <span class="keyword">sizeof</span>(IMEMENUITEMINFOW));
00411 
00412         <span class="comment">// copy menuinfo</span>
00413         <span class="keywordflow">for</span> (i = 0; i &lt; pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">dwSize</a>; ++i, ++pMenu, ++lpMenuW) {
00414             RtlCopyMemory(pMenu, lpMenuW, <span class="keyword">sizeof</span> *lpMenuW);
00415             <span class="comment">// decompile hbitmap</span>
00416             <span class="keywordflow">if</span> (lpMenuW-&gt;hbmpChecked) {
00417                 <span class="keywordflow">if</span> ((pMenu-&gt;lpBmpChecked = <a class="code" href="../../d2/d0/imemenu_8c.html#a12">DecompileBitmap</a>(pHeader, lpMenuW-&gt;hbmpChecked)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00418                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: DecompileBitmap Failed in L%d"</span>, __LINE__);
00419                     <span class="keywordflow">goto</span> cleanup;
00420                 }
00421             }
00422             <span class="keywordflow">if</span> (lpMenuW-&gt;hbmpUnchecked) {
00423                 <span class="keywordflow">if</span> ((pMenu-&gt;lpBmpUnchecked = <a class="code" href="../../d2/d0/imemenu_8c.html#a12">DecompileBitmap</a>(pHeader, lpMenuW-&gt;hbmpUnchecked)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00424                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: DecompileBitmap Failed in L%d"</span>, __LINE__);
00425                     <span class="keywordflow">goto</span> cleanup;
00426                 }
00427             }
00428             <span class="keywordflow">if</span> (lpMenuW-&gt;hbmpItem) {
00429                 <span class="keywordflow">if</span> ((pMenu-&gt;lpBmpItem = <a class="code" href="../../d2/d0/imemenu_8c.html#a12">DecompileBitmap</a>(pHeader, lpMenuW-&gt;hbmpItem)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00430                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: DecompileBitmap Failed in L%d"</span>, __LINE__);
00431                     <span class="keywordflow">goto</span> cleanup;
00432                 }
00433             }
00434         }
00435 
00437         <span class="comment">//</span>
00438         <span class="comment">// convert pointer to offset</span>
00439         <span class="comment">//</span>
00440 
00441         pMenu = pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o5">lpImeMenu</a>;
00442         <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o5">lpImeMenu</a>);
00443         <span class="comment">// no need to convert parent menu, so let it be NULL</span>
00444         <a class="code" href="../../d2/d0/imemenu_8c.html#a0">D</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o4">lpImeParentMenu</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00445 
00446         <span class="comment">// pointer to BITMAP_HEADER in each menu</span>
00447         <span class="keywordflow">for</span> (i = 0; i &lt; pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o6">dwSize</a>; ++i, ++pMenu) {
00448             <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: convertiong '%S'\n"</span>, pMenu-&gt;szString));
00449             <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pMenu-&gt;lpBmpChecked);
00450             <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pMenu-&gt;lpBmpUnchecked);
00451             <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: before conversion (%#lx)\n"</span>, pMenu-&gt;lpBmpItem));
00452             <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pMenu-&gt;lpBmpItem);
00453             <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"ImmPutImeMenuItemsIntoMappedFile: after  conversion (%#lx)\n"</span>, pMenu-&gt;lpBmpItem));
00454 
00455             <span class="comment">// check them</span>
00456             <a class="code" href="../../d2/d0/imemenu_8c.html#a5">CHK_OFFSET</a>(pMenu-&gt;lpBmpChecked);
00457             <a class="code" href="../../d2/d0/imemenu_8c.html#a5">CHK_OFFSET</a>(pMenu-&gt;lpBmpChecked);
00458             <a class="code" href="../../d2/d0/imemenu_8c.html#a5">CHK_OFFSET</a>(pMenu-&gt;lpBmpItem);
00459         }
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// first pointer to BITMAP_HEADER linked list</span>
00463         <span class="comment">//</span>
00464         pBmp = pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">lpBmp</a>;
00465         <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">lpBmp</a>);
00466         <a class="code" href="../../d2/d0/imemenu_8c.html#a5">CHK_OFFSET</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o7">lpBmp</a>);
00467         <span class="comment">// pHeader-&gt;lpBmpNext will not be used, so let it be NULL</span>
00468         <a class="code" href="../../d2/d0/imemenu_8c.html#a0">D</a>(pHeader-&gt;<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html#o8">lpBmpNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00469 
00470         <span class="comment">//</span>
00471         <span class="comment">// pointers in BITMAP_HEADER linked list</span>
00472         <span class="comment">//</span>
00473         <span class="keywordflow">while</span> (pBmp) {
00474             <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* ptBmp = pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">lpNext</a>;
00475             <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">pBits</a>);
00476             <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">lpNext</a>);
00477             <a class="code" href="../../d2/d0/imemenu_8c.html#a5">CHK_OFFSET</a>(pBmp-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">lpNext</a>);
00478             pBmp = ptBmp;
00479         }
00480         <span class="comment">//</span>
00481         <span class="comment">// pointer conversion finished</span>
00482         <span class="comment">//</span>
00484 <span class="comment"></span>    } <span class="comment">// end if (lpBuf)</span>
00485 
00486     <span class="comment">//</span>
00487     <span class="comment">// everything went OK</span>
00488     <span class="comment">//</span>
00489     lRet = 1;
00490 
00491 cleanup:
00492     <span class="keywordflow">if</span> (lpBuf)
00493         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpBuf);
00494     <span class="keywordflow">if</span> (lpMap)
00495         UnmapViewOfFile(lpMap);
00496     <span class="keywordflow">if</span> (hMap)
00497         CloseHandle(hMap);
00498     <span class="keywordflow">return</span> lRet;
00499 }
00500 
00501 
00503 <span class="comment">// InternalImeMenuCreateBitmap()</span>
00504 <span class="comment">//</span>
00505 <span class="comment">// create bitmap from IMEMENU_BMP_HEADER</span>
00507 <span class="comment"></span>
<a name="l00508"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a14">00508</a> HBITMAP <a class="code" href="../../d2/d0/imemenu_8c.html#a14">InternalImeMenuCreateBitmap</a>(<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* lpBH)
00509 {
00510     HDC hDC;
00511 
00512     <span class="keywordflow">if</span> (lpBH == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00513         RIPMSG1(RIP_WARNING, <span class="stringliteral">"InternalImeMenuCreateBitmap: lpBH == NULL in L%d"</span>, __LINE__);
00514         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00515     }
00516     <span class="keywordflow">if</span> (lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">pBits</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00517         RIPMSG1(RIP_WARNING, <span class="stringliteral">"InternalImeMenuCreateBitmap: lpBH-&gt;pBits == NULL in L%d"</span>, __LINE__);
00518         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00519     }
00520 
00521     <span class="keywordflow">if</span> (lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a>) {
00522         <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"InternalImeMenuCreateBitmap: lpBH-&gt;hBitmap != NULL. will return it.\n"</span>));
00523         <span class="keywordflow">return</span> lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a>;
00524     }
00525 
00526     <span class="keywordflow">if</span> (hDC = <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a1">GetDC</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>())) {
00527         HDC hMyDC = CreateCompatibleDC(hDC);
00528         <span class="keywordflow">if</span> (hMyDC) {
00529             <span class="comment">// (select palette) needed ?</span>
00530             lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a> = CreateDIBitmap(hDC, &amp;lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o3">bmi</a>.bmiHeader, CBM_INIT,
00531                                                   lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">pBits</a>, &amp;lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o3">bmi</a>, DIB_RGB_COLORS);
00532             <span class="keywordflow">if</span> (lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00533                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwErr = GetLastError();
00534                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"InternalImeMenuCreateBitmap: CreateDIBitmap Failed. Last error=%#x\n"</span>, dwErr);
00535             }
00536             DeleteDC(hMyDC);
00537         }
00538         <span class="keywordflow">else</span> {
00539             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalImeMenuCreateBitmap: CreateCompatibleDC failed."</span>);
00540         }
00541 
00542         <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>(), hDC);
00543     }
00544     <span class="keywordflow">else</span> {
00545         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalImeMenuCreateBitmap: couldn't get Desktop DC."</span>);
00546     }
00547     <span class="keywordflow">return</span> lpBH-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a>;
00548 }
00549 
00551 <span class="comment">// ImmGetImeMenuItemsInterProcess()</span>
00552 <span class="comment">//</span>
00553 <span class="comment">// Inter process IME Menu handler</span>
00554 <span class="comment">// sends WM_IME_SYSTEM:IMS_GETIMEMENU</span>
00555 <span class="comment">//</span>
00556 <span class="comment">// History:</span>
00557 <span class="comment">// 23-Mar-1997 HiroYama Created</span>
00559 <span class="comment"></span>
<a name="l00560"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a15">00560</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d0/imemenu_8c.html#a15">ImmGetImeMenuItemsInterProcess</a>(HIMC hImc,
00561                                      DWORD dwFlags,
00562                                      DWORD dwType,
00563                                      LPIMEMENUITEMINFOW lpParentMenu,
00564                                      LPIMEMENUITEMINFOW lpMenu,
00565                                      DWORD dwSize)
00566 {
00567     HWND hwnd;
00568     HANDLE hMemFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00569     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet = 0;
00570     LPBYTE lpMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00571     <a class="code" href="../../d0/d7/structIMEMENU__HEADER.html">IMEMENU_HEADER</a>* pHeader;
00572     <a class="code" href="../../d1/d7/structIMEMENU__ITEM.html">IMEMENU_ITEM</a>* pMenuItem;
00573     <a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html">IMEMENU_BMP_HEADER</a>* pBmpHeader;
00574     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00575     ULONG_PTR offset;
00576 
00577     <span class="comment">// Get default IME window</span>
00578     <span class="comment">//</span>
00579     <span class="comment">// Note: We do not consider user created HIMC here, because this inter-process call is intended to</span>
00580     <span class="comment">// support only internat.exe, and this message is passed as just a kick to IMM's def WinProc.</span>
00581     hwnd = (HWND)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a389">NtUserQueryInputContext</a>(hImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a74a50">InputContextDefaultImeWindow</a>);
00582     <span class="keywordflow">if</span> (hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwnd)) {
00583         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsInterProcess: hwnd(%lx) is not a valid window."</span>, hwnd);
00584         <span class="keywordflow">return</span> 0;
00585     }
00586 
00587     RtlEnterCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00588 
00589     <span class="comment">// first, create memory mapped file</span>
00590     hMemFile = CreateFileMapping((HANDLE)~0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, PAGE_READWRITE,
00591                                  0, <a class="code" href="../../d2/d0/imemenu_8c.html#a2">IME_MENU_MAXMEM</a>, <a class="code" href="../../d2/d0/imemenu_8c.html#a1">IME_MENU_FILE_NAME</a>);
00592     <span class="keywordflow">if</span> (hMemFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00593         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsInterProcess: cannot allocate memory mapped file."</span>);
00594         <span class="keywordflow">goto</span> cleanup;
00595     }
00596     <span class="comment">// then get a view of the mapped file</span>
00597     lpMap = (LPBYTE)MapViewOfFile(hMemFile, FILE_MAP_READ | FILE_MAP_WRITE, 0, 0, 0);
00598     <span class="keywordflow">if</span> (lpMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00599         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsInterProcess: cannot map view of memory mapped file."</span>);
00600         <span class="keywordflow">goto</span> cleanup;
00601     }
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">// shared buffer (memory mapped file) initialization</span>
00605     <span class="comment">//</span>
00606     pHeader = (<a class="code" href="../../d0/d7/structIMEMENU__HEADER.html">IMEMENU_HEADER</a>*)lpMap;
00607     RtlZeroMemory(pHeader, <span class="keyword">sizeof</span> *pHeader);
00608     pHeader-&gt;dwVersion = 1;
00609     pHeader-&gt;dwMemSize = <a class="code" href="../../d2/d0/imemenu_8c.html#a2">IME_MENU_MAXMEM</a>;
00610     pHeader-&gt;dwSize = dwSize / <span class="keyword">sizeof</span>(IMEMENUITEMINFOW);    <span class="comment">// CAUTION: dwSize could be 0.</span>
00611     RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsInterProcess: pHeader-&gt;dwSize=%ld"</span>, pHeader-&gt;dwSize);
00612     pHeader-&gt;dwFlags = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00613     pHeader-&gt;dwType = dwType;
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// 1) dwSize != 0 and lpMenu != NULL means, caller requests the given buffer filled</span>
00617     <span class="comment">// 2) if lpParentMenu is passed, we need to put its information in shared buffer</span>
00618     <span class="comment">//</span>
00619     <span class="keywordflow">if</span> ((dwSize &amp;&amp; lpMenu) || lpParentMenu) {
00620         <span class="comment">// if parent menu is specified, copy it here</span>
00621         <span class="keywordflow">if</span> (lpParentMenu) {
00622             <a class="code" href="../../d1/d7/structIMEMENU__ITEM.html">IMEMENU_ITEM</a>* pPMenu =
00623                 pHeader-&gt;lpImeParentMenu = (<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html">IMEMENU_ITEM</a>*)&amp;pHeader[1];
00624 
00625             RtlCopyMemory(pPMenu, lpParentMenu, <span class="keyword">sizeof</span>(IMEMENUITEMINFOW));
00626 
00627             <span class="comment">// by design, IME will receive NULL hbmpItem in parent menu.</span>
00628             <span class="comment">// there is no way to guarantee the same hbmpItem is returned, thus NULL is passed.</span>
00629             pPMenu-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o4">lpBmpChecked</a> = pPMenu-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o5">lpBmpUnchecked</a> = pPMenu-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o8">lpBmpItem</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00630             pHeader-&gt;lpImeMenu = pHeader-&gt;lpImeParentMenu + 1;
00631         }
00632         <span class="keywordflow">else</span> {
00633             pHeader-&gt;lpImeParentMenu = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00634             pHeader-&gt;lpImeMenu = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;pHeader[1];
00635         }
00636         <span class="comment">// convert pointer to offset</span>
00637         offset = (ULONG_PTR)lpMap;
00638         <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pHeader-&gt;lpImeParentMenu);
00639         <a class="code" href="../../d2/d0/imemenu_8c.html#a3">CONVTO_OFFSET</a>(pHeader-&gt;lpImeMenu);
00640     }
00641 
00642 
00643 
00644 
00646     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_IME_SYSTEM, IMS_GETIMEMENU, (LPARAM)hImc)) {
00647         <span class="comment">// if it fails</span>
00648         <span class="keywordflow">goto</span> cleanup;
00649     }
00651 
00652     <span class="comment">// NOTE: dwSize is maximum index of menu array. not a total byte size of array.</span>
00653     dwSize = pHeader-&gt;dwSize;
00654 
00655     <span class="keywordflow">if</span> (lpMenu) {
00657         <span class="comment">// convert offset to pointer</span>
00659 <span class="comment"></span>        pMenuItem = <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pHeader-&gt;lpImeMenu);
00660         <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pMenuItem);
00661         <span class="comment">// NOTE: we don't have to handle parent menu</span>
00662 
00663         <span class="comment">//</span>
00664         <span class="comment">// pointers to BITMAP_HEADER in each menu structure</span>
00665         <span class="comment">//</span>
00666         <span class="keywordflow">for</span> (i = 0; i &lt; dwSize; ++i, ++pMenuItem) {
00667             <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pMenuItem-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o4">lpBmpChecked</a>);
00668             <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pMenuItem-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o5">lpBmpUnchecked</a>);
00669             <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pMenuItem-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o8">lpBmpItem</a>);
00670             <span class="comment">//</span>
00671             <span class="comment">// check the pointers</span>
00672             <span class="comment">//</span>
00673             <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pMenuItem-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o4">lpBmpChecked</a>);
00674             <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pMenuItem-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o5">lpBmpUnchecked</a>);
00675             <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pMenuItem-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o8">lpBmpItem</a>);
00676         }
00677 
00678         <span class="comment">//</span>
00679         <span class="comment">// pointer to first BITMAP_HEADER</span>
00680         <span class="comment">//</span>
00681         pBmpHeader = <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pHeader-&gt;lpBmp);
00682 
00683         <span class="comment">//</span>
00684         <span class="comment">// each BITMAP_HEADER</span>
00685         <span class="comment">//</span>
00686         <span class="keywordflow">while</span> (pBmpHeader) {
00687             pBmpHeader-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o1">hBitmap</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// clear</span>
00688             <span class="comment">// pBits</span>
00689             <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pBmpHeader-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">pBits</a>);
00690             <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pBmpHeader-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o2">pBits</a>);
00691 
00692             <span class="comment">// next BITMAP_HEADER</span>
00693             pBmpHeader = <a class="code" href="../../d2/d0/imemenu_8c.html#a4">CONVTO_PTR</a>(pBmpHeader-&gt;<a class="code" href="../../d5/d1/struct__IMEMENU__BMP__HEADER.html#o0">lpNext</a>);
00694             <a class="code" href="../../d2/d0/imemenu_8c.html#a6">CHK_PTR</a>(pBmpHeader);
00695         }
00696 
00697         <span class="comment">//</span>
00698         <span class="comment">// copy back the results</span>
00699         <span class="comment">//</span>
00700         pMenuItem = pHeader-&gt;lpImeMenu;
00701         <span class="keywordflow">for</span> (i = 0; i &lt; dwSize; ++i, ++pMenuItem, ++lpMenu) {
00702             lpMenu-&gt;<a class="code" href="../../d1/d7/structIMEMENU__ITEM.html#o0">cbSize</a> = pMenuItem-&gt;cbSize;
00703             lpMenu-&gt;fType = pMenuItem-&gt;fType;
00704             lpMenu-&gt;fState = pMenuItem-&gt;fState;
00705             lpMenu-&gt;wID = pMenuItem-&gt;wID;
00706             lpMenu-&gt;dwItemData = pMenuItem-&gt;dwItemData;
00707             wcscpy(lpMenu-&gt;szString, pMenuItem-&gt;szString);
00708 
00709             <span class="comment">// Create bitmap from memory buffer</span>
00710             <span class="comment">// hbmp will be NULL if no bmp is specified.</span>
00711             <span class="keywordflow">if</span> (pMenuItem-&gt;lpBmpChecked) {
00712                 lpMenu-&gt;hbmpChecked = <a class="code" href="../../d2/d0/imemenu_8c.html#a14">InternalImeMenuCreateBitmap</a>(pMenuItem-&gt;lpBmpChecked);
00713             }
00714             <span class="keywordflow">else</span> {
00715                 lpMenu-&gt;hbmpChecked = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00716             }
00717             <span class="keywordflow">if</span> (pMenuItem-&gt;lpBmpUnchecked) {
00718                 lpMenu-&gt;hbmpUnchecked = <a class="code" href="../../d2/d0/imemenu_8c.html#a14">InternalImeMenuCreateBitmap</a>(pMenuItem-&gt;lpBmpUnchecked);
00719             }
00720             <span class="keywordflow">else</span> {
00721                 lpMenu-&gt;hbmpUnchecked = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00722             }
00723             <span class="keywordflow">if</span> (pMenuItem-&gt;lpBmpItem) {
00724                 lpMenu-&gt;hbmpItem = <a class="code" href="../../d2/d0/imemenu_8c.html#a14">InternalImeMenuCreateBitmap</a>(pMenuItem-&gt;lpBmpItem);
00725             }
00726             <span class="keywordflow">else</span> {
00727                 lpMenu-&gt;hbmpItem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00728             }
00729         }
00730     }
00731 
00732 
00733 cleanup:
00734     <span class="keywordflow">if</span> (lpMap) {
00735         UnmapViewOfFile(lpMap);
00736     }
00737     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00738     <span class="comment">// destroy memory mapped file</span>
00739     <span class="keywordflow">if</span> (hMemFile) {
00740         CloseHandle(hMemFile);
00741     }
00742 
00743     <span class="keywordflow">return</span> dwSize;
00744 }
00745 
00747 <span class="comment">// ImmGetImeMenuItemsWorker()</span>
00748 <span class="comment">//</span>
00749 <span class="comment">// Handler of IME Menu</span>
00750 <span class="comment">//</span>
00751 <span class="comment">// if specified HIMC belongs to other process, it calls</span>
00752 <span class="comment">// ImmGetImeMenuItemsInterProcess()</span>
00753 <span class="comment">//</span>
00754 <span class="comment">// History:</span>
00755 <span class="comment">// 23-Mar-1997 HiroYama Created</span>
00757 <span class="comment"></span>
00758 
<a name="l00759"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a16">00759</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d0/imemenu_8c.html#a16">ImmGetImeMenuItemsWorker</a>(HIMC hIMC,
00760                                DWORD dwFlags,
00761                                DWORD dwType,
00762                                LPVOID lpImeParentMenu,
00763                                LPVOID lpImeMenu,
00764                                DWORD dwSize,
00765                                BOOL bAnsiOrigin)
00766 {
00767     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiIme = <a class="code" href="../../d4/d0/immcli_8h.html#a117">IsAnsiIMC</a>(hIMC);
00768     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet = 0;
00769     LPINPUTCONTEXT lpInputContext;
00770     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadId;
00771     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00772     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> lpImePTemp = lpImeParentMenu;    <span class="comment">// keeps parent menu</span>
00773     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> lpImeTemp = lpImeMenu;           <span class="comment">// points menu buffer</span>
00774     IMEMENUITEMINFOA imiiParentA;
00775     IMEMENUITEMINFOW imiiParentW;
00776 
00777     <span class="comment">//</span>
00778     <span class="comment">// check if the call will be inter process</span>
00779     <span class="comment">//</span>
00780     {
00781         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwProcessId = <a class="code" href="../../d4/d0/immcli_8h.html#a14">GetInputContextProcess</a>(hIMC);
00782         <span class="keywordflow">if</span> (dwProcessId == 0) {
00783             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: dwProcessId == 0"</span>);
00784             <span class="keywordflow">return</span> 0;
00785         }
00786         <span class="keywordflow">if</span> (dwProcessId != <a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>()) {
00787             <span class="comment">//</span>
00788             <span class="comment">// going to call another process' IME</span>
00789             <span class="comment">//</span>
00790             <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"ImmGetImeMenuItemsWorker: Inter process.\n"</span>));
00791             <span class="keywordflow">if</span> (bAnsiOrigin) {
00792                 <span class="comment">//</span>
00793                 <span class="comment">// this inter-process thing is only allowed to internat.exe or equivalent</span>
00794                 <span class="comment">//</span>
00795                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: interprocess getmenu is not allowed for ANSI caller."</span>);
00796                 <span class="keywordflow">return</span> 0;
00797             }
00798             <span class="keywordflow">return</span> <a class="code" href="../../d2/d0/imemenu_8c.html#a15">ImmGetImeMenuItemsInterProcess</a>(hIMC, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, dwType, lpImeParentMenu,
00799                                                   lpImeMenu, dwSize);
00800         }
00801     }
00802 
00803     <span class="comment">//</span>
00804     <span class="comment">// within process</span>
00805     <span class="comment">//</span>
00806 
00807     <span class="keywordflow">if</span> (hIMC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (lpInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hIMC)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00808         RIPMSG2(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: illegal hIMC(%#lx) in L%d"</span>, hIMC, __LINE__);
00809         <span class="keywordflow">return</span> 0;
00810     }
00811 
00812     dwThreadId = <a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hIMC);
00813     <span class="keywordflow">if</span> (dwThreadId == 0) {
00814         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: dwThreadId = 0 in L%d"</span>, __LINE__);
00815         <span class="keywordflow">goto</span> cleanup;
00816     }
00817     <span class="keywordflow">if</span> ((pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(<a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(dwThreadId))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00818         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemWorker: pImeDpi == NULL in L%d."</span>, __LINE__);
00819         <span class="keywordflow">goto</span> cleanup;
00820     }
00821 
00822 <span class="preprocessor">#if 0   // NT: we don't keep version info in ImeDpi</span>
00823 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pImeDpi-&gt;dwWinVersion &lt;= IMEVER_0310) {
00824         RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetImeMenuItems: OldIME does not support this. %lx"</span>, hIMC);
00825         <span class="keywordflow">goto</span> cleanup;
00826     }
00827 <span class="preprocessor">#endif</span>
00828 <span class="preprocessor"></span>
00829     <span class="comment">//</span>
00830     <span class="comment">// if IME does not support IME Menu, do nothing</span>
00831     <span class="comment">//</span>
00832     <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o28">ImeGetImeMenuItems</a>) {
00833         <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> lpNewBuf = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00834 
00835         <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"ImmGetImeMenuItemsWorker: IME has menu callback.\n"</span>));
00836 
00837         <span class="keywordflow">if</span> (bAnsiIme != bAnsiOrigin) {
00838             <span class="comment">//</span>
00839             <span class="comment">// we need A/W translation before calling IME</span>
00840             <span class="comment">//</span>
00841             <span class="keywordflow">if</span> (bAnsiOrigin) {
00842                 <span class="comment">// ANSI API and UNICODE IME.</span>
00843                 <span class="comment">// A to W conversion needed here</span>
00844                 <span class="keywordflow">if</span> (lpImeParentMenu) {
00845                     <span class="comment">// parent menu is specified. need conversion</span>
00846                     lpImePTemp = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;imiiParentW;
00847                     <a class="code" href="../../d2/d0/imemenu_8c.html#a9">ConvertImeMenuItemInfoAtoW</a>((LPIMEMENUITEMINFOA)lpImeParentMenu,
00848                                                (LPIMEMENUITEMINFOW)lpImePTemp,
00849                                                 CP_ACP, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);  <span class="comment">// ANSI app, UNICODE IME: let's use CP_ACP</span>
00850                 }
00851                 <span class="keywordflow">if</span> (lpImeMenu) {
00852                     <span class="comment">// allocate memory block for temporary storage</span>
00853                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNumBuffer = dwSize / <span class="keyword">sizeof</span>(IMEMENUITEMINFOA);
00854                     dwSize = dwNumBuffer * <span class="keyword">sizeof</span>(IMEMENUITEMINFOW);
00855                     <span class="keywordflow">if</span> (dwSize == 0) {
00856                         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: (AtoW) dwSize is 0."</span>);
00857                         <span class="keywordflow">goto</span> cleanup;
00858                     }
00859                     lpImeTemp = lpNewBuf = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwSize);
00860                     <a class="code" href="../../d7/d5/ntuser_2client_2nt6_2debug_8h.html#a0">TRACE</a>((<span class="stringliteral">"ImmGetImeMenuItemsWorker: for UNICODE IME memory allocated %d bytes. lpNewBuf=%#x\n"</span>, dwSize, lpNewBuf));
00861                     <span class="keywordflow">if</span> (lpNewBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00862                         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: cannot alloc lpNewBuf in L%d"</span>, __LINE__);
00863                         <span class="keywordflow">goto</span> cleanup;
00864                     }
00865                 }
00866             }
00867             <span class="keywordflow">else</span> {
00868                 <span class="comment">// UNICODE API and ANSI IME.</span>
00869                 <span class="comment">// W to A conversion needed here</span>
00870                 <span class="keywordflow">if</span> (lpImeParentMenu) {
00871                     <span class="comment">// parent menu is speicified. need conversion</span>
00872                     lpImePTemp = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;imiiParentA;
00873                     <a class="code" href="../../d2/d0/imemenu_8c.html#a10">ConvertImeMenuItemInfoWtoA</a>((LPIMEMENUITEMINFOW)lpImeParentMenu,
00874                                                (LPIMEMENUITEMINFOA)lpImePTemp,
00875                                                 pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o4">dwCodePage</a>);   <span class="comment">// Note: hopefully in the future, this can be changed to IMECodePage(pImeDpi)</span>
00876                 }
00877                 <span class="keywordflow">if</span> (lpImeMenu) {
00878                     <span class="comment">// allocate memory block for temporary storage</span>
00879                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNumBuffer = dwSize / <span class="keyword">sizeof</span>(IMEMENUITEMINFOW);
00880                     dwSize = dwNumBuffer / <span class="keyword">sizeof</span>(IMEMENUITEMINFOA);
00881                     <span class="keywordflow">if</span> (dwSize == 0) {
00882                         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: (WtoA) dwSize is 0."</span>);
00883                         <span class="keywordflow">goto</span> cleanup;
00884                     }
00885                     lpImeTemp = lpNewBuf = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwSize);
00886                     RIPMSG2(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: for ANSI IME memory allocated %d bytes. lpNewBuf=%#x"</span>, dwSize, lpNewBuf);
00887                     <span class="keywordflow">if</span> (lpNewBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00888                         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetImeMenuItemsWorker: cannot alloc lpNewBuf in L%d"</span>, __LINE__);
00889                         <span class="keywordflow">goto</span> cleanup;
00890                     }
00891                 }
00892             }
00893         }
00894 
00896         dwRet = pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o28">ImeGetImeMenuItems</a>(hIMC, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, dwType, lpImePTemp, lpImeTemp, dwSize);
00898 
00899         <span class="comment">//</span>
00900         <span class="comment">// back-conversion needed if:</span>
00901         <span class="comment">// 1) IME returns menus, and</span>
00902         <span class="comment">// 2) A/W is different between caller and IME, and</span>
00903         <span class="comment">// 3) caller wants the buffer to be filled</span>
00904         <span class="comment">//</span>
00905         <span class="keywordflow">if</span> (dwRet &amp;&amp; bAnsiIme != bAnsiOrigin &amp;&amp; lpImeTemp) {
00906             <span class="keywordflow">if</span> (bAnsiOrigin) {
00907                 <span class="comment">// ANSI API and UNICODE IME.</span>
00908                 <span class="comment">// W to A conversion needed here</span>
00909                 LPIMEMENUITEMINFOW lpW = (LPIMEMENUITEMINFOW)lpImeTemp;
00910                 LPIMEMENUITEMINFOA lpA = (LPIMEMENUITEMINFOA)lpImeMenu;
00911                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00912 
00913                 <span class="keywordflow">for</span> (i = 0; i &lt; dwRet; ++i) {
00914                     <a class="code" href="../../d2/d0/imemenu_8c.html#a10">ConvertImeMenuItemInfoWtoA</a>((LPIMEMENUITEMINFOW)lpW++,
00915                                                (LPIMEMENUITEMINFOA)lpA++,
00916                                                 CP_ACP);    <span class="comment">// ANSI app and UNICODE IME: let's use CP_ACP</span>
00917                 }
00918             }
00919             <span class="keywordflow">else</span> {
00920                 <span class="comment">// UNICODE API and ANSI IME.</span>
00921                 <span class="comment">// A to W conversion needed here</span>
00922                 LPIMEMENUITEMINFOA lpA = (LPIMEMENUITEMINFOA)lpImeTemp;
00923                 LPIMEMENUITEMINFOW lpW = (LPIMEMENUITEMINFOW)lpImeMenu;
00924                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00925 
00926                 <span class="keywordflow">for</span> (i = 0; i &lt; dwSize; i++) {
00927                     <a class="code" href="../../d2/d0/imemenu_8c.html#a9">ConvertImeMenuItemInfoAtoW</a>((LPIMEMENUITEMINFOA)lpA++,
00928                                                (LPIMEMENUITEMINFOW)lpW++,
00929                                                pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o4">dwCodePage</a>,     <span class="comment">// Note: hopefully in the future, this can be changed to IMECodePage(pImeDpi)</span>
00930                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>); <span class="comment">// copy hbitmap also</span>
00931                 }
00932             }
00933         }
00934 
00935         <span class="comment">// free temporary buffer if we've allocated it</span>
00936         <span class="keywordflow">if</span> (lpNewBuf)
00937             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpNewBuf);
00938     }   <span class="comment">// end if IME has menu callback</span>
00939 
00940 cleanup:
00941     <span class="keywordflow">if</span> (pImeDpi) {
00942         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00943     }
00944 
00945     <span class="keywordflow">if</span> (hIMC != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00946         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hIMC);
00947     }
00948 
00949     <span class="keywordflow">return</span> dwRet;
00950 }
00951 
00952 
<a name="l00953"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a17">00953</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d2/d0/imemenu_8c.html#a17">ImmGetImeMenuItemsA</a>(
00954     HIMC    hIMC,
00955     DWORD   dwFlags,
00956     DWORD   dwType,
00957     LPIMEMENUITEMINFOA lpImeParentMenu,
00958     LPIMEMENUITEMINFOA lpImeMenu,
00959     DWORD   dwSize)
00960 {
00961     <span class="keywordflow">return</span> <a class="code" href="../../d2/d0/imemenu_8c.html#a16">ImmGetImeMenuItemsWorker</a>(hIMC, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, dwType,
00962                                     (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lpImeParentMenu,
00963                                     (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lpImeMenu, dwSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="comment">/* ANSI origin */</span>);
00964 }
00965 
00966 
<a name="l00967"></a><a class="code" href="../../d2/d0/imemenu_8c.html#a18">00967</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d2/d0/imemenu_8c.html#a18">ImmGetImeMenuItemsW</a>(
00968     HIMC    hIMC,
00969     DWORD   dwFlags,
00970     DWORD   dwType,
00971     LPIMEMENUITEMINFOW lpImeParentMenu,
00972     LPIMEMENUITEMINFOW lpImeMenu,
00973     DWORD   dwSize)
00974 {
00975     <span class="keywordflow">return</span> <a class="code" href="../../d2/d0/imemenu_8c.html#a16">ImmGetImeMenuItemsWorker</a>(hIMC, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, dwType,
00976                                     (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lpImeParentMenu,
00977                                     (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lpImeMenu, dwSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="comment">/* UNICODE origin */</span>);
00978 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:21 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
