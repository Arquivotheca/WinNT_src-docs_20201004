<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: misc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>misc.c</h1><a href="../../d2/d0/ke_2i386_2misc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    misc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements machine dependent miscellaneous kernel functions.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Ken Reneris     7-5-95</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00026 
<a name="l00027"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a4">00027</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>;
<a name="l00028"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a5">00028</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a>;
00029 
00030 <span class="comment">//</span>
00031 <span class="comment">// Internal format of the floating_save structure which is passed</span>
00032 <span class="comment">//</span>
<a name="l00033"></a><a class="code" href="../../d0/d8/struct__CONTROL__WORD.html">00033</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d8/struct__CONTROL__WORD.html">_CONTROL_WORD</a> {
<a name="l00034"></a><a class="code" href="../../d0/d8/struct__CONTROL__WORD.html#o0">00034</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      <a class="code" href="../../d0/d8/struct__CONTROL__WORD.html#o0">ControlWord</a>;
<a name="l00035"></a><a class="code" href="../../d0/d8/struct__CONTROL__WORD.html#o1">00035</a>     ULONG       <a class="code" href="../../d0/d8/struct__CONTROL__WORD.html#o1">MXCsr</a>;
00036 } <a class="code" href="../../d0/d8/struct__CONTROL__WORD.html">CONTROL_WORD</a>, *<a class="code" href="../../d0/d8/struct__CONTROL__WORD.html">PCONTROL_WORD</a>;
00037 
<a name="l00038"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html">00038</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00039"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html#o0">00039</a>     UCHAR       Flags;
<a name="l00040"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html#o1">00040</a>     KIRQL       Irql;
<a name="l00041"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html#o2">00041</a>     KIRQL       PreviousNpxIrql;
<a name="l00042"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html#o3">00042</a>     UCHAR       Spare[2];
00043 
00044     <span class="keyword">union </span>{
<a name="l00045"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html#o4">00045</a>         <a class="code" href="../../d0/d8/struct__CONTROL__WORD.html">CONTROL_WORD</a>    Fcw;
<a name="l00046"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html#o5">00046</a>         PFX_SAVE_AREA   Context;
00047     } u;
<a name="l00048"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html#o7">00048</a>     ULONG       Cr0NpxState;
00049 
<a name="l00050"></a><a class="code" href="../../d7/d9/structFLOAT__SAVE.html#o8">00050</a>     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>    Thread;         <span class="comment">// debug</span>
00051 
00052 } <a class="code" href="../../d7/d9/structFLOAT__SAVE.html">FLOAT_SAVE</a>, *<a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a8">PFLOAT_SAVE</a>;
00053 
00054 
<a name="l00055"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a0">00055</a> <span class="preprocessor">#define FLOAT_SAVE_COMPLETE_CONTEXT     0x01</span>
<a name="l00056"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a1">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define FLOAT_SAVE_FREE_CONTEXT_HEAP    0x02</span>
<a name="l00057"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a2">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define FLOAT_SAVE_VALID                0x04</span>
<a name="l00058"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a3">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define FLOAT_SAVE_RESERVED             0xF8</span>
00059 <span class="preprocessor"></span>
00060 <span class="preprocessor">#pragma warning(disable:4035)               // re-enable below</span>
00061 <span class="preprocessor"></span>
00062 <span class="comment">// notes:</span>
00063 <span class="comment">// Kix86FxSave(NpxFame) - performs an FxSave to the address specificied</span>
00064 <span class="comment">//                   - no other action occurs</span>
00065 __inline
00066 KIRQL
<a name="l00067"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a9">00067</a> <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a9">Kix86FxSave</a>(
00068     PULONG NpxFrame
00069     )
00070 {
00071     _asm {
00072         mov eax, NpxFrame
00073         ;fxsave [eax]
00074         _emit  0fh
00075         _emit  0aeh
00076         _emit   0
00077     }
00078 }
00079 
00080 <span class="comment">// Kix86FnSave(NpxFame) - performs an FxSave to the address specificied</span>
00081 <span class="comment">//                   - no other action occurs</span>
00082 __inline
00083 KIRQL
<a name="l00084"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a10">00084</a> <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a10">Kix86FnSave</a>(
00085     PULONG NpxFrame
00086     )
00087 {
00088     __asm {
00089         mov eax, NpxFrame
00090         fnsave [eax]
00091     }
00092 }
00093 
00094 <span class="comment">//</span>
00095 <span class="comment">// Load Katmai New Instruction Technology Control/Status</span>
00096 <span class="comment">//</span>
00097 __inline
00098 KIRQL
<a name="l00099"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a11">00099</a> <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a11">Kix86LdMXCsr</a>(
00100     PULONG MXCsr
00101     )
00102 {
00103     _asm {
00104         mov eax, MXCsr
00105         ;LDMXCSR [eax]
00106         _emit  0fh
00107         _emit  0aeh
00108         _emit  10h
00109     }
00110 }
00111 
00112 <span class="comment">//</span>
00113 <span class="comment">// Store Katmai New Instruction Technology Control/Status</span>
00114 <span class="comment">//</span>
00115 __inline
00116 KIRQL
<a name="l00117"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a12">00117</a> <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a12">Kix86StMXCsr</a>(
00118     PULONG MXCsr
00119     )
00120 {
00121     _asm {
00122         mov eax, MXCsr
00123         ;STMXCSR [eax]
00124         _emit  0fh
00125         _emit  0aeh
00126         _emit  18h
00127     }
00128 }
00129 <span class="preprocessor">#pragma warning(default:4035)</span>
00130 <span class="preprocessor"></span>
00131 
00132 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00133"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a13">00133</a> <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a13">KeSaveFloatingPointState</a> (
00134     OUT PKFLOATING_SAVE     PublicFloatSave
00135     )
00136 <span class="comment">/*++</span>
00137 <span class="comment"></span>
00138 <span class="comment">Routine Description:</span>
00139 <span class="comment"></span>
00140 <span class="comment">    This routine saves the thread's current non-volatile NPX state,</span>
00141 <span class="comment">    and sets a new initial floating point state for the caller.</span>
00142 <span class="comment"></span>
00143 <span class="comment">Arguments:</span>
00144 <span class="comment"></span>
00145 <span class="comment">    FloatSave - receives the current non-volatile npx state for the thread</span>
00146 <span class="comment"></span>
00147 <span class="comment">Return Value:</span>
00148 <span class="comment"></span>
00149 <span class="comment">--*/</span>
00150 {
00151     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00152     PFX_SAVE_AREA NpxFrame;
00153     KIRQL                   Irql;
00154     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>                  ControlWord;
00155     ULONG                   MXCsr;
00156     PKPRCB                  Prcb;
00157     <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a8">PFLOAT_SAVE</a>             FloatSave;
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// If the system is using floating point emulation, then</span>
00161     <span class="comment">// return an error</span>
00162     <span class="comment">//</span>
00163 
00164     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
00165         <span class="keywordflow">return</span> STATUS_ILLEGAL_FLOAT_CONTEXT;
00166     }
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">// Get the current irql and thread</span>
00170     <span class="comment">//</span>
00171 
00172     FloatSave = (<a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a8">PFLOAT_SAVE</a>) PublicFloatSave;
00173 
00174     Irql = KeGetCurrentIrql();
00175     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00176 
00177     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o34">NpxIrql</a> &lt;= Irql);
00178 
00179     FloatSave-&gt;Flags           = 0;
00180     FloatSave-&gt;Irql            = Irql;
00181     FloatSave-&gt;PreviousNpxIrql = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o34">NpxIrql</a>;
00182     FloatSave-&gt;Thread          = Thread;
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">// If the irql has changed we need to save the complete floating</span>
00186     <span class="comment">// state context as the prior level has been interrupted.</span>
00187     <span class="comment">//</span>
00188 
00189     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o34">NpxIrql</a> != Irql) {
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// If this is apc level we don't have anyplace to hold this</span>
00193         <span class="comment">// context, allocate some heap.</span>
00194         <span class="comment">//</span>
00195 
00196         <span class="keywordflow">if</span> (Irql == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00197             FloatSave-&gt;u.Context = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00198                                         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00199                                         <span class="keyword">sizeof</span> (FX_SAVE_AREA),
00200                                         ' XPN'
00201                                         );
00202 
00203             <span class="keywordflow">if</span> (!FloatSave-&gt;u.Context) {
00204                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00205             }
00206 
00207             FloatSave-&gt;Flags |= <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a1">FLOAT_SAVE_FREE_CONTEXT_HEAP</a>;
00208 
00209         } <span class="keywordflow">else</span> {
00210 
00211             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Irql == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00212             FloatSave-&gt;u.Context = &amp;<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;NpxSaveArea;
00213 
00214         }
00215 
00216         FloatSave-&gt;Flags |= <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a0">FLOAT_SAVE_COMPLETE_CONTEXT</a>;
00217     }
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// Stop context switching and allow access to the local fp unit</span>
00221     <span class="comment">//</span>
00222 
00223     _asm {
00224         cli
00225         mov     eax, cr0
00226         mov     ecx, eax
00227         and     eax, not (CR0_MP|CR0_EM|CR0_TS)
00228         cmp     eax, ecx
00229         je      <span class="keywordtype">short</span> sav10
00230 
00231         mov     cr0, eax
00232 sav10:
00233     }
00234 
00235     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00236 
00237     <span class="comment">//</span>
00238     <span class="comment">// Get ownership of npx register set for this context</span>
00239     <span class="comment">//</span>
00240 
00241     <span class="keywordflow">if</span> (Prcb-&gt;NpxThread != Thread) {
00242 
00243         <span class="comment">//</span>
00244         <span class="comment">// If the other context is loaded in the npx registers, flush</span>
00245         <span class="comment">// it to that threads save area</span>
00246         <span class="comment">//</span>
00247         <span class="keywordflow">if</span> (Prcb-&gt;NpxThread) {
00248 
00249             NpxFrame = (PFX_SAVE_AREA)(((ULONG)(Prcb-&gt;NpxThread-&gt;InitialStack) -
00250                         <span class="keyword">sizeof</span>(FX_SAVE_AREA)));
00251 
00252             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) {
00253                 <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a9">Kix86FxSave</a>((PULONG)NpxFrame);
00254             } <span class="keywordflow">else</span> {
00255                 <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a10">Kix86FnSave</a>((PULONG)NpxFrame);
00256             }
00257 
00258             NpxFrame-&gt;NpxSavedCpu = 0;
00259             Prcb-&gt;NpxThread-&gt;NpxState = NPX_STATE_NOT_LOADED;
00260 
00261         }
00262 
00263         Prcb-&gt;NpxThread = Thread;
00264     }
00265 
00266     NpxFrame = (PFX_SAVE_AREA)(((ULONG)(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a>) -
00267                 <span class="keyword">sizeof</span>(FX_SAVE_AREA)));
00268 
00269 
00270     <span class="comment">//</span>
00271     <span class="comment">// Save the previous state as required</span>
00272     <span class="comment">//</span>
00273 
00274     <span class="keywordflow">if</span> (FloatSave-&gt;Flags &amp; <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a0">FLOAT_SAVE_COMPLETE_CONTEXT</a>) {
00275 
00276         <span class="comment">//</span>
00277         <span class="comment">// Need to save the entire context</span>
00278         <span class="comment">//</span>
00279 
00280         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o11">NpxState</a> == NPX_STATE_LOADED) {
00281             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) {
00282                 <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a9">Kix86FxSave</a> ((PULONG)(FloatSave-&gt;u.Context));
00283             } <span class="keywordflow">else</span> {
00284                 <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a10">Kix86FnSave</a> ((PULONG)(FloatSave-&gt;u.Context));
00285             }
00286 
00287             FloatSave-&gt;u.Context-&gt;NpxSavedCpu = 0;
00288             FloatSave-&gt;u.Context-&gt;Cr0NpxState = NpxFrame-&gt;Cr0NpxState;
00289 
00290         } <span class="keywordflow">else</span> {
00291             RtlCopyMemory (FloatSave-&gt;u.Context, NpxFrame, <span class="keyword">sizeof</span>(FX_SAVE_AREA));
00292             FloatSave-&gt;u.Context-&gt;NpxSavedCpu = 0;
00293 
00294         }
00295 
00296     } <span class="keywordflow">else</span> {
00297 
00298         <span class="comment">//</span>
00299         <span class="comment">// Save only the non-volatile state</span>
00300         <span class="comment">//</span>
00301 
00302         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o11">NpxState</a> == NPX_STATE_LOADED) {
00303 
00304             _asm {
00305                 mov     eax, FloatSave
00306                 fnstcw  [eax] <a class="code" href="../../d7/d9/structFLOAT__SAVE.html">FLOAT_SAVE</a>.u.Fcw.ControlWord
00307             }
00308 
00309             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) &amp;&amp; (<a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a>)) {
00310                 <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a12">Kix86StMXCsr</a>(&amp;FloatSave-&gt;u.Fcw.MXCsr);
00311             }
00312 
00313         } <span class="keywordflow">else</span> {
00314             <span class="comment">//</span>
00315             <span class="comment">// Save the control word from the npx frame.</span>
00316             <span class="comment">//</span>
00317 
00318             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) {
00319                 FloatSave-&gt;u.Fcw.ControlWord = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) NpxFrame-&gt;U.FxArea.ControlWord;
00320                 FloatSave-&gt;u.Fcw.MXCsr = NpxFrame-&gt;U.FxArea.MXCsr;
00321         
00322             } <span class="keywordflow">else</span> {
00323                 FloatSave-&gt;u.Fcw.ControlWord = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) NpxFrame-&gt;U.FnArea.ControlWord;
00324             }
00325         }
00326 
00327 
00328         <span class="comment">//</span>
00329         <span class="comment">// Save Cr0NpxState, but clear CR0_TS as there's not non-volatile</span>
00330         <span class="comment">// pending fp exceptions</span>
00331         <span class="comment">//</span>
00332 
00333         FloatSave-&gt;Cr0NpxState = NpxFrame-&gt;Cr0NpxState &amp; ~CR0_TS;
00334     }
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// The previous state is saved.  Set an initial default</span>
00338     <span class="comment">// FP state for the caller</span>
00339     <span class="comment">//</span>
00340 
00341     NpxFrame-&gt;Cr0NpxState = 0;
00342     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o11">NpxState</a> = NPX_STATE_LOADED;
00343     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o34">NpxIrql</a>  = Irql;
00344     ControlWord = 0x27f;    <span class="comment">// 64bit mode</span>
00345     MXCsr = 0x1f80;
00346 
00347     _asm {
00348         fninit
00349         fldcw       ControlWord
00350     }
00351 
00352     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) &amp;&amp; (<a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a>)) {
00353         <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a11">Kix86LdMXCsr</a>(&amp;MXCsr);
00354     }
00355 
00356     _asm {
00357         sti
00358     }
00359 
00360     FloatSave-&gt;Flags |= <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a2">FLOAT_SAVE_VALID</a>;
00361     <span class="keywordflow">return</span> STATUS_SUCCESS;
00362 }
00363 
00364 
00365 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00366"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a14">00366</a> <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a14">KeRestoreFloatingPointState</a> (
00367     IN PKFLOATING_SAVE      PublicFloatSave
00368     )
00369 <span class="comment">/*++</span>
00370 <span class="comment"></span>
00371 <span class="comment">Routine Description:</span>
00372 <span class="comment"></span>
00373 <span class="comment">    This routine retores the thread's current non-volatile NPX state,</span>
00374 <span class="comment">    to the passed in state.</span>
00375 <span class="comment"></span>
00376 <span class="comment">Arguments:</span>
00377 <span class="comment"></span>
00378 <span class="comment">    FloatSave - the non-volatile npx state for the thread to restore</span>
00379 <span class="comment"></span>
00380 <span class="comment">Return Value:</span>
00381 <span class="comment"></span>
00382 <span class="comment">--*/</span>
00383 {
00384     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00385     PFX_SAVE_AREA NpxFrame;
00386     ULONG                   Cr0State;
00387     <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a8">PFLOAT_SAVE</a>             FloatSave;
00388 
00389     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>);
00390 
00391     FloatSave = (<a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a8">PFLOAT_SAVE</a>) PublicFloatSave;
00392     Thread = FloatSave-&gt;Thread;
00393     
00394     NpxFrame = (PFX_SAVE_AREA)(((ULONG)(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a>) -
00395                 <span class="keyword">sizeof</span>(FX_SAVE_AREA)));
00396 
00397     
00398     <span class="comment">//</span>
00399     <span class="comment">// Verify float save looks like it's from the right context</span>
00400     <span class="comment">//</span>
00401 
00402     <span class="keywordflow">if</span> ((FloatSave-&gt;Flags &amp; (<a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a2">FLOAT_SAVE_VALID</a> | <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a3">FLOAT_SAVE_RESERVED</a>)) != <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a2">FLOAT_SAVE_VALID</a>) {
00403 
00404         <span class="comment">// BUGBUG: need to pick a good bugcheck code</span>
00405         <span class="comment">// KeBugCheck (...);</span>
00406         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeRestoreFloatingPointState: Invalid float save area\n"</span>);
00407         DbgBreakPoint();
00408     }
00409 
00410     <span class="keywordflow">if</span> (FloatSave-&gt;Irql != KeGetCurrentIrql()) {
00411         <span class="comment">// BUGBUG: need to pick a good bugcheck code</span>
00412         <span class="comment">// KeBugCheck (...);</span>
00413         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeRestoreFloatingPointState: Invalid IRQL\n"</span>);
00414         DbgBreakPoint();
00415     }
00416 
00417     <span class="keywordflow">if</span> (Thread != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()) {
00418         <span class="comment">// BUGBUG: need to pick a good bugcheck code</span>
00419         <span class="comment">// KeBugCheck (...);</span>
00420         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeRestoreFloatingPointState: Invalid thread\n"</span>);
00421         DbgBreakPoint();
00422     }
00423 
00424 
00425     <span class="comment">//</span>
00426     <span class="comment">// Synchronize with context switches and the npx trap handlers</span>
00427     <span class="comment">//</span>
00428 
00429     _asm {
00430         cli
00431     }
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Restore the required state</span>
00435     <span class="comment">//</span>
00436 
00437     <span class="keywordflow">if</span> (FloatSave-&gt;Flags &amp; <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a0">FLOAT_SAVE_COMPLETE_CONTEXT</a>) {
00438 
00439         <span class="comment">//</span>
00440         <span class="comment">// Restore the entire fp state to the threads save area</span>
00441         <span class="comment">//</span>
00442 
00443         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o11">NpxState</a> == NPX_STATE_LOADED) {
00444 
00445             <span class="comment">//</span>
00446             <span class="comment">// This state in the fp unit is no longer needed, just disregard it</span>
00447             <span class="comment">//</span>
00448 
00449             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o11">NpxState</a> = NPX_STATE_NOT_LOADED;
00450             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;NpxThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00451         }
00452 
00453         <span class="comment">//</span>
00454         <span class="comment">// Copy restored state to npx frame</span>
00455         <span class="comment">//</span>
00456 
00457         RtlCopyMemory (NpxFrame, FloatSave-&gt;u.Context, <span class="keyword">sizeof</span>(FX_SAVE_AREA));
00458 
00459     } <span class="keywordflow">else</span> {
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// Restore the non-volatile state</span>
00463         <span class="comment">//</span>
00464 
00465         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o11">NpxState</a> == NPX_STATE_LOADED) {
00466 
00467             <span class="comment">//</span>
00468             <span class="comment">// Init fp state and restore control word</span>
00469             <span class="comment">//</span>
00470 
00471             _asm {
00472                 fninit
00473                 mov     eax, FloatSave
00474                 fldcw   [eax] <a class="code" href="../../d7/d9/structFLOAT__SAVE.html">FLOAT_SAVE</a>.u.Fcw.ControlWord
00475             }
00476 
00477             
00478             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) &amp;&amp; (<a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a>)) {
00479                 <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a11">Kix86LdMXCsr</a>(&amp;FloatSave-&gt;u.Fcw.MXCsr);
00480             }
00481             
00482 
00483         } <span class="keywordflow">else</span> {
00484 
00485             <span class="comment">//</span>
00486             <span class="comment">// Fp state not loaded.  Restore control word in npx frame</span>
00487             <span class="comment">//</span>
00488 
00489             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) {
00490                 NpxFrame-&gt;U.FxArea.ControlWord = FloatSave-&gt;u.Fcw.ControlWord;
00491                 NpxFrame-&gt;U.FxArea.StatusWord = 0;
00492                 NpxFrame-&gt;U.FxArea.TagWord = 0;
00493                 NpxFrame-&gt;NpxSavedCpu = 0;
00494                 NpxFrame-&gt;U.FxArea.MXCsr = FloatSave-&gt;u.Fcw.MXCsr;
00495                  
00496             } <span class="keywordflow">else</span> {
00497                 NpxFrame-&gt;U.FnArea.ControlWord = FloatSave-&gt;u.Fcw.ControlWord;
00498                 NpxFrame-&gt;U.FnArea.StatusWord = 0;
00499                 NpxFrame-&gt;U.FnArea.TagWord = 0xffff;
00500             }
00501 
00502         }
00503 
00504         NpxFrame-&gt;Cr0NpxState = FloatSave-&gt;Cr0NpxState;
00505     }
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Restore NpxIrql and Cr0</span>
00509     <span class="comment">//</span>
00510 
00511     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o34">NpxIrql</a> = FloatSave-&gt;PreviousNpxIrql;
00512     Cr0State = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o11">NpxState</a> | NpxFrame-&gt;Cr0NpxState;
00513 
00514     _asm {
00515         mov     eax, cr0
00516         mov     ecx, eax
00517         and     eax, not (CR0_MP|CR0_EM|CR0_TS)
00518         or      eax, Cr0State
00519         cmp     eax, ecx
00520         je      <span class="keywordtype">short</span> res10
00521         mov     cr0, eax
00522 res10:
00523         sti
00524     }
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">// Done</span>
00528     <span class="comment">//</span>
00529 
00530     <span class="keywordflow">if</span> (FloatSave-&gt;Flags &amp; <a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a1">FLOAT_SAVE_FREE_CONTEXT_HEAP</a>) {
00531         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (FloatSave-&gt;u.Context);
00532     }
00533 
00534     FloatSave-&gt;Flags = 0;
00535     <span class="keywordflow">return</span> STATUS_SUCCESS;
00536 }
00537 
00538 <span class="preprocessor">#pragma optimize( "y", off )    // disable frame pointer omission (FPO)</span>
00539 <span class="preprocessor"></span>
00540 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00541 __cdecl
<a name="l00542"></a><a class="code" href="../../d2/d0/ke_2i386_2misc_8c.html#a15">00542</a> <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a7">KeSaveStateForHibernate</a>(
00543     IN PKPROCESSOR_STATE ProcessorState
00544     )
00545 <span class="comment">/*++</span>
00546 <span class="comment"></span>
00547 <span class="comment">Routine Description:</span>
00548 <span class="comment"></span>
00549 <span class="comment">    Saves all processor-specific state that must be preserved</span>
00550 <span class="comment">    across an S4 state (hibernation).</span>
00551 <span class="comment"></span>
00552 <span class="comment">    N.B. #pragma surrounding this function is required in order</span>
00553 <span class="comment">         to create the frame pointer than RtlCaptureContext relies</span>
00554 <span class="comment">         on.</span>
00555 <span class="comment">    N.B. _CRTAPI1 (__cdecl) decoration is also required so that</span>
00556 <span class="comment">         RtlCaptureContext can compute the correct ESP.</span>
00557 <span class="comment"></span>
00558 <span class="comment">Arguments:</span>
00559 <span class="comment"></span>
00560 <span class="comment">    ProcessorState - Supplies the KPROCESSOR_STATE where the</span>
00561 <span class="comment">        current CPU's state is to be saved.</span>
00562 <span class="comment"></span>
00563 <span class="comment">Return Value:</span>
00564 <span class="comment"></span>
00565 <span class="comment">    None.</span>
00566 <span class="comment"></span>
00567 <span class="comment">--*/</span>
00568 
00569 {
00570     RtlCaptureContext(&amp;ProcessorState-&gt;ContextFrame);
00571     <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(ProcessorState);
00572 }
00573 <span class="preprocessor">#pragma optimize( "y", off )    // disable frame pointer omission (FPO)</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
