<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpdd.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpdd.c</h1><a href="../../d2/d0/pnpdd_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment">All rights reserved</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    pnpdd.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module implements new Plug-And-Play driver entries and IRPs.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Shie-Lin Tzong (shielint) June-16-1995</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00027 <span class="preprocessor">#pragma hdrstop</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'ddpP')</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <span class="comment">//</span>
00035 <span class="comment">// Internal definitions and references</span>
00036 <span class="comment">//</span>
00037 
<a name="l00038"></a><a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">00038</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">_DEVICE_LIST_CONTEXT</a> {
<a name="l00039"></a><a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">00039</a>     ULONG <a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a>;
<a name="l00040"></a><a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o1">00040</a>     BOOLEAN <a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o1">Reallocation</a>;
<a name="l00041"></a><a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">00041</a>     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> <a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[1];
00042 } <a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">DEVICE_LIST_CONTEXT</a>, *<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">PDEVICE_LIST_CONTEXT</a>;
00043 
00044 BOOLEAN
00045 <a class="code" href="../../d2/d0/pnpdd_8c.html#a2">IopAddDevicesToBootDriverWorker</a>(
00046     IN HANDLE DeviceInstanceHandle,
00047     IN PUNICODE_STRING DeviceInstancePath,
00048     IN OUT PVOID Context
00049     );
00050 
00051 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00052 <a class="code" href="../../d2/d0/pnpdd_8c.html#a3">IopProcessAddDevicesWorker</a> (
00053    IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00054    IN PVOID Context
00055    );
00056 
00057 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00058 <a class="code" href="../../d2/d0/pnpdd_8c.html#a4">IopProcessAssignResourcesWorker</a> (
00059    IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00060    IN PVOID Context
00061    );
00062 
00063 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00064 <a class="code" href="../../d2/d0/pnpdd_8c.html#a5">IopPnPCompleteRequest</a>(
00065     IN OUT <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00066     IN NTSTATUS Status,
00067     IN ULONG_PTR Information
00068     );
00069 
00070 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00071 <a class="code" href="../../d2/d0/pnpdd_8c.html#a6">IopGetDriverDeviceList</a> (
00072    IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00073    OUT PDEVICE_LIST_CONTEXT *DeviceList
00074    );
00075 
00076 BOOLEAN
00077 <a class="code" href="../../d2/d0/pnpdd_8c.html#a7">IopGetDriverDeviceListWorker</a>(
00078     IN HANDLE DeviceInstanceHandle,
00079     IN PUNICODE_STRING DeviceInstancePath,
00080     IN OUT PVOID Context
00081     );
00082 
00083 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00084 <a class="code" href="../../d2/d0/pnpdd_8c.html#a22">IopAssignResourcesToDevices</a> (
00085     IN ULONG DeviceCount,
00086     IN <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> RequestTable,
00087     IN BOOLEAN BootConfigsOK
00088     );
00089 
00090 BOOLEAN
00091 <a class="code" href="../../d2/d0/pnpdd_8c.html#a9">IopIsFirmwareDisabled</a> (
00092     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00093     );
00094 
00095 
00096 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IopAddDevicesToBootDriver)</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IopAddDevicesToBootDriverWorker)</span>
00099 <span class="preprocessor"></span><span class="comment">//#pragma alloc_text(INIT, IopReportResourcesForAllChildren)</span>
00100 <span class="preprocessor">#pragma alloc_text(PAGE, IopReleaseDeviceResources)</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPnPAddDevice)</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPnPDispatch)</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IopProcessAddDevices)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IopProcessAddDevicesWorker)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopProcessAssignResources)</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopProcessAssignResourcesWorker)</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetDriverDeviceList)</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetDriverDeviceListWorker)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopNewDevice)</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopStartDriverDevices)</span>
00111 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAssignResourcesToDevices)</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopWriteAllocatedResourcesToRegistry)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsFirmwareDisabled)</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00115 <span class="preprocessor"></span>
00116 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00117"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a260">00117</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a260">IopAddDevicesToBootDriver</a> (
00118    IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
00119    )
00120 
00121 <span class="comment">/*++</span>
00122 <span class="comment"></span>
00123 <span class="comment">Routine Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    This functions is used by Pnp manager to inform a boot device driver of</span>
00126 <span class="comment">    all the devices it can possibly control.  This routine is for boot</span>
00127 <span class="comment">    drivers only.</span>
00128 <span class="comment"></span>
00129 <span class="comment">Parameters:</span>
00130 <span class="comment"></span>
00131 <span class="comment">    DriverObject - Supplies a driver object to receive its boot devices.</span>
00132 <span class="comment"></span>
00133 <span class="comment">Return Value:</span>
00134 <span class="comment"></span>
00135 <span class="comment">    NTSTATUS code.</span>
00136 <span class="comment"></span>
00137 <span class="comment">--*/</span>
00138 {
00139     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00140 
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// For each device instance in the driver's service/enum key, we will</span>
00144     <span class="comment">// invoke the driver's AddDevice routine and perform enumeration on</span>
00145     <span class="comment">// the device.</span>
00146     <span class="comment">// Note, we don't acquire registry lock before calling IopApplyFunction</span>
00147     <span class="comment">// routine.  We know this code is for boot driver initialization.  No</span>
00148     <span class="comment">// one else would access the registry Enum key at this time and most</span>
00149     <span class="comment">// important we need the registry lock in other down level routines.</span>
00150     <span class="comment">//</span>
00151 
00152     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a14">IopApplyFunctionToServiceInstances</a>(
00153                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00154                                 &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName,
00155                                 KEY_ALL_ACCESS,
00156                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00157                                 <a class="code" href="../../d2/d0/pnpdd_8c.html#a2">IopAddDevicesToBootDriverWorker</a>,
00158                                 DriverObject,
00159                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00160                                 );
00161 
00162     <span class="keywordflow">return</span> status;
00163 }
00164 
00165 BOOLEAN
<a name="l00166"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a2">00166</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a2">IopAddDevicesToBootDriverWorker</a>(
00167     IN HANDLE DeviceInstanceHandle,
00168     IN PUNICODE_STRING DeviceInstancePath,
00169     IN OUT PVOID Context
00170     )
00171 
00172 <span class="comment">/*++</span>
00173 <span class="comment"></span>
00174 <span class="comment">Routine Description:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    This routine is a callback function for IopApplyFunctionToServiceInstances.</span>
00177 <span class="comment">    It is called for each device instance key referenced by a service instance</span>
00178 <span class="comment">    value under the specified service's volatile Enum subkey. The purpose of this</span>
00179 <span class="comment">    routine is to invoke the AddDevice() entry of a boot driver with the device</span>
00180 <span class="comment">    object.</span>
00181 <span class="comment"></span>
00182 <span class="comment">    Note this routine is also used for the devices controlled by a legacy driver.</span>
00183 <span class="comment">    If the specified device instance is controlled by a legacy driver this routine</span>
00184 <span class="comment">    sets the device node flags.</span>
00185 <span class="comment"></span>
00186 <span class="comment">Arguments:</span>
00187 <span class="comment"></span>
00188 <span class="comment">    DeviceInstanceHandle - Supplies a handle to the registry path (relative to</span>
00189 <span class="comment">        HKLM\CCS\System\Enum) to this device instance.</span>
00190 <span class="comment"></span>
00191 <span class="comment">    DeviceInstancePath - Supplies the registry path (relative to HKLM\CCS\System\Enum)</span>
00192 <span class="comment">        to this device instance.</span>
00193 <span class="comment"></span>
00194 <span class="comment">    Context - Supplies a pointer to a DRIVER_OBJECT structure.</span>
00195 <span class="comment"></span>
00196 <span class="comment">Return Value:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    TRUE to continue the enumeration.</span>
00199 <span class="comment">    FALSE to abort it.</span>
00200 <span class="comment"></span>
00201 <span class="comment">--*/</span>
00202 
00203 {
00204     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00205 <span class="comment">//  PDRIVER_OBJECT driverObject = (PDRIVER_OBJECT)Context;</span>
00206     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDevice;
00207     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00208     ULONG length;
00209     BOOLEAN conflict;
00210     PCM_RESOURCE_LIST cmResource;
00211 
00212     <a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">ADD_CONTEXT</a> addContext;
00213 
00214 
00215     <span class="comment">//</span>
00216     <span class="comment">// Reference the physical device object associated with the device instance.</span>
00217     <span class="comment">//</span>
00218 
00219     physicalDevice = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(DeviceInstanceHandle,
00220                                                        DeviceInstancePath);
00221     <span class="keywordflow">if</span> (!physicalDevice) {
00222         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00223     }
00224 
00225     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00226     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> == physicalDevice));
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// If the device has been added (or failed) skip it.</span>
00230     <span class="comment">//</span>
00231 
00232     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a42">OK_TO_ADD_DEVICE</a>(deviceNode)) {
00233         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00234     }
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// If we know the device is a duplicate of another device which</span>
00238     <span class="comment">// has been enumerated at this point. we will skip this device.</span>
00239     <span class="comment">//</span>
00240 
00241     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a6">DNF_DUPLICATE</a>) &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a>)) {
00242         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00243     }
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Invoke driver's AddDevice Entry for the device.</span>
00247     <span class="comment">// Since the driver has already been loaded, we generate a fake</span>
00248     <span class="comment">// context to make sure that group order won't get in the way of</span>
00249     <span class="comment">// adding the drivers.</span>
00250 
00251     addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = 0xffff;
00252     addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = 0;
00253     addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_BOOT_START;
00254 
00255     <a class="code" href="../../d9/d0/pnpiop_8h.html#a286">IopCallDriverAddDevice</a>(deviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;addContext);
00256 
00257 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00258     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDevice);
00259     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00260 }
00261 
00262 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00263"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a279">00263</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a> (
00264     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00265     IN BOOLEAN ReserveResources
00266     )
00267 
00268 <span class="comment">/*++</span>
00269 <span class="comment"></span>
00270 <span class="comment">Routine Description:</span>
00271 <span class="comment"></span>
00272 <span class="comment">    This routine releases the resources assigned to a device.</span>
00273 <span class="comment"></span>
00274 <span class="comment">Arguments:</span>
00275 <span class="comment"></span>
00276 <span class="comment">    DeviceObject - supplies a pointer to a device whose resources are to be released.</span>
00277 <span class="comment"></span>
00278 <span class="comment">    ReserveResources - indicates whether we need to re-query and reserve BOOT config for DeviceObject.</span>
00279 <span class="comment"></span>
00280 <span class="comment">Return Value:</span>
00281 <span class="comment"></span>
00282 <span class="comment">    NTSTATUS code.</span>
00283 <span class="comment"></span>
00284 <span class="comment"></span>
00285 <span class="comment">--*/</span>
00286 {
00287     BOOLEAN             conflict;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status= STATUS_SUCCESS;
00289     PCM_RESOURCE_LIST   cmResource;
00290     ULONG               cmLength;
00291 
00292     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00293 
00294     <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceList || (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>)) {
00295 
00296         cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00297         cmLength = 0;
00298 
00299         <span class="comment">//</span>
00300         <span class="comment">// If needed, re-query for BOOT configs. We need to do this BEFORE we</span>
00301         <span class="comment">// release the BOOT config (otherwise ROOT devices cannot report BOOT</span>
00302         <span class="comment">// config).</span>
00303         <span class="comment">//</span>
00304 
00305         <span class="keywordflow">if</span> (ReserveResources &amp;&amp; !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
00306 
00307             <span class="comment">//</span>
00308             <span class="comment">// First query for new BOOT config (order important for ROOT devices).</span>
00309             <span class="comment">//</span>
00310 
00311             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a27">IopQueryDeviceResources</a> (  DeviceNode-&gt;PhysicalDeviceObject,
00312                                                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>,
00313                                                 &amp;cmResource,
00314                                                 &amp;cmLength);
00315 
00316             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00317 
00318                 cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00319                 cmLength = 0;
00320 
00321             }
00322         }
00323 
00324         <span class="comment">//</span>
00325         <span class="comment">// Release resources for this device.</span>
00326         <span class="comment">//</span>
00327 
00328         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a107">IopLegacyResourceAllocation</a>(   <a class="code" href="../../d6/d9/pnp_8h.html#a174a125">ArbiterRequestUndefined</a>,
00329                                                 <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>,
00330                                                 DeviceNode-&gt;PhysicalDeviceObject,
00331                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00332                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00333         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00334 
00335             <a class="code" href="../../d1/d0/pnpdata_8c.html#a19">IopResourcesReleased</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;        <span class="comment">// Signal there are resources available.</span>
00336 
00337             <span class="comment">//</span>
00338             <span class="comment">// If needed, re-query and reserve current BOOT config for this device.</span>
00339             <span class="comment">// We always rereserve the boot config (ie DNF_MADEUP root enumerated</span>
00340             <span class="comment">// and IoReportDetected) devices in IopLegacyResourceAllocation.</span>
00341             <span class="comment">//</span>
00342 
00343             <span class="keywordflow">if</span> (ReserveResources &amp;&amp; !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
00344 
00345                 UNICODE_STRING      unicodeName;
00346                 HANDLE              logConfHandle;
00347                 HANDLE              handle;
00348 
00349                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;BootResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00350 
00351                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceNode-&gt;PhysicalDeviceObject, &amp;handle, KEY_ALL_ACCESS);
00352                 logConfHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00353                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00354 
00355 
00356                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
00357                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
00358                                                      handle,
00359                                                      &amp;unicodeName,
00360                                                      KEY_ALL_ACCESS,
00361                                                      REG_OPTION_NON_VOLATILE,
00362                                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00363                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00364 
00365                         logConfHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00366 
00367                     }
00368                 }
00369 
00370                 <span class="keywordflow">if</span> (logConfHandle) {
00371 
00372                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_BOOTCONFIG);
00373                     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00374                     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00375                     <span class="keywordflow">if</span> (cmResource) {
00376 
00377                         ZwSetValueKey(  logConfHandle,
00378                                         &amp;unicodeName,
00379                                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00380                                         REG_RESOURCE_LIST,
00381                                         cmResource,
00382                                         cmLength);
00383                     } <span class="keywordflow">else</span> {
00384 
00385                         ZwDeleteValueKey(logConfHandle, &amp;unicodeName);
00386 
00387                     }
00388                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00389                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00390 
00391                     ZwClose(logConfHandle);
00392                 }
00393 
00394                 <span class="comment">//</span>
00395                 <span class="comment">// Reserve any remaining BOOT config.</span>
00396                 <span class="comment">//</span>
00397 
00398                 <span class="keywordflow">if</span> (cmResource) {
00399 
00400                     DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
00401                     DeviceNode-&gt;BootResources = cmResource;
00402 
00403                     <span class="comment">//</span>
00404                     <span class="comment">// This device consumes BOOT resources.  Reserve its boot resources</span>
00405                     <span class="comment">//</span>
00406 
00407                     (*IopReserveResourcesRoutine)(  <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
00408                                                     DeviceNode-&gt;PhysicalDeviceObject,
00409                                                     cmResource);
00410                 }
00411             }
00412         }
00413     }
00414 
00415     <span class="keywordflow">return</span> status;
00416 }
00417 
00418 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00419"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a280">00419</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a280">IopPnPAddDevice</a>(
00420     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00421     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00422     )
00423 
00424 <span class="comment">/*++</span>
00425 <span class="comment"></span>
00426 <span class="comment">Routine Description:</span>
00427 <span class="comment"></span>
00428 <span class="comment">    This routine handles AddDevice for an madeup PDO device.</span>
00429 <span class="comment"></span>
00430 <span class="comment">Arguments:</span>
00431 <span class="comment"></span>
00432 <span class="comment">    DriverObject - Pointer to our pseudo driver object.</span>
00433 <span class="comment"></span>
00434 <span class="comment">    DeviceObject - Pointer to the device object for which this requestapplies.</span>
00435 <span class="comment"></span>
00436 <span class="comment">Return Value:</span>
00437 <span class="comment"></span>
00438 <span class="comment">    NT status.</span>
00439 <span class="comment"></span>
00440 <span class="comment">--*/</span>
00441 {
00442     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00443 
00444 <span class="preprocessor">#if DBG</span>
00445 <span class="preprocessor"></span>
00446     <span class="comment">//</span>
00447     <span class="comment">// We should never get an AddDevice request.</span>
00448     <span class="comment">//</span>
00449 
00450     DbgBreakPoint();
00451 
00452 <span class="preprocessor">#endif</span>
00453 <span class="preprocessor"></span>
00454     <span class="keywordflow">return</span> STATUS_SUCCESS;
00455 }
00456 <span class="comment">//  PNPRES test</span>
00457 
00458 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00459"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a13">00459</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a13">IopArbiterHandlerxx</a> (
00460     IN PVOID Context,
00461     IN ARBITER_ACTION Action,
00462     IN OUT <a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html">PARBITER_PARAMETERS</a> Parameters
00463     )
00464 {
00465     PLIST_ENTRY listHead, listEntry;
00466     PIO_RESOURCE_DESCRIPTOR ioDesc;
00467     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDesc;
00468     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> arbiterListEntry;
00469 
00470     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a173a122">ArbiterActionQueryArbitrate</a>) {
00471         <span class="keywordflow">return</span> STATUS_SUCCESS;
00472     }
00473     <span class="keywordflow">if</span> (Parameters == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00474         <span class="keywordflow">return</span> STATUS_SUCCESS;
00475     }
00476     listHead = Parameters-&gt;Parameters.TestAllocation.ArbitrationList;
00477     <span class="keywordflow">if</span> (IsListEmpty(listHead)) {
00478         <span class="keywordflow">return</span> STATUS_SUCCESS;
00479     }
00480     listEntry = listHead-&gt;Flink;
00481     <span class="keywordflow">while</span> (listEntry != listHead) {
00482       arbiterListEntry = (<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a>)listEntry;
00483       cmDesc = arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a>;
00484       ioDesc = arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a>;
00485       <span class="keywordflow">if</span> (cmDesc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ioDesc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00486           <span class="keywordflow">return</span> STATUS_SUCCESS;
00487       }
00488       cmDesc-&gt;Type = ioDesc-&gt;Type;
00489       cmDesc-&gt;ShareDisposition = ioDesc-&gt;ShareDisposition;
00490       cmDesc-&gt;Flags = ioDesc-&gt;Flags;
00491       <span class="keywordflow">if</span> (ioDesc-&gt;Type == CmResourceTypePort) {
00492           cmDesc-&gt;u.Port.Start = ioDesc-&gt;u.Port.MinimumAddress;
00493           cmDesc-&gt;u.Port.Length = ioDesc-&gt;u.Port.Length;
00494       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioDesc-&gt;Type == CmResourceTypeInterrupt) {
00495           cmDesc-&gt;u.Interrupt.Level = ioDesc-&gt;u.Interrupt.MinimumVector;
00496           cmDesc-&gt;u.Interrupt.Vector = ioDesc-&gt;u.Interrupt.MinimumVector;
00497           cmDesc-&gt;u.Interrupt.Affinity = (ULONG) -1;
00498       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioDesc-&gt;Type == CmResourceTypeMemory) {
00499           cmDesc-&gt;u.Memory.Start = ioDesc-&gt;u.Memory.MinimumAddress;
00500           cmDesc-&gt;u.Memory.Length = ioDesc-&gt;u.Memory.Length;
00501       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioDesc-&gt;Type == CmResourceTypeDma) {
00502           cmDesc-&gt;u.Dma.Channel = ioDesc-&gt;u.Dma.MinimumChannel;
00503           cmDesc-&gt;u.Dma.Port = 0;
00504           cmDesc-&gt;u.Dma.Reserved1 = 0;
00505       }
00506       listEntry = listEntry-&gt;Flink;
00507     }
00508     <span class="keywordflow">return</span> STATUS_SUCCESS;
00509 }
00510 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00511"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a14">00511</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a14">IopTranslatorHandlerCm</a> (
00512     IN PVOID Context,
00513     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Source,
00514     IN RESOURCE_TRANSLATION_DIRECTION Direction,
00515     IN ULONG AlternativesCount, OPTIONAL
00516     IN IO_RESOURCE_DESCRIPTOR Alternatives[], OPTIONAL
00517     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00518     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Target
00519     )
00520 {
00521     *Target = *Source;
00522 <span class="preprocessor">#if 0</span>
00523 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Direction == <a class="code" href="../../d6/d9/pnp_8h.html#a176a135">TranslateChildToParent</a>) {
00524         <span class="keywordflow">if</span> (Target-&gt;Type == CmResourceTypePort) {
00525             Target-&gt;u.Port.Start.LowPart += 0x10000;
00526         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Target-&gt;Type == CmResourceTypeMemory) {
00527             Target-&gt;u.Memory.Start.LowPart += 0x100000;
00528         }
00529     } <span class="keywordflow">else</span> {
00530         <span class="keywordflow">if</span> (Target-&gt;Type == CmResourceTypePort) {
00531             Target-&gt;u.Port.Start.LowPart -= 0x10000;
00532         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Target-&gt;Type == CmResourceTypeMemory) {
00533             Target-&gt;u.Memory.Start.LowPart -= 0x100000;
00534         }
00535     }
00536 <span class="preprocessor">#endif</span>
00537 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00538 }
00539 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00540"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a15">00540</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a15">IopTranslatorHandlerIo</a> (
00541     IN PVOID Context,
00542     IN PIO_RESOURCE_DESCRIPTOR Source,
00543     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00544     OUT PULONG TargetCount,
00545     OUT PIO_RESOURCE_DESCRIPTOR *Target
00546     )
00547 {
00548     PIO_RESOURCE_DESCRIPTOR newDesc;
00549 
00550     newDesc = (PIO_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR));
00551     <span class="keywordflow">if</span> (newDesc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00552         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00553     }
00554     *TargetCount = 1;
00555     *newDesc = *Source;
00556 <span class="preprocessor">#if 0</span>
00557 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (newDesc-&gt;Type == CmResourceTypePort) {
00558         newDesc-&gt;u.Port.MinimumAddress.LowPart += 0x10000;
00559         newDesc-&gt;u.Port.MaximumAddress.LowPart += 0x10000;
00560     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (newDesc-&gt;Type == CmResourceTypeMemory) {
00561         newDesc-&gt;u.Memory.MinimumAddress.LowPart += 0x100000;
00562         newDesc-&gt;u.Memory.MaximumAddress.LowPart += 0x100000;
00563     }
00564 <span class="preprocessor">#endif</span>
00565 <span class="preprocessor"></span>    *Target = newDesc;
00566     <span class="keywordflow">return</span> STATUS_SUCCESS;
00567 }
00568 
00569 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00570"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a283">00570</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a283">IopPowerDispatch</a>(
00571     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00572     IN OUT <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00573     )
00574 {
00575     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>      IrpSp;
00576     <a class="code" href="../../d4/d9/struct__POWER__SEQUENCE.html">PPOWER_SEQUENCE</a>         PowerSequence;
00577     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00578 
00579 
00580     UNREFERENCED_PARAMETER( DeviceObject );
00581 
00582     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>);
00583     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00584 
00585     <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
00586         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a89">IRP_MN_WAIT_WAKE</a>:
00587             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00588             <span class="keywordflow">break</span>;
00589 
00590         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a90">IRP_MN_POWER_SEQUENCE</a>:
00591             PowerSequence = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.PowerSequence.PowerSequence;
00592             PowerSequence-&gt;<a class="code" href="../../d4/d9/struct__POWER__SEQUENCE.html#o0">SequenceD1</a> = <a class="code" href="../../d1/d2/po_8h.html#a52">PoPowerSequence</a>;
00593             PowerSequence-&gt;<a class="code" href="../../d4/d9/struct__POWER__SEQUENCE.html#o1">SequenceD2</a> = <a class="code" href="../../d1/d2/po_8h.html#a52">PoPowerSequence</a>;
00594             PowerSequence-&gt;<a class="code" href="../../d4/d9/struct__POWER__SEQUENCE.html#o2">SequenceD3</a> = <a class="code" href="../../d1/d2/po_8h.html#a52">PoPowerSequence</a>;
00595             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00596             <span class="keywordflow">break</span>;
00597 
00598         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a92">IRP_MN_QUERY_POWER</a>:
00599             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00600             <span class="keywordflow">break</span>;
00601 
00602         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a91">IRP_MN_SET_POWER</a>:
00603             <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Power.Type) {
00604                 <span class="keywordflow">case</span> SystemPowerState:
00605                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00606                     <span class="keywordflow">break</span>;
00607 
00608                 <span class="keywordflow">case</span> DevicePowerState:
00609                     <span class="comment">//</span>
00610                     <span class="comment">// To be here the FDO must have passed the IRP on.</span>
00611                     <span class="comment">// We do not know how to turn the device off, but the</span>
00612                     <span class="comment">// FDO is prepaired for it work</span>
00613                     <span class="comment">//</span>
00614 
00615                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00616                     <span class="keywordflow">break</span>;
00617 
00618                 <span class="keywordflow">default</span>:
00619                     <span class="comment">// Unkown power type</span>
00620                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00621                     <span class="keywordflow">break</span>;
00622             }
00623             <span class="keywordflow">break</span>;
00624 
00625         <span class="keywordflow">default</span>:
00626             <span class="comment">// Unkown power minor code</span>
00627             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00628             <span class="keywordflow">break</span>;
00629     }
00630 
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">// For lagecy devices that do not have drivers loaded, complete</span>
00634     <span class="comment">// power irps with success.</span>
00635     <span class="comment">//</span>
00636 
00637     <a class="code" href="../../d1/d2/po_8h.html#a79">PoStartNextPowerIrp</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>);
00638     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_NOT_SUPPORTED) {
00639        <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00640     } <span class="keywordflow">else</span> {
00641        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00642     }
00643     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a> );
00644     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00645 }
00646 
00647 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00648"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a282">00648</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a282">IopPnPDispatch</a>(
00649     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00650     IN OUT <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00651     )
00652 
00653 <span class="comment">/*++</span>
00654 <span class="comment"></span>
00655 <span class="comment">Routine Description:</span>
00656 <span class="comment"></span>
00657 <span class="comment">    This routine handles all IRP_MJ_PNP IRPs for madeup PDO device.</span>
00658 <span class="comment"></span>
00659 <span class="comment">Arguments:</span>
00660 <span class="comment"></span>
00661 <span class="comment">    DeviceObject - Pointer to the device object for which this IRP applies.</span>
00662 <span class="comment"></span>
00663 <span class="comment">    Irp - Pointer to the IRP_MJ_PNP IRP to dispatch.</span>
00664 <span class="comment"></span>
00665 <span class="comment">Return Value:</span>
00666 <span class="comment"></span>
00667 <span class="comment">    NT status.</span>
00668 <span class="comment"></span>
00669 <span class="comment">--*/</span>
00670 {
00671     <a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">PIOPNP_DEVICE_EXTENSION</a> deviceExtension = DeviceObject-&gt;DeviceExtension;
00672     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00674     PVOID information = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00675     ULONG length;
00676     PWCHAR <span class="keywordtype">id</span>, wp;
00677     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00678     <a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">PARBITER_INTERFACE</a> arbiterInterface;  <span class="comment">// PNPRES test</span>
00679     <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> translatorInterface;  <span class="comment">// PNPRES test</span>
00680 
00681     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00682 
00683     <span class="comment">//</span>
00684     <span class="comment">// Get a pointer to our stack location and take appropriate action based</span>
00685     <span class="comment">// on the minor function.</span>
00686     <span class="comment">//</span>
00687 
00688     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>);
00689     <span class="keywordflow">switch</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>){
00690 
00691     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>:
00692     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>:
00693 
00694         <span class="comment">//</span>
00695         <span class="comment">// If we get a start device request for a PDO, we simply</span>
00696         <span class="comment">// return success.</span>
00697         <span class="comment">//</span>
00698 
00699         status = STATUS_SUCCESS;
00700         <span class="keywordflow">break</span>;
00701 
00702     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>:
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// As we fail all STOP's, this cancel is always successful, and we have</span>
00706         <span class="comment">// no work to do.</span>
00707         <span class="comment">//</span>
00708         status = STATUS_SUCCESS;
00709         <span class="keywordflow">break</span>;
00710 
00711     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a70">IRP_MN_QUERY_STOP_DEVICE</a>:
00712     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a69">IRP_MN_STOP_DEVICE</a>:
00713 
00714         <span class="comment">//</span>
00715         <span class="comment">// We can not success the query stop.  We don't handle it.  because</span>
00716         <span class="comment">// we don't know how to stop a root enumerated device.</span>
00717         <span class="comment">//</span>
00718         status = STATUS_UNSUCCESSFUL ;
00719         <span class="keywordflow">break</span>;
00720 
00721     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a75">IRP_MN_QUERY_RESOURCES</a>:
00722 
00723         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
00724                          DeviceObject,
00725                          <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>,
00726                          <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>,
00727                          &amp;information,
00728                          &amp;length);
00729         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
00730             status = STATUS_SUCCESS;
00731             information = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00732         }
00733         <span class="keywordflow">break</span>;
00734 
00735     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>:
00736 
00737         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a>(
00738                          DeviceObject,
00739                          <a class="code" href="../../d9/d0/pnpiop_8h.html#a61">QUERY_RESOURCE_REQUIREMENTS</a>,
00740                          <a class="code" href="../../d9/d0/pnpiop_8h.html#a66">REGISTRY_BASIC_CONFIGVECTOR</a>,
00741                          &amp;information,
00742                          &amp;length);
00743         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
00744             status = STATUS_SUCCESS;
00745             information = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00746         }
00747         <span class="keywordflow">break</span>;
00748 
00749     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>:
00750     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>:
00751     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>:
00752 
00753         <span class="comment">//</span>
00754         <span class="comment">// For root enumerated devices we let the device objects stays.</span>
00755         <span class="comment">// So, they will be marked as deleted but still show up in the tree.</span>
00756         <span class="comment">//</span>
00757 
00758         <span class="comment">//IoDeleteDevice(DeviceObject);</span>
00759         status = STATUS_SUCCESS;
00760         <span class="keywordflow">break</span>;
00761 
00762     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>:
00763 
00764         <span class="keywordflow">if</span> (DeviceObject == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> &amp;&amp;
00765             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type == <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>) {
00766             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a311">IopGetRootDevices</a>((<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *)&amp;information);
00767         } <span class="keywordflow">else</span> {
00768             <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type == <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>) {
00769                 <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
00770 
00771                 deviceRelations = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">DEVICE_RELATIONS</a>));
00772                 <span class="keywordflow">if</span> (deviceRelations == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00773                     status = STATUS_INSUFFICIENT_RESOURCES;
00774                 } <span class="keywordflow">else</span> {
00775                     deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a> = 1;
00776                     deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[0] = DeviceObject;
00777                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
00778                     information = (PVOID)deviceRelations;
00779                     status = STATUS_SUCCESS;
00780                 }
00781             } <span class="keywordflow">else</span> {
00782                 information = (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
00783                 status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00784             }
00785         }
00786         <span class="keywordflow">break</span>;
00787 
00788     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>:
00789         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00790         <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00791             <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>((PVOID)irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType, (PVOID)&amp;GUID_ARBITER_INTERFACE_STANDARD)) {
00792                 status = STATUS_SUCCESS;
00793                 arbiterInterface = (<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">PARBITER_INTERFACE</a>) irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface;
00794                 arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a> = <a class="code" href="../../d8/d8/arbiter_8c.html#a31">ArbArbiterHandler</a>;
00795                 <span class="keywordflow">switch</span> ((UCHAR)((ULONG_PTR)irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceSpecificData)) {
00796                 <span class="keywordflow">case</span> CmResourceTypePort:
00797                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>;
00798                     <span class="keywordflow">break</span>;
00799                 <span class="keywordflow">case</span> CmResourceTypeMemory:
00800                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>;
00801                     <span class="keywordflow">break</span>;
00802                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00803                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a33">IopRootIrqArbiter</a>;
00804                     <span class="keywordflow">break</span>;
00805                 <span class="keywordflow">case</span> CmResourceTypeDma:
00806                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a32">IopRootDmaArbiter</a>;
00807                     <span class="keywordflow">break</span>;
00808                 <span class="keywordflow">case</span> CmResourceTypeBusNumber:
00809                     arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a> = (PVOID) &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a34">IopRootBusNumberArbiter</a>;
00810                     <span class="keywordflow">break</span>;
00811                 <span class="keywordflow">default</span>:
00812                     status = STATUS_INVALID_PARAMETER;
00813                     <span class="keywordflow">break</span>;
00814                 }
00815             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>((PVOID)irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType, (PVOID)&amp;GUID_TRANSLATOR_INTERFACE_STANDARD)) {
00816                 translatorInterface = (<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a>) irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface;
00817                 translatorInterface-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o5">TranslateResources</a> = <a class="code" href="../../d2/d0/pnpdd_8c.html#a14">IopTranslatorHandlerCm</a>;
00818                 translatorInterface-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o6">TranslateResourceRequirements</a> = <a class="code" href="../../d2/d0/pnpdd_8c.html#a15">IopTranslatorHandlerIo</a>;
00819                 status = STATUS_SUCCESS;
00820             }
00821             <span class="keywordflow">break</span>;
00822         }
00823 
00824         status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00825         <span class="keywordflow">break</span>;
00826 
00827     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a74">IRP_MN_QUERY_CAPABILITIES</a>:
00828 
00829         {
00830             ULONG i;
00831             PDEVICE_POWER_STATE state;
00832             <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> deviceCapabilities;
00833 
00834             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00835 
00836             deviceCapabilities = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceCapabilities.Capabilities;
00837             deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o0">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>);
00838             deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o1">Version</a> = 1;
00839 
00840             deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o23">DeviceState</a>[PowerSystemUnspecified]=PowerDeviceUnspecified;
00841             deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o23">DeviceState</a>[PowerSystemWorking]=PowerDeviceD0;
00842 
00843             state = &amp;deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o23">DeviceState</a>[PowerSystemSleeping1];
00844 
00845             <span class="keywordflow">for</span> (i = PowerSystemSleeping1; i &lt; PowerSystemMaximum; i++) {
00846 
00847                 <span class="comment">//</span>
00848                 <span class="comment">// Only supported state, currently, is off.</span>
00849                 <span class="comment">//</span>
00850 
00851                 *state++ = PowerDeviceD3;
00852             }
00853 
00854 
00855             <span class="keywordflow">if</span>(<a class="code" href="../../d2/d0/pnpdd_8c.html#a9">IopIsFirmwareDisabled</a>(deviceNode)) {
00856                 <span class="comment">//</span>
00857                 <span class="comment">// this device has been disabled by BIOS</span>
00858                 <span class="comment">//</span>
00859                 deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o16">HardwareDisabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00860             }
00861 
00862             status = STATUS_SUCCESS;
00863         }
00864         <span class="keywordflow">break</span>;
00865 
00866     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>:
00867         <span class="keywordflow">if</span> (DeviceObject != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> &amp;&amp;
00868             (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status) || !<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information)) {
00869 
00870             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00871             <span class="keywordflow">switch</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType) {
00872 
00873             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>:
00874             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>:
00875 
00876                 <span class="keywordtype">id</span> = (PWCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length);
00877                 <span class="keywordflow">if</span> (<span class="keywordtype">id</span>) {
00878                     ULONG separatorCount = 0;
00879 
00880                     RtlZeroMemory(<span class="keywordtype">id</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length);
00881                     information = <span class="keywordtype">id</span>;
00882                     status = STATUS_SUCCESS;
00883                     wp = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer;
00884                     <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType == <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>) {
00885                         <span class="keywordflow">while</span>(*wp) {
00886                             <span class="keywordflow">if</span> (*wp == OBJ_NAME_PATH_SEPARATOR) {
00887                                 separatorCount++;
00888                                 <span class="keywordflow">if</span> (separatorCount == 2) {
00889                                     <span class="keywordflow">break</span>;
00890                                 }
00891                             }
00892                             *<span class="keywordtype">id</span> = *wp;
00893                             <span class="keywordtype">id</span>++;
00894                             wp++;
00895                         }
00896                     } <span class="keywordflow">else</span> {
00897                         <span class="keywordflow">while</span>(*wp) {
00898                             <span class="keywordflow">if</span> (*wp == OBJ_NAME_PATH_SEPARATOR) {
00899                                 separatorCount++;
00900                                 <span class="keywordflow">if</span> (separatorCount == 2) {
00901                                     wp++;
00902                                     <span class="keywordflow">break</span>;
00903                                 }
00904                             }
00905                             wp++;
00906                         }
00907                         <span class="keywordflow">while</span> (*wp) {
00908                             *<span class="keywordtype">id</span> = *wp;
00909                             <span class="keywordtype">id</span>++;
00910                             wp++;
00911                         }
00912                     }
00913                 } <span class="keywordflow">else</span> {
00914                     status = STATUS_INSUFFICIENT_RESOURCES;
00915                 }
00916                 <span class="keywordflow">break</span>;
00917 
00918             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>:
00919 
00920                 <span class="keywordflow">if</span>((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status != STATUS_NOT_SUPPORTED) ||
00921                    (deviceExtension == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))  {
00922 
00923                     <span class="comment">//</span>
00924                     <span class="comment">// Upper driver has given some sort of reply or this device</span>
00925                     <span class="comment">// object wasn't allocated to handle these requests.</span>
00926                     <span class="comment">//</span>
00927 
00928                     status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00929                     <span class="keywordflow">break</span>;
00930                 }
00931 
00932                 <span class="keywordflow">if</span>(deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o1">CompatibleIdListSize</a> != 0) {
00933 
00934                     <span class="keywordtype">id</span> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00935                                         deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o1">CompatibleIdListSize</a>);
00936 
00937                     <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938                         status = STATUS_INSUFFICIENT_RESOURCES;
00939                         <span class="keywordflow">break</span>;
00940                     }
00941 
00942                     RtlCopyMemory(<span class="keywordtype">id</span>,
00943                                   deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o0">CompatibleIdList</a>,
00944                                   deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o1">CompatibleIdListSize</a>);
00945 
00946                     information = <span class="keywordtype">id</span>;
00947                     status = STATUS_SUCCESS;
00948                     <span class="keywordflow">break</span>;
00949                 }
00950 
00951             <span class="keywordflow">default</span>:
00952 
00953                 information = (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
00954                 status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00955             }
00956         } <span class="keywordflow">else</span> {
00957             information = (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
00958             status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00959         }
00960 
00961         <span class="keywordflow">break</span>;
00962 <span class="preprocessor">#if 0</span>
00963 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a85">IRP_MN_QUERY_BUS_INFORMATION</a>:
00964         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00965         <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00966             <a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html">PPNP_BUS_INFORMATION</a> busInfo;
00967 
00968             busInfo = (<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html">PPNP_BUS_INFORMATION</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html">PNP_BUS_INFORMATION</a>));
00969             <span class="keywordflow">if</span> (busInfo) {
00970                 busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o1">LegacyBusType</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
00971                 busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o2">BusNumber</a> = 0;
00972                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a> == Isa) {
00973                     busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o0">BusTypeGuid</a> = GUID_BUS_TYPE_ISAPNP; <span class="comment">// BUGBUG</span>
00974                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a> == Eisa) {
00975                     busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o0">BusTypeGuid</a> = GUID_BUS_TYPE_EISA;
00976                 } <span class="keywordflow">else</span> { <span class="comment">// Microchannel</span>
00977                     busInfo-&gt;<a class="code" href="../../d8/d6/struct__PNP__BUS__INFORMATION.html#o0">BusTypeGuid</a> = GUID_BUS_TYPE_MCA;
00978                 }
00979                 information = busInfo;
00980                 status = STATUS_SUCCESS;
00981             } <span class="keywordflow">else</span> {
00982                 status = STATUS_INSUFFICIENT_RESOURCES;
00983                 information = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00984             }
00985             <span class="keywordflow">break</span>;
00986         }
00987 <span class="preprocessor">#endif</span>
00988 <span class="preprocessor"></span>
00989         <span class="comment">//</span>
00990         <span class="comment">// Otherwise, let it fall through the default path.</span>
00991         <span class="comment">//</span>
00992 
00993     <span class="keywordflow">default</span>:
00994 
00995         information = (PVOID)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
00996         status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00997         <span class="keywordflow">break</span>;
00998     }
00999 
01000     <span class="comment">//</span>
01001     <span class="comment">// Complete the Irp and return.</span>
01002     <span class="comment">//</span>
01003 
01004     <a class="code" href="../../d2/d0/pnpdd_8c.html#a5">IopPnPCompleteRequest</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, status, (ULONG_PTR)information);
01005     <span class="keywordflow">return</span> status;
01006 }
01007 
01008 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01009"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a5">01009</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a5">IopPnPCompleteRequest</a>(
01010     IN OUT <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
01011     IN NTSTATUS Status,
01012     IN ULONG_PTR Information
01013     )
01014 
01015 <span class="comment">/*++</span>
01016 <span class="comment"></span>
01017 <span class="comment">Routine Description:</span>
01018 <span class="comment"></span>
01019 <span class="comment">    This routine completes PnP irps for our pseudo driver.</span>
01020 <span class="comment"></span>
01021 <span class="comment">Arguments:</span>
01022 <span class="comment"></span>
01023 <span class="comment">    Irp - Supplies a pointer to the irp to be completed.</span>
01024 <span class="comment"></span>
01025 <span class="comment">    Status - completion status.</span>
01026 <span class="comment"></span>
01027 <span class="comment">    Information - completion information to be passed back.</span>
01028 <span class="comment"></span>
01029 <span class="comment">Return Value:</span>
01030 <span class="comment"></span>
01031 <span class="comment">    None.</span>
01032 <span class="comment"></span>
01033 <span class="comment">--*/</span>
01034 
01035 {
01036     KIRQL oldIrql;
01037 
01038     <span class="comment">//</span>
01039     <span class="comment">// Complete the IRP.  First update the status...</span>
01040     <span class="comment">//</span>
01041 
01042     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01043     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = Information;
01044 
01045     <span class="comment">//</span>
01046     <span class="comment">// ... and complete it.</span>
01047     <span class="comment">//</span>
01048 
01049     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a>);
01050 }
01051 
01052 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l01053"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a261">01053</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a261">IopProcessAddDevices</a> (
01054    IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
01055    IN USHORT StartOrder,
01056    IN ULONG  DriverStartType
01057    )
01058 
01059 <span class="comment">/*++</span>
01060 <span class="comment"></span>
01061 <span class="comment">Routine Description:</span>
01062 <span class="comment"></span>
01063 <span class="comment">    This functions is used by Pnp manager to load driver and perform AddDevice for</span>
01064 <span class="comment">    all the devices under DeviceNode subtree.  This routine is used at boot time</span>
01065 <span class="comment">    to process devices which were not processed during boot driver initialization.</span>
01066 <span class="comment"></span>
01067 <span class="comment">    Note, caller must acquire the enumeration mutex of the DeviceNode before calling</span>
01068 <span class="comment">    this routine.</span>
01069 <span class="comment"></span>
01070 <span class="comment">Parameters:</span>
01071 <span class="comment"></span>
01072 <span class="comment">    DeviceNode - Specifies the device node whose subtree is to be checked for StartDevice.</span>
01073 <span class="comment"></span>
01074 <span class="comment">    StartOrder - The group orders to start.</span>
01075 <span class="comment"></span>
01076 <span class="comment">Return Value:</span>
01077 <span class="comment"></span>
01078 <span class="comment">    TRUE - if any new device is successfully added to its driver.</span>
01079 <span class="comment"></span>
01080 <span class="comment">--*/</span>
01081 {
01082     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, nextDeviceNode;
01083     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> returnValue = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
01084     <a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">ADD_CONTEXT</a> context;
01085 
01086     context.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = StartOrder;
01087     context.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
01088     context.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = DriverStartType;
01089 
01090     <span class="comment">//</span>
01091     <span class="comment">// Traverse the device node subtree to perform AddDevice call.</span>
01092     <span class="comment">//</span>
01093 
01094     <span class="keywordflow">if</span> (DeviceNode != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
01095         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(DeviceNode);
01096     }
01097 
01098     deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
01099     <span class="keywordflow">while</span> (deviceNode) {
01100 
01101         <span class="comment">//</span>
01102         <span class="comment">// We need to remember the 'next' device node.  If the deviceNode is a madeup device</span>
01103         <span class="comment">// it may be deleted while processing the IopProcessAddDeviceWorker.</span>
01104         <span class="comment">//</span>
01105 
01106         nextDeviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
01107         <a class="code" href="../../d2/d0/pnpdd_8c.html#a3">IopProcessAddDevicesWorker</a>(deviceNode, &amp;context);
01108         deviceNode = nextDeviceNode;
01109     }
01110     <span class="keywordflow">if</span> (DeviceNode != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
01111         <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
01112     }
01113     <span class="keywordflow">return</span> context.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a>;
01114 }
01115 
01116 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01117"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a3">01117</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a3">IopProcessAddDevicesWorker</a> (
01118    IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
01119    IN PVOID Context
01120    )
01121 
01122 <span class="comment">/*++</span>
01123 <span class="comment"></span>
01124 <span class="comment">Routine Description:</span>
01125 <span class="comment"></span>
01126 <span class="comment">    This function checks if the driver for the DeviceNode is present and loads</span>
01127 <span class="comment">    the driver if necessary.</span>
01128 <span class="comment"></span>
01129 <span class="comment">Arguments:</span>
01130 <span class="comment"></span>
01131 <span class="comment">    DeviceNode - Supplies a pointer to the device node which is to be added.</span>
01132 <span class="comment"></span>
01133 <span class="comment">    Context - Supplies a pointer to a BOOLEAN value to indicate if the specified device</span>
01134 <span class="comment">              is successfully added to its driver.</span>
01135 <span class="comment"></span>
01136 <span class="comment">Return Value:</span>
01137 <span class="comment"></span>
01138 <span class="comment">    NTSTATUS code.</span>
01139 <span class="comment"></span>
01140 <span class="comment">--*/</span>
01141 
01142 {
01143     <a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">PADD_CONTEXT</a> addContext = (<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">PADD_CONTEXT</a>)Context;
01144 
01145 
01146     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) {
01147 
01148         <span class="comment">//</span>
01149         <span class="comment">// If the device has been added, move to its children.</span>
01150         <span class="comment">//</span>
01151 
01152         <span class="comment">//</span>
01153         <span class="comment">// Acquire enumeration mutex to make sure its children won't change by</span>
01154         <span class="comment">// someone else.  Note, the current device node is protected by its parent's</span>
01155         <span class="comment">// Enumeration mutex and it won't disappear either.</span>
01156         <span class="comment">//</span>
01157 
01158         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(DeviceNode);
01159 
01160         <span class="comment">//</span>
01161         <span class="comment">// Recursively mark all of our children deleted.</span>
01162         <span class="comment">//</span>
01163 
01164         <a class="code" href="../../d9/d0/pnpiop_8h.html#a270">IopForAllChildDeviceNodes</a>(DeviceNode, <a class="code" href="../../d2/d0/pnpdd_8c.html#a3">IopProcessAddDevicesWorker</a>, Context);
01165 
01166         <span class="comment">//</span>
01167         <span class="comment">// Release the enumeration mutex of the device node.</span>
01168         <span class="comment">//</span>
01169 
01170         <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
01171 
01172     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a42">OK_TO_ADD_DEVICE</a>(DeviceNode)) {
01173 
01174         <span class="comment">//</span>
01175         <span class="comment">// If this device is not added (not because of failure), load its controlling</span>
01176         <span class="comment">// driver and invoke the driver's AddDevice entry.</span>
01177         <span class="comment">//</span>
01178 
01179         <a class="code" href="../../d9/d0/pnpiop_8h.html#a286">IopCallDriverAddDevice</a>(DeviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, addContext);
01180     }
01181     <span class="keywordflow">return</span> STATUS_SUCCESS;
01182 }
01183 
01184 BOOLEAN
<a name="l01185"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a262">01185</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a> (
01186    IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
01187    IN BOOLEAN Reallocation,
01188    IN BOOLEAN BootConfigsOK
01189    )
01190 
01191 <span class="comment">/*++</span>
01192 <span class="comment"></span>
01193 <span class="comment">Routine Description:</span>
01194 <span class="comment"></span>
01195 <span class="comment">    This functions is used by Pnp manager to allocate resources for the devices</span>
01196 <span class="comment">    which have been successfully added to their drivers and waiting to be started.</span>
01197 <span class="comment"></span>
01198 <span class="comment">    Note, the caller must acquire the enumeration mutex before calling this routine.</span>
01199 <span class="comment"></span>
01200 <span class="comment">Parameters:</span>
01201 <span class="comment"></span>
01202 <span class="comment">    DeviceNode - specifies the device node whose subtree is to be checked for AssignRes.</span>
01203 <span class="comment"></span>
01204 <span class="comment">    Reallocation - specifies if we are assigning resources for DNF_INSUFFICIENT_RESOURCES</span>
01205 <span class="comment">                   devices.</span>
01206 <span class="comment"></span>
01207 <span class="comment">    BootConfigsOK  - Indicates that it is OK to assign BOOT configs.</span>
01208 <span class="comment"></span>
01209 <span class="comment">Return Value:</span>
01210 <span class="comment"></span>
01211 <span class="comment">    TRUE - if more devices need resources.  This means we did not assign resources for all</span>
01212 <span class="comment">    the devices.  caller must call this routine again.</span>
01213 <span class="comment"></span>
01214 <span class="comment">--*/</span>
01215 {
01216     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01217     <a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a> context;
01218     BOOLEAN again = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01219     ULONG count, i;
01220     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> requestTable;
01221 
01222     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// Allocate and init memory for resource context</span>
01226     <span class="comment">//</span>
01227 
01228     context = (<a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01229                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01230                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">DEVICE_LIST_CONTEXT</a>) +
01231                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * <a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a>
01232                                     );
01233     <span class="keywordflow">if</span> (!context) {
01234         <span class="keywordflow">return</span> again;
01235     }
01236     context-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a> = 0;
01237     context-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o1">Reallocation</a> = Reallocation;
01238 
01239     <span class="comment">//</span>
01240     <span class="comment">// Parse the device node subtree to determine which devices need resources</span>
01241     <span class="comment">//</span>
01242 
01243     <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(DeviceNode);
01244     deviceNode = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
01245 
01246     <span class="keywordflow">while</span> (deviceNode) {
01247         <a class="code" href="../../d2/d0/pnpdd_8c.html#a4">IopProcessAssignResourcesWorker</a>(deviceNode, context);
01248         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
01249     }
01250     <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
01251     count = context-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a>;
01252     <span class="keywordflow">if</span> (count == 0) {
01253         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(context);
01254         <span class="keywordflow">return</span> again;
01255     }
01256 
01257     <span class="comment">//</span>
01258     <span class="comment">// Need to assign resources to devices.  Build the resource request table and call</span>
01259     <span class="comment">// resource assignment routine.</span>
01260     <span class="comment">//</span>
01261 
01262     requestTable = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01263                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01264                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>) * count
01265                                     );
01266     <span class="keywordflow">if</span> (requestTable) {
01267 
01268         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
01269             requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = 0;
01270             requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = context-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[i];
01271         }
01272 
01273         <span class="comment">//</span>
01274         <span class="comment">// Assign resources</span>
01275         <span class="comment">//</span>
01276 
01277         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a8">IopDeviceTreeLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01278         <a class="code" href="../../d2/d0/pnpdd_8c.html#a22">IopAssignResourcesToDevices</a>(count, requestTable, BootConfigsOK);
01279 
01280         <span class="comment">//</span>
01281         <span class="comment">// Check the results</span>
01282         <span class="comment">//</span>
01283 
01284         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
01285 
01286             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)
01287                           requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01288             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(requestTable[i].<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01289                 <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
01290                     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>)) {
01291                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
01292                     }
01293                     <span class="comment">//deviceNode-&gt;Flags &amp;= ~DNF_INSUFFICIENT_RESOURCES;</span>
01294                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
01295                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
01296                 } <span class="keywordflow">else</span> {
01297                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
01298                 }
01299             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_RETRY) {
01300                 again = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01301             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_DEVICE_CONFIGURATION_ERROR) {
01302                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NO_SOFTCONFIG);
01303             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_BAD_MPS_TABLE) {
01304                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_BIOS_TABLE);
01305             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_TRANSLATION_FAILED) {
01306                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_TRANSLATION_FAILED);
01307             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_IRQ_TRANSLATION_FAILED) {
01308                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_IRQ_TRANSLATION_FAILED);
01309             } <span class="keywordflow">else</span> {
01310                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NORMAL_CONFLICT);
01311             }
01312 
01313             <span class="comment">//</span>
01314             <span class="comment">// IopProcessAssignReourcesWork marks the device nodes as DNF_ASSIGNING_RESOURCES</span>
01315             <span class="comment">// We need to clear it to indicate the assigment is done.</span>
01316             <span class="comment">//</span>
01317 
01318             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
01319         }
01320         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a8">IopDeviceTreeLock</a>);
01321         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable);
01322     }
01323     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(context);
01324     <span class="keywordflow">return</span> again;
01325 }
01326 
01327 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01328"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a4">01328</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a4">IopProcessAssignResourcesWorker</a> (
01329    IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
01330    IN PVOID Context
01331    )
01332 
01333 <span class="comment">/*++</span>
01334 <span class="comment"></span>
01335 <span class="comment">Routine Description:</span>
01336 <span class="comment"></span>
01337 <span class="comment">    This functions searches the DeviceNode subtree to locate all the device objects</span>
01338 <span class="comment">    which have been successfully added to their drivers and waiting for resources to</span>
01339 <span class="comment">    be started.</span>
01340 <span class="comment"></span>
01341 <span class="comment">Parameters:</span>
01342 <span class="comment"></span>
01343 <span class="comment">    DeviceNode - specifies the device node whose subtree is to be checked for AssignRes.</span>
01344 <span class="comment"></span>
01345 <span class="comment">    Context - specifies a pointer to a structure to pass resource assignment information.</span>
01346 <span class="comment"></span>
01347 <span class="comment">Return Value:</span>
01348 <span class="comment"></span>
01349 <span class="comment">    TRUE.</span>
01350 <span class="comment"></span>
01351 <span class="comment">--*/</span>
01352 {
01353     <a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a> resourceContext = (<a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a>) Context;
01354 
01355     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01356 
01357     <span class="comment">//</span>
01358     <span class="comment">// If the device node/object has not been add, skip it.</span>
01359     <span class="comment">//</span>
01360 
01361     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>)) {
01362         <span class="keywordflow">return</span> STATUS_SUCCESS;
01363     }
01364 
01365     <span class="keywordflow">if</span> (resourceContext-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o1">Reallocation</a> &amp;&amp;
01366         (   <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NORMAL_CONFLICT) ||
01367             <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_TRANSLATION_FAILED) ||
01368             <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_IRQ_TRANSLATION_FAILED))) {
01369         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
01370     }
01371 
01372     <span class="comment">//</span>
01373     <span class="comment">// If the device object has not been started and has no resources yet.</span>
01374     <span class="comment">// Append it to our list.</span>
01375     <span class="comment">//</span>
01376 
01377     <span class="keywordflow">if</span> (    !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a43">DNF_START_PHASE</a>) &amp;&amp;
01378             !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a45">DNF_ASSIGN_RESOURCE_PHASE</a>)) {
01379 
01380            resourceContext-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[resourceContext-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a>] =
01381                               DeviceNode-&gt;PhysicalDeviceObject;
01382            DeviceNode-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
01383            resourceContext-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a>++;
01384 
01385     } <span class="keywordflow">else</span> {
01386 
01387         <span class="comment">//</span>
01388         <span class="comment">// Acquire enumeration mutex to make sure its children won't change by</span>
01389         <span class="comment">// someone else.  Note, the current device node is protected by its parent's</span>
01390         <span class="comment">// Enumeration mutex and it won't disappear either.</span>
01391         <span class="comment">//</span>
01392 
01393         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(DeviceNode);
01394 
01395         <span class="comment">//</span>
01396         <span class="comment">// Recursively mark all of our children deleted.</span>
01397         <span class="comment">//</span>
01398 
01399         <a class="code" href="../../d9/d0/pnpiop_8h.html#a270">IopForAllChildDeviceNodes</a>(DeviceNode, <a class="code" href="../../d2/d0/pnpdd_8c.html#a4">IopProcessAssignResourcesWorker</a>, Context);
01400 
01401         <span class="comment">//</span>
01402         <span class="comment">// Release the enumeration mutex of the device node.</span>
01403         <span class="comment">//</span>
01404 
01405         <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
01406     }
01407     <span class="keywordflow">return</span> STATUS_SUCCESS;
01408 }
01409 
01410 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01411"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a6">01411</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a6">IopGetDriverDeviceList</a> (
01412    IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
01413    OUT PDEVICE_LIST_CONTEXT *DeviceList
01414    )
01415 
01416 <span class="comment">/*++</span>
01417 <span class="comment"></span>
01418 <span class="comment">Routine Description:</span>
01419 <span class="comment"></span>
01420 <span class="comment">    This functions is used by Pnp manager to inform a device driver of</span>
01421 <span class="comment">    all the devices it can possibly control.  See IopStartDriverDevices().</span>
01422 <span class="comment"></span>
01423 <span class="comment">Parameters:</span>
01424 <span class="comment"></span>
01425 <span class="comment">    DriverObject - Supplies a driver object to receive its boot devices.</span>
01426 <span class="comment"></span>
01427 <span class="comment">    DeviceList - Specifies a pointer to a variable to receive the list of device</span>
01428 <span class="comment">                 objects controlled by the driver.</span>
01429 <span class="comment"></span>
01430 <span class="comment">Return Value:</span>
01431 <span class="comment"></span>
01432 <span class="comment">    NTSTATUS code.</span>
01433 <span class="comment"></span>
01434 <span class="comment">--*/</span>
01435 {
01436     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01437     HANDLE enumHandle;
01438     ULONG count = 0;
01439     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01440     <a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a> deviceList;
01441 
01442     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01443 
01444     *DeviceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01445     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01446     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01447 
01448     <span class="comment">//</span>
01449     <span class="comment">// Open System\CurrentControlSet\Services</span>
01450     <span class="comment">//</span>
01451 
01452     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a> (
01453                  &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName,
01454                  KEY_READ,
01455                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01456                  &amp;enumHandle,
01457                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01458                  );
01459     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01460         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01461     }
01462 
01463     <span class="comment">//</span>
01464     <span class="comment">// Read value of Count if present.  If it is not present, a value of</span>
01465     <span class="comment">// zero will be returned.</span>
01466     <span class="comment">//</span>
01467 
01468     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(enumHandle, REGSTR_VALUE_COUNT, &amp;keyValueInformation);
01469     ZwClose(enumHandle);
01470     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01471         <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength != 0) {
01472             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01473         }
01474         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01475     }
01476 
01477     <span class="keywordflow">if</span> (count == 0) {
01478         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01479     }
01480 
01481     deviceList = (<a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01482                                 <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01483                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html">DEVICE_LIST_CONTEXT</a>) +
01484                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * count * 2
01485                                 );
01486 
01487     <span class="keywordflow">if</span> (!deviceList) {
01488         status = STATUS_INSUFFICIENT_RESOURCES;
01489         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01490     }
01491 
01492     deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a> = 0;
01493 
01494     <span class="comment">//</span>
01495     <span class="comment">// For each device instance in the driver's service/enum key, we will</span>
01496     <span class="comment">// invoke the our worker routine to collect its corresponding device object.</span>
01497     <span class="comment">//</span>
01498 
01499     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a14">IopApplyFunctionToServiceInstances</a>(
01500                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01501                                 &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName,
01502                                 KEY_ALL_ACCESS,
01503                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01504                                 <a class="code" href="../../d2/d0/pnpdd_8c.html#a7">IopGetDriverDeviceListWorker</a>,
01505                                 deviceList,
01506                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01507                                 );
01508     *DeviceList = deviceList;
01509 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
01510     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
01511     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01512     <span class="keywordflow">return</span> status;
01513 }
01514 
01515 BOOLEAN
<a name="l01516"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a7">01516</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a7">IopGetDriverDeviceListWorker</a>(
01517     IN HANDLE DeviceInstanceHandle,
01518     IN PUNICODE_STRING DeviceInstancePath,
01519     IN OUT PVOID Context
01520     )
01521 
01522 <span class="comment">/*++</span>
01523 <span class="comment"></span>
01524 <span class="comment">Routine Description:</span>
01525 <span class="comment"></span>
01526 <span class="comment">    This routine is a callback function for IopApplyFunctionToServiceInstances.</span>
01527 <span class="comment">    It is called for each device instance key referenced by a service instance</span>
01528 <span class="comment">    value under the specified service's volatile Enum subkey. The purpose of this</span>
01529 <span class="comment">    routine is to generate a device list controlled by the same driver.</span>
01530 <span class="comment"></span>
01531 <span class="comment">Arguments:</span>
01532 <span class="comment"></span>
01533 <span class="comment">    DeviceInstanceHandle - Supplies a handle to the registry path (relative to</span>
01534 <span class="comment">        HKLM\CCS\System\Enum) to this device instance.</span>
01535 <span class="comment"></span>
01536 <span class="comment">    DeviceInstancePath - Supplies the registry path (relative to HKLM\CCS\System\Enum)</span>
01537 <span class="comment">        to this device instance.</span>
01538 <span class="comment"></span>
01539 <span class="comment">    Context - Supplies a pointer to a PDEVICE_LIST_CONTEXT structure.</span>
01540 <span class="comment"></span>
01541 <span class="comment">Return Value:</span>
01542 <span class="comment"></span>
01543 <span class="comment">    TRUE to continue the enumeration.</span>
01544 <span class="comment">    FALSE to abort it.</span>
01545 <span class="comment"></span>
01546 <span class="comment">--*/</span>
01547 
01548 {
01549     <a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a> deviceList = (<a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a>)Context;
01550     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDevice;
01551     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01552 
01553     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01554 
01555     <span class="comment">//</span>
01556     <span class="comment">// Reference the physical device object associated with the device instance.</span>
01557     <span class="comment">//</span>
01558 
01559     physicalDevice = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(DeviceInstanceHandle,
01560                                                        DeviceInstancePath);
01561     <span class="keywordflow">if</span> (!physicalDevice) {
01562         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01563     }
01564 
01565     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01566 
01567     <span class="comment">//</span>
01568     <span class="comment">// Make sure the device instance is not disabled.</span>
01569     <span class="comment">//</span>
01570 
01571     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode)) {
01572         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01573     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(DeviceInstanceHandle, DeviceInstancePath, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01574         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01575     }
01576 
01577     <span class="comment">//</span>
01578     <span class="comment">// If we know the device is a duplicate of another enumerated device and it</span>
01579     <span class="comment">// has been enumerated at this point. we will skip this device.</span>
01580     <span class="comment">//</span>
01581 
01582     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a6">DNF_DUPLICATE</a>) &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a>)) {
01583 
01584         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01585     }
01586 
01587     deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a>] = physicalDevice;
01588     deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a>++;
01589     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01590 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
01591     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDevice);
01592     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01593 }
01594 
01595 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01596"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a289">01596</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a289">IopNewDevice</a>(
01597     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
01598     )
01599 
01600 <span class="comment">/*++</span>
01601 <span class="comment"></span>
01602 <span class="comment">Routine Description:</span>
01603 <span class="comment"></span>
01604 <span class="comment">    This routine handles user-mode initiated starts of devices.</span>
01605 <span class="comment"></span>
01606 <span class="comment">Parameters:</span>
01607 <span class="comment"></span>
01608 <span class="comment">    DeviceObject - PDO.</span>
01609 <span class="comment"></span>
01610 <span class="comment">ReturnValue:</span>
01611 <span class="comment"></span>
01612 <span class="comment">    None.</span>
01613 <span class="comment"></span>
01614 <span class="comment">--*/</span>
01615 
01616 {
01617     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, parent;
01618     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> requestTable;
01619     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01620     BOOLEAN newDevice;
01621     <a class="code" href="../../d0/d6/struct__START__CONTEXT.html">START_CONTEXT</a> startContext;
01622     <a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html">ADD_CONTEXT</a> addContext;
01623 
01624     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01625 
01626     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
01627 
01628     <span class="comment">//</span>
01629     <span class="comment">// Make sure the device is not started</span>
01630     <span class="comment">//</span>
01631 
01632     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) {
01633         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01634     }
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">// Need enumeration on IoReportDetectedDevice</span>
01638     <span class="comment">//</span>
01639 
01640     <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>)) {
01641         <span class="comment">//</span>
01642         <span class="comment">// Invoke the driver's AddDevice() entry and enumerate the device.</span>
01643         <span class="comment">//</span>
01644 
01645         addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = 0xffff;
01646         addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = 0xffff;
01647         addContext.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
01648 
01649         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a286">IopCallDriverAddDevice</a>(deviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;addContext);
01650         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>)) {
01651             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01652         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>) {
01653 
01654             <span class="comment">//</span>
01655             <span class="comment">// The driver may perform IoReportDetectedDevice</span>
01656             <span class="comment">//</span>
01657 
01658             <span class="keywordflow">goto</span> enumerate;
01659         }
01660 
01661         <span class="comment">//</span>
01662         <span class="comment">// Assign resource to the device</span>
01663         <span class="comment">//</span>
01664 
01665         requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = DeviceObject;
01666         requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = 0;
01667 
01668         <a class="code" href="../../d2/d0/pnpdd_8c.html#a22">IopAssignResourcesToDevices</a>(1, &amp;requestTable, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01669 
01670         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a>)) {
01671             <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
01672                 <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>)) {
01673                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
01674                 }
01675                 <span class="comment">// deviceNode-&gt;Flags &amp;= ~DNF_INSUFFICIENT_RESOURCES;</span>
01676                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
01677                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
01678             } <span class="keywordflow">else</span> {
01679                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
01680             }
01681         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_DEVICE_CONFIGURATION_ERROR) {
01682             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NO_SOFTCONFIG);
01683             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01684         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_BAD_MPS_TABLE) {
01685             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_BIOS_TABLE);
01686             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01687         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_TRANSLATION_FAILED) {
01688             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_TRANSLATION_FAILED);
01689             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01690         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> == STATUS_PNP_IRQ_TRANSLATION_FAILED) {
01691             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_IRQ_TRANSLATION_FAILED);
01692             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01693         } <span class="keywordflow">else</span> {
01694             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NORMAL_CONFLICT);
01695             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01696         }
01697     }
01698 
01699 enumerate:
01700 
01701     <span class="comment">//</span>
01702     <span class="comment">// Start and enumerate the device</span>
01703     <span class="comment">//</span>
01704 
01705     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o0">LoadDriver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01706     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01707     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o0">GroupsToStart</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
01708     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o1">GroupToStartNext</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
01709     startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o2">AddContext</a>.<a class="code" href="../../d8/d5/struct__ADD__CONTEXT.html#o2">DriverStartType</a> = SERVICE_DEMAND_START;
01710 
01711     <a class="code" href="../../d9/d0/pnpiop_8h.html#a285">IopStartAndEnumerateDevice</a>(deviceNode, &amp;startContext);
01712     newDevice = startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
01713     <span class="keywordflow">while</span> (newDevice) {
01714 
01715         startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01716 
01717         <span class="comment">//</span>
01718         <span class="comment">// Process the whole device tree to assign resources to those devices who</span>
01719         <span class="comment">// have been successfully added to their drivers.</span>
01720         <span class="comment">//</span>
01721 
01722         newDevice = <a class="code" href="../../d9/d0/pnpiop_8h.html#a262">IopProcessAssignResources</a>(deviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01723 
01724         <span class="comment">//</span>
01725         <span class="comment">// Process the whole device tree to start those devices who have been allocated</span>
01726         <span class="comment">// resources and waiting to be started.</span>
01727         <span class="comment">// Note, the IopProcessStartDevices routine may enumerate new devices.</span>
01728         <span class="comment">//</span>
01729 
01730         <a class="code" href="../../d9/d0/pnpiop_8h.html#a263">IopProcessStartDevices</a>(deviceNode, &amp;startContext);
01731         newDevice |= startContext.<a class="code" href="../../d0/d6/struct__START__CONTEXT.html#o1">NewDevice</a>;
01732 
01733     }
01734 
01735 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
01736     ;
01737 }
01738 
01739 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01740"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a287">01740</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a287">IopStartDriverDevices</a>(
01741     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
01742     )
01743 
01744 <span class="comment">/*++</span>
01745 <span class="comment"></span>
01746 <span class="comment">Routine Description:</span>
01747 <span class="comment"></span>
01748 <span class="comment">    This routine is used by IopLoadDriver to add/start the devices controlled by</span>
01749 <span class="comment">    the newly loaded driver.</span>
01750 <span class="comment"></span>
01751 <span class="comment">Arguments:</span>
01752 <span class="comment"></span>
01753 <span class="comment">    DriverObject - specifies the driver object which is being started thru</span>
01754 <span class="comment">                   IopLoadDriver after the boot drivers and system drivers init</span>
01755 <span class="comment">                   phase.</span>
01756 <span class="comment"></span>
01757 <span class="comment">Return Value:</span>
01758 <span class="comment"></span>
01759 <span class="comment">    NTSTATUS code.</span>
01760 <span class="comment"></span>
01761 <span class="comment">--*/</span>
01762 
01763 {
01764     ULONG count, i;
01765     <a class="code" href="../../d2/d0/pnpdd_8c.html#a1">PDEVICE_LIST_CONTEXT</a> deviceList;
01766     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01767     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01768     <a class="code" href="../../d0/d5/io_8h.html#a290">PDRIVER_ADD_DEVICE</a> addDeviceRoutine;
01769 
01770     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01771 
01772     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a>) {
01773 
01774         <span class="comment">//</span>
01775         <span class="comment">// If this function is called at PnP Init time, we don't start the devices</span>
01776         <span class="comment">// for the specified driver.  The device add/start is handled by pnp based</span>
01777         <span class="comment">// on the device enumeration.</span>
01778         <span class="comment">//</span>
01779 
01780         <span class="keywordflow">return</span> status;
01781     }
01782 
01783     addDeviceRoutine = DriverObject-&gt;DriverExtension-&gt;AddDevice;
01784     <span class="keywordflow">if</span> (addDeviceRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01785         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(addDeviceRoutine);
01786         <span class="keywordflow">return</span> status;
01787     }
01788 
01789     <a class="code" href="../../d2/d0/pnpdd_8c.html#a6">IopGetDriverDeviceList</a>(DriverObject, &amp;deviceList);
01790     count = deviceList ? deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o0">DeviceCount</a> : 0;
01791     <span class="keywordflow">if</span> (count == 0) {
01792 
01793         <span class="keywordflow">if</span> (deviceList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01794             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceList);
01795         }
01796 
01797         <span class="keywordflow">return</span> STATUS_PLUGPLAY_NO_DEVICE;
01798     }
01799 
01800     <span class="comment">//</span>
01801     <span class="comment">// For each device int the list queue an IopNewDeviceEvent if the device is reported by driver</span>
01802     <span class="comment">//</span>
01803 
01804     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
01805 
01806         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[i]-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01807         <span class="keywordflow">if</span> (!deviceNode || !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>) ) {
01808             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[i]);
01809             <span class="keywordflow">continue</span>;
01810         }
01811         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(deviceList-&gt;<a class="code" href="../../d1/d4/struct__DEVICE__LIST__CONTEXT.html#o2">DeviceList</a>[i], <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a224">StartDevice</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01812     }
01813 
01814     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceList);
01815     <span class="keywordflow">return</span> status;
01816 }
01817 
01818 <span class="comment">//</span>
01819 <span class="comment">// The following routines should be removed once the real</span>
01820 <span class="comment">// Resource Assign code is done.</span>
01821 <span class="comment">//</span>
01822 
01823 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01824"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a22">01824</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a22">IopAssignResourcesToDevices</a> (
01825     IN ULONG DeviceCount,
01826     IN OUT <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> RequestTable,
01827     IN BOOLEAN BootConfigsOK
01828     )
01829 <span class="comment">/*++</span>
01830 <span class="comment"></span>
01831 <span class="comment">Routine Description:</span>
01832 <span class="comment"></span>
01833 <span class="comment">    This routine takes an input array of IOP_RESOURCE_REQUEST structures, and</span>
01834 <span class="comment">    allocates resource for the physical device object specified in</span>
01835 <span class="comment">    the structure.   The allocated resources are automatically recorded</span>
01836 <span class="comment">    in the registry.</span>
01837 <span class="comment"></span>
01838 <span class="comment">Arguments:</span>
01839 <span class="comment"></span>
01840 <span class="comment">    DeviceCount - Supplies the number of device objects whom we need to</span>
01841 <span class="comment">                  allocate resource to.  That is the number of entries</span>
01842 <span class="comment">                  in the RequestTable.</span>
01843 <span class="comment"></span>
01844 <span class="comment">    RequestTable - Supplies an array of IOP_RESOURCE_REQUEST structures which</span>
01845 <span class="comment">                   contains the Physical device object to allocate resource to.</span>
01846 <span class="comment">                   Upon entry, the ResourceAssignment pointer is NULL and on</span>
01847 <span class="comment">                   return the allocated resource is returned via the this pointer.</span>
01848 <span class="comment"></span>
01849 <span class="comment">    BootConfigsOK - Allow assignment of BOOT configs.</span>
01850 <span class="comment"></span>
01851 <span class="comment">Return Value:</span>
01852 <span class="comment"></span>
01853 <span class="comment">    The status returned is the final completion status of the operation.</span>
01854 <span class="comment"></span>
01855 <span class="comment">    NOTE:</span>
01856 <span class="comment">    If NTSTATUS_SUCCESS is returned, the resource allocation for *all* the devices</span>
01857 <span class="comment">    specified is succeeded.  Otherwise, one or more are failed and caller must</span>
01858 <span class="comment">    examine the ResourceAssignment pointer in each IOP_RESOURCE_REQUEST structure to</span>
01859 <span class="comment">    determine which devices failed and which succeeded.</span>
01860 <span class="comment"></span>
01861 <span class="comment">--*/</span>
01862 {
01863     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01864     ULONG i;
01865 
01866     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01867 
01868     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceCount != 0);
01869 
01870     <span class="keywordflow">for</span> (i = 0; i &lt; DeviceCount; i++) {
01871 
01872         <span class="comment">//</span>
01873         <span class="comment">// Initialize table entry.</span>
01874         <span class="comment">//</span>
01875 
01876         RequestTable[i].ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01877         RequestTable[i].Status = 0;
01878         RequestTable[i].Flags = 0;
01879         RequestTable[i].AllocationType = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
01880         <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)(RequestTable[i].PhysicalDevice-&gt;DeviceObjectExtension-&gt;DeviceNode))-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
01881 
01882             ULONG           reportedDevice = 0;
01883             HANDLE          hInstance;
01884 
01885             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(RequestTable[i].PhysicalDevice, &amp;hInstance, KEY_READ);
01886             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01887 
01888                 ULONG           resultSize = 0;
01889                 UCHAR           buffer[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(ULONG)];
01890                 UNICODE_STRING  unicodeString;
01891 
01892                 PiWstrToUnicodeString(&amp;unicodeString, REGSTR_VALUE_DEVICE_REPORTED);
01893                 status = ZwQueryValueKey(   hInstance,
01894                                             &amp;unicodeString,
01895                                             KeyValuePartialInformation,
01896                                             (PVOID)buffer,
01897                                             <span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(ULONG),
01898                                             &amp;resultSize);
01899                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01900 
01901                     reportedDevice = *(PULONG)(((PKEY_VALUE_PARTIAL_INFORMATION)buffer)-&gt;Data);
01902 
01903                 }
01904 
01905                 ZwClose(hInstance);
01906             }
01907 
01908             <span class="comment">//</span>
01909             <span class="comment">// Change the AllocationType for reported devices.</span>
01910             <span class="comment">//</span>
01911 
01912             <span class="keywordflow">if</span> (reportedDevice) {
01913 
01914                 RequestTable[i].AllocationType = <a class="code" href="../../d6/d9/pnp_8h.html#a174a126">ArbiterRequestLegacyReported</a>;
01915 
01916             }
01917 
01918         }
01919         RequestTable[i].ResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01920     }
01921 
01922     <span class="comment">//</span>
01923     <span class="comment">// Allocate memory to build a IOP_ASSIGN table to call IopAllocateResources()</span>
01924     <span class="comment">//</span>
01925 
01926     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a105">IopAllocateResources</a>(&amp;DeviceCount, &amp;RequestTable, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, BootConfigsOK);
01927     <span class="keywordflow">return</span> status;
01928 }
01929 
01930 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01931"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a23">01931</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a> (
01932     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
01933     PCM_RESOURCE_LIST CmResourceList,
01934     ULONG Length
01935     )
01936 
01937 <span class="comment">/*++</span>
01938 <span class="comment"></span>
01939 <span class="comment">Routine Description:</span>
01940 <span class="comment"></span>
01941 <span class="comment">    This routine writes allocated resources for a device to its control key of device</span>
01942 <span class="comment">    instance path key.</span>
01943 <span class="comment"></span>
01944 <span class="comment">Arguments:</span>
01945 <span class="comment"></span>
01946 <span class="comment">    DeviceNode - Supplies a pointer to the device node structure of the device.</span>
01947 <span class="comment"></span>
01948 <span class="comment">    CmResourceList - Supplies a pointer to the device's allocated CM resource list.</span>
01949 <span class="comment"></span>
01950 <span class="comment">    Length - Supplies the length of the CmResourceList.</span>
01951 <span class="comment"></span>
01952 <span class="comment">Return Value:</span>
01953 <span class="comment"></span>
01954 <span class="comment">    The status returned is the final completion status of the operation.</span>
01955 <span class="comment"></span>
01956 <span class="comment">--*/</span>
01957 {
01958     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01959     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
01960     HANDLE handle, handlex;
01961     UNICODE_STRING unicodeName;
01962 
01963     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01964     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01965 
01966     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(
01967                                     deviceObject,
01968                                     &amp;handlex,
01969                                     KEY_ALL_ACCESS);
01970     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01971 
01972         <span class="comment">//</span>
01973         <span class="comment">// Open the LogConfig key of the device instance.</span>
01974         <span class="comment">//</span>
01975 
01976         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
01977         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
01978                                          handlex,
01979                                          &amp;unicodeName,
01980                                          KEY_ALL_ACCESS,
01981                                          REG_OPTION_VOLATILE,
01982                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01983                                          );
01984         ZwClose(handlex);
01985         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01986 
01987             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VALUE_ALLOC_CONFIG);
01988             <span class="keywordflow">if</span> (CmResourceList) {
01989                 status = ZwSetValueKey(
01990                               handle,
01991                               &amp;unicodeName,
01992                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01993                               REG_RESOURCE_LIST,
01994                               CmResourceList,
01995                               Length
01996                               );
01997             } <span class="keywordflow">else</span> {
01998                 status = ZwDeleteValueKey(handle, &amp;unicodeName);
01999             }
02000             ZwClose(handle);
02001         }
02002     }
02003     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
02004     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02005     <span class="keywordflow">return</span> status;
02006 }
02007 
02008 BOOLEAN
<a name="l02009"></a><a class="code" href="../../d2/d0/pnpdd_8c.html#a9">02009</a> <a class="code" href="../../d2/d0/pnpdd_8c.html#a9">IopIsFirmwareDisabled</a> (
02010     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
02011     )
02012 
02013 <span class="comment">/*++</span>
02014 <span class="comment"></span>
02015 <span class="comment">Routine Description:</span>
02016 <span class="comment"></span>
02017 <span class="comment">    This routine determines if the devicenode has been disabled by firmware.</span>
02018 <span class="comment"></span>
02019 <span class="comment">Arguments:</span>
02020 <span class="comment"></span>
02021 <span class="comment">    DeviceNode - Supplies a pointer to the device node structure of the device.</span>
02022 <span class="comment"></span>
02023 <span class="comment">Return Value:</span>
02024 <span class="comment"></span>
02025 <span class="comment">    TRUE if disabled, otherwise FALSE</span>
02026 <span class="comment"></span>
02027 <span class="comment">--*/</span>
02028 {
02029     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02030     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
02031     HANDLE handle, handlex;
02032     UNICODE_STRING unicodeName;
02033     UCHAR buffer[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+<span class="keyword">sizeof</span>(ULONG)];
02034     PKEY_VALUE_PARTIAL_INFORMATION value = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
02035     ULONG buflen;
02036     BOOLEAN FirmwareDisabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02037 
02038     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02039     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02040 
02041     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(
02042                                     deviceObject,
02043                                     &amp;handlex,
02044                                     KEY_ALL_ACCESS);
02045     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02046 
02047         <span class="comment">//</span>
02048         <span class="comment">// Open the LogConfig key of the device instance.</span>
02049         <span class="comment">//</span>
02050 
02051         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
02052         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
02053                                          handlex,
02054                                          &amp;unicodeName,
02055                                          KEY_ALL_ACCESS,
02056                                          REG_OPTION_VOLATILE,
02057                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02058                                          );
02059         ZwClose(handlex);
02060         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02061 
02062             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_FIRMWAREDISABLED);
02063             value = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
02064             buflen = <span class="keyword">sizeof</span>(buffer);
02065             status = ZwQueryValueKey(handle,
02066                                      &amp;unicodeName,
02067                                      KeyValuePartialInformation,
02068                                      value,
02069                                      <span class="keyword">sizeof</span>(buffer),
02070                                      &amp;buflen
02071                                      );
02072 
02073             ZwClose(handle);
02074 
02075             <span class="comment">//</span>
02076             <span class="comment">// We don't need to check the buffer was big enough because it starts</span>
02077             <span class="comment">// off that way and doesn't get any smaller!</span>
02078             <span class="comment">//</span>
02079 
02080             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
02081                 &amp;&amp; value-&gt;Type == REG_DWORD
02082                 &amp;&amp; value-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)
02083                 &amp;&amp; (*(PULONG)(value-&gt;Data))!=0) {
02084 
02085                 <span class="comment">//</span>
02086                 <span class="comment">// firmware disabled</span>
02087                 <span class="comment">//</span>
02088                 FirmwareDisabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02089             }
02090         }
02091     }
02092     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
02093     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02094     <span class="keywordflow">return</span> FirmwareDisabled;
02095 }
02096 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
