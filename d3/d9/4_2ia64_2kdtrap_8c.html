<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: 4/ia64/kdtrap.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdtrap.c File Reference</h1><code>#include "<a class="el" href="../../d2/d6/4_2kdp_8h-source.html">kdp.h</a>"</code><br>

<p>
<a href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a0">KdpTrap</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame, IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN BOOLEAN SecondChance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a2">KdpStub</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame, IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN BOOLEAN SecondChance)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="4/ia64/kdtrap.c::KdIsThisAKdTrap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdIsThisAKdTrap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html#l00329">329</a> of file <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html">4/ia64/kdtrap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00617">BREAKIN_BREAKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00616">KERNEL_BREAKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00412">KiDispatchException()</a>.
<p>
<pre class="fragment"><div>00337                    :
00338 
00339     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a user-mode exception occurs and
00340     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> might be a kernel debugger exception (Like DbgPrint/DbgPrompt ).
00341 
00342 Arguments:
00343 
00344     ExceptionRecord - Supplies a pointer to an exception record that
00345         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00346 
00347     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00348 
00349     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00350 
00351 Return Value:
00352 
00353     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger.
00354     Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00355 
00356 --*/
00357 
00358 {
00359 
00360     ULONG_PTR BreakpointCode;
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// Isolate the breakpoint code from the breakpoint instruction which</span>
00364     <span class="comment">// is stored by the exception dispatch code in the information field</span>
00365     <span class="comment">// of the exception record.</span>
00366     <span class="comment">//</span>
00367 
00368     BreakpointCode = (ULONG) ExceptionRecord-&gt;ExceptionInformation[0];
00369 
00370     <span class="comment">//</span>
00371     <span class="comment">// Switch on the breakpoint code.</span>
00372     <span class="comment">//</span>
00373 
00374     <span class="keywordflow">switch</span> (BreakpointCode) {
00375 
00376         <span class="comment">//</span>
00377         <span class="comment">// Kernel breakpoint codes.</span>
00378         <span class="comment">//</span>
00379 
00380     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a454">BREAKIN_BREAKPOINT</a>:
00381     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a453">KERNEL_BREAKPOINT</a>:
00382 
00383 <span class="preprocessor">#if DEVL</span>
00384 <span class="preprocessor"></span>
00385         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00386 
00387 <span class="preprocessor">#else</span>
00388 <span class="preprocessor"></span>
00389         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00390             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00391 
00392         } <span class="keywordflow">else</span> {
00393             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00394         }
00395 
00396 <span class="preprocessor">#endif</span>
00397 <span class="preprocessor"></span>
00398         <span class="comment">//</span>
00399         <span class="comment">// Debug print code.</span>
00400         <span class="comment">//</span>
00401 
00402     <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
00403         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00404 
00405         <span class="comment">//</span>
00406         <span class="comment">// Debug prompt code.</span>
00407         <span class="comment">//</span>
00408 
00409     <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
00410         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00411 
00412         <span class="comment">//</span>
00413         <span class="comment">// Debug stop code.</span>
00414         <span class="comment">//</span>
00415 
00416     <span class="keywordflow">case</span> DEBUG_STOP_BREAKPOINT:
00417 
00418 <span class="preprocessor">#if DEVL</span>
00419 <span class="preprocessor"></span>
00420         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00421 
00422 <span class="preprocessor">#else</span>
00423 <span class="preprocessor"></span>
00424         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00425             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00426 
00427         } <span class="keywordflow">else</span> {
00428             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00429         }
00430 
00431 <span class="preprocessor">#endif</span>
00432 <span class="preprocessor"></span>
00433         <span class="comment">//</span>
00434         <span class="comment">// Debug load symbols code.</span>
00435         <span class="comment">//</span>
00436 
00437     <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
00438         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00439             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00440 
00441         } <span class="keywordflow">else</span> {
00442             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00443         }
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">// Debug unload symbols code.</span>
00447         <span class="comment">//</span>
00448 
00449     <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
00450         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00451             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00452 
00453         } <span class="keywordflow">else</span> {
00454             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00455         }
00456 
00457         <span class="comment">//</span>
00458         <span class="comment">// All other codes.</span>
00459         <span class="comment">//</span>
00460 
00461     <span class="keywordflow">default</span>:
00462         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00463     }
00464 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="4/ia64/kdtrap.c::KdpStub" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpStub           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html#l00467">467</a> of file <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html">4/ia64/kdtrap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00616">KERNEL_BREAKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00478                    :
00479 
00480     This routine provides a kernel debugger stub routine that catchs debug
00481     prints in checked systems when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not active.
00482 
00483 Arguments:
00484 
00485     TrapFrame - Supplies a pointer to a trap frame that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00486         trap.
00487 
00488     ExceptionFrame - Supplies a pointer to a exception frame that describes
00489         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap.
00490 
00491     ExceptionRecord - Supplies a pointer to an exception record that
00492         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00493 
00494     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00495 
00496     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00497 
00498     SecondChance - Supplies a <span class="keywordtype">boolean</span> value that determines whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00499         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second chance (TRUE) that the exception has been raised.
00500 
00501 Return Value:
00502 
00503     A value of TRUE is returned if the exception is handled. Otherwise a
00504     value of FALSE is returned.
00505 
00506 --*/
00507 
00508 {
00509 
00510     ULONG_PTR BreakpointCode;
00511 <span class="preprocessor">#ifdef _GAMBIT_</span>
00512 <span class="preprocessor"></span>    PHYSICAL_ADDRESS PAddress;
00513 <span class="preprocessor">#endif // _GAMBIT_</span>
00514 <span class="preprocessor"></span>
00515     <span class="comment">//</span>
00516     <span class="comment">// Isolate the breakpoint code from the breakpoint instruction which</span>
00517     <span class="comment">// is stored by the exception dispatch code in the information field</span>
00518     <span class="comment">// of the exception record.</span>
00519     <span class="comment">//</span>
00520 
00521     BreakpointCode = (ULONG) ExceptionRecord-&gt;ExceptionInformation[0];
00522 
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">// If the breakpoint is a debug print, debug load symbols, or debug</span>
00526     <span class="comment">// unload symbols, then return TRUE. Otherwise, return FALSE;</span>
00527     <span class="comment">//</span>
00528 
00529     <span class="keywordflow">if</span> ((BreakpointCode == DEBUG_PRINT_BREAKPOINT) ||
00530         (BreakpointCode == DEBUG_LOAD_SYMBOLS_BREAKPOINT) ||
00531         (BreakpointCode == DEBUG_UNLOAD_SYMBOLS_BREAKPOINT)) {
00532 
00533         <span class="comment">//</span>
00534         <span class="comment">// Advance to next instruction slot so that the BREAK instruction</span>
00535         <span class="comment">// does not get re-executed</span>
00536         <span class="comment">//</span>
00537 
00538         RtlIa64IncrementIP((ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress &gt;&gt; 2,
00539                           ContextRecord-&gt;StIPSR,
00540                           ContextRecord-&gt;StIIP);
00541 
00542 
00543 <span class="preprocessor">#ifdef _GAMBIT_</span>
00544 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (BreakpointCode == DEBUG_PRINT_BREAKPOINT) {
00545             <span class="keywordflow">if</span> ((PUCHAR)ContextRecord-&gt;IntT0) {
00546                 PAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> ((PUCHAR)ContextRecord-&gt;IntT0);
00547                 <span class="keywordflow">if</span> (PAddress.QuadPart != 0ULL) {
00548                     SscDbgPrintf((PVOID)PAddress.QuadPart);
00549                 }
00550             }
00551         }
00552 <span class="preprocessor">#endif // _GAMBIT_</span>
00553 <span class="preprocessor"></span>
00554         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00555 
00556     } <span class="keywordflow">else</span> {
00557         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00558     }
00559 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="4/ia64/kdtrap.c::KdpTrap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpTrap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html#l00030">30</a> of file <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html">4/ia64/kdtrap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00617">BREAKIN_BREAKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00133">KdDebuggerNotPresent</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00277">KdEnterDebugger()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00355">KdExitDebugger()</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00414">KdLogDbgPrint()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00261">KdpControlCPressed</a>, <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00030">KdpPrintString()</a>, <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00110">KdpPromptString()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02351">KdpReportExceptionStateChange()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02434">KdpReportLoadSymbolsStateChange()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d9/d6/ppc_2ipi_8c.html#a0">KiRestoreProcessorControlState()</a>, <a class="el" href="../../d6/d0/xxmpipi_8c-source.html#l00124">KiSaveProcessorControlState()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00041                    :
00042 
00043     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dispatched and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel
00044     debugger <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> active.
00045 
00046 Arguments:
00047 
00048     TrapFrame - Supplies a pointer to a trap frame that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00049         trap.
00050 
00051     ExceptionFrame - Supplies a pointer to a exception frame that describes
00052         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap.
00053 
00054     ExceptionRecord - Supplies a pointer to an exception record that
00055         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00056 
00057     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00058 
00059     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00060 
00061     SecondChance - Supplies a <span class="keywordtype">boolean</span> value that determines whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00062         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second chance (TRUE) that the exception has been raised.
00063 
00064 Return Value:
00065 
00066     A value of TRUE is returned if the exception is handled. Otherwise a
00067     value of FALSE is returned.
00068 
00069 --*/
00070 
00071 {
00072 
00073     BOOLEAN Completion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00074     BOOLEAN Enable;
00075     BOOLEAN UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00076     ULONGLONG OldStIIP, OldStIPSR;
00077     STRING Input;
00078     STRING Output;
00079     PKPRCB Prcb;
00080 
00081     <span class="comment">//</span>
00082     <span class="comment">// Synchronize processor execution, save processor state, enter debugger,</span>
00083     <span class="comment">// and flush the current TB.</span>
00084     <span class="comment">//</span>
00085 
00086     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00087 
00088     <span class="comment">//</span>
00089     <span class="comment">// If this is a breakpoint instruction, then check to determine if is</span>
00090     <span class="comment">// an internal command.</span>
00091     <span class="comment">//</span>
00092 
00093     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00094         (ExceptionRecord-&gt;ExceptionInformation[0] &gt;= DEBUG_PRINT_BREAKPOINT)) {
00095 
00096         <span class="comment">//</span>
00097         <span class="comment">// Switch on the breakpoint code.</span>
00098         <span class="comment">//</span>
00099 
00100         <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0]) {
00101 
00102             <span class="comment">//</span>
00103             <span class="comment">// Print a debug string.</span>
00104             <span class="comment">//</span>
00105             <span class="comment">// Arguments: IA64 passes arguments via RSE not GR's. Since arguments are not</span>
00106             <span class="comment">//            part of CONTEXT struct, they need to be copies Temp registers.</span>
00107             <span class="comment">//            (see NTOS/RTL/IA64/DEBUGSTB.S)</span>
00108             <span class="comment">//</span>
00109             <span class="comment">//   T0 - Supplies a pointer to an output string buffer.</span>
00110             <span class="comment">//   T1 - Supplies the length of the output string buffer.</span>
00111             <span class="comment">//</span>
00112 
00113         <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
00114 
00115             <span class="comment">//</span>
00116             <span class="comment">// Advance to next instruction slot so that the BREAK instruction</span>
00117             <span class="comment">// does not get re-executed</span>
00118             <span class="comment">//</span>
00119 
00120             RtlIa64IncrementIP((ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress &gt;&gt; 2,
00121                                ContextRecord-&gt;StIPSR,
00122                                ContextRecord-&gt;StIIP);
00123 
00124             Output.Buffer = (PCHAR)ContextRecord-&gt;IntT0;
00125             Output.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;IntT1;
00126 
00127             <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(&amp;Output);
00128 
00129             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00130 
00131                 Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00132                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a102">KdpPrintString</a>(&amp;Output)) {
00133                     ContextRecord-&gt;IntV0 = (ULONG)STATUS_BREAKPOINT;
00134 
00135                 } <span class="keywordflow">else</span> {
00136                     ContextRecord-&gt;IntV0 = (ULONG)STATUS_SUCCESS;
00137                 }
00138                 <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00139 
00140             } <span class="keywordflow">else</span> {
00141                 ContextRecord-&gt;IntV0 = (ULONG)STATUS_DEVICE_NOT_CONNECTED;
00142             }
00143 
00144             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00145 
00146             <span class="comment">//</span>
00147             <span class="comment">// Print a debug prompt string, then input a string.</span>
00148             <span class="comment">//</span>
00149             <span class="comment">//   T0 - Supplies a pointer to an output string buffer.</span>
00150             <span class="comment">//   T1 - Supplies the length of the output string buffer..</span>
00151             <span class="comment">//   T2 - supplies a pointer to an input string buffer.</span>
00152             <span class="comment">//   T3 - Supplies the length of the input string bufffer.</span>
00153             <span class="comment">//</span>
00154 
00155         <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
00156 
00157             <span class="comment">//</span>
00158             <span class="comment">// Advance to next instruction slot so that the BREAK instruction</span>
00159             <span class="comment">// does not get re-executed</span>
00160             <span class="comment">//</span>
00161 
00162             RtlIa64IncrementIP((ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress &gt;&gt; 2,
00163                                ContextRecord-&gt;StIPSR,
00164                                ContextRecord-&gt;StIIP);
00165 
00166             Output.Buffer = (PCHAR)ContextRecord-&gt;IntT0;
00167             Output.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;IntT1;
00168             Input.Buffer = (PCHAR)ContextRecord-&gt;IntT2;
00169             Input.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;IntT3;
00170 
00171             <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(&amp;Output);
00172 
00173             Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00174 
00175             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a103">KdpPromptString</a>(&amp;Output, &amp;Input);
00176 
00177             ContextRecord-&gt;IntV0 = Input.Length;
00178 
00179             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00180             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00181 
00182             <span class="comment">//</span>
00183             <span class="comment">// Load the symbolic information for an image.</span>
00184             <span class="comment">//</span>
00185             <span class="comment">// Arguments:</span>
00186             <span class="comment">//</span>
00187             <span class="comment">//    T0 - Supplies a pointer to an output string descriptor.</span>
00188             <span class="comment">//    T1 - Supplies a the base address of the image.</span>
00189             <span class="comment">//</span>
00190 
00191         <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
00192             UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00193 
00194             <span class="comment">//</span>
00195             <span class="comment">// Fall through</span>
00196             <span class="comment">//</span>
00197 
00198         <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
00199     
00200             <span class="comment">//</span>
00201             <span class="comment">// Advance to next instruction slot so that the BREAK instruction</span>
00202             <span class="comment">// does not get re-executed</span>
00203             <span class="comment">//</span>
00204 
00205             Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00206             Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00207             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00208             OldStIPSR = ContextRecord-&gt;StIPSR;
00209             OldStIIP = ContextRecord-&gt;StIIP;
00210             RtlCopyMemory(&amp;Prcb-&gt;ProcessorState.ContextFrame,
00211                           ContextRecord,
00212                           <span class="keyword">sizeof</span>(CONTEXT));
00213 
00214             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00215                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a121">KdpReportLoadSymbolsStateChange</a>((PSTRING)ContextRecord-&gt;IntT0,
00216                                                 (<a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a>) ContextRecord-&gt;IntT1,
00217                                                 UnloadSymbols,
00218                                                 &amp;Prcb-&gt;ProcessorState.ContextFrame);
00219 
00220             }
00221 
00222             RtlCopyMemory(ContextRecord,
00223                           &amp;Prcb-&gt;ProcessorState.ContextFrame,
00224                           <span class="keyword">sizeof</span>(CONTEXT));
00225 
00226             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a0">KiRestoreProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00227             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00228 
00229             <span class="comment">//</span>
00230             <span class="comment">// If the kernel debugger did not update the IP, then increment</span>
00231             <span class="comment">// past the breakpoint instruction.</span>
00232             <span class="comment">//</span>
00233 
00234             <span class="keywordflow">if</span> ((ContextRecord-&gt;StIIP == OldStIIP) &amp;&amp;
00235                 ((ContextRecord-&gt;StIPSR &amp; IPSR_RI_MASK) == (OldStIPSR &amp; IPSR_RI_MASK))) { 
00236                 RtlIa64IncrementIP((ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress &gt;&gt; 2,
00237                                ContextRecord-&gt;StIPSR,
00238                                ContextRecord-&gt;StIIP);
00239             }
00240 
00241             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00242 
00243             <span class="comment">//</span>
00244             <span class="comment">// Kernel breakin break</span>
00245             <span class="comment">//</span>
00246 
00247         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a454">BREAKIN_BREAKPOINT</a>:
00248 
00249            <span class="comment">//</span>
00250            <span class="comment">// Advance to next instruction slot so that the BREAK instruction</span>
00251            <span class="comment">// does not get re-executed</span>
00252            <span class="comment">//</span>
00253 
00254            RtlIa64IncrementIP((ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress &gt;&gt; 2,
00255                               ContextRecord-&gt;StIPSR,
00256                               ContextRecord-&gt;StIIP);
00257            <span class="keywordflow">break</span>;
00258 
00259             <span class="comment">//</span>
00260             <span class="comment">// Unknown internal command.</span>
00261             <span class="comment">//</span>
00262 
00263         <span class="keywordflow">default</span>:
00264             <span class="keywordflow">break</span>;
00265         }
00266 
00267     }
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Get here if single step or BREAKIN breakpoint</span>
00271     <span class="comment">//</span>
00272 
00273     <span class="keywordflow">if</span>  ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) ||
00274           (ExceptionRecord-&gt;ExceptionCode == STATUS_SINGLE_STEP)  ||
00275           (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_STOP_ON_EXCEPTION) ||
00276           SecondChance) {
00277 
00278          <span class="comment">//</span>
00279          <span class="comment">// Report state change to kernel debugger on host</span>
00280          <span class="comment">//</span>
00281 
00282          Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00283          Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00284          <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00285           
00286          RtlCopyMemory(&amp;Prcb-&gt;ProcessorState.ContextFrame,
00287                           ContextRecord,
00288                           sizeof (CONTEXT));
00289       
00290          Completion = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a120">KdpReportExceptionStateChange</a>(
00291                           ExceptionRecord,
00292                           &amp;Prcb-&gt;ProcessorState.ContextFrame,
00293                           SecondChance);
00294       
00295          RtlCopyMemory(ContextRecord,
00296                           &amp;Prcb-&gt;ProcessorState.ContextFrame,
00297                           sizeof (CONTEXT));
00298       
00299          <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a0">KiRestoreProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00300          <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00301       
00302       
00303          <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00304      
00305     } <span class="keywordflow">else</span> {
00306 
00307          <span class="comment">//</span>
00308          <span class="comment">// This is real exception that user doesn't want to see,</span>
00309          <span class="comment">// so do NOT report it to debugger.</span>
00310          <span class="comment">//</span>
00311 
00312          <span class="comment">// return FALSE;</span>
00313     }
00314 
00315     <span class="comment">//</span>
00316     <span class="comment">// Always return TRUE if this is the first chance to handle the</span>
00317     <span class="comment">// exception.  Otherwise, return the completion status of the</span>
00318     <span class="comment">// state change reporting.</span>
00319     <span class="comment">//</span>
00320 
00321     <span class="keywordflow">if</span>( SecondChance ){
00322         <span class="keywordflow">return</span> Completion;
00323     } <span class="keywordflow">else</span> {
00324         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00325     }
00326 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
