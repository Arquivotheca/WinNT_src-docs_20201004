<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psctx.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psctx.c</h1><a href="../../d2/d0/psctx_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    psctx.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This procedure implements Get/Set Context Thread</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 25-May-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00022 
00023 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00024 <a class="code" href="../../d2/d0/psctx_8c.html#a0">PspQueueApcSpecialApc</a>(
00025     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00026     IN PKNORMAL_ROUTINE *NormalRoutine,
00027     IN PVOID *NormalContext,
00028     IN PVOID *SystemArgument1,
00029     IN PVOID *SystemArgument2
00030     );
00031 
00032 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtGetContextThread)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetContextThread)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueueApcThread)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspQueueApcSpecialApc )</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00040"></a><a class="code" href="../../d2/d0/psctx_8c.html#a0">00040</a> <a class="code" href="../../d2/d0/psctx_8c.html#a0">PspQueueApcSpecialApc</a>(
00041     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00042     IN PKNORMAL_ROUTINE *NormalRoutine,
00043     IN PVOID *NormalContext,
00044     IN PVOID *SystemArgument1,
00045     IN PVOID *SystemArgument2
00046     )
00047 {
00048     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00049 
00050     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
00051 }
00052 
00053 NTSYSAPI
00054 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00055 NTAPI
<a name="l00056"></a><a class="code" href="../../d2/d0/psctx_8c.html#a1">00056</a> <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
00057     IN HANDLE ThreadHandle,
00058     IN PPS_APC_ROUTINE ApcRoutine,
00059     IN PVOID ApcArgument1,
00060     IN PVOID ApcArgument2,
00061     IN PVOID ApcArgument3
00062     )
00063 
00064 <span class="comment">/*++</span>
00065 <span class="comment"></span>
00066 <span class="comment">Routine Description:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    This function is used to queue a user-mode APC to the specified thread. The APC</span>
00069 <span class="comment">    will fire when the specified thread does an alertable wait</span>
00070 <span class="comment"></span>
00071 <span class="comment">Arguments:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    ThreadHandle - Supplies a handle to a thread object.  The caller</span>
00074 <span class="comment">        must have THREAD_SET_CONTEXT access to the thread.</span>
00075 <span class="comment"></span>
00076 <span class="comment">    ApcRoutine - Supplies the address of the APC routine to execute when the</span>
00077 <span class="comment">        APC fires.</span>
00078 <span class="comment"></span>
00079 <span class="comment">    ApcArgument1 - Supplies the first PVOID passed to the APC</span>
00080 <span class="comment"></span>
00081 <span class="comment">    ApcArgument2 - Supplies the second PVOID passed to the APC</span>
00082 <span class="comment"></span>
00083 <span class="comment">    ApcArgument3 - Supplies the third PVOID passed to the APC</span>
00084 <span class="comment"></span>
00085 <span class="comment">Return Value:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    Returns an NT Status code indicating success or failure of the API</span>
00088 <span class="comment"></span>
00089 <span class="comment">--*/</span>
00090 
00091 {
00092     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00094     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> Mode;
00095     KIRQL Irql;
00096     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00097 
00098     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00099 
00100     Mode = KeGetPreviousMode();
00101 
00102     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00103             <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00104             THREAD_SET_CONTEXT,
00105             <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00106             Mode,
00107             (PVOID *)&amp;Thread,
00108             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00109             );
00110 
00111     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00112         st = STATUS_SUCCESS;
00113         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00114             st = STATUS_INVALID_HANDLE;
00115             }
00116         <span class="keywordflow">else</span> {
00117             Apc = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(
00118                     (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a> | <a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>),
00119                     <span class="keyword">sizeof</span>(*Apc),
00120                     'pasP'
00121                     );
00122 
00123             <span class="keywordflow">if</span> ( !Apc ) {
00124                 st = STATUS_NO_MEMORY;
00125                 }
00126             <span class="keywordflow">else</span> {
00127                 <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(
00128                     Apc,
00129                     &amp;Thread-&gt;Tcb,
00130                     <a class="code" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>,
00131                     <a class="code" href="../../d2/d0/psctx_8c.html#a0">PspQueueApcSpecialApc</a>,
00132                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00133                     (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)ApcRoutine,
00134                     <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00135                     ApcArgument1
00136                     );
00137 
00138                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(Apc,ApcArgument2,ApcArgument3,0) ) {
00139                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
00140                     st = STATUS_UNSUCCESSFUL;
00141                     }
00142                 }
00143             }
00144         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00145         }
00146 
00147     <span class="keywordflow">return</span> st;
00148 }
00149 
00150 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00151"></a><a class="code" href="../../d2/d0/psctx_8c.html#a2">00151</a> <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>(
00152     IN HANDLE ThreadHandle,
00153     IN OUT PCONTEXT ThreadContext
00154     )
00155 
00156 <span class="comment">/*++</span>
00157 <span class="comment"></span>
00158 <span class="comment">Routine Description:</span>
00159 <span class="comment"></span>
00160 <span class="comment">    This function returns the usermode context of the specified thread. This</span>
00161 <span class="comment">    function will fail if the specified thread is a system thread. It will</span>
00162 <span class="comment">    return the wrong answer if the thread is a non-system thread that does</span>
00163 <span class="comment">    not execute in user-mode.</span>
00164 <span class="comment"></span>
00165 <span class="comment">Arguments:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    ThreadHandle - Supplies an open handle to the thread object from</span>
00168 <span class="comment">                   which to retrieve context information.  The handle</span>
00169 <span class="comment">                   must allow THREAD_GET_CONTEXT access to the thread.</span>
00170 <span class="comment"></span>
00171 <span class="comment">    ThreadContext - Supplies the address of a buffer that will receive</span>
00172 <span class="comment">                    the context of the specified thread.</span>
00173 <span class="comment"></span>
00174 <span class="comment">Return Value:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    None.</span>
00177 <span class="comment"></span>
00178 <span class="comment">--*/</span>
00179 
00180 {
00181 
00182     ULONG Alignment;
00183     ULONG ContextFlags;
00184     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a> ContextFrame;
00185     ULONG ContextLength;
00186     KIRQL Irql;
00187     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> Mode;
00188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00189     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00190 
00191     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Get previous mode and reference specified thread.</span>
00195     <span class="comment">//</span>
00196 
00197     Mode = KeGetPreviousMode();
00198     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00199                                    THREAD_GET_CONTEXT,
00200                                    <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00201                                    Mode,
00202                                    (PVOID *)&amp;Thread,
00203                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00204 
00205     <span class="comment">//</span>
00206     <span class="comment">// If the reference was successful, the check if the specified thread</span>
00207     <span class="comment">// is a system thread.</span>
00208     <span class="comment">//</span>
00209 
00210     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00211 
00212         <span class="comment">//</span>
00213         <span class="comment">// If the thread is not a system thread, then attempt to get the</span>
00214         <span class="comment">// context of the thread.</span>
00215         <span class="comment">//</span>
00216 
00217         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00218 
00219             <span class="comment">//</span>
00220             <span class="comment">// Attempt to get the context of the specified thread.</span>
00221             <span class="comment">//</span>
00222 
00223             <span class="keywordflow">try</span> {
00224 
00225                 <span class="comment">//</span>
00226                 <span class="comment">// Set the default alignment, capture the context flags,</span>
00227                 <span class="comment">// and set the default size of the context record.</span>
00228                 <span class="comment">//</span>
00229 
00230                 Alignment = CONTEXT_ALIGN;
00231                 ContextFlags = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>(&amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;ContextFlags);
00232                 ContextLength = <span class="keyword">sizeof</span>(CONTEXT);
00233 
00234 <span class="preprocessor">#if defined(_X86_)</span>
00235 <span class="preprocessor"></span>                <span class="comment">//</span>
00236                 <span class="comment">// CONTEXT_EXTENDED_REGISTERS is SET, then we want sizeof(CONTEXT) set above</span>
00237                 <span class="comment">// otherwise (not set) we only want the old part of the context record.</span>
00238                 <span class="comment">//</span>
00239                 <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_EXTENDED_REGISTERS) != CONTEXT_EXTENDED_REGISTERS) {
00240                     ContextLength = FIELD_OFFSET(CONTEXT, ExtendedRegisters);
00241                 }
00242 <span class="preprocessor">#endif</span>
00243 <span class="preprocessor"></span>
00244 <span class="preprocessor">#if defined(_MIPS_)</span>
00245 <span class="preprocessor"></span>
00246                 <span class="comment">//</span>
00247                 <span class="comment">// The following code is included for backward compatibility</span>
00248                 <span class="comment">// with old code that does not understand extended context</span>
00249                 <span class="comment">// records on MIPS systems.</span>
00250                 <span class="comment">//</span>
00251 
00252                 <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00253                     Alignment = <span class="keyword">sizeof</span>(ULONG);
00254                     ContextLength = FIELD_OFFSET(CONTEXT, ContextFlags) + 4;
00255                 }
00256 
00257 <span class="preprocessor">#endif</span>
00258 <span class="preprocessor"></span>
00259                 <span class="keywordflow">if</span> (Mode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00260                     <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>, ContextLength, Alignment);
00261                 }
00262 
00263             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00264                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00265             }
00266 
00267             <span class="comment">//</span>
00268             <span class="comment">// If an exception did not occur during the probe of the thread</span>
00269             <span class="comment">// context, then get the context of the target thread.</span>
00270             <span class="comment">//</span>
00271 
00272             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00273                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,
00274                                   NotificationEvent,
00275                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00276 
00277                 ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>.ContextFlags = ContextFlags;
00278 
00279                 ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a> = Mode;
00280                 <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
00281                     ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00282                     ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a> = Thread;
00283                     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;Irql);
00284                     <a class="code" href="../../d8/d1/psp_8h.html#a74">PspGetSetContextSpecialApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>,
00285                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00286                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00287                                                &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>,
00288                                                &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>);
00289 
00290                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(Irql);
00291 
00292                     <span class="comment">//</span>
00293                     <span class="comment">// Move context to specfied context record. If an exception</span>
00294                     <span class="comment">// occurs, then silently handle it and return success.</span>
00295                     <span class="comment">//</span>
00296 
00297                     <span class="keywordflow">try</span> {
00298                         RtlMoveMemory(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>,
00299                                       &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,
00300                                       ContextLength);
00301 
00302                     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00303                     }
00304 
00305                 } <span class="keywordflow">else</span> {
00306                     <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>,
00307                                     &amp;Thread-&gt;Tcb,
00308                                     <a class="code" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>,
00309                                     <a class="code" href="../../d3/d0/psctx386_8c.html#a4">PspGetSetContextSpecialApc</a>,
00310                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00311                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00312                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00313                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00314 
00315                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Thread, 2)) {
00316                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00317 
00318                     } <span class="keywordflow">else</span> {
00319                         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,
00320                                               <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00321                                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00322                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00323                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00324                         <span class="comment">//</span>
00325                         <span class="comment">// Move context to specfied context record. If an</span>
00326                         <span class="comment">// exception occurs, then silently handle it and</span>
00327                         <span class="comment">// return success.</span>
00328                         <span class="comment">//</span>
00329 
00330                         <span class="keywordflow">try</span> {
00331                             RtlMoveMemory(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>,
00332                                           &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,
00333                                           ContextLength);
00334 
00335                         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00336                         }
00337                     }
00338                 }
00339             }
00340 
00341         } <span class="keywordflow">else</span> {
00342             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00343         }
00344 
00345         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00346     }
00347 
00348     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00349 }
00350 
00351 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00352"></a><a class="code" href="../../d2/d0/psctx_8c.html#a3">00352</a> <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>(
00353     IN HANDLE ThreadHandle,
00354     IN PCONTEXT ThreadContext
00355     )
00356 
00357 <span class="comment">/*++</span>
00358 <span class="comment"></span>
00359 <span class="comment">Routine Description:</span>
00360 <span class="comment"></span>
00361 <span class="comment">    This function sets the usermode context of the specified thread. This</span>
00362 <span class="comment">    function will fail if the specified thread is a system thread. It will</span>
00363 <span class="comment">    return the wrong answer if the thread is a non-system thread that does</span>
00364 <span class="comment">    not execute in user-mode.</span>
00365 <span class="comment"></span>
00366 <span class="comment">Arguments:</span>
00367 <span class="comment"></span>
00368 <span class="comment">    ThreadHandle - Supplies an open handle to the thread object from</span>
00369 <span class="comment">                   which to retrieve context information.  The handle</span>
00370 <span class="comment">                   must allow THREAD_SET_CONTEXT access to the thread.</span>
00371 <span class="comment"></span>
00372 <span class="comment">    ThreadContext - Supplies the address of a buffer that contains new</span>
00373 <span class="comment">                    context for the specified thread.</span>
00374 <span class="comment"></span>
00375 <span class="comment">Return Value:</span>
00376 <span class="comment"></span>
00377 <span class="comment">    None.</span>
00378 <span class="comment"></span>
00379 <span class="comment">--*/</span>
00380 
00381 {
00382 
00383     ULONG Alignment;
00384     ULONG ContextFlags;
00385     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a> ContextFrame;
00386     ULONG ContextLength;
00387     KIRQL Irql;
00388     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> Mode;
00389     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00390     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00391 
00392     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Get previous mode and reference specified thread.</span>
00396     <span class="comment">//</span>
00397 
00398     Mode = KeGetPreviousMode();
00399     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00400                                        THREAD_SET_CONTEXT,
00401                                        <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00402                                        Mode,
00403                                        (PVOID *)&amp;Thread,
00404                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00405 
00406     <span class="comment">//</span>
00407     <span class="comment">// If the reference was successful, the check if the specified thread</span>
00408     <span class="comment">// is a system thread.</span>
00409     <span class="comment">//</span>
00410 
00411     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00412 
00413         <span class="comment">//</span>
00414         <span class="comment">// If the thread is not a system thread, then attempt to get the</span>
00415         <span class="comment">// context of the thread.</span>
00416         <span class="comment">//</span>
00417 
00418         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00419 
00420             <span class="comment">//</span>
00421             <span class="comment">// Attempt to get the context of the specified thread.</span>
00422             <span class="comment">//</span>
00423 
00424             <span class="keywordflow">try</span> {
00425 
00426                 <span class="comment">//</span>
00427                 <span class="comment">// Set the default alignment, capture the context flags,</span>
00428                 <span class="comment">// and set the default size of the context record.</span>
00429                 <span class="comment">//</span>
00430 
00431                 Alignment = CONTEXT_ALIGN;
00432                 ContextFlags = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>(&amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;ContextFlags);
00433                 ContextLength = <span class="keyword">sizeof</span>(CONTEXT);
00434 
00435 <span class="preprocessor">#if defined(_X86_)</span>
00436 <span class="preprocessor"></span>                <span class="comment">//</span>
00437                 <span class="comment">// CONTEXT_EXTENDED_REGISTERS is SET, then we want sizeof(CONTEXT) set above</span>
00438                 <span class="comment">// otherwise (not set) we only want the old part of the context record.</span>
00439                 <span class="comment">//</span>
00440                 <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_EXTENDED_REGISTERS) != CONTEXT_EXTENDED_REGISTERS) {
00441                     ContextLength = FIELD_OFFSET(CONTEXT, ExtendedRegisters);
00442                 }
00443 <span class="preprocessor">#endif</span>
00444 <span class="preprocessor"></span>
00445 <span class="preprocessor">#if defined(_MIPS_)</span>
00446 <span class="preprocessor"></span>
00447                 <span class="comment">//</span>
00448                 <span class="comment">// The following code is included for backward compatibility</span>
00449                 <span class="comment">// with old code that does not understand extended context</span>
00450                 <span class="comment">// records on MIPS systems.</span>
00451                 <span class="comment">//</span>
00452 
00453                 <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00454                     Alignment = <span class="keyword">sizeof</span>(ULONG);
00455                     ContextLength = FIELD_OFFSET(CONTEXT, ContextFlags) + 4;
00456                 }
00457 
00458 <span class="preprocessor">#endif</span>
00459 <span class="preprocessor"></span>
00460                 <span class="keywordflow">if</span> (Mode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00461                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>, ContextLength, Alignment);
00462                 }
00463 
00464                 RtlMoveMemory(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>, <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>, ContextLength);
00465 
00466             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00467                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00468             }
00469 
00470             <span class="comment">//</span>
00471             <span class="comment">// If an exception did not occur during the probe of the thread</span>
00472             <span class="comment">// context, then set the context of the target thread.</span>
00473             <span class="comment">//</span>
00474 
00475             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00476                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,
00477                                   NotificationEvent,
00478                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00479 
00480                 ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>.ContextFlags = ContextFlags;
00481 
00482                 ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a> = Mode;
00483                 <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
00484                     ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a> = (PVOID)1;
00485                     ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a> = Thread;
00486                     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;Irql);
00487                     <a class="code" href="../../d8/d1/psp_8h.html#a74">PspGetSetContextSpecialApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>,
00488                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00489                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00490                                                &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>,
00491                                                &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>);
00492 
00493                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(Irql);
00494 
00495                 } <span class="keywordflow">else</span> {
00496                     <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>,
00497                                     &amp;Thread-&gt;Tcb,
00498                                     <a class="code" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>,
00499                                     <a class="code" href="../../d3/d0/psctx386_8c.html#a4">PspGetSetContextSpecialApc</a>,
00500                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00501                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00502                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00503                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00504 
00505                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>, (PVOID)1, Thread, 2)) {
00506                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00507 
00508                     } <span class="keywordflow">else</span> {
00509                         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,
00510                                               <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00511                                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00512                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00513                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00514                     }
00515                 }
00516             }
00517 
00518         } <span class="keywordflow">else</span> {
00519             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00520         }
00521 
00522         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00523     }
00524 
00525     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00526 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:31 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
