<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivefree.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivefree.c</h1><a href="../../d2/d1/hivefree_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hivefree.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Hive free code</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 30-Mar-92</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment">    Dragos C. Sambotin (dragoss) 25-Jan-99</span>
00022 <span class="comment">        Implementation of bin-size chunk loading of hives.</span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00026 
00027 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvFreeHive)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvFreeHivePartial)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span>
00032 
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00034"></a><a class="code" href="../../d2/d1/hivefree_8c.html#a0">00034</a> <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>(
00035     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive
00036     )
00037 <span class="comment">/*++</span>
00038 <span class="comment"></span>
00039 <span class="comment">Routine Description:</span>
00040 <span class="comment"></span>
00041 <span class="comment">    Free all of the pieces of a hive.</span>
00042 <span class="comment"></span>
00043 <span class="comment">Arguments:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    Hive - supplies a pointer to hive control structure for hive to free.</span>
00046 <span class="comment">            this structure itself will NOT be freed, but everything it</span>
00047 <span class="comment">            points to will.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Return Value:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    NONE.</span>
00052 <span class="comment"></span>
00053 <span class="comment">--*/</span>
00054 {
00055     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir;
00056     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00057     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Address;
00058     ULONG           Type;
00059     ULONG           Length;
00060     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00061     ULONG           Tables;
00062     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>      FreeBin;
00063 
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00065     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00066     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> == 0);
00067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> == 1);
00068 
00069     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a25">CML_BIN</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a40">CMS_BIN_MAP</a>) {
00070         KdPrint((<span class="stringliteral">"HvFreeHive(%ws) :\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>));
00071     }
00072     <span class="comment">//</span>
00073     <span class="comment">// Iterate through both types of storage</span>
00074     <span class="comment">//</span>
00075     <span class="keywordflow">for</span> (Type = 0; Type &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>; Type++) {
00076 
00077         Address = <a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type;
00078         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length + (<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type);
00079 
00080         <span class="keywordflow">if</span> (Length &gt; (<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type)) {
00081 
00082             <span class="comment">//</span>
00083             <span class="comment">// Sweep through bin set</span>
00084             <span class="comment">//</span>
00085             <span class="keywordflow">do</span> {
00086                 Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Address);
00087                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Address);
00088                 <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
00089                     <span class="comment">//</span>
00090                     <span class="comment">// hbin is either discarded or discardable, check the tombstone</span>
00091                     <span class="comment">//</span>
00092                     FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00093                     Address += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00094                     <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00095                         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>), FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00096                     }
00097                     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00098                 } <span class="keywordflow">else</span> {
00099                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00100                     Address += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>;
00101 <span class="preprocessor">#if DBG</span>
00102 <span class="preprocessor"></span>                    <span class="comment">//</span>
00103                     <span class="comment">// Make sure that the next bin in the list is</span>
00104                     <span class="comment">// actually the start of an alloc before freeing it</span>
00105                     <span class="comment">//</span>
00106                     <span class="keywordflow">if</span> (Address &lt; Length) {
00107                         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Address);
00108                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Address);
00109                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>);
00110                     }
00111 <span class="preprocessor">#endif</span>
00112 <span class="preprocessor"></span>
00113                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a25">CML_BIN</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a40">CMS_BIN_MAP</a>) {
00114                         <span class="keywordflow">if</span>( Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> ) {
00115                             KdPrint((<span class="stringliteral">"HvFreeHive: BinAddress = 0x%08lx\t Size = 0x%lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>));
00116                         }
00117                     }
00118 
00119                     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00120                 }
00121 
00122             } <span class="keywordflow">while</span> (Address &lt; Length);
00123 
00124             <span class="comment">//</span>
00125             <span class="comment">// Free map table storage</span>
00126             <span class="comment">//</span>
00127             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length != (<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type));
00128             Tables = (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00129             Dir = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map;
00130             <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Dir, 0, Tables);
00131 
00132             <span class="keywordflow">if</span> (Tables &gt; 0) {
00133                 <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));  <span class="comment">// free dir if it exists</span>
00134             }
00135         }
00136         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length = 0;
00137     }
00138 
00139     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a25">CML_BIN</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a40">CMS_BIN_MAP</a>) {
00140         KdPrint((<span class="stringliteral">"\n"</span>));
00141     }
00142     <span class="comment">//</span>
00143     <span class="comment">// Free the base block</span>
00144     <span class="comment">//</span>
00145     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00146     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Free the dirty vector</span>
00150     <span class="comment">//</span>
00151     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00152         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((PVOID)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer), <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a>);
00153     }
00154 
00155     <span class="keywordflow">return</span>;
00156 }
00157 
00158 
00159 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00160"></a><a class="code" href="../../d2/d1/hivefree_8c.html#a1">00160</a> <a class="code" href="../../d2/d1/hivefree_8c.html#a1">HvFreeHivePartial</a>(
00161     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      Hive,
00162     HCELL_INDEX Start,
00163     HSTORAGE_TYPE Type
00164     )
00165 <span class="comment">/*++</span>
00166 <span class="comment"></span>
00167 <span class="comment">Routine Description:</span>
00168 <span class="comment"></span>
00169 <span class="comment">    Free the memory and associated maps for the end of a hive</span>
00170 <span class="comment">    starting at Start.  The baseblock, hive, etc will not be touched.</span>
00171 <span class="comment"></span>
00172 <span class="comment">Arguments:</span>
00173 <span class="comment"></span>
00174 <span class="comment">    Hive - supplies a pointer to hive control structure for hive to</span>
00175 <span class="comment">            partially free.</span>
00176 <span class="comment"></span>
00177 <span class="comment">    Start - HCELL_INDEX of first bin to free, will free from this</span>
00178 <span class="comment">            bin (inclusive) to the end of the hives stable storage.</span>
00179 <span class="comment"></span>
00180 <span class="comment">    Type - Type of storage (Stable or Volatile) to be freed.</span>
00181 <span class="comment"></span>
00182 <span class="comment">Return Value:</span>
00183 <span class="comment"></span>
00184 <span class="comment">    NONE.</span>
00185 <span class="comment"></span>
00186 <span class="comment">--*/</span>
00187 {
00188     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir;
00189     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00190     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Address;
00191     ULONG           StartTable;
00192     ULONG           Length;
00193     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00194     ULONG           Tables;
00195     ULONG           FirstBit;
00196     ULONG           LastBit;
00197     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>      FreeBin;
00198 
00199     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00200     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00201 
00202     Address = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00203     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length;
00204     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Address &lt;= Length);
00205 
00206     <span class="keywordflow">if</span> (Address == Length) {
00207         <span class="keywordflow">return</span>;
00208     }
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Sweep through bin set</span>
00212     <span class="comment">//</span>
00213     <span class="keywordflow">do</span> {
00214         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Address + (Type*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>));
00215         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Address + (Type*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>));
00216         <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
00217             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00218             <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00219                 <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((PVOID)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>), FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00220             } <span class="keywordflow">else</span> {
00221                 <span class="comment">//</span>
00222                 <span class="comment">// The bin has been freed, but quota is still charged.</span>
00223                 <span class="comment">// Since the file will now shrink, the quota must be</span>
00224                 <span class="comment">// returned here.</span>
00225                 <span class="comment">//</span>
00226                 <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00227             }
00228             RemoveEntryList(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
00229             Address += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00230             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00231 
00232         } <span class="keywordflow">else</span> {
00233             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00234 
00235             Address += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>;
00236             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00237         }
00238     } <span class="keywordflow">while</span> (Address &lt; Length);
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// Free map table storage</span>
00242     <span class="comment">//</span>
00243     Tables = (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00244     Dir = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map;
00245     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt; 0) {
00246         StartTable = ((<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00247     } <span class="keywordflow">else</span> {
00248         StartTable = (ULONG)-1;
00249     }
00250     <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Dir, StartTable+1, Tables);
00251 
00252     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00253 
00254     <span class="keywordflow">if</span> (Type==<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>) {
00255         <span class="comment">//</span>
00256         <span class="comment">// Clear dirty vector for data past Hive-&gt;Storage[Stable].Length</span>
00257         <span class="comment">//</span>
00258         FirstBit = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00259         LastBit = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
00260         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00261         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, FirstBit, LastBit-FirstBit);
00262         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00263     }
00264 
00265     <span class="keywordflow">return</span>;
00266 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
