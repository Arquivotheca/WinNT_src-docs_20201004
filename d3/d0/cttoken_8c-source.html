<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cttoken.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cttoken.c</h1><a href="../../d2/d1/cttoken_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cttoken.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Common token object test routines.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    These routines are used in both kernel and user mode tests.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    This test assumes the security runtime library routines are</span>
00016 <span class="comment">    functioning correctly.</span>
00017 <span class="comment"></span>
00018 <span class="comment">    NOTE:  This test program allocates a lot of memory and frees</span>
00019 <span class="comment">           none of it ! ! !</span>
00020 <span class="comment"></span>
00021 <span class="comment"></span>
00022 <span class="comment"></span>
00023 <span class="comment">Author:</span>
00024 <span class="comment"></span>
00025 <span class="comment">    Jim Kelly       (JimK)     27-June-1990</span>
00026 <span class="comment"></span>
00027 <span class="comment">Environment:</span>
00028 <span class="comment"></span>
00029 <span class="comment">    Test of token object.</span>
00030 <span class="comment"></span>
00031 <span class="comment">Revision History:</span>
00032 <span class="comment"></span>
00033 <span class="comment">--*/</span>
00034 
00035 <span class="preprocessor">#include "<a class="code" href="../../d2/d6/tsecomm_8c.html">tsecomm.c</a>"</span>    <span class="comment">// Mode dependent macros and routines.</span>
00036 
00037 
00038 
00040 <span class="comment">//                                                            //</span>
00041 <span class="comment">// Module wide variables                                      //</span>
00042 <span class="comment">//                                                            //</span>
00044 <span class="comment"></span>
<a name="l00045"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a0">00045</a> <span class="preprocessor">#define DEFAULT_DACL_LENGTH (1024L)</span>
<a name="l00046"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a1">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define GROUP_IDS_LENGTH (1024L)</span>
<a name="l00047"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a2">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define NEW_GROUP_STATE_LENGTH (1024L)</span>
<a name="l00048"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a3">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define PRIVILEGES_LENGTH (128L)</span>
<a name="l00049"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a4">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define TOO_BIG_ACL_SIZE (2048L)</span>
<a name="l00050"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a5">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define TOO_BIG_PRIMARY_GROUP_SIZE (39L)</span>
00051 <span class="preprocessor"></span>
00052 <span class="comment">//</span>
00053 <span class="comment">// definitions related to TokenWithGroups</span>
00054 <span class="comment">// (we also substitute SYSTEM for NEANDERTHOL in some tests)</span>
00055 <span class="comment">//</span>
00056 
<a name="l00057"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a6">00057</a> <span class="preprocessor">#define FLINTSTONE_INDEX  (0L)</span>
<a name="l00058"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a7">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define CHILD_INDEX       (1L)</span>
<a name="l00059"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a8">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define NEANDERTHOL_INDEX (2L)</span>
<a name="l00060"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a9">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSTEM_INDEX      (2L)</span>
<a name="l00061"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a10">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define WORLD_INDEX       (3L)</span>
<a name="l00062"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a11">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define GROUP_COUNT       (4L)</span>
<a name="l00063"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a12">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define RESTRICTED_SID_COUNT (2L)</span>
00064 <span class="preprocessor"></span>
00065 
00066 <span class="comment">//</span>
00067 <span class="comment">// Definitions related to TokenWithPrivileges</span>
00068 <span class="comment">//</span>
00069 
<a name="l00070"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a13">00070</a> <span class="preprocessor">#define UNSOLICITED_INDEX           (0L)</span>
<a name="l00071"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a14">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define SECURITY_INDEX              (1L)</span>
<a name="l00072"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a15">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define ASSIGN_PRIMARY_INDEX        (2L)</span>
<a name="l00073"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a16">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define PRIVILEGE_COUNT             (3L)</span>
00074 <span class="preprocessor"></span>
00075 
00076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00077 
<a name="l00078"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a19">00078</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>;
<a name="l00079"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a20">00079</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>;
<a name="l00080"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a21">00080</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a26">TokenWithDefaultOwner</a>;
<a name="l00081"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a22">00081</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>;
<a name="l00082"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a23">00082</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a28">TokenWithDefaultDacl</a>;
00083 
<a name="l00084"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a24">00084</a>     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a24">TokenWithRestrictedGroups</a>;
<a name="l00085"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a25">00085</a>     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a25">TokenWithRestrictedPrivileges</a>;
<a name="l00086"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a26">00086</a>     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a26">TokenWithRestrictedSids</a>;
<a name="l00087"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a27">00087</a>     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a27">TokenWithMoreRestrictedSids</a>;
00088 
00089 
<a name="l00090"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a28">00090</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
<a name="l00091"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a29">00091</a>     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>;
<a name="l00092"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a30">00092</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>;
<a name="l00093"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a31">00093</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a32">AnonymousToken</a>;
00094 
<a name="l00095"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a32">00095</a>     OBJECT_ATTRIBUTES <a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>;
<a name="l00096"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a33">00096</a>     PSECURITY_DESCRIPTOR <a class="code" href="../../d6/d0/ctaccess_8c.html#a34">PrimarySecurityDescriptor</a>;
<a name="l00097"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a34">00097</a>     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d6/d0/ctaccess_8c.html#a35">PrimarySecurityQos</a>;
00098 
<a name="l00099"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a35">00099</a>     OBJECT_ATTRIBUTES <a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>;
<a name="l00100"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a36">00100</a>     PSECURITY_DESCRIPTOR <a class="code" href="../../d6/d0/ctaccess_8c.html#a37">ImpersonationSecurityDescriptor</a>;
<a name="l00101"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a37">00101</a>     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>;
00102 
<a name="l00103"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a38">00103</a>     OBJECT_ATTRIBUTES <a class="code" href="../../d6/d0/ctaccess_8c.html#a39">AnonymousTokenAttributes</a>;
<a name="l00104"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a39">00104</a>     PSECURITY_DESCRIPTOR <a class="code" href="../../d6/d0/ctaccess_8c.html#a40">AnonymousSecurityDescriptor</a>;
<a name="l00105"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a40">00105</a>     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>;
00106 
<a name="l00107"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a41">00107</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
<a name="l00108"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a42">00108</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
<a name="l00109"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a43">00109</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
<a name="l00110"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a44">00110</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00111 
<a name="l00112"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a45">00112</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a46">LengthAvailable</a>;
<a name="l00113"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a46">00113</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>;
00114 
00115 
<a name="l00116"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a47">00116</a>     TIME_FIELDS <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a> = {3000, 1, 1, 1, 1, 1, 1, 1};
<a name="l00117"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a48">00117</a>     LARGE_INTEGER <a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>;
00118 
<a name="l00119"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a49">00119</a>     LUID <a class="code" href="../../d2/d1/cttoken_8c.html#a49">BadAuthenticationId</a>;
<a name="l00120"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a50">00120</a>     LUID <a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a> = SYSTEM_LUID;
<a name="l00121"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a51">00121</a>     LUID <a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a>;
00122 
<a name="l00123"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a52">00123</a>     TOKEN_SOURCE <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a> = {<span class="stringliteral">"SE: TEST"</span>, 0};
00124 
<a name="l00125"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a53">00125</a>     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
<a name="l00126"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a54">00126</a>     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>;
<a name="l00127"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a55">00127</a>     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00128 
<a name="l00129"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a56">00129</a>     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a56">TempOwner</a>;
<a name="l00130"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a57">00130</a>     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a57">TempGroup</a>;
<a name="l00131"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a58">00131</a>     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a58">TempDacl</a>;
00132 
<a name="l00133"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a59">00133</a>     UQUAD <a class="code" href="../../d2/d1/cttoken_8c.html#a59">ThreadStack</a>[256];
<a name="l00134"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a60">00134</a>     INITIAL_TEB <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>;
<a name="l00135"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a18">00135</a>     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
<a name="l00136"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a61">00136</a>     CLIENT_ID <a class="code" href="../../d2/d1/cttoken_8c.html#a61">ThreadClientId</a>;
<a name="l00137"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a62">00137</a>     CONTEXT <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
<a name="l00138"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a63">00138</a>     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
<a name="l00139"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a64">00139</a>     OBJECT_ATTRIBUTES <a class="code" href="../../d2/d1/cttoken_8c.html#a64">ThreadObja</a>;
00140 
00141 
00142 
00143 
00144 
00145 
00147 <span class="comment">//                                                            //</span>
00148 <span class="comment">// Private Macros                                             //</span>
00149 <span class="comment">//                                                            //</span>
00151 <span class="comment"></span>
00152 
<a name="l00153"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a17">00153</a> <span class="preprocessor">#define TestpPrintLuid(G)                                                     \</span>
00154 <span class="preprocessor">            DbgPrint( "(0x%x, 0x%x)", \</span>
00155 <span class="preprocessor">                         (G).HighPart, (G).LowPart);                         \</span>
00156 <span class="preprocessor"></span>
00157 <span class="preprocessor"></span>
00158 
00159 
00161 <span class="comment">//                                                            //</span>
00162 <span class="comment">// Initialization Routine                                     //</span>
00163 <span class="comment">//                                                            //</span>
00165 <span class="comment"></span>
00166 BOOLEAN
<a name="l00167"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a65">00167</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a62">TestTokenInitialize</a>()
00168 {
00169 
00170     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00171     ULONG ReturnLength;
00172     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>;
00173     TOKEN_STATISTICS ProcessTokenStatistics;
00174     PTOKEN_PRIVILEGES NewState;
00175 
00176 
00177     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d6/tsevars_8c.html#a65">TSeVariableInitialization</a>()) {
00178         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:    Failed to initialize global test variables.\n"</span>);
00179         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00180     }
00181 
00182 
00183     <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a> =  (SE_GROUP_ENABLED_BY_DEFAULT);
00184 
00185     <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a> =  (SE_GROUP_ENABLED_BY_DEFAULT |
00186                                 SE_GROUP_ENABLED
00187                                 );
00188     <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a> =    (SE_GROUP_MANDATORY          |
00189                                 SE_GROUP_ENABLED_BY_DEFAULT |
00190                                 SE_GROUP_ENABLED
00191                                 );
00192     <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>  =    (SE_GROUP_MANDATORY          |
00193                                 SE_GROUP_ENABLED_BY_DEFAULT |
00194                                 SE_GROUP_ENABLED            |
00195                                 SE_GROUP_OWNER
00196                                 );
00197 
00198 
00199     <a class="code" href="../../d6/d0/ctaccess_8c.html#a34">PrimarySecurityDescriptor</a> =
00200         (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00201 
00202     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a> (
00203                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a34">PrimarySecurityDescriptor</a>,
00204                  SECURITY_DESCRIPTOR_REVISION1
00205                  ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00206     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a> (
00207                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a34">PrimarySecurityDescriptor</a>,
00208                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                  <span class="comment">//DaclPresent,</span>
00209                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                  <span class="comment">//Dacl OPTIONAL,  // No protection</span>
00210                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>                  <span class="comment">//DaclDefaulted OPTIONAL</span>
00211                  ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00212 
00213 
00214     InitializeObjectAttributes(
00215         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,
00216         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00217         OBJ_INHERIT,
00218         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00219         <a class="code" href="../../d6/d0/ctaccess_8c.html#a34">PrimarySecurityDescriptor</a>
00220         );
00221 
00222 
00223     <a class="code" href="../../d6/d0/ctaccess_8c.html#a37">ImpersonationSecurityDescriptor</a> =
00224         (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00225 
00226     <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>.Length = (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
00227     <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>.ImpersonationLevel = SecurityImpersonation;
00228     <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00229     <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00230 
00231     InitializeObjectAttributes(
00232         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>,
00233         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00234         OBJ_INHERIT,
00235         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00236         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00237         );
00238     <a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>.SecurityQualityOfService =
00239         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>;
00240 
00241 
00242     <a class="code" href="../../d6/d0/ctaccess_8c.html#a40">AnonymousSecurityDescriptor</a> =
00243         (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00244 
00245     <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>.Length = (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
00246     <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>.ImpersonationLevel = SecurityAnonymous;
00247     <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00248     <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00249 
00250     InitializeObjectAttributes(
00251         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a39">AnonymousTokenAttributes</a>,
00252         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00253         OBJ_INHERIT,
00254         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00255         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00256         );
00257     <a class="code" href="../../d6/d0/ctaccess_8c.html#a39">AnonymousTokenAttributes</a>.SecurityQualityOfService =
00258         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>;
00259 
00260 
00261     <span class="comment">//</span>
00262     <span class="comment">// Build an ACL for use.</span>
00263     <span class="comment">//</span>
00264 
00265     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>        = (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00266 
00267     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclRevision=ACL_REVISION;
00268     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;Sbz1=0;
00269     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;Sbz2=0;
00270     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclSize=256;
00271     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount=0;
00272 
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// Set up expiration times</span>
00276     <span class="comment">//</span>
00277 
00278     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Year = 3000;
00279     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Month = 1;
00280     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Day = 1;
00281     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Hour = 1;
00282     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Minute = 1;
00283     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Second = 1;
00284     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Milliseconds = 1;
00285     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Weekday = 1;
00286 
00287     <a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>( &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>, &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a> );
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">// Set up a bad authentication ID</span>
00291     <span class="comment">//</span>
00292 
00293     <a class="code" href="../../d2/d1/cttoken_8c.html#a49">BadAuthenticationId</a> = RtlConvertLongToLuid(1);
00294 
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// Use a token source specific to security test</span>
00298     <span class="comment">//</span>
00299 
00300     <a class="code" href="../../d0/d8/luid_8c.html#a4">NtAllocateLocallyUniqueId</a>( &amp;(<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceIdentifier) );
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">// Create a new thread for impersonation tests</span>
00304     <span class="comment">//</span>
00305 
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// Initialize object attributes.</span>
00309     <span class="comment">// Note that the name of the thread is NULL so that we</span>
00310     <span class="comment">// can run multiple copies of the test at the same time</span>
00311     <span class="comment">// without collisions.</span>
00312     <span class="comment">//</span>
00313 
00314     InitializeObjectAttributes(&amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a64">ThreadObja</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Initialize thread context and initial TEB.</span>
00318     <span class="comment">//</span>
00319 
00320     <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a1">RtlInitializeContext</a>(NtCurrentProcess(),
00321                          &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>,
00322                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00323                          (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a62">TestTokenInitialize</a>,
00324                          &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a59">ThreadStack</a>[254]);
00325 
00326     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>.StackBase = &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a59">ThreadStack</a>[254];
00327     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>.StackLimit = &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a59">ThreadStack</a>[0];
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">// Create a thread in a suspended state.</span>
00331     <span class="comment">//</span>
00332 
00333     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/ps_2create_8c.html#a10">NtCreateThread</a>(&amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00334                             THREAD_ALL_ACCESS,
00335                             &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a64">ThreadObja</a>,
00336                             NtCurrentProcess(),
00337                             &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a61">ThreadClientId</a>,
00338                             &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>,
00339                             &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>,
00340                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00341 
00342     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00343 
00344 
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// The following is sortof a horse-before-the-cart type of initialization.</span>
00348     <span class="comment">// Now that the system is enforcing things like "you can only create a</span>
00349     <span class="comment">// token with an AuthenticationId that the reference monitor has been told</span>
00350     <span class="comment">// about, it is necessary to obtain some information out of our current</span>
00351     <span class="comment">// token.</span>
00352     <span class="comment">//</span>
00353 
00354     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
00355                  NtCurrentProcess(),
00356                  TOKEN_ALL_ACCESS,
00357                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>
00358                  );
00359     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00360     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00361                  <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>,                 <span class="comment">// Handle</span>
00362                  TokenStatistics,              <span class="comment">// TokenInformationClass</span>
00363                  &amp;ProcessTokenStatistics,      <span class="comment">// TokenInformation</span>
00364                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
00365                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
00366                  );
00367     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00368     <a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a> = ProcessTokenStatistics.AuthenticationId;
00369 
00370 
00371     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: enabling AssignPrimary &amp; TCB privileges...\n"</span>);
00372 
00373     NewState = (PTOKEN_PRIVILEGES) TstAllocatePool(
00374                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00375                                     200
00376                                     );
00377 
00378     NewState-&gt;PrivilegeCount = 2;
00379     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a40">CreateTokenPrivilege</a>;
00380     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
00381     NewState-&gt;Privileges[1].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>;
00382     NewState-&gt;Privileges[1].Attributes = SE_PRIVILEGE_ENABLED;
00383 
00384 
00385     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
00386                  <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>,                     <span class="comment">// TokenHandle</span>
00387                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
00388                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
00389                  0,                                <span class="comment">// BufferLength</span>
00390                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
00391                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
00392                  );
00393 
00394     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00395 
00396         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Failed to enable TCB and AssignPrimaryToken privilegs: 0x%x\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00398 
00399     }
00400 
00401     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Done.\n"</span>);
00402 
00403     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00404 }
00405 
00406 
00407 
00409 <span class="comment">//                                                            //</span>
00410 <span class="comment">// Test routines                                              //</span>
00411 <span class="comment">//                                                            //</span>
00413 <span class="comment"></span>
00415 <span class="comment">//                                                            //</span>
00416 <span class="comment">// Token Creation Test                                        //</span>
00417 <span class="comment">//                                                            //</span>
00419 <span class="comment"></span>
00420 BOOLEAN
<a name="l00421"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a66">00421</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a66">TestTokenCreate</a>()
00422 {
00423 
00424     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00425 
00426     TOKEN_USER UserId;
00427     TOKEN_PRIMARY_GROUP PrimaryGroup;
00428     PTOKEN_GROUPS GroupIds;
00429     PTOKEN_PRIVILEGES Privileges;
00430     TOKEN_DEFAULT_DACL DefaultDacl;
00431     TOKEN_DEFAULT_DACL NullDefaultDacl;
00432     TOKEN_OWNER <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00433 
00434     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00435 
00436     GroupIds = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00437                                                <a class="code" href="../../d6/d0/ctaccess_8c.html#a3">GROUP_IDS_LENGTH</a>
00438                                                );
00439 
00440     Privileges = (PTOKEN_PRIVILEGES)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00441                                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a5">PRIVILEGES_LENGTH</a>
00442                                                      );
00443 
00444     DefaultDacl.DefaultDacl = (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00445                                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>
00446                                                      );
00447 
00448 
00449     <span class="comment">//</span>
00450     <span class="comment">// Create the simplest token possible</span>
00451     <span class="comment">// (no Groups, explicit Owner, or DefaultDacl)</span>
00452     <span class="comment">//</span>
00453 
00454     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create Simple Token ...                                "</span>);
00455 
00456     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00457     UserId.User.Attributes = 0;
00458     GroupIds-&gt;GroupCount = 0;
00459     Privileges-&gt;PrivilegeCount = 0;
00460     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00461 
00462 
00463     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00464                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
00465                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00466                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00467                  TokenPrimary,             <span class="comment">// TokenType</span>
00468                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00469                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00470                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00471                  GroupIds,                 <span class="comment">// Group IDs</span>
00472                  Privileges,               <span class="comment">// Privileges</span>
00473                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// Owner</span>
00474                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00475                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// Default Dacl</span>
00476                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00477                  );
00478 
00479     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00480         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00481         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
00482                      NtCurrentProcess(),     <span class="comment">// SourceProcessHandle</span>
00483                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                  <span class="comment">// SourceHandle</span>
00484                      NtCurrentProcess(),     <span class="comment">// TargetProcessHandle</span>
00485                      &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,           <span class="comment">// TargetHandle</span>
00486                      0,                      <span class="comment">// DesiredAccess (over-ridden by option)</span>
00487                      0,                      <span class="comment">// HandleAttributes</span>
00488                      DUPLICATE_SAME_ACCESS   <span class="comment">// Options</span>
00489                      );
00490         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00491         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00492         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00493     } <span class="keywordflow">else</span> {
00494         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00495         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00496         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00497     }
00498 
00499     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00500 
00501 
00502 
00503     <span class="comment">//</span>
00504     <span class="comment">// Create a token with groups</span>
00505     <span class="comment">//</span>
00506 
00507     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create Token With Groups ...                           "</span>);
00508 
00509     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00510 
00511     GroupIds-&gt;Groups[0].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00512     GroupIds-&gt;Groups[1].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00513     GroupIds-&gt;Groups[2].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00514     GroupIds-&gt;Groups[3].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00515 
00516     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00517     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00518     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00519     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00520 
00521 
00522     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00523     UserId.User.Attributes = 0;
00524 
00525     Privileges-&gt;PrivilegeCount = 0;
00526 
00527     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00528 
00529 
00530     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00531                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
00532                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00533                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00534                  TokenPrimary,             <span class="comment">// TokenType</span>
00535                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00536                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00537                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00538                  GroupIds,                 <span class="comment">// Group IDs</span>
00539                  Privileges,               <span class="comment">// Privileges</span>
00540                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// Owner</span>
00541                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00542                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// Default Dacl</span>
00543                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00544                  );
00545 
00546     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00547         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00548         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
00549                      NtCurrentProcess(),     <span class="comment">// SourceProcessHandle</span>
00550                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                  <span class="comment">// SourceHandle</span>
00551                      NtCurrentProcess(),     <span class="comment">// TargetProcessHandle</span>
00552                      &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,       <span class="comment">// TargetHandle</span>
00553                      0,                      <span class="comment">// DesiredAccess (over-ridden by option)</span>
00554                      0,                      <span class="comment">// HandleAttributes</span>
00555                      DUPLICATE_SAME_ACCESS   <span class="comment">// Options</span>
00556                      );
00557         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00558         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00559         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00560     } <span class="keywordflow">else</span> {
00561         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00562         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00563         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00564     }
00565 
00566     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00567 
00568 
00569 
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Create a token with default owner</span>
00573     <span class="comment">//</span>
00574 
00575     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create Token Default Owner ...                         "</span>);
00576 
00577     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00578 
00579     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00580     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00581     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00582     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00583 
00584     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00585     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00586     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00587     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00588 
00589 
00590     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00591     UserId.User.Attributes = 0;
00592 
00593     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00594 
00595     Privileges-&gt;PrivilegeCount = 0;
00596 
00597     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00598 
00599 
00600     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00601                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
00602                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00603                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00604                  TokenPrimary,             <span class="comment">// TokenType</span>
00605                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00606                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00607                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00608                  GroupIds,                 <span class="comment">// Group IDs</span>
00609                  Privileges,               <span class="comment">// Privileges</span>
00610                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
00611                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00612                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// Default Dacl</span>
00613                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00614                  );
00615 
00616     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00617         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00618         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
00619                      NtCurrentProcess(),     <span class="comment">// SourceProcessHandle</span>
00620                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                  <span class="comment">// SourceHandle</span>
00621                      NtCurrentProcess(),     <span class="comment">// TargetProcessHandle</span>
00622                      &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a26">TokenWithDefaultOwner</a>, <span class="comment">// TargetHandle</span>
00623                      0,                      <span class="comment">// DesiredAccess (over-ridden by option)</span>
00624                      0,                      <span class="comment">// HandleAttributes</span>
00625                      DUPLICATE_SAME_ACCESS   <span class="comment">// Options</span>
00626                      );
00627         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00628         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00629         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00630     } <span class="keywordflow">else</span> {
00631         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00632         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00633         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00634     }
00635 
00636     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00637 
00638 
00639 
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// Create a token with default privileges</span>
00643     <span class="comment">//</span>
00644 
00645     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create Token privileges ...                            "</span>);
00646 
00647     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00648 
00649     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00650     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00651     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00652     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00653 
00654     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00655     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00656     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00657     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00658 
00659 
00660     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00661     UserId.User.Attributes = 0;
00662 
00663     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00664 
00665     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
00666 
00667     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
00668     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00669     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>;
00670     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
00671     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
00672     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Attributes = SE_PRIVILEGE_ENABLED;
00673 
00674     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00675 
00676 
00677     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00678                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
00679                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00680                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00681                  TokenPrimary,             <span class="comment">// TokenType</span>
00682                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00683                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00684                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00685                  GroupIds,                 <span class="comment">// Group IDs</span>
00686                  Privileges,               <span class="comment">// Privileges</span>
00687                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
00688                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00689                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// Default Dacl</span>
00690                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00691                  );
00692 
00693     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00694         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00695         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
00696                      NtCurrentProcess(),     <span class="comment">// SourceProcessHandle</span>
00697                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                  <span class="comment">// SourceHandle</span>
00698                      NtCurrentProcess(),     <span class="comment">// TargetProcessHandle</span>
00699                      &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,   <span class="comment">// TargetHandle</span>
00700                      0,                      <span class="comment">// DesiredAccess (over-ridden by option)</span>
00701                      0,                      <span class="comment">// HandleAttributes</span>
00702                      DUPLICATE_SAME_ACCESS   <span class="comment">// Options</span>
00703                      );
00704         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00705         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00706         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00707     } <span class="keywordflow">else</span> {
00708         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00709         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00710         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00711     }
00712 
00713     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00714 
00715 
00716 
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Create a token with default DACL</span>
00720     <span class="comment">//</span>
00721 
00722     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create Token With Default Dacl ...                     "</span>);
00723 
00724     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00725 
00726     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00727     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00728     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00729     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00730 
00731     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00732     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00733     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00734     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00735 
00736     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00737     UserId.User.Attributes = 0;
00738 
00739     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00740 
00741     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
00742 
00743     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
00744     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00745     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>;
00746     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
00747     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
00748     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Attributes = SE_PRIVILEGE_ENABLED;
00749 
00750     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00751 
00752     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( DefaultDacl.DefaultDacl, <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>, ACL_REVISION);
00753 
00754     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00755 
00756     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00757                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
00758                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00759                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00760                  TokenPrimary,             <span class="comment">// TokenType</span>
00761                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00762                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00763                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00764                  GroupIds,                 <span class="comment">// Group IDs</span>
00765                  Privileges,               <span class="comment">// Privileges</span>
00766                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
00767                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00768                  &amp;DefaultDacl,             <span class="comment">// Default Dacl</span>
00769                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00770                  );
00771 
00772     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00773         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00774 
00775         <span class="comment">//</span>
00776         <span class="comment">// Save a copy of this for later use...</span>
00777         <span class="comment">//</span>
00778 
00779         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
00780                      NtCurrentProcess(),     <span class="comment">// SourceProcessHandle</span>
00781                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                  <span class="comment">// SourceHandle</span>
00782                      NtCurrentProcess(),     <span class="comment">// TargetProcessHandle</span>
00783                      &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a28">TokenWithDefaultDacl</a>,  <span class="comment">// TargetHandle</span>
00784                      0,                      <span class="comment">// DesiredAccess (over-ridden by option)</span>
00785                      0,                      <span class="comment">// HandleAttributes</span>
00786                      DUPLICATE_SAME_ACCESS   <span class="comment">// Options</span>
00787                      );
00788         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00789         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00790         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00791     } <span class="keywordflow">else</span> {
00792         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00793         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00794         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00795     }
00796 
00797     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00798 
00799 
00800 
00801 
00802     <span class="comment">//</span>
00803     <span class="comment">// Create a token with a null default DACL</span>
00804     <span class="comment">//</span>
00805 
00806     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create Token With a Null Default Dacl ...              "</span>);
00807 
00808     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00809 
00810     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00811     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00812     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00813     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00814 
00815     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00816     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00817     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00818     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00819 
00820     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00821     UserId.User.Attributes = 0;
00822 
00823     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00824 
00825     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
00826 
00827     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
00828     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00829     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>;
00830     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
00831     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
00832     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Attributes = SE_PRIVILEGE_ENABLED;
00833 
00834     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00835 
00836     NullDefaultDacl.DefaultDacl =  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00837 
00838 
00839     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00840                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
00841                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00842                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00843                  TokenPrimary,             <span class="comment">// TokenType</span>
00844                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00845                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00846                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00847                  GroupIds,                 <span class="comment">// Group IDs</span>
00848                  Privileges,               <span class="comment">// Privileges</span>
00849                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
00850                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00851                  &amp;NullDefaultDacl,         <span class="comment">// Default Dacl</span>
00852                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00853                  );
00854 
00855     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00856         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00857         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00858         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00859     } <span class="keywordflow">else</span> {
00860         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00861         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00862         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00863     }
00864 
00865     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00866 
00867 
00868 
00869 
00870     <span class="comment">//</span>
00871     <span class="comment">// Create an impersonation token, Impersonation level = Impersonation</span>
00872     <span class="comment">//</span>
00873 
00874     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create an impersonation token ...                      "</span>);
00875 
00876     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00877 
00878     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00879     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00880     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00881     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00882 
00883     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00884     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00885     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00886     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00887 
00888     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00889     UserId.User.Attributes = 0;
00890 
00891     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00892 
00893     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
00894 
00895     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
00896     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00897     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>;
00898     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
00899     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
00900     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Attributes = SE_PRIVILEGE_ENABLED;
00901 
00902     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00903 
00904     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( DefaultDacl.DefaultDacl, <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>, ACL_REVISION);
00905 
00906     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00907 
00908     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00909                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
00910                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00911                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00912                  TokenImpersonation,       <span class="comment">// TokenType</span>
00913                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00914                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00915                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00916                  GroupIds,                 <span class="comment">// Group IDs</span>
00917                  Privileges,               <span class="comment">// Privileges</span>
00918                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
00919                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00920                  &amp;DefaultDacl,             <span class="comment">// Default Dacl</span>
00921                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00922                  );
00923 
00924     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00925         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00926         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
00927                      NtCurrentProcess(),     <span class="comment">// SourceProcessHandle</span>
00928                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                  <span class="comment">// SourceHandle</span>
00929                      NtCurrentProcess(),     <span class="comment">// TargetProcessHandle</span>
00930                      &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>,    <span class="comment">// TargetHandle</span>
00931                      0,                      <span class="comment">// DesiredAccess (over-ridden by option)</span>
00932                      0,                      <span class="comment">// HandleAttributes</span>
00933                      DUPLICATE_SAME_ACCESS   <span class="comment">// Options</span>
00934                      );
00935         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00936         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00937         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00938     } <span class="keywordflow">else</span> {
00939         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00940         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00941         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00942     }
00943 
00944     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00945 
00946 
00947 
00948 
00949     <span class="comment">//</span>
00950     <span class="comment">// Create an impersonation token, Impersonation level = Anonymous</span>
00951     <span class="comment">//</span>
00952 
00953     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create an anonymous token ...                          "</span>);
00954 
00955     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00956 
00957     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00958     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00959     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00960     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00961 
00962     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00963     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00964     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00965     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00966 
00967     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00968     UserId.User.Attributes = 0;
00969 
00970     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00971 
00972     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
00973 
00974     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
00975     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00976     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>;
00977     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
00978     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
00979     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Attributes = SE_PRIVILEGE_ENABLED;
00980 
00981     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00982 
00983     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( DefaultDacl.DefaultDacl, <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>, ACL_REVISION);
00984 
00985     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00986 
00987     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00988                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                     <span class="comment">// Handle</span>
00989                  (TOKEN_ALL_ACCESS),         <span class="comment">// DesiredAccess</span>
00990                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a39">AnonymousTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00991                  TokenImpersonation,         <span class="comment">// TokenType</span>
00992                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a>,     <span class="comment">// Authentication LUID</span>
00993                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,              <span class="comment">// Expiration Time</span>
00994                  &amp;UserId,                    <span class="comment">// Owner ID</span>
00995                  GroupIds,                   <span class="comment">// Group IDs</span>
00996                  Privileges,                 <span class="comment">// Privileges</span>
00997                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                     <span class="comment">// Owner</span>
00998                  &amp;PrimaryGroup,              <span class="comment">// Primary Group</span>
00999                  &amp;DefaultDacl,               <span class="comment">// Default Dacl</span>
01000                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>                 <span class="comment">// TokenSource</span>
01001                  );
01002 
01003     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01004         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01005         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
01006                      NtCurrentProcess(),     <span class="comment">// SourceProcessHandle</span>
01007                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                  <span class="comment">// SourceHandle</span>
01008                      NtCurrentProcess(),     <span class="comment">// TargetProcessHandle</span>
01009                      &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a32">AnonymousToken</a>,        <span class="comment">// TargetHandle</span>
01010                      0,                      <span class="comment">// DesiredAccess (over-ridden by option)</span>
01011                      0,                      <span class="comment">// HandleAttributes</span>
01012                      DUPLICATE_SAME_ACCESS   <span class="comment">// Options</span>
01013                      );
01014         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01015         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
01016         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01017     } <span class="keywordflow">else</span> {
01018         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01019         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01020         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01021     }
01022 
01023     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01024 
01025 
01026 
01027     <span class="comment">//</span>
01028     <span class="comment">// Create the simplest token possible</span>
01029     <span class="comment">// (no Groups, explicit Owner, or DefaultDacl)</span>
01030     <span class="comment">//</span>
01031 
01032     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create Token With Bad Authentication Id ...            "</span>);
01033 
01034     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
01035     UserId.User.Attributes = 0;
01036     GroupIds-&gt;GroupCount = 0;
01037     Privileges-&gt;PrivilegeCount = 0;
01038     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
01039 
01040 
01041     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
01042                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
01043                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
01044                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
01045                  TokenPrimary,             <span class="comment">// TokenType</span>
01046                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a49">BadAuthenticationId</a>,     <span class="comment">// Authentication LUID</span>
01047                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
01048                  &amp;UserId,                  <span class="comment">// Owner ID</span>
01049                  GroupIds,                 <span class="comment">// Group IDs</span>
01050                  Privileges,               <span class="comment">// Privileges</span>
01051                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// Owner</span>
01052                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
01053                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// Default Dacl</span>
01054                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
01055                  );
01056 
01057     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_SUCH_LOGON_SESSION) {
01058         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01059     } <span class="keywordflow">else</span> {
01060         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01061         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01062         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status should be: 0x%lx \n"</span>, STATUS_NO_SUCH_LOGON_SESSION);
01063         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01064     }
01065 
01066 
01067 
01068 
01069 
01070 
01071     <span class="comment">//</span>
01072     <span class="comment">// All done with this test</span>
01073     <span class="comment">//</span>
01074 
01075     <span class="keywordflow">return</span> CompletionStatus;
01076 }
01077 
01079 <span class="comment">//                                                            //</span>
01080 <span class="comment">// Token Filtering Test                                       //</span>
01081 <span class="comment">//                                                            //</span>
01083 <span class="comment"></span>
01084 BOOLEAN
<a name="l01085"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a67">01085</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a67">TestTokenFilter</a>()
01086 {
01087 
01088     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01089 
01090     PTOKEN_GROUPS GroupIds;
01091     PTOKEN_GROUPS RestrictedGroupIds;
01092     PTOKEN_PRIVILEGES Privileges;
01093 
01094     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01095 
01096     GroupIds = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01097                                                <a class="code" href="../../d6/d0/ctaccess_8c.html#a3">GROUP_IDS_LENGTH</a>
01098                                                );
01099 
01100     RestrictedGroupIds = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01101                                                          <a class="code" href="../../d6/d0/ctaccess_8c.html#a3">GROUP_IDS_LENGTH</a>
01102                                                          );
01103 
01104     Privileges = (PTOKEN_PRIVILEGES)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01105                                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a5">PRIVILEGES_LENGTH</a>
01106                                                      );
01107 
01108 
01109 
01110 
01111     <span class="comment">//</span>
01112     <span class="comment">// Filter a token without doing anything</span>
01113     <span class="comment">//</span>
01114 
01115     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Filter null Token ...                                  "</span>);
01116     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a7">NtFilterToken</a>(
01117                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,
01118                 0,                      <span class="comment">// no flags</span>
01119                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no groups to disable</span>
01120                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no privileges to disable</span>
01121                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no restricted sids</span>
01122                 &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>
01123                 );
01124     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01125         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01126         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
01127     } <span class="keywordflow">else</span> {
01128         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01129         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01130         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01131     }
01132 
01133     <span class="comment">//</span>
01134     <span class="comment">// Filter a token and remove some groups</span>
01135     <span class="comment">//</span>
01136 
01137     GroupIds-&gt;GroupCount = 2;
01138 
01139     GroupIds-&gt;Groups[0].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
01140     GroupIds-&gt;Groups[1].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
01141 
01142     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = SE_GROUP_USE_FOR_DENY_ONLY;
01143     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = SE_GROUP_USE_FOR_DENY_ONLY;
01144 
01145 
01146     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Filter token with disabled groups ...                  "</span>);
01147     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a7">NtFilterToken</a>(
01148                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,
01149                 0,                      <span class="comment">// no flags</span>
01150                 GroupIds,               <span class="comment">// no groups to disable</span>
01151                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no privileges to disable</span>
01152                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no restricted sids</span>
01153                 &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a24">TokenWithRestrictedGroups</a>
01154                 );
01155     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01156         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01157     } <span class="keywordflow">else</span> {
01158         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01159         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01160         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01161     }
01162 
01163 
01164     <span class="comment">//</span>
01165     <span class="comment">// Filter a token and remove some privileges</span>
01166     <span class="comment">//</span>
01167 
01168 
01169     Privileges-&gt;PrivilegeCount = 2;
01170 
01171     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
01172     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
01173     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
01174     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
01175 
01176 
01177     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Filter token with disabled privilegs ...               "</span>);
01178     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a7">NtFilterToken</a>(
01179                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,
01180                 0,                      <span class="comment">// no flags</span>
01181                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no groups to disable</span>
01182                 Privileges,             <span class="comment">// no privileges to disable</span>
01183                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no restricted sids</span>
01184                 &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a25">TokenWithRestrictedPrivileges</a>
01185                 );
01186     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01187         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01188     } <span class="keywordflow">else</span> {
01189         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01190         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01191         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01192     }
01193 
01194 
01195     <span class="comment">//</span>
01196     <span class="comment">// Filter a restricted token and add some restricted sids</span>
01197     <span class="comment">//</span>
01198 
01199     RestrictedGroupIds-&gt;GroupCount = <a class="code" href="../../d2/d1/cttoken_8c.html#a12">RESTRICTED_SID_COUNT</a>;
01200 
01201     RestrictedGroupIds-&gt;GroupCount = <a class="code" href="../../d2/d1/cttoken_8c.html#a12">RESTRICTED_SID_COUNT</a>;
01202 
01203     RestrictedGroupIds-&gt;Groups[0].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
01204     RestrictedGroupIds-&gt;Groups[1].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
01205 
01206     RestrictedGroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
01207     RestrictedGroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
01208 
01209 
01210 
01211     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Filter token with restricted sids ...                 "</span>);
01212     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a7">NtFilterToken</a>(
01213                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,
01214                 0,                      <span class="comment">// no flags</span>
01215                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no groups to disable</span>
01216                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no privileges to disable</span>
01217                 RestrictedGroupIds,     <span class="comment">// no restricted sids</span>
01218                 &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a26">TokenWithRestrictedSids</a>
01219                 );
01220     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01221         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01222     } <span class="keywordflow">else</span> {
01223         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01224         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01225         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01226     }
01227 
01228 
01229     <span class="comment">//</span>
01230     <span class="comment">// Filter a token and add some restricted sids</span>
01231     <span class="comment">//</span>
01232 
01233     RestrictedGroupIds-&gt;GroupCount = <a class="code" href="../../d2/d1/cttoken_8c.html#a12">RESTRICTED_SID_COUNT</a>;
01234 
01235     RestrictedGroupIds-&gt;Groups[0].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
01236     RestrictedGroupIds-&gt;Groups[1].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
01237 
01238     RestrictedGroupIds-&gt;Groups[0].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
01239     RestrictedGroupIds-&gt;Groups[1].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
01240 
01241 
01242     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Filter token with more restricted sids ...             "</span>);
01243     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a7">NtFilterToken</a>(
01244                 <a class="code" href="../../d2/d1/cttoken_8c.html#a26">TokenWithRestrictedSids</a>,
01245                 0,                      <span class="comment">// no flags</span>
01246                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no groups to disable</span>
01247                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// no privileges to disable</span>
01248                 RestrictedGroupIds,     <span class="comment">// no restricted sids</span>
01249                 &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a27">TokenWithMoreRestrictedSids</a>
01250                 );
01251     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01252         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01253     } <span class="keywordflow">else</span> {
01254         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01255         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01256         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01257     }
01258 
01259 
01260     <span class="comment">//</span>
01261     <span class="comment">// All done with this test</span>
01262     <span class="comment">//</span>
01263 
01264     <span class="keywordflow">return</span> CompletionStatus;
01265 }
01266 
01267 
01268 
01270 <span class="comment">//                                                            //</span>
01271 <span class="comment">// Open Primary Token Test                                    //</span>
01272 <span class="comment">//                                                            //</span>
01274 <span class="comment"></span>
01275 BOOLEAN
<a name="l01276"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a68">01276</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a68">TestTokenOpenPrimary</a>()
01277 {
01278     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01279     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01280 
01281     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>;
01282     HANDLE SubProcessToken;
01283     HANDLE SubProcess;
01284 
01285     TOKEN_STATISTICS ProcessTokenStatistics;
01286     TOKEN_STATISTICS SubProcessTokenStatistics;
01287 
01288     ULONG ReturnLength;
01289 
01290     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01291 
01292     <span class="comment">//</span>
01293     <span class="comment">// Open the current process's token</span>
01294     <span class="comment">//</span>
01295 
01296     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Open own process's token ...                           "</span>);
01297 
01298     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
01299                  NtCurrentProcess(),
01300                  TOKEN_ALL_ACCESS,
01301                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>
01302                  );
01303     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01304         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01305                      <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>,                 <span class="comment">// Handle</span>
01306                      TokenStatistics,              <span class="comment">// TokenInformationClass</span>
01307                      &amp;ProcessTokenStatistics,      <span class="comment">// TokenInformation</span>
01308                      <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
01309                      &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
01310                      );
01311         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01312         <span class="keywordflow">if</span> ( ProcessTokenStatistics.TokenType == TokenPrimary) {
01313             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( &amp;ProcessTokenStatistics.AuthenticationId,
01314                                &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a> ) ) {
01315                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01316             } <span class="keywordflow">else</span> {
01317                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01318                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected authentication ID value.\n"</span>);
01319                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Authentication ID is: "</span>);
01320                 <a class="code" href="../../d2/d1/cttoken_8c.html#a17">TestpPrintLuid</a>(ProcessTokenStatistics.AuthenticationId);
01321                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01322                 CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01323             }
01324 
01325         } <span class="keywordflow">else</span> {
01326             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01327             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Token type not TokenPrimary.\n"</span>);
01328             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned token type is: 0x%lx \n"</span>,
01329                     ProcessTokenStatistics.TokenType);
01330             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Authentication ID is: "</span>);
01331             <a class="code" href="../../d2/d1/cttoken_8c.html#a17">TestpPrintLuid</a>(ProcessTokenStatistics.AuthenticationId);
01332             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01333             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01334         }
01335         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>);
01336         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01337 
01338     } <span class="keywordflow">else</span> {
01339         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01340         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01341         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01342     }
01343 
01344 
01345 
01346 
01347 
01348 
01349     <span class="comment">//</span>
01350     <span class="comment">// Open another process's token</span>
01351     <span class="comment">//</span>
01352 
01353     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Open another process's token ...                       "</span>);
01354 
01355     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/ps_2create_8c.html#a14">NtCreateProcess</a>(
01356                  &amp;SubProcess,
01357                  (GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | DELETE),
01358                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01359                  NtCurrentProcess(),   <span class="comment">// ParentProcess</span>
01360                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                <span class="comment">// InheritObjectTable</span>
01361                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                 <span class="comment">// SectionHandle,</span>
01362                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                 <span class="comment">// DebugPort,</span>
01363                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                  <span class="comment">// ExceptionPort</span>
01364                  );
01365 
01366     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
01367                  SubProcess,
01368                  TOKEN_ALL_ACCESS,
01369                  &amp;SubProcessToken
01370                  );
01371     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01372         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01373                      SubProcessToken,              <span class="comment">// Handle</span>
01374                      TokenStatistics,              <span class="comment">// TokenInformationClass</span>
01375                      &amp;SubProcessTokenStatistics,   <span class="comment">// TokenInformation</span>
01376                      <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
01377                      &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
01378                      );
01379         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01380         <span class="keywordflow">if</span> ( SubProcessTokenStatistics.TokenType == TokenPrimary) {
01381             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( &amp;SubProcessTokenStatistics.AuthenticationId,
01382                                &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a> ) ) {
01383                 <span class="keywordflow">if</span> ( (ProcessTokenStatistics.TokenId.HighPart ==
01384                       SubProcessTokenStatistics.TokenId.HighPart)  &amp;&amp;
01385                      (ProcessTokenStatistics.TokenId.LowPart ==
01386                       SubProcessTokenStatistics.TokenId.LowPart) ) {
01387                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01388                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Same token as parent process (token IDs match).\n"</span>);
01389                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Authentication ID is: "</span>);
01390                     <a class="code" href="../../d2/d1/cttoken_8c.html#a17">TestpPrintLuid</a>(SubProcessTokenStatistics.AuthenticationId);
01391                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01392                     CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01393 
01394                 } <span class="keywordflow">else</span> {
01395                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01396                 }
01397             } <span class="keywordflow">else</span> {
01398                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01399                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected authentication ID value.\n"</span>);
01400                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Authentication ID is: "</span>);
01401                 <a class="code" href="../../d2/d1/cttoken_8c.html#a17">TestpPrintLuid</a>(SubProcessTokenStatistics.AuthenticationId);
01402                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01403                 CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01404             }
01405         } <span class="keywordflow">else</span> {
01406             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01407             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Token type not TokenPrimary.\n"</span>);
01408             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned token type is: 0x%lx \n"</span>,
01409             SubProcessTokenStatistics.TokenType);
01410             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Authentication ID is: "</span>);
01411             <a class="code" href="../../d2/d1/cttoken_8c.html#a17">TestpPrintLuid</a>(SubProcessTokenStatistics.AuthenticationId);
01412             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01413             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01414         }
01415         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SubProcessToken);
01416         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01417     } <span class="keywordflow">else</span> {
01418         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01419         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01420         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01421     }
01422 
01423 
01424     <span class="keywordflow">return</span> CompletionStatus;
01425 }
01426 
01428 <span class="comment">//                                                            //</span>
01429 <span class="comment">// Query Token Test                                           //</span>
01430 <span class="comment">//                                                            //</span>
01432 <span class="comment"></span>
01433 BOOLEAN
<a name="l01434"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a69">01434</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a69">TestTokenQuery</a>()
01435 {
01436     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01437     ULONG ReturnLength;
01438     BOOLEAN ValuesCompare;
01439 
01440     PTOKEN_USER UserId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01441     PTOKEN_PRIMARY_GROUP PrimaryGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01442     PTOKEN_GROUPS GroupIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443     PTOKEN_GROUPS RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01444     PTOKEN_PRIVILEGES Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01445     PTOKEN_OWNER <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01446     PTOKEN_DEFAULT_DACL DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01447 
01448     SECURITY_IMPERSONATION_LEVEL QueriedImpersonationLevel;
01449     TOKEN_SOURCE QueriedSource;
01450     TOKEN_TYPE QueriedType;
01451     TOKEN_STATISTICS QueriedStatistics;
01452 
01453     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01454 
01455 
01456 
01457 <span class="preprocessor">#if 0</span>
01458 <span class="preprocessor"></span>
01459    <span class="comment">//</span>
01460    <span class="comment">// Query invalid return buffer address</span>
01461    <span class="comment">//</span>
01462 
01463     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query with invalid buffer address ...                  "</span>);
01464 
01465     UserId = (PTOKEN_USER)((PVOID)0x200<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01466     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01467                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
01468                  TokenUser,                <span class="comment">// TokenInformationClass</span>
01469                  UserId,                   <span class="comment">// TokenInformation</span>
01470                  3000,                     <span class="comment">// TokenInformationLength</span>
01471                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01472                  );
01473 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01474 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01475 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01476 <span class="preprocessor"></span>
01477     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ACCESS_VIOLATION) {
01478         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01479     } <span class="keywordflow">else</span> {
01480         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01481         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01482         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01483     }
01484 
01485     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01486 
01487 <span class="preprocessor">#endif  //0</span>
01488 <span class="preprocessor"></span>
01489 
01491 <span class="comment">//                                                                    //</span>
01492 <span class="comment">//        Query User ID                                               //</span>
01493 <span class="comment">//                                                                    //</span>
01495 <span class="comment"></span>
01496    <span class="comment">//</span>
01497    <span class="comment">// Query User ID with zero length buffer</span>
01498    <span class="comment">//</span>
01499 
01500     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query User ID with zero length buffer ...              "</span>);
01501 
01502     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01503                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
01504                  TokenUser,                <span class="comment">// TokenInformationClass</span>
01505                  UserId,                   <span class="comment">// TokenInformation</span>
01506                  0,                        <span class="comment">// TokenInformationLength</span>
01507                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01508                  );
01509 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01510 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01511 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01512 <span class="preprocessor"></span>
01513     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01514         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01515     } <span class="keywordflow">else</span> {
01516         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01517         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01518         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01519         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01520     }
01521 
01522     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01523 
01524 
01525 
01526 
01527     UserId = (PTOKEN_USER)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01528                                            ReturnLength
01529                                            );
01530 
01531     <span class="comment">//</span>
01532     <span class="comment">// Query user SID</span>
01533     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
01534     <span class="comment">//</span>
01535 
01536     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query token user ...                                   "</span>);
01537 
01538     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01539                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
01540                  TokenUser,                <span class="comment">// TokenInformationClass</span>
01541                  UserId,                   <span class="comment">// TokenInformation</span>
01542                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
01543                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01544                  );
01545 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01546 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01547 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01548 <span class="preprocessor"></span>
01549     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01550 
01551         <span class="comment">//</span>
01552         <span class="comment">// Check returned value</span>
01553         <span class="comment">//</span>
01554 
01555         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((UserId-&gt;User.Sid), <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>) ) {
01556             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01557         } <span class="keywordflow">else</span> {
01558         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01559         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
01560         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01561         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01562         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01563         }
01564     } <span class="keywordflow">else</span> {
01565         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01566         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01567         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01568         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01569     }
01570 
01571     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01572 
01573 
01574    <span class="comment">//</span>
01575    <span class="comment">// Query with too little buffer</span>
01576     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
01577    <span class="comment">//</span>
01578 
01579     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query user with too small buffer ...                   "</span>);
01580 
01581     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01582                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
01583                  TokenUser,                <span class="comment">// TokenInformationClass</span>
01584                  UserId,                   <span class="comment">// TokenInformation</span>
01585                  ReturnLength-1,           <span class="comment">// TokenInformationLength</span>
01586                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01587                  );
01588 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01589 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01590 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01591 <span class="preprocessor"></span>
01592     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01593         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01594     } <span class="keywordflow">else</span> {
01595         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01596         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01597         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01598         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01599     }
01600 
01601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01602 
01603 
01605 <span class="comment">//                                                                    //</span>
01606 <span class="comment">//        Query Primary Group                                         //</span>
01607 <span class="comment">//                                                                    //</span>
01609 <span class="comment"></span>
01610    <span class="comment">//</span>
01611    <span class="comment">// Query primary group with zero length buffer</span>
01612    <span class="comment">//</span>
01613 
01614     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query primary group with zero length buffer ...        "</span>);
01615 
01616     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01617                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
01618                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
01619                  PrimaryGroup,             <span class="comment">// TokenInformation</span>
01620                  0,                        <span class="comment">// TokenInformationLength</span>
01621                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01622                  );
01623 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01624 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01625 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01626 <span class="preprocessor"></span>
01627     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01628         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01629     } <span class="keywordflow">else</span> {
01630         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01631         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01632         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01633         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01634     }
01635 
01636     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01637 
01638 
01639 
01640 
01641     PrimaryGroup = (PTOKEN_PRIMARY_GROUP)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01642                                                           ReturnLength
01643                                                           );
01644 
01645     <span class="comment">//</span>
01646     <span class="comment">// Query primary group SID</span>
01647     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
01648     <span class="comment">//</span>
01649 
01650     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query primary group ...                                "</span>);
01651 
01652     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01653                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
01654                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
01655                  PrimaryGroup,             <span class="comment">// TokenInformation</span>
01656                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
01657                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01658                  );
01659 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01660 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01661 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01662 <span class="preprocessor"></span>
01663     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01664 
01665         <span class="comment">//</span>
01666         <span class="comment">// Check returned value</span>
01667         <span class="comment">//</span>
01668 
01669         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( PrimaryGroup-&gt;PrimaryGroup, <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>) ) {
01670             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01671         } <span class="keywordflow">else</span> {
01672             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01673             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
01674             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01675             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01676             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01677         }
01678     } <span class="keywordflow">else</span> {
01679         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01680         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01681         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01682         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01683     }
01684 
01685     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01686 
01687 
01688    <span class="comment">//</span>
01689    <span class="comment">// Query with too little buffer</span>
01690     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
01691    <span class="comment">//</span>
01692 
01693     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query primary group with too small buffer ...          "</span>);
01694 
01695     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01696                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
01697                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
01698                  PrimaryGroup,             <span class="comment">// TokenInformation</span>
01699                  ReturnLength-1,           <span class="comment">// TokenInformationLength</span>
01700                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01701                  );
01702 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01703 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01704 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01705 <span class="preprocessor"></span>
01706     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01707         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01708     } <span class="keywordflow">else</span> {
01709         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01710         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01711         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01712         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01713     }
01714 
01715     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01716 
01717 
01718 
01720 <span class="comment">//                                                                    //</span>
01721 <span class="comment">//        Query Groups                                                //</span>
01722 <span class="comment">//                                                                    //</span>
01724 <span class="comment"></span>
01725    <span class="comment">//</span>
01726    <span class="comment">// Query groups with zero length buffer</span>
01727    <span class="comment">//</span>
01728 
01729     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query groups with zero length buffer ...               "</span>);
01730 
01731     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01732                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
01733                  TokenGroups,              <span class="comment">// TokenInformationClass</span>
01734                  GroupIds,                 <span class="comment">// TokenInformation</span>
01735                  0,                        <span class="comment">// TokenInformationLength</span>
01736                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01737                  );
01738 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01739 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01740 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01741 <span class="preprocessor"></span>
01742     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01743         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01744     } <span class="keywordflow">else</span> {
01745         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01746         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01747         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01748         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01749     }
01750 
01751     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01752 
01753 
01754 
01755 
01756     GroupIds = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01757                                                ReturnLength
01758                                                );
01759 
01760     <span class="comment">//</span>
01761     <span class="comment">// Query Group SIDs</span>
01762     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
01763     <span class="comment">//</span>
01764 
01765     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query groups ...                                       "</span>);
01766 
01767     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01768                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
01769                  TokenGroups,              <span class="comment">// TokenInformationClass</span>
01770                  GroupIds,                 <span class="comment">// TokenInformation</span>
01771                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
01772                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01773                  );
01774 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01775 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01776 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01777 <span class="preprocessor"></span>
01778     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01779 
01780         <span class="comment">//</span>
01781         <span class="comment">// Check returned value</span>
01782         <span class="comment">//    Group count = 4</span>
01783         <span class="comment">//    SID 0 = Flintstone</span>
01784         <span class="comment">//    SID 1 = ChildSid</span>
01785         <span class="comment">//    SID 2 = NeandertholSid</span>
01786         <span class="comment">//    SID 3 = WorldSid</span>
01787         <span class="comment">//</span>
01788 
01789         ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01790 
01791         <span class="keywordflow">if</span> (GroupIds-&gt;GroupCount != <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>) {
01792             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01793         }
01794 
01795         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid),
01796                             <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>)) ||
01797              (GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes !=
01798               <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>) ) {
01799             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01800         }
01801 
01802         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid), <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>)) ||
01803              (GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes !=
01804               <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) ) {
01805             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01806         }
01807 
01808         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid),
01809               <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>)) ||
01810              (GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes !=
01811               <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) ) {
01812             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01813         }
01814 
01815         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid), <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>)) ||
01816              (GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes != <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>) ) {
01817             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01818         }
01819 
01820 
01821         <span class="keywordflow">if</span> ( ValuesCompare ) {
01822             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01823         } <span class="keywordflow">else</span> {
01824         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01825         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
01826         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01827         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01828         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned group count is: 0x%lx \n"</span>, GroupIds-&gt;GroupCount);
01829         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01830         }
01831     } <span class="keywordflow">else</span> {
01832         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01833         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01834         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01835         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01836     }
01837 
01838     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01839 
01840 
01841    <span class="comment">//</span>
01842    <span class="comment">// Query with too little buffer</span>
01843     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
01844    <span class="comment">//</span>
01845 
01846     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query groups with too small buffer ...                 "</span>);
01847 
01848     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01849                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
01850                  TokenGroups,              <span class="comment">// TokenInformationClass</span>
01851                  GroupIds,                 <span class="comment">// TokenInformation</span>
01852                  ReturnLength-1,           <span class="comment">// TokenInformationLength</span>
01853                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01854                  );
01855 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01856 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01857 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01858 <span class="preprocessor"></span>
01859     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01860         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01861     } <span class="keywordflow">else</span> {
01862         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01863         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01864         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01865         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01866     }
01867 
01868     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01869 
01870    <span class="comment">//</span>
01871    <span class="comment">// Query groups with zero length buffer</span>
01872    <span class="comment">//</span>
01873 
01874     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query restgroups with zero length buffer ...           "</span>);
01875     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01876                  <a class="code" href="../../d2/d1/cttoken_8c.html#a24">TokenWithRestrictedGroups</a>,<span class="comment">// Handle</span>
01877                  TokenGroups,              <span class="comment">// TokenInformationClass</span>
01878                  GroupIds,                 <span class="comment">// TokenInformation</span>
01879                  0,                        <span class="comment">// TokenInformationLength</span>
01880                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01881                  );
01882 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01883 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01884 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01885 <span class="preprocessor"></span>
01886     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01887         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01888     } <span class="keywordflow">else</span> {
01889         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01890         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01891         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01892         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01893     }
01894 
01895     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01896 
01897 
01898 
01899 
01900     GroupIds = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01901                                                ReturnLength
01902                                                );
01903 
01904     <span class="comment">//</span>
01905     <span class="comment">// Query Group SIDs</span>
01906     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
01907     <span class="comment">//</span>
01908 
01909     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query rest groups ...                                  "</span>);
01910 
01911     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01912                  <a class="code" href="../../d2/d1/cttoken_8c.html#a24">TokenWithRestrictedGroups</a>,<span class="comment">// Handle</span>
01913                  TokenGroups,              <span class="comment">// TokenInformationClass</span>
01914                  GroupIds,                 <span class="comment">// TokenInformation</span>
01915                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
01916                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
01917                  );
01918 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01919 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
01920 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01921 <span class="preprocessor"></span>
01922     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01923 
01924         <span class="comment">//</span>
01925         <span class="comment">// Check returned value</span>
01926         <span class="comment">//    Group count = 4</span>
01927         <span class="comment">//    SID 0 = Flintstone</span>
01928         <span class="comment">//    SID 1 = ChildSid</span>
01929         <span class="comment">//    SID 2 = NeandertholSid</span>
01930         <span class="comment">//    SID 3 = WorldSid</span>
01931         <span class="comment">//</span>
01932 
01933         ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01934 
01935         <span class="keywordflow">if</span> (GroupIds-&gt;GroupCount != <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>) {
01936             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01937         }
01938 
01939         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid),
01940                             <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>)) ||
01941              (GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes !=
01942               ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a> &amp; ~(SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT)) | SE_GROUP_USE_FOR_DENY_ONLY) ) ) {
01943             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01944         }
01945 
01946         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid), <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>)) ||
01947              (GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes !=
01948                             ((<a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a> &amp; ~(SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT)) | SE_GROUP_USE_FOR_DENY_ONLY)) ) {
01949             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01950         }
01951 
01952         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid),
01953               <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>)) ||
01954              (GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes !=
01955               <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) ) {
01956             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01957         }
01958 
01959         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid), <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>)) ||
01960              (GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes != <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>) ) {
01961             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01962         }
01963 
01964 
01965         <span class="keywordflow">if</span> ( ValuesCompare ) {
01966             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01967         } <span class="keywordflow">else</span> {
01968 
01969         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01970         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
01971         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01972         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01973         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned group count is: 0x%lx \n"</span>, GroupIds-&gt;GroupCount);
01974         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01975         }
01976     } <span class="keywordflow">else</span> {
01977         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
01978         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01979         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
01980         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01981     }
01982 
01983     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01984 
01985 
01986 
01988 <span class="comment">//                                                                    //</span>
01989 <span class="comment">//        Query RestrictedSids                                        //</span>
01990 <span class="comment">//                                                                    //</span>
01992 <span class="comment"></span>
01993    <span class="comment">//</span>
01994    <span class="comment">// Query groups with zero length buffer</span>
01995    <span class="comment">//</span>
01996 
01997     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query null restricted with zero length buffer ...      "</span>);
01998 
01999     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02000                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
02001                  TokenRestrictedSids,      <span class="comment">// TokenInformationClass</span>
02002                  RestrictedSids,           <span class="comment">// TokenInformation</span>
02003                  0,                        <span class="comment">// TokenInformationLength</span>
02004                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02005                  );
02006 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02007 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02008 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02009 <span class="preprocessor"></span>
02010     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02011         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02012     } <span class="keywordflow">else</span> {
02013         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02014         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02015         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02016         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02017     }
02018 
02019     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02020 
02021    <span class="comment">//</span>
02022    <span class="comment">// Query groups with zero length buffer</span>
02023    <span class="comment">//</span>
02024 
02025     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query restricted sids with zero length buffer ...      "</span>);
02026 
02027     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02028                  <a class="code" href="../../d2/d1/cttoken_8c.html#a26">TokenWithRestrictedSids</a>,  <span class="comment">// Handle</span>
02029                  TokenRestrictedSids,      <span class="comment">// TokenInformationClass</span>
02030                  RestrictedSids,           <span class="comment">// TokenInformation</span>
02031                  0,                        <span class="comment">// TokenInformationLength</span>
02032                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02033                  );
02034 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02035 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02036 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02037 <span class="preprocessor"></span>
02038     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02039         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02040     } <span class="keywordflow">else</span> {
02041         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02042         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02043         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02044         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02045     }
02046 
02047     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02048 
02049 
02050 
02051 
02052     RestrictedSids = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02053                                                      ReturnLength
02054                                                      );
02055 
02056     <span class="comment">//</span>
02057     <span class="comment">// Query Group SIDs</span>
02058     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02059     <span class="comment">//</span>
02060 
02061     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query restricted sids ...                              "</span>);
02062 
02063     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02064                  <a class="code" href="../../d2/d1/cttoken_8c.html#a26">TokenWithRestrictedSids</a>,  <span class="comment">// Handle</span>
02065                  TokenRestrictedSids,      <span class="comment">// TokenInformationClass</span>
02066                  RestrictedSids,           <span class="comment">// TokenInformation</span>
02067                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
02068                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02069                  );
02070 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02071 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02072 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02073 <span class="preprocessor"></span>
02074 
02075     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02076 
02077         <span class="comment">//</span>
02078         <span class="comment">// Check returned value</span>
02079         <span class="comment">//    Group count = 2</span>
02080         <span class="comment">//    SID 0 = Flintstone</span>
02081         <span class="comment">//    SID 1 = ChildSid</span>
02082         <span class="comment">//</span>
02083 
02084         ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02085 
02086         <span class="keywordflow">if</span> (RestrictedSids-&gt;GroupCount != <a class="code" href="../../d2/d1/cttoken_8c.html#a12">RESTRICTED_SID_COUNT</a>) {
02087             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02088         }
02089 
02090         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid),
02091                             <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>)) ||
02092              (RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes !=
02093               (SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_MANDATORY)) ) {
02094             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02095         }
02096 
02097         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid), <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>)) ||
02098              (RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes !=
02099               (SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_MANDATORY)) ) {
02100             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02101         }
02102 
02103 
02104         <span class="keywordflow">if</span> ( ValuesCompare ) {
02105             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02106         } <span class="keywordflow">else</span> {
02107             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02108             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02109             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02110             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02111             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned group count is: 0x%lx \n"</span>, RestrictedSids-&gt;GroupCount);
02112             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02113         }
02114     } <span class="keywordflow">else</span> {
02115         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02116         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02117         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02118         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02119     }
02120 
02121     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02122 
02123     <span class="comment">//</span>
02124    <span class="comment">// Query restricted sids with zero length buffer</span>
02125    <span class="comment">//</span>
02126 
02127     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query more restricted sids with zero length buffer ... "</span>);
02128 
02129     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02130                  <a class="code" href="../../d2/d1/cttoken_8c.html#a27">TokenWithMoreRestrictedSids</a>,  <span class="comment">// Handle</span>
02131                  TokenRestrictedSids,      <span class="comment">// TokenInformationClass</span>
02132                  RestrictedSids,           <span class="comment">// TokenInformation</span>
02133                  0,                        <span class="comment">// TokenInformationLength</span>
02134                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02135                  );
02136 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02137 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02138 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02139 <span class="preprocessor"></span>
02140     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02141         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02142     } <span class="keywordflow">else</span> {
02143         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02144         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02145         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02146         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02147     }
02148 
02149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02150 
02151 
02152 
02153 
02154     RestrictedSids = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02155                                                      ReturnLength
02156                                                      );
02157 
02158     <span class="comment">//</span>
02159     <span class="comment">// Query Group SIDs</span>
02160     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02161     <span class="comment">//</span>
02162 
02163     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query more restricted sids ...                         "</span>);
02164 
02165     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02166                  <a class="code" href="../../d2/d1/cttoken_8c.html#a27">TokenWithMoreRestrictedSids</a>,  <span class="comment">// Handle</span>
02167                  TokenRestrictedSids,      <span class="comment">// TokenInformationClass</span>
02168                  RestrictedSids,           <span class="comment">// TokenInformation</span>
02169                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
02170                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02171                  );
02172 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02173 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02174 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02175 <span class="preprocessor"></span>
02176 
02177     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02178 
02179         <span class="comment">//</span>
02180         <span class="comment">// Check returned value</span>
02181         <span class="comment">//    Group count = 2</span>
02182         <span class="comment">//    SID 0 = Flintstone</span>
02183         <span class="comment">//    SID 1 = ChildSid</span>
02184         <span class="comment">//    SID 2 = Neaderthol</span>
02185         <span class="comment">//    SID 3 = World</span>
02186         <span class="comment">//</span>
02187 
02188         ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02189 
02190         <span class="keywordflow">if</span> (RestrictedSids-&gt;GroupCount != <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>) {
02191             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02192         }
02193 
02194         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid),
02195                             <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>)) ||
02196              (RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes !=
02197               (SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_MANDATORY)) ) {
02198             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02199         }
02200 
02201         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid), <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>)) ||
02202              (RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes !=
02203               (SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_MANDATORY)) ) {
02204             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02205         }
02206 
02207 
02208         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid),
02209                             <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>)) ||
02210              (RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes !=
02211               (SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_MANDATORY)) ) {
02212             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02213         }
02214 
02215         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid), <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>)) ||
02216              (RestrictedSids-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes !=
02217               (SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_MANDATORY)) ) {
02218             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02219         }
02220 
02221 
02222 
02223         <span class="keywordflow">if</span> ( ValuesCompare ) {
02224             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02225         } <span class="keywordflow">else</span> {
02226             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02227             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02228             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02229             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02230             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned group count is: 0x%lx \n"</span>, RestrictedSids-&gt;GroupCount);
02231             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02232         }
02233     } <span class="keywordflow">else</span> {
02234         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02235         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02236         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02237         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02238     }
02239 
02240     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02241 
02242 
02243    <span class="comment">//</span>
02244    <span class="comment">// Query with too little buffer</span>
02245     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02246    <span class="comment">//</span>
02247 
02248     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query groups with too small buffer ...                 "</span>);
02249 
02250     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02251                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
02252                  TokenGroups,              <span class="comment">// TokenInformationClass</span>
02253                  GroupIds,                 <span class="comment">// TokenInformation</span>
02254                  ReturnLength-1,           <span class="comment">// TokenInformationLength</span>
02255                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02256                  );
02257 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02258 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02259 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02260 <span class="preprocessor"></span>
02261     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02262         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02263     } <span class="keywordflow">else</span> {
02264         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02265         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02266         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02267         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02268     }
02269 
02270     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02271 
02272 
02274 <span class="comment">//                                                                    //</span>
02275 <span class="comment">//        Query Privileges                                            //</span>
02276 <span class="comment">//                                                                    //</span>
02278 <span class="comment"></span>
02279 
02280    <span class="comment">//</span>
02281    <span class="comment">// Query groups with zero length buffer</span>
02282    <span class="comment">//</span>
02283 
02284     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query privileges with zero length buffer ...           "</span>);
02285 
02286     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02287                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
02288                  TokenPrivileges,          <span class="comment">// TokenInformationClass</span>
02289                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// TokenInformation</span>
02290                  0,                        <span class="comment">// TokenInformationLength</span>
02291                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02292                  );
02293 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02294 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02295 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02296 <span class="preprocessor"></span>
02297     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02298         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02299     } <span class="keywordflow">else</span> {
02300         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02301         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02302         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02303         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02304     }
02305 
02306     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02307 
02308 
02309 
02310 
02311     Privileges = (PTOKEN_PRIVILEGES)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02312                                                      ReturnLength
02313                                                      );
02314 
02315     <span class="comment">//</span>
02316     <span class="comment">// Query privileges</span>
02317     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02318     <span class="comment">//</span>
02319 
02320     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query privileges ...                                   "</span>);
02321 
02322     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02323                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
02324                  TokenPrivileges,          <span class="comment">// TokenInformationClass</span>
02325                  Privileges,               <span class="comment">// TokenInformation</span>
02326                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
02327                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02328                  );
02329 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02330 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02331 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02332 <span class="preprocessor"></span>
02333     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02334 
02335         <span class="comment">//</span>
02336         <span class="comment">// Check returned value</span>
02337         <span class="comment">//    Privilege count = PRIVILEGE_COUNT</span>
02338         <span class="comment">//    Privilege UNSOLICITED_INDEX    = UnsolicitedInputPrivilege</span>
02339         <span class="comment">//    Privilege SECURITY_INDEX       = SecurityPrivilege</span>
02340         <span class="comment">//    Privilege ASSIGN_PRIMARY_INDEX = AssignPrimaryPrivilege</span>
02341         <span class="comment">//</span>
02342 
02343         ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02344 
02345         <span class="keywordflow">if</span> (Privileges-&gt;PrivilegeCount != <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>) {
02346             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02347         }
02348 
02349         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid,
02350                &amp;<a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>)      ||
02351              (Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes != 0)             ) {
02352             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02353         }
02354 
02355         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid,
02356                &amp;<a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>)             ||
02357              (Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes != 0)             ) {
02358             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02359         }
02360 
02361         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Luid,
02362                &amp;<a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>)             ||
02363              (Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Attributes != SE_PRIVILEGE_ENABLED)             ) {
02364             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02365         }
02366 
02367 
02368         <span class="keywordflow">if</span> ( ValuesCompare ) {
02369             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02370         } <span class="keywordflow">else</span> {
02371         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02372         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02373         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02374         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02375         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02376         }
02377     } <span class="keywordflow">else</span> {
02378         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02379         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02380         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02381         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02382     }
02383 
02384     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02385 
02386 
02387    <span class="comment">//</span>
02388    <span class="comment">// Query with too little buffer</span>
02389     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02390    <span class="comment">//</span>
02391 
02392     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query privileges with too small buffer ...             "</span>);
02393 
02394     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02395                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
02396                  TokenPrivileges,          <span class="comment">// TokenInformationClass</span>
02397                  Privileges,               <span class="comment">// TokenInformation</span>
02398                  ReturnLength-1,           <span class="comment">// TokenInformationLength</span>
02399                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02400                  );
02401 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02402 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02403 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02404 <span class="preprocessor"></span>
02405     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02406         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02407     } <span class="keywordflow">else</span> {
02408         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02409         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02410         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02411         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02412     }
02413 
02414     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02415 
02416    <span class="comment">//</span>
02417    <span class="comment">// Query groups with zero length buffer</span>
02418    <span class="comment">//</span>
02419 
02420     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query rest privileges with zero length buffer ...      "</span>);
02421 
02422     ReturnLength = 0;
02423     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02424                  <a class="code" href="../../d2/d1/cttoken_8c.html#a25">TokenWithRestrictedPrivileges</a>,      <span class="comment">// Handle</span>
02425                  TokenPrivileges,          <span class="comment">// TokenInformationClass</span>
02426                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                     <span class="comment">// TokenInformation</span>
02427                  0,                        <span class="comment">// TokenInformationLength</span>
02428                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02429                  );
02430 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02431 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02432 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02433 <span class="preprocessor"></span>
02434     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02435         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02436     } <span class="keywordflow">else</span> {
02437         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02438         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02439         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02440         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02441     }
02442 
02443     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02444 
02445 
02446 
02447 
02448     Privileges = (PTOKEN_PRIVILEGES)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02449                                                      ReturnLength
02450                                                      );
02451 
02452     <span class="comment">//</span>
02453     <span class="comment">// Query privileges</span>
02454     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02455     <span class="comment">//</span>
02456 
02457     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query rest privileges ...                              "</span>);
02458 
02459     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02460                  <a class="code" href="../../d2/d1/cttoken_8c.html#a25">TokenWithRestrictedPrivileges</a>,      <span class="comment">// Handle</span>
02461                  TokenPrivileges,          <span class="comment">// TokenInformationClass</span>
02462                  Privileges,               <span class="comment">// TokenInformation</span>
02463                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
02464                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02465                  );
02466 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02467 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02468 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02469 <span class="preprocessor"></span>
02470     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02471 
02472         <span class="comment">//</span>
02473         <span class="comment">// Check returned value</span>
02474         <span class="comment">//    Privilege count = PRIVILEGE_COUNT -2</span>
02475         <span class="comment">//    Privilege ASSIGN_PRIMARY_INDEX = AssignPrimaryPrivilege</span>
02476         <span class="comment">//</span>
02477 
02478         ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02479 
02480         <span class="keywordflow">if</span> (Privileges-&gt;PrivilegeCount != <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> - 2) {
02481             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02482         }
02483 
02484 
02485         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;Privileges-&gt;Privileges[0].Luid,
02486                &amp;<a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>)             ||
02487              (Privileges-&gt;Privileges[0].Attributes != SE_PRIVILEGE_ENABLED)             ) {
02488             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02489         }
02490 
02491 
02492         <span class="keywordflow">if</span> ( ValuesCompare ) {
02493             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02494         } <span class="keywordflow">else</span> {
02495         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02496         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02497         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02498         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02499         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02500         }
02501     } <span class="keywordflow">else</span> {
02502         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02503         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02504         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02505         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02506     }
02507 
02508     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02509 
02510 
02512 <span class="comment">//                                                                    //</span>
02513 <span class="comment">//        Query Owner                                                 //</span>
02514 <span class="comment">//                                                                    //</span>
02516 <span class="comment"></span>
02517    <span class="comment">//</span>
02518    <span class="comment">// Query Owner of simple token with zero length buffer</span>
02519    <span class="comment">//</span>
02520 
02521     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query Owner of simple token with zero length buffer... "</span>);
02522 
02523     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02524                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
02525                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
02526                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                    <span class="comment">// TokenInformation</span>
02527                  0,                        <span class="comment">// TokenInformationLength</span>
02528                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02529                  );
02530 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02531 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02532 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02533 <span class="preprocessor"></span>
02534     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02535         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02536     } <span class="keywordflow">else</span> {
02537         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02538         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02539         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02540         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02541     }
02542 
02543     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02544 
02545 
02546 
02547     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = (PTOKEN_OWNER)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02548                                            ReturnLength
02549                                            );
02550 
02551     <span class="comment">//</span>
02552     <span class="comment">// Query Owner SID</span>
02553     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02554     <span class="comment">//</span>
02555 
02556     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query owner of simple token ...                        "</span>);
02557 
02558     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02559                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
02560                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
02561                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                    <span class="comment">// TokenInformation</span>
02562                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
02563                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02564                  );
02565 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02566 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02567 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02568 <span class="preprocessor"></span>
02569     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02570 
02571         <span class="comment">//</span>
02572         <span class="comment">// Check returned value</span>
02573         <span class="comment">//</span>
02574 
02575         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;Owner), <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>) ) {
02576             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02577         } <span class="keywordflow">else</span> {
02578         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02579         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02580         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02581         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02582         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02583         }
02584     } <span class="keywordflow">else</span> {
02585         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02586         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02587         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02588         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02589     }
02590 
02591     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02592 
02593 
02594     <span class="comment">//</span>
02595     <span class="comment">// Query owner of simple token with too little buffer</span>
02596     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02597     <span class="comment">//</span>
02598 
02599     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query owner of simple token with too small buffer ...  "</span>);
02600 
02601     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02602                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,              <span class="comment">// Handle</span>
02603                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
02604                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                    <span class="comment">// TokenInformation</span>
02605                  ReturnLength-1,           <span class="comment">// TokenInformationLength</span>
02606                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02607                  );
02608 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02609 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02610 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02611 <span class="preprocessor"></span>
02612     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02613         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02614     } <span class="keywordflow">else</span> {
02615         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02616         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02617         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02618         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02619     }
02620 
02621     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02622 
02623 
02624     <span class="comment">//</span>
02625     <span class="comment">// Query default owner of token with zero length buffer</span>
02626     <span class="comment">//</span>
02627 
02628     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query Default Owner of token with zero length buffer..."</span>);
02629 
02630     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02631                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a26">TokenWithDefaultOwner</a>,    <span class="comment">// Handle</span>
02632                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
02633                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                    <span class="comment">// TokenInformation</span>
02634                  0,                        <span class="comment">// TokenInformationLength</span>
02635                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02636                  );
02637 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02638 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02639 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02640 <span class="preprocessor"></span>
02641     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02642         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02643     } <span class="keywordflow">else</span> {
02644         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02645         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02646         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02647         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02648     }
02649 
02650     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02651 
02652 
02653 
02654 
02655     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = (PTOKEN_OWNER)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02656                                            ReturnLength
02657                                            );
02658 
02659     <span class="comment">//</span>
02660     <span class="comment">// Query default owner of token</span>
02661     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02662     <span class="comment">//</span>
02663 
02664     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query default owner of token ...                       "</span>);
02665 
02666     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02667                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a26">TokenWithDefaultOwner</a>,    <span class="comment">// Handle</span>
02668                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
02669                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                    <span class="comment">// TokenInformation</span>
02670                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
02671                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02672                  );
02673 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02674 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02675 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02676 <span class="preprocessor"></span>
02677     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02678 
02679         <span class="comment">//</span>
02680         <span class="comment">// Check returned value</span>
02681         <span class="comment">//</span>
02682 
02683         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;Owner), <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>) ) {
02684             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02685         } <span class="keywordflow">else</span> {
02686         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02687         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02688         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02689         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02690         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02691         }
02692     } <span class="keywordflow">else</span> {
02693         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02694         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02695         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02696         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02697     }
02698 
02699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02700 
02701 
02702     <span class="comment">//</span>
02703     <span class="comment">// Query default owner of token with too little buffer</span>
02704     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02705     <span class="comment">//</span>
02706 
02707     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query default owner of token with too small buffer ... "</span>);
02708 
02709     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02710                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a26">TokenWithDefaultOwner</a>,    <span class="comment">// Handle</span>
02711                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
02712                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                    <span class="comment">// TokenInformation</span>
02713                  ReturnLength-1,           <span class="comment">// TokenInformationLength</span>
02714                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02715                  );
02716 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02717 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02718 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02719 <span class="preprocessor"></span>
02720     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02721         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02722     } <span class="keywordflow">else</span> {
02723         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02724         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02725         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02726         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02727     }
02728 
02729     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02730 
02731 
02733 <span class="comment">//                                                                    //</span>
02734 <span class="comment">//        Query Default Dacl                                          //</span>
02735 <span class="comment">//                                                                    //</span>
02737 <span class="comment"></span>
02738    <span class="comment">//</span>
02739    <span class="comment">// Query default dacl with zero length buffer</span>
02740    <span class="comment">//</span>
02741 
02742     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query default DACL with zero length buffer ...         "</span>);
02743 
02744     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02745                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a28">TokenWithDefaultDacl</a>,     <span class="comment">// Handle</span>
02746                  TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
02747                  DefaultDacl,              <span class="comment">// TokenInformation</span>
02748                  0,                        <span class="comment">// TokenInformationLength</span>
02749                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02750                  );
02751 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02752 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02753 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02754 <span class="preprocessor"></span>
02755     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02756         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02757     } <span class="keywordflow">else</span> {
02758         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02759         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02760         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02761         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02762     }
02763 
02764     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02765 
02766 
02767 
02768 
02769     DefaultDacl = (PTOKEN_DEFAULT_DACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02770                                                         ReturnLength
02771                                                         );
02772 
02773     <span class="comment">//</span>
02774     <span class="comment">// Query default dacl</span>
02775     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02776     <span class="comment">//</span>
02777 
02778     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query default dacl ...                                 "</span>);
02779 
02780     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02781                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a28">TokenWithDefaultDacl</a>,     <span class="comment">// Handle</span>
02782                  TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
02783                  DefaultDacl,              <span class="comment">// TokenInformation</span>
02784                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
02785                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02786                  );
02787 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02788 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02789 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02790 <span class="preprocessor"></span>
02791     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02792 
02793         <span class="comment">//</span>
02794         <span class="comment">// Check returned value</span>
02795         <span class="comment">//</span>
02796 
02797         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>(DefaultDacl-&gt;DefaultDacl)) {
02798 
02799             <span class="keywordflow">if</span> (DefaultDacl-&gt;DefaultDacl-&gt;AceCount == 0) {
02800 
02801                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02802             } <span class="keywordflow">else</span> {
02803                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02804                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02805                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02806                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02807                 CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02808             }
02809         } <span class="keywordflow">else</span> {
02810             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02811             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02812             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02813             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02814             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02815         }
02816     } <span class="keywordflow">else</span> {
02817         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02818         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02819         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02820         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02821     }
02822 
02823     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02824 
02825 
02826    <span class="comment">//</span>
02827    <span class="comment">// Query with too little buffer</span>
02828    <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02829    <span class="comment">//</span>
02830 
02831     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query default Dacl with too small buffer ...           "</span>);
02832 
02833     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02834                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a28">TokenWithDefaultDacl</a>,     <span class="comment">// Handle</span>
02835                  TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
02836                  DefaultDacl,              <span class="comment">// TokenInformation</span>
02837                  ReturnLength-1,           <span class="comment">// TokenInformationLength</span>
02838                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02839                  );
02840 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02841 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02842 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02843 <span class="preprocessor"></span>
02844     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02845         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02846     } <span class="keywordflow">else</span> {
02847         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02848         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02849         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02850         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02851     }
02852 
02853     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02854 
02855 
02856    <span class="comment">//</span>
02857    <span class="comment">// Query token with no default dacl</span>
02858    <span class="comment">//</span>
02859 
02860     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query default dacl from token with none ...            "</span>);
02861 
02862     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02863                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,                <span class="comment">// Handle</span>
02864                  TokenDefaultDacl,           <span class="comment">// TokenInformationClass</span>
02865                  DefaultDacl,                <span class="comment">// TokenInformation</span>
02866                  <span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL), <span class="comment">// TokenInformationLength</span>
02867                  &amp;ReturnLength               <span class="comment">// ReturnLength</span>
02868                  );
02869 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02870 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02871 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02872 <span class="preprocessor"></span>
02873     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02874         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02875     } <span class="keywordflow">else</span> {
02876         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02877         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02878         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02879         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02880     }
02881 
02882     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02883 
02884 
02886 <span class="comment">//                                                                    //</span>
02887 <span class="comment">//        Query Token Source                                          //</span>
02888 <span class="comment">//                                                                    //</span>
02890 <span class="comment"></span>
02891    <span class="comment">//</span>
02892    <span class="comment">// Query Token Source with zero length buffer</span>
02893    <span class="comment">//</span>
02894 
02895     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query Token Source with zero length buffer ...         "</span>);
02896 
02897     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02898                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
02899                  TokenSource,              <span class="comment">// TokenInformationClass</span>
02900                  &amp;QueriedSource,           <span class="comment">// TokenInformation</span>
02901                  0,                        <span class="comment">// TokenInformationLength</span>
02902                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02903                  );
02904 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02905 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02906 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02907 <span class="preprocessor"></span>
02908     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
02909         <span class="keywordflow">if</span> (ReturnLength == <span class="keyword">sizeof</span>(TOKEN_SOURCE)) {
02910             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02911         } <span class="keywordflow">else</span> {
02912         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02913         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02914         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02915         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"TOKEN_SOURCE data size is 0x%lx \n"</span>, <span class="keyword">sizeof</span>(TOKEN_SOURCE));
02916         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02917         }
02918     } <span class="keywordflow">else</span> {
02919         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02920         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02921         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02922         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02923     }
02924 
02925     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02926 
02927 
02928 
02929     <span class="comment">//</span>
02930     <span class="comment">// Query token source</span>
02931     <span class="comment">//</span>
02932 
02933     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query token source ...                                 "</span>);
02934 
02935     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02936                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
02937                  TokenSource,              <span class="comment">// TokenInformationClass</span>
02938                  &amp;QueriedSource,           <span class="comment">// TokenInformation</span>
02939                  <span class="keyword">sizeof</span>(TOKEN_SOURCE),     <span class="comment">// TokenInformationLength</span>
02940                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
02941                  );
02942 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02943 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
02944 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
02945 <span class="preprocessor"></span>
02946     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02947 
02948         <span class="comment">//</span>
02949         <span class="comment">// Check returned value against TestSource</span>
02950         <span class="comment">//</span>
02951 
02952         ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02953 
02954         <span class="keywordflow">if</span> ( (QueriedSource.SourceName[0] != <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceName[0]) ||
02955              (QueriedSource.SourceName[1] != <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceName[1]) ||
02956              (QueriedSource.SourceName[2] != <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceName[2]) ||
02957              (QueriedSource.SourceName[3] != <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceName[3]) ||
02958              (QueriedSource.SourceName[4] != <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceName[4]) ||
02959              (QueriedSource.SourceName[5] != <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceName[5]) ||
02960              (QueriedSource.SourceName[6] != <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceName[6]) ||
02961              (QueriedSource.SourceName[7] != <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceName[7]) ) {
02962 
02963             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02964 
02965         }
02966 
02967         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;QueriedSource.SourceIdentifier,
02968                &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceIdentifier)   ) {
02969 
02970             ValuesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02971 
02972         }
02973 
02974 
02975         <span class="keywordflow">if</span> ( ValuesCompare ) {
02976             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
02977         } <span class="keywordflow">else</span> {
02978         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02979         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
02980         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02981         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02982         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02983         }
02984     } <span class="keywordflow">else</span> {
02985         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
02986         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02987         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
02988         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02989     }
02990 
02991     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02992 
02993 
02994     <span class="comment">//</span>
02995     <span class="comment">// Query with too little buffer</span>
02996     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
02997     <span class="comment">//</span>
02998 
02999     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query token source with too small buffer ...           "</span>);
03000 
03001     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03002                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
03003                  TokenSource,              <span class="comment">// TokenInformationClass</span>
03004                  &amp;QueriedSource,           <span class="comment">// TokenInformation</span>
03005                  ReturnLength - 1,         <span class="comment">// TokenInformationLength</span>
03006                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03007                  );
03008 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03009 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03010 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03011 <span class="preprocessor"></span>
03012     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
03013         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03014     } <span class="keywordflow">else</span> {
03015         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03016         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03017         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03018         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03019     }
03020 
03021     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03022 
03023 
03025 <span class="comment">//                                                                    //</span>
03026 <span class="comment">//        Query Token Type                                            //</span>
03027 <span class="comment">//                                                                    //</span>
03029 <span class="comment"></span>
03030    <span class="comment">//</span>
03031    <span class="comment">// Query Token type with zero length buffer</span>
03032    <span class="comment">//</span>
03033 
03034     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query Token type with zero length buffer ...           "</span>);
03035 
03036     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03037                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
03038                  TokenType,                <span class="comment">// TokenInformationClass</span>
03039                  &amp;QueriedType,             <span class="comment">// TokenInformation</span>
03040                  0,                        <span class="comment">// TokenInformationLength</span>
03041                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03042                  );
03043 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03044 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03045 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03046 <span class="preprocessor"></span>
03047     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
03048         <span class="keywordflow">if</span> (ReturnLength == <span class="keyword">sizeof</span>(TOKEN_TYPE)) {
03049             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03050         } <span class="keywordflow">else</span> {
03051         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03052         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03053         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03054         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"TOKEN_TYPE data size is 0x%lx \n"</span>, <span class="keyword">sizeof</span>(TOKEN_TYPE));
03055         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03056         }
03057     } <span class="keywordflow">else</span> {
03058         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03059         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03060         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03061         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03062     }
03063 
03064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03065 
03066 
03067 
03068 
03069     <span class="comment">//</span>
03070     <span class="comment">// Query token type</span>
03071     <span class="comment">//</span>
03072 
03073     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query token type ...                                   "</span>);
03074 
03075     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03076                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
03077                  TokenType,                <span class="comment">// TokenInformationClass</span>
03078                  &amp;QueriedType,             <span class="comment">// TokenInformation</span>
03079                  <span class="keyword">sizeof</span>(TOKEN_TYPE),       <span class="comment">// TokenInformationLength</span>
03080                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03081                  );
03082 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03083 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03084 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03085 <span class="preprocessor"></span>
03086     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03087 
03088         <span class="comment">//</span>
03089         <span class="comment">// Check returned value against TestSource</span>
03090         <span class="comment">//</span>
03091 
03092 
03093         <span class="keywordflow">if</span> ( QueriedType == TokenPrimary ) {
03094             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03095         } <span class="keywordflow">else</span> {
03096         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03097         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
03098         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03099         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03100         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned token type is: 0x%lx \n"</span>, QueriedType);
03101         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03102         }
03103     } <span class="keywordflow">else</span> {
03104         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03105         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03106         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03107         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03108     }
03109 
03110     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03111 
03112 
03113     <span class="comment">//</span>
03114     <span class="comment">// Query with too little buffer</span>
03115     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
03116     <span class="comment">//</span>
03117 
03118     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query token type with too small buffer ...             "</span>);
03119 
03120     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03121                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
03122                  TokenType,                <span class="comment">// TokenInformationClass</span>
03123                  &amp;QueriedType,             <span class="comment">// TokenInformation</span>
03124                  ReturnLength - 1,         <span class="comment">// TokenInformationLength</span>
03125                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03126                  );
03127 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03128 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03129 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03130 <span class="preprocessor"></span>
03131     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
03132         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03133     } <span class="keywordflow">else</span> {
03134         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03135         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03136         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03137         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03138     }
03139 
03140     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03141 
03142 
03144 <span class="comment">//                                                                    //</span>
03145 <span class="comment">//        Query Impersonation Level                                   //</span>
03146 <span class="comment">//                                                                    //</span>
03148 <span class="comment"></span>
03149    <span class="comment">//</span>
03150    <span class="comment">// Query Impersonation Level of primary token</span>
03151    <span class="comment">//</span>
03152 
03153     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query Impersonation level of primary token ...         "</span>);
03154 
03155     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03156                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,                  <span class="comment">// Handle</span>
03157                  TokenImpersonationLevel,              <span class="comment">// TokenInformationClass</span>
03158                  &amp;QueriedImpersonationLevel,           <span class="comment">// TokenInformation</span>
03159                  <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL), <span class="comment">// TokenInformationLength</span>
03160                  &amp;ReturnLength                         <span class="comment">// ReturnLength</span>
03161                  );
03162 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03163 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03164 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03165 <span class="preprocessor"></span>
03166     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_INFO_CLASS) {
03167         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03168     } <span class="keywordflow">else</span> {
03169         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03170         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03171         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03172         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03173     }
03174 
03175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_INFO_CLASS);
03176 
03177 
03179 <span class="comment">//                                                                    //</span>
03180 <span class="comment">//        Query Token Statistics                                      //</span>
03181 <span class="comment">//                                                                    //</span>
03183 <span class="comment"></span>
03184    <span class="comment">//</span>
03185    <span class="comment">// Query Token statistics with zero length buffer</span>
03186    <span class="comment">//</span>
03187 
03188     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query Token statistics with zero length buffer ...     "</span>);
03189 
03190     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03191                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
03192                  TokenStatistics,          <span class="comment">// TokenInformationClass</span>
03193                  &amp;QueriedStatistics,       <span class="comment">// TokenInformation</span>
03194                  0,                        <span class="comment">// TokenInformationLength</span>
03195                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03196                  );
03197 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03198 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03199 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03200 <span class="preprocessor"></span>
03201     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
03202         <span class="keywordflow">if</span> (ReturnLength == <span class="keyword">sizeof</span>(TOKEN_STATISTICS)) {
03203             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03204         } <span class="keywordflow">else</span> {
03205         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03206         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03207         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03208         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"TOKEN_STATISTICS data size is 0x%lx \n"</span>, <span class="keyword">sizeof</span>(TOKEN_STATISTICS));
03209         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03210         }
03211     } <span class="keywordflow">else</span> {
03212         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03213         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03214         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03215         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03216     }
03217 
03218     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03219 
03220 
03221 
03222 
03223     <span class="comment">//</span>
03224     <span class="comment">// Query token statistics</span>
03225     <span class="comment">//</span>
03226 
03227     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query token statistics ...                             "</span>);
03228 
03229     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03230                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
03231                  TokenStatistics,          <span class="comment">// TokenInformationClass</span>
03232                  &amp;QueriedStatistics,       <span class="comment">// TokenInformation</span>
03233                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS), <span class="comment">// TokenInformationLength</span>
03234                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03235                  );
03236 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03237 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03238 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03239 <span class="preprocessor"></span>
03240     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03241 
03242         <span class="comment">//</span>
03243         <span class="comment">// Check returned value against TestSource</span>
03244         <span class="comment">//</span>
03245 
03246         <span class="keywordflow">if</span> ( ( QueriedStatistics.TokenType == TokenPrimary) &amp;&amp;
03247              ( QueriedStatistics.GroupCount == 4 )          &amp;&amp;
03248              ( QueriedStatistics.PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>) ) {
03249             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03250         } <span class="keywordflow">else</span> {
03251             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03252             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
03253             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03254             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03255             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned token type is: 0x%lx \n"</span>, QueriedStatistics.TokenType);
03256             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned group count is: 0x%lx \n"</span>, QueriedStatistics.GroupCount);
03257             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Returned privilege count is: 0x%lx \n"</span>, QueriedStatistics.PrivilegeCount);
03258             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03259         }
03260     } <span class="keywordflow">else</span> {
03261         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03262         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03263         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03264         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03265     }
03266 
03267     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03268 
03269 
03270     <span class="comment">//</span>
03271     <span class="comment">// Query with too little buffer</span>
03272     <span class="comment">// (This relies upon the ReturnLength returned from previous call)</span>
03273     <span class="comment">//</span>
03274 
03275     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Query token statistics with too small buffer ...       "</span>);
03276 
03277     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03278                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,      <span class="comment">// Handle</span>
03279                  TokenStatistics,          <span class="comment">// TokenInformationClass</span>
03280                  &amp;QueriedStatistics,       <span class="comment">// TokenInformation</span>
03281                  ReturnLength - 1,         <span class="comment">// TokenInformationLength</span>
03282                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03283                  );
03284 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03285 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03286 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03287 <span class="preprocessor"></span>
03288     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
03289         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03290     } <span class="keywordflow">else</span> {
03291         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03292         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03293         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03294         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03295     }
03296 
03297     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03298 
03299 
03300 
03301     <span class="keywordflow">return</span> CompletionStatus;
03302 }
03303 
03305 <span class="comment">//                                                            //</span>
03306 <span class="comment">// Set Token Test                                             //</span>
03307 <span class="comment">//                                                            //</span>
03309 <span class="comment"></span>
03310 BOOLEAN
<a name="l03311"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a70">03311</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a70">TestTokenSet</a>()
03312 {
03313     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03314     ULONG InformationLength;
03315     ULONG ReturnLength;
03316 
03317     TOKEN_STATISTICS QueriedStatistics;
03318 
03319     TOKEN_PRIMARY_GROUP AssignedPrimaryGroup;
03320     PTOKEN_PRIMARY_GROUP QueriedPrimaryGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03321 
03322     TOKEN_OWNER AssignedOwner;
03323     PTOKEN_OWNER QueriedOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03324 
03325     TOKEN_DEFAULT_DACL AssignedDefaultDacl;
03326     PTOKEN_DEFAULT_DACL QueriedDefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03327 
03328     PSID TooBigSid;
03329 
03330     SID_IDENTIFIER_AUTHORITY BedrockAuthority = <a class="code" href="../../d4/d6/tsevars_8c.html#a0">BEDROCK_AUTHORITY</a>;
03331 
03332     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
03333 
03334 
03335    <span class="comment">//</span>
03336    <span class="comment">// Set owner of a token to be an invalid group</span>
03337    <span class="comment">//</span>
03338 
03339     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Set default owner to be an invalid group ...           "</span>);
03340 
03341     AssignedOwner.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
03342     InformationLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER);
03343 
03344     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a>(
03345                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03346                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
03347                  &amp;AssignedOwner,           <span class="comment">// TokenInformation</span>
03348                  InformationLength         <span class="comment">// TokenInformationLength</span>
03349                  );
03350 
03351     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_OWNER) {
03352         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03353     } <span class="keywordflow">else</span> {
03354         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03355         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03356         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"InformationLength is: 0x%lx \n"</span>, InformationLength);
03357         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03358     }
03359 
03360     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_OWNER);
03361 
03362 
03363    <span class="comment">//</span>
03364    <span class="comment">// Set owner of a token to be an ID not in the token</span>
03365    <span class="comment">//</span>
03366 
03367     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Set default owner to be an ID not in the token ...     "</span>);
03368 
03369     AssignedOwner.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a>;
03370     InformationLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER);
03371 
03372     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a>(
03373                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03374                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
03375                  &amp;AssignedOwner,           <span class="comment">// TokenInformation</span>
03376                  InformationLength         <span class="comment">// TokenInformationLength</span>
03377                  );
03378 
03379     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_OWNER) {
03380         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03381     } <span class="keywordflow">else</span> {
03382         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03383         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03384         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"InformationLength is: 0x%lx \n"</span>, InformationLength);
03385         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03386     }
03387 
03388     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_OWNER);
03389 
03390 
03391    <span class="comment">//</span>
03392    <span class="comment">// Set owner of a token to be a valid group</span>
03393    <span class="comment">//</span>
03394 
03395     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Set default owner to be a valid group ...              "</span>);
03396 
03397     AssignedOwner.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
03398     InformationLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER);
03399 
03400     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a>(
03401                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03402                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
03403                  &amp;AssignedOwner,           <span class="comment">// TokenInformation</span>
03404                  InformationLength         <span class="comment">// TokenInformationLength</span>
03405                  );
03406 
03407     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03408         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03409         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03410         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"InformationLength is: 0x%lx \n"</span>, InformationLength);
03411         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03412     }
03413 
03414     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03415 
03416     <span class="comment">//</span>
03417     <span class="comment">// Query the Owner to see that it was set properly</span>
03418     <span class="comment">//</span>
03419 
03420     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03421                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03422                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
03423                  QueriedOwner,             <span class="comment">// TokenInformation</span>
03424                  0,                        <span class="comment">// TokenInformationLength</span>
03425                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03426                  );
03427 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03428 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03429 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03430 <span class="preprocessor"></span>
03431     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL) {
03432         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed Query of length ************\n"</span>);
03433         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03434         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03435         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03436     }
03437 
03438     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03439 
03440     QueriedOwner = (PTOKEN_OWNER)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03441                                                   ReturnLength
03442                                                   );
03443 
03444     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03445                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03446                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
03447                  QueriedOwner,             <span class="comment">// TokenInformation</span>
03448                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
03449                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03450                  );
03451 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03452 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03453 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03454 <span class="preprocessor"></span>
03455     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03456 
03457         <span class="comment">//</span>
03458         <span class="comment">// Check returned value</span>
03459         <span class="comment">//</span>
03460 
03461         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((QueriedOwner-&gt;Owner), AssignedOwner.Owner) ) {
03462             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03463         } <span class="keywordflow">else</span> {
03464         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed Comparison ************\n"</span>);
03465         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
03466         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03467         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03468         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03469         }
03470     } <span class="keywordflow">else</span> {
03471         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed Query Of Value ************\n"</span>);
03472         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03473         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03474         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03475     }
03476 
03477     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03478 
03479 
03480     <span class="comment">//</span>
03481     <span class="comment">//  Set Default Dacl</span>
03482 
03483     <span class="comment">//</span>
03484     <span class="comment">// Get a buffer for use in all Default Dacl assignment tests.</span>
03485     <span class="comment">// This will be initialized to different sizes for each test.</span>
03486     <span class="comment">//</span>
03487 
03488     AssignedDefaultDacl.DefaultDacl =
03489         (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a6">TOO_BIG_ACL_SIZE</a> );
03490 
03491 
03492     <span class="comment">//</span>
03493     <span class="comment">// Assign a discretionary ACL to a token that doesn't yet have one</span>
03494     <span class="comment">//</span>
03495 
03496     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Set original discretionary ACL in token ...            "</span>);
03497 
03498     InformationLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL);
03499     <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( AssignedDefaultDacl.DefaultDacl, 200, ACL_REVISION );
03500 
03501     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03502                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,            <span class="comment">// Handle</span>
03503                  TokenDefaultDacl,           <span class="comment">// TokenInformationClass</span>
03504                  &amp;QueriedDefaultDacl,        <span class="comment">// TokenInformation</span>
03505                  0,                          <span class="comment">// TokenInformationLength</span>
03506                  &amp;ReturnLength               <span class="comment">// ReturnLength</span>
03507                  );
03508 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03509 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03510 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03511 <span class="preprocessor"></span>
03512     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL);
03513 
03514     <span class="keywordflow">if</span> (ReturnLength != <span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL)) {
03515 
03516         <span class="comment">//</span>
03517         <span class="comment">// Wait a minute, this token has a default Dacl</span>
03518         <span class="comment">//</span>
03519 
03520             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"******** Failed - token has default dacl *********\n"</span>);
03521             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03522             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03523 
03524     } <span class="keywordflow">else</span> {
03525 
03526         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a>(
03527                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03528                      TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
03529                      &amp;AssignedDefaultDacl,     <span class="comment">// TokenInformation</span>
03530                      InformationLength         <span class="comment">// TokenInformationLength</span>
03531                      );
03532 
03533         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03534             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03535         } <span class="keywordflow">else</span> {
03536             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03537             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03538             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03539         }
03540 
03541     }
03542 
03543     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03544 
03545     <span class="comment">//</span>
03546     <span class="comment">// Replace a discretionary ACL in a token that already has one</span>
03547     <span class="comment">// Make it big to help with future "too big" tests...</span>
03548     <span class="comment">//</span>
03549 
03550 
03551     <span class="comment">//</span>
03552     <span class="comment">// find out how much space is available</span>
03553     <span class="comment">//</span>
03554 
03555     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03556                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,                 <span class="comment">// Handle</span>
03557                  TokenStatistics,                 <span class="comment">// TokenInformationClass</span>
03558                  &amp;QueriedStatistics,              <span class="comment">// TokenInformation</span>
03559                  (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS), <span class="comment">// TokenInformationLength</span>
03560                  &amp;ReturnLength                    <span class="comment">// ReturnLength</span>
03561                  );
03562 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03563 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03564 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03565 <span class="preprocessor"></span>
03566     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03567 
03568     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03569                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03570                  TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
03571                  &amp;QueriedDefaultDacl,      <span class="comment">// TokenInformation</span>
03572                  0,                        <span class="comment">// TokenInformationLength</span>
03573                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03574                  );
03575 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03576 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03577 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03578 <span class="preprocessor"></span>
03579     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL);
03580 
03581 
03582     <span class="keywordflow">if</span> (ReturnLength &gt; <span class="keyword">sizeof</span>(TOKEN_STATISTICS)) {
03583         <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = ReturnLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS);
03584     } <span class="keywordflow">else</span> {
03585         <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = 0;
03586     }
03587 
03588     <a class="code" href="../../d6/d0/ctaccess_8c.html#a46">LengthAvailable</a> = QueriedStatistics.DynamicAvailable + <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>;
03589 
03590     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Replace discretionary ACL in token ...                 "</span>);
03591 
03592     InformationLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL);
03593     <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( AssignedDefaultDacl.DefaultDacl,
03594                   (ULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a46">LengthAvailable</a> - 50),
03595                   ACL_REVISION
03596                   );
03597 
03598     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03599                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03600                  TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
03601                  &amp;QueriedDefaultDacl,      <span class="comment">// TokenInformation</span>
03602                  0,                        <span class="comment">// TokenInformationLength</span>
03603                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03604                  );
03605 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03606 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03607 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03608 <span class="preprocessor"></span>
03609 
03610     <span class="keywordflow">if</span> (!(ReturnLength &gt; <span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL))) {
03611 
03612         <span class="comment">//</span>
03613         <span class="comment">// Wait a minute, this token doesn't have a default Dacl</span>
03614         <span class="comment">//</span>
03615 
03616             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"******** Failed - No default dacl *********\n"</span>);
03617             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03618 
03619     } <span class="keywordflow">else</span> {
03620 
03621         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a>(
03622                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03623                      TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
03624                      &amp;AssignedDefaultDacl,     <span class="comment">// TokenInformation</span>
03625                      InformationLength         <span class="comment">// TokenInformationLength</span>
03626                      );
03627 
03628         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03629             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03630         } <span class="keywordflow">else</span> {
03631             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03632             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03633             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03634         }
03635 
03636     }
03637 
03638     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03639 
03640 
03641     <span class="comment">//</span>
03642     <span class="comment">// Assign a discretionary ACL that doesn't fit into the dynamic part of the</span>
03643     <span class="comment">// token.</span>
03644     <span class="comment">//</span>
03645 
03646 
03647     <span class="comment">//</span>
03648     <span class="comment">// find out how much space is available</span>
03649     <span class="comment">//</span>
03650 
03651     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03652                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,                 <span class="comment">// Handle</span>
03653                  TokenStatistics,                 <span class="comment">// TokenInformationClass</span>
03654                  &amp;QueriedStatistics,              <span class="comment">// TokenInformation</span>
03655                  (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS), <span class="comment">// TokenInformationLength</span>
03656                  &amp;ReturnLength                    <span class="comment">// ReturnLength</span>
03657                  );
03658 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03659 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03660 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03661 <span class="preprocessor"></span>
03662     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03663 
03664     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03665                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03666                  TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
03667                  &amp;QueriedDefaultDacl,      <span class="comment">// TokenInformation</span>
03668                  0,                        <span class="comment">// TokenInformationLength</span>
03669                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03670                  );
03671 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03672 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03673 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03674 <span class="preprocessor"></span>
03675     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL);
03676 
03677 
03678     <span class="keywordflow">if</span> (ReturnLength &gt; <span class="keyword">sizeof</span>(TOKEN_STATISTICS)) {
03679         <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = ReturnLength - (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS);
03680     } <span class="keywordflow">else</span> {
03681         <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = 0;
03682     }
03683 
03684     <a class="code" href="../../d6/d0/ctaccess_8c.html#a46">LengthAvailable</a> = QueriedStatistics.DynamicAvailable + <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>;
03685 
03686     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Set too big discretionary ACL ...                      "</span>);
03687 
03688 
03689     <span class="comment">//</span>
03690     <span class="comment">// Now make sure our ACL is large enough to exceed the available</span>
03691     <span class="comment">// space.</span>
03692     <span class="comment">//</span>
03693 
03694     <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( AssignedDefaultDacl.DefaultDacl,
03695                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a6">TOO_BIG_ACL_SIZE</a>,
03696                   ACL_REVISION
03697                   );
03698 
03699     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a6">TOO_BIG_ACL_SIZE</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a46">LengthAvailable</a>) {
03700 
03701         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed - Dynamic too big ************\n"</span>);
03702         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Dynamic available is: 0x%lx \n"</span>,
03703             QueriedStatistics.DynamicAvailable);
03704         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Current default Dacl size is: 0x%lx \n"</span>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>);
03705         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Big ACL size is: 0x%lx \n"</span>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a6">TOO_BIG_ACL_SIZE</a>);
03706         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03707     }
03708 
03709 
03710     InformationLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL);
03711 
03712     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a>(
03713                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03714                  TokenDefaultDacl,         <span class="comment">// TokenInformationClass</span>
03715                  &amp;AssignedDefaultDacl,     <span class="comment">// TokenInformation</span>
03716                  InformationLength         <span class="comment">// TokenInformationLength</span>
03717                  );
03718 
03719     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALLOTTED_SPACE_EXCEEDED) {
03720         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03721     } <span class="keywordflow">else</span> {
03722         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03723         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03724         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Dynamic available is: 0x%lx \n"</span>,
03725             QueriedStatistics.DynamicAvailable);
03726         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Current default Dacl size is: 0x%lx \n"</span>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>);
03727         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Big ACL size is: 0x%lx \n"</span>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a6">TOO_BIG_ACL_SIZE</a>);
03728         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03729     }
03730 
03731     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALLOTTED_SPACE_EXCEEDED);
03732 
03733 
03734    <span class="comment">//</span>
03735    <span class="comment">// Set primary group</span>
03736    <span class="comment">//</span>
03737 
03738     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Set primary group ...                                  "</span>);
03739 
03740     AssignedPrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a26">RubbleSid</a>;
03741     InformationLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP);
03742 
03743     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a>(
03744                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03745                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
03746                  &amp;AssignedPrimaryGroup,    <span class="comment">// TokenInformation</span>
03747                  InformationLength         <span class="comment">// TokenInformationLength</span>
03748                  );
03749 
03750     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03751         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03752         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03753         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"InformationLength is: 0x%lx \n"</span>, InformationLength);
03754         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03755     }
03756 
03757     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03758 
03759 
03760     <span class="comment">//</span>
03761     <span class="comment">// Query the Primary Group to see that it was set properly</span>
03762     <span class="comment">//</span>
03763 
03764     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03765                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03766                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
03767                  QueriedPrimaryGroup,      <span class="comment">// TokenInformation</span>
03768                  0,                        <span class="comment">// TokenInformationLength</span>
03769                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03770                  );
03771 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03772 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03773 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03774 <span class="preprocessor"></span>
03775     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL) {
03776         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed Query of length ************\n"</span>);
03777         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03778         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03779         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03780     }
03781 
03782     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03783 
03784     QueriedPrimaryGroup =
03785         (PTOKEN_PRIMARY_GROUP)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03786                                                ReturnLength
03787                                                );
03788 
03789     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03790                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03791                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
03792                  QueriedPrimaryGroup,      <span class="comment">// TokenInformation</span>
03793                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
03794                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03795                  );
03796 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03797 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03798 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03799 <span class="preprocessor"></span>
03800     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03801 
03802         <span class="comment">//</span>
03803         <span class="comment">// Check returned value</span>
03804         <span class="comment">//</span>
03805 
03806         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((QueriedPrimaryGroup-&gt;PrimaryGroup),
03807             AssignedPrimaryGroup.PrimaryGroup) ) {
03808             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03809         } <span class="keywordflow">else</span> {
03810         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed Comparison ************\n"</span>);
03811         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unexpected value returned by query.\n"</span>);
03812         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03813         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03814         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03815         }
03816     } <span class="keywordflow">else</span> {
03817         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed Query Of Value ************\n"</span>);
03818         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03819         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Required return length is: 0x%lx \n"</span>, ReturnLength);
03820         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03821     }
03822 
03823     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03824 
03825 
03826     <span class="comment">//</span>
03827     <span class="comment">// Assign a primary group that doesn't fit into the dynamic part of the</span>
03828     <span class="comment">// token.</span>
03829     <span class="comment">//</span>
03830 
03831 
03832     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Set too big primary group ...                          "</span>);
03833 
03834     <span class="comment">//</span>
03835     <span class="comment">// First, find out how much space is available</span>
03836     <span class="comment">//</span>
03837 
03838     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03839                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,                 <span class="comment">// Handle</span>
03840                  TokenStatistics,                 <span class="comment">// TokenInformationClass</span>
03841                  &amp;QueriedStatistics,              <span class="comment">// TokenInformation</span>
03842                  (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS), <span class="comment">// TokenInformationLength</span>
03843                  &amp;ReturnLength                    <span class="comment">// ReturnLength</span>
03844                  );
03845 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03846 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03847 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03848 <span class="preprocessor"></span>
03849     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03850 
03851     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03852                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03853                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
03854                  QueriedPrimaryGroup,      <span class="comment">// TokenInformation</span>
03855                  ReturnLength,             <span class="comment">// TokenInformationLength</span>
03856                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
03857                  );
03858 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
03859 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
03860 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
03861 <span class="preprocessor"></span>
03862     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03863 
03864     <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(QueriedPrimaryGroup-&gt;PrimaryGroup);
03865     <a class="code" href="../../d6/d0/ctaccess_8c.html#a46">LengthAvailable</a> = QueriedStatistics.DynamicAvailable + <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>;
03866 
03867     <span class="comment">//</span>
03868     <span class="comment">// Now make sure our fake group ID is large enough to exceed the available</span>
03869     <span class="comment">// space.</span>
03870     <span class="comment">//</span>
03871 
03872     TooBigSid = (PSID)TstAllocatePool(
03873                           <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03874                           <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a5">TOO_BIG_PRIMARY_GROUP_SIZE</a> )
03875                           );
03876 
03877     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(
03878         TooBigSid,
03879         &amp;BedrockAuthority,
03880         <a class="code" href="../../d2/d1/cttoken_8c.html#a5">TOO_BIG_PRIMARY_GROUP_SIZE</a>
03881         );
03882 
03883     <span class="keywordflow">if</span> ((ULONG) <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(TooBigSid) &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a46">LengthAvailable</a>) {
03884 
03885         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed - Dynamic too big ************\n"</span>);
03886         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Dynamic available is: 0x%lx \n"</span>,
03887             QueriedStatistics.DynamicAvailable);
03888         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Existing primary group length is: 0x%lx \n"</span>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>);
03889         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Big SID size is: 0x%lx \n"</span>, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(TooBigSid));
03890         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03891     }
03892 
03893 
03894     AssignedPrimaryGroup.PrimaryGroup = TooBigSid;
03895     InformationLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP);
03896 
03897     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a>(
03898                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,          <span class="comment">// Handle</span>
03899                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
03900                  &amp;AssignedPrimaryGroup,    <span class="comment">// TokenInformation</span>
03901                  InformationLength         <span class="comment">// TokenInformationLength</span>
03902                  );
03903 
03904     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALLOTTED_SPACE_EXCEEDED) {
03905         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
03906     } <span class="keywordflow">else</span> {
03907         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
03908         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03909         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Dynamic available is: 0x%lx \n"</span>,
03910             QueriedStatistics.DynamicAvailable);
03911         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Existing primary group length is: 0x%lx \n"</span>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>);
03912         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Big SID size is: 0x%lx \n"</span>, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(TooBigSid));
03913         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03914     }
03915 
03916 
03917 
03918 
03919     <span class="keywordflow">return</span> CompletionStatus;
03920 }
03921 
03923 <span class="comment">//                                                            //</span>
03924 <span class="comment">// Adjust Privileges Test                                     //</span>
03925 <span class="comment">//                                                            //</span>
03927 <span class="comment"></span>
03928 BOOLEAN
<a name="l03929"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a71">03929</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a71">TestTokenAdjustPrivileges</a>()
03930 {
03931 
03932     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03933     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03934     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> IgnoreStatus;
03935 
03936     PTOKEN_PRIVILEGES NewState;
03937     PTOKEN_PRIVILEGES PreviousState;
03938     PTOKEN_PRIVILEGES PrePrivileges;
03939     PTOKEN_PRIVILEGES PostPrivileges;
03940 
03941     ULONG NewStateBufferLength = 200;
03942     ULONG PreviousStateBufferLength = 200;
03943     ULONG PrePrivilegesLength = 200;
03944     ULONG PostPrivilegesLength = 200;
03945 
03946     ULONG ReturnLength;
03947     ULONG IgnoreReturnLength;
03948 
03949     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
03950 
03951     PreviousState = (PTOKEN_PRIVILEGES)TstAllocatePool(
03952                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03953                         PreviousStateBufferLength
03954                         );
03955 
03956     PrePrivileges = (PTOKEN_PRIVILEGES)TstAllocatePool(
03957                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03958                         PrePrivilegesLength
03959                         );
03960 
03961     PostPrivileges = (PTOKEN_PRIVILEGES)TstAllocatePool(
03962                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03963                         PostPrivilegesLength
03964                         );
03965 
03966     NewState = (PTOKEN_PRIVILEGES)TstAllocatePool(
03967                    <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03968                    NewStateBufferLength
03969                    );
03970 
03971 
03972 
03973 
03974 
03976     <span class="comment">//                                                                  //</span>
03977     <span class="comment">// Adjust privileges giving no instructions                         //</span>
03978     <span class="comment">//                                                                  //</span>
03980 <span class="comment"></span>
03981 
03982     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Adjust privileges with no instructions ...             "</span>);
03983 
03984     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
03985                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,                      <span class="comment">// TokenHandle</span>
03986                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
03987                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// NewState (OPTIONAL)</span>
03988                  0,                                <span class="comment">// BufferLength</span>
03989                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
03990                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
03991                  );
03992 
03993     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_PARAMETER) {
03994 
03995         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
03996 
03997     } <span class="keywordflow">else</span> {
03998 
03999         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04000         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04001         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04002         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04003 
04004     }
04005 
04006     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_PARAMETER);
04007 
04008 
04010     <span class="comment">//                                                                  //</span>
04011     <span class="comment">// Enable privileges in token with no privileges                    //</span>
04012     <span class="comment">//                                                                  //</span>
04014 <span class="comment"></span>
04015 
04016     NewState-&gt;PrivilegeCount = 1;
04017     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
04018     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
04019 
04020     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable privilege in token with none ...                "</span>);
04021 
04022     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04023                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,                      <span class="comment">// TokenHandle</span>
04024                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04025                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
04026                  0,                                <span class="comment">// BufferLength</span>
04027                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04028                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04029                  );
04030 
04031     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED) {
04032 
04033         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04034 
04035     } <span class="keywordflow">else</span> {
04036 
04037         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04038         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04039         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04040         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04041 
04042     }
04043 
04044     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED);
04045 
04046 
04048     <span class="comment">//                                                                  //</span>
04049     <span class="comment">//  Enable a privilege that isn't assigned                          //</span>
04050     <span class="comment">//                                                                  //</span>
04052 <span class="comment"></span>
04053     NewState-&gt;PrivilegeCount = 1;
04054     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a40">CreateTokenPrivilege</a>;
04055     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
04056 
04057     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable unassigned privilege in token with some ...     "</span>);
04058 
04059     PrePrivileges-&gt;PrivilegeCount = 77;
04060     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04061                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04062                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04063                        PrePrivileges,              <span class="comment">// TokenInformation</span>
04064                        PrePrivilegesLength,        <span class="comment">// TokenInformationLength</span>
04065                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04066                        );
04067 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04068 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04069 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04070 <span class="preprocessor"></span>
04071     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04072     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04073 
04074     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04075                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04076                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04077                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
04078                  0,                                <span class="comment">// BufferLength</span>
04079                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04080                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04081                  );
04082 
04083     PostPrivileges-&gt;PrivilegeCount = 88;
04084     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04085                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04086                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04087                        PostPrivileges,             <span class="comment">// TokenInformation</span>
04088                        PostPrivilegesLength,       <span class="comment">// TokenInformationLength</span>
04089                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04090                        );
04091 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04092 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04093 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04094 <span class="preprocessor"></span>
04095     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostPrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04096     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04097 
04098     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED) {
04099 
04100          <span class="comment">//</span>
04101          <span class="comment">// Check the privilege values</span>
04102          <span class="comment">//</span>
04103 
04104          <span class="keywordflow">if</span> ( (PrePrivileges-&gt;Privileges[0].Attributes ==
04105                PostPrivileges-&gt;Privileges[0].Attributes)    &amp;&amp;
04106               (PrePrivileges-&gt;Privileges[1].Attributes ==
04107                PostPrivileges-&gt;Privileges[1].Attributes)    ) {
04108 
04109             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04110 
04111          } <span class="keywordflow">else</span> {
04112 
04113             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed Value Check ************\n"</span>);
04114             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04115             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 0 state: 0x%lx,  0x%lx \n"</span>,
04116                     PrePrivileges-&gt;Privileges[0].Attributes,
04117                     PostPrivileges-&gt;Privileges[0].Attributes);
04118             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 1 state: 0x%lx,  0x%lx \n"</span>,
04119                     PrePrivileges-&gt;Privileges[1].Attributes,
04120                     PostPrivileges-&gt;Privileges[1].Attributes);
04121             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04122             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04123 
04124         }
04125 
04126     } <span class="keywordflow">else</span> {
04127 
04128         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04129         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04130         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04131         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04132 
04133     }
04134 
04135     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED);
04136 
04137 
04138 
04139 
04141     <span class="comment">//                                                                  //</span>
04142     <span class="comment">// Disable All Privileges (which they already are)                  //</span>
04143     <span class="comment">//                                                                  //</span>
04145 <span class="comment"></span>
04146     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable already disabled privileges ...                "</span>);
04147 
04148     PrePrivileges-&gt;PrivilegeCount = 77;
04149     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04150                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04151                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04152                        PrePrivileges,              <span class="comment">// TokenInformation</span>
04153                        PrePrivilegesLength,        <span class="comment">// TokenInformationLength</span>
04154                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04155                        );
04156 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04157 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04158 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04159 <span class="preprocessor"></span>
04160     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04161     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[0].Attributes == 0 );
04162     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[1].Attributes == 0 );
04163     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04164 
04165     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04166                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04167                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                             <span class="comment">// DisableAllPrivileges</span>
04168                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// NewState (OPTIONAL)</span>
04169                  0,                                <span class="comment">// BufferLength</span>
04170                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04171                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04172                  );
04173 
04174 
04175     PostPrivileges-&gt;PrivilegeCount = 88;
04176     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04177                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04178                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04179                        PostPrivileges,             <span class="comment">// TokenInformation</span>
04180                        PostPrivilegesLength,       <span class="comment">// TokenInformationLength</span>
04181                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04182                        );
04183 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04184 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04185 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04186 <span class="preprocessor"></span>
04187     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostPrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04188     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04189 
04190     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
04191 
04192          <span class="comment">//</span>
04193          <span class="comment">// Check the privilege values</span>
04194          <span class="comment">//</span>
04195 
04196          <span class="keywordflow">if</span> ( (PostPrivileges-&gt;Privileges[0].Attributes == 0) &amp;&amp;
04197               (PostPrivileges-&gt;Privileges[1].Attributes == 0)    ) {
04198 
04199             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04200 
04201          } <span class="keywordflow">else</span> {
04202 
04203             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
04204             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04205             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 0 state: 0x%lx,  0x%lx \n"</span>,
04206                     PrePrivileges-&gt;Privileges[0].Attributes,
04207                     PostPrivileges-&gt;Privileges[0].Attributes);
04208             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 1 state: 0x%lx,  0x%lx \n"</span>,
04209                     PrePrivileges-&gt;Privileges[1].Attributes,
04210                     PostPrivileges-&gt;Privileges[1].Attributes);
04211             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04212             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04213 
04214         }
04215 
04216     } <span class="keywordflow">else</span> {
04217 
04218         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04219         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04220         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04221         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04222 
04223     }
04224 
04225     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
04226 
04227 
04228 
04230     <span class="comment">//                                                                  //</span>
04231     <span class="comment">// Enable currently disabled privileges                             //</span>
04232     <span class="comment">//                                                                  //</span>
04234 <span class="comment"></span>
04235     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable currently disabled privileges ...               "</span>);
04236 
04237     PrePrivileges-&gt;PrivilegeCount = 77;
04238     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04239                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04240                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04241                        PrePrivileges,              <span class="comment">// TokenInformation</span>
04242                        PrePrivilegesLength,        <span class="comment">// TokenInformationLength</span>
04243                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04244                        );
04245 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04246 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04247 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04248 <span class="preprocessor"></span>
04249     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04250     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[0].Attributes == 0 );
04251     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[1].Attributes == 0 );
04252     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04253 
04254     NewState-&gt;PrivilegeCount = 2;
04255     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
04256     NewState-&gt;Privileges[1].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
04257     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
04258     NewState-&gt;Privileges[1].Attributes = SE_PRIVILEGE_ENABLED;
04259 
04260     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04261                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04262                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04263                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
04264                  0,                                <span class="comment">// BufferLength</span>
04265                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04266                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04267                  );
04268 
04269     PostPrivileges-&gt;PrivilegeCount = 88;
04270     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04271                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04272                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04273                        PostPrivileges,             <span class="comment">// TokenInformation</span>
04274                        PostPrivilegesLength,       <span class="comment">// TokenInformationLength</span>
04275                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04276                        );
04277 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04278 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04279 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04280 <span class="preprocessor"></span>
04281     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostPrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04282     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04283 
04284     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
04285 
04286          <span class="comment">//</span>
04287          <span class="comment">// Check the privilege values</span>
04288          <span class="comment">//</span>
04289 
04290          <span class="keywordflow">if</span> ( (PostPrivileges-&gt;Privileges[0].Attributes == SE_PRIVILEGE_ENABLED)    &amp;&amp;
04291               (PostPrivileges-&gt;Privileges[1].Attributes == SE_PRIVILEGE_ENABLED)
04292          ) {
04293 
04294             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04295 
04296          } <span class="keywordflow">else</span> {
04297 
04298             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
04299             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04300             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 0 state: 0x%lx,  0x%lx \n"</span>,
04301                     PrePrivileges-&gt;Privileges[0].Attributes,
04302                     PostPrivileges-&gt;Privileges[0].Attributes);
04303             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 1 state: 0x%lx,  0x%lx \n"</span>,
04304                     PrePrivileges-&gt;Privileges[1].Attributes,
04305                     PostPrivileges-&gt;Privileges[1].Attributes);
04306             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04307             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04308 
04309         }
04310 
04311     } <span class="keywordflow">else</span> {
04312 
04313         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04314         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04315         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04316         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04317 
04318     }
04319 
04320     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
04321 
04322 
04323 
04325     <span class="comment">//                                                                  //</span>
04326     <span class="comment">// Disable all enabled privileges                                   //</span>
04327     <span class="comment">//                                                                  //</span>
04329 <span class="comment"></span>
04330     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable all enabled privileges ...                     "</span>);
04331 
04332     PrePrivileges-&gt;PrivilegeCount = 77;
04333     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04334                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04335                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04336                        PrePrivileges,              <span class="comment">// TokenInformation</span>
04337                        PrePrivilegesLength,        <span class="comment">// TokenInformationLength</span>
04338                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04339                        );
04340 
04341     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04342     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[0].Attributes == SE_PRIVILEGE_ENABLED );
04343     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[1].Attributes == SE_PRIVILEGE_ENABLED );
04344     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04345 
04346     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04347                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04348                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                             <span class="comment">// DisableAllPrivileges</span>
04349                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// NewState (OPTIONAL)</span>
04350                  0,                                <span class="comment">// BufferLength</span>
04351                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04352                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04353                  );
04354 
04355 
04356     PostPrivileges-&gt;PrivilegeCount = 88;
04357     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04358                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04359                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04360                        PostPrivileges,             <span class="comment">// TokenInformation</span>
04361                        PostPrivilegesLength,       <span class="comment">// TokenInformationLength</span>
04362                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04363                        );
04364 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04365 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04366 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04367 <span class="preprocessor"></span>
04368     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostPrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04369     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04370 
04371     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
04372 
04373          <span class="comment">//</span>
04374          <span class="comment">// Check the privilege values</span>
04375          <span class="comment">//</span>
04376 
04377          <span class="keywordflow">if</span> ( (PostPrivileges-&gt;Privileges[0].Attributes == 0)    &amp;&amp;
04378               (PostPrivileges-&gt;Privileges[1].Attributes == 0)    ) {
04379 
04380             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04381 
04382          } <span class="keywordflow">else</span> {
04383 
04384             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
04385             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04386             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 0 state: 0x%lx,  0x%lx \n"</span>,
04387                     PrePrivileges-&gt;Privileges[0].Attributes,
04388                     PostPrivileges-&gt;Privileges[0].Attributes);
04389             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 1 state: 0x%lx,  0x%lx \n"</span>,
04390                     PrePrivileges-&gt;Privileges[1].Attributes,
04391                     PostPrivileges-&gt;Privileges[1].Attributes);
04392             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04393             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04394 
04395         }
04396 
04397     } <span class="keywordflow">else</span> {
04398 
04399         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04400         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04401         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04402         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04403 
04404     }
04405 
04406     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
04407 
04408 
04409 
04411     <span class="comment">//                                                                  //</span>
04412     <span class="comment">// Enable privileges requesting previous state with no return       //</span>
04413     <span class="comment">// length buffer                                                    //</span>
04414     <span class="comment">//                                                                  //</span>
04416 <span class="comment"></span>
04417 
04418     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     PreviousState not NULL, ReturnLength NULL...           "</span>);
04419 
04420     NewState-&gt;PrivilegeCount = 2;
04421     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
04422     NewState-&gt;Privileges[1].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
04423     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
04424     NewState-&gt;Privileges[1].Attributes = SE_PRIVILEGE_ENABLED;
04425 
04426     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04427                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04428                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04429                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
04430                  0,                                <span class="comment">// BufferLength</span>
04431                  PreviousState,                    <span class="comment">// PreviousState (OPTIONAL)</span>
04432                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                              <span class="comment">// ReturnLength</span>
04433                  );
04434 
04435     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ACCESS_VIOLATION) {
04436 
04437         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04438 
04439     } <span class="keywordflow">else</span> {
04440 
04441         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04442         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04443         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04444 
04445     }
04446 
04447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ACCESS_VIOLATION);
04448 
04449 
04450 
04451 
04453     <span class="comment">//                                                                  //</span>
04454     <span class="comment">// Enable privileges without requesting previous state and          //</span>
04455     <span class="comment">// providing no return length buffer                                //</span>
04456     <span class="comment">//                                                                  //</span>
04458 <span class="comment"></span>
04459 
04460     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     PreviousState and ReturnLength both NULL...            "</span>);
04461 
04462     NewState-&gt;PrivilegeCount = 2;
04463     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
04464     NewState-&gt;Privileges[1].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
04465     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
04466     NewState-&gt;Privileges[1].Attributes = SE_PRIVILEGE_ENABLED;
04467 
04468     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04469                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04470                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04471                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
04472                  0,                                <span class="comment">// BufferLength</span>
04473                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04474                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                              <span class="comment">// ReturnLength</span>
04475                  );
04476 
04477     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
04478 
04479         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04480 
04481     } <span class="keywordflow">else</span> {
04482 
04483         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04484         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04485         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04486 
04487     }
04488 
04489     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
04490 
04491 
04492 
04493 
04494 
04495 
04497     <span class="comment">//                                                                  //</span>
04498     <span class="comment">// Enable privileges requesting previous state with insufficient    //</span>
04499     <span class="comment">// buffer                                                           //</span>
04500     <span class="comment">//                                                                  //</span>
04502 <span class="comment"></span>
04503 
04504     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Too small buffer for previous state ...                "</span>);
04505 
04506     <span class="comment">//</span>
04507     <span class="comment">// Establish a known previous state first...</span>
04508     <span class="comment">//</span>
04509 
04510     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04511                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04512                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                             <span class="comment">// DisableAllPrivileges</span>
04513                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// NewState (OPTIONAL)</span>
04514                  0,                                <span class="comment">// BufferLength</span>
04515                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04516                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04517                  );
04518 
04519     NewState-&gt;PrivilegeCount = 2;
04520     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
04521     NewState-&gt;Privileges[1].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
04522     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
04523     NewState-&gt;Privileges[1].Attributes = SE_PRIVILEGE_ENABLED;
04524 
04525     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04526                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04527                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04528                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
04529                  0,                                <span class="comment">// BufferLength</span>
04530                  PreviousState,                    <span class="comment">// PreviousState (OPTIONAL)</span>
04531                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04532                  );
04533 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04534 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
04535 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04536 <span class="preprocessor"></span>
04537     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
04538 
04539         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04540 
04541     } <span class="keywordflow">else</span> {
04542 
04543         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04544         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04545         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04546         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04547 
04548     }
04549 
04550     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL);
04551 
04552 
04553 
04554 
04555 
04557     <span class="comment">//                                                                  //</span>
04558     <span class="comment">// Enable one of the privileges requesting previous state           //</span>
04559     <span class="comment">//                                                                  //</span>
04561 <span class="comment"></span>
04562     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable one requesting previous state ...               "</span>);
04563 
04564     PrePrivileges-&gt;PrivilegeCount = 77;
04565     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04566                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04567                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04568                        PrePrivileges,              <span class="comment">// TokenInformation</span>
04569                        PrePrivilegesLength,        <span class="comment">// TokenInformationLength</span>
04570                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04571                        );
04572 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04573 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04574 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04575 <span class="preprocessor"></span>
04576     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04577     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[0].Attributes == 0 );
04578     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[1].Attributes == 0 );
04579     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04580 
04581 
04582     NewState-&gt;PrivilegeCount = 1;
04583     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
04584     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
04585 
04586     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04587                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04588                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04589                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
04590                  PreviousStateBufferLength,        <span class="comment">// BufferLength</span>
04591                  PreviousState,                    <span class="comment">// PreviousState (OPTIONAL)</span>
04592                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04593                  );
04594 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04595 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
04596 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04597 <span class="preprocessor"></span>
04598     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04599     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousState-&gt;PrivilegeCount == 1);
04600 
04601 
04602     PostPrivileges-&gt;PrivilegeCount = 88;
04603     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04604                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04605                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04606                        PostPrivileges,             <span class="comment">// TokenInformation</span>
04607                        PostPrivilegesLength,       <span class="comment">// TokenInformationLength</span>
04608                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04609                        );
04610 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04611 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04612 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04613 <span class="preprocessor"></span>
04614     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostPrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04615     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04616 
04617     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
04618 
04619          <span class="comment">//</span>
04620          <span class="comment">// Check the privilege values</span>
04621          <span class="comment">//</span>
04622 
04623          <span class="keywordflow">if</span> ( (PostPrivileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes ==
04624                SE_PRIVILEGE_ENABLED)    &amp;&amp;
04625               (PostPrivileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes == 0)
04626          ) {
04627 
04628             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04629 
04630          } <span class="keywordflow">else</span> {
04631 
04632             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
04633             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04634             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 0 state: 0x%lx,  0x%lx \n"</span>,
04635                     PrePrivileges-&gt;Privileges[0].Attributes,
04636                     PostPrivileges-&gt;Privileges[0].Attributes);
04637             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 1 state: 0x%lx,  0x%lx \n"</span>,
04638                     PrePrivileges-&gt;Privileges[1].Attributes,
04639                     PostPrivileges-&gt;Privileges[1].Attributes);
04640             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04641             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04642 
04643         }
04644 
04645     } <span class="keywordflow">else</span> {
04646 
04647         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04648         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04649         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04650         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Change Count is: 0x%lx \n"</span>, PreviousState-&gt;PrivilegeCount);
04651         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04652 
04653     }
04654 
04655     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
04656 
04657 
04658 
04659 
04661     <span class="comment">//                                                                  //</span>
04662     <span class="comment">// Enable the other privilege requesting previous state             //</span>
04663     <span class="comment">//                                                                  //</span>
04665 <span class="comment"></span>
04666     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable one requesting previous state ...               "</span>);
04667 
04668     PrePrivileges-&gt;PrivilegeCount = 77;
04669     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04670                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04671                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04672                        PrePrivileges,              <span class="comment">// TokenInformation</span>
04673                        PrePrivilegesLength,        <span class="comment">// TokenInformationLength</span>
04674                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04675                        );
04676 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04677 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04678 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04679 <span class="preprocessor"></span>
04680     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04681     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes ==
04682             SE_PRIVILEGE_ENABLED );
04683     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes == 0 );
04684     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04685 
04686     NewState-&gt;PrivilegeCount = 1;
04687     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
04688     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
04689 
04690     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04691                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04692                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04693                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
04694                  PreviousStateBufferLength,        <span class="comment">// BufferLength</span>
04695                  PreviousState,                    <span class="comment">// PreviousState (OPTIONAL)</span>
04696                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04697                  );
04698 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04699 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
04700 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04701 <span class="preprocessor"></span>
04702     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04703     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousState-&gt;PrivilegeCount == 1);
04704 
04705 
04706     PostPrivileges-&gt;PrivilegeCount = 88;
04707     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04708                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04709                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04710                        PostPrivileges,             <span class="comment">// TokenInformation</span>
04711                        PostPrivilegesLength,       <span class="comment">// TokenInformationLength</span>
04712                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04713                        );
04714 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04715 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04716 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04717 <span class="preprocessor"></span>
04718     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostPrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04719     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04720 
04721     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
04722 
04723          <span class="comment">//</span>
04724          <span class="comment">// Check the privilege values</span>
04725          <span class="comment">//</span>
04726 
04727          <span class="keywordflow">if</span> ( (PostPrivileges-&gt;Privileges[0].Attributes == SE_PRIVILEGE_ENABLED)    &amp;&amp;
04728               (PostPrivileges-&gt;Privileges[1].Attributes == SE_PRIVILEGE_ENABLED)
04729          ) {
04730 
04731             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04732 
04733          } <span class="keywordflow">else</span> {
04734 
04735             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
04736             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04737             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 0 state: 0x%lx,  0x%lx \n"</span>,
04738                     PrePrivileges-&gt;Privileges[0].Attributes,
04739                     PostPrivileges-&gt;Privileges[0].Attributes);
04740             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 1 state: 0x%lx,  0x%lx \n"</span>,
04741                     PrePrivileges-&gt;Privileges[1].Attributes,
04742                     PostPrivileges-&gt;Privileges[1].Attributes);
04743             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04744             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04745 
04746         }
04747 
04748     } <span class="keywordflow">else</span> {
04749 
04750         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04751         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04752         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04753         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Change Count is: 0x%lx \n"</span>, PreviousState-&gt;PrivilegeCount);
04754         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04755 
04756     }
04757 
04758     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
04759 
04760 
04761 
04762 
04763 
04765     <span class="comment">//                                                                  //</span>
04766     <span class="comment">// Return privileges to their previous state                        //</span>
04767     <span class="comment">// Uses PreviousState from previous call                            //</span>
04768     <span class="comment">//                                                                  //</span>
04770 <span class="comment"></span>
04771     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Return privileges to previous state ...                "</span>);
04772 
04773     PrePrivileges-&gt;PrivilegeCount = 77;
04774     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04775                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04776                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04777                        PrePrivileges,              <span class="comment">// TokenInformation</span>
04778                        PrePrivilegesLength,        <span class="comment">// TokenInformationLength</span>
04779                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04780                        );
04781 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04782 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04783 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04784 <span class="preprocessor"></span>
04785     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04786     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[0].Attributes == SE_PRIVILEGE_ENABLED );
04787     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PrePrivileges-&gt;Privileges[1].Attributes == SE_PRIVILEGE_ENABLED );
04788     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04789 
04790     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
04791                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,              <span class="comment">// TokenHandle</span>
04792                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
04793                  PreviousState,                    <span class="comment">// NewState (OPTIONAL)</span>
04794                  0,                                <span class="comment">// BufferLength</span>
04795                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04796                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04797                  );
04798 
04799     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04800     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousState-&gt;PrivilegeCount == 1);
04801 
04802 
04803     PostPrivileges-&gt;PrivilegeCount = 88;
04804     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04805                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>,        <span class="comment">// TokenHandle</span>
04806                        TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
04807                        PostPrivileges,             <span class="comment">// TokenInformation</span>
04808                        PostPrivilegesLength,       <span class="comment">// TokenInformationLength</span>
04809                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
04810                        );
04811 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04812 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04813 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04814 <span class="preprocessor"></span>
04815     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostPrivileges-&gt;PrivilegeCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a> );
04816     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04817 
04818     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
04819 
04820          <span class="comment">//</span>
04821          <span class="comment">// Check the privilege values</span>
04822          <span class="comment">//</span>
04823 
04824          <span class="keywordflow">if</span> ( (PostPrivileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes ==
04825               SE_PRIVILEGE_ENABLED)    &amp;&amp;
04826               (PostPrivileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes == 0)
04827          ) {
04828 
04829             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04830 
04831          } <span class="keywordflow">else</span> {
04832 
04833             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
04834             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04835             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 0 state: 0x%lx,  0x%lx \n"</span>,
04836                     PrePrivileges-&gt;Privileges[0].Attributes,
04837                     PostPrivileges-&gt;Privileges[0].Attributes);
04838             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before and after privilege 1 state: 0x%lx,  0x%lx \n"</span>,
04839                     PrePrivileges-&gt;Privileges[1].Attributes,
04840                     PostPrivileges-&gt;Privileges[1].Attributes);
04841             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04842             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04843 
04844         }
04845 
04846     } <span class="keywordflow">else</span> {
04847 
04848         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04849         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04850         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04851         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04852 
04853     }
04854 
04855 
04856     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
04857 
04858 
04859 
04860 
04862     <span class="comment">//                                                            //</span>
04863     <span class="comment">// Done with test                                             //</span>
04864     <span class="comment">//                                                            //</span>
04866 <span class="comment"></span>
04867 
04868 
04869     TstDeallocatePool( PreviousState, PreviousStateBufferLength );
04870     TstDeallocatePool( NewState, NewStateBufferLength );
04871     TstDeallocatePool( PrePrivileges, PrePrivilegesLength );
04872     TstDeallocatePool( PostPrivileges, PostPrivilegesLength );
04873 
04874 
04875     <span class="keywordflow">return</span> CompletionStatus;
04876 }
04877 
04879 <span class="comment">//                                                            //</span>
04880 <span class="comment">// Adjust Groups Test                                         //</span>
04881 <span class="comment">//                                                            //</span>
04883 <span class="comment"></span>
04884 BOOLEAN
<a name="l04885"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a72">04885</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a72">TestTokenAdjustGroups</a>()
04886 {
04887     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04888     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04889     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> IgnoreStatus;
04890 
04891     PTOKEN_GROUPS NewState;
04892     PTOKEN_GROUPS PreviousState;
04893     PTOKEN_GROUPS PreGroups;
04894     PTOKEN_GROUPS PostGroups;
04895 
04896     ULONG NewStateBufferLength = 600;
04897     ULONG PreviousStateBufferLength = 600;
04898     ULONG PreGroupsLength = 600;
04899     ULONG PostGroupsLength = 600;
04900 
04901     ULONG ReturnLength;
04902     ULONG IgnoreReturnLength;
04903 
04904     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
04905 
04906     PreviousState = (PTOKEN_GROUPS)TstAllocatePool(
04907                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04908                         PreviousStateBufferLength
04909                         );
04910 
04911     PreGroups = (PTOKEN_GROUPS)TstAllocatePool(
04912                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04913                         PreGroupsLength
04914                         );
04915 
04916     PostGroups = (PTOKEN_GROUPS)TstAllocatePool(
04917                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04918                         PostGroupsLength
04919                         );
04920 
04921     NewState = (PTOKEN_GROUPS)TstAllocatePool(
04922                    <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04923                    NewStateBufferLength
04924                    );
04925 
04926 
04927 
04928 
04929 
04931     <span class="comment">//                                                                  //</span>
04932     <span class="comment">// Adjust groups giving no instructions                             //</span>
04933     <span class="comment">//                                                                  //</span>
04935 <span class="comment"></span>
04936 
04937     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Adjust groups with no instructions ...                 "</span>);
04938 
04939     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
04940                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,                      <span class="comment">// TokenHandle</span>
04941                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// ResetToDefault</span>
04942                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// NewState (OPTIONAL)</span>
04943                  0,                                <span class="comment">// BufferLength</span>
04944                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
04945                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
04946                  );
04947 
04948     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_PARAMETER) {
04949 
04950         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
04951 
04952     } <span class="keywordflow">else</span> {
04953 
04954         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
04955         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04956         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
04957         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04958 
04959     }
04960 
04961     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_PARAMETER);
04962 
04963 
04965 <span class="comment">//                                                                     //</span>
04966 <span class="comment">//  Disable unknown group                                              //</span>
04967 <span class="comment">//                                                                     //</span>
04969 <span class="comment"></span>
04970     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable unknown group ...                              "</span>);
04971 
04972     PreGroups-&gt;GroupCount = 77;
04973     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
04974                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
04975                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
04976                        PreGroups,              <span class="comment">// TokenInformation</span>
04977                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
04978                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
04979                        );
04980 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
04981 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
04982 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
04983 <span class="preprocessor"></span>
04984     <span class="keywordflow">if</span> (IgnoreStatus != STATUS_SUCCESS) {
04985         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" \n IgnoreStatus = 0x%lx \n"</span>, IgnoreStatus);
04986         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" \n IgnoreReturnLength = 0x%lx \n"</span>, IgnoreReturnLength);
04987     }
04988 
04989     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
04990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
04991     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
04992     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
04993     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
04994     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04995 
04996     NewState-&gt;GroupCount = 1;
04997     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a26">RubbleSid</a>;
04998     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
04999 
05000     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05001                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05002                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05003                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05004                  0,                            <span class="comment">// BufferLength</span>
05005                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05006                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05007                  );
05008 
05009     PostGroups-&gt;GroupCount = 88;
05010     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05011                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05012                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05013                        PostGroups,             <span class="comment">// TokenInformation</span>
05014                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05015                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
05016                        );
05017 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05018 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05019 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05020 <span class="preprocessor"></span>
05021     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05022 
05023     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED) {
05024 
05025          <span class="comment">//</span>
05026          <span class="comment">// Check the group values</span>
05027          <span class="comment">//</span>
05028 
05029          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05030          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05031               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05032               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05033               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05034          ) {
05035 
05036             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05037 
05038          } <span class="keywordflow">else</span> {
05039 
05040             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05041             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05042 
05043             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05044                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05045                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05046 
05047             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05048                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05049                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05050 
05051             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05052                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05053                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05054 
05055             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05056                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05057                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05058 
05059             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05060 
05061             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05062 
05063         }
05064 
05065     } <span class="keywordflow">else</span> {
05066 
05067         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05068         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05069         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05070         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05071 
05072     }
05073 
05074     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED);
05075 
05076 
05077 
05079 <span class="comment">//                                                                     //</span>
05080 <span class="comment">//  Enable unknown group                                               //</span>
05081 <span class="comment">//                                                                     //</span>
05083 <span class="comment"></span>
05084     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable unknown group ...                               "</span>);
05085 
05086     PreGroups-&gt;GroupCount = 77;
05087     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05088                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05089                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05090                        PreGroups,              <span class="comment">// TokenInformation</span>
05091                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05092                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05093                        );
05094 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05095 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05096 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05097 <span class="preprocessor"></span>
05098     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05099     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05100     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05101     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05102     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05103     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05104 
05105     NewState-&gt;GroupCount = 1;
05106     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a26">RubbleSid</a>;
05107     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
05108 
05109     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05110                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05111                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05112                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05113                  0,                            <span class="comment">// BufferLength</span>
05114                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05115                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05116                  );
05117 
05118     PostGroups-&gt;GroupCount = 88;
05119     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05120                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05121                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05122                        PostGroups,             <span class="comment">// TokenInformation</span>
05123                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05124                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
05125                        );
05126 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05127 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05128 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05129 <span class="preprocessor"></span>
05130     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05131 
05132     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED) {
05133 
05134          <span class="comment">//</span>
05135          <span class="comment">// Check the group values</span>
05136          <span class="comment">//</span>
05137 
05138          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05139          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05140               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05141               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05142               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05143          ) {
05144 
05145             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05146 
05147          } <span class="keywordflow">else</span> {
05148 
05149             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05150             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05151 
05152             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05153                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05154                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05155 
05156             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05157                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05158                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05159 
05160             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05161                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05162                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05163 
05164             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05165                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05166                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05167 
05168             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05169 
05170             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05171 
05172         }
05173 
05174     } <span class="keywordflow">else</span> {
05175 
05176         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05177         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05178         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05179         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05180 
05181     }
05182 
05183     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED);
05184 
05185 
05186 
05188 <span class="comment">//                                                                     //</span>
05189 <span class="comment">//  Disable mandatory group                                            //</span>
05190 <span class="comment">//                                                                     //</span>
05192 <span class="comment"></span>
05193     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable mandatory group ...                            "</span>);
05194 
05195     PreGroups-&gt;GroupCount = 77;
05196     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05197                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05198                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05199                        PreGroups,              <span class="comment">// TokenInformation</span>
05200                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05201                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05202                        );
05203 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05204 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05205 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05206 <span class="preprocessor"></span>
05207     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05208     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05209     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05210     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05211     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05212     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05213 
05214     NewState-&gt;GroupCount = 1;
05215     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
05216     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
05217 
05218     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05219                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05220                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05221                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05222                  0,                            <span class="comment">// BufferLength</span>
05223                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05224                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05225                  );
05226 
05227     PostGroups-&gt;GroupCount = 88;
05228     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05229                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05230                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05231                        PostGroups,             <span class="comment">// TokenInformation</span>
05232                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05233                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
05234                        );
05235 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05236 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05237 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05238 <span class="preprocessor"></span>
05239     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05240 
05241     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_DISABLE_MANDATORY) {
05242 
05243          <span class="comment">//</span>
05244          <span class="comment">// Check the group values</span>
05245          <span class="comment">//</span>
05246 
05247          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05248          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05249               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05250               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05251               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05252          ) {
05253 
05254             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05255 
05256          } <span class="keywordflow">else</span> {
05257 
05258             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05259             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05260 
05261             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05262                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05263                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05264 
05265             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05266                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05267                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05268 
05269             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05270                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05271                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05272 
05273             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05274                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05275                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05276 
05277             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05278 
05279             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05280 
05281         }
05282 
05283     } <span class="keywordflow">else</span> {
05284 
05285         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05286         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05287         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05288         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05289 
05290     }
05291 
05292     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_DISABLE_MANDATORY);
05293 
05294 
05295 
05296 
05298 <span class="comment">//                                                                     //</span>
05299 <span class="comment">//  Enable mandatory group                                             //</span>
05300 <span class="comment">//                                                                     //</span>
05302 <span class="comment"></span>
05303     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable mandatory group ...                             "</span>);
05304 
05305     PreGroups-&gt;GroupCount = 77;
05306     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05307                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05308                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05309                        PreGroups,              <span class="comment">// TokenInformation</span>
05310                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05311                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05312                        );
05313 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05314 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05315 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05316 <span class="preprocessor"></span>
05317     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05318     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05319     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05320     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05321     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05322     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05323 
05324     NewState-&gt;GroupCount = 1;
05325     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
05326     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
05327 
05328     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05329                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05330                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05331                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05332                  0,                            <span class="comment">// BufferLength</span>
05333                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05334                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05335                  );
05336 
05337     PostGroups-&gt;GroupCount = 88;
05338     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05339                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05340                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05341                        PostGroups,             <span class="comment">// TokenInformation</span>
05342                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05343                        &amp;IgnoreReturnLength         <span class="comment">// ReturnLength</span>
05344                        );
05345 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05346 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05347 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05348 <span class="preprocessor"></span>
05349     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05350 
05351     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
05352 
05353          <span class="comment">//</span>
05354          <span class="comment">// Check the group values</span>
05355          <span class="comment">//</span>
05356 
05357          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05358          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05359               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05360               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05361               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05362          ) {
05363 
05364             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05365 
05366          } <span class="keywordflow">else</span> {
05367 
05368             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05369             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05370 
05371             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05372                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05373                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05374 
05375             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05376                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05377                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05378 
05379             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05380                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05381                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05382 
05383             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05384                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05385                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05386 
05387             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05388 
05389             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05390 
05391         }
05392 
05393     } <span class="keywordflow">else</span> {
05394 
05395         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05396         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05397         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05398         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05399 
05400     }
05401 
05402     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
05403 
05404 
05405 
05407 <span class="comment">//                                                                     //</span>
05408 <span class="comment">//  Disable optional group                                             //</span>
05409 <span class="comment">//                                                                     //</span>
05411 <span class="comment"></span>
05412     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable optional group ...                             "</span>);
05413 
05414     PreGroups-&gt;GroupCount = 77;
05415     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05416                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05417                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05418                        PreGroups,              <span class="comment">// TokenInformation</span>
05419                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05420                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05421                        );
05422 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05423 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05424 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05425 <span class="preprocessor"></span>
05426     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05427     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05428     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05429     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05430     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05431     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05432 
05433     NewState-&gt;GroupCount = 1;
05434     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
05435     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
05436 
05437     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05438                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05439                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05440                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05441                  0,                            <span class="comment">// BufferLength</span>
05442                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05443                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05444                  );
05445 
05446     PostGroups-&gt;GroupCount = 88;
05447     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05448                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05449                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05450                        PostGroups,             <span class="comment">// TokenInformation</span>
05451                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05452                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05453                        );
05454 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05455 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05456 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05457 <span class="preprocessor"></span>
05458     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05459 
05460     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
05461 
05462          <span class="comment">//</span>
05463          <span class="comment">// Check the group values</span>
05464          <span class="comment">//</span>
05465 
05466          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05467          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05468               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
05469               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05470               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05471          ) {
05472 
05473             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05474 
05475          } <span class="keywordflow">else</span> {
05476 
05477             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05478             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05479 
05480             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05481                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05482                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05483 
05484             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05485                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05486                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05487 
05488             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05489                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05490                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05491 
05492             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05493                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05494                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05495 
05496             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05497 
05498             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05499 
05500         }
05501 
05502     } <span class="keywordflow">else</span> {
05503 
05504         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05505         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05506         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05507         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05508 
05509     }
05510 
05511     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
05512 
05513 
05514 
05516 <span class="comment">//                                                                     //</span>
05517 <span class="comment">//  Disable already disabled group                                     //</span>
05518 <span class="comment">//                                                                     //</span>
05520 <span class="comment"></span>
05521     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable already disabled group ...                     "</span>);
05522 
05523     PreGroups-&gt;GroupCount = 77;
05524     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05525                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05526                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05527                        PreGroups,              <span class="comment">// TokenInformation</span>
05528                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05529                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05530                        );
05531 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05532 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05533 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05534 <span class="preprocessor"></span>
05535     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05536     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05537     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
05538     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05539     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05540     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05541 
05542     NewState-&gt;GroupCount = 1;
05543     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
05544     NewState-&gt;Groups[0].Attributes = 0;
05545 
05546     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05547                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05548                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05549                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05550                  0,                            <span class="comment">// BufferLength</span>
05551                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05552                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05553                  );
05554 
05555     PostGroups-&gt;GroupCount = 88;
05556     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05557                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05558                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05559                        PostGroups,             <span class="comment">// TokenInformation</span>
05560                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05561                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05562                        );
05563 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05564 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05565 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05566 <span class="preprocessor"></span>
05567     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05568 
05569     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
05570 
05571          <span class="comment">//</span>
05572          <span class="comment">// Check the group values</span>
05573          <span class="comment">//</span>
05574 
05575          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05576          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05577               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
05578               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05579               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05580          ) {
05581 
05582             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05583 
05584          } <span class="keywordflow">else</span> {
05585 
05586             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05587             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05588 
05589             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05590                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05591                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05592 
05593             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05594                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05595                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05596 
05597             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05598                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05599                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05600 
05601             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05602                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05603                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05604 
05605             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05606 
05607             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05608 
05609         }
05610 
05611     } <span class="keywordflow">else</span> {
05612 
05613         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05614         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05615         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05616         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05617 
05618     }
05619 
05620     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
05621 
05622 
05623 
05625 <span class="comment">//                                                                     //</span>
05626 <span class="comment">//  Enable optional group                                              //</span>
05627 <span class="comment">//                                                                     //</span>
05629 <span class="comment"></span>
05630     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable optional group ...                              "</span>);
05631 
05632     PreGroups-&gt;GroupCount = 77;
05633     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05634                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05635                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05636                        PreGroups,              <span class="comment">// TokenInformation</span>
05637                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05638                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05639                        );
05640 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05641 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05642 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05643 <span class="preprocessor"></span>
05644     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05645     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05646     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
05647     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05648     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05649     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05650 
05651     NewState-&gt;GroupCount = 1;
05652     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
05653     NewState-&gt;Groups[0].Attributes = SE_GROUP_ENABLED;
05654 
05655     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05656                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05657                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05658                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05659                  0,                            <span class="comment">// BufferLength</span>
05660                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05661                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05662                  );
05663 
05664     PostGroups-&gt;GroupCount = 88;
05665     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05666                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05667                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05668                        PostGroups,             <span class="comment">// TokenInformation</span>
05669                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05670                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05671                        );
05672 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05673 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05674 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05675 <span class="preprocessor"></span>
05676     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05677 
05678     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
05679 
05680          <span class="comment">//</span>
05681          <span class="comment">// Check the group values</span>
05682          <span class="comment">//</span>
05683 
05684          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05685          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05686               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05687               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05688               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05689          ) {
05690 
05691             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05692 
05693          } <span class="keywordflow">else</span> {
05694 
05695             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05696             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05697 
05698             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05699                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05700                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05701 
05702             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05703                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05704                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05705 
05706             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05707                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05708                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05709 
05710             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05711                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05712                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05713 
05714             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05715 
05716             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05717 
05718         }
05719 
05720     } <span class="keywordflow">else</span> {
05721 
05722         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05723         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05724         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05725         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05726 
05727     }
05728 
05729     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
05730 
05731 
05732 
05734 <span class="comment">//                                                                     //</span>
05735 <span class="comment">//  Enable already enabled group                                       //</span>
05736 <span class="comment">//                                                                     //</span>
05738 <span class="comment"></span>
05739     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable already enabled group ...                       "</span>);
05740 
05741     PreGroups-&gt;GroupCount = 77;
05742     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05743                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05744                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05745                        PreGroups,              <span class="comment">// TokenInformation</span>
05746                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05747                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05748                        );
05749 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05750 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05751 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05752 <span class="preprocessor"></span>
05753     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05754     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05755     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05756     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05757     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05758     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05759 
05760     NewState-&gt;GroupCount = 1;
05761     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
05762     NewState-&gt;Groups[0].Attributes = SE_GROUP_ENABLED;
05763 
05764     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05765                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05766                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05767                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05768                  0,                            <span class="comment">// BufferLength</span>
05769                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05770                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05771                  );
05772 
05773     PostGroups-&gt;GroupCount = 88;
05774     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05775                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05776                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05777                        PostGroups,             <span class="comment">// TokenInformation</span>
05778                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05779                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05780                        );
05781 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05782 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05783 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05784 <span class="preprocessor"></span>
05785     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05786 
05787     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
05788 
05789          <span class="comment">//</span>
05790          <span class="comment">// Check the group values</span>
05791          <span class="comment">//</span>
05792 
05793          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05794          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05795               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05796               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05797               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05798          ) {
05799 
05800             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05801 
05802          } <span class="keywordflow">else</span> {
05803 
05804             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05805             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05806 
05807             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05808                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05809                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05810 
05811             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05812                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05813                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05814 
05815             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05816                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05817                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05818 
05819             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05820                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05821                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05822 
05823             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05824 
05825             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05826 
05827         }
05828 
05829     } <span class="keywordflow">else</span> {
05830 
05831         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05832         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05833         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05834         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05835 
05836     }
05837 
05838     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
05839 
05840 
05841 
05843 <span class="comment">//                                                                     //</span>
05844 <span class="comment">//  Disable optional and unknown group                                 //</span>
05845 <span class="comment">//                                                                     //</span>
05847 <span class="comment"></span>
05848     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable optional and unknown group ...                 "</span>);
05849 
05850     PreGroups-&gt;GroupCount = 77;
05851     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05852                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05853                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05854                        PreGroups,              <span class="comment">// TokenInformation</span>
05855                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05856                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05857                        );
05858 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05859 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05860 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05861 <span class="preprocessor"></span>
05862     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05863     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05864     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05865     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05866     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05867     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05868 
05869     NewState-&gt;GroupCount = 2;
05870     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
05871     NewState-&gt;Groups[1].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a26">RubbleSid</a>;
05872     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
05873     NewState-&gt;Groups[1].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
05874 
05875     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05876                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05877                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05878                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05879                  0,                            <span class="comment">// BufferLength</span>
05880                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05881                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05882                  );
05883 
05884     PostGroups-&gt;GroupCount = 88;
05885     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05886                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05887                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05888                        PostGroups,             <span class="comment">// TokenInformation</span>
05889                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
05890                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05891                        );
05892 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05893 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05894 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05895 <span class="preprocessor"></span>
05896     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05897 
05898     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED) {
05899 
05900          <span class="comment">//</span>
05901          <span class="comment">// Check the group values</span>
05902          <span class="comment">//</span>
05903 
05904          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05905          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
05906               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
05907               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
05908               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
05909          ) {
05910 
05911             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
05912 
05913          } <span class="keywordflow">else</span> {
05914 
05915             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
05916             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05917 
05918             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
05919                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
05920                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
05921 
05922             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
05923                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
05924                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
05925 
05926             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
05927                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
05928                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
05929 
05930             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
05931                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
05932                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
05933 
05934             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05935 
05936             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05937 
05938         }
05939 
05940     } <span class="keywordflow">else</span> {
05941 
05942         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
05943         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05944         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
05945         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05946 
05947     }
05948 
05949     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED);
05950 
05951 
05952 
05953 
05955 <span class="comment">//                                                                     //</span>
05956 <span class="comment">//  Enable optional and unknown group                                  //</span>
05957 <span class="comment">//                                                                     //</span>
05959 <span class="comment"></span>
05960     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable optional and unknown group ...                  "</span>);
05961 
05962     PreGroups-&gt;GroupCount = 77;
05963     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05964                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05965                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
05966                        PreGroups,              <span class="comment">// TokenInformation</span>
05967                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
05968                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
05969                        );
05970 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
05971 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
05972 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
05973 <span class="preprocessor"></span>
05974     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
05975     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
05976     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
05977     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
05978     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
05979     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05980 
05981     NewState-&gt;GroupCount = 2;
05982     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
05983     NewState-&gt;Groups[1].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a26">RubbleSid</a>;
05984     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
05985     NewState-&gt;Groups[1].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
05986 
05987     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
05988                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
05989                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
05990                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
05991                  0,                            <span class="comment">// BufferLength</span>
05992                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
05993                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
05994                  );
05995 
05996     PostGroups-&gt;GroupCount = 88;
05997     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
05998                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
05999                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06000                        PostGroups,             <span class="comment">// TokenInformation</span>
06001                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06002                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06003                        );
06004 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06005 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06006 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06007 <span class="preprocessor"></span>
06008     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06009 
06010     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED) {
06011 
06012          <span class="comment">//</span>
06013          <span class="comment">// Check the group values</span>
06014          <span class="comment">//</span>
06015 
06016          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06017          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06018               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06019               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06020               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
06021          ) {
06022 
06023             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06024 
06025          } <span class="keywordflow">else</span> {
06026 
06027             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06028             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06029 
06030             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06031                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06032                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06033 
06034             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06035                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06036                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06037 
06038             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06039                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06040                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06041 
06042             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06043                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06044                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06045 
06046             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06047 
06048             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06049 
06050         }
06051 
06052     } <span class="keywordflow">else</span> {
06053 
06054         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06055         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06056         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06057         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06058 
06059     }
06060 
06061     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED);
06062 
06063 
06064 
06065 
06067 <span class="comment">//                                                                     //</span>
06068 <span class="comment">//  Disable optional and mandatory group                               //</span>
06069 <span class="comment">//                                                                     //</span>
06071 <span class="comment"></span>
06072     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable optional and mandatory group ...               "</span>);
06073 
06074     PreGroups-&gt;GroupCount = 77;
06075     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06076                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06077                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06078                        PreGroups,              <span class="comment">// TokenInformation</span>
06079                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
06080                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06081                        );
06082 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06083 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06084 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06085 <span class="preprocessor"></span>
06086     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06087     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
06088     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06089     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06090     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
06091     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06092 
06093     NewState-&gt;GroupCount = 2;
06094     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
06095     NewState-&gt;Groups[1].Sid = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
06096     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
06097     NewState-&gt;Groups[1].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
06098 
06099     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06100                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06101                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
06102                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
06103                  0,                            <span class="comment">// BufferLength</span>
06104                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
06105                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06106                  );
06107 
06108     PostGroups-&gt;GroupCount = 88;
06109     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06110                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06111                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06112                        PostGroups,             <span class="comment">// TokenInformation</span>
06113                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06114                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06115                        );
06116 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06117 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06118 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06119 <span class="preprocessor"></span>
06120     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06121 
06122     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_DISABLE_MANDATORY) {
06123 
06124          <span class="comment">//</span>
06125          <span class="comment">// Check the group values</span>
06126          <span class="comment">//</span>
06127 
06128          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06129          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06130               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06131               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06132               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
06133          ) {
06134 
06135             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06136 
06137          } <span class="keywordflow">else</span> {
06138 
06139             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06140             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06141 
06142             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06143                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06144                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06145 
06146             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06147                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06148                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06149 
06150             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06151                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06152                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06153 
06154             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06155                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06156                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06157 
06158             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06159 
06160             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06161 
06162         }
06163 
06164     } <span class="keywordflow">else</span> {
06165 
06166         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06167         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06168         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06169         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06170 
06171     }
06172 
06173     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_DISABLE_MANDATORY);
06174 
06175 
06176 
06178 <span class="comment">//                                                                     //</span>
06179 <span class="comment">//  Enable optional and mandatory group                                //</span>
06180 <span class="comment">//                                                                     //</span>
06182 <span class="comment"></span>
06183     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Enable optional and mandatory group ...                "</span>);
06184 
06185     NewState-&gt;GroupCount = 1;
06186     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
06187     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
06188 
06189     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06190                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06191                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
06192                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
06193                  0,                            <span class="comment">// BufferLength</span>
06194                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
06195                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06196                  );
06197     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
06198 
06199     PreGroups-&gt;GroupCount = 77;
06200     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06201                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06202                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06203                        PreGroups,              <span class="comment">// TokenInformation</span>
06204                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
06205                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06206                        );
06207 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06208 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06209 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06210 <span class="preprocessor"></span>
06211     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06212     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
06213     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
06214     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
06216     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06217 
06218     NewState-&gt;GroupCount = 2;
06219     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
06220     NewState-&gt;Groups[1].Sid = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
06221     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
06222     NewState-&gt;Groups[1].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
06223 
06224     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06225                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06226                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
06227                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
06228                  0,                            <span class="comment">// BufferLength</span>
06229                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
06230                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06231                  );
06232 
06233     PostGroups-&gt;GroupCount = 88;
06234     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06235                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06236                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06237                        PostGroups,             <span class="comment">// TokenInformation</span>
06238                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06239                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06240                        );
06241 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06242 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06243 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06244 <span class="preprocessor"></span>
06245     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06246 
06247     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
06248 
06249          <span class="comment">//</span>
06250          <span class="comment">// Check the group values</span>
06251          <span class="comment">//</span>
06252 
06253          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06254          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06255               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06256               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06257               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
06258          ) {
06259 
06260             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06261 
06262          } <span class="keywordflow">else</span> {
06263 
06264             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06265             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06266 
06267             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06268                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06269                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06270 
06271             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06272                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06273                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06274 
06275             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06276                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06277                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06278 
06279             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06280                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06281                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06282 
06283             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06284 
06285             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06286 
06287         }
06288 
06289     } <span class="keywordflow">else</span> {
06290 
06291         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06292         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06293         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06294         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06295 
06296     }
06297 
06298     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
06299 
06300 
06301 
06303 <span class="comment">//                                                                  //</span>
06304 <span class="comment">// Disable optional group requesting previous state with            //</span>
06305 <span class="comment">// insufficient buffer                                              //</span>
06306 <span class="comment">//                                                                  //</span>
06308 <span class="comment"></span>
06309 
06310     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Too small buffer for previous state ...                "</span>);
06311 
06312 
06313     PreGroups-&gt;GroupCount = 77;
06314     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06315                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06316                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06317                        PreGroups,              <span class="comment">// TokenInformation</span>
06318                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
06319                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06320                        );
06321 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06322 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06323 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06324 <span class="preprocessor"></span>
06325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
06327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06328     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06329     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
06330     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06331 
06332     NewState-&gt;GroupCount = 1;
06333     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
06334     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
06335 
06336     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06337                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06338                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
06339                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
06340                  0,                            <span class="comment">// BufferLength</span>
06341                  PreviousState,                <span class="comment">// PreviousState (OPTIONAL)</span>
06342                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06343                  );
06344 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06345 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
06346 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06347 <span class="preprocessor"></span>
06348     PostGroups-&gt;GroupCount = 88;
06349     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06350                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06351                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06352                        PostGroups,             <span class="comment">// TokenInformation</span>
06353                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06354                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06355                        );
06356 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06357 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06358 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06359 <span class="preprocessor"></span>
06360     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06361 
06362     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
06363 
06364          <span class="comment">//</span>
06365          <span class="comment">// Check the group values</span>
06366          <span class="comment">//</span>
06367 
06368          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06369          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06370               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06371               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06372               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
06373          ) {
06374 
06375             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06376 
06377          } <span class="keywordflow">else</span> {
06378 
06379             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06380             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06381 
06382             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06383                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06384                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06385 
06386             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06387                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06388                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06389 
06390             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06391                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06392                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06393 
06394             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06395                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06396                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06397 
06398             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06399 
06400             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06401 
06402         }
06403 
06404     } <span class="keywordflow">else</span> {
06405 
06406         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06407         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06408         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06409         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06410 
06411     }
06412 
06413     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL);
06414 
06415 
06416 
06417 
06419 <span class="comment">//                                                                     //</span>
06420 <span class="comment">//  Disable optional requesting previous state                         //</span>
06421 <span class="comment">//                                                                     //</span>
06423 <span class="comment"></span>
06424     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Disable optional, requesting previous state ...        "</span>);
06425 
06426     PreGroups-&gt;GroupCount = 77;
06427     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06428                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06429                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06430                        PreGroups,              <span class="comment">// TokenInformation</span>
06431                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
06432                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06433                        );
06434 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06435 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06436 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06437 <span class="preprocessor"></span>
06438     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06439     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
06440     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06441     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06442     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
06443     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06444 
06445     NewState-&gt;GroupCount = 2;
06446     NewState-&gt;Groups[0].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
06447     NewState-&gt;Groups[1].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
06448     NewState-&gt;Groups[0].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
06449     NewState-&gt;Groups[1].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
06450     PreviousState-&gt;GroupCount = 99;
06451 
06452     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06453                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06454                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
06455                  NewState,                     <span class="comment">// NewState (OPTIONAL)</span>
06456                  PreviousStateBufferLength,    <span class="comment">// BufferLength</span>
06457                  PreviousState,                <span class="comment">// PreviousState (OPTIONAL)</span>
06458                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06459                  );
06460 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06461 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
06462 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06463 <span class="preprocessor"></span>
06464     PostGroups-&gt;GroupCount = 88;
06465     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06466                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06467                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06468                        PostGroups,             <span class="comment">// TokenInformation</span>
06469                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06470                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06471                        );
06472 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06473 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06474 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06475 <span class="preprocessor"></span>
06476     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06477 
06478     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
06479 
06480          <span class="comment">//</span>
06481          <span class="comment">// Check the group values</span>
06482          <span class="comment">//</span>
06483 
06484          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06485          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PreviousState-&gt;GroupCount == 2 );
06486          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06487               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
06488               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
06489               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)   &amp;&amp;
06490               (PreviousState-&gt;Groups[0].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06491               (PreviousState-&gt;Groups[1].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>)
06492          ) {
06493 
06494             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06495 
06496          } <span class="keywordflow">else</span> {
06497 
06498             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06499             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06500 
06501             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06502                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06503                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06504 
06505             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06506                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06507                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06508 
06509             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06510                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06511                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06512 
06513             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06514                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06515                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06516 
06517             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06518 
06519             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Previous count is: 0x%lx \n"</span>, PreviousState-&gt;GroupCount);
06520             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Previous state of group 0 is: 0x%lx \n"</span>,
06521                     PreviousState-&gt;Groups[0].Attributes);
06522             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Previous state of group 1 is: 0x%lx \n"</span>,
06523                     PreviousState-&gt;Groups[1].Attributes);
06524 
06525 
06526             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06527 
06528         }
06529 
06530     } <span class="keywordflow">else</span> {
06531 
06532         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06533         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06534         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06535         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06536 
06537     }
06538 
06539     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
06540 
06541 
06542 
06544 <span class="comment">//                                                                     //</span>
06545 <span class="comment">//  Return group to previous state                                     //</span>
06546 <span class="comment">//                                                                     //</span>
06548 <span class="comment"></span>
06549     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Return to previous state ...                           "</span>);
06550 
06551     PreGroups-&gt;GroupCount = 77;
06552     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06553                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06554                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06555                        PreGroups,              <span class="comment">// TokenInformation</span>
06556                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
06557                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06558                        );
06559 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06560 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06561 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06562 <span class="preprocessor"></span>
06563     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06564     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
06565     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
06566     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
06567     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
06568     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06569 
06570     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06571                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06572                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
06573                  PreviousState,                <span class="comment">// NewState (OPTIONAL)</span>
06574                  PreviousStateBufferLength,    <span class="comment">// BufferLength</span>
06575                  PreviousState,                <span class="comment">// PreviousState (OPTIONAL)</span>
06576                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06577                  );
06578 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06579 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
06580 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06581 <span class="preprocessor"></span>
06582     PostGroups-&gt;GroupCount = 88;
06583     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06584                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06585                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06586                        PostGroups,             <span class="comment">// TokenInformation</span>
06587                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06588                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06589                        );
06590 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06591 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06592 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06593 <span class="preprocessor"></span>
06594     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06595 
06596     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
06597 
06598          <span class="comment">//</span>
06599          <span class="comment">// Check the group values</span>
06600          <span class="comment">//</span>
06601 
06602          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06603          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06604               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06605               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06606               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)   &amp;&amp;
06607               (PreviousState-&gt;Groups[0].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
06608               (PreviousState-&gt;Groups[1].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>)
06609          ) {
06610 
06611             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06612 
06613          } <span class="keywordflow">else</span> {
06614 
06615             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06616             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06617 
06618             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06619                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06620                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06621 
06622             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06623                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06624                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06625 
06626             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06627                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06628                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06629 
06630             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06631                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06632                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06633 
06634             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06635 
06636             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06637 
06638         }
06639 
06640     } <span class="keywordflow">else</span> {
06641 
06642         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06643         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06644         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06645         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06646 
06647     }
06648 
06649     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
06650 
06651 
06652 
06654 <span class="comment">//                                                                     //</span>
06655 <span class="comment">//  Return to previous state again                                     //</span>
06656 <span class="comment">//                                                                     //</span>
06658 <span class="comment"></span>
06659     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Return to previous state again ...                     "</span>);
06660 
06661     PreGroups-&gt;GroupCount = 77;
06662     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06663                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06664                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06665                        PreGroups,              <span class="comment">// TokenInformation</span>
06666                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
06667                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06668                        );
06669 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06670 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06671 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06672 <span class="preprocessor"></span>
06673     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06674     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
06675     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06676     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>);
06677     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
06678     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06679 
06680     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06681                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06682                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
06683                  PreviousState,                <span class="comment">// NewState (OPTIONAL)</span>
06684                  PreviousStateBufferLength,    <span class="comment">// BufferLength</span>
06685                  PreviousState,                <span class="comment">// PreviousState (OPTIONAL)</span>
06686                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06687                  );
06688 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06689 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
06690 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06691 <span class="preprocessor"></span>
06692     PostGroups-&gt;GroupCount = 88;
06693     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06694                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06695                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06696                        PostGroups,             <span class="comment">// TokenInformation</span>
06697                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06698                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06699                        );
06700 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06701 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06702 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06703 <span class="preprocessor"></span>
06704     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06705 
06706     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
06707 
06708          <span class="comment">//</span>
06709          <span class="comment">// Check the group values</span>
06710          <span class="comment">//</span>
06711 
06712          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06713          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06714               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
06715               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
06716               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)   &amp;&amp;
06717               (PreviousState-&gt;Groups[0].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06718               (PreviousState-&gt;Groups[1].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>)
06719          ) {
06720 
06721             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06722 
06723          } <span class="keywordflow">else</span> {
06724 
06725             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06726             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06727 
06728             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06729                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06730                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06731 
06732             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06733                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06734                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06735 
06736             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06737                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06738                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06739 
06740             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06741                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06742                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06743 
06744             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06745 
06746             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06747 
06748         }
06749 
06750     } <span class="keywordflow">else</span> {
06751 
06752         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06753         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06754         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06755         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06756 
06757     }
06758 
06759     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
06760 
06761 
06762 
06763 
06765 <span class="comment">//                                                                     //</span>
06766 <span class="comment">//  Return to default state (capture previous state)                   //</span>
06767 <span class="comment">//                                                                     //</span>
06769 <span class="comment"></span>
06770     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Return to default state (w/previous state) ...         "</span>);
06771 
06772     PreGroups-&gt;GroupCount = 77;
06773     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06774                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06775                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06776                        PreGroups,              <span class="comment">// TokenInformation</span>
06777                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
06778                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06779                        );
06780 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06781 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06782 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06783 <span class="preprocessor"></span>
06784     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06785     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
06786     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
06787     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
06788     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
06789     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06790 
06791     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06792                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06793                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                         <span class="comment">// ResetToDefault</span>
06794                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// NewState (OPTIONAL)</span>
06795                  PreviousStateBufferLength,    <span class="comment">// BufferLength</span>
06796                  PreviousState,                <span class="comment">// PreviousState (OPTIONAL)</span>
06797                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06798                  );
06799 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06800 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) return length: 0x%lx \n"</span>, ReturnLength);
06801 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06802 <span class="preprocessor"></span>
06803     PostGroups-&gt;GroupCount = 88;
06804     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06805                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06806                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06807                        PostGroups,             <span class="comment">// TokenInformation</span>
06808                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06809                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06810                        );
06811 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06812 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06813 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06814 <span class="preprocessor"></span>
06815     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06816 
06817     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
06818 
06819          <span class="comment">//</span>
06820          <span class="comment">// Check the group values</span>
06821          <span class="comment">//</span>
06822 
06823          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06824          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06825               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06826               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06827               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)   &amp;&amp;
06828               (PreviousState-&gt;Groups[0].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>) &amp;&amp;
06829               (PreviousState-&gt;Groups[1].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>)
06830          ) {
06831 
06832             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06833 
06834          } <span class="keywordflow">else</span> {
06835 
06836             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06837             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06838 
06839             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06840                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06841                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06842 
06843             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06844                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06845                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06846 
06847             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06848                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06849                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06850 
06851             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06852                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06853                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06854 
06855             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06856 
06857             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06858 
06859         }
06860 
06861     } <span class="keywordflow">else</span> {
06862 
06863         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06864         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06865         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06866         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06867 
06868     }
06869 
06870     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
06871 
06872 
06873 
06875 <span class="comment">//                                                                     //</span>
06876 <span class="comment">//  Return to default state  (don't capture previous state)            //</span>
06877 <span class="comment">//                                                                     //</span>
06879 <span class="comment"></span>
06880     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Return to default state (no previous state) ...        "</span>);
06881 
06882     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06883                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06884                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                        <span class="comment">// ResetToDefault</span>
06885                  PreviousState,                <span class="comment">// NewState (OPTIONAL)</span>
06886                  0,                            <span class="comment">// BufferLength</span>
06887                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
06888                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06889                  );
06890 
06891     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
06892 
06893     PreGroups-&gt;GroupCount = 77;
06894     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06895                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06896                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06897                        PreGroups,              <span class="comment">// TokenInformation</span>
06898                        PreGroupsLength,        <span class="comment">// TokenInformationLength</span>
06899                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06900                        );
06901 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06902 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06903 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06904 <span class="preprocessor"></span>
06905     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06906     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>);
06907     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
06908     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>);
06909     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>);
06910     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06911 
06912     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a>(
06913                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,              <span class="comment">// TokenHandle</span>
06914                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                         <span class="comment">// ResetToDefault</span>
06915                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// NewState (OPTIONAL)</span>
06916                  0,                            <span class="comment">// BufferLength</span>
06917                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                         <span class="comment">// PreviousState (OPTIONAL)</span>
06918                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
06919                  );
06920 
06921     PostGroups-&gt;GroupCount = 88;
06922     IgnoreStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
06923                        <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>,        <span class="comment">// TokenHandle</span>
06924                        TokenGroups,            <span class="comment">// TokenInformationClass</span>
06925                        PostGroups,             <span class="comment">// TokenInformation</span>
06926                        PostGroupsLength,       <span class="comment">// TokenInformationLength</span>
06927                        &amp;IgnoreReturnLength     <span class="comment">// ReturnLength</span>
06928                        );
06929 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
06930 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n (debug) ignore return length: 0x%lx \n"</span>, IgnoreReturnLength);
06931 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
06932 <span class="preprocessor"></span>
06933     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06934 
06935     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
06936 
06937          <span class="comment">//</span>
06938          <span class="comment">// Check the group values</span>
06939          <span class="comment">//</span>
06940 
06941          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostGroups-&gt;GroupCount == <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a> );
06942          <span class="keywordflow">if</span> ( (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  == <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>)    &amp;&amp;
06943               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06944               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes == <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>) &amp;&amp;
06945               (PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       == <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>)
06946          ) {
06947 
06948             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
06949 
06950          } <span class="keywordflow">else</span> {
06951 
06952             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed  Value Check ************\n"</span>);
06953             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06954 
06955             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Flintstone state: 0x%lx / 0x%lx \n"</span>,
06956                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes,
06957                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes);
06958 
06959             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Child state: 0x%lx / 0x%lx \n"</span>,
06960                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes,
06961                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes);
06962 
06963             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after Neanderthol state: 0x%lx / 0x%lx \n"</span>,
06964                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes,
06965                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes);
06966 
06967             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before/after World state: 0x%lx / 0x%lx \n"</span>,
06968                     PreGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes,
06969                     PostGroups-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes);
06970 
06971             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06972 
06973             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06974 
06975         }
06976 
06977     } <span class="keywordflow">else</span> {
06978 
06979         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
06980         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06981         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Return Length is: 0x%lx \n"</span>, ReturnLength);
06982         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06983 
06984     }
06985 
06986     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
06987 
06988 
06989 
06990 
06992     <span class="comment">//                                                            //</span>
06993     <span class="comment">// Done with test                                             //</span>
06994     <span class="comment">//                                                            //</span>
06996 <span class="comment"></span>
06997 
06998 
06999     TstDeallocatePool( PreviousState, PreviousStateBufferLength );
07000     TstDeallocatePool( NewState, NewStateBufferLength );
07001     TstDeallocatePool( PreGroups, PreGroupsLength );
07002     TstDeallocatePool( PostGroups, PostGroupsLength );
07003 
07004 
07005     <span class="keywordflow">return</span> CompletionStatus;
07006 }
07007 
07008 
07010 <span class="comment">//                                                            //</span>
07011 <span class="comment">// Compare duplicate to original token &amp; display test results //</span>
07012 <span class="comment">//                                                            //</span>
07014 <span class="comment"></span>
07015 BOOLEAN
<a name="l07016"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a73">07016</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a73">TestpCompareDuplicateToken</a>(
07017     IN NTSTATUS Status,
07018     IN HANDLE OldToken,
07019     IN OBJECT_ATTRIBUTES NewAttributes,
07020     IN BOOLEAN EffectiveOnly,
07021     IN TOKEN_TYPE NewType,
07022     IN HANDLE NewToken
07023     )
07024 
07025 {
07026     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07027 
07028     ULONG OldReturnLength;
07029     ULONG NewReturnLength;
07030 
07031     PTOKEN_USER OldUserId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07032     PTOKEN_USER NewUserId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07033 
07034     TOKEN_SOURCE OldSource;
07035     TOKEN_SOURCE NewSource;
07036 
07037     TOKEN_STATISTICS OldStatistics;
07038     TOKEN_STATISTICS NewStatistics;
07039 
07040     BOOLEAN SomeNotCompared = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07041 
07042 
07043     <span class="comment">//</span>
07044     <span class="comment">// Appease the compiler Gods</span>
07045     <span class="comment">//</span>
07046     NewAttributes = NewAttributes;
07047     NewType = NewType;
07048     EffectiveOnly = EffectiveOnly;
07049 
07050 
07051     <span class="comment">//</span>
07052     <span class="comment">// If the status isn't success, don't bother comparing the tokens</span>
07053     <span class="comment">//</span>
07054 
07055     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
07056 
07057         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
07058         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
07059         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07060     }
07061 
07062     <span class="comment">//</span>
07063     <span class="comment">// Compare the user IDs</span>
07064     <span class="comment">//</span>
07065 
07066     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07067                  OldToken,                 <span class="comment">// Handle</span>
07068                  TokenUser,                <span class="comment">// TokenInformationClass</span>
07069                  OldUserId,                <span class="comment">// TokenInformation</span>
07070                  0,                        <span class="comment">// TokenInformationLength</span>
07071                  &amp;OldReturnLength          <span class="comment">// ReturnLength</span>
07072                  ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL);
07073     OldUserId = (PTOKEN_USER)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, OldReturnLength );
07074 
07075     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07076                  OldToken,                 <span class="comment">// Handle</span>
07077                  TokenUser,                <span class="comment">// TokenInformationClass</span>
07078                  OldUserId,                <span class="comment">// TokenInformation</span>
07079                  OldReturnLength,          <span class="comment">// TokenInformationLength</span>
07080                  &amp;OldReturnLength          <span class="comment">// ReturnLength</span>
07081                  ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07082 
07083 
07084     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07085                  NewToken,                 <span class="comment">// Handle</span>
07086                  TokenUser,                <span class="comment">// TokenInformationClass</span>
07087                  NewUserId,                <span class="comment">// TokenInformation</span>
07088                  0,                        <span class="comment">// TokenInformationLength</span>
07089                  &amp;NewReturnLength          <span class="comment">// ReturnLength</span>
07090                  ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL);
07091 
07092     NewUserId = (PTOKEN_USER)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, NewReturnLength );
07093 
07094     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07095                  NewToken,                 <span class="comment">// Handle</span>
07096                  TokenUser,                <span class="comment">// TokenInformationClass</span>
07097                  NewUserId,                <span class="comment">// TokenInformation</span>
07098                  NewReturnLength,          <span class="comment">// TokenInformationLength</span>
07099                  &amp;NewReturnLength          <span class="comment">// ReturnLength</span>
07100                  ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07101 
07102 
07103     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(OldUserId-&gt;User.Sid, NewUserId-&gt;User.Sid) ) {
07104 
07105         <span class="keywordflow">if</span> (CompletionStatus) {
07106             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed Value Comparison ***\n"</span>);
07107         }
07108         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"User IDs don't match.\n"</span>);
07109         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07110     }
07111 
07112     TstDeallocatePool( OldUserId, OldReturnLength );
07113     TstDeallocatePool( NewUserId, NewReturnLength );
07114 
07115 
07116     <span class="comment">//</span>
07117     <span class="comment">// Check the token statistics</span>
07118     <span class="comment">//</span>
07119 
07120     <span class="keywordflow">if</span> (CompletionStatus) {
07121         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07122                      OldToken,                        <span class="comment">// Handle</span>
07123                      TokenStatistics,                 <span class="comment">// TokenInformationClass</span>
07124                      &amp;OldStatistics,                  <span class="comment">// TokenInformation</span>
07125                      (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS), <span class="comment">// TokenInformationLength</span>
07126                      &amp;OldReturnLength                 <span class="comment">// ReturnLength</span>
07127                      ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07128 
07129         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07130                      NewToken,                        <span class="comment">// Handle</span>
07131                      TokenStatistics,                 <span class="comment">// TokenInformationClass</span>
07132                      &amp;NewStatistics,                  <span class="comment">// TokenInformation</span>
07133                      (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS), <span class="comment">// TokenInformationLength</span>
07134                      &amp;NewReturnLength                 <span class="comment">// ReturnLength</span>
07135                      ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07136         <span class="comment">//</span>
07137         <span class="comment">// Must have:</span>
07138         <span class="comment">//             Different TokenId values</span>
07139         <span class="comment">//             Same authenticationId value</span>
07140         <span class="comment">//             Same ExpirationTime</span>
07141         <span class="comment">//             Same token type</span>
07142         <span class="comment">//             Same ImpersonationLevel (if correct token type)</span>
07143         <span class="comment">//             Same DynamicCharged &amp; DynamicAvailable</span>
07144         <span class="comment">//</span>
07145         <span class="comment">// GroupCount and PrivilegeCount are deferred to the group and</span>
07146         <span class="comment">// privilege comparison due to the difficulty involved with</span>
07147         <span class="comment">// taking EffectiveOnly into account.</span>
07148         <span class="comment">//</span>
07149         <span class="comment">// The new token must have a ModifiedId that is the same as the</span>
07150         <span class="comment">// original.</span>
07151         <span class="comment">//</span>
07152 
07153         <span class="comment">//</span>
07154         <span class="comment">// Token ID</span>
07155         <span class="comment">//</span>
07156 
07157         <span class="keywordflow">if</span> ( (OldStatistics.TokenId.HighPart ==
07158               NewStatistics.TokenId.HighPart)    &amp;&amp;
07159              (OldStatistics.TokenId.LowPart ==
07160               NewStatistics.TokenId.LowPart)  ) {
07161 
07162             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed ***\n"</span>);
07163             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       TokenIds are equal.\n"</span>);
07164             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Old TokenId is: (0x%xl, 0x%xl)\n"</span>,
07165                             OldStatistics.TokenId.HighPart,
07166                             OldStatistics.TokenId.LowPart);
07167             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       New TokenId is: (0x%xl, 0x%xl)\n"</span>,
07168                             NewStatistics.TokenId.HighPart,
07169                             NewStatistics.TokenId.LowPart);
07170             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       "</span>);
07171             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07172         }
07173 
07174 
07175         <span class="comment">//</span>
07176         <span class="comment">// Authentication ID</span>
07177         <span class="comment">//</span>
07178 
07179         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;OldStatistics.AuthenticationId,
07180                            &amp;NewStatistics.AuthenticationId) ) {
07181 
07182             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed ***\n"</span>);
07183             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       AuthenticationIds are not equal.\n"</span>);
07184             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Original Authentication ID is: "</span>);
07185             <a class="code" href="../../d2/d1/cttoken_8c.html#a17">TestpPrintLuid</a>(OldStatistics.AuthenticationId);
07186             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
07187             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"New Authentication ID is: "</span>);
07188             <a class="code" href="../../d2/d1/cttoken_8c.html#a17">TestpPrintLuid</a>(NewStatistics.AuthenticationId);
07189             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
07190             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       "</span>);
07191             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07192         }
07193 
07194         <span class="comment">//</span>
07195         <span class="comment">// ExpirationTime</span>
07196         <span class="comment">//</span>
07197 
07198         <span class="keywordflow">if</span> ( (OldStatistics.ExpirationTime.HighPart !=
07199               NewStatistics.ExpirationTime.HighPart)    ||
07200              (OldStatistics.ExpirationTime.LowPart !=
07201               NewStatistics.ExpirationTime.LowPart)  ) {
07202 
07203             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed ***\n"</span>);
07204             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       ExpirationTimes differ.\n"</span>);
07205             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       "</span>);
07206             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07207         }
07208 
07209         <span class="comment">//</span>
07210         <span class="comment">// TokenType</span>
07211         <span class="comment">//</span>
07212 
07213         <span class="keywordflow">if</span> ( OldStatistics.TokenType != NewStatistics.TokenType ) {
07214 
07215             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed ***\n"</span>);
07216             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Token types are different.\n"</span>);
07217             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Old token type is:  0x%lx \n"</span>, OldStatistics.TokenType );
07218             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       New token type is:  0x%lx \n"</span>, NewStatistics.TokenType );
07219             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       "</span>);
07220             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07221         }
07222 
07223         <span class="comment">//</span>
07224         <span class="comment">// ImpersonationLevel</span>
07225         <span class="comment">//</span>
07226 
07227         <span class="keywordflow">if</span> (NewStatistics.TokenType = TokenImpersonation) {
07228             <span class="keywordflow">if</span> ( OldStatistics.ImpersonationLevel !=
07229                  NewStatistics.ImpersonationLevel ) {
07230 
07231                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed ***\n"</span>);
07232                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Impersonation levels are different.\n"</span>);
07233                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Old impersonation level  is:  0x%lx \n"</span>,
07234                                 OldStatistics.ImpersonationLevel );
07235                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       New impersonation level is:  0x%lx \n"</span>,
07236                                 NewStatistics.ImpersonationLevel );
07237                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       "</span>);
07238                 CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07239             }
07240         }
07241 
07242         <span class="comment">//</span>
07243         <span class="comment">// DynamicCharged</span>
07244         <span class="comment">//</span>
07245 
07246         <span class="keywordflow">if</span> ( OldStatistics.DynamicCharged != NewStatistics.DynamicCharged ) {
07247 
07248             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed ***\n"</span>);
07249             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       DynamicCharges are different.\n"</span>);
07250             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Old value is:  0x%lx \n"</span>, OldStatistics.DynamicCharged );
07251             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       New value is:  0x%lx \n"</span>, NewStatistics.DynamicCharged );
07252             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       "</span>);
07253             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07254         }
07255 
07256         <span class="comment">//</span>
07257         <span class="comment">// DynamicAvailable</span>
07258         <span class="comment">//</span>
07259 
07260         <span class="keywordflow">if</span> ( OldStatistics.DynamicAvailable != NewStatistics.DynamicAvailable ) {
07261 
07262             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed ***\n"</span>);
07263             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       DynamicAvailable are different.\n"</span>);
07264             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Old value is:  0x%lx \n"</span>, OldStatistics.DynamicAvailable );
07265             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       New value is:  0x%lx \n"</span>, NewStatistics.DynamicAvailable );
07266             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       "</span>);
07267             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07268         }
07269 
07270 
07271         <span class="comment">//</span>
07272         <span class="comment">// ModifiedId</span>
07273         <span class="comment">//</span>
07274 
07275         <span class="keywordflow">if</span> ( (NewStatistics.ModifiedId.HighPart !=
07276               OldStatistics.ModifiedId.HighPart)   ||
07277              (NewStatistics.ModifiedId.LowPart  !=
07278               OldStatistics.ModifiedId.LowPart)     ) {
07279 
07280             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed ***\n"</span>);
07281             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       ModifiedIds different.\n"</span>);
07282             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Old ModifiedId is: (0x%xl, 0x%xl)\n"</span>,
07283                             OldStatistics.ModifiedId.HighPart,
07284                             OldStatistics.ModifiedId.LowPart);
07285             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       New ModifiedId is: (0x%xl, 0x%xl)\n"</span>,
07286                             NewStatistics.ModifiedId.HighPart,
07287                             NewStatistics.ModifiedId.LowPart);
07288             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       "</span>);
07289             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07290         }
07291 
07292     }
07293 
07294     <span class="comment">//</span>
07295     <span class="comment">// Compare the group IDs</span>
07296     <span class="comment">//</span>
07297 
07298     SomeNotCompared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07299 
07300     <span class="comment">//</span>
07301     <span class="comment">// Compare the privileges</span>
07302     <span class="comment">//</span>
07303 
07304     SomeNotCompared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07305 
07306     <span class="comment">//</span>
07307     <span class="comment">// Compare the owner IDs</span>
07308     <span class="comment">//</span>
07309 
07310     SomeNotCompared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07311 
07312     <span class="comment">//</span>
07313     <span class="comment">// Compare the primary group IDs</span>
07314     <span class="comment">//</span>
07315 
07316     SomeNotCompared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07317 
07318     <span class="comment">//</span>
07319     <span class="comment">// Compare the default dacls</span>
07320     <span class="comment">//</span>
07321 
07322     SomeNotCompared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07323 
07324     <span class="comment">//</span>
07325     <span class="comment">// Compare the token source</span>
07326     <span class="comment">//</span>
07327 
07328     <span class="keywordflow">if</span> (CompletionStatus) {
07329         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07330                      OldToken,                    <span class="comment">// Handle</span>
07331                      TokenSource,                 <span class="comment">// TokenInformationClass</span>
07332                      &amp;OldSource,                  <span class="comment">// TokenInformation</span>
07333                      (ULONG)<span class="keyword">sizeof</span>(TOKEN_SOURCE), <span class="comment">// TokenInformationLength</span>
07334                      &amp;OldReturnLength             <span class="comment">// ReturnLength</span>
07335                      ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07336 
07337         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07338                      NewToken,                    <span class="comment">// Handle</span>
07339                      TokenSource,                 <span class="comment">// TokenInformationClass</span>
07340                      &amp;NewSource,                  <span class="comment">// TokenInformation</span>
07341                      (ULONG)<span class="keyword">sizeof</span>(TOKEN_SOURCE), <span class="comment">// TokenInformationLength</span>
07342                      &amp;NewReturnLength             <span class="comment">// ReturnLength</span>
07343                      ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07344 
07345         <span class="keywordflow">if</span> ( (OldSource.SourceIdentifier.HighPart ==
07346               NewSource.SourceIdentifier.HighPart)    &amp;&amp;
07347              (OldSource.SourceIdentifier.LowPart ==
07348               NewSource.SourceIdentifier.LowPart)  ) {
07349             <span class="keywordflow">if</span> (  (OldSource.SourceName[0] != NewSource.SourceName[0])  ||
07350                   (OldSource.SourceName[1] != NewSource.SourceName[1])  ||
07351                   (OldSource.SourceName[2] != NewSource.SourceName[2])  ||
07352                   (OldSource.SourceName[3] != NewSource.SourceName[3])  ||
07353                   (OldSource.SourceName[4] != NewSource.SourceName[4])  ||
07354                   (OldSource.SourceName[5] != NewSource.SourceName[5])  ||
07355                   (OldSource.SourceName[6] != NewSource.SourceName[6])  ||
07356                   (OldSource.SourceName[7] != NewSource.SourceName[7])  ) {
07357 
07358                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed Value Comparison ***\n"</span>);
07359                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       SourceName changed.\n"</span>);
07360                 CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07361 
07362             }
07363         } <span class="keywordflow">else</span> {
07364 
07365             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Failed Value Comparison ***\n"</span>);
07366             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       SourceIdentifier changed.\n"</span>);
07367             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       Old SourceIdentifier is: (0x%xl, 0x%xl)\n"</span>,
07368                             OldSource.SourceIdentifier.HighPart,
07369                             OldSource.SourceIdentifier.LowPart);
07370             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"       New SourceIdentifier is: (0x%xl, 0x%xl)\n"</span>,
07371                             NewSource.SourceIdentifier.HighPart,
07372                             NewSource.SourceIdentifier.LowPart);
07373             CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07374 
07375         }
07376     }
07377 
07379 
07380 
07381     <span class="keywordflow">if</span> (SomeNotCompared) {
07382         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Incomplete\n"</span>);
07383         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        Some fields not yet compared ...                       "</span>);
07384     }
07385 
07386     <span class="keywordflow">if</span> (CompletionStatus) {
07387 
07388         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded. \n"</span>);
07389     }
07390 
07391     <span class="keywordflow">return</span> CompletionStatus;
07392 }
07393 
07394 
07396 <span class="comment">//                                                            //</span>
07397 <span class="comment">// Duplicate Token Test                                       //</span>
07398 <span class="comment">//                                                            //</span>
07400 <span class="comment"></span>
07401 BOOLEAN
<a name="l07402"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a74">07402</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a74">TestTokenDuplicate</a>()
07403 {
07404     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07405 
07406     BOOLEAN EffectiveOnly;
07407     TOKEN_TYPE NewType;
07408     HANDLE NewToken;
07409 
07410     OBJECT_ATTRIBUTES NewAttributes;
07411 
07412     SECURITY_QUALITY_OF_SERVICE ImpersonationLevel;
07413     SECURITY_QUALITY_OF_SERVICE IdentificationLevel;
07414 
07415 
07416 
07417     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
07418 
07419     <span class="comment">//</span>
07420     <span class="comment">// Initialize variables</span>
07421     <span class="comment">//</span>
07422 
07423     ImpersonationLevel.Length = (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
07424     ImpersonationLevel.ImpersonationLevel = SecurityImpersonation;
07425     ImpersonationLevel.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
07426     ImpersonationLevel.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07427 
07428     IdentificationLevel.Length = (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
07429     IdentificationLevel.ImpersonationLevel = SecurityImpersonation;
07430     IdentificationLevel.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
07431     IdentificationLevel.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07432 
07433 
07434     InitializeObjectAttributes(
07435         &amp;NewAttributes,
07436         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
07437         OBJ_INHERIT,
07438         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
07439         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
07440         );
07441 
07442 
07443 
07445     <span class="comment">//                                                        //</span>
07446     <span class="comment">// Duplicate the simple token                             //</span>
07447     <span class="comment">//                                                        //</span>
07449 <span class="comment"></span>
07450     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Duplicate primary token ...                            "</span>);
07451 
07452     EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07453     NewType = TokenImpersonation;
07454     NewAttributes.SecurityQualityOfService = &amp;ImpersonationLevel;
07455 
07456     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>(
07457                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>,             <span class="comment">// ExistingTokenHandle</span>
07458                  0,                       <span class="comment">// DesiredAccess</span>
07459                  &amp;NewAttributes,          <span class="comment">// ObjectAttributes</span>
07460                  EffectiveOnly,           <span class="comment">// EffectiveOnly</span>
07461                  NewType,                 <span class="comment">// TokenType</span>
07462                  &amp;NewToken                <span class="comment">// NewTokenHandle</span>
07463                  );
07464 
07465     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
07466         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
07467         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( NewToken ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewToken));
07468 
07469     } <span class="keywordflow">else</span> {
07470 
07471         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
07472         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
07473         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07474     }
07475 
07476 
07477 
07479     <span class="comment">//                                                        //</span>
07480     <span class="comment">// Duplicate the restricted token                         //</span>
07481     <span class="comment">//                                                        //</span>
07483 <span class="comment"></span>
07484     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Duplicate restricted sids ...                          "</span>);
07485 
07486     EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07487     NewType = TokenImpersonation;
07488     NewAttributes.SecurityQualityOfService = &amp;ImpersonationLevel;
07489 
07490     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>(
07491                  <a class="code" href="../../d2/d1/cttoken_8c.html#a26">TokenWithRestrictedSids</a>, <span class="comment">// ExistingTokenHandle</span>
07492                  0,                       <span class="comment">// DesiredAccess</span>
07493                  &amp;NewAttributes,          <span class="comment">// ObjectAttributes</span>
07494                  EffectiveOnly,           <span class="comment">// EffectiveOnly</span>
07495                  NewType,                 <span class="comment">// TokenType</span>
07496                  &amp;NewToken                <span class="comment">// NewTokenHandle</span>
07497                  );
07498 
07499     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
07500         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
07501         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( NewToken ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewToken));
07502 
07503     } <span class="keywordflow">else</span> {
07504 
07505         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
07506         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
07507         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07508     }
07509 
07510 
07512     <span class="comment">//                                                        //</span>
07513     <span class="comment">// Duplicate the token with restricted groups             //</span>
07514     <span class="comment">//                                                        //</span>
07516 <span class="comment"></span>
07517     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Duplicate restricted groups ...                          "</span>);
07518 
07519     EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07520     NewType = TokenImpersonation;
07521     NewAttributes.SecurityQualityOfService = &amp;ImpersonationLevel;
07522 
07523     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>(
07524                  <a class="code" href="../../d2/d1/cttoken_8c.html#a26">TokenWithRestrictedSids</a>, <span class="comment">// ExistingTokenHandle</span>
07525                  0,                       <span class="comment">// DesiredAccess</span>
07526                  &amp;NewAttributes,          <span class="comment">// ObjectAttributes</span>
07527                  EffectiveOnly,           <span class="comment">// EffectiveOnly</span>
07528                  NewType,                 <span class="comment">// TokenType</span>
07529                  &amp;NewToken                <span class="comment">// NewTokenHandle</span>
07530                  );
07531 
07532     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
07533         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
07534         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( NewToken ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewToken));
07535 
07536     } <span class="keywordflow">else</span> {
07537 
07538         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
07539         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
07540         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07541     }
07542 
07543 
07545     <span class="comment">//                                                        //</span>
07546     <span class="comment">// Duplicate the full impersonation token                 //</span>
07547     <span class="comment">//                                                        //</span>
07549 <span class="comment"></span>
07550     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Duplicate full impersonation token ...                      "</span>);
07551 
07552     EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07553     NewType = TokenImpersonation;
07554     NewAttributes.SecurityQualityOfService = &amp;ImpersonationLevel;
07555 
07556     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>(
07557                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>,       <span class="comment">// ExistingTokenHandle</span>
07558                  0,                        <span class="comment">// DesiredAccess</span>
07559                  &amp;NewAttributes,           <span class="comment">// ObjectAttributes</span>
07560                  EffectiveOnly,            <span class="comment">// EffectiveOnly</span>
07561                  NewType,                  <span class="comment">// TokenType</span>
07562                  &amp;NewToken                 <span class="comment">// NewTokenHandle</span>
07563                  );
07564     <span class="comment">//</span>
07565     <span class="comment">// Check to see that the duplicate is really a duplicate of</span>
07566     <span class="comment">// the original and display the test results.</span>
07567     <span class="comment">//</span>
07568 
07569     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a73">TestpCompareDuplicateToken</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
07570                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>,
07571                                      NewAttributes,
07572                                      EffectiveOnly,
07573                                      NewType,
07574                                      NewToken ) ) {
07575 
07576         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07577     }
07578 
07579     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
07580 
07581         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( NewToken );
07582 
07583         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07584     }
07585 
07586 
07588     <span class="comment">//                                                        //</span>
07589     <span class="comment">// Duplicate the full token, effective only               //</span>
07590     <span class="comment">//                                                        //</span>
07592 <span class="comment"></span>
07593     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Duplicate full token, effective only ...                    "</span>);
07594 
07595     EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07596     NewType = TokenImpersonation;
07597     NewAttributes.SecurityQualityOfService = &amp;ImpersonationLevel;
07598 
07599     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>(
07600                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>,       <span class="comment">// ExistingTokenHandle</span>
07601                  0,                        <span class="comment">// DesiredAccess</span>
07602                  &amp;NewAttributes,           <span class="comment">// ObjectAttributes</span>
07603                  EffectiveOnly,            <span class="comment">// EffectiveOnly</span>
07604                  NewType,                  <span class="comment">// TokenType</span>
07605                  &amp;NewToken                 <span class="comment">// NewTokenHandle</span>
07606                  );
07607     <span class="comment">//</span>
07608     <span class="comment">// Check to see that the duplicate is really a duplicate of</span>
07609     <span class="comment">// the original and display the test results.</span>
07610     <span class="comment">//</span>
07611 
07612     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a73">TestpCompareDuplicateToken</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
07613                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>,
07614                                      NewAttributes,
07615                                      EffectiveOnly,
07616                                      NewType,
07617                                      NewToken ) ) {
07618 
07619         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07620     }
07621 
07622     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
07623 
07624         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( NewToken );
07625 
07626         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07627     }
07628 
07629 
07630 
07631 
07632 
07633 
07634 
07635 
07636 
07637 
07638     <span class="keywordflow">return</span> CompletionStatus;
07639 }
07640 
07642 <span class="comment">//                                                            //</span>
07643 <span class="comment">// Assign Primary Token Test                                  //</span>
07644 <span class="comment">//                                                            //</span>
07646 <span class="comment"></span>
07647 BOOLEAN
<a name="l07648"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a75">07648</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a75">TestTokenAssignPrimary</a>()
07649 {
07650     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07651     ULONG ReturnLength;
07652 
07653     TOKEN_STATISTICS OriginalTokenStatistics;
07654     TOKEN_STATISTICS NewTokenStatistics;
07655     TOKEN_STATISTICS AssignedTokenStatistics;
07656 
07657 
07658     TOKEN_USER UserId;
07659     TOKEN_PRIMARY_GROUP PrimaryGroup;
07660     PTOKEN_GROUPS GroupIds;
07661     PTOKEN_PRIVILEGES Privileges;
07662     TOKEN_DEFAULT_DACL DefaultDacl;
07663     TOKEN_OWNER <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
07664 
07665     PROCESS_ACCESS_TOKEN PrimaryTokenInfo;
07666 
07667     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
07668 
07669 
07671     <span class="comment">//                                                        //</span>
07672     <span class="comment">// Assign a valid primary token                           //</span>
07673     <span class="comment">//                                                        //</span>
07675 <span class="comment"></span>
07676     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Assign new primary token ...                           "</span>);
07677 
07678     <span class="comment">//</span>
07679     <span class="comment">// Get information about the current token</span>
07680     <span class="comment">//</span>
07681 
07682     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
07683                  NtCurrentProcess(),
07684                  TOKEN_ALL_ACCESS,
07685                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>
07686                  );
07687     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07688 
07689     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07690                  <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>,                 <span class="comment">// Handle</span>
07691                  TokenStatistics,              <span class="comment">// TokenInformationClass</span>
07692                  &amp;OriginalTokenStatistics,     <span class="comment">// TokenInformation</span>
07693                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
07694                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
07695                  );
07696     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07697 
07698 
07699 
07700 
07701     <span class="comment">//</span>
07702     <span class="comment">// Create a token with default DACL for use</span>
07703     <span class="comment">//</span>
07704 
07705     GroupIds = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
07706                                                <a class="code" href="../../d6/d0/ctaccess_8c.html#a3">GROUP_IDS_LENGTH</a>
07707                                                );
07708 
07709     Privileges = (PTOKEN_PRIVILEGES)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
07710                                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a5">PRIVILEGES_LENGTH</a>
07711                                                      );
07712 
07713     DefaultDacl.DefaultDacl = (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
07714                                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>
07715                                                      );
07716 
07717     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
07718 
07719     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
07720     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
07721     GroupIds-&gt;Groups[<a class="code" href="../../d2/d1/cttoken_8c.html#a9">SYSTEM_INDEX</a>].Sid      = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">LocalSystemSid</a>;
07722     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
07723 
07724     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
07725     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
07726     GroupIds-&gt;Groups[<a class="code" href="../../d2/d1/cttoken_8c.html#a9">SYSTEM_INDEX</a>].Attributes      = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
07727     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
07728 
07729     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
07730     UserId.User.Attributes = 0;
07731 
07732     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
07733 
07734     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
07735 
07736     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
07737     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
07738     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>;
07739     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
07740     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
07741     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Attributes = SE_PRIVILEGE_ENABLED;
07742 
07743     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
07744 
07745     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( DefaultDacl.DefaultDacl, <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>, ACL_REVISION);
07746 
07747     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
07748 
07749     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
07750                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
07751                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
07752                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
07753                  TokenPrimary,             <span class="comment">// TokenType</span>
07754                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
07755                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
07756                  &amp;UserId,                  <span class="comment">// Owner ID</span>
07757                  GroupIds,                 <span class="comment">// Group IDs</span>
07758                  Privileges,               <span class="comment">// Privileges</span>
07759                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
07760                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
07761                  &amp;DefaultDacl,             <span class="comment">// Default Dacl</span>
07762                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
07763                  );
07764     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07765 
07766     <span class="comment">//</span>
07767     <span class="comment">// Make sure key data is different than what is already on the process.</span>
07768     <span class="comment">//</span>
07769 
07770     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07771                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                        <span class="comment">// Handle</span>
07772                  TokenStatistics,              <span class="comment">// TokenInformationClass</span>
07773                  &amp;NewTokenStatistics,          <span class="comment">// TokenInformation</span>
07774                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
07775                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
07776                  );
07777     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07778 
07779     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (OriginalTokenStatistics.TokenId.HighPart !=
07780              NewTokenStatistics.TokenId.HighPart)  ||
07781             (OriginalTokenStatistics.TokenId.LowPart !=
07782              NewTokenStatistics.TokenId.LowPart)        );
07783 
07784 
07785 
07786     <span class="comment">//</span>
07787     <span class="comment">// Assign the new token</span>
07788     <span class="comment">//</span>
07789 
07790     PrimaryTokenInfo.Token  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
07791     PrimaryTokenInfo.Thread = NtCurrentThread();
07792     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a19">NtSetInformationProcess</a>(
07793                  NtCurrentProcess(),
07794                  ProcessAccessToken,
07795                  (PVOID)&amp;PrimaryTokenInfo,
07796                  (ULONG)<span class="keyword">sizeof</span>(PROCESS_ACCESS_TOKEN)
07797                  );
07798 
07799     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
07800 
07801         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
07802         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
07803         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07804 
07805     } <span class="keywordflow">else</span> {
07806 
07807         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
07808         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07809 
07810 
07811         <span class="comment">//</span>
07812         <span class="comment">// Get information about the assigned token</span>
07813         <span class="comment">//</span>
07814 
07815         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
07816                      NtCurrentProcess(),
07817                      TOKEN_QUERY | TOKEN_QUERY_SOURCE,
07818                      &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>
07819                      );
07820         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07821 
07822         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
07823                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                        <span class="comment">// Handle</span>
07824                      TokenStatistics,              <span class="comment">// TokenInformationClass</span>
07825                      &amp;AssignedTokenStatistics,     <span class="comment">// TokenInformation</span>
07826                      <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
07827                      &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
07828                      );
07829         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07830 
07831         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
07832         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07833 
07834 
07835         <span class="comment">//</span>
07836         <span class="comment">// Information about assigned token and the new token</span>
07837         <span class="comment">// should be the same</span>
07838         <span class="comment">//</span>
07839 
07840         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AssignedTokenStatistics.TokenType == TokenPrimary);
07841 
07842         <span class="keywordflow">if</span> ( (NewTokenStatistics.TokenId.HighPart ==
07843               AssignedTokenStatistics.TokenId.HighPart)  &amp;&amp;
07844              (NewTokenStatistics.TokenId.LowPart ==
07845               AssignedTokenStatistics.TokenId.LowPart) ) {
07846 
07847             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
07848 
07849         } <span class="keywordflow">else</span> {
07850 
07851         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
07852         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Token ID mismatch.\n"</span>);
07853         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"New token ID is:      (0x%lx, 0x%lx) \n"</span>,
07854                  NewTokenStatistics.TokenId.HighPart,
07855                  NewTokenStatistics.TokenId.LowPart);
07856         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Assigned token ID is: (0x%lx, 0x%lx) \n"</span>,
07857                  AssignedTokenStatistics.TokenId.HighPart,
07858                  AssignedTokenStatistics.TokenId.LowPart);
07859         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07860 
07861         }
07862     }
07863 
07864     <span class="comment">//</span>
07865     <span class="comment">// Change back to the original token</span>
07866     <span class="comment">//</span>
07867 
07868     PrimaryTokenInfo.Token  = <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>;
07869     PrimaryTokenInfo.Thread = NtCurrentThread();
07870     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a19">NtSetInformationProcess</a>(
07871                  NtCurrentProcess(),
07872                  ProcessAccessToken,
07873                  (PVOID)&amp;PrimaryTokenInfo,
07874                  (ULONG)<span class="keyword">sizeof</span>(PROCESS_ACCESS_TOKEN)
07875                  );
07876 
07877     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07878     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a> );
07879     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07880 
07881 
07883     <span class="comment">//                                                        //</span>
07884     <span class="comment">// Attempt to assign an impersonation token as primary    //</span>
07885     <span class="comment">//                                                        //</span>
07887 <span class="comment"></span>
07888     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Assign impersonation token as primary ...              "</span>);
07889 
07890 
07891     <span class="comment">//</span>
07892     <span class="comment">// Create an impersonation token</span>
07893     <span class="comment">//</span>
07894     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
07895 
07896     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
07897     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
07898     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
07899     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
07900 
07901     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
07902     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
07903     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
07904     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
07905 
07906     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
07907     UserId.User.Attributes = 0;
07908 
07909     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
07910 
07911     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
07912 
07913     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
07914     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
07915     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>;
07916     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
07917     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
07918     Privileges-&gt;Privileges[<a class="code" href="../../d2/d1/cttoken_8c.html#a15">ASSIGN_PRIMARY_INDEX</a>].Attributes = SE_PRIVILEGE_ENABLED;
07919 
07920     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
07921 
07922     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( DefaultDacl.DefaultDacl, <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>, ACL_REVISION);
07923 
07924     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
07925 
07926     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
07927                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                   <span class="comment">// Handle</span>
07928                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
07929                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
07930                  TokenImpersonation,       <span class="comment">// TokenType</span>
07931                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a51">OriginalAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
07932                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
07933                  &amp;UserId,                  <span class="comment">// Owner ID</span>
07934                  GroupIds,                 <span class="comment">// Group IDs</span>
07935                  Privileges,               <span class="comment">// Privileges</span>
07936                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
07937                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
07938                  &amp;DefaultDacl,             <span class="comment">// Default Dacl</span>
07939                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
07940                  );
07941     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07942 
07943     <span class="comment">//</span>
07944     <span class="comment">// Assign the new token</span>
07945     <span class="comment">//</span>
07946 
07947     PrimaryTokenInfo.Token  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
07948     PrimaryTokenInfo.Thread = NtCurrentThread();
07949     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a19">NtSetInformationProcess</a>(
07950                  NtCurrentProcess(),
07951                  ProcessAccessToken,
07952                  (PVOID)&amp;PrimaryTokenInfo,
07953                  (ULONG)<span class="keyword">sizeof</span>(PROCESS_ACCESS_TOKEN)
07954                  );
07955 
07956     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BAD_TOKEN_TYPE) {
07957 
07958         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
07959 
07960     } <span class="keywordflow">else</span> {
07961 
07962         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
07963         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
07964         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07965 
07966     }
07967 
07968     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
07969     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
07970 
07971 
07972     <span class="keywordflow">return</span> CompletionStatus;
07973 }
07974 
07976 <span class="comment">//                                                            //</span>
07977 <span class="comment">// Impersonation Test  (with open test)                       //</span>
07978 <span class="comment">//                                                            //</span>
07980 <span class="comment"></span>
07981 BOOLEAN
<a name="l07982"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a76">07982</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a76">TestTokenImpersonation</a>()
07983 {
07984     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07985 
07986     HANDLE OpenedToken;
07987     HANDLE NewToken;
07988     OBJECT_ATTRIBUTES NewAttributes;
07989     TOKEN_TYPE NewType;
07990     BOOLEAN EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07991 
07992     SECURITY_QUALITY_OF_SERVICE ImpersonationLevel;
07993 
07994 
07995 
07996     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
07997 
07998 
08000     <span class="comment">//                                                        //</span>
08001     <span class="comment">// Terminate impersonation using NtSetInformationThread() //</span>
08002     <span class="comment">//                                                        //</span>
08004 <span class="comment"></span>
08005     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Revert to self (specify NULL handle) ...               "</span>);
08006 
08007     NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08008     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08009                  NtCurrentThread(),
08010                  ThreadImpersonationToken,
08011                  (PVOID)&amp;NewToken,
08012                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08013                  );
08014 
08015     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
08016         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08017     } <span class="keywordflow">else</span> {
08018 
08019         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08020         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08021         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08022 
08023     }
08024 
08025 
08027     <span class="comment">//                                                        //</span>
08028     <span class="comment">// Attempt to assign a primary token as an impersonation  //</span>
08029     <span class="comment">// token.                                                 //</span>
08030     <span class="comment">//                                                        //</span>
08032 <span class="comment"></span>
08033     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Assigning primary token as impersonation token ...     "</span>);
08034 
08035     NewToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>;
08036     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08037                  NtCurrentThread(),
08038                  ThreadImpersonationToken,
08039                  (PVOID)&amp;NewToken,
08040                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08041                  );
08042 
08043     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BAD_TOKEN_TYPE) {
08044         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08045     } <span class="keywordflow">else</span> {
08046 
08047         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08048         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08049         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08050 
08051     }
08052 
08053 
08055     <span class="comment">//                                                        //</span>
08056     <span class="comment">// Assign a valid impersonation token                     //</span>
08057     <span class="comment">//                                                        //</span>
08059 <span class="comment"></span>
08060     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Assign valid impersonation token ...                   "</span>);
08061 
08062     NewToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>;
08063     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08064                  NtCurrentThread(),
08065                  ThreadImpersonationToken,
08066                  (PVOID)&amp;NewToken,
08067                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08068                  );
08069 
08070     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
08071         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08072     } <span class="keywordflow">else</span> {
08073 
08074         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08075         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08076         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08077 
08078     }
08079 
08080 
08082     <span class="comment">//                                                        //</span>
08083     <span class="comment">// Open the impersonation token                           //</span>
08084     <span class="comment">//                                                        //</span>
08086 <span class="comment"></span>
08087 
08088     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Open an impersonation token ...                        "</span>);
08089 
08090     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
08091                  NtCurrentThread(),
08092                  TOKEN_ALL_ACCESS,
08093                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
08094                  &amp;OpenedToken
08095                  );
08096 
08097     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
08098         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08099         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( OpenedToken );
08100         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08101     } <span class="keywordflow">else</span> {
08102 
08103         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08104         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08105         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08106 
08107     }
08108 
08109 
08110 
08112     <span class="comment">//                                                        //</span>
08113     <span class="comment">// Open a non-existent impersonation token                //</span>
08114     <span class="comment">//                                                        //</span>
08116 <span class="comment"></span>
08117 
08118     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Open a non-existent impersonation token ...            "</span>);
08119 
08120     <span class="comment">//</span>
08121     <span class="comment">// Clear any existing impersonation token.</span>
08122     <span class="comment">//</span>
08123 
08124     NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08125     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08126                  NtCurrentThread(),
08127                  ThreadImpersonationToken,
08128                  (PVOID)&amp;NewToken,
08129                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08130                  );  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08131 
08132     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
08133                  NtCurrentThread(),
08134                  TOKEN_ALL_ACCESS,
08135                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
08136                  &amp;OpenedToken
08137                  );
08138 
08139     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_TOKEN) {
08140         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08141     } <span class="keywordflow">else</span> {
08142 
08143         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08144         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08145         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08146 
08147     }
08148 
08149 
08151     <span class="comment">//                                                        //</span>
08152     <span class="comment">// Open an anonymous   impersonation token                //</span>
08153     <span class="comment">//                                                        //</span>
08155 <span class="comment"></span>
08156 
08157     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Open an anonymous impersonation token ...              "</span>);
08158 
08159     <span class="comment">//</span>
08160     <span class="comment">//  Assign an anonymous impersonation token</span>
08161     <span class="comment">//</span>
08162 
08163     NewToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a32">AnonymousToken</a>;
08164     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08165                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
08166                  ThreadImpersonationToken,
08167                  (PVOID)&amp;NewToken,
08168                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08169                  );  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08170 
08171 
08172     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
08173                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
08174                  TOKEN_ALL_ACCESS,
08175                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
08176                  &amp;OpenedToken
08177                  );
08178 
08179     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_OPEN_ANONYMOUS) {
08180         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08181     } <span class="keywordflow">else</span> {
08182 
08183         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08184         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08185         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08186 
08187     }
08188 
08189 
08191     <span class="comment">//                                                        //</span>
08192     <span class="comment">// Change the impersonation of a thread                   //</span>
08193     <span class="comment">//                                                        //</span>
08195 <span class="comment"></span>
08196 
08197     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Change the impersonation token ...                     "</span>);
08198 
08199     NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08200     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08201                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
08202                  ThreadImpersonationToken,
08203                  (PVOID)&amp;NewToken,
08204                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08205                  );  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08206 
08207     NewToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a32">AnonymousToken</a>;
08208     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08209                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
08210                  ThreadImpersonationToken,
08211                  (PVOID)&amp;NewToken,
08212                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08213                  );  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08214 
08215     NewToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>;
08216     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08217                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
08218                  ThreadImpersonationToken,
08219                  (PVOID)&amp;NewToken,
08220                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08221                  );
08222 
08223     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
08224         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08225     } <span class="keywordflow">else</span> {
08226 
08227         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08228         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08229         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08230 
08231     }
08232 
08234     <span class="comment">//                                                        //</span>
08235     <span class="comment">// Impersonate a restricted token                         //</span>
08236     <span class="comment">//                                                        //</span>
08238 <span class="comment"></span>
08239 
08240     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Impersonate restricted token ...                      "</span>);
08241 
08242     NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08243     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08244                  NtCurrentThread(),
08245                  ThreadImpersonationToken,
08246                  (PVOID)&amp;NewToken,
08247                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08248                  );  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08249 
08250 
08251 
08252 
08253     <span class="comment">//</span>
08254     <span class="comment">// Initialize variables</span>
08255     <span class="comment">//</span>
08256 
08257     InitializeObjectAttributes(
08258         &amp;NewAttributes,
08259         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
08260         OBJ_INHERIT,
08261         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
08262         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
08263         );
08264 
08265 
08266     ImpersonationLevel.Length = (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
08267     ImpersonationLevel.ImpersonationLevel = SecurityImpersonation;
08268     ImpersonationLevel.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
08269     ImpersonationLevel.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08270     NewType = TokenImpersonation;
08271     NewAttributes.SecurityQualityOfService = &amp;ImpersonationLevel;
08272 
08273 
08274     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>(
08275                  <a class="code" href="../../d2/d1/cttoken_8c.html#a26">TokenWithRestrictedSids</a>, <span class="comment">// ExistingTokenHandle</span>
08276                  TOKEN_ALL_ACCESS,        <span class="comment">// DesiredAccess</span>
08277                  &amp;NewAttributes,          <span class="comment">// ObjectAttributes</span>
08278                  EffectiveOnly,           <span class="comment">// EffectiveOnly</span>
08279                  NewType,                 <span class="comment">// TokenType</span>
08280                  &amp;NewToken                <span class="comment">// NewTokenHandle</span>
08281                  );
08282 
08283     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
08284         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08285 
08286     } <span class="keywordflow">else</span> {
08287 
08288         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08289         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08290         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08291     }
08292 
08293     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08294                  NtCurrentThread(),
08295                  ThreadImpersonationToken,
08296                  (PVOID)&amp;NewToken,
08297                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08298                  );  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08299 
08300     <span class="comment">//</span>
08301     <span class="comment">// Now try to open something, like the process, which should fail</span>
08302     <span class="comment">//</span>
08303 
08304     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
08305                  NtCurrentProcess(),
08306                  TOKEN_QUERY | TOKEN_QUERY_SOURCE,
08307                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>
08308                  );
08309     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_ACCESS_DENIED) {
08310         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08311         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08312         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08313     }
08314 
08315     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
08316                  NtCurrentProcess(),
08317                  MAXIMUM_ALLOWED,
08318                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>
08319                  );
08320     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_ACCESS_DENIED) {
08321         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08322         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08323         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08324     }
08325 
08326     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>(
08327                  <a class="code" href="../../d2/d1/cttoken_8c.html#a27">TokenWithMoreRestrictedSids</a>, <span class="comment">// ExistingTokenHandle</span>
08328                  TOKEN_ALL_ACCESS,        <span class="comment">// DesiredAccess</span>
08329                  &amp;NewAttributes,          <span class="comment">// ObjectAttributes</span>
08330                  EffectiveOnly,           <span class="comment">// EffectiveOnly</span>
08331                  NewType,                 <span class="comment">// TokenType</span>
08332                  &amp;NewToken                <span class="comment">// NewTokenHandle</span>
08333                  );
08334 
08335     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
08336         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08337 
08338     } <span class="keywordflow">else</span> {
08339 
08340         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08341         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08342         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08343     }
08344 
08345     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08346                  NtCurrentThread(),
08347                  ThreadImpersonationToken,
08348                  (PVOID)&amp;NewToken,
08349                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08350                  );  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08351 
08352 
08353     <span class="comment">//</span>
08354     <span class="comment">// Now try to open something, like the process, which should succeed</span>
08355     <span class="comment">//</span>
08356 
08357     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
08358                  NtCurrentProcess(),
08359                  TOKEN_QUERY | TOKEN_QUERY_SOURCE,
08360                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>
08361                  );
08362     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
08363         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08364         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08365         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08366     }
08367 
08368     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
08369                  NtCurrentProcess(),
08370                  MAXIMUM_ALLOWED,
08371                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>
08372                  );
08373     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
08374         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08375         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08376         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08377     }
08378 
08379     NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08380     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
08381                  NtCurrentThread(),
08382                  ThreadImpersonationToken,
08383                  (PVOID)&amp;NewToken,
08384                  (ULONG)<span class="keyword">sizeof</span>(HANDLE)
08385                  );
08386 
08387     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
08388         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
08389     } <span class="keywordflow">else</span> {
08390 
08391         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
08392         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
08393         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08394 
08395     }
08396 
08397     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>(
08398                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
08399                  (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)0
08400                  );
08401 
08402     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
08403 
08404     <span class="keywordflow">return</span> CompletionStatus;
08405 }
08406 
08408 <span class="comment">//                                                            //</span>
08409 <span class="comment">// Main Program Entry                                         //</span>
08410 <span class="comment">//                                                            //</span>
08412 <span class="comment"></span>
08413 BOOLEAN
<a name="l08414"></a><a class="code" href="../../d2/d1/cttoken_8c.html#a77">08414</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a77">CTToken</a>()      <span class="comment">// Common Test for Token object</span>
08415 {
08416     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08417 
08418     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Initialization..."</span>);
08419     <a class="code" href="../../d6/d0/ctaccess_8c.html#a62">TestTokenInitialize</a>();
08420 
08421     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Token Creation Test...                                 Test"</span>);
08422     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a66">TestTokenCreate</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08423 
08424     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Token Filtering Test...                                Test"</span>);
08425     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a67">TestTokenFilter</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08426 
08427     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Token Open Test (with primary token)...                Test"</span>);
08428     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a68">TestTokenOpenPrimary</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08429 
08430     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Token Query Test...                                    Test"</span>);
08431     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a69">TestTokenQuery</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08432 
08433     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Token Set Test...                                      Test"</span>);
08434     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a70">TestTokenSet</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08435 
08436     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Token Adjust Privileges Test...                        Test"</span>);
08437     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a71">TestTokenAdjustPrivileges</a>()) {Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08438 
08439     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Token Adjust Group Test...                             Test"</span>);
08440     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a72">TestTokenAdjustGroups</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08441 
08442     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Token Duplication Test...                              Test"</span>);
08443     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a74">TestTokenDuplicate</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08444 
08445     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Primary Token Assignment Test...                       Test"</span>);
08446     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a75">TestTokenAssignPrimary</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08447 
08448     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Impersonation Test (and impersonation open)...         Test"</span>);
08449     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/cttoken_8c.html#a76">TestTokenImpersonation</a>()) { Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
08450 
08451 
08452     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
08453     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
08454     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    ********************\n"</span>);
08455     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    **                **\n"</span>);
08456     <span class="keywordflow">if</span> (Result) {
08457         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: ** Test Succeeded **\n"</span>);
08458     } <span class="keywordflow">else</span> {
08459         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: **  Test Failed   **\n"</span>);
08460     }
08461 
08462     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    **                **\n"</span>);
08463     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    ********************\n"</span>);
08464     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
08465     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
08466 
08467     <span class="keywordflow">return</span> Result;
08468 }
08469 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
