<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpmap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpmap.c</h1><a href="../../d2/d1/pnpmap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright (c) 1994 Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    pnpmap.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains the code that translates the device info returned from</span>
00013 <span class="comment">    the PnP BIOS into root enumerated devices.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Robert B. Nelson (RobertN) 22-Sep-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History :</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00028 <span class="preprocessor">#pragma hdrstop</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d0/d0/pnpcvrt_8h.html">pnpcvrt.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="../../d1/d4/pbios_8h.html">pbios.h</a>"</span>
00031 
00032 <span class="preprocessor">#if UMODETEST</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#undef IsNEC_98</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#define IsNEC_98 0</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'PpaM')</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 <span class="comment">//</span>
00043 <span class="comment">// Debugging stuff</span>
00044 <span class="comment">//</span>
00045 
00046 <span class="preprocessor">#if DBG</span>
00047 <span class="preprocessor"></span>
00048 <span class="preprocessor">#define MAPPER_ERROR       0x00000001</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_INFORMATION 0x00000002</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_PNP_ID      0x00000004</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_RESOURCES   0x00000008</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_REGISTRY    0x00000010</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#define MAPPER_VERBOSE     0x00008000</span>
00054 <span class="preprocessor"></span>
00055 ULONG PnPBiosMapperDebugMask =    MAPPER_ERROR       |
00056                                <span class="comment">// MAPPER_INFORMATION |</span>
00057                                <span class="comment">// MAPPER_REGISTRY    |</span>
00058                                <span class="comment">// MAPPER_PNP_ID      |</span>
00059                                <span class="comment">// MAPPER_RESOURCES   |</span>
00060                                <span class="comment">// MAPPER_VERBOSE     |</span>
00061                                0;
00062 
00063 <span class="preprocessor">#define DebugPrint(X) PnPBiosDebugPrint X</span>
00064 <span class="preprocessor"></span>
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 PnPBiosDebugPrint(
00067     ULONG  DebugMask,
00068     PCCHAR DebugMessage,
00069     ...
00070     );
00071 
00072 <span class="preprocessor">#else</span>
00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a0">00074</a> <span class="preprocessor">#define DebugPrint(X)</span>
00075 <span class="preprocessor"></span>
00076 <span class="preprocessor">#endif // DBG</span>
00077 <span class="preprocessor"></span>
00078 <span class="preprocessor">#if UMODETEST</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#define MULTIFUNCTION_KEY_NAME L"\\Registry\\Machine\\HARDWARE\\DESCRIPTION\\TestSystem\\MultifunctionAdapter"</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#define ENUMROOT_KEY_NAME L"\\Registry\\Machine\\System\\TestControlSet\\Enum\\Root"</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00082"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a1">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define MULTIFUNCTION_KEY_NAME L"\\Registry\\Machine\\HARDWARE\\DESCRIPTION\\System\\MultifunctionAdapter"</span>
<a name="l00083"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a2">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define ENUMROOT_KEY_NAME L"\\Registry\\Machine\\System\\CurrentControlSet\\Enum\\Root"</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00085 <span class="preprocessor"></span>
<a name="l00086"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a3">00086</a> <span class="preprocessor">#define BIOSINFO_KEY_NAME L"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Biosinfo\\PNPBios"</span>
<a name="l00087"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a4">00087</a> <span class="preprocessor"></span><span class="preprocessor">#define BIOSINFO_VALUE_NAME L"DisableNodes"</span>
<a name="l00088"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a5">00088</a> <span class="preprocessor"></span><span class="preprocessor">#define DECODEINFO_VALUE_NAME L"FullDecodeChipsetOverride"</span>
00089 <span class="preprocessor"></span>
<a name="l00090"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a6">00090</a> <span class="preprocessor">#define INSTANCE_ID_PREFIX      L"PnPBIOS_"</span>
00091 <span class="preprocessor"></span>
<a name="l00092"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a7">00092</a> <span class="preprocessor">#define DEFAULT_STRING_SIZE     80</span>
<a name="l00093"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a8">00093</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_VALUE_SIZE      80</span>
00094 <span class="preprocessor"></span>
<a name="l00095"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a9">00095</a> <span class="preprocessor">#define DEFAULT_DEVICE_DESCRIPTION  L"Unknown device class"</span>
00096 <span class="preprocessor"></span>
00097 
<a name="l00098"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a10">00098</a> <span class="preprocessor">#define EXCLUSION_ENTRY(a)  { a, sizeof(a) - sizeof(UNICODE_NULL) }</span>
00099 <span class="preprocessor"></span>
<a name="l00100"></a><a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html">00100</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span><a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html">_EXCLUDED_PNPNODE</a>  {
<a name="l00101"></a><a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html#o0">00101</a>     PWCHAR  <a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html#o0">Id</a>;
<a name="l00102"></a><a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html#o1">00102</a>     ULONG   <a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html#o1">IdLength</a>;
00103 } <a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html">EXCLUDED_PNPNODE</a>, *<a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html">PEXCLUDED_PNPNODE</a>;
00104 
<a name="l00105"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a18">00105</a> <a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html">EXCLUDED_PNPNODE</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a18">ExcludedDevices</a>[] =  {
00106     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP03"</span>),     <span class="comment">// Keyboards</span>
00107     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0A"</span>),     <span class="comment">// PCI Busses</span>
00108     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0E"</span>),     <span class="comment">// PCMCIA Busses</span>
00109     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0F"</span>),     <span class="comment">// Mice</span>
00110     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC13"</span>),     <span class="comment">// Keyboard for NEC98</span>
00111     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1E"</span>),     <span class="comment">// PCMCIA Busses for NEC98</span>
00112     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*nEC1F"</span>),     <span class="comment">// Mouse for NEC98</span>
00113     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*IBM3780"</span>),   <span class="comment">// IBM Trackpoint Mouse</span>
00114     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*IBM3781"</span>)    <span class="comment">// IBM Trackpoint Mouse</span>
00115 };
00116 
<a name="l00117"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a11">00117</a> <span class="preprocessor">#define EXCLUDED_DEVICES_COUNT  (sizeof(ExcludedDevices) / sizeof(ExcludedDevices[0]))</span>
00118 <span class="preprocessor"></span>
<a name="l00119"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a19">00119</a> <a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html">EXCLUDED_PNPNODE</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a19">ExcludeIfDisabled</a>[] = {
00120     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0C01"</span>),   <span class="comment">// Motherboard resources</span>
00121     <a class="code" href="../../d2/d1/pnpmap_8c.html#a10">EXCLUSION_ENTRY</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0C02"</span>)    <span class="comment">// Motherboard resources</span>
00122 };
00123 
<a name="l00124"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a12">00124</a> <span class="preprocessor">#define EXCLUDE_DISABLED_COUNT  (sizeof(ExcludeIfDisabled) / sizeof(ExcludeIfDisabled[0]))</span>
00125 <span class="preprocessor"></span>
<a name="l00126"></a><a class="code" href="../../d0/d0/struct__CLASSDATA.html">00126</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d0/struct__CLASSDATA.html">_CLASSDATA</a> {
<a name="l00127"></a><a class="code" href="../../d0/d0/struct__CLASSDATA.html#o0">00127</a>     ULONG   <a class="code" href="../../d0/d0/struct__CLASSDATA.html#o0">Value</a>;
<a name="l00128"></a><a class="code" href="../../d0/d0/struct__CLASSDATA.html#o1">00128</a>     PWCHAR  <a class="code" href="../../d0/d0/struct__CLASSDATA.html#o1">Description</a>;
00129 } <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a>;
00130 
<a name="l00131"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a21">00131</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a21">Class1Descriptions</a>[] = {
00132     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SCSI Controller"</span> },
00133     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IDE Controller"</span> },
00134     { 0x0200, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Floppy Controller"</span> },
00135     { 0x0300, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IPI Controller"</span> },
00136     { 0x0400, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RAID Controller"</span> },
00137     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other Mass Storage"</span> }
00138 };
00139 
<a name="l00140"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a22">00140</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a22">Class2Descriptions</a>[] = {
00141     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Ethernet"</span> },
00142     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Token ring"</span> },
00143     { 0x0200, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"FDDI"</span> },
00144     { 0x0300, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ATM"</span> },
00145     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other network"</span> }
00146 };
00147 
<a name="l00148"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a23">00148</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a23">Class3Descriptions</a>[] = {
00149     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VGA"</span> },
00150     { 0x0001, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SVGA"</span> },
00151     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"XGA"</span> },
00152     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other display"</span> }
00153 };
00154 
<a name="l00155"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a24">00155</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a24">Class4Descriptions</a>[] = {
00156     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Video device"</span> },
00157     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Audio device"</span> },
00158     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other multimedia"</span> }
00159 };
00160 
<a name="l00161"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a25">00161</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a25">Class5Descriptions</a>[] = {
00162     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RAM memory"</span> },
00163     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Flash memory"</span> },
00164     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other memory"</span> }
00165 };
00166 
<a name="l00167"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a26">00167</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a26">Class6Descriptions</a>[] = {
00168     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"HOST / PCI"</span> },
00169     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCI / ISA"</span> },
00170     { 0x0200, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCI / EISA"</span> },
00171     { 0x0300, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCI / MCA"</span> },
00172     { 0x0400, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCI / PCI"</span> },
00173     { 0x0500, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCI / PCMCIA"</span> },
00174     { 0x0600, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NuBus"</span> },
00175     { 0x0700, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Cardbus"</span> },
00176     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other bridge"</span> }
00177 };
00178 
<a name="l00179"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a27">00179</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a27">Class7Descriptions</a>[] = {
00180     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"XT Serial"</span> },
00181     { 0x0001, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"16450"</span> },
00182     { 0x0002, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"16550"</span> },
00183     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Parallel output only"</span> },
00184     { 0x0101, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"BiDi Parallel"</span> },
00185     { 0x0102, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ECP 1.x parallel"</span> },
00186     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other comm"</span> }
00187 };
00188 
<a name="l00189"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a28">00189</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a28">Class8Descriptions</a>[] = {
00190     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Generic 8259"</span> },
00191     { 0x0001, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ISA PIC"</span> },
00192     { 0x0002, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EISA PIC"</span> },
00193     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Generic 8237"</span> },
00194     { 0x0101, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ISA DMA"</span> },
00195     { 0x0102, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EISA DMA"</span> },
00196     { 0x0200, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Generic 8254"</span> },
00197     { 0x0201, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ISA timer"</span> },
00198     { 0x0202, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EISA timer"</span> },
00199     { 0x0300, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Generic RTC"</span> },
00200     { 0x0301, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ISA RTC"</span> },
00201     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other system device"</span> }
00202 };
00203 
<a name="l00204"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a29">00204</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a29">Class9Descriptions</a>[] = {
00205     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Keyboard"</span> },
00206     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Digitizer"</span> },
00207     { 0x0200, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Mouse"</span> },
00208     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other input"</span> }
00209 };
00210 
<a name="l00211"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a30">00211</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a30">Class10Descriptions</a>[] = {
00212     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Generic dock"</span> },
00213     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other dock"</span> },
00214 };
00215 
<a name="l00216"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a31">00216</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a31">Class11Descriptions</a>[] = {
00217     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"386"</span> },
00218     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"486"</span> },
00219     { 0x0200, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Pentium"</span> },
00220     { 0x1000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Alpha"</span> },
00221     { 0x4000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Co-processor"</span> }
00222 };
00223 
<a name="l00224"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a32">00224</a> <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a32">Class12Descriptions</a>[] = {
00225     { 0x0000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Firewire"</span> },
00226     { 0x0100, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Access bus"</span> },
00227     { 0x0200, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SSA"</span> },
00228     { 0x8000, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other serial bus"</span> }
00229 };
00230 
<a name="l00231"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a13">00231</a> <span class="preprocessor">#define CLASSLIST_ENTRY(a)   { a, sizeof(a) / sizeof(a[0]) }</span>
00232 <span class="preprocessor"></span>
<a name="l00233"></a><a class="code" href="../../d8/d9/struct__CLASS__DESCRIPTIONS__LIST.html">00233</a> <span class="keyword">struct </span><a class="code" href="../../d8/d9/struct__CLASS__DESCRIPTIONS__LIST.html">_CLASS_DESCRIPTIONS_LIST</a>  {
00234 
<a name="l00235"></a><a class="code" href="../../d8/d9/struct__CLASS__DESCRIPTIONS__LIST.html#o0">00235</a>     <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a> *<a class="code" href="../../d8/d9/struct__CLASS__DESCRIPTIONS__LIST.html#o0">Descriptions</a>;
<a name="l00236"></a><a class="code" href="../../d8/d9/struct__CLASS__DESCRIPTIONS__LIST.html#o1">00236</a>     ULONG      <a class="code" href="../../d8/d9/struct__CLASS__DESCRIPTIONS__LIST.html#o1">Count</a>;
00237 
00238 }   <a class="code" href="../../d2/d1/pnpmap_8c.html#a33">ClassDescriptionsList</a>[] =  {
00239     { <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0 },
00240     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class1Descriptions ),
00241     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class2Descriptions ),
00242     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class3Descriptions ),
00243     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class4Descriptions ),
00244     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class5Descriptions ),
00245     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class6Descriptions ),
00246     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class7Descriptions ),
00247     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class8Descriptions ),
00248     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class9Descriptions ),
00249     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class10Descriptions ),
00250     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class11Descriptions ),
00251     <a class="code" href="../../d2/d1/pnpmap_8c.html#a13">CLASSLIST_ENTRY</a>( Class12Descriptions )
00252 
00253 };
00254 
<a name="l00255"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a14">00255</a> <span class="preprocessor">#define CLASSLIST_COUNT  ( sizeof(ClassDescriptionsList) / sizeof(ClassDescriptionsList[0]) )</span>
00256 <span class="preprocessor"></span>
<a name="l00257"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html">00257</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html">_BIOS_DEVNODE_INFO</a>  {
<a name="l00258"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o0">00258</a>     WCHAR   <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o0">ProductId</a>[10];  <span class="comment">// '*' + 7 char ID + NUL + NUL for REG_MULTI_SZ</span>
<a name="l00259"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o1">00259</a>     UCHAR   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a29">Handle</a>;         <span class="comment">// BIOS Node # / Handle</span>
<a name="l00260"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o2">00260</a>     UCHAR   <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o2">TypeCode</a>[3];
<a name="l00261"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o3">00261</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o3">Attributes</a>;
<a name="l00262"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o4">00262</a>     PWSTR   <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o4">Replaces</a>;       <span class="comment">// Instance ID of Root enumerated device being replaced</span>
00263 
<a name="l00264"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o5">00264</a>     PCM_RESOURCE_LIST               <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o5">BootConfig</a>;
<a name="l00265"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o6">00265</a>     ULONG                           <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o6">BootConfigLength</a>;
<a name="l00266"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o7">00266</a>     PIO_RESOURCE_REQUIREMENTS_LIST  <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o7">BasicConfig</a>;
<a name="l00267"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o8">00267</a>     ULONG                           <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o8">BasicConfigLength</a>;
<a name="l00268"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o9">00268</a>     PWSTR                           <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o9">CompatibleIDs</a>;  <span class="comment">// REG_MULTI_SZ list of compatible IDs (including ProductId)</span>
<a name="l00269"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o10">00269</a>     ULONG                           <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o10">CompatibleIDsLength</a>;
<a name="l00270"></a><a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o11">00270</a>     BOOLEAN                         <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o11">FirmwareDisabled</a>; <span class="comment">// determined that it's disabled by firmware</span>
00271 
00272 }   <a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html">BIOS_DEVNODE_INFO</a>, *<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html">PBIOS_DEVNODE_INFO</a>;
00273 
00274 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00275 <a class="code" href="../../d2/d1/pnpmap_8c.html#a36">PbBiosResourcesToNtResources</a> (
00276     IN ULONG BusNumber,
00277     IN ULONG SlotNumber,
00278     IN OUT PUCHAR *BiosData,
00279     OUT PIO_RESOURCE_REQUIREMENTS_LIST *ReturnedList,
00280     OUT PULONG ReturnedLength
00281     );
00282 
00283 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00284 <a class="code" href="../../d2/d1/pnpmap_8c.html#a37">PnPBiosExpandProductId</a>(
00285     PUCHAR CompressedId,
00286     PWCHAR ProductIDStr
00287     );
00288 
00289 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00290 <a class="code" href="../../d2/d1/pnpmap_8c.html#a38">PnPBiosIoResourceListToCmResourceList</a>(
00291     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResourceList,
00292     OUT PCM_RESOURCE_LIST *CmResourceList,
00293     OUT ULONG *CmResourceListSize
00294     );
00295 
00296 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00297 <a class="code" href="../../d2/d1/pnpmap_8c.html#a39">PnPBiosExtractCompatibleIDs</a>(
00298     IN  PUCHAR *DevNodeData,
00299     IN  ULONG DevNodeDataLength,
00300     OUT PWSTR *CompatibleIDs,
00301     OUT ULONG *CompatibleIDsLength
00302     );
00303 
00304 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00305 <a class="code" href="../../d2/d1/pnpmap_8c.html#a40">PnPBiosTranslateInfo</a>(
00306     IN VOID *BiosInfo,
00307     IN ULONG BiosInfoLength,
00308     OUT PBIOS_DEVNODE_INFO *DevNodeInfoList,
00309     OUT ULONG *NumberNodes
00310     );
00311 
00312 LONG
00313 <a class="code" href="../../d2/d1/pnpmap_8c.html#a41">PnPBiosFindMatchingDevNode</a>(
00314     IN PWCHAR MapperName,
00315     IN PCM_RESOURCE_LIST ResourceList,
00316     IN PBIOS_DEVNODE_INFO DevNodeInfoList,
00317     IN ULONG NumberNodes
00318     );
00319 
00320 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00321 <a class="code" href="../../d2/d1/pnpmap_8c.html#a42">PnPBiosEliminateDupes</a>(
00322     IN PBIOS_DEVNODE_INFO DevNodeInfoList,
00323     IN ULONG NumberNodes
00324     );
00325 
00326 PWCHAR
00327 <a class="code" href="../../d2/d1/pnpmap_8c.html#a43">PnPBiosGetDescription</a>(
00328     IN PBIOS_DEVNODE_INFO DevNodeInfoEntry
00329     );
00330 
00331 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00332 <a class="code" href="../../d2/d1/pnpmap_8c.html#a44">PnPBiosWriteInfo</a>(
00333     IN PBIOS_DEVNODE_INFO DevNodeInfoList,
00334     IN ULONG NumberNodes
00335     );
00336 
00337 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00338 <a class="code" href="../../d2/d1/pnpmap_8c.html#a45">PnPBiosCopyIoDecode</a>(
00339     IN HANDLE EnumRootKey,
00340     IN PBIOS_DEVNODE_INFO DevNodeInfo
00341     );
00342 
00343 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00344 <a class="code" href="../../d2/d1/pnpmap_8c.html#a46">PnPBiosFreeDevNodeInfo</a>(
00345     IN PBIOS_DEVNODE_INFO DevNodeInfoList,
00346     IN ULONG NumberNodes
00347     );
00348 
00349 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00350 <a class="code" href="../../d2/d1/pnpmap_8c.html#a47">PnPBiosCheckForHardwareDisabled</a>(
00351     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResourceList,
00352     IN OUT PBOOLEAN Disabled
00353     );
00354 
00355 BOOLEAN
00356 <a class="code" href="../../d2/d1/pnpmap_8c.html#a56">PnPBiosCheckForExclusion</a>(
00357     IN PEXCLUDED_PNPNODE ExclusionArray,
00358     IN ULONG ExclusionCount,
00359     IN PWCHAR PnpDeviceName,
00360     IN PWCHAR PnpCompatIds
00361     );
00362 
00363 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00364 <a class="code" href="../../d2/d1/pnpmap_8c.html#a58">PnPBiosMapper</a>(
00365     VOID
00366     );
00367 
00368 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00369 <a class="code" href="../../d2/d1/pnpmap_8c.html#a50">PpFilterNtResource</a> (
00370     IN PWCHAR PnpDeviceName,
00371     PIO_RESOURCE_REQUIREMENTS_LIST ResReqList
00372     );
00373 
00374 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00375 <a class="code" href="../../d2/d1/pnpmap_8c.html#a51">ComPortDBAdd</a>(
00376     IN  HANDLE  DeviceParamKey,
00377     IN  PWSTR   PortName
00378     );
00379 
00380 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00381 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosExpandProductId)</span>
00382 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosIoResourceListToCmResourceList)</span>
00383 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosExtractCompatibleIDs)</span>
00384 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosTranslateInfo)</span>
00385 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosFindMatchingDevNode)</span>
00386 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosEliminateDupes)</span>
00387 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosGetDescription)</span>
00388 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosWriteInfo)</span>
00389 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosCopyIoDecode)</span>
00390 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosFreeDevNodeInfo)</span>
00391 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosCheckForHardwareDisabled)</span>
00392 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosCheckForExclusion)</span>
00393 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PnPBiosMapper)</span>
00394 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, PpFilterNtResource)</span>
00395 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PnPBiosGetBiosInfo)</span>
00396 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00397 <span class="preprocessor"></span>
00398 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00399"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a52">00399</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a52">PnPBiosGetBiosInfo</a>(
00400     OUT PVOID *BiosInfo,
00401     OUT ULONG *BiosInfoLength
00402     )
00403 <span class="comment">/*++</span>
00404 <span class="comment"></span>
00405 <span class="comment">Routine Description:</span>
00406 <span class="comment"></span>
00407 <span class="comment">    This function retrieves the PnP BIOS info accumulated by NTDETECT.COM and</span>
00408 <span class="comment">    placed in the registry.</span>
00409 <span class="comment"></span>
00410 <span class="comment">Arguments:</span>
00411 <span class="comment"></span>
00412 <span class="comment">    BiosInfo - Set to a dynamically allocated block of information retrieved</span>
00413 <span class="comment">        from the PnP BIOS by NTDETECT.  This block should be freed using</span>
00414 <span class="comment">        ExFreePool.  The contents of the block are the PnP BIOS</span>
00415 <span class="comment">        Installation Check Structure followed by the DevNode Structures reported</span>
00416 <span class="comment">        by the BIOS.  The detailed format is documented in the PnP BIOS spec.</span>
00417 <span class="comment"></span>
00418 <span class="comment">    BiosInfoLength - Length of the block whose address is stored in BiosInfo.</span>
00419 <span class="comment"></span>
00420 <span class="comment"></span>
00421 <span class="comment">Return Value:</span>
00422 <span class="comment"></span>
00423 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
00424 <span class="comment"></span>
00425 <span class="comment">--*/</span>
00426 {
00427     UNICODE_STRING                  multifunctionKeyName, biosKeyName, valueName;
00428     HANDLE                          multifunctionKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, biosKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00429     PKEY_BASIC_INFORMATION          keyBasicInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00430     ULONG                           keyBasicInfoLength;
00431     PKEY_VALUE_PARTIAL_INFORMATION  valueInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00432     ULONG                           valueInfoLength;
00433     ULONG                           returnedLength;
00434 
00435     PCM_FULL_RESOURCE_DESCRIPTOR    biosValue;
00436 
00437     ULONG                           index;
00438     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status = STATUS_UNSUCCESSFUL;
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// The PnP BIOS info is written to one of the subkeys under</span>
00442     <span class="comment">// MULTIFUNCTION_KEY_NAME.  The appropriate key is determined by</span>
00443     <span class="comment">// enumerating the subkeys and using the first one which has a value named</span>
00444     <span class="comment">// "Identifier" that is "PNP BIOS".</span>
00445     <span class="comment">//</span>
00446 
00447     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;multifunctionKeyName, <a class="code" href="../../d2/d1/pnpmap_8c.html#a1">MULTIFUNCTION_KEY_NAME</a>);
00448 
00449     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;multifunctionKey,
00450                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00451                                    &amp;multifunctionKeyName,
00452                                    KEY_READ
00453                                    );
00454 
00455     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00456 
00457         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
00458                     <span class="stringliteral">"Could not open %S, status = %8.8X\n"</span>,
00459                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a1">MULTIFUNCTION_KEY_NAME</a>,
00460                     status) );
00461 
00462         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00463     }
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">// Allocate memory for key names returned from ZwEnumerateKey and values</span>
00467     <span class="comment">// returned from ZwQueryValueKey.</span>
00468     <span class="comment">//</span>
00469     keyBasicInfoLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>;
00470     keyBasicInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, keyBasicInfoLength + <span class="keyword">sizeof</span>(UNICODE_NULL));
00471 
00472     <span class="keywordflow">if</span> (keyBasicInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00473 
00474         ZwClose( multifunctionKey );
00475 
00476         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00477     }
00478 
00479     valueInfoLength = <span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>;
00480     valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueInfoLength);
00481 
00482     <span class="keywordflow">if</span> (valueInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00483 
00484         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInfo );
00485 
00486         ZwClose( multifunctionKey );
00487 
00488         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00489     }
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// Enumerate each key under HKLM\HARDWARE\\DESCRIPTION\\System\\MultifunctionAdapter</span>
00493     <span class="comment">// to locate the one representing the PnP BIOS information.</span>
00494     <span class="comment">//</span>
00495     <span class="keywordflow">for</span> (index = 0; ; index++) {
00496 
00497         status = ZwEnumerateKey( multifunctionKey,   <span class="comment">// handle of key to enumerate</span>
00498                                  index,              <span class="comment">// index of subkey to enumerate</span>
00499                                  KeyBasicInformation,
00500                                  keyBasicInfo,
00501                                  keyBasicInfoLength,
00502                                  &amp;returnedLength);
00503 
00504         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00505 
00506             <span class="keywordflow">if</span> (status != STATUS_NO_MORE_ENTRIES)  {
00507 
00508                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
00509                             <span class="stringliteral">"Could not enumerate under key %S, status = %8.8X\n"</span>,
00510                             <a class="code" href="../../d2/d1/pnpmap_8c.html#a1">MULTIFUNCTION_KEY_NAME</a>,
00511                             status) );
00512             }
00513 
00514             <span class="keywordflow">break</span>;
00515         }
00516 
00517         <span class="comment">//</span>
00518         <span class="comment">// We found a subkey, NUL terminate the name and open the subkey.</span>
00519         <span class="comment">//</span>
00520         keyBasicInfo-&gt;Name[ keyBasicInfo-&gt;NameLength / 2 ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00521 
00522         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;biosKeyName, keyBasicInfo-&gt;Name);
00523 
00524         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;biosKey,
00525                                        multifunctionKey,
00526                                        &amp;biosKeyName,
00527                                        KEY_READ
00528                                        );
00529 
00530         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00531 
00532             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
00533                         <span class="stringliteral">"Could not open registry key %S\\%S, status = %8.8X\n"</span>,
00534                         <a class="code" href="../../d2/d1/pnpmap_8c.html#a1">MULTIFUNCTION_KEY_NAME</a>,
00535                         keyBasicInfo-&gt;Name,
00536                         status) );
00537             <span class="keywordflow">break</span>;
00538         }
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">// Now we need to check the Identifier value in the subkey to see if</span>
00542         <span class="comment">// it is PNP BIOS.</span>
00543         <span class="comment">//</span>
00544         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Identifier"</span>);
00545 
00546         status = ZwQueryValueKey( biosKey,
00547                                   &amp;valueName,
00548                                   KeyValuePartialInformation,
00549                                   valueInfo,
00550                                   valueInfoLength,
00551                                   &amp;returnedLength);
00552 
00553 
00554         <span class="comment">// lets see if its the PNP BIOS identifier</span>
00555         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00556 
00557             <span class="keywordflow">if</span> (wcscmp((PWSTR)valueInfo-&gt;Data, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PNP BIOS"</span>) == 0) {
00558 
00559                 <span class="comment">//</span>
00560                 <span class="comment">// We found the PnP BIOS subkey, retrieve the BIOS info which</span>
00561                 <span class="comment">// is stored in the "Configuration Data" value.</span>
00562                 <span class="comment">//</span>
00563                 <span class="comment">// We'll start off with our default value buffer and increase</span>
00564                 <span class="comment">// its size if necessary.</span>
00565                 <span class="comment">//</span>
00566 
00567                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Configuration Data"</span>);
00568 
00569                 status = ZwQueryValueKey( biosKey,
00570                                           &amp;valueName,
00571                                           KeyValuePartialInformation,
00572                                           valueInfo,
00573                                           valueInfoLength,
00574                                           &amp;returnedLength);
00575 
00576                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00577 
00578                     <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL || status == STATUS_BUFFER_OVERFLOW) {
00579 
00580                         <span class="comment">//</span>
00581                         <span class="comment">// The default buffer was too small, free it and reallocate</span>
00582                         <span class="comment">// it to the required size.</span>
00583                         <span class="comment">//</span>
00584                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueInfo );
00585 
00586                         valueInfoLength = returnedLength;
00587                         valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueInfoLength );
00588 
00589                         <span class="keywordflow">if</span> (valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00590 
00591                             status = ZwQueryValueKey( biosKey,
00592                                                       &amp;valueName,
00593                                                       KeyValuePartialInformation,
00594                                                       valueInfo,
00595                                                       valueInfoLength,
00596                                                       &amp;returnedLength );
00597                         } <span class="keywordflow">else</span> {
00598 
00599                             status = STATUS_NO_MEMORY;
00600                         }
00601                     }
00602                 }
00603 
00604                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00605 
00606                     <span class="comment">//</span>
00607                     <span class="comment">// We now have the PnP BIOS data but it is buried inside</span>
00608                     <span class="comment">// the resource structures.  Do some consistency checks and</span>
00609                     <span class="comment">// then extract it into its own buffer.</span>
00610                     <span class="comment">//</span>
00611 
00612                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(valueInfo-&gt;Type == REG_FULL_RESOURCE_DESCRIPTOR);
00613 
00614                     biosValue = (PCM_FULL_RESOURCE_DESCRIPTOR)valueInfo-&gt;Data;
00615 
00616                     <span class="comment">//</span>
00617                     <span class="comment">// BUGBUG - The WMI folks added another list so we should</span>
00618                     <span class="comment">// search for the PnPBIOS one, but for now the BIOS one is</span>
00619                     <span class="comment">// always first.</span>
00620                     <span class="comment">//</span>
00621                     <span class="comment">//ASSERT(biosValue-&gt;PartialResourceList.Count == 1);</span>
00622 
00623                     *BiosInfoLength = biosValue-&gt;PartialResourceList.PartialDescriptors[0].u.DeviceSpecificData.DataSize;
00624                     *BiosInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, *BiosInfoLength);
00625 
00626                     <span class="keywordflow">if</span> (*BiosInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00627 
00628                         RtlCopyMemory( *BiosInfo,
00629                                        &amp;biosValue-&gt;PartialResourceList.PartialDescriptors[1],
00630                                        *BiosInfoLength );
00631 
00632                         status = STATUS_SUCCESS;
00633 
00634                     } <span class="keywordflow">else</span> {
00635 
00636                         *BiosInfoLength = 0;
00637 
00638                         status = STATUS_NO_MEMORY;
00639                     }
00640 
00641                 } <span class="keywordflow">else</span> {
00642 
00643                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
00644                                 <span class="stringliteral">"Error retrieving %S\\%S\\Configuration Data, status = %8.8X\n"</span>,
00645                                 <a class="code" href="../../d2/d1/pnpmap_8c.html#a1">MULTIFUNCTION_KEY_NAME</a>,
00646                                 keyBasicInfo-&gt;Name,
00647                                 status) );
00648                 }
00649 
00650                 <span class="comment">//</span>
00651                 <span class="comment">// We found the PnP BIOS entry, so close the key handle and</span>
00652                 <span class="comment">// return.</span>
00653                 <span class="comment">//</span>
00654 
00655                 ZwClose(biosKey);
00656 
00657                 <span class="keywordflow">break</span>;
00658             }
00659         }
00660 
00661         <span class="comment">//</span>
00662         <span class="comment">// That wasn't it so close this handle and try the next subkey.</span>
00663         <span class="comment">//</span>
00664         ZwClose(biosKey);
00665     }
00666 
00667     <span class="comment">//</span>
00668     <span class="comment">// Cleanup the dynamically allocated temporary buffers.</span>
00669     <span class="comment">//</span>
00670 
00671     <span class="keywordflow">if</span> (valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00672 
00673         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(valueInfo);
00674     }
00675 
00676     <span class="keywordflow">if</span> (keyBasicInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00677 
00678         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyBasicInfo);
00679     }
00680 
00681     ZwClose(multifunctionKey);
00682 
00683     <span class="keywordflow">return</span> status;
00684 }
00685 
00686 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00687"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a37">00687</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a37">PnPBiosExpandProductId</a>(
00688     PUCHAR CompressedId,
00689     PWCHAR ProductIDStr
00690     )
00691 <span class="comment">/*++</span>
00692 <span class="comment"></span>
00693 <span class="comment">Routine Description:</span>
00694 <span class="comment"></span>
00695 <span class="comment">    This function expands a PnP Device ID from the 4 byte compressed form into</span>
00696 <span class="comment">    an 7 character unicode string.  The string is then NUL terminated.</span>
00697 <span class="comment"></span>
00698 <span class="comment">Arguments:</span>
00699 <span class="comment"></span>
00700 <span class="comment">    CompressedId - Pointer to the 4 byte compressed Device ID as defined in the</span>
00701 <span class="comment">        PnP Specification.</span>
00702 <span class="comment"></span>
00703 <span class="comment">    ProductIDStr - Pointer to the 16 byte buffer in which the unicode string</span>
00704 <span class="comment">        version of the ID is placed.</span>
00705 <span class="comment"></span>
00706 <span class="comment"></span>
00707 <span class="comment">Return Value:</span>
00708 <span class="comment"></span>
00709 <span class="comment">    NONE.</span>
00710 <span class="comment"></span>
00711 <span class="comment">--*/</span>
00712 {
00713     <span class="keyword">static</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> HexDigits[16] = <span class="stringliteral">"0123456789ABCDEF"</span>;
00714 
00715     ProductIDStr[0] = (CompressedId[0] &gt;&gt; 2) + 0x40;
00716     ProductIDStr[1] = (((CompressedId[0] &amp; 0x03) &lt;&lt; 3) | (CompressedId[1] &gt;&gt; 5)) + 0x40;
00717     ProductIDStr[2] = (CompressedId[1] &amp; 0x1f) + 0x40;
00718     ProductIDStr[3] = HexDigits[CompressedId[2] &gt;&gt; 4];
00719     ProductIDStr[4] = HexDigits[CompressedId[2] &amp; 0x0F];
00720     ProductIDStr[5] = HexDigits[CompressedId[3] &gt;&gt; 4];
00721     ProductIDStr[6] = HexDigits[CompressedId[3] &amp; 0x0F];
00722     ProductIDStr[7] = 0x00;
00723 }
00724 
00725 BOOLEAN
<a name="l00726"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a53">00726</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a53">PnPBiosIgnoreNode</a> (
00727     PWCHAR PnpID,
00728     PWCHAR excludeNodes
00729     )
00730 {
00731     BOOLEAN bRet=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00732     ULONG   keyLen;
00733     PWCHAR  pTmp;
00734 
00735     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (excludeNodes);
00736 
00737     <span class="comment">//</span>
00738     <span class="comment">//excludeNodes is multi-sz, so walk through each one and check it.</span>
00739     <span class="comment">//</span>
00740     pTmp=excludeNodes;
00741 
00742     <span class="keywordflow">while</span> (*pTmp != <span class="charliteral">'\0'</span>) {
00743 
00744         keyLen = wcslen (pTmp);
00745 
00746         <span class="keywordflow">if</span> (RtlCompareMemory (PnpID,pTmp,keyLen*<span class="keyword">sizeof</span> (WCHAR)) == keyLen*<span class="keyword">sizeof</span> (WCHAR)) {
00747             bRet=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00748             <span class="keywordflow">break</span>;
00749         }
00750         pTmp=pTmp+keyLen+1;
00751 
00752     }
00753 
00754 
00755     <span class="keywordflow">return</span> bRet;
00756 }
00757 
00758 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00759"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a54">00759</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a54">PnPGetDevnodeExcludeList</a> (
00760     OUT  PKEY_VALUE_FULL_INFORMATION  *ExcludeList
00761     )
00762 {
00763     UNICODE_STRING biosKeyName;
00764     HANDLE  biosKey;
00765     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00766 
00767     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;biosKeyName, <a class="code" href="../../d2/d1/pnpmap_8c.html#a3">BIOSINFO_KEY_NAME</a>);
00768     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;biosKey,
00769                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00770                                    &amp;biosKeyName,
00771                                    KEY_READ
00772                                    );
00773 
00774     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00775 
00776         <span class="comment">//</span>
00777         <span class="comment">// Don't really need to complain, likely not there.</span>
00778         <span class="comment">//</span>
00779         <span class="keywordflow">return</span>;
00780     }
00781 
00782     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (biosKey,<a class="code" href="../../d2/d1/pnpmap_8c.html#a4">BIOSINFO_VALUE_NAME</a>,ExcludeList);
00783 
00784     ZwClose (biosKey);
00785 }
00786 
00787 BOOLEAN
<a name="l00788"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a55">00788</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a55">PnPCheckFixedIoOverrideDecodes</a>(
00789     VOID
00790     )
00791 {
00792     PKEY_VALUE_FULL_INFORMATION decodeFlagInfo=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00793     UNICODE_STRING biosKeyName;
00794     HANDLE  biosKey;
00795     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00796     BOOLEAN overrideDecodes = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00797 
00798     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;biosKeyName, <a class="code" href="../../d2/d1/pnpmap_8c.html#a3">BIOSINFO_KEY_NAME</a>);
00799     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;biosKey,
00800                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00801                                    &amp;biosKeyName,
00802                                    KEY_READ
00803                                    );
00804 
00805     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00806 
00807         <span class="comment">//</span>
00808         <span class="comment">// Don't really need to complain, likely not there.</span>
00809         <span class="comment">//</span>
00810         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00811     }
00812 
00813     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(biosKey, <a class="code" href="../../d2/d1/pnpmap_8c.html#a5">DECODEINFO_VALUE_NAME</a>, &amp;decodeFlagInfo);
00814 
00815     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00816 
00817         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(decodeFlagInfo-&gt;Type == REG_DWORD);
00818         <span class="keywordflow">if</span> (decodeFlagInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
00819 
00820             overrideDecodes = (BOOLEAN) *((PULONG) decodeFlagInfo-&gt;Name);
00821         }
00822     }
00823 
00824     <span class="keywordflow">if</span> (decodeFlagInfo) {
00825 
00826         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(decodeFlagInfo);
00827     }
00828 
00829     ZwClose (biosKey);
00830 
00831     <span class="keywordflow">return</span> overrideDecodes;
00832 }
00833 
00834 BOOLEAN
<a name="l00835"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a56">00835</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a56">PnPBiosCheckForExclusion</a>(
00836     IN <a class="code" href="../../d5/d8/struct__EXCLUDED__PNPNODE.html">EXCLUDED_PNPNODE</a> *Exclusions,
00837     IN ULONG  ExclusionCount,
00838     IN PWCHAR PnpDeviceName,
00839     IN PWCHAR PnpCompatIds
00840     )
00841 {
00842     PWCHAR idPtr;
00843     ULONG exclusionIndex;
00844 
00845     <span class="keywordflow">for</span> (exclusionIndex = 0; exclusionIndex &lt; ExclusionCount; exclusionIndex++) {
00846 
00847         idPtr = PnpDeviceName;
00848 
00849         <span class="keywordflow">if</span> (RtlCompareMemory( idPtr,
00850                               Exclusions[ exclusionIndex ].Id,
00851                               Exclusions[ exclusionIndex ].IdLength) != Exclusions[ exclusionIndex ].IdLength )  {
00852 
00853             idPtr = PnpCompatIds;
00854 
00855             <span class="keywordflow">if</span> (idPtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00856 
00857                 <span class="keywordflow">while</span> (*idPtr != <span class="charliteral">'\0'</span>) {
00858 
00859                     <span class="keywordflow">if</span> (RtlCompareMemory( idPtr,
00860                                           Exclusions[ exclusionIndex ].Id,
00861                                           Exclusions[ exclusionIndex ].IdLength) == Exclusions[ exclusionIndex ].IdLength )  {
00862 
00863                         <span class="keywordflow">break</span>;
00864                     }
00865 
00866                     idPtr += 9;
00867                 }
00868 
00869                 <span class="keywordflow">if</span> (*idPtr == <span class="charliteral">'\0'</span>) {
00870 
00871                     idPtr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00872                 }
00873             }
00874         }
00875 
00876         <span class="keywordflow">if</span> (idPtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00877 
00878             <span class="keywordflow">break</span>;
00879         }
00880     }
00881 
00882     <span class="keywordflow">if</span> (exclusionIndex &lt; ExclusionCount) {
00883         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00884     }
00885 
00886     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00887 }
00888 
00889 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00890"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a38">00890</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a38">PnPBiosIoResourceListToCmResourceList</a>(
00891     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResourceList,
00892     OUT PCM_RESOURCE_LIST *CmResourceList,
00893     OUT ULONG *CmResourceListSize
00894     )
00895 <span class="comment">/*++</span>
00896 <span class="comment"></span>
00897 <span class="comment">Routine Description:</span>
00898 <span class="comment"></span>
00899 <span class="comment">    Converts an IO_RESOURCE_REQUIREMENTS_LIST into a CM_RESOURCE_LIST.  This</span>
00900 <span class="comment">    routine is used to convert the list of resources currently being used by a</span>
00901 <span class="comment">    device into a form suitable for writing to the BootConfig registry value.</span>
00902 <span class="comment"></span>
00903 <span class="comment">Arguments:</span>
00904 <span class="comment"></span>
00905 <span class="comment">    IoResourceList - Pointer to the input list.</span>
00906 <span class="comment"></span>
00907 <span class="comment">    CmResourceList - Pointer to a PCM_RESOURCE_LIST which is set to the</span>
00908 <span class="comment">        dynamically allocated and filled in using the data from IoResourceList.</span>
00909 <span class="comment"></span>
00910 <span class="comment">    CmResourceListSize - Pointer to a variable which is set to the size in bytes</span>
00911 <span class="comment">        of the dynamically allocated *CmResourceList.</span>
00912 <span class="comment"></span>
00913 <span class="comment">Return Value:</span>
00914 <span class="comment"></span>
00915 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
00916 <span class="comment"></span>
00917 <span class="comment">--*/</span>
00918 {
00919     PCM_PARTIAL_RESOURCE_LIST       partialList;
00920     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
00921     PIO_RESOURCE_DESCRIPTOR         ioDescriptor;
00922     ULONG                           descIndex;
00923 
00924     <span class="comment">//</span>
00925     <span class="comment">// Since this routine is only used to translate the allocated resources</span>
00926     <span class="comment">// returned by the PnP BIOS, we can assume that there is only 1 alternative</span>
00927     <span class="comment">// list</span>
00928     <span class="comment">//</span>
00929 
00930     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoResourceList-&gt;AlternativeLists == 1);
00931 
00932     <span class="comment">//</span>
00933     <span class="comment">// Calculate the size of the translated list and allocate memory for it.</span>
00934     <span class="comment">//</span>
00935     *CmResourceListSize = <span class="keyword">sizeof</span>(CM_RESOURCE_LIST) +
00936                           (IoResourceList-&gt;AlternativeLists - 1) * <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR) +
00937                           (IoResourceList-&gt;List[0].Count - 1) * <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
00938 
00939     *CmResourceList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, *CmResourceListSize );
00940 
00941     <span class="keywordflow">if</span> (*CmResourceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00942 
00943         *CmResourceListSize = 0;
00944 
00945         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00946     }
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">// Copy the header info from the requirements list to the resource list.</span>
00950     <span class="comment">//</span>
00951     (*CmResourceList)-&gt;Count = 1;
00952 
00953     (*CmResourceList)-&gt;List[ 0 ].InterfaceType = IoResourceList-&gt;InterfaceType;
00954     (*CmResourceList)-&gt;List[ 0 ].BusNumber = IoResourceList-&gt;BusNumber;
00955 
00956     partialList = &amp;(*CmResourceList)-&gt;List[ 0 ].PartialResourceList;
00957 
00958     partialList-&gt;Version = IoResourceList-&gt;List[ 0 ].Version;
00959     partialList-&gt;Revision = IoResourceList-&gt;List[ 0 ].Revision;
00960     partialList-&gt;Count = 0;
00961 
00962     <span class="comment">//</span>
00963     <span class="comment">// Translate each resource descriptor, currently we only handle ports,</span>
00964     <span class="comment">// memory, interrupts, and dma.  The current implementation of the routine</span>
00965     <span class="comment">// which converts from ISA PnP Resource data to IO_RESOURCE_REQUIREMENTS</span>
00966     <span class="comment">// won't generate any other descriptor types given the data returned from</span>
00967     <span class="comment">// the BIOS.</span>
00968     <span class="comment">//</span>
00969 
00970     partialDescriptor = &amp;partialList-&gt;PartialDescriptors[ 0 ];
00971     <span class="keywordflow">for</span> (descIndex = 0; descIndex &lt; IoResourceList-&gt;List[ 0 ].Count; descIndex++) {
00972 
00973         ioDescriptor = &amp;IoResourceList-&gt;List[ 0 ].Descriptors[ descIndex ];
00974 
00975         <span class="keywordflow">switch</span> (ioDescriptor-&gt;Type) {
00976 
00977         <span class="keywordflow">case</span> CmResourceTypePort:
00978             partialDescriptor-&gt;u.Port.Start = ioDescriptor-&gt;u.Port.MinimumAddress;
00979             partialDescriptor-&gt;u.Port.Length = ioDescriptor-&gt;u.Port.Length;
00980             <span class="keywordflow">break</span>;
00981 
00982         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00983             <span class="keywordflow">if</span> (ioDescriptor-&gt;u.Interrupt.MinimumVector == (ULONG)(IsNEC_98 ? 7 : 2) ) {
00984                 *CmResourceListSize -= <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
00985                 <span class="keywordflow">continue</span>;
00986             }
00987             partialDescriptor-&gt;u.Interrupt.Level = ioDescriptor-&gt;u.Interrupt.MinimumVector;
00988             partialDescriptor-&gt;u.Interrupt.Vector = ioDescriptor-&gt;u.Interrupt.MinimumVector;
00989             partialDescriptor-&gt;u.Interrupt.Affinity = ~0;
00990             <span class="keywordflow">break</span>;
00991 
00992         <span class="keywordflow">case</span> CmResourceTypeMemory:
00993             partialDescriptor-&gt;u.Memory.Start = ioDescriptor-&gt;u.Memory.MinimumAddress;
00994             partialDescriptor-&gt;u.Memory.Length = ioDescriptor-&gt;u.Memory.Length;
00995             <span class="keywordflow">break</span>;
00996 
00997         <span class="keywordflow">case</span> CmResourceTypeDma:
00998             partialDescriptor-&gt;u.Dma.Channel = ioDescriptor-&gt;u.Dma.MinimumChannel;
00999             partialDescriptor-&gt;u.Dma.Port = 0;
01000             partialDescriptor-&gt;u.Dma.Reserved1 = 0;
01001             <span class="keywordflow">break</span>;
01002 
01003         <span class="keywordflow">default</span>:
01004             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01005                         <span class="stringliteral">"Unexpected ResourceType (%d) in I/O Descriptor\n"</span>,
01006                         ioDescriptor-&gt;Type) );
01007 
01008 <span class="preprocessor">#if DBG</span>
01009 <span class="preprocessor"></span>            <span class="comment">// DbgBreakPoint();</span>
01010 <span class="preprocessor">#endif</span>
01011 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
01012         }
01013 
01014         partialDescriptor-&gt;Type = ioDescriptor-&gt;Type;
01015         partialDescriptor-&gt;ShareDisposition = ioDescriptor-&gt;ShareDisposition;
01016         partialDescriptor-&gt;Flags = ioDescriptor-&gt;Flags;
01017         partialDescriptor++;
01018 
01019         partialList-&gt;Count++;
01020     }
01021 
01022     <span class="keywordflow">return</span> STATUS_SUCCESS;
01023 }
01024 
01025 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01026"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a39">01026</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a39">PnPBiosExtractCompatibleIDs</a>(
01027     IN  PUCHAR *DevNodeData,
01028     IN  ULONG DevNodeDataLength,
01029     OUT PWSTR *CompatibleIDs,
01030     OUT ULONG *CompatibleIDsLength
01031     )
01032 {
01033     PWCHAR  idPtr;
01034     PUCHAR  currentPtr, endPtr;
01035     UCHAR   tagName;
01036     ULONG   increment;
01037     ULONG   compatibleCount;
01038 
01039     endPtr = &amp;(*DevNodeData)[DevNodeDataLength];
01040 
01041     compatibleCount = 0;
01042 
01043     <span class="keywordflow">for</span> (currentPtr = *DevNodeData; currentPtr &lt; endPtr; currentPtr += increment) {
01044 
01045         tagName = *currentPtr;
01046 
01047         <span class="keywordflow">if</span> (tagName == <a class="code" href="../../d1/d4/pbios_8h.html#a22">TAG_COMPLETE_END</a>)  {
01048 
01049             <span class="keywordflow">break</span>;
01050         }
01051 
01052         <span class="comment">//</span>
01053         <span class="comment">// Determine the size of the BIOS resource descriptor</span>
01054         <span class="comment">//</span>
01055 
01056         <span class="keywordflow">if</span> (!(tagName &amp; <a class="code" href="../../d1/d4/pbios_8h.html#a1">LARGE_RESOURCE_TAG</a>)) {
01057             increment = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(tagName &amp; <a class="code" href="../../d1/d4/pbios_8h.html#a3">SMALL_TAG_SIZE_MASK</a>);
01058             increment++;     <span class="comment">// length of small tag</span>
01059             tagName &amp;= <a class="code" href="../../d1/d4/pbios_8h.html#a2">SMALL_TAG_MASK</a>;
01060         } <span class="keywordflow">else</span> {
01061             increment = *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> UNALIGNED *)(&amp;currentPtr[1]);
01062             increment += 3;     <span class="comment">// length of large tag</span>
01063         }
01064 
01065         <span class="keywordflow">if</span> (tagName == <a class="code" href="../../d1/d4/pbios_8h.html#a6">TAG_COMPATIBLE_ID</a>) {
01066 
01067             compatibleCount++;
01068         }
01069     }
01070 
01071     <span class="keywordflow">if</span> (compatibleCount == 0) {
01072         *CompatibleIDs = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01073         *CompatibleIDsLength = 0;
01074 
01075         <span class="keywordflow">return</span> STATUS_SUCCESS;
01076     }
01077 
01078     *CompatibleIDsLength = (compatibleCount * 9 + 1) * <span class="keyword">sizeof</span>(WCHAR);
01079     *CompatibleIDs = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, *CompatibleIDsLength);
01080 
01081     <span class="keywordflow">if</span> (*CompatibleIDs == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
01082 
01083         *CompatibleIDsLength = 0;
01084         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01085     }
01086 
01087     idPtr = *CompatibleIDs;
01088 
01089     <span class="keywordflow">for</span> (currentPtr = *DevNodeData; currentPtr &lt; endPtr; currentPtr += increment) {
01090 
01091         tagName = *currentPtr;
01092 
01093         <span class="keywordflow">if</span> (tagName == <a class="code" href="../../d1/d4/pbios_8h.html#a22">TAG_COMPLETE_END</a>)  {
01094 
01095             <span class="keywordflow">break</span>;
01096         }
01097 
01098         <span class="comment">//</span>
01099         <span class="comment">// Determine the size of the BIOS resource descriptor</span>
01100         <span class="comment">//</span>
01101 
01102         <span class="keywordflow">if</span> (!(tagName &amp; <a class="code" href="../../d1/d4/pbios_8h.html#a1">LARGE_RESOURCE_TAG</a>)) {
01103             increment = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(tagName &amp; <a class="code" href="../../d1/d4/pbios_8h.html#a3">SMALL_TAG_SIZE_MASK</a>);
01104             increment++;     <span class="comment">// length of small tag</span>
01105             tagName &amp;= <a class="code" href="../../d1/d4/pbios_8h.html#a2">SMALL_TAG_MASK</a>;
01106         } <span class="keywordflow">else</span> {
01107             increment = *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> UNALIGNED *)(&amp;currentPtr[1]);
01108             increment += 3;     <span class="comment">// length of large tag</span>
01109         }
01110 
01111         <span class="keywordflow">if</span> (tagName == <a class="code" href="../../d1/d4/pbios_8h.html#a6">TAG_COMPATIBLE_ID</a>) {
01112 
01113             *idPtr = <span class="charliteral">'*'</span>;
01114             <a class="code" href="../../d2/d1/pnpmap_8c.html#a37">PnPBiosExpandProductId</a>(&amp;currentPtr[1], &amp;idPtr[1]);
01115             idPtr += 9;
01116         }
01117     }
01118 
01119     *idPtr++ = <span class="charliteral">'\0'</span>;  <span class="comment">// Extra NUL for REG_MULTI_SZ</span>
01120     *CompatibleIDsLength = (ULONG)(idPtr - *CompatibleIDs) * <span class="keyword">sizeof</span>(WCHAR);
01121 
01122     <span class="keywordflow">return</span> STATUS_SUCCESS;
01123 }
01124 
01125 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01126"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a40">01126</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a40">PnPBiosTranslateInfo</a>(
01127     IN VOID *BiosInfo,
01128     IN ULONG BiosInfoLength,
01129     OUT PBIOS_DEVNODE_INFO *DevNodeInfoList,
01130     OUT ULONG *NumberNodes
01131     )
01132 <span class="comment">/*++</span>
01133 <span class="comment"></span>
01134 <span class="comment">Routine Description:</span>
01135 <span class="comment"></span>
01136 <span class="comment">    Translates the devnode info retrieved from the BIOS.</span>
01137 <span class="comment"></span>
01138 <span class="comment">Arguments:</span>
01139 <span class="comment"></span>
01140 <span class="comment">    BiosInfo - The PnP BIOS Installation Check Structure followed by the</span>
01141 <span class="comment">        DevNode Structures reported by the BIOS.  The detailed format is</span>
01142 <span class="comment">        documented in the PnP BIOS spec.</span>
01143 <span class="comment"></span>
01144 <span class="comment">    BiosInfoLength - Length in bytes of the block whose address is stored in</span>
01145 <span class="comment">        BiosInfo.</span>
01146 <span class="comment"></span>
01147 <span class="comment">    DevNodeInfoList - Dynamically allocated array of BIOS_DEVNODE_INFO</span>
01148 <span class="comment">        structures, one for each device reported by the BIOS.  The information</span>
01149 <span class="comment">        supplied by the BIOS: device ID, type, current resources, and supported</span>
01150 <span class="comment">        configurations is converted into a more useful format.  For example the</span>
01151 <span class="comment">        current resource allocation is converted from ISA PnP descriptors into</span>
01152 <span class="comment">        an IO_RESOURCE_REQUIREMENTS_LIST and then into a CM_RESOURCE_LIST for</span>
01153 <span class="comment">        storing into the BootConfig registry value.</span>
01154 <span class="comment"></span>
01155 <span class="comment">    NumberNodes - Number of BIOS_DEVNODE_INFO elements pointed to by</span>
01156 <span class="comment">        DevNodeInfoList.</span>
01157 <span class="comment"></span>
01158 <span class="comment">Return Value:</span>
01159 <span class="comment"></span>
01160 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
01161 <span class="comment"></span>
01162 <span class="comment">--*/</span>
01163 {
01164     PCM_PNP_BIOS_INSTALLATION_CHECK biosInstallCheck;
01165     PCM_PNP_BIOS_DEVICE_NODE        devNodeHeader;
01166     <a class="code" href="../../d2/d1/pnpmap_8c.html#a35">PBIOS_DEVNODE_INFO</a>              devNodeInfo;
01167     PKEY_VALUE_FULL_INFORMATION     excludeList=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168 
01169     PIO_RESOURCE_REQUIREMENTS_LIST  tempResReqList;
01170 
01171     PUCHAR                          currentPtr;
01172     LONG                            lengthRemaining;
01173 
01174     LONG                            remainingNodeLength;
01175 
01176     ULONG                           numNodes;
01177     ULONG                           nodeIndex;
01178     PUCHAR                          configPtr;
01179     ULONG                           configListLength;
01180     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
01181     ULONG                           convertFlags = 0;
01182 
01183     <span class="comment">//</span>
01184     <span class="comment">// Make sure the data is at least large enough to hold the BIOS Installation</span>
01185     <span class="comment">// Check structure and check that the PnP signature is correct.</span>
01186     <span class="comment">//</span>
01187     <span class="keywordflow">if</span> (BiosInfoLength &lt; <span class="keyword">sizeof</span>(CM_PNP_BIOS_INSTALLATION_CHECK)) {
01188 
01189         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01190                     <span class="stringliteral">"BiosInfoLength (%d) is smaller than sizeof(PNPBIOS_INSTALLATION_CHECK) (%d)\n"</span>,
01191                     BiosInfoLength,
01192                     <span class="keyword">sizeof</span>(CM_PNP_BIOS_INSTALLATION_CHECK)) );
01193 
01194         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01195     }
01196 
01197     biosInstallCheck = (PCM_PNP_BIOS_INSTALLATION_CHECK)BiosInfo;
01198 
01199     <span class="keywordflow">if</span> (biosInstallCheck-&gt;Signature[0] != <span class="charliteral">'$'</span> ||
01200         biosInstallCheck-&gt;Signature[1] != <span class="charliteral">'P'</span> ||
01201         biosInstallCheck-&gt;Signature[2] != <span class="charliteral">'n'</span> ||
01202         biosInstallCheck-&gt;Signature[3] != <span class="charliteral">'P'</span>) {
01203 
01204         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01205     }
01206 
01207     <span class="comment">//</span>
01208     <span class="comment">// First scan the data and count the devnodes to determine the size of our</span>
01209     <span class="comment">// allocated data structures.</span>
01210     <span class="comment">//</span>
01211     currentPtr = (PUCHAR)BiosInfo + biosInstallCheck-&gt;Length;
01212     lengthRemaining = BiosInfoLength - biosInstallCheck-&gt;Length;
01213 
01214     <span class="keywordflow">for</span> (numNodes = 0; lengthRemaining &gt; <span class="keyword">sizeof</span>(CM_PNP_BIOS_DEVICE_NODE); numNodes++) {
01215 
01216         devNodeHeader = (PCM_PNP_BIOS_DEVICE_NODE)currentPtr;
01217 
01218         <span class="keywordflow">if</span> (devNodeHeader-&gt;Size &gt; lengthRemaining) {
01219 
01220             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01221                         <span class="stringliteral">"Node # %d, invalid size (%d), length remaining (%d)\n"</span>,
01222                         devNodeHeader-&gt;Node,
01223                         devNodeHeader-&gt;Size,
01224                         lengthRemaining) );
01225 
01226             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01227         }
01228 
01229         currentPtr += devNodeHeader-&gt;Size;
01230         lengthRemaining -= devNodeHeader-&gt;Size;
01231     }
01232 
01233     <span class="comment">//</span>
01234     <span class="comment">// Allocate the list of translated devnodes.</span>
01235     <span class="comment">//</span>
01236     devNodeInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, numNodes * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html">BIOS_DEVNODE_INFO</a>) );
01237 
01238     <span class="keywordflow">if</span> (devNodeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01239 
01240         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01241     }
01242 
01243     <span class="comment">//</span>
01244     <span class="comment">// Should we force all fixed IO decodes to 16bit?</span>
01245     <span class="comment">//</span>
01246     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/pnpmap_8c.html#a55">PnPCheckFixedIoOverrideDecodes</a>()) {
01247 
01248         convertFlags |= <a class="code" href="../../d0/d0/pnpcvrt_8h.html#a1">PPCONVERTFLAG_FORCE_FIXED_IO_16BIT_DECODE</a>;
01249     }
01250 
01251     <span class="comment">//</span>
01252     <span class="comment">// Now scan the data translating the info for each devnode into an entry in</span>
01253     <span class="comment">// our devNodeInfo array.</span>
01254     <span class="comment">//</span>
01255 
01256     currentPtr = (PUCHAR)BiosInfo + biosInstallCheck-&gt;Length;
01257     lengthRemaining = BiosInfoLength - biosInstallCheck-&gt;Length;
01258 
01259     <span class="keywordflow">for</span> (nodeIndex = 0; nodeIndex &lt; numNodes; nodeIndex++) {
01260 
01261         devNodeHeader = (PCM_PNP_BIOS_DEVICE_NODE)currentPtr;
01262 
01263         <span class="keywordflow">if</span> (devNodeHeader-&gt;Size &gt; lengthRemaining) {
01264 
01265             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01266                         <span class="stringliteral">"Node # %d, invalid size (%d), length remaining (%d)\n"</span>,
01267                         devNodeHeader-&gt;Node,
01268                         devNodeHeader-&gt;Size,
01269                         lengthRemaining) );
01270 
01271             <span class="keywordflow">break</span>;
01272         }
01273 
01274         <span class="comment">//</span>
01275         <span class="comment">// We use the Product ID field as the DeviceID key name.  So we insert</span>
01276         <span class="comment">// an initial asterisk so we don't have to copy and mangle it later.</span>
01277         <span class="comment">//</span>
01278         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o0">ProductId</a>[0] = <span class="charliteral">'*'</span>;
01279 
01280         <a class="code" href="../../d2/d1/pnpmap_8c.html#a37">PnPBiosExpandProductId</a>((PUCHAR)&amp;devNodeHeader-&gt;ProductId, &amp;devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o0">ProductId</a>[1]);
01281 
01282         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o0">ProductId</a>[9] = <span class="charliteral">'\0'</span>;  <span class="comment">// Extra NUL for REG_MULTI_SZ</span>
01283 
01284         <span class="comment">//</span>
01285         <span class="comment">// The handle is used as part of the Instance ID</span>
01286         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o1">Handle</a> = devNodeHeader-&gt;Node;
01287 
01288         <span class="comment">//</span>
01289         <span class="comment">// The type code and attributes aren't currently used but are copied</span>
01290         <span class="comment">// for completeness.</span>
01291         <span class="comment">//</span>
01292         RtlCopyMemory( &amp;devNodeInfo[nodeIndex].TypeCode,
01293                        devNodeHeader-&gt;DeviceType,
01294                        <span class="keyword">sizeof</span>(devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o2">TypeCode</a>) );
01295 
01296         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o3">Attributes</a> = devNodeHeader-&gt;DeviceAttributes;
01297 
01298         <span class="comment">//</span>
01299         <span class="comment">// Replaces will eventually be set to the path of the Firmware</span>
01300         <span class="comment">// Enumerated devnode which duplicates this one (if a duplicate exists).</span>
01301         <span class="comment">//</span>
01302         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o4">Replaces</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01303 
01304         <span class="comment">//</span>
01305         <span class="comment">// CompatibleIDs will be set to the list of compatible IDs.</span>
01306         <span class="comment">//</span>
01307         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o9">CompatibleIDs</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01308 
01309         <span class="comment">//</span>
01310         <span class="comment">// Convert the allocated resources from ISA PnP resource descriptor</span>
01311         <span class="comment">// format to an IO_RESOURCE_REQUIREMENTS_LIST.</span>
01312         <span class="comment">//</span>
01313         configPtr = currentPtr + <span class="keyword">sizeof</span>(*devNodeHeader);
01314         remainingNodeLength = devNodeHeader-&gt;Size - <span class="keyword">sizeof</span>(*devNodeHeader);
01315 
01316         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o5">BootConfig</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01317         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o11">FirmwareDisabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01318 
01319         status = <a class="code" href="../../d0/d0/pnpcvrt_8h.html#a3">PpBiosResourcesToNtResources</a>( 0,            <span class="comment">/* BusNumber */</span>
01320                                                0,            <span class="comment">/* SlotNumber */</span>
01321                                                &amp;configPtr,   <span class="comment">/* BiosData */</span>
01322                                                convertFlags, <span class="comment">/* ConvertFlags */</span>
01323                                                &amp;tempResReqList, <span class="comment">/* ReturnedList */</span>
01324                                                &amp;configListLength);    <span class="comment">/* ReturnedLength */</span>
01325 
01326         remainingNodeLength = devNodeHeader-&gt;Size - (LONG)(configPtr - (PUCHAR)devNodeHeader);
01327 
01328         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01329 
01330             <span class="keywordflow">if</span> (tempResReqList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01331 
01332                 <a class="code" href="../../d2/d1/pnpmap_8c.html#a50">PpFilterNtResource</a> (
01333                     devNodeInfo[nodeIndex].ProductId,
01334                     tempResReqList
01335                 );
01336 
01337                 <span class="comment">//</span>
01338                 <span class="comment">// Now we need to convert from a IO_RESOURCE_REQUIREMENTS_LIST to a</span>
01339                 <span class="comment">// CM_RESOURCE_LIST.</span>
01340                 <span class="comment">//</span>
01341                 status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a38">PnPBiosIoResourceListToCmResourceList</a>( tempResReqList,
01342                                                                 &amp;devNodeInfo[nodeIndex].BootConfig,
01343                                                                 &amp;devNodeInfo[nodeIndex].BootConfigLength );
01344 
01345                 status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a47">PnPBiosCheckForHardwareDisabled</a>(tempResReqList,&amp;devNodeInfo[nodeIndex].FirmwareDisabled);
01346 
01347                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( tempResReqList );
01348 
01349             }
01350 
01351         } <span class="keywordflow">else</span> {
01352 
01353             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01354                         <span class="stringliteral">"Error converting allocated resources for devnode # %d, status = %8.8X\n"</span>,
01355                         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01356                         status) );
01357         }
01358 
01359         <span class="comment">//</span>
01360         <span class="comment">// Convert the supported resource configurations from ISA PnP resource</span>
01361         <span class="comment">// descriptor format to an IO_RESOURCE_REQUIREMENTS_LIST.</span>
01362         <span class="comment">//</span>
01363         status = <a class="code" href="../../d0/d0/pnpcvrt_8h.html#a3">PpBiosResourcesToNtResources</a>( 0,            <span class="comment">/* BusNumber */</span>
01364                                                0,            <span class="comment">/* SlotNumber */</span>
01365                                                &amp;configPtr,   <span class="comment">/* BiosData */</span>
01366                                                convertFlags | <a class="code" href="../../d0/d0/pnpcvrt_8h.html#a0">PPCONVERTFLAG_SET_RESTART_LCPRI</a>, <span class="comment">/* ConvertFlags */</span>
01367                                                &amp;devNodeInfo[nodeIndex].BasicConfig, <span class="comment">/* ReturnedList */</span>
01368                                                &amp;devNodeInfo[nodeIndex].BasicConfigLength );  <span class="comment">/* ReturnedLength */</span>
01369 
01370         remainingNodeLength = devNodeHeader-&gt;Size - (LONG)(configPtr - (PUCHAR)devNodeHeader);
01371 
01372         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01373 
01374             devNodeInfo[nodeIndex].<a class="code" href="../../d7/d3/struct__BIOS__DEVNODE__INFO.html#o7">BasicConfig</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01375 
01376             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01377                         <span class="stringliteral">"Error converting allowed resources for devnode # %d, status = %8.8X\n"</span>,
01378                         devNodeInfo[nodeIndex].<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01379                         status) );
01380         } <span class="keywordflow">else</span> {
01381 
01382             <a class="code" href="../../d2/d1/pnpmap_8c.html#a50">PpFilterNtResource</a> (
01383                 devNodeInfo[nodeIndex].ProductId,
01384                 devNodeInfo[nodeIndex].BasicConfig
01385             );
01386         }
01387 
01388         <span class="comment">//</span>
01389         <span class="comment">// Convert the list of compatible IDs if present</span>
01390         <span class="comment">//</span>
01391 
01392         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(remainingNodeLength &gt;= 0);
01393 
01394         status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a39">PnPBiosExtractCompatibleIDs</a>( &amp;configPtr,       <span class="comment">// BiosData</span>
01395                                               (ULONG)remainingNodeLength,
01396                                               &amp;devNodeInfo[nodeIndex].CompatibleIDs,
01397                                               &amp;devNodeInfo[nodeIndex].CompatibleIDsLength );
01398 
01399         currentPtr += devNodeHeader-&gt;Size;
01400         lengthRemaining -= devNodeHeader-&gt;Size;
01401 
01402     }
01403 
01404     *DevNodeInfoList = devNodeInfo;
01405     *NumberNodes = numNodes;
01406     <span class="keywordflow">return</span> STATUS_SUCCESS;
01407 }
01408 
01409 LONG
<a name="l01410"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a41">01410</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a41">PnPBiosFindMatchingDevNode</a>(
01411     IN PWCHAR MapperName,
01412     IN PCM_RESOURCE_LIST ResourceList,
01413     IN PBIOS_DEVNODE_INFO DevNodeInfoList,
01414     IN ULONG NumberNodes
01415     )
01416 <span class="comment">/*++</span>
01417 <span class="comment"></span>
01418 <span class="comment">Routine Description:</span>
01419 <span class="comment"></span>
01420 <span class="comment">    Given a list of resources this routine finds an entry in the</span>
01421 <span class="comment">    DevNodeInfoList whose BootConfig resources match.  A match is defined as</span>
01422 <span class="comment">    having at least overlapping I/O Ports or Memory Ranges.  If ResourceList doesn't</span>
01423 <span class="comment">    include any I/O Ports or Memory Ranges then a match is defined as exactly</span>
01424 <span class="comment">    the same interrupts and/or DMA channels.</span>
01425 <span class="comment"></span>
01426 <span class="comment">    This routine is used to find PnP BIOS reported devices which match devices</span>
01427 <span class="comment">    created by the Firmware Mapper.</span>
01428 <span class="comment"></span>
01429 <span class="comment">Arguments:</span>
01430 <span class="comment"></span>
01431 <span class="comment">    ResourceList - Pointer to CM_RESOURCE_LIST describing the resources</span>
01432 <span class="comment">        currently used by the device for which a match is being searched.</span>
01433 <span class="comment"></span>
01434 <span class="comment">    DevNodeInfoList - Array of BIOS_DEVNODE_INFO structures, one for each device</span>
01435 <span class="comment">        reported by the BIOS.</span>
01436 <span class="comment"></span>
01437 <span class="comment">    NumberNodes - Number of BIOS_DEVNODE_INFO elements pointed to by</span>
01438 <span class="comment">        DevNodeInfoList.</span>
01439 <span class="comment"></span>
01440 <span class="comment"></span>
01441 <span class="comment">Return Value:</span>
01442 <span class="comment"></span>
01443 <span class="comment">    Index of the entry in DevNodeInfoList whose BootConfig matches the resources</span>
01444 <span class="comment">    listed in ResourceList.  If no matching entry is found then -1 is returned.</span>
01445 <span class="comment"></span>
01446 <span class="comment">--*/</span>
01447 {
01448     PCM_PARTIAL_RESOURCE_LIST       sourceList;
01449     PCM_PARTIAL_RESOURCE_LIST       targetList;
01450     PCM_PARTIAL_RESOURCE_DESCRIPTOR sourceDescriptor;
01451     PCM_PARTIAL_RESOURCE_DESCRIPTOR targetDescriptor;
01452     ULONG                           nodeIndex, sourceIndex, targetIndex;
01453     LONG                            firstMatch = -1;
01454     LONG                            bestMatch = -1;
01455     ULONG                           numResourcesMatch;
01456     ULONG                           score, possibleScore, bestScore = 0;
01457     PWCHAR                          idPtr;
01458     BOOLEAN                         idsMatch;
01459     BOOLEAN                         bestIdsMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01460 
01461 <span class="preprocessor">#if DEBUG_DUP_MATCH</span>
01462 <span class="preprocessor"></span>    <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                            sourceMapping[256];
01463     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                            targetMapping[256];
01464 <span class="preprocessor">#endif</span>
01465 <span class="preprocessor"></span>
01466     <span class="comment">//</span>
01467     <span class="comment">// In order to simplify the problem we assume there is only one list.  This</span>
01468     <span class="comment">// assumption holds true in the BootConfig structures generated by the</span>
01469     <span class="comment">// current firmware mapper.</span>
01470     <span class="comment">//</span>
01471     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ResourceList-&gt;Count == 1 );
01472 
01473     sourceList = &amp;ResourceList-&gt;List[0].PartialResourceList;
01474 
01475 <span class="preprocessor">#if DEBUG_DUP_MATCH</span>
01476 <span class="preprocessor"></span>    <span class="comment">//</span>
01477     <span class="comment">// For debugging purposes we keep track of which resource entries map to</span>
01478     <span class="comment">// each other.  These relationships are stored in a fixed CHAR array, thus</span>
01479     <span class="comment">// the restriction on the number of descriptors.</span>
01480     <span class="comment">//</span>
01481     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( sourceList-&gt;Count &lt; 255 );
01482 <span class="preprocessor">#endif</span>
01483 <span class="preprocessor"></span>
01484     <span class="comment">//</span>
01485     <span class="comment">// Loop through each devnode and try and match it to the source resource</span>
01486     <span class="comment">// list.</span>
01487     <span class="comment">//</span>
01488     <span class="keywordflow">for</span> (nodeIndex = 0; nodeIndex &lt; NumberNodes; nodeIndex++) {
01489 
01490         <span class="keywordflow">if</span> (DevNodeInfoList[ nodeIndex ].BootConfig == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01491 
01492             <span class="keywordflow">continue</span>;
01493         }
01494 
01495         <span class="comment">//</span>
01496         <span class="comment">// We found at least one potential match.  Let's double check if</span>
01497         <span class="comment">// the PNP ids also match.  We use a lack of ID match to disqualify</span>
01498         <span class="comment">// entries which don't match at least I/O ports or memory.</span>
01499         <span class="comment">//</span>
01500 
01501         idPtr = DevNodeInfoList[ nodeIndex ].ProductId;
01502 
01503         <span class="keywordflow">if</span> (RtlCompareMemory( idPtr, MapperName, 12 ) != 12) {
01504 
01505             idPtr = DevNodeInfoList[ nodeIndex ].CompatibleIDs;
01506 
01507             <span class="keywordflow">if</span> (idPtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01508 
01509                 <span class="keywordflow">while</span> (*idPtr != <span class="charliteral">'\0'</span>) {
01510 
01511                     <span class="keywordflow">if</span> (RtlCompareMemory( idPtr, MapperName, 12 ) == 12) {
01512 
01513                         <span class="keywordflow">break</span>;
01514                     }
01515 
01516                     idPtr += 9;
01517                 }
01518 
01519                 <span class="keywordflow">if</span> (*idPtr == <span class="charliteral">'\0'</span>) {
01520 
01521                     idPtr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01522                 }
01523             }
01524         }
01525 
01526         idsMatch = idPtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01527 
01528         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DevNodeInfoList[ nodeIndex ].BootConfig-&gt;Count == 1 );
01529 
01530         targetList = &amp;DevNodeInfoList[ nodeIndex ].BootConfig-&gt;List[0].PartialResourceList;
01531 
01532 <span class="preprocessor">#if DEBUG_DUP_MATCH</span>
01533 <span class="preprocessor"></span>        RtlFillMemory( sourceMapping, <span class="keyword">sizeof</span>(sourceMapping), -1 );
01534         RtlFillMemory( targetMapping, <span class="keyword">sizeof</span>(targetMapping), -1 );
01535 <span class="preprocessor">#endif</span>
01536 <span class="preprocessor"></span>
01537         numResourcesMatch = 0;
01538         possibleScore = 0;
01539         score = 0;
01540 
01541         <span class="comment">//</span>
01542         <span class="comment">// Loop through each source descriptor (resource) and try and match it</span>
01543         <span class="comment">// to one of this devnode's descriptors.</span>
01544         <span class="comment">//</span>
01545 
01546         <span class="keywordflow">for</span> (sourceIndex = 0; sourceIndex &lt; sourceList-&gt;Count; sourceIndex++) {
01547 
01548             sourceDescriptor = &amp;sourceList-&gt;PartialDescriptors[sourceIndex];
01549 
01550             <span class="comment">//</span>
01551             <span class="comment">// We are recalculating the possible score unnecessarily each time</span>
01552             <span class="comment">// we process a devnode.  We might save a small amount of time by</span>
01553             <span class="comment">// looping through the source descriptors once at the beginning but</span>
01554             <span class="comment">// its not clear it would make all that much difference given the</span>
01555             <span class="comment">// few devices reported by the BIOS.</span>
01556             <span class="comment">//</span>
01557 
01558             <span class="keywordflow">switch</span> (sourceDescriptor-&gt;Type) {
01559 
01560             <span class="keywordflow">case</span> CmResourceTypePort:
01561                 possibleScore += 0x1100;
01562                 <span class="keywordflow">break</span>;
01563 
01564             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
01565                 possibleScore += 0x0001;
01566                 <span class="keywordflow">break</span>;
01567 
01568             <span class="keywordflow">case</span> CmResourceTypeMemory:
01569                 possibleScore += 0x1100;
01570                 <span class="keywordflow">break</span>;
01571 
01572             <span class="keywordflow">case</span> CmResourceTypeDma:
01573                 possibleScore += 0x0010;
01574                 <span class="keywordflow">break</span>;
01575 
01576             <span class="keywordflow">default</span>:
01577                 <span class="keywordflow">continue</span>;
01578             }
01579 
01580             <span class="comment">//</span>
01581             <span class="comment">// Try to find a resource in the target devnode which matches the</span>
01582             <span class="comment">// current source resource.</span>
01583             <span class="comment">//</span>
01584             <span class="keywordflow">for</span> (targetIndex = 0; targetIndex &lt; targetList-&gt;Count; targetIndex++) {
01585 
01586                 targetDescriptor = &amp;targetList-&gt;PartialDescriptors[targetIndex];
01587 
01588                 <span class="keywordflow">if</span> (sourceDescriptor-&gt;Type == targetDescriptor-&gt;Type) {
01589                     <span class="keywordflow">switch</span> (sourceDescriptor-&gt;Type) {
01590                     <span class="keywordflow">case</span> CmResourceTypePort:
01591                         <span class="keywordflow">if</span> ((sourceDescriptor-&gt;u.Port.Start.LowPart + sourceDescriptor-&gt;u.Port.Length) &lt;=
01592                              targetDescriptor-&gt;u.Port.Start.LowPart ||
01593                             (targetDescriptor-&gt;u.Port.Start.LowPart + targetDescriptor-&gt;u.Port.Length) &lt;=
01594                              sourceDescriptor-&gt;u.Port.Start.LowPart) {
01595                             <span class="keywordflow">continue</span>;
01596                         }
01597                         <span class="keywordflow">if</span> (sourceDescriptor-&gt;u.Port.Start.LowPart ==
01598                                 targetDescriptor-&gt;u.Port.Start.LowPart &amp;&amp;
01599                             sourceDescriptor-&gt;u.Port.Length ==
01600                                 targetDescriptor-&gt;u.Port.Length) {
01601 
01602                             score += 0x1100;
01603 
01604                         } <span class="keywordflow">else</span> {
01605 
01606                             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_INFORMATION,
01607                                         <span class="stringliteral">"Overlapping port resources, source = %4.4X-%4.4X, target = %4.4X-%4.4X\n"</span>,
01608                                         sourceDescriptor-&gt;u.Port.Start.LowPart,
01609                                         sourceDescriptor-&gt;u.Port.Start.LowPart + sourceDescriptor-&gt;u.Port.Length - 1,
01610                                         targetDescriptor-&gt;u.Port.Start.LowPart,
01611                                         targetDescriptor-&gt;u.Port.Start.LowPart + targetDescriptor-&gt;u.Port.Length - 1) );
01612 
01613                             score += 0x1000;
01614 
01615                         }
01616                         <span class="keywordflow">break</span>;
01617 
01618                     <span class="keywordflow">case</span> CmResourceTypeInterrupt:
01619                         <span class="keywordflow">if</span> (sourceDescriptor-&gt;u.Interrupt.Level !=
01620                             targetDescriptor-&gt;u.Interrupt.Level) {
01621                             <span class="keywordflow">continue</span>;
01622                         }
01623                         score += 0x0001;
01624                         <span class="keywordflow">break</span>;
01625 
01626                     <span class="keywordflow">case</span> CmResourceTypeMemory:
01627                         <span class="keywordflow">if</span> ((sourceDescriptor-&gt;u.Memory.Start.LowPart + sourceDescriptor-&gt;u.Memory.Length) &lt;=
01628                              targetDescriptor-&gt;u.Memory.Start.LowPart ||
01629                             (targetDescriptor-&gt;u.Memory.Start.LowPart + targetDescriptor-&gt;u.Memory.Length) &lt;=
01630                              sourceDescriptor-&gt;u.Memory.Start.LowPart) {
01631 
01632                             <span class="keywordflow">continue</span>;
01633                         }
01634                         <span class="keywordflow">if</span> (sourceDescriptor-&gt;u.Memory.Start.LowPart ==
01635                                 targetDescriptor-&gt;u.Memory.Start.LowPart &amp;&amp;
01636                             sourceDescriptor-&gt;u.Memory.Length ==
01637                                 targetDescriptor-&gt;u.Memory.Length) {
01638 
01639                             score += 0x1100;
01640 
01641                         } <span class="keywordflow">else</span> {
01642 
01643                             score += 0x1000;
01644 
01645                         }
01646                         <span class="keywordflow">break</span>;
01647 
01648                     <span class="keywordflow">case</span> CmResourceTypeDma:
01649                         <span class="keywordflow">if</span> (sourceDescriptor-&gt;u.Dma.Channel !=
01650                             targetDescriptor-&gt;u.Dma.Channel) {
01651 
01652                             <span class="keywordflow">continue</span>;
01653                         }
01654                         score += 0x0010;
01655                         <span class="keywordflow">break</span>;
01656 
01657                     }
01658                     <span class="keywordflow">break</span>;
01659                 }
01660             }
01661 
01662             <span class="keywordflow">if</span> (targetIndex &lt; targetList-&gt;Count) {
01663 <span class="preprocessor">#if DEBUG_DUP_MATCH</span>
01664 <span class="preprocessor"></span>                sourceMapping[sourceIndex] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)targetIndex;
01665                 targetMapping[targetIndex] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)sourceIndex;
01666 <span class="preprocessor">#endif</span>
01667 <span class="preprocessor"></span>                numResourcesMatch++;
01668             }
01669         }
01670 
01671         <span class="keywordflow">if</span> (numResourcesMatch != 0) {
01672             <span class="keywordflow">if</span> (firstMatch == -1) {
01673                 firstMatch = nodeIndex;
01674             }
01675 
01676             <span class="keywordflow">if</span> ((score &gt; bestScore) || (score == bestScore &amp;&amp; !bestIdsMatch &amp;&amp; idsMatch))  {
01677                 bestScore = score;
01678                 bestMatch = nodeIndex;
01679                 bestIdsMatch = idsMatch;
01680             }
01681         }
01682     }
01683 
01684     <span class="keywordflow">if</span> (bestMatch != -1) {
01685 
01686         <span class="keywordflow">if</span> (bestScore == possibleScore) {
01687 
01688             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_INFORMATION,
01689                         <span class="stringliteral">"Perfect match, score = %4.4X, possible = %4.4X, index = %d\n"</span>,
01690                         bestScore,
01691                         possibleScore,
01692                         bestMatch) );
01693 
01694             <span class="keywordflow">if</span> (possibleScore &lt; 0x1000 &amp;&amp; !bestIdsMatch) {
01695 
01696                 bestMatch = -1;
01697 
01698             }
01699 
01700         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (possibleScore &gt; 0x1000 &amp;&amp; bestScore &gt;= 0x1000) {
01701 
01702             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_INFORMATION,
01703                         <span class="stringliteral">"Best match is close enough, score = %4.4X, possible = %4.4X, index = %d\n"</span>,
01704                         bestScore,
01705                         possibleScore,
01706                         bestMatch) );
01707 
01708         } <span class="keywordflow">else</span>  {
01709 
01710             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_INFORMATION,
01711                         <span class="stringliteral">"Best match is less than threshold, score = %4.4X, possible = %4.4X, index = %d\n"</span>,
01712                         bestScore,
01713                         possibleScore,
01714                         bestMatch) );
01715 
01716             bestMatch = -1;
01717 
01718         }
01719     }
01720 
01721     <span class="keywordflow">return</span> bestMatch;
01722 }
01723 
01724 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01725"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a42">01725</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a42">PnPBiosEliminateDupes</a>(
01726     IN PBIOS_DEVNODE_INFO DevNodeInfoList,
01727     IN ULONG NumberNodes
01728     )
01729 <span class="comment">/*++</span>
01730 <span class="comment"></span>
01731 <span class="comment">Routine Description:</span>
01732 <span class="comment"></span>
01733 <span class="comment">    This routine enumerates the Firmware Mapper generated devices under</span>
01734 <span class="comment">    Enum\Root.  Those that match entries in DevNodeInfoList have their registry</span>
01735 <span class="comment">    key name stored in the DevNodeInfoList entry so that the Firmare Mapper</span>
01736 <span class="comment">    instance may be removed later.</span>
01737 <span class="comment"></span>
01738 <span class="comment">Arguments:</span>
01739 <span class="comment"></span>
01740 <span class="comment">    DevNodeInfoList - Array of BIOS_DEVNODE_INFO structures, one for each device</span>
01741 <span class="comment">        reported by the BIOS.</span>
01742 <span class="comment"></span>
01743 <span class="comment">    NumberNodes - Number of BIOS_DEVNODE_INFO elements pointed to by</span>
01744 <span class="comment">        DevNodeInfoList.</span>
01745 <span class="comment"></span>
01746 <span class="comment">Return Value:</span>
01747 <span class="comment"></span>
01748 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
01749 <span class="comment"></span>
01750 <span class="comment">--*/</span>
01751 {
01752     UNICODE_STRING                  enumRootKeyName, valueName;
01753     HANDLE                          enumRootKey;
01754     PKEY_BASIC_INFORMATION          deviceBasicInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01755     ULONG                           deviceBasicInfoLength;
01756     UNICODE_STRING                  deviceKeyName;
01757     HANDLE                          deviceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01758     PKEY_BASIC_INFORMATION          instanceBasicInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01759     ULONG                           instanceBasicInfoLength;
01760     WCHAR                           logConfStr[<a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>];
01761     UNICODE_STRING                  logConfKeyName;
01762     HANDLE                          logConfKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01763 
01764     PKEY_VALUE_PARTIAL_INFORMATION  valueInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01765     ULONG                           valueInfoLength;
01766     ULONG                           returnedLength;
01767 
01768     ULONG                           deviceIndex, instanceIndex;
01769     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status = STATUS_UNSUCCESSFUL;
01770 
01771     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;enumRootKeyName, <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>);
01772 
01773     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumRootKey,
01774                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01775                                    &amp;enumRootKeyName,
01776                                    KEY_READ
01777                                    );
01778 
01779     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01780 
01781         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01782                     <span class="stringliteral">"Could not open registry key %S, status = %8.8X\n"</span>,
01783                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
01784                     status) );
01785 
01786         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01787     }
01788 
01789     deviceBasicInfoLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>;
01790     deviceBasicInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, deviceBasicInfoLength);
01791 
01792     instanceBasicInfoLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>;
01793     instanceBasicInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, instanceBasicInfoLength);
01794 
01795     valueInfoLength = <span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>;
01796     valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueInfoLength);
01797 
01798     <span class="keywordflow">if</span> (deviceBasicInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; instanceBasicInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01799 
01800         <span class="keywordflow">for</span> (deviceIndex = 0; ; deviceIndex++) {
01801 
01802             status = ZwEnumerateKey( enumRootKey,
01803                                      deviceIndex,
01804                                      KeyBasicInformation,
01805                                      deviceBasicInfo,
01806                                      deviceBasicInfoLength,
01807                                      &amp;returnedLength);
01808 
01809             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01810 
01811                 <span class="keywordflow">if</span> (status != STATUS_NO_MORE_ENTRIES)  {
01812 
01813                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01814                                 <span class="stringliteral">"Could not enumerate under key %S, status = %8.8X\n"</span>,
01815                                 <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
01816                                 status) );
01817                 } <span class="keywordflow">else</span> {
01818                     status = STATUS_SUCCESS;
01819                 }
01820                 <span class="keywordflow">break</span>;
01821             }
01822 
01823             <span class="keywordflow">if</span> (deviceBasicInfo-&gt;Name[0] != <span class="charliteral">'*'</span>) {
01824                 <span class="keywordflow">continue</span>;
01825             }
01826 
01827             deviceBasicInfo-&gt;Name[ deviceBasicInfo-&gt;NameLength / 2 ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01828             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceKeyName, deviceBasicInfo-&gt;Name);
01829 
01830             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;deviceKey,
01831                                            enumRootKey,
01832                                            &amp;deviceKeyName,
01833                                            KEY_READ
01834                                            );
01835 
01836             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01837 
01838                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01839                             <span class="stringliteral">"Could not open registry key %S\\%S, status = %8.8X\n"</span>,
01840                             <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
01841                             deviceBasicInfo-&gt;Name,
01842                             status) );
01843                 <span class="keywordflow">break</span>;
01844             }
01845 
01846             <span class="keywordflow">for</span> (instanceIndex = 0; ; instanceIndex++) {
01847 
01848                 status = ZwEnumerateKey( deviceKey,
01849                                          instanceIndex,
01850                                          KeyBasicInformation,
01851                                          instanceBasicInfo,
01852                                          instanceBasicInfoLength,
01853                                          &amp;returnedLength);
01854 
01855                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01856 
01857                     <span class="keywordflow">if</span> (status != STATUS_NO_MORE_ENTRIES)  {
01858                         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01859                                     <span class="stringliteral">"Could not enumerate under key %S\\%S, status = %8.8X\n"</span>,
01860                                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
01861                                     deviceBasicInfo-&gt;Name,
01862                                     status) );
01863                     } <span class="keywordflow">else</span> {
01864                         status = STATUS_SUCCESS;
01865                     }
01866                     <span class="keywordflow">break</span>;
01867                 }
01868 
01869                 <span class="keywordflow">if</span> (RtlCompareMemory( instanceBasicInfo-&gt;Name,
01870                                       <a class="code" href="../../d2/d1/pnpmap_8c.html#a6">INSTANCE_ID_PREFIX</a>,
01871                                       <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d1/pnpmap_8c.html#a6">INSTANCE_ID_PREFIX</a>) - <span class="keyword">sizeof</span>(UNICODE_NULL)
01872                                       ) == (<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d1/pnpmap_8c.html#a6">INSTANCE_ID_PREFIX</a>) - <span class="keyword">sizeof</span>(UNICODE_NULL))) {
01873 
01874                     <span class="keywordflow">continue</span>;
01875                 }
01876 
01877                 instanceBasicInfo-&gt;Name[ instanceBasicInfo-&gt;NameLength / 2 ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01878 
01879                 RtlCopyMemory( logConfStr,
01880                                instanceBasicInfo-&gt;Name,
01881                                instanceBasicInfo-&gt;NameLength );
01882 
01883                 logConfStr[ instanceBasicInfo-&gt;NameLength / 2 ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
01884 
01885                 RtlCopyMemory( &amp;logConfStr[ instanceBasicInfo-&gt;NameLength / 2 + 1 ],
01886                                REGSTR_KEY_LOGCONF,
01887                                <span class="keyword">sizeof</span>(REGSTR_KEY_LOGCONF) );
01888 
01889                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;logConfKeyName, logConfStr );
01890 
01891                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;logConfKey,
01892                                                deviceKey,
01893                                                &amp;logConfKeyName,
01894                                                KEY_READ
01895                                                );
01896 
01897                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01898 
01899                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01900                                 <span class="stringliteral">"Could not open registry key %S\\%S\\%S, status = %8.8X\n"</span>,
01901                                 <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
01902                                 deviceBasicInfo-&gt;Name,
01903                                 logConfStr,
01904                                 status) );
01905                     <span class="keywordflow">continue</span>;
01906                 }
01907 
01908                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, REGSTR_VAL_BOOTCONFIG );
01909 
01910                 status = ZwQueryValueKey( logConfKey,
01911                                           &amp;valueName,
01912                                           KeyValuePartialInformation,
01913                                           valueInfo,
01914                                           valueInfoLength,
01915                                           &amp;returnedLength );
01916 
01917                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01918 
01919                     <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL || status == STATUS_BUFFER_OVERFLOW) {
01920 
01921                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueInfo );
01922 
01923                         valueInfoLength = returnedLength;
01924                         valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueInfoLength );
01925 
01926                         <span class="keywordflow">if</span> (valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01927 
01928                             status = ZwQueryValueKey( logConfKey,
01929                                                       &amp;valueName,
01930                                                       KeyValuePartialInformation,
01931                                                       valueInfo,
01932                                                       valueInfoLength,
01933                                                       &amp;returnedLength );
01934                         } <span class="keywordflow">else</span> {
01935                             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01936                                         <span class="stringliteral">"Error allocating memory for %S\\%S\\LogConf\\BootConfig value\n"</span>,
01937                                         <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
01938                                         deviceBasicInfo-&gt;Name) );
01939                             valueInfoLength = 0;
01940                             status = STATUS_NO_MEMORY;
01941 
01942                             <span class="keywordflow">break</span>;
01943                         }
01944 
01945                     } <span class="keywordflow">else</span> {
01946                         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01947                                     <span class="stringliteral">"Error retrieving %S\\%S\\LogConf\\BootConfig size, status = %8.8X\n"</span>,
01948                                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
01949                                     deviceBasicInfo-&gt;Name,
01950                                     status) );
01951 
01952                         status = STATUS_UNSUCCESSFUL;
01953                     }
01954                 }
01955 
01956                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01957                     PCM_RESOURCE_LIST   resourceList;
01958                     LONG                matchingIndex;
01959 
01960                     resourceList = (PCM_RESOURCE_LIST)valueInfo-&gt;Data;
01961 
01962                     matchingIndex = <a class="code" href="../../d2/d1/pnpmap_8c.html#a41">PnPBiosFindMatchingDevNode</a>( deviceBasicInfo-&gt;Name,
01963                                                                 resourceList,
01964                                                                 DevNodeInfoList,
01965                                                                 NumberNodes );
01966 
01967                     <span class="keywordflow">if</span> (matchingIndex != -1) {
01968 
01969                         DevNodeInfoList[ matchingIndex ].Replaces = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01970                                                                                     deviceBasicInfo-&gt;NameLength + instanceBasicInfo-&gt;NameLength + 2 * <span class="keyword">sizeof</span>(UNICODE_NULL));
01971 
01972                         <span class="keywordflow">if</span> (DevNodeInfoList[ matchingIndex ].Replaces != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01973 
01974                             RtlCopyMemory( DevNodeInfoList[ matchingIndex ].Replaces,
01975                                            deviceBasicInfo-&gt;Name,
01976                                            deviceBasicInfo-&gt;NameLength );
01977 
01978                             DevNodeInfoList[ matchingIndex ].Replaces[ deviceBasicInfo-&gt;NameLength / 2 ] = <span class="charliteral">'\\'</span>;
01979 
01980                             RtlCopyMemory( &amp;DevNodeInfoList[ matchingIndex ].Replaces[ deviceBasicInfo-&gt;NameLength / 2 + 1 ],
01981                                            instanceBasicInfo-&gt;Name,
01982                                            instanceBasicInfo-&gt;NameLength );
01983 
01984                             DevNodeInfoList[ matchingIndex ].Replaces[ (deviceBasicInfo-&gt;NameLength + instanceBasicInfo-&gt;NameLength) / 2 + 1 ] = <span class="charliteral">'\0'</span>;
01985 
01986                             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_INFORMATION,
01987                                         <span class="stringliteral">"Match found: %S\\%S%d replaces %S\n"</span>,
01988                                         DevNodeInfoList[ matchingIndex ].ProductId,
01989                                         <a class="code" href="../../d2/d1/pnpmap_8c.html#a6">INSTANCE_ID_PREFIX</a>,
01990                                         DevNodeInfoList[ matchingIndex ].<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01991                                         DevNodeInfoList[ matchingIndex ].Replaces) );
01992                         } <span class="keywordflow">else</span> {
01993                             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
01994                                         <span class="stringliteral">"Error allocating memory for %S\\%S%d\\Replaces\n"</span>,
01995                                         DevNodeInfoList[ matchingIndex ].ProductId,
01996                                         <a class="code" href="../../d2/d1/pnpmap_8c.html#a6">INSTANCE_ID_PREFIX</a>,
01997                                         DevNodeInfoList[ matchingIndex ].<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>) );
01998                         }
01999                     } <span class="keywordflow">else</span> {
02000                         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_INFORMATION,
02001                                     <span class="stringliteral">"No matching PnP Bios DevNode found for FW Enumerated device %S\\%S\n"</span>,
02002                                     deviceBasicInfo-&gt;Name,
02003                                     instanceBasicInfo-&gt;Name) );
02004                     }
02005                 } <span class="keywordflow">else</span> {
02006                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02007                                 <span class="stringliteral">"Error retrieving %S\\%S\\%S\\BootConfig, status = %8.8X\n"</span>,
02008                                 <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
02009                                 deviceBasicInfo-&gt;Name,
02010                                 logConfStr,
02011                                 status) );
02012                 }
02013 
02014                 ZwClose(logConfKey);
02015 
02016                 logConfKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02017             }
02018 
02019             ZwClose(deviceKey);
02020 
02021             deviceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02022         }
02023     } <span class="keywordflow">else</span> {
02024         status = STATUS_NO_MEMORY;
02025     }
02026 
02027     <span class="keywordflow">if</span> (valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02028         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(valueInfo);
02029     }
02030 
02031     <span class="keywordflow">if</span> (instanceBasicInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02032         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(instanceBasicInfo);
02033     }
02034 
02035     <span class="keywordflow">if</span> (deviceBasicInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02036         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceBasicInfo);
02037     }
02038 
02039     <span class="keywordflow">if</span> (logConfKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02040         ZwClose(logConfKey);
02041     }
02042 
02043     <span class="keywordflow">if</span> (deviceKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02044         ZwClose(deviceKey);
02045     }
02046 
02047     ZwClose(enumRootKey);
02048 
02049     <span class="keywordflow">return</span> status;
02050 }
02051 
02052 PWCHAR
<a name="l02053"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a43">02053</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a43">PnPBiosGetDescription</a>(
02054     IN PBIOS_DEVNODE_INFO DevNodeInfoEntry
02055     )
02056 {
02057     ULONG       <span class="keyword">class</span>, subClass;
02058     LONG        index;
02059     <a class="code" href="../../d0/d0/struct__CLASSDATA.html">CLASSDATA</a>   *classDescriptions;
02060     LONG        descriptionCount;
02061 
02062     <span class="keyword">class </span>= DevNodeInfoEntry-&gt;TypeCode[0];
02063     subClass = (DevNodeInfoEntry-&gt;TypeCode[1] &lt;&lt; 8) | DevNodeInfoEntry-&gt;TypeCode[2];
02064 
02065     <span class="keywordflow">if</span> (<span class="keyword">class </span>&gt; 0 &amp;&amp; <span class="keyword">class </span>&lt; <a class="code" href="../../d2/d1/pnpmap_8c.html#a14">CLASSLIST_COUNT</a>) {
02066 
02067         classDescriptions = <a class="code" href="../../d2/d1/pnpmap_8c.html#a33">ClassDescriptionsList</a>[ <span class="keyword">class </span>].Descriptions;
02068         descriptionCount = <a class="code" href="../../d2/d1/pnpmap_8c.html#a33">ClassDescriptionsList</a>[ <span class="keyword">class </span>].<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
02069 
02070         <span class="comment">//</span>
02071         <span class="comment">// The last description entry is the default so there is no use</span>
02072         <span class="comment">// comparing it, if we get that far just use it.</span>
02073         <span class="comment">//</span>
02074         <span class="keywordflow">for</span> (index = 0; index &lt; (descriptionCount - 1); index++) {
02075 
02076             <span class="keywordflow">if</span> (subClass == classDescriptions[ index ].<a class="code" href="../../d0/d0/struct__CLASSDATA.html#o0">Value</a>)  {
02077 
02078                 <span class="keywordflow">break</span>;
02079             }
02080         }
02081 
02082         <span class="keywordflow">return</span> classDescriptions[ index ].<a class="code" href="../../d0/d0/struct__CLASSDATA.html#o1">Description</a>;
02083     }
02084 
02085     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/pnpmap_8c.html#a9">DEFAULT_DEVICE_DESCRIPTION</a>;
02086 }
02087 
02088 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02089"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a57">02089</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a57">PnPBiosCopyDeviceParamKey</a>(
02090     IN HANDLE EnumRootKey,
02091     IN PWCHAR SourcePath,
02092     IN PWCHAR DestinationPath
02093     )
02094 <span class="comment">/*++</span>
02095 <span class="comment"></span>
02096 <span class="comment">Routine Description:</span>
02097 <span class="comment"></span>
02098 <span class="comment">    Copy the Device Parameters key from the firmware mapper node in</span>
02099 <span class="comment">    DevNodeInfo-&gt;Replaces to the BIOS mapper node represented by DevNodeInfo.</span>
02100 <span class="comment"></span>
02101 <span class="comment">Arguments:</span>
02102 <span class="comment"></span>
02103 <span class="comment">    EnumRootKey - Handle to Enum\Root.</span>
02104 <span class="comment"></span>
02105 <span class="comment">    SourcePath - Instance path of FW Mapper node relative to Enum\Root.</span>
02106 <span class="comment"></span>
02107 <span class="comment">    DestinationKey - Handle to destination instance key.</span>
02108 <span class="comment"></span>
02109 <span class="comment">Return Value:</span>
02110 <span class="comment"></span>
02111 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
02112 <span class="comment"></span>
02113 <span class="comment">--*/</span>
02114 {
02115     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
02116     UNICODE_STRING              sourceInstanceKeyName;
02117     HANDLE                      sourceInstanceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02118 
02119     UNICODE_STRING              deviceParamKeyName;
02120     HANDLE                      sourceDeviceParamKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02121     HANDLE                      destinationDeviceParamKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02122     UNICODE_STRING              destinationInstanceKeyName;
02123 
02124     PKEY_VALUE_FULL_INFORMATION valueFullInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02125     ULONG                       valueFullInfoLength;
02126     ULONG                       resultLength;
02127 
02128     UNICODE_STRING              valueName;
02129 
02130     ULONG                       index;
02131 
02132     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;sourceInstanceKeyName, SourcePath );
02133 
02134     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;sourceInstanceKey,
02135                                    EnumRootKey,
02136                                    &amp;sourceInstanceKeyName,
02137                                    KEY_ALL_ACCESS
02138                                    );
02139 
02140     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02141 
02142         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02143                     <span class="stringliteral">"PnPBiosCopyDeviceParamKey() - Could not open source instance key %S, status = %8.8X\n"</span>,
02144                     SourcePath,
02145                     status) );
02146 
02147         <span class="keywordflow">return</span> status;
02148     }
02149 
02150     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceParamKeyName, REGSTR_KEY_DEVICEPARAMETERS);
02151 
02152     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;sourceDeviceParamKey,
02153                                    sourceInstanceKey,
02154                                    &amp;deviceParamKeyName,
02155                                    KEY_ALL_ACCESS
02156                                    );
02157 
02158     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02159 
02160         <span class="keywordflow">if</span> (status != STATUS_OBJECT_NAME_NOT_FOUND) {
02161 
02162             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02163                         <span class="stringliteral">"PnPBiosCopyDeviceParamKey() - Could not open source device parameter key %S\\%S, status = %8.8X\n"</span>,
02164                         SourcePath,
02165                         deviceParamKeyName.Buffer,
02166                         status) );
02167         }
02168 
02169         <span class="keywordflow">goto</span> Cleanup;
02170     }
02171 
02172     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;destinationInstanceKeyName, DestinationPath);
02173 
02174     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a304">IopOpenDeviceParametersSubkey</a>( &amp;destinationDeviceParamKey,
02175                                             EnumRootKey,
02176                                             &amp;destinationInstanceKeyName,
02177                                             KEY_ALL_ACCESS );
02178 
02179     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02180 
02181         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02182                     <span class="stringliteral">"PnPBiosCopyDeviceParamKey() - Could not open destination device parameter key %S\\%S, status = %8.8X\n"</span>,
02183                     DestinationPath,
02184                     REGSTR_KEY_DEVICEPARAMETERS,
02185                     status) );
02186 
02187         <span class="keywordflow">goto</span> Cleanup;
02188     }
02189 
02190     valueFullInfoLength = <span class="keyword">sizeof</span>(KEY_VALUE_FULL_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a> + <a class="code" href="../../d2/d1/pnpmap_8c.html#a8">DEFAULT_VALUE_SIZE</a>;
02191     valueFullInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueFullInfoLength);
02192 
02193     <span class="keywordflow">if</span> (valueFullInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02194 
02195         <span class="keywordflow">goto</span> Cleanup;
02196     }
02197 
02198     <span class="keywordflow">for</span> (index = 0; ; index++) {
02199         status = ZwEnumerateValueKey( sourceDeviceParamKey,
02200                                       index,
02201                                       KeyValueFullInformation,
02202                                       valueFullInfo,
02203                                       valueFullInfoLength,
02204                                       &amp;resultLength );
02205 
02206         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02207             UNICODE_STRING  sourcePathString;
02208             UNICODE_STRING  serialPrefixString;
02209             UNICODE_STRING  portNameString;
02210 
02211             valueName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)valueFullInfo-&gt;NameLength;
02212             valueName.MaximumLength = valueName.Length;
02213             valueName.Buffer = valueFullInfo-&gt;Name;
02214 
02215             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;sourcePathString, SourcePath);
02216             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;serialPrefixString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP0501"</span>);
02217 
02218             <span class="keywordflow">if</span> (sourcePathString.Length &gt; serialPrefixString.Length) {
02219                 sourcePathString.Length = serialPrefixString.Length;
02220             }
02221 
02222             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(&amp;sourcePathString, &amp;serialPrefixString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == 0) {
02223 
02224                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;portNameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PortName"</span>);
02225 
02226                 <span class="keywordflow">if</span> (valueName.Length == 16 &amp;&amp;
02227                     <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(&amp;valueName, &amp;portNameString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == 0)  {
02228 
02229                     <span class="comment">// ComPortDBRemove(SourcePath, &amp;unicodeValue);</span>
02230                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a51">ComPortDBAdd</a>(destinationDeviceParamKey, (PWSTR)((PUCHAR)valueFullInfo + valueFullInfo-&gt;DataOffset));
02231                     <span class="keywordflow">continue</span>;
02232                 }
02233             }
02234 
02235             status = ZwSetValueKey( destinationDeviceParamKey,
02236                                     &amp;valueName,
02237                                     valueFullInfo-&gt;TitleIndex,
02238                                     valueFullInfo-&gt;Type,
02239                                     (PUCHAR)valueFullInfo + valueFullInfo-&gt;DataOffset,
02240                                     valueFullInfo-&gt;DataLength );
02241         } <span class="keywordflow">else</span> {
02242             <span class="keywordflow">if</span> (status == STATUS_BUFFER_OVERFLOW) {
02243                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueFullInfo );
02244 
02245                 valueFullInfoLength = resultLength;
02246                 valueFullInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueFullInfoLength);
02247 
02248                 <span class="keywordflow">if</span> (valueFullInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02249                     status = STATUS_NO_MEMORY;
02250                 } <span class="keywordflow">else</span> {
02251                     index--;
02252                     <span class="keywordflow">continue</span>;
02253                 }
02254             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != STATUS_NO_MORE_ENTRIES)  {
02255                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02256                             <span class="stringliteral">"Could not enumerate under key %S\\%S, status = %8.8X\n"</span>,
02257                             SourcePath,
02258                             deviceParamKeyName.Buffer,
02259                             status) );
02260             } <span class="keywordflow">else</span> {
02261                 status = STATUS_SUCCESS;
02262             }
02263 
02264             <span class="keywordflow">break</span>;
02265         }
02266     }
02267 
02268 Cleanup:
02269     <span class="keywordflow">if</span> (sourceInstanceKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02270         ZwClose( sourceInstanceKey );
02271     }
02272 
02273     <span class="keywordflow">if</span> (sourceDeviceParamKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02274         ZwClose( sourceDeviceParamKey );
02275     }
02276 
02277     <span class="keywordflow">if</span> (destinationDeviceParamKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02278         ZwClose( destinationDeviceParamKey );
02279     }
02280 
02281     <span class="keywordflow">if</span> (valueFullInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02282         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueFullInfo );
02283     }
02284 
02285     <span class="keywordflow">return</span> status;
02286 }
02287 
02288 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02289"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a44">02289</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a44">PnPBiosWriteInfo</a>(
02290     IN PBIOS_DEVNODE_INFO DevNodeInfoList,
02291     IN ULONG NumberNodes
02292     )
02293 <span class="comment">/*++</span>
02294 <span class="comment"></span>
02295 <span class="comment">Routine Description:</span>
02296 <span class="comment"></span>
02297 <span class="comment">    Creates an entry under Enum\Root for each DevNodeInfoList element.  Also</span>
02298 <span class="comment">    removes any duplicate entries which were created by the Firmware Mapper.</span>
02299 <span class="comment"></span>
02300 <span class="comment">    Note: Currently entries for the Keyboard, Mouse, and PCI bus are ignored.</span>
02301 <span class="comment"></span>
02302 <span class="comment">Arguments:</span>
02303 <span class="comment"></span>
02304 <span class="comment">    DevNodeInfoList - Array of BIOS_DEVNODE_INFO structures, one for each device</span>
02305 <span class="comment">        reported by the BIOS.</span>
02306 <span class="comment"></span>
02307 <span class="comment">    NumberNodes - Number of BIOS_DEVNODE_INFO elements pointed to by</span>
02308 <span class="comment">        DevNodeInfoList.</span>
02309 <span class="comment"></span>
02310 <span class="comment">Return Value:</span>
02311 <span class="comment"></span>
02312 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
02313 <span class="comment"></span>
02314 <span class="comment">--*/</span>
02315 {
02316     PKEY_VALUE_FULL_INFORMATION     excludeList=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02317 
02318     UNICODE_STRING                  enumRootKeyName;
02319     HANDLE                          enumRootKey;
02320     WCHAR                           instanceNameStr[<a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>];
02321     UNICODE_STRING                  instanceKeyName;
02322     HANDLE                          instanceKey;
02323     UNICODE_STRING                  controlKeyName;
02324     HANDLE                          controlKey;
02325     UNICODE_STRING                  logConfKeyName;
02326     HANDLE                          logConfKey;
02327 
02328     UNICODE_STRING                  valueName;
02329     ULONG                           dwordValue;
02330     ULONG                           disposition;
02331 
02332     PWCHAR                          descriptionStr;
02333     ULONG                           descriptionStrLength;
02334 
02335     ULONG                           nodeIndex;
02336     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
02337 
02338     BOOLEAN                         isNewDevice;
02339 
02340     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;enumRootKeyName, <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>);
02341 
02342     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumRootKey,
02343                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02344                                    &amp;enumRootKeyName,
02345                                    KEY_ALL_ACCESS
02346                                    );
02347 
02348     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02349 
02350         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02351                     <span class="stringliteral">"Could not open registry key %S, status = %8.8X\n"</span>,
02352                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
02353                     status) );
02354 
02355         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02356 
02357     }
02358 
02359     <span class="comment">//</span>
02360     <span class="comment">// Reasons why a node might be excluded (i.e not enumerated)</span>
02361     <span class="comment">// * included in ExcludedDevices array (non-conditional)</span>
02362     <span class="comment">// * included in CCS\Control\BiosInfo\PnpBios\DisableNodes via biosinfo.inf</span>
02363     <span class="comment">// * resources are disabled and device is included in the</span>
02364     <span class="comment">//   ExcludeIfDisabled array</span>
02365 
02366     <a class="code" href="../../d2/d1/pnpmap_8c.html#a54">PnPGetDevnodeExcludeList</a> (&amp;excludeList);
02367 
02368     <span class="keywordflow">for</span> (nodeIndex = 0; nodeIndex &lt; NumberNodes; nodeIndex++) {
02369 
02370         <span class="comment">//</span>
02371         <span class="comment">// Check if this node is in the 'ignore on this machine' list.</span>
02372         <span class="comment">//</span>
02373 
02374         <span class="keywordflow">if</span> ( excludeList &amp;&amp;
02375              <a class="code" href="../../d2/d1/pnpmap_8c.html#a53">PnPBiosIgnoreNode</a>( &amp;DevNodeInfoList[ nodeIndex ].ProductId[1],
02376                                 (PWCHAR)((PUCHAR)excludeList+excludeList-&gt;DataOffset))) {
02377             <span class="keywordflow">continue</span>;
02378         }
02379 
02380         <span class="comment">// Checking for nodes we always exclude</span>
02381         <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d1/pnpmap_8c.html#a56">PnPBiosCheckForExclusion</a>( <a class="code" href="../../d2/d1/pnpmap_8c.html#a18">ExcludedDevices</a>,
02382                                        <a class="code" href="../../d2/d1/pnpmap_8c.html#a11">EXCLUDED_DEVICES_COUNT</a>,
02383                                        DevNodeInfoList[ nodeIndex ].ProductId,
02384                                        DevNodeInfoList[ nodeIndex ].CompatibleIDs)) {
02385             <span class="comment">//</span>
02386             <span class="comment">// If we are skipping the device, we need to first copy the decode</span>
02387             <span class="comment">// info that the BIOS supplied to the ntdetected device's Boot</span>
02388             <span class="comment">// Config which was generated by the FW mapper.</span>
02389             <span class="comment">//</span>
02390             <a class="code" href="../../d2/d1/pnpmap_8c.html#a45">PnPBiosCopyIoDecode</a>( enumRootKey, &amp;DevNodeInfoList[ nodeIndex ] );
02391 
02392             <span class="comment">//</span>
02393             <span class="comment">// Skip excluded devices, ie busses, mice and keyboards for now.</span>
02394             <span class="comment">//</span>
02395 
02396             <span class="keywordflow">continue</span>;
02397         }
02398 
02399         <span class="comment">// Checking for nodes we exclude if disabled</span>
02400         <span class="keywordflow">if</span> ( DevNodeInfoList[ nodeIndex ].FirmwareDisabled &amp;&amp;
02401              <a class="code" href="../../d2/d1/pnpmap_8c.html#a56">PnPBiosCheckForExclusion</a>( <a class="code" href="../../d2/d1/pnpmap_8c.html#a19">ExcludeIfDisabled</a>,
02402                                        <a class="code" href="../../d2/d1/pnpmap_8c.html#a12">EXCLUDE_DISABLED_COUNT</a>,
02403                                        DevNodeInfoList[ nodeIndex ].ProductId,
02404                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02405             <span class="keywordflow">continue</span>;
02406         }
02407 
02408         swprintf( instanceNameStr,
02409                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%s\\%s%d"</span>,
02410                   DevNodeInfoList[ nodeIndex ].ProductId,
02411                   <a class="code" href="../../d2/d1/pnpmap_8c.html#a6">INSTANCE_ID_PREFIX</a>,
02412                   DevNodeInfoList[ nodeIndex ].<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
02413 
02414         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;instanceKeyName, instanceNameStr );
02415 
02416         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;instanceKey,
02417                                          enumRootKey,
02418                                          &amp;instanceKeyName,
02419                                          KEY_ALL_ACCESS,
02420                                          REG_OPTION_NON_VOLATILE,
02421                                          &amp;disposition
02422                                          );
02423 
02424         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
02425 
02426             isNewDevice = disposition == REG_CREATED_NEW_KEY;
02427 
02428             <span class="keywordflow">if</span> (isNewDevice) {
02429 
02430                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DeviceDesc"</span> );
02431 
02432                 descriptionStr = <a class="code" href="../../d2/d1/pnpmap_8c.html#a43">PnPBiosGetDescription</a>( &amp;DevNodeInfoList[ nodeIndex ] );
02433                 descriptionStrLength = wcslen(descriptionStr) * 2 + <span class="keyword">sizeof</span>(UNICODE_NULL);
02434 
02435                 status = ZwSetValueKey( instanceKey,
02436                                         &amp;valueName,
02437                                         0,
02438                                         REG_SZ,
02439                                         descriptionStr,
02440                                         descriptionStrLength );
02441             }
02442 
02443             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, REGSTR_VAL_FIRMWAREIDENTIFIED );
02444             dwordValue = 1;
02445 
02446             status = ZwSetValueKey( instanceKey,
02447                                     &amp;valueName,
02448                                     0,
02449                                     REG_DWORD,
02450                                     &amp;dwordValue,
02451                                     <span class="keyword">sizeof</span>(dwordValue) );
02452 
02453             <span class="keywordflow">if</span> (isNewDevice)  {
02454 
02455                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"HardwareID"</span> );
02456 
02457                 status = ZwSetValueKey( instanceKey,
02458                                         &amp;valueName,
02459                                         0,
02460                                         REG_MULTI_SZ,
02461                                         DevNodeInfoList[ nodeIndex ].ProductId,
02462                                         <span class="keyword">sizeof</span>(DevNodeInfoList[ nodeIndex ].ProductId) );
02463 
02464                 <span class="keywordflow">if</span> (DevNodeInfoList[ nodeIndex ].CompatibleIDs != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02465 
02466                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CompatibleIDs"</span> );
02467 
02468                     status = ZwSetValueKey( instanceKey,
02469                                             &amp;valueName,
02470                                             0,
02471                                             REG_MULTI_SZ,
02472                                             DevNodeInfoList[ nodeIndex ].CompatibleIDs,
02473                                             DevNodeInfoList[ nodeIndex ].CompatibleIDsLength );
02474                 }
02475             }
02476 
02477             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Replaces"</span> );
02478 
02479             <span class="keywordflow">if</span> (DevNodeInfoList[ nodeIndex ].Replaces != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02480 
02481                 status = ZwSetValueKey( instanceKey,
02482                                         &amp;valueName,
02483                                         0,
02484                                         REG_SZ,
02485                                         DevNodeInfoList[ nodeIndex ].Replaces,
02486                                         wcslen(DevNodeInfoList[ nodeIndex ].Replaces) * 2 + <span class="keyword">sizeof</span>(UNICODE_NULL) );
02487 
02488             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!isNewDevice) {
02489 
02490                 status = ZwDeleteValueKey( instanceKey,
02491                                            &amp;valueName );
02492             }
02493 
02494             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;controlKeyName, REGSTR_KEY_DEVICECONTROL );
02495 
02496             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;controlKey,
02497                                              instanceKey,
02498                                              &amp;controlKeyName,
02499                                              KEY_ALL_ACCESS,
02500                                              REG_OPTION_VOLATILE,
02501                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02502                                              );
02503 
02504             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
02505 
02506                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, REGSTR_VAL_FIRMWAREMEMBER );
02507                 dwordValue = 1;
02508 
02509                 status = ZwSetValueKey( controlKey,
02510                                         &amp;valueName,
02511                                         0,
02512                                         REG_DWORD,
02513                                         &amp;dwordValue,
02514                                         <span class="keyword">sizeof</span>(dwordValue) );
02515 
02516                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PnpBiosDeviceHandle"</span> );
02517                 dwordValue = DevNodeInfoList[ nodeIndex ].Handle;
02518 
02519                 status = ZwSetValueKey( controlKey,
02520                                         &amp;valueName,
02521                                         0,
02522                                         REG_DWORD,
02523                                         &amp;dwordValue,
02524                                         <span class="keyword">sizeof</span>(dwordValue) );
02525 
02526                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, REGSTR_VAL_FIRMWAREDISABLED );
02527                 dwordValue = DevNodeInfoList[ nodeIndex ].FirmwareDisabled;
02528 
02529                 status = ZwSetValueKey( controlKey,
02530                                         &amp;valueName,
02531                                         0,
02532                                         REG_DWORD,
02533                                         &amp;dwordValue,
02534                                         <span class="keyword">sizeof</span>(dwordValue) );
02535 
02536                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PnpBiosDeviceHandle"</span> );
02537                 dwordValue = DevNodeInfoList[ nodeIndex ].Handle;
02538 
02539                 ZwClose( controlKey );
02540 
02541             } <span class="keywordflow">else</span> {
02542 
02543                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02544                             <span class="stringliteral">"Could not open registry key %S\\%S\\%S\\Control, status = %8.8X\n"</span>,
02545                             <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
02546                             DevNodeInfoList[ nodeIndex ].ProductId,
02547                             instanceNameStr,
02548                             status) );
02549 
02550                 ZwClose( instanceKey );
02551                 status = STATUS_UNSUCCESSFUL;
02552 
02553                 <span class="keywordflow">goto</span> Cleanup;
02554             }
02555 
02556             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;logConfKeyName, REGSTR_KEY_LOGCONF );
02557 
02558             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfKey,
02559                                            instanceKey,
02560                                            &amp;logConfKeyName,
02561                                            KEY_ALL_ACCESS,
02562                                            REG_OPTION_NON_VOLATILE,
02563                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02564                                            );
02565 
02566             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
02567 
02568                 <span class="keywordflow">if</span> (DevNodeInfoList[ nodeIndex ].BootConfig != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02569 
02570                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, REGSTR_VAL_BOOTCONFIG );
02571 
02572                     status = ZwSetValueKey( logConfKey,
02573                                             &amp;valueName,
02574                                             0,
02575                                             REG_RESOURCE_LIST,
02576                                             DevNodeInfoList[ nodeIndex ].BootConfig,
02577                                             DevNodeInfoList[ nodeIndex ].BootConfigLength );
02578 
02579                 }
02580 
02581                 <span class="keywordflow">if</span> (DevNodeInfoList[ nodeIndex ].BasicConfig != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02582 
02583                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, REGSTR_VAL_BASICCONFIGVECTOR );
02584 
02585                     status = ZwSetValueKey( logConfKey,
02586                                             &amp;valueName,
02587                                             0,
02588                                             REG_RESOURCE_REQUIREMENTS_LIST,
02589                                             DevNodeInfoList[ nodeIndex ].BasicConfig,
02590                                             DevNodeInfoList[ nodeIndex ].BasicConfigLength );
02591 
02592                 }
02593 
02594                 ZwClose( logConfKey );
02595 
02596             } <span class="keywordflow">else</span> {
02597 
02598                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02599                             <span class="stringliteral">"Could not open registry key %S\\%S\\%S\\LogConf, status = %8.8X\n"</span>,
02600                             <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
02601                             DevNodeInfoList[ nodeIndex ].ProductId,
02602                             instanceNameStr,
02603                             status) );
02604 
02605                 ZwClose( instanceKey );
02606                 status = STATUS_UNSUCCESSFUL;
02607 
02608                 <span class="keywordflow">goto</span> Cleanup;
02609             }
02610 
02611             <span class="comment">//</span>
02612             <span class="comment">// If we are replacing a FW Mapper devnode we need to copy the</span>
02613             <span class="comment">// Device Parameters subkey.</span>
02614             <span class="comment">//</span>
02615             <span class="keywordflow">if</span> (isNewDevice &amp;&amp; DevNodeInfoList[ nodeIndex ].Replaces != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02616 
02617                 status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a57">PnPBiosCopyDeviceParamKey</a>( enumRootKey,
02618                                                     DevNodeInfoList[ nodeIndex ].Replaces,
02619                                                     instanceNameStr );
02620             }
02621 
02622             ZwClose( instanceKey );
02623 
02624         } <span class="keywordflow">else</span> {
02625 
02626             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02627                         <span class="stringliteral">"Could not open registry key %S\\%S\\%S, status = %8.8X\n"</span>,
02628                         <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
02629                         DevNodeInfoList[ nodeIndex ].ProductId,
02630                         instanceNameStr,
02631                         status) );
02632 
02633             ZwClose( instanceKey );
02634             status = STATUS_UNSUCCESSFUL;
02635 
02636             <span class="keywordflow">goto</span> Cleanup;
02637         }
02638 
02639         <span class="comment">//</span>
02640         <span class="comment">// Now check if the entry just written duplicates one written by the</span>
02641         <span class="comment">// Firmware Mapper.  If it does then remove the Firmware Mapper entry.</span>
02642         <span class="comment">//</span>
02643 
02644         <span class="keywordflow">if</span> (DevNodeInfoList[ nodeIndex ].Replaces != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02645 
02646             <a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a>( enumRootKey, DevNodeInfoList[ nodeIndex ].Replaces );
02647 
02648         }
02649     }
02650 
02651     status = STATUS_SUCCESS;
02652 
02653  Cleanup:
02654     ZwClose( enumRootKey );
02655 
02656     <span class="keywordflow">if</span> (excludeList) {
02657         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (excludeList);
02658     }
02659 
02660     <span class="keywordflow">return</span> status;
02661 }
02662 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02663"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a45">02663</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a45">PnPBiosCopyIoDecode</a>(
02664     IN HANDLE EnumRootKey,
02665     IN PBIOS_DEVNODE_INFO DevNodeInfo
02666     )
02667 {
02668     HANDLE                          deviceKey;
02669     WCHAR                           logConfKeyNameStr[<a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>];
02670     UNICODE_STRING                  logConfKeyName;
02671     HANDLE                          logConfKey;
02672     UNICODE_STRING                  valueName;
02673     PKEY_VALUE_PARTIAL_INFORMATION  valueInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02674     ULONG                           valueInfoLength;
02675     ULONG                           returnedLength;
02676     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
02677     PCM_PARTIAL_RESOURCE_LIST       partialResourceList;
02678     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
02679     ULONG                           index;
02680     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>                          flags;
02681 
02682     <span class="keywordflow">if</span> (DevNodeInfo-&gt;Replaces == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || DevNodeInfo-&gt;BootConfig == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02683 
02684         <span class="comment">//</span>
02685         <span class="comment">// If we didn't find a FW Mapper created devnode then there is nothing</span>
02686         <span class="comment">// to do.</span>
02687         <span class="comment">//</span>
02688         <span class="keywordflow">return</span>;
02689     }
02690 
02691     <span class="comment">//</span>
02692     <span class="comment">// Search through the Boot Config and see if the device's I/O ports are</span>
02693     <span class="comment">// 16 bit decode.</span>
02694     <span class="comment">//</span>
02695 
02696     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DevNodeInfo-&gt;BootConfig-&gt;Count == 1);
02697 
02698     partialResourceList = &amp;DevNodeInfo-&gt;BootConfig-&gt;List[0].PartialResourceList;
02699 
02700     partialDescriptor = &amp;partialResourceList-&gt;PartialDescriptors[0];
02701 
02702     flags = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)~0;
02703 
02704 <span class="preprocessor">#define DECODE_FLAGS ( CM_RESOURCE_PORT_10_BIT_DECODE | \</span>
02705 <span class="preprocessor">                       CM_RESOURCE_PORT_12_BIT_DECODE | \</span>
02706 <span class="preprocessor">                       CM_RESOURCE_PORT_16_BIT_DECODE | \</span>
02707 <span class="preprocessor">                       CM_RESOURCE_PORT_POSITIVE_DECODE )</span>
02708 <span class="preprocessor"></span>
02709     <span class="keywordflow">for</span> ( index = 0; index &lt; partialResourceList-&gt;Count; index++ ) {
02710         <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypePort) {
02711             <span class="keywordflow">if</span> (flags == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)~0) {
02712                 flags = partialDescriptor-&gt;Flags &amp; <a class="code" href="../../d2/d1/pnpmap_8c.html#a15">DECODE_FLAGS</a>;
02713             } <span class="keywordflow">else</span> {
02714                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(flags == (partialDescriptor-&gt;Flags &amp; <a class="code" href="../../d2/d1/pnpmap_8c.html#a15">DECODE_FLAGS</a>));
02715             }
02716         }
02717         partialDescriptor++;
02718     }
02719 
02720     <span class="keywordflow">if</span> (!(flags &amp; (CM_RESOURCE_PORT_16_BIT_DECODE | CM_RESOURCE_PORT_POSITIVE_DECODE)))  {
02721         <span class="keywordflow">return</span>;
02722     }
02723 
02724     swprintf( logConfKeyNameStr,
02725               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%s\\%s"</span>,
02726               DevNodeInfo-&gt;Replaces,
02727               REGSTR_KEY_LOGCONF
02728               );
02729 
02730     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;logConfKeyName, logConfKeyNameStr );
02731 
02732     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfKey,
02733                                      EnumRootKey,
02734                                      &amp;logConfKeyName,
02735                                      KEY_ALL_ACCESS,
02736                                      REG_OPTION_NON_VOLATILE,
02737                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02738                                      );
02739 
02740     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02741 
02742         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02743                     <span class="stringliteral">"Could not open registry key %S\\%S\\%S, status = %8.8X\n"</span>,
02744                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
02745                     DevNodeInfo-&gt;Replaces,
02746                     REGSTR_KEY_LOGCONF,
02747                     status) );
02748 
02749         <span class="keywordflow">return</span>;
02750     }
02751 
02752     valueInfoLength = <span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <a class="code" href="../../d2/d1/pnpmap_8c.html#a7">DEFAULT_STRING_SIZE</a>;
02753     valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueInfoLength);
02754 
02755     <span class="keywordflow">if</span> (valueInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
02756 
02757         ZwClose( logConfKey );
02758 
02759         <span class="keywordflow">return</span>;
02760     }
02761 
02762     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;valueName, REGSTR_VAL_BOOTCONFIG );
02763 
02764     status = ZwQueryValueKey( logConfKey,
02765                               &amp;valueName,
02766                               KeyValuePartialInformation,
02767                               valueInfo,
02768                               valueInfoLength,
02769                               &amp;returnedLength);
02770 
02771     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02772 
02773         <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL || status == STATUS_BUFFER_OVERFLOW) {
02774 
02775             <span class="comment">//</span>
02776             <span class="comment">// The default buffer was too small, free it and reallocate</span>
02777             <span class="comment">// it to the required size.</span>
02778             <span class="comment">//</span>
02779             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueInfo );
02780 
02781             valueInfoLength = returnedLength;
02782             valueInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, valueInfoLength );
02783 
02784             <span class="keywordflow">if</span> (valueInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
02785 
02786                 status = ZwQueryValueKey( logConfKey,
02787                                           &amp;valueName,
02788                                           KeyValuePartialInformation,
02789                                           valueInfo,
02790                                           valueInfoLength,
02791                                           &amp;returnedLength );
02792 
02793                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02794                     <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02795                                 <span class="stringliteral">"Could not query registry value %S\\%S\\LogConf\\BootConfig, status = %8.8X\n"</span>,
02796                                 <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
02797                                 DevNodeInfo-&gt;Replaces,
02798                                 status) );
02799 
02800                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( valueInfo );
02801 
02802                     ZwClose( logConfKey );
02803 
02804                     <span class="keywordflow">return</span>;
02805                 }
02806             } <span class="keywordflow">else</span> {
02807 
02808                 <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02809                             <span class="stringliteral">"Could not allocate memory for BootConfig value\n"</span>
02810                             ) );
02811 
02812                 ZwClose( logConfKey );
02813 
02814                 <span class="keywordflow">return</span>;
02815             }
02816         }
02817     }
02818 
02819     partialResourceList = &amp;((PCM_RESOURCE_LIST)valueInfo-&gt;Data)-&gt;List[0].PartialResourceList;
02820 
02821     partialDescriptor = &amp;partialResourceList-&gt;PartialDescriptors[0];
02822 
02823     <span class="keywordflow">for</span> ( index = 0; index &lt; partialResourceList-&gt;Count; index++ ) {
02824         <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypePort) {
02825             partialDescriptor-&gt;Flags &amp;= ~<a class="code" href="../../d2/d1/pnpmap_8c.html#a15">DECODE_FLAGS</a>;
02826             partialDescriptor-&gt;Flags |= flags;
02827         }
02828         partialDescriptor++;
02829     }
02830 
02831     status = ZwSetValueKey( logConfKey,
02832                             &amp;valueName,
02833                             0,
02834                             REG_RESOURCE_LIST,
02835                             valueInfo-&gt;Data,
02836                             valueInfo-&gt;DataLength );
02837 
02838     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02839         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02840                     <span class="stringliteral">"Could not set registry value %S\\%S\\LogConf\\BootConfig, status = %8.8X\n"</span>,
02841                     <a class="code" href="../../d2/d1/pnpmap_8c.html#a2">ENUMROOT_KEY_NAME</a>,
02842                     DevNodeInfo-&gt;Replaces,
02843                     status) );
02844     }
02845 
02846     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(valueInfo);
02847 
02848     ZwClose(logConfKey);
02849 }
02850 
02851 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02852"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a47">02852</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a47">PnPBiosCheckForHardwareDisabled</a>(
02853     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResourceList,
02854     IN OUT PBOOLEAN Disabled
02855     )
02856 <span class="comment">/*++</span>
02857 <span class="comment"></span>
02858 <span class="comment">Routine Description:</span>
02859 <span class="comment"></span>
02860 <span class="comment">    If this device has been assigned one or more resources, and each resource has a length of zero, then it is</span>
02861 <span class="comment">    hardware disabled.</span>
02862 <span class="comment"></span>
02863 <span class="comment">Arguments:</span>
02864 <span class="comment"></span>
02865 <span class="comment">    IoResourceList - Resource obtained from BIOS that we're about to map to a CmResourceList</span>
02866 <span class="comment"></span>
02867 <span class="comment">    Disabled - Set to TRUE if the device is deemed to be disabled</span>
02868 <span class="comment"></span>
02869 <span class="comment">Return Value:</span>
02870 <span class="comment"></span>
02871 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
02872 <span class="comment"></span>
02873 <span class="comment">--*/</span>
02874 {
02875     BOOLEAN ParsedResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02876     PIO_RESOURCE_DESCRIPTOR ioDescriptor;
02877     ULONG descIndex;
02878     <span class="comment">//</span>
02879     <span class="comment">// Since this routine is only used to translate the allocated resources</span>
02880     <span class="comment">// returned by the PnP BIOS, we can assume that there is only 1 alternative</span>
02881     <span class="comment">// list</span>
02882     <span class="comment">//</span>
02883 
02884     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoResourceList-&gt;AlternativeLists == 1);
02885     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disabled != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02886 
02887     *Disabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02888 
02889     <span class="comment">//</span>
02890     <span class="comment">// Translate each resource descriptor, currently we only handle ports,</span>
02891     <span class="comment">// memory, interrupts, and dma.  The current implementation of the routine</span>
02892     <span class="comment">// which converts from ISA PnP Resource data to IO_RESOURCE_REQUIREMENTS</span>
02893     <span class="comment">// won't generate any other descriptor types given the data returned from</span>
02894     <span class="comment">// the BIOS.</span>
02895     <span class="comment">//</span>
02896 
02897     <span class="keywordflow">for</span> (descIndex = 0; descIndex &lt; IoResourceList-&gt;List[ 0 ].Count; descIndex++) {
02898 
02899         ioDescriptor = &amp;IoResourceList-&gt;List[ 0 ].Descriptors[ descIndex ];
02900 
02901         <span class="keywordflow">switch</span> (ioDescriptor-&gt;Type) {
02902 
02903         <span class="keywordflow">case</span> CmResourceTypePort:
02904             <span class="keywordflow">if</span> (ioDescriptor-&gt;u.Port.Length) {
02905                 <span class="keywordflow">return</span> STATUS_SUCCESS;
02906             }
02907             ParsedResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02908             <span class="keywordflow">break</span>;
02909 
02910         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
02911             <span class="keywordflow">if</span> (ioDescriptor-&gt;u.Interrupt.MinimumVector != (ULONG)(-1)) {
02912                 <span class="keywordflow">return</span> STATUS_SUCCESS;
02913             }
02914             ParsedResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02915             <span class="keywordflow">break</span>;
02916 
02917         <span class="keywordflow">case</span> CmResourceTypeMemory:
02918             <span class="keywordflow">if</span> (ioDescriptor-&gt;u.Memory.Length) {
02919                 <span class="keywordflow">return</span> STATUS_SUCCESS;
02920             }
02921             ParsedResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02922             <span class="keywordflow">break</span>;
02923 
02924         <span class="keywordflow">case</span> CmResourceTypeDma:
02925             <span class="keywordflow">if</span> (ioDescriptor-&gt;u.Dma.MinimumChannel != (ULONG)(-1)) {
02926                 <span class="keywordflow">return</span> STATUS_SUCCESS;
02927             }
02928             ParsedResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02929             <span class="keywordflow">break</span>;
02930 
02931         <span class="keywordflow">default</span>:
02932             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>( (MAPPER_ERROR,
02933                         <span class="stringliteral">"Unexpected ResourceType (%d) in I/O Descriptor\n"</span>,
02934                         ioDescriptor-&gt;Type) );
02935 
02936 <span class="preprocessor">#if DBG</span>
02937 <span class="preprocessor"></span>            <span class="comment">// DbgBreakPoint();</span>
02938 <span class="preprocessor">#endif</span>
02939 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
02940         }
02941     }
02942 
02943     <span class="keywordflow">if</span> (ParsedResource) {
02944         <span class="comment">//</span>
02945         <span class="comment">// at least one empty resource, no non-empty resources</span>
02946         <span class="comment">//</span>
02947         *Disabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02948     }
02949 
02950     <span class="keywordflow">return</span> STATUS_SUCCESS;
02951 
02952 }
02953 
02954 
02955 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02956"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a46">02956</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a46">PnPBiosFreeDevNodeInfo</a>(
02957     IN PBIOS_DEVNODE_INFO DevNodeInfoList,
02958     IN ULONG NumberNodes
02959     )
02960 <span class="comment">/*++</span>
02961 <span class="comment"></span>
02962 <span class="comment">Routine Description:</span>
02963 <span class="comment"></span>
02964 <span class="comment">    Free the dynamically allocated DevNodeInfoList as well as any dynamically</span>
02965 <span class="comment">    allocated dependent structures.</span>
02966 <span class="comment"></span>
02967 <span class="comment">Arguments:</span>
02968 <span class="comment"></span>
02969 <span class="comment">    DevNodeInfoList - Array of BIOS_DEVNODE_INFO structures, one for each device</span>
02970 <span class="comment">        reported by the BIOS.</span>
02971 <span class="comment"></span>
02972 <span class="comment">    NumberNodes - Number of BIOS_DEVNODE_INFO elements pointed to by</span>
02973 <span class="comment">        DevNodeInfoList.</span>
02974 <span class="comment"></span>
02975 <span class="comment">Return Value:</span>
02976 <span class="comment"></span>
02977 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
02978 <span class="comment"></span>
02979 <span class="comment">--*/</span>
02980 {
02981     ULONG   nodeIndex;
02982 
02983     <span class="keywordflow">for</span> (nodeIndex = 0; nodeIndex &lt; NumberNodes; nodeIndex++) {
02984 
02985         <span class="keywordflow">if</span> (DevNodeInfoList[nodeIndex].Replaces != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02986             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DevNodeInfoList[nodeIndex].Replaces );
02987         }
02988 
02989         <span class="keywordflow">if</span> (DevNodeInfoList[nodeIndex].CompatibleIDs != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02990             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DevNodeInfoList[nodeIndex].CompatibleIDs );
02991         }
02992 
02993         <span class="keywordflow">if</span> (DevNodeInfoList[nodeIndex].BootConfig != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02994             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DevNodeInfoList[nodeIndex].BootConfig );
02995         }
02996 
02997         <span class="keywordflow">if</span> (DevNodeInfoList[nodeIndex].BasicConfig != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02998             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DevNodeInfoList[nodeIndex].BasicConfig );
02999         }
03000     }
03001 
03002     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DevNodeInfoList );
03003 
03004     <span class="keywordflow">return</span> STATUS_SUCCESS;
03005 }
03006 
03007 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03008"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a58">03008</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a58">PnPBiosMapper</a>()
03009 <span class="comment">/*++</span>
03010 <span class="comment"></span>
03011 <span class="comment">Routine Description:</span>
03012 <span class="comment"></span>
03013 <span class="comment">    Map the information provided from the PnP BIOS and stored in the registry by</span>
03014 <span class="comment">    NTDETECT into root enumerated devices.</span>
03015 <span class="comment"></span>
03016 <span class="comment">Arguments:</span>
03017 <span class="comment"></span>
03018 <span class="comment">    NONE</span>
03019 <span class="comment"></span>
03020 <span class="comment">Return Value:</span>
03021 <span class="comment"></span>
03022 <span class="comment">    STATUS_SUCCESS if no errors, otherwise the appropriate error.</span>
03023 <span class="comment"></span>
03024 <span class="comment">--*/</span>
03025 {
03026     PCM_RESOURCE_LIST   biosInfo;
03027     ULONG               length;
03028     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
03029     <a class="code" href="../../d2/d1/pnpmap_8c.html#a35">PBIOS_DEVNODE_INFO</a>  devNodeInfoList;
03030     ULONG               numberNodes;
03031 
03032     status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a52">PnPBiosGetBiosInfo</a>( &amp;biosInfo, &amp;length );
03033 
03034     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03035 
03036         <span class="keywordflow">return</span> status;
03037     }
03038 
03039     status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a40">PnPBiosTranslateInfo</a>( biosInfo,
03040                                    length,
03041                                    &amp;devNodeInfoList,
03042                                    &amp;numberNodes );
03043 
03044     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( biosInfo );
03045 
03046     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03047 
03048         <span class="keywordflow">return</span> status;
03049     }
03050 
03051     status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a42">PnPBiosEliminateDupes</a>( devNodeInfoList, numberNodes );
03052 
03053     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03054 
03055         status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a44">PnPBiosWriteInfo</a>( devNodeInfoList, numberNodes );
03056 
03057     }
03058 
03059     <a class="code" href="../../d2/d1/pnpmap_8c.html#a46">PnPBiosFreeDevNodeInfo</a>( devNodeInfoList, numberNodes );
03060 
03061     <span class="keywordflow">return</span> status;
03062 }
03063 
03064 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03065"></a><a class="code" href="../../d2/d1/pnpmap_8c.html#a50">03065</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a50">PpFilterNtResource</a> (
03066     IN PWCHAR PnpDeviceName,
03067     PIO_RESOURCE_REQUIREMENTS_LIST ResReqList
03068 )
03069 {
03070     PIO_RESOURCE_LIST ioResourceList;
03071     PIO_RESOURCE_DESCRIPTOR ioResourceDescriptors;
03072 
03073     <span class="keywordflow">if</span> (ResReqList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03074         <span class="keywordflow">return</span>;
03075     }
03076 
03077     <span class="keywordflow">if</span> (IsNEC_98) {
03078         <span class="keywordflow">return</span>;
03079     }
03080 
03081 <span class="preprocessor">#if 0 //_X86_</span>
03082 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> == MACHINE_TYPE_EISA) {
03083 
03084         PCM_FULL_RESOURCE_DESCRIPTOR    fullDescriptor;
03085         PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
03086         PUCHAR                          nextDescriptor;
03087         ULONG                           j;
03088         ULONG                           lastResourceIndex;
03089 
03090         fullDescriptor = &amp;ResourceList-&gt;List[0];
03091 
03092         <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
03093 
03094             partialResourceList = &amp;fullDescriptor-&gt;PartialResourceList;
03095 
03096             <span class="keywordflow">for</span> (j = 0; j &lt; partialResourceList-&gt;Count; j++) {
03097                 partialDescriptor = &amp;partialResourceList-&gt;PartialDescriptors[j];
03098 
03099                 <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypePort) {
03100                     <span class="keywordflow">if</span> (partialDescriptor-&gt;u.Port.Start.HighPart == 0 &amp;&amp;
03101                         (partialDescriptor-&gt;u.Port.Start.LowPart &amp; 0x00000300) == 0) {
03102                         partialDescriptor-&gt;Flags |= CM_RESOURCE_PORT_16_BIT_DECODE;
03103                     }
03104                 }
03105             }
03106 
03107             nextDescriptor = (PUCHAR)fullDescriptor + <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR);
03108 
03109             <span class="comment">//</span>
03110             <span class="comment">// account for any resource descriptors in addition to the single</span>
03111             <span class="comment">// imbedded one I've already accounted for (if there aren't any,</span>
03112             <span class="comment">// then I'll end up subtracting off the extra imbedded descriptor</span>
03113             <span class="comment">// from the previous step)</span>
03114             <span class="comment">//</span>
03115             <span class="comment">//</span>
03116             <span class="comment">// finally, account for any extra device specific data at the end of</span>
03117             <span class="comment">// the last partial resource descriptor (if any)</span>
03118             <span class="comment">//</span>
03119             <span class="keywordflow">if</span> (partialResourceList-&gt;Count &gt; 0) {
03120 
03121                 nextDescriptor += (partialResourceList-&gt;Count - 1) *
03122                      <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
03123 
03124                 lastResourceIndex = partialResourceList-&gt;Count - 1;
03125 
03126                 <span class="keywordflow">if</span> (partialResourceList-&gt;PartialDescriptors[lastResourceIndex].Type ==
03127                           CmResourceTypeDeviceSpecific) {
03128 
03129                     nextDescriptor += partialResourceList-&gt;PartialDescriptors[lastResourceIndex].
03130                                u.DeviceSpecificData.DataSize;
03131                 }
03132             }
03133 
03134             fullDescriptor = (PCM_FULL_RESOURCE_DESCRIPTOR)nextDescriptor;
03135         }
03136     }
03137 <span class="preprocessor">#endif</span>
03138 <span class="preprocessor"></span>
03139     <span class="keywordflow">if</span> (RtlCompareMemory(PnpDeviceName,
03140                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP06"</span>,
03141                          <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP06"</span>) - <span class="keyword">sizeof</span>(WCHAR)) ==
03142                          <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"*PNP06"</span>) - <span class="keyword">sizeof</span>(WCHAR)) {
03143 
03144         ULONG i, j;
03145 
03146         ioResourceList = ResReqList-&gt;List;
03147 
03148         <span class="keywordflow">for</span> (j = 0; j &lt; ResReqList-&gt;AlternativeLists; j++) {
03149 
03150             ioResourceDescriptors = ioResourceList-&gt;Descriptors;
03151 
03152             <span class="keywordflow">for</span> (i = 0; i &lt; ioResourceList-&gt;Count; i++) {
03153 
03154                 <span class="keywordflow">if</span> (ioResourceDescriptors[i].Type == CmResourceTypePort) {
03155 
03156                     <span class="comment">//</span>
03157                     <span class="comment">// some bios asks for 1 too many io port for ide channel</span>
03158                     <span class="comment">//</span>
03159                     <span class="keywordflow">if</span> ((ioResourceDescriptors[i].u.Port.Length == 2) &amp;&amp;
03160                             (ioResourceDescriptors[i].u.Port.MaximumAddress.QuadPart ==
03161                             (ioResourceDescriptors[i].u.Port.MinimumAddress.QuadPart + 1))) {
03162 
03163                             ioResourceDescriptors[i].u.Port.Length = 1;
03164                         ioResourceDescriptors[i].u.Port.MaximumAddress =
03165                             ioResourceDescriptors[i].u.Port.MinimumAddress;
03166                     }
03167                 }
03168             }
03169 
03170             ioResourceList = (PIO_RESOURCE_LIST) (ioResourceDescriptors + ioResourceList-&gt;Count);
03171         }
03172     }
03173 }
03174 
03175 
03176 
03177 <span class="preprocessor">#if DBG</span>
03178 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03179 PnPBiosDebugPrint(
03180     ULONG  DebugMask,
03181     PCCHAR DebugMessage,
03182     ...
03183     )
03184 
03185 <span class="comment">/*++</span>
03186 <span class="comment"></span>
03187 <span class="comment">Routine Description:</span>
03188 <span class="comment"></span>
03189 <span class="comment">    Debug print for the firmware mapper</span>
03190 <span class="comment"></span>
03191 <span class="comment">Arguments:</span>
03192 <span class="comment"></span>
03193 <span class="comment">    Check the mask value to see if the debug message is requested.</span>
03194 <span class="comment"></span>
03195 <span class="comment">Return Value:</span>
03196 <span class="comment"></span>
03197 <span class="comment">    None</span>
03198 <span class="comment"></span>
03199 <span class="comment">--*/</span>
03200 
03201 {
03202     va_list ap;
03203     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>    buffer[256];
03204 
03205     va_start( ap, DebugMessage );
03206 
03207 <span class="preprocessor">#define DBG_MSG_PREFIX  "BiosMapper: "</span>
03208 <span class="preprocessor"></span>
03209     strcpy(buffer, DBG_MSG_PREFIX);
03210 
03211     <span class="keywordflow">if</span> ( DebugMask &amp; PnPBiosMapperDebugMask ) {
03212 
03213         _vsnprintf( &amp;buffer[<span class="keyword">sizeof</span>(DBG_MSG_PREFIX) - 1],
03214                    <span class="keyword">sizeof</span>(buffer) - <span class="keyword">sizeof</span>(DBG_MSG_PREFIX),
03215                    DebugMessage,
03216                    ap );
03217 
03218         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( buffer );
03219     }
03220 
03221     va_end(ap);
03222 
03223 }
03224 <span class="preprocessor">#endif</span>
03225 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
