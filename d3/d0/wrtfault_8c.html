<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wrtfault.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wrtfault.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d4/d9/wrtfault_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d0/wrtfault_8c.html#a0">MiCopyOnWrite</a> (IN PVOID FaultingAddress, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="wrtfault.c::MiCopyOnWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FASTCALL MiCopyOnWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FaultingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">25</a> of file <a class="el" href="../../d4/d9/wrtfault_8c-source.html">wrtfault.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00459">_MMINFO_COUNTERS::CopyOnWriteCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01585">_MMWSLE::e1</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00219">_EPROCESS::ForkInProgress</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01165">MI_GET_SECONDARY_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00775">MI_MAKE_PROTECT_NOT_WRITE_COPY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01313">MI_SET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02513">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01745">MiDecrementCloneBlockReference()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a968">MiFormatPte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03764">MiInitializeCopyOnWritePfn()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00715">MiLocateCloneAddress</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01980">MiWaitForForkToComplete()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00165">MM_DBG_PTE_UPDATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00164">MM_DBG_WRITEFAULT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00475">MmInfoCounters</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00230">_EPROCESS::NumberOfPrivatePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02206">PERFINFO_PRIVATE_COPY_ON_WRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01571">_MMWSLENTRY::Protection</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, and <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>.
<p>
<pre class="fragment"><div>00032                    :
00033 
00034     This routine performs a copy on write operation <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00035     <span class="keyword">virtual</span> address.
00036 
00037 Arguments:
00038 
00039     FaultingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00040                       fault.
00041 
00042     PointerPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE which caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00043                  page fault.
00044 
00045 
00046 Return Value:
00047 
00048     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fault handling operation.  Can be one of:
00049         - Success.
00050         - In-page <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>.
00051 
00052 Environment:
00053 
00054     Kernel mode, APC's disabled, Working set mutex held.
00055 
00056 --*/
00057 
00058 {
00059     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00060     PFN_NUMBER PageFrameIndex;
00061     PFN_NUMBER NewPageIndex;
00062     PULONG CopyTo;
00063     PULONG CopyFrom;
00064     KIRQL OldIrql;
00065     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00066 <span class="comment">//    PMMPTE PointerPde;</span>
00067     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00068     <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneBlock;
00069     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> CloneDescriptor;
00070     PVOID VirtualAddress;
00071     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00072     LOGICAL FakeCopyOnWrite;
00073 
00074     FakeCopyOnWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00075 
00076     <span class="comment">//</span>
00077     <span class="comment">// This is called from MmAccessFault, the PointerPte is valid</span>
00078     <span class="comment">// and the working set mutex ensures it cannot change state.</span>
00079     <span class="comment">//</span>
00080 
00081 <span class="preprocessor">#if DBG</span>
00082 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a56">MM_DBG_WRITEFAULT</a>) {
00083         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**copy on write Fault va %lx proc %lx thread %lx\n"</span>,
00084             (ULONG_PTR)FaultingAddress,
00085             (ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), (ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>());
00086     }
00087 
00088     <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
00089         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
00090     }
00091 <span class="preprocessor">#endif //DBG</span>
00092 <span class="preprocessor"></span>
00093     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ForkInProgress == NULL);
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">// Capture the PTE contents to TempPte.</span>
00097     <span class="comment">//</span>
00098 
00099     TempPte = *PointerPte;
00100 
00101     <span class="comment">//</span>
00102     <span class="comment">// Check to see if this is a prototype PTE with copy on write</span>
00103     <span class="comment">// enabled.</span>
00104     <span class="comment">//</span>
00105 
00106     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0) {
00107 
00108         <span class="comment">//</span>
00109         <span class="comment">// This is a fork page which is being made private in order</span>
00110         <span class="comment">// to change the protection of the page.</span>
00111         <span class="comment">// Do not make the page writable.</span>
00112         <span class="comment">//</span>
00113 
00114         FakeCopyOnWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00115     }
00116 
00117     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
00118     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00119     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">// Acquire the PFN mutex.</span>
00123     <span class="comment">//</span>
00124 
00125     VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00126     WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (VirtualAddress, MmWorkingSetList,
00127                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
00128 
00129     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// The page must be copied into a new page.</span>
00133     <span class="comment">//</span>
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">// If a fork operation is in progress and the faulting thread</span>
00137     <span class="comment">// is not the thread performing the fork operation, block until</span>
00138     <span class="comment">// the fork is completed.</span>
00139     <span class="comment">//</span>
00140 
00141     <span class="keywordflow">if</span> ((CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00142         (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> != <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) {
00143         <a class="code" href="../../d4/d8/mi_8h.html#a855">MiWaitForForkToComplete</a> (CurrentProcess);
00144         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00145         <span class="keywordflow">return</span> STATUS_SUCCESS;
00146     }
00147 
00148     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a>(CurrentProcess, NULL)) {
00149 
00150         <span class="comment">//</span>
00151         <span class="comment">// A wait operation was performed to obtain an available</span>
00152         <span class="comment">// page and the working set mutex and pfn mutexes have</span>
00153         <span class="comment">// been released and various things may have changed for</span>
00154         <span class="comment">// the worse.  Rather than examine all the conditions again,</span>
00155         <span class="comment">// return and if things are still proper, the fault we</span>
00156         <span class="comment">// be taken again.</span>
00157         <span class="comment">//</span>
00158 
00159         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00160         <span class="keywordflow">return</span> STATUS_SUCCESS;
00161     }
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">// Increment the number of private pages.</span>
00165     <span class="comment">//</span>
00166 
00167     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
00168 
00169     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o1">CopyOnWriteCount</a> += 1;
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">// A page is being copied and made private, the global state of</span>
00173     <span class="comment">// the shared page needs to be updated at this point on certain</span>
00174     <span class="comment">// hardware.  This is done by ORing the dirty bit into the modify bit in</span>
00175     <span class="comment">// the PFN element.</span>
00176     <span class="comment">//</span>
00177 
00178     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (PointerPte, Pfn1);
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">// This must be a prototype PTE.  Perform the copy on write.</span>
00182     <span class="comment">//</span>
00183 
00184 <span class="preprocessor">#if DBG</span>
00185 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0) {
00186         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"writefault - PTE indicates cow but not protopte\n"</span>);
00187         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
00188         <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a>(Pfn1);
00189     }
00190 <span class="preprocessor">#endif</span>
00191 <span class="preprocessor"></span>
00192     CloneBlock = (<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">// If the share count for the physical page is one, the reference</span>
00196     <span class="comment">// count is one, and the modified flag is clear the current page</span>
00197     <span class="comment">// can be stolen to satisfy the copy on write.</span>
00198     <span class="comment">//</span>
00199 
00200 <span class="preprocessor">#if 0</span>
00201 <span class="preprocessor"></span><span class="comment">// COMMENTED OUT ****************************************************</span>
00202 <span class="comment">// COMMENTED OUT ****************************************************</span>
00203 <span class="comment">// COMMENTED OUT ****************************************************</span>
00204     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1) &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
00205             &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 0)) {
00206 
00207         <span class="comment">//</span>
00208         <span class="comment">// Make this page a private page and return the prototype</span>
00209         <span class="comment">// PTE into its original contents.  The PFN database for</span>
00210         <span class="comment">// this page now points to this PTE.</span>
00211         <span class="comment">//</span>
00212 
00213         <span class="comment">//</span>
00214         <span class="comment">// Note that a page fault could occur referencing the prototype</span>
00215         <span class="comment">// PTE, so we map it into hyperspace to prevent a fault.</span>
00216         <span class="comment">//</span>
00217 
00218         MiRestorePrototypePte (Pfn1);
00219 
00220         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">// Get the protection for the page.</span>
00224         <span class="comment">//</span>
00225 
00226         VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00227         WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (VirtualAddress, MmWorkingSetList,
00228                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
00229 
00230         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex != WSLE_NULL_INDEX) {
00231 
00232         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00233         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
00234                 <a class="code" href="../../d4/d8/mi_8h.html#a112">MI_MAKE_PROTECT_NOT_WRITE_COPY</a> (
00235                                 MmWsle[WorkingSetIndex].u1.e1.Protection);
00236 
00237         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
00238         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte = 0;
00239         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde);
00240 
00241         <span class="keywordflow">if</span> (!FakeCopyOnWrite) {
00242 
00243             <span class="comment">//</span>
00244             <span class="comment">// If the page was Copy On Write and stolen or if the page was not</span>
00245             <span class="comment">// copy on write, update the PTE setting both the dirty bit and the</span>
00246             <span class="comment">// accessed bit. Note, that as this PTE is in the TB, the TB must</span>
00247             <span class="comment">// be flushed.</span>
00248             <span class="comment">//</span>
00249 
00250             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
00251             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 1;
00252             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (&amp;TempPte, 1);
00253             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite = 0;
00254             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a> (PointerPte, TempPte);
00255 
00256             <span class="comment">//</span>
00257             <span class="comment">// This is a copy on write operation, set the modify bit</span>
00258             <span class="comment">// in the PFN database and deallocate any page file space.</span>
00259             <span class="comment">//</span>
00260 
00261             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
00262 
00263             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00264                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
00265 
00266                 <span class="comment">//</span>
00267                 <span class="comment">// This page is in page file format, deallocate the page</span>
00268                 <span class="comment">// file space.</span>
00269                 <span class="comment">//</span>
00270 
00271                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00272 
00273                 <span class="comment">//</span>
00274                 <span class="comment">// Change original PTE to indicate no page file space is</span>
00275                 <span class="comment">// reserved, otherwise the space will be deallocated when</span>
00276                 <span class="comment">// the PTE is deleted.</span>
00277                 <span class="comment">//</span>
00278 
00279                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
00280             }
00281         }
00282 
00283         <span class="comment">//</span>
00284         <span class="comment">// The TB entry must be flushed as the valid PTE with the dirty</span>
00285         <span class="comment">// bit clear has been fetched into the TB. If it isn't flushed,</span>
00286         <span class="comment">// another fault is generated as the dirty bit is not set in</span>
00287         <span class="comment">// the cached TB entry.</span>
00288         <span class="comment">//</span>
00289 
00290 
00291         KeFillEntryTb ((PHARDWARE_PTE)PointerPte, FaultingAddress, TRUE);
00292 
00293         CloneDescriptor = <a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)CloneBlock);
00294 
00295         <span class="keywordflow">if</span> (CloneDescriptor != (<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00296 
00297             <span class="comment">//</span>
00298             <span class="comment">// Decrement the reference count for the clone block,</span>
00299             <span class="comment">// note that this could release and reacquire</span>
00300             <span class="comment">// the mutexes.</span>
00301             <span class="comment">//</span>
00302 
00303             <a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> ( CloneDescriptor,
00304                                              CloneBlock,
00305                                              CurrentProcess );
00306         }
00307 
00308     ] <span class="keywordflow">else</span> [
00309 
00310 <span class="comment">// ABOVE COMMENTED OUT ****************************************************</span>
00311 <span class="comment">// ABOVE COMMENTED OUT ****************************************************</span>
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <span class="comment">//</span>
00315     <span class="comment">// Get a new page with the same color as this page.</span>
00316     <span class="comment">//</span>
00317 
00318     NewPageIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
00319                     MI_GET_SECONDARY_COLOR (PageFrameIndex,
00320                                             Pfn1));
00321     <a class="code" href="../../d8/d2/pagfault_8c.html#a25">MiInitializeCopyOnWritePfn</a> (NewPageIndex, PointerPte, WorkingSetIndex, NULL);
00322 
00323     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00324 
00325     CopyTo = (PULONG)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (NewPageIndex, &amp;OldIrql);
00326 
00327 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00328 <span class="preprocessor"></span>
00329     <span class="comment">//</span>
00330     <span class="comment">// Should avoid accessing the user space. Accessing the user space may potentially </span>
00331     <span class="comment">// cause a page fault on the alternate table.   </span>
00332     <span class="comment">//</span>
00333 
00334     CopyFrom = KSEG_ADDRESS(PointerPte-&gt;u.Hard.PageFrameNumber);
00335 
00336 <span class="preprocessor">#else</span>
00337 <span class="preprocessor"></span>    CopyFrom = (PULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00338 <span class="preprocessor">#endif</span>
00339 <span class="preprocessor"></span>
00340     RtlCopyMemory ( CopyTo, CopyFrom, PAGE_SIZE);
00341 
00342     <a class="code" href="../../d2/d1/mm_8h.html#a85">PERFINFO_PRIVATE_COPY_ON_WRITE</a>(CopyFrom, PAGE_SIZE);
00343 
00344     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
00345 
00346     <span class="keywordflow">if</span> (!FakeCopyOnWrite) {
00347 
00348         <span class="comment">//</span>
00349         <span class="comment">// If the page was really a copy on write page, make it</span>
00350         <span class="comment">// accessed, dirty and writable.  Also, clear the copy-on-write</span>
00351         <span class="comment">// bit in the PTE.</span>
00352         <span class="comment">//</span>
00353 
00354         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
00355         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 1;
00356         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (&amp;TempPte, 1);
00357         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite = 0;
00358         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NewPageIndex;
00359 
00360     } <span class="keywordflow">else</span> {
00361 
00362         <span class="comment">//</span>
00363         <span class="comment">// The page was not really a copy on write, just change</span>
00364         <span class="comment">// the frame field of the PTE.</span>
00365         <span class="comment">//</span>
00366 
00367         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NewPageIndex;
00368     }
00369 
00370     <span class="comment">//</span>
00371     <span class="comment">// If the modify bit is set in the PFN database for the</span>
00372     <span class="comment">// page, the data cache must be flushed.  This is due to the</span>
00373     <span class="comment">// fact that this process may have been cloned and the cache</span>
00374     <span class="comment">// still contains stale data destined for the page we are</span>
00375     <span class="comment">// going to remove.</span>
00376     <span class="comment">//</span>
00377 
00378     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00379 
00380     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">// Flush the TB entry for this page.</span>
00384     <span class="comment">//</span>
00385 
00386     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (FaultingAddress,
00387                      TRUE,
00388                      FALSE,
00389                      (PHARDWARE_PTE)PointerPte,
00390                      TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// Decrement the share count for the page which was copied</span>
00394     <span class="comment">// as this pte no longer refers to it.</span>
00395     <span class="comment">//</span>
00396 
00397     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
00398 
00399     CloneDescriptor = <a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)CloneBlock);
00400 
00401     <span class="keywordflow">if</span> (CloneDescriptor != (<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00402 
00403         <span class="comment">//</span>
00404         <span class="comment">// Decrement the reference count for the clone block,</span>
00405         <span class="comment">// note that this could release and reacquire</span>
00406         <span class="comment">// the mutexes.</span>
00407         <span class="comment">//</span>
00408 
00409         <a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> ( CloneDescriptor,
00410                                          CloneBlock,
00411                                          CurrentProcess );
00412     }
00413 
00414     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00415     <span class="keywordflow">return</span> STATUS_SUCCESS;
00416 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
