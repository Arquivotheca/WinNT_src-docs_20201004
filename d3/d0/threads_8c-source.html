<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: threads.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>threads.c</h1><a href="../../d2/d1/threads_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989-1998 Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    threads.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module defines functions for thread pools. Thread pools can be used for</span>
00012 <span class="comment">    one time execution of tasks, for waits and for one shot or periodic timers.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Gurdeep Singh Pall (gurdeep) Nov 13, 1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    These routines are statically linked in the caller's executable and</span>
00021 <span class="comment">    are callable in only from user mode. They make use of Nt system services.</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">    Aug-19 lokeshs - modifications to thread pool apis.</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 
00031 <span class="comment">// There are 3 types of thread pool functions supported</span>
00032 <span class="comment">//</span>
00033 <span class="comment">// 1. Wait Thread Pool</span>
00034 <span class="comment">// 2. Worker Thread Pool</span>
00035 <span class="comment">// 3. Timer Thread Pool</span>
00036 <span class="comment">//</span>
00037 <span class="comment">// Wait Thread Pool</span>
00038 <span class="comment">// ----------------</span>
00039 <span class="comment">// Clients can submit a waitable object with an optional timeout to wait on. </span>
00040 <span class="comment">// One thread is created per 63 of such waitable objects. These threads are </span>
00041 <span class="comment">// never killed.</span>
00042 <span class="comment">//</span>
00043 <span class="comment">// Worker Thread Pool</span>
00044 <span class="comment">// ------------------</span>
00045 <span class="comment">// Clients can submit functions to be executed by a worker thread. Threads are </span>
00046 <span class="comment">// created if the work queue exceeds a threshold. Clients can request that the </span>
00047 <span class="comment">// function be invoked in the context of a I/O thread. I/O worker threads</span>
00048 <span class="comment">// can be used for initiating asynchronous I/O requests. They are not terminated if</span>
00049 <span class="comment">// there are pending IO requests. Worker threads terminate if inactivity exceeds a </span>
00050 <span class="comment">// threshold.</span>
00051 <span class="comment">// Clients can also associate IO completion requests with the IO completion port</span>
00052 <span class="comment">// waited upon by the non I/O worker threads. One should not post overlapped IO requests</span>
00053 <span class="comment">// in worker threads.</span>
00054 <span class="comment">//</span>
00055 <span class="comment">// Timer Thread Pool</span>
00056 <span class="comment">// -----------------</span>
00057 <span class="comment">// Clients create one or more Timer Queues and insert one shot or periodic </span>
00058 <span class="comment">// timers in them. All timers in a queue are kept in a "Delta List" with each </span>
00059 <span class="comment">// timer's firing time relative to the timer before it. All Queues are also </span>
00060 <span class="comment">// kept in a "Delta List" with each Queue's firing time (set to the firing time </span>
00061 <span class="comment">// of the nearest firing timer) relative to the Queue before it. One NT Timer </span>
00062 <span class="comment">// is used to service all timers in all queues.</span>
00063 
00064 
00065 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00066 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00067 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00068 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00069 <span class="preprocessor">#include "<a class="code" href="../../d3/d1/threads_8h.html">threads.h</a>"</span>
00070 
00071 
<a name="l00072"></a><a class="code" href="../../d2/d1/threads_8c.html#a4">00072</a> ULONG <a class="code" href="../../d2/d1/threads_8c.html#a4">DPRN</a> = 0x0000000;
00073 
00074 
00075 
00076 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00077"></a><a class="code" href="../../d2/d1/threads_8c.html#a5">00077</a> <a class="code" href="../../d2/d1/threads_8c.html#a5">RtlRegisterWait</a> (
00078     OUT PHANDLE WaitHandle,
00079     IN  HANDLE  Handle,
00080     IN  WAITORTIMERCALLBACKFUNC Function,
00081     IN  PVOID Context,
00082     IN  ULONG  Milliseconds,
00083     IN  ULONG  Flags
00084     )
00085 
00086 <span class="comment">/*++</span>
00087 <span class="comment"></span>
00088 <span class="comment">Routine Description:</span>
00089 <span class="comment"></span>
00090 <span class="comment">    This routine adds a new wait request to the pool of objects being waited on.</span>
00091 <span class="comment"></span>
00092 <span class="comment">Arguments:</span>
00093 <span class="comment"></span>
00094 <span class="comment">    WaitHandle - Handle returned on successful completion of this routine.</span>
00095 <span class="comment"></span>
00096 <span class="comment">    Handle - Handle to the object to be waited on</span>
00097 <span class="comment"></span>
00098 <span class="comment">    Function - Routine that is called when the wait completes or a timeout occurs</span>
00099 <span class="comment"></span>
00100 <span class="comment">    Context - Opaque pointer passed in as an argument to Function</span>
00101 <span class="comment"></span>
00102 <span class="comment">    Milliseconds - Timeout for the wait in milliseconds. 0xffffffff means dont </span>
00103 <span class="comment">            timeout.</span>
00104 <span class="comment"></span>
00105 <span class="comment">    Flags - Can be one of:</span>
00106 <span class="comment"></span>
00107 <span class="comment">        WT_EXECUTEINWAITTHREAD - if WorkerProc should be invoked in the wait</span>
00108 <span class="comment">                thread itself. This should only be used for small routines.</span>
00109 <span class="comment">        WT_EXECUTEINIOTHREAD - use only if the WorkerProc should be invoked in</span>
00110 <span class="comment">                an IO Worker thread. Avoid using it.</span>
00111 <span class="comment"></span>
00112 <span class="comment">    If Flags is not WT_EXECUTEINWAITTHREAD, the following flag can also be set:</span>
00113 <span class="comment">    </span>
00114 <span class="comment">        WT_EXECUTELONGFUNCTION - indicates that the callback might be blocked</span>
00115 <span class="comment">                for a long duration. Use only if the callback is being queued to a</span>
00116 <span class="comment">                worker thread.</span>
00117 <span class="comment">    </span>
00118 <span class="comment">Return Value:</span>
00119 <span class="comment"></span>
00120 <span class="comment">    NTSTATUS - Result code from call.  The following are returned</span>
00121 <span class="comment"></span>
00122 <span class="comment">    STATUS_SUCCESS - The registration was successful.</span>
00123 <span class="comment"></span>
00124 <span class="comment">    STATUS_NO_MEMORY - There was not sufficient heap to perform the requested </span>
00125 <span class="comment">                operation.</span>
00126 <span class="comment">                </span>
00127 <span class="comment">    or other NTSTATUS error code</span>
00128 <span class="comment"></span>
00129 <span class="comment">--*/</span>
00130 
00131 {
00132     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait ;
00133     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00134     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
00135     LARGE_INTEGER TimeOut ;
00136     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00137 
00138     *WaitHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00139 
00140     
00141     <span class="comment">// Initialize thread pool if it isnt already done</span>
00142 
00143     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a> != 1) {
00144 
00145         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a32">RtlpInitializeWaitThreadPool</a> () ;
00146 
00147         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00148             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00149     }
00150 
00151 
00152     <span class="comment">// Initialize Wait request</span>
00153 
00154     Wait = (<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>) <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a> ( <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">RTLP_WAIT</a>),
00155                                             HEAP_ZERO_MEMORY) ;
00156 
00157     <span class="keywordflow">if</span> (!Wait) {
00158         <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00159     }
00160     
00161     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o1">WaitHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> ;
00162     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> = Flags ;
00163     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a> = Function ;
00164     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a> = Context ;
00165     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> = Milliseconds ;
00166     <a class="code" href="../../d3/d1/threads_8h.html#a28">SET_SIGNATURE</a>(Wait) ;
00167         
00168     
00169     <span class="comment">// timer part of wait is initialized by wait thread in RtlpAddWait</span>
00170 
00171     
00172     <span class="comment">// Get a wait thread that can accomodate another wait request.</span>
00173     
00174     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a145">RtlpFindWaitThread</a> (&amp;ThreadCB) ;
00175 
00176     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00177     
00178         <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Wait ) ;
00179         
00180         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00181     }
00182 
00183     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a> = ThreadCB ;
00184 
00185 <span class="preprocessor">    #if DBG1</span>
00186 <span class="preprocessor"></span>    Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o10">DbgId</a> = ++<a class="code" href="../../d3/d1/threads_8h.html#a49">NextWaitDbgId</a> ;
00187     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o11">ThreadId</a> = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
00188     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00189     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d:%d&gt; Wait %x created by thread:&lt;%x:%x&gt;\n\n"</span>, 
00190                 Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o10">DbgId</a>, 1, (ULONG_PTR)Wait,
00191                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00192                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00193 <span class="preprocessor">    #endif</span>
00194 <span class="preprocessor"></span>
00195     <span class="comment">// Set the wait handle</span>
00196 
00197     *WaitHandle = Wait ;
00198 
00199 
00200     <span class="comment">// Queue an APC to the Wait Thread</span>
00201 
00202     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
00203                     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>,
00204                     (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a36">RtlpAddWait</a>,
00205                     (PVOID)Wait,
00206                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00207                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00208                     );
00209 
00210 
00211     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00212 
00213         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
00214 
00215     } <span class="keywordflow">else</span> {
00216 
00217         *WaitHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00218         <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Wait ) ;
00219     }
00220 
00221     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00222 
00223 }
00224 
00225 
00226 
00227 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00228"></a><a class="code" href="../../d2/d1/threads_8c.html#a6">00228</a> <a class="code" href="../../d2/d1/threads_8c.html#a6">RtlDeregisterWait</a>(
00229     IN HANDLE WaitHandle
00230     )
00231 <span class="comment">/*++</span>
00232 <span class="comment"></span>
00233 <span class="comment">Routine Description:</span>
00234 <span class="comment"></span>
00235 <span class="comment">    This routine removes the specified wait from the pool of objects being</span>
00236 <span class="comment">    waited on. This routine is non-blocking. Once this call returns, no new</span>
00237 <span class="comment">    Callbacks are invoked. However, Callbacks that might already have been queued</span>
00238 <span class="comment">    to worker threads are not cancelled.</span>
00239 <span class="comment"></span>
00240 <span class="comment">Arguments:</span>
00241 <span class="comment"></span>
00242 <span class="comment">    WaitHandle - Handle indentifying the wait.</span>
00243 <span class="comment"></span>
00244 <span class="comment">Return Value:</span>
00245 <span class="comment"></span>
00246 <span class="comment">    STATUS_SUCCESS - The deregistration was successful.</span>
00247 <span class="comment">    STATUS_PENDING - Some callbacks associated with this Wait, are still executing.</span>
00248 <span class="comment">--*/</span>
00249 
00250 {
00251     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/threads_8c.html#a7">RtlDeregisterWaitEx</a>( WaitHandle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ;    
00252 }
00253 
00254 
00255 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00256"></a><a class="code" href="../../d2/d1/threads_8c.html#a7">00256</a> <a class="code" href="../../d2/d1/threads_8c.html#a7">RtlDeregisterWaitEx</a>(
00257     IN HANDLE WaitHandle,
00258     IN HANDLE Event
00259     )
00260 <span class="comment">/*++</span>
00261 <span class="comment"></span>
00262 <span class="comment">Routine Description:</span>
00263 <span class="comment"></span>
00264 <span class="comment">    This routine removes the specified wait from the pool of objects being</span>
00265 <span class="comment">    waited on. Once this call returns, no new Callbacks will be invoked.</span>
00266 <span class="comment">    Depending on the value of Event, the call can be blocking or non-blocking.</span>
00267 <span class="comment">    Blocking calls MUST NOT be invoked inside the callback routines, except</span>
00268 <span class="comment">    when a callback being executed in the Wait thread context deregisters</span>
00269 <span class="comment">    its associated Wait (in this case there is no reason for making blocking calls),</span>
00270 <span class="comment">    or when a callback queued to a worker thread is deregistering some other wait item</span>
00271 <span class="comment">    (be careful of deadlocks here).</span>
00272 <span class="comment"></span>
00273 <span class="comment">Arguments:</span>
00274 <span class="comment"></span>
00275 <span class="comment">    WaitHandle - Handle indentifying the wait.</span>
00276 <span class="comment"></span>
00277 <span class="comment">    Event - Event to wait upon.</span>
00278 <span class="comment">            (HANDLE)-1: The function creates an event and waits on it.</span>
00279 <span class="comment">            Event : The caller passes an Event. The function removes the wait handle,</span>
00280 <span class="comment">                    but does not wait for all callbacks to complete. The Event is </span>
00281 <span class="comment">                    released after all callbacks have completed.</span>
00282 <span class="comment">            NULL : The function is non-blocking. The function removes the wait handle,</span>
00283 <span class="comment">                    but does not wait for all callbacks to complete.</span>
00284 <span class="comment">            </span>
00285 <span class="comment">Return Value:</span>
00286 <span class="comment"></span>
00287 <span class="comment">    STATUS_SUCCESS - The deregistration was successful.</span>
00288 <span class="comment">    STATUS_PENDING - Some callback is still pending.</span>
00289 <span class="comment"></span>
00290 <span class="comment">--*/</span>
00291 
00292 {
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, StatusAsync = STATUS_SUCCESS ;
00294     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait = (<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>) WaitHandle ;
00295     ULONG CurrentThreadId =  HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
00296     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> CompletionEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00297     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ;
00298     ULONG NonBlocking = ( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> != (HANDLE) -1 ) ; <span class="comment">//The call returns non-blocking</span>
00299 
00300 
00301     <span class="keywordflow">if</span> (!Wait) {
00302         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
00303         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER ;
00304     }
00305     
00306     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a>-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a> ;
00307 
00308     
00309     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( Wait ) ;
00310     <a class="code" href="../../d3/d1/threads_8h.html#a30">SET_DEL_SIGNATURE</a>( Wait ) ;
00311     
00312 <span class="preprocessor">    #if DBG1</span>
00313 <span class="preprocessor"></span>    Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o12">ThreadId2</a> = CurrentThreadId ;
00314 <span class="preprocessor">    #endif</span>
00315 <span class="preprocessor"></span>    
00316     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == (HANDLE)-1) {
00317 
00318         <span class="comment">// Get an event from the event cache</span>
00319 
00320         CompletionEvent = <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> () ;
00321 
00322         <span class="keywordflow">if</span> (!CompletionEvent) {
00323 
00324             <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00325 
00326         }
00327     }
00328 
00329     
00330     Wait = (<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>) WaitHandle ;
00331 
00332 <span class="preprocessor">    #if DBG1</span>
00333 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00334     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d:%d&gt; Wait %x deregistering by thread:&lt;%x:%x&gt;\n\n"</span>, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o10">DbgId</a>, 
00335                 Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a>, (ULONG_PTR)Wait,
00336                 CurrentThreadId,
00337                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00338 <span class="preprocessor">    #endif</span>
00339 <span class="preprocessor"></span>
00340 
00341     Wait-&gt;CompletionEvent = CompletionEvent
00342                             ? CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>
00343                             : <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// RtlDeregisterWaitEx is being called from within the Wait thread callback</span>
00347     <span class="comment">//</span>
00348     
00349     <span class="keywordflow">if</span> ( CurrentThreadId == Wait-&gt;ThreadCB-&gt;ThreadId ) {
00350 
00351         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a131">RtlpDeregisterWait</a> ( Wait, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ;
00352 
00353 
00354         <span class="comment">// all callback functions run in the wait thread. So cannot return PENDING</span>
00355         
00356         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PENDING ) ;
00357           
00358     
00359     } <span class="keywordflow">else</span> {
00360 
00361         <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> PartialCompletionEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00362 
00363         <span class="keywordflow">if</span> (NonBlocking) {
00364         
00365             PartialCompletionEvent = <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> () ;
00366 
00367             <span class="keywordflow">if</span> (!PartialCompletionEvent) {
00368 
00369                 <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00370             }
00371         }
00372         
00373         <span class="comment">// Queue an APC to the Wait Thread</span>
00374         
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
00376                         Wait-&gt;ThreadCB-&gt;ThreadHandle,
00377                         (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a37">RtlpDeregisterWait</a>,
00378                         (PVOID) Wait,
00379                         NonBlocking ? PartialCompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ,
00380                         NonBlocking ? (PVOID)&amp;StatusAsync : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00381                         );
00382                         
00383         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00384 
00385             <span class="keywordflow">if</span> (CompletionEvent) <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
00386             <span class="keywordflow">if</span> (PartialCompletionEvent) <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( PartialCompletionEvent ) ;
00387     
00388             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00389         }
00390 
00391 
00392         <span class="comment">// block till the wait entry has been deactivated</span>
00393         
00394         <span class="keywordflow">if</span> (NonBlocking) {
00395         
00396             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a>( PartialCompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>, <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ) ;
00397         }    
00398 
00399 
00400         <span class="keywordflow">if</span> (PartialCompletionEvent) <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( PartialCompletionEvent ) ;
00401 
00402     }
00403 
00404     <span class="keywordflow">if</span> ( CompletionEvent ) {
00405 
00406         <span class="comment">// wait for Event to be fired. Return if the thread has been killed.</span>
00407 
00408 <span class="preprocessor">        #if DBG1</span>
00409 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00410         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Wait %x deregister waiting ThreadId&lt;%x:%x&gt;\n\n"</span>, 
00411                 (ULONG_PTR)Wait,
00412                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00413                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00414 <span class="preprocessor">        #endif</span>
00415 <span class="preprocessor"></span>        
00416         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a>( CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>, <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ) ;
00417 
00418 <span class="preprocessor">        #if DBG1</span>
00419 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00420         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Wait %x deregister completed\n\n"</span>, (ULONG_PTR)Wait) ;
00421 <span class="preprocessor">        #endif</span>
00422 <span class="preprocessor"></span>
00423         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
00424 
00425         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00426         
00427     } <span class="keywordflow">else</span> {
00428 
00429         <span class="keywordflow">return</span> StatusAsync ;
00430     }
00431 }
00432 
00433 
00434 
00435 
00436 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00437"></a><a class="code" href="../../d2/d1/threads_8c.html#a8">00437</a> <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>(
00438     IN  WORKERCALLBACKFUNC Function,
00439     IN  PVOID Context,
00440     IN  ULONG  Flags
00441     )
00442 
00443 <span class="comment">/*++</span>
00444 <span class="comment"></span>
00445 <span class="comment">Routine Description:</span>
00446 <span class="comment"></span>
00447 <span class="comment">    This routine queues up the request to be executed in a worker thread.</span>
00448 <span class="comment"></span>
00449 <span class="comment">Arguments:</span>
00450 <span class="comment"></span>
00451 <span class="comment">    Function - Routine that is called by the worker thread</span>
00452 <span class="comment"></span>
00453 <span class="comment">    Context - Opaque pointer passed in as an argument to WorkerProc</span>
00454 <span class="comment"></span>
00455 <span class="comment">    Flags - Can be:</span>
00456 <span class="comment"></span>
00457 <span class="comment">            WT_EXECUTEINIOTHREAD - Specifies that the WorkerProc should be invoked</span>
00458 <span class="comment">            by a thread that is never destroyed when there are pending IO requests.</span>
00459 <span class="comment">            This can be used by threads that invoke I/O and/or schedule APCs.</span>
00460 <span class="comment"></span>
00461 <span class="comment">            The below flag can also be set:</span>
00462 <span class="comment">            WT_EXECUTELONGFUNCTION - Specifies that the function might block for a</span>
00463 <span class="comment">            long duration.</span>
00464 <span class="comment"></span>
00465 <span class="comment">Return Value:</span>
00466 <span class="comment"></span>
00467 <span class="comment">    STATUS_SUCCESS - Queued successfully.</span>
00468 <span class="comment"></span>
00469 <span class="comment">    STATUS_NO_MEMORY - There was not sufficient heap to perform the</span>
00470 <span class="comment">        requested operation.</span>
00471 <span class="comment"></span>
00472 <span class="comment">--*/</span>
00473 
00474 {
00475     ULONG Threshold ;
00476     ULONG CurrentTickCount ;
00477     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
00478 
00479     
00480     <span class="comment">// Make sure the worker thread pool is initialized</span>
00481 
00482     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a> != 1) {
00483 
00484         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a24">RtlpInitializeWorkerThreadPool</a> () ;
00485         
00486         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) )
00487             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00488     }
00489 
00490        
00491     <span class="comment">// Take lock for the global worker thread pool</span>
00492 
00493     RtlEnterCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
00494 
00495 
00496     <span class="keywordflow">if</span> (Flags &amp; (WT_EXECUTEINIOTHREAD |WT_EXECUTEINUITHREAD |WT_EXECUTEINPERSISTENTIOTHREAD) ){
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// execute in IO Worker thread</span>
00500         <span class="comment">//</span>
00501 
00502         ULONG NumEffIOWorkerThreads = <a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> ;
00503         ULONG ThreadCreationDampingTime = <a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> &lt; <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a>
00504                                             ? <a class="code" href="../../d3/d1/threads_8h.html#a5">THREAD_CREATION_DAMPING_TIME1</a>
00505                                             : <a class="code" href="../../d3/d1/threads_8h.html#a6">THREAD_CREATION_DAMPING_TIME2</a> ;
00506                                             
00507         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a90">PersistentIOTCB</a> &amp;&amp; (Flags&amp;WT_EXECUTELONGFUNCTION))
00508             NumEffIOWorkerThreads -- ;
00509 
00510         
00511         <span class="comment">// Check if we need to grow I/O worker thread pool</span>
00512 
00513         Threshold = (NumEffIOWorkerThreads &lt; <a class="code" href="../../d3/d1/threads_8h.html#a9">MAX_WORKER_THREADS</a> 
00514                     ? <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * NumEffIOWorkerThreads 
00515                     : 0xffffffff) ;
00516 
00517         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> &gt; <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>())
00518             <a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
00519 
00520         <span class="keywordflow">if</span> (NumEffIOWorkerThreads == 0
00521             || ((<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a> - <a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> &gt; Threshold)
00522                     &amp;&amp; (<a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> + ThreadCreationDampingTime 
00523                         &lt; <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>()))) {
00524 
00525             <span class="comment">// Grow the IO worker thread pool</span>
00526 
00527             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a22">RtlpStartIOWorkerThread</a> () ;
00528 
00529         }
00530 
00531         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00532 
00533             <span class="comment">// Queue the work request</span>
00534 
00535             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a148">RtlpQueueIOWorkerRequest</a> (Function, Context, Flags) ;
00536         }
00537 
00538 
00539     } <span class="keywordflow">else</span> {
00540 
00541         <span class="comment">//</span>
00542         <span class="comment">// execute in regular worker thread</span>
00543         <span class="comment">//</span>
00544 
00545         ULONG NumEffWorkerThreads = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a>) ;
00546         ULONG ThreadCreationDampingTime = <a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt; <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a>
00547                                             ? <a class="code" href="../../d3/d1/threads_8h.html#a5">THREAD_CREATION_DAMPING_TIME1</a>
00548                                             : (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt; 50
00549                                                 ? <a class="code" href="../../d3/d1/threads_8h.html#a6">THREAD_CREATION_DAMPING_TIME2</a>
00550                                                 : <a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt;&lt; 7); <span class="comment">// *100ms</span>
00551 
00552         <span class="comment">// if io completion set, then have 1 more thread</span>
00553         
00554         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a76">NumMinWorkerThreads</a> &amp;&amp; NumEffWorkerThreads)
00555             NumEffWorkerThreads -- ;
00556 
00557 
00558         <span class="comment">// Check if we need to grow worker thread pool</span>
00559 
00560         Threshold = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt; <a class="code" href="../../d3/d1/threads_8h.html#a9">MAX_WORKER_THREADS</a> 
00561                     ? (NumEffWorkerThreads &lt; 7 
00562                         ? NumEffWorkerThreads*NumEffWorkerThreads
00563                         : <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * NumEffWorkerThreads )
00564                     : 0xffffffff) ;
00565 
00566         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> &gt; <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>())
00567             <a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
00568 
00569         <span class="keywordflow">if</span> (NumEffWorkerThreads == 0 ||
00570             ( (<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a> - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> &gt;= Threshold)
00571                     &amp;&amp; (<a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> + ThreadCreationDampingTime 
00572                             &lt; <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>()))) 
00573         {
00574 
00575             <span class="comment">// Grow the worker thread pool</span>
00576 
00577             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a21">RtlpStartWorkerThread</a> () ;
00578 
00579         } 
00580 
00581         <span class="comment">// Queue the work request</span>
00582 
00583         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00584 
00585             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a152">RtlpQueueWorkerRequest</a> (Function, Context, Flags) ;
00586         }
00587 
00588     }
00589 
00590     <span class="comment">// Release lock on the worker thread pool</span>
00591 
00592     RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
00593 
00594     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00595 }
00596 
00597 
00598 
00599 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00600"></a><a class="code" href="../../d2/d1/threads_8c.html#a9">00600</a> <a class="code" href="../../d2/d1/threads_8c.html#a9">RtlSetIoCompletionCallback</a> (
00601     IN  HANDLE  FileHandle,
00602     IN  APC_CALLBACK_FUNCTION  CompletionProc,
00603     IN  ULONG Flags
00604     )
00605 
00606 <span class="comment">/*++</span>
00607 <span class="comment"></span>
00608 <span class="comment">Routine Description:</span>
00609 <span class="comment"></span>
00610 <span class="comment">    This routine binds an Handle and an associated callback function to the</span>
00611 <span class="comment">    IoCompletionPort which queues work items to worker threads.</span>
00612 <span class="comment"></span>
00613 <span class="comment">Arguments:</span>
00614 <span class="comment"></span>
00615 <span class="comment">    Handle - handle to be bound to the IO completion port</span>
00616 <span class="comment">    </span>
00617 <span class="comment">    CompletionProc - callback function to be executed when an IO request</span>
00618 <span class="comment">        pending on the IO handle completes.</span>
00619 <span class="comment"></span>
00620 <span class="comment">    Flags - Reserved. pass 0.</span>
00621 <span class="comment"></span>
00622 <span class="comment">--*/</span>
00623 
00624 {
00625     IO_STATUS_BLOCK IoSb ;
00626     FILE_COMPLETION_INFORMATION CompletionInfo ;
00627     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00628     
00629 
00630     <span class="comment">// Make sure that the worker thread pool is initialized as the file handle</span>
00631     <span class="comment">// is bound to IO completion port.</span>
00632 
00633     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a> != 1) {
00634 
00635         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a24">RtlpInitializeWorkerThreadPool</a> () ;
00636         
00637         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) )
00638             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00639 
00640     }
00641 
00642 
00643     <span class="comment">//</span>
00644     <span class="comment">// from now on NumMinWorkerThreads should be 1. If there is only 1 worker thread</span>
00645     <span class="comment">// create a new one.</span>
00646     <span class="comment">//</span>
00647     
00648     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d1/threads_8h.html#a76">NumMinWorkerThreads</a> == 0 ) {
00649     
00650         <span class="comment">// Take lock for the global worker thread pool</span>
00651 
00652         RtlEnterCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
00653 
00654         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> == 0) {
00655 
00656             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a21">RtlpStartWorkerThread</a> () ;
00657 
00658             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00659             
00660                 RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
00661                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00662             }
00663         }
00664 
00665         <span class="comment">// from now on, there will be at least 1 worker thread</span>
00666         <a class="code" href="../../d3/d1/threads_8h.html#a76">NumMinWorkerThreads</a> = 1 ;
00667         
00668         RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
00669 
00670     }
00671 
00672 
00673     <span class="comment">// bind to IoCompletionPort, which queues work items to worker threads</span>
00674 
00675     CompletionInfo.Port = <a class="code" href="../../d3/d1/threads_8h.html#a91">WorkerCompletionPort</a> ;
00676     CompletionInfo.Key = (PVOID) CompletionProc ;
00677 
00678     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a> (
00679                         FileHandle,
00680                         &amp;IoSb, <span class="comment">//not initialized</span>
00681                         &amp;CompletionInfo,
00682                         <span class="keyword">sizeof</span>(CompletionInfo),
00683                         FileCompletionInformation <span class="comment">//enum flag</span>
00684                         ) ;
00685     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00686 }
00687 
00688 
00689 
00690 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00691"></a><a class="code" href="../../d2/d1/threads_8c.html#a10">00691</a> <a class="code" href="../../d2/d1/threads_8c.html#a10">RtlCreateTimerQueue</a>(
00692     OUT PHANDLE TimerQueueHandle
00693     )
00694 
00695 <span class="comment">/*++</span>
00696 <span class="comment"></span>
00697 <span class="comment">Routine Description:</span>
00698 <span class="comment"></span>
00699 <span class="comment">    This routine creates a queue that can be used to queue time based tasks.</span>
00700 <span class="comment"></span>
00701 <span class="comment">Arguments:</span>
00702 <span class="comment"></span>
00703 <span class="comment">    TimerQueueHandle - Returns back the Handle identifying the timer queue created.</span>
00704 <span class="comment"></span>
00705 <span class="comment">Return Value:</span>
00706 <span class="comment"></span>
00707 <span class="comment">    NTSTATUS - Result code from call.  The following are returned</span>
00708 <span class="comment"></span>
00709 <span class="comment">        STATUS_SUCCESS - Timer Queue created successfully.</span>
00710 <span class="comment"></span>
00711 <span class="comment">        STATUS_NO_MEMORY - There was not sufficient heap to perform the</span>
00712 <span class="comment">            requested operation.</span>
00713 <span class="comment"></span>
00714 <span class="comment">--*/</span>
00715 
00716 {
00717     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
00718     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00719 
00720 
00721     <span class="comment">// Initialize the timer component if it hasnt been done already</span>
00722 
00723     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a> != 1) {
00724 
00725         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a63">RtlpInitializeTimerThreadPool</a> () ;
00726 
00727         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) )
00728             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00729 
00730     }
00731 
00732 
00733     InterlockedIncrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a96">NumTimerQueues</a> ) ;
00734 
00735     
00736     <span class="comment">// Allocate a Queue structure</span>
00737 
00738     Queue = (<a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a>) <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a> (
00739                                       <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d1/threads_8h.html#a3">RTLP_TIMER_QUEUE</a>),
00740                                       HEAP_ZERO_MEMORY
00741                                       ) ;
00742 
00743     <span class="keywordflow">if</span> (Queue == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00744 
00745         InterlockedDecrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a96">NumTimerQueues</a> ) ;
00746         
00747         <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00748     }
00749 
00750     Queue-&gt;RefCount = 1 ;
00751 
00752     
00753     <span class="comment">// Initialize the allocated queue</span>
00754 
00755     InitializeListHead (&amp;Queue-&gt;List) ;
00756     InitializeListHead (&amp;Queue-&gt;TimerList) ;
00757     InitializeListHead (&amp;Queue-&gt;UncancelledTimerList) ;
00758     <a class="code" href="../../d3/d1/threads_8h.html#a28">SET_SIGNATURE</a>( Queue ) ;
00759 
00760     Queue-&gt;DeltaFiringTime = 0 ;
00761 
00762 <span class="preprocessor">    #if DBG1</span>
00763 <span class="preprocessor"></span>    Queue-&gt;DbgId = ++<a class="code" href="../../d3/d1/threads_8h.html#a48">NextTimerDbgId</a> ;
00764     Queue-&gt;ThreadId = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
00765     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00766     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d:%d&gt; TimerQueue %x created by thread:&lt;%x:%x&gt;\n\n"</span>, 
00767                 Queue-&gt;DbgId, 1, (ULONG_PTR)Queue,
00768                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00769                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00770 <span class="preprocessor">    #endif</span>
00771 <span class="preprocessor"></span>    
00772     *TimerQueueHandle = Queue ;
00773     
00774     <span class="keywordflow">return</span> STATUS_SUCCESS ;
00775 }
00776 
00777 
00778 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00779"></a><a class="code" href="../../d2/d1/threads_8c.html#a11">00779</a> <a class="code" href="../../d2/d1/threads_8c.html#a11">RtlDeleteTimerQueue</a>(
00780     IN HANDLE TimerQueueHandle
00781     )
00782 
00783 <span class="comment">/*++</span>
00784 <span class="comment"></span>
00785 <span class="comment">Routine Description:</span>
00786 <span class="comment"></span>
00787 <span class="comment">    This routine deletes a previously created queue. This call is non-blocking and </span>
00788 <span class="comment">    can be made from Callbacks. Pending callbacks already queued to worker threads</span>
00789 <span class="comment">    are not cancelled.</span>
00790 <span class="comment"></span>
00791 <span class="comment">Arguments:</span>
00792 <span class="comment"></span>
00793 <span class="comment">    TimerQueueHandle - Handle identifying the timer queue created.</span>
00794 <span class="comment"></span>
00795 <span class="comment">Return Value:</span>
00796 <span class="comment"></span>
00797 <span class="comment">    NTSTATUS - Result code from call.</span>
00798 <span class="comment"></span>
00799 <span class="comment">        STATUS_PENDING - Timer Queue created successfully.</span>
00800 <span class="comment">        </span>
00801 <span class="comment">--*/</span>
00802 
00803 {
00804     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/threads_8c.html#a12">RtlDeleteTimerQueueEx</a>( TimerQueueHandle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ;
00805 }
00806 
00807 
00808 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00809"></a><a class="code" href="../../d2/d1/threads_8c.html#a12">00809</a> <a class="code" href="../../d2/d1/threads_8c.html#a12">RtlDeleteTimerQueueEx</a> (
00810     HANDLE QueueHandle,
00811     HANDLE Event
00812     )
00813 <span class="comment">/*++</span>
00814 <span class="comment"></span>
00815 <span class="comment">Routine Description:</span>
00816 <span class="comment"></span>
00817 <span class="comment">    This routine deletes the queue specified in the Request and frees all timers.</span>
00818 <span class="comment">    This call is blocking or non-blocking depending on the value passed for Event.</span>
00819 <span class="comment">    Blocking calls cannot be made from ANY Timer callbacks. After this call returns,</span>
00820 <span class="comment">    no new Callbacks will be fired for any timer associated with the queue.</span>
00821 <span class="comment"></span>
00822 <span class="comment">Arguments:</span>
00823 <span class="comment"></span>
00824 <span class="comment">    QueueHandle - queue to delete</span>
00825 <span class="comment"></span>
00826 <span class="comment">    Event - Event to wait upon.</span>
00827 <span class="comment">            (HANDLE)-1: The function creates an event and waits on it.</span>
00828 <span class="comment">            Event : The caller passes an event. The function marks the queue for deletion,</span>
00829 <span class="comment">                    but does not wait for all callbacks to complete. The event is </span>
00830 <span class="comment">                    signalled after all callbacks have completed.</span>
00831 <span class="comment">            NULL : The function is non-blocking. The function marks the queue for deletion,</span>
00832 <span class="comment">                    but does not wait for all callbacks to complete.</span>
00833 <span class="comment">            </span>
00834 <span class="comment">Return Value:</span>
00835 <span class="comment"></span>
00836 <span class="comment">    STATUS_SUCCESS - All timer callbacks have completed.</span>
00837 <span class="comment">    STATUS_PENDING - Non-Blocking call. Some timer callbacks associated with timers</span>
00838 <span class="comment">                    in this queue may not have completed.</span>
00839 <span class="comment">    </span>
00840 <span class="comment">--*/</span>
00841 {
00842     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00843     LARGE_INTEGER TimeOut ;
00844     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> CompletionEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00845     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue = (<a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a>)QueueHandle ;
00846 
00847     <span class="keywordflow">if</span> (!Queue) {
00848         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
00849         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER ;
00850     }
00851 
00852     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( Queue ) ;
00853     <a class="code" href="../../d3/d1/threads_8h.html#a30">SET_DEL_SIGNATURE</a>( Queue ) ;
00854 
00855     
00856 <span class="preprocessor">    #if DBG1</span>
00857 <span class="preprocessor"></span>    Queue-&gt;ThreadId2 = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
00858     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00859     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n&lt;%d:%d&gt; Queue Delete(Queue:%x Event:%x by Thread:&lt;%x:%x&gt;)\n\n"</span>, 
00860              Queue-&gt;DbgId, Queue-&gt;RefCount, (ULONG_PTR)Queue, (ULONG_PTR)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00861              HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00862              HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00863 <span class="preprocessor">    #endif</span>
00864 <span class="preprocessor"></span>
00865 
00866     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == (HANDLE)-1 ) {
00867 
00868         <span class="comment">// Get an event from the event cache</span>
00869 
00870         CompletionEvent = <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> () ;
00871 
00872         <span class="keywordflow">if</span> (!CompletionEvent) {
00873 
00874             <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00875 
00876         }
00877     }
00878     
00879     Queue-&gt;CompletionEvent = CompletionEvent
00880                              ? CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a> 
00881                              : <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
00882 
00883 
00884     <span class="comment">// once this flag is set, no timer will be fired</span>
00885     
00886     <a class="code" href="../../d3/d1/threads_8h.html#a21">ACQUIRE_GLOBAL_TIMER_LOCK</a>();
00887     Queue-&gt;State |= <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>;
00888     <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>();
00889 
00890 
00891 
00892     <span class="comment">// queue an APC</span>
00893     
00894     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
00895                     <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a>,
00896                     (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a64">RtlpDeleteTimerQueue</a>,
00897                     (PVOID) QueueHandle,
00898                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00899                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00900                     );
00901 
00902     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00903 
00904         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
00905 
00906         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00907     }
00908     
00909     <span class="keywordflow">if</span> (CompletionEvent) {
00910 
00911         <span class="comment">// wait for Event to be fired. Return if the thread has been killed.</span>
00912 
00913 
00914 <span class="preprocessor">        #if DBG1</span>
00915 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00916         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%x&gt; Queue delete waiting Thread&lt;%d:%d&gt;\n\n"</span>,
00917                 (ULONG_PTR)Queue,
00918                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00919                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00920 <span class="preprocessor">        #endif</span>
00921 <span class="preprocessor"></span>
00922 
00923         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a>( CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>, <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a> ) ;
00924 
00925 
00926 <span class="preprocessor">        #if DBG1</span>
00927 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00928         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%x&gt; Queue delete completed\n\n"</span>, (ULONG_PTR) Queue) ;
00929 <span class="preprocessor">        #endif</span>
00930 <span class="preprocessor"></span>
00931         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
00932 
00933         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00934 
00935     } <span class="keywordflow">else</span> {
00936 
00937         <span class="keywordflow">return</span> STATUS_PENDING ;
00938     }
00939 }
00940 
00941 
00942 
00943 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00944"></a><a class="code" href="../../d2/d1/threads_8c.html#a13">00944</a> <a class="code" href="../../d2/d1/threads_8c.html#a13">RtlCreateTimer</a>(
00945     IN  HANDLE TimerQueueHandle,
00946     OUT HANDLE *Handle,
00947     IN  WAITORTIMERCALLBACKFUNC Function,
00948     IN  PVOID Context,
00949     IN  ULONG  DueTime,
00950     IN  ULONG  Period,
00951     IN  ULONG  Flags
00952     )
00953 <span class="comment">/*++</span>
00954 <span class="comment"></span>
00955 <span class="comment">Routine Description:</span>
00956 <span class="comment"></span>
00957 <span class="comment">    This routine puts a timer request in the queue identified in by TimerQueueHandle.</span>
00958 <span class="comment">    The timer request can be one shot or periodic.</span>
00959 <span class="comment"></span>
00960 <span class="comment">Arguments:</span>
00961 <span class="comment"></span>
00962 <span class="comment">    TimerQueueHandle - Handle identifying the timer queue in which to insert the timer</span>
00963 <span class="comment">                    request.</span>
00964 <span class="comment"></span>
00965 <span class="comment">    Handle - Specifies a location to return a handle to this timer request</span>
00966 <span class="comment"></span>
00967 <span class="comment">    Function - Routine that is called when the timer fires</span>
00968 <span class="comment"></span>
00969 <span class="comment">    Context - Opaque pointer passed in as an argument to WorkerProc</span>
00970 <span class="comment"></span>
00971 <span class="comment">    DueTime - Specifies the time in milliseconds after which the timer fires.</span>
00972 <span class="comment"></span>
00973 <span class="comment">    Period - Specifies the period of the timer in milliseconds. This should be 0 for</span>
00974 <span class="comment">    one shot requests.</span>
00975 <span class="comment"></span>
00976 <span class="comment">    Flags - Can be one of:</span>
00977 <span class="comment"></span>
00978 <span class="comment">            WT_EXECUTEINTIMERTHREAD - if WorkerProc should be invoked in the wait thread</span>
00979 <span class="comment">            it this should only be used for small routines.</span>
00980 <span class="comment"></span>
00981 <span class="comment">            WT_EXECUTELONGFUNCTION - if WorkerProc can possibly block for a long time.</span>
00982 <span class="comment"></span>
00983 <span class="comment">            WT_EXECUTEINIOTHREAD - if WorkerProc should be invoked in IO worker thread</span>
00984 <span class="comment">            </span>
00985 <span class="comment">Return Value:</span>
00986 <span class="comment"></span>
00987 <span class="comment">    NTSTATUS - Result code from call.  The following are returned</span>
00988 <span class="comment"></span>
00989 <span class="comment">        STATUS_SUCCESS - Timer Queue created successfully.</span>
00990 <span class="comment"></span>
00991 <span class="comment">        STATUS_NO_MEMORY - There was not sufficient heap to perform the</span>
00992 <span class="comment">            requested operation.</span>
00993 <span class="comment"></span>
00994 <span class="comment">--*/</span>
00995 
00996 {
00997     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00998     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
00999 
01000     Timer = (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>) <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a> (
01001                                 <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>),
01002                                 HEAP_ZERO_MEMORY
01003                                 ) ;
01004 
01005     <span class="keywordflow">if</span> (Timer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01006 
01007         <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
01008 
01009     }
01010 
01011     <span class="comment">// Initialize the allocated timer</span>
01012 
01013     Timer-&gt;DeltaFiringTime = DueTime ;
01014     Timer-&gt;Queue = (<a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a>) TimerQueueHandle ;
01015     Timer-&gt;RefCount = 1 ;
01016     Timer-&gt;Flags = Flags ;
01017     Timer-&gt;Function = Function ;
01018     Timer-&gt;Context = Context ;
01019     <span class="comment">//todo:remove below</span>
01020     Timer-&gt;Period = (Period == -1) ? 0 : Period;
01021     InitializeListHead( &amp;Timer-&gt;TimersToFireList ) ;
01022     <a class="code" href="../../d3/d1/threads_8h.html#a28">SET_SIGNATURE</a>( Timer ) ;
01023     
01024     
01025 <span class="preprocessor">    #if DBG1</span>
01026 <span class="preprocessor"></span>    Timer-&gt;DbgId = ++ Timer-&gt;Queue-&gt;NextDbgId ;
01027     Timer-&gt;ThreadId = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
01028     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
01029     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n&lt;%d:%d:%d&gt; Timer: created by Thread:&lt;%x:%x&gt;\n\n"</span>, 
01030             Timer-&gt;Queue-&gt;DbgId, Timer-&gt;DbgId, 1,
01031             HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
01032             HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
01033 <span class="preprocessor">    #endif</span>
01034 <span class="preprocessor"></span>
01035     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = Timer ;
01036 
01037 
01038     <span class="comment">// Increment the total number of timers in the queue</span>
01039 
01040     InterlockedIncrement( &amp;((<a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a>)TimerQueueHandle)-&gt;<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> ) ;
01041 
01042 
01043     <span class="comment">// Queue APC to timer thread</span>
01044 
01045     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01046                     <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a>,
01047                     (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a46">RtlpAddTimer</a>,
01048                     (PVOID)Timer,
01049                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01050                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01051                     ) ;
01052 
01053     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01054 }
01055 
01056 
01057 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01058"></a><a class="code" href="../../d2/d1/threads_8c.html#a14">01058</a> <a class="code" href="../../d2/d1/threads_8c.html#a14">RtlUpdateTimer</a>(
01059     IN HANDLE TimerQueueHandle,
01060     IN HANDLE Timer,
01061     IN ULONG  DueTime,
01062     IN ULONG  Period
01063     )
01064 <span class="comment">/*++</span>
01065 <span class="comment"></span>
01066 <span class="comment">Routine Description:</span>
01067 <span class="comment"></span>
01068 <span class="comment">    This routine updates the timer</span>
01069 <span class="comment"></span>
01070 <span class="comment">Arguments:</span>
01071 <span class="comment"></span>
01072 <span class="comment">    TimerQueueHandle - Handle identifying the queue in which the timer to be updated exists</span>
01073 <span class="comment"></span>
01074 <span class="comment">    Timer - Specifies a handle to the timer which needs to be updated</span>
01075 <span class="comment"></span>
01076 <span class="comment">    DueTime - Specifies the time in milliseconds after which the timer fires.</span>
01077 <span class="comment"></span>
01078 <span class="comment">    Period - Specifies the period of the timer in milliseconds. This should be </span>
01079 <span class="comment">            0 for one shot requests.</span>
01080 <span class="comment"></span>
01081 <span class="comment">Return Value:</span>
01082 <span class="comment"></span>
01083 <span class="comment">    NTSTATUS - Result code from call.  The following are returned</span>
01084 <span class="comment"></span>
01085 <span class="comment">        STATUS_SUCCESS - Timer updated successfully.</span>
01086 <span class="comment"></span>
01087 <span class="comment">--*/</span>
01088 {
01089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01090     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> TmpTimer ;
01091 
01092     <span class="keywordflow">if</span> (!TimerQueueHandle || !Timer) {
01093         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
01094         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER ;
01095     }
01096 
01097     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>)Timer ) ;
01098 
01099     
01100     TmpTimer = (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>) <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a> (
01101                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>),
01102                                         0
01103                                         ) ;
01104 
01105     <span class="keywordflow">if</span> (TmpTimer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01106 
01107         <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
01108     }
01109 
01110     TmpTimer-&gt;DeltaFiringTime = DueTime;
01111     <span class="comment">//todo:remove below</span>
01112     <span class="keywordflow">if</span> (Period==-1) Period = 0;
01113     TmpTimer-&gt;Period = Period ;
01114 
01115 <span class="preprocessor">    #if DBG1</span>
01116 <span class="preprocessor"></span>    ((<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>)Timer)-&gt;ThreadId2 = 
01117                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
01118 <span class="preprocessor">    #endif</span>
01119 <span class="preprocessor"></span><span class="preprocessor">    #if DBG1</span>
01120 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
01121     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d:%d:%d&gt; Timer: updated by Thread:&lt;%x:%x&gt;\n\n"</span>, 
01122                 ((<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>)Timer)-&gt;Queue-&gt;DbgId, 
01123                 ((<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>)Timer)-&gt;DbgId, ((<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>)Timer)-&gt;RefCount,
01124                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
01125                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
01126 <span class="preprocessor">    #endif</span>
01127 <span class="preprocessor"></span>
01128 
01129     <span class="comment">// queue APC to update timer</span>
01130     
01131     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a> (
01132                     <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a>,
01133                     (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a47">RtlpUpdateTimer</a>,
01134                     (PVOID)Timer, <span class="comment">//Actual timer</span>
01135                     (PVOID)TmpTimer,
01136                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01137                     );
01138 
01139 
01140     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01141 }
01142 
01143 
01144 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01145"></a><a class="code" href="../../d2/d1/threads_8c.html#a15">01145</a> <a class="code" href="../../d2/d1/threads_8c.html#a15">RtlDeleteTimer</a> (
01146     IN HANDLE TimerQueueHandle,
01147     IN HANDLE TimerToCancel,
01148     IN HANDLE Event
01149     )
01150 <span class="comment">/*++</span>
01151 <span class="comment"></span>
01152 <span class="comment">Routine Description:</span>
01153 <span class="comment"></span>
01154 <span class="comment">    This routine cancels the timer</span>
01155 <span class="comment"></span>
01156 <span class="comment">Arguments:</span>
01157 <span class="comment"></span>
01158 <span class="comment">    TimerQueueHandle - Handle identifying the queue from which to delete timer</span>
01159 <span class="comment"></span>
01160 <span class="comment">    TimerToCancel - Handle identifying the timer to cancel</span>
01161 <span class="comment"></span>
01162 <span class="comment">    Event - Event to be signalled when the timer is deleted</span>
01163 <span class="comment">            (HANDLE)-1: The function creates an event and waits on it.</span>
01164 <span class="comment">            Event : The caller passes an event. The function marks the timer for deletion,</span>
01165 <span class="comment">                    but does not wait for all callbacks to complete. The event is </span>
01166 <span class="comment">                    signalled after all callbacks have completed.</span>
01167 <span class="comment">            NULL : The function is non-blocking. The function marks the timer for deletion,</span>
01168 <span class="comment">                    but does not wait for all callbacks to complete.</span>
01169 <span class="comment"></span>
01170 <span class="comment">Return Value:</span>
01171 <span class="comment"></span>
01172 <span class="comment">    NTSTATUS - Result code from call.  The following are returned</span>
01173 <span class="comment"></span>
01174 <span class="comment">        STATUS_SUCCESS - Timer cancelled. No pending callbacks.</span>
01175 <span class="comment">        STATUS_PENDING - Timer cancelled. Some callbacks still not completed.</span>
01176 <span class="comment"></span>
01177 <span class="comment">--*/</span>
01178 {
01179     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01180     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> CompletionEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01181     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer = (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>) TimerToCancel ;
01182     ULONG TimerRefCount ;
01183 <span class="preprocessor">    #if DBG1</span>
01184 <span class="preprocessor"></span>    ULONG QueueDbgId ;
01185 <span class="preprocessor">    #endif</span>
01186 <span class="preprocessor"></span>
01187 
01188     <span class="keywordflow">if</span> (!TimerQueueHandle || !TimerToCancel) {
01189         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
01190         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER ;
01191     }
01192 
01193 <span class="preprocessor">    #if DBG1</span>
01194 <span class="preprocessor"></span>    QueueDbgId = Timer-&gt;Queue-&gt;DbgId ;
01195 <span class="preprocessor">    #endif</span>
01196 <span class="preprocessor"></span>
01197 
01198     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( Timer ) ;
01199     <a class="code" href="../../d3/d1/threads_8h.html#a30">SET_DEL_SIGNATURE</a>( Timer ) ;
01200     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( (<a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a>)TimerQueueHandle ) ;
01201 
01202     
01203     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == (HANDLE)-1 ) {
01204 
01205         <span class="comment">// Get an event from the event cache</span>
01206 
01207         CompletionEvent = <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> () ;
01208 
01209         <span class="keywordflow">if</span> (!CompletionEvent) {
01210 
01211             <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
01212         }
01213     }
01214 
01215 <span class="preprocessor">    #if DBG1</span>
01216 <span class="preprocessor"></span>    Timer-&gt;ThreadId2 = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
01217 <span class="preprocessor">    #endif</span>
01218 <span class="preprocessor"></span><span class="preprocessor">    #if DBG1</span>
01219 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
01220     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n&lt;%d:%d:%d&gt; Timer: Cancel:(Timer:%x, Event:%x)\n\n"</span>, 
01221                 Timer-&gt;Queue-&gt;DbgId, Timer-&gt;DbgId, Timer-&gt;RefCount, 
01222                 (ULONG_PTR)Timer, (ULONG_PTR)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>) ;
01223 <span class="preprocessor">    #endif</span>
01224 <span class="preprocessor"></span>
01225     Timer-&gt;CompletionEvent = CompletionEvent
01226                             ? CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a> 
01227                             : <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
01228 
01229 
01230     <a class="code" href="../../d3/d1/threads_8h.html#a21">ACQUIRE_GLOBAL_TIMER_LOCK</a>();
01231     Timer-&gt;State |= <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a> ;
01232     TimerRefCount = Timer-&gt;RefCount ;
01233     <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>();
01234 
01235     
01236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01237                 <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a>,
01238                 (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a48">RtlpCancelTimer</a>,
01239                 (PVOID)TimerToCancel,
01240                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01241                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01242                 );
01243 
01244     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01245 
01246         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
01247 
01248         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01249     }
01250 
01251 
01252     
01253     <span class="keywordflow">if</span> ( CompletionEvent ) {
01254 
01255         <span class="comment">// wait for the event to be signalled </span>
01256 
01257 <span class="preprocessor">        #if DBG1</span>
01258 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
01259         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Timer: %x: Cancel waiting Thread&lt;%d:%d&gt;\n\n"</span>, 
01260                 QueueDbgId, (ULONG_PTR)Timer,
01261                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
01262                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
01263 <span class="preprocessor">        #endif</span>
01264 <span class="preprocessor"></span>
01265         
01266         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a>( CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>,  <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a> ) ;
01267 
01268         
01269 <span class="preprocessor">        #if DBG1</span>
01270 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
01271         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Timer: %x: Cancel waiting done\n\n"</span>, QueueDbgId, 
01272                 (ULONG_PTR)Timer) ;
01273 <span class="preprocessor">        #endif</span>
01274 <span class="preprocessor"></span>
01275 
01276         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
01277 
01278         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01279 
01280     } <span class="keywordflow">else</span> {
01281 
01282         <span class="keywordflow">return</span> (TimerRefCount &gt; 1) ? STATUS_PENDING : STATUS_SUCCESS;
01283     }
01284 }
01285 
01286 
01287 
01288 
01289 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01290 NTAPI
<a name="l01291"></a><a class="code" href="../../d2/d1/threads_8c.html#a16">01291</a> <a class="code" href="../../d2/d1/threads_8c.html#a16">RtlSetThreadPoolStartFunc</a>(
01292     PRTLP_START_THREAD StartFunc,
01293     PRTLP_EXIT_THREAD ExitFunc
01294     )
01295 <span class="comment">/*++</span>
01296 <span class="comment"></span>
01297 <span class="comment">Routine Description:</span>
01298 <span class="comment"></span>
01299 <span class="comment">    This routine sets the thread pool's thread creation function.  This is not</span>
01300 <span class="comment">    thread safe, because it is intended solely for kernel32 to call for processes</span>
01301 <span class="comment">    that aren't csrss/smss.</span>
01302 <span class="comment"></span>
01303 <span class="comment">Arguments:</span>
01304 <span class="comment"></span>
01305 <span class="comment">    StartFunc - Function to create a new thread</span>
01306 <span class="comment"></span>
01307 <span class="comment">Return Value:</span>
01308 <span class="comment"></span>
01309 <span class="comment">--*/</span>
01310 
01311 {
01312     <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> = StartFunc ;
01313     <a class="code" href="../../d3/d1/threads_8h.html#a104">RtlpExitThreadFunc</a> = ExitFunc ;
01314     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01315 }
01316 
01317 
01318 
01319 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01320"></a><a class="code" href="../../d3/d1/threads_8h.html#a168">01320</a> <a class="code" href="../../d3/d1/threads_8h.html#a168">RtlThreadPoolCleanup</a> (
01321     ULONG Flags
01322     )
01323 <span class="comment">/*++</span>
01324 <span class="comment"></span>
01325 <span class="comment">Routine Description:</span>
01326 <span class="comment">    This routine cleans up the thread pool.</span>
01327 <span class="comment"></span>
01328 <span class="comment">Arguments:</span>
01329 <span class="comment"></span>
01330 <span class="comment">    None</span>
01331 <span class="comment">    </span>
01332 <span class="comment">Return Value:</span>
01333 <span class="comment"></span>
01334 <span class="comment">    STATUS_SUCCESS : if none of the components are in use.</span>
01335 <span class="comment">    STATUS_UNSUCCESSFUL : if some components are still in use.</span>
01336 <span class="comment"></span>
01337 <span class="comment">--*/</span>
01338 {
01339     BOOLEAN Cleanup ;
01340     PLIST_ENTRY Node ;
01341     ULONG i ;
01342     HANDLE TmpHandle ;
01343     
01344     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01345     
01346     <span class="comment">// cleanup timer thread</span>
01347     
01348     <a class="code" href="../../d3/d1/threads_8h.html#a23">IS_COMPONENT_INITIALIZED</a>(<a class="code" href="../../d3/d1/threads_8h.html#a68">StartedTimerInitialization</a>, 
01349                             <a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a>,
01350                             Cleanup ) ;
01351 
01352     <span class="keywordflow">if</span> ( Cleanup ) {
01353 
01354         <a class="code" href="../../d3/d1/threads_8h.html#a21">ACQUIRE_GLOBAL_TIMER_LOCK</a>() ;
01355         
01356         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a96">NumTimerQueues</a> != 0 ) {
01357         
01358             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01359                 <span class="stringliteral">"Trying to deinitialize ThreadPool when timers exist\n"</span> ) ;
01360             <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>() ;
01361 
01362             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL ;
01363         }
01364         
01365         <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01366                 <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a>,
01367                 (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a66">RtlpThreadCleanup</a>,
01368                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01369                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01370                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01371                 );
01372 
01373         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a> ) ;
01374         <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01375 
01376         <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>() ;
01377 
01378     }
01379 
01380 
01381     <span class="comment">//</span>
01382     <span class="comment">// cleanup wait threads</span>
01383     <span class="comment">//</span>
01384 
01385     <a class="code" href="../../d3/d1/threads_8h.html#a23">IS_COMPONENT_INITIALIZED</a>(<a class="code" href="../../d3/d1/threads_8h.html#a66">StartedWaitInitialization</a>, 
01386                             <a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a>,
01387                             Cleanup ) ;
01388 
01389     <span class="keywordflow">if</span> ( Cleanup ) {
01390 
01391         <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB ;
01392 
01393         <a class="code" href="../../d3/d1/threads_8h.html#a19">ACQUIRE_GLOBAL_WAIT_LOCK</a>() ;
01394 
01395         <span class="comment">// Queue an APC to all Wait Threads</span>
01396         
01397         <span class="keywordflow">for</span> (Node = <a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a>.Flink ; Node != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a> ; 
01398                 Node = Node-&gt;Flink) 
01399         {
01400 
01401             ThreadCB = CONTAINING_RECORD(Node, 
01402                                 <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">RTLP_WAIT_THREAD_CONTROL_BLOCK</a>,
01403                                 WaitThreadsList) ;
01404 
01405             <span class="keywordflow">if</span> ( ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> != 0 ) {
01406 
01407                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01408                     <span class="stringliteral">"Cannot cleanup ThreadPool. Registered Wait events exist."</span> ) ;
01409                 <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>( ) ;
01410                 
01411                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL ;
01412             }
01413 
01414             RemoveEntryList( &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o0">WaitThreadsList</a> ) ;
01415             TmpHandle = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a> ;
01416             
01417             <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01418                     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>,
01419                     (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a66">RtlpThreadCleanup</a>,
01420                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01421                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01422                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01423                     );
01424 
01425             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TmpHandle ) ;
01426         }
01427 
01428         <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>( ) ;
01429 
01430     }
01431 
01432 
01433     <span class="comment">// cleanup worker threads</span>
01434 
01435     <a class="code" href="../../d3/d1/threads_8h.html#a23">IS_COMPONENT_INITIALIZED</a>( <a class="code" href="../../d3/d1/threads_8h.html#a64">StartedWorkerInitialization</a>, 
01436                             <a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a>,
01437                             Cleanup ) ;
01438                                 
01439     <span class="keywordflow">if</span> ( Cleanup ) {
01440 
01441         RtlEnterCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
01442 
01443         <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a> != 0) || (<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a> != 0) ) {
01444 
01445             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01446                 <span class="stringliteral">"Cannot cleanup ThreadPool. Work requests pending."</span> ) ;
01447 
01448             RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
01449             
01450             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL ;
01451         }
01452         
01453         <span class="comment">// queue a cleanup for each worker thread</span>
01454         
01455         <span class="keywordflow">for</span> (i = 0 ;  i &lt; <a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> ; i ++ ) {
01456 
01457             <a class="code" href="../../d5/d4/complete_8c.html#a4">NtSetIoCompletion</a> (
01458                     <a class="code" href="../../d3/d1/threads_8h.html#a91">WorkerCompletionPort</a>,
01459                     <a class="code" href="../../d2/d1/threads_8c.html#a66">RtlpThreadCleanup</a>,
01460                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01461                     STATUS_SUCCESS,
01462                     0
01463                     );
01464         }
01465 
01466         <span class="comment">// queue an apc to cleanup all IO worker threads</span>
01467 
01468         <span class="keywordflow">for</span> (Node = <a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>.Flink ; Node != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a> ;
01469                 Node = Node-&gt;Flink )
01470         {
01471             <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">PRTLP_IOWORKER_TCB</a> ThreadCB ;
01472             
01473             ThreadCB = CONTAINING_RECORD (Node, <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
01474             RemoveEntryList( &amp;ThreadCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
01475             TmpHandle = ThreadCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a> ;
01476 
01477             <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01478                    ThreadCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a>,
01479                    (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a66">RtlpThreadCleanup</a>,
01480                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01481                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01482                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01483                    );
01484 
01485             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TmpHandle ) ;
01486         }
01487 
01488         <a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> = <a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> = 0 ;
01489 
01490         RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
01491 
01492     }
01493 
01494     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01495 
01496 }
01497 
01498 
01499 <span class="comment">// Private Functions</span>
01500 
01501 
01502 <span class="comment">// Worker functions</span>
01503 
01504 
01505 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01506"></a><a class="code" href="../../d3/d1/threads_8h.html#a152">01506</a> <a class="code" href="../../d3/d1/threads_8h.html#a152">RtlpQueueWorkerRequest</a> (
01507     WORKERCALLBACKFUNC Function,
01508     PVOID Context,
01509     ULONG Flags
01510     )
01511 <span class="comment">/*++</span>
01512 <span class="comment"></span>
01513 <span class="comment">Routine Description:</span>
01514 <span class="comment"></span>
01515 <span class="comment">    This routine queues up the request to be executed in a worker thread.</span>
01516 <span class="comment"></span>
01517 <span class="comment">Arguments:</span>
01518 <span class="comment"></span>
01519 <span class="comment">    Function - Routine that is called by the worker thread</span>
01520 <span class="comment"></span>
01521 <span class="comment">    Context - Opaque pointer passed in as an argument to WorkerProc</span>
01522 <span class="comment"></span>
01523 <span class="comment">    Flags - flags passed to RtlQueueWorkItem</span>
01524 <span class="comment"></span>
01525 <span class="comment">Return Value:</span>
01526 <span class="comment"></span>
01527 <span class="comment">--*/</span>
01528 
01529 {
01530     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01531     <a class="code" href="../../d6/d7/struct__RTLP__WORK.html">PRTLP_WORK</a> WorkEntry ;
01532     
01533     <span class="comment">// Increment the outstanding work request counter</span>
01534 
01535     InterlockedIncrement (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a>) ;
01536     <span class="keywordflow">if</span> (Flags &amp; WT_EXECUTELONGFUNCTION) {
01537         InterlockedIncrement( &amp; <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> ) ;
01538     }
01539 
01540     WorkEntry = (<a class="code" href="../../d6/d7/struct__RTLP__WORK.html">PRTLP_WORK</a>) <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a> ( <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d7/struct__RTLP__WORK.html">RTLP_WORK</a>),
01541                                                         HEAP_ZERO_MEMORY) ;
01542     WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o0">Function</a> = Function ;
01543     WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o1">Flags</a> = Flags ;
01544 
01545     <span class="keywordflow">if</span> (Flags &amp; WT_EXECUTEINPERSISTENTTHREAD) {
01546 
01547         <span class="comment">// Queue APC to timer thread</span>
01548 
01549         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01550                         <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a>,
01551                         (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a19">RtlpExecuteWorkerRequest</a>,
01552                         (PVOID) STATUS_SUCCESS,
01553                         (PVOID) Context,
01554                         (PVOID) WorkEntry
01555                         ) ;
01556 
01557     } <span class="keywordflow">else</span> {
01558     
01559         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/complete_8c.html#a4">NtSetIoCompletion</a> (
01560                     <a class="code" href="../../d3/d1/threads_8h.html#a91">WorkerCompletionPort</a>,
01561                     <a class="code" href="../../d2/d1/threads_8c.html#a19">RtlpExecuteWorkerRequest</a>,
01562                     (PVOID) WorkEntry,
01563                     STATUS_SUCCESS,
01564                     (ULONG_PTR)Context
01565                     );
01566     }
01567     
01568     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01569     
01570         InterlockedDecrement (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a>) ;
01571         <span class="keywordflow">if</span> (Flags &amp;&amp; WT_EXECUTELONGFUNCTION) {
01572             InterlockedDecrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> ) ;
01573         }
01574 
01575         <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( WorkEntry ) ;
01576 
01577         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
01578 
01579 <span class="preprocessor">        #if DBG</span>
01580 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ERROR!! Thread Pool (RtlQeueuWorkItem): could not queue work item\n"</span>);
01581 <span class="preprocessor">        #endif</span>
01582 <span class="preprocessor"></span>    }
01583 
01584     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01585 }
01586 
01587 
01588 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01589"></a><a class="code" href="../../d3/d1/threads_8h.html#a161">01589</a> <a class="code" href="../../d3/d1/threads_8h.html#a161">RtlpExecuteWorkerRequest</a> (
01590     NTSTATUS Status, <span class="comment">//not  used</span>
01591     PVOID Context,
01592     PVOID WorkContext
01593     )
01594 <span class="comment">/*++</span>
01595 <span class="comment"></span>
01596 <span class="comment">Routine Description:</span>
01597 <span class="comment"></span>
01598 <span class="comment">    This routine executes a work item.</span>
01599 <span class="comment">    </span>
01600 <span class="comment">Arguments:</span>
01601 <span class="comment"></span>
01602 <span class="comment">    Context - contains context to be passed to the callback function.</span>
01603 <span class="comment"></span>
01604 <span class="comment">    WorkContext - contains callback function ptr and flags</span>
01605 <span class="comment">    </span>
01606 <span class="comment">Return Value:</span>
01607 <span class="comment"></span>
01608 <span class="comment">Notes:</span>
01609 <span class="comment">    This function executes in a worker thread or a timer thread if</span>
01610 <span class="comment">    WT_EXECUTEINTIMERTHREAD flag is set.</span>
01611 <span class="comment"></span>
01612 <span class="comment">--*/</span>
01613 
01614 {
01615     <a class="code" href="../../d6/d7/struct__RTLP__WORK.html">PRTLP_WORK</a> WorkEntry = (<a class="code" href="../../d6/d7/struct__RTLP__WORK.html">PRTLP_WORK</a>) WorkContext;
01616 
01617 <span class="preprocessor">    #if (DBG1)</span>
01618 <span class="preprocessor"></span>    <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o0">Function</a>, Context ) ;
01619 <span class="preprocessor">    #endif</span>
01620 <span class="preprocessor"></span>
01621     <span class="keywordflow">try</span> {
01622         ((WORKERCALLBACKFUNC) WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o0">Function</a>) ( Context ) ;
01623 
01624     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01625 <span class="comment">//        ASSERT(FALSE);</span>
01626     }
01627     
01628     InterlockedDecrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a> ) ;
01629     <span class="keywordflow">if</span> (WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o1">Flags</a> &amp; WT_EXECUTELONGFUNCTION) {
01630         InterlockedDecrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> ) ;
01631     }
01632 
01633     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( WorkEntry ) ;
01634 }
01635 
01636 
01637 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01638"></a><a class="code" href="../../d3/d1/threads_8h.html#a148">01638</a> <a class="code" href="../../d3/d1/threads_8h.html#a148">RtlpQueueIOWorkerRequest</a> (
01639     WORKERCALLBACKFUNC Function,
01640     PVOID Context,
01641     ULONG Flags
01642     )
01643 
01644 <span class="comment">/*++</span>
01645 <span class="comment"></span>
01646 <span class="comment">Routine Description:</span>
01647 <span class="comment"></span>
01648 <span class="comment">    This routine queues up the request to be executed in an IO worker thread.</span>
01649 <span class="comment"></span>
01650 <span class="comment">Arguments:</span>
01651 <span class="comment"></span>
01652 <span class="comment">    Function - Routine that is called by the worker thread</span>
01653 <span class="comment"></span>
01654 <span class="comment">    Context - Opaque pointer passed in as an argument to WorkerProc</span>
01655 <span class="comment"></span>
01656 <span class="comment">Return Value:</span>
01657 <span class="comment"></span>
01658 <span class="comment">--*/</span>
01659 
01660 {
01661     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01662     <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">PRTLP_IOWORKER_TCB</a> TCB ;
01663     BOOLEAN LongFunction = (Flags &amp; WT_EXECUTELONGFUNCTION) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01664     PLIST_ENTRY  ple ;
01665     
01666                 
01667     <span class="keywordflow">if</span> (Flags &amp; WT_EXECUTEINPERSISTENTIOTHREAD) {
01668 
01669         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d1/threads_8h.html#a90">PersistentIOTCB</a>) {
01670             <span class="keywordflow">for</span> (ple=<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>.Flink;  ple!=&amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>;  ple=ple-&gt;Flink) {
01671                 TCB = CONTAINING_RECORD (ple, <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
01672                 <span class="keywordflow">if</span> (! TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o3">LongFunctionFlag</a>)
01673                     <span class="keywordflow">break</span>;
01674             }
01675 
01676             <span class="keywordflow">if</span> (ple == &amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>) {
01677                 <span class="comment">// ASSERT(FALSE);</span>
01678                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01679             }
01680 
01681             
01682             <a class="code" href="../../d3/d1/threads_8h.html#a90">PersistentIOTCB</a> = TCB ;
01683             TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o2">Flags</a> |= WT_EXECUTEINPERSISTENTIOTHREAD ;
01684             
01685         } <span class="keywordflow">else</span> {
01686             TCB = <a class="code" href="../../d3/d1/threads_8h.html#a90">PersistentIOTCB</a> ;
01687         }
01688 
01689     } <span class="keywordflow">else</span> {
01690         <span class="keywordflow">for</span> (ple=<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>.Flink;  ple!=&amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>;  ple=ple-&gt;Flink) {
01691         
01692             TCB = CONTAINING_RECORD (ple, <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
01693 
01694             <span class="comment">// do not queue to the thread if it is executing a long function, or</span>
01695             <span class="comment">// if you are queueing a long function and the thread is a persistent thread</span>
01696             
01697             <span class="keywordflow">if</span> (! TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o3">LongFunctionFlag</a>
01698                 &amp;&amp; (! ((TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o2">Flags</a>&amp;WT_EXECUTEINPERSISTENTIOTHREAD)
01699                         &amp;&amp; (Flags&amp;WT_EXECUTELONGFUNCTION)))) {
01700                 <span class="keywordflow">break</span> ;
01701             }            
01702 
01703         }
01704 
01705         <span class="keywordflow">if</span> ((ple == &amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>) &amp;&amp; (<a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a>&lt;1)) {
01706 
01707 <span class="preprocessor">            #if DBG</span>
01708 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ThreadPool:ntdll.dll: Out of memory. "</span>
01709                      <span class="stringliteral">"Could not execute IOWorkItem(%x)\n"</span>, (ULONG_PTR)Function);
01710 <span class="preprocessor">            #endif</span>
01711 <span class="preprocessor"></span>                     
01712             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01713         }
01714         <span class="keywordflow">else</span> {
01715             ple = <a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>.Flink;
01716             TCB = CONTAINING_RECORD (ple, <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
01717 
01718             <span class="comment">// treat it as a short function so that counters work fine.</span>
01719             
01720             LongFunction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            
01721         }
01722 
01723         <span class="comment">// In order to implement "fair" assignment of work items between IO worker threads</span>
01724         <span class="comment">// each time remove the entry and reinsert at back.</span>
01725 
01726         RemoveEntryList (&amp;TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
01727         InsertTailList (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>, &amp;TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
01728     }
01729 
01730              
01731     <span class="comment">// Increment the outstanding work request counter</span>
01732 
01733     InterlockedIncrement (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a>) ;
01734     <span class="keywordflow">if</span> (LongFunction) {
01735         InterlockedIncrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> ) ;
01736         TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o3">LongFunctionFlag</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01737     }
01738 
01739     <span class="comment">// Queue an APC to the IoWorker Thread</span>
01740 
01741     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01742                     TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a>,
01743                     LongFunction? (PPS_APC_ROUTINE)RtlpExecuteLongIOWorkItem:
01744                                   (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a29">RtlpExecuteIOWorkItem</a>,
01745                     (PVOID)Function,
01746                     Context,
01747                     TCB
01748                     );
01749 
01750     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01751         InterlockedDecrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a> ) ;
01752         <span class="keywordflow">if</span> (LongFunction)
01753             InterlockedDecrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> ) ;
01754     }
01755     
01756     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01757 
01758 }
01759 
01760 
01761 
01762 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01763"></a><a class="code" href="../../d3/d1/threads_8h.html#a149">01763</a> <a class="code" href="../../d2/d1/threads_8c.html#a21">RtlpStartWorkerThread</a> (
01764     )
01765 <span class="comment">/*++</span>
01766 <span class="comment"></span>
01767 <span class="comment">Routine Description:</span>
01768 <span class="comment"></span>
01769 <span class="comment">    This routine starts a regular worker thread</span>
01770 <span class="comment"></span>
01771 <span class="comment">Arguments:</span>
01772 <span class="comment"></span>
01773 <span class="comment"></span>
01774 <span class="comment">Return Value:</span>
01775 <span class="comment"></span>
01776 <span class="comment">    NTSTATUS error codes resulting from attempts to create a thread</span>
01777 <span class="comment">    STATUS_SUCCESS</span>
01778 <span class="comment"></span>
01779 <span class="comment">--*/</span>
01780 {
01781     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ;
01782     ULONG CurrentTickCount ;
01783     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01784 
01785     <span class="comment">// Create worker thread</span>
01786     
01787     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> (<a class="code" href="../../d2/d1/threads_8c.html#a26">RtlpWorkerThread</a>, &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>) ;
01788 
01789     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
01790 
01791         <span class="comment">// Update the time at which the current thread was created</span>
01792 
01793         <a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
01794 
01795         <span class="comment">// Increment the count of the thread type created</span>
01796 
01797         InterlockedIncrement(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a>) ;
01798 
01799         <span class="comment">// Close Thread handle, we dont need it.</span>
01800 
01801         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>) ;
01802 
01803     } <span class="keywordflow">else</span> {
01804 
01805         <span class="comment">// Thread creation failed. If there is even one thread present do not return</span>
01806         <span class="comment">// failure - else queue the request anyway.</span>
01807 
01808         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> == 0) {
01809 
01810             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01811         }
01812 
01813     }
01814 
01815     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01816 }
01817 
01818 
01819 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01820"></a><a class="code" href="../../d3/d1/threads_8h.html#a150">01820</a> <a class="code" href="../../d2/d1/threads_8c.html#a22">RtlpStartIOWorkerThread</a> (
01821     )
01822 <span class="comment">/*++</span>
01823 <span class="comment"></span>
01824 <span class="comment">Routine Description:</span>
01825 <span class="comment"></span>
01826 <span class="comment">    This routine starts an I/O worker thread</span>
01827 <span class="comment"></span>
01828 <span class="comment">Arguments:</span>
01829 <span class="comment"></span>
01830 <span class="comment"></span>
01831 <span class="comment">Return Value:</span>
01832 <span class="comment"></span>
01833 <span class="comment">    NTSTATUS error codes resulting from attempts to create a thread</span>
01834 <span class="comment">    STATUS_SUCCESS</span>
01835 <span class="comment"></span>
01836 <span class="comment">--*/</span>
01837 {
01838     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ;
01839     ULONG CurrentTickCount ;
01840     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01841 
01842 
01843     <span class="comment">// Create worker thread</span>
01844 
01845     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> (<a class="code" href="../../d2/d1/threads_8c.html#a27">RtlpIOWorkerThread</a>, &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>) ;
01846 
01847     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
01848 
01849         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ) ;
01850 
01851         <span class="comment">// Update the time at which the current thread was created</span>
01852 
01853         <a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
01854 
01855     } <span class="keywordflow">else</span> {
01856 
01857         <span class="comment">// Thread creation failed. If there is even one thread present do not return</span>
01858         <span class="comment">// failure since we can still service the work request.</span>
01859 
01860         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> == 0) {
01861 
01862             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01863 
01864         }
01865     }
01866 
01867     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01868 }
01869 
01870 
01871 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01872"></a><a class="code" href="../../d3/d1/threads_8h.html#a151">01872</a> <a class="code" href="../../d3/d1/threads_8h.html#a151">RtlpWorkerThreadTimerCallback</a>(
01873     PVOID Context,
01874     BOOLEAN NotUsed
01875     )
01876 <span class="comment">/*++</span>
01877 <span class="comment"></span>
01878 <span class="comment">Routine Description:</span>
01879 <span class="comment"></span>
01880 <span class="comment">    This routine checks if new worker thread has to be created</span>
01881 <span class="comment"></span>
01882 <span class="comment">Arguments:</span>
01883 <span class="comment">    None</span>
01884 <span class="comment"></span>
01885 <span class="comment">Return Value:</span>
01886 <span class="comment">    None</span>
01887 <span class="comment">    </span>
01888 <span class="comment">--*/</span>
01889 {
01890     IO_COMPLETION_BASIC_INFORMATION Info ;
01891     BOOLEAN bCreateThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01892     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01893     ULONG QueueLength, Threshold, ShortWorkRequests ;
01894     
01895     
01896     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/complete_8c.html#a3">NtQueryIoCompletion</a>(
01897                 <a class="code" href="../../d3/d1/threads_8h.html#a91">WorkerCompletionPort</a>,
01898                 IoCompletionBasicInformation,
01899                 &amp;Info,
01900                 <span class="keyword">sizeof</span>(Info),
01901                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01902                 ) ;
01903 
01904     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01905         <span class="keywordflow">return</span> ;
01906 
01907     QueueLength = Info.Depth ;
01908 
01909     <span class="keywordflow">if</span> (!QueueLength) {
01910         <a class="code" href="../../d3/d1/threads_8h.html#a83">OldTotalExecutedWorkRequests</a> = <a class="code" href="../../d3/d1/threads_8h.html#a82">TotalExecutedWorkRequests</a> ;
01911         <span class="keywordflow">return</span> ;
01912     }
01913 
01914 
01915     RtlEnterCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
01916 
01917     
01918     <span class="comment">// if there are queued work items and no new work items have been scheduled</span>
01919     <span class="comment">// in the last 30 seconds then create a new thread.</span>
01920     <span class="comment">// this will take care of deadlocks.</span>
01921 
01922     <span class="comment">// this will create a problem only if some thread is running for a long time</span>
01923     
01924     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a82">TotalExecutedWorkRequests</a> == <a class="code" href="../../d3/d1/threads_8h.html#a83">OldTotalExecutedWorkRequests</a>) {
01925 
01926         bCreateThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01927     }
01928         
01929     
01930     <span class="comment">// if there are a lot of queued work items, then create a new thread</span>
01931     {
01932         ULONG NumEffWorkerThreads = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a>) ;
01933         ULONG ShortWorkRequests ;
01934         
01935         Threshold = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt; <a class="code" href="../../d3/d1/threads_8h.html#a9">MAX_WORKER_THREADS</a>
01936                         ? (NumEffWorkerThreads &lt; 7
01937                             ? NumEffWorkerThreads*NumEffWorkerThreads
01938                             : <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * NumEffWorkerThreads )
01939                         : 0xffffffff) ;
01940 
01941         ShortWorkRequests = QueueLength + <a class="code" href="../../d3/d1/threads_8h.html#a81">NumExecutingWorkerThreads</a>
01942                                 - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> ;
01943 
01944         <span class="keywordflow">if</span> (ShortWorkRequests  &gt; Threshold)
01945         {
01946             bCreateThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01947         }
01948     }
01949 
01950     <span class="keywordflow">if</span> (bCreateThread) {
01951 
01952         <a class="code" href="../../d2/d1/threads_8c.html#a21">RtlpStartWorkerThread</a> () ;
01953     }
01954 
01955 
01956     <a class="code" href="../../d3/d1/threads_8h.html#a83">OldTotalExecutedWorkRequests</a> = <a class="code" href="../../d3/d1/threads_8h.html#a82">TotalExecutedWorkRequests</a> ;
01957     
01958     RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
01959 
01960 }
01961 
01962 
01963 
01964 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01965"></a><a class="code" href="../../d3/d1/threads_8h.html#a113">01965</a> <a class="code" href="../../d2/d1/threads_8c.html#a24">RtlpInitializeWorkerThreadPool</a> (
01966     )
01967 <span class="comment">/*++</span>
01968 <span class="comment"></span>
01969 <span class="comment">Routine Description:</span>
01970 <span class="comment"></span>
01971 <span class="comment">    This routine initializes all aspects of the thread pool.</span>
01972 <span class="comment"></span>
01973 <span class="comment">Arguments:</span>
01974 <span class="comment"></span>
01975 <span class="comment">    None</span>
01976 <span class="comment"></span>
01977 <span class="comment">Return Value:</span>
01978 <span class="comment"></span>
01979 <span class="comment">    None</span>
01980 <span class="comment"></span>
01981 <span class="comment">--*/</span>
01982 {
01983     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
01984     LARGE_INTEGER TimeOut ;
01985 
01986 
01987     <span class="comment">// Initialize the timer component if it hasnt been done already</span>
01988 
01989     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a> != 1) {
01990 
01991         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a63">RtlpInitializeTimerThreadPool</a> () ;
01992 
01993         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) )
01994             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01995 
01996     }
01997 
01998     
01999     <span class="comment">// In order to avoid an explicit RtlInitialize() function to initialize the thread pool</span>
02000     <span class="comment">// we use StartedInitialization and CompletedInitialization to provide us the necessary</span>
02001     <span class="comment">// synchronization to avoid multiple threads from initializing the thread pool.</span>
02002     <span class="comment">// This scheme does not work if RtlInitializeCriticalSection() fails - but in this case the</span>
02003     <span class="comment">// caller has no choices left.</span>
02004 
02005     <span class="keywordflow">if</span> (!InterlockedExchange(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a64">StartedWorkerInitialization</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
02006 
02007         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a>)
02008             InterlockedExchange( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a>, 0 ) ;
02009 
02010             
02011         <span class="keywordflow">do</span> {
02012 
02013             <span class="comment">// Initialize Critical Sections</span>
02014 
02015             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a> );
02016             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
02017                 <span class="keywordflow">break</span> ;
02018 
02019 
02020             InitializeListHead (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>) ;
02021 
02022             {            
02023                 SYSTEM_BASIC_INFORMATION BasicInfo;
02024 
02025                 <span class="comment">// get number of processors</span>
02026 
02027                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a> (
02028                                     SystemBasicInformation,
02029                                     &amp;BasicInfo,
02030                                     <span class="keyword">sizeof</span>(BasicInfo),
02031                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02032                                     ) ;
02033 
02034                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
02035                     BasicInfo.NumberOfProcessors = 1 ;
02036                 }
02037 
02038                 <span class="comment">// Create completion port used by worker threads</span>
02039 
02040                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/complete_8c.html#a1">NtCreateIoCompletion</a> (
02041                                     &amp;<a class="code" href="../../d3/d1/threads_8h.html#a91">WorkerCompletionPort</a>,
02042                                     IO_COMPLETION_ALL_ACCESS,
02043                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02044                                     BasicInfo.NumberOfProcessors
02045                                     );
02046 
02047                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
02048                     <span class="keywordflow">break</span> ;
02049 
02050             }
02051 
02052         } <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
02053 
02054         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
02055         
02056             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) ;
02057             <a class="code" href="../../d3/d1/threads_8h.html#a64">StartedWorkerInitialization</a> = 0 ;
02058             InterlockedExchange( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a>, ~0 ) ;
02059             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02060         }
02061         
02062         <span class="comment">// Signal that initialization has completed</span>
02063 
02064         InterlockedExchange (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) ;
02065 
02066     } <span class="keywordflow">else</span> {
02067 
02068         LARGE_INTEGER Timeout ;
02069 
02070         <span class="comment">// Sleep 1 ms and see if the other thread has completed initialization</span>
02071 
02072         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
02073 
02074         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a>) {
02075 
02076             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;TimeOut) ;
02077         }
02078 
02079         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a> != 1)
02080             <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
02081         
02082     }
02083 
02084 
02085     <span class="comment">//</span>
02086     <span class="comment">// create timer for worker thread. it should be created outside any worker</span>
02087     <span class="comment">// lock and the above wait loop. It should not make the RtlpInitializeWorkerThread</span>
02088     <span class="comment">// call blocking on a timer thread. so queue a work item.</span>
02089     <span class="comment">//</span>
02090     
02091     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
02092         &amp;&amp; (InterlockedIncrement(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a85">WorkerThreadTimerQueueInit</a>) == 1) )
02093     {
02094         <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>(<a class="code" href="../../d2/d1/threads_8c.html#a25">RtlpWorkerThreadInitializeTimers</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
02095     }
02096     
02097 
02098     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)  ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02099 }
02100 
02101 
02102 
02103 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02104"></a><a class="code" href="../../d3/d1/threads_8h.html#a167">02104</a> <a class="code" href="../../d3/d1/threads_8h.html#a167">RtlpWorkerThreadInitializeTimers</a>(
02105     PVOID Context
02106     )
02107 {
02108     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02109     
02110 
02111     <span class="comment">// create a timer that will fire every 30 sec and check if new thread</span>
02112     <span class="comment">// should be created</span>
02113 
02114     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a10">RtlCreateTimerQueue</a>(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a84">WorkerThreadTimerQueue</a>) ;
02115     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
02116         <span class="keywordflow">return</span> ;
02117     
02118     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a13">RtlCreateTimer</a>(
02119                         <a class="code" href="../../d3/d1/threads_8h.html#a84">WorkerThreadTimerQueue</a>,
02120                         &amp;<a class="code" href="../../d3/d1/threads_8h.html#a86">WorkerThreadTimer</a>,
02121                         <a class="code" href="../../d2/d1/threads_8c.html#a23">RtlpWorkerThreadTimerCallback</a>,
02122                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02123                         30000,
02124                         30000,
02125                         WT_EXECUTEINTIMERTHREAD
02126                         ) ;
02127 
02128    <span class="keywordflow">return</span>;
02129 }
02130 
02131 
02132 
02133 
02134 
02135 
02136 LONG
<a name="l02137"></a><a class="code" href="../../d3/d1/threads_8h.html#a118">02137</a> <a class="code" href="../../d3/d1/threads_8h.html#a118">RtlpWorkerThread</a> (
02138     PVOID  Initialized
02139     )
02140 <span class="comment">/*++</span>
02141 <span class="comment"></span>
02142 <span class="comment">Routine Description:</span>
02143 <span class="comment"></span>
02144 <span class="comment">    All non I/O worker threads execute in this routine. Worker thread will try to</span>
02145 <span class="comment">    terminate when it has not serviced a request for</span>
02146 <span class="comment"></span>
02147 <span class="comment">        STARTING_WORKER_SLEEP_TIME +</span>
02148 <span class="comment">        STARTING_WORKER_SLEEP_TIME &lt;&lt; 1 +</span>
02149 <span class="comment">        ...</span>
02150 <span class="comment">        STARTING_WORKER_SLEEP_TIME &lt;&lt; MAX_WORKER_SLEEP_TIME_EXPONENT</span>
02151 <span class="comment"></span>
02152 <span class="comment">Arguments:</span>
02153 <span class="comment"></span>
02154 <span class="comment">    Initialized - Set to 1 when we are initialized</span>
02155 <span class="comment"></span>
02156 <span class="comment">Return Value:</span>
02157 <span class="comment"></span>
02158 <span class="comment">--*/</span>
02159 {
02160     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02161     PVOID WorkerProc ;
02162     PVOID Context ;
02163     IO_STATUS_BLOCK IoSb ;
02164     ULONG SleepTime ;
02165     LARGE_INTEGER TimeOut ;
02166     ULONG Terminate ;
02167     PVOID Overlapped ;
02168 
02169 
02170     <span class="comment">// We are all initialized now. Notify the starter to queue the task.</span>
02171 
02172     InterlockedExchange ((ULONG *)<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) ;
02173 
02174 
02175     <span class="comment">// Set default sleep time for 40 seconds. This time is doubled each time a timeout</span>
02176     <span class="comment">// occurs after which the thread terminates</span>
02177 
02178 <span class="preprocessor">#define WORKER_IDLE_TIMEOUT     40000    // In Milliseconds</span>
02179 <span class="preprocessor"></span><span class="preprocessor">#define MAX_WORKER_SLEEP_TIME_EXPONENT 4</span>
02180 <span class="preprocessor"></span>
02181     SleepTime = <a class="code" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a> ;
02182 
02183     <span class="comment">// Loop servicing I/O completion requests</span>
02184 
02185     <span class="keywordflow">for</span> ( ; ; ) {
02186 
02187         TimeOut.QuadPart = Int32x32To64( SleepTime, -10000 ) ;
02188 
02189         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/complete_8c.html#a5">NtRemoveIoCompletion</a>(
02190                     <a class="code" href="../../d3/d1/threads_8h.html#a91">WorkerCompletionPort</a>,
02191                     (PVOID) &amp;WorkerProc,
02192                     &amp;Overlapped,
02193                     &amp;IoSb,
02194                     &amp;TimeOut
02195                     ) ;
02196 
02197         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02198 
02199 
02200             <a class="code" href="../../d3/d1/threads_8h.html#a82">TotalExecutedWorkRequests</a> ++ ;<span class="comment">//interlocked op not req</span>
02201             InterlockedIncrement(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a81">NumExecutingWorkerThreads</a>) ;
02202             
02203             <span class="comment">// Call the work item. </span>
02204             <span class="comment">// If IO APC, context1 contains number of IO bytes transferred, and context2</span>
02205             <span class="comment">// contains the overlapped structure.</span>
02206             <span class="comment">// If (IO)WorkerFunction, context1 contains the actual WorkerFunction to be</span>
02207             <span class="comment">// executed and context2 contains the actual context</span>
02208 
02209             Context = (PVOID) IoSb.Information ;
02210 
02211             <span class="keywordflow">try</span> {
02212                 ((APC_CALLBACK_FUNCTION)WorkerProc) (
02213                                             IoSb.Status, 
02214                                             Context,        <span class="comment">// Number of IO bytes transferred</span>
02215                                             Overlapped      <span class="comment">// Overlapped structure</span>
02216                                             ) ;
02217             } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02218                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02219             }
02220 
02221             SleepTime = <a class="code" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a> ;
02222 
02223             InterlockedDecrement(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a81">NumExecutingWorkerThreads</a>) ;
02224 
02225         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
02226 
02227             <span class="comment">// NtRemoveIoCompletion timed out. Check to see if have hit our limit</span>
02228             <span class="comment">// on waiting. If so terminate.</span>
02229 
02230             Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02231 
02232             RtlEnterCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
02233 
02234             <span class="comment">// The thread terminates if there are &gt; 1 threads and the queue is small</span>
02235             <span class="comment">// OR if there is only 1 thread and there is no request pending</span>
02236 
02237             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &gt;  1) {
02238 
02239                 ULONG NumEffWorkerThreads = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a>) ;
02240 
02241                 <span class="keywordflow">if</span> (NumEffWorkerThreads == 0) {
02242 
02243                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02244 
02245                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SleepTime &gt;= (<a class="code" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a> &lt;&lt; <a class="code" href="../../d2/d1/threads_8c.html#a1">MAX_WORKER_SLEEP_TIME_EXPONENT</a>)) {
02246 
02247                     <span class="comment">//</span>
02248                     <span class="comment">// have been idle for very long time. terminate irrespective of number of</span>
02249                     <span class="comment">// work items. (This is useful when the set of runnable threads is taking</span>
02250                     <span class="comment">// care of all the work items being queued). dont terminate if</span>
02251                     <span class="comment">// (NumEffWorkerThreads == 1)</span>
02252                     <span class="comment">//</span>
02253                     
02254                     <span class="keywordflow">if</span> (NumEffWorkerThreads &gt; 1)
02255                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02256 
02257                 } <span class="keywordflow">else</span> {
02258                 
02259                     ULONG Threshold ;
02260                     
02261                     <span class="comment">// Check if we need to shrink worker thread pool</span>
02262 
02263                     Threshold = NumEffWorkerThreads &lt; 7
02264                                 ? NumEffWorkerThreads*(NumEffWorkerThreads-1)
02265                                 : <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * (NumEffWorkerThreads-1);
02266 
02267 
02268                     
02269                     <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a>-<a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> &lt; Threshold)  {
02270 
02271                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02272 
02273                     } <span class="keywordflow">else</span> {
02274 
02275                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02276                         SleepTime &lt;&lt;= 1 ;
02277                     }
02278                 }
02279                 
02280             } <span class="keywordflow">else</span> {
02281 
02282                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d1/threads_8h.html#a76">NumMinWorkerThreads</a> == 0) &amp;&amp; (<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a> == 0) ) {
02283 
02284                     <span class="comment">// delay termination of last thread</span>
02285                     
02286                     <span class="keywordflow">if</span> (SleepTime &lt; (<a class="code" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a> &lt;&lt; <a class="code" href="../../d2/d1/threads_8c.html#a1">MAX_WORKER_SLEEP_TIME_EXPONENT</a>)) {
02287                         SleepTime &lt;&lt;= 1 ;
02288                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02289                     }
02290                     <span class="keywordflow">else</span> {
02291                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02292                     }
02293                     
02294                 } <span class="keywordflow">else</span> {
02295 
02296                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02297 
02298                 }
02299 
02300             }
02301 
02302             <span class="keywordflow">if</span> (Terminate) {
02303 
02304                 THREAD_BASIC_INFORMATION ThreadInfo;
02305                 ULONG IsIoPending ;
02306                 HANDLE CurThreadHandle ;
02307 
02308                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
02309                             NtCurrentProcess(),
02310                             NtCurrentThread(),
02311                             NtCurrentProcess(),
02312                             &amp;CurThreadHandle,
02313                             0,
02314                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02315                             DUPLICATE_SAME_ACCESS
02316                             ) ;
02317 
02318                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) ;
02319 
02320                 Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02321 
02322                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( CurThreadHandle,
02323                                                    ThreadIsIoPending,
02324                                                    &amp;IsIoPending,
02325                                                    <span class="keyword">sizeof</span>( IsIoPending ),
02326                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02327                                                  );
02328                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02329 
02330                     <span class="keywordflow">if</span> (! IsIoPending )
02331                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02332                 }
02333 
02334                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( CurThreadHandle ) ;
02335             }
02336             
02337             <span class="keywordflow">if</span> (Terminate) {
02338 
02339                 InterlockedDecrement (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a>) ;
02340 
02341                 RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
02342 
02343                 <a class="code" href="../../d3/d1/threads_8h.html#a104">RtlpExitThreadFunc</a>( 0 );
02344 
02345             } <span class="keywordflow">else</span> {
02346 
02347                 <span class="comment">// This is the condition where a request was queued *after* the</span>
02348                 <span class="comment">// thread woke up - ready to terminate because of inactivity. In</span>
02349                 <span class="comment">// this case dont terminate - service the completion port.</span>
02350 
02351                 RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
02352 
02353             }
02354 
02355         } <span class="keywordflow">else</span> {
02356 
02357             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
02358 
02359         }
02360 
02361     }
02362 
02363 
02364     <span class="keywordflow">return</span> 1 ;
02365 }
02366 
02367 
02368 
02369 LONG
<a name="l02370"></a><a class="code" href="../../d3/d1/threads_8h.html#a119">02370</a> <a class="code" href="../../d3/d1/threads_8h.html#a119">RtlpIOWorkerThread</a> (
02371     PVOID  Initialized
02372     )
02373 <span class="comment">/*++</span>
02374 <span class="comment"></span>
02375 <span class="comment">Routine Description:</span>
02376 <span class="comment"></span>
02377 <span class="comment">    All I/O worker threads execute in this routine. All the work requests execute as APCs</span>
02378 <span class="comment">    in this thread.</span>
02379 <span class="comment"></span>
02380 <span class="comment">Arguments:</span>
02381 <span class="comment"></span>
02382 <span class="comment">    Initialized - set to 1 when the initialization has completed</span>
02383 <span class="comment"></span>
02384 <span class="comment">Return Value:</span>
02385 <span class="comment"></span>
02386 <span class="comment">--*/</span>
02387 {
02388 <span class="preprocessor">    #define IOWORKER_IDLE_TIMEOUT     40000    // In Milliseconds</span>
02389 <span class="preprocessor"></span>    
02390     LARGE_INTEGER TimeOut ;
02391     ULONG SleepTime = <a class="code" href="../../d2/d1/threads_8c.html#a2">IOWORKER_IDLE_TIMEOUT</a> ;
02392     <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a> ThreadCB ;    <span class="comment">// Control Block allocated on the stack</span>
02393     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02394     BOOLEAN Terminate ;
02395 
02396     
02397     <span class="comment">//</span>
02398     <span class="comment">// Initialize thread control block</span>
02399     <span class="comment">// and insert it into list of IOWorker Threads</span>
02400     <span class="comment">//</span>
02401     
02402     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
02403                 NtCurrentProcess(),
02404                 NtCurrentThread(),
02405                 NtCurrentProcess(),
02406                 &amp;ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a>,
02407                 0,
02408                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02409                 DUPLICATE_SAME_ACCESS
02410                 ) ;
02411 
02412     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02413         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
02414         InterlockedExchange ((ULONG *)<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, (ULONG)~0) ;
02415         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02416     }
02417 
02418     InsertHeadList (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>, &amp;ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
02419     ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o2">Flags</a> = 0 ;
02420     ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o3">LongFunctionFlag</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02421 
02422     InterlockedIncrement(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a>) ;
02423 
02424     
02425     <span class="comment">// We are all initialized now. Notify the starter to queue the task.</span>
02426 
02427     InterlockedExchange ((ULONG *)<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) ;
02428 
02429 
02430 
02431     <span class="comment">// Sleep alertably so that all the activity can take place</span>
02432     <span class="comment">// in APCs</span>
02433 
02434     <span class="keywordflow">for</span> ( ; ; ) {
02435 
02436         <span class="comment">// Set timeout for IdleTimeout</span>
02437 
02438         TimeOut.QuadPart = Int32x32To64( SleepTime, -10000 ) ;
02439 
02440 
02441         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;TimeOut) ;
02442 
02443 
02444         <span class="comment">// Status is STATUS_SUCCESS only when it has timed out</span>
02445         
02446         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
02447             <span class="keywordflow">continue</span> ;
02448         } 
02449 
02450 
02451         <span class="comment">//</span>
02452         <span class="comment">// idle timeout. check if you can terminate the thread</span>
02453         <span class="comment">//</span>
02454         
02455         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02456 
02457         RtlEnterCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
02458 
02459 
02460         <span class="comment">// dont terminate if it is a persistent thread</span>
02461         
02462         <span class="keywordflow">if</span> (ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o2">Flags</a> &amp; WT_EXECUTEINPERSISTENTIOTHREAD) {
02463 
02464             TimeOut.LowPart = 0x0;
02465             TimeOut.HighPart = 0x80000000;
02466 
02467             RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
02468 
02469             <span class="keywordflow">continue</span> ;
02470         }
02471 
02472         
02473         <span class="comment">// The thread terminates if there are &gt; 1 threads and the queue is small</span>
02474         <span class="comment">// OR if there is only 1 thread and there is no request pending</span>
02475 
02476         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> &gt;  1) {
02477 
02478 
02479             ULONG NumEffIOWorkerThreads = <a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> ;
02480             ULONG Threshold ;
02481 
02482             <span class="keywordflow">if</span> (NumEffIOWorkerThreads == 0) {
02483 
02484                 Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02485 
02486             } <span class="keywordflow">else</span> {
02487             
02488                 <span class="comment">// Check if we need to shrink worker thread pool</span>
02489 
02490                 Threshold = <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * (NumEffIOWorkerThreads-1);
02491 
02492 
02493 
02494                 <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a>-<a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> &lt; Threshold)  {
02495 
02496                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02497 
02498                 } <span class="keywordflow">else</span> {
02499 
02500                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02501                     SleepTime &lt;&lt;= 1 ;
02502                 }
02503             }
02504 
02505         } <span class="keywordflow">else</span> {
02506 
02507             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a> == 0) {
02508 
02509                 <span class="comment">// delay termination of last thread</span>
02510 
02511                 <span class="keywordflow">if</span> (SleepTime &lt; 4*<a class="code" href="../../d2/d1/threads_8c.html#a2">IOWORKER_IDLE_TIMEOUT</a>) {
02512                 
02513                     SleepTime &lt;&lt;= 1 ;
02514                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02515 
02516                 } <span class="keywordflow">else</span> {
02517                 
02518                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02519                 }
02520 
02521             } <span class="keywordflow">else</span> {
02522 
02523                 Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02524 
02525             }
02526 
02527         }
02528 
02529         <span class="comment">//</span>
02530         <span class="comment">// terminate only if no io is pending</span>
02531         <span class="comment">//</span>
02532         
02533         <span class="keywordflow">if</span> (Terminate) {
02534 
02535             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02536             THREAD_BASIC_INFORMATION ThreadInfo;
02537             ULONG IsIoPending ;
02538             
02539             Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02540             
02541             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a>,
02542                                                ThreadIsIoPending,
02543                                                &amp;IsIoPending,
02544                                                <span class="keyword">sizeof</span>( IsIoPending ),
02545                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02546                                              );
02547             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02548 
02549                 <span class="keywordflow">if</span> (! IsIoPending )
02550                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02551             }
02552         }
02553 
02554         <span class="keywordflow">if</span> (Terminate) {
02555 
02556             InterlockedDecrement (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a>) ;
02557 
02558             RemoveEntryList (&amp;ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
02559             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a> ) ;
02560             
02561             RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
02562 
02563             <a class="code" href="../../d3/d1/threads_8h.html#a104">RtlpExitThreadFunc</a>( 0 );
02564 
02565         } <span class="keywordflow">else</span> {
02566 
02567             <span class="comment">// This is the condition where a request was queued *after* the</span>
02568             <span class="comment">// thread woke up - ready to terminate because of inactivity. In</span>
02569             <span class="comment">// this case dont terminate - service the completion port.</span>
02570 
02571             RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a97">WorkerCriticalSection</a>) ;
02572 
02573         }
02574     }
02575 
02576     <span class="keywordflow">return</span> 0 ;  <span class="comment">// Keep compiler happy</span>
02577 
02578 }
02579 
02580 
02581 
02582 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02583"></a><a class="code" href="../../d3/d1/threads_8h.html#a147">02583</a> <a class="code" href="../../d3/d1/threads_8h.html#a147">RtlpExecuteLongIOWorkItem</a> (
02584     PVOID Function,
02585     PVOID Context,
02586     PVOID ThreadCB
02587     )
02588 <span class="comment">/*++</span>
02589 <span class="comment"></span>
02590 <span class="comment">Routine Description:</span>
02591 <span class="comment"></span>
02592 <span class="comment">    Executes an IO Work function. RUNs in a APC in the IO Worker thread.</span>
02593 <span class="comment"></span>
02594 <span class="comment">Arguments:</span>
02595 <span class="comment"></span>
02596 <span class="comment">    Function - Worker function to call</span>
02597 <span class="comment"></span>
02598 <span class="comment">    Context - Argument for the worker function.</span>
02599 <span class="comment"></span>
02600 <span class="comment">    NotUsed - Argument is not used in this function.</span>
02601 <span class="comment"></span>
02602 <span class="comment">Return Value:</span>
02603 <span class="comment"></span>
02604 <span class="comment">--*/</span>
02605 {
02606 <span class="preprocessor">    #if (DBG1)</span>
02607 <span class="preprocessor"></span>    <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Function, Context ) ;
02608 <span class="preprocessor">    #endif</span>
02609 <span class="preprocessor"></span>
02610     <span class="comment">// Invoke the function</span>
02611 
02612     <span class="keywordflow">try</span> {
02613         ((WORKERCALLBACKFUNC) Function)((PVOID)Context) ;
02614     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02615         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02616     }
02617 
02618 
02619     ((<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">PRTLP_IOWORKER_TCB</a>)ThreadCB)-&gt;LongFunctionFlag = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02620 
02621     <span class="comment">// Decrement pending IO requests count</span>
02622 
02623     InterlockedDecrement (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a>) ;
02624 
02625     <span class="comment">// decrement pending long funcitons</span>
02626 
02627     InterlockedDecrement (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> ) ;
02628 }
02629 
02630 
02631 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02632"></a><a class="code" href="../../d3/d1/threads_8h.html#a146">02632</a> <a class="code" href="../../d3/d1/threads_8h.html#a146">RtlpExecuteIOWorkItem</a> (
02633     PVOID Function,
02634     PVOID Context,
02635     PVOID NotUsed
02636     )
02637 <span class="comment">/*++</span>
02638 <span class="comment"></span>
02639 <span class="comment">Routine Description:</span>
02640 <span class="comment"></span>
02641 <span class="comment">    Executes an IO Work function. RUNs in a APC in the IO Worker thread.</span>
02642 <span class="comment"></span>
02643 <span class="comment">Arguments:</span>
02644 <span class="comment"></span>
02645 <span class="comment">    Function - Worker function to call</span>
02646 <span class="comment"></span>
02647 <span class="comment">    Context - Argument for the worker function.</span>
02648 <span class="comment"></span>
02649 <span class="comment">    NotUsed - Argument is not used in this function.</span>
02650 <span class="comment"></span>
02651 <span class="comment">Return Value:</span>
02652 <span class="comment"></span>
02653 <span class="comment"></span>
02654 <span class="comment">--*/</span>
02655 {
02656 <span class="preprocessor">    #if (DBG1)</span>
02657 <span class="preprocessor"></span>    <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Function, Context ) ;
02658 <span class="preprocessor">    #endif</span>
02659 <span class="preprocessor"></span>
02660     <span class="comment">// Invoke the function</span>
02661 
02662     <span class="keywordflow">try</span> {
02663         ((WORKERCALLBACKFUNC) Function)((PVOID)Context) ;
02664     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02665         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02666     }
02667 
02668     <span class="comment">// Decrement pending IO requests count</span>
02669 
02670     InterlockedDecrement (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a>) ;
02671 
02672 }
02673 
02674 
02675 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02676 NTAPI
<a name="l02677"></a><a class="code" href="../../d2/d1/threads_8c.html#a30">02677</a> <a class="code" href="../../d3/d1/threads_8h.html#a116">RtlpStartThread</a> (
02678     PUSER_THREAD_START_ROUTINE Function,
02679     HANDLE *ThreadHandle
02680     )
02681 <span class="comment">/*++</span>
02682 <span class="comment"></span>
02683 <span class="comment">Routine Description:</span>
02684 <span class="comment"></span>
02685 <span class="comment">    This routine is used start a new wait thread in the pool.</span>
02686 <span class="comment">Arguments:</span>
02687 <span class="comment"></span>
02688 <span class="comment">    None</span>
02689 <span class="comment"></span>
02690 <span class="comment">Return Value:</span>
02691 <span class="comment"></span>
02692 <span class="comment">    STATUS_SUCCESS - Timer Queue created successfully.</span>
02693 <span class="comment"></span>
02694 <span class="comment">    STATUS_NO_MEMORY - There was not sufficient heap to perform the requested operation.</span>
02695 <span class="comment"></span>
02696 <span class="comment">--*/</span>
02697 {
02698     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02699     ULONG <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> ;
02700     LARGE_INTEGER TimeOut ;
02701 
02702     <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02703 
02704     <span class="comment">// Create the first thread. This thread never dies until the process exits</span>
02705 
02706     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(
02707                    NtCurrentProcess(), <span class="comment">// process handle</span>
02708                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,               <span class="comment">// security descriptor</span>
02709                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,              <span class="comment">// Create suspended?</span>
02710                    0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,                 <span class="comment">// ZeroBits: default</span>
02711                    0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,                 <span class="comment">// Max stack size: default</span>
02712                    0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,                 <span class="comment">// Committed stack size: default</span>
02713                    Function,           <span class="comment">// Function to start in</span>
02714                    &amp;<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>,       <span class="comment">// Event the thread signals when the thread is ready</span>
02715                    <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,       <span class="comment">// Thread handle</span>
02716                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                <span class="comment">// Thread id</span>
02717                    );
02718 
02719     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
02720 
02721         <span class="comment">// Sleep 1 ms and see if the other thread has completed initialization</span>
02722 
02723         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
02724 
02725         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>) {
02726 
02727             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;TimeOut) ;
02728 
02729         }
02730 
02731     }
02732 
02733 
02734     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02735 }
02736 
02737 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02738"></a><a class="code" href="../../d2/d1/threads_8c.html#a31">02738</a> <a class="code" href="../../d2/d1/threads_8c.html#a31">RtlpExitThread</a>(
02739     NTSTATUS Status
02740     )
02741 {
02742     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02743 }
02744 
02745 
02746 
02747 <span class="comment">// Wait functions</span>
02748 
02749 
02750 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02751"></a><a class="code" href="../../d3/d1/threads_8h.html#a114">02751</a> <a class="code" href="../../d2/d1/threads_8c.html#a32">RtlpInitializeWaitThreadPool</a> (
02752     )
02753 <span class="comment">/*++</span>
02754 <span class="comment"></span>
02755 <span class="comment">Routine Description:</span>
02756 <span class="comment"></span>
02757 <span class="comment">    This routine initializes all aspects of the thread pool.</span>
02758 <span class="comment"></span>
02759 <span class="comment">Arguments:</span>
02760 <span class="comment"></span>
02761 <span class="comment">    None</span>
02762 <span class="comment"></span>
02763 <span class="comment">Return Value:</span>
02764 <span class="comment"></span>
02765 <span class="comment">    None</span>
02766 <span class="comment"></span>
02767 <span class="comment">--*/</span>
02768 {
02769     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02770     LARGE_INTEGER TimeOut ;
02771 
02772     <span class="comment">// In order to avoid an explicit RtlInitialize() function to initialize the wait thread pool</span>
02773     <span class="comment">// we use StartedWaitInitialization and CompletedWait Initialization to provide us the</span>
02774     <span class="comment">// necessary synchronization to avoid multiple threads from initializing the thread pool.</span>
02775     <span class="comment">// This scheme does not work if RtlInitializeCriticalSection() or NtCreateEvent fails - but in this case the</span>
02776     <span class="comment">// caller has not choices left.</span>
02777 
02778     <span class="keywordflow">if</span> (!InterlockedExchange(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a66">StartedWaitInitialization</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
02779 
02780         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a>)
02781             InterlockedExchange (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) ;
02782 
02783         <span class="comment">// Initialize Critical Section</span>
02784 
02785         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a98">WaitCriticalSection</a> ) ;
02786 
02787         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
02788 
02789             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) ;
02790 
02791             <a class="code" href="../../d3/d1/threads_8h.html#a66">StartedWaitInitialization</a> = 0 ;
02792             InterlockedExchange (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a>, ~0) ;
02793             
02794             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02795         }
02796             
02797         InitializeListHead (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a>);  <span class="comment">// Initialize global wait threads list</span>
02798 
02799         InterlockedExchange (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) ;
02800 
02801     } <span class="keywordflow">else</span> {
02802 
02803         <span class="comment">// Sleep 1 ms and see if the other thread has completed initialization</span>
02804 
02805         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
02806 
02807         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a>) {
02808 
02809             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;TimeOut) ;
02810 
02811         }
02812 
02813         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a> != 1) {
02814             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY ;
02815         }
02816     }
02817 
02818     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02819 }
02820 
02821 
02822 
02823 LONG
<a name="l02824"></a><a class="code" href="../../d2/d1/threads_8c.html#a33">02824</a> <a class="code" href="../../d3/d1/threads_8h.html#a117">RtlpWaitThread</a> (
02825     PVOID  Initialized
02826     )
02827 <span class="comment">/*++</span>
02828 <span class="comment"></span>
02829 <span class="comment">Routine Description:</span>
02830 <span class="comment"></span>
02831 <span class="comment">    This routine is used for all waits in the wait thread pool</span>
02832 <span class="comment"></span>
02833 <span class="comment">Arguments:</span>
02834 <span class="comment"></span>
02835 <span class="comment">    Initialized - This is set to 1 when the thread has initialized</span>
02836 <span class="comment"></span>
02837 <span class="comment">Return Value:</span>
02838 <span class="comment"></span>
02839 <span class="comment">    Nothing. The thread never terminates.</span>
02840 <span class="comment"></span>
02841 <span class="comment">--*/</span>
02842 {
02843     ULONG  i ;                                   <span class="comment">// Used as an index</span>
02844     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02845     LARGE_INTEGER TimeOut;                       <span class="comment">// Timeout used for waits</span>
02846     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB ;   <span class="comment">// Control Block allocated on the stack</span>
02847 <span class="preprocessor">#define WAIT_IDLE_TIMEOUT 400000</span>
02848 <span class="preprocessor"></span>
02849 
02850     <span class="keywordflow">try</span> {
02851         ThreadCB = (<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a>)
02852                         _alloca(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">RTLP_WAIT_THREAD_CONTROL_BLOCK</a>));
02853 
02854     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02855     
02856         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02857         InterlockedExchange ((ULONG *)<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, (ULONG)~0) ;
02858         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02859     }
02860     
02861 
02862     
02863     <span class="comment">// Initialize thread control block</span>
02864 
02865     InitializeListHead (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o0">WaitThreadsList</a>) ;
02866 
02867     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
02868                 NtCurrentProcess(),
02869                 NtCurrentThread(),
02870                 NtCurrentProcess(),
02871                 &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>,
02872                 0,
02873                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02874                 DUPLICATE_SAME_ACCESS
02875                 ) ;
02876 
02877     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02878         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
02879         InterlockedExchange ((ULONG *)<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, (ULONG)~0) ;
02880         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02881     }
02882 
02883     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o2">ThreadId</a> =  HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
02884 
02885     RtlZeroMemory (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[0], sizeof (HANDLE) * 64) ;
02886 
02887     RtlZeroMemory (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[0], sizeof (HANDLE) * 64) ;
02888 
02889 
02890 
02891     <span class="comment">// Initialize the timer related fields.</span>
02892 
02893     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d2/timer_8c.html#a11">NtCreateTimer</a>(
02894                  &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>,
02895                  TIMER_ALL_ACCESS,
02896                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02897                  NotificationTimer
02898                  ) ;
02899 
02900     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02901         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02902         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>) ;
02903         InterlockedExchange ((ULONG *)<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, (ULONG)~0) ;
02904         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02905     }
02906     
02907 
02908     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o12">Firing64BitTickCount</a> = 0 ;
02909     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o11">Current64BitTickCount</a>.QuadPart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
02910 
02911     <span class="comment">// Reset the NT Timer to never fire initially</span>
02912 
02913     <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, -1, ThreadCB) ;
02914     
02915     InitializeListHead (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.TimerList) ;
02916     InitializeListHead (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.UncancelledTimerList) ;
02917 
02918     
02919     <span class="comment">// Initialize the timer blocks</span>
02920 
02921     RtlZeroMemory (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o9">TimerBlocks</a>[0], sizeof (<a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>) * 63) ;
02922 
02923     InitializeListHead (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o10">FreeTimerBlocks</a>) ;
02924 
02925     <span class="keywordflow">for</span> (i = 0 ; i &lt; 63 ; i++) {
02926 
02927         InitializeListHead (&amp;(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o9">TimerBlocks</a>[i])-&gt;List) ;
02928         InsertHeadList (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o10">FreeTimerBlocks</a>, &amp;(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o9">TimerBlocks</a>[i])-&gt;List) ;
02929 
02930     }
02931 
02932 
02933     <span class="comment">// Insert this new wait thread in the WaitThreads list. Insert at the head so that</span>
02934     <span class="comment">// the request that caused this thread to be created can find it right away.</span>
02935 
02936     InsertHeadList (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a>, &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o0">WaitThreadsList</a>) ;
02937 
02938 
02939     <span class="comment">// The first wait element is the timer object</span>
02940 
02941     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[0] = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a> ;
02942 
02943     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> = 1 ;
02944 
02945 
02946     <span class="comment">// till here, the function is running under the global wait lock</span>
02947 
02948 
02949     
02950     <span class="comment">// We are all initialized now. Notify the starter to queue the task.</span>
02951 
02952     InterlockedExchange ((ULONG *)<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, 1) ;
02953 
02954 
02955     <span class="comment">// Loop forever - wait threads never, never die.</span>
02956 
02957     <span class="keywordflow">for</span> ( ; ; ) {
02958 
02959         <span class="keywordflow">if</span> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> == 1)
02960             TimeOut.QuadPart = Int32x32To64( <a class="code" href="../../d2/d1/threads_8c.html#a3">WAIT_IDLE_TIMEOUT</a>, -10000 ) ;
02961 
02962         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a5">NtWaitForMultipleObjects</a> (
02963                      (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>) ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>,
02964                      ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>,
02965                      WaitAny,
02966                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,      <span class="comment">// Wait Alertably</span>
02967                      ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a>!=1 ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : &amp;TimeOut       <span class="comment">// Wait forever</span>
02968                      ) ;
02969 
02970         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALERTED || <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
02971 
02972             <span class="keywordflow">continue</span> ;
02973 
02974         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &gt;= STATUS_WAIT_0 &amp;&amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &lt;= STATUS_WAIT_63) {
02975 
02976             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_WAIT_0) {
02977 
02978                 <a class="code" href="../../d3/d1/threads_8h.html#a135">RtlpProcessTimeouts</a> (ThreadCB) ;
02979 
02980             } <span class="keywordflow">else</span> {
02981 
02982                 <span class="comment">// Wait completed call Callback function</span>
02983 
02984                 <a class="code" href="../../d3/d1/threads_8h.html#a134">RtlpProcessWaitCompletion</a> (
02985                         ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>], <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ;
02986 
02987             }
02988 
02989         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &gt;= STATUS_ABANDONED_WAIT_0 
02990                     &amp;&amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &lt;= STATUS_ABANDONED_WAIT_63) {
02991 
02992 <span class="preprocessor">            #if DBG</span>
02993 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"RTL ThreadPool Wait Thread: Abandoned wait: %d\n"</span>,
02994                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - STATUS_ABANDONED_WAIT_0 ) ;
02995 <span class="preprocessor">            #endif</span>
02996 <span class="preprocessor"></span>
02997             
02998             <span class="comment">// Abandoned wait</span>
02999 
03000             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
03001 
03002         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
03003 
03004             <span class="comment">//</span>
03005             <span class="comment">// remove this thread from the wait list and terminate</span>
03006             <span class="comment">//</span>
03007 
03008             {
03009                 ULONG NumWaits;
03010                 
03011                 <a class="code" href="../../d3/d1/threads_8h.html#a19">ACQUIRE_GLOBAL_WAIT_LOCK</a>() ;
03012 
03013                 NumWaits = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a>;
03014                 
03015                 <span class="keywordflow">if</span> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> &lt;= 1) {
03016                     RemoveEntryList(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o0">WaitThreadsList</a>) ;
03017                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>) ;
03018                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>) ;
03019                 }
03020 
03021                 <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>() ;
03022 
03023                 <span class="keywordflow">if</span> (NumWaits &lt;= 1) {
03024 
03025                     <a class="code" href="../../d3/d1/threads_8h.html#a104">RtlpExitThreadFunc</a>( 0 );
03026                 }
03027             }
03028             
03029         } <span class="keywordflow">else</span> {
03030 
03031             <span class="comment">// Some other error: fatal condition</span>
03032             ULONG i ;
03033             
03034 <span class="comment">//            ASSERTMSG( "Press 'i', and note the dbgprint\n", FALSE ) ;</span>
03035 
03036 <span class="preprocessor">            #if DBG</span>
03037 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"RTL Thread Pool: Application closed an object handle "</span>
03038                         <span class="stringliteral">"that the wait thread was waiting on: Code:%x ThreadId:&lt;%x:%x&gt;\n"</span>,
03039                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03040                         HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
03041 
03042             TimeOut.QuadPart = 0 ;
03043 
03044             <span class="keywordflow">for</span> (i=0;  i&lt;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>;  i++) {
03045 
03046                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a5">NtWaitForMultipleObjects</a>(
03047                              (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>) 1,
03048                              &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[i],
03049                              WaitAny,
03050                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,      <span class="comment">// Wait Alertably</span>
03051                              &amp;TimeOut   <span class="comment">// Dont 0</span>
03052                              ) ;
03053 
03054                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_HANDLE) {
03055                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Bad Handle index:%d WaitEntry Ptr:%x\n"</span>,
03056                                 i, ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[i]) ;
03057                 }
03058             }
03059             
03060 <span class="preprocessor">            #endif</span>
03061 <span class="preprocessor"></span>
03062             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
03063 
03064             
03065             <span class="comment">// Set timeout for the largest timeout possible</span>
03066 
03067             TimeOut.LowPart = 0 ;
03068             TimeOut.HighPart = 0x80000000 ;
03069 
03070             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;TimeOut) ;
03071             
03072         }
03073 
03074     } <span class="comment">// forever</span>
03075 
03076     <span class="keywordflow">return</span> 0 ; <span class="comment">// Keep compiler happy</span>
03077 
03078 }
03079 
03080 
03081 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03082"></a><a class="code" href="../../d2/d1/threads_8c.html#a34">03082</a> <a class="code" href="../../d2/d1/threads_8c.html#a34">RtlpAsyncCallbackCompletion</a>(
03083     PVOID Context
03084     )
03085 <span class="comment">/*++</span>
03086 <span class="comment"></span>
03087 <span class="comment">Routine Description:</span>
03088 <span class="comment"></span>
03089 <span class="comment">    This routine is called in a (IO)worker thread and is used to decrement the </span>
03090 <span class="comment">    RefCount at the end and call RtlpDelete(Wait/Timer) if required</span>
03091 <span class="comment"></span>
03092 <span class="comment">Arguments:</span>
03093 <span class="comment"></span>
03094 <span class="comment">    Context - AsyncCallback: containing pointer to Wait/Timer object, </span>
03095 <span class="comment"></span>
03096 <span class="comment">Return Value:</span>
03097 <span class="comment"></span>
03098 <span class="comment">--*/</span>
03099 {
03100     <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">PRTLP_ASYNC_CALLBACK</a> AsyncCallback ;
03101     
03102     AsyncCallback = (<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">PRTLP_ASYNC_CALLBACK</a>) Context ;
03103 
03104     <span class="comment">// callback queued by WaitThread (event or timer)</span>
03105     
03106     <span class="keywordflow">if</span> ( AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o2">WaitThreadCallback</a> ) {
03107 
03108         <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait = AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o0">Wait</a> ;
03109 
03110         <span class="comment">//DPRN5</span>
03111         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a38">DPRN4</a>)
03112         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling WaitOrTimer: fn:%x  context:%x  bool:%d Thread&lt;%d:%d&gt;\n"</span>,
03113                 (ULONG_PTR)Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>, (ULONG_PTR)Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a>,
03114                 (ULONG_PTR)AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o3">TimerCondition</a>,
03115                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03116                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)
03117                 ) ;
03118 
03119 <span class="preprocessor">        #if (DBG1)</span>
03120 <span class="preprocessor"></span>        <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a> ) ;
03121 <span class="preprocessor">        #endif</span>
03122 <span class="preprocessor"></span>        
03123         ((WAITORTIMERCALLBACKFUNC) Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>) 
03124                                 ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a>, AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o3">TimerCondition</a> ) ;
03125 
03126         <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ) == 0 ) {
03127 
03128             <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a>( Wait ) ;            
03129         }
03130 
03131     }
03132 
03133     <span class="comment">// callback queued by TimerThread</span>
03134     
03135     <span class="keywordflow">else</span> {
03136 
03137         <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer = AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o1">Timer</a> ;
03138 
03139         <span class="comment">//DPRN5</span>
03140         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a38">DPRN4</a>)
03141         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling WaitOrTimer:Timer: fn:%x  context:%x  bool:%d Thread&lt;%d:%d&gt;\n"</span>,
03142                 (ULONG_PTR)Timer-&gt;Function, (ULONG_PTR)Timer-&gt;Context,
03143                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03144                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03145                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)
03146                 ) ;
03147                 
03148 <span class="preprocessor">        #if (DBG1)</span>
03149 <span class="preprocessor"></span>        <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Timer-&gt;Function, Timer-&gt;Context ) ;
03150 <span class="preprocessor">        #endif</span>
03151 <span class="preprocessor"></span>  
03152 
03153         ((WAITORTIMERCALLBACKFUNC) Timer-&gt;Function) ( Timer-&gt;Context , <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ;
03154 
03155 
03156         <span class="comment">// decrement RefCount after function is executed so that the context is not deleted</span>
03157         
03158         <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Timer-&gt;RefCount ) == 0 ) {
03159         
03160             <a class="code" href="../../d3/d1/threads_8h.html#a155">RtlpDeleteTimer</a>( Timer ) ;            
03161         }
03162         
03163     }
03164 
03165     
03166     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( AsyncCallback );
03167 
03168 }
03169 
03170 
03171 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03172"></a><a class="code" href="../../d3/d1/threads_8h.html#a134">03172</a> <a class="code" href="../../d3/d1/threads_8h.html#a134">RtlpProcessWaitCompletion</a> (
03173     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait,
03174     ULONG ArrayIndex
03175     )
03176 <span class="comment">/*++</span>
03177 <span class="comment"></span>
03178 <span class="comment">Routine Description:</span>
03179 <span class="comment"></span>
03180 <span class="comment">    This routine is used for processing a completed wait</span>
03181 <span class="comment"></span>
03182 <span class="comment">Arguments:</span>
03183 <span class="comment"></span>
03184 <span class="comment">    Wait - Wait that completed</span>
03185 <span class="comment"></span>
03186 <span class="comment">Return Value:</span>
03187 <span class="comment"></span>
03188 <span class="comment">--*/</span>
03189 {
03190     ULONG TimeRemaining ;
03191     ULONG NewFiringTime ;
03192     LARGE_INTEGER DueTime ;
03193     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB ;
03194     <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">PRTLP_ASYNC_CALLBACK</a> AsyncCallback ;
03195 
03196     ThreadCB = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a> ;
03197 
03198     <span class="comment">// deactivate wait if it is meant for single execution</span>
03199     
03200     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> &amp; WT_EXECUTEONLYONCE ) {
03201 
03202         <a class="code" href="../../d3/d1/threads_8h.html#a132">RtlpDeactivateWait</a> (Wait) ;
03203     } 
03204 
03205     <span class="keywordflow">else</span> {
03206         <span class="comment">// if wait being reactivated, then reset the timer now itself as</span>
03207         <span class="comment">// it can be deleted in the callback function</span>
03208 
03209         <span class="keywordflow">if</span>  ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> ) {
03210 
03211             TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>) ;
03212 
03213             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (
03214                         &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.TimerList,
03215                         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>,
03216                         TimeRemaining,
03217                         &amp;NewFiringTime,
03218                         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o13">Period</a>)) {
03219 
03220                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
03221                 <span class="comment">// timer to fire later</span>
03222 
03223                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, NewFiringTime, ThreadCB) ;
03224             }
03225 
03226         }
03227 
03228         <span class="comment">// move the wait entry to the end, and shift elements to its right one pos towards left</span>
03229         {
03230             HANDLE HandlePtr = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[ArrayIndex];
03231             <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> WaitPtr = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[ArrayIndex];
03232 
03233             <a class="code" href="../../d3/d1/threads_8h.html#a25">RtlpShiftWaitArray</a>(ThreadCB, ArrayIndex+1, ArrayIndex,
03234                             ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> -1 - ArrayIndex)
03235             ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>-1] = HandlePtr ;
03236             ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>-1] = WaitPtr ;
03237         }
03238     }
03239     
03240     <span class="comment">// call callback function (FALSE since this isnt a timeout related callback)</span>
03241 
03242     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> &amp; WT_EXECUTEINWAITTHREAD ) {
03243     
03244         <span class="comment">// executing callback after RtlpDeactivateWait allows the Callback to call</span>
03245         <span class="comment">// RtlDeregisterWait Wait-&gt;RefCount is not incremented so that RtlDeregisterWait </span>
03246         <span class="comment">// will work on this Wait. Though Wait-&gt;RefCount is not incremented, others cannot</span>
03247         <span class="comment">// deregister this Wait as it has to be queued as an APC.</span>
03248 
03249         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a38">DPRN4</a>)
03250         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling WaitOrTimer(wait): fn:%x  context:%x  bool:%d Thread&lt;%d:%d&gt;\n"</span>,
03251                 (ULONG_PTR)Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>, (ULONG_PTR)Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a>,
03252                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03253                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03254                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)
03255                 ) ;
03256                 
03257 <span class="preprocessor">        #if (DBG1)</span>
03258 <span class="preprocessor"></span>        <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a> ) ;
03259 <span class="preprocessor">        #endif</span>
03260 <span class="preprocessor"></span>        
03261         
03262         ((WAITORTIMERCALLBACKFUNC)(Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>))(Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
03263 
03264 
03265         <span class="comment">// Wait object could have been deleted in the above callback</span>
03266         
03267         <span class="keywordflow">return</span> ;
03268 
03269         
03270     } <span class="keywordflow">else</span> {
03271 
03272         AsyncCallback = <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a>( <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">RTLP_ASYNC_CALLBACK</a> ), 0 );
03273         
03274         <span class="keywordflow">if</span> ( AsyncCallback ) {
03275 
03276             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03277             
03278             AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o0">Wait</a> = Wait ;
03279             AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o2">WaitThreadCallback</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03280             AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o3">TimerCondition</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03281 
03282             InterlockedIncrement( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ) ;
03283 
03284             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>( <a class="code" href="../../d2/d1/threads_8c.html#a34">RtlpAsyncCallbackCompletion</a>, AsyncCallback,
03285                                 Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> );
03286 
03287 
03288             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03289 
03290                 <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( AsyncCallback );
03291 
03292                 <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ) == 0 ) {
03293                     <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a>( Wait ) ;
03294                 }
03295             }
03296         }
03297     }
03298 }
03299 
03300 
03301 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03302"></a><a class="code" href="../../d3/d1/threads_8h.html#a130">03302</a> <a class="code" href="../../d3/d1/threads_8h.html#a130">RtlpAddWait</a> (
03303     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait
03304     )
03305 <span class="comment">/*++</span>
03306 <span class="comment"></span>
03307 <span class="comment">Routine Description:</span>
03308 <span class="comment"></span>
03309 <span class="comment">    This routine is used for adding waits to the wait thread. It is executed in</span>
03310 <span class="comment">    an APC.</span>
03311 <span class="comment"></span>
03312 <span class="comment">Arguments:</span>
03313 <span class="comment"></span>
03314 <span class="comment">    Wait - The wait to add</span>
03315 <span class="comment"></span>
03316 <span class="comment">Return Value:</span>
03317 <span class="comment"></span>
03318 <span class="comment">--*/</span>
03319 {
03320     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a>;
03321 
03322 
03323     <span class="comment">// if the state is deleted, it implies that RtlDeregister was called in a</span>
03324     <span class="comment">// WaitThreadCallback for a Wait other than that which was fired. This is </span>
03325     <span class="comment">// an application bug. I Assert, but also handle it.</span>
03326     
03327     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> &amp; <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ) {
03328 
03329         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
03330 
03331         InterlockedDecrement( &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> ) ;
03332         
03333         <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a> (Wait) ;
03334 
03335         <span class="keywordflow">return</span> ;
03336     }
03337 
03338     
03339     <span class="comment">// activate Wait</span>
03340         
03341     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a> [ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>] = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o1">WaitHandle</a> ;
03342     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>] = Wait ;
03343     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> ++ ;
03344     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> |= (<a class="code" href="../../d3/d1/threads_8h.html#a41">STATE_REGISTERED</a> | <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a>) ;
03345     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> = 1 ;
03346 
03347 
03348     <span class="comment">// Fill in the wait timer</span>
03349 
03350     <span class="keywordflow">if</span> (Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> != <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a>) {
03351 
03352         ULONG TimeRemaining ;
03353         ULONG NewFiringTime ;
03354 
03355         <span class="comment">// Initialize timer related fields and insert the timer in the timer queue for</span>
03356         <span class="comment">// this wait thread</span>
03357 
03358         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> = (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>) RemoveHeadList(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o10">FreeTimerBlocks</a>);
03359         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o11">Function</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a> ;
03360         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o12">Context</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a> ;
03361         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o10">Flags</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> ;
03362         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> ;
03363         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o13">Period</a> = ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> &amp; WT_EXECUTEONLYONCE )
03364                                 ? 0 
03365                                 : Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> == <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a>
03366                                 ? 0 : Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> ;
03367 
03368         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o4">State</a> = ( <a class="code" href="../../d3/d1/threads_8h.html#a41">STATE_REGISTERED</a> | <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) ; ;
03369         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o9">Wait</a> = Wait ;
03370         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o3">RefCountPtr</a> = &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ;
03371         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o8">Queue</a> = &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a> ;
03372 
03373         
03374         TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>) ;
03375 
03376         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.TimerList, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>,
03377                                     TimeRemaining, &amp;NewFiringTime)) 
03378         {
03379             <span class="comment">// If the element was inserted at head of list then reset the timers</span>
03380 
03381             <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, NewFiringTime, ThreadCB) ;
03382         }
03383 
03384     } <span class="keywordflow">else</span> {
03385 
03386         <span class="comment">// No timer with this wait</span>
03387 
03388         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
03389 
03390     }
03391 
03392     <span class="keywordflow">return</span> ;
03393 }
03394 
03395 
03396 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03397"></a><a class="code" href="../../d3/d1/threads_8h.html#a131">03397</a> <a class="code" href="../../d3/d1/threads_8h.html#a131">RtlpDeregisterWait</a> (
03398     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait,
03399     HANDLE PartialCompletionEvent,
03400     PULONG RetStatusPtr
03401     )
03402 <span class="comment">/*++</span>
03403 <span class="comment"></span>
03404 <span class="comment">Routine Description:</span>
03405 <span class="comment"></span>
03406 <span class="comment">    This routine is used for deregistering the specified wait.</span>
03407 <span class="comment"></span>
03408 <span class="comment">Arguments:</span>
03409 <span class="comment"></span>
03410 <span class="comment">    Wait - The wait to deregister</span>
03411 <span class="comment"></span>
03412 <span class="comment">Return Value:</span>
03413 <span class="comment"></span>
03414 <span class="comment">--*/</span>
03415 {
03416     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
03417     ULONG DontUse ;
03418     PULONG RetStatus = RetStatusPtr ? RetStatusPtr : &amp;DontUse;
03419     
03420     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>(Wait) ;
03421 
03422     
03423     <span class="comment">// RtlpDeregisterWait can be called on a wait that has not yet been</span>
03424     <span class="comment">// registered. This indicates that someone calls a RtlDeregisterWait</span>
03425     <span class="comment">// inside a WaitThreadCallback for a Wait other than that was fired.</span>
03426     <span class="comment">// Application bug!! I assert but handle it</span>
03427     
03428     <span class="keywordflow">if</span> ( ! (Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> &amp; <a class="code" href="../../d3/d1/threads_8h.html#a41">STATE_REGISTERED</a>) ) {
03429 
03430         <span class="comment">// set state to deleted, so that it does not get registered</span>
03431         
03432         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> |= <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ;
03433         
03434         InterlockedDecrement( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ) ;
03435 
03436         <span class="keywordflow">if</span> ( PartialCompletionEvent ) {
03437         
03438             <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( PartialCompletionEvent, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ;
03439         }
03440 
03441         *RetStatus = STATUS_SUCCESS ;
03442         <span class="keywordflow">return</span> STATUS_SUCCESS ;
03443     }
03444 
03445 
03446     <span class="comment">// deactivate wait.</span>
03447     
03448     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> &amp; <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) {
03449 
03450         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d2/d1/threads_8c.html#a38">RtlpDeactivateWait</a> ( Wait ) ) ) {
03451 
03452             *RetStatus = STATUS_NOT_FOUND ;
03453             <span class="keywordflow">return</span> STATUS_NOT_FOUND ;
03454         }
03455     }
03456 
03457     <span class="comment">// delete wait if RefCount == 0</span>
03458 
03459     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> |= <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ;
03460     
03461     <span class="keywordflow">if</span> ( InterlockedDecrement (&amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a>) == 0 ) {
03462 
03463         <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a> ( Wait ) ;
03464 
03465         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = *RetStatus = STATUS_SUCCESS ;
03466 
03467     } <span class="keywordflow">else</span> {
03468 
03469         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = *RetStatus = STATUS_PENDING ;
03470     }
03471 
03472     <span class="keywordflow">if</span> ( PartialCompletionEvent ) {
03473     
03474         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( PartialCompletionEvent, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ;
03475     }
03476 
03477         
03478     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
03479 }
03480 
03481 
03482 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03483"></a><a class="code" href="../../d3/d1/threads_8h.html#a132">03483</a> <a class="code" href="../../d3/d1/threads_8h.html#a132">RtlpDeactivateWait</a> (
03484     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait
03485     )
03486 <span class="comment">/*++</span>
03487 <span class="comment"></span>
03488 <span class="comment">Routine Description:</span>
03489 <span class="comment"></span>
03490 <span class="comment">    This routine is used for deactivating the specified wait. It is executed in a APC.</span>
03491 <span class="comment"></span>
03492 <span class="comment">Arguments:</span>
03493 <span class="comment"></span>
03494 <span class="comment">    Wait - The wait to deactivate</span>
03495 <span class="comment"></span>
03496 <span class="comment">Return Value:</span>
03497 <span class="comment"></span>
03498 <span class="comment">--*/</span>
03499 {
03500     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a> ;
03501     ULONG ArrayIndex ; <span class="comment">//Index in ActiveWaitArray where the Wait object is placed</span>
03502     ULONG EndIndex = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> -1;
03503 
03504     <span class="comment">// get the index in ActiveWaitArray</span>
03505     
03506     <span class="keywordflow">for</span> (ArrayIndex = 0;  ArrayIndex &lt;= EndIndex; ArrayIndex++) {
03507 
03508         <span class="keywordflow">if</span> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[ArrayIndex] == Wait)
03509             <span class="keywordflow">break</span> ;
03510     }
03511 
03512     <span class="keywordflow">if</span> ( ArrayIndex &gt; EndIndex ) {
03513     
03514         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
03515         <span class="keywordflow">return</span> STATUS_NOT_FOUND;
03516     }
03517 
03518 
03519     <span class="comment">// Move the remaining ActiveWaitArray left.</span>
03520 
03521     <a class="code" href="../../d3/d1/threads_8h.html#a25">RtlpShiftWaitArray</a>( ThreadCB, ArrayIndex+1, ArrayIndex,
03522                     EndIndex - ArrayIndex ) ;
03523 
03524 
03525     <span class="comment">//</span>
03526     <span class="comment">// delete timer if associated with this wait</span>
03527     <span class="comment">//</span>
03528     <span class="comment">// Though timer is being "freed" here, if it is in the timersToBeFired</span>
03529     <span class="comment">// list, some of its fields will be used later</span>
03530     <span class="comment">//</span>
03531     
03532     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> ) {
03533     
03534         ULONG TimeRemaining ;
03535         ULONG NewFiringTime ;
03536 
03537         <span class="keywordflow">if</span> (! (Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o4">State</a> &amp; <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a>) ) {
03538         
03539             RemoveEntryList( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a> ) ;
03540 
03541         } <span class="keywordflow">else</span> {
03542 
03543             TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>) ;
03544             
03545             
03546             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.TimerList, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>, 
03547                                             TimeRemaining, &amp;NewFiringTime)) 
03548             {
03549 
03550                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, NewFiringTime, ThreadCB) ;
03551             }
03552         }
03553 
03554         
03555         InsertTailList (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o10">FreeTimerBlocks</a>, &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) ;
03556 
03557         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
03558     }
03559 
03560     <span class="comment">// Decrement the (active) wait count</span>
03561 
03562     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>-- ;
03563     InterlockedDecrement( &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> ) ;
03564     
03565     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> &amp;= ~<a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ;
03566 
03567     <span class="keywordflow">return</span> STATUS_SUCCESS;
03568 
03569 }
03570 
03571 
03572 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03573"></a><a class="code" href="../../d3/d1/threads_8h.html#a133">03573</a> <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a> (
03574     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait
03575     )
03576 <span class="comment">/*++</span>
03577 <span class="comment"></span>
03578 <span class="comment">Routine Description:</span>
03579 <span class="comment"></span>
03580 <span class="comment">    This routine is used for deleting the specified wait. It can be executed</span>
03581 <span class="comment">    outside the context of the wait thread. So structure except the WaitEntry</span>
03582 <span class="comment">    can be changed. It also sets the event.</span>
03583 <span class="comment"></span>
03584 <span class="comment">Arguments:</span>
03585 <span class="comment"></span>
03586 <span class="comment">    Wait - The wait to delete</span>
03587 <span class="comment"></span>
03588 <span class="comment">Return Value:</span>
03589 <span class="comment"></span>
03590 <span class="comment">--*/</span>
03591 {
03592     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>( Wait ) ;
03593     <a class="code" href="../../d3/d1/threads_8h.html#a32">CLEAR_SIGNATURE</a>( Wait ) ;
03594 
03595 <span class="preprocessor">    #if DBG1</span>
03596 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
03597     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Wait %x deleted in thread:%d\n\n"</span>, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o10">DbgId</a>, 
03598             (ULONG_PTR)Wait,
03599             HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread)) ;
03600 <span class="preprocessor">    #endif</span>
03601 <span class="preprocessor"></span>
03602     
03603     <span class="keywordflow">if</span> ( Wait-&gt;CompletionEvent ) {
03604 
03605         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( Wait-&gt;CompletionEvent, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ;
03606     }
03607 
03608     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Wait) ;
03609 
03610     <span class="keywordflow">return</span> ;
03611 }
03612 
03613 
03614 
03615 
03616 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03617"></a><a class="code" href="../../d3/d1/threads_8h.html#a160">03617</a> <a class="code" href="../../d3/d1/threads_8h.html#a160">RtlpDoNothing</a> (
03618     PVOID NotUsed1,
03619     PVOID NotUsed2,
03620     PVOID NotUsed3
03621     )
03622 <span class="comment">/*++</span>
03623 <span class="comment"></span>
03624 <span class="comment">Routine Description:</span>
03625 <span class="comment"></span>
03626 <span class="comment">    This routine is used to see if the thread is alive</span>
03627 <span class="comment"></span>
03628 <span class="comment">Arguments:</span>
03629 <span class="comment"></span>
03630 <span class="comment">    NotUsed1, NotUsed2 and NotUsed 3 - not used</span>
03631 <span class="comment"></span>
03632 <span class="comment">Return Value:</span>
03633 <span class="comment"></span>
03634 <span class="comment">    None</span>
03635 <span class="comment"></span>
03636 <span class="comment">--*/</span>
03637 {
03638 
03639 }
03640 
03641 
03642 __inline
03643 LONGLONG
<a name="l03644"></a><a class="code" href="../../d2/d1/threads_8c.html#a41">03644</a> <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(
03645     LARGE_INTEGER *Last64BitTickCount
03646     )
03647 <span class="comment">/*++</span>
03648 <span class="comment"></span>
03649 <span class="comment">Routine Description:</span>
03650 <span class="comment"></span>
03651 <span class="comment">    This routine is used for getting the latest 64bit tick count.</span>
03652 <span class="comment"></span>
03653 <span class="comment">Arguments:</span>
03654 <span class="comment"></span>
03655 <span class="comment">Return Value: 64bit tick count</span>
03656 <span class="comment"></span>
03657 <span class="comment">--*/</span>
03658 {
03659     LARGE_INTEGER liCurTime ;
03660 
03661     liCurTime.QuadPart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() + <a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>-&gt;HighPart ;
03662 
03663     <span class="comment">// see if timer has wrapped.</span>
03664 
03665     <span class="keywordflow">if</span> (liCurTime.LowPart &lt; <a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>-&gt;LowPart) {
03666         liCurTime.HighPart++ ;
03667     }
03668 
03669     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>-&gt;QuadPart = liCurTime.QuadPart) ;
03670 }
03671 
03672 __inline
03673 LONGLONG
<a name="l03674"></a><a class="code" href="../../d2/d1/threads_8c.html#a42">03674</a> <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>(
03675     )
03676 <span class="comment">/*++</span>
03677 <span class="comment"></span>
03678 <span class="comment">Routine Description:</span>
03679 <span class="comment"></span>
03680 <span class="comment">    This routine is used for getting the latest 64bit tick count.</span>
03681 <span class="comment"></span>
03682 <span class="comment">Arguments:</span>
03683 <span class="comment"></span>
03684 <span class="comment">Return Value: 64bit tick count</span>
03685 <span class="comment"></span>
03686 <span class="comment">Remarks: This call should be made in the first line of any APC queued</span>
03687 <span class="comment">    to the timer thread and nowhere else. It is used to reduce the drift</span>
03688 <span class="comment"></span>
03689 <span class="comment">--*/</span>
03690 {
03691     <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/threads_8h.html#a110">Resync64BitTickCount</a>.QuadPart = 
03692                     <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>);
03693 }
03694 
03695 
03696 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03697"></a><a class="code" href="../../d3/d1/threads_8h.html#a135">03697</a> <a class="code" href="../../d3/d1/threads_8h.html#a135">RtlpProcessTimeouts</a> (
03698     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB
03699     )
03700 <span class="comment">/*++</span>
03701 <span class="comment"></span>
03702 <span class="comment">Routine Description:</span>
03703 <span class="comment"></span>
03704 <span class="comment">    This routine processes timeouts for the wait thread</span>
03705 <span class="comment"></span>
03706 <span class="comment">Arguments:</span>
03707 <span class="comment"></span>
03708 <span class="comment">    ThreadCB - The wait thread to add the wait to</span>
03709 <span class="comment"></span>
03710 <span class="comment">Return Value:</span>
03711 <span class="comment"></span>
03712 <span class="comment">--*/</span>
03713 {
03714     ULONG NewFiringTime, TimeRemaining ;
03715     LIST_ENTRY TimersToFireList ;
03716 
03717     <span class="comment">//</span>
03718     <span class="comment">// check if incorrect timer fired</span>
03719     <span class="comment">//</span>
03720     <span class="keywordflow">if</span> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o12">Firing64BitTickCount</a> &gt;
03721             <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o11">Current64BitTickCount</a>) + 200 )
03722     {
03723         <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, 
03724                     <a class="code" href="../../d2/d1/threads_8c.html#a53">RtlpGetTimeRemaining</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>),
03725                     ThreadCB) ;
03726 
03727         <span class="keywordflow">return</span> ;
03728     }
03729  
03730     InitializeListHead( &amp;TimersToFireList ) ;
03731 
03732     
03733     <span class="comment">// Walk thru the timer list and fire all waits with DeltaFiringTime == 0</span>
03734 
03735     <a class="code" href="../../d3/d1/threads_8h.html#a124">RtlpFireTimersAndReorder</a> (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>, &amp;NewFiringTime, &amp;TimersToFireList) ;
03736 
03737     <span class="comment">// Reset the NT timer</span>
03738 
03739     <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, NewFiringTime, ThreadCB) ;
03740 
03741 
03742     <a class="code" href="../../d3/d1/threads_8h.html#a125">RtlpFireTimers</a>( &amp;TimersToFireList ) ;    
03743 }
03744 
03745 
03746 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03747"></a><a class="code" href="../../d3/d1/threads_8h.html#a125">03747</a> <a class="code" href="../../d3/d1/threads_8h.html#a125">RtlpFireTimers</a> (
03748     PLIST_ENTRY TimersToFireList
03749     )
03750 <span class="comment">/*++</span>
03751 <span class="comment"></span>
03752 <span class="comment">Routine Description:</span>
03753 <span class="comment"></span>
03754 <span class="comment">    Finally all the timers are fired here.</span>
03755 <span class="comment"></span>
03756 <span class="comment">Arguments:</span>
03757 <span class="comment"></span>
03758 <span class="comment">    TimersToFireList: List of timers to fire</span>
03759 <span class="comment"></span>
03760 <span class="comment">--*/</span>
03761 
03762 {
03763     PLIST_ENTRY Node ;
03764     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
03765     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03766 
03767     
03768     <span class="keywordflow">for</span> (Node = TimersToFireList-&gt;Flink;  Node != TimersToFireList; Node = TimersToFireList-&gt;Flink)
03769     {
03770         Timer = CONTAINING_RECORD (Node, <a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>, TimersToFireList) ;
03771 
03772         RemoveEntryList( Node ) ;
03773         InitializeListHead( Node ) ;
03774 
03775         
03776         <span class="keywordflow">if</span> ( (Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>) 
03777             || (Timer-&gt;Queue-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>) )
03778         {
03779             ;
03780 
03781         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Timer-&gt;Flags &amp; (WT_EXECUTEINTIMERTHREAD | WT_EXECUTEINWAITTHREAD ) ) {
03782 
03783             <span class="comment">//DPRN5</span>
03784             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a38">DPRN4</a>)
03785             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling WaitOrTimer(Timer): fn:%x  context:%x  bool:%d Thread&lt;%d:%d&gt;\n"</span>,
03786                 (ULONG_PTR)Timer-&gt;Function, (ULONG_PTR)Timer-&gt;Context,
03787                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03788                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03789                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)
03790                 ) ;
03791 
03792 <span class="preprocessor">            #if (DBG1)</span>
03793 <span class="preprocessor"></span>            <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Timer-&gt;Function, Timer-&gt;Context ) ;
03794 <span class="preprocessor">            #endif</span>
03795 <span class="preprocessor"></span>
03796 
03797             ((WAITORTIMERCALLBACKFUNC) Timer-&gt;Function) (Timer-&gt;Context, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ;
03798 
03799         } <span class="keywordflow">else</span> {
03800 
03801             <span class="comment">// create context for Callback and queue it appropriately</span>
03802             
03803             <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">PRTLP_ASYNC_CALLBACK</a>  AsyncCallback ;
03804             
03805             AsyncCallback = <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a>(
03806                                     <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">RTLP_ASYNC_CALLBACK</a> ), 
03807                                     0 );
03808             AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o3">TimerCondition</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03809 
03810             <span class="comment">// timer associated with WaitEvents should be treated differently</span>
03811             
03812             <span class="keywordflow">if</span> ( Timer-&gt;Wait != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03813 
03814                 AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o0">Wait</a> = Timer-&gt;Wait ;
03815                 AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o2">WaitThreadCallback</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03816                 
03817                 InterlockedIncrement( Timer-&gt;RefCountPtr ) ;
03818 
03819             } <span class="keywordflow">else</span> {
03820 
03821                 AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o1">Timer</a> = Timer ;
03822                 AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o2">WaitThreadCallback</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03823 
03824                 InterlockedIncrement( &amp;Timer-&gt;RefCount ) ;
03825             }
03826 
03827 
03828             <span class="comment">// queue work item</span>
03829             
03830             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>( <a class="code" href="../../d2/d1/threads_8c.html#a34">RtlpAsyncCallbackCompletion</a>, AsyncCallback, 
03831                                 Timer-&gt;Flags );
03832                                 
03833             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03834 
03835                 <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( AsyncCallback );
03836                 <span class="keywordflow">if</span> ( Timer-&gt;Wait != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03837                     InterlockedDecrement( Timer-&gt;RefCountPtr ) ;
03838                 } <span class="keywordflow">else</span> {
03839                     InterlockedDecrement( &amp;Timer-&gt;RefCount ) ;
03840                 }
03841             }
03842             
03843         }
03844 
03845         
03846     }
03847 }
03848 
03849 
03850 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03851"></a><a class="code" href="../../d3/d1/threads_8h.html#a145">03851</a> <a class="code" href="../../d3/d1/threads_8h.html#a145">RtlpFindWaitThread</a> (
03852     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> *ThreadCB
03853 )
03854 <span class="comment">/*++</span>
03855 <span class="comment"></span>
03856 <span class="comment">Routine Description:</span>
03857 <span class="comment"></span>
03858 <span class="comment">    Walks thru the list of wait threads and finds one which can accomodate another wait.</span>
03859 <span class="comment">    If one is not found then a new thread is created.</span>
03860 <span class="comment"></span>
03861 <span class="comment">    This routine assumes that the caller has the GlobalWaitLock.</span>
03862 <span class="comment"></span>
03863 <span class="comment">Arguments:</span>
03864 <span class="comment"></span>
03865 <span class="comment">    ThreadCB: returns the ThreadCB of the wait thread that will service the wait request.</span>
03866 <span class="comment"></span>
03867 <span class="comment">Return Value:</span>
03868 <span class="comment"></span>
03869 <span class="comment">    STATUS_SUCCESS if a wait thread was allocated,</span>
03870 <span class="comment"></span>
03871 <span class="comment">--*/</span>
03872 {
03873     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03874     PLIST_ENTRY Node ;
03875     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ;
03876     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCBTmp;
03877 
03878     
03879     <a class="code" href="../../d3/d1/threads_8h.html#a19">ACQUIRE_GLOBAL_WAIT_LOCK</a>() ;
03880 
03881     <span class="keywordflow">do</span> {
03882 
03883         <span class="comment">// Walk thru the list of Wait Threads and find a Wait thread that can accomodate a</span>
03884         <span class="comment">// new wait request.</span>
03885 
03886         <span class="comment">// *Consider* finding a wait thread with least # of waits to facilitate better</span>
03887         <span class="comment">// load balancing of waits.</span>
03888 
03889 
03890         <span class="keywordflow">for</span> (Node = <a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a>.Flink ; Node != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a> ; Node = Node-&gt;Flink) {
03891 
03892             ThreadCBTmp = CONTAINING_RECORD (Node, <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">RTLP_WAIT_THREAD_CONTROL_BLOCK</a>, 
03893                                             WaitThreadsList) ;
03894 
03895 
03896             <span class="comment">// Wait Threads can accomodate upto 64 waits (NtWaitForMultipleObject limit)</span>
03897 
03898             <span class="keywordflow">if</span> ((ThreadCBTmp)-&gt;NumWaits &lt; 64) {
03899 
03900                 <span class="comment">// Found a thread with some wait slots available.</span>
03901 
03902                 InterlockedIncrement ( &amp;(ThreadCBTmp)-&gt;NumWaits) ;
03903 
03904                 *ThreadCB = ThreadCBTmp;
03905                 
03906                 <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>() ;
03907                 
03908                 <span class="keywordflow">return</span> STATUS_SUCCESS ;
03909             }
03910 
03911         }
03912 
03913 
03914         <span class="comment">// If we reach here, we dont have any more wait threads. so create a new wait thread.</span>
03915 
03916         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> (<a class="code" href="../../d2/d1/threads_8c.html#a33">RtlpWaitThread</a>, &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>) ;
03917 
03918 
03919         <span class="comment">// If thread creation fails then return the failure to caller</span>
03920 
03921         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS ) {
03922 
03923 <span class="preprocessor">            #if DBG</span>
03924 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ERROR!! ThreadPool: could not create wait thread\n"</span>);
03925 <span class="preprocessor">            #endif</span>
03926 <span class="preprocessor"></span>
03927             <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>() ;
03928             
03929             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
03930 
03931         } <span class="keywordflow">else</span> {
03932 
03933             <span class="comment">// Close Thread handle, we dont need it.</span>
03934 
03935             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>) ;
03936         }
03937 
03938         <span class="comment">// Loop back now that we have created another thread</span>
03939 
03940     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ;    <span class="comment">// Loop back to top and put new wait request in the newly created thread</span>
03941 
03942     <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>() ;
03943     
03944     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
03945 }
03946 
03947 
03948 
03949 <span class="comment">// Timer Functions</span>
03950 
03951 
03952 
03953 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03954"></a><a class="code" href="../../d3/d1/threads_8h.html#a122">03954</a> <a class="code" href="../../d3/d1/threads_8h.html#a122">RtlpAddTimer</a> (
03955     PRTLP_TIMER Timer
03956     )
03957 <span class="comment">/*++</span>
03958 <span class="comment"></span>
03959 <span class="comment">Routine Description:</span>
03960 <span class="comment"></span>
03961 <span class="comment">    This routine runs as an APC into the Timer thread. It adds a new timer to the</span>
03962 <span class="comment">    specified queue.</span>
03963 <span class="comment"></span>
03964 <span class="comment">Arguments:</span>
03965 <span class="comment"></span>
03966 <span class="comment">    Timer - Pointer to the timer to add</span>
03967 <span class="comment"></span>
03968 <span class="comment">Return Value:</span>
03969 <span class="comment"></span>
03970 <span class="comment"></span>
03971 <span class="comment">--*/</span>
03972 {
03973     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
03974     ULONG TimeRemaining, QueueRelTimeRemaining ;
03975     ULONG NewFiringTime ;
03976 
03977     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>() ;
03978 
03979     
03980     <span class="comment">// the timer was set to be deleted in a callback function.</span>
03981     
03982     <span class="keywordflow">if</span> (Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ) {
03983     
03984         <a class="code" href="../../d3/d1/threads_8h.html#a155">RtlpDeleteTimer</a>( Timer ) ;
03985         <span class="keywordflow">return</span> ;
03986     }
03987 
03988     
03989     Queue = Timer-&gt;Queue ;
03990 
03991     
03992     <span class="comment">// TimeRemaining is the time left in the current timer + the relative time of</span>
03993     <span class="comment">// the queue it is being inserted into</span>
03994 
03995     TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>) ;
03996     QueueRelTimeRemaining = TimeRemaining + <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (Queue) ;
03997 
03998 
03999     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (&amp;Queue-&gt;TimerList, Timer, QueueRelTimeRemaining, 
04000                                 &amp;NewFiringTime)) 
04001     {
04002 
04003         <span class="comment">// If the Queue is not attached to TimerQueues since it had no timers </span>
04004         <span class="comment">// previously then insert the queue into the TimerQueues list, else just </span>
04005         <span class="comment">// reorder its existing position.</span>
04006 
04007         <span class="keywordflow">if</span> (IsListEmpty (&amp;Queue-&gt;List)) {
04008 
04009             Queue-&gt;DeltaFiringTime = NewFiringTime ;
04010 
04011             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>, Queue, TimeRemaining, 
04012                                         &amp;NewFiringTime)) 
04013             {
04014 
04015                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
04016                 <span class="comment">// timer to fire sooner.</span>
04017 
04018                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, NewFiringTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
04019             }
04020 
04021         } <span class="keywordflow">else</span> {
04022 
04023             <span class="comment">// If we insert at the head of the timer delta list we will need to</span>
04024             <span class="comment">// make sure the queue delta list is readjusted</span>
04025 
04026             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a>(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>, Queue, TimeRemaining, &amp;NewFiringTime, NewFiringTime)){
04027 
04028                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
04029                 <span class="comment">// timer to fire sooner.</span>
04030 
04031                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, NewFiringTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
04032 
04033             }
04034         }
04035 
04036     }
04037 
04038     Timer-&gt;State |= ( <a class="code" href="../../d3/d1/threads_8h.html#a41">STATE_REGISTERED</a> | <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) ;
04039 }
04040 
04041 
04042 
04043 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04044"></a><a class="code" href="../../d3/d1/threads_8h.html#a154">04044</a> <a class="code" href="../../d3/d1/threads_8h.html#a154">RtlpUpdateTimer</a> (
04045     PRTLP_TIMER Timer,
04046     PRTLP_TIMER UpdatedTimer
04047     )
04048 <span class="comment">/*++</span>
04049 <span class="comment"></span>
04050 <span class="comment">Routine Description:</span>
04051 <span class="comment"></span>
04052 <span class="comment">    This routine executes in an APC and updates the specified timer if it exists</span>
04053 <span class="comment"></span>
04054 <span class="comment">Arguments:</span>
04055 <span class="comment"></span>
04056 <span class="comment">    Timer - Timer that is actually updated</span>
04057 <span class="comment">    UpdatedTimer - Specifies pointer to a timer structure that contains Queue and</span>
04058 <span class="comment">                Timer information</span>
04059 <span class="comment"></span>
04060 <span class="comment">Return Value:</span>
04061 <span class="comment"></span>
04062 <span class="comment"></span>
04063 <span class="comment">--*/</span>
04064 {
04065     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
04066     ULONG TimeRemaining, QueueRelTimeRemaining ;
04067     ULONG NewFiringTime ;
04068 
04069 
04070     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>( ) ;
04071 
04072     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>(Timer) ;
04073 
04074     Queue = Timer-&gt;Queue ;
04075 
04076     <span class="comment">// Update the periodic time on the timer</span>
04077 
04078     Timer-&gt;Period = UpdatedTimer-&gt;Period ;
04079 
04080 
04081     <span class="comment">// if timer is not in active state, then dont update it</span>
04082     
04083     <span class="keywordflow">if</span> ( ! ( Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) ) {
04084 
04085         <span class="keywordflow">return</span> ;
04086     }
04087         
04088     <span class="comment">// Get the time remaining on the NT timer</span>
04089 
04090     TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>) ;
04091     QueueRelTimeRemaining = TimeRemaining + <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (Queue) ;
04092 
04093 
04094     <span class="comment">// Update the timer based on the due time</span>
04095     
04096     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (&amp;Queue-&gt;TimerList, Timer, QueueRelTimeRemaining, 
04097                                 &amp;NewFiringTime, 
04098                                 UpdatedTimer-&gt;DeltaFiringTime)) 
04099     {
04100 
04101         <span class="comment">// If this update caused the timer at the head of the queue to change, then reinsert</span>
04102         <span class="comment">// this queue in the list of queues.</span>
04103 
04104         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>, Queue, TimeRemaining, &amp;NewFiringTime, NewFiringTime)) {
04105 
04106             <span class="comment">// NT timer needs to be updated since the change caused the queue at the head of</span>
04107             <span class="comment">// the TimerQueues to change.</span>
04108 
04109             <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, NewFiringTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
04110 
04111         }
04112 
04113     }
04114 
04115     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( UpdatedTimer ) ;
04116 }
04117 
04118 
04119 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04120"></a><a class="code" href="../../d3/d1/threads_8h.html#a139">04120</a> <a class="code" href="../../d3/d1/threads_8h.html#a139">RtlpCancelTimer</a> (
04121     PRTLP_TIMER Timer
04122     )
04123 <span class="comment">/*++</span>
04124 <span class="comment"></span>
04125 <span class="comment">Routine Description:</span>
04126 <span class="comment"></span>
04127 <span class="comment">    This routine executes in an APC and cancels the specified timer if it exists</span>
04128 <span class="comment"></span>
04129 <span class="comment">Arguments:</span>
04130 <span class="comment"></span>
04131 <span class="comment">    Timer - Specifies pointer to a timer structure that contains Queue and Timer information</span>
04132 <span class="comment"></span>
04133 <span class="comment">Return Value:</span>
04134 <span class="comment"></span>
04135 <span class="comment"></span>
04136 <span class="comment">--*/</span>
04137 {
04138     <a class="code" href="../../d3/d1/threads_8h.html#a140">RtlpCancelTimerEx</a>( Timer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ; <span class="comment">// queue not being deleted</span>
04139 }
04140 
04141 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04142"></a><a class="code" href="../../d3/d1/threads_8h.html#a140">04142</a> <a class="code" href="../../d3/d1/threads_8h.html#a140">RtlpCancelTimerEx</a> (
04143     PRTLP_TIMER Timer,
04144     BOOLEAN DeletingQueue
04145     )
04146 <span class="comment">/*++</span>
04147 <span class="comment"></span>
04148 <span class="comment">Routine Description:</span>
04149 <span class="comment"></span>
04150 <span class="comment">    This routine cancels the specified timer.</span>
04151 <span class="comment"></span>
04152 <span class="comment">Arguments:</span>
04153 <span class="comment"></span>
04154 <span class="comment">    Timer - Specifies pointer to a timer structure that contains Queue and Timer information</span>
04155 <span class="comment">    DeletingQueue - FALSE: routine executing in an APC. Delete timer only.</span>
04156 <span class="comment">                    TRUE : routine called by timer queue which is being deleted. So dont</span>
04157 <span class="comment">                            reset the queue's position</span>
04158 <span class="comment">Return Value:</span>
04159 <span class="comment"></span>
04160 <span class="comment"></span>
04161 <span class="comment">--*/</span>
04162 {
04163     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
04164 
04165     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>() ;
04166     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>( Timer ) ;
04167     
04168     Queue = Timer-&gt;Queue ;
04169 
04170 
04171     <span class="keywordflow">if</span> ( Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) {
04172 
04173         <span class="comment">// if queue is being deleted, then the timer should not be reset</span>
04174         
04175         <span class="keywordflow">if</span> ( ! DeletingQueue )
04176             <a class="code" href="../../d3/d1/threads_8h.html#a141">RtlpDeactivateTimer</a>( Queue, Timer ) ;
04177         
04178     } <span class="keywordflow">else</span> {
04179 
04180         <span class="comment">// remove one shot Inactive timer from Queue-&gt;UncancelledTimerList</span>
04181         <span class="comment">// called only when the time queue is being deleted</span>
04182         
04183         RemoveEntryList( &amp;Timer-&gt;List ) ;
04184 
04185     }
04186 
04187     
04188     <span class="comment">// Set the State to deleted</span>
04189     
04190     Timer-&gt;State |= <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ;
04191 
04192 
04193     <span class="comment">// delete timer if refcount == 0</span>
04194     
04195     <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Timer-&gt;RefCount ) == 0 ) {
04196     
04197         <a class="code" href="../../d3/d1/threads_8h.html#a155">RtlpDeleteTimer</a>( Timer ) ;
04198     }
04199 }
04200 
04201 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04202"></a><a class="code" href="../../d3/d1/threads_8h.html#a141">04202</a> <a class="code" href="../../d3/d1/threads_8h.html#a141">RtlpDeactivateTimer</a> (
04203     PRTLP_TIMER_QUEUE Queue,
04204     PRTLP_TIMER Timer
04205     )
04206 <span class="comment">/*++</span>
04207 <span class="comment"></span>
04208 <span class="comment">Routine Description:</span>
04209 <span class="comment"></span>
04210 <span class="comment">    This routine executes in an APC and cancels the specified timer if it exists</span>
04211 <span class="comment"></span>
04212 <span class="comment">Arguments:</span>
04213 <span class="comment"></span>
04214 <span class="comment">    Timer - Specifies pointer to a timer structure that contains Queue and Timer information</span>
04215 <span class="comment"></span>
04216 <span class="comment">Return Value:</span>
04217 <span class="comment"></span>
04218 <span class="comment"></span>
04219 <span class="comment">--*/</span>
04220 {
04221     ULONG TimeRemaining, QueueRelTimeRemaining ;
04222     ULONG NewFiringTime ;
04223 
04224     
04225     <span class="comment">// Remove the timer from the appropriate queue</span>
04226 
04227     TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>) ;
04228     QueueRelTimeRemaining = TimeRemaining + <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (Queue) ;
04229 
04230     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (&amp;Queue-&gt;TimerList, Timer, QueueRelTimeRemaining, &amp;NewFiringTime)) {
04231 
04232         <span class="comment">// If we removed the last timer from the queue then we should remove the queue</span>
04233         <span class="comment">// from TimerQueues, else we should readjust its position based on the delta time change</span>
04234 
04235         <span class="keywordflow">if</span> (IsListEmpty (&amp;Queue-&gt;TimerList)) {
04236 
04237             <span class="comment">// Remove the queue from TimerQueues</span>
04238 
04239             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>, Queue, TimeRemaining, &amp;NewFiringTime)) {
04240 
04241                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
04242                 <span class="comment">// timer to fire later</span>
04243 
04244                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, NewFiringTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
04245 
04246             }
04247 
04248             InitializeListHead (&amp;Queue-&gt;List) ;
04249 
04250         } <span class="keywordflow">else</span> {
04251 
04252             <span class="comment">// If we remove from the head of the timer delta list we will need to</span>
04253             <span class="comment">// make sure the queue delta list is readjusted</span>
04254 
04255             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>, Queue, TimeRemaining, &amp;NewFiringTime, NewFiringTime)) {
04256 
04257                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
04258                 <span class="comment">// timer to fire later</span>
04259 
04260                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, NewFiringTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
04261 
04262             }
04263 
04264         }
04265 
04266     }
04267 }
04268 
04269 
04270 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04271"></a><a class="code" href="../../d3/d1/threads_8h.html#a155">04271</a> <a class="code" href="../../d3/d1/threads_8h.html#a155">RtlpDeleteTimer</a> (
04272     PRTLP_TIMER Timer
04273     )
04274 <span class="comment">/*++</span>
04275 <span class="comment"></span>
04276 <span class="comment">Routine Description:</span>
04277 <span class="comment"></span>
04278 <span class="comment">    This routine executes in worker or timer thread and deletes the timer </span>
04279 <span class="comment">    whose RefCount == 0. The function can be called outside timer thread,</span>
04280 <span class="comment">    so no structure outside Timer can be touched (no list etc).</span>
04281 <span class="comment"></span>
04282 <span class="comment">Arguments:</span>
04283 <span class="comment"></span>
04284 <span class="comment">    Timer - Specifies pointer to a timer structure that contains Queue and Timer information</span>
04285 <span class="comment"></span>
04286 <span class="comment">Return Value:</span>
04287 <span class="comment"></span>
04288 <span class="comment"></span>
04289 <span class="comment">--*/</span>
04290 {
04291     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue = Timer-&gt;Queue ;
04292 
04293     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>( Timer ) ;
04294     <a class="code" href="../../d3/d1/threads_8h.html#a32">CLEAR_SIGNATURE</a>( Timer ) ;
04295 
04296 <span class="preprocessor">    #if DBG1</span>
04297 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
04298     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Timer: %x: deleted\n\n"</span>, Timer-&gt;Queue-&gt;DbgId, 
04299             (ULONG_PTR)Timer) ;
04300 <span class="preprocessor">    #endif</span>
04301 <span class="preprocessor"></span>
04302     <span class="comment">// safe to call this. Either the timer is in the TimersToFireList and</span>
04303     <span class="comment">// the function is being called in time context or else it is not in the</span>
04304     <span class="comment">// list</span>
04305 
04306     RemoveEntryList( &amp;Timer-&gt;TimersToFireList ) ;
04307 
04308     <span class="keywordflow">if</span> ( Timer-&gt;CompletionEvent )
04309         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( Timer-&gt;CompletionEvent, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ;
04310 
04311 
04312     <span class="comment">// decrement the total number of timers in the queue</span>
04313     
04314     <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Queue-&gt;RefCount ) == 0 )
04315 
04316         <a class="code" href="../../d3/d1/threads_8h.html#a143">RtlpDeleteTimerQueueComplete</a>( Queue ) ;
04317         
04318 
04319     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Timer ) ;
04320 
04321 }
04322 
04323 
04324 
04325 ULONG
<a name="l04326"></a><a class="code" href="../../d3/d1/threads_8h.html#a138">04326</a> <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (
04327     PRTLP_TIMER_QUEUE Queue
04328     )
04329 <span class="comment">/*++</span>
04330 <span class="comment"></span>
04331 <span class="comment">Routine Description:</span>
04332 <span class="comment"></span>
04333 <span class="comment">    Walks the list of queues and returns the relative firing time by adding all the</span>
04334 <span class="comment">    DeltaFiringTimes for all queues before it.</span>
04335 <span class="comment"></span>
04336 <span class="comment">Arguments:</span>
04337 <span class="comment"></span>
04338 <span class="comment">    Queue - Queue for which to find the relative firing time</span>
04339 <span class="comment"></span>
04340 <span class="comment">Return Value:</span>
04341 <span class="comment"></span>
04342 <span class="comment">    Time in milliseconds</span>
04343 <span class="comment"></span>
04344 <span class="comment">--*/</span>
04345 {
04346     PLIST_ENTRY Node ;
04347     ULONG RelativeTime ;
04348     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> CurrentQueue ;
04349 
04350     RelativeTime = 0 ;
04351 
04352     <span class="comment">// It the Queue is not attached to TimerQueues List because it has no timer</span>
04353     <span class="comment">// associated with it simply returns 0 as the relative time. Else run thru</span>
04354     <span class="comment">// all queues before it in the list and compute the relative firing time</span>
04355 
04356     <span class="keywordflow">if</span> (!IsListEmpty (&amp;Queue-&gt;List)) {
04357 
04358         <span class="keywordflow">for</span> (Node = <a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>.Flink; Node != &amp;Queue-&gt;List; Node=Node-&gt;Flink) {
04359 
04360             CurrentQueue = CONTAINING_RECORD (Node, <a class="code" href="../../d3/d1/threads_8h.html#a3">RTLP_TIMER_QUEUE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
04361 
04362             RelativeTime += CurrentQueue-&gt;DeltaFiringTime ;
04363 
04364         }
04365 
04366         <span class="comment">// Add the queue's delta firing time as well</span>
04367 
04368         RelativeTime += Queue-&gt;DeltaFiringTime ;
04369         
04370     }
04371 
04372     <span class="keywordflow">return</span> RelativeTime ;
04373 
04374 }
04375 
04376 
04377 ULONG
<a name="l04378"></a><a class="code" href="../../d3/d1/threads_8h.html#a136">04378</a> <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (
04379     HANDLE TimerHandle
04380     )
04381 <span class="comment">/*++</span>
04382 <span class="comment"></span>
04383 <span class="comment">Routine Description:</span>
04384 <span class="comment"></span>
04385 <span class="comment">    Gets the time remaining on the specified NT timer</span>
04386 <span class="comment"></span>
04387 <span class="comment">Arguments:</span>
04388 <span class="comment"></span>
04389 <span class="comment">    TimerHandle - Handle to the NT timer</span>
04390 <span class="comment"></span>
04391 <span class="comment">Return Value:</span>
04392 <span class="comment"></span>
04393 <span class="comment">    Time remaining on the timer</span>
04394 <span class="comment"></span>
04395 <span class="comment">--*/</span>
04396 {
04397     ULONG InfoLen ;
04398     TIMER_BASIC_INFORMATION Info ;
04399 
04400     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
04401 
04402     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d2/timer_8c.html#a14">NtQueryTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, TimerBasicInformation, &amp;Info, <span class="keyword">sizeof</span>(Info), &amp;InfoLen) ;
04403 
04404     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) ;
04405 
04406     <span class="comment">// Return 0 if</span>
04407     <span class="comment">//</span>
04408     <span class="comment">// - the timer has already fired then return</span>
04409     <span class="comment">//   OR</span>
04410     <span class="comment">// - the timer is has more than 0x7f0000000 in its high part</span>
04411     <span class="comment">//   (which indicates that the timer was (probably) programmed for -1)</span>
04412 
04413     
04414     <span class="keywordflow">if</span> (Info.TimerState || ((ULONG)Info.RemainingTime.HighPart &gt; 0x7f000000) ) {
04415 
04416         <span class="keywordflow">return</span> 0 ;
04417 
04418     } <span class="keywordflow">else</span> {
04419 
04420         <span class="keywordflow">return</span> (ULONG) (Info.RemainingTime.QuadPart / 10000) ;
04421 
04422     }
04423 
04424 }
04425 
04426 
04427 
04428 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04429"></a><a class="code" href="../../d3/d1/threads_8h.html#a123">04429</a> <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (
04430     HANDLE TimerHandle,
04431     ULONG DueTime,
04432     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB
04433     )
04434 <span class="comment">/*++</span>
04435 <span class="comment"></span>
04436 <span class="comment">Routine Description:</span>
04437 <span class="comment"></span>
04438 <span class="comment">    This routine resets the timer object with the new due time.</span>
04439 <span class="comment"></span>
04440 <span class="comment">Arguments:</span>
04441 <span class="comment"></span>
04442 <span class="comment">    TimerHandle - Handle to the timer object</span>
04443 <span class="comment"></span>
04444 <span class="comment">    DueTime - Relative timer due time in Milliseconds</span>
04445 <span class="comment"></span>
04446 <span class="comment">Return Value:</span>
04447 <span class="comment"></span>
04448 <span class="comment">--*/</span>
04449 {
04450     LARGE_INTEGER LongDueTime ;
04451 
04452     <a class="code" href="../../d2/d2/timer_8c.html#a13">NtCancelTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
04453 
04454     <span class="comment">// If the DueTime is INFINITE_TIME then set the timer to the largest integer possible</span>
04455 
04456     <span class="keywordflow">if</span> (DueTime == <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a>) {
04457 
04458         LongDueTime.LowPart = 0x0 ;
04459 
04460         LongDueTime.HighPart = 0x80000000 ;
04461 
04462     } <span class="keywordflow">else</span> {
04463 
04464         <span class="comment">//</span>
04465         <span class="comment">// set the absolute time when timer is to be fired</span>
04466         <span class="comment">//</span>
04467         
04468         <span class="keywordflow">if</span> (ThreadCB) {
04469         
04470             ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o12">Firing64BitTickCount</a> = DueTime 
04471                                 + <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o11">Current64BitTickCount</a>) ;
04472 
04473         } <span class="keywordflow">else</span> {
04474             <span class="comment">//</span>
04475             <span class="comment">// adjust for drift only if it is a global timer</span>
04476             <span class="comment">//</span>
04477         
04478             ULONG Drift ;
04479             LONGLONG llCurrentTick ;
04480             
04481             llCurrentTick = <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>) ;
04482             
04483             Drift = (ULONG) (llCurrentTick - <a class="code" href="../../d3/d1/threads_8h.html#a26">RtlpGetResync64BitTickCount</a>()) ;
04484             DueTime = (DueTime &gt; Drift) ? DueTime-Drift : 1 ;
04485             <a class="code" href="../../d3/d1/threads_8h.html#a27">RtlpSetFiring64BitTickCount</a>(llCurrentTick + DueTime) ;
04486         }
04487 
04488         
04489         LongDueTime.QuadPart = Int32x32To64( DueTime, -10000 );
04490 
04491     }
04492     
04493 
04494     <a class="code" href="../../d2/d2/timer_8c.html#a15">NtSetTimer</a> (
04495         <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>,
04496         &amp;LongDueTime,
04497         ThreadCB ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : <a class="code" href="../../d2/d1/threads_8c.html#a59">RtlpServiceTimer</a>,
04498         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04499         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04500         0,
04501         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04502         ) ;
04503 }
04504 
04505 
04506 BOOLEAN
<a name="l04507"></a><a class="code" href="../../d3/d1/threads_8h.html#a127">04507</a> <a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (
04508     PLIST_ENTRY DeltaList,
04509     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> NewTimer,
04510     ULONG TimeRemaining,
04511     ULONG *NewFiringTime
04512     )
04513 <span class="comment">/*++</span>
04514 <span class="comment"></span>
04515 <span class="comment">Routine Description:</span>
04516 <span class="comment"></span>
04517 <span class="comment">    Inserts the timer element in the appropriate place in the delta list.</span>
04518 <span class="comment"></span>
04519 <span class="comment">Arguments:</span>
04520 <span class="comment"></span>
04521 <span class="comment">    DeltaList - Delta list to insert into</span>
04522 <span class="comment"></span>
04523 <span class="comment">    NewTimer - Timer element to insert into list</span>
04524 <span class="comment"></span>
04525 <span class="comment">    TimeRemaining - This time must be added to the head of the list to get "real"</span>
04526 <span class="comment">                    relative time.</span>
04527 <span class="comment"></span>
04528 <span class="comment">    NewFiringTime - If the new element was inserted at the head of the list - this</span>
04529 <span class="comment">                    will contain the new firing time in milliseconds. The caller</span>
04530 <span class="comment">                    can use this time to re-program the NT timer. This MUST NOT be</span>
04531 <span class="comment">                    changed if the function returns FALSE.</span>
04532 <span class="comment"></span>
04533 <span class="comment">Return Value:</span>
04534 <span class="comment"></span>
04535 <span class="comment">    TRUE - If the timer was inserted at head of delta list</span>
04536 <span class="comment"></span>
04537 <span class="comment">    FALSE - otherwise</span>
04538 <span class="comment"></span>
04539 <span class="comment">--*/</span>
04540 {
04541     PLIST_ENTRY Node ;
04542     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Temp ;
04543     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Head ;
04544 
04545     <span class="keywordflow">if</span> (IsListEmpty (DeltaList)) {
04546 
04547         InsertHeadList (DeltaList, &amp;NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) ;
04548 
04549         *NewFiringTime = NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04550         
04551         NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = 0 ;
04552 
04553         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04554 
04555     }
04556 
04557     <span class="comment">// Adjust the head of the list to reflect the time remaining on the NT timer</span>
04558 
04559     Head = CONTAINING_RECORD (DeltaList-&gt;Flink, <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">RTLP_GENERIC_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
04560 
04561     Head-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> += TimeRemaining ;
04562 
04563 
04564     <span class="comment">// Find the appropriate location to insert this element in</span>
04565 
04566     <span class="keywordflow">for</span> (Node = DeltaList-&gt;Flink ; Node != DeltaList ; Node = Node-&gt;Flink) {
04567 
04568         Temp = CONTAINING_RECORD (Node, <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">RTLP_GENERIC_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
04569 
04570 
04571         <span class="keywordflow">if</span> (Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> &lt;= NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a>) {
04572 
04573             NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> -= Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04574 
04575         } <span class="keywordflow">else</span> {
04576 
04577             <span class="comment">// found appropriate place to insert this timer</span>
04578 
04579             <span class="keywordflow">break</span> ;
04580 
04581         }
04582 
04583     }
04584 
04585     <span class="comment">// Either we have found the appopriate node to insert before in terms of deltas.</span>
04586     <span class="comment">// OR we have come to the end of the list. Insert this timer here.</span>
04587 
04588     InsertHeadList (Node-&gt;Blink, &amp;NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) ;
04589 
04590 
04591     <span class="comment">// If this isnt the last element in the list - adjust the delta of the</span>
04592     <span class="comment">// next element</span>
04593 
04594     <span class="keywordflow">if</span> (Node != DeltaList) {
04595 
04596         Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> -= NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04597 
04598     }
04599 
04600 
04601     <span class="comment">// Check if element was inserted at head of list</span>
04602 
04603     <span class="keywordflow">if</span> (DeltaList-&gt;Flink == &amp;NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) {
04604 
04605         <span class="comment">// Set NewFiringTime to the time in milliseconds when the new head of list</span>
04606         <span class="comment">// should be serviced.</span>
04607 
04608         *NewFiringTime = NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04609 
04610         <span class="comment">// This means the timer must be programmed to service this request</span>
04611 
04612         NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = 0 ;
04613 
04614         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04615 
04616     } <span class="keywordflow">else</span> {
04617 
04618         <span class="comment">// No change to the head of the list, set the delta time back</span>
04619 
04620         Head-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> -= TimeRemaining ;
04621 
04622         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
04623 
04624     }
04625 
04626 }
04627 
04628 
04629 
04630 BOOLEAN
<a name="l04631"></a><a class="code" href="../../d3/d1/threads_8h.html#a128">04631</a> <a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (
04632     PLIST_ENTRY DeltaList,
04633     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Timer,
04634     ULONG TimeRemaining,
04635     ULONG* NewFiringTime
04636     )
04637 <span class="comment">/*++</span>
04638 <span class="comment"></span>
04639 <span class="comment">Routine Description:</span>
04640 <span class="comment"></span>
04641 <span class="comment">    Removes the specified timer from the delta list</span>
04642 <span class="comment"></span>
04643 <span class="comment">Arguments:</span>
04644 <span class="comment"></span>
04645 <span class="comment">    DeltaList - Delta list to insert into</span>
04646 <span class="comment"></span>
04647 <span class="comment">    Timer - Timer element to insert into list</span>
04648 <span class="comment"></span>
04649 <span class="comment">    TimerHandle - Handle of the NT Timer object</span>
04650 <span class="comment"></span>
04651 <span class="comment">    TimeRemaining - This time must be added to the head of the list to get "real"</span>
04652 <span class="comment">                    relative time.</span>
04653 <span class="comment"></span>
04654 <span class="comment">Return Value:</span>
04655 <span class="comment"></span>
04656 <span class="comment">    TRUE if the timer was removed from head of timer list</span>
04657 <span class="comment">    FALSE otherwise</span>
04658 <span class="comment"></span>
04659 <span class="comment">--*/</span>
04660 {
04661     PLIST_ENTRY Next ;
04662     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Temp ;
04663 
04664     Next = Timer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>.Flink ;
04665 
04666     RemoveEntryList (&amp;Timer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) ;
04667 
04668     <span class="keywordflow">if</span> (IsListEmpty (DeltaList)) {
04669 
04670         *NewFiringTime = <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a> ;
04671 
04672         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04673 
04674     }
04675 
04676     <span class="keywordflow">if</span> (Next == DeltaList)  {
04677 
04678         <span class="comment">// If we removed the last element in the list nothing to do either</span>
04679 
04680         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
04681 
04682     } <span class="keywordflow">else</span> {
04683 
04684         Temp = CONTAINING_RECORD ( Next, <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">RTLP_GENERIC_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
04685 
04686         Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> += Timer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04687         
04688         <span class="comment">// Check if element was removed from head of list</span>
04689 
04690         <span class="keywordflow">if</span> (DeltaList-&gt;Flink == Next) {
04691 
04692             *NewFiringTime = Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> + TimeRemaining ;
04693 
04694             Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = 0 ;
04695 
04696             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04697 
04698         } <span class="keywordflow">else</span> {
04699 
04700             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
04701 
04702         }
04703 
04704     }
04705 
04706 }
04707 
04708 
04709 
04710 BOOLEAN
<a name="l04711"></a><a class="code" href="../../d3/d1/threads_8h.html#a129">04711</a> <a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (
04712     PLIST_ENTRY DeltaList,
04713     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Timer,
04714     ULONG TimeRemaining,
04715     ULONG *NewFiringTime,
04716     ULONG ChangedFiringTime
04717     )
04718 <span class="comment">/*++</span>
04719 <span class="comment"></span>
04720 <span class="comment">Routine Description:</span>
04721 <span class="comment"></span>
04722 <span class="comment">    Called when a timer in the delta list needs to be re-inserted because the firing time</span>
04723 <span class="comment">    has changed.</span>
04724 <span class="comment"></span>
04725 <span class="comment">Arguments:</span>
04726 <span class="comment"></span>
04727 <span class="comment">    DeltaList - List in which to re-insert</span>
04728 <span class="comment"></span>
04729 <span class="comment">    Timer - Timer for which the firing time has changed</span>
04730 <span class="comment"></span>
04731 <span class="comment">    TimeRemaining - Time before the head of the delta list is fired</span>
04732 <span class="comment"></span>
04733 <span class="comment">    NewFiringTime - If the new element was inserted at the head of the list - this</span>
04734 <span class="comment">                    will contain the new firing time in milliseconds. The caller</span>
04735 <span class="comment">                    can use this time to re-program the NT timer.</span>
04736 <span class="comment"></span>
04737 <span class="comment">    ChangedFiringTime - Changed Time for the specified timer.</span>
04738 <span class="comment"></span>
04739 <span class="comment">Return Value:</span>
04740 <span class="comment"></span>
04741 <span class="comment">    TRUE if the timer was removed from head of timer list</span>
04742 <span class="comment">    FALSE otherwise</span>
04743 <span class="comment"></span>
04744 <span class="comment">--*/</span>
04745 {
04746     ULONG NewTimeRemaining ;
04747     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Temp ;
04748 
04749     <span class="comment">// Remove the timer from the list</span>
04750 
04751     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (DeltaList, Timer, TimeRemaining, NewFiringTime)) {
04752 
04753         <span class="comment">// If element was removed from the head of the list we should record that</span>
04754 
04755         NewTimeRemaining = *NewFiringTime ;
04756 
04757 
04758     } <span class="keywordflow">else</span> {
04759 
04760         <span class="comment">// Element was not removed from head of delta list, the current TimeRemaining is valid</span>
04761 
04762         NewTimeRemaining = TimeRemaining ;
04763 
04764     }
04765 
04766     <span class="comment">// Before inserting Timer, set its delta time to the ChangedFiringTime</span>
04767 
04768     Timer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = ChangedFiringTime ;
04769 
04770     <span class="comment">// Reinsert this element back in the list</span>
04771 
04772     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (DeltaList, Timer, NewTimeRemaining, NewFiringTime)) {
04773 
04774         <span class="comment">// If we did not add at the head of the list, then we should return TRUE if</span>
04775         <span class="comment">// RtlpRemoveFromDeltaList() had returned TRUE. We also update the NewFiringTime to</span>
04776         <span class="comment">// the reflect the new firing time returned by RtlpRemoveFromDeltaList()</span>
04777 
04778         *NewFiringTime = NewTimeRemaining ;
04779 
04780         <span class="keywordflow">return</span> (NewTimeRemaining != TimeRemaining) ;
04781 
04782     } <span class="keywordflow">else</span> {
04783 
04784         <span class="comment">// NewFiringTime contains the time the NT timer must be programmed for</span>
04785 
04786         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04787 
04788     }
04789 
04790 }
04791 
04792 
04793 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04794"></a><a class="code" href="../../d3/d1/threads_8h.html#a121">04794</a> <a class="code" href="../../d3/d1/threads_8h.html#a121">RtlpAddTimerQueue</a> (
04795     PVOID Queue
04796     )
04797 <span class="comment">/*++</span>
04798 <span class="comment"></span>
04799 <span class="comment">Routine Description:</span>
04800 <span class="comment"></span>
04801 <span class="comment">    This routine runs as an APC into the Timer thread. It does whatever necessary to</span>
04802 <span class="comment">    create a new timer queue</span>
04803 <span class="comment"></span>
04804 <span class="comment">Arguments:</span>
04805 <span class="comment"></span>
04806 <span class="comment">    Queue - Pointer to the queue to add</span>
04807 <span class="comment"></span>
04808 <span class="comment">Return Value:</span>
04809 <span class="comment"></span>
04810 <span class="comment"></span>
04811 <span class="comment">--*/</span>
04812 {
04813 
04814     <span class="comment">// We do nothing here. The newly created queue is free floating until a timer is</span>
04815     <span class="comment">// queued onto it.</span>
04816 
04817 }
04818 
04819 
04820 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04821"></a><a class="code" href="../../d3/d1/threads_8h.html#a137">04821</a> <a class="code" href="../../d3/d1/threads_8h.html#a137">RtlpServiceTimer</a> (
04822     PVOID NotUsedArg,
04823     ULONG NotUsedLowTimer,
04824     LONG NotUsedHighTimer
04825     )
04826 <span class="comment">/*++</span>
04827 <span class="comment"></span>
04828 <span class="comment">Routine Description:</span>
04829 <span class="comment"></span>
04830 <span class="comment">    Services the timer. Runs in an APC.</span>
04831 <span class="comment"></span>
04832 <span class="comment">Arguments:</span>
04833 <span class="comment"></span>
04834 <span class="comment">    NotUsedArg - Argument is not used in this function.</span>
04835 <span class="comment"></span>
04836 <span class="comment">    NotUsedLowTimer - Argument is not used in this function.</span>
04837 <span class="comment"></span>
04838 <span class="comment">    NotUsedHighTimer - Argument is not used in this function.</span>
04839 <span class="comment"></span>
04840 <span class="comment">Return Value:</span>
04841 <span class="comment"></span>
04842 <span class="comment">Remarks:</span>
04843 <span class="comment">    This APC is called only for timeouts of timer threads.</span>
04844 <span class="comment">    </span>
04845 <span class="comment">--*/</span>
04846 {
04847     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
04848     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
04849     PLIST_ENTRY TNode ;
04850     PLIST_ENTRY QNode ;
04851     PLIST_ENTRY Temp ;
04852     ULONG NewFiringTime ;
04853     LIST_ENTRY ReinsertTimerQueueList ;
04854     LIST_ENTRY TimersToFireList ;
04855 
04856     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>() ;
04857     
04858     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a36">DPRN2</a>) {
04859         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before service timer ThreadId&lt;%x:%x&gt;\n"</span>,
04860                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
04861                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess));
04862         <a class="code" href="../../d2/d1/threads_8c.html#a72">RtlDebugPrintTimes</a> ();
04863     }
04864 
04865     <a class="code" href="../../d3/d1/threads_8h.html#a21">ACQUIRE_GLOBAL_TIMER_LOCK</a>();
04866 
04867     <span class="comment">// fire it if it even 200ms ahead. else reset the timer</span>
04868     
04869     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a111">Firing64BitTickCount</a>.QuadPart &gt; <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>) + 200) {
04870 
04871         <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, <a class="code" href="../../d2/d1/threads_8c.html#a53">RtlpGetTimeRemaining</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
04872 
04873         <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>() ;
04874         <span class="keywordflow">return</span> ;
04875     }
04876         
04877     InitializeListHead (&amp;ReinsertTimerQueueList) ;
04878 
04879     InitializeListHead (&amp;TimersToFireList) ;
04880 
04881 
04882     <span class="comment">// We run thru all queues with DeltaFiringTime == 0 and fire all timers that</span>
04883     <span class="comment">// have DeltaFiringTime == 0. We remove the fired timers and either free them</span>
04884     <span class="comment">// (for one shot timers) or put them in aside list (for periodic timers).</span>
04885     <span class="comment">// After we have finished firing all timers in a queue we reinsert the timers</span>
04886     <span class="comment">// in the aside list back into the queue based on their new firing times.</span>
04887     <span class="comment">//</span>
04888     <span class="comment">// Similarly, we remove each fired Queue and put it in a aside list. After firing</span>
04889     <span class="comment">// all queues with DeltaFiringTime == 0, we reinsert the Queues in the aside list</span>
04890     <span class="comment">// and reprogram the NT timer to be the firing time of the first queue in the list</span>
04891 
04892 
04893     <span class="keywordflow">for</span> (QNode = <a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>.Flink ; QNode != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a> ; QNode = QNode-&gt;Flink) {
04894 
04895         Queue = CONTAINING_RECORD (QNode, <a class="code" href="../../d3/d1/threads_8h.html#a3">RTLP_TIMER_QUEUE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
04896 
04897         <span class="comment">// If the delta time in the timer queue is 0 - then this queue</span>
04898         <span class="comment">// has timers that are ready to fire. Walk the list and fire all timers with</span>
04899         <span class="comment">// Delta time of 0</span>
04900 
04901         <span class="keywordflow">if</span> (Queue-&gt;DeltaFiringTime == 0) {
04902 
04903             <span class="comment">// Walk all timers with DeltaFiringTime == 0 and fire them. After that</span>
04904             <span class="comment">// reinsert the periodic timers in the appropriate place.</span>
04905 
04906             <a class="code" href="../../d3/d1/threads_8h.html#a124">RtlpFireTimersAndReorder</a> (Queue, &amp;NewFiringTime, &amp;TimersToFireList) ;
04907 
04908             <span class="comment">// detach this Queue from the list</span>
04909 
04910             QNode = QNode-&gt;Blink ;
04911 
04912             RemoveEntryList (QNode-&gt;Flink) ;
04913 
04914             <span class="comment">// If there are timers in the queue then prepare to reinsert the queue in</span>
04915             <span class="comment">// TimerQueues.</span>
04916 
04917             <span class="keywordflow">if</span> (NewFiringTime != <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a>) {
04918 
04919                 Queue-&gt;DeltaFiringTime = NewFiringTime ;
04920 
04921                 <span class="comment">// put the timer in list that we will process after we have</span>
04922                 <span class="comment">// fired all elements in this queue</span>
04923 
04924                 InsertHeadList (&amp;ReinsertTimerQueueList, &amp;Queue-&gt;List) ;
04925 
04926             } <span class="keywordflow">else</span> {
04927 
04928                 <span class="comment">// Queue has no more timers in it. Let the Queue float.</span>
04929 
04930                 InitializeListHead (&amp;Queue-&gt;List) ;
04931 
04932             }
04933 
04934 
04935         } <span class="keywordflow">else</span> {
04936 
04937             <span class="comment">// No more Queues with DeltaFiringTime == 0</span>
04938 
04939             <span class="keywordflow">break</span> ;
04940 
04941         }
04942 
04943     }
04944 
04945     <span class="comment">// At this point we have fired all the ready timers. We have two lists that need to be</span>
04946     <span class="comment">// merged - TimerQueues and ReinsertTimerQueueList. The following steps do this - at the</span>
04947     <span class="comment">// end of this we will reprogram the NT Timer.</span>
04948 
04949     <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>)) {
04950 
04951         Queue = CONTAINING_RECORD (<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>.Flink, <a class="code" href="../../d3/d1/threads_8h.html#a3">RTLP_TIMER_QUEUE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
04952 
04953         NewFiringTime = Queue-&gt;DeltaFiringTime ;
04954 
04955         Queue-&gt;DeltaFiringTime = 0 ;
04956 
04957         <span class="keywordflow">if</span> (!IsListEmpty (&amp;ReinsertTimerQueueList)) {
04958 
04959             <span class="comment">// TimerQueues and ReinsertTimerQueueList are both non-empty. Merge them.</span>
04960 
04961             <a class="code" href="../../d3/d1/threads_8h.html#a126">RtlpInsertTimersIntoDeltaList</a> (&amp;ReinsertTimerQueueList, &amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>, 
04962                                             NewFiringTime, &amp;NewFiringTime) ;
04963 
04964         }
04965 
04966         <span class="comment">// NewFiringTime contains the time the NT Timer should be programmed to.</span>
04967 
04968     } <span class="keywordflow">else</span> {
04969 
04970         <span class="keywordflow">if</span> (!IsListEmpty (&amp;ReinsertTimerQueueList)) {
04971 
04972             <span class="comment">// TimerQueues is empty. ReinsertTimerQueueList is not.</span>
04973 
04974             <a class="code" href="../../d3/d1/threads_8h.html#a126">RtlpInsertTimersIntoDeltaList</a> (&amp;ReinsertTimerQueueList, &amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>, 0, 
04975                                             &amp;NewFiringTime) ;
04976 
04977         } <span class="keywordflow">else</span> {
04978 
04979             NewFiringTime = <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a> ;
04980 
04981         }
04982 
04983         <span class="comment">// NewFiringTime contains the time the NT Timer should be programmed to.</span>
04984 
04985     }
04986 
04987 
04988     <span class="comment">// Reset the timer to reflect the Delta time associated with the first Queue</span>
04989 
04990     <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, NewFiringTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
04991 
04992     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a37">DPRN3</a>) {
04993         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"After service timer:ThreadId&lt;%x:%x&gt;\n"</span>,
04994                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
04995                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess));
04996         <a class="code" href="../../d2/d1/threads_8c.html#a72">RtlDebugPrintTimes</a> ();
04997     }
04998 
04999     
05000     <span class="comment">// finally fire all the timers</span>
05001     
05002     <a class="code" href="../../d3/d1/threads_8h.html#a125">RtlpFireTimers</a>( &amp;TimersToFireList ) ;
05003 
05004     <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>();
05005 
05006 }
05007 
05008 
05009 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05010"></a><a class="code" href="../../d3/d1/threads_8h.html#a124">05010</a> <a class="code" href="../../d3/d1/threads_8h.html#a124">RtlpFireTimersAndReorder</a> (
05011     PRTLP_TIMER_QUEUE Queue,
05012     ULONG *NewFiringTime,
05013     PLIST_ENTRY TimersToFireList
05014     )
05015 <span class="comment">/*++</span>
05016 <span class="comment"></span>
05017 <span class="comment">Routine Description:</span>
05018 <span class="comment"></span>
05019 <span class="comment">    Fires all timers in TimerList that have DeltaFiringTime == 0. After firing the timers</span>
05020 <span class="comment">    it reorders the timers based on their periodic times OR frees the fired one shot timers.</span>
05021 <span class="comment"></span>
05022 <span class="comment">Arguments:</span>
05023 <span class="comment"></span>
05024 <span class="comment">    TimerList - Timer list to work thru.</span>
05025 <span class="comment"></span>
05026 <span class="comment">    NewFiringTime - Location where the new firing time for the first timer in the delta list</span>
05027 <span class="comment">                    is returned.</span>
05028 <span class="comment"></span>
05029 <span class="comment"></span>
05030 <span class="comment">Return Value:</span>
05031 <span class="comment"></span>
05032 <span class="comment"></span>
05033 <span class="comment">--*/</span>
05034 {
05035     PLIST_ENTRY TNode ;
05036     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
05037     LIST_ENTRY ReinsertTimerList ;
05038     PLIST_ENTRY TimerList = &amp;Queue-&gt;TimerList ;
05039     
05040     InitializeListHead (&amp;ReinsertTimerList) ;
05041     *NewFiringTime = 0 ;
05042     
05043 
05044     <span class="keywordflow">for</span> (TNode = TimerList-&gt;Flink ; (TNode != TimerList) &amp;&amp; (*NewFiringTime == 0); 
05045             TNode = TimerList-&gt;Flink) 
05046     {
05047 
05048         Timer = CONTAINING_RECORD (TNode, <a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
05049 
05050         <span class="comment">// Fire all timers with delta time of 0</span>
05051 
05052         <span class="keywordflow">if</span> (Timer-&gt;DeltaFiringTime == 0) {
05053 
05054             <span class="comment">// detach this timer from the list</span>
05055 
05056             RemoveEntryList (TNode) ;
05057 
05058             <span class="comment">// get next firing time</span>
05059             
05060             <span class="keywordflow">if</span> (!IsListEmpty(TimerList)) {
05061 
05062                 <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> TmpTimer ;
05063 
05064                 TmpTimer = CONTAINING_RECORD (TimerList-&gt;Flink, <a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
05065 
05066                 *NewFiringTime  = TmpTimer-&gt;DeltaFiringTime ;
05067 
05068                 TmpTimer-&gt;DeltaFiringTime = 0 ;
05069 
05070             } <span class="keywordflow">else</span> {
05071 
05072                 *NewFiringTime = <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a> ;
05073             }
05074 
05075 
05076             <span class="comment">// if timer is not periodic then remove active state. Timer will be deleted</span>
05077             <span class="comment">// when cancel timer is called.</span>
05078 
05079             <span class="keywordflow">if</span> (Timer-&gt;Period == 0) {
05080 
05081                 InsertHeadList( &amp;Queue-&gt;UncancelledTimerList, &amp;Timer-&gt;List ) ;
05082 
05083                 <span class="comment">// if one shot wait was timed out then, deactivate the wait</span>
05084                 
05085                 <span class="keywordflow">if</span> ( Timer-&gt;Wait ) {
05086 
05087                     <span class="comment">//</span>
05088                     <span class="comment">// though timer is being "freed" in this call, it can still be</span>
05089                     <span class="comment">// used after this call</span>
05090                     <span class="comment">//</span>
05091                     
05092                     <a class="code" href="../../d3/d1/threads_8h.html#a132">RtlpDeactivateWait</a>( Timer-&gt;Wait ) ;
05093                 }
05094 
05095                 <span class="keywordflow">else</span> {
05096                     <span class="comment">// should be set at the end</span>
05097                 
05098                     Timer-&gt;State &amp;= ~<a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ;
05099                 }
05100 
05101                 Timer-&gt;State |= <a class="code" href="../../d3/d1/threads_8h.html#a45">STATE_ONE_SHOT_FIRED</a> ;
05102                 
05103             } <span class="keywordflow">else</span> {
05104 
05105                 <span class="comment">// Set the DeltaFiringTime to be the next period</span>
05106 
05107                 Timer-&gt;DeltaFiringTime = Timer-&gt;Period ;
05108 
05109                 <span class="comment">// reinsert the timer in the list.</span>
05110                 
05111                 <a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (TimerList, Timer, *NewFiringTime, NewFiringTime) ;
05112             }
05113 
05114 
05115             <span class="comment">// Call the function associated with this timer. call it in the end</span>
05116             <span class="comment">// so that RtlTimer calls can be made in the timer function</span>
05117 
05118             <span class="keywordflow">if</span> ( (Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>) 
05119                 || (Timer-&gt;Queue-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>) )
05120             {
05121                 ;
05122 
05123             } <span class="keywordflow">else</span> {
05124 
05125                 InsertTailList( TimersToFireList, &amp;Timer-&gt;TimersToFireList ) ;
05126 
05127             }
05128 
05129         } <span class="keywordflow">else</span> {
05130 
05131             <span class="comment">// No more Timers with DeltaFiringTime == 0</span>
05132 
05133             <span class="keywordflow">break</span> ;
05134 
05135         }
05136     }
05137 
05138 
05139     <span class="keywordflow">if</span> ( *NewFiringTime == 0 ) {
05140         *NewFiringTime = <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a> ;
05141     }
05142 }
05143 
05144 
05145 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05146"></a><a class="code" href="../../d2/d1/threads_8c.html#a61">05146</a> <a class="code" href="../../d3/d1/threads_8h.html#a126">RtlpInsertTimersIntoDeltaList</a> (
05147     IN PLIST_ENTRY NewTimerList,
05148     IN PLIST_ENTRY DeltaTimerList,
05149     IN ULONG TimeRemaining,
05150     OUT ULONG *NewFiringTime
05151     )
05152 <span class="comment">/*++</span>
05153 <span class="comment"></span>
05154 <span class="comment">Routine Description:</span>
05155 <span class="comment"></span>
05156 <span class="comment">    This routine walks thru a list of timers in NewTimerList and inserts them into a delta</span>
05157 <span class="comment">    timers list pointed to by DeltaTimerList. The timeout associated with the first element</span>
05158 <span class="comment">    in the new list is returned in NewFiringTime.</span>
05159 <span class="comment"></span>
05160 <span class="comment">Arguments:</span>
05161 <span class="comment"></span>
05162 <span class="comment">    NewTimerList - List of timers that need to be inserted into the DeltaTimerList</span>
05163 <span class="comment"></span>
05164 <span class="comment">    DeltaTimerList - Existing delta list of zero or more timers.</span>
05165 <span class="comment"></span>
05166 <span class="comment">    TimeRemaining - Firing time of the first element in the DeltaTimerList</span>
05167 <span class="comment"></span>
05168 <span class="comment">    NewFiringTime - Location where the new firing time will be returned</span>
05169 <span class="comment"></span>
05170 <span class="comment">Return Value:</span>
05171 <span class="comment"></span>
05172 <span class="comment"></span>
05173 <span class="comment">--*/</span>
05174 {
05175     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Timer ;
05176     PLIST_ENTRY TNode ;
05177     PLIST_ENTRY Temp ;
05178 
05179     <span class="keywordflow">for</span> (TNode = NewTimerList-&gt;Flink ; TNode != NewTimerList ; TNode = TNode-&gt;Flink) {
05180 
05181         Temp = TNode-&gt;Blink ;
05182 
05183         RemoveEntryList (Temp-&gt;Flink) ;
05184 
05185         Timer = CONTAINING_RECORD (TNode, <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">RTLP_GENERIC_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
05186 
05187         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (DeltaTimerList, Timer, TimeRemaining, NewFiringTime)) {
05188 
05189             TimeRemaining = *NewFiringTime ;
05190 
05191         }
05192 
05193         TNode = Temp ;
05194 
05195     }
05196 
05197 }
05198 
05199 
05200 LONG
<a name="l05201"></a><a class="code" href="../../d3/d1/threads_8h.html#a120">05201</a> <a class="code" href="../../d3/d1/threads_8h.html#a120">RtlpTimerThread</a> (
05202     PVOID  Initialized
05203     )
05204 <span class="comment">/*++</span>
05205 <span class="comment"></span>
05206 <span class="comment">Routine Description:</span>
05207 <span class="comment"></span>
05208 <span class="comment">    All the timer activity takes place in APCs.</span>
05209 <span class="comment"></span>
05210 <span class="comment">Arguments:</span>
05211 <span class="comment"></span>
05212 <span class="comment">    Initialized - Used to notify the starter of the thread that thread initialization </span>
05213 <span class="comment">    has completed</span>
05214 <span class="comment"></span>
05215 <span class="comment">Return Value:</span>
05216 <span class="comment"></span>
05217 <span class="comment">--*/</span>
05218 {
05219     LARGE_INTEGER TimeOut ;
05220 
05221     <span class="comment">// no structure initializations should be done here as new timer thread</span>
05222     <span class="comment">// may be created after threadPoolCleanup</span>
05223     
05224 
05225     <a class="code" href="../../d3/d1/threads_8h.html#a73">TimerThreadId</a> = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
05226 
05227 
05228     <span class="comment">// Reset the NT Timer to never fire initially</span>
05229 
05230     <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, -1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
05231 
05232     <span class="comment">// Notify starter of this thread that it has initialized</span>
05233 
05234     InterlockedExchange ((ULONG *) <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, 1) ;
05235 
05236     <span class="comment">// Sleep alertably so that all the activity can take place</span>
05237     <span class="comment">// in APCs</span>
05238 
05239     <span class="keywordflow">for</span> ( ; ; ) {
05240 
05241         <span class="comment">// Set timeout for the largest timeout possible</span>
05242 
05243         TimeOut.LowPart = 0 ;
05244         TimeOut.HighPart = 0x80000000 ;
05245 
05246         <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;TimeOut) ;
05247 
05248     }
05249 
05250     <span class="keywordflow">return</span> 0 ;  <span class="comment">// Keep compiler happy</span>
05251 
05252 }
05253 
05254 
05255 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05256"></a><a class="code" href="../../d3/d1/threads_8h.html#a115">05256</a> <a class="code" href="../../d2/d1/threads_8c.html#a63">RtlpInitializeTimerThreadPool</a> (
05257     )
05258 <span class="comment">/*++</span>
05259 <span class="comment"></span>
05260 <span class="comment">Routine Description:</span>
05261 <span class="comment"></span>
05262 <span class="comment">    This routine is used to initialize structures used for Timer Thread</span>
05263 <span class="comment"></span>
05264 <span class="comment">Arguments:</span>
05265 <span class="comment"></span>
05266 <span class="comment"></span>
05267 <span class="comment">Return Value:</span>
05268 <span class="comment"></span>
05269 <span class="comment">--*/</span>
05270 {
05271     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05272     LARGE_INTEGER TimeOut ;
05273 
05274     <span class="comment">// In order to avoid an explicit RtlInitialize() function to initialize the wait thread pool</span>
05275     <span class="comment">// we use StartedTimerInitialization and CompletedTimerInitialization to provide us the</span>
05276     <span class="comment">// necessary synchronization to avoid multiple threads from initializing the thread pool.</span>
05277     <span class="comment">// This scheme does not work if RtlInitializeCriticalSection() or NtCreateEvent fails - but in this case the</span>
05278     <span class="comment">// caller has not choices left.</span>
05279 
05280     <span class="keywordflow">if</span> (!InterlockedExchange(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a68">StartedTimerInitialization</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
05281 
05282         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a>)
05283             InterlockedExchange(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a>, 0 ) ;
05284 
05285         <span class="keywordflow">do</span> {
05286 
05287             <span class="comment">// Initialize global timer lock</span>
05288 
05289             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a99">TimerCriticalSection</a> ) ;
05290             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
05291                 <span class="keywordflow">break</span> ;
05292             }
05293 
05294             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d2/timer_8c.html#a11">NtCreateTimer</a>(
05295                                 &amp;<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>,
05296                                 TIMER_ALL_ACCESS,
05297                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05298                                 NotificationTimer
05299                                 ) ;
05300 
05301             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) )
05302                 <span class="keywordflow">break</span> ;
05303                 
05304             InitializeListHead (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>) ; <span class="comment">// Initialize Timer Queue Structures</span>
05305 
05306 
05307             <span class="comment">// initialize tick count</span>
05308 
05309             <a class="code" href="../../d3/d1/threads_8h.html#a110">Resync64BitTickCount</a>.QuadPart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>()  ;
05310             <a class="code" href="../../d3/d1/threads_8h.html#a111">Firing64BitTickCount</a>.QuadPart = 0 ;
05311 
05312             
05313             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> (<a class="code" href="../../d2/d1/threads_8c.html#a62">RtlpTimerThread</a>, &amp;<a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a>) ;
05314 
05315             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) )
05316                 <span class="keywordflow">break</span> ;
05317 
05318 
05319         } <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
05320 
05321         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
05322 
05323             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) ;
05324             
05325             <a class="code" href="../../d3/d1/threads_8h.html#a68">StartedTimerInitialization</a> = 0 ;
05326             InterlockedExchange (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a>, ~0) ;
05327             
05328             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
05329         }
05330         
05331         InterlockedExchange (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) ;
05332 
05333     } <span class="keywordflow">else</span> {
05334 
05335         <span class="comment">// Sleep 1 ms and see if the other thread has completed initialization</span>
05336 
05337         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
05338 
05339         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a>) {
05340 
05341             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;TimeOut) ;
05342 
05343         }
05344         
05345         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a> != 1)
05346             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY ;
05347     }
05348 
05349     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
05350 }
05351 
05352 
05353 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05354"></a><a class="code" href="../../d3/d1/threads_8h.html#a142">05354</a> <a class="code" href="../../d3/d1/threads_8h.html#a142">RtlpDeleteTimerQueue</a> (
05355     PRTLP_TIMER_QUEUE Queue
05356     )
05357 <span class="comment">/*++</span>
05358 <span class="comment"></span>
05359 <span class="comment">Routine Description:</span>
05360 <span class="comment"></span>
05361 <span class="comment">    This routine deletes the queue specified in the Request and frees all timers</span>
05362 <span class="comment"></span>
05363 <span class="comment">Arguments:</span>
05364 <span class="comment"></span>
05365 <span class="comment">    Queue - queue to delete</span>
05366 <span class="comment"></span>
05367 <span class="comment">    Event - Event Handle used for signalling completion of request</span>
05368 <span class="comment"></span>
05369 <span class="comment">Return Value:</span>
05370 <span class="comment"></span>
05371 <span class="comment">--*/</span>
05372 {
05373     ULONG TimeRemaining ;
05374     ULONG NewFiringTime ;
05375     PLIST_ENTRY Node ;
05376     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
05377 
05378     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>() ;
05379 
05380     <a class="code" href="../../d3/d1/threads_8h.html#a33">SET_DEL_TIMERQ_SIGNATURE</a>( Queue ) ;
05381 
05382     
05383     <span class="comment">// If there are no timers in the queue then it is not attached to TimerQueues</span>
05384     <span class="comment">// In this case simply free the memory and return. Otherwise we have to first</span>
05385     <span class="comment">// remove the queue from the TimerQueues List, update the firing time if this</span>
05386     <span class="comment">// was the first queue in the list and then walk all the timers and free them</span>
05387     <span class="comment">// before freeing the Timer Queue.</span>
05388 
05389     <span class="keywordflow">if</span> (!IsListEmpty (&amp;Queue-&gt;List)) {
05390 
05391         TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>) 
05392                         + <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (Queue) ;
05393 
05394         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>, Queue, TimeRemaining, 
05395                                     &amp;NewFiringTime)) 
05396         {
05397 
05398             <span class="comment">// If removed from head of queue list, reset the timer</span>
05399 
05400             <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, NewFiringTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
05401         }
05402 
05403 
05404         <span class="comment">// Free all the timers associated with this queue</span>
05405 
05406         <span class="keywordflow">for</span> (Node = Queue-&gt;TimerList.Flink ; Node != &amp;Queue-&gt;TimerList ; ) {
05407 
05408             Timer =  CONTAINING_RECORD (Node, <a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
05409             
05410             Node = Node-&gt;Flink ;
05411 
05412             <a class="code" href="../../d3/d1/threads_8h.html#a140">RtlpCancelTimerEx</a>( Timer ,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) ; <span class="comment">// Queue being deleted</span>
05413         }
05414     }
05415 
05416 
05417     <span class="comment">// Free all the uncancelled one shot timers in this queue</span>
05418 
05419     <span class="keywordflow">for</span> (Node = Queue-&gt;UncancelledTimerList.Flink ; Node != &amp;Queue-&gt;UncancelledTimerList ; ) {
05420 
05421         Timer =  CONTAINING_RECORD (Node, <a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
05422         
05423         Node = Node-&gt;Flink ;
05424 
05425         <a class="code" href="../../d3/d1/threads_8h.html#a140">RtlpCancelTimerEx</a>( Timer ,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) ; <span class="comment">// Queue being deleted</span>
05426     }
05427 
05428 
05429     <span class="comment">// delete the queue completely if the RefCount is 0</span>
05430     
05431     <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Queue-&gt;RefCount ) == 0 ) {
05432     
05433         <a class="code" href="../../d3/d1/threads_8h.html#a143">RtlpDeleteTimerQueueComplete</a>( Queue ) ;
05434 
05435         <span class="keywordflow">return</span> STATUS_SUCCESS ;
05436         
05437     } <span class="keywordflow">else</span> {
05438     
05439         <span class="keywordflow">return</span> STATUS_PENDING ;
05440     }
05441 
05442 }
05443 
05444 
05445 
05446 <span class="comment">/*++</span>
05447 <span class="comment"></span>
05448 <span class="comment">Routine Description:</span>
05449 <span class="comment"></span>
05450 <span class="comment">    This routine frees the queue and sets the event.</span>
05451 <span class="comment"></span>
05452 <span class="comment">Arguments:</span>
05453 <span class="comment"></span>
05454 <span class="comment">    Queue - queue to delete</span>
05455 <span class="comment"></span>
05456 <span class="comment">    Event - Event Handle used for signalling completion of request</span>
05457 <span class="comment"></span>
05458 <span class="comment">Return Value:</span>
05459 <span class="comment"></span>
05460 <span class="comment">--*/</span>
05461 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05462"></a><a class="code" href="../../d3/d1/threads_8h.html#a143">05462</a> <a class="code" href="../../d3/d1/threads_8h.html#a143">RtlpDeleteTimerQueueComplete</a> (
05463     PRTLP_TIMER_QUEUE Queue
05464     )
05465 {
05466 <span class="preprocessor">    #if DBG1</span>
05467 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
05468     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Queue: %x: deleted\n\n"</span>, Queue-&gt;DbgId, 
05469             (ULONG_PTR)Queue) ;
05470 <span class="preprocessor">    #endif</span>
05471 <span class="preprocessor"></span>
05472     InterlockedDecrement( &amp;<a class="code" href="../../d3/d1/threads_8h.html#a96">NumTimerQueues</a> ) ;    
05473 
05474     <span class="comment">// Notify the thread issuing the cancel that the request is completed</span>
05475 
05476     <span class="keywordflow">if</span> ( Queue-&gt;CompletionEvent )
05477         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a> (Queue-&gt;CompletionEvent, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
05478     
05479     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Queue ) ;
05480 }
05481 
05482 
05483 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05484"></a><a class="code" href="../../d3/d1/threads_8h.html#a164">05484</a> <a class="code" href="../../d2/d1/threads_8c.html#a66">RtlpThreadCleanup</a> (
05485     )
05486 <span class="comment">/*++</span>
05487 <span class="comment"></span>
05488 <span class="comment">Routine Description:</span>
05489 <span class="comment"></span>
05490 <span class="comment">    This routine is used for exiting timer, wait and IOworker threads.</span>
05491 <span class="comment"></span>
05492 <span class="comment">Arguments:</span>
05493 <span class="comment"></span>
05494 <span class="comment">Return Value:</span>
05495 <span class="comment"></span>
05496 <span class="comment">--*/</span>
05497 {
05498     <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), 0) ;
05499 }
05500 
05501 
05502 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05503"></a><a class="code" href="../../d3/d1/threads_8h.html#a163">05503</a> <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a> (
05504     HANDLE Event,
05505     HANDLE ThreadHandle
05506     )
05507 <span class="comment">/*++</span>
05508 <span class="comment"></span>
05509 <span class="comment">Routine Description:</span>
05510 <span class="comment"></span>
05511 <span class="comment">    Waits for the event to be signalled. If the event is not signalled within</span>
05512 <span class="comment">    one second, then checks to see that the thread is alive</span>
05513 <span class="comment"></span>
05514 <span class="comment">Arguments:</span>
05515 <span class="comment"></span>
05516 <span class="comment">    Event : Event handle used for signalling completion of request</span>
05517 <span class="comment"></span>
05518 <span class="comment">    ThreadHandle: Thread to check whether still alive</span>
05519 <span class="comment"></span>
05520 <span class="comment">Return Value:</span>
05521 <span class="comment"></span>
05522 <span class="comment">    STATUS_SUCCESS if event was signalled</span>
05523 <span class="comment">    else return NTSTATUS</span>
05524 <span class="comment"></span>
05525 <span class="comment">--*/</span>
05526 {
05527     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
05528     LARGE_INTEGER TimeOut ;
05529     
05530     <span class="comment">// Timeout of 1 second for request to complete</span>
05531     <a class="code" href="../../d3/d1/threads_8h.html#a15">ONE_SECOND_TIMEOUT</a>(TimeOut) ;
05532 
05533 Wait:
05534 
05535     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;TimeOut) ;
05536     
05537     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
05538 
05539         <span class="comment">// The wait timed out. Check to see if the wait thread is still alive.</span>
05540         <span class="comment">// This is done by trying to queue a dummy APC to it. There is no better</span>
05541         <span class="comment">// way known to determine if the thread has died unexpectedly.</span>
05542         <span class="comment">// If so then go back to waiting.</span>
05543 
05544         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
05545             <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
05546             (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a40">RtlpDoNothing</a>,
05547             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05548             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05549             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05550             );
05551 
05552         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
05553 
05554             <span class="comment">// Wait thread is still alive. Go back to waiting.</span>
05555 
05556             <span class="keywordflow">goto</span> Wait ;
05557 
05558         } <span class="keywordflow">else</span> {
05559 
05560             <span class="comment">// The wait thread died between the time the APC was queued and the</span>
05561             <span class="comment">// the time we started waiting on NtQueryInformationThread()</span>
05562 
05563 
05564             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Thread died before event could be signalled"</span>) ;
05565 
05566         }
05567 
05568     }
05569 
05570     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
05571 }
05572 
05573 
05574 <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a>
<a name="l05575"></a><a class="code" href="../../d3/d1/threads_8h.html#a158">05575</a> <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> (
05576     VOID
05577     )
05578 <span class="comment">/*++</span>
05579 <span class="comment"></span>
05580 <span class="comment">Routine Description:</span>
05581 <span class="comment"></span>
05582 <span class="comment">    Returns an event from the event cache.</span>
05583 <span class="comment"></span>
05584 <span class="comment">Arguments:</span>
05585 <span class="comment"></span>
05586 <span class="comment">    None</span>
05587 <span class="comment"></span>
05588 <span class="comment">Return Value:</span>
05589 <span class="comment"></span>
05590 <span class="comment">    Pointer to event structure</span>
05591 <span class="comment"></span>
05592 <span class="comment">--*/</span>
05593 {
05594     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05595     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
05596 
05597     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d1/threads_8h.html#a71">CompletedEventCacheInitialization</a>) {
05598 
05599         <a class="code" href="../../d3/d1/threads_8h.html#a157">RtlpInitializeEventCache</a> () ;
05600 
05601     }
05602 
05603     RtlEnterCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a100">EventCacheCriticalSection</a>) ;
05604 
05605     <span class="keywordflow">if</span> (!IsListEmpty (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a93">EventCache</a>)) {
05606 
05607         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = (<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a>) RemoveHeadList (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a93">EventCache</a>) ;
05608 
05609     } <span class="keywordflow">else</span> {
05610 
05611         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a>( <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">RTLP_EVENT</a> ), 0 );
05612 
05613         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>) {
05614 
05615             RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a100">EventCacheCriticalSection</a>) ;
05616 
05617             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
05618 
05619         }
05620 
05621         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(
05622                     &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Handle,
05623                     EVENT_ALL_ACCESS,
05624                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05625                     SynchronizationEvent,
05626                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
05627                     );
05628 
05629         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
05630 
05631             <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ) ;
05632 
05633             RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a100">EventCacheCriticalSection</a>) ;
05634 
05635             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
05636 
05637         }
05638 
05639     }
05640 
05641     RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a100">EventCacheCriticalSection</a>) ;
05642 
05643     <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
05644 }
05645 
05646 
05647 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05648"></a><a class="code" href="../../d3/d1/threads_8h.html#a156">05648</a> <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a> (
05649     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> Event
05650     )
05651 <span class="comment">/*++</span>
05652 <span class="comment"></span>
05653 <span class="comment">Routine Description:</span>
05654 <span class="comment"></span>
05655 <span class="comment">    Frees the event to the event cache</span>
05656 <span class="comment"></span>
05657 <span class="comment">Arguments:</span>
05658 <span class="comment"></span>
05659 <span class="comment">    Event - the event struct to put back into the cache</span>
05660 <span class="comment"></span>
05661 <span class="comment">Return Value:</span>
05662 <span class="comment"></span>
05663 <span class="comment">    Nothing</span>
05664 <span class="comment"></span>
05665 <span class="comment">--*/</span>
05666 {
05667 
05668     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
05669         <span class="keywordflow">return</span> ;
05670         
05671     InitializeListHead (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;List) ;
05672 
05673     RtlEnterCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a100">EventCacheCriticalSection</a>) ;
05674 
05675     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d1/threads_8h.html#a87">NumUnusedEvents</a> &gt; <a class="code" href="../../d3/d1/threads_8h.html#a12">MAX_UNUSED_EVENTS</a> ) {
05676 
05677         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Handle ) ;
05678         
05679         <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ) ;
05680 
05681     } <span class="keywordflow">else</span> {
05682     
05683         InsertHeadList (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a93">EventCache</a>, &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;List) ;
05684         <a class="code" href="../../d3/d1/threads_8h.html#a87">NumUnusedEvents</a>++ ;
05685     }
05686 
05687     
05688     RtlLeaveCriticalSection (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a100">EventCacheCriticalSection</a>) ;
05689 }
05690 
05691 
05692 
05693 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05694"></a><a class="code" href="../../d3/d1/threads_8h.html#a157">05694</a> <a class="code" href="../../d3/d1/threads_8h.html#a157">RtlpInitializeEventCache</a> (
05695     VOID
05696     )
05697 <span class="comment">/*++</span>
05698 <span class="comment"></span>
05699 <span class="comment">Routine Description:</span>
05700 <span class="comment"></span>
05701 <span class="comment">    Initializes the event cache</span>
05702 <span class="comment"></span>
05703 <span class="comment">Arguments:</span>
05704 <span class="comment"></span>
05705 <span class="comment">    None</span>
05706 <span class="comment"></span>
05707 <span class="comment">Return Value:</span>
05708 <span class="comment"></span>
05709 <span class="comment">    Nothing</span>
05710 <span class="comment"></span>
05711 <span class="comment">--*/</span>
05712 {
05713     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05714     LARGE_INTEGER TimeOut ;
05715 
05716     <span class="keywordflow">if</span> (!InterlockedExchange(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a70">StartedEventCacheInitialization</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
05717 
05718         InitializeListHead (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a93">EventCache</a>) ;
05719 
05720         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d3/d1/threads_8h.html#a100">EventCacheCriticalSection</a>) ;
05721 
05722         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) ;
05723 
05724         <a class="code" href="../../d3/d1/threads_8h.html#a87">NumUnusedEvents</a> = 0 ;
05725         
05726         InterlockedExchange (&amp;<a class="code" href="../../d3/d1/threads_8h.html#a71">CompletedEventCacheInitialization</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) ;
05727 
05728     } <span class="keywordflow">else</span> {
05729 
05730         <span class="comment">// sleep for 1 milliseconds and see if the initialization is complete</span>
05731 
05732         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
05733 
05734         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d3/d1/threads_8h.html#a71">CompletedEventCacheInitialization</a>) {
05735 
05736             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;TimeOut) ;
05737 
05738         }
05739 
05740     }
05741 }
05742 
05743 
05744 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05745"></a><a class="code" href="../../d2/d1/threads_8c.html#a71">05745</a> <a class="code" href="../../d2/d1/threads_8c.html#a71">PrintTimerQueue</a>(PLIST_ENTRY QNode, ULONG Delta, ULONG Count
05746     )
05747 {
05748     PLIST_ENTRY Tnode ;
05749     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
05750     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
05751     
05752     Queue = CONTAINING_RECORD (QNode, <a class="code" href="../../d3/d1/threads_8h.html#a3">RTLP_TIMER_QUEUE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
05753     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%1d&gt; Queue: %x FiringTime:%d\n"</span>, <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>, (ULONG_PTR)Queue, 
05754                 Queue-&gt;DeltaFiringTime);
05755     <span class="keywordflow">for</span> (Tnode=Queue-&gt;TimerList.Flink; Tnode!=&amp;Queue-&gt;TimerList; 
05756             Tnode=Tnode-&gt;Flink) 
05757     {
05758         Timer = CONTAINING_RECORD (Tnode, <a class="code" href="../../d3/d1/threads_8h.html#a1">RTLP_TIMER</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
05759         Delta += Timer-&gt;DeltaFiringTime ;
05760         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        Timer: %x Delta:%d Period:%d\n"</span>,(ULONG_PTR)Timer,
05761                     Delta, Timer-&gt;Period);
05762     }
05763 
05764 }
05765 
05766 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05767"></a><a class="code" href="../../d2/d1/threads_8c.html#a72">05767</a> <a class="code" href="../../d2/d1/threads_8c.html#a72">RtlDebugPrintTimes</a> (
05768     )
05769 {    
05770     PLIST_ENTRY QNode ;
05771     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0 ;
05772     ULONG Delta = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>) ;
05773     ULONG CurrentThreadId =  
05774                         HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
05775 
05776     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>();
05777 
05778     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a> != 1) {
05779 
05780         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"===========RtlTimerThread not yet initialized==========\n"</span>);
05781         <span class="keywordflow">return</span> ;
05782     }
05783 
05784     <span class="keywordflow">if</span> (CurrentThreadId == <a class="code" href="../../d3/d1/threads_8h.html#a73">TimerThreadId</a>)
05785     {
05786         <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
05787         
05788         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"================Printing timerqueues====================\n"</span>);
05789         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"TimeRemaining: %d\n"</span>, Delta);
05790         <span class="keywordflow">for</span> (QNode = <a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>.Flink; QNode != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>; 
05791                 QNode = QNode-&gt;Flink)
05792         {
05793             Queue = CONTAINING_RECORD (QNode, <a class="code" href="../../d3/d1/threads_8h.html#a3">RTLP_TIMER_QUEUE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) ;
05794             Delta += Queue-&gt;DeltaFiringTime ;
05795             
05796             <a class="code" href="../../d2/d1/threads_8c.html#a71">PrintTimerQueue</a>(QNode, Delta, ++<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
05797             
05798         }
05799         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"================Printed ================================\n"</span>);
05800     }
05801 
05802     <span class="keywordflow">else</span>
05803     {
05804         <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
05805                     <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a>,
05806                     (PPS_APC_ROUTINE)<a class="code" href="../../d2/d1/threads_8c.html#a72">RtlDebugPrintTimes</a>,
05807                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05808                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05809                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05810                     );
05811     }
05812 }
05813 
05814 
05815 <span class="comment">/*DO NOT USE THIS FUNCTION: REPLACED BY RTLCREATETIMER*/</span>
05816 
05817 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05818"></a><a class="code" href="../../d2/d1/threads_8c.html#a73">05818</a> <a class="code" href="../../d2/d1/threads_8c.html#a73">RtlSetTimer</a>(
05819     IN  HANDLE TimerQueueHandle,
05820     OUT HANDLE *Handle,
05821     IN  WAITORTIMERCALLBACKFUNC Function,
05822     IN  PVOID Context,
05823     IN  ULONG  DueTime,
05824     IN  ULONG  Period,
05825     IN  ULONG  Flags
05826     )
05827 {
05828     <span class="keyword">static</span> ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
05829     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++ ==0) {
05830         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Using obsolete function call: RtlSetTimer\n"</span>);
05831         DbgBreakPoint();
05832         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Using obsolete function call: RtlSetTimer\n"</span>);
05833     }
05834     
05835     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/threads_8c.html#a13">RtlCreateTimer</a>(TimerQueueHandle,
05836                             <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
05837                             Function,
05838                             Context,
05839                             DueTime,
05840                             Period,
05841                             Flags
05842                             ) ;
05843 }
05844 
05845 
05846 PVOID
<a name="l05847"></a><a class="code" href="../../d3/d1/threads_8h.html#a166">05847</a> <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a>(
05848     ULONG dwSize,
05849     ULONG dwFlags
05850     )
05851 <span class="comment">/*++</span>
05852 <span class="comment">Routine Description:</span>
05853 <span class="comment"></span>
05854 <span class="comment">    This routine goes into an infinite loop trying to allocate the memory.</span>
05855 <span class="comment"></span>
05856 <span class="comment">Arguments:</span>
05857 <span class="comment"></span>
05858 <span class="comment">    dwSize - size of memory to be allocated</span>
05859 <span class="comment"></span>
05860 <span class="comment">    dwFlags - Flags for memory allocation</span>
05861 <span class="comment"></span>
05862 <span class="comment">Return Value:</span>
05863 <span class="comment"></span>
05864 <span class="comment">    ptr to memory</span>
05865 <span class="comment"></span>
05866 <span class="comment">--*/</span>
05867 {
05868     PVOID ptr;
05869     ptr = <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a>(dwSize, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
05870     <span class="keywordflow">if</span> (ptr)
05871         <span class="keywordflow">return</span> ptr;
05872 
05873     {
05874         LARGE_INTEGER TimeOut ;
05875         <span class="keywordflow">do</span> {
05876 
05877             <a class="code" href="../../d3/d1/threads_8h.html#a15">ONE_SECOND_TIMEOUT</a>(TimeOut) ;
05878 
05879             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;TimeOut) ;
05880 
05881             ptr = <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a>(dwSize, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
05882             <span class="keywordflow">if</span> (ptr)
05883                 <span class="keywordflow">break</span>;
05884 
05885         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ;
05886     }
05887     <span class="keywordflow">return</span> ptr;
05888 }
05889 
05890 
05891 
05892 <span class="comment">/*DO NOT USE THIS FUNCTION: REPLACED BY RTLDeleteTimer*/</span>
05893 
05894 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05895"></a><a class="code" href="../../d2/d1/threads_8c.html#a75">05895</a> <a class="code" href="../../d2/d1/threads_8c.html#a75">RtlCancelTimer</a>(
05896     IN HANDLE TimerQueueHandle,
05897     IN HANDLE TimerToCancel
05898     )
05899 <span class="comment">/*++</span>
05900 <span class="comment"></span>
05901 <span class="comment">Routine Description:</span>
05902 <span class="comment"></span>
05903 <span class="comment">    This routine cancels the timer. This call is non-blocking. The timer Callback</span>
05904 <span class="comment">    will not be executed after this call returns.</span>
05905 <span class="comment"></span>
05906 <span class="comment">Arguments:</span>
05907 <span class="comment"></span>
05908 <span class="comment">    TimerQueueHandle - Handle identifying the queue from which to delete timer</span>
05909 <span class="comment"></span>
05910 <span class="comment">    TimerToCancel - Handle identifying the timer to cancel</span>
05911 <span class="comment"></span>
05912 <span class="comment">Return Value:</span>
05913 <span class="comment"></span>
05914 <span class="comment">    NTSTATUS - Result code from call.  The following are returned</span>
05915 <span class="comment"></span>
05916 <span class="comment">        STATUS_SUCCESS - Timer cancelled. All callbacks completed.</span>
05917 <span class="comment">        STATUS_PENDING - Timer cancelled. Some callbacks still not completed.</span>
05918 <span class="comment"></span>
05919 <span class="comment">--*/</span>
05920 {
05921     <span class="keyword">static</span> ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
05922     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++ ==0) {
05923         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Using obsolete function call: RtlCancelTimer\n"</span>);
05924         DbgBreakPoint();
05925         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Using obsolete function call: RtlCancelTimer\n"</span>);
05926     }
05927     
05928     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/threads_8c.html#a15">RtlDeleteTimer</a>( TimerQueueHandle, TimerToCancel, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ;
05929 }
05930 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
