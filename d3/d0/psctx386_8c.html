<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psctx386.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psctx386.c File Reference</h1><code>#include "<a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>"</code><br>

<p>
<a href="../../d4/d9/psctx386_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d0/psctx386_8c.html#a0">PSPALIGN_DOWN</a>(address, amt)&nbsp;&nbsp;&nbsp;((ULONG)(address) &amp; ~(( amt ) - 1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d0/psctx386_8c.html#a1">PSPALIGN_UP</a>(address, amt)&nbsp;&nbsp;&nbsp;(PSPALIGN_DOWN( (address + (amt) - 1), (amt) ))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d0/psctx386_8c.html#a2">PspGetContext</a> (IN PKTRAP_FRAME TrapFrame, IN PKNONVOLATILE_CONTEXT_POINTERS NonVolatileContext, IN OUT PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d0/psctx386_8c.html#a3">PspSetContext</a> (OUT PKTRAP_FRAME TrapFrame, OUT PKNONVOLATILE_CONTEXT_POINTERS NonVolatileContext, IN PCONTEXT Context, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> Mode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d0/psctx386_8c.html#a4">PspGetSetContextSpecialApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="psctx386.c::PSPALIGN_DOWN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSPALIGN_DOWN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>amt&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)(address) &amp; ~(( amt ) - 1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00034">34</a> of file <a class="el" href="../../d4/d9/psctx386_8c-source.html">psctx386.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="psctx386.c::PSPALIGN_UP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSPALIGN_UP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>amt&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(PSPALIGN_DOWN( (address + (amt) - 1), (amt) ))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00036">36</a> of file <a class="el" href="../../d4/d9/psctx386_8c-source.html">psctx386.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00131">PspGetSetContextSpecialApc()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="psctx386.c::PspGetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspGetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKNONVOLATILE_CONTEXT_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>NonVolatileContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00046">46</a> of file <a class="el" href="../../d4/d9/psctx386_8c-source.html">psctx386.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00081">KeContextFromKframes()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00054                    :
00055 
00056     This function moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap and NonVolatile
00057     context into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context record. It's primary user will
00058     be <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>.
00059 
00060     N.B. - NonVolatileContext <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> IGNORED on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 386.
00061 
00062 Arguments:
00063 
00064     TrapFrame - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of a trap frame that should be
00065                 restored copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper location in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
00066                 record.
00067 
00068     Context - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> threads current context.
00069 
00070 Return Value:
00071 
00072     None.
00073 
00074 --*/
00075 
00076 {
00077     UNREFERENCED_PARAMETER( NonVolatileContext );
00078 
00079     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00080 
00081     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((TrapFrame-&gt;SegCs &amp; MODE_MASK) != KernelMode) ||
00082            (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK));
00083 
00084     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, NULL, Context);
00085 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="psctx386.c::PspGetSetContextSpecialApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspGetSetContextSpecialApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00131">131</a> of file <a class="el" href="../../d4/d9/psctx386_8c-source.html">psctx386.c</a>.
<p>
References <a class="el" href="../../d9/d0/psp_8h-source.html#l00080">_GETSETCONTEXT::Context</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00556">_KTHREAD::InitialStack</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00078">_GETSETCONTEXT::Mode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00079">_GETSETCONTEXT::OperationComplete</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d8/d1/psp_8h.html#a13">PGETSETCONTEXT</a>, <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00036">PSPALIGN_UP</a>, <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00029">PspGetContext()</a>, <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00088">PspSetContext()</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, and <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>.
<p>
<pre class="fragment"><div>00141                    :
00142 
00143     This function either captures <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usermode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00144     thread, or sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usermode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread. The
00145     operation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of SystemArgument1. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>
00146     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> get context, and a non-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used
00147     <span class="keywordflow">for</span> set context.
00148 
00149 Arguments:
00150 
00151     Apc - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object that caused entry
00152           into <span class="keyword">this</span> routine.
00153 
00154     NormalRoutine - Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal routine
00155         function that was specifed when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
00156 
00157     NormalContext - Supplies a pointer to a pointer to an arbitrary data
00158         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
00159 
00160     SystemArgument1, SystemArgument2 - Supplies a set of two pointer to two
00161         arguments that contain untyped data.
00162 
00163 Return Value:
00164 
00165     None.
00166 
00167 --*/
00168 
00169 {
00170     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">PGETSETCONTEXT</a> Ctx;
00171     PKTRAP_FRAME TrapFrame;
00172     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00173 
00174     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00175 
00176     UNREFERENCED_PARAMETER( NormalRoutine );
00177     UNREFERENCED_PARAMETER( NormalContext );
00178     UNREFERENCED_PARAMETER( SystemArgument1 );
00179     UNREFERENCED_PARAMETER( SystemArgument2 );
00180 
00181     Ctx = CONTAINING_RECORD(Apc,<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a>,Apc);
00182     Thread = Apc-&gt;SystemArgument2;
00183 
00184     TrapFrame = (PKTRAP_FRAME)((PUCHAR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> -
00185                 <a class="code" href="../../d3/d0/psctx386_8c.html#a1">PSPALIGN_UP</a>(<span class="keyword">sizeof</span>(KTRAP_FRAME),KTRAP_FRAME_ALIGN) -
00186                 <span class="keyword">sizeof</span>(FX_SAVE_AREA));
00187 
00188     <span class="keywordflow">if</span> ( Apc-&gt;SystemArgument1 ) {
00189 
00190         <span class="comment">//</span>
00191         <span class="comment">// Set Context</span>
00192         <span class="comment">//</span>
00193 
00194         <a class="code" href="../../d8/d1/psp_8h.html#a72">PspSetContext</a>(TrapFrame,NULL,&amp;Ctx-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,Ctx-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a>);
00195 
00196     } <span class="keywordflow">else</span> {
00197 
00198         <span class="comment">//</span>
00199         <span class="comment">// Get Context</span>
00200         <span class="comment">//</span>
00201 
00202         <a class="code" href="../../d8/d1/psp_8h.html#a73">PspGetContext</a>(TrapFrame,NULL,&amp;Ctx-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>);
00203     }
00204 
00205     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;Ctx-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,0,FALSE);
00206 
00207 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="psctx386.c::PspSetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspSetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PKNONVOLATILE_CONTEXT_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>NonVolatileContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00088">88</a> of file <a class="el" href="../../d4/d9/psctx386_8c-source.html">psctx386.c</a>.
<p>
<pre class="fragment"><div>00097                    :
00098 
00099     This function moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context record
00100     into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap frame, and modifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's non <span class="keyword">volatile</span>
00101     context by storing through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's nonvolatile context pointers.
00102 
00103     N.B. - NonVolatileContext <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> IGNORED on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 386.
00104 
00105 Arguments:
00106 
00107     TrapFrame - Returns selected pieces of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00108 
00109     Context - Supplies a context record to be copied in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and
00110               nonvolatile context.
00111 
00112     Mode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode to be used when sanitizing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> psr, epsr and fsr
00113 
00114 Return Value:
00115 
00116     None.
00117 
00118 --*/
00119 
00120 {
00121     UNREFERENCED_PARAMETER( NonVolatileContext );
00122     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((TrapFrame-&gt;SegCs &amp; MODE_MASK) != KernelMode) ||
00123            (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK));
00124 
00125     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00126 
00127     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame, NULL, Context, Context-&gt;ContextFlags, Mode);
00128 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
