<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: query.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>query.c</h1><a href="../../d2/d3/io_2query_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989-1994  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    query.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the subroutines to Query Device Descriptions from</span>
00012 <span class="comment">    the Hardware tree in the registry</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Andre Vachon (andreva) 20-Jun-1994</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00028 
<a name="l00029"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html">00029</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html">_IO_QUERY_DESC</a> {
<a name="l00030"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">00030</a>     PINTERFACE_TYPE <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>;
<a name="l00031"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">00031</a>     PULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
<a name="l00032"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">00032</a>     <a class="code" href="../../d1/d9/arc_8h.html#a57">PCONFIGURATION_TYPE</a> <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a>;
<a name="l00033"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o3">00033</a>     PULONG <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o3">ControllerNumber</a>;
<a name="l00034"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">00034</a>     <a class="code" href="../../d1/d9/arc_8h.html#a57">PCONFIGURATION_TYPE</a> <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a>;
<a name="l00035"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o5">00035</a>     PULONG <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o5">PeripheralNumber</a>;
<a name="l00036"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">00036</a>     <a class="code" href="../../d0/d5/io_8h.html#a272">PIO_QUERY_DEVICE_ROUTINE</a> <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a>;
<a name="l00037"></a><a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">00037</a>     PVOID <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a>;
00038 } <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html">IO_QUERY_DESC</a>, *<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html">PIO_QUERY_DESC</a>;
00039 
00040 
00041 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00042 <a class="code" href="../../d2/d3/io_2query_8c.html#a4">pIoQueryBusDescription</a>(
00043     PIO_QUERY_DESC QueryDescription,
00044     UNICODE_STRING PathName,
00045     HANDLE RootHandle,
00046     PULONG BusNum,
00047     BOOLEAN HighKey
00048     );
00049 
00050 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00051 <a class="code" href="../../d2/d3/io_2query_8c.html#a5">pIoQueryDeviceDescription</a>(
00052     PIO_QUERY_DESC QueryDescription,
00053     UNICODE_STRING PathName,
00054     HANDLE RootHandle,
00055     ULONG BusNum,
00056     PKEY_VALUE_FULL_INFORMATION *BusValueInfo
00057     );
00058 
00059 
00060 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoQueryDeviceDescription)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, pIoQueryBusDescription)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, pIoQueryDeviceDescription)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>
00066 
00067 
00068 
00069 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00070"></a><a class="code" href="../../d2/d3/io_2query_8c.html#a6">00070</a> <a class="code" href="../../d2/d3/io_2query_8c.html#a6">IoQueryDeviceDescription</a>(
00071     IN PINTERFACE_TYPE BusType OPTIONAL,
00072     IN PULONG BusNumber OPTIONAL,
00073     IN PCONFIGURATION_TYPE ControllerType OPTIONAL,
00074     IN PULONG ControllerNumber OPTIONAL,
00075     IN PCONFIGURATION_TYPE PeripheralType OPTIONAL,
00076     IN PULONG PeripheralNumber OPTIONAL,
00077     IN PIO_QUERY_DEVICE_ROUTINE CalloutRoutine,
00078     IN PVOID Context
00079     )
00080 
00081 <span class="comment">/*++</span>
00082 <span class="comment"></span>
00083 <span class="comment">Routine Description:</span>
00084 <span class="comment"></span>
00085 <span class="comment"></span>
00086 <span class="comment">Arguments:</span>
00087 <span class="comment"></span>
00088 <span class="comment">    BusType - Supplies an optional bus type being searched for in the</span>
00089 <span class="comment">        description tree. Valid types are Mca, Isa, Eisa ... If no bus type</span>
00090 <span class="comment">        is specified, the system information (i.e. machine BIOS) is returned.</span>
00091 <span class="comment"></span>
00092 <span class="comment">    BusNumber - Supplies an optional value determining which bus should be</span>
00093 <span class="comment">        queried.</span>
00094 <span class="comment"></span>
00095 <span class="comment">    ControllerType - Supplies an optional controller type being searched for.</span>
00096 <span class="comment">        If no Controller type is specified, only the Bus information is</span>
00097 <span class="comment">        returned.</span>
00098 <span class="comment"></span>
00099 <span class="comment">    ControllerNumber - Supplies an optional value determining which</span>
00100 <span class="comment">        controller should be queried.</span>
00101 <span class="comment"></span>
00102 <span class="comment">    PeripheralType - Supplies an optional peripheral type being searched for.</span>
00103 <span class="comment">        If no Controller type is specified, only the Bus information and the</span>
00104 <span class="comment">        controller information are returned.</span>
00105 <span class="comment"></span>
00106 <span class="comment">    PeripheralNumber - Supplies an optional value determining which</span>
00107 <span class="comment">        peripheral should be queried.</span>
00108 <span class="comment"></span>
00109 <span class="comment">    CalloutRoutine - Supplies a pointer to a routine that gets called</span>
00110 <span class="comment">       for each successful match of PeripheralType.</span>
00111 <span class="comment"></span>
00112 <span class="comment">    Context - Supplies a context value that is passed back to the callback</span>
00113 <span class="comment">        routine.</span>
00114 <span class="comment"></span>
00115 <span class="comment">Return Value:</span>
00116 <span class="comment"></span>
00117 <span class="comment">    The status returned is the final completion status of the operation.</span>
00118 <span class="comment"></span>
00119 <span class="comment">Notes:</span>
00120 <span class="comment"></span>
00121 <span class="comment">--*/</span>
00122 
00123 {
00124 
00125 <span class="preprocessor">#define UNICODE_NUM_LENGTH 14</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#define UNICODE_REGISTRY_PATH_LENGTH 1024</span>
00127 <span class="preprocessor"></span>
00128     <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html">IO_QUERY_DESC</a> queryDesc;
00129 
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00131     UNICODE_STRING registryPathName;
00132     HANDLE rootHandle;
00133     ULONG busNumber = (ULONG) -1;
00134 
00135 
00136     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00137 
00138     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CalloutRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">// Check if we need to return the machine information</span>
00142     <span class="comment">//</span>
00143 
00144     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( BusType )) {
00145         <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00146     }
00147 
00148     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a> = BusType;
00149     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a> = <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00150     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>;
00151     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o3">ControllerNumber</a> = ControllerNumber;
00152     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>;
00153     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o5">PeripheralNumber</a> = PeripheralNumber;
00154     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a> = CalloutRoutine;
00155     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a> = Context;
00156 
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">// Set up a string with the pathname to the hardware description</span>
00160     <span class="comment">// portion of the registry.</span>
00161     <span class="comment">//</span>
00162 
00163     registryPathName.Length = 0;
00164     registryPathName.MaximumLength = <a class="code" href="../../d2/d3/io_2query_8c.html#a1">UNICODE_REGISTRY_PATH_LENGTH</a> *
00165                                      <span class="keyword">sizeof</span>(WCHAR);
00166 
00167     registryPathName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00168                                                      <a class="code" href="../../d2/d3/io_2query_8c.html#a1">UNICODE_REGISTRY_PATH_LENGTH</a>,
00169                                                      'mNoI' );
00170 
00171     <span class="keywordflow">if</span> (!registryPathName.Buffer) {
00172 
00173         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00174 
00175     }
00176 
00177     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;registryPathName,
00178                                     &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a> );
00179 
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Open a handle to the root path we have.</span>
00183     <span class="comment">//</span>
00184 
00185     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;rootHandle,
00186                                  (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00187                                  &amp;registryPathName,
00188                                  KEY_READ,
00189                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00190 
00191     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00192 
00193         status = <a class="code" href="../../d2/d3/io_2query_8c.html#a4">pIoQueryBusDescription</a>(&amp;queryDesc,
00194                                         registryPathName,
00195                                         rootHandle,
00196                                         &amp;busNumber,
00197                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00198 
00199         ZwClose( rootHandle );
00200 
00201     }
00202 
00203     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( registryPathName.Buffer );
00204 
00205     <span class="comment">//</span>
00206     <span class="comment">// For compatibility with old version of the function.</span>
00207     <span class="comment">//</span>
00208 
00209     <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
00210 
00211         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
00212 
00213 
00214     } <span class="keywordflow">else</span> {
00215 
00216         <span class="keywordflow">return</span> status;
00217 
00218     }
00219 }
00220 
00221 
00222 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00223"></a><a class="code" href="../../d2/d3/io_2query_8c.html#a4">00223</a> <a class="code" href="../../d2/d3/io_2query_8c.html#a4">pIoQueryBusDescription</a>(
00224     PIO_QUERY_DESC QueryDescription,
00225     UNICODE_STRING PathName,
00226     HANDLE RootHandle,
00227     PULONG BusNum,
00228     BOOLEAN HighKey
00229     )
00230 
00231 <span class="comment">/*++</span>
00232 <span class="comment"></span>
00233 <span class="comment">Routine Description:</span>
00234 <span class="comment"></span>
00235 <span class="comment"></span>
00236 <span class="comment">Arguments:</span>
00237 <span class="comment"></span>
00238 <span class="comment">    QueryDescription - Buffer containing all the query information requested</span>
00239 <span class="comment">        by the driver.</span>
00240 <span class="comment"></span>
00241 <span class="comment">    PathName - Registry path name of the key we are dealing with.  This is</span>
00242 <span class="comment">        a unicode strig so that we don't have to bother with resetting NULLs</span>
00243 <span class="comment">        at the end of the string - the length determines how much of the</span>
00244 <span class="comment">        string is valid.</span>
00245 <span class="comment"></span>
00246 <span class="comment">    RootHandle - Handle equivalent to the registry path.</span>
00247 <span class="comment"></span>
00248 <span class="comment">    BusNum - Pointer to a variable that keeps track of the bus number we are</span>
00249 <span class="comment">        searching for (buses have to be accumulated.</span>
00250 <span class="comment"></span>
00251 <span class="comment">    HighKey - Determines is this is a high key (a root key with a list of</span>
00252 <span class="comment">        bus types) or a low level key (under which the number of the various</span>
00253 <span class="comment">        buses will be little).</span>
00254 <span class="comment"></span>
00255 <span class="comment">Return Value:</span>
00256 <span class="comment"></span>
00257 <span class="comment">    The status returned is the final completion status of the operation.</span>
00258 <span class="comment"></span>
00259 <span class="comment">Notes:</span>
00260 <span class="comment"></span>
00261 <span class="comment">--*/</span>
00262 
00263 {
00264     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00265     ULONG i;
00266     UNICODE_STRING unicodeString;
00267 
00268     UNICODE_STRING registryPathName;
00269 
00270     ULONG keyBasicInformationSize;
00271     PKEY_BASIC_INFORMATION keyBasicInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00272     HANDLE handle;
00273 
00274     PKEY_FULL_INFORMATION keyInformation;
00275     ULONG size;
00276 
00277     PKEY_VALUE_FULL_INFORMATION busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a405">IoQueryDeviceMaxData</a>];
00278 
00279 
00280     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00281 
00282     status = <a class="code" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a>( RootHandle,
00283                                            &amp;keyInformation );
00284 
00285     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00286 
00287         <span class="comment">//</span>
00288         <span class="comment">// With the keyInformation, allocate a buffer that will be large</span>
00289         <span class="comment">// enough for all the subkeys</span>
00290         <span class="comment">//</span>
00291 
00292         keyBasicInformationSize = keyInformation-&gt;MaxNameLen +
00293                                   <span class="keyword">sizeof</span>(KEY_NODE_INFORMATION);
00294 
00295         keyBasicInformation = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00296                                                      keyBasicInformationSize,
00297                                                      'mNoI' );
00298 
00299         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyInformation);
00300 
00301         <span class="keywordflow">if</span> (keyBasicInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00302 
00303             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00304 
00305         }
00306     }
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Now we need to enumerate the keys and see if one of them is a bus</span>
00310     <span class="comment">//</span>
00311 
00312     <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ); i++) {
00313 
00314 
00315         <span class="comment">//</span>
00316         <span class="comment">// If we have found the Bus we are looking for, break</span>
00317         <span class="comment">//</span>
00318 
00319         <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a> )) &amp;&amp;
00320             (*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a>) == *BusNum)) {
00321 
00322             <span class="keywordflow">break</span>;
00323 
00324         }
00325 
00326         status = ZwEnumerateKey( RootHandle,
00327                                  i,
00328                                  KeyBasicInformation,
00329                                  keyBasicInformation,
00330                                  keyBasicInformationSize,
00331                                  &amp;size );
00332 
00333         <span class="comment">//</span>
00334         <span class="comment">// If the sub function enumerated all the buses till the end, then</span>
00335         <span class="comment">// treat that as success.</span>
00336         <span class="comment">//</span>
00337 
00338         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00339 
00340             <span class="keywordflow">break</span>;
00341 
00342         }
00343 
00344         <span class="comment">//</span>
00345         <span class="comment">// Only if this is a high key (otherwise we are in the callback</span>
00346         <span class="comment">// pass which we will process later on).</span>
00347         <span class="comment">//</span>
00348         <span class="comment">// If the string is any valid bus string, then we have to go down</span>
00349         <span class="comment">// the tree recursively.</span>
00350         <span class="comment">// Otherwise, go on to the next key.</span>
00351         <span class="comment">//</span>
00352 
00353         <span class="keywordflow">if</span> (HighKey) {
00354 
00355             <span class="keywordflow">if</span> (wcsncmp( keyBasicInformation-&gt;Name,
00356                          <a class="code" href="../../d6/d0/cmdat_8c.html#a71">CmTypeString</a>[<a class="code" href="../../d1/d9/arc_8h.html#a315a199">MultiFunctionAdapter</a>],
00357                          keyBasicInformation-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR) )  &amp;&amp;
00358                 wcsncmp( keyBasicInformation-&gt;Name,
00359                          <a class="code" href="../../d6/d0/cmdat_8c.html#a71">CmTypeString</a>[<a class="code" href="../../d1/d9/arc_8h.html#a315a195">EisaAdapter</a>],
00360                          keyBasicInformation-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR) )  &amp;&amp;
00361                 wcsncmp( keyBasicInformation-&gt;Name,
00362                          <a class="code" href="../../d6/d0/cmdat_8c.html#a71">CmTypeString</a>[<a class="code" href="../../d1/d9/arc_8h.html#a315a196">TcAdapter</a>],
00363                          keyBasicInformation-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR) )) {
00364 
00365                 <span class="comment">//</span>
00366                 <span class="comment">// All the comparisons returned 1 (which means they all were</span>
00367                 <span class="comment">// unsuccessful) so we do not have a bus.</span>
00368                 <span class="comment">//</span>
00369                 <span class="comment">// Go on to the next key.</span>
00370                 <span class="comment">//</span>
00371 
00372                 <span class="keywordflow">continue</span>;
00373             }
00374         }
00375 
00376         <span class="comment">//</span>
00377         <span class="comment">// We have a bus. Open that key and enumerate it's clidren</span>
00378         <span class="comment">// (which should be numbers)</span>
00379         <span class="comment">//</span>
00380 
00381         unicodeString.Buffer = keyBasicInformation-&gt;Name;
00382         unicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInformation-&gt;NameLength;
00383         unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInformation-&gt;NameLength;
00384 
00385         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;handle,
00386                                              RootHandle,
00387                                              &amp;unicodeString,
00388                                              KEY_READ,
00389                                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) )) {
00390 
00391             <span class="comment">//</span>
00392             <span class="comment">// The key could not be opened. Go to the next key</span>
00393             <span class="comment">//</span>
00394 
00395             <span class="keywordflow">continue</span>;
00396 
00397         }
00398 
00399         <span class="comment">//</span>
00400         <span class="comment">// We have the key. now build the name for this path.</span>
00401         <span class="comment">//</span>
00402         <span class="comment">// Reset the string to its original value</span>
00403         <span class="comment">//</span>
00404 
00405         registryPathName = PathName;
00406 
00407         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00408                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> );
00409 
00410         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;registryPathName,
00411                                         &amp;unicodeString );
00412 
00413 
00414         <span class="keywordflow">if</span> (!HighKey) {
00415 
00416             <span class="comment">//</span>
00417             <span class="comment">// We have a Key. Get the information for that key</span>
00418             <span class="comment">//</span>
00419 
00420             status = <a class="code" href="../../d0/d6/iop_8h.html#a181">IopGetRegistryValues</a>( handle,
00421                                            &amp;busValueInfo[0] );
00422 
00423             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00424 
00425                 <span class="comment">//</span>
00426                 <span class="comment">// Verify that the identifier value for this bus</span>
00427                 <span class="comment">// sub-key matches the user-specified bus type.</span>
00428                 <span class="comment">// If not, do not increment the number of *found*</span>
00429                 <span class="comment">// buses.</span>
00430                 <span class="comment">//</span>
00431 
00432                 <span class="keywordflow">if</span> (( busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) &amp;&amp;
00433                     ( busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>]-&gt;DataLength != 0 ) &amp;&amp;
00434                     ( ((PCM_FULL_RESOURCE_DESCRIPTOR)
00435                         ((PCCHAR) busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>] +
00436                         busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>]-&gt;DataOffset))
00437                         -&gt;InterfaceType == *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>) )) {
00438 
00439                     <span class="comment">//</span>
00440                     <span class="comment">// Increment the number of buses of desired type we</span>
00441                     <span class="comment">// have found.</span>
00442                     <span class="comment">//</span>
00443 
00444                     (*BusNum)++;
00445 
00446                     <span class="comment">//</span>
00447                     <span class="comment">// If we are looking for a specific bus number,</span>
00448                     <span class="comment">// check to see if we are at the right number.</span>
00449                     <span class="comment">// If we are not goto the next bus.  Otherwise</span>
00450                     <span class="comment">// (i.e we have the right bus number, or we</span>
00451                     <span class="comment">// specified all buses), then go on so the</span>
00452                     <span class="comment">// information can be reported.</span>
00453                     <span class="comment">//</span>
00454 
00455                     <span class="keywordflow">if</span> ( (QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00456                          (*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a>) == *BusNum) ) {
00457 
00458 
00459                         <span class="comment">//</span>
00460                         <span class="comment">// If we want controller information, call</span>
00461                         <span class="comment">// the controller function.</span>
00462                         <span class="comment">// Otherwise just return the bus information.</span>
00463                         <span class="comment">//</span>
00464 
00465                         <span class="keywordflow">if</span> (QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00466 
00467                             status = <a class="code" href="../../d2/d3/io_2query_8c.html#a5">pIoQueryDeviceDescription</a>(
00468                                          QueryDescription,
00469                                          registryPathName,
00470                                          handle,
00471                                          *BusNum,
00472                                          (PKEY_VALUE_FULL_INFORMATION *) busValueInfo );
00473 
00474                         } <span class="keywordflow">else</span> {
00475 
00476                             status = QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a>(
00477                                          QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a>,
00478                                          &amp;registryPathName,
00479                                          *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>),
00480                                          *BusNum,
00481                                          (PKEY_VALUE_FULL_INFORMATION *) busValueInfo,
00482                                          0,
00483                                          0,
00484                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00485                                          0,
00486                                          0,
00487                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00488 
00489                         }
00490                     }
00491                 }
00492 
00493                 <span class="comment">//</span>
00494                 <span class="comment">// Free the pool allocated for the controller value data.</span>
00495                 <span class="comment">//</span>
00496 
00497                 <span class="keywordflow">if</span> (busValueInfo[0]) {
00498                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( busValueInfo[0] );
00499                     busValueInfo[0] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00500                 }
00501                 <span class="keywordflow">if</span> (busValueInfo[1]) {
00502                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( busValueInfo[1] );
00503                     busValueInfo[1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00504                 }
00505                 <span class="keywordflow">if</span> (busValueInfo[2]) {
00506                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( busValueInfo[2] );
00507                     busValueInfo[2] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00508                 }
00509 
00510             }
00511 
00512 
00513             <span class="comment">//</span>
00514             <span class="comment">// Shortcurt exit to avoid the recursive call.</span>
00515             <span class="comment">//</span>
00516 
00517             <span class="keywordflow">if</span> ((QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a> !=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) &amp;&amp;
00518                 (*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a>) == *BusNum)) {
00519                 ZwClose( handle );
00520                 handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00521                 <span class="keywordflow">continue</span>;
00522 
00523             }
00524         }
00525 
00526         <span class="comment">//</span>
00527         <span class="comment">// If we have the key handle, do recursive enumeration.</span>
00528         <span class="comment">// enumaration (for both high and low keys)</span>
00529         <span class="comment">//</span>
00530 
00531         status = <a class="code" href="../../d2/d3/io_2query_8c.html#a4">pIoQueryBusDescription</a>(
00532                      QueryDescription,
00533                      registryPathName,
00534                      handle,
00535                      BusNum,
00536                      (BOOLEAN)!HighKey );
00537 
00538         <span class="comment">//</span>
00539         <span class="comment">// If the sub function enumerated all the buses till the end, then</span>
00540         <span class="comment">// treat that as success.</span>
00541         <span class="comment">//</span>
00542 
00543         <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
00544 
00545             status = STATUS_SUCCESS;
00546 
00547         }
00548 
00549         ZwClose( handle );
00550         handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551 
00552     }
00553 
00554     <span class="keywordflow">if</span> (keyBasicInformation) {
00555         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
00556     }
00557 
00558     <span class="keywordflow">return</span> status;
00559 }
00560 
00561 
00562 
00563 
00564 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00565"></a><a class="code" href="../../d2/d3/io_2query_8c.html#a5">00565</a> <a class="code" href="../../d2/d3/io_2query_8c.html#a5">pIoQueryDeviceDescription</a>(
00566     PIO_QUERY_DESC QueryDescription,
00567     UNICODE_STRING PathName,
00568     HANDLE RootHandle,
00569     ULONG BusNum,
00570     PKEY_VALUE_FULL_INFORMATION *BusValueInfo
00571     )
00572 
00573 {
00574 
00575     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00576     UNICODE_STRING registryPathName = PathName;
00577     UNICODE_STRING controllerBackupRegistryPathName;
00578     UNICODE_STRING peripheralBackupRegistryPathName;
00579     HANDLE controllerHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00580     HANDLE peripheralHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00581     PKEY_FULL_INFORMATION controllerTypeInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00582     PKEY_FULL_INFORMATION peripheralTypeInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00583     ULONG maxControllerNum;
00584     ULONG maxPeripheralNum;
00585     ULONG controllerNum;
00586     ULONG peripheralNum;
00587     WCHAR numBuffer[<a class="code" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a>];
00588     UNICODE_STRING bufferUnicodeString;
00589     PKEY_VALUE_FULL_INFORMATION controllerValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a405">IoQueryDeviceMaxData</a>];
00590     PKEY_VALUE_FULL_INFORMATION peripheralValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a405">IoQueryDeviceMaxData</a>];
00591 
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Set up a string for the number translation.</span>
00595     <span class="comment">//</span>
00596 
00597     bufferUnicodeString.MaximumLength = <a class="code" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a> * <span class="keyword">sizeof</span>(WCHAR);
00598     bufferUnicodeString.Buffer = &amp;numBuffer[0];
00599 
00600 
00601     <span class="comment">//         For each controller of the specified type (subkeys 0..M)</span>
00602     <span class="comment">//             if we are looking for controller information</span>
00603     <span class="comment">//                 call the specified callout routine</span>
00604     <span class="comment">//             else</span>
00605     <span class="comment">//                 For each peripheral of the specified type (subkeys 0..N)</span>
00606     <span class="comment">//                     call the specified callout routine</span>
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Add the controller name to the registry path name.</span>
00610     <span class="comment">//</span>
00611 
00612     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00613                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> );
00614 
00615     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00616 
00617         status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00618                                            <a class="code" href="../../d6/d0/cmdat_8c.html#a71">CmTypeString</a>[*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a>)] );
00619 
00620     }
00621 
00622     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00623         <span class="keywordflow">return</span> status;
00624     }
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">// If a Contoller number was specified by the caller, use that</span>
00628     <span class="comment">// controller number. Otherwise, find out how many buses are present</span>
00629     <span class="comment">// by querying the key.</span>
00630     <span class="comment">//</span>
00631 
00632     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o3">ControllerNumber</a> )) {
00633 
00634         controllerNum = *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o3">ControllerNumber</a>);
00635         maxControllerNum = controllerNum + 1;
00636 
00637     } <span class="keywordflow">else</span> {
00638 
00639         <span class="comment">//</span>
00640         <span class="comment">// Open the registry key for the controller and</span>
00641         <span class="comment">// Get the full key information for the controller key to</span>
00642         <span class="comment">// determine the number of sub-keys (controller numbers).</span>
00643         <span class="comment">// And we fail, then go on to the next bus.</span>
00644         <span class="comment">// Note the memory allocated by the query must be freed.</span>
00645         <span class="comment">//</span>
00646 
00647         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;controllerHandle,
00648                                      (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00649                                      &amp;registryPathName,
00650                                      KEY_READ,
00651                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00652 
00653         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00654 
00655             status = <a class="code" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a>( controllerHandle,
00656                                                    &amp;controllerTypeInfo );
00657 
00658             ZwClose( controllerHandle );
00659             controllerHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660         }
00661 
00662         <span class="comment">//</span>
00663         <span class="comment">// If no controller of this type was found on the bus, go on to</span>
00664         <span class="comment">// the next bus; goto the end of the loop with a successful status</span>
00665         <span class="comment">// so that the memory gets freed, but we continue looping.</span>
00666         <span class="comment">//</span>
00667 
00668         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00669 
00670             <span class="keywordflow">return</span> status;
00671 
00672         }
00673 
00674         <span class="comment">//</span>
00675         <span class="comment">// Get the number of controller sub-keys for this controller</span>
00676         <span class="comment">// type and free the pool.</span>
00677         <span class="comment">//</span>
00678 
00679         maxControllerNum = controllerTypeInfo-&gt;SubKeys;
00680         controllerNum = 0;
00681 
00682         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( controllerTypeInfo );
00683         controllerTypeInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00684     }
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// Make a backup of the string since we want to start where we were</span>
00688     <span class="comment">// on the next loop iteration.</span>
00689     <span class="comment">//</span>
00690 
00691     controllerBackupRegistryPathName = registryPathName;
00692 
00693     <span class="comment">//</span>
00694     <span class="comment">// For each controller of the specified type (subkeys 0..M).</span>
00695     <span class="comment">// We use BusNumber as the initial value since it is zero if we want</span>
00696     <span class="comment">// all buses, and we only want the bus specified if the value  is not</span>
00697     <span class="comment">// zero.</span>
00698     <span class="comment">//</span>
00699 
00700     <span class="keywordflow">for</span> ( ; controllerNum &lt; maxControllerNum; controllerNum++) {
00701 
00702         <span class="comment">//</span>
00703         <span class="comment">// Reset the string to its original value</span>
00704         <span class="comment">//</span>
00705 
00706         registryPathName = controllerBackupRegistryPathName;
00707 
00708         <span class="comment">//</span>
00709         <span class="comment">// Convert the controller number to a unicode string and append</span>
00710         <span class="comment">// it to the registry path name.</span>
00711         <span class="comment">//</span>
00712 
00713         bufferUnicodeString.Length = (<a class="code" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a>-1) * <span class="keyword">sizeof</span>(WCHAR);
00714         status = <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>( controllerNum,
00715                                             10,
00716                                             &amp;bufferUnicodeString );
00717 
00718         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00719 
00720             status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00721                                                <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> );
00722 
00723             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00724 
00725                 status = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(
00726                                                      &amp;registryPathName,
00727                                                      &amp;bufferUnicodeString );
00728 
00729             }
00730         }
00731 
00732         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00733             <span class="keywordflow">break</span>;
00734         }
00735 
00736         <span class="comment">//</span>
00737         <span class="comment">// Open the registry key for the controller number and</span>
00738         <span class="comment">// Get the value data for this controller and save it for later.</span>
00739         <span class="comment">//</span>
00740 
00741 
00742         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;controllerHandle,
00743                                      (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00744                                      &amp;registryPathName,
00745                                      KEY_READ,
00746                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00747 
00748         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00749 
00750             status = <a class="code" href="../../d0/d6/iop_8h.html#a181">IopGetRegistryValues</a>( controllerHandle,
00751                                            &amp;controllerValueInfo[0] );
00752 
00753             ZwClose( controllerHandle );
00754             controllerHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00755         }
00756 
00757         <span class="comment">//</span>
00758         <span class="comment">// If we could not open the key and get the info, just continue</span>
00759         <span class="comment">// since there is no memory to free and we are using the for</span>
00760         <span class="comment">// loop to determine when we get to the last controller.</span>
00761         <span class="comment">//</span>
00762 
00763         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00764             <span class="keywordflow">continue</span>;
00765         }
00766 
00767         <span class="comment">//</span>
00768         <span class="comment">// Check if we want the controller and bus information only. If</span>
00769         <span class="comment">// it is the case, invoque the callout routine and go on to the</span>
00770         <span class="comment">// next loop (unless an error occurs in the callout).</span>
00771         <span class="comment">//</span>
00772 
00773         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( (QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a>) )) {
00774 
00775             status = QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a>(
00776                          QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a>,
00777                          &amp;registryPathName,
00778                          *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>),
00779                          BusNum,
00780                          BusValueInfo,
00781                          *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a>),
00782                          controllerNum,
00783                          (PKEY_VALUE_FULL_INFORMATION *) controllerValueInfo,
00784                          0,
00785                          0,
00786                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00787 
00788             <span class="keywordflow">goto</span> IoQueryDeviceControllerLoop;
00789         }
00790 
00791         <span class="comment">//</span>
00792         <span class="comment">// Add the peripheral name to the registry path name.</span>
00793         <span class="comment">//</span>
00794 
00795         status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00796                                            <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> );
00797 
00798         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00799 
00800             status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(
00801                                              &amp;registryPathName,
00802                                              <a class="code" href="../../d6/d0/cmdat_8c.html#a71">CmTypeString</a>[*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a>)] );
00803 
00804         }
00805 
00806         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00807             <span class="keywordflow">goto</span> IoQueryDeviceControllerLoop;
00808         }
00809 
00810         <span class="comment">//</span>
00811         <span class="comment">// If a Peripheralnumber was specified by the caller, use that</span>
00812         <span class="comment">// peripheral number. Otherwise, find out how many buses are</span>
00813         <span class="comment">// present by querying the key.</span>
00814         <span class="comment">//</span>
00815 
00816         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o5">PeripheralNumber</a>) )) {
00817 
00818             peripheralNum = *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o5">PeripheralNumber</a>);
00819             maxPeripheralNum = peripheralNum + 1;
00820 
00821         } <span class="keywordflow">else</span> {
00822 
00823             <span class="comment">//</span>
00824             <span class="comment">// Open the registry key for the peripheral and</span>
00825             <span class="comment">// Get the full key information for the peripheral key to</span>
00826             <span class="comment">// determine the number of sub-keys (peripheral numbers).</span>
00827             <span class="comment">// And we fail, then go on to the next controller.</span>
00828             <span class="comment">// Note the memory allocated by the query must be freed.</span>
00829             <span class="comment">//</span>
00830 
00831             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;peripheralHandle,
00832                                          (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00833                                          &amp;registryPathName,
00834                      KEY_READ,
00835                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00836 
00837             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00838 
00839                 status = <a class="code" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a>( peripheralHandle,
00840                            &amp;peripheralTypeInfo );
00841 
00842                 ZwClose( peripheralHandle );
00843                 peripheralHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00844             }
00845 
00846             <span class="comment">//</span>
00847             <span class="comment">// If no controller of this type was found on the bus, go on to</span>
00848             <span class="comment">// the next bus; goto the end of the loop with a successful</span>
00849             <span class="comment">// status so that the memory gets freed, but we continue looping.</span>
00850             <span class="comment">//</span>
00851 
00852             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00853                 status = STATUS_SUCCESS;
00854                 <span class="keywordflow">goto</span> IoQueryDeviceControllerLoop;
00855             }
00856 
00857             <span class="comment">//</span>
00858             <span class="comment">// Get the number of peripheral sub-keys for this peripheral</span>
00859             <span class="comment">// type and free the pool.</span>
00860             <span class="comment">//</span>
00861 
00862             maxPeripheralNum = peripheralTypeInfo-&gt;SubKeys;
00863             peripheralNum = 0;
00864 
00865             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( peripheralTypeInfo );
00866             peripheralTypeInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00867         }
00868 
00869         <span class="comment">//</span>
00870         <span class="comment">// Make a backup of the string since we want to start where we</span>
00871         <span class="comment">// were on the next loop iteration.</span>
00872         <span class="comment">//</span>
00873 
00874         peripheralBackupRegistryPathName = registryPathName;
00875 
00876         <span class="comment">//</span>
00877         <span class="comment">// For each peripheral of the specified type (subkeys 0..N).</span>
00878         <span class="comment">// We use BusNumber as the initial value since it is zero if we</span>
00879         <span class="comment">// want all buses, and we only want the bus specified if the</span>
00880         <span class="comment">// value is not zero.</span>
00881         <span class="comment">//</span>
00882 
00883         <span class="keywordflow">for</span> ( ; peripheralNum &lt; maxPeripheralNum; peripheralNum++) {
00884 
00885             <span class="comment">//</span>
00886             <span class="comment">// Reset the string to its original value.</span>
00887             <span class="comment">//</span>
00888 
00889             registryPathName = peripheralBackupRegistryPathName;
00890 
00891             <span class="comment">//</span>
00892             <span class="comment">// Convert the peripheral number to a unicode string and append</span>
00893             <span class="comment">// it to the registry path name.</span>
00894             <span class="comment">//</span>
00895 
00896             bufferUnicodeString.Length =
00897                 (<a class="code" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a>-1) * <span class="keyword">sizeof</span>(WCHAR);
00898             status = <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>( peripheralNum,
00899                                                 10,
00900                                                 &amp;bufferUnicodeString );
00901 
00902             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00903 
00904                 status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00905                                                    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> );
00906 
00907                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00908 
00909                     status = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(
00910                                                      &amp;registryPathName,
00911                                                      &amp;bufferUnicodeString );
00912 
00913                 }
00914             }
00915 
00916             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00917                 <span class="keywordflow">break</span>;
00918             }
00919 
00920             <span class="comment">//</span>
00921             <span class="comment">// Open the registry key for the peripheral number and</span>
00922             <span class="comment">// Get the value data for this peripheral and save it for</span>
00923             <span class="comment">// later.</span>
00924             <span class="comment">//</span>
00925 
00926             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;peripheralHandle,
00927                                          (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00928                                          &amp;registryPathName,
00929                                          KEY_READ,
00930                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00931 
00932             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00933 
00934                 status = <a class="code" href="../../d0/d6/iop_8h.html#a181">IopGetRegistryValues</a>( peripheralHandle,
00935                                                &amp;peripheralValueInfo[0] );
00936 
00937                 ZwClose( peripheralHandle );
00938                 peripheralHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00939             }
00940 
00941             <span class="comment">//</span>
00942             <span class="comment">// If getting the peripheral information worked properly,</span>
00943             <span class="comment">// call the user-specified callout routine.</span>
00944             <span class="comment">//</span>
00945 
00946             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00947 
00948                 status = QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a>(
00949                              QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a>,
00950                              &amp;registryPathName,
00951                              *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>),
00952                              BusNum,
00953                              BusValueInfo,
00954                              *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a>),
00955                              controllerNum,
00956                              (PKEY_VALUE_FULL_INFORMATION *) controllerValueInfo,
00957                              *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a>),
00958                              peripheralNum,
00959                              (PKEY_VALUE_FULL_INFORMATION *) peripheralValueInfo );
00960 
00961                 <span class="comment">//</span>
00962                 <span class="comment">// Free the pool allocated for the peripheral value data.</span>
00963                 <span class="comment">//</span>
00964 
00965                 <span class="keywordflow">if</span> (peripheralValueInfo[0]) {
00966                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( peripheralValueInfo[0] );
00967                     peripheralValueInfo[0] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00968                 }
00969                 <span class="keywordflow">if</span> (peripheralValueInfo[1]) {
00970                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( peripheralValueInfo[1] );
00971                     peripheralValueInfo[1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00972                 }
00973                 <span class="keywordflow">if</span> (peripheralValueInfo[2]) {
00974                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( peripheralValueInfo[2] );
00975                     peripheralValueInfo[2] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00976                 }
00977 
00978                 <span class="comment">//</span>
00979                 <span class="comment">// If the user-specified callout routine returned with</span>
00980                 <span class="comment">// an unsuccessful status, quit.</span>
00981                 <span class="comment">//</span>
00982 
00983                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00984                     <span class="keywordflow">break</span>;
00985                }
00986             }
00987 
00988         } <span class="comment">// for ( ; peripheralNum &lt; maxPeripheralNum ...</span>
00989 
00990 IoQueryDeviceControllerLoop:
00991 
00992         <span class="comment">//</span>
00993         <span class="comment">// Free the pool allocated for the controller value data.</span>
00994         <span class="comment">//</span>
00995 
00996         <span class="keywordflow">if</span> (controllerValueInfo[0]) {
00997             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( controllerValueInfo[0] );
00998             controllerValueInfo[0] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00999         }
01000         <span class="keywordflow">if</span> (controllerValueInfo[1]) {
01001             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( controllerValueInfo[1] );
01002             controllerValueInfo[1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01003         }
01004         <span class="keywordflow">if</span> (controllerValueInfo[2]) {
01005             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( controllerValueInfo[2] );
01006             controllerValueInfo[2] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01007         }
01008 
01009         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01010             <span class="keywordflow">break</span>;
01011         }
01012 
01013     } <span class="comment">// for ( ; controllerNum &lt; maxControllerNum...</span>
01014 
01015 
01016     <span class="keywordflow">return</span>( status );
01017 }
01018 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
