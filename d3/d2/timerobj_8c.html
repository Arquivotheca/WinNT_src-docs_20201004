<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: timerobj.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>timerobj.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d4/d1/timerobj_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(E)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a> (IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a> (IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer, IN TIMER_TYPE Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a3">KeClearTimer</a> (IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a> (IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a5">KeReadStateTimer</a> (IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a> (IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer, IN LARGE_INTEGER DueTime, IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a> (IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer, IN LARGE_INTEGER DueTime, IN LONG Period OPTIONAL, IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a8">KeQueryTimerDueTime</a> (IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a> (IN PVOID BlockStart, IN ULONG BlockSize)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="timerobj.c::ASSERT_TIMER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_TIMER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                     \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((E)-&gt;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>.Type == TimerNotificationObject) ||   \
           ((E)-&gt;Header.Type == TimerSynchronizationObject)); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00037">37</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00157">KeCancelTimer()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00124">KeClearTimer()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00410">KeQueryTimerDueTime()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00211">KeReadStateTimer()</a>, and <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">KeSetTimerEx()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="timerobj.c::KeCancelTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeCancelTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Timer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00157">157</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00037">ASSERT_TIMER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00755">KiRemoveTreeTimer</a>, and <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l00232">ExpDeleteTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00346">ExTimerRundown()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>, and <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00097">Win32kNtUserCleanup()</a>.
<p>
<pre class="fragment"><div>00163                    :
00164 
00165     This function cancels a timer that was previously set to expire at
00166     a specified time. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently set, then no operation
00167     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed. Canceling a timer does not set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer to
00168     Signaled.
00169 
00170 Arguments:
00171 
00172     Timer - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> timer.
00173 
00174 Return Value:
00175 
00176     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer was
00177     currently set. Else a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00178 
00179 --*/
00180 
00181 {
00182 
00183     BOOLEAN Inserted;
00184     KIRQL OldIrql;
00185 
00186     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00187     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// Raise IRQL to dispatcher level, lock the dispatcher database, and</span>
00191     <span class="comment">// capture the timer inserted status. If the timer is currently set,</span>
00192     <span class="comment">// then remove it from the timer list.</span>
00193     <span class="comment">//</span>
00194 
00195     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00196     Inserted = Timer-&gt;Header.Inserted;
00197     <span class="keywordflow">if</span> (Inserted != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00198         <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00199     }
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">// Unlock the dispatcher database, lower IRQL to its previous value, and</span>
00203     <span class="comment">// return boolean value that signifies whether the timer was set of not.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00207     <span class="keywordflow">return</span> Inserted;
00208 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="timerobj.c::KeCheckForTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID KeCheckForTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BlockStart</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BlockSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00467">467</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00336">_KDPC::DeferredRoutine</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00525">_KTIMER::Dpc</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00059">KiTimerTableListHead</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00094">TIMER_TABLE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03892">ExFreePoolSanityChecks()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l03020">VerifierKeInitializeTimerEx()</a>.
<p>
<pre class="fragment"><div>00473                    :
00474 
00475     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> debugging by checking all timers
00476     to see <span class="keywordflow">if</span> any <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory block passed.  If so, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00477     system stops at a debug breakpoint.
00478 
00479 Arguments:
00480 
00481     MemoryBlock - Base address to check <span class="keywordflow">for</span> timer
00482 
00483     <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> - <a class="code" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a> (in bytes) to check in memory block
00484 
00485 Return Value:
00486 
00487     The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently active timer.
00488 
00489 --*/
00490 {
00491     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00492     PLIST_ENTRY ListHead;
00493     PLIST_ENTRY NextEntry;
00494     KIRQL OldIrql;
00495     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00496     PUCHAR Address;
00497     PUCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00498     PUCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">// Compute the ending memory location.</span>
00502     <span class="comment">//</span>
00503 
00504     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = (PUCHAR)BlockStart;
00505     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00509     <span class="comment">//</span>
00510 
00511     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">// Run the entire timer database and check for any timers in</span>
00515     <span class="comment">// the memory block</span>
00516     <span class="comment">//</span>
00517 
00518     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00519     <span class="keywordflow">do</span> {
00520         ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00521         NextEntry = ListHead-&gt;Flink;
00522         <span class="keywordflow">while</span> (NextEntry != ListHead) {
00523             Timer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00524             Address = (PUCHAR)Timer;
00525             NextEntry = NextEntry-&gt;Flink;
00526 
00527             <span class="comment">//</span>
00528             <span class="comment">// Check this timer object is not in the range.</span>
00529             <span class="comment">// In each of the following, we check that the object</span>
00530             <span class="comment">// does not overlap the range, for example, if the timer</span>
00531             <span class="comment">// object (in this first check), starts one dword before</span>
00532             <span class="comment">// the range being checked, we have an overlap and should</span>
00533             <span class="comment">// stop.</span>
00534             <span class="comment">//</span>
00535 
00536             <span class="keywordflow">if</span> ((Address &gt; (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>))) &amp;&amp;
00537                 (Address &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>)) {
00538                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(TIMER_OR_DPC_INVALID,
00539                              0x0,
00540                              (ULONG_PTR)Address,
00541                              (ULONG_PTR)Start,
00542                              (ULONG_PTR)End);
00543             }
00544 
00545             <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>) {
00546 
00547                 <span class="comment">//</span>
00548                 <span class="comment">// Check the timer's DPC object isn't in the range.</span>
00549                 <span class="comment">//</span>
00550 
00551                 Address = (PUCHAR)Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>;
00552                 <span class="keywordflow">if</span> ((Address &gt; (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/struct__KDPC.html">KDPC</a>))) &amp;&amp;
00553                     (Address &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>)) {
00554                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(TIMER_OR_DPC_INVALID,
00555                                  0x1,
00556                                  (ULONG_PTR)Address,
00557                                  (ULONG_PTR)Start,
00558                                  (ULONG_PTR)End);
00559                 }
00560 
00561                 <span class="comment">//</span>
00562                 <span class="comment">// Check the timer's DPC routine is not in the range.</span>
00563                 <span class="comment">//</span>
00564 
00565                 Address = (PUCHAR)Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o4">DeferredRoutine</a>;
00566                 <span class="keywordflow">if</span> (Address &gt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &amp;&amp; Address &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00567                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(TIMER_OR_DPC_INVALID,
00568                                  0x2,
00569                                  (ULONG_PTR)Address,
00570                                  (ULONG_PTR)Start,
00571                                  (ULONG_PTR)End);
00572                 }
00573             }
00574         }
00575 
00576         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00577     } <span class="keywordflow">while</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>);
00578 
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous value</span>
00582     <span class="comment">//</span>
00583 
00584     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00585     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00586 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="timerobj.c::KeClearTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeClearTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Timer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00124">124</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00037">ASSERT_TIMER</a>.
<p>
<pre class="fragment"><div>00130                    :
00131 
00132     This function clears <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> signal state of an timer object.
00133 
00134 Arguments:
00135 
00136     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> timer.
00137 
00138 Return Value:
00139 
00140     None.
00141 
00142 --*/
00143 
00144 {
00145 
00146     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Clear signal state of timer object.</span>
00150     <span class="comment">//</span>
00151 
00152     Timer-&gt;Header.SignalState = 0;
00153     <span class="keywordflow">return</span>;
00154 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="timerobj.c::KeInitializeTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeInitializeTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Timer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00043">43</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00075">KeInitializeTimerEx()</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00069">CcInitializeCacheManager()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00431">ExpWorkerThreadBalanceManager()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00760">IopErrorLogQueueRequest()</a>, <a class="el" href="../../d5/d5/kdinit_8c-source.html#l00036">KdInitSystem()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00043">KeInitializeThread()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03270">MiInitializeSpecialPoolCriteria()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01235">VdmpDelayInterrupt()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This function initializes a kernel timer object.
00052 
00053 Arguments:
00054 
00055     Timer - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> timer.
00056 
00057 Return Value:
00058 
00059     None.
00060 
00061 --*/
00062 
00063 {
00064 
00065     <span class="comment">//</span>
00066     <span class="comment">// Initialize extended timer object with a type of notification and a</span>
00067     <span class="comment">// period of zero.</span>
00068     <span class="comment">//</span>
00069 
00070     <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>(Timer, NotificationTimer);
00071     <span class="keywordflow">return</span>;
00072 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="timerobj.c::KeInitializeTimerEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeInitializeTimerEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TIMER_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00075">75</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a402a165">TimerNotificationObject</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00043">KeInitializeTimer()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">NtCreateTimer()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l03020">VerifierKeInitializeTimerEx()</a>.
<p>
<pre class="fragment"><div>00082                    :
00083 
00084     This function initializes an extended kernel timer object.
00085 
00086 Arguments:
00087 
00088     Timer - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> timer.
00089 
00090     Type - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of timer object; NotificationTimer or
00091         SynchronizationTimer;
00092 
00093 Return Value:
00094 
00095     None.
00096 
00097 --*/
00098 
00099 {
00100     <span class="comment">//</span>
00101     <span class="comment">// Initialize standard dispatcher object header and set initial</span>
00102     <span class="comment">// state of timer.</span>
00103     <span class="comment">//</span>
00104 
00105     Timer-&gt;Header.Type = <a class="code" href="../../d4/d9/ke_8h.html#a402a165">TimerNotificationObject</a> + Type;
00106     Timer-&gt;Header.Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00107     Timer-&gt;Header.Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>) / <span class="keyword">sizeof</span>(LONG);
00108     Timer-&gt;Header.SignalState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00109 
00110 <span class="preprocessor">#if DBG</span>
00111 <span class="preprocessor"></span>
00112     Timer-&gt;TimerListEntry.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00113     Timer-&gt;TimerListEntry.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00114 
00115 <span class="preprocessor">#endif</span>
00116 <span class="preprocessor"></span>
00117     InitializeListHead(&amp;Timer-&gt;Header.WaitListHead);
00118     Timer-&gt;DueTime.QuadPart = 0;
00119     Timer-&gt;Period = 0;
00120     <span class="keywordflow">return</span>;
00121 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="timerobj.c::KeQueryTimerDueTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONGLONG KeQueryTimerDueTime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Timer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00410">410</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00037">ASSERT_TIMER</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, and <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l01212">ExGetNextWakeTime()</a>.
<p>
<pre class="fragment"><div>00416                    :
00417 
00418     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InterruptTime at which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00419     pending.   0 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not pending.
00420 
00421     N.B. This function may <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system sleep code.
00422 
00423 Arguments:
00424 
00425     Timer - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> timer.
00426 
00427 Return Value:
00428 
00429     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of time remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer, or 0 <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00430     timer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not pending.
00431 
00432 --*/
00433 
00434 {
00435 
00436     KIRQL OldIrql;
00437     LARGE_INTEGER InterruptTime;
00438     ULONGLONG DueTime;
00439 
00440     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00444     <span class="comment">//</span>
00445 
00446     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// If the timer is currently pending, compute its due time</span>
00450     <span class="comment">//</span>
00451 
00452     DueTime = 0;
00453     <span class="keywordflow">if</span> (Timer-&gt;Header.Inserted) {
00454         DueTime = Timer-&gt;DueTime.QuadPart;
00455     }
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00459     <span class="comment">// value, and return the due time</span>
00460     <span class="comment">//</span>
00461 
00462     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00463     <span class="keywordflow">return</span> DueTime;
00464 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="timerobj.c::KeReadStateTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeReadStateTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Timer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00211">211</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00037">ASSERT_TIMER</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00822">NtQueryTimer()</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>.
<p>
<pre class="fragment"><div>00217                    :
00218 
00219     This function reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current signal state of a timer object.
00220 
00221 Arguments:
00222 
00223     Timer - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> timer.
00224 
00225 Return Value:
00226 
00227     The current signal state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object.
00228 
00229 --*/
00230 
00231 {
00232 
00233     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">// Return current signal state of timer object.</span>
00237     <span class="comment">//</span>
00238 
00239     <span class="keywordflow">return</span> (BOOLEAN)Timer-&gt;Header.SignalState;
00240 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="timerobj.c::KeSetTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeSetTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00243">243</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">KeSetTimerEx()</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l01790">CcCanIWrite()</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00049">CcScheduleLazyWriteScan()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00368">CmpLazyFlush()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00431">ExpWorkerThreadBalanceManager()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00225">InternalSetTimer()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00760">IopErrorLogQueueRequest()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00528">KdpTimeSlipWork()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00746">TimersProc()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01235">VdmpDelayInterrupt()</a>.
<p>
<pre class="fragment"><div>00251                    :
00252 
00253     This function sets a timer to expire at a specified time. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00254     already set, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implicitly canceled before <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to expire at
00255     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified time. Setting a timer causes its due time to be computed,
00256     its state to be set to Not-Signaled, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object itself to be
00257     inserted in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer list.
00258 
00259 Arguments:
00260 
00261     Timer - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> timer.
00262 
00263     DueTime - Supplies an absolute or relative time at which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer
00264         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to expire.
00265 
00266     Dpc - Supplies an optional pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> DPC.
00267 
00268 Return Value:
00269 
00270     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer was
00271     currently set. Else a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00272 
00273 --*/
00274 
00275 {
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">// Set the timer with a period of zero.</span>
00279     <span class="comment">//</span>
00280 
00281     <span class="keywordflow">return</span> <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>(Timer, DueTime, 0, Dpc);
00282 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="timerobj.c::KeSetTimerEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeSetTimerEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG Period&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">285</a> of file <a class="el" href="../../d4/d1/timerobj_8c-source.html">timerobj.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00037">ASSERT_TIMER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00525">_KTIMER::Dpc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00522">_KTIMER::Header</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00089">KeInsertQueueDpc()</a>, <a class="el" href="../../d6/d1/timersup_8c-source.html#l00042">KiInsertTreeTimer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00755">KiRemoveTreeTimer</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00526">_KTIMER::Period</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00038">TIMER_EXPIRE_INCREMENT</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00243">KeSetTimer()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03270">MiInitializeSpecialPoolCriteria()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>.
<p>
<pre class="fragment"><div>00294                    :
00295 
00296     This function sets a timer to expire at a specified time. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00297     already set, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implicitly canceled before <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to expire at
00298     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified time. Setting a timer causes its due time to be computed,
00299     its state to be set to Not-Signaled, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object itself to be
00300     inserted in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer list.
00301 
00302 Arguments:
00303 
00304     Timer - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> timer.
00305 
00306     DueTime - Supplies an absolute or relative time at which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer
00307         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to expire.
00308 
00309     Period - Supplies an optional period <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer in milliseconds.
00310 
00311     Dpc - Supplies an optional pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> DPC.
00312 
00313 Return Value:
00314 
00315     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer was
00316     currently set. Else a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00317 
00318 --*/
00319 
00320 {
00321 
00322     BOOLEAN Inserted;
00323     LARGE_INTEGER Interval;
00324     KIRQL OldIrql;
00325     LARGE_INTEGER SystemTime;
00326 
00327     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00328     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Capture the timer inserted status and if the timer is currently</span>
00338     <span class="comment">// set, then remove it from the timer list.</span>
00339     <span class="comment">//</span>
00340 
00341     Inserted = Timer-&gt;Header.Inserted;
00342     <span class="keywordflow">if</span> (Inserted != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00343         <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00344     }
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// Clear the signal state, set the period, set the DPC address, and</span>
00348     <span class="comment">// insert the timer in the timer tree. If the timer is not inserted</span>
00349     <span class="comment">// in the timer tree, then it has already expired and as many waiters</span>
00350     <span class="comment">// as possible should be continued, and a DPC, if specified should be</span>
00351     <span class="comment">// queued.</span>
00352     <span class="comment">//</span>
00353     <span class="comment">// N.B. The signal state must be cleared in case the period is not</span>
00354     <span class="comment">//      zero.</span>
00355     <span class="comment">//</span>
00356 
00357     Timer-&gt;Header.SignalState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00358     Timer-&gt;Dpc = Dpc;
00359     Timer-&gt;Period = Period;
00360     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>((<a class="code" href="../../d3/d8/struct__KTIMER.html">PRKTIMER</a>)Timer, DueTime) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00361         <span class="keywordflow">if</span> (IsListEmpty(&amp;Timer-&gt;Header.WaitListHead) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00362             <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(Timer, TIMER_EXPIRE_INCREMENT);
00363         }
00364 
00365         <span class="comment">//</span>
00366         <span class="comment">// If a DPC is specfied, then call the DPC routine.</span>
00367         <span class="comment">//</span>
00368 
00369         <span class="keywordflow">if</span> (Dpc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370             KiQuerySystemTime(&amp;SystemTime);
00371             <a class="code" href="../../d4/d1/dpcobj_8c.html#a2">KeInsertQueueDpc</a>(Timer-&gt;Dpc,
00372                              ULongToPtr(SystemTime.LowPart),
00373                              ULongToPtr(SystemTime.HighPart));
00374         }
00375 
00376         <span class="comment">//</span>
00377         <span class="comment">// If the timer is periodic, then compute the next interval time</span>
00378         <span class="comment">// and reinsert the timer in the timer tree.</span>
00379         <span class="comment">//</span>
00380         <span class="comment">// N.B. Even though the timer insertion is relative, it can still</span>
00381         <span class="comment">//      fail if the period of the timer elapses in between computing</span>
00382         <span class="comment">//      the time and inserting the timer in the table. If this happens,</span>
00383         <span class="comment">//      try again.</span>
00384         <span class="comment">//</span>
00385 
00386         <span class="keywordflow">if</span> (Period != 0) {
00387             Interval.QuadPart = Int32x32To64(Timer-&gt;Period, - 10 * 1000);
00388             <span class="keywordflow">while</span> (!<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>(Timer, Interval)) {
00389                 ; 
00390             }
00391         }
00392     }
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00396     <span class="comment">// value.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// Return boolean value that signifies whether the timer was set of</span>
00403     <span class="comment">// not.</span>
00404     <span class="comment">//</span>
00405 
00406     <span class="keywordflow">return</span> Inserted;
00407 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
