<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dumpctl.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dumpctl.c</h1><a href="../../d2/d3/dumpctl_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dumpctl.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code to dump memory to disk after a crash.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Darryl E. Havens (darrylh) 17-dec-1993</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00027 <span class="preprocessor">#include "ntddft.h"</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="../../d0/d1/inbv_8h.html">inbv.h</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;windef.h&gt;</span>
00030 
00031 <span class="comment">//</span>
00032 <span class="comment">// Processor specific macros.</span>
00033 <span class="comment">//</span>
00034 
00035 <span class="preprocessor">#if defined (i386)</span>
00036 <span class="preprocessor"></span>
00037 <span class="preprocessor">#define PROGRAM_COUNTER(_context)   ((_context)-&gt;Eip)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#define STACK_POINTER(_context)     ((_context)-&gt;Esp)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#define CURRENT_IMAGE_TYPE()        IMAGE_FILE_MACHINE_I386</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#define PaeEnabled() X86PaeEnabled()</span>
00041 <span class="preprocessor"></span>
00042 <span class="preprocessor">#elif defined (ALPHA)</span>
00043 <span class="preprocessor"></span>
00044 <span class="preprocessor">#define PROGRAM_COUNTER(_context)   ((_context)-&gt;Fir)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#define STACK_POINTER(_context)     ((_context)-&gt;IntSp)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define CURRENT_IMAGE_TYPE()        IMAGE_FILE_MACHINE_ALPHA</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#define PaeEnabled() (FALSE)</span>
00048 <span class="preprocessor"></span>
00049 <span class="preprocessor">#elif defined (_IA64_)</span>
00050 <span class="preprocessor"></span>
00051 <span class="preprocessor">#define PROGRAM_COUNTER(_context)   ((_context)-&gt;StIIP)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#define STACK_POINTER(_context)     ((_context)-&gt;IntSp)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#define CURRENT_IMAGE_TYPE()        IMAGE_FILE_MACHINE_IA64</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#define PaeEnabled() (FALSE)</span>
00055 <span class="preprocessor"></span>
00056 <span class="preprocessor">#else</span>
00057 <span class="preprocessor"></span>
00058 <span class="preprocessor">#error ("unknown processor type")</span>
00059 <span class="preprocessor"></span>
00060 <span class="preprocessor">#endif</span>
00061 <span class="preprocessor"></span>
00062 <span class="comment">//</span>
00063 <span class="comment">// min3(_a,_b,_c)</span>
00064 <span class="comment">//</span>
00065 <span class="comment">// Same as min() but takes 3 parameters.</span>
00066 <span class="comment">//</span>
00067 
<a name="l00068"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a0">00068</a> <span class="preprocessor">#define min3(_a,_b,_c) ( min ( min ((_a), (_b)), min ((_a), (_c))) )</span>
00069 <span class="preprocessor"></span>
00070 
00071 <span class="comment">//</span>
00072 <span class="comment">// Global variables</span>
00073 <span class="comment">//</span>
00074 
<a name="l00075"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a15">00075</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
<a name="l00076"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a16">00076</a> <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>;
00077 
<a name="l00078"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a17">00078</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a>         = -1;
<a name="l00079"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a18">00079</a> ULONG    <a class="code" href="../../d2/d3/dumpctl_8c.html#a18">IopCrashDumpStateChange</a>         =  0;
<a name="l00080"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a19">00080</a> BOOLEAN  <a class="code" href="../../d2/d3/dumpctl_8c.html#a19">IopDumpFileContainsNewDump</a>      = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00081 
00082 <span class="comment">//</span>
00083 <span class="comment">// Max dump transfer sizes</span>
00084 <span class="comment">//</span>
00085 
<a name="l00086"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a1">00086</a> <span class="preprocessor">#define IO_DUMP_MAXIMUM_TRANSFER_SIZE   ( 1024 * 64 )</span>
<a name="l00087"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a2">00087</a> <span class="preprocessor"></span><span class="preprocessor">#define IO_DUMP_MINIMUM_TRANSFER_SIZE   ( 1024 * 32 )</span>
<a name="l00088"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a3">00088</a> <span class="preprocessor"></span><span class="preprocessor">#define IO_DUMP_MINIMUM_FILE_SIZE       ( PAGE_SIZE * 256 )</span>
<a name="l00089"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a4">00089</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_UNICODE_LENGTH              ( 512 )</span>
00090 <span class="preprocessor"></span>
<a name="l00091"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a5">00091</a> <span class="preprocessor">#define DEFAULT_DRIVER_PATH             L"\\SystemRoot\\System32\\Drivers\\"</span>
<a name="l00092"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a6">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_DUMP_DRIVER             L"\\SystemRoot\\System32\\Drivers\\diskdump.sys"</span>
<a name="l00093"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a7">00093</a> <span class="preprocessor"></span><span class="preprocessor">#define SCSIPORT_DRIVER_NAME            L"scsiport.sys"</span>
<a name="l00094"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a8">00094</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_TRIAGE_STACK_SIZE           ( 16 * 1024 )</span>
<a name="l00095"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a9">00095</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_TRIAGE_DUMP_FLAGS (0xFFFFFFFF)</span>
00096 <span class="preprocessor"></span>
00097 
00098 <span class="comment">//</span>
00099 <span class="comment">// Function prototypes</span>
00100 <span class="comment">//</span>
00101 
00102 
00103 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00104 <a class="code" href="../../d2/d3/dumpctl_8c.html#a52">IopWriteTriageDump</a>(
00105     IN ULONG FieldsToWrite,
00106     IN <a class="code" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> WriteRoutine,
00107     IN OUT PLARGE_INTEGER Mcb,
00108     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00109     IN ULONG DiverTransferSize,
00110     IN PCONTEXT Context,
00111     IN LPBYTE Buffer,
00112     IN ULONG BufferSize,
00113     IN ULONG ServicePackBuild,
00114     IN ULONG TriageOptions
00115     );
00116 
00117 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00118 <a class="code" href="../../d2/d3/dumpctl_8c.html#a54">IopWriteSummaryDump</a>(
00119     IN PRTL_BITMAP PageMap,
00120     IN PDUMP_DRIVER_WRITE WriteRoutine,
00121     IN PANSI_STRING ProgressMessage,
00122     IN PUCHAR MessageBuffer,
00123     IN OUT PLARGE_INTEGER Mcb,
00124     IN ULONG DiverTransferSize
00125     );
00126 
00127 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00128 <a class="code" href="../../d2/d3/dumpctl_8c.html#a22">IopWriteToDisk</a>(
00129     IN PVOID Buffer,
00130     IN ULONG WriteLength,
00131     IN PDUMP_DRIVER_WRITE DriverWriteRoutine,
00132     IN OUT PLARGE_INTEGER * Mcb,
00133     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00134     IN ULONG DriverTransferSize
00135     );
00136     
00137 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00138 <a class="code" href="../../d2/d3/dumpctl_8c.html#a23">IopMapPhysicalMemory</a>(
00139     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
00140     IN ULONG_PTR MemoryAddress,
00141     IN <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> PhysicalMemoryRun,
00142     IN ULONG Length
00143     );
00144 
00145 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00146 <a class="code" href="../../d2/d3/dumpctl_8c.html#a24">IopLoadDumpDriver</a> (
00147     IN OUT <a class="code" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>  DumpStack,
00148     IN PWCHAR DriverNameString,
00149     IN PWCHAR NewBaseNameString
00150     );
00151 
00152 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00153 <a class="code" href="../../d2/d3/dumpctl_8c.html#a25">IoSetCrashDumpState</a>(
00154     IN SYSTEM_CRASH_STATE_INFORMATION *pDumpState
00155     );
00156 
00157 PSUMMARY_DUMP_HEADER
00158 <a class="code" href="../../d2/d3/dumpctl_8c.html#a26">IopInitializeSummaryDump</a>(
00159     IN <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> pDcb
00160     );
00161 
00162 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00163 <a class="code" href="../../d2/d3/dumpctl_8c.html#a27">IopWriteSummaryHeader</a>(
00164     IN PSUMMARY_DUMP_HEADER    pSummaryHeader,
00165     IN PDUMP_DRIVER_WRITE      pfWrite,
00166     IN OUT PLARGE_INTEGER *    pMcbBuffer,
00167     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>                pMdl,
00168     IN ULONG                   dwWriteSize,
00169     IN ULONG                   dwLength
00170     );
00171 
00172 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00173 <a class="code" href="../../d2/d3/dumpctl_8c.html#a28">IopMapVirtualToPhysicalMdl</a>(
00174     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> pMdl,
00175     IN ULONG_PTR dwMemoryAddress,
00176     IN ULONG    dwLength
00177     );
00178 
00179 ULONG
00180 <a class="code" href="../../d2/d3/dumpctl_8c.html#a29">IopCreateSummaryDump</a> (
00181     IN PSUMMARY_DUMP_HEADER pHeader
00182     );
00183 
00184 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00185 <a class="code" href="../../d2/d3/dumpctl_8c.html#a30">IopDeleteNonExistentMemory</a>(
00186     PSUMMARY_DUMP_HEADER        pHeader,
00187     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> MmPhysicalMemoryBlock
00188     );
00189 
00190 
00191 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00192 <a class="code" href="../../d2/d3/dumpctl_8c.html#a37">IopGetDumpStack</a> (
00193     IN PWCHAR                         ModulePrefix,
00194     OUT PDUMP_STACK_CONTEXT           *pDumpStack,
00195     IN PUNICODE_STRING                pUniDeviceName,
00196     IN PWSTR                          pDumpDriverName,
00197     IN <a class="code" href="../../d0/d5/io_8h.html#a362">DEVICE_USAGE_NOTIFICATION_TYPE</a> UsageType,
00198     IN ULONG                          IgnoreDeviceUsageFailure
00199     );
00200 
00201 BOOLEAN
00202 <a class="code" href="../../d2/d3/dumpctl_8c.html#a32">IopInitializeDCB</a>(
00203     );
00204 
00205 LARGE_INTEGER
00206 <a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
00207     IN ULONG            dwDmpFlags,
00208     IN ULONG            dwHeaderSize,
00209     IN PFN_NUMBER       dwMaxPages,
00210     IN PFN_NUMBER       dwMaxSummaryPages
00211     );
00212 
00213 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00214 <a class="code" href="../../d2/d3/dumpctl_8c.html#a34">IopCompleteDumpInitialization</a>(
00215     IN HANDLE     FileHandle
00216     );
00217 
00218 <span class="preprocessor">#if DBG</span>
00219 <span class="preprocessor"></span>
00220 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00221 IopDebugPrint(
00222     ULONG  DebugPrintLevel,
00223     PCCHAR DebugMessage,
00224     ...
00225     );
00226 
00227 <span class="preprocessor">#define IoDebugPrint(X) IopDebugPrint X</span>
00228 <span class="preprocessor"></span>
00229 <span class="preprocessor">#else</span>
00230 <span class="preprocessor"></span>
<a name="l00231"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a10">00231</a> <span class="preprocessor">#define IoDebugPrint(X)</span>
00232 <span class="preprocessor"></span>
00233 <span class="preprocessor">#endif //DBG</span>
00234 <span class="preprocessor"></span>
00235 
00236 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00237 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IoGetDumpStack)</span>
00238 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopLoadDumpDriver)</span>
00239 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IoFreeDumpStack)</span>
00240 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IoGetCrashDumpInformation)</span>
00241 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IoGetCrashDumpStateInformation)</span>
00242 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IoSetCrashDumpState)</span>
00243 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00244 <span class="preprocessor"></span>
00245 
00246 <span class="preprocessor">#if defined (i386)</span>
00247 <span class="preprocessor"></span>
00248 <span class="comment">//</span>
00249 <span class="comment">// Functions </span>
00250 <span class="comment">//</span>
00251 
00252 
00253 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00254 X86PaeEnabled(
00255     )
00256 
00257 <span class="comment">/*++</span>
00258 <span class="comment"></span>
00259 <span class="comment">Routine Description:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    Is PAE currently enabled?</span>
00262 <span class="comment">    </span>
00263 <span class="comment">Return Values:</span>
00264 <span class="comment"></span>
00265 <span class="comment">    Return TRUE if PAE is enabled in the CR4 register, FALSE otherwise.</span>
00266 <span class="comment"></span>
00267 <span class="comment">--*/</span>
00268     
00269 {
00270     ULONG Reg_Cr4;
00271     
00272     _asm {
00273         _emit 0Fh
00274         _emit 20h
00275         _emit 0E0h  ;; mov eax, cr4
00276         mov Reg_Cr4, eax
00277     }
00278 
00279     <span class="keywordflow">return</span> (Reg_Cr4 &amp; CR4_PAE ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00280 }
00281 
00282 <span class="preprocessor">#endif</span>
00283 <span class="preprocessor"></span>
00284         
00285 
00286 BOOLEAN
<a name="l00287"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a35">00287</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a>(
00288     IN PVOID VirtualAddress,
00289     IN SIZE_T Length
00290     )
00291 
00292 <span class="comment">/*++</span>
00293 <span class="comment"></span>
00294 <span class="comment">Routine Description:</span>
00295 <span class="comment"></span>
00296 <span class="comment">    Validate a range of addresses.</span>
00297 <span class="comment"></span>
00298 <span class="comment">Arguments:</span>
00299 <span class="comment"></span>
00300 <span class="comment">    Virtual Address - Beginning of of memory block to validate.</span>
00301 <span class="comment"></span>
00302 <span class="comment">    Length - Length of memory block to validate.</span>
00303 <span class="comment"></span>
00304 <span class="comment">Return Value:</span>
00305 <span class="comment"></span>
00306 <span class="comment">    TRUE - Address range is valid.</span>
00307 <span class="comment"></span>
00308 <span class="comment">    FALSE - Address range is not valid.</span>
00309 <span class="comment"></span>
00310 <span class="comment">--*/</span>
00311 
00312 {
00313     UINT_PTR Va;
00314     ULONG Pages;
00315 
00316     Va = (UINT_PTR) <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (VirtualAddress);
00317     Pages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (VirtualAddress, Length);
00318 
00319     <span class="keywordflow">while</span> (Pages) {
00320 
00321         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> ( (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) Va)) {
00322             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323         }
00324 
00325         Va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00326         Pages--;
00327     }
00328 
00329     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00330 }
00331     
00332 
00333 
00334 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00335"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a36">00335</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a36">IoGetDumpStack</a> (
00336     IN PWCHAR                          ModulePrefix,
00337     OUT PDUMP_STACK_CONTEXT          * pDumpStack,
00338     IN  DEVICE_USAGE_NOTIFICATION_TYPE UsageType,
00339     IN  ULONG                          IgnoreDeviceUsageFailure
00340     )
00341 <span class="comment">/*++</span>
00342 <span class="comment"></span>
00343 <span class="comment">Routine Description:</span>
00344 <span class="comment"></span>
00345 <span class="comment">    This routine loads a dump stack instance and returns an allocated</span>
00346 <span class="comment">    context structure to track the loaded dumps stack.</span>
00347 <span class="comment"></span>
00348 <span class="comment">Arguments:</span>
00349 <span class="comment"></span>
00350 <span class="comment">    ModePrefix      - The prefix to prepent to BaseName during the load</span>
00351 <span class="comment">                      operation.  This allows loading the same drivers</span>
00352 <span class="comment">                      multiple times with different virtual names and</span>
00353 <span class="comment">                      linkages.</span>
00354 <span class="comment"></span>
00355 <span class="comment">    pDumpStack      - The returned dump stack context structure</span>
00356 <span class="comment"></span>
00357 <span class="comment">    UsageType       - The Device Notification Usage Type for this file, that</span>
00358 <span class="comment">                      this routine will send as to the device object once the</span>
00359 <span class="comment">                      file has been successfully created and initialized.</span>
00360 <span class="comment"></span>
00361 <span class="comment">    IgnoreDeviceUsageFailure - If the Device Usage Notification Irp fails, allow</span>
00362 <span class="comment">                      this to succeed anyway.</span>
00363 <span class="comment"></span>
00364 <span class="comment">Return Value:</span>
00365 <span class="comment"></span>
00366 <span class="comment">    Status</span>
00367 <span class="comment"></span>
00368 <span class="comment">--*/</span>
00369 {
00370 
00371     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00372     <span class="keywordflow">return</span> <a class="code" href="../../d2/d3/dumpctl_8c.html#a37">IopGetDumpStack</a>(ModulePrefix,
00373                            pDumpStack,
00374                            &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a86">IoArcBootDeviceName</a>,
00375                            <a class="code" href="../../d2/d3/dumpctl_8c.html#a6">DEFAULT_DUMP_DRIVER</a>,
00376                            UsageType,
00377                            IgnoreDeviceUsageFailure
00378                            );
00379 }
00380 
00381 
00382 
00383 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00384"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a37">00384</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a37">IopGetDumpStack</a> (
00385     IN PWCHAR                         ModulePrefix,
00386     OUT PDUMP_STACK_CONTEXT         * pDumpStack,
00387     IN PUNICODE_STRING                pUniDeviceName,
00388     IN PWCHAR                         pDumpDriverName,
00389     IN DEVICE_USAGE_NOTIFICATION_TYPE UsageType,
00390     IN ULONG                          IgnoreDeviceUsageFailure
00391     )
00392 <span class="comment">/*++</span>
00393 <span class="comment"></span>
00394 <span class="comment">Routine Description:</span>
00395 <span class="comment"></span>
00396 <span class="comment">    This routine loads a dump stack instance and returns an allocated</span>
00397 <span class="comment">    context structure to track the loaded dumps stack.</span>
00398 <span class="comment"></span>
00399 <span class="comment">Arguments:</span>
00400 <span class="comment"></span>
00401 <span class="comment">    ModePrefix      - The prefix to prepent to BaseName during the load</span>
00402 <span class="comment">                      operation.  This allows loading the same drivers</span>
00403 <span class="comment">                      multiple times with different virtual names and</span>
00404 <span class="comment">                      linkages.</span>
00405 <span class="comment"></span>
00406 <span class="comment">    pDumpStack      - The returned dump stack context structure</span>
00407 <span class="comment"></span>
00408 <span class="comment">    pDeviceName     - The name of the target dump device</span>
00409 <span class="comment"></span>
00410 <span class="comment">    pDumpDriverName - The name of the target dump driver</span>
00411 <span class="comment"></span>
00412 <span class="comment">    UsageType       - The Device Notification Usage Type for this file, that</span>
00413 <span class="comment">                      this routine will send as to the device object once the</span>
00414 <span class="comment">                      file has been successfully created and initialized.</span>
00415 <span class="comment"></span>
00416 <span class="comment">    IgnoreDeviceUsageFailure - If the Device Usage Notification Irp fails, allow</span>
00417 <span class="comment">                      this to succeed anyway.</span>
00418 <span class="comment"></span>
00419 <span class="comment">Return Value:</span>
00420 <span class="comment"></span>
00421 <span class="comment">    Status</span>
00422 <span class="comment"></span>
00423 <span class="comment">--*/</span>
00424 {
00425     <a class="code" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>         DumpStack;
00426     PUCHAR                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00427     PUCHAR                      PartitionName;
00428     ANSI_STRING                 AnsiString;
00429     UNICODE_STRING              TempName;
00430     OBJECT_ATTRIBUTES           <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00431     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00432     HANDLE                      DeviceHandle;
00433     SCSI_ADDRESS                ScsiAddress;
00434     BOOLEAN                     ScsiDump;
00435     PARTITION_INFORMATION       PartitionInfo;
00436     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>                FileObject;
00437     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>              DeviceObject;
00438     <a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html">PINITIALIZATION_CONTEXT</a>     DumpInit;
00439     PDUMP_POINTERS              DumpPointers;
00440     UNICODE_STRING              DriverName;
00441     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>              DriverObject;
00442     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                        <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00443     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>          IrpSp;
00444     IO_STATUS_BLOCK             IoStatus;
00445     PWCHAR                      DumpName, NameOffset;
00446     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>                      <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00447     PVOID                       p1;
00448     PHYSICAL_ADDRESS            pa;
00449     ULONG                       i;
00450     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>           irpSp;
00451     ULONG                       information;
00452 
00453     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopGetDumpStack: Prefix:%ws stk: %x device:%ws driver:%ws\n"</span>,
00454                 ModulePrefix, pDumpStack, pUniDeviceName-&gt;Buffer,pDumpDriverName));
00455 
00456     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d0/d5/io_8h.html#a603a417">DeviceUsageTypeUndefined</a> != UsageType);
00457 
00458     DumpStack = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00459                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00460                     <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d8/structDUMP__STACK__CONTEXT.html">DUMP_STACK_CONTEXT</a>) + <span class="keyword">sizeof</span> (DUMP_POINTERS),
00461                     'pmuD'
00462                     );
00463 
00464     <span class="keywordflow">if</span> (!DumpStack) {
00465         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00466     }
00467 
00468     RtlZeroMemory(DumpStack, <span class="keyword">sizeof</span>(DUMP_STACK_CONTEXT)+<span class="keyword">sizeof</span>(DUMP_POINTERS));
00469     DumpInit = &amp;DumpStack-&gt;Init;
00470     DumpPointers = (PDUMP_POINTERS) (DumpStack + 1);
00471     DumpStack-&gt;DumpPointers = DumpPointers;
00472     InitializeListHead (&amp;DumpStack-&gt;DriverList);
00473     DumpName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00474 
00475     <span class="comment">//</span>
00476     <span class="comment">// Allocate scratch buffer</span>
00477     <span class="comment">//</span>
00478 
00479     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, 'pmuD');
00480     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00481         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpStack);
00482         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00483     }
00484 
00485     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(BUGCODE_PSS_CRASH_INIT, &amp;DumpStack-&gt;InitMsg) ||
00486         !<a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(BUGCODE_PSS_CRASH_PROGRESS, &amp;DumpStack-&gt;ProgMsg) ||
00487         !<a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(BUGCODE_PSS_CRASH_DONE, &amp;DumpStack-&gt;DoneMsg)) {
00488             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00489             <span class="keywordflow">goto</span> Done;
00490     }
00491 
00492     InitializeObjectAttributes(
00493         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00494         pUniDeviceName,
00495         0,
00496         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00497         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00498         );
00499 
00500     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00501               &amp;DeviceHandle,
00502               FILE_READ_DATA | SYNCHRONIZE,
00503               &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00504               &amp;IoStatus,
00505               FILE_SHARE_READ | FILE_SHARE_WRITE,
00506               FILE_NON_DIRECTORY_FILE
00507               );
00508 
00509     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00510         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
00511                        <span class="stringliteral">"IODUMP: Could not open boot device partition, %s\n"</span>,
00512                        <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
00513                        ));
00514         <span class="keywordflow">goto</span> Done;
00515     }
00516 
00517     <span class="comment">//</span>
00518     <span class="comment">// Check to see whether or not the system was booted from a SCSI device.</span>
00519     <span class="comment">//</span>
00520 
00521     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile (
00522                     DeviceHandle,
00523                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00524                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00525                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00526                     &amp;IoStatus,
00527                     IOCTL_SCSI_GET_ADDRESS,
00528                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00529                     0,
00530                     &amp;ScsiAddress,
00531                     <span class="keyword">sizeof</span>( SCSI_ADDRESS )
00532                     );
00533 
00534     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00535         ZwWaitForSingleObject (
00536             DeviceHandle,
00537             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00538             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00539             );
00540 
00541         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00542     }
00543 
00544     ScsiDump = (BOOLEAN) (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">// If SCSI then allocate storage to contain the target address information.</span>
00548     <span class="comment">//</span>
00549 
00550     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o15">TargetAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551 
00552     <span class="keywordflow">if</span> (ScsiDump) {
00553 
00554         DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o15">TargetAddress</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00555                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00556                                     <span class="keyword">sizeof</span> (SCSI_ADDRESS),
00557                                     'pmuD'
00558                                     );
00559         <span class="comment">//</span>
00560         <span class="comment">// It is ok If the allocation fails. The scsi dump driver will scan</span>
00561         <span class="comment">// all devices if the targetaddress information does not exist</span>
00562         <span class="comment">//</span>
00563 
00564         <span class="keywordflow">if</span> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o15">TargetAddress</a>) {
00565             RtlCopyMemory(DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o15">TargetAddress</a>,&amp;ScsiAddress,<span class="keyword">sizeof</span>(SCSI_ADDRESS));
00566         }
00567     }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// Determine the disk signature for the device from which the system was</span>
00571     <span class="comment">// booted and get the partition offset.</span>
00572     <span class="comment">//</span>
00573 
00574     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile(
00575                     DeviceHandle,
00576                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00577                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00578                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00579                     &amp;IoStatus,
00580                     IOCTL_DISK_GET_PARTITION_INFO,
00581                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00582                     0,
00583                     &amp;PartitionInfo,
00584                     <span class="keyword">sizeof</span>( PARTITION_INFORMATION )
00585                     );
00586 
00587     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00588         ZwWaitForSingleObject (
00589             DeviceHandle,
00590             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00591             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00592             );
00593 
00594         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00595     }
00596 
00597     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"Partition Type = %x\n"</span>,PartitionInfo.PartitionType));
00598     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"Boot Indicator = %x\n"</span>,PartitionInfo.BootIndicator));
00599 
00600     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile(
00601                     DeviceHandle,
00602                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00603                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00604                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00605                     &amp;IoStatus,
00606                     IOCTL_DISK_GET_DRIVE_LAYOUT,
00607                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00608                     0,
00609                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00610                     <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>
00611                     );
00612 
00613     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00614         ZwWaitForSingleObject (
00615             DeviceHandle,
00616             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00617             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00618             );
00619 
00620         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00621     }
00622 
00623     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o1">DiskSignature</a> = ((PDRIVE_LAYOUT_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Signature;
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Get the adapter object and base mapping registers for the disk from</span>
00627     <span class="comment">// the disk driver.  These will be used to call the HAL once the system</span>
00628     <span class="comment">// system has crashed, since it is not possible at that point to recreate</span>
00629     <span class="comment">// them from scratch.</span>
00630     <span class="comment">//</span>
00631 
00632     <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00633             DeviceHandle,
00634             0,
00635             <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
00636             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00637             (PVOID *) &amp;FileObject,
00638             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00639             );
00640 
00641 
00642     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> (FileObject);
00643 
00644     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00645 
00646     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>(
00647                 IOCTL_SCSI_GET_DUMP_POINTERS,
00648                 DeviceObject,
00649                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00650                 0,
00651                 DumpPointers,
00652                 <span class="keyword">sizeof</span> (DUMP_POINTERS),
00653                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00654                 &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00655                 &amp;IoStatus
00656                 );
00657 
00658     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>) {
00659         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (FileObject);
00660         ZwClose (DeviceHandle);
00661         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00662         <span class="keywordflow">goto</span> Done;
00663     }
00664 
00665     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>);
00666 
00667     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
00668 
00669     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00670 
00671     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00672         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00673         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00674     }
00675 
00676     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)  ||  IoStatus.Information &lt; FIELD_OFFSET(DUMP_POINTERS, DeviceObject)) {
00677 
00678         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
00679                        <span class="stringliteral">"IODUMP: Could not get dump pointers; error = %x, length %x\n"</span>,
00680                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
00681                         IoStatus.Information
00682                         ));
00683         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (FileObject);
00684 <span class="comment">//      NtClose (DeviceHandle);</span>
00685         ZwClose (DeviceHandle);
00686         <span class="keywordflow">goto</span> Done;
00687     }
00688     DumpStack-&gt;PointersLength = (ULONG) IoStatus.Information;
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">// If the driver returned a pointer to a device object, that is the</span>
00692     <span class="comment">// object for the dump driver  (non-scsi case)</span>
00693     <span class="comment">//</span>
00694 
00695     DeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) DumpPointers-&gt;DeviceObject;
00696     <span class="keywordflow">if</span> (DeviceObject) {
00697         DriverObject = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>;
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// Loop through the name of the driver looking for the end of the name,</span>
00701         <span class="comment">// which is the name of the dump image.</span>
00702         <span class="comment">//</span>
00703 
00704         DumpName = DriverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer;
00705         <span class="keywordflow">while</span> ( NameOffset = wcsstr( DumpName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> )) {
00706             DumpName = ++NameOffset;
00707         }
00708 
00709         ScsiDump = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00710     }
00711 
00712     <span class="comment">//</span>
00713     <span class="comment">// Release the handle, but keep the reference to the file object as it</span>
00714     <span class="comment">// will be needed at free dump dump driver time</span>
00715     <span class="comment">//</span>
00716 
00717     DumpStack-&gt;FileObject = FileObject;
00718     ZwClose (DeviceHandle);
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// Fill in some DumpInit results</span>
00722     <span class="comment">//</span>
00723 
00724     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o0">Length</a>             = <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html">INITIALIZATION_CONTEXT</a>);
00725     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o5">StallRoutine</a>       = &amp;<a class="code" href="../../d2/d7/hal_8h.html#a206">KeStallExecutionProcessor</a>;
00726     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>      = DumpPointers-&gt;AdapterObject;
00727     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o10">MappedRegisterBase</a> = DumpPointers-&gt;MappedRegisterBase;
00728     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o11">PortConfiguration</a>  = DumpPointers-&gt;DumpData;
00729 
00730     DumpStack-&gt;ModulePrefix      = ModulePrefix;
00731     DumpStack-&gt;PartitionOffset   = PartitionInfo.StartingOffset;
00732     DumpStack-&gt;UsageType         = <a class="code" href="../../d0/d5/io_8h.html#a603a417">DeviceUsageTypeUndefined</a>;
00733 
00734     <span class="comment">//</span>
00735     <span class="comment">// The minimum common buffer size is IO_DUMP_COMMON_BUFFER_SIZE (compatability)</span>
00736     <span class="comment">// This is used by the dump driver for SRB extension, CachedExtension, and sense buffer</span>
00737     <span class="comment">//</span>
00738     <span class="keywordflow">if</span> (DumpPointers-&gt;CommonBufferSize &lt; <a class="code" href="../../d0/d5/io_8h.html#a115">IO_DUMP_COMMON_BUFFER_SIZE</a>) {
00739         DumpPointers-&gt;CommonBufferSize = <a class="code" href="../../d0/d5/io_8h.html#a115">IO_DUMP_COMMON_BUFFER_SIZE</a>;
00740     }
00741     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o14">CommonBufferSize</a>    = DumpPointers-&gt;CommonBufferSize;
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Allocate the required common buffers</span>
00745     <span class="comment">//</span>
00746 
00747     <span class="keywordflow">if</span> (DumpPointers-&gt;AllocateCommonBuffers) {
00748         pa.QuadPart = 0x1000000 - 1;
00749         <span class="keywordflow">for</span> (i=0; i &lt; 2; i++) {
00750             <span class="keywordflow">if</span> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>) {
00751 
00752 <span class="preprocessor">#if !defined(NO_LEGACY_DRIVERS)</span>
00753 <span class="preprocessor"></span>                p1 = <a class="code" href="../../d2/d7/hal_8h.html#a227">HalAllocateCommonBuffer</a>(
00754                     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>,
00755                     DumpPointers-&gt;CommonBufferSize,
00756                     &amp;pa,
00757                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00758                     );
00759                 
00760 <span class="preprocessor">#else</span>
00761 <span class="preprocessor"></span>                p1 = (*((<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>)DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>)-&gt;DmaOperations-&gt;
00762                       AllocateCommonBuffer)(
00763                           (<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>)DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>,
00764                           DumpPointers-&gt;CommonBufferSize,
00765                           &amp;pa,
00766                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00767                           );
00768                 
00769 <span class="preprocessor">#endif // NO_LEGACY_DRIVERS</span>
00770 <span class="preprocessor"></span>                        
00771             } <span class="keywordflow">else</span> {
00772                 p1 = <a class="code" href="../../d5/d6/iosup_8c.html#a60">MmAllocateContiguousMemory</a> (
00773                         DumpPointers-&gt;CommonBufferSize,
00774                         pa
00775                         );
00776 
00777                 <span class="keywordflow">if</span> (!p1) {
00778                     p1 = <a class="code" href="../../d5/d6/iosup_8c.html#a70">MmAllocateNonCachedMemory</a> (DumpPointers-&gt;CommonBufferSize);
00779                 }
00780                 pa = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>(p1);
00781             }
00782 
00783             <span class="keywordflow">if</span> (!p1) {
00784                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0, <span class="stringliteral">"IODUMP: Could not allocate common buffers for dump\n"</span>));
00785                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00786                 <span class="keywordflow">goto</span> Done;
00787             }
00788 
00789             DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i] = p1;
00790             DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o4">PhysicalAddress</a>[i] = pa;
00791         }
00792     }
00793 
00794     <span class="comment">//</span>
00795     <span class="comment">// Determine whether or not the system booted from SCSI.</span>
00796     <span class="comment">//</span>
00797 
00798     <span class="keywordflow">if</span> (ScsiDump) {
00799 
00800         <span class="comment">//</span>
00801         <span class="comment">// Load the boot disk and port driver to be used by the various</span>
00802         <span class="comment">// miniports for writing memory to the disk.</span>
00803         <span class="comment">//</span>
00804 
00805         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a24">IopLoadDumpDriver</a> (
00806                         DumpStack,
00807                         pDumpDriverName,
00808                         <a class="code" href="../../d2/d3/dumpctl_8c.html#a7">SCSIPORT_DRIVER_NAME</a>
00809                         );
00810 
00811         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00812 
00813             <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,9,STATUS_SUCCESS,IO_DUMP_DRIVER_LOAD_FAILURE,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00814             <span class="keywordflow">goto</span> Done;
00815         }
00816 
00817         <span class="comment">//</span>
00818         <span class="comment">// The disk and port dump driver has been loaded.  Load the appropriate</span>
00819         <span class="comment">// miniport driver as well so that the boot device can be accessed.</span>
00820         <span class="comment">//</span>
00821 
00822         DriverName.Length = 0;
00823         DriverName.Buffer = (PVOID) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00824         DriverName.MaximumLength = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00825 
00826 
00827         <span class="comment">//</span>
00828         <span class="comment">// The system was booted from SCSI. Get the name of the appropriate</span>
00829         <span class="comment">// miniport driver and load it.</span>
00830         <span class="comment">//</span>
00831 
00832         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="stringliteral">"\\Device\\ScsiPort%d"</span>, ScsiAddress.PortNumber );
00833         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00834         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;TempName, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00835         InitializeObjectAttributes(
00836                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00837                     &amp;TempName,
00838                     0,
00839                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00840                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00841                     );
00842 
00843         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00844                     &amp;DeviceHandle,
00845                     FILE_READ_ATTRIBUTES,
00846                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00847                     &amp;IoStatus,
00848                     FILE_SHARE_READ | FILE_SHARE_WRITE,
00849                     FILE_NON_DIRECTORY_FILE
00850                     );
00851 
00852         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;TempName );
00853         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00854             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
00855                            <span class="stringliteral">"IODUMP: Could not open SCSI port %d, error = %x\n"</span>,
00856                            ScsiAddress.PortNumber,
00857                            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00858                            ));
00859             <span class="keywordflow">goto</span> Done;
00860         }
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">// Convert the file handle into a pointer to the device object, and</span>
00864         <span class="comment">// get the name of the driver from its driver object.</span>
00865         <span class="comment">//</span>
00866 
00867         <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00868                     DeviceHandle,
00869                     0,
00870                     <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
00871                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00872                     (PVOID *) &amp;FileObject,
00873                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00874                     );
00875 
00876         DriverObject = FileObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>;
00877         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
00878         ZwClose( DeviceHandle );
00879         <span class="comment">//</span>
00880         <span class="comment">// Loop through the name of the driver looking for the end of the name,</span>
00881         <span class="comment">// which is the name of the miniport image.</span>
00882         <span class="comment">//</span>
00883 
00884         DumpName = DriverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer;
00885         <span class="keywordflow">while</span> ( NameOffset = wcsstr( DumpName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> )) {
00886             DumpName = ++NameOffset;
00887         }
00888     }
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Load the dump driver</span>
00892     <span class="comment">//</span>
00893 
00894     <span class="keywordflow">if</span> (!DumpName) {
00895         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00896         <span class="keywordflow">goto</span> Done;
00897     }
00898 
00899     swprintf ((PWCHAR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\%s.sys"</span>, DumpName);
00900     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a24">IopLoadDumpDriver</a> (
00901                     DumpStack,
00902                     (PWCHAR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00903                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00904                     );
00905     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00906 
00907         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,10,STATUS_SUCCESS,IO_DUMP_DRIVER_LOAD_FAILURE,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00908         <span class="keywordflow">goto</span> Done;
00909     }
00910 
00911     <span class="comment">//</span>
00912     <span class="comment">// Claim the file as part of specific device usage path.</span>
00913     <span class="comment">//</span>
00914 
00915     FileObject = DumpStack-&gt;FileObject;
00916     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> (FileObject);
00917 
00918     RtlZeroMemory (&amp;irpSp, <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
00919 
00920     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00921     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>;
00922     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.Type = UsageType;
00923     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.InPath = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00924     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
00925 
00926     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a> (DeviceObject, &amp;irpSp, (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> **) &amp;information);
00927     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 == information);
00928 
00929     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; IgnoreDeviceUsageFailure) {
00930         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
00931                        <span class="stringliteral">"IopGetDumpStack: DEVICE_USAGE_NOTIFICATION "</span>
00932                        <span class="stringliteral">"Error ignored (%x)\n"</span>,
00933                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00934         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00935     }
00936 
00937     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00938         DumpStack-&gt;UsageType         = UsageType;
00939     }
00940 
00941 Done:
00942     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00943         *pDumpStack = DumpStack;
00944     } <span class="keywordflow">else</span> {
00945         <a class="code" href="../../d2/d3/dumpctl_8c.html#a41">IoFreeDumpStack</a> (DumpStack);
00946     }
00947     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00948     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00949 }
00950 
00951 
00952 
00953 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00954"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a24">00954</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a24">IopLoadDumpDriver</a> (
00955     IN OUT PDUMP_STACK_CONTEXT  DumpStack,
00956     IN PWCHAR DriverNameString,
00957     IN PWCHAR NewBaseNameString OPTIONAL
00958     )
00959 <span class="comment">/*++</span>
00960 <span class="comment"></span>
00961 <span class="comment">Routine Description:</span>
00962 <span class="comment"></span>
00963 <span class="comment">    Worker function for IoGetDumpStack to load a particular driver into</span>
00964 <span class="comment">    the current DumpStack being created</span>
00965 <span class="comment"></span>
00966 <span class="comment">Arguments:</span>
00967 <span class="comment"></span>
00968 <span class="comment">    DumpStack           - Dump driver stack being built</span>
00969 <span class="comment"></span>
00970 <span class="comment">    DriverNameString    - The string name of the driver to load</span>
00971 <span class="comment"></span>
00972 <span class="comment">    NewBaseNameString   - The modified basename of the driver once loaded</span>
00973 <span class="comment"></span>
00974 <span class="comment">Return Value:</span>
00975 <span class="comment"></span>
00976 <span class="comment">    Status</span>
00977 <span class="comment"></span>
00978 <span class="comment">--*/</span>
00979 {
00980     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00981     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>       DumpImage;
00982     PLDR_DATA_TABLE_ENTRY   ImageLdrInfo;
00983     UNICODE_STRING          DriverName;
00984     UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>;
00985     UNICODE_STRING          Prefix;
00986     PUNICODE_STRING         LoadBaseName;
00987 
00988     <span class="comment">//</span>
00989     <span class="comment">// Allocate space to track this dump driver</span>
00990     <span class="comment">//</span>
00991 
00992     DumpImage = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00993                         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00994                         <span class="keyword">sizeof</span> (<a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>),
00995                         'pmuD'
00996                         );
00997 
00998     <span class="keywordflow">if</span> (!DumpImage) {
00999         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01000     }
01001 
01002     <span class="comment">//</span>
01003     <span class="comment">// Load the system image</span>
01004     <span class="comment">//</span>
01005 
01006     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;DriverName, DriverNameString);
01007     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;Prefix, DumpStack-&gt;ModulePrefix);
01008     LoadBaseName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01009     <span class="keywordflow">if</span> (NewBaseNameString) {
01010         LoadBaseName = &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>;
01011         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, NewBaseNameString);
01012         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.MaximumLength = Prefix.Length + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
01013         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
01014                             <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01015                             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.MaximumLength,
01016                             'pmuD'
01017                             );
01018 
01019 
01020         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer) {
01021             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpImage);
01022             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01023         }
01024 
01025         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length = 0;
01026         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a> (&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, &amp;Prefix);
01027         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, NewBaseNameString);
01028     }
01029 
01030     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a54">MmLoadAndLockSystemImage</a>(
01031                 &amp;DriverName,
01032                 &amp;Prefix,
01033                 LoadBaseName,
01034                 &amp;DumpImage-&gt;Image,
01035                 &amp;DumpImage-&gt;ImageBase
01036                 );
01037 
01038     <span class="keywordflow">if</span> (NewBaseNameString) {
01039         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer);
01040     }
01041 
01042     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01043         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
01044                        <span class="stringliteral">"IODUMP: Could not load %wZ; error = %x\n"</span>,
01045                        &amp;DriverName,
01046                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01047         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpImage);
01048         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01049     }
01050 
01051     <span class="comment">//</span>
01052     <span class="comment">// Put this driver on the list of drivers to be processed at crash time</span>
01053     <span class="comment">//</span>
01054 
01055     DumpImage-&gt;SizeOfImage = DumpImage-&gt;Image-&gt;SizeOfImage;
01056     InsertTailList (&amp;DumpStack-&gt;DriverList, &amp;DumpImage-&gt;Link);
01057     <span class="keywordflow">return</span> STATUS_SUCCESS;
01058 }
01059 
01060 
01061 ULONG
<a name="l01062"></a><a class="code" href="../../d0/d6/iop_8h.html#a176">01062</a> <a class="code" href="../../d0/d6/iop_8h.html#a176">IopGetDumpControlBlockCheck</a> (
01063     IN <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>  Dcb
01064     )
01065 <span class="comment">/*++</span>
01066 <span class="comment"></span>
01067 <span class="comment">Routine Description:</span>
01068 <span class="comment"></span>
01069 <span class="comment">    Return the current checksum total for the Dcb</span>
01070 <span class="comment"></span>
01071 <span class="comment">Arguments:</span>
01072 <span class="comment"></span>
01073 <span class="comment">    DumpStack           - Dump driver stack to checksum</span>
01074 <span class="comment"></span>
01075 <span class="comment">Return Value:</span>
01076 <span class="comment"></span>
01077 <span class="comment">    Checksum value</span>
01078 <span class="comment"></span>
01079 <span class="comment">--*/</span>
01080 {
01081     ULONG                   Check;
01082     PLIST_ENTRY             Link;
01083     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>       DumpImage;
01084     PMAPPED_ADDRESS         MappedAddress;
01085     <a class="code" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>     DumpStack;
01086 
01087 
01088     <span class="comment">//</span>
01089     <span class="comment">// Check the DCB, memory descriptor array, and the FileDescriptorArray</span>
01090     <span class="comment">//</span>
01091 
01092     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(0, Dcb, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">DUMP_CONTROL_BLOCK</a>));
01093     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(
01094                 Check,
01095                 Dcb-&gt;MemoryDescriptor,
01096                 Dcb-&gt;MemoryDescriptorLength
01097                 );
01098 
01099     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, Dcb-&gt;FileDescriptorArray, Dcb-&gt;FileDescriptorSize);
01100 
01101     DumpStack = Dcb-&gt;DumpStack;
01102     <span class="keywordflow">if</span> (DumpStack) {
01103 
01104         <span class="comment">//</span>
01105         <span class="comment">// Include the dump stack context structure, and dump driver images</span>
01106         <span class="comment">//</span>
01107 
01108         Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpStack, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/structDUMP__STACK__CONTEXT.html">DUMP_STACK_CONTEXT</a>));
01109         Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpStack-&gt;DumpPointers, DumpStack-&gt;PointersLength);
01110 
01111         <span class="keywordflow">for</span> (Link = DumpStack-&gt;DriverList.Flink;
01112              Link != &amp;DumpStack-&gt;DriverList;
01113              Link = Link-&gt;Flink) {
01114 
01115             DumpImage = CONTAINING_RECORD(Link, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01116             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpImage, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>));
01117             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpImage-&gt;ImageBase, DumpImage-&gt;SizeOfImage);
01118         }
01119 
01120         <span class="comment">//</span>
01121         <span class="comment">// Include the mapped addresses</span>
01122         <span class="comment">//</span>
01123         <span class="comment">// If this is non-null it is treated as a PMAPPED_ADDRESS * (see scsiport and atdisk)</span>
01124         <span class="comment">//</span>
01125         <span class="keywordflow">if</span> (DumpStack-&gt;Init.MappedRegisterBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01126             MappedAddress = *(PMAPPED_ADDRESS *)DumpStack-&gt;Init.MappedRegisterBase;
01127         } <span class="keywordflow">else</span> {
01128             MappedAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01129         }
01130 
01131         <span class="keywordflow">while</span> (MappedAddress) {
01132             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a> (Check, MappedAddress, <span class="keyword">sizeof</span>(MAPPED_ADDRESS));
01133             MappedAddress = MappedAddress-&gt;NextMappedAddress;
01134         }
01135     }
01136 
01137     <span class="keywordflow">return</span> Check;
01138 }
01139 
01140 
01141 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01142"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a39">01142</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a39">IoInitializeDumpStack</a> (
01143     IN PDUMP_STACK_CONTEXT  DumpStack,
01144     IN PUCHAR               MessageBuffer OPTIONAL
01145     )
01146 <span class="comment">/*++</span>
01147 <span class="comment"></span>
01148 <span class="comment">Routine Description:</span>
01149 <span class="comment"></span>
01150 <span class="comment">    Initialize the dump driver stack referenced by DumpStack to perform IO.</span>
01151 <span class="comment"></span>
01152 <span class="comment">Arguments:</span>
01153 <span class="comment"></span>
01154 <span class="comment">    DumpStack   - Dump driver stack being initialized</span>
01155 <span class="comment"></span>
01156 <span class="comment">Return Value:</span>
01157 <span class="comment"></span>
01158 <span class="comment">    Status</span>
01159 <span class="comment"></span>
01160 <span class="comment">--*/</span>
01161 {
01162 
01163     <a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html">PINITIALIZATION_CONTEXT</a>     DumpInit;
01164     PLIST_ENTRY                 Link;
01165     ULONG                       Check;
01166     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01167     <a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>          DriverInit;
01168     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>           DumpImage;
01169 
01170 
01171     DumpInit = &amp;DumpStack-&gt;Init;
01172 
01173     <span class="comment">//</span>
01174     <span class="comment">// Verify checksum on DumpStack structure</span>
01175     <span class="comment">//</span>
01176 
01177     <span class="comment">// BUGBUG: later</span>
01178 
01179     <span class="comment">//</span>
01180     <span class="comment">// Initializes the dump drivers</span>
01181     <span class="comment">//</span>
01182 
01183     <span class="keywordflow">for</span> (Link = DumpStack-&gt;DriverList.Flink;
01184          Link != &amp;DumpStack-&gt;DriverList;
01185          Link = Link-&gt;Flink) {
01186 
01187         DumpImage = CONTAINING_RECORD(Link, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01188 
01189         <span class="comment">//</span>
01190         <span class="comment">// Call this driver's driver init.  Only the first driver gets the</span>
01191         <span class="comment">// dump initialization context</span>
01192         <span class="comment">//</span>
01193 
01194         DriverInit = DumpImage-&gt;Image-&gt;EntryPoint;
01195         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = DriverInit (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PUNICODE_STRING) DumpInit);
01196         DumpInit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01197 
01198         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01199             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
01200                            <span class="stringliteral">"IODUMP: Unable to initialize driver; error = %x\n"</span>,
01201                            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01202                            ));
01203             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01204         }
01205     }
01206 
01207     DumpInit = &amp;DumpStack-&gt;Init;
01208 
01209     <span class="comment">//</span>
01210     <span class="comment">// Display string we are starting</span>
01211     <span class="comment">//</span>
01212 
01213     <span class="keywordflow">if</span> (MessageBuffer) {
01214         <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a> (MessageBuffer);
01215     }
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">// Open the partition from which the system was booted.</span>
01219     <span class="comment">// This returns TRUE if the disk w/the appropriate signature was found,</span>
01220     <span class="comment">// otherwise a NULL, in which case there is no way to continue.</span>
01221     <span class="comment">//</span>
01222 
01223     <span class="keywordflow">if</span> (!DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o6">OpenRoutine</a> (DumpStack-&gt;PartitionOffset)) {
01224         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> (( 0, <span class="stringliteral">"IODUMP: Could not find/open partition offset\n"</span> ));
01225         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01226     }
01227 
01228     <span class="keywordflow">return</span> STATUS_SUCCESS;
01229 }
01230 
01231 
01232 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01233"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a40">01233</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a40">IoGetDumpHiberRanges</a> (
01234     IN PVOID                    HiberContext,
01235     IN PDUMP_STACK_CONTEXT      DumpStack
01236     )
01237 <span class="comment">/*++</span>
01238 <span class="comment"></span>
01239 <span class="comment">Routine Description:</span>
01240 <span class="comment"></span>
01241 <span class="comment">    Adds the dump driver stack storage to the hibernate range list,</span>
01242 <span class="comment">    to inform the hibernate procedure which pages need cloned,</span>
01243 <span class="comment">    discarded or not checksumed as they are in use by the dump</span>
01244 <span class="comment">    stack.</span>
01245 <span class="comment"></span>
01246 <span class="comment">Arguments:</span>
01247 <span class="comment"></span>
01248 <span class="comment">    HiberContext        - Pointer to the hiber context structure</span>
01249 <span class="comment"></span>
01250 <span class="comment">    DumpStack           - Dump driver stack being initialized</span>
01251 <span class="comment"></span>
01252 <span class="comment">Return Value:</span>
01253 <span class="comment"></span>
01254 <span class="comment">    None</span>
01255 <span class="comment"></span>
01256 <span class="comment">--*/</span>
01257 {
01258     PDUMP_POINTERS              DumpPointers;
01259     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>           DumpImage;
01260     PLIST_ENTRY                 Link;
01261 
01262     DumpPointers = DumpStack-&gt;DumpPointers;
01263 
01264     <span class="comment">//</span>
01265     <span class="comment">// Report the common buffer</span>
01266     <span class="comment">//</span>
01267 
01268     <span class="keywordflow">if</span> (DumpPointers-&gt;CommonBufferVa) {
01269         <a class="code" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange</a> (
01270             HiberContext,
01271             <a class="code" href="../../d1/d2/po_8h.html#a10">PO_MEM_CL_OR_NCHK</a>,
01272             DumpPointers-&gt;CommonBufferVa,
01273             DumpPointers-&gt;CommonBufferSize,
01274             'fubc'
01275             );
01276     }
01277 
01278     <span class="comment">//</span>
01279     <span class="comment">// Dump the entire image of the dump drivers</span>
01280     <span class="comment">//</span>
01281 
01282     <span class="keywordflow">for</span> (Link = DumpStack-&gt;DriverList.Flink;
01283          Link != &amp;DumpStack-&gt;DriverList;
01284          Link = Link-&gt;Flink) {
01285 
01286         DumpImage = CONTAINING_RECORD(Link, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01287 
01288         <a class="code" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange</a> (
01289             HiberContext,
01290             <a class="code" href="../../d1/d2/po_8h.html#a10">PO_MEM_CL_OR_NCHK</a>,
01291             DumpImage-&gt;ImageBase,
01292             DumpImage-&gt;SizeOfImage,
01293             'gmID'
01294             );
01295     }
01296 }
01297 
01298 
01299 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01300"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a41">01300</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a41">IoFreeDumpStack</a> (
01301     IN PDUMP_STACK_CONTEXT     DumpStack
01302     )
01303 <span class="comment">/*++</span>
01304 <span class="comment"></span>
01305 <span class="comment">Routine Description:</span>
01306 <span class="comment"></span>
01307 <span class="comment">    Free the dump driver stack referenced by DumpStack</span>
01308 <span class="comment"></span>
01309 <span class="comment">Arguments:</span>
01310 <span class="comment"></span>
01311 <span class="comment">    DumpStack           - Dump driver stack being initialized</span>
01312 <span class="comment"></span>
01313 <span class="comment">Return Value:</span>
01314 <span class="comment"></span>
01315 <span class="comment">    None</span>
01316 <span class="comment"></span>
01317 <span class="comment">--*/</span>
01318 {
01319     <a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html">PINITIALIZATION_CONTEXT</a>     DumpInit;
01320     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>           DumpImage;
01321     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>              DeviceObject;
01322     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>          IrpSp;
01323     IO_STATUS_BLOCK             IoStatus;
01324     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                        <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01325     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>                      <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01326     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01327     ULONG                       i;
01328     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>                FileObject;
01329     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>           irpSp;
01330     ULONG                       information;
01331 
01332     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01333     DumpInit = &amp;DumpStack-&gt;Init;
01334 
01335     <span class="comment">//</span>
01336     <span class="comment">// Release the claim to this file as a specific device usage path.</span>
01337     <span class="comment">//</span>
01338 
01339     FileObject = DumpStack-&gt;FileObject;
01340     <span class="keywordflow">if</span> (FileObject) {
01341         DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> (FileObject);
01342 
01343         RtlZeroMemory (&amp;irpSp, <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01344 
01345         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01346         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>;
01347         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.Type = DumpStack-&gt;UsageType;
01348         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.InPath = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01349         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
01350 
01351         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a603a417">DeviceUsageTypeUndefined</a> != DumpStack-&gt;UsageType) {
01352             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a> (DeviceObject, &amp;irpSp, (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> **) &amp;information);
01353             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 == information);
01354         } <span class="keywordflow">else</span> {
01355             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01356         }
01357     }
01358 
01359     <span class="comment">//</span>
01360     <span class="comment">// Free any common buffers which where allocated</span>
01361     <span class="comment">//</span>
01362 
01363     <span class="keywordflow">for</span> (i=0; i &lt; 2; i++) {
01364         <span class="keywordflow">if</span> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i]) {
01365             <span class="keywordflow">if</span> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>) {
01366 
01367 <span class="preprocessor">#if !defined(NO_LEGACY_DRIVERS)</span>
01368 <span class="preprocessor"></span>                <a class="code" href="../../d2/d7/hal_8h.html#a228">HalFreeCommonBuffer</a> (
01369                     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>,
01370                     ((PDUMP_POINTERS)DumpStack-&gt;DumpPointers)-&gt;CommonBufferSize,
01371                     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o4">PhysicalAddress</a>[i],
01372                     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i],
01373                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01374                     );
01375 <span class="preprocessor">#else</span>
01376 <span class="preprocessor"></span>                (*((<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>)DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>)-&gt;DmaOperations-&gt;
01377                  FreeCommonBuffer )(
01378                      (<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>)DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>,
01379                      ((PDUMP_POINTERS)DumpStack-&gt;DumpPointers)-&gt;CommonBufferSize,
01380                      DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o4">PhysicalAddress</a>[i],
01381                      DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i],
01382                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01383                      );
01384 
01385 <span class="preprocessor">#endif // NO_LEGACY_DRIVERS</span>
01386 <span class="preprocessor"></span>
01387                 
01388             } <span class="keywordflow">else</span> {
01389                 <a class="code" href="../../d5/d6/iosup_8c.html#a66">MmFreeContiguousMemory</a> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i]);
01390             }
01391         }
01392         DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01393     }
01394 
01395     <span class="comment">//</span>
01396     <span class="comment">// Unload the dump drivers</span>
01397     <span class="comment">//</span>
01398 
01399     <span class="keywordflow">while</span> (!IsListEmpty(&amp;DumpStack-&gt;DriverList)) {
01400         DumpImage = CONTAINING_RECORD(DumpStack-&gt;DriverList.Blink, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01401         RemoveEntryList (&amp;DumpImage-&gt;Link);
01402         <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> (DumpImage-&gt;Image);
01403         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpImage);
01404     }
01405 
01406     <span class="comment">//</span>
01407     <span class="comment">// Inform the driver stack that the dump registartion is over</span>
01408     <span class="comment">//</span>
01409 
01410     <span class="keywordflow">if</span> (DumpStack-&gt;FileObject) {
01411         DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> ((<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) DumpStack-&gt;FileObject);
01412 
01413         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01414         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>(
01415                     IOCTL_SCSI_FREE_DUMP_POINTERS,
01416                     DeviceObject,
01417                     DumpStack-&gt;DumpPointers,
01418                     sizeof (DUMP_POINTERS),
01419                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01420                     0,
01421                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01422                     &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
01423                     &amp;IoStatus
01424                     );
01425 
01426         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>);
01427         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = DumpStack-&gt;FileObject;
01428 
01429         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
01430 
01431         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
01432             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01433             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
01434         }
01435         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DumpStack-&gt;FileObject );
01436     }
01437     <span class="comment">//</span>
01438     <span class="comment">// Free the target address if it exists</span>
01439     <span class="comment">//</span>
01440     <span class="keywordflow">if</span> (DumpStack-&gt;Init.TargetAddress) {
01441         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DumpStack-&gt;Init.TargetAddress);
01442     }
01443     <span class="comment">//</span>
01444     <span class="comment">// Free the dump stack context</span>
01445     <span class="comment">//</span>
01446 
01447     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpStack);
01448 }
01449 
01450 
01451 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01452"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a42">01452</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a42">IopInitializeDumpSpaceAndType</a>(
01453     IN <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> dcb,
01454     IN OUT PULONG block,
01455     IN PSUMMARY_DUMP_HEADER pSummaryHeader
01456     )
01457 {
01458     LARGE_INTEGER <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>;
01459     
01460     <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.QuadPart = 0;
01461 
01462     <span class="keywordflow">if</span> (dcb-&gt;Flags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
01463 
01464         <span class="comment">//</span>
01465         <span class="comment">// Fixed size dump for triage-dumps.</span>
01466         <span class="comment">//</span>
01467         
01468         block [ DH_DUMP_TYPE ] = DUMP_TYPE_TRIAGE;
01469         <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.QuadPart = TRIAGE_DUMP_SIZE;
01470 
01471 
01472     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dcb-&gt;Flags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>) {
01473 
01474         block [ DH_DUMP_TYPE ] = DUMP_TYPE_SUMMARY;
01475 
01476         <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
01477                                 dcb-&gt;Flags,
01478                                 dcb-&gt;HeaderSize,
01479                                 dcb-&gt;MemoryDescriptor-&gt;NumberOfPages,
01480                                 pSummaryHeader-&gt;Pages
01481                                 );
01482     } <span class="keywordflow">else</span> {
01483 
01484         <span class="keywordflow">if</span> (dcb-&gt;Flags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a8">DCB_DUMP_HEADER_ENABLED</a>) {
01485             block [ DH_DUMP_TYPE ] = DUMP_TYPE_HEADER;
01486         }
01487 
01488         <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
01489                                 dcb-&gt;Flags,
01490                                 dcb-&gt;HeaderSize,
01491                                 dcb-&gt;MemoryDescriptor-&gt;NumberOfPages,
01492                                 dcb-&gt;MemoryDescriptor-&gt;NumberOfPages
01493                                 );
01494     }
01495 
01496     <span class="comment">//</span>
01497     <span class="comment">// If the calculated size is larger than the pagefile, truncate it to</span>
01498     <span class="comment">// the pagefile size.</span>
01499     <span class="comment">//</span>
01500 
01501     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.QuadPart &gt; dcb-&gt;DumpFileSize.QuadPart) {
01502         <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.QuadPart = dcb-&gt;DumpFileSize.QuadPart;
01503     }
01504     
01505     block [ DH_REQUIRED_DUMP_SPACE ] = <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.LowPart;
01506     block [ DH_REQUIRED_DUMP_SPACE + 1 ] = <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.HighPart;
01507 
01508     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IODUMP: dcb File Size %x Block Size %x\n"</span>,
01509                     block [DH_REQUIRED_DUMP_SPACE],
01510                     (ULONG)dcb-&gt;DumpFileSize.LowPart
01511                     ));
01512 
01513     <span class="keywordflow">return</span> STATUS_SUCCESS;
01514 }
01515 
01516 
01517 
01518 BOOLEAN
<a name="l01519"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a43">01519</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a43">IoWriteCrashDump</a>(
01520     IN ULONG BugCheckCode,
01521     IN ULONG_PTR BugCheckParameter1,
01522     IN ULONG_PTR BugCheckParameter2,
01523     IN ULONG_PTR BugCheckParameter3,
01524     IN ULONG_PTR BugCheckParameter4,
01525     IN PVOID ContextSave
01526     )
01527 
01528 <span class="comment">/*++</span>
01529 <span class="comment"></span>
01530 <span class="comment">Routine Description:</span>
01531 <span class="comment"></span>
01532 <span class="comment">    This routine checks to see whether or not crash dumps are enabled and, if</span>
01533 <span class="comment">    so, writes all of physical memory to the system disk's paging file.</span>
01534 <span class="comment"></span>
01535 <span class="comment">Arguments:</span>
01536 <span class="comment"></span>
01537 <span class="comment">    BugCheckCode/ParameterN - Code and parameters w/which BugCheck was called.</span>
01538 <span class="comment"></span>
01539 <span class="comment">Return Value:</span>
01540 <span class="comment"></span>
01541 <span class="comment">    None.</span>
01542 <span class="comment"></span>
01543 <span class="comment">--*/</span>
01544 
01545 {
01546     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> dcb;
01547     <a class="code" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> dumpStack;
01548     <a class="code" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> write;
01549     <a class="code" href="../../d0/d5/io_8h.html#a269">PDUMP_DRIVER_FINISH</a> finishUp;
01550     PDUMP_HEADER header;
01551     EXCEPTION_RECORD exception;
01552     PCONTEXT context = ContextSave;
01553     PULONG block;
01554     LARGE_INTEGER diskByteOffset;
01555     PPFN_NUMBER page;
01556     PFN_NUMBER localMdl[(<span class="keyword">sizeof</span>( <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> )/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 17];
01557     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
01558     PLARGE_INTEGER mcb;
01559     ULONG_PTR memoryAddress;
01560     ULONG byteOffset;
01561     ULONG byteCount;
01562     ULONG bytesRemaining;
01563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01564     UCHAR messageBuffer[128];
01565     PFN_NUMBER ActualPages;
01566     PSUMMARY_DUMP_HEADER pSummaryHeader;
01567     ULONG dwTransferSize;
01568     LARGE_INTEGER requiredDumpSpace;
01569     ULONG_PTR DirBasePage;
01570 
01571     <span class="comment">//</span>
01572     <span class="comment">// Begin by determining whether or not crash dumps are enabled.  If not,</span>
01573     <span class="comment">// check to see whether or not auto-rebooting is enabled.  If not, return</span>
01574     <span class="comment">// immediately since there is nothing to do.</span>
01575     <span class="comment">//</span>
01576 
01577     dcb = <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>;
01578     <span class="keywordflow">if</span> (!dcb) {
01579         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01580     }
01581 
01582     <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a> || dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>) {
01583 
01584         <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_PENDING;
01585 
01586         <span class="comment">//</span>
01587         <span class="comment">// A dump is to be written to the paging file.  Ensure that all of the</span>
01588         <span class="comment">// descriptor data for what needs to be done is valid, otherwise it</span>
01589         <span class="comment">// could be that part of the reason for the bugcheck is that this data</span>
01590         <span class="comment">// was corrupted.  Or, it could be that no paging file was found yet,</span>
01591         <span class="comment">// or any number of other situations.</span>
01592         <span class="comment">//</span>
01593 
01594         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a176">IopGetDumpControlBlockCheck</a>(dcb) != <a class="code" href="../../d3/d5/iodata_8c.html#a48">IopDumpControlBlockChecksum</a>) {
01595             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> (( 0,
01596                            <span class="stringliteral">"CRASHDUMP: Disk dump routine returning due to DCB integrity error\n"</span>
01597                            <span class="stringliteral">"           No dump will be created\n"</span> ));
01598             <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01599             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01600         }
01601 
01602         <span class="comment">//</span>
01603         <span class="comment">// Message  that we are starting the crashdump</span>
01604         <span class="comment">//</span>
01605 
01606         dumpStack = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>;
01607         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( messageBuffer, <span class="stringliteral">"%Z\n"</span>, &amp;dumpStack-&gt;InitMsg );
01608 
01609         <span class="comment">//</span>
01610         <span class="comment">// Initialize the dump stack</span>
01611         <span class="comment">//</span>
01612 
01613         status = <a class="code" href="../../d2/d3/dumpctl_8c.html#a39">IoInitializeDumpStack</a> (dumpStack, messageBuffer);
01614         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01615             <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01616             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01617         }
01618 
01619         <span class="comment">//</span>
01620         <span class="comment">// Record the dump driver's entry points.</span>
01621         <span class="comment">//</span>
01622 
01623         write = dumpStack-&gt;Init.WriteRoutine;
01624         finishUp = dumpStack-&gt;Init.FinishRoutine;
01625 
01626 
01627         dwTransferSize = dumpStack-&gt;Init.MaximumTransferSize;
01628 
01629         <span class="keywordflow">if</span> ( ( !dwTransferSize ) || ( dwTransferSize &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a1">IO_DUMP_MAXIMUM_TRANSFER_SIZE</a> ) ) {
01630             dwTransferSize = <a class="code" href="../../d2/d3/dumpctl_8c.html#a2">IO_DUMP_MINIMUM_TRANSFER_SIZE</a>;
01631         }
01632 
01633         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"CRASHDUMP: Maximum Transfer Size = %x\n"</span>,dwTransferSize));
01634 
01635 
01636         <span class="comment">//</span>
01637         <span class="comment">// The boot partition was found, so put together a dump file header</span>
01638         <span class="comment">// and write it to the disk.</span>
01639         <span class="comment">//</span>
01640 
01641         block = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>;
01642         header = (PDUMP_HEADER) block;
01643 
01644         RtlFillMemoryUlong( header, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, 'EGAP' );
01645         header-&gt;ValidDump = 'PMUD';
01646         header-&gt;BugCheckCode = BugCheckCode;
01647         header-&gt;BugCheckParameter1 = BugCheckParameter1;
01648         header-&gt;BugCheckParameter2 = BugCheckParameter2;
01649         header-&gt;BugCheckParameter3 = BugCheckParameter3;
01650         header-&gt;BugCheckParameter4 = BugCheckParameter4;
01651 <span class="preprocessor">#if defined (i386)</span>
01652 <span class="preprocessor"></span>        <span class="comment">//</span>
01653         <span class="comment">// Add the current page directory table page - don't use the directory</span>
01654         <span class="comment">// table base for the crashing process as we have switched cr3 on</span>
01655         <span class="comment">// stack overflow crashes, etc.</span>
01656         <span class="comment">//</span>
01657     
01658         _asm {
01659             mov     eax, cr3
01660             mov     DirBasePage, eax
01661         }
01662         header-&gt;DirectoryTableBase = DirBasePage;
01663 <span class="preprocessor">#else</span>
01664 <span class="preprocessor"></span>        header-&gt;DirectoryTableBase = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
01665 <span class="preprocessor">#endif</span>
01666 <span class="preprocessor"></span>        header-&gt;PfnDataBase = <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
01667         header-&gt;PsLoadedModuleList = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
01668         header-&gt;PsActiveProcessHead = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>;
01669         header-&gt;NumberProcessors = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o3">NumberProcessors</a>;
01670         header-&gt;MajorVersion = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o13">MajorVersion</a>;
01671         header-&gt;MinorVersion = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o14">MinorVersion</a>;
01672         header-&gt;KdDebuggerDataBlock = <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a3">KdGetDataBlock</a>();
01673         header-&gt;PaeEnabled = PaeEnabled ();
01674 
01675         header-&gt;MachineImageType = CURRENT_IMAGE_TYPE ();
01676 
01677         <span class="keywordflow">if</span> (!(dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>)) {
01678             dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> = 1;
01679         }
01680 
01681         strcpy( header-&gt;VersionUser, dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o16">VersionUser</a> );
01682 
01683         RtlCopyMemory( &amp;block[DH_PHYSICAL_MEMORY_BLOCK],
01684                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>,
01685                        <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a> ) +
01686                        ((dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> - 1) *
01687                        <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a> )) );
01688 
01689         RtlCopyMemory( &amp;block[DH_CONTEXT_RECORD],
01690                        context,
01691                        <span class="keyword">sizeof</span>( CONTEXT ) );
01692 
01693         exception.ExceptionCode = STATUS_BREAKPOINT;
01694         exception.ExceptionRecord = (PEXCEPTION_RECORD) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01695         exception.NumberParameters = 0;
01696         exception.ExceptionFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a25">EXCEPTION_NONCONTINUABLE</a>;
01697         exception.ExceptionAddress = (PVOID) PROGRAM_COUNTER (context);
01698 
01699         RtlCopyMemory( &amp;block[DH_EXCEPTION_RECORD],
01700                        &amp;exception,
01701                        <span class="keyword">sizeof</span>( EXCEPTION_RECORD ) );
01702 
01703         <span class="comment">//</span>
01704         <span class="comment">// Init dump type to FULL</span>
01705         <span class="comment">//</span>
01706         
01707         block[DH_DUMP_TYPE] = DUMP_TYPE_FULL;
01708 
01709         <span class="comment">//</span>
01710         <span class="comment">// Set the timestamp</span>
01711         <span class="comment">//</span>
01712 <span class="preprocessor">#ifdef _WIN64</span>
01713 <span class="preprocessor"></span>        RtlCopyMemory( &amp;block[DH_CRASH_DUMP_TIMESTAMP],
01714                        (PCHAR)( &amp;SharedUserData-&gt;SystemLowTime),
01715                        <span class="keyword">sizeof</span>( LARGE_INTEGER) );
01716 <span class="preprocessor">#else</span>
01717 <span class="preprocessor"></span>        RtlCopyMemory( &amp;block[DH_CRASH_DUMP_TIMESTAMP],
01718                        (PCHAR)( &amp;SharedUserData-&gt;SystemTime),
01719                        <span class="keyword">sizeof</span>( LARGE_INTEGER) );
01720 <span class="preprocessor">#endif</span>
01721 <span class="preprocessor"></span>
01722         <span class="comment">//</span>
01723         <span class="comment">// Set the Required dump size in the dump header. In the case of</span>
01724         <span class="comment">// a summary dump the file allocation size can be significantly larger</span>
01725         <span class="comment">// then the amount of used space.</span>
01726         <span class="comment">//</span>
01727         
01728         RtlZeroMemory( &amp;block[DH_REQUIRED_DUMP_SPACE], <span class="keyword">sizeof</span>(LARGE_INTEGER));
01729 
01730         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>) {
01731         
01732             <span class="comment">//</span>
01733             <span class="comment">// If summary dump try to create the dump header</span>
01734             <span class="comment">//</span>
01735             
01736             <span class="keywordflow">if</span> ( (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>) ) {
01737 
01738                 <span class="comment">//</span>
01739                 <span class="comment">// Initialize the summary dump</span>
01740                 <span class="comment">//</span>
01741 
01742                 pSummaryHeader = <a class="code" href="../../d2/d3/dumpctl_8c.html#a26">IopInitializeSummaryDump</a>(dcb);
01743 
01744                 <span class="keywordflow">if</span> ( !pSummaryHeader ) {
01745 
01746                     <span class="comment">//</span>
01747                     <span class="comment">// No summary dump header so return.</span>
01748                     <span class="comment">//</span>
01749 
01750                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"IoWriteCrashDump: Error Null summary dump header\n"</span>));
01751 
01752                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01753 
01754                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01755                 }
01756             }
01757 
01758             <a class="code" href="../../d2/d3/dumpctl_8c.html#a42">IopInitializeDumpSpaceAndType</a> (dcb, block, pSummaryHeader);
01759         }
01760 
01761         <span class="comment">//</span>
01762         <span class="comment">// All of the pieces of the header file have been generated.  Before</span>
01763         <span class="comment">// mapping or writing anything to the disk, the I- &amp; D-stream caches</span>
01764         <span class="comment">// must be flushed so that page color coherency is kept.  Sweep both</span>
01765         <span class="comment">// caches now.</span>
01766         <span class="comment">//</span>
01767 
01768         KeSweepCurrentDcache();
01769         KeSweepCurrentIcache();
01770 
01771         <span class="comment">//</span>
01772         <span class="comment">// Create MDL for dump.</span>
01773         <span class="comment">//</span>
01774 
01775         mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) &amp;localMdl[0];
01776         <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a>( mdl, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> );
01777         mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01778 
01779         mcb = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a>;
01780 
01781         page = <a class="code" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a>(mdl);
01782         *page = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o12">HeaderPfn</a>;
01783         mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>;
01784 
01785         bytesRemaining = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01786         memoryAddress = (ULONG_PTR) dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>;
01787 
01788         <span class="comment">//</span>
01789         <span class="comment">// All of the pieces of the header file have been generated.  Write</span>
01790         <span class="comment">// the header page to the paging file, using the appropriate drivers,</span>
01791         <span class="comment">// etc.</span>
01792         <span class="comment">//</span>
01793 
01794         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Writing dump header to disk\n"</span>));
01795 
01796         <span class="keywordflow">while</span> (bytesRemaining) {
01797 
01798             <span class="keywordflow">if</span> (mcb[0].QuadPart &lt;= bytesRemaining) {
01799                 byteCount = mcb[0].LowPart;
01800             } <span class="keywordflow">else</span> {
01801                 byteCount = bytesRemaining;
01802             }
01803 
01804             mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = byteCount;
01805             mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o7">ByteOffset</a> = (ULONG)(memoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01806             mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a> = (PVOID) memoryAddress;
01807             mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> ((PVOID)memoryAddress);
01808 
01809             <span class="comment">//</span>
01810             <span class="comment">// Write to disk.</span>
01811             <span class="comment">//</span>
01812 
01813             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( write( &amp;mcb[1], mdl ) )) {
01814                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01815                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01816             }
01817 
01818             <span class="comment">//</span>
01819             <span class="comment">// Adjust bytes remaining.</span>
01820             <span class="comment">//</span>
01821 
01822             bytesRemaining -= byteCount;
01823             memoryAddress += byteCount;
01824             mcb[0].QuadPart = mcb[0].QuadPart - byteCount;
01825             mcb[1].QuadPart = mcb[1].QuadPart + byteCount;
01826 
01827             <span class="keywordflow">if</span> (!mcb[0].QuadPart) {
01828                 mcb += 2;
01829             }
01830         }
01831 
01832         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Header Page written\n"</span>));
01833 
01834 
01835         <span class="comment">//</span>
01836         <span class="comment">// If only requesting a header dump, we are now done.</span>
01837         <span class="comment">//</span>
01838         
01839         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a8">DCB_DUMP_HEADER_ENABLED</a>) {
01840             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Only Dumping Dump Header\n"</span>));
01841             <span class="keywordflow">goto</span> FinishDump;
01842         }
01843 
01844         <span class="comment">//</span>
01845         <span class="comment">// The header page has been written. If this is a triage-dump, write</span>
01846         <span class="comment">// the dump information and bail. Otherwise, fall through and do the</span>
01847         <span class="comment">// full or summary dump.</span>
01848         <span class="comment">//</span>
01849 
01850         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
01851             status = <a class="code" href="../../d2/d3/dumpctl_8c.html#a52">IopWriteTriageDump</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o19">TriageDumpFlags</a>,
01852                                        write,
01853                                        mcb,
01854                                        mdl,
01855                                        dwTransferSize,
01856                                        context,
01857                                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o20">TriageDumpBuffer</a>,
01858                                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o21">TriageDumpBufferSize</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
01859                                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o15">BuildNumber</a>,
01860                                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a>
01861                                        );
01862                                        
01863             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01864                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoWriteCrashDump: Failed to write triage-dump\n"</span>));
01865                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01866                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01867             }
01868 
01869             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoWriteCrashDump: Successfully wrote triage-dump\n"</span>));
01870             <span class="keywordflow">goto</span> FinishDump;
01871         }
01872 
01873         <span class="comment">//</span>
01874         <span class="comment">// The header page has been written to the paging file.  If a full dump</span>
01875         <span class="comment">// of all of physical memory is to be written, write it now.</span>
01876         <span class="comment">//</span>
01877 
01878         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>) {
01879 
01880             PFN_NUMBER pagesDoneSoFar = 0;
01881             ULONG currentPercentage = 0;
01882             ULONG maximumPercentage = 0;
01883 
01884 
01885             <span class="comment">//</span>
01886             <span class="comment">// Actual Pages is the number of pages to dump.</span>
01887             <span class="comment">//</span>
01888 
01889             ActualPages = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a>;
01890 
01891             <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>) {
01892 
01893                 PRTL_BITMAP PageMap;
01894 
01895                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( pSummaryHeader != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01896 
01897                 PageMap = (PRTL_BITMAP)(pSummaryHeader + 1);
01898                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01899 
01900                 <span class="comment">//</span>
01901                 <span class="comment">// At this point the dump header header has been sucessfully</span>
01902                 <span class="comment">// written. Write the summary dump header.</span>
01903                 <span class="comment">//</span>
01904                 
01905                 status = <a class="code" href="../../d2/d3/dumpctl_8c.html#a27">IopWriteSummaryHeader</a>(
01906                                      pSummaryHeader,
01907                                      write,
01908                                      &amp;mcb,
01909                                      mdl,
01910                                      dwTransferSize,
01911                                      (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)
01912                                      );
01913                                      
01914                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01915                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"IoWriteCrashDump: Error writing summary dump header\n"</span>));
01916                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = status;
01917                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01918                 }
01919 
01920                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Sucessfully wrote summary dump header\n"</span>));
01921 
01922                 ActualPages = pSummaryHeader-&gt;Pages;
01923 
01924             }
01925 
01926             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Writing Memory Dump\n"</span>));
01927 
01928             <span class="comment">//</span>
01929             <span class="comment">// Set the virtual file offset and initialize loop variables and</span>
01930             <span class="comment">// constants.</span>
01931             <span class="comment">//</span>
01932 
01933             memoryAddress = (ULONG_PTR)dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01934 
01935             <span class="keywordflow">if</span> ( dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a> ) {
01936 
01937                 PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
01938                 
01939                 <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = (PRTL_BITMAP)(pSummaryHeader+1);
01940 
01941                 status = <a class="code" href="../../d2/d3/dumpctl_8c.html#a54">IopWriteSummaryDump</a> (
01942                                         <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>,
01943                                         write,
01944                                         &amp;dumpStack-&gt;ProgMsg,
01945                                         messageBuffer,
01946                                         mcb,
01947                                         dwTransferSize
01948                                         );
01949 
01950                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01951                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoWriteCrashDump: Failed to write triage-dump\n"</span>));
01952                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01953                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01954                 }
01955 
01956                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoWriteCrashDump: Successfully wrote triage-dump\n"</span>));
01957                 <span class="keywordflow">goto</span> FinishDump;
01958             }
01959 
01960             <span class="comment">//</span>
01961             <span class="comment">// Now loop, writing all of physical memory to the paging file.</span>
01962             <span class="comment">//</span>
01963 
01964             <span class="keywordflow">while</span> (mcb[0].QuadPart) {
01965 
01966                 diskByteOffset = mcb[1];
01967 
01968                 <span class="comment">//</span>
01969                 <span class="comment">// Calculate byte offset;</span>
01970                 <span class="comment">//</span>
01971 
01972                 byteOffset = (ULONG)(memoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01973 
01974                 <span class="keywordflow">if</span> (dwTransferSize &lt;= mcb[0].QuadPart) {
01975                     byteCount = dwTransferSize - byteOffset;
01976                 } <span class="keywordflow">else</span> {
01977                     byteCount = mcb[0].LowPart;
01978                 }
01979                 pagesDoneSoFar += byteCount / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01980 
01981                 currentPercentage = (ULONG)((pagesDoneSoFar * 100) /
01982                                     ActualPages);
01983 
01984                 <span class="keywordflow">if</span> (currentPercentage &gt; maximumPercentage) {
01985 
01986                     maximumPercentage = currentPercentage;
01987                     <span class="comment">//</span>
01988                     <span class="comment">// Update message on screen.</span>
01989                     <span class="comment">//</span>
01990 
01991                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( messageBuffer, <span class="stringliteral">"%Z: %3d\r"</span>, &amp;dumpStack-&gt;ProgMsg, maximumPercentage );
01992                     <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>( messageBuffer );
01993 
01994                 }
01995 
01996                 <span class="comment">//</span>
01997                 <span class="comment">// Map the physical memory and write it to the</span>
01998                 <span class="comment">// current segment of the file.</span>
01999                 <span class="comment">//</span>
02000 
02001                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a23">IopMapPhysicalMemory</a>( mdl,
02002                                    memoryAddress,
02003                                    &amp;dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0],
02004                                    byteCount
02005                                    );
02006 
02007 
02008                 <span class="comment">//</span>
02009                 <span class="comment">// Write the next segment.</span>
02010                 <span class="comment">//</span>
02011 
02012                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( write( &amp;diskByteOffset, mdl ) )) {
02013                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
02014                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02015                 }
02016 
02017                 <span class="comment">//</span>
02018                 <span class="comment">// Adjust pointers for next part.</span>
02019                 <span class="comment">//</span>
02020 
02021                 memoryAddress += byteCount;
02022                 mcb[0].QuadPart = mcb[0].QuadPart - byteCount;
02023                 mcb[1].QuadPart = mcb[1].QuadPart + byteCount;
02024 
02025                 <span class="keywordflow">if</span> (!mcb[0].QuadPart) {
02026                     mcb += 2;
02027                 }
02028 
02029                 <span class="keywordflow">if</span> (pagesDoneSoFar &gt;= ActualPages) {
02030                     <span class="keywordflow">break</span>;
02031 
02032                 }
02033 
02034             }
02035 
02036             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: memory dump written\n"</span>));
02037         }
02038         
02039 FinishDump:
02040 
02041         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( messageBuffer, <span class="stringliteral">"%Z"</span>, &amp;dumpStack-&gt;DoneMsg );
02042         <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>( messageBuffer );
02043 
02044         <span class="comment">//</span>
02045         <span class="comment">// Sweep the cache so the debugger will work.</span>
02046         <span class="comment">//</span>
02047 
02048         KeSweepCurrentDcache();
02049         KeSweepCurrentIcache();
02050 
02051         <span class="comment">//</span>
02052         <span class="comment">// Have the dump flush the adapter and disk caches.</span>
02053         <span class="comment">//</span>
02054 
02055         finishUp();
02056 
02057         <span class="comment">//</span>
02058         <span class="comment">// Indicate to the debugger that the dump has been successfully</span>
02059         <span class="comment">// written.</span>
02060         <span class="comment">//</span>
02061 
02062         <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_SUCCESS;
02063     }
02064 
02065     <span class="comment">//</span>
02066     <span class="comment">// Check to see whether or not auto-reboots are enabled and, if so,</span>
02067     <span class="comment">// reboot now.</span>
02068     <span class="comment">//</span>
02069 
02070     <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a>) {
02071         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> (( 0,  <span class="stringliteral">"IODUMP: Autorebooting\n"</span> ));
02072         <a class="code" href="../../d9/d4/ke_2debug_8c.html#a13">KeReturnToFirmware</a>( <a class="code" href="../../d4/d9/ke_8h.html#a411a244">HalRebootRoutine</a> );
02073     }
02074 
02075     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02076 }
02077 
02078 
02079 
02080 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02081"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a23">02081</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a23">IopMapPhysicalMemory</a>(
02082     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
02083     IN ULONG_PTR MemoryAddress,
02084     IN <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> PhysicalMemoryRun,
02085     IN ULONG Length
02086     )
02087 
02088 <span class="comment">/*++</span>
02089 <span class="comment"></span>
02090 <span class="comment">Routine Description:</span>
02091 <span class="comment"></span>
02092 <span class="comment">    This routine is invoked to fill in the specified MDL (Memory Descriptor</span>
02093 <span class="comment">    List) w/the appropriate information to map the specified memory address</span>
02094 <span class="comment">    range.</span>
02095 <span class="comment"></span>
02096 <span class="comment">Arguments:</span>
02097 <span class="comment"></span>
02098 <span class="comment">    Mdl - Address of the MDL to be filled in.</span>
02099 <span class="comment"></span>
02100 <span class="comment">    MemoryAddress - Pseudo-virtual address being mapped.</span>
02101 <span class="comment"></span>
02102 <span class="comment">    PhysicalMemoryRun - Base address of the physical memory run list.</span>
02103 <span class="comment"></span>
02104 <span class="comment">    Length - Length of transfer to be mapped.</span>
02105 <span class="comment"></span>
02106 <span class="comment">Return Value:</span>
02107 <span class="comment"></span>
02108 <span class="comment">    None.</span>
02109 <span class="comment"></span>
02110 <span class="comment">--*/</span>
02111 
02112 {
02113     <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> pmr = PhysicalMemoryRun;
02114     PPFN_NUMBER page;
02115     PFN_NUMBER pages;
02116     PFN_NUMBER base;
02117     PFN_NUMBER currentBase;
02118 
02119     <span class="comment">//</span>
02120     <span class="comment">// Begin by determining the base physical page of the start of the address</span>
02121     <span class="comment">// range and filling in the MDL appropriately.</span>
02122     <span class="comment">//</span>
02123     Mdl-&gt;StartVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>( (PVOID) (MemoryAddress) );
02124     Mdl-&gt;ByteOffset = (ULONG)(MemoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
02125     Mdl-&gt;ByteCount = Length;
02126 
02127     <span class="comment">//</span>
02128     <span class="comment">// Get the page frame index for the base address.</span>
02129     <span class="comment">//</span>
02130 
02131     base = (PFN_NUMBER) ((ULONG_PTR)(Mdl-&gt;StartVa) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02132     pages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a>(MemoryAddress, Length);
02133     currentBase = pmr-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
02134     page = <a class="code" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a>(Mdl);
02135 
02136     <span class="comment">//</span>
02137     <span class="comment">// Map all of the pages for this transfer until there are no more remaining</span>
02138     <span class="comment">// to be mapped.</span>
02139     <span class="comment">//</span>
02140 
02141     <span class="keywordflow">while</span> (pages) {
02142 
02143         <span class="comment">//</span>
02144         <span class="comment">// Find the memory run that maps the beginning of this transfer.</span>
02145         <span class="comment">//</span>
02146 
02147         <span class="keywordflow">while</span> (currentBase + pmr-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> &lt;= base) {
02148             currentBase += pmr-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
02149             pmr++;
02150         }
02151 
02152         <span class="comment">//</span>
02153         <span class="comment">// The current memory run maps the start of this transfer.  Capture</span>
02154         <span class="comment">// the base page for the start of the transfer.</span>
02155         <span class="comment">//</span>
02156 
02157         *page++ = pmr-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> + (PFN_NUMBER)(base++ - currentBase);
02158         pages--;
02159     }
02160 
02161     <span class="comment">//</span>
02162     <span class="comment">// All of the PFNs for the address range have been filled in so map the</span>
02163     <span class="comment">// physical memory into virtual address space.</span>
02164     <span class="comment">//</span>
02165 
02166     <a class="code" href="../../d5/d6/iosup_8c.html#a82">MmMapMemoryDumpMdl</a>( Mdl );
02167 }
02168 
02169 
02170 
02171 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02172"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a44">02172</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a44">IopAddPageToPageMap</a>(
02173     IN ULONG dwMaxPage,
02174     IN PRTL_BITMAP pBitMapHeader,
02175     IN ULONG dwPageFrameIndex,
02176     IN ULONG dwNumberOfPages
02177     )
02178 {
02179     <span class="comment">//</span>
02180     <span class="comment">// Sometimes we get PFNs that are out of range. Just ignore them.</span>
02181     <span class="comment">//</span>
02182 
02183     <span class="keywordflow">if</span> (dwPageFrameIndex &gt;= dwMaxPage) {
02184         <span class="keywordflow">return</span>;
02185     }
02186 
02187     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (pBitMapHeader, dwPageFrameIndex, dwNumberOfPages);
02188 }
02189 
02190 
02191 
02192 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02193"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a45">02193</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a>(
02194     IN ULONG dwMaxPage,
02195     IN PRTL_BITMAP pBitMapHeader,
02196     IN ULONG dwPageFrameIndex,
02197     IN ULONG dwNumberOfPages
02198     )
02199 {
02200     <span class="comment">//</span>
02201     <span class="comment">// Sometimes we get PFNs that are out of range. Just ignore them.</span>
02202     <span class="comment">//</span>
02203 
02204     <span class="keywordflow">if</span> (dwPageFrameIndex &gt;= dwMaxPage) {
02205         <span class="keywordflow">return</span>;
02206     }
02207     
02208     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>( (6, <span class="stringliteral">"RtlClearBits max:%x pfn:%x, pages:%x\n"</span>,(dwMaxPage), (dwPageFrameIndex), (dwNumberOfPages) )); \
02209     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (pBitMapHeader, dwPageFrameIndex, dwNumberOfPages);
02210 
02211 }
02212 
02213 
02214 
02215 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
02216 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02217"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a46">02217</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a46">IoGetCrashDumpInformation</a>(
02218     OUT PSYSTEM_CRASH_DUMP_INFORMATION pCrashDumpInfo
02219     )
02220 
02221 <span class="comment">/*++</span>
02222 <span class="comment"></span>
02223 <span class="comment">Routine Description:</span>
02224 <span class="comment"></span>
02225 <span class="comment">    This function checks to see if an open crash dump section exists and</span>
02226 <span class="comment">    if so creates a handle to the section and returns that value</span>
02227 <span class="comment">    in the CrashDumpInformation structure.</span>
02228 <span class="comment"></span>
02229 <span class="comment"></span>
02230 <span class="comment">Arguments:</span>
02231 <span class="comment"></span>
02232 <span class="comment">    CrashInfo - Supplies a pointer to the crash dump information</span>
02233 <span class="comment">                structure.</span>
02234 <span class="comment"></span>
02235 <span class="comment">Return Value:</span>
02236 <span class="comment"></span>
02237 <span class="comment">    Status of the operation.  A handle value of zero indicates no</span>
02238 <span class="comment">    crash dump was located.</span>
02239 <span class="comment"></span>
02240 <span class="comment">--*/</span>
02241 {
02242 
02243     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>) {
02244         <span class="keywordflow">return</span> STATUS_NOT_FOUND;
02245     }
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">// NB: The section object is for direct dump support, which has been</span>
02249     <span class="comment">// removed.</span>
02250     <span class="comment">//</span>
02251     
02252     pCrashDumpInfo-&gt;hDumpSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02253     <span class="keywordflow">return</span> STATUS_SUCCESS;
02254 }
02255 
02256 
02257 
02258 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
02259 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02260"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a47">02260</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a47">IoGetCrashDumpStateInformation</a>(
02261     OUT PSYSTEM_CRASH_STATE_INFORMATION pCrashDumpState
02262     )
02263 
02264 <span class="comment">/*++</span>
02265 <span class="comment"></span>
02266 <span class="comment">Routine Description:</span>
02267 <span class="comment"></span>
02268 <span class="comment">    This routine returns sets the state variable for direct dump (fast dump)</span>
02269 <span class="comment"></span>
02270 <span class="comment"></span>
02271 <span class="comment">Arguments:</span>
02272 <span class="comment"></span>
02273 <span class="comment">    CrashInfo - Supplies a pointer to the crash dump state information</span>
02274 <span class="comment">                structure.</span>
02275 <span class="comment"></span>
02276 <span class="comment">Return Value:</span>
02277 <span class="comment"></span>
02278 <span class="comment">    Status of the operation.  A handle value of zero indicates no</span>
02279 <span class="comment">    crash dump was located.</span>
02280 <span class="comment"></span>
02281 <span class="comment">--*/</span>
02282 
02283 {
02284     pCrashDumpState-&gt;ValidDirectDump = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02285 
02286     <span class="keywordflow">return</span> STATUS_SUCCESS;
02287 }
02288 
02289 
02290 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02291"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a48">02291</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a48">IoSetDumpRange</a>(
02292     IN PVOID   DumpContext,
02293     IN PVOID   StartVa,
02294     IN ULONG_PTR Pages,
02295     IN BOOLEAN IsPhysicalAddress
02296     )
02297 
02298 <span class="comment">/*++</span>
02299 <span class="comment"></span>
02300 <span class="comment">Routine Description:</span>
02301 <span class="comment"></span>
02302 <span class="comment">    This routine includes this range of memory in the dump</span>
02303 <span class="comment"></span>
02304 <span class="comment">Arguments:</span>
02305 <span class="comment"></span>
02306 <span class="comment">    DumpContext - dump context</span>
02307 <span class="comment">    </span>
02308 <span class="comment">    StartVa - Starting VA</span>
02309 <span class="comment">    </span>
02310 <span class="comment">    Pages - The number of pages to include</span>
02311 <span class="comment">    </span>
02312 <span class="comment">    IsPhysicalAddress - true if direct physical address translation</span>
02313 <span class="comment">    </span>
02314 <span class="comment">Return Value:</span>
02315 <span class="comment"></span>
02316 <span class="comment">    STATUS_SUCCESS - On success.</span>
02317 <span class="comment">    </span>
02318 <span class="comment">    NTSTATUS - Error.</span>
02319 <span class="comment"></span>
02320 <span class="comment">--*/</span>
02321 {
02322     PCHAR                   Va;
02323     PRTL_BITMAP             pBitMapHeader;
02324     PHYSICAL_ADDRESS        phyAddr;
02325     PSUMMARY_DUMP_HEADER    pHeader;
02326     BOOLEAN                 AllPagesSet;
02327 
02328 
02329     Va = StartVa;
02330     pHeader = (PSUMMARY_DUMP_HEADER) DumpContext;
02331     pBitMapHeader = (PRTL_BITMAP)(pHeader + 1);
02332     AllPagesSet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02333 
02334     <span class="comment">//</span>
02335     <span class="comment">// Win64 can have really large page addresses.  This dump code does</span>
02336     <span class="comment">// not handle that yet.  Note that before this assert is removed</span>
02337     <span class="comment">// the casts of Pages to ULONG must be removed.</span>
02338     <span class="comment">//</span>
02339 
02340     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pages &lt;= MAXULONG);
02341 
02342     <span class="comment">//</span>
02343     <span class="comment">// IsPhysicalAddress indicates that the va is virtually / physically</span>
02344     <span class="comment">// contiguous.</span>
02345     <span class="comment">//</span>
02346     
02347     <span class="keywordflow">if</span> (IsPhysicalAddress) {
02348 
02349         phyAddr = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (Va);
02350         <a class="code" href="../../d2/d3/dumpctl_8c.html#a44">IopAddPageToPageMap</a> (pHeader-&gt;BitmapSize,
02351                              pBitMapHeader,
02352                              (ULONG)(phyAddr.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
02353                              (ULONG) Pages
02354                              );
02355 
02356     } <span class="keywordflow">else</span> {
02357     
02358         <span class="comment">//</span>
02359         <span class="comment">// Not physically contiguous.</span>
02360         <span class="comment">//</span>
02361         
02362         <span class="keywordflow">while</span> (Pages) {
02363 
02364             <span class="comment">//</span>
02365             <span class="comment">// Only do a translation for valid pages.</span>
02366             <span class="comment">//</span>
02367             
02368             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(Va) ) {
02369 
02370                 <span class="comment">//</span>
02371                 <span class="comment">// Get the physical mapping. Note: this does not require a lock</span>
02372                 <span class="comment">//</span>
02373                 
02374                 phyAddr = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (Va);
02375 
02376                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a44">IopAddPageToPageMap</a> (pHeader-&gt;BitmapSize,
02377                                      pBitMapHeader,
02378                                      (ULONG)(phyAddr.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
02379                                      1);
02380 
02381                 <span class="keywordflow">if</span> (phyAddr.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> &gt; pHeader-&gt;BitmapSize) {
02382                     AllPagesSet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02383                 }
02384             }
02385 
02386             Va +=  <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02387             Pages--;
02388         }
02389     }
02390 
02391     <span class="keywordflow">if</span> (AllPagesSet) {
02392         <span class="keywordflow">return</span> STATUS_SUCCESS;
02393     }
02394 
02395     <span class="keywordflow">return</span> STATUS_INVALID_ADDRESS;
02396 }
02397 
02398 
02399 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02400"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a49">02400</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a49">IoFreeDumpRange</a>(
02401     IN PVOID   DumpContext,
02402     IN PVOID   StartVa,
02403     IN ULONG_PTR Pages,
02404     IN BOOLEAN IsPhysicalAddress
02405     )
02406 <span class="comment">/*++</span>
02407 <span class="comment"></span>
02408 <span class="comment">Routine Description:</span>
02409 <span class="comment"></span>
02410 <span class="comment">    This routine excludes this range of memory in the dump.</span>
02411 <span class="comment"></span>
02412 <span class="comment">Arguments:</span>
02413 <span class="comment"></span>
02414 <span class="comment">    DumpContext - dump context</span>
02415 <span class="comment">    </span>
02416 <span class="comment">    StartVa - Starting VA</span>
02417 <span class="comment">    </span>
02418 <span class="comment">    Pages - The number of pages to include</span>
02419 <span class="comment">    </span>
02420 <span class="comment">    IsPhysicalAddress - true if direct physical address translation</span>
02421 <span class="comment">    </span>
02422 <span class="comment">Return Value:</span>
02423 <span class="comment"></span>
02424 <span class="comment">    STATUS_SUCCESS - On success.</span>
02425 <span class="comment">    </span>
02426 <span class="comment">    NTSTATUS - Error.</span>
02427 <span class="comment"></span>
02428 <span class="comment">--*/</span>
02429 {
02430     PCHAR                   Va;
02431     PRTL_BITMAP             pBitMapHeader;
02432     PHYSICAL_ADDRESS        phyAddr;
02433     PSUMMARY_DUMP_HEADER    pHeader;
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">// Round to page size.</span>
02437     <span class="comment">//</span>
02438     
02439     Va = StartVa;
02440     pHeader = (PSUMMARY_DUMP_HEADER)DumpContext;
02441     pBitMapHeader = (PRTL_BITMAP)(pHeader + 1);
02442 
02443     <span class="comment">//</span>
02444     <span class="comment">// Win64 can have really large page addresses.  This dump code does</span>
02445     <span class="comment">// not handle that yet.  Note that before this assert is removed</span>
02446     <span class="comment">// the casts of Pages to ULONG must be removed.</span>
02447     <span class="comment">//</span>
02448 
02449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pages &lt;= MAXULONG);
02450 
02451     <span class="keywordflow">if</span> (IsPhysicalAddress) {
02452 
02453         phyAddr = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>(Va);
02454 
02455         <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (pHeader-&gt;BitmapSize,
02456                                   pBitMapHeader,
02457                                   (ULONG)(phyAddr.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
02458                                   (ULONG) Pages
02459                                   );
02460     } <span class="keywordflow">else</span> {
02461 
02462         <span class="keywordflow">while</span> (Pages) {
02463 
02464             <span class="comment">//</span>
02465             <span class="comment">// Only do a translation for valid pages.</span>
02466             <span class="comment">//</span>
02467 
02468             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Va) ) {
02469                 phyAddr = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (Va);
02470 
02471                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((3,<span class="stringliteral">"IoFreeDumpRange:Va: %x Pages: %x IsPhysical: %x phyAddr %I64x\n"</span>,
02472                     StartVa,Pages,IsPhysicalAddress, phyAddr.QuadPart));
02473 
02474                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (pHeader-&gt;BitmapSize,
02475                                           pBitMapHeader,
02476                                           (ULONG)(phyAddr.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
02477                                           1);
02478 
02479             }
02480 
02481             Va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02482             Pages--;
02483         }
02484     }
02485 
02486     <span class="keywordflow">return</span> STATUS_SUCCESS;
02487 }
02488 
02489 
02490 
02491 LARGE_INTEGER
<a name="l02492"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a33">02492</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
02493     IN ULONG   dwDmpFlags,
02494     IN ULONG   dwHeaderSize,
02495     IN PFN_NUMBER   dwMaxPages,
02496     IN PFN_NUMBER   dwMaxSummaryPages
02497     )
02498 
02499 <span class="comment">/*++</span>
02500 <span class="comment"></span>
02501 <span class="comment">Routine Description:</span>
02502 <span class="comment"></span>
02503 <span class="comment">    This routine is used to calcuate required dump space</span>
02504 <span class="comment"></span>
02505 <span class="comment">        1. Crash dump summary must be at least 1 page in length.</span>
02506 <span class="comment"></span>
02507 <span class="comment">        2. Summary dump must be large enough for kernel memory plus header,</span>
02508 <span class="comment">           plus summary header.</span>
02509 <span class="comment"></span>
02510 <span class="comment">        3. Full dump must be large enough for header plus all physical memory.</span>
02511 <span class="comment"></span>
02512 <span class="comment">Arguments:</span>
02513 <span class="comment"></span>
02514 <span class="comment">    dwDmpFlags - Dump Control Block (DCB) flags.</span>
02515 <span class="comment"></span>
02516 <span class="comment">    dwHeaderSize - The size of the dump header.</span>
02517 <span class="comment"></span>
02518 <span class="comment">    dwMaxPages - All physical memory.</span>
02519 <span class="comment"></span>
02520 <span class="comment">    dwMaxSummaryPages - Maximum pages in summary dump.</span>
02521 <span class="comment"></span>
02522 <span class="comment">Return Value:</span>
02523 <span class="comment"></span>
02524 <span class="comment">    Size of the dump file</span>
02525 <span class="comment"></span>
02526 <span class="comment">--*/</span>
02527 {
02528     LARGE_INTEGER maxMemorySize;
02529 
02530     <span class="comment">//</span>
02531     <span class="comment">// Dump header or dump summary.</span>
02532     <span class="comment">//</span>
02533     
02534     <span class="keywordflow">if</span> ( (dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a8">DCB_DUMP_HEADER_ENABLED</a>) ||
02535          ( !( dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a> ) &amp;&amp;
02536          ( dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a> ) ) ) {
02537          
02538         maxMemorySize.QuadPart = <a class="code" href="../../d2/d3/dumpctl_8c.html#a3">IO_DUMP_MINIMUM_FILE_SIZE</a>;
02539         <span class="keywordflow">return</span> maxMemorySize;
02540     }
02541 
02542     <span class="keywordflow">if</span> (dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
02543 
02544         maxMemorySize.QuadPart = TRIAGE_DUMP_SIZE;
02545         <span class="keywordflow">return</span> maxMemorySize;
02546     }
02547 
02548     <span class="keywordflow">if</span> (dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>) {
02549         ULONG summaryHeaderSize;
02550         ULONG dwGB;
02551 
02552         maxMemorySize.QuadPart  = (dwMaxSummaryPages) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02553 
02554         <span class="comment">//</span>
02555         <span class="comment">// If biased then max kernel memory is 1GB otherwise it is 2GB</span>
02556         <span class="comment">//</span>
02557         
02558         dwGB = 1024 * 1024 * 1024;
02559 
02560         <span class="keywordflow">if</span> (maxMemorySize.QuadPart &gt;  (2 * dwGB) ) {
02561             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a>) {
02562                 maxMemorySize.QuadPart = dwGB;
02563             } <span class="keywordflow">else</span> {
02564                 maxMemorySize.QuadPart = (2 * dwGB);
02565             }
02566         }
02567 
02568         <span class="comment">//</span>
02569         <span class="comment">// Calculate the summary header size. Includes the header plus bitmap</span>
02570         <span class="comment">//</span>
02571         summaryHeaderSize = (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(
02572                                 <span class="keyword">sizeof</span>(SUMMARY_DUMP_HEADER) +
02573                                 <span class="keyword">sizeof</span>(RTL_BITMAP) +
02574                                 ( ( (maxMemorySize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> ) &gt;&gt; 5 ) &lt;&lt; 2 ) +
02575                                 dwHeaderSize
02576                                 );
02577 
02578         maxMemorySize.QuadPart+= summaryHeaderSize;
02579 
02580         <span class="keywordflow">return</span> maxMemorySize;
02581 
02582     }
02583 
02584     <span class="comment">//</span>
02585     <span class="comment">// Full memory dump is #pages * pagesize plus 1 page for the dump header.</span>
02586     <span class="comment">//</span>
02587     
02588     maxMemorySize.QuadPart = (dwMaxPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) + dwHeaderSize;
02589 
02590     <span class="keywordflow">return</span> maxMemorySize;
02591 
02592 }
02593 
02594 
02595 
02596 <span class="comment">//</span>
02597 <span class="comment">// Triage-dump support routines.</span>
02598 <span class="comment">//</span>
02599 
02600 
02601 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02602"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a50">02602</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a50">IopGetLoadedDriverInfo</a>(
02603     OUT ULONG * lpDriverCount,
02604     OUT ULONG * lpSizeOfStringData
02605     )
02606 
02607 <span class="comment">/*++</span>
02608 <span class="comment"></span>
02609 <span class="comment">Routine Description:</span>
02610 <span class="comment"></span>
02611 <span class="comment">    Get information about all loaded drivers.</span>
02612 <span class="comment"></span>
02613 <span class="comment">Arguments:</span>
02614 <span class="comment"></span>
02615 <span class="comment">    lpDriverCount - Buffer to return the count of all the drivers that are</span>
02616 <span class="comment">                    currently loaded in the system.</span>
02617 <span class="comment"></span>
02618 <span class="comment">    lpSizeOfStringData - Buffer to return the sum of the sizes of all driver</span>
02619 <span class="comment">                    name strings (FullDllName). This does not include the size</span>
02620 <span class="comment">                    of the UNICODE_STRING structure or a trailing NULL byte.</span>
02621 <span class="comment"></span>
02622 <span class="comment">Return Values:</span>
02623 <span class="comment"></span>
02624 <span class="comment">    NTSTATUS</span>
02625 <span class="comment"></span>
02626 <span class="comment">--*/</span>
02627 
02628 {
02629     ULONG DriverCount = 0;
02630     ULONG SizeOfStringData = 0;
02631     PLIST_ENTRY NextEntry;
02632     PLDR_DATA_TABLE_ENTRY <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>;
02633 
02634 
02635     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02636     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
02637 
02638         <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = CONTAINING_RECORD (NextEntry,
02639                                          LDR_DATA_TABLE_ENTRY,
02640                                          InLoadOrderLinks
02641                                          );
02642 
02643         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>, <span class="keyword">sizeof</span> (*<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>)) ||
02644             !<a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Buffer,
02645                                      <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Length)) {
02646 
02647             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02648         }
02649         
02650         DriverCount++;
02651         SizeOfStringData += <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;FullDllName.Length;
02652         NextEntry = NextEntry-&gt;Flink;
02653     }
02654 
02655     *lpDriverCount = DriverCount;
02656     *lpSizeOfStringData = SizeOfStringData;
02657 
02658     <span class="keywordflow">return</span> STATUS_SUCCESS;
02659 }
02660 
<a name="l02661"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a11">02661</a> <span class="preprocessor">#define DmpPoolStringSize(DumpString)\</span>
02662 <span class="preprocessor">        (sizeof (DUMP_STRING) + sizeof (WCHAR) * ( DumpString-&gt;Length + 1 ))</span>
02663 <span class="preprocessor"></span>        
<a name="l02664"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a12">02664</a> <span class="preprocessor">#define DmpNextPoolString(DumpString)                                       \</span>
02665 <span class="preprocessor">        (PDUMP_STRING) (                                                    \</span>
02666 <span class="preprocessor">            ALIGN_UP_POINTER(                                               \</span>
02667 <span class="preprocessor">                ((LPBYTE) DumpString) + DmpPoolStringSize (DumpString),     \</span>
02668 <span class="preprocessor">                ULONGLONG                                                   \</span>
02669 <span class="preprocessor">                )                                                           \</span>
02670 <span class="preprocessor">            )</span>
02671 <span class="preprocessor"></span>
<a name="l02672"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a13">02672</a> <span class="preprocessor">#define ALIGN_8(_x) ALIGN_UP(_x, DWORDLONG)</span>
02673 <span class="preprocessor"></span>
02674 
02675 <span class="preprocessor">#ifndef IndexByByte</span>
<a name="l02676"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a14">02676</a> <span class="preprocessor"></span><span class="preprocessor">#define IndexByByte(Pointer, Index) (&amp;(((BYTE*) (Pointer)) [Index]))</span>
02677 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02678 <span class="preprocessor"></span>
02679         
02680 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02681"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a51">02681</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a51">IopWriteDriverList</a>(
02682     IN ULONG_PTR BufferAddress,
02683     IN ULONG BufferSize,
02684     IN ULONG DriverListOffset,
02685     IN ULONG StringPoolOffset
02686     )
02687 
02688 <span class="comment">/*++</span>
02689 <span class="comment"></span>
02690 <span class="comment">Routine Description:</span>
02691 <span class="comment"></span>
02692 <span class="comment">    Write the triage dump driver list to the buffer.</span>
02693 <span class="comment"></span>
02694 <span class="comment">Arguments:</span>
02695 <span class="comment"></span>
02696 <span class="comment">    BufferAddress - The address of the buffer.</span>
02697 <span class="comment"></span>
02698 <span class="comment">    BufferSize - The size of the buffer.</span>
02699 <span class="comment"></span>
02700 <span class="comment">    DriverListOffset - The offset within the buffer where the driver list</span>
02701 <span class="comment">        should be written.</span>
02702 <span class="comment"></span>
02703 <span class="comment">    StringPoolOffset - The offset within the buffer where the driver list's</span>
02704 <span class="comment">        string pool should start. If there are no other strings for the triage</span>
02705 <span class="comment">        dump other than driver name strings, this will be the string pool</span>
02706 <span class="comment">        offset.</span>
02707 <span class="comment"></span>
02708 <span class="comment">Return Value:</span>
02709 <span class="comment"></span>
02710 <span class="comment">    NTSTATUS</span>
02711 <span class="comment"></span>
02712 <span class="comment">--*/</span>
02713 
02714 {
02715     ULONG i = 0;
02716     PLIST_ENTRY NextEntry;
02717     PLDR_DATA_TABLE_ENTRY <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>;
02718     PDUMP_DRIVER_ENTRY DumpImageArray;
02719     PDUMP_STRING DumpStringName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02720     PIMAGE_NT_HEADERS NtHeaders;
02721 
02722     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverListOffset != 0);
02723     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StringPoolOffset != 0);
02724     
02725 
02726     DumpImageArray = (PDUMP_DRIVER_ENTRY) (BufferAddress + DriverListOffset);
02727     DumpStringName = (PDUMP_STRING) (BufferAddress + StringPoolOffset);
02728 
02729     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02730     
02731     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
02732 
02733         <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = CONTAINING_RECORD (NextEntry,
02734                                         LDR_DATA_TABLE_ENTRY,
02735                                         InLoadOrderLinks);
02736 
02737         <span class="comment">//</span>
02738         <span class="comment">// Verify the memory is valid before reading anything from it.</span>
02739         <span class="comment">//</span>
02740         
02741         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>, <span class="keyword">sizeof</span> (*<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>)) ||
02742             !<a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Buffer,
02743                                      <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Length)) {
02744 
02745             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02746         }
02747             
02748         <span class="comment">//</span>
02749         <span class="comment">// Build the entry in the string pool. We guarantee all strings are</span>
02750         <span class="comment">// NULL terminated as well as length prefixed.</span>
02751         <span class="comment">//</span>
02752 
02753         DumpStringName-&gt;Length = <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Length / 2;
02754         RtlCopyMemory (DumpStringName-&gt;Buffer,
02755                        <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Buffer,
02756                        DumpStringName-&gt;Length * sizeof (WCHAR)
02757                        );
02758 
02759         DumpStringName-&gt;Buffer[ DumpStringName-&gt;Length ] = <span class="charliteral">'\000'</span>;
02760 
02761         RtlCopyMemory (&amp;DumpImageArray [i].LdrEntry,
02762                        <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>,
02763                        <span class="keyword">sizeof</span> (DumpImageArray [i].LdrEntry)
02764                        );
02765 
02766         <span class="comment">//</span>
02767         <span class="comment">// Add the time/date stamp.</span>
02768         <span class="comment">//</span>
02769 
02770         DumpImageArray[i].LdrEntry.TimeDateStamp = 0;
02771         DumpImageArray[i].LdrEntry.SizeOfImage = 0;
02772 
02773         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;DllBase ) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02774 
02775             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;DllBase);
02776             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( NtHeaders );
02777             DumpImageArray[i].LdrEntry.TimeDateStamp = NtHeaders-&gt;FileHeader.TimeDateStamp;
02778             DumpImageArray[i].LdrEntry.SizeOfImage = NtHeaders-&gt;OptionalHeader.SizeOfImage;
02779         }
02780         
02781         DumpImageArray [i].DriverNameOffset =
02782                 (ULONG)((ULONG_PTR) DumpStringName - BufferAddress);
02783 
02784         i++;
02785         DumpStringName = <a class="code" href="../../d2/d3/dumpctl_8c.html#a12">DmpNextPoolString</a> (DumpStringName);
02786         NextEntry = NextEntry-&gt;Flink;
02787     }
02788 
02789     <span class="keywordflow">return</span> STATUS_SUCCESS;
02790 }
02791 
02792 
02793 
02794 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02795"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a52">02795</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a52">IopWriteTriageDump</a>(
02796     IN ULONG Fields,
02797     IN PDUMP_DRIVER_WRITE DriverWriteRoutine,
02798     IN OUT PLARGE_INTEGER Mcb,
02799     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
02800     IN ULONG DriverTransferSize,
02801     IN PCONTEXT Context,
02802     IN BYTE* Buffer,
02803     IN ULONG BufferSize,
02804     IN ULONG ServicePackBuild,
02805     IN ULONG TriageOptions
02806     )
02807 
02808 <span class="comment">/*++</span>
02809 <span class="comment"></span>
02810 <span class="comment">Routine Description:</span>
02811 <span class="comment"></span>
02812 <span class="comment">    Write the Triage-Dump to the MCB.</span>
02813 <span class="comment"></span>
02814 <span class="comment">Arguments:</span>
02815 <span class="comment"></span>
02816 <span class="comment">    Fields - The set of fields that should be written.</span>
02817 <span class="comment">    </span>
02818 <span class="comment">    DriverWriteRoutine - The write routine for the driver.</span>
02819 <span class="comment"></span>
02820 <span class="comment">    Mcb - Message Control Block where the data is to be written.</span>
02821 <span class="comment"></span>
02822 <span class="comment">    Mdl - A MDL descrbing the data to be written (??).</span>
02823 <span class="comment"></span>
02824 <span class="comment">    DriverTransferSize - The maximum transfer size for the driver.</span>
02825 <span class="comment"></span>
02826 <span class="comment">    Context - The context.</span>
02827 <span class="comment"></span>
02828 <span class="comment">    Buffer - The buffer to use as a scratch buffer.</span>
02829 <span class="comment"></span>
02830 <span class="comment">    BufferSize - The size of the buffer.</span>
02831 <span class="comment"></span>
02832 <span class="comment">    ServicePackBuild - Service Pack BuildNumber.</span>
02833 <span class="comment"></span>
02834 <span class="comment">    TriageOptions - Triage Options.</span>
02835 <span class="comment"></span>
02836 <span class="comment">Return Values:</span>
02837 <span class="comment"></span>
02838 <span class="comment">    STATUS_SUCCESS - On success.</span>
02839 <span class="comment"></span>
02840 <span class="comment">    NTSTATUS - Otherwise.</span>
02841 <span class="comment"></span>
02842 <span class="comment">Comments:</span>
02843 <span class="comment"></span>
02844 <span class="comment">    This function assumes that exactly one header page was written.</span>
02845 <span class="comment"></span>
02846 <span class="comment">--*/</span>
02847 
02848 {
02849     ULONG SizeOfSection;
02850     ULONG SizeOfStringData;
02851     ULONG DriverCount = 0;
02852     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> Address = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02853     ULONG BytesToWrite = 0;
02854     ULONG_PTR BufferAddress = 0;
02855     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02856     ULONG_PTR <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02857     ULONG_PTR StartOfStackRegion = 0;
02858     PTRIAGE_DUMP_HEADER TriageDumpHeader = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02859     PLDR_DATA_TABLE_ENTRY <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02860     PDUMP_DRIVER_ENTRY DumpImageArray = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02861     PDUMP_STRING DumpStringName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02862     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02863 
02864     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0, <span class="stringliteral">"[IopWriteTriageDump] BufferSize = %#x ServicePackBuild = %d\n"</span>,
02865                    <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
02866                    ServicePackBuild));
02867 
02868     <span class="comment">//</span>
02869     <span class="comment">// Setup the triage-dump header.</span>
02870     <span class="comment">//</span>
02871 
02872     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; <span class="keyword">sizeof</span> (TRIAGE_DUMP_HEADER) + <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
02873         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02874     }
02875     
02876     TriageDumpHeader = (PTRIAGE_DUMP_HEADER) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02877     RtlZeroMemory (TriageDumpHeader, <span class="keyword">sizeof</span> (*TriageDumpHeader));
02878 
02879     <span class="comment">//</span>
02880     <span class="comment">// The normal dump header is of size PAGE_SIZE.</span>
02881     <span class="comment">//</span>
02882     
02883     TriageDumpHeader-&gt;SizeOfDump = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02884 
02885     <span class="comment">//</span>
02886     <span class="comment">// Adjust the BufferSize so we can write the final status DWORD at the</span>
02887     <span class="comment">// end.</span>
02888     <span class="comment">//</span>
02889     
02890     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> -= <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02891     RtlZeroMemory (<a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>), <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
02892 
02893     TriageDumpHeader-&gt;ValidOffset = ( TriageDumpHeader-&gt;SizeOfDump - <span class="keyword">sizeof</span> (ULONG) );
02894     TriageDumpHeader-&gt;ContextOffset = DH_CONTEXT_RECORD * <span class="keyword">sizeof</span> (ULONG);
02895     TriageDumpHeader-&gt;ExceptionOffset = DH_EXCEPTION_RECORD * <span class="keyword">sizeof</span> (ULONG);
02896     TriageDumpHeader-&gt;BrokenDriverOffset = 0;
02897     TriageDumpHeader-&gt;ServicePackBuild = ServicePackBuild;
02898     TriageDumpHeader-&gt;TriageOptions = TriageOptions;
02899 
02900     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> + <span class="keyword">sizeof</span> (TRIAGE_DUMP_HEADER));
02901 
02902     <span class="comment">//</span>
02903     <span class="comment">// Set the Mm Offset, if necessary.</span>
02904     <span class="comment">//</span>
02905 
02906     SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<a class="code" href="../../d2/d1/mm_8h.html#a236">MmSizeOfTriageInformation</a>());
02907 
02908     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02909         TriageDumpHeader-&gt;MmOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02910         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02911     }
02912 
02913     <span class="comment">//</span>
02914     <span class="comment">// Set the Unloaded Drivers Offset, if necessary.</span>
02915     <span class="comment">//</span>
02916 
02917     SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<a class="code" href="../../d2/d1/mm_8h.html#a237">MmSizeOfUnloadedDriverInformation</a>());
02918 
02919     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02920         TriageDumpHeader-&gt;UnloadedDriversOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02921         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02922     }
02923 
02924     <span class="comment">//</span>
02925     <span class="comment">// Set the Prcb Offset, if necessary.</span>
02926     <span class="comment">//</span>
02927 
02928     <span class="keywordflow">if</span> (Fields &amp; TRIAGE_DUMP_PRCB) {
02929         SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<span class="keyword">sizeof</span> (KPRCB));
02930 
02931         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02932             TriageDumpHeader-&gt;PrcbOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02933             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02934         }
02935     }
02936 
02937     <span class="comment">//</span>
02938     <span class="comment">// Set the Process Offset, if necessary.</span>
02939     <span class="comment">//</span>
02940 
02941     <span class="keywordflow">if</span> (Fields &amp; TRIAGE_DUMP_PROCESS) {
02942         SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>));
02943 
02944         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02945             TriageDumpHeader-&gt;ProcessOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02946             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02947         }
02948     }
02949 
02950     <span class="comment">//</span>
02951     <span class="comment">// Set the Thread Offset, if necessary.</span>
02952     <span class="comment">//</span>
02953     
02954     <span class="keywordflow">if</span> (Fields &amp; TRIAGE_DUMP_THREAD) {
02955         SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<span class="keyword">sizeof</span> (<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>));
02956 
02957         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02958             TriageDumpHeader-&gt;ThreadOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02959             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02960         }
02961     }
02962 
02963     <span class="comment">//</span>
02964     <span class="comment">// Set the CallStack Offset, if necessary.</span>
02965     <span class="comment">//</span>
02966 
02967     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
02968 
02969     <span class="keywordflow">if</span> (Fields &amp; TRIAGE_DUMP_STACK) {
02970 
02971         <span class="comment">//</span>
02972         <span class="comment">// If there is a stack, calculate its size.</span>
02973         <span class="comment">//</span>
02974         
02975         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o44">KernelStackResident</a>) {
02976 
02977             ULONG_PTR StackBase;
02978 
02979             StackBase = (ULONG_PTR) Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a>;
02980 
02981             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( StackBase &gt; STACK_POINTER (Context));
02982             
02983             <span class="comment">//</span>
02984             <span class="comment">// There is a valid stack. Note that we limit the size of</span>
02985             <span class="comment">// the triage dump stack to MAX_TRIAGE_STACK_SIZE (currently</span>
02986             <span class="comment">// 16 KB).</span>
02987             <span class="comment">//</span>
02988 
02989             StartOfStackRegion = (ULONG_PTR) STACK_POINTER (Context);
02990             SizeOfSection = (ULONG) <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> ( StackBase -  (ULONG_PTR) STACK_POINTER (Context),
02991                                   <a class="code" href="../../d2/d3/dumpctl_8c.html#a8">MAX_TRIAGE_STACK_SIZE</a>
02992                                   );
02993 
02994             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( StartOfStackRegion + SizeOfSection &lt;= StackBase);
02995                 
02996         } <span class="keywordflow">else</span> {
02997 
02998             <span class="comment">//</span>
02999             <span class="comment">// There is not a valid stack.</span>
03000             <span class="comment">//</span>
03001 
03002             SizeOfSection = 0;
03003         }
03004 
03005         <span class="keywordflow">if</span> (SizeOfSection &amp;&amp; <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
03006             TriageDumpHeader-&gt;CallStackOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
03007             TriageDumpHeader-&gt;SizeOfCallStack = SizeOfSection;
03008             TriageDumpHeader-&gt;BaseOfStack = (ULONG) StartOfStackRegion;
03009             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
03010         }
03011     }
03012 
03013     <span class="comment">//</span>
03014     <span class="comment">// Set the Driver List Offset, if necessary.</span>
03015     <span class="comment">//</span>
03016     
03017     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a50">IopGetLoadedDriverInfo</a> (&amp;DriverCount, &amp;SizeOfStringData);
03018 
03019     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; Fields &amp; TRIAGE_DUMP_DRIVER_LIST) {
03020         SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (DriverCount * <span class="keyword">sizeof</span> (DUMP_DRIVER_ENTRY));
03021 
03022         <span class="keywordflow">if</span> (SizeOfSection &amp;&amp; (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>)) {
03023             TriageDumpHeader-&gt;DriverListOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
03024             TriageDumpHeader-&gt;DriverCount = DriverCount;
03025             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
03026         }
03027 
03028     } <span class="keywordflow">else</span> {
03029 
03030         SizeOfSection = 0;
03031         SizeOfStringData = 0;
03032     }
03033             
03034     <span class="comment">//</span>
03035     <span class="comment">// Set the String Pool offset.</span>
03036     <span class="comment">//</span>
03037 
03038     SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (SizeOfStringData +
03039                         DriverCount * (<span class="keyword">sizeof</span> (WCHAR) + <span class="keyword">sizeof</span> (DUMP_STRING)));
03040 
03041     <span class="keywordflow">if</span> (SizeOfSection &amp;&amp; (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>)) {
03042         TriageDumpHeader-&gt;StringPoolOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
03043         TriageDumpHeader-&gt;StringPoolSize = SizeOfSection;
03044         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
03045     }
03046 
03047 
03048     BytesToWrite = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
03049     BufferAddress = ((ULONG_PTR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> ;
03050 
03051     <span class="comment">//</span>
03052     <span class="comment">// Write the Mm information.</span>
03053     <span class="comment">//</span>
03054 
03055     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;MmOffset) {
03056 
03057         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;MmOffset);
03058         <a class="code" href="../../d2/d1/mm_8h.html#a238">MmWriteTriageInformation</a> (Address);
03059     }
03060 
03061     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;UnloadedDriversOffset) {
03062 
03063         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;UnloadedDriversOffset);
03064         <a class="code" href="../../d2/d1/mm_8h.html#a239">MmWriteUnloadedDriverInformation</a> (Address);
03065     }
03066 
03067     <span class="comment">//</span>
03068     <span class="comment">// Write the PRCB.</span>
03069     <span class="comment">//</span>
03070 
03071     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;PrcbOffset) {
03072 
03073         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;PrcbOffset);
03074         RtlCopyMemory (Address,
03075                        <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a> (),
03076                        <span class="keyword">sizeof</span> (KPRCB)
03077                        );
03078     }
03079 
03080     <span class="comment">//</span>
03081     <span class="comment">// Write the EPROCESS.</span>
03082     <span class="comment">//</span>
03083     
03084     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;ProcessOffset) {
03085     
03086         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;ProcessOffset);
03087         RtlCopyMemory (Address,
03088                        <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> (),
03089                        <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>)
03090                        );
03091     }
03092 
03093     <span class="comment">//</span>
03094     <span class="comment">// Write the ETHREAD.</span>
03095     <span class="comment">//</span>
03096     
03097     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;ThreadOffset) {
03098     
03099         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;ThreadOffset);
03100         RtlCopyMemory (Address,
03101                        <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a> (),
03102                        <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>)
03103                        );
03104     }
03105 
03106     <span class="comment">//</span>
03107     <span class="comment">// Write the Call Stack.</span>
03108     <span class="comment">//</span>
03109 
03110     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;CallStackOffset) {
03111 
03112         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread);
03113         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TriageDumpHeader-&gt;SizeOfCallStack != 0);
03114 
03115         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;CallStackOffset);
03116         RtlCopyMemory (Address,
03117                        (PVOID) StartOfStackRegion,
03118                        TriageDumpHeader-&gt;SizeOfCallStack
03119                        );
03120     }
03121 
03122     <span class="comment">//</span>
03123     <span class="comment">// Write the Driver List.</span>
03124     <span class="comment">//</span>
03125     
03126     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;DriverListOffset &amp;&amp;
03127         TriageDumpHeader-&gt;StringPoolOffset) {
03128 
03129         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a51">IopWriteDriverList</a> (BufferAddress,
03130                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
03131                                      TriageDumpHeader-&gt;DriverListOffset,
03132                                      TriageDumpHeader-&gt;StringPoolOffset
03133                                      );
03134 
03135         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03136             TriageDumpHeader-&gt;DriverListOffset = 0;
03137         }
03138     }
03139 
03140     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BytesToWrite &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
03141     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a> (BytesToWrite, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
03142 
03143     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((3, <span class="stringliteral">"TRIAGEDUMP: Calling IopWriteToDisk with:\n"</span>
03144                    <span class="stringliteral">"\tBytesToWrite = %#x\n"</span>
03145                    <span class="stringliteral">"\tBytesToWrite (Aligned) = %#x\n"</span>
03146                    <span class="stringliteral">"\tBufferSize = %#x\n"</span>,
03147                     BytesToWrite,
03148                     <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a> (BytesToWrite, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>),
03149                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>));
03150 
03151 
03152     <span class="comment">//</span>
03153     <span class="comment">// Write the valid status to the end of the dump.</span>
03154     <span class="comment">//</span>
03155 
03156     *((ULONG *)<a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>)) = TRIAGE_DUMP_VALID ;
03157 
03158     <span class="comment">//</span>
03159     <span class="comment">// Re-adjust the buffer size.</span>
03160     <span class="comment">//</span>
03161     
03162     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> += <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
03163 
03164     <span class="comment">//</span>
03165     <span class="comment">// NOTE: This routine writes the entire buffer, even if it is not</span>
03166     <span class="comment">// all required.</span>
03167     <span class="comment">//</span>
03168 
03169     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a22">IopWriteToDisk</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
03170                              <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
03171                              DriverWriteRoutine,
03172                              &amp;Mcb,
03173                              Mdl,
03174                              DriverTransferSize
03175                              );
03176 
03177     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03178 }
03179 
03180 
03181 
03182 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03183"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a53">03183</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a53">IopWritePageToDisk</a>(
03184     IN PDUMP_DRIVER_WRITE DriverWrite,
03185     IN OUT PLARGE_INTEGER * McbBuffer,
03186     IN OUT ULONG DriverTransferSize,
03187     IN PFN_NUMBER PageFrameIndex
03188     )
03189 
03190 <span class="comment">/*++</span>
03191 <span class="comment"></span>
03192 <span class="comment">Routine Description:</span>
03193 <span class="comment"></span>
03194 <span class="comment">    Write the page described by PageFrameIndex to the disk/file (DriverWrite,</span>
03195 <span class="comment">    McbBuffer) and update the MCB buffer to reflect the new position in the</span>
03196 <span class="comment">    file.</span>
03197 <span class="comment">    </span>
03198 <span class="comment">Arguments:</span>
03199 <span class="comment"></span>
03200 <span class="comment">    DriverWrite - The driver write routine.</span>
03201 <span class="comment"></span>
03202 <span class="comment">    McbBuffer - A pointer to the MCB array. This array is terminated by</span>
03203 <span class="comment">            a zero-length MCB entry. On success, this pointer is updated</span>
03204 <span class="comment">            to reflect the new position in the MCB array.</span>
03205 <span class="comment"></span>
03206 <span class="comment">            NB: MCB[0] is the size and MCB[1] is the offset.</span>
03207 <span class="comment"></span>
03208 <span class="comment">    DriverTransferSize - The maximum transfer size for this driver.</span>
03209 <span class="comment"></span>
03210 <span class="comment">    PageFrameIndex - The page to be written.</span>
03211 <span class="comment"></span>
03212 <span class="comment">Return Values:</span>
03213 <span class="comment"></span>
03214 <span class="comment">    NTSTATUS code.</span>
03215 <span class="comment"></span>
03216 <span class="comment">--*/</span>
03217 
03218 {
03219     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03220     PFN_NUMBER MdlHack [ (<span class="keyword">sizeof</span> (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) / <span class="keyword">sizeof</span> (PFN_NUMBER)) + 1];
03221     PPFN_NUMBER PfnArray;
03222     PLARGE_INTEGER Mcb;
03223     ULONG ByteCount;
03224     ULONG ByteOffset;
03225     ULONG BytesToWrite;
03226     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> TempMdl;
03227 
03228 
03229     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( DriverWrite );
03230     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( McbBuffer );
03231     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( DriverTransferSize &amp;&amp; DriverTransferSize &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> );
03232 
03233     <span class="comment">//</span>
03234     <span class="comment">// Initialization</span>
03235     <span class="comment">//</span>
03236 
03237     TempMdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) &amp;MdlHack;
03238     Mcb = *McbBuffer;
03239     BytesToWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03240 
03241 
03242     <span class="comment">//</span>
03243     <span class="comment">// Initialze the MDL to point to this page.</span>
03244     <span class="comment">//</span>
03245     
03246     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a> (TempMdl, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03247 
03248     PfnArray = <a class="code" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a> ( TempMdl );
03249     PfnArray[0] = PageFrameIndex;
03250 
03251 
03252     <span class="comment">//</span>
03253     <span class="comment">// We loop for the cases when the space remaining in this block (Mcb [0])</span>
03254     <span class="comment">// is less than one page. Generally the Mcb will be large enough to hold</span>
03255     <span class="comment">// the entire page and this loop will only be executed once. When Mcb[0]</span>
03256     <span class="comment">// is less than a page, we will write the first part of the page to this</span>
03257     <span class="comment">// Mcb then increment the Mcb and write the remaining part to the next</span>
03258     <span class="comment">// page.</span>
03259     <span class="comment">//</span>
03260     
03261     ByteOffset = 0;
03262 
03263     <span class="keywordflow">while</span> ( BytesToWrite ) {
03264 
03265         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( Mcb[0].QuadPart != 0 );
03266         
03267         ByteCount = (ULONG) <a class="code" href="../../d2/d3/dumpctl_8c.html#a0">min3</a> ((LONGLONG) BytesToWrite,
03268                                   (LONGLONG) DriverTransferSize,
03269                                   Mcb[0].QuadPart
03270                                   );
03271 
03272         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( ByteCount != 0 );
03273 
03274         <span class="comment">//</span>
03275         <span class="comment">// Update the MDL byte count and byte offset. </span>
03276         <span class="comment">//</span>
03277         
03278         TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = ByteCount;
03279         TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o7">ByteOffset</a> = ByteOffset;
03280 
03281         <span class="comment">//</span>
03282         <span class="comment">// Map the MDL. The flags are updated to show that MappedSsytemVa is</span>
03283         <span class="comment">// valid, which should probably be done in MmMapMemoryDumpMdl.</span>
03284         <span class="comment">//</span>
03285         
03286         <a class="code" href="../../d5/d6/iosup_8c.html#a82">MmMapMemoryDumpMdl</a> ( TempMdl );
03287         TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= ( <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a> );
03288         TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>);
03289         
03290         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = DriverWrite ( &amp;Mcb[1], TempMdl );
03291 
03292 
03293         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03294             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03295         }
03296 
03297         BytesToWrite -= ByteCount;
03298         ByteOffset += ByteCount;
03299         
03300         Mcb[0].QuadPart -= ByteCount;
03301         Mcb[1].QuadPart += ByteCount;
03302 
03303 
03304         <span class="comment">//</span>
03305         <span class="comment">// If there is no more room for this MCB, go to the next one.</span>
03306         <span class="comment">//</span>
03307         
03308         <span class="keywordflow">if</span> ( Mcb[0].QuadPart == 0 ) {
03309 
03310             Mcb += 2;
03311 
03312             <span class="comment">//</span>
03313             <span class="comment">// We have filled up all the space in the paging file. </span>
03314             <span class="comment">//</span>
03315             
03316             <span class="keywordflow">if</span> ( Mcb[0].QuadPart == 0) {
03317                 <span class="keywordflow">return</span> STATUS_END_OF_FILE;
03318             }
03319         }
03320     }
03321 
03322     *McbBuffer = Mcb;
03323 
03324     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03325 }
03326 
03327 
03328 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03329"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a54">03329</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a54">IopWriteSummaryDump</a>(
03330     IN PRTL_BITMAP PageMap,
03331     IN PDUMP_DRIVER_WRITE DriverWriteRoutine,
03332     IN PANSI_STRING ProgressMessage,
03333     IN PUCHAR MessageBuffer,
03334     IN OUT PLARGE_INTEGER Mcb,
03335     IN OUT ULONG DriverTransferSize
03336     )
03337 
03338 <span class="comment">/*++</span>
03339 <span class="comment"></span>
03340 <span class="comment">Routine Description:</span>
03341 <span class="comment"></span>
03342 <span class="comment">    Write a summary dump to the disk.</span>
03343 <span class="comment"></span>
03344 <span class="comment">Arguments:</span>
03345 <span class="comment"></span>
03346 <span class="comment"></span>
03347 <span class="comment">    PageMap - A bitmap of the pages that need to be written.</span>
03348 <span class="comment"></span>
03349 <span class="comment">    DriverWriteRoutine - The driver's write routine.</span>
03350 <span class="comment"></span>
03351 <span class="comment">    ProgressMessage - The "Percent Complete" message.</span>
03352 <span class="comment"></span>
03353 <span class="comment">    MessageBuffer - A message buffer we can use to update percentage complete</span>
03354 <span class="comment">            status.</span>
03355 <span class="comment"></span>
03356 <span class="comment">    Mcb - Message Control Block where the data is to be written.</span>
03357 <span class="comment"></span>
03358 <span class="comment">    DriverTransferSize - The maximum transfer size for the driver.</span>
03359 <span class="comment"></span>
03360 <span class="comment">Return Values:</span>
03361 <span class="comment"></span>
03362 <span class="comment">    NTSTATUS code.</span>
03363 <span class="comment"></span>
03364 <span class="comment">--*/</span>
03365 
03366 {
03367     PVOID Va;
03368     PFN_NUMBER PageFrameIndex;
03369     PHYSICAL_ADDRESS PhysicalAddress;
03370     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03371 
03372     ULONG WriteCount;
03373     ULONG MaxWriteCount;
03374     ULONG Step;
03375     
03376 
03377     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( DriverWriteRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03378     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( Mcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03379     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( DriverTransferSize != 0 );
03380     
03381 
03382     MaxWriteCount = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a> ( PageMap );
03383     Step = MaxWriteCount / 100;
03384 
03385     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((1, <span class="stringliteral">"IODUMP: Summary Dump\n"</span>
03386                      <span class="stringliteral">"  Writing %x pages to disk from a total of %x\n"</span>,
03387                   MaxWriteCount,
03388                   PageMap-&gt;SizeOfBitMap));
03389 
03390     <span class="comment">//</span>
03391     <span class="comment">// Loop over all pages in the system and write those that are set</span>
03392     <span class="comment">// in the bitmap.</span>
03393     <span class="comment">//</span>
03394 
03395     WriteCount = 0;
03396     <span class="keywordflow">for</span> ( PageFrameIndex = 0;
03397           PageFrameIndex &lt; PageMap-&gt;SizeOfBitMap;
03398           PageFrameIndex++) {
03399 
03400 
03401         <span class="comment">//</span>
03402         <span class="comment">// If this page needs to be included in the dump file.</span>
03403         <span class="comment">//</span>
03404         
03405         <span class="keywordflow">if</span> ( RtlCheckBit (PageMap, PageFrameIndex) ) {
03406 
03407             <span class="keywordflow">if</span> (++WriteCount % Step == 0) {
03408 
03409                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (MessageBuffer,
03410                          <span class="stringliteral">"%Z: %3d\r"</span>,
03411                          ProgressMessage,
03412                          (WriteCount * 100) / MaxWriteCount);
03413 
03414                 <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a> ( MessageBuffer );
03415             }
03416 
03417             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( WriteCount &lt;= MaxWriteCount );
03418 
03419             <span class="comment">//</span>
03420             <span class="comment">// Write the page to disk.</span>
03421             <span class="comment">//</span>
03422             
03423             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a53">IopWritePageToDisk</a> (
03424                             DriverWriteRoutine,
03425                             &amp;Mcb,
03426                             DriverTransferSize,
03427                             PageFrameIndex
03428                             );
03429             
03430             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03431 
03432                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03433             }
03434         }
03435     }
03436 
03437     <span class="keywordflow">return</span> STATUS_SUCCESS;
03438 }
03439 
03440 
03441 PSUMMARY_DUMP_HEADER
<a name="l03442"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a26">03442</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a26">IopInitializeSummaryDump</a>(
03443     IN <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> pDcb
03444     )
03445 <span class="comment">/*++</span>
03446 <span class="comment"></span>
03447 <span class="comment">Routine Description:</span>
03448 <span class="comment"></span>
03449 <span class="comment">    This routine creates a summary dump header. In particular it initializes</span>
03450 <span class="comment">    a bitmap that contains a map of kernel memory.</span>
03451 <span class="comment"></span>
03452 <span class="comment">Arguments:</span>
03453 <span class="comment"></span>
03454 <span class="comment">    PDUMP_CONTROL_BLOCK - A pointer to the dump control block.</span>
03455 <span class="comment"></span>
03456 <span class="comment">Return Value:</span>
03457 <span class="comment"></span>
03458 <span class="comment">    Non-NULL - A pointer to the summary dump header</span>
03459 <span class="comment"></span>
03460 <span class="comment">    NULL - Error</span>
03461 <span class="comment"></span>
03462 <span class="comment">--*/</span>
03463 {
03464     PULONG                  pdwBlock;
03465     PSUMMARY_DUMP_HEADER    pSummaryHeader;
03466     ULONG                   dwActualPages;
03467 
03468     <span class="comment">//</span>
03469     <span class="comment">// Get the dump header page.</span>
03470     <span class="comment">//</span>
03471 
03472     pdwBlock = pDcb-&gt;HeaderPage;
03473 
03474     <span class="comment">//</span>
03475     <span class="comment">// The summary dump starts 1 page after the header.</span>
03476     <span class="comment">//</span>
03477 
03478     pSummaryHeader = (PSUMMARY_DUMP_HEADER)&amp;pdwBlock[ DH_SUMMARY_DUMP_RECORD ];
03479 
03480     <span class="comment">//</span>
03481     <span class="comment">// Fill the header with signatures.</span>
03482     <span class="comment">//</span>
03483     RtlFillMemoryUlong( pSummaryHeader,
03484                         <span class="keyword">sizeof</span>(SUMMARY_DUMP_HEADER),
03485                         'PMDS' );
03486 
03487     <span class="comment">//</span>
03488     <span class="comment">// Set the size and valid signature.</span>
03489     <span class="comment">//</span>
03490     
03491     pSummaryHeader-&gt;BitmapSize = (ULONG)( <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>-1].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>  +
03492                                       <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>-1].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> );
03493     pSummaryHeader-&gt;ValidDump = 'PMUD';
03494 
03495     <span class="comment">//</span>
03496     <span class="comment">// Construct the kernel memory bitmap.</span>
03497     <span class="comment">//</span>
03498     
03499     dwActualPages = <a class="code" href="../../d2/d3/dumpctl_8c.html#a29">IopCreateSummaryDump</a>(pSummaryHeader);
03500 
03501     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IopInitializeSummaryDump]: Kernel Pages = %x\n"</span>,dwActualPages));
03502 
03503     <span class="keywordflow">if</span> (!dwActualPages) {
03504         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03505     }
03506 
03507     <span class="comment">//</span>
03508     <span class="comment">// Set the actual number of physical pages in the summary dump</span>
03509     <span class="comment">//</span>
03510     
03511     pSummaryHeader-&gt;Pages = dwActualPages;
03512     pSummaryHeader-&gt;HeaderSize = pDcb-&gt;HeaderSize;
03513 
03514     <span class="keywordflow">return</span> pSummaryHeader;
03515 }
03516 
03517 
03518 
03519 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03520"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a27">03520</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a27">IopWriteSummaryHeader</a>(
03521     IN PSUMMARY_DUMP_HEADER    pSummaryHeader,
03522     IN PDUMP_DRIVER_WRITE      pfWrite,
03523     IN OUT PLARGE_INTEGER *    McbBuffer,
03524     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>                pMdl,
03525     IN ULONG                   dwWriteSize,
03526     IN ULONG                   dwLength
03527     )
03528 <span class="comment">/*++</span>
03529 <span class="comment"></span>
03530 <span class="comment">Routine Description:</span>
03531 <span class="comment"></span>
03532 <span class="comment">    Write the summary dump header to the dump file.</span>
03533 <span class="comment"></span>
03534 <span class="comment">Arguments:</span>
03535 <span class="comment"></span>
03536 <span class="comment">    pSummaryHeader - pointer to the summary dump bitmap</span>
03537 <span class="comment"></span>
03538 <span class="comment">    pfWrite - dump driver write function</span>
03539 <span class="comment"></span>
03540 <span class="comment">    McbBuffer - pointer to the MCB array.</span>
03541 <span class="comment"></span>
03542 <span class="comment">    pMdl - Pointer to an MDL</span>
03543 <span class="comment"></span>
03544 <span class="comment">    dwWriteSize - the max transfer size for the dump driver</span>
03545 <span class="comment"></span>
03546 <span class="comment">    dwLength - the length of this transfer</span>
03547 <span class="comment"></span>
03548 <span class="comment">Return Value:</span>
03549 <span class="comment"></span>
03550 <span class="comment">    Updated MCB</span>
03551 <span class="comment"></span>
03552 <span class="comment">--*/</span>
03553 {
03554     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03555     ULONG       dwBytesRemaining;
03556     ULONG_PTR   dwMemoryAddress;
03557     ULONG       dwByteOffset;
03558     ULONG       dwByteCount;
03559     PLARGE_INTEGER pMcb;
03560 
03561     dwBytesRemaining = dwLength;
03562     dwMemoryAddress = (ULONG_PTR) pSummaryHeader;
03563     pMcb = *McbBuffer;
03564 
03565     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> (( 0, <span class="stringliteral">"IoWriteCrashDump: Writing SUMMARY dump header to disk\n"</span> ));
03566 
03567     <span class="keywordflow">while</span> (dwBytesRemaining) {
03568 
03569         <span class="comment">// Calculate byte offset</span>
03570         dwByteOffset = (ULONG)(dwMemoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
03571 
03572         <span class="comment">//</span>
03573         <span class="comment">// See if the number of bytes to write is greator than the crash</span>
03574         <span class="comment">// drives max transfer.</span>
03575         <span class="comment">//</span>
03576         
03577         <span class="keywordflow">if</span> (dwBytesRemaining &lt;= dwWriteSize) {
03578             dwByteCount = dwBytesRemaining;
03579         } <span class="keywordflow">else</span> {
03580             dwByteCount = dwWriteSize;
03581         }
03582 
03583         <span class="comment">//</span>
03584         <span class="comment">// If the byteCount is greater than the remaining mcb then correct it.</span>
03585         <span class="comment">//</span>
03586         
03587         <span class="keywordflow">if</span> (dwByteCount &gt; pMcb[0].QuadPart) {
03588             dwByteCount = pMcb[0].LowPart;
03589         }
03590 
03591         pMdl-&gt;ByteCount      = dwByteCount;
03592         pMdl-&gt;ByteOffset     = dwByteOffset;
03593         pMdl-&gt;MappedSystemVa = (PVOID) dwMemoryAddress;
03594 
03595         <span class="comment">//</span>
03596         <span class="comment">// Get the actual physical frame and create an mdl.</span>
03597         <span class="comment">//</span>
03598         
03599         <a class="code" href="../../d2/d3/dumpctl_8c.html#a28">IopMapVirtualToPhysicalMdl</a>(pMdl, dwMemoryAddress, dwByteCount);
03600 
03601         <span class="comment">//</span>
03602         <span class="comment">// Write to disk.</span>
03603         <span class="comment">//</span>
03604         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = pfWrite( &amp;pMcb[1], pMdl );
03605 
03606         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
03607             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03608         }
03609 
03610         <span class="comment">//</span>
03611         <span class="comment">// Adjust bytes remaining.</span>
03612         <span class="comment">//</span>
03613 
03614         dwBytesRemaining -= dwByteCount;
03615         dwMemoryAddress  += dwByteCount;
03616 
03617         pMcb[0].QuadPart = pMcb[0].QuadPart - dwByteCount;
03618         pMcb[1].QuadPart = pMcb[1].QuadPart + dwByteCount;
03619 
03620         <span class="keywordflow">if</span> (pMcb[0].QuadPart == 0) {
03621             pMcb += 2;
03622         }
03623 
03624         <span class="keywordflow">if</span> (pMcb[0].QuadPart == 0) {
03625             <span class="keywordflow">return</span> STATUS_END_OF_FILE;
03626         }
03627     }
03628 
03629     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"IoWriteCrashDump: Writing SUMMARY dump header to disk\n"</span> ));
03630 
03631     *McbBuffer = pMcb;
03632     <span class="keywordflow">return</span> STATUS_SUCCESS;
03633 }
03634 
03635 
03636 
03637 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03638"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a22">03638</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a22">IopWriteToDisk</a>(
03639     IN PVOID Buffer,
03640     IN ULONG WriteLength,
03641     IN PDUMP_DRIVER_WRITE DriverWriteRoutine,
03642     IN OUT PLARGE_INTEGER * McbBuffer,
03643     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
03644     IN ULONG DriverTransferSize
03645     )
03646 <span class="comment">/*++</span>
03647 <span class="comment"></span>
03648 <span class="comment">Routine Description:</span>
03649 <span class="comment"></span>
03650 <span class="comment">    Write the summary dump header to the dump file.</span>
03651 <span class="comment"></span>
03652 <span class="comment">Arguments:</span>
03653 <span class="comment"></span>
03654 <span class="comment">    Buffer - Pointer to the buffer to write.</span>
03655 <span class="comment"></span>
03656 <span class="comment">    WriteLength - The length of this transfer.</span>
03657 <span class="comment"></span>
03658 <span class="comment">    DriverWriteRoutine - Dump driver write function.</span>
03659 <span class="comment"></span>
03660 <span class="comment">    McbBuffer - Pointer to the dump file Mapped Control Block.</span>
03661 <span class="comment"></span>
03662 <span class="comment">    Mdl - Pointer to an MDL.</span>
03663 <span class="comment"></span>
03664 <span class="comment">    DriverTransferSize - The max transfer size for the dump driver.</span>
03665 <span class="comment"></span>
03666 <span class="comment"></span>
03667 <span class="comment">Return Value:</span>
03668 <span class="comment"></span>
03669 <span class="comment"></span>
03670 <span class="comment">--*/</span>
03671 {
03672     ULONG dwBytesRemaining;
03673     ULONG_PTR dwMemoryAddress;
03674     ULONG dwByteOffset;
03675     ULONG dwByteCount;
03676     PLARGE_INTEGER Mcb;
03677 
03678     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
03679     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WriteLength);
03680     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverWriteRoutine);
03681     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (McbBuffer &amp;&amp; *McbBuffer);
03682     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Mdl);
03683     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverTransferSize &gt;= <a class="code" href="../../d2/d3/dumpctl_8c.html#a2">IO_DUMP_MINIMUM_TRANSFER_SIZE</a> &amp;&amp;
03684             DriverTransferSize &lt;= <a class="code" href="../../d2/d3/dumpctl_8c.html#a1">IO_DUMP_MAXIMUM_TRANSFER_SIZE</a>);
03685     
03686 
03687     Mcb = *McbBuffer;
03688     dwBytesRemaining = WriteLength;
03689     dwMemoryAddress = (ULONG_PTR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
03690 
03691     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>(( 2, <span class="stringliteral">"IoWriteToDisk: Writing %d bytes to disk.\n"</span>, WriteLength ));
03692 
03693     <span class="keywordflow">while</span> (dwBytesRemaining) {
03694 
03695         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Mcb [0].QuadPart != 0);
03696         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a> &lt;= Mcb &amp;&amp;
03697                 (LPBYTE) Mcb &lt; (LPBYTE) IopDumpControlBlock-&gt;FileDescriptorArray +
03698                                <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o10">FileDescriptorSize</a>
03699                 );
03700         
03701         dwByteOffset = <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (dwMemoryAddress);
03702 
03703         <span class="comment">//</span>
03704         <span class="comment">// See if the number of bytes to write is greator than the crash</span>
03705         <span class="comment">// drives max transfer.</span>
03706         <span class="comment">//</span>
03707 
03708         dwByteCount = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> ( dwBytesRemaining, DriverTransferSize );
03709 
03710         <span class="comment">//</span>
03711         <span class="comment">// If the byteCount is greater than the remaining mcb then correct it.</span>
03712         <span class="comment">//</span>
03713         
03714         <span class="keywordflow">if</span> (dwByteCount &gt; Mcb[0].QuadPart) {
03715             dwByteCount = Mcb[0].LowPart;
03716         }
03717 
03718         Mdl-&gt;ByteCount = dwByteCount;
03719         Mdl-&gt;ByteOffset = dwByteOffset;
03720         Mdl-&gt;MappedSystemVa = (PVOID) dwMemoryAddress;
03721 
03722         <span class="comment">//</span>
03723         <span class="comment">// Get the actual physical frame and create an mdl.</span>
03724         <span class="comment">//</span>
03725         
03726         <a class="code" href="../../d2/d3/dumpctl_8c.html#a28">IopMapVirtualToPhysicalMdl</a>(Mdl, dwMemoryAddress, dwByteCount);
03727 
03728         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( DriverWriteRoutine ( &amp;Mcb[1], Mdl ) )) {
03729             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((1, <span class="stringliteral">"IopWriteToDisk: Failed write.\n"</span>));
03730             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03731         }
03732 
03733         <span class="comment">//</span>
03734         <span class="comment">// Adjust bytes remaining.</span>
03735         <span class="comment">//</span>
03736 
03737         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (dwBytesRemaining &gt;= dwByteCount);
03738         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (dwByteCount != 0);
03739         
03740         dwBytesRemaining -= dwByteCount;
03741         dwMemoryAddress  += dwByteCount;
03742 
03743         Mcb[0].QuadPart -= dwByteCount;
03744         Mcb[1].QuadPart += dwByteCount;
03745         
03746         <span class="keywordflow">if</span> (Mcb[0].QuadPart == 0) {
03747             Mcb += 2;
03748         }
03749     }
03750 
03751     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((2, <span class="stringliteral">"IopWriteToDisk: Successfully wrote %d bytes.\n"</span>, WriteLength));
03752 
03753     *McbBuffer = Mcb;
03754     <span class="keywordflow">return</span> STATUS_SUCCESS;
03755 }
03756 
03757 
03758 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03759"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a28">03759</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a28">IopMapVirtualToPhysicalMdl</a>(
03760     IN OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> pMdl,
03761     IN ULONG_PTR dwMemoryAddress,
03762     IN ULONG    dwLength
03763     )
03764 {
03765     PPFN_NUMBER  pdwPage;
03766     ULONG   dwPages;
03767     ULONG   dwBase;
03768     ULONG   dwCurrentBase;
03769     ULONG_PTR dwBaseVa;
03770     PHYSICAL_ADDRESS PhysicalAddress;
03771 
03772     <span class="comment">//</span>
03773     <span class="comment">// Begin by determining the base physical page of the start of the address</span>
03774     <span class="comment">// range and filling in the MDL appropriately.</span>
03775     <span class="comment">//</span>
03776 
03777     pMdl-&gt;StartVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>((PVOID)dwMemoryAddress);
03778     pMdl-&gt;ByteOffset= (ULONG)(dwMemoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
03779     pMdl-&gt;ByteCount = dwLength;
03780     dwBaseVa = dwMemoryAddress &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> -1);
03781     pMdl-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>;
03782 
03783     <span class="comment">//</span>
03784     <span class="comment">// Compute the number of pages spanned</span>
03785     <span class="comment">//</span>
03786 
03787     dwPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a>( dwMemoryAddress, dwLength );
03788     pdwPage = <a class="code" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a>(pMdl);
03789 
03790     <span class="comment">//</span>
03791     <span class="comment">// Map all of the pages for this transfer until there are no more remaining</span>
03792     <span class="comment">// to be mapped.</span>
03793     <span class="comment">//</span>
03794     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((3,<span class="stringliteral">"MapVirtualToPhysical: VA: %08x off: %08x Len:%08x base: %08x \n"</span>,pMdl-&gt;StartVa,pMdl-&gt;ByteOffset,pMdl-&gt;ByteCount,dwBaseVa));
03795 
03796     <span class="keywordflow">while</span> (dwPages) {
03797         PhysicalAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>( (PVOID)dwBaseVa );
03798         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>( (3,<span class="stringliteral">"Physical Frame: %08x Adr: %08x\n"</span>,( PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),dwBaseVa ) );
03799         *pdwPage++  = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03800         dwBaseVa    +=<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03801         dwPages--;
03802     }
03803 
03804     <span class="comment">//</span>
03805     <span class="comment">// All of the PFNs for the address range have been filled in so map the</span>
03806     <span class="comment">// physical memory into virtual address space using crash dump PTE.</span>
03807     <span class="comment">//</span>
03808 
03809 <span class="comment">//    MmMapMemoryDumpMdl( pMdl );</span>
03810 }
03811 
03812 
03813 
03814 ULONG
<a name="l03815"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a29">03815</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a29">IopCreateSummaryDump</a> (
03816     IN PSUMMARY_DUMP_HEADER pHeader
03817     )
03818 <span class="comment">/*++</span>
03819 <span class="comment"></span>
03820 <span class="comment">Routine Description:</span>
03821 <span class="comment"></span>
03822 <span class="comment">    This routine determines the kernel memory and data structures to include</span>
03823 <span class="comment">    in the summary memory dump.</span>
03824 <span class="comment"></span>
03825 <span class="comment">    NOTE: This function uses MmGetPhysicalAddress. MmGetPhysicalAddress does</span>
03826 <span class="comment">    not acquire any locks. It uses a set of macros for translation.</span>
03827 <span class="comment"></span>
03828 <span class="comment"></span>
03829 <span class="comment">Arguments:</span>
03830 <span class="comment"></span>
03831 <span class="comment">    pHeader - Pointer to the dump header</span>
03832 <span class="comment"></span>
03833 <span class="comment">    pDcb - Dump control block</span>
03834 <span class="comment">    </span>
03835 <span class="comment">Return Value:</span>
03836 <span class="comment"></span>
03837 <span class="comment">    Status</span>
03838 <span class="comment"></span>
03839 <span class="comment">--*/</span>
03840 {
03841     PRTL_BITMAP             pBitMapHeader = (PRTL_BITMAP)(pHeader+1);
03842     ULONG                   Pages;
03843     PCHAR                   VA;
03844     ULONG                   UserPages;
03845     PHYSICAL_ADDRESS        PhyAddr;
03846     ULONG                   i;
03847     PULONG                  pBitMapBuffer;
03848     PUCHAR                  pBitMapBytes;
03849     LARGE_INTEGER           dumpFileSize;
03850     PULONG                  block;
03851     ULONG                   numDumpPages;
03852 
03853     <span class="comment">//</span>
03854     <span class="comment">// The bitmap is the last structure in the header. The</span>
03855     <span class="comment">// buffer is allocated directly after the bitmap header.</span>
03856     <span class="comment">//</span>
03857     <span class="comment">// Initialize Bit Map, set the size and buffer address.</span>
03858     <span class="comment">//</span>
03859     
03860     pBitMapHeader-&gt;SizeOfBitMap = pHeader-&gt;BitmapSize;
03861     pBitMapBuffer = (PULONG)( pBitMapHeader + 1);
03862     pBitMapHeader-&gt;Buffer = pBitMapBuffer;
03863     pBitMapBytes = (PUCHAR)pBitMapBuffer;
03864 
03865     <span class="comment">//</span>
03866     <span class="comment">// Clear all bits</span>
03867     <span class="comment">//</span>
03868 
03869     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (pBitMapHeader);
03870 
03871     <span class="comment">//</span>
03872     <span class="comment">// Have MM initialize the kernel memory to dump</span>
03873     <span class="comment">//</span>
03874     
03875     <a class="code" href="../../d5/d6/iosup_8c.html#a91">MmSetKernelDumpRange</a>(pHeader);
03876 
03877     <span class="comment">//</span>
03878     <span class="comment">// Exclude non-existent memory</span>
03879     <span class="comment">//</span>
03880     
03881     <a class="code" href="../../d2/d3/dumpctl_8c.html#a30">IopDeleteNonExistentMemory</a>(pHeader, <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>);
03882 
03883 
03884     Pages = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a> ( pBitMapHeader );
03885     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopLocalSetBits =       %x\n"</span>,Pages));
03886 
03887     <span class="comment">//</span>
03888     <span class="comment">// See If we have room to Include user va for the current process</span>
03889     <span class="comment">//</span>
03890     
03891     block = <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>;
03892     dumpFileSize.LowPart= block [DH_REQUIRED_DUMP_SPACE];
03893     dumpFileSize.HighPart= block [DH_REQUIRED_DUMP_SPACE + 1];
03894 
03895     dumpFileSize.QuadPart -= <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a>;
03896 
03897     <span class="comment">//</span>
03898     <span class="comment">// Total physical pages will not exceed 2&lt;&lt;32 for sometime</span>
03899     <span class="comment">//</span>
03900     
03901     numDumpPages= (ULONG)(dumpFileSize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03902     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((2,<span class="stringliteral">"IopCreateSummaryDump: numDumpPages: %x Pages : %x\n"</span>, numDumpPages,Pages));
03903 
03904     <span class="comment">//</span>
03905     <span class="comment">// Only copy user virtual if there is enough room in the dump file.</span>
03906     <span class="comment">//</span>
03907     
03908     UserPages = 0;
03909 
03910     <span class="keywordflow">if</span> (Pages &lt; numDumpPages ) {
03911 
03912         <span class="comment">//</span>
03913         <span class="comment">// Stride through user VA and include all valid pages</span>
03914         <span class="comment">//</span>
03915 
03916         <span class="keywordflow">for</span> (VA = 0; VA &lt; (PCHAR)<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a>; VA+=<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> ) {
03917 
03918             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>( VA ) ) {
03919 
03920                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d3/dumpctl_8c.html#a48">IoSetDumpRange</a>(pHeader,VA, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ) ) {
03921 
03922                     UserPages++;
03923 
03924                     <span class="comment">//</span>
03925                     <span class="comment">// Break if there is no more room in the dump file</span>
03926                     <span class="comment">//</span>
03927 
03928                     <span class="keywordflow">if</span> (UserPages+Pages &gt;= numDumpPages ) {
03929                         <span class="keywordflow">break</span>;
03930                     }
03931                 }
03932             }
03933         }
03934 
03935     }
03936 
03937     Pages+= UserPages;
03938 
03939     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopCreateSummaryDump number of user mode pages = %x\n"</span>,UserPages));
03940 
03941     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"SummaryDump: Dump SummaryDumpHeader\n"</span>));
03942     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"SdBitmapSize      =%x\n"</span>, pHeader-&gt;BitmapSize));
03943     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"SdAllBits         =%x\n"</span>, Pages));
03944     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"&amp;SdBitmapBuffer[0]=%x\n"</span>, pBitMapHeader-&gt;Buffer));
03945 
03946 
03947     <span class="keywordflow">return</span> Pages;
03948 
03949 }
03950 
03951 
03952 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03953"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a30">03953</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a30">IopDeleteNonExistentMemory</a>(
03954     PSUMMARY_DUMP_HEADER pHeader,
03955     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> MmPhysicalMemoryBlock
03956     )
03957 <span class="comment">/*++</span>
03958 <span class="comment"></span>
03959 <span class="comment">Routine Description:</span>
03960 <span class="comment"></span>
03961 <span class="comment">    This deletes non existent memory. Non existent memory is defined as the</span>
03962 <span class="comment">    unassigned memory between memory runs. For example, memory between</span>
03963 <span class="comment">    (run[0].base + size) and run[1].base.</span>
03964 <span class="comment">    </span>
03965 <span class="comment">Arguments:</span>
03966 <span class="comment"></span>
03967 <span class="comment">    pHeader - This is a pointer to the summary dump header.</span>
03968 <span class="comment">    </span>
03969 <span class="comment">    dwStartingIndex - The starting bit index in the bitmap (starting page).</span>
03970 <span class="comment"></span>
03971 <span class="comment">    dwMemoryAddress - Pseudo-virtual address being mapped.</span>
03972 <span class="comment"></span>
03973 <span class="comment">    dwByteCount - The number of bytes to copy.</span>
03974 <span class="comment"></span>
03975 <span class="comment">    dwMaxBitmapBit - The limit or the highest possible valid bit in the bitmap.</span>
03976 <span class="comment"></span>
03977 <span class="comment">    pMdl - The MDL to create.</span>
03978 <span class="comment"></span>
03979 <span class="comment">Return Value:</span>
03980 <span class="comment"></span>
03981 <span class="comment">    (none)</span>
03982 <span class="comment">    </span>
03983 <span class="comment">--*/</span>
03984 {
03985     <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a>    Run;
03986     ULONG                   NumberOfRuns;
03987     ULONG                   i;
03988     PFN_NUMBER              CurrentPageFrame, NextPageFrame;
03989     PRTL_BITMAP             pBitMapHeader;
03990 
03991     NumberOfRuns            = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>;
03992 
03993     Run = &amp;<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0];
03994 
03995     pBitMapHeader = (PRTL_BITMAP)(pHeader + 1);
03996     i = 0;
03997 
03998     CurrentPageFrame = 1;
03999 
04000     NextPageFrame = Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
04001 
04002     <span class="comment">//</span>
04003     <span class="comment">// Remove the gap from 0 till the first run.</span>
04004     <span class="comment">//</span>
04005     
04006     <span class="keywordflow">if</span> (NextPageFrame &gt; CurrentPageFrame) {
04007 
04008         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>( (2,<span class="stringliteral">"DeleteNonExistentMemory: %x - %x\n"</span>,
04009             CurrentPageFrame,
04010             (NextPageFrame - CurrentPageFrame) ) );
04011 
04012         <span class="comment">//</span>
04013         <span class="comment">// FIXFIX - handle page frame numbers greater than 32 bits.</span>
04014         <span class="comment">//</span>
04015 
04016         <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (pHeader-&gt;BitmapSize,
04017                                   pBitMapHeader,
04018                                   (ULONG)CurrentPageFrame,
04019                                   (ULONG)(NextPageFrame-CurrentPageFrame)
04020                                   );
04021 
04022     }
04023 
04024     <span class="comment">//</span>
04025     <span class="comment">// Remove the gaps between runs.</span>
04026     <span class="comment">//</span>
04027     
04028     <span class="keywordflow">while</span> (i &lt; NumberOfRuns - 1) {
04029     
04030         CurrentPageFrame = Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> + Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
04031         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"Run[%x]: Base=%x, Pages=%x\n"</span>, i, Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>, Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>));
04032 
04033         i++;
04034         Run++;
04035 
04036         <span class="comment">//</span>
04037         <span class="comment">// Get the next starting BasePage.</span>
04038         <span class="comment">//</span>
04039         
04040         NextPageFrame = Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
04041 
04042         <span class="keywordflow">if</span> (NextPageFrame != CurrentPageFrame) {
04043 
04044             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"DeleteNonExistentMemory: %x - %x\n"</span>, NextPageFrame, CurrentPageFrame));
04045 
04046             <span class="comment">//</span>
04047             <span class="comment">// FIXFIX - handle page frame numbers greater than 32 bits.</span>
04048             <span class="comment">//</span>
04049 
04050             <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (pHeader-&gt;BitmapSize,
04051                                       pBitMapHeader,
04052                                       (ULONG)CurrentPageFrame,
04053                                       (ULONG)(NextPageFrame - CurrentPageFrame)
04054                                       );
04055         }
04056     }
04057 }
04058 
04059 
04060 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04061"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a34">04061</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a34">IopCompleteDumpInitialization</a>(
04062     IN HANDLE     FileHandle
04063     )
04064 
04065 <span class="comment">/*++</span>
04066 <span class="comment"></span>
04067 <span class="comment">Routine Description:</span>
04068 <span class="comment"></span>
04069 <span class="comment">    This routine is invoked after the dump file is created.</span>
04070 <span class="comment"></span>
04071 <span class="comment">    The purpose is to obtain the retrieval pointers so that they can then be</span>
04072 <span class="comment">    used later to write the dump. The last step is to checksum the</span>
04073 <span class="comment">    IopDumpControlBlock.</span>
04074 <span class="comment"></span>
04075 <span class="comment">    Fields in the IopDumpControlBlock are updated if necessary and the</span>
04076 <span class="comment">    IopDumpControlBlockChecksum is initialized.</span>
04077 <span class="comment"></span>
04078 <span class="comment">    This is the final step in dump initialization.</span>
04079 <span class="comment"></span>
04080 <span class="comment">Arguments:</span>
04081 <span class="comment"></span>
04082 <span class="comment">    FileHandle - Handle to the dump file just created.</span>
04083 <span class="comment"></span>
04084 <span class="comment">Return Value:</span>
04085 <span class="comment"></span>
04086 <span class="comment">    STATUS_SUCCESS - Indicates success.</span>
04087 <span class="comment"></span>
04088 <span class="comment">    Other NTSTATUS - Failure.</span>
04089 <span class="comment"></span>
04090 <span class="comment">--*/</span>
04091 
04092 {
04093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04094     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ErrorToLog;
04095     ULONG i;
04096     LARGE_INTEGER RequestedFileSize;
04097     PLARGE_INTEGER mcb;
04098     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
04099     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
04100     IO_STATUS_BLOCK IoStatusBlock;
04101     FILE_STANDARD_INFORMATION StandardFileInfo;
04102 
04103     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
04104     ErrorToLog = STATUS_SUCCESS;    <span class="comment">// No error</span>
04105     FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04106     DeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04107 
04108     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
04109                                         0,
04110                                         <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
04111                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04112                                         (PVOID *) &amp;FileObject,
04113                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04114                                         );
04115 
04116     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04117         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04118         <span class="keywordflow">goto</span> Cleanup;
04119     }
04120 
04121 
04122     DeviceObject = FileObject-&gt;DeviceObject;
04123 
04124     <span class="comment">//</span>
04125     <span class="comment">// If this device object represents the boot partition then query</span>
04126     <span class="comment">// the retrieval pointers for the file.</span>
04127     <span class="comment">//</span>
04128 
04129     <span class="keywordflow">if</span> ( !(DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a>) ) {
04130          
04131         KdPrint ((<span class="stringliteral">"IODUMP: Cannot dump to pagefile on non-system partition.\n"</span>));
04132         <span class="keywordflow">goto</span> Cleanup;
04133     }
04134 
04135     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationFile(
04136                                 FileHandle,
04137                                 &amp;IoStatusBlock,
04138                                 &amp;StandardFileInfo,
04139                                 <span class="keyword">sizeof</span> (StandardFileInfo),
04140                                 FileStandardInformation
04141                                 );
04142 
04143     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
04144         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;Event,
04145                                         <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
04146                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04147                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04148                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04149                                         );
04150         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatusBlock.Status;
04151     }
04152 
04153     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04154         KdPrint ((<span class="stringliteral">"CRASHDUMP: Failed ZwQueryInformationFile\n"</span>));
04155         <span class="keywordflow">goto</span> Cleanup;
04156     }
04157 
04158     <span class="comment">//</span>
04159     <span class="comment">// Do not ask for more space than is in the pagefile.</span>
04160     <span class="comment">//</span>
04161 
04162     RequestedFileSize = <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a>;
04163     
04164     <span class="keywordflow">if</span> (RequestedFileSize.QuadPart &gt; StandardFileInfo.EndOfFile.QuadPart) {
04165         RequestedFileSize = StandardFileInfo.EndOfFile;
04166     }
04167 
04168     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFsControlFile(
04169                         FileHandle,
04170                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04171                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04172                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04173                         &amp;IoStatusBlock,
04174                         FSCTL_QUERY_RETRIEVAL_POINTERS,
04175                         &amp;RequestedFileSize,
04176                         <span class="keyword">sizeof</span>( LARGE_INTEGER ),
04177                         &amp;mcb,
04178                         <span class="keyword">sizeof</span>( PVOID )
04179                         );
04180 
04181     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
04182         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;Event,
04183                                         <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
04184                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04185                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04186                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
04187         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatusBlock.Status;
04188     }
04189 
04190 
04191     <span class="comment">//</span>
04192     <span class="comment">// NOTE: If you fail here, put a BP on ntfs!NtfsQueryRetrievalPointers</span>
04193     <span class="comment">// or FatQueryRetrievalPointers and see why you failed.</span>
04194     <span class="comment">//</span>
04195     
04196     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
04197         KdPrint ((<span class="stringliteral">"CRASHDUMP: ZwFsControlFile returnd %d\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04198         ErrorToLog = IO_DUMP_POINTER_FAILURE;
04199         <span class="keywordflow">goto</span> Cleanup;
04200     }
04201     
04202     <span class="comment">//</span>
04203     <span class="comment">// This paging file is on the system boot partition, and</span>
04204     <span class="comment">// the retrieval pointers for the file were just successfully</span>
04205     <span class="comment">// queried.  Walk the MCB to size it, and then checksum it.</span>
04206     <span class="comment">//</span>
04207 
04208     <span class="keywordflow">for</span> (i = 0; mcb [i].QuadPart; i++) {
04209         NOTHING;
04210     }
04211 
04212     <span class="comment">//</span>
04213     <span class="comment">// Write back fields of the IopDumpControlBlock.</span>
04214     <span class="comment">//</span>
04215     
04216     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a> = mcb;
04217     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o10">FileDescriptorSize</a> = (i + 1) * <span class="keyword">sizeof</span> (LARGE_INTEGER);
04218     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a> = RequestedFileSize;
04219     <a class="code" href="../../d3/d5/iodata_8c.html#a48">IopDumpControlBlockChecksum</a> = <a class="code" href="../../d0/d6/iop_8h.html#a176">IopGetDumpControlBlockCheck</a> ( <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a> );
04220 
04221     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04222 
04223 Cleanup:
04224 
04225     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS &amp;&amp;
04226         ErrorToLog != STATUS_SUCCESS ) {
04227         
04228         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a> (0,
04229                           4,
04230                           STATUS_SUCCESS,
04231                           ErrorToLog,
04232                           0,
04233                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04234                           0,
04235                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04236                           );
04237     }
04238 
04239     DeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04240     
04241     <span class="keywordflow">if</span> ( FileObject ) {
04242         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
04243         FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04244     }
04245 
04246     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04247 
04248 }
04249 
04250 
04251 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04252"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a55">04252</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a55">IopFreeDCB</a>(
04253     BOOLEAN FreeDCB
04254     )
04255 
04256 <span class="comment">/*++</span>
04257 <span class="comment"></span>
04258 <span class="comment">Routine Description:</span>
04259 <span class="comment"></span>
04260 <span class="comment">    Free dump control block storage.</span>
04261 <span class="comment"></span>
04262 <span class="comment">Arguments:</span>
04263 <span class="comment"></span>
04264 <span class="comment">    FreeDCB - Implictly free storage for the dump control block.</span>
04265 <span class="comment"></span>
04266 <span class="comment">Return Value:</span>
04267 <span class="comment"></span>
04268 <span class="comment">    None</span>
04269 <span class="comment"></span>
04270 <span class="comment">--*/</span>
04271 {
04272     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> dcb;
04273     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            dwStatus;
04274     BOOLEAN             ShouldFreeDCB;
04275 
04276     dcb = <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>;
04277 
04278 
04279     <span class="keywordflow">if</span> (dcb) {
04280 
04281         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>) {
04282              <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>);
04283              dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>      = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04284         }
04285 
04286         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>) {
04287             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>);
04288             dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>             = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04289         }
04290 
04291         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a>) {
04292             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a>);
04293             dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a>    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04294         }
04295 
04296         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>) {
04297             <a class="code" href="../../d2/d3/dumpctl_8c.html#a41">IoFreeDumpStack</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>);
04298             dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>              = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04299         }
04300 
04301         ShouldFreeDCB = FreeDCB | !( dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a>);
04302 
04303         <span class="comment">//</span>
04304         <span class="comment">// Disable all options that require dump file access</span>
04305         <span class="comment">//</span>
04306         
04307         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a>;
04308 
04309         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IopFreeDCB] Should Free DCB = %s\n"</span>,(ShouldFreeDCB ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>)));
04310 
04311         <span class="keywordflow">if</span> (ShouldFreeDCB) {
04312             <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04313             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( dcb );
04314             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IopFreeDCB]: Freeing Dump Control Block\n"</span>));
04315         }
04316     }
04317 
04318     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IopFreeDCB]: CRASH DUMP DISABLED\n"</span>));
04319 
04320 }
04321 
04322 
04323 
04324 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04325"></a><a class="code" href="../../d0/d5/io_8h.html#a577">04325</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a25">IoSetCrashDumpState</a>(
04326     IN SYSTEM_CRASH_STATE_INFORMATION *pDumpState
04327     )
04328 
04329 <span class="comment">/*++</span>
04330 <span class="comment"></span>
04331 <span class="comment">Routine Description:</span>
04332 <span class="comment"></span>
04333 <span class="comment">    Disable the current crash dump. Optionally, configure a new crash dump.</span>
04334 <span class="comment"></span>
04335 <span class="comment">Arguments:</span>
04336 <span class="comment"></span>
04337 <span class="comment">    pDumpState - If ValidDirectDump = TRUE  enable a new dump</span>
04338 <span class="comment">                                      FALSE Disable crash dump</span>
04339 <span class="comment"></span>
04340 <span class="comment">Return Value:</span>
04341 <span class="comment"></span>
04342 <span class="comment">    STATUS_SUCCESS - The operation was successful</span>
04343 <span class="comment"></span>
04344 <span class="comment">    W32ERROR - Otherwise</span>
04345 <span class="comment"></span>
04346 <span class="comment">--*/</span>
04347 {
04348     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04349     ULONG       crashConfigurationInProgress;
04350 
04351     <span class="comment">//</span>
04352     <span class="comment">// Check the sentinal</span>
04353     <span class="comment">//</span>
04354 
04355     crashConfigurationInProgress = InterlockedExchange(&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a18">IopCrashDumpStateChange</a>,1);
04356 
04357     <span class="keywordflow">if</span> (crashConfigurationInProgress) {
04358         <span class="keywordflow">return</span> STATUS_SUCCESS;
04359     }
04360 
04361     <span class="comment">//</span>
04362     <span class="comment">// If crash dumps disabled return success</span>
04363     <span class="comment">//</span>
04364 
04365     <span class="keywordflow">if</span> (!pDumpState-&gt;ValidDirectDump) {
04366         <a class="code" href="../../d2/d3/dumpctl_8c.html#a55">IopFreeDCB</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04367         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04368     } <span class="keywordflow">else</span> {
04369         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
04370     }
04371 
04372     InterlockedExchange(&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a18">IopCrashDumpStateChange</a>,0);
04373 
04374     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04375 }
04376 
04377 
04378 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04379"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a56">04379</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a56">IopReadDumpRegistry</a>(
04380     OUT PULONG dumpControl,
04381     OUT PULONG numberOfHeaderPages,
04382     OUT PULONG autoReboot,
04383     OUT PULONG dumpFileSize
04384     )
04385 <span class="comment">/*++</span>
04386 <span class="comment"></span>
04387 <span class="comment">Routine Description:</span>
04388 <span class="comment"></span>
04389 <span class="comment">    This routine reads the dump parameters from the registry.</span>
04390 <span class="comment"></span>
04391 <span class="comment">Arguments:</span>
04392 <span class="comment"></span>
04393 <span class="comment">    dumpControl - Supplies a pointer to the dumpControl flags to set.</span>
04394 <span class="comment"></span>
04395 <span class="comment">Return Value:</span>
04396 <span class="comment"></span>
04397 <span class="comment">    None.</span>
04398 <span class="comment"></span>
04399 <span class="comment">--*/</span>
04400 
04401 {
04402     HANDLE                      keyHandle;
04403     HANDLE                      crashHandle;
04404     LOGICAL                     crashHandleOpened;
04405     UNICODE_STRING              keyName;
04406     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
04407     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04408     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>         dcb;
04409     ULONG                       handleValue;
04410 
04411     *dumpControl = 0;
04412     *autoReboot = 0;
04413     *dumpFileSize = 0;
04414 
04415     *numberOfHeaderPages = 1;       <span class="comment">// Dump header</span>
04416 
04417     <span class="comment">//</span>
04418     <span class="comment">// Begin by opening the path to the control for dumping memory.  Note</span>
04419     <span class="comment">// that if it does not exist, then no dumps will occur.</span>
04420     <span class="comment">//</span>
04421 
04422     crashHandleOpened = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04423 
04424     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;keyName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control"</span> );
04425 
04426     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;keyHandle,
04427                                  (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04428                                  &amp;keyName,
04429                                  KEY_READ,
04430                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
04431 
04432     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04433         <span class="keywordflow">return</span>;
04434     }
04435 
04436     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;keyName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CrashControl"</span> );
04437     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;crashHandle,
04438                                  keyHandle,
04439                                  &amp;keyName,
04440                                  KEY_READ,
04441                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
04442 
04443     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
04444 
04445     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04446         <span class="keywordflow">return</span>;
04447     }
04448 
04449     crashHandleOpened = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04450 
04451     <span class="comment">//</span>
04452     <span class="comment">// Now get the value of the crash control to determine whether or not</span>
04453     <span class="comment">// dumping is enabled.</span>
04454     <span class="comment">//</span>
04455 
04456     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04457                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CrashDumpEnabled"</span>,
04458                                   &amp;keyValueInformation );
04459 
04460     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
04461 
04462         <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04463 
04464             handleValue = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04465             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
04466 
04467             <span class="keywordflow">if</span> (handleValue) {
04468 
04469                 *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>;
04470 
04471                 <span class="comment">//</span>
04472                 <span class="comment">// If handleValue equals summary dump or the amount of physical</span>
04473                 <span class="comment">// memory is greater than 2GB, then enable summary dump</span>
04474                 <span class="comment">//</span>
04475 
04476                 <span class="keywordflow">if</span> ( handleValue == 3 ) {
04477 
04478                     *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>;
04479                     
04480                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( handleValue == 4 ) {
04481 
04482                     *dumpControl |= ( <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a> | <a class="code" href="../../d0/d6/iop_8h.html#a11">DCB_TRIAGE_DUMP_ACT_UPON_ENABLED</a> );
04483                     
04484                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ( handleValue == 2 ) ||
04485                      ( <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &gt;= ( 0x80000000 &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> ) ) ) {
04486                     
04487                     *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>;
04488 
04489                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopInitializeDCB: SUMMARY DUMP ENABLED \n"</span>));
04490 
04491                     <span class="comment">//</span>
04492                     <span class="comment">// Allocate enough storage for the dump header, summary</span>
04493                     <span class="comment">// dump header and bitmap.</span>
04494                     <span class="comment">//</span>
04495 
04496                     *numberOfHeaderPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(
04497                                             <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> +
04498                                             ( ( <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &gt;&gt; 5) &lt;&lt; 2 ) +
04499                                             <span class="keyword">sizeof</span>(SUMMARY_DUMP_HEADER)
04500                                             );
04501 
04502                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopInitializeDCB: NumberOfHeader Pages = %x\n"</span>,numberOfHeaderPages));
04503 
04504                 }
04505             }
04506         }
04507     }
04508 
04509     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04510                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LogEvent"</span>,
04511                                   &amp;keyValueInformation );
04512 
04513     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04514          <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04515             handleValue = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04516             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation);
04517             <span class="keywordflow">if</span> (handleValue) {
04518                 *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>;
04519             }
04520         }
04521     }
04522 
04523     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04524                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SendAlert"</span>,
04525                                   &amp;keyValueInformation );
04526 
04527     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04528          <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04529             handleValue = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04530             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation);
04531             <span class="keywordflow">if</span> (handleValue) {
04532                 *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>;
04533             }
04534         }
04535     }
04536 
04537     <span class="comment">//</span>
04538     <span class="comment">// Now determine whether or not automatic reboot is enabled.</span>
04539     <span class="comment">//</span>
04540 
04541     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04542                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"AutoReboot"</span>,
04543                                   &amp;keyValueInformation );
04544 
04545 
04546     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04547         <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04548             *autoReboot = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04549         }
04550         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
04551     }
04552 
04553     <span class="comment">//</span>
04554     <span class="comment">// If we aren't auto rebooting or crashing then return now.</span>
04555     <span class="comment">//</span>
04556 
04557     <span class="keywordflow">if</span> (*dumpControl == 0 &amp;&amp; *autoReboot == 0) {
04558         <span class="keywordflow">if</span> (crashHandleOpened == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04559             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( crashHandle );
04560         }
04561         <span class="keywordflow">return</span>;
04562     }
04563 
04564     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04565                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DumpFileSize"</span>,
04566                                   &amp;keyValueInformation );
04567 
04568     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04569         <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04570             *dumpFileSize = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04571         }
04572 
04573         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
04574     }
04575     <span class="keywordflow">return</span>;
04576 }
04577 
04578 
04579 BOOLEAN
<a name="l04580"></a><a class="code" href="../../d2/d3/dumpctl_8c.html#a32">04580</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a32">IopInitializeDCB</a>(
04581     )
04582 <span class="comment">/*++</span>
04583 <span class="comment"></span>
04584 <span class="comment">Routine Description:</span>
04585 <span class="comment"></span>
04586 <span class="comment">    This routine initializes the Dump Control Block (DCB). It allocates the</span>
04587 <span class="comment">    DCB and reads the crashdump parameters from the registry.</span>
04588 <span class="comment"></span>
04589 <span class="comment">Arguments:</span>
04590 <span class="comment"></span>
04591 <span class="comment"></span>
04592 <span class="comment">Return Value:</span>
04593 <span class="comment"></span>
04594 <span class="comment">    The final function value is TRUE if everything worked, else FALSE.</span>
04595 <span class="comment"></span>
04596 <span class="comment">--*/</span>
04597 
04598 {
04599     HANDLE                      keyHandle;
04600     HANDLE                      crashHandle;
04601     LOGICAL                     crashHandleOpened;
04602     UNICODE_STRING              keyName;
04603     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
04604     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04605     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>         dcb;
04606     ULONG                       dumpControl;
04607     ULONG                       handleValue;
04608     ULONG                       autoReboot;
04609     PCHAR                       partitionName;
04610     ULONG                       dcbSize;
04611     LARGE_INTEGER               page;
04612     ULONG                       numberOfHeaderPages;
04613     ULONG                       dumpFileSize;
04614 
04615     <span class="comment">//</span>
04616     <span class="comment">// Read all the registry default values first.</span>
04617     <span class="comment">//</span>
04618 
04619     <a class="code" href="../../d2/d3/dumpctl_8c.html#a56">IopReadDumpRegistry</a> ( &amp;dumpControl,
04620                           &amp;numberOfHeaderPages,
04621                           &amp;autoReboot,
04622                           &amp;dumpFileSize);
04623 
04624     <span class="comment">//</span>
04625     <span class="comment">// If we aren't crashing or auto rebooting then return now.</span>
04626     <span class="comment">//</span>
04627 
04628     <span class="keywordflow">if</span> (dumpControl == 0 &amp;&amp; autoReboot == 0) {
04629 
04630         <span class="comment">//</span>
04631         <span class="comment">// At some point, we will conditionally on system size, type, etc,</span>
04632         <span class="comment">// set dump defaults like the below and skip over the return.</span>
04633         <span class="comment">//</span>
04634         <span class="comment">//    *dumpControl = (DCB_DUMP_ENABLED | DCB_TRIAGE_DUMP_ENABLED);</span>
04635         <span class="comment">//    *autoReboot = 1;</span>
04636         <span class="comment">//    *dumpFileSize = ?</span>
04637         <span class="comment">//</span>
04638 
04639         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04640     }
04641 
04642     <span class="keywordflow">if</span> (dumpControl &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
04643         dumpControl &amp;= ~<a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>;
04644         dumpFileSize = TRIAGE_DUMP_SIZE;
04645     }
04646 
04647     <span class="comment">//</span>
04648     <span class="comment">// Allocate and initialize the structures necessary to describe and control</span>
04649     <span class="comment">// the post-bugcheck code.</span>
04650     <span class="comment">//</span>
04651 
04652     dcbSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">DUMP_CONTROL_BLOCK</a> ) + <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d9/struct__MINIPORT__NODE.html">MINIPORT_NODE</a> );
04653     dcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, dcbSize, 'pmuD' );
04654     <span class="keywordflow">if</span> (!dcb) {
04655         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IopInitializeDCB: Not enough pool to allocate DCB0\n"</span> ));
04656         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,1,STATUS_SUCCESS,IO_DUMP_INITIALIZATION_FAILURE,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04657         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04658     }
04659 
04660     RtlZeroMemory( dcb, dcbSize );
04661     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o0">Type</a> = <a class="code" href="../../d0/d6/iop_8h.html#a4">IO_TYPE_DCB</a>;
04662     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o2">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) dcbSize;
04663     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> = (UCHAR) (dumpControl | (autoReboot ? <a class="code" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a> : 0));
04664     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o3">NumberProcessors</a> = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
04665     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o5">ProcessorArchitecture</a> = <a class="code" href="../../d4/d9/ke_8h.html#a134">KeProcessorArchitecture</a>;
04666     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o14">MinorVersion</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a>;
04667     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o13">MajorVersion</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((<a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &gt;&gt; 28) &amp; 0xfffffff);
04668     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o15">BuildNumber</a> = <a class="code" href="../../d8/d1/init_8h.html#a7">CmNtCSDVersion</a>;
04669     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o19">TriageDumpFlags</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a9">DEFAULT_TRIAGE_DUMP_FLAGS</a>;
04670 
04671     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a>.QuadPart = dumpFileSize;
04672 
04673     <span class="comment">//</span>
04674     <span class="comment">// Allocate memory descriptors.</span>
04675     <span class="comment">//</span>
04676 
04677     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o8">MemoryDescriptorLength</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a> ) - <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a> ) +
04678                                   (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> * <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a> ));
04679     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
04680                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04681                                     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o8">MemoryDescriptorLength</a>,
04682                                     'pmuD'
04683                                     );
04684     <span class="keywordflow">if</span> (!dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>) {
04685         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb);
04686 
04687         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IopInitializeDCB: Not enough pool to allocate DCB1\n"</span> ));
04688         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,1,STATUS_SUCCESS,IO_DUMP_INITIALIZATION_FAILURE,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04689         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04690     }
04691 
04692     RtlCopyMemory (
04693         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>,
04694         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>,
04695         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o8">MemoryDescriptorLength</a>
04696         );
04697 
04698     <span class="comment">//</span>
04699     <span class="comment">// Allocate header page.</span>
04700     <span class="comment">//</span>
04701 
04702     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a> = numberOfHeaderPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
04703     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a>, 'pmuD' );
04704 
04705     <span class="keywordflow">if</span> (!dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>) {
04706         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>);
04707         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb);
04708         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IopInitializeDCB: Not enough pool to allocate DCB2\n"</span> ));
04709         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,1,STATUS_SUCCESS,IO_DUMP_INITIALIZATION_FAILURE,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04710         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04711     }
04712     page = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>( dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a> );
04713     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o12">HeaderPfn</a> = (ULONG)(page.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04714 
04715 
04716     <span class="comment">//</span>
04717     <span class="comment">// Allocate the triage-dump buffer.</span>
04718     <span class="comment">//</span>
04719     
04720     <span class="keywordflow">if</span> (dumpControl &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
04721     
04722         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o20">TriageDumpBuffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> ( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04723                                                       dumpFileSize,
04724                                                       'pmuD'
04725                                                       );
04726 
04727         <span class="keywordflow">if</span> (!dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o20">TriageDumpBuffer</a>) {
04728             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>);
04729             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>);
04730             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb);
04731             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IopInitializeDCB: Not enough pool to allocate DCB3\n"</span> ));
04732             <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,1,STATUS_SUCCESS,IO_DUMP_INITIALIZATION_FAILURE,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04733             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04734         }
04735 
04736         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o21">TriageDumpBufferSize</a> = dumpFileSize;
04737     }
04738     
04739     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a> = dcb;
04740 
04741     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04742 }
04743 
04744 
04745 BOOLEAN
<a name="l04746"></a><a class="code" href="../../d0/d6/iop_8h.html#a228">04746</a> <a class="code" href="../../d0/d6/iop_8h.html#a228">IopConfigureCrashDump</a>(
04747     IN HANDLE hPageFile
04748     )
04749 <span class="comment">/*++</span>
04750 <span class="comment"></span>
04751 <span class="comment">Routine Description:</span>
04752 <span class="comment"></span>
04753 <span class="comment">    This routine configures the system for crash dump. The following things</span>
04754 <span class="comment">    are done:</span>
04755 <span class="comment">    </span>
04756 <span class="comment">        1. Initialize the dump control block and init registry crashdump</span>
04757 <span class="comment">           parameters.</span>
04758 <span class="comment"></span>
04759 <span class="comment">        2. Configure either page or fast dump.</span>
04760 <span class="comment"></span>
04761 <span class="comment">        3. Complete dump file initialization.</span>
04762 <span class="comment"></span>
04763 <span class="comment">    This routine is called as each page file is created. A return value of</span>
04764 <span class="comment">    TRUE tells the caller (i.e., NtCreatePagingFiles, IoPageFileCreated)</span>
04765 <span class="comment">    that crash dump has been configured.</span>
04766 <span class="comment"></span>
04767 <span class="comment"></span>
04768 <span class="comment">Arguments:</span>
04769 <span class="comment"></span>
04770 <span class="comment">       hPageFile - Handle to the paging file</span>
04771 <span class="comment"></span>
04772 <span class="comment">Return Value:</span>
04773 <span class="comment"></span>
04774 <span class="comment">    TRUE - Configuration complete (or crash dump not enabled).</span>
04775 <span class="comment"></span>
04776 <span class="comment">    FALSE - Error, retry PageFile is not on boot partition.</span>
04777 <span class="comment"></span>
04778 <span class="comment">--*/</span>
04779 {
04780     ULONG           dwStatus;
04781     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>    fileObject;
04782     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  deviceObject;
04783 
04784     <span class="comment">//</span>
04785     <span class="comment">// Only Init DCB Once.</span>
04786     <span class="comment">//</span>
04787     
04788     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>) {
04789         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/dumpctl_8c.html#a32">IopInitializeDCB</a>()) {
04790             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04791         }
04792     }
04793 
04794     <span class="comment">//</span>
04795     <span class="comment">// Return crash dump not enabled</span>
04796     <span class="comment">//</span>
04797     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>){
04798         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04799     }
04800 
04801     <span class="comment">//</span>
04802     <span class="comment">//  Only autoreboot?</span>
04803     <span class="comment">//</span>
04804     
04805     <span class="keywordflow">if</span> ( !( <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; (<a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a> | <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>) ) ) {
04806         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04807     }
04808 
04809     <span class="comment">//</span>
04810     <span class="comment">// Configure the paging file for crash dump.</span>
04811     <span class="comment">//</span>
04812 
04813     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IoPageFileCreated]: Page file dump\n"</span>));
04814 
04815 
04816     dwStatus = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
04817                                         hPageFile,
04818                                         0,
04819                                         <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
04820                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04821                                         (PVOID *) &amp;fileObject,
04822                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04823                                         );
04824 
04825     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( dwStatus )) {
04826         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"[IoPageFileCreated]: ObReferenceObjectByHandle for Paging file failed status = %x\n"</span>,dwStatus));
04827         <span class="keywordflow">goto</span> error_return;
04828     }
04829 
04830     <span class="comment">//</span>
04831     <span class="comment">// Get a pointer to the device object for this file.  Note that it</span>
04832     <span class="comment">// cannot go away, since there is an open handle to it, so it is</span>
04833     <span class="comment">// OK to dereference it and then use it.</span>
04834     <span class="comment">//</span>
04835 
04836     deviceObject = fileObject-&gt;DeviceObject;
04837 
04838     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
04839 
04840     <span class="comment">//</span>
04841     <span class="comment">// If this device object does not represents the boot partition return</span>
04842     <span class="comment">// FALSE so MM will try again.</span>
04843     <span class="comment">//</span>
04844     
04845     <span class="keywordflow">if</span> ( ! (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a>) ) {
04846         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04847     }
04848 
04849     <span class="comment">//</span>
04850     <span class="comment">// Load paging file dump stack</span>
04851     <span class="comment">//</span>
04852     
04853     dwStatus = <a class="code" href="../../d2/d3/dumpctl_8c.html#a36">IoGetDumpStack</a> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"dump_"</span>,
04854                                &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>,
04855                                <a class="code" href="../../d0/d5/io_8h.html#a603a420">DeviceUsageTypeDumpFile</a>,
04856                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04857 
04858     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(dwStatus)) {
04859         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoPageFileCreated: Could not load dump stack status = %x\n"</span>,dwStatus) );
04860         <span class="keywordflow">goto</span> error_return;
04861     }
04862 
04863     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.CrashDump = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04864 
04865     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.MemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
04866                                                 <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04867                                                 <a class="code" href="../../d0/d5/io_8h.html#a114">IO_DUMP_MEMORY_BLOCK_PAGES</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
04868                                                 'pmuD'
04869                                                 );
04870 
04871     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.MemoryBlock) {
04872         dwStatus = STATUS_NO_MEMORY;
04873         <span class="keywordflow">goto</span> error_return;
04874     }
04875 
04876 
04877     <span class="comment">//</span>
04878     <span class="comment">// Calculate the amount of space required for the dump</span>
04879     <span class="comment">//</span>
04880     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a> =<a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
04881                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a>,
04882                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a>,
04883                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a>,
04884                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a>
04885                                                     );
04886 
04887 
04888     <span class="comment">//</span>
04889     <span class="comment">// Complete dump initialization</span>
04890     <span class="comment">//</span>
04891 
04892     dwStatus = <a class="code" href="../../d2/d3/dumpctl_8c.html#a34">IopCompleteDumpInitialization</a>(hPageFile);
04893 
04894 error_return:
04895 
04896     <span class="comment">//</span>
04897     <span class="comment">// The BOOT partition paging file could not be configured.</span>
04898     <span class="comment">//   1. Log an error message</span>
04899     <span class="comment">//   2. Return TRUE so that MM does not try again</span>
04900     <span class="comment">//</span>
04901 
04902     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(dwStatus)) {
04903         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"IopPageFileCreated: Page File dump init FAILED status = %x\n"</span>,dwStatus));
04904 
04905         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,3,STATUS_SUCCESS,IO_DUMP_PAGE_CONFIG_FAILED,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04906 
04907         <a class="code" href="../../d2/d3/dumpctl_8c.html#a55">IopFreeDCB</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04908 
04909     }
04910 
04911     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04912 }
04913 
04914 
04915 <span class="comment">//</span>
04916 <span class="comment">// Debugging routines.</span>
04917 <span class="comment">//</span>
04918 
04919 <span class="preprocessor">#if DBG</span>
04920 <span class="preprocessor"></span>
04921 ULONG IopDebugLevel = 0;
04922 UCHAR IopBuffer[128];
04923 
04924 
04925 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04926 IopDebugPrint(
04927     ULONG Level,
04928     PCHAR Format,
04929     ...
04930     )
04931 {
04932     va_list ap;
04933 
04934     va_start(ap, Format);
04935 
04936     <span class="keywordflow">if</span> (IopDebugLevel &gt;= Level) {
04937         vsprintf(IopBuffer, Format, ap);
04938         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(IopBuffer);
04939     }
04940 
04941     va_end(ap);
04942 }
04943 
04944 <span class="preprocessor">#endif //DBG</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
