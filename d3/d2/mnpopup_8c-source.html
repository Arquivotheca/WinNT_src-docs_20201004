<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mnpopup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mnpopup.c</h1><a href="../../d2/d3/mnpopup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: mnpopup.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Popup Menu Support</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">*  10-10-90 JimA    Cleanup.</span>
00010 <span class="comment">*  03-18-91 IanJa   Window revalidation added</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
<a name="l00016"></a><a class="code" href="../../d2/d3/mnpopup_8c.html#a0">00016</a> <span class="preprocessor">#define RECT_ONLEFT     0</span>
<a name="l00017"></a><a class="code" href="../../d2/d3/mnpopup_8c.html#a1">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define RECT_ONTOP      1</span>
<a name="l00018"></a><a class="code" href="../../d2/d3/mnpopup_8c.html#a2">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define RECT_ONRIGHT    2</span>
<a name="l00019"></a><a class="code" href="../../d2/d3/mnpopup_8c.html#a3">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define RECT_ONBOTTOM   3</span>
<a name="l00020"></a><a class="code" href="../../d2/d3/mnpopup_8c.html#a4">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define RECT_ORG        4</span>
00021 <span class="preprocessor"></span>
00022 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d3/mnpopup_8c.html#a5">TryRect</a>(
00023         UINT        wRect,
00024         <span class="keywordtype">int</span>         x,
00025         <span class="keywordtype">int</span>         y,
00026         <span class="keywordtype">int</span>         cx,
00027         <span class="keywordtype">int</span>         cy,
00028         LPRECT      prcExclude,
00029         LPPOINT     ppt,
00030         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor);
00031 
00032 <span class="comment">/***************************************************************************\</span>
00033 <span class="comment">* xxxTrackPopupMenuEx (API)</span>
00034 <span class="comment">*</span>
00035 <span class="comment">* Process a popup menu</span>
00036 <span class="comment">*</span>
00037 <span class="comment">* Revalidation Notes:</span>
00038 <span class="comment">* o  if pwndOwner is always the owner of the popup menu windows, then we don't</span>
00039 <span class="comment">*    really have to revalidate it: when it is destroyed the popup menu windows</span>
00040 <span class="comment">*    are destroyed first because it owns them - this is detected in MenuWndProc</span>
00041 <span class="comment">*    so we would only have to test pMenuState-&gt;fSabotaged.</span>
00042 <span class="comment">* o  pMenuState-&gt;fSabotaged must be cleared before this top-level routine</span>
00043 <span class="comment">*    returns, to be ready for next time menus are processed (unless we are</span>
00044 <span class="comment">*    currently inside xxxMenuLoop())</span>
00045 <span class="comment">* o  pMenuState-&gt;fSabotaged should be FALSE when we enter this routine.</span>
00046 <span class="comment">* o  xxxMenuLoop always returns with pMenuState-&gt;fSabotaged clear.  Use</span>
00047 <span class="comment">*    a UserAssert to verify this.</span>
00048 <span class="comment">*</span>
00049 <span class="comment">* History:</span>
00050 <span class="comment">\***************************************************************************/</span>
00051 
<a name="l00052"></a><a class="code" href="../../d4/d1/userk_8h.html#a1597">00052</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1597">xxxTrackPopupMenuEx</a>(
00053     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>       pMenu,
00054     UINT        dwFlags,
00055     <span class="keywordtype">int</span>         x,
00056     <span class="keywordtype">int</span>         y,
00057     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndOwner,
00058     CONST TPMPARAMS *lpTpm)
00059 {
00060     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a>      pMenuState;
00061     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndHierarchy;
00062     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>      ppopupMenuHierarchy;
00063     LONG            sizeHierarchy;
00064     <span class="keywordtype">int</span>             cxPopup,
00065                     cyPopup;
00066     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fSync;
00067     <span class="keywordtype">int</span>             cmd;
00068     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fButtonDown;
00069     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwndHierarchy;
00070     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwndT;
00071     RECT            rcExclude;
00072     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent,
00073                     ptiOwner;
00074     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor;
00075     POINT           pt;
00076 
00077     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00078     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndOwner);
00079 
00080     <span class="comment">/*</span>
00081 <span class="comment">     * Capture the things we care about in case lpTpm goes away.</span>
00082 <span class="comment">     */</span>
00083     <span class="keywordflow">if</span> (lpTpm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00084         <span class="keywordflow">if</span> (lpTpm-&gt;cbSize != <span class="keyword">sizeof</span>(TPMPARAMS)) {
00085             RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"TrackPopupMenuEx: cbSize is invalid"</span>);
00086             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00087         }
00088         rcExclude = lpTpm-&gt;rcExclude;
00089     }
00090 
00091     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00092     ptiOwner = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOwner);
00093 
00094     <span class="comment">/*</span>
00095 <span class="comment">     * Win95 compatibility: pwndOwner must be owned by ptiCurrent.</span>
00096 <span class="comment">     */</span>
00097     <span class="keywordflow">if</span> (ptiCurrent != ptiOwner) {
00098         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxTrackPopupMenuEx: pwndOwner not owned by ptiCurrent"</span>);
00099         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00100     }
00101 
00102     UserAssert(pMenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00103     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00104 
00105         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_RECURSE) {
00106             <span class="comment">/*</span>
00107 <span class="comment">             * Only allow recursion if:</span>
00108 <span class="comment">             *  -The current menu mode is not about to exit</span>
00109 <span class="comment">             *  -Both menus notify the same window</span>
00110 <span class="comment">             *  -Only one thread is involved in the current menu mode</span>
00111 <span class="comment">             * This will prevent us from getting into some random</span>
00112 <span class="comment">             *  scenarios we don't want to deal with</span>
00113 <span class="comment">             */</span>
00114            ppopupMenuHierarchy = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>;
00115            pwndHierarchy = ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>;
00116            <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>, ppopupMenuHierarchy)
00117                 || (pwndHierarchy == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00118                 || (pwndHierarchy != pwndOwner)
00119                 || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndHierarchy))) {
00120 
00121                RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxTrackPopupMenuEx: Failing TPM_RECURSE request"</span>);
00122                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00123            }
00124            <span class="comment">/*</span>
00125 <span class="comment">            * Terminate any animation</span>
00126 <span class="comment">            */</span>
00127             <a class="code" href="../../d4/d1/userk_8h.html#a1339">MNAnimate</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00128            <span class="comment">/*</span>
00129 <span class="comment">            * Cancel pending show timer if any. ie, the app wants to</span>
00130 <span class="comment">            *  pop up a context menu on a popup before we drop it.</span>
00131 <span class="comment">            */</span>
00132            ppopupMenuHierarchy = ((ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00133                                   ? ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)(ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>))-&gt;ppopupmenu
00134                                   : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00135            <span class="keywordflow">if</span> ((ppopupMenuHierarchy != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a>) {
00136 
00137                 <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a55">IDSYS_MNSHOW</a>);
00138                 ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o13">fShowTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00139            }
00140            <span class="comment">/*</span>
00141 <span class="comment">            * If we're currently on a modal menu, let's unlock the capture</span>
00142 <span class="comment">            *  so the recursive menu can get it.</span>
00143 <span class="comment">            */</span>
00144            <span class="keywordflow">if</span> (!ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00145                ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>;
00146            }
00147         } <span class="keywordflow">else</span> {
00148             <span class="comment">/*</span>
00149 <span class="comment">             * Allow only one guy to have a popup menu up at a time...</span>
00150 <span class="comment">             */</span>
00151             RIPERR0(ERROR_POPUP_ALREADY_ACTIVE, RIP_VERBOSE, <span class="stringliteral">""</span>);
00152             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00153        }
00154    }
00155 
00156     <span class="comment">// Is button down?</span>
00157 
00158     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_RIGHTBUTTON)
00159     {
00160         fButtonDown = (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_RBUTTON) &amp; 0x8000) != 0;
00161     } <span class="keywordflow">else</span> {
00162         fButtonDown = (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_LBUTTON) &amp; 0x8000) != 0;
00163     }
00164 
00165     <span class="comment">/*</span>
00166 <span class="comment">     * Create the menu window.</span>
00167 <span class="comment">     */</span>
00168     pwndHierarchy = <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
00169             WS_EX_TOOLWINDOW | WS_EX_DLGMODALFRAME | WS_EX_WINDOWEDGE,
00170             (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a45">MENUCLASS</a>,
00171             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00172             WS_POPUP | WS_BORDER,
00173             x, y, 100, 100,
00174             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, MNS_MODELESS) ? pwndOwner : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00175             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (HANDLE)pwndOwner-&gt;hModule,
00176             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00177             WINVER);
00178 
00179     <span class="keywordflow">if</span> (pwndHierarchy == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00180         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00181     }
00182 
00183 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00184 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOwner, WEFLAYOUTRTL))
00185         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwndHierarchy, WEFLAYOUTRTL);
00186 <span class="preprocessor">#endif</span>
00187 <span class="preprocessor"></span>
00188     <span class="comment">//</span>
00189     <span class="comment">// Do this so that old apps don't get weird borders on tracked popups due</span>
00190     <span class="comment">// to the app hack used in CreateWindowEx32.</span>
00191     <span class="comment">//</span>
00192     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndHierarchy, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a587">WFOLDUI</a>);
00193 
00194     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndHierarchy, &amp;tlpwndHierarchy);
00195 
00196 <span class="preprocessor">#ifdef HAVE_MN_GETPPOPUPMENU</span>
00197 <span class="preprocessor"></span>    ppopupMenuHierarchy = (<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndHierarchy,
00198                                                 MN_GETPPOPUPMENU, 0, 0);
00199 <span class="preprocessor">#else</span>
00200 <span class="preprocessor"></span>    ppopupMenuHierarchy = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)pwndHierarchy)-&gt;ppopupmenu;
00201 <span class="preprocessor">#endif</span>
00202 <span class="preprocessor"></span>
00203 
00204     ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o16">fDelayedFree</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00205     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>), pwndOwner);
00206     <a class="code" href="../../d4/d1/userk_8h.html#a1360">LockPopupMenu</a>(ppopupMenuHierarchy, &amp;ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, pMenu);
00207     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>), pwndHierarchy);
00208     ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o32">ppopupmenuRoot</a> = ppopupMenuHierarchy;
00209     ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>  = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00210     ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o9">fFirstClick</a> = fButtonDown;
00211     ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o6">fRightButton</a>   = ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_RIGHTBUTTON) != 0);
00212     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MENUDROPALIGNMENT) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>)) {
00213        <span class="comment">//</span>
00214        <span class="comment">// popup's below this one need to follow the same direction as</span>
00215        <span class="comment">// the other menu's on the desktop.</span>
00216        <span class="comment">//</span>
00217        ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o4">fDroppedLeft</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00218     }
00219     ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>      = ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_NONOTIFY) != 0);
00220 
00221     <span class="keywordflow">if</span> (fSync = (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_RETURNCMD))
00222         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o8">fSynchronous</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00223 
00224     ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> =  ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_SYSMENU) != 0);
00225 
00226     <span class="comment">// Set the GlobalPopupMenu variable so that EndMenu works for popupmenus so</span>
00227     <span class="comment">// that WinWart II people can continue to abuse undocumented functions.</span>
00228     <span class="comment">// This is nulled out in MNCancel.</span>
00229     <span class="comment">/*</span>
00230 <span class="comment">     * This is actually needed for cleanup in case this thread ends</span>
00231 <span class="comment">     *  execution before we can free the popup. (See xxxDestroyThreadInfo)</span>
00232 <span class="comment">     *</span>
00233 <span class="comment">     * Note that one thread might own pwndOwner and another one might call</span>
00234 <span class="comment">     *  TrackPopupMenu (pretty normal if the two threads are attached). So</span>
00235 <span class="comment">     *  properly setting (and initializing) pMenuState is a must here.</span>
00236 <span class="comment">     */</span>
00237     pMenuState = <a class="code" href="../../d4/d1/userk_8h.html#a1343">xxxMNAllocMenuState</a>(ptiCurrent, ptiOwner, ppopupMenuHierarchy);
00238     <span class="keywordflow">if</span> (pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00239         <span class="comment">/*</span>
00240 <span class="comment">         * Get out. The app never knew we were here so don't notify it</span>
00241 <span class="comment">         */</span>
00242         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= TPM_NONOTIFY;
00243         <span class="keywordflow">goto</span> AbortTrackPopupMenuEx;
00244     }
00245 
00246     <span class="comment">/*</span>
00247 <span class="comment">     * Notify the app we are entering menu mode.  wParam is 1 since this is a</span>
00248 <span class="comment">     * TrackPopupMenu.</span>
00249 <span class="comment">     */</span>
00250 
00251     <span class="keywordflow">if</span> (!ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>)
00252         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndOwner, WM_ENTERMENULOOP,
00253             (ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>), 0);
00254 
00255     <span class="comment">/*</span>
00256 <span class="comment">     * Send off the WM_INITMENU, set ourselves up for menu mode etc...</span>
00257 <span class="comment">     */</span>
00258     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1386">xxxMNStartMenu</a>(ppopupMenuHierarchy, <a class="code" href="../../d4/d1/userk_8h.html#a332">MOUSEHOLD</a>)) {
00259         <span class="comment">/*</span>
00260 <span class="comment">         * ppopupMenuHierarchy has been destroyed already; let's bail</span>
00261 <span class="comment">         */</span>
00262         <span class="keywordflow">goto</span> AbortTrackPopupMenuEx;
00263     }
00264 
00265     <span class="comment">/*</span>
00266 <span class="comment">     * If drag and drop, register the window as a target.</span>
00267 <span class="comment">     */</span>
00268     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a>) {
00269         <span class="keywordflow">if</span> (!SUCCEEDED(<a class="code" href="../../d4/d1/userk_8h.html#a1413">xxxClientRegisterDragDrop</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndHierarchy)))) {
00270             RIPMSG0(RIP_ERROR, <span class="stringliteral">"xxxTrackPopupMenuEx: xxxClientRegisterDragDrop failed"</span>);
00271         }
00272     }
00273 
00274     <span class="keywordflow">if</span> (!ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>) {
00275         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndT);
00276         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_INITMENUPOPUP,
00277             (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pMenu), MAKELONG(0, (ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> ? 1: 0)));
00278         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00279         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o21">fSendUninit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00280     }
00281 
00282     <span class="comment">/*</span>
00283 <span class="comment">     * Size the menu window if needed...</span>
00284 <span class="comment">     */</span>
00285     sizeHierarchy = (LONG)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndHierarchy, MN_SIZEWINDOW, <a class="code" href="../../d4/d1/userk_8h.html#a535">MNSW_SIZE</a>, 0);
00286 
00287     <span class="keywordflow">if</span> (!sizeHierarchy) {
00288 
00289 AbortTrackPopupMenuEx:
00290         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00291             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUEND, pwndOwner, OBJID_WINDOW, INDEXID_CONTAINER, 0);
00292         }
00293         <span class="comment">/*</span>
00294 <span class="comment">         * Release the mouse capture we set when we called StartMenuState...</span>
00295 <span class="comment">         */</span>
00296         <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a6">xxxMNReleaseCapture</a>();
00297 
00298         <span class="comment">/* Notify the app we have exited menu mode.  wParam is 1 for real</span>
00299 <span class="comment">         * tracked popups, not sys menu.  Check wFlags since ppopupHierarchy</span>
00300 <span class="comment">         * will be gone.</span>
00301 <span class="comment">         */</span>
00302         <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_NONOTIFY))
00303             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndOwner, WM_EXITMENULOOP, ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_SYSMENU) ?
00304                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>), 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00305 
00306         <span class="comment">/*</span>
00307 <span class="comment">         * Make sure we return failure</span>
00308 <span class="comment">         */</span>
00309         fSync = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00310         cmd = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00311         <span class="keywordflow">goto</span> CleanupTrackPopupMenuEx;
00312     }
00313 
00314     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a376">LINP_KEYBOARD</a>) {
00315         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o6">fUnderline</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00316         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a144">MFUNDERLINE</a>);
00317     }
00318 
00319     <span class="comment">//</span>
00320     <span class="comment">// Setup popup window dimensions</span>
00321     <span class="comment">//</span>
00322     cxPopup = LOWORD(sizeHierarchy) + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME);
00323     cyPopup = HIWORD(sizeHierarchy) + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME);
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Calculate the monitor BEFORE we adjust the point.  Otherwise, we might</span>
00327     <span class="comment">// move the point offscreen.  In which case, we will end up pinning the</span>
00328     <span class="comment">// popup to the primary display, which is wrong.</span>
00329     <span class="comment">//</span>
00330     pt.x = x;
00331     pt.y = y;
00332     pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a6">_MonitorFromPoint</a>(pt, MONITOR_DEFAULTTONEAREST);
00333 
00334     <span class="comment">//</span>
00335     <span class="comment">// Horizontal alignment</span>
00336     <span class="comment">//</span>
00337 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00338 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOwner, WEFLAYOUTRTL) &amp;&amp; !(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_CENTERALIGN)) {
00339         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> ^ TPM_RIGHTALIGN;
00340     }
00341 <span class="preprocessor">#endif</span>
00342 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_RIGHTALIGN) {
00343 <span class="preprocessor">#if DBG</span>
00344 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_CENTERALIGN) {
00345             RIPMSG0(RIP_WARNING, <span class="stringliteral">"TrackPopupMenuEx:  TPM_CENTERALIGN ignored"</span>);
00346         }
00347 <span class="preprocessor">#endif // DBG</span>
00348 <span class="preprocessor"></span>
00349         x -= cxPopup;
00350         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a>;
00351     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_CENTERALIGN) {
00352         x -= (cxPopup / 2);
00353     } <span class="keywordflow">else</span> {
00354         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = (ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o4">fDroppedLeft</a> ? <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a> : <a class="code" href="../../d4/d1/userk_8h.html#a537">PAS_RIGHT</a>);
00355     }
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">// Vertical alignment</span>
00359     <span class="comment">//</span>
00360     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_BOTTOMALIGN) {
00361 <span class="preprocessor">#if DBG</span>
00362 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_VCENTERALIGN) {
00363             RIPMSG0(RIP_WARNING, <span class="stringliteral">"TrackPopupMenuEx:  TPM_VCENTERALIGN ignored"</span>);
00364         }
00365 <span class="preprocessor">#endif // DBG</span>
00366 <span class="preprocessor"></span>
00367         y -= cyPopup;
00368         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a540">PAS_UP</a>;
00369     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_VCENTERALIGN) {
00370         y -= (cyPopup / 2);
00371     } <span class="keywordflow">else</span> {
00372         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a539">PAS_DOWN</a>;
00373     }
00374     <span class="comment">/*</span>
00375 <span class="comment">     * If the caller provided an animation direction, use that instead</span>
00376 <span class="comment">     */</span>
00377     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_ANIMATIONBITS) {
00378         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &gt;&gt; TPM_FIRSTANIBITPOS) &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a543">PAS_VERT</a> | <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>));
00379     }
00380     <span class="comment">//</span>
00381     <span class="comment">// Get coords to move to.</span>
00382     <span class="comment">//</span>
00383     sizeHierarchy = <a class="code" href="../../d4/d1/userk_8h.html#a1598">FindBestPos</a>(
00384             x,
00385             y,
00386             cxPopup,
00387             cyPopup,
00388             ((lpTpm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? &amp;rcExclude : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>),
00389             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
00390             ppopupMenuHierarchy,
00391             pMonitor);
00392 
00393 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00394 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOwner, WEFLAYOUTRTL) &amp;&amp; (ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>)) {
00395         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> ^= <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>;
00396     }
00397 <span class="preprocessor">#endif</span>
00398 <span class="preprocessor"></span>
00399     <span class="comment">/*</span>
00400 <span class="comment">     * If we have an animation direction and the caller wants animation,</span>
00401 <span class="comment">     *  set the bit to get it going.</span>
00402 <span class="comment">     */</span>
00403     <span class="keywordflow">if</span> ((ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> != 0) &amp;&amp; !(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; TPM_NOANIMATION)) {
00404         ppopupMenuHierarchy-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a541">PAS_OUT</a>;
00405     }
00406 
00407     <span class="comment">/*</span>
00408 <span class="comment">     * Show the window. Modeless menus are not topmost and get activated.</span>
00409 <span class="comment">     *  Modal menus are topmost but don't get activated.</span>
00410 <span class="comment">     */</span>
00411     <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a924">USER_SOUND_MENUPOPUP</a>);
00412     <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndHierarchy,
00413             (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> ? <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a> : <a class="code" href="../../d4/d1/userk_8h.html#a455">PWND_TOPMOST</a>),
00414             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(sizeHierarchy), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(sizeHierarchy), 0, 0,
00415             SWP_SHOWWINDOW | SWP_NOSIZE | SWP_NOOWNERZORDER
00416             | (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> ? 0 : SWP_NOACTIVATE));
00417 
00418     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00419         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MENUPOPUPSTART, pwndHierarchy, OBJID_CLIENT, INDEXID_CONTAINER, 0);
00420     }
00421     <span class="comment">//</span>
00422     <span class="comment">// We need to return TRUE for compatibility w/ async TrackPopupMenu().</span>
00423     <span class="comment">// It is conceivable that a menu ID could have ID 0, in which case just</span>
00424     <span class="comment">// returning the cmd chosen would return FALSE instead of TRUE.</span>
00425     <span class="comment">//</span>
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// If mouse is in client of popup, act like clicked down</span>
00429     <span class="comment">//</span>
00430     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> = fButtonDown;
00431 
00432     cmd = <a class="code" href="../../d4/d1/userk_8h.html#a1401">xxxMNLoop</a>(ppopupMenuHierarchy, pMenuState, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00433 
00434     <span class="comment">/*</span>
00435 <span class="comment">     * If this is a modeless menu, return without clenning up because</span>
00436 <span class="comment">     *  the menu is up.</span>
00437 <span class="comment">     */</span>
00438     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00439         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndHierarchy);
00440         <span class="keywordflow">goto</span> ReturnCmdOrTrue;
00441     }
00442 
00443 CleanupTrackPopupMenuEx:
00444 
00445     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndHierarchy)) {
00446         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndHierarchy, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
00447             <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwndHierarchy);
00448         }
00449     }
00450 
00451     <span class="keywordflow">if</span> (pMenuState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00452         <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00453     }
00454 
00455     <span class="comment">/*</span>
00456 <span class="comment">     * Capture must be unlocked if no menu is active.</span>
00457 <span class="comment">     */</span>
00458     UserAssert(!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>)
00459             || ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00460                 &amp;&amp; !ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>));
00461 
00462 
00463 ReturnCmdOrTrue:
00464     <span class="keywordflow">return</span>(fSync ? cmd : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00465 }
00466 
00467 <span class="comment">/***************************************************************************\</span>
00468 <span class="comment">*</span>
00469 <span class="comment">* FindBestPos()</span>
00470 <span class="comment">*</span>
00471 <span class="comment">* Gets best point to move popup menu window to, given exclusion area and</span>
00472 <span class="comment">* screen real estate.  Note that for our purposes, we consider center</span>
00473 <span class="comment">* alignment to be the same as left/top alignment.</span>
00474 <span class="comment">*</span>
00475 <span class="comment">* We try to pin the menu to a particular monitor, to avoid having it</span>
00476 <span class="comment">* cross.</span>
00477 <span class="comment">*</span>
00478 <span class="comment">* We try four possibilities if the original position fails.  The order of</span>
00479 <span class="comment">* these is determined by the alignment and "try" flags.  Basically, we try</span>
00480 <span class="comment">* to move the rectangle out of the exclusion area by sliding it horizontally</span>
00481 <span class="comment">* or vertically without going offscreen.  If we can't, then we know that</span>
00482 <span class="comment">* sliding it in both dimensions will also fail.  So we use the original</span>
00483 <span class="comment">* point, clipping on screen.</span>
00484 <span class="comment">*</span>
00485 <span class="comment">* Take the example of a top-left justified popup, which should be moved</span>
00486 <span class="comment">* horizontally before vertically.  We'll try the original point.  Then</span>
00487 <span class="comment">* we'll try to left-justify with the right edge of the exclude rect.  Then</span>
00488 <span class="comment">* we'll try to top-justify with the bottom edge of the exclude rect.  Then</span>
00489 <span class="comment">* we'll try to right-justify with the left edge of the exclude rect.  Then</span>
00490 <span class="comment">* we'll try to bottom-justify with the top edge of the exclude rect.</span>
00491 <span class="comment">* Finally, we'll use the original pos.</span>
00492 <span class="comment">*</span>
00493 <span class="comment">\***************************************************************************/</span>
00494 
00495 LONG
<a name="l00496"></a><a class="code" href="../../d4/d1/userk_8h.html#a1598">00496</a> <a class="code" href="../../d4/d1/userk_8h.html#a1598">FindBestPos</a>(
00497         <span class="keywordtype">int</span>         x,
00498         <span class="keywordtype">int</span>         y,
00499         <span class="keywordtype">int</span>         cx,
00500         <span class="keywordtype">int</span>         cy,
00501         LPRECT      prcExclude,
00502         UINT        wFlags,
00503         <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>  ppopupmenu,
00504         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor)
00505 {
00506     <span class="keywordtype">int</span> iRect;
00507     <span class="keywordtype">int</span> iT;
00508     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> awRect[4];
00509     POINT ptT;
00510     RECT rcExclude;
00511     <span class="comment">//</span>
00512     <span class="comment">// Clip our coords on screen first.  We use the same algorithm to clip</span>
00513     <span class="comment">// as in Win3.1 for dudes with no exclude rect.</span>
00514     <span class="comment">//</span>
00515 
00516     <span class="keywordflow">if</span> (prcExclude!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00517         <span class="comment">// Clip exclude rect to monitor!</span>
00518         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcExclude, prcExclude);
00519         <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcExclude, &amp;rcExclude, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>);
00520     } <span class="keywordflow">else</span> {
00521         <a class="code" href="../../d3/d6/rect_8c.html#a1">SetRect</a>(&amp;rcExclude, x, y, x, y);
00522     }
00523 
00524 
00525     <span class="comment">/*</span>
00526 <span class="comment">     * Make sure popup fits completely on the screen</span>
00527 <span class="comment">     * At least the x,y point will be on the screen.</span>
00528 <span class="comment">     */</span>
00529     <span class="keywordflow">if</span> (x + cx &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right) {
00530         <span class="keywordflow">if</span> ((wFlags &amp; TPM_CENTERALIGN)
00531                 || (x - cx &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left)
00532                 || (x &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right)) {
00533             x = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - cx;
00534         } <span class="keywordflow">else</span> {
00535             x -= cx;
00536         }
00537         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>) {
00538             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a14">COPY_FLAG</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a>, <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a>, <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>);
00539         }
00540     }
00541 
00542     <span class="keywordflow">if</span> (x &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left) {
00543         x += cx;
00544         <span class="keywordflow">if</span> ((wFlags &amp; TPM_CENTERALIGN)
00545                 || (x &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right)
00546                 || (x &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left)) {
00547             x = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left;
00548         }
00549         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>) {
00550             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a14">COPY_FLAG</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a>, <a class="code" href="../../d4/d1/userk_8h.html#a537">PAS_RIGHT</a>, <a class="code" href="../../d4/d1/userk_8h.html#a542">PAS_HORZ</a>);
00551         }
00552     }
00553 
00554 
00555     <span class="keywordflow">if</span> (y + <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom) {
00556         <span class="keywordflow">if</span> ((wFlags &amp; TPM_VCENTERALIGN)
00557                 || (y - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top)
00558                 || (y &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom)) {
00559             y = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00560         } <span class="keywordflow">else</span> {
00561             y -= <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00562         }
00563         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a543">PAS_VERT</a>) {
00564             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a14">COPY_FLAG</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a>, <a class="code" href="../../d4/d1/userk_8h.html#a540">PAS_UP</a>, <a class="code" href="../../d4/d1/userk_8h.html#a543">PAS_VERT</a>);
00565         }
00566     }
00567 
00568     <span class="keywordflow">if</span> (y &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top) {
00569         y += <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00570         <span class="keywordflow">if</span> ((wFlags &amp; TPM_VCENTERALIGN)
00571                 || (y &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom)
00572                 || (y &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top)) {
00573             y = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top;
00574         }
00575         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a543">PAS_VERT</a>) {
00576             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a14">COPY_FLAG</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a>, <a class="code" href="../../d4/d1/userk_8h.html#a539">PAS_DOWN</a>, <a class="code" href="../../d4/d1/userk_8h.html#a543">PAS_VERT</a>);
00577         }
00578     }
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// Try first point</span>
00582     <span class="comment">//</span>
00583     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/mnpopup_8c.html#a5">TryRect</a>(<a class="code" href="../../d2/d3/mnpopup_8c.html#a4">RECT_ORG</a>, x, y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, &amp;rcExclude, &amp;ptT, pMonitor))
00584         <span class="keywordflow">goto</span> FOUND;
00585 
00586     <span class="comment">//</span>
00587     <span class="comment">// Sort possibilities.  Get offset of horizontal rects.</span>
00588     <span class="comment">//</span>
00589     iRect = (wFlags &amp; TPM_VERTICAL) ? 2 : 0;
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Sort horizontally.  Note that we treat TPM_CENTERALIGN like</span>
00593     <span class="comment">// TPM_LEFTALIGN.</span>
00594     <span class="comment">//</span>
00595     <span class="comment">//</span>
00596     <span class="comment">// If we're right-aligned, try to right-align on left side first.</span>
00597     <span class="comment">// Otherwise, try to left-align on right side first.</span>
00598     <span class="comment">//</span>
00599     iT = (wFlags &amp; TPM_RIGHTALIGN) ? 0 : 2;
00600 
00601     awRect[0 + iRect] = <a class="code" href="../../d2/d3/mnpopup_8c.html#a0">RECT_ONLEFT</a> + iT;
00602     awRect[1 + iRect] = <a class="code" href="../../d2/d3/mnpopup_8c.html#a2">RECT_ONRIGHT</a> - iT;
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// Sort vertically.  Note that we treat TPM_VCENTERALIGN like</span>
00606     <span class="comment">// TPM_TOPALIGN.</span>
00607     <span class="comment">//</span>
00608     <span class="comment">// If we're bottom-aligned, try to bottom-align with top of rect</span>
00609     <span class="comment">// first.  Otherwise, try to top-align with bottom of exclusion first.</span>
00610     <span class="comment">//</span>
00611     iT = (wFlags &amp; TPM_BOTTOMALIGN) ? 0 : 2;
00612 
00613     awRect[2 - iRect] = <a class="code" href="../../d2/d3/mnpopup_8c.html#a1">RECT_ONTOP</a> + iT;
00614     awRect[3 - iRect] = <a class="code" href="../../d2/d3/mnpopup_8c.html#a3">RECT_ONBOTTOM</a> - iT;
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// Loop through sorted alternatives.  Note that TryRect fails immediately</span>
00618     <span class="comment">// if an exclusion coordinate is too close to screen edge.</span>
00619     <span class="comment">//</span>
00620 
00621     <span class="keywordflow">for</span> (iRect = 0; iRect &lt; 4; iRect++) {
00622         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/mnpopup_8c.html#a5">TryRect</a>(awRect[iRect], x, y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, &amp;rcExclude, &amp;ptT, pMonitor)) {
00623             <span class="keywordflow">switch</span> (awRect[iRect])
00624             {
00625                 <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/mnpopup_8c.html#a1">RECT_ONTOP</a>:
00626                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = <a class="code" href="../../d4/d1/userk_8h.html#a540">PAS_UP</a>;
00627                     <span class="keywordflow">break</span>;
00628                 <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/mnpopup_8c.html#a0">RECT_ONLEFT</a>:
00629                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = <a class="code" href="../../d4/d1/userk_8h.html#a538">PAS_LEFT</a>;
00630                     <span class="keywordflow">break</span>;
00631                 <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/mnpopup_8c.html#a3">RECT_ONBOTTOM</a>:
00632                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = <a class="code" href="../../d4/d1/userk_8h.html#a539">PAS_DOWN</a>;
00633                     <span class="keywordflow">break</span>;
00634                 <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/mnpopup_8c.html#a2">RECT_ONRIGHT</a>:
00635                     ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o24">iDropDir</a> = <a class="code" href="../../d4/d1/userk_8h.html#a537">PAS_RIGHT</a>;
00636                     <span class="keywordflow">break</span>;
00637             }
00638 
00639             x = ptT.x;
00640             y = ptT.y;
00641             <span class="keywordflow">break</span>;
00642         }
00643     }
00644 
00645 FOUND:
00646     <span class="keywordflow">return</span> MAKELONG(x, y);
00647 }
00648 
00649 
00650 
00651 <span class="comment">/***************************************************************************\</span>
00652 <span class="comment">*</span>
00653 <span class="comment">*  TryRect()</span>
00654 <span class="comment">*</span>
00655 <span class="comment">*  Tries to fit rect on screen without covering exclusion area.  Returns</span>
00656 <span class="comment">*  TRUE if success.</span>
00657 <span class="comment">*</span>
00658 <span class="comment">\***************************************************************************/</span>
00659 
00660 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00661"></a><a class="code" href="../../d2/d3/mnpopup_8c.html#a5">00661</a> <a class="code" href="../../d2/d3/mnpopup_8c.html#a5">TryRect</a>(
00662         UINT        wRect,
00663         <span class="keywordtype">int</span>         x,
00664         <span class="keywordtype">int</span>         y,
00665         <span class="keywordtype">int</span>         cx,
00666         <span class="keywordtype">int</span>         cy,
00667         LPRECT      prcExclude,
00668         LPPOINT     ppt,
00669         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor)
00670 {
00671     RECT rcTry;
00672 
00673     <span class="keywordflow">switch</span> (wRect) {
00674         <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/mnpopup_8c.html#a2">RECT_ONRIGHT</a>:
00675             x = prcExclude-&gt;right;
00676             <span class="keywordflow">if</span> (x + cx &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right)
00677                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00678             <span class="keywordflow">break</span>;
00679 
00680         <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/mnpopup_8c.html#a3">RECT_ONBOTTOM</a>:
00681             y = prcExclude-&gt;bottom;
00682             <span class="keywordflow">if</span> (y + <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> &gt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom)
00683                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684             <span class="keywordflow">break</span>;
00685 
00686         <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/mnpopup_8c.html#a0">RECT_ONLEFT</a>:
00687             x = prcExclude-&gt;left - cx;
00688             <span class="keywordflow">if</span> (x &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left)
00689                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00690             <span class="keywordflow">break</span>;
00691 
00692         <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/mnpopup_8c.html#a1">RECT_ONTOP</a>:
00693             y = prcExclude-&gt;top - <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00694             <span class="keywordflow">if</span> (y &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top)
00695                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00696             <span class="keywordflow">break</span>;
00697 
00698         <span class="comment">//</span>
00699         <span class="comment">// case RECT_ORG:</span>
00700         <span class="comment">//      NOP;</span>
00701         <span class="comment">//      break;</span>
00702         <span class="comment">//</span>
00703     }
00704 
00705     ppt-&gt;x = x;
00706     ppt-&gt;y = y;
00707 
00708     rcTry.left      = x;
00709     rcTry.top       = y;
00710     rcTry.right     = x + cx;
00711     rcTry.bottom    = y + <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00712 
00713     <span class="keywordflow">return</span>(!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcTry, &amp;rcTry, prcExclude));
00714 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
