<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ldrsnap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ldrsnap.c</h1><a href="../../d2/d3/ldrsnap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ldrsnap.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the guts of the Ldr Dll Snap Routine.</span>
00012 <span class="comment">    This code is system code that is part of the executive, but</span>
00013 <span class="comment">    is executed from both user and system space.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Mike O'Leary (mikeol) 23-Mar-1990</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
<a name="l00023"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a0">00023</a> <span class="preprocessor">#define LDRDBG 0</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#include "<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>"</span>
00026 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00027 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00028 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d9/heap_8h.html">heap.h</a>&gt;</span>
00030 <span class="preprocessor">#include "<a class="code" href="../../d9/d2/ldrp_8h.html">ldrp.h</a>"</span>
00031 
00032 <span class="preprocessor">#if DBG // DBG</span>
00033 <span class="preprocessor"></span>PUCHAR MonthOfYear[] = { <span class="stringliteral">"Jan"</span>, <span class="stringliteral">"Feb"</span>, <span class="stringliteral">"Mar"</span>, <span class="stringliteral">"Apr"</span>, <span class="stringliteral">"May"</span>, <span class="stringliteral">"Jun"</span>,
00034                          <span class="stringliteral">"Jul"</span>, <span class="stringliteral">"Aug"</span>, <span class="stringliteral">"Sep"</span>, <span class="stringliteral">"Oct"</span>, <span class="stringliteral">"Nov"</span>, <span class="stringliteral">"Dec"</span> };
00035 PUCHAR DaysOfWeek[] =  { <span class="stringliteral">"Sun"</span>, <span class="stringliteral">"Mon"</span>, <span class="stringliteral">"Tue"</span>, <span class="stringliteral">"Wed"</span>, <span class="stringliteral">"Thu"</span>, <span class="stringliteral">"Fri"</span>, <span class="stringliteral">"Sat"</span> };
00036 LARGE_INTEGER MapBeginTime, MapEndTime, MapElapsedTime;
00037 <span class="preprocessor">#endif // DBG</span>
00038 <span class="preprocessor"></span>
00039 <span class="preprocessor">#if defined (_ALPHA_)</span>
00040 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00041 AlphaFindArchitectureFixups(
00042     PIMAGE_NT_HEADERS NtHeaders,
00043     PVOID ViewBase,
00044     BOOLEAN StaticLink
00045     );
00046 <span class="preprocessor">#endif</span>
00047 <span class="preprocessor"></span>
00048 
00049 <span class="preprocessor">#if defined (_X86_)</span>
00050 <span class="preprocessor"></span><span class="keyword">extern</span> PVOID LdrpLockPrefixTable;
00051 
00052 <span class="comment">//</span>
00053 <span class="comment">// Specify address of kernel32 lock prefixes</span>
00054 <span class="comment">//</span>
00055 IMAGE_LOAD_CONFIG_DIRECTORY _load_config_used = {
00056     0,                             <span class="comment">// Reserved</span>
00057     0,                             <span class="comment">// Reserved</span>
00058     0,                             <span class="comment">// Reserved</span>
00059     0,                             <span class="comment">// Reserved</span>
00060     0,                             <span class="comment">// GlobalFlagsClear</span>
00061     0,                             <span class="comment">// GlobalFlagsSet</span>
00062     0,                             <span class="comment">// CriticalSectionTimeout (milliseconds)</span>
00063     0,                             <span class="comment">// DeCommitFreeBlockThreshold</span>
00064     0,                             <span class="comment">// DeCommitTotalFreeThreshold</span>
00065     (ULONG_PTR) &amp;LdrpLockPrefixTable,  <span class="comment">// LockPrefixTable</span>
00066     0, 0, 0, 0, 0, 0, 0            <span class="comment">// Reserved</span>
00067 };
00068 
00069 <span class="keywordtype">void</span>
00070 LdrpValidateImageForMp(
00071     IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry
00072     )
00073 {
00074     PIMAGE_LOAD_CONFIG_DIRECTORY ImageConfigData;
00075     ULONG i;
00076     PUCHAR *pb;
00077     ULONG ErrorParameters;
00078     ULONG ErrorResponse;
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">// If we are on an MP system and the DLL has image config info, check to see</span>
00082     <span class="comment">// if it has a lock prefix table and make sure the locks have not been converted</span>
00083     <span class="comment">// to NOPs</span>
00084     <span class="comment">//</span>
00085 
00086     ImageConfigData = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( LdrDataTableEntry-&gt;DllBase,
00087                                                     TRUE,
00088                                                     IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG,
00089                                                     &amp;i
00090                                                   );
00091 
00092     <span class="keywordflow">if</span> (ImageConfigData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00093         i == <span class="keyword">sizeof</span>( *ImageConfigData ) &amp;&amp;
00094         ImageConfigData-&gt;LockPrefixTable ) {
00095             pb = (PUCHAR *)ImageConfigData-&gt;LockPrefixTable;
00096             <span class="keywordflow">while</span> ( *pb ) {
00097                 <span class="keywordflow">if</span> ( **pb == (UCHAR)0x90 ) {
00098 
00099                     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a> &gt; 1 ) {
00100 
00101                         <span class="comment">//</span>
00102                         <span class="comment">// Hard error time. One of the know DLL's is corrupt !</span>
00103                         <span class="comment">//</span>
00104 
00105                         ErrorParameters = (ULONG)&amp;LdrDataTableEntry-&gt;BaseDllName;
00106 
00107                         <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
00108                             STATUS_IMAGE_MP_UP_MISMATCH,
00109                             1,
00110                             1,
00111                             &amp;ErrorParameters,
00112                             OptionOk,
00113                             &amp;ErrorResponse
00114                             );
00115 
00116                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
00117                             <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
00118                             }
00119 
00120                         }
00121                     }
00122                 pb++;
00123                 }
00124         }
00125 }
00126 <span class="preprocessor">#endif</span>
00127 <span class="preprocessor"></span>
00128 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00129 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor</a> (
00130     IN PWSTR DllPath OPTIONAL,
00131     IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry
00132     );
00133 
00134 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00135 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a40">LdrpDphInitializeTargetDll</a> (
00136     PLDR_DATA_TABLE_ENTRY LoadedDllData
00137     );
00138 
00139 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00140"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a41">00140</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a41">LdrpLoadImportModule</a>(
00141     IN PWSTR DllPath OPTIONAL,
00142     IN LPSTR ImportName,
00143     IN PVOID DllBaseImporter,
00144     OUT PLDR_DATA_TABLE_ENTRY *DataTableEntry,
00145     OUT PBOOLEAN AlreadyLoaded
00146     )
00147 {
00148     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00149     ANSI_STRING AnsiString;
00150     PUNICODE_STRING ImportDescriptorName_U;
00151     BOOLEAN Wx86KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00152 
00153     ImportDescriptorName_U = &amp;NtCurrentTeb()-&gt;StaticUnicodeString;
00154     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
00155     st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(ImportDescriptorName_U, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00156     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00157         <span class="keywordflow">return</span> st;
00158     }
00159 
00160 
00161 <span class="preprocessor">#if defined (WX86)</span>
00162 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Wx86ProcessInit) {
00163         Wx86KnownDll = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DllBaseImporter)-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386;
00164         }
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">// BUGBUG If a DLL refers to itself we will recurse and blow up</span>
00170     <span class="comment">//</span>
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Check the LdrTable to see if Dll has already been mapped</span>
00174     <span class="comment">// into this image. If not, map it.</span>
00175     <span class="comment">//</span>
00176 
00177     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( DllPath,
00178                                ImportDescriptorName_U,
00179                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00180                                Wx86KnownDll,
00181                                DataTableEntry
00182                              )
00183        ) {
00184         *AlreadyLoaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00185     } <span class="keywordflow">else</span> {
00186         *AlreadyLoaded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00187 
00188         st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a46">LdrpMapDll</a>(DllPath,
00189                         ImportDescriptorName_U-&gt;Buffer,
00190                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00191                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00192                         Wx86KnownDll,
00193                         DataTableEntry
00194                         );
00195 
00196         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00197             <span class="keywordflow">return</span> st;
00198         }
00199         st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor</a>(
00200                 DllPath,
00201                 *DataTableEntry
00202                 );
00203         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00204             InsertTailList(&amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList,
00205                            &amp;(*DataTableEntry)-&gt;InInitializationOrderLinks);
00206         }
00207     }
00208 
00209     <span class="keywordflow">return</span> st;
00210 }
00211 
00212 
00213 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00214"></a><a class="code" href="../../d9/d2/ldrp_8h.html#a62">00214</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor</a> (
00215     IN PWSTR DllPath OPTIONAL,
00216     IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry
00217     )
00218 
00219 <span class="comment">/*++</span>
00220 <span class="comment"></span>
00221 <span class="comment">Routine Description:</span>
00222 <span class="comment"></span>
00223 <span class="comment">    This is a recursive routine which walks the Import Descriptor</span>
00224 <span class="comment">    Table and loads each DLL that is referenced.</span>
00225 <span class="comment"></span>
00226 <span class="comment">Arguments:</span>
00227 <span class="comment"></span>
00228 <span class="comment">    DllPath - Supplies an optional search path to be used to locate</span>
00229 <span class="comment">        the DLL.</span>
00230 <span class="comment"></span>
00231 <span class="comment">    LdrDataTableEntry - Supplies the address of the data table entry</span>
00232 <span class="comment">        to initialize.</span>
00233 <span class="comment"></span>
00234 <span class="comment">Return Value:</span>
00235 <span class="comment"></span>
00236 <span class="comment">    Status value.</span>
00237 <span class="comment"></span>
00238 <span class="comment">--*/</span>
00239 
00240 {
00241     ULONG i, ImportSize, NewImportSize;
00242     BOOLEAN AlreadyLoaded, SnapForwardersOnly, StaleBinding;
00243     PLDR_DATA_TABLE_ENTRY DataTableEntry, FwdDataTableEntry;
00244     PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor;
00245     PIMAGE_BOUND_IMPORT_DESCRIPTOR NewImportDescriptor;
00246     PIMAGE_BOUND_FORWARDER_REF NewImportForwarder;
00247     PSZ ImportName, NewImportName, NewFwdImportName, NewImportStringBase;
00248     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00249     PIMAGE_NT_HEADERS ExportNtHeaders;
00250     PVOID ImportBase;
00251     ULONG RegionSize;
00252     PIMAGE_THUNK_DATA Thunk,<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00253     PIMAGE_THUNK_DATA FirstThunk;
00254     PPEB Peb = NtCurrentPeb();
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// See if there is a bound import table.  If so, walk that to</span>
00258     <span class="comment">// verify if the binding is good.  If so, then succeed with</span>
00259     <span class="comment">// having touched the .idata section, as all the information</span>
00260     <span class="comment">// in the bound imports table is stored in the header.  If any</span>
00261     <span class="comment">// are stale, then fall out into the unbound case.</span>
00262     <span class="comment">//</span>
00263     NewImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00264                            LdrDataTableEntry-&gt;DllBase,
00265                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00266                            IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT,
00267                            &amp;NewImportSize
00268                            );
00269 
00270     ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00271                         LdrDataTableEntry-&gt;DllBase,
00272                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00273                         IMAGE_DIRECTORY_ENTRY_IMPORT,
00274                         &amp;ImportSize
00275                         );
00276 
00277 
00278     <span class="keywordflow">if</span> (NewImportDescriptor) {
00279         NewImportStringBase = (LPSTR)NewImportDescriptor;
00280         <span class="keywordflow">while</span> (NewImportDescriptor-&gt;OffsetModuleName) {
00281             NewImportName = NewImportStringBase +
00282                          NewImportDescriptor-&gt;OffsetModuleName;
00283 
00284             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00285                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ bound to %s\n"</span>,
00286                     &amp;LdrDataTableEntry-&gt;BaseDllName,
00287                     NewImportName
00288                     );
00289             }
00290 
00291             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a41">LdrpLoadImportModule</a>( DllPath,
00292                                        NewImportName,
00293                                        LdrDataTableEntry-&gt;DllBase,
00294                                        &amp;DataTableEntry,
00295                                        &amp;AlreadyLoaded
00296                                        );
00297             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00298                 <span class="keywordflow">return</span> st;
00299             }
00300 
00301             <span class="comment">//</span>
00302             <span class="comment">// Add to initialization list.</span>
00303             <span class="comment">//</span>
00304 
00305             <span class="keywordflow">if</span> (!AlreadyLoaded) {
00306                 InsertTailList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
00307                                &amp;DataTableEntry-&gt;InInitializationOrderLinks);
00308             }
00309 
00310 <span class="preprocessor">#if defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
00311 <span class="preprocessor"></span>            ExportNtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(LdrDataTableEntry-&gt;DllBase);
00312 
00313             <span class="keywordflow">if</span> ((ExportNtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
00314                 (ExportNtHeaders-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386)) {
00315                 <span class="keywordflow">if</span> (LdrpWx86DllHasRelocatedSharedSection(LdrDataTableEntry-&gt;DllBase)) {
00316                    DataTableEntry-&gt;Flags |= LDRP_IMAGE_NOT_AT_BASE;
00317                 }
00318             }
00319 <span class="preprocessor">#endif // defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
00320 <span class="preprocessor"></span>
00321             <span class="keywordflow">if</span> ( NewImportDescriptor-&gt;TimeDateStamp != DataTableEntry-&gt;TimeDateStamp ||
00322                  (DataTableEntry-&gt;Flags &amp; LDRP_IMAGE_NOT_AT_BASE) ) {
00323                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00324                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ has stale binding to %s\n"</span>,
00325                             &amp;LdrDataTableEntry-&gt;BaseDllName,
00326                             NewImportName
00327                             );
00328                 }
00329                 StaleBinding = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00330             } <span class="keywordflow">else</span> {
00331 <span class="preprocessor">#if DBG</span>
00332 <span class="preprocessor"></span>                LdrpSnapBypass++;
00333 <span class="preprocessor">#endif</span>
00334 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00335                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ has correct binding to %s\n"</span>,
00336                             &amp;LdrDataTableEntry-&gt;BaseDllName,
00337                             NewImportName
00338                             );
00339                 }
00340                 StaleBinding = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00341             }
00342 
00343             NewImportForwarder = (PIMAGE_BOUND_FORWARDER_REF)(NewImportDescriptor+1);
00344             <span class="keywordflow">for</span> (i=0; i&lt;NewImportDescriptor-&gt;NumberOfModuleForwarderRefs; i++) {
00345                 NewFwdImportName = NewImportStringBase +
00346                                 NewImportForwarder-&gt;OffsetModuleName;
00347                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00348                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ bound to %s via forwarder(s) from %wZ\n"</span>,
00349                         &amp;LdrDataTableEntry-&gt;BaseDllName,
00350                         NewFwdImportName,
00351                         &amp;DataTableEntry-&gt;BaseDllName
00352                         );
00353                 }
00354 
00355                 st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a41">LdrpLoadImportModule</a>( DllPath,
00356                                            NewFwdImportName,
00357                                            LdrDataTableEntry-&gt;DllBase,
00358                                            &amp;FwdDataTableEntry,
00359                                            &amp;AlreadyLoaded
00360                                            );
00361                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00362                     <span class="keywordflow">if</span> (!AlreadyLoaded) {
00363                         InsertTailList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
00364                                        &amp;FwdDataTableEntry-&gt;InInitializationOrderLinks);
00365                         }
00366                     }
00367 
00368                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ||
00369                      NewImportForwarder-&gt;TimeDateStamp != FwdDataTableEntry-&gt;TimeDateStamp ||
00370                      (FwdDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_NOT_AT_BASE ) ) {
00371                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00372                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ has stale binding to %s\n"</span>,
00373                                 &amp;LdrDataTableEntry-&gt;BaseDllName,
00374                                 NewFwdImportName
00375                                 );
00376                     }
00377                     StaleBinding = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00378                 } <span class="keywordflow">else</span> {
00379 <span class="preprocessor">#if DBG</span>
00380 <span class="preprocessor"></span>                    LdrpSnapBypass++;
00381 <span class="preprocessor">#endif</span>
00382 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00383                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ has correct binding to %s\n"</span>,
00384                                 &amp;LdrDataTableEntry-&gt;BaseDllName,
00385                                 NewFwdImportName
00386                                 );
00387                     }
00388                 }
00389 
00390                 NewImportForwarder += 1;
00391             }
00392             NewImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)NewImportForwarder;
00393 
00394             <span class="keywordflow">if</span> (StaleBinding) {
00395 <span class="preprocessor">#if DBG</span>
00396 <span class="preprocessor"></span>                LdrpNormalSnap++;
00397 <span class="preprocessor">#endif</span>
00398 <span class="preprocessor"></span>                <span class="comment">//</span>
00399                 <span class="comment">// Find the unbound import descriptor that matches this bound</span>
00400                 <span class="comment">// import descriptor</span>
00401                 <span class="comment">//</span>
00402 
00403                 ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00404                                     LdrDataTableEntry-&gt;DllBase,
00405                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00406                                     IMAGE_DIRECTORY_ENTRY_IMPORT,
00407                                     &amp;ImportSize
00408                                     );
00409 
00410                 <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name) {
00411                     ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;Name);
00412                     <span class="keywordflow">if</span> (!_stricmp(ImportName, NewImportName)) {
00413                         <span class="keywordflow">break</span>;
00414                     }
00415 
00416                     ImportDescriptor += 1;
00417                 }
00418 
00419                 <span class="keywordflow">if</span> (!ImportDescriptor-&gt;Name) {
00420                     <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
00421                 }
00422 
00423                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00424                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Stale Bind %s from %wZ\n"</span>,ImportName,&amp;LdrDataTableEntry-&gt;BaseDllName);
00425                 }
00426 
00427                 st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a48">LdrpSnapIAT</a>(
00428                         DataTableEntry,
00429                         LdrDataTableEntry,
00430                         ImportDescriptor,
00431                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00432                         );
00433 
00434                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00435                     <span class="keywordflow">return</span> st;
00436                 }
00437             }
00438         }
00439     }
00440     <span class="keywordflow">else</span>
00441     <span class="keywordflow">if</span> (ImportDescriptor) {
00442         <span class="comment">//</span>
00443         <span class="comment">// For each DLL used by this DLL, load the dll. Then snap</span>
00444         <span class="comment">// the IAT, and call the DLL's init routine.</span>
00445         <span class="comment">//</span>
00446 
00447         <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name &amp;&amp; ImportDescriptor-&gt;FirstThunk) {
00448             ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;Name);
00449 
00450             <span class="comment">//</span>
00451             <span class="comment">// check for import that has no references</span>
00452             <span class="comment">//</span>
00453             FirstThunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;FirstThunk);
00454             <span class="keywordflow">if</span> ( !FirstThunk-&gt;u1.Function ) {
00455                 <span class="keywordflow">goto</span> skipimport;
00456                 }
00457 
00458             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00459                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %s used by %wZ\n"</span>,
00460                     ImportName,
00461                     &amp;LdrDataTableEntry-&gt;BaseDllName
00462                     );
00463             }
00464 
00465 
00466             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a41">LdrpLoadImportModule</a>( DllPath,
00467                                        ImportName,
00468                                        LdrDataTableEntry-&gt;DllBase,
00469                                        &amp;DataTableEntry,
00470                                        &amp;AlreadyLoaded
00471                                        );
00472             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00473                 <span class="keywordflow">return</span> st;
00474             }
00475 
00476             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00477                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Snapping imports for %wZ from %s\n"</span>,
00478                         &amp;LdrDataTableEntry-&gt;BaseDllName,
00479                         ImportName
00480                         );
00481             }
00482 
00483             <span class="comment">//</span>
00484             <span class="comment">// If the image has been bound and the import date stamp</span>
00485             <span class="comment">// matches the date time stamp in the export modules header,</span>
00486             <span class="comment">// and the image was mapped at it's prefered base address,</span>
00487             <span class="comment">// then we are done.</span>
00488             <span class="comment">//</span>
00489 
00490             SnapForwardersOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00491 
00492             <span class="keywordflow">if</span> ( ImportDescriptor-&gt;OriginalFirstThunk ) {
00493                 <span class="keywordflow">if</span> ( ImportDescriptor-&gt;TimeDateStamp &amp;&amp;
00494                      ImportDescriptor-&gt;TimeDateStamp == DataTableEntry-&gt;TimeDateStamp &amp;&amp;
00495                      (! DataTableEntry-&gt;Flags &amp; LDRP_IMAGE_NOT_AT_BASE) ) {
00496 <span class="preprocessor">#if DBG</span>
00497 <span class="preprocessor"></span>                    LdrpSnapBypass++;
00498 <span class="preprocessor">#endif</span>
00499 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00500                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Snap bypass %s from %wZ\n"</span>,
00501                             ImportName,
00502                             &amp;LdrDataTableEntry-&gt;BaseDllName
00503                             );
00504                     }
00505 
00506                     <span class="keywordflow">if</span> (ImportDescriptor-&gt;ForwarderChain == -1) {
00507                         <span class="keywordflow">goto</span> bypass_snap;
00508                         }
00509 
00510                     SnapForwardersOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00511 
00512                     }
00513             }
00514 <span class="preprocessor">#if DBG</span>
00515 <span class="preprocessor"></span>            LdrpNormalSnap++;
00516 <span class="preprocessor">#endif</span>
00517 <span class="preprocessor"></span>            <span class="comment">//</span>
00518             <span class="comment">// Add to initialization list.</span>
00519             <span class="comment">//</span>
00520 
00521             <span class="keywordflow">if</span> (!AlreadyLoaded) {
00522                 InsertTailList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
00523                                &amp;DataTableEntry-&gt;InInitializationOrderLinks);
00524             }
00525             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a48">LdrpSnapIAT</a>(
00526                     DataTableEntry,
00527                     LdrDataTableEntry,
00528                     ImportDescriptor,
00529                     SnapForwardersOnly
00530                     );
00531 
00532             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00533                 <span class="keywordflow">return</span> st;
00534             }
00535             AlreadyLoaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00536 bypass_snap:
00537             <span class="comment">//</span>
00538             <span class="comment">// Add to initialization list.</span>
00539             <span class="comment">//</span>
00540 
00541             <span class="keywordflow">if</span> (!AlreadyLoaded) {
00542                 InsertTailList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
00543                                &amp;DataTableEntry-&gt;InInitializationOrderLinks);
00544             }
00545 
00546 skipimport:
00547             ++ImportDescriptor;
00548         }
00549     }
00550 
00551     <span class="keywordflow">if</span> (Peb-&gt;NtGlobalFlag &amp; FLG_HEAP_ENABLE_TAG_BY_DLL) {
00552         PVOID IATBase;
00553         SIZE_T BigIATSize;
00554         ULONG  LittleIATSize;
00555         PVOID *ProcAddresses;
00556         ULONG NumberOfProcAddresses;
00557         ULONG OldProtect;
00558         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
00559 
00560         <span class="comment">//</span>
00561         <span class="comment">// Determine the location and size of the IAT.  If found, scan the</span>
00562         <span class="comment">// IAT address to see if any are pointing to RtlAllocateHeap.  If so</span>
00563         <span class="comment">// replace when with a pointer to a unique thunk function that will</span>
00564         <span class="comment">// replace the tag with a unique tag for this image.</span>
00565         <span class="comment">//</span>
00566 
00567         IATBase = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( LdrDataTableEntry-&gt;DllBase,
00568                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00569                                                 IMAGE_DIRECTORY_ENTRY_IAT,
00570                                                 &amp;LittleIATSize
00571                                               );
00572         BigIATSize = LittleIATSize;
00573         <span class="keywordflow">if</span> (IATBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00574             st = <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>( NtCurrentProcess(),
00575                                          &amp;IATBase,
00576                                          &amp;BigIATSize,
00577                                          PAGE_READWRITE,
00578                                          &amp;OldProtect
00579                                        );
00580             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00581                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Unable to unprotect IAT to enable tagging by DLL.\n"</span> );
00582             }
00583             <span class="keywordflow">else</span> {
00584                 ProcAddresses = (PVOID *)IATBase;
00585                 NumberOfProcAddresses = (ULONG)(BigIATSize / <span class="keyword">sizeof</span>(PVOID));
00586                 <span class="keywordflow">while</span> (NumberOfProcAddresses--) {
00587                     <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>) {
00588                         *ProcAddresses = <a class="code" href="../../d9/d2/ldrp_8h.html#a87">LdrpDefineDllTag</a>( LdrDataTableEntry-&gt;BaseDllName.Buffer, &amp;TagIndex );
00589                         <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00590                             *ProcAddresses = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>;
00591                         }
00592                     }
00593 
00594                     ProcAddresses += 1;
00595                 }
00596 
00597                 <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>( NtCurrentProcess(),
00598                                         &amp;IATBase,
00599                                         &amp;BigIATSize,
00600                                         OldProtect,
00601                                         &amp;OldProtect
00602                                       );
00603             }
00604         }
00605     }
00606 
00607     <span class="comment">//</span>
00608     <span class="comment">// Check if we need to redirect some imports in case page heap</span>
00609     <span class="comment">// is enabled and we target specific dlls.</span>
00610     <span class="comment">//</span>
00611 
00612     <span class="keywordflow">if</span> (Peb-&gt;NtGlobalFlag &amp; FLG_HEAP_PAGE_ALLOCS) {
00613         
00614         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a40">LdrpDphInitializeTargetDll</a> (LdrDataTableEntry);
00615     }
00616 
00617     <span class="keywordflow">return</span> STATUS_SUCCESS;
00618 }
00619 
00620 
00621 ULONG
<a name="l00622"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a42">00622</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a42">LdrpClearLoadInProgress</a>(
00623     VOID
00624     )
00625 {
00626     PLIST_ENTRY Head, Next;
00627     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00628     ULONG i;
00629 
00630     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList;
00631     Next = Head-&gt;Flink;
00632     i = 0;
00633     <span class="keywordflow">while</span> ( Next != Head ) {
00634         LdrDataTableEntry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InInitializationOrderLinks);
00635         LdrDataTableEntry-&gt;Flags &amp;= ~LDRP_LOAD_IN_PROGRESS;
00636 
00637         <span class="comment">//</span>
00638         <span class="comment">// return the number of entries that have not been processed, but</span>
00639         <span class="comment">// have init routines</span>
00640         <span class="comment">//</span>
00641 
00642         <span class="keywordflow">if</span> ( !(LdrDataTableEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED) &amp;&amp; LdrDataTableEntry-&gt;EntryPoint) {
00643             i++;
00644             }
00645 
00646         Next = Next-&gt;Flink;
00647         }
00648     <span class="keywordflow">return</span> i;
00649 }
00650 
00651 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00652"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a43">00652</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a43">LdrpRunInitializeRoutines</a>(
00653     IN PCONTEXT Context OPTIONAL
00654     )
00655 {
00656     PLIST_ENTRY Head, Next;
00657     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00658     PLDR_DATA_TABLE_ENTRY *LdrDataTableBase;
00659     PDLL_INIT_ROUTINE InitRoutine;
00660     BOOLEAN InitStatus;
00661     ULONG NumberOfRoutines;
00662     ULONG i;
00663     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00664     ULONG BreakOnDllLoad;
00665 
00666     <span class="comment">//</span>
00667     <span class="comment">// Run the Init routines</span>
00668     <span class="comment">//</span>
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// capture the entries that have init routines</span>
00672     <span class="comment">//</span>
00673 
00674     NumberOfRoutines = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a42">LdrpClearLoadInProgress</a>();
00675     <span class="keywordflow">if</span> ( NumberOfRoutines ) {
00676         LdrDataTableBase = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a18">TEMP_TAG</a> ),NumberOfRoutines*<span class="keyword">sizeof</span>(LdrDataTableBase));
00677         <span class="keywordflow">if</span> ( !LdrDataTableBase ) {
00678             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00679             }
00680         }
00681     <span class="keywordflow">else</span> {
00682         LdrDataTableBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00683         }
00684 
00685     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList;
00686     Next = Head-&gt;Flink;
00687     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00688         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Real INIT LIST\n"</span>);
00689         }
00690 
00691     i = 0;
00692     <span class="keywordflow">while</span> ( Next != Head ) {
00693         LdrDataTableEntry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InInitializationOrderLinks);
00694 
00695 <span class="preprocessor">#if defined (WX86)</span>
00696 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Wx86ProcessInit &amp;&amp; !(LdrDataTableEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED)) {
00697             PIMAGE_NT_HEADERS NtHeaders;
00698 
00699             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(LdrDataTableEntry-&gt;DllBase);
00700             <span class="keywordflow">if</span> (NtHeaders-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386) {
00701                 LdrpWx86DllMapNotify(LdrDataTableEntry-&gt;DllBase, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00702             }
00703         }
00704 <span class="preprocessor">#endif</span>
00705 <span class="preprocessor"></span>
00706         <span class="keywordflow">if</span> ( !(LdrDataTableEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED) &amp;&amp; LdrDataTableEntry-&gt;EntryPoint) {
00707             LdrDataTableBase[i] = LdrDataTableEntry;
00708             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00709                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"     %wZ init routine %x\n"</span>,
00710                         &amp;LdrDataTableEntry-&gt;FullDllName,
00711                         LdrDataTableEntry-&gt;EntryPoint
00712                         );
00713                 }
00714 
00715             i++;
00716             }
00717         LdrDataTableEntry-&gt;Flags |= LDRP_ENTRY_PROCESSED;
00718 
00719         Next = Next-&gt;Flink;
00720         }
00721     <span class="keywordflow">if</span> ( !LdrDataTableBase ) {
00722         <span class="keywordflow">return</span> STATUS_SUCCESS;
00723         }
00724 
00725     <span class="keywordflow">try</span> {
00726         i = 0;
00727         <span class="keywordflow">while</span> ( i &lt; NumberOfRoutines ) {
00728             LdrDataTableEntry = LdrDataTableBase[i];
00729             i++;
00730             InitRoutine = (PDLL_INIT_ROUTINE)LdrDataTableEntry-&gt;EntryPoint;
00731 
00732             <span class="comment">//</span>
00733             <span class="comment">// Walk through the entire list looking for un-processed</span>
00734             <span class="comment">// entries. For each entry, set the processed flag</span>
00735             <span class="comment">// and optionally call it's init routine</span>
00736             <span class="comment">//</span>
00737 
00738             BreakOnDllLoad = 0;
00739 <span class="preprocessor">#if DBG</span>
00740 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00741 <span class="preprocessor">#else</span>
00742 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (NtCurrentPeb()-&gt;BeingDebugged || NtCurrentPeb()-&gt;ReadImageFileExecOptions) {
00743 <span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( &amp;LdrDataTableEntry-&gt;BaseDllName,
00745                                                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"BreakOnDllLoad"</span>,
00746                                                             REG_DWORD,
00747                                                             &amp;BreakOnDllLoad,
00748                                                             <span class="keyword">sizeof</span>( BreakOnDllLoad ),
00749                                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00750                                                           );
00751                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00752                     BreakOnDllLoad = 0;
00753                     }
00754                 }
00755 
00756             <span class="keywordflow">if</span> (BreakOnDllLoad) {
00757                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00758                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: %wZ loaded."</span>, &amp;LdrDataTableEntry-&gt;BaseDllName );
00759                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">" - About to call init routine at %lx\n"</span>, InitRoutine );
00760                     }
00761                 DbgBreakPoint();
00762 
00763                 }
00764             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00765                 <span class="keywordflow">if</span> ( InitRoutine ) {
00766                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: %wZ loaded."</span>, &amp;LdrDataTableEntry-&gt;BaseDllName );
00767                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" - Calling init routine at %lx\n"</span>, InitRoutine);
00768                     }
00769                 }
00770 
00771             <span class="keywordflow">if</span> ( InitRoutine ) {
00772 
00773                 <span class="comment">//</span>
00774                 <span class="comment">// If the DLL has TLS data, then call the optional initializers</span>
00775                 <span class="comment">//</span>
00776 
00777 
00778 
00779                 <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;TlsIndex &amp;&amp; Context) {
00780                     <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(LdrDataTableEntry-&gt;DllBase,DLL_PROCESS_ATTACH);
00781                     }
00782 
00783 <span class="preprocessor">#if defined (WX86)</span>
00784 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!Wx86ProcessInit ||
00785                     LdrpRunWx86DllEntryPoint(InitRoutine,
00786                                             &amp;InitStatus,
00787                                             LdrDataTableEntry-&gt;DllBase,
00788                                             DLL_PROCESS_ATTACH,
00789                                             Context
00790                                             ) ==  STATUS_IMAGE_MACHINE_TYPE_MISMATCH)
00791                     {
00792                     InitStatus = <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine,
00793                                                      LdrDataTableEntry-&gt;DllBase,
00794                                                      DLL_PROCESS_ATTACH,
00795                                                      Context
00796                                                     );
00797                     }
00798 
00799 <span class="preprocessor">#else</span>
00800 <span class="preprocessor"></span>                InitStatus = <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine,
00801                                                  LdrDataTableEntry-&gt;DllBase,
00802                                                  DLL_PROCESS_ATTACH,
00803                                                  Context
00804                                                 );
00805 <span class="preprocessor">#endif</span>
00806 <span class="preprocessor"></span>
00807                 LdrDataTableEntry-&gt;Flags |= LDRP_PROCESS_ATTACH_CALLED;
00808 
00809                 <span class="keywordflow">if</span> ( !InitStatus ) {
00810                     <span class="keywordflow">return</span> STATUS_DLL_INIT_FAILED;
00811                     }
00812                 }
00813             }
00814 
00815         <span class="comment">//</span>
00816         <span class="comment">// If the image has tls than call its initializers</span>
00817         <span class="comment">//</span>
00818 
00819         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a> &amp;&amp; Context ) {
00820             <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(NtCurrentPeb()-&gt;ImageBaseAddress,DLL_PROCESS_ATTACH);
00821             }
00822 
00823         }
00824     finally {
00825         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,LdrDataTableBase);
00826         }
00827 
00828     <span class="keywordflow">return</span> STATUS_SUCCESS;
00829 }
00830 
00831 BOOLEAN
<a name="l00832"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">00832</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a> (
00833     IN PWSTR DllPath OPTIONAL,
00834     IN PUNICODE_STRING DllName,
00835     IN BOOLEAN StaticLink,
00836     IN BOOLEAN Wx86KnownDll,
00837     OUT PLDR_DATA_TABLE_ENTRY *LdrDataTableEntry
00838     )
00839 
00840 <span class="comment">/*++</span>
00841 <span class="comment"></span>
00842 <span class="comment">Routine Description:</span>
00843 <span class="comment"></span>
00844 <span class="comment">    This function scans the loader data table looking to see if</span>
00845 <span class="comment">    the specified DLL has already been mapped into the image. If</span>
00846 <span class="comment">    the dll has been loaded, the address of its data table entry</span>
00847 <span class="comment">    is returned.</span>
00848 <span class="comment"></span>
00849 <span class="comment">Arguments:</span>
00850 <span class="comment"></span>
00851 <span class="comment">    DllPath - Supplies an optional search path used to locate the DLL.</span>
00852 <span class="comment"></span>
00853 <span class="comment">    DllName - Supplies the name to search for.</span>
00854 <span class="comment"></span>
00855 <span class="comment">    StaticLink - TRUE if performing a static link.</span>
00856 <span class="comment"></span>
00857 <span class="comment">    Wx86KnownDll - TRUE, treat Importer as x86</span>
00858 <span class="comment"></span>
00859 <span class="comment">    LdrDataTableEntry - Returns the address of the loader data table</span>
00860 <span class="comment">        entry that describes the first dll section that implements the</span>
00861 <span class="comment">        dll.</span>
00862 <span class="comment"></span>
00863 <span class="comment">Return Value:</span>
00864 <span class="comment"></span>
00865 <span class="comment">    TRUE- The dll is already loaded.  The address of the data table</span>
00866 <span class="comment">        entries that implement the dll, and the number of data table</span>
00867 <span class="comment">        entries are returned.</span>
00868 <span class="comment"></span>
00869 <span class="comment">    FALSE - The dll is not already mapped.</span>
00870 <span class="comment"></span>
00871 <span class="comment">--*/</span>
00872 
00873 {
00874     BOOLEAN Result;
00875     PLDR_DATA_TABLE_ENTRY Entry;
00876     PLIST_ENTRY Head, Next;
00877     UNICODE_STRING FullDllName;
00878     HANDLE DllFile;
00879     BOOLEAN HardCodedPath;
00880     PWCH p;
00881     WCHAR wch;
00882     ULONG i;
00883     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> FullDllNameBuffer[530+<span class="keyword">sizeof</span>(UNICODE_NULL)];
00884     ULONG Length = 0;
00885     PWCH src,dest;
00886 
00887 
00888 
00889     <span class="keywordflow">if</span> (!DllName-&gt;Buffer || !DllName-&gt;Buffer[0]) {
00890         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00891         }
00892 
00893 <span class="preprocessor">#if defined (WX86)</span>
00894 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Wx86ProcessInit) {
00895 
00896         FullDllName.Buffer = (PWCHAR)FullDllNameBuffer;
00897         FullDllName.MaximumLength = <span class="keyword">sizeof</span>(FullDllNameBuffer);
00898         FullDllName.Length = 0;
00899 
00900         Entry = LdrpWx86CheckForLoadedDll(DllPath,
00901                                           DllName,
00902                                           Wx86KnownDll,
00903                                           &amp;FullDllName
00904                                           );
00905 
00906         <span class="keywordflow">if</span> (Entry) {
00907             <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(DllName, &amp;FullDllName);
00908             *LdrDataTableEntry = Entry;
00909             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00910             }
00911         <span class="keywordflow">else</span> {
00912             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00913             }
00914         }
00915 
00916 <span class="preprocessor">#endif</span>
00917 <span class="preprocessor"></span>
00918 
00919 
00920     <span class="comment">//</span>
00921     <span class="comment">// for static links, just go to the hash table</span>
00922     <span class="comment">//</span>
00923 staticlink:
00924     <span class="keywordflow">if</span> ( StaticLink ) {
00925 
00926         i = <a class="code" href="../../d9/d2/ldrp_8h.html#a7">LDRP_COMPUTE_HASH_INDEX</a>(DllName-&gt;Buffer[0]);
00927         Head = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a26">LdrpHashTable</a>[i];
00928         Next = Head-&gt;Flink;
00929         <span class="keywordflow">while</span> ( Next != Head ) {
00930             Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, HashLinks);
00931 <span class="preprocessor">#if DBG</span>
00932 <span class="preprocessor"></span>            LdrpCompareCount++;
00933 <span class="preprocessor">#endif</span>
00934 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(DllName,
00935                         &amp;Entry-&gt;BaseDllName,
00936                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00937                         )) {
00938 
00939                 *LdrDataTableEntry = Entry;
00940                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00941                 }
00942             Next = Next-&gt;Flink;
00943             }
00944         }
00945 
00946     <span class="keywordflow">if</span> ( StaticLink ) {
00947         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00948         }
00949 
00950 
00951     <span class="comment">//</span>
00952     <span class="comment">// If the dll name contained a hard coded path</span>
00953     <span class="comment">// (dynamic link only), then the fully qualified</span>
00954     <span class="comment">// name needs to be compared to make sure we</span>
00955     <span class="comment">// have the correct dll.</span>
00956     <span class="comment">//</span>
00957 
00958     p = DllName-&gt;Buffer;
00959     HardCodedPath = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00960     <span class="keywordflow">while</span> (*p) {
00961         wch = *p++;
00962         <span class="keywordflow">if</span> (wch == (WCHAR)<span class="charliteral">'\\'</span> || wch == (WCHAR)<span class="charliteral">'/'</span> ) {
00963 
00964             HardCodedPath = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00965 
00966             <span class="comment">//</span>
00967             <span class="comment">// We have a hard coded path, so we have to search path</span>
00968             <span class="comment">// for the DLL. We need the full DLL name so we can</span>
00969 
00970             FullDllName.Buffer = (WCHAR *)FullDllNameBuffer;
00971 
00972             Length = <a class="code" href="../../d5/d1/curdir_8c.html#a32">RtlDosSearchPath_U</a>(
00973                         ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer,
00974                         DllName-&gt;Buffer,
00975                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00976                         <span class="keyword">sizeof</span>(FullDllNameBuffer)-<span class="keyword">sizeof</span>(UNICODE_NULL),
00977                         FullDllName.Buffer,
00978                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00979                         );
00980             <span class="keywordflow">if</span> ( !Length || Length &gt; <span class="keyword">sizeof</span>(FullDllNameBuffer)-<span class="keyword">sizeof</span>(UNICODE_NULL) ) {
00981 
00982                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00983                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrpCheckForLoadedDll - Unable To Locate "</span>);
00984                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%ws from %ws\n"</span>,
00985                         DllName-&gt;Buffer,
00986                         ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer
00987                         );
00988                     }
00989 
00990                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00991                 }
00992 
00993             FullDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
00994             FullDllName.MaximumLength = FullDllName.Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
00995             <span class="keywordflow">break</span>;
00996             }
00997         }
00998 
00999     <span class="comment">//</span>
01000     <span class="comment">// if this is a dynamic load lib, and there is not a hard</span>
01001     <span class="comment">// coded path, then go to the static lib hash table for resolution</span>
01002     <span class="comment">//</span>
01003 
01004     <span class="keywordflow">if</span> ( !HardCodedPath ) {
01005 
01006         StaticLink = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01007 
01008         <span class="keywordflow">goto</span> staticlink;
01009         }
01010 
01011 
01012     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01013     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01014     Next = Head-&gt;Flink;
01015 
01016     <span class="keywordflow">while</span> ( Next != Head ) {
01017         Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01018         Next = Next-&gt;Flink;
01019 
01020         <span class="comment">//</span>
01021         <span class="comment">// when we unload, the memory order links flink field is nulled.</span>
01022         <span class="comment">// this is used to skip the entry pending list removal.</span>
01023         <span class="comment">//</span>
01024 
01025         <span class="keywordflow">if</span> ( !Entry-&gt;InMemoryOrderLinks.Flink ) {
01026             <span class="keywordflow">continue</span>;
01027         }
01028 
01029 
01030         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(
01031                 &amp;FullDllName,
01032                 &amp;Entry-&gt;FullDllName,
01033                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01034                 ) ) {
01035 
01036                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01037                 *LdrDataTableEntry = Entry;
01038                 <span class="keywordflow">break</span>;
01039             }
01040         }
01041 
01042     <span class="keywordflow">if</span> ( !Result ) {
01043 
01044         <span class="comment">//</span>
01045         <span class="comment">// no names matched. This might be a long short name mismatch or</span>
01046         <span class="comment">// any kind of alias pathname. Deal with this by opening and mapping</span>
01047         <span class="comment">// full dll name and then repeat the scan this time checking for</span>
01048         <span class="comment">// timedatestamp matches</span>
01049         <span class="comment">//</span>
01050 
01051         HANDLE <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
01052         HANDLE Section;
01053         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01054         OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01055         IO_STATUS_BLOCK IoStatus;
01056         PVOID ViewBase;
01057         SIZE_T ViewSize;
01058         PIMAGE_NT_HEADERS NtHeadersSrc,NtHeadersE;
01059         UNICODE_STRING NtFileName;
01060 
01061 
01062         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d1/curdir_8c.html#a29">RtlDosPathNameToNtPathName_U</a>( FullDllName.Buffer,
01063                                            &amp;NtFileName,
01064                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01065                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01066                                          )
01067            ) {
01068             <span class="keywordflow">goto</span> alldone;
01069             }
01070 
01071         InitializeObjectAttributes(
01072             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01073             &amp;NtFileName,
01074             OBJ_CASE_INSENSITIVE,
01075             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01076             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01077             );
01078 
01079         st = <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
01080                 &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
01081                 SYNCHRONIZE | FILE_EXECUTE,
01082                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01083                 &amp;IoStatus,
01084                 FILE_SHARE_READ | FILE_SHARE_DELETE,
01085                 FILE_NON_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT
01086                 );
01087         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, NtFileName.Buffer);
01088 
01089         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01090             <span class="keywordflow">goto</span> alldone;
01091             }
01092 
01093         st = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(
01094                 &amp;Section,
01095                 SECTION_MAP_READ | SECTION_MAP_EXECUTE | SECTION_MAP_WRITE,
01096                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01097                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01098                 PAGE_EXECUTE,
01099                 SEC_COMMIT,
01100                 <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>
01101                 );
01102         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> );
01103 
01104         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01105             <span class="keywordflow">goto</span> alldone;
01106             }
01107 
01108         ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01109         ViewSize = 0;
01110         st = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01111                 Section,
01112                 NtCurrentProcess(),
01113                 (PVOID *)&amp;ViewBase,
01114                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01115                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01116                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01117                 &amp;ViewSize,
01118                 ViewShare,
01119                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01120                 PAGE_EXECUTE
01121                 );
01122         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01123         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01124             <span class="keywordflow">goto</span> alldone;
01125             }
01126 
01127         <span class="comment">//</span>
01128         <span class="comment">// The section is mapped. Now find the headers</span>
01129         <span class="comment">//</span>
01130         NtHeadersSrc = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ViewBase);
01131         <span class="keywordflow">if</span> ( !NtHeadersSrc ) {
01132             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01133             <span class="keywordflow">goto</span> alldone;
01134             }
01135         Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01136         Next = Head-&gt;Flink;
01137 
01138         <span class="keywordflow">while</span> ( Next != Head ) {
01139             Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01140             Next = Next-&gt;Flink;
01141 
01142             <span class="comment">//</span>
01143             <span class="comment">// when we unload, the memory order links flink field is nulled.</span>
01144             <span class="comment">// this is used to skip the entry pending list removal.</span>
01145             <span class="comment">//</span>
01146 
01147             <span class="keywordflow">if</span> ( !Entry-&gt;InMemoryOrderLinks.Flink ) {
01148                 <span class="keywordflow">continue</span>;
01149             }
01150 
01151             <span class="keywordflow">try</span> {
01152                 <span class="keywordflow">if</span> ( Entry-&gt;TimeDateStamp == NtHeadersSrc-&gt;FileHeader.TimeDateStamp &amp;&amp;
01153                      Entry-&gt;SizeOfImage == NtHeadersSrc-&gt;OptionalHeader.SizeOfImage ) {
01154 
01155                     <span class="comment">//</span>
01156                     <span class="comment">// there is a very good chance we have an image match. Check the</span>
01157                     <span class="comment">// entire file header and optional header. If they match, declare</span>
01158                     <span class="comment">// this a match</span>
01159                     <span class="comment">//</span>
01160 
01161                     NtHeadersE = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Entry-&gt;DllBase);
01162 
01163                     <span class="keywordflow">if</span> ( RtlCompareMemory(NtHeadersE,NtHeadersSrc,<span class="keyword">sizeof</span>(*NtHeadersE)) ) {
01164 
01165                         <span class="comment">//</span>
01166                         <span class="comment">// Now that it looks like we have a match, compare</span>
01167                         <span class="comment">// volume serial number's and file index's</span>
01168                         <span class="comment">//</span>
01169 
01170                         st = <a class="code" href="../../d3/d5/mapview_8c.html#a26">NtAreMappedFilesTheSame</a>(Entry-&gt;DllBase,ViewBase);
01171 
01172                         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01173                             <span class="keywordflow">continue</span>;
01174                             }
01175                         <span class="keywordflow">else</span> {
01176                             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01177                             *LdrDataTableEntry = Entry;
01178                             <span class="keywordflow">break</span>;
01179                             }
01180                         }
01181                     }
01182                 }
01183             except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01184                 <span class="keywordflow">break</span>;
01185                 }
01186             }
01187         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01188         }
01189 
01190 alldone:
01191     <span class="keywordflow">return</span> Result;
01192 }
01193 
01194 
01195 BOOLEAN
<a name="l01196"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a45">01196</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a45">LdrpCheckForLoadedDllHandle</a> (
01197     IN PVOID DllHandle,
01198     OUT PLDR_DATA_TABLE_ENTRY *LdrDataTableEntry
01199     )
01200 
01201 <span class="comment">/*++</span>
01202 <span class="comment"></span>
01203 <span class="comment">Routine Description:</span>
01204 <span class="comment"></span>
01205 <span class="comment">    This function scans the loader data table looking to see if</span>
01206 <span class="comment">    the specified DLL has already been mapped into the image address</span>
01207 <span class="comment">    space. If the dll has been loaded, the address of its data table</span>
01208 <span class="comment">    entry that describes the dll is returned.</span>
01209 <span class="comment"></span>
01210 <span class="comment">Arguments:</span>
01211 <span class="comment"></span>
01212 <span class="comment">    DllHandle - Supplies the DllHandle of the DLL being searched for.</span>
01213 <span class="comment"></span>
01214 <span class="comment">    LdrDataTableEntry - Returns the address of the loader data table</span>
01215 <span class="comment">        entry that describes the dll.</span>
01216 <span class="comment"></span>
01217 <span class="comment">Return Value:</span>
01218 <span class="comment"></span>
01219 <span class="comment">    TRUE- The dll is loaded.  The address of the data table entry is</span>
01220 <span class="comment">        returned.</span>
01221 <span class="comment"></span>
01222 <span class="comment">    FALSE - The dll is not loaded.</span>
01223 <span class="comment"></span>
01224 <span class="comment">--*/</span>
01225 
01226 {
01227     PLDR_DATA_TABLE_ENTRY Entry;
01228     PLIST_ENTRY Head,Next;
01229 
01230     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a> &amp;&amp;
01231         (PVOID) <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a>-&gt;DllBase == DllHandle ) {
01232         *LdrDataTableEntry = <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a>;
01233         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01234         }
01235 
01236     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01237     Next = Head-&gt;Flink;
01238 
01239     <span class="keywordflow">while</span> ( Next != Head ) {
01240         Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01241         Next = Next-&gt;Flink;
01242         <span class="comment">//</span>
01243         <span class="comment">// when we unload, the memory order links flink field is nulled.</span>
01244         <span class="comment">// this is used to skip the entry pending list removal.</span>
01245         <span class="comment">//</span>
01246 
01247         <span class="keywordflow">if</span> ( !Entry-&gt;InMemoryOrderLinks.Flink ) {
01248             <span class="keywordflow">continue</span>;
01249         }
01250 
01251         <span class="keywordflow">if</span> (DllHandle == (PVOID)Entry-&gt;DllBase ){
01252             <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a> = Entry;
01253             *LdrDataTableEntry = Entry;
01254             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01255         }
01256     }
01257     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01258 }
01259 
01260 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01261"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a46">01261</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a46">LdrpMapDll</a> (
01262     IN PWSTR DllPath OPTIONAL,
01263     IN PWSTR DllName,
01264     IN PULONG DllCharacteristics OPTIONAL,
01265     IN BOOLEAN StaticLink,
01266     IN BOOLEAN Wx86KnownDll,
01267     OUT PLDR_DATA_TABLE_ENTRY *LdrDataTableEntry
01268     )
01269 
01270 <span class="comment">/*++</span>
01271 <span class="comment"></span>
01272 <span class="comment">Routine Description:</span>
01273 <span class="comment"></span>
01274 <span class="comment">    This routine maps the DLL into the users address space.</span>
01275 <span class="comment"></span>
01276 <span class="comment">Arguments:</span>
01277 <span class="comment"></span>
01278 <span class="comment">    DllPath - Supplies an optional search path to be used to locate the DLL.</span>
01279 <span class="comment"></span>
01280 <span class="comment">    DllName - Supplies the name of the DLL to load.</span>
01281 <span class="comment"></span>
01282 <span class="comment">    StaticLink - TRUE if this DLL has a static link to it.</span>
01283 <span class="comment"></span>
01284 <span class="comment">    Wx86KnownDll - TRUE, treat Importer as x86</span>
01285 <span class="comment"></span>
01286 <span class="comment">    LdrDataTableEntry - Supplies the address of the data table entry.</span>
01287 <span class="comment"></span>
01288 <span class="comment">Return Value:</span>
01289 <span class="comment"></span>
01290 <span class="comment">    Status value.</span>
01291 <span class="comment"></span>
01292 <span class="comment">--*/</span>
01293 
01294 {
01295     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01296     PVOID ViewBase;
01297     PTEB Teb = NtCurrentTeb();
01298     SIZE_T ViewSize;
01299     HANDLE Section, DllFile;
01300     UNICODE_STRING FullDllName, BaseDllName;
01301     UNICODE_STRING NtFileName;
01302     PLDR_DATA_TABLE_ENTRY Entry;
01303     PIMAGE_NT_HEADERS NtHeaders;
01304     PVOID ArbitraryUserPointer;
01305     BOOLEAN KnownDll;
01306     UNICODE_STRING CollidingDll;
01307     PUCHAR ImageBase, ImageBounds, ScanBase, ScanTop;
01308     PLDR_DATA_TABLE_ENTRY ScanEntry;
01309     PLIST_ENTRY ScanHead,ScanNext;
01310     BOOLEAN CollidingDllFound;
01311     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ErrorStatus;
01312     ULONG_PTR ErrorParameters[2];
01313     ULONG ErrorResponse;
01314 <span class="preprocessor">#if defined (WX86)</span>
01315 <span class="preprocessor"></span>    BOOLEAN Wx86Plugin = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01316 <span class="preprocessor">#endif</span>
01317 <span class="preprocessor"></span>
01318 
01319     <span class="comment">//</span>
01320     <span class="comment">// Get section handle of DLL being snapped</span>
01321     <span class="comment">//</span>
01322 
01323 <span class="preprocessor">#if LDRDBG</span>
01324 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01325         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrpMapDll: Image Name %ws, Search Path %ws\n"</span>,
01326                 DllName,
01327                 ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>
01328                 );
01329     }
01330 <span class="preprocessor">#endif</span>
01331 <span class="preprocessor"></span>
01332     Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01333     KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01334     Section = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01335 
01336     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a23">LdrpKnownDllObjectDirectory</a> &amp;&amp; !Wx86KnownDll) {
01337 
01338         PWCH p = DllName;
01339         WCHAR wch;
01340 
01341         <span class="comment">//</span>
01342         <span class="comment">// Skip the KnownDll check if this is an explicit path.</span>
01343         <span class="comment">//</span>
01344 
01345         <span class="keywordflow">while</span> (*p) {
01346             wch = *p++;
01347             <span class="keywordflow">if</span> (wch == (WCHAR)<span class="charliteral">'\\'</span> || wch == (WCHAR)<span class="charliteral">'/'</span> ) {
01348                 <span class="keywordflow">goto</span> SkipKnownDllCheck;
01349                 }
01350             }
01351         Section = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a56">LdrpCheckForKnownDll</a>(
01352                         DllName,
01353                         &amp;FullDllName,
01354                         &amp;BaseDllName
01355                         );
01356 
01357         }
01358 
01359 SkipKnownDllCheck:
01360 
01361     <span class="keywordflow">if</span> ( !Section ) {
01362 
01363 <span class="preprocessor">#if defined (WX86)</span>
01364 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Wx86ProcessInit) {
01365             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;BaseDllName, DllName);
01366             st = LdrpWx86MapDll(DllPath,
01367                                 DllCharacteristics,
01368                                 Wx86KnownDll,
01369                                 StaticLink,
01370                                 &amp;BaseDllName,
01371                                 &amp;Entry,
01372                                 &amp;ViewSize,
01373                                 &amp;Section
01374                                 );
01375 
01376             <span class="keywordflow">if</span> (st == STATUS_DLL_NOT_FOUND) {
01377                 <span class="keywordflow">goto</span> Wx86MapDllNotFound;
01378                 }
01379 
01380             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01381                 <span class="keywordflow">return</span> st;
01382                 }
01383 
01384 
01385             ViewBase    = Entry-&gt;DllBase;
01386             FullDllName = Entry-&gt;FullDllName;
01387             BaseDllName = Entry-&gt;BaseDllName;
01388             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ViewBase);
01389 
01390             <span class="keywordflow">goto</span> Wx86MapComplete;
01391 
01392         } <span class="keywordflow">else</span>
01393 <span class="preprocessor">#endif</span>
01394 <span class="preprocessor"></span>
01395         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a54">LdrpResolveDllName</a>( DllPath,
01396                                 DllName,
01397                                 &amp;FullDllName,
01398                                 &amp;BaseDllName,
01399                                 &amp;DllFile
01400                               )
01401            ) {
01402             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01403                 PSZ <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>;
01404                 <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = StaticLink ? <span class="stringliteral">"STATIC"</span> : <span class="stringliteral">"DYNAMIC"</span>;
01405                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Loading (%s) %wZ\n"</span>,
01406                          <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
01407                          &amp;FullDllName
01408                          );
01409             }
01410 
01411             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d1/curdir_8c.html#a29">RtlDosPathNameToNtPathName_U</a>( FullDllName.Buffer,
01412                                                &amp;NtFileName,
01413                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01414                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01415                                              )
01416                ) {
01417                 <span class="keywordflow">return</span> STATUS_OBJECT_PATH_SYNTAX_BAD;
01418                 }
01419 
01420             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a47">LdrpCreateDllSection</a>(&amp;NtFileName,
01421                                       DllFile,
01422                                       &amp;BaseDllName,
01423                                       DllCharacteristics,
01424                                       &amp;Section
01425                                      );
01426 
01427             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, NtFileName.Buffer);
01428 
01429             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01430                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;FullDllName);
01431                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;BaseDllName);
01432                 <span class="keywordflow">return</span> st;
01433             }
01434 <span class="preprocessor">#if DBG</span>
01435 <span class="preprocessor"></span>            LdrpSectionCreates++;
01436 <span class="preprocessor">#endif</span>
01437 <span class="preprocessor"></span>
01438         } <span class="keywordflow">else</span> {
01439 
01440 <span class="preprocessor">#ifdef WX86</span>
01441 <span class="preprocessor"></span>Wx86MapDllNotFound:
01442 <span class="preprocessor">#endif</span>
01443 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( StaticLink ) {
01444                 PUNICODE_STRING ErrorStrings[2];
01445                 UNICODE_STRING ErrorDllName, ErrorDllPath;
01446                 ULONG ErrorResponse;
01447 
01448                 ErrorStrings[0] = &amp;ErrorDllName;
01449                 ErrorStrings[1] = &amp;ErrorDllPath;
01450                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ErrorDllName,DllName);
01451                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ErrorDllPath,
01452                         ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer);
01453                 <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
01454                   (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)STATUS_DLL_NOT_FOUND,
01455                   2,
01456                   0x00000003,
01457                   (PULONG_PTR)ErrorStrings,
01458                   OptionOk,
01459                   &amp;ErrorResponse
01460                   );
01461                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
01462                     <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
01463                     }
01464                 }
01465 
01466             <span class="keywordflow">return</span> STATUS_DLL_NOT_FOUND;
01467         }
01468     } <span class="keywordflow">else</span> {
01469         KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01470     }
01471 
01472     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01473     ViewSize = 0;
01474 
01475 
01476 <span class="preprocessor">#if DBG</span>
01477 <span class="preprocessor"></span>    LdrpSectionMaps++;
01478     <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
01479         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;MapBeginTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01480     }
01481 <span class="preprocessor">#endif</span>
01482 <span class="preprocessor"></span>
01483     <span class="comment">//</span>
01484     <span class="comment">// arrange for debugger to pick up the image name</span>
01485     <span class="comment">//</span>
01486 
01487     ArbitraryUserPointer = Teb-&gt;NtTib.ArbitraryUserPointer;
01488     Teb-&gt;NtTib.ArbitraryUserPointer = (PVOID)FullDllName.Buffer;
01489     st = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01490             Section,
01491             NtCurrentProcess(),
01492             (PVOID *)&amp;ViewBase,
01493             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01494             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01495             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01496             &amp;ViewSize,
01497             ViewShare,
01498             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01499             PAGE_READWRITE
01500             );
01501     Teb-&gt;NtTib.ArbitraryUserPointer = ArbitraryUserPointer;
01502 
01503     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01504         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01505         <span class="keywordflow">return</span> st;
01506     }
01507 
01508     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ViewBase);
01509     <span class="keywordflow">if</span> ( !NtHeaders ) {
01510         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01511         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01512         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01513         }
01514 
01515 <span class="preprocessor">#if DBG</span>
01516 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
01517         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;MapEndTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01518         MapElapsedTime.QuadPart = MapEndTime.QuadPart - MapBeginTime.QuadPart;
01519         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Map View of Section Time %ld %ws\n"</span>,
01520             MapElapsedTime.LowPart,
01521             DllName
01522             );
01523     }
01524 <span class="preprocessor">#endif</span>
01525 <span class="preprocessor"></span>
01526 <span class="preprocessor">#if defined (BUILD_WOW6432)</span>
01527 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d9/d2/ldrp_8h.html#a2">NATIVE_PAGE_SIZE</a> &amp;&amp;
01528         !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(LdrpWx86FormatVirtualImage((PIMAGE_NT_HEADERS32)NtHeaders, ViewBase)))
01529       {
01530         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01531         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01532         <span class="keywordflow">return</span> st;
01533         }
01534 <span class="preprocessor">#elif defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
01535 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((NtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
01536         !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(LdrpWx86FormatVirtualImage((PIMAGE_NT_HEADERS32)NtHeaders, ViewBase)))
01537       {
01538         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01539         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01540         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01541         }
01542 
01543     <span class="keywordflow">if</span> (st == STATUS_IMAGE_MACHINE_TYPE_MISMATCH &amp;&amp; !StaticLink) {
01544 
01545         <span class="comment">// Attempt to find a plugin provider dll that can thunk this interface</span>
01546         <span class="comment">// temporarily insert the image in the loaded-module-list</span>
01547 
01548         Entry = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a>(ViewBase);
01549         <span class="keywordflow">if</span> (!Entry) {
01550             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01551         }
01552 
01553         Entry-&gt;Flags = 0;
01554         Entry-&gt;LoadCount = 0;
01555         Entry-&gt;FullDllName = FullDllName;
01556         Entry-&gt;BaseDllName = BaseDllName;
01557         Entry-&gt;EntryPoint = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a>(Entry-&gt;DllBase);
01558         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a>(Entry);
01559 
01560         <span class="comment">// Determine if this dll can be thunked using a plugin</span>
01561 
01562         st = Wx86IdentifyPlugin(ViewBase, &amp;FullDllName );
01563 
01564          <span class="comment">// remove the image from the loaded-module-list</span>
01565 
01566         RemoveEntryList(&amp;Entry-&gt;InLoadOrderLinks);
01567         RemoveEntryList(&amp;Entry-&gt;InMemoryOrderLinks);
01568         RemoveEntryList(&amp;Entry-&gt;HashLinks);
01569         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, Entry);
01570         Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01571 
01572         <span class="keywordflow">if</span> (st == STATUS_SUCCESS) {
01573 
01574             <span class="comment">// Release the previous mapping because it's going to</span>
01575             <span class="comment">// be reloaded via Wx86.</span>
01576 
01577             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01578             ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01579 
01580             <span class="comment">// The plugin providers must be statically bound to Wx86</span>
01581             <span class="comment">// or dynamically load it in their DllInit.</span>
01582 
01583             <span class="keywordflow">if</span> (Wx86ProcessInit) {
01584 
01585                 <span class="comment">// Load the dll again using Wx86.</span>
01586 
01587                 st = LdrpWx86MapDll(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01588                                     DllCharacteristics,
01589                                     !Wx86KnownDll,          <span class="comment">// swap sense so we don't get mismatch</span>
01590                                     StaticLink,
01591                                     &amp;FullDllName,
01592                                     &amp;Entry,
01593                                     &amp;ViewSize,
01594                                     &amp;Section
01595                                     );
01596 
01597                 <span class="comment">// Load and thunk the plugin dll</span>
01598 
01599                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01600 
01601                     ViewBase    = Entry-&gt;DllBase;
01602                     FullDllName = Entry-&gt;FullDllName;
01603                     BaseDllName = Entry-&gt;BaseDllName;
01604                     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ViewBase);
01605 
01606                 }
01607             }
01608 
01609             <span class="keywordflow">if</span> (!Wx86ProcessInit || <a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(st)) {
01610                 Wx86UnloadProviders(ViewBase);
01611                 st = STATUS_IMAGE_MACHINE_TYPE_MISMATCH;
01612             }
01613         }
01614 
01615         <span class="comment">// Need to save the status here to put in loader ENTRY after it's allocated.</span>
01616 
01617         Wx86Plugin = (st == STATUS_SUCCESS);
01618 
01619         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01620             PCHAR <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>;
01621 
01622             <span class="keywordflow">if</span> (st == STATUS_SUCCESS) {
01623                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> = <span class="stringliteral">"Loaded"</span>;
01624             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (st == STATUS_IMAGE_MACHINE_TYPE_MISMATCH) {
01625                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> = <span class="stringliteral">"Unsupported"</span>;
01626             } <span class="keywordflow">else</span> {
01627                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> = <span class="stringliteral">"Failed"</span>;
01628             }
01629 
01630             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDRWx86: Plugin: %wZ %s.\n"</span>,
01631                 &amp;FullDllName, <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>
01632                 );
01633         }
01634     }
01635 
01636     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) || (ViewBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01637         <span class="keywordflow">if</span> (ViewBase) <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01638         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01639         <span class="keywordflow">return</span> st;
01640     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Entry) {
01641         <span class="keywordflow">goto</span> Wx86MapComplete;
01642     }
01643 <span class="preprocessor">#endif</span>
01644 <span class="preprocessor"></span>
01645     <span class="comment">//</span>
01646     <span class="comment">// Allocate a data table entry.</span>
01647     <span class="comment">//</span>
01648 
01649     Entry = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a>(ViewBase);
01650 
01651     <span class="keywordflow">if</span> (!Entry) {
01652         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01653         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01654         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01655     }
01656 
01657 
01658     Entry-&gt;Flags = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(StaticLink ? LDRP_STATIC_LINK : 0);
01659     Entry-&gt;LoadCount = 0;
01660     Entry-&gt;FullDllName = FullDllName;
01661     Entry-&gt;BaseDllName = BaseDllName;
01662     Entry-&gt;EntryPoint = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a>(Entry-&gt;DllBase);
01663 
01664 <span class="preprocessor">#ifdef WX86</span>
01665 <span class="preprocessor"></span>Wx86MapComplete:
01666     <span class="keywordflow">if</span> (Wx86Plugin) {
01667         Entry-&gt;Flags |= LDRP_WX86_PLUGIN;
01668     }
01669 <span class="preprocessor">#endif</span>
01670 <span class="preprocessor"></span>
01671 
01672 <span class="preprocessor">#if LDRDBG</span>
01673 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01674         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrpMapDll: Full Name %wZ, Base Name %wZ\n"</span>,
01675                 &amp;FullDllName,
01676                 &amp;BaseDllName
01677                 );
01678     }
01679 <span class="preprocessor">#endif</span>
01680 <span class="preprocessor"></span>
01681     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a>(Entry);
01682 
01683     <span class="keywordflow">if</span> ( st == STATUS_IMAGE_MACHINE_TYPE_MISMATCH ) {
01684 
01685         PIMAGE_NT_HEADERS ImageHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( NtCurrentPeb()-&gt;ImageBaseAddress );
01686 
01687         <span class="comment">//</span>
01688         <span class="comment">// apps compiled for NT 3.x and below can load cross architecture</span>
01689         <span class="comment">// images</span>
01690         <span class="comment">//</span>
01691 
01692         ErrorStatus = STATUS_SUCCESS;
01693         ErrorResponse = ResponseCancel;
01694 
01695         <span class="keywordflow">if</span> ( ImageHeader-&gt;OptionalHeader.MajorSubsystemVersion &lt;= 3 ) {
01696 
01697             Entry-&gt;EntryPoint = 0;
01698 
01699             <span class="comment">//</span>
01700             <span class="comment">// Hard Error Time</span>
01701             <span class="comment">//</span>
01702 
01703             <span class="comment">//</span>
01704             <span class="comment">// Its error time...</span>
01705             <span class="comment">//</span>
01706 
01707             ErrorParameters[0] = (ULONG_PTR)&amp;FullDllName;
01708 
01709             ErrorStatus = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
01710                             STATUS_IMAGE_MACHINE_TYPE_MISMATCH,
01711                             1,
01712                             1,
01713                             ErrorParameters,
01714                             OptionOkCancel,
01715                             &amp;ErrorResponse
01716                             );
01717             }
01718         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ErrorStatus) &amp;&amp; ErrorResponse == ResponseCancel ) {
01719             RemoveEntryList(&amp;Entry-&gt;InLoadOrderLinks);
01720             RemoveEntryList(&amp;Entry-&gt;InMemoryOrderLinks);
01721             RemoveEntryList(&amp;Entry-&gt;HashLinks);
01722             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, Entry );
01723             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01724             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01725 
01726             <span class="keywordflow">if</span> ( ImageHeader-&gt;OptionalHeader.MajorSubsystemVersion &lt;= 3 ) {
01727                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
01728                     <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
01729                     }
01730                 }
01731             <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01732             }
01733         }
01734     <span class="keywordflow">else</span> {
01735         <span class="keywordflow">if</span> (NtHeaders-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_DLL) {
01736             Entry-&gt;Flags |= LDRP_IMAGE_DLL;
01737             }
01738 
01739         <span class="keywordflow">if</span> (!(Entry-&gt;Flags &amp; LDRP_IMAGE_DLL)) {
01740             Entry-&gt;EntryPoint = 0;
01741             }
01742         }
01743     *LdrDataTableEntry = Entry;
01744 
01745     <span class="keywordflow">if</span> (st == STATUS_IMAGE_NOT_AT_BASE) {
01746 
01747         Entry-&gt;Flags |= LDRP_IMAGE_NOT_AT_BASE;
01748 
01749         <span class="comment">//</span>
01750         <span class="comment">// now find the colliding dll. If we can not find a dll,</span>
01751         <span class="comment">// then the colliding dll must be dynamic memory</span>
01752         <span class="comment">//</span>
01753 
01754         ImageBase = (PUCHAR)NtHeaders-&gt;OptionalHeader.ImageBase;
01755         ImageBounds = ImageBase + ViewSize;
01756 
01757         CollidingDllFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01758 
01759         ScanHead = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01760         ScanNext = ScanHead-&gt;Flink;
01761 
01762         <span class="keywordflow">while</span> ( ScanNext != ScanHead ) {
01763             ScanEntry = CONTAINING_RECORD(ScanNext, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01764             ScanNext = ScanNext-&gt;Flink;
01765 
01766             ScanBase = (PUCHAR)ScanEntry-&gt;DllBase;
01767             ScanTop = ScanBase + ScanEntry-&gt;SizeOfImage;
01768 
01769             <span class="comment">//</span>
01770             <span class="comment">// when we unload, the memory order links flink field is nulled.</span>
01771             <span class="comment">// this is used to skip the entry pending list removal.</span>
01772             <span class="comment">//</span>
01773 
01774             <span class="keywordflow">if</span> ( !ScanEntry-&gt;InMemoryOrderLinks.Flink ) {
01775                 <span class="keywordflow">continue</span>;
01776                 }
01777 
01778             <span class="comment">//</span>
01779             <span class="comment">// See if the base address of the scan image is within the relocating dll</span>
01780             <span class="comment">// or if the top address of the scan image is within the relocating dll</span>
01781             <span class="comment">//</span>
01782 
01783             <span class="keywordflow">if</span> ( (ImageBase &gt;= ScanBase &amp;&amp; ImageBase &lt;= ScanTop)
01784 
01785                  ||
01786 
01787                  (ImageBounds &gt;= ScanBase &amp;&amp; ImageBounds &lt;= ScanTop)
01788 
01789                  ||
01790 
01791                  (ScanBase &gt;= ImageBase &amp;&amp; ScanBase &lt;= ImageBounds)
01792 
01793                  ){
01794 
01795                 CollidingDllFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01796                 CollidingDll = ScanEntry-&gt;FullDllName;
01797                 <span class="keywordflow">break</span>;
01798                 }
01799             }
01800 
01801         <span class="keywordflow">if</span> ( !CollidingDllFound ) {
01802             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CollidingDll,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Dynamically Allocated Memory"</span>);
01803             }
01804 
01805 <span class="preprocessor">#if DBG</span>
01806 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( BeginTime.LowPart || BeginTime.HighPart ) {
01807             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nLDR: LdrpMapDll Relocateing Image Name %ws\n"</span>,
01808                     DllName
01809                     );
01810         }
01811         LdrpSectionRelocates++;
01812 <span class="preprocessor">#endif</span>
01813 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Entry-&gt;Flags &amp; LDRP_IMAGE_DLL) {
01814 
01815             BOOLEAN AllowRelocation;
01816             UNICODE_STRING SystemDll;
01817 
01818             <span class="keywordflow">if</span> (!(NtHeaders-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_RELOCS_STRIPPED)) {
01819 
01820                 PVOID pBaseRelocs;
01821                 ULONG BaseRelocCountBytes = 0;
01822 
01823                 <span class="comment">//</span>
01824                 <span class="comment">// If the iamge doesn't have the reloc stripped bit set and there's no</span>
01825                 <span class="comment">// relocs in the data directory, allow this through.  This is probably</span>
01826                 <span class="comment">// a pure forwarder dll or data w/o relocs.</span>
01827                 <span class="comment">//</span>
01828 
01829                 pBaseRelocs = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
01830                         ViewBase, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, IMAGE_DIRECTORY_ENTRY_BASERELOC, &amp;BaseRelocCountBytes);
01831 
01832                 <span class="keywordflow">if</span> (!pBaseRelocs &amp;&amp; !BaseRelocCountBytes) {
01833                     <span class="keywordflow">goto</span> NoRelocNeeded;
01834                     }
01835                 }
01836 
01837             <span class="comment">//</span>
01838             <span class="comment">// decide whether or not to allow the relocation</span>
01839             <span class="comment">// certain system dll's like user32 and kernel32 are not relocatable</span>
01840             <span class="comment">// since addresses within these dll's are not always stored per process</span>
01841             <span class="comment">// do not allow these dll's to be relocated</span>
01842             <span class="comment">//</span>
01843 
01844             AllowRelocation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01845             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SystemDll,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"user32.dll"</span>);
01846             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;BaseDllName,&amp;SystemDll,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ) {
01847                 AllowRelocation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01848                 }
01849             <span class="keywordflow">else</span> {
01850                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SystemDll,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kernel32.dll"</span>);
01851                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;BaseDllName,&amp;SystemDll,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ) {
01852                     AllowRelocation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01853                     }
01854                 }
01855             <span class="keywordflow">if</span> ( !AllowRelocation &amp;&amp; KnownDll ) {
01856 
01857                 <span class="comment">//</span>
01858                 <span class="comment">// totally disallow the relocation since this is a knowndll</span>
01859                 <span class="comment">// that matches our system binaries and is being relocated</span>
01860                 <span class="comment">//</span>
01861 
01862                 <span class="comment">//</span>
01863                 <span class="comment">// Hard Error Time</span>
01864                 <span class="comment">//</span>
01865 
01866                 ErrorParameters[0] = (ULONG_PTR)&amp;SystemDll;
01867                 ErrorParameters[1] = (ULONG_PTR)&amp;CollidingDll;
01868 
01869                 <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
01870                   STATUS_ILLEGAL_DLL_RELOCATION,
01871                   2,
01872                   3,
01873                   ErrorParameters,
01874                   OptionOk,
01875                   &amp;ErrorResponse
01876                   );
01877 
01878                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
01879                     <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
01880                     }
01881 
01882                 st = STATUS_CONFLICTING_ADDRESSES;
01883                 <span class="keywordflow">goto</span> skipreloc;
01884                 }
01885 
01886             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, StaticLink );
01887             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01888                 st = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a>(ViewBase,
01889                             <span class="stringliteral">"LDR"</span>,
01890                             (ULONG)STATUS_SUCCESS,
01891                             (ULONG)STATUS_CONFLICTING_ADDRESSES,
01892                             (ULONG)STATUS_INVALID_IMAGE_FORMAT
01893                             );
01894                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01895 
01896                     <span class="comment">//</span>
01897                     <span class="comment">// If we did relocations, then map the section again.</span>
01898                     <span class="comment">// this will force the debug event</span>
01899                     <span class="comment">//</span>
01900 
01901                     <span class="comment">//</span>
01902                     <span class="comment">// arrange for debugger to pick up the image name</span>
01903                     <span class="comment">//</span>
01904 
01905                     ArbitraryUserPointer = Teb-&gt;NtTib.ArbitraryUserPointer;
01906                     Teb-&gt;NtTib.ArbitraryUserPointer = (PVOID)FullDllName.Buffer;
01907                     <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01908                         Section,
01909                         NtCurrentProcess(),
01910                         (PVOID *)&amp;ViewBase,
01911                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01912                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01913                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01914                         &amp;ViewSize,
01915                         ViewShare,
01916                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01917                         PAGE_READWRITE
01918                         );
01919                     Teb-&gt;NtTib.ArbitraryUserPointer = ArbitraryUserPointer;
01920 
01921                     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, StaticLink);
01922 
01923                 }
01924             }
01925 skipreloc:
01926             <span class="comment">//</span>
01927             <span class="comment">// if the set protection failed, or if the relocation failed, then</span>
01928             <span class="comment">// remove the partially loaded dll from the lists and clear entry</span>
01929             <span class="comment">// that it has been freed.</span>
01930             <span class="comment">//</span>
01931 
01932             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01933                 RemoveEntryList(&amp;Entry-&gt;InLoadOrderLinks);
01934                 RemoveEntryList(&amp;Entry-&gt;InMemoryOrderLinks);
01935                 RemoveEntryList(&amp;Entry-&gt;HashLinks);
01936                 <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01937                 Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01938                 }
01939 
01940             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01941                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Fixups %successfully re-applied @ %lx\n"</span>,
01942                        <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ? <span class="stringliteral">"s"</span> : <span class="stringliteral">"uns"</span>, ViewBase);
01943             }
01944         } <span class="keywordflow">else</span> {
01945 NoRelocNeeded:
01946                  st = STATUS_SUCCESS;
01947 
01948                  <span class="comment">//</span>
01949                  <span class="comment">// arrange for debugger to pick up the image name</span>
01950                  <span class="comment">//</span>
01951 
01952                  ArbitraryUserPointer = Teb-&gt;NtTib.ArbitraryUserPointer;
01953                  Teb-&gt;NtTib.ArbitraryUserPointer = (PVOID)FullDllName.Buffer;
01954                  <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01955                      Section,
01956                      NtCurrentProcess(),
01957                      (PVOID *)&amp;ViewBase,
01958                      0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01959                      0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01960                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01961                      &amp;ViewSize,
01962                      ViewShare,
01963                      0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01964                      PAGE_READWRITE
01965                      );
01966                  Teb-&gt;NtTib.ArbitraryUserPointer = ArbitraryUserPointer;
01967 
01968                  <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01969                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Fixups won't be re-applied to non-Dll @ %lx\n"</span>,
01970                               ViewBase);
01971                  }
01972                }
01973     }
01974 
01975 <span class="preprocessor">#if defined (_ALPHA_)</span>
01976 <span class="preprocessor"></span>
01977     <span class="comment">//</span>
01978     <span class="comment">// Find and apply Alpha architecture fixups for this dll</span>
01979     <span class="comment">//</span>
01980     <span class="keywordflow">if</span> (Entry-&gt;Flags &amp; LDRP_IMAGE_DLL)
01981         AlphaFindArchitectureFixups(NtHeaders, ViewBase, StaticLink);
01982 <span class="preprocessor">#endif</span>
01983 <span class="preprocessor"></span>
01984 <span class="preprocessor">#if defined(_X86_)</span>
01985 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a> &gt; 1 &amp;&amp; Entry &amp;&amp; (Entry-&gt;Flags &amp; LDRP_IMAGE_DLL) ) {
01986         LdrpValidateImageForMp(Entry);
01987         }
01988 <span class="preprocessor">#endif</span>
01989 <span class="preprocessor"></span>    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01990     <span class="keywordflow">return</span> st;
01991 }
01992 
01993 <span class="preprocessor">#if defined (_ALPHA_)</span>
01994 <span class="preprocessor"></span>
01995 <span class="preprocessor">#define asm __asm</span>
01996 <span class="preprocessor"></span><span class="preprocessor">#pragma intrinsic (__asm)</span>
01997 <span class="preprocessor"></span>
01998 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01999 AlphaApplyArchitectureFixups(
02000     IN PIMAGE_ARCHITECTURE_HEADER ArchHeader,
02001     IN ULONG ArchHeaderByteSize,
02002     IN ULONG_PTR BaseAddr
02003     )
02004 
02005 <span class="comment">/*++</span>
02006 <span class="comment"></span>
02007 <span class="comment">Routine Description:</span>
02008 <span class="comment"></span>
02009 <span class="comment">    This applies the Alpha architecture enhancement fixups. If an image contains</span>
02010 <span class="comment">    a .arch section, then the image/dll, if running on a newer chip, may</span>
02011 <span class="comment">    be eligible to take advantage of new instructions. Check the replacement</span>
02012 <span class="comment">    constraints vs. chip capabilities and apply fixup if warranted.</span>
02013 <span class="comment"></span>
02014 <span class="comment"></span>
02015 <span class="comment">Arguments:</span>
02016 <span class="comment"></span>
02017 <span class="comment">    ArchHeader - Supplies a pointer to the first architecture specific</span>
02018 <span class="comment">        fixup header record.</span>
02019 <span class="comment"></span>
02020 <span class="comment">    ArchHeaderByteSize - Supplies the size (in bytes) of the</span>
02021 <span class="comment">        Architecture headers to be processed.</span>
02022 <span class="comment"></span>
02023 <span class="comment">    BaseAddr - Base address to be added to RVA's in architecture section</span>
02024 <span class="comment"></span>
02025 <span class="comment">Return Value:</span>
02026 <span class="comment"></span>
02027 <span class="comment">    None.</span>
02028 <span class="comment"></span>
02029 <span class="comment">--*/</span>
02030 
02031 {
02032     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>, Entry;
02033     ULONG SystemAmask;
02034     ULONG ReplacementInstruction;
02035     PIMAGE_ARCHITECTURE_HEADER ArchHeaderEnd;
02036     PIMAGE_ARCHITECTURE_ENTRY ArchEntry;
02037 
02038     <span class="comment">// Figure out the end value for ArchHeader</span>
02039 
02040     ArchHeaderEnd = (PIMAGE_ARCHITECTURE_HEADER)((PCHAR)ArchHeader + ArchHeaderByteSize);
02041     <span class="comment">//</span>
02042     <span class="comment">// Get the architecture mask and implementation version</span>
02043     <span class="comment">// of the running system</span>
02044     <span class="comment">//</span>
02045 
02046     <span class="keywordflow">while</span> (*(PULONGLONG)ArchHeader == 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)
02047         ArchHeader++; <span class="comment">// skip over quadwords of zero</span>
02048 
02049     SystemAmask = ~asm(<span class="stringliteral">"amask $16, $0"</span>, -1);
02050 
02051     <span class="keywordflow">while</span> ((*(PULONGLONG)ArchHeader != 0xffffffff<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) &amp;&amp; (ArchHeader &lt; ArchHeaderEnd)) {
02052         <span class="keywordflow">if</span> (*(PULONGLONG)ArchHeader != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) { <span class="comment">// maybe zero's intermixed</span>
02053 <span class="preprocessor">#if DBG &amp;&amp; ARCH_DBG</span>
02054 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ARCH: Amask=0x%x, Current Header=0x%08x, Shift=%d, Value=%d\n"</span>,
02055                     SystemAmask, *ArchHeader,
02056                     ArchHeader-&gt;AmaskShift, ArchHeader-&gt;AmaskValue);
02057 <span class="preprocessor">#endif</span>
02058 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (((SystemAmask &gt;&gt; ArchHeader-&gt;AmaskShift) &amp; 1) != ArchHeader-&gt;AmaskValue) {
02059 
02060                 <span class="comment">//</span>
02061                 <span class="comment">// fixup needed</span>
02062                 <span class="comment">//</span>
02063 
02064                 PIMAGE_ARCHITECTURE_ENTRY ArchEntry;
02065 
02066                 ArchEntry = (PIMAGE_ARCHITECTURE_ENTRY)(ArchHeader-&gt;FirstEntryRVA + BaseAddr);
02067 
02068                 <span class="keywordflow">while</span> (*(PULONGLONG)ArchEntry != 0xffffffff<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) {
02069 
02070                     <span class="keywordflow">if</span> (*(PULONGLONG)ArchEntry != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) { <span class="comment">// maybe zero's intermixed</span>
02071 <span class="preprocessor">#if DBG &amp;&amp; ARCH_DBG</span>
02072 <span class="preprocessor"></span>                        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ARCH: 0x%08x -&gt; 0x%08x\n"</span>,
02073                                  *(PALPHA_INSTRUCTION)(ArchEntry-&gt;FixupInstRVA + BaseAddr),
02074                                  ArchEntry-&gt;NewInst
02075                                 );
02076 <span class="preprocessor">#endif</span>
02077 <span class="preprocessor"></span>                        *(ULONG *)(ArchEntry-&gt;FixupInstRVA + BaseAddr) = ArchEntry-&gt;NewInst;
02078                     }
02079                     ArchEntry++;
02080                 }
02081             } <span class="comment">// if this header describes fixups for this machine</span>
02082         }
02083         ArchHeader++;
02084     }
02085 }
02086 
02087 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02088 AlphaFindArchitectureFixups(
02089     PIMAGE_NT_HEADERS NtHeaders,
02090     PVOID ViewBase,
02091     BOOLEAN StaticLink
02092     )
02093 
02094 <span class="comment">/*++</span>
02095 <span class="comment"></span>
02096 <span class="comment">Routine Description:</span>
02097 <span class="comment"></span>
02098 <span class="comment">    This routine runs through a mapped image/dll looking for an architecture</span>
02099 <span class="comment">    enhancement section (.arch). If found, it applies the architecture</span>
02100 <span class="comment">    fixups.</span>
02101 <span class="comment"></span>
02102 <span class="comment"></span>
02103 <span class="comment">Arguments:</span>
02104 <span class="comment"></span>
02105 <span class="comment">    NtHeaders   - the NT header for this image or dll.</span>
02106 <span class="comment">    ViewBase    - the Mapped view base used for page protection munging.</span>
02107 <span class="comment">    StaticLink  - TRUE if this DLL has a static link to it</span>
02108 <span class="comment"></span>
02109 <span class="comment">Return Value:</span>
02110 <span class="comment"></span>
02111 <span class="comment">    None.</span>
02112 <span class="comment"></span>
02113 <span class="comment">--*/</span>
02114 
02115 {
02116     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02117     PIMAGE_ARCHITECTURE_HEADER ImageArchData;
02118 
02119     <span class="keywordflow">if</span> (NtHeaders-&gt;FileHeader.Machine != IMAGE_FILE_MACHINE_ALPHA) {
02120         <span class="comment">//</span>
02121         <span class="comment">// If the image isnt Alpha, don't try to find/apply Alpha fixups.</span>
02122         <span class="comment">// The image may be an x86 image linked with the x86 Watcom</span>
02123         <span class="comment">// linker which stuffed its version number in the .arch directory</span>
02124         <span class="comment">// entry in the image, fooling the Alpha .arch checker.</span>
02125         <span class="comment">//</span>
02126         <span class="keywordflow">return</span>;
02127     }
02128 
02129     ImageArchData =
02130         (PIMAGE_ARCHITECTURE_HEADER)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02131                                 ViewBase,
02132                                 TRUE,
02133                                 IMAGE_DIRECTORY_ENTRY_ARCHITECTURE,
02134                                 &amp;Size
02135                                 );
02136     <span class="keywordflow">if</span> (ImageArchData) {
02137         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02138 
02139         st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, FALSE, StaticLink); <span class="comment">// access to r/w</span>
02140 
02141         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02142             AlphaApplyArchitectureFixups(ImageArchData, Size, (ULONG_PTR)ViewBase);
02143             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, TRUE, StaticLink); <span class="comment">// back to r/o</span>
02144         }
02145     }
02146 }
02147 <span class="preprocessor">#endif</span>
02148 <span class="preprocessor"></span>
02149 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02150"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a47">02150</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a47">LdrpCreateDllSection</a>(
02151     IN PUNICODE_STRING NtFullDllName,
02152     IN HANDLE DllFile,
02153     IN PUNICODE_STRING BaseName,
02154     IN PULONG DllCharacteristics OPTIONAL,
02155     OUT PHANDLE SectionHandle
02156     )
02157 {
02158     HANDLE <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
02159     HANDLE Section;
02160     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02161     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02162     IO_STATUS_BLOCK IoStatus;
02163 
02164     <span class="keywordflow">if</span> ( !DllFile ) {
02165         <span class="comment">//</span>
02166         <span class="comment">// Since ntsdk does not search paths well, we can't use</span>
02167         <span class="comment">// relative object names</span>
02168         <span class="comment">//</span>
02169 
02170         InitializeObjectAttributes(
02171             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02172             NtFullDllName,
02173             OBJ_CASE_INSENSITIVE,
02174             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02175             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02176             );
02177 
02178         st = <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
02179                 &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
02180                 SYNCHRONIZE | FILE_EXECUTE,
02181                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02182                 &amp;IoStatus,
02183                 FILE_SHARE_READ | FILE_SHARE_DELETE,
02184                 FILE_NON_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT
02185                 );
02186         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02187 
02188 <span class="preprocessor">#if DBG</span>
02189 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrCreateDllSection - NtOpenFile( %wZ ) failed. Status == %X\n"</span>,
02190                 NtFullDllName,
02191                 st
02192                 );
02193 <span class="preprocessor">#endif</span>
02194 <span class="preprocessor"></span>            *SectionHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02195             <span class="keywordflow">return</span> st;
02196         }
02197 
02198 
02199     } <span class="keywordflow">else</span> {
02200              <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> = DllFile;
02201            }
02202 
02203 
02204     st = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(
02205             SectionHandle,
02206             SECTION_MAP_READ | SECTION_MAP_EXECUTE | SECTION_MAP_WRITE | SECTION_QUERY,
02207             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02208             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02209             PAGE_EXECUTE,
02210             SEC_IMAGE,
02211             <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>
02212             );
02213     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> );
02214 
02215     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02216 
02217         <span class="comment">//</span>
02218         <span class="comment">// hard error time</span>
02219         <span class="comment">//</span>
02220 
02221         ULONG_PTR ErrorParameters[1];
02222         ULONG ErrorResponse;
02223 
02224         *SectionHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02225         ErrorParameters[0] = (ULONG_PTR)NtFullDllName;
02226 
02227         <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
02228           STATUS_INVALID_IMAGE_FORMAT,
02229           1,
02230           1,
02231           ErrorParameters,
02232           OptionOk,
02233           &amp;ErrorResponse
02234           );
02235 
02236         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
02237             <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
02238             }
02239 
02240 
02241 <span class="preprocessor">#if DBG</span>
02242 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (st != STATUS_INVALID_IMAGE_NE_FORMAT &amp;&amp;
02243             st != STATUS_INVALID_IMAGE_LE_FORMAT &amp;&amp;
02244             st != STATUS_INVALID_IMAGE_WIN_16
02245            ) {
02246             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrCreateDllSection - NtCreateSection %wZ failed. Status == %X\n"</span>,
02247                      NtFullDllName,
02248                      st
02249                     );
02250         }
02251 <span class="preprocessor">#endif</span>
02252 <span class="preprocessor"></span>    }
02253 
02254     <span class="keywordflow">return</span> st;
02255 }
02256 
02257 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02258"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a48">02258</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a48">LdrpSnapIAT</a> (
02259     IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry_Export,
02260     IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry_Import,
02261     IN PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor,
02262     IN BOOLEAN SnapForwardersOnly
02263     )
02264 
02265 <span class="comment">/*++</span>
02266 <span class="comment"></span>
02267 <span class="comment">Routine Description:</span>
02268 <span class="comment"></span>
02269 <span class="comment">    This function snaps the Import Address Table for this</span>
02270 <span class="comment">    Import Descriptor.</span>
02271 <span class="comment"></span>
02272 <span class="comment">Arguments:</span>
02273 <span class="comment"></span>
02274 <span class="comment">    LdrDataTableEntry_Export - Information about the image to import from.</span>
02275 <span class="comment"></span>
02276 <span class="comment">    LdrDataTableEntry_Import - Information about the image to import to.</span>
02277 <span class="comment"></span>
02278 <span class="comment">    ImportDescriptor - Contains a pointer to the IAT to snap.</span>
02279 <span class="comment"></span>
02280 <span class="comment">    SnapForwardersOnly - TRUE if just snapping forwarders only.</span>
02281 <span class="comment"></span>
02282 <span class="comment">Return Value:</span>
02283 <span class="comment"></span>
02284 <span class="comment">    Status value</span>
02285 <span class="comment"></span>
02286 <span class="comment">--*/</span>
02287 
02288 {
02289     PPEB Peb;
02290     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02291     ULONG ExportSize;
02292     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
02293     PIMAGE_THUNK_DATA Thunk, OriginalThunk;
02294     PSZ ImportName;
02295     ULONG ForwarderChain;
02296     PIMAGE_NT_HEADERS NtHeaders;
02297     PIMAGE_SECTION_HEADER NtSection;
02298     ULONG i, Rva;
02299     PVOID IATBase;
02300     SIZE_T IATSize;
02301     ULONG LittleIATSize;
02302     ULONG OldProtect;
02303 
02304     Peb = NtCurrentPeb();
02305 
02306     ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02307                        LdrDataTableEntry_Export-&gt;DllBase,
02308                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02309                        IMAGE_DIRECTORY_ENTRY_EXPORT,
02310                        &amp;ExportSize
02311                        );
02312 
02313     <span class="keywordflow">if</span> (!ExportDirectory) {
02314         KdPrint((<span class="stringliteral">"LDR: %wZ doesn't contain an EXPORT table\n"</span>, &amp;LdrDataTableEntry_Export-&gt;BaseDllName));
02315         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
02316         }
02317 
02318     <span class="comment">//</span>
02319     <span class="comment">// Determine the location and size of the IAT.  If the linker did</span>
02320     <span class="comment">// not tell use explicitly, then use the location and size of the</span>
02321     <span class="comment">// image section that contains the import table.</span>
02322     <span class="comment">//</span>
02323 
02324     IATBase = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( LdrDataTableEntry_Import-&gt;DllBase,
02325                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02326                                             IMAGE_DIRECTORY_ENTRY_IAT,
02327                                             &amp;LittleIATSize
02328                                           );
02329     IATSize = LittleIATSize;
02330     <span class="keywordflow">if</span> (IATBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02331         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( LdrDataTableEntry_Import-&gt;DllBase );
02332         NtSection = IMAGE_FIRST_SECTION( NtHeaders );
02333         Rva = NtHeaders-&gt;OptionalHeader.DataDirectory[ IMAGE_DIRECTORY_ENTRY_IMPORT ].VirtualAddress;
02334         <span class="keywordflow">if</span> (Rva != 0) {
02335             <span class="keywordflow">for</span> (i=0; i&lt;NtHeaders-&gt;FileHeader.NumberOfSections; i++) {
02336                 <span class="keywordflow">if</span> (Rva &gt;= NtSection-&gt;VirtualAddress &amp;&amp;
02337                     Rva &lt; (NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData)
02338                    ) {
02339                     IATBase = (PVOID)
02340                         ((ULONG_PTR)(LdrDataTableEntry_Import-&gt;DllBase) + NtSection-&gt;VirtualAddress);
02341 
02342                     LittleIATSize = NtSection-&gt;Misc.VirtualSize;
02343                     <span class="keywordflow">if</span> (LittleIATSize == 0) {
02344                         LittleIATSize = NtSection-&gt;SizeOfRawData;
02345                         }
02346                     <span class="keywordflow">break</span>;
02347                     }
02348 
02349                 ++NtSection;
02350                 }
02351             }
02352 
02353         <span class="keywordflow">if</span> (IATBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02354             KdPrint(( <span class="stringliteral">"LDR: Unable to unprotect IAT for %wZ (Image Base %x)\n"</span>,
02355                       &amp;LdrDataTableEntry_Import-&gt;BaseDllName,
02356                       LdrDataTableEntry_Import-&gt;DllBase
02357                    ));
02358             <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
02359             }
02360         IATSize = LittleIATSize;
02361         }
02362 
02363     st = <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>( NtCurrentProcess(),
02364                                  &amp;IATBase,
02365                                  &amp;IATSize,
02366                                  PAGE_READWRITE,
02367                                  &amp;OldProtect
02368                                );
02369     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02370         KdPrint(( <span class="stringliteral">"LDR: Unable to unprotect IAT for %wZ (Status %x)\n"</span>,
02371                   &amp;LdrDataTableEntry_Import-&gt;BaseDllName,
02372                   st
02373                ));
02374         <span class="keywordflow">return</span> st;
02375         }
02376 
02377     <span class="comment">//</span>
02378     <span class="comment">// If just snapping forwarded entries, walk that list</span>
02379     <span class="comment">//</span>
02380     <span class="keywordflow">if</span> (SnapForwardersOnly) {
02381         ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase + ImportDescriptor-&gt;Name);
02382         ForwarderChain = ImportDescriptor-&gt;ForwarderChain;
02383         <span class="keywordflow">while</span> (ForwarderChain != -1) {
02384             OriginalThunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase +
02385                             ImportDescriptor-&gt;OriginalFirstThunk +
02386                             (ForwarderChain * <span class="keyword">sizeof</span>(IMAGE_THUNK_DATA)));
02387             Thunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase +
02388                             ImportDescriptor-&gt;FirstThunk +
02389                             (ForwarderChain * <span class="keyword">sizeof</span>(IMAGE_THUNK_DATA)));
02390             ForwarderChain = (ULONG) Thunk-&gt;u1.Ordinal;
02391             <span class="keywordflow">try</span> {
02392                 st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a49">LdrpSnapThunk</a>(LdrDataTableEntry_Export-&gt;DllBase,
02393                         LdrDataTableEntry_Import-&gt;DllBase,
02394                         OriginalThunk,
02395                         Thunk,
02396                         ExportDirectory,
02397                         ExportSize,
02398                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02399                         ImportName
02400                         );
02401                 Thunk++;
02402                 }
02403             except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02404                 st = GetExceptionCode();
02405                 }
02406             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02407                 <span class="keywordflow">break</span>;
02408                 }
02409             }
02410         }
02411     <span class="keywordflow">else</span>
02412 
02413     <span class="comment">//</span>
02414     <span class="comment">// Otherwise, walk through the IAT and snap all the thunks.</span>
02415     <span class="comment">//</span>
02416 
02417     <span class="keywordflow">if</span> ( ImportDescriptor-&gt;FirstThunk ) {
02418         Thunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase + ImportDescriptor-&gt;FirstThunk);
02419 
02420         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( LdrDataTableEntry_Import-&gt;DllBase );
02421         <span class="comment">//</span>
02422         <span class="comment">// If the OriginalFirstThunk field does not point inside the image, then ignore</span>
02423         <span class="comment">// it.  This is will detect bogus Borland Linker 2.25 images that did not fill</span>
02424         <span class="comment">// this field in.</span>
02425         <span class="comment">//</span>
02426 
02427         <span class="keywordflow">if</span> (ImportDescriptor-&gt;Characteristics &lt; NtHeaders-&gt;OptionalHeader.SizeOfHeaders ||
02428             ImportDescriptor-&gt;Characteristics &gt;= NtHeaders-&gt;OptionalHeader.SizeOfImage
02429            ) {
02430             OriginalThunk = Thunk;
02431         } <span class="keywordflow">else</span> {
02432             OriginalThunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase +
02433                             ImportDescriptor-&gt;OriginalFirstThunk);
02434         }
02435         ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase + ImportDescriptor-&gt;Name);
02436         <span class="keywordflow">while</span> (OriginalThunk-&gt;u1.AddressOfData) {
02437             <span class="keywordflow">try</span> {
02438                 st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a49">LdrpSnapThunk</a>(LdrDataTableEntry_Export-&gt;DllBase,
02439                         LdrDataTableEntry_Import-&gt;DllBase,
02440                         OriginalThunk,
02441                         Thunk,
02442                         ExportDirectory,
02443                         ExportSize,
02444                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02445                         ImportName
02446                         );
02447                 OriginalThunk++;
02448                 Thunk++;
02449                 }
02450             except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02451                 st = GetExceptionCode();
02452                 }
02453 
02454             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02455                 <span class="keywordflow">break</span>;
02456                 }
02457             }
02458         }
02459 
02460     <span class="comment">//</span>
02461     <span class="comment">// Restore protection for IAT and flush instruction cache.</span>
02462     <span class="comment">//</span>
02463 
02464     <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>( NtCurrentProcess(),
02465                             &amp;IATBase,
02466                             &amp;IATSize,
02467                             OldProtect,
02468                             &amp;OldProtect
02469                           );
02470     <a class="code" href="../../d5/d5/flushbuf_8c.html#a2">NtFlushInstructionCache</a>( NtCurrentProcess(), IATBase, LittleIATSize );
02471 
02472     <span class="keywordflow">return</span> st;
02473 }
02474 
02475 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02476"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a49">02476</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a49">LdrpSnapThunk</a> (
02477     IN PVOID DllBase,
02478     IN PVOID ImageBase,
02479     IN PIMAGE_THUNK_DATA OriginalThunk,
02480     IN OUT PIMAGE_THUNK_DATA Thunk,
02481     IN PIMAGE_EXPORT_DIRECTORY ExportDirectory,
02482     IN ULONG ExportSize,
02483     IN BOOLEAN StaticSnap,
02484     IN PSZ DllName
02485     )
02486 
02487 <span class="comment">/*++</span>
02488 <span class="comment"></span>
02489 <span class="comment">Routine Description:</span>
02490 <span class="comment"></span>
02491 <span class="comment">    This function snaps a thunk using the specified Export Section data.</span>
02492 <span class="comment">    If the section data does not support the thunk, then the thunk is</span>
02493 <span class="comment">    partially snapped (Dll field is still non-null, but snap address is</span>
02494 <span class="comment">    set).</span>
02495 <span class="comment"></span>
02496 <span class="comment">Arguments:</span>
02497 <span class="comment"></span>
02498 <span class="comment">    DllBase - Base of Dll.</span>
02499 <span class="comment"></span>
02500 <span class="comment">    ImageBase - Base of image that contains the thunks to snap.</span>
02501 <span class="comment"></span>
02502 <span class="comment">    Thunk - On input, supplies the thunk to snap.  When successfully</span>
02503 <span class="comment">        snapped, the function field is set to point to the address in</span>
02504 <span class="comment">        the DLL, and the DLL field is set to NULL.</span>
02505 <span class="comment"></span>
02506 <span class="comment">    ExportDirectory - Supplies the Export Section data from a DLL.</span>
02507 <span class="comment"></span>
02508 <span class="comment">    StaticSnap - If TRUE, then loader is attempting a static snap,</span>
02509 <span class="comment">                 and any ordinal/name lookup failure will be reported.</span>
02510 <span class="comment"></span>
02511 <span class="comment">Return Value:</span>
02512 <span class="comment"></span>
02513 <span class="comment">    STATUS_SUCCESS or STATUS_PROCEDURE_NOT_FOUND</span>
02514 <span class="comment"></span>
02515 <span class="comment">--*/</span>
02516 
02517 {
02518     BOOLEAN Ordinal;
02519     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> OrdinalNumber;
02520     ULONG OriginalOrdinalNumber;
02521     PIMAGE_IMPORT_BY_NAME AddressOfData;
02522     PULONG NameTableBase;
02523     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase;
02524     PULONG Addr;
02525     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> HintIndex;
02526     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02527     PSZ ImportString;
02528 
02529     <span class="comment">//</span>
02530     <span class="comment">// Determine if snap is by name, or by ordinal</span>
02531     <span class="comment">//</span>
02532 
02533     Ordinal = (BOOLEAN)IMAGE_SNAP_BY_ORDINAL(OriginalThunk-&gt;u1.Ordinal);
02534 
02535     <span class="keywordflow">if</span> (Ordinal) {
02536         OriginalOrdinalNumber = (ULONG)IMAGE_ORDINAL(OriginalThunk-&gt;u1.Ordinal);
02537         OrdinalNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(OriginalOrdinalNumber - ExportDirectory-&gt;Base);
02538     } <span class="keywordflow">else</span> {
02539              <span class="comment">//</span>
02540              <span class="comment">// Change AddressOfData from an RVA to a VA.</span>
02541              <span class="comment">//</span>
02542 
02543              AddressOfData = (PIMAGE_IMPORT_BY_NAME)((ULONG_PTR)ImageBase + ((ULONG_PTR)OriginalThunk-&gt;u1.AddressOfData &amp; 0xffffffff));
02544              ImportString = (PSZ)AddressOfData-&gt;Name;
02545 
02546              <span class="comment">//</span>
02547              <span class="comment">// Lookup Name in NameTable</span>
02548              <span class="comment">//</span>
02549 
02550              NameTableBase = (PULONG)((ULONG_PTR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNames);
02551              NameOrdinalTableBase = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((ULONG_PTR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNameOrdinals);
02552 
02553              <span class="comment">//</span>
02554              <span class="comment">// Before dropping into binary search, see if</span>
02555              <span class="comment">// the hint index results in a successful</span>
02556              <span class="comment">// match. If the hint index is zero, then</span>
02557              <span class="comment">// drop into binary search.</span>
02558              <span class="comment">//</span>
02559 
02560              HintIndex = AddressOfData-&gt;Hint;
02561              <span class="keywordflow">if</span> ((ULONG)HintIndex &lt; ExportDirectory-&gt;NumberOfNames &amp;&amp;
02562                  !strcmp(ImportString, (PSZ)((ULONG_PTR)DllBase + NameTableBase[HintIndex]))) {
02563                  OrdinalNumber = NameOrdinalTableBase[HintIndex];
02564 <span class="preprocessor">#if LDRDBG</span>
02565 <span class="preprocessor"></span>                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02566                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Snapping %s\n"</span>, ImportString);
02567                  }
02568 <span class="preprocessor">#endif</span>
02569 <span class="preprocessor"></span>             } <span class="keywordflow">else</span> {
02570 <span class="preprocessor">#if LDRDBG</span>
02571 <span class="preprocessor"></span>                      <span class="keywordflow">if</span> (HintIndex) {
02572                           <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Warning HintIndex Failure. Name %s (%lx) Hint 0x%lx\n"</span>,
02573                               ImportString,
02574                               (ULONG)ImportString,
02575                               (ULONG)HintIndex
02576                               );
02577                       }
02578 <span class="preprocessor">#endif</span>
02579 <span class="preprocessor"></span>                      OrdinalNumber = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a50">LdrpNameToOrdinal</a>(
02580                                         ImportString,
02581                                         ExportDirectory-&gt;NumberOfNames,
02582                                         DllBase,
02583                                         NameTableBase,
02584                                         NameOrdinalTableBase
02585                                         );
02586                     }
02587            }
02588 
02589     <span class="comment">//</span>
02590     <span class="comment">// If OrdinalNumber is not within the Export Address Table,</span>
02591     <span class="comment">// then DLL does not implement function. Snap to LDRP_BAD_DLL.</span>
02592     <span class="comment">//</span>
02593 
02594     <span class="keywordflow">if</span> ((ULONG)OrdinalNumber &gt;= ExportDirectory-&gt;NumberOfFunctions) {
02595 baddllref:
02596 <span class="preprocessor">#if DBG</span>
02597 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (StaticSnap) {
02598             <span class="keywordflow">if</span> (Ordinal) {
02599                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Can't locate ordinal 0x%lx\n"</span>, OriginalOrdinalNumber);
02600                 }
02601             <span class="keywordflow">else</span> {
02602                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Can't locate %s\n"</span>, ImportString);
02603                 }
02604         }
02605 <span class="preprocessor">#endif</span>
02606 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( StaticSnap ) {
02607             <span class="comment">//</span>
02608             <span class="comment">// Hard Error Time</span>
02609             <span class="comment">//</span>
02610 
02611             ULONG_PTR ErrorParameters[3];
02612             UNICODE_STRING ErrorDllName, ErrorEntryPointName;
02613             ANSI_STRING AnsiScratch;
02614             ULONG ParameterStringMask;
02615             ULONG ErrorResponse;
02616 
02617             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiScratch,DllName ? DllName : <span class="stringliteral">"Unknown"</span>);
02618             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;ErrorDllName,&amp;AnsiScratch,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02619             ErrorParameters[1] = (ULONG_PTR)&amp;ErrorDllName;
02620             ParameterStringMask = 2;
02621 
02622             <span class="keywordflow">if</span> ( Ordinal ) {
02623                 ErrorParameters[0] = OriginalOrdinalNumber;
02624                 }
02625             <span class="keywordflow">else</span> {
02626                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiScratch,ImportString);
02627                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;ErrorEntryPointName,&amp;AnsiScratch,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02628                 ErrorParameters[0] = (ULONG_PTR)&amp;ErrorEntryPointName;
02629                 ParameterStringMask = 3;
02630                 }
02631 
02632 
02633             <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
02634               Ordinal ? STATUS_ORDINAL_NOT_FOUND : STATUS_ENTRYPOINT_NOT_FOUND,
02635               2,
02636               ParameterStringMask,
02637               ErrorParameters,
02638               OptionOk,
02639               &amp;ErrorResponse
02640               );
02641 
02642             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
02643                 <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
02644                 }
02645             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ErrorDllName);
02646             <span class="keywordflow">if</span> ( !Ordinal ) {
02647                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ErrorEntryPointName);
02648                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_ENTRYPOINT_NOT_FOUND);
02649                 }
02650             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_ORDINAL_NOT_FOUND);
02651             }
02652         Thunk-&gt;u1.Function = (ULONG_PTR)<a class="code" href="../../d9/d2/ldrp_8h.html#a8">LDRP_BAD_DLL</a>;
02653         st = Ordinal ? STATUS_ORDINAL_NOT_FOUND : STATUS_ENTRYPOINT_NOT_FOUND;
02654     } <span class="keywordflow">else</span> {
02655              Addr = (PULONG)((ULONG_PTR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfFunctions);
02656              Thunk-&gt;u1.Function = ((ULONG_PTR)DllBase + Addr[OrdinalNumber]);
02657              <span class="keywordflow">if</span> (Thunk-&gt;u1.Function &gt; (ULONG_PTR)ExportDirectory &amp;&amp;
02658                  Thunk-&gt;u1.Function &lt; ((ULONG_PTR)ExportDirectory + ExportSize)
02659                 ) {
02660                 UNICODE_STRING UnicodeString;
02661                 ANSI_STRING ForwardDllName;
02662                 PVOID ForwardDllHandle;
02663                 PUNICODE_STRING ForwardProcName;
02664                 ULONG ForwardProcOrdinal;
02665 
02666                 ImportString = (PSZ)Thunk-&gt;u1.Function;
02667                 ForwardDllName.Buffer = ImportString,
02668                 ForwardDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(strchr(ImportString, <span class="charliteral">'.'</span>) - ImportString);
02669                 ForwardDllName.MaximumLength = ForwardDllName.Length;
02670                 st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeString, &amp;ForwardDllName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02671 
02672                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02673 <span class="preprocessor">#if defined (WX86)</span>
02674 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Wx86ProcessInit) {
02675                         NtCurrentTeb()-&gt;Wx86Thread.UseKnownWx86Dll = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DllBase)-&gt;FileHeader.Machine
02676                                                    == IMAGE_FILE_MACHINE_I386;
02677 
02678                         }
02679 <span class="preprocessor">#endif</span>
02680 <span class="preprocessor"></span>
02681 
02682                         st = <a class="code" href="../../d9/d2/ldrp_8h.html#a82">LdrpLoadDll</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;UnicodeString, &amp;ForwardDllHandle,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02683                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeString);
02684                     }
02685 
02686                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02687                     <span class="keywordflow">goto</span> baddllref;
02688                     }
02689 
02690                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ForwardDllName,
02691                                    ImportString + ForwardDllName.Length + 1
02692                                  );
02693                 <span class="keywordflow">if</span> (ForwardDllName.Length &gt; 1 &amp;&amp;
02694                     *ForwardDllName.Buffer == <span class="charliteral">'#'</span>
02695                    ) {
02696                     ForwardProcName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02697                     st = <a class="code" href="../../d9/d3/cnvint_8c.html#a3">RtlCharToInteger</a>( ForwardDllName.Buffer+1,
02698                                            0,
02699                                            &amp;ForwardProcOrdinal
02700                                          );
02701                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02702                         <span class="keywordflow">goto</span> baddllref;
02703                         }
02704                     }
02705                 <span class="keywordflow">else</span> {
02706                     ForwardProcName = (PUNICODE_STRING)&amp;ForwardDllName;
02707 
02708                     <span class="comment">//</span>
02709                     <span class="comment">// Following line is not needed since this is a by name lookup</span>
02710                     <span class="comment">//</span>
02711                     <span class="comment">//</span>
02712                     <span class="comment">//ForwardProcOrdinal = (ULONG)&amp;ForwardDllName;</span>
02713                     <span class="comment">//</span>
02714                     }
02715 
02716                 st = <a class="code" href="../../d9/d2/ldrp_8h.html#a83">LdrpGetProcedureAddress</a>( ForwardDllHandle,
02717                                               (PANSI_STRING )ForwardProcName,
02718                                               ForwardProcOrdinal,
02719                                               &amp;(PVOID)Thunk-&gt;u1.Function,
02720                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02721                                             );
02722                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02723                     <span class="keywordflow">goto</span> baddllref;
02724                     }
02725                 }
02726              <span class="keywordflow">else</span> {
02727                 <span class="keywordflow">if</span> ( !Addr[OrdinalNumber] ) {
02728                     <span class="keywordflow">goto</span> baddllref;
02729                     }
02730 <span class="preprocessor">#if defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
02731 <span class="preprocessor"></span>                <span class="keywordflow">else</span> {
02732                    PIMAGE_NT_HEADERS ExportNtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DllBase);
02733 
02734                    <span class="keywordflow">if</span> ((ExportNtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
02735                        (ExportNtHeaders-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386)) {
02736                        Thunk-&gt;u1.Function += LdrpWx86RelocatedFixupDiff(DllBase, Addr[OrdinalNumber]);
02737                     }
02738                 }
02739 <span class="preprocessor">#endif //  defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
02740 <span class="preprocessor"></span>             }
02741              st = STATUS_SUCCESS;
02742            }
02743     <span class="keywordflow">return</span> st;
02744 }
02745 
02746 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l02747"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a50">02747</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a50">LdrpNameToOrdinal</a> (
02748     IN PSZ Name,
02749     IN ULONG NumberOfNames,
02750     IN PVOID DllBase,
02751     IN PULONG NameTableBase,
02752     IN PUSHORT NameOrdinalTableBase
02753     )
02754 {
02755     LONG High;
02756     LONG Low;
02757     LONG Middle;
02758     LONG Result;
02759 
02760     <span class="comment">//</span>
02761     <span class="comment">// Lookup the import name in the name table using a binary search.</span>
02762     <span class="comment">//</span>
02763 
02764     Low = 0;
02765     High = NumberOfNames - 1;
02766     <span class="keywordflow">while</span> (High &gt;= Low) {
02767 
02768         <span class="comment">//</span>
02769         <span class="comment">// Compute the next probe index and compare the import name</span>
02770         <span class="comment">// with the export name entry.</span>
02771         <span class="comment">//</span>
02772 
02773         Middle = (Low + High) &gt;&gt; 1;
02774         Result = strcmp(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, (PCHAR)((ULONG_PTR)DllBase + NameTableBase[Middle]));
02775 
02776         <span class="keywordflow">if</span> (Result &lt; 0) {
02777             High = Middle - 1;
02778 
02779         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &gt; 0) {
02780             Low = Middle + 1;
02781 
02782         } <span class="keywordflow">else</span> {
02783             <span class="keywordflow">break</span>;
02784         }
02785     }
02786 
02787     <span class="comment">//</span>
02788     <span class="comment">// If the high index is less than the low index, then a matching</span>
02789     <span class="comment">// table entry was not found. Otherwise, get the ordinal number</span>
02790     <span class="comment">// from the ordinal table.</span>
02791     <span class="comment">//</span>
02792 
02793     <span class="keywordflow">if</span> (High &lt; Low) {
02794         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)-1;
02795     } <span class="keywordflow">else</span> {
02796         <span class="keywordflow">return</span> NameOrdinalTableBase[Middle];
02797     }
02798 
02799 }
02800 
02801 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02802"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a51">02802</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a51">LdrpUpdateLoadCount</a> (
02803     IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry,
02804     IN BOOLEAN IncrementCount
02805     )
02806 
02807 <span class="comment">/*++</span>
02808 <span class="comment"></span>
02809 <span class="comment">Routine Description:</span>
02810 <span class="comment"></span>
02811 <span class="comment">    This function dereferences a loaded DLL adjusting its reference</span>
02812 <span class="comment">    count.  It then dereferences each dll referenced by this dll.</span>
02813 <span class="comment"></span>
02814 <span class="comment">Arguments:</span>
02815 <span class="comment"></span>
02816 <span class="comment">    LdrDataTableEntry - Supplies the address of the DLL to dereference</span>
02817 <span class="comment"></span>
02818 <span class="comment">    IncrementCount - TRUE if adding one to LoadCount, O.W. subtracting one</span>
02819 <span class="comment"></span>
02820 <span class="comment">Return Value:</span>
02821 <span class="comment"></span>
02822 <span class="comment">    None.</span>
02823 <span class="comment"></span>
02824 <span class="comment">--*/</span>
02825 
02826 {
02827     PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor;
02828     PIMAGE_BOUND_IMPORT_DESCRIPTOR NewImportDescriptor;
02829     PIMAGE_BOUND_FORWARDER_REF NewImportForwarder;
02830     PSZ ImportName, NewImportStringBase;
02831     ULONG i, ImportSize, NewImportSize;
02832     ANSI_STRING AnsiString;
02833     PUNICODE_STRING ImportDescriptorName_U;
02834     PLDR_DATA_TABLE_ENTRY Entry;
02835     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02836     BOOLEAN Wx86KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02837     PIMAGE_THUNK_DATA FirstThunk;
02838 
02839     <span class="keywordflow">if</span> (IncrementCount)
02840         <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags &amp; LDRP_LOAD_IN_PROGRESS) {
02841             <span class="keywordflow">return</span>;
02842         } <span class="keywordflow">else</span> {
02843             LdrDataTableEntry-&gt;Flags |= LDRP_LOAD_IN_PROGRESS;
02844         }
02845     <span class="keywordflow">else</span>
02846         <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags &amp; LDRP_UNLOAD_IN_PROGRESS) {
02847             <span class="keywordflow">return</span>;
02848         } <span class="keywordflow">else</span> {
02849             LdrDataTableEntry-&gt;Flags |= LDRP_UNLOAD_IN_PROGRESS;
02850         }
02851 
02852     <span class="comment">//</span>
02853     <span class="comment">// For each DLL used by this DLL, reference or dereference the DLL.</span>
02854     <span class="comment">//</span>
02855 
02856     ImportDescriptorName_U = &amp;NtCurrentTeb()-&gt;StaticUnicodeString;
02857 
02858 <span class="preprocessor">#if defined (WX86)</span>
02859 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Wx86ProcessInit) {
02860         Wx86KnownDll = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(LdrDataTableEntry-&gt;DllBase)-&gt;FileHeader.Machine
02861                            == IMAGE_FILE_MACHINE_I386;
02862         }
02863 <span class="preprocessor">#endif</span>
02864 <span class="preprocessor"></span>
02865 
02866 
02867 
02868     <span class="comment">//</span>
02869     <span class="comment">// See if there is a bound import table.  If so, walk that to</span>
02870     <span class="comment">// determine DLL names to reference or dereference.  Avoids touching</span>
02871     <span class="comment">// the .idata section</span>
02872     <span class="comment">//</span>
02873     NewImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02874                            LdrDataTableEntry-&gt;DllBase,
02875                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02876                            IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT,
02877                            &amp;NewImportSize
02878                            );
02879     <span class="keywordflow">if</span> (NewImportDescriptor) {
02880         <span class="keywordflow">if</span> (IncrementCount) {
02881             LdrDataTableEntry-&gt;Flags |= LDRP_LOAD_IN_PROGRESS;
02882         } <span class="keywordflow">else</span> {
02883             LdrDataTableEntry-&gt;Flags |= LDRP_UNLOAD_IN_PROGRESS;
02884         }
02885 
02886         NewImportStringBase = (LPSTR)NewImportDescriptor;
02887         <span class="keywordflow">while</span> (NewImportDescriptor-&gt;OffsetModuleName) {
02888             ImportName = NewImportStringBase +
02889                          NewImportDescriptor-&gt;OffsetModuleName;
02890             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
02891             st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(ImportDescriptorName_U, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02892             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02893                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02894                                            ImportDescriptorName_U,
02895                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02896                                            Wx86KnownDll,
02897                                            &amp;Entry
02898                                          )
02899                    ) {
02900                     <span class="keywordflow">if</span> ( Entry-&gt;LoadCount != 0xffff ) {
02901                         <span class="keywordflow">if</span> (IncrementCount) {
02902                             Entry-&gt;LoadCount++;
02903 
02904                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02905                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Refcount   %wZ (%lx)\n"</span>,
02906                                         ImportDescriptorName_U,
02907                                         (ULONG)Entry-&gt;LoadCount
02908                                         );
02909                             }
02910                         } <span class="keywordflow">else</span> {
02911                             Entry-&gt;LoadCount--;
02912 
02913                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02914                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Derefcount   %wZ (%lx)\n"</span>,
02915                                         ImportDescriptorName_U,
02916                                         (ULONG)Entry-&gt;LoadCount
02917                                         );
02918                             }
02919                         }
02920                     }
02921                     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a51">LdrpUpdateLoadCount</a>(Entry, IncrementCount);
02922                 }
02923             }
02924 
02925             NewImportForwarder = (PIMAGE_BOUND_FORWARDER_REF)(NewImportDescriptor+1);
02926             <span class="keywordflow">for</span> (i=0; i&lt;NewImportDescriptor-&gt;NumberOfModuleForwarderRefs; i++) {
02927                 ImportName = NewImportStringBase +
02928                              NewImportForwarder-&gt;OffsetModuleName;
02929 
02930                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
02931                 st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(ImportDescriptorName_U, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02932                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02933                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02934                                                ImportDescriptorName_U,
02935                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02936                                                Wx86KnownDll,
02937                                                &amp;Entry
02938                                              )
02939                        ) {
02940                         <span class="keywordflow">if</span> ( Entry-&gt;LoadCount != 0xffff ) {
02941                             <span class="keywordflow">if</span> (IncrementCount) {
02942                                 Entry-&gt;LoadCount++;
02943 
02944                                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02945                                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Refcount   %wZ (%lx)\n"</span>,
02946                                             ImportDescriptorName_U,
02947                                             (ULONG)Entry-&gt;LoadCount
02948                                             );
02949                                 }
02950                             } <span class="keywordflow">else</span> {
02951                                 Entry-&gt;LoadCount--;
02952 
02953                                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02954                                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Derefcount   %wZ (%lx)\n"</span>,
02955                                             ImportDescriptorName_U,
02956                                             (ULONG)Entry-&gt;LoadCount
02957                                             );
02958                                 }
02959                             }
02960                         }
02961                         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a51">LdrpUpdateLoadCount</a>(Entry, IncrementCount);
02962                     }
02963                 }
02964 
02965                 NewImportForwarder += 1;
02966             }
02967 
02968             NewImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)NewImportForwarder;
02969         }
02970 
02971         <span class="keywordflow">return</span>;
02972     }
02973 
02974     ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02975                         LdrDataTableEntry-&gt;DllBase,
02976                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02977                         IMAGE_DIRECTORY_ENTRY_IMPORT,
02978                         &amp;ImportSize
02979                         );
02980     <span class="keywordflow">if</span> (ImportDescriptor) {
02981 
02982         <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name &amp;&amp; ImportDescriptor-&gt;FirstThunk) {
02983 
02984             <span class="comment">//</span>
02985             <span class="comment">// Match code in walk that skips references like this. IE3 had</span>
02986             <span class="comment">// some dll's with these bogus links to url.dll. On load, the url.dll</span>
02987             <span class="comment">// ref was skipped. On unload, it was not skipped because</span>
02988             <span class="comment">// this code was missing.</span>
02989             <span class="comment">//</span>
02990             <span class="comment">// Since the skip logic is only in the old style import</span>
02991             <span class="comment">// descriptor path, it is only duplicated here.</span>
02992             <span class="comment">//</span>
02993             <span class="comment">// check for import that has no references</span>
02994             <span class="comment">//</span>
02995             FirstThunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;FirstThunk);
02996             <span class="keywordflow">if</span> ( !FirstThunk-&gt;u1.Function ) {
02997                 <span class="keywordflow">goto</span> skipskippedimport;
02998                 }
02999 
03000             ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;Name);
03001 
03002             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
03003             st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(ImportDescriptorName_U, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03004             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03005                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03006                                            ImportDescriptorName_U,
03007                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03008                                            Wx86KnownDll,
03009                                            &amp;Entry
03010                                          )
03011                    ) {
03012                     <span class="keywordflow">if</span> ( Entry-&gt;LoadCount != 0xffff ) {
03013                         <span class="keywordflow">if</span> (IncrementCount) {
03014                             Entry-&gt;LoadCount++;
03015 
03016                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
03017                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Refcount   %wZ (%lx)\n"</span>,
03018                                         ImportDescriptorName_U,
03019                                         (ULONG)Entry-&gt;LoadCount
03020                                         );
03021                             }
03022                         } <span class="keywordflow">else</span> {
03023                             Entry-&gt;LoadCount--;
03024 
03025                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
03026                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Derefcount   %wZ (%lx)\n"</span>,
03027                                         ImportDescriptorName_U,
03028                                         (ULONG)Entry-&gt;LoadCount
03029                                         );
03030                             }
03031                         }
03032                     }
03033                     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a51">LdrpUpdateLoadCount</a>(Entry, IncrementCount);
03034                 }
03035             }
03036 skipskippedimport:
03037             ++ImportDescriptor;
03038         }
03039     }
03040 }
03041 
03042 PLDR_DATA_TABLE_ENTRY
<a name="l03043"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">03043</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a> (
03044     IN PVOID DllBase
03045     )
03046 
03047 <span class="comment">/*++</span>
03048 <span class="comment"></span>
03049 <span class="comment">Routine Description:</span>
03050 <span class="comment"></span>
03051 <span class="comment">    This function allocates an entry in the loader data table. If the</span>
03052 <span class="comment">    table is going to overflow, then a new table is allocated.</span>
03053 <span class="comment"></span>
03054 <span class="comment">Arguments:</span>
03055 <span class="comment"></span>
03056 <span class="comment">    DllBase - Supplies the address of the base of the DLL Image.</span>
03057 <span class="comment">        be added to the loader data table.</span>
03058 <span class="comment"></span>
03059 <span class="comment">Return Value:</span>
03060 <span class="comment"></span>
03061 <span class="comment">    Returns the address of the allocated loader data table entry</span>
03062 <span class="comment"></span>
03063 <span class="comment">--*/</span>
03064 
03065 {
03066     PLDR_DATA_TABLE_ENTRY Entry;
03067     PIMAGE_NT_HEADERS NtHeaders;
03068 
03069     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DllBase);
03070 
03071     Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03072     <span class="keywordflow">if</span> ( NtHeaders ) {
03073         Entry = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a13">LDR_TAG</a> ) | HEAP_ZERO_MEMORY,<span class="keyword">sizeof</span>( *Entry ));
03074         <span class="keywordflow">if</span> ( Entry ) {
03075             Entry-&gt;DllBase = DllBase;
03076             Entry-&gt;SizeOfImage = NtHeaders-&gt;OptionalHeader.SizeOfImage;
03077             Entry-&gt;TimeDateStamp = NtHeaders-&gt;FileHeader.TimeDateStamp;
03078             }
03079         }
03080     <span class="keywordflow">return</span> Entry;
03081 }
03082 
03083 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03084"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">03084</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a> (
03085     IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry
03086     )
03087 
03088 <span class="comment">/*++</span>
03089 <span class="comment"></span>
03090 <span class="comment">Routine Description:</span>
03091 <span class="comment"></span>
03092 <span class="comment">    This function inserts a loader data table entry into the</span>
03093 <span class="comment">    list of loaded modules for this process. The insertion is</span>
03094 <span class="comment">    done in "image memory base order".</span>
03095 <span class="comment"></span>
03096 <span class="comment">Arguments:</span>
03097 <span class="comment"></span>
03098 <span class="comment">    LdrDataTableEntry - Supplies the address of the loader data table</span>
03099 <span class="comment">        entry to insert in the list of loaded modules for this process.</span>
03100 <span class="comment"></span>
03101 <span class="comment">Return Value:</span>
03102 <span class="comment"></span>
03103 <span class="comment">    None.</span>
03104 <span class="comment"></span>
03105 <span class="comment">--*/</span>
03106 
03107 {
03108     PPEB_LDR_DATA Ldr;
03109     ULONG i;
03110 
03111     Ldr = NtCurrentPeb()-&gt;Ldr;
03112 
03113     i = <a class="code" href="../../d9/d2/ldrp_8h.html#a7">LDRP_COMPUTE_HASH_INDEX</a>(LdrDataTableEntry-&gt;BaseDllName.Buffer[0]);
03114     InsertTailList(&amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a26">LdrpHashTable</a>[i],&amp;LdrDataTableEntry-&gt;HashLinks);
03115     InsertTailList(&amp;Ldr-&gt;InLoadOrderModuleList, &amp;LdrDataTableEntry-&gt;InLoadOrderLinks);
03116     InsertTailList(&amp;Ldr-&gt;InMemoryOrderModuleList, &amp;LdrDataTableEntry-&gt;InMemoryOrderLinks);
03117 }
03118 
03119 BOOLEAN
<a name="l03120"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a54">03120</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a54">LdrpResolveDllName</a> (
03121     IN PWSTR DllPath OPTIONAL,
03122     IN PWSTR DllName,
03123     OUT PUNICODE_STRING FullDllName,
03124     OUT PUNICODE_STRING BaseDllName,
03125     OUT PHANDLE DllFile
03126     )
03127 
03128 <span class="comment">/*++</span>
03129 <span class="comment"></span>
03130 <span class="comment">Routine Description:</span>
03131 <span class="comment"></span>
03132 <span class="comment">    This function computes the DLL pathname and base dll name (the</span>
03133 <span class="comment">    unqualified, extensionless portion of the file name) for the specified</span>
03134 <span class="comment">    DLL.</span>
03135 <span class="comment"></span>
03136 <span class="comment">Arguments:</span>
03137 <span class="comment"></span>
03138 <span class="comment">    DllPath - Supplies the DLL search path.</span>
03139 <span class="comment"></span>
03140 <span class="comment">    DllName - Supplies the name of the DLL.</span>
03141 <span class="comment"></span>
03142 <span class="comment">    FullDllName - Returns the fully qualified pathname of the</span>
03143 <span class="comment">        DLL. The Buffer field of this string is dynamically</span>
03144 <span class="comment">        allocated from the processes heap.</span>
03145 <span class="comment"></span>
03146 <span class="comment">    BaseDLLName - Returns the base dll name of the dll.  The base name</span>
03147 <span class="comment">        is the file name portion of the dll path without the trailing</span>
03148 <span class="comment">        extension. The Buffer field of this string is dynamically</span>
03149 <span class="comment">        allocated from the processes heap.</span>
03150 <span class="comment"></span>
03151 <span class="comment">    DllFile - Returns an open handle to the DLL file. This parameter may</span>
03152 <span class="comment">        still be NULL even upon success.</span>
03153 <span class="comment"></span>
03154 <span class="comment">Return Value:</span>
03155 <span class="comment"></span>
03156 <span class="comment">    TRUE - The operation was successful. A DLL file was found, and the</span>
03157 <span class="comment">        FullDllName-&gt;Buffer &amp; BaseDllName-&gt;Buffer field points to the</span>
03158 <span class="comment">        base of process heap allocated memory.</span>
03159 <span class="comment"></span>
03160 <span class="comment">    FALSE - The DLL could not be found.</span>
03161 <span class="comment"></span>
03162 <span class="comment">--*/</span>
03163 
03164 {
03165     ULONG Length;
03166     PWCH p, pp;
03167     PWCH FullBuffer;
03168 
03169     *DllFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03170     FullDllName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a18">TEMP_TAG</a> ),530+<span class="keyword">sizeof</span>(UNICODE_NULL));
03171     <span class="keywordflow">if</span> (FullDllName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03172         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03173         }
03174 
03175     Length = <a class="code" href="../../d5/d1/curdir_8c.html#a32">RtlDosSearchPath_U</a>(
03176                 ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer,
03177                 DllName,
03178                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03179                 530,
03180                 FullDllName-&gt;Buffer,
03181                 &amp;BaseDllName-&gt;Buffer
03182                 );
03183 
03184     <span class="keywordflow">if</span> ( !Length || Length &gt; 530 ) {
03185 
03186         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
03187             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrResolveDllName - Unable To Locate "</span>);
03188             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%ws from %ws\n"</span>,
03189                 DllName,
03190                 ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer
03191                 );
03192         }
03193 
03194         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(FullDllName);
03195         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03196     }
03197 
03198     FullDllName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
03199     FullDllName-&gt;MaximumLength = FullDllName-&gt;Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
03200     FullBuffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a13">LDR_TAG</a> ),FullDllName-&gt;MaximumLength);
03201     <span class="keywordflow">if</span> ( FullBuffer ) {
03202         RtlCopyMemory(FullBuffer,FullDllName-&gt;Buffer,FullDllName-&gt;MaximumLength);
03203         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, FullDllName-&gt;Buffer);
03204         FullDllName-&gt;Buffer = FullBuffer;
03205         }
03206     <span class="keywordflow">else</span> {
03207         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03208         }
03209     <span class="comment">//</span>
03210     <span class="comment">// Compute Length of base dll name</span>
03211     <span class="comment">//</span>
03212 
03213     pp = UNICODE_NULL;
03214     p = FullDllName-&gt;Buffer;
03215     <span class="keywordflow">while</span> (*p) {
03216         <span class="keywordflow">if</span> (*p++ == (WCHAR)<span class="charliteral">'\\'</span>) {
03217             pp = p;
03218         }
03219     }
03220 
03221     p = pp ? pp : DllName;
03222     pp = p;
03223 
03224     <span class="keywordflow">while</span> (*p) {
03225         ++p;
03226     }
03227 
03228     BaseDllName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)p - (ULONG_PTR)pp);
03229     BaseDllName-&gt;MaximumLength = BaseDllName-&gt;Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
03230     BaseDllName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a13">LDR_TAG</a> ), BaseDllName-&gt;MaximumLength);
03231     <span class="keywordflow">if</span> ( BaseDllName-&gt;Buffer ) {
03232         RtlMoveMemory(BaseDllName-&gt;Buffer,
03233                        pp,
03234                        BaseDllName-&gt;Length
03235                      );
03236 
03237         BaseDllName-&gt;Buffer[BaseDllName-&gt;Length &gt;&gt; 1] = UNICODE_NULL;
03238         }
03239     <span class="keywordflow">else</span> {
03240         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, FullBuffer);
03241         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03242         }
03243 
03244     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03245 }
03246 
03247 
03248 PVOID
<a name="l03249"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">03249</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a> (
03250     IN PVOID Base
03251     )
03252 
03253 <span class="comment">/*++</span>
03254 <span class="comment"></span>
03255 <span class="comment">Routine Description:</span>
03256 <span class="comment"></span>
03257 <span class="comment">    This function returns the address of the initialization routine.</span>
03258 <span class="comment"></span>
03259 <span class="comment">Arguments:</span>
03260 <span class="comment"></span>
03261 <span class="comment">    Base - Base of image.</span>
03262 <span class="comment"></span>
03263 <span class="comment">Return Value:</span>
03264 <span class="comment"></span>
03265 <span class="comment">    Status value</span>
03266 <span class="comment"></span>
03267 <span class="comment">--*/</span>
03268 
03269 {
03270     PIMAGE_NT_HEADERS NtHeaders;
03271     ULONG_PTR ep;
03272 
03273     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
03274     ep = NtHeaders-&gt;OptionalHeader.AddressOfEntryPoint;
03275     <span class="keywordflow">if</span> (ep) {
03276         ep += (ULONG_PTR)Base;
03277     }
03278 
03279     <span class="keywordflow">return</span> (PVOID)ep;
03280 }
03281 
03282 HANDLE
<a name="l03283"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a56">03283</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a56">LdrpCheckForKnownDll</a> (
03284     IN PWSTR DllName,
03285     OUT PUNICODE_STRING FullDllName,
03286     OUT PUNICODE_STRING BaseDllName
03287     )
03288 
03289 <span class="comment">/*++</span>
03290 <span class="comment"></span>
03291 <span class="comment">Routine Description:</span>
03292 <span class="comment"></span>
03293 <span class="comment">    This function checks to see if the specified DLL is a known DLL.</span>
03294 <span class="comment">    It assumes it is only called for static DLL's, and when</span>
03295 <span class="comment">    the know DLL directory structure has been set up.</span>
03296 <span class="comment"></span>
03297 <span class="comment">Arguments:</span>
03298 <span class="comment"></span>
03299 <span class="comment">    DllName - Supplies the name of the DLL.</span>
03300 <span class="comment"></span>
03301 <span class="comment">    FullDllName - Returns the fully qualified pathname of the</span>
03302 <span class="comment">        DLL. The Buffer field of this string is dynamically</span>
03303 <span class="comment">        allocated from the processes heap.</span>
03304 <span class="comment"></span>
03305 <span class="comment">    BaseDLLName - Returns the base dll name of the dll.  The base name</span>
03306 <span class="comment">        is the file name portion of the dll path without the trailing</span>
03307 <span class="comment">        extension. The Buffer field of this string is dynamically</span>
03308 <span class="comment">        allocated from the processes heap.</span>
03309 <span class="comment"></span>
03310 <span class="comment">Return Value:</span>
03311 <span class="comment"></span>
03312 <span class="comment">    NON-NULL - Returns an open handle to the section associated with</span>
03313 <span class="comment">        the DLL.</span>
03314 <span class="comment"></span>
03315 <span class="comment">    NULL - The DLL is not known.</span>
03316 <span class="comment"></span>
03317 <span class="comment">--*/</span>
03318 
03319 {
03320 
03321     UNICODE_STRING <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>;
03322     HANDLE Section;
03323     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03324     OBJECT_ATTRIBUTES Obja;
03325     PSZ p;
03326     PWSTR pw;
03327 
03328     Section = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03329 
03330     <span class="comment">//</span>
03331     <span class="comment">// calculate base name</span>
03332     <span class="comment">//</span>
03333 
03334     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>,DllName);
03335 
03336 
03337     BaseDllName-&gt;Length = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Length;
03338     BaseDllName-&gt;MaximumLength = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.MaximumLength;
03339     BaseDllName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
03340                             RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a13">LDR_TAG</a> ),
03341                             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.MaximumLength
03342                             );
03343     <span class="keywordflow">if</span> ( !BaseDllName-&gt;Buffer ) {
03344         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03345         }
03346 
03347     RtlMoveMemory(BaseDllName-&gt;Buffer,<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Buffer,<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.MaximumLength);
03348 
03349     <span class="comment">//</span>
03350     <span class="comment">// now compute the full name for the dll</span>
03351     <span class="comment">//</span>
03352 
03353     FullDllName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length +  <span class="comment">// path prefix</span>
03354                                    (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(WCHAR)   +  <span class="comment">// seperator</span>
03355                                    BaseDllName-&gt;Length        <span class="comment">// base</span>
03356                                   );
03357 
03358     FullDllName-&gt;MaximumLength = FullDllName-&gt;Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
03359     FullDllName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
03360                             RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a13">LDR_TAG</a> ),
03361                             FullDllName-&gt;MaximumLength
03362                             );
03363     <span class="keywordflow">if</span> ( !FullDllName-&gt;Buffer ) {
03364         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,BaseDllName-&gt;Buffer);
03365         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03366         }
03367 
03368     p = (PSZ)FullDllName-&gt;Buffer;
03369     RtlMoveMemory(p,<a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Buffer,<a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length);
03370     p += <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length;
03371     pw = (PWSTR)p;
03372     *pw++ = (WCHAR)<span class="charliteral">'\\'</span>;
03373     p = (PSZ)pw;
03374 
03375     <span class="comment">//</span>
03376     <span class="comment">// This is the relative name of the section</span>
03377     <span class="comment">//</span>
03378 
03379     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Buffer = (PWSTR)p;
03380     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Length = BaseDllName-&gt;Length;       <span class="comment">// base</span>
03381     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.MaximumLength = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
03382 
03383     RtlMoveMemory(p,BaseDllName-&gt;Buffer,BaseDllName-&gt;MaximumLength);
03384 
03385     <span class="comment">//</span>
03386     <span class="comment">// open the section object</span>
03387     <span class="comment">//</span>
03388 
03389     InitializeObjectAttributes(
03390         &amp;Obja,
03391         &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>,
03392         OBJ_CASE_INSENSITIVE,
03393         <a class="code" href="../../d9/d2/ldrp_8h.html#a23">LdrpKnownDllObjectDirectory</a>,
03394         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03395         );
03396 
03397     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a24">NtOpenSection</a>(
03398             &amp;Section,
03399             SECTION_MAP_READ | SECTION_MAP_EXECUTE | SECTION_MAP_WRITE,
03400             &amp;Obja
03401             );
03402 
03403     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
03404         Section = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03405         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,BaseDllName-&gt;Buffer);
03406         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,FullDllName-&gt;Buffer);
03407         }
03408 <span class="preprocessor">#if DBG</span>
03409 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
03410         LdrpSectionOpens++;
03411         }
03412 <span class="preprocessor">#endif // DBG</span>
03413 <span class="preprocessor"></span>    <span class="keywordflow">return</span> Section;
03414 }
03415 
03416 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03417"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">03417</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a> (
03418     IN PVOID Base,
03419     IN BOOLEAN Reset,
03420     IN BOOLEAN StaticLink
03421     )
03422 
03423 <span class="comment">/*++</span>
03424 <span class="comment"></span>
03425 <span class="comment">Routine Description:</span>
03426 <span class="comment"></span>
03427 <span class="comment">    This function loops thru the images sections/objects, setting</span>
03428 <span class="comment">    all sections/objects marked r/o to r/w. It also resets the</span>
03429 <span class="comment">    original section/object protections.</span>
03430 <span class="comment"></span>
03431 <span class="comment">Arguments:</span>
03432 <span class="comment"></span>
03433 <span class="comment">    Base - Base of image.</span>
03434 <span class="comment"></span>
03435 <span class="comment">    Reset - If TRUE, reset section/object protection to original</span>
03436 <span class="comment">            protection described by the section/object headers.</span>
03437 <span class="comment">            If FALSE, then set all sections/objects to r/w.</span>
03438 <span class="comment"></span>
03439 <span class="comment">    StaticLink - TRUE if this is a static link.</span>
03440 <span class="comment"></span>
03441 <span class="comment">Return Value:</span>
03442 <span class="comment"></span>
03443 <span class="comment">    SUCCESS or reason NtProtectVirtualMemory failed.</span>
03444 <span class="comment"></span>
03445 <span class="comment">--*/</span>
03446 
03447 {
03448     HANDLE CurrentProcessHandle;
03449     SIZE_T RegionSize;
03450     ULONG NewProtect, OldProtect;
03451     PVOID VirtualAddress;
03452     ULONG i;
03453     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
03454     PIMAGE_NT_HEADERS NtHeaders;
03455     PIMAGE_SECTION_HEADER SectionHeader;
03456     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
03457 
03458     CurrentProcessHandle = NtCurrentProcess();
03459 
03460     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
03461 
03462 <span class="preprocessor">#if defined (_ALPHA_)</span>
03463 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
03464         <span class="comment">//</span>
03465         <span class="comment">// if SectionAlignment &lt; PAGE_SIZE the entire image is</span>
03466         <span class="comment">// exec-copy on write, so we have nothing to do.</span>
03467         <span class="comment">//</span>
03468         <span class="keywordflow">return</span> STATUS_SUCCESS;
03469         }
03470 <span class="preprocessor">#endif</span>
03471 <span class="preprocessor"></span>
03472     SectionHeader = (PIMAGE_SECTION_HEADER)((ULONG_PTR)NtHeaders + <span class="keyword">sizeof</span>(ULONG) +
03473                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
03474                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
03475                         );
03476 
03477     <span class="keywordflow">for</span> (i=0; i&lt;NtHeaders-&gt;FileHeader.NumberOfSections; i++) {
03478         <span class="keywordflow">if</span> (!(SectionHeader-&gt;Characteristics &amp; IMAGE_SCN_MEM_WRITE) &amp;&amp;
03479              (SectionHeader-&gt;SizeOfRawData))
03480          {
03481             <span class="comment">//</span>
03482             <span class="comment">// Object isn't writeable and has a non-zero on disk size, change it.</span>
03483             <span class="comment">//</span>
03484             <span class="keywordflow">if</span> (Reset) {
03485                 <span class="keywordflow">if</span> (SectionHeader-&gt;Characteristics &amp; IMAGE_SCN_MEM_EXECUTE) {
03486                     NewProtect = PAGE_EXECUTE;
03487                 } <span class="keywordflow">else</span> {
03488                          NewProtect = PAGE_READONLY;
03489                 }
03490                 NewProtect |= (SectionHeader-&gt;Characteristics &amp; IMAGE_SCN_MEM_NOT_CACHED) ? PAGE_NOCACHE : 0;
03491             } <span class="keywordflow">else</span> {
03492                 NewProtect = PAGE_READWRITE;
03493             }
03494             VirtualAddress = (PVOID)((ULONG_PTR)Base + SectionHeader-&gt;VirtualAddress);
03495             RegionSize = SectionHeader-&gt;SizeOfRawData;
03496 
03497             <span class="keywordflow">if</span> (RegionSize != 0) {
03498                 st = <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>(CurrentProcessHandle, &amp;VirtualAddress,
03499                               &amp;RegionSize, NewProtect, &amp;OldProtect);
03500 
03501                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
03502                     <span class="keywordflow">return</span> st;
03503                 }
03504             }
03505 
03506         }
03507         ++SectionHeader;
03508     }
03509 
03510     <span class="keywordflow">if</span> (Reset) {
03511         <a class="code" href="../../d5/d5/flushbuf_8c.html#a2">NtFlushInstructionCache</a>(NtCurrentProcess(), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
03512     }
03513     <span class="keywordflow">return</span> STATUS_SUCCESS;
03514 }
03515 
03519 
<a name="l03520"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a24">03520</a> BOOLEAN <a class="code" href="../../d2/d3/ldrsnap_8c.html#a24">LdrpDphKernel32Snapped</a>;
<a name="l03521"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a25">03521</a> BOOLEAN <a class="code" href="../../d2/d3/ldrsnap_8c.html#a25">LdrpDphMsvcrtSnapped</a>;
03522 
<a name="l03523"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a1">03523</a> <span class="preprocessor">#define SNAP_ROUTINE_GLOBALALLOC     0</span>
<a name="l03524"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a2">03524</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_GLOBALREALLOC   1</span>
<a name="l03525"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a3">03525</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_GLOBALFREE      2</span>
<a name="l03526"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a4">03526</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_LOCALALLOC      3</span>
<a name="l03527"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a5">03527</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_LOCALREALLOC    4</span>
<a name="l03528"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a6">03528</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_LOCALFREE       5</span>
<a name="l03529"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a7">03529</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_HEAPALLOC       6</span>
<a name="l03530"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a8">03530</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_HEAPREALLOC     7</span>
<a name="l03531"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a9">03531</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_HEAPFREE        8</span>
<a name="l03532"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a10">03532</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_HEAPCREATE      9</span>
<a name="l03533"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a11">03533</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_MALLOC          10</span>
<a name="l03534"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a12">03534</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_CALLOC          11</span>
<a name="l03535"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a13">03535</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_REALLOC         12</span>
<a name="l03536"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a14">03536</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_FREE            13</span>
<a name="l03537"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a15">03537</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_NEW             14</span>
<a name="l03538"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a16">03538</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_DELETE          15</span>
<a name="l03539"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a17">03539</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_NEW_ARRAY       16</span>
<a name="l03540"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a18">03540</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_DELETE_ARRAY    17</span>
<a name="l03541"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a19">03541</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAP_ROUTINE_MAX_INDEX       18</span>
03542 <span class="preprocessor"></span>
<a name="l03543"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">03543</a> PVOID <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a> [<a class="code" href="../../d2/d3/ldrsnap_8c.html#a19">SNAP_ROUTINE_MAX_INDEX</a>];
03544 
<a name="l03545"></a><a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html">03545</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html">_DPH_SNAP_NAME</a> {
03546 
<a name="l03547"></a><a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html#o0">03547</a>     PSTR <a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html#o0">Name</a>;
<a name="l03548"></a><a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html#o1">03548</a>     ULONG <a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html#o1">Index</a>;
03549 
03550 } <a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html">DPH_SNAP_NAME</a>, * <a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html">PDPH_SNAP_NAME</a>;
03551 
03552 <a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html">DPH_SNAP_NAME</a> 
<a name="l03553"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a29">03553</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a29">LdrpDphSnapNamesForKernel32</a> [] = {
03554 
03555     { <span class="stringliteral">"GlobalAlloc"</span>,   0 },
03556     { <span class="stringliteral">"GlobalReAlloc"</span>, 1 },
03557     { <span class="stringliteral">"GlobalFree"</span>,    2 },
03558     { <span class="stringliteral">"LocalAlloc"</span>,    3 },
03559     { <span class="stringliteral">"LocalReAlloc"</span>,  4 },
03560     { <span class="stringliteral">"LocalFree"</span>,     5 },
03561     { <span class="stringliteral">"HeapAlloc"</span>,     6 },
03562     { <span class="stringliteral">"HeapReAlloc"</span>,   7 },
03563     { <span class="stringliteral">"HeapFree"</span>,      8 },
03564     { <span class="stringliteral">"HeapCreate"</span>,    9 }, 
03565     { <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0 }
03566 };
03567 
03568 <a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html">DPH_SNAP_NAME</a> 
<a name="l03569"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a30">03569</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a30">LdrpDphSnapNamesForMsvcrt</a> [] = {
03570 
03571     { <span class="stringliteral">"malloc"</span>,        10},
03572     { <span class="stringliteral">"calloc"</span>,        11},
03573     { <span class="stringliteral">"realloc"</span>,       12},
03574     { <span class="stringliteral">"free"</span>,          13},
03575     { <span class="stringliteral">"??2@YAPAXI@Z"</span>,  14}, <span class="comment">// operator new</span>
03576     { <span class="stringliteral">"??3@YAXPAX@Z"</span>,  15}, <span class="comment">// operator delete</span>
03577     { <span class="stringliteral">"??_U@YAPAXI@Z"</span>, 16}, <span class="comment">// operator new[]</span>
03578     { <span class="stringliteral">"??_V@YAXPAX@Z"</span>, 17}, <span class="comment">// operator delete[]</span>
03579     { <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0 }
03580 };
03581 
03582 <span class="comment">//</span>
03583 <span class="comment">// Declarations for replacement functions</span>
03584 <span class="comment">//</span>
03585 
03586 PVOID
03587 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a58">RtlpDphDllHeapAlloc</a> (
03588     IN PVOID  HeapHandle,
03589     IN ULONG  Flags,
03590     IN SIZE_T Size
03591     );
03592 
03593 PVOID
03594 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a59">RtlpDphDllHeapReAlloc</a> (
03595     IN PVOID  HeapHandle,
03596     IN ULONG  Flags,
03597     IN PVOID Address,
03598     IN SIZE_T Size
03599     );
03600 
03601 BOOLEAN
03602 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a60">RtlpDphDllHeapFree</a>(
03603     IN PVOID HeapHandle,
03604     IN ULONG Flags,
03605     IN PVOID Address
03606     );
03607 
03608 PVOID
03609 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a61">RtlpDphDllLocalAlloc</a> (
03610     IN ULONG  Flags,
03611     IN SIZE_T Size
03612     );
03613 
03614 PVOID
03615 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a62">RtlpDphDllLocalReAlloc</a> (
03616     IN PVOID Address,
03617     IN SIZE_T Size,
03618     IN ULONG  Flags
03619     );
03620 
03621 PVOID
03622 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a63">RtlpDphDllLocalFree</a>(
03623     IN PVOID Address
03624     );
03625 
03626 PVOID
03627 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a64">RtlpDphDllGlobalAlloc</a> (
03628     IN ULONG  Flags,
03629     IN SIZE_T Size
03630     );
03631 
03632 PVOID
03633 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a65">RtlpDphDllGlobalReAlloc</a> (
03634     IN PVOID Address,
03635     IN SIZE_T Size,
03636     IN ULONG  Flags
03637     );
03638 
03639 PVOID
03640 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a66">RtlpDphDllGlobalFree</a>(
03641     IN PVOID Address
03642     );
03643 
03644 PVOID __cdecl
03645 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a67">RtlpDphDllmalloc</a> (
03646     IN SIZE_T Size
03647     );
03648 
03649 PVOID __cdecl
03650 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a68">RtlpDphDllcalloc</a> (
03651     IN SIZE_T Number,
03652     IN SIZE_T Size
03653     );
03654 
03655 PVOID __cdecl
03656 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a69">RtlpDphDllrealloc</a> (
03657     IN PVOID Address,
03658     IN SIZE_T Size
03659     );
03660 
03661 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> __cdecl
03662 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a70">RtlpDphDllfree</a> (
03663     IN PVOID Address
03664     );
03665 
03666 PVOID __cdecl
03667 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a71">RtlpDphDllNew</a> (
03668     IN SIZE_T Size
03669     );
03670 
03671 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> __cdecl
03672 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a72">RtlpDphDllDelete</a> (
03673     IN PVOID Address
03674     );
03675 
03676 PVOID __cdecl
03677 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a73">RtlpDphDllNewArray</a> (
03678     IN SIZE_T Size
03679     );
03680 
03681 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> __cdecl
03682 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a74">RtlpDphDllDeleteArray</a> (
03683     IN PVOID Address
03684     );
03685 
03686 <span class="comment">//</span>
03687 <span class="comment">// Replacement function for msvcrt HeapCreate used to intercept</span>
03688 <span class="comment">// the CRT heap creation.</span>
03689 <span class="comment">//</span>
03690 
03691 PVOID
03692 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a75">RtlpDphDllHeapCreate</a> (
03693     ULONG Options,
03694     SIZE_T InitialSize,
03695     SIZE_T MaximumSize
03696     );
03697 
03698 <span class="comment">//</span>
03699 <span class="comment">// Address of heap created by msvcrt. This is needed</span>
03700 <span class="comment">// by the replacements of malloc/free etc.</span>
03701 <span class="comment">//</span>
03702 
<a name="l03703"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">03703</a> PVOID <a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>;
03704 
03705 <span class="comment">//</span>
03706 <span class="comment">// Snap implementation</span>
03707 <span class="comment">//</span>
03708 
03709 BOOLEAN
<a name="l03710"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a76">03710</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a76">LdrpDphDetectSnapRoutines</a> (
03711     PWSTR DllString,
03712     PDPH_SNAP_NAME SnapNames
03713     )
03714 {
03715     PLDR_DATA_TABLE_ENTRY DllData;
03716     PIMAGE_EXPORT_DIRECTORY <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
03717     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03718     PCHAR NameAddress;
03719     PCHAR FunctionAddress;
03720     PCHAR Base;
03721     PCHAR IndexAddress;
03722     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03723     ULONG RealIndex;
03724     BOOLEAN Result;
03725     UNICODE_STRING DllName;
03726     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a28">PDPH_SNAP_NAME</a> CurrentSnapName;
03727 
03728     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (
03729         &amp;DllName, 
03730         DllString);
03731 
03732     Result = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a> (
03733         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03734         &amp;DllName,
03735         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03736         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03737         &amp;DllData);
03738 
03739     <span class="keywordflow">if</span> (Result == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03740         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03741     }
03742 
03743     Base = DllData-&gt;DllBase;
03744 
03745     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a> (
03746         DllData-&gt;DllBase,
03747         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03748         IMAGE_DIRECTORY_ENTRY_EXPORT,    
03749         &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
03750         );
03751 
03752     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03753         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03754     }
03755 
03756     <span class="keywordflow">for</span> (CurrentSnapName = SnapNames; CurrentSnapName-&gt;<a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html#o0">Name</a>; CurrentSnapName += 1) {
03757 
03758         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;NumberOfFunctions; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
03759 
03760             NameAddress = Base + <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;AddressOfNames;
03761             NameAddress = Base + ((ULONG *)NameAddress)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
03762 
03763             IndexAddress = Base + <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;AddressOfNameOrdinals;
03764             RealIndex = (ULONG)(((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *)IndexAddress)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
03765 
03766             <span class="keywordflow">if</span> (_stricmp (NameAddress, CurrentSnapName-&gt;<a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html#o0">Name</a>) == 0) {
03767 
03768                 FunctionAddress = Base + <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;AddressOfFunctions;
03769                 FunctionAddress = Base + ((ULONG *)FunctionAddress)[RealIndex];
03770 
03771                 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[CurrentSnapName-&gt;<a class="code" href="../../d7/d8/struct__DPH__SNAP__NAME.html#o1">Index</a>] = FunctionAddress;
03772                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Page heap: found %s @ address %p \n"</span>, NameAddress, FunctionAddress);
03773             }
03774         }
03775     }
03776 
03777     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03778 }
03779 
03780 BOOLEAN
<a name="l03781"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a77">03781</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a77">LdrpDphSnapImports</a> (
03782     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry,
03783     BOOLEAN CallToDetectCrtHeap
03784     )
03785 {
03786     PVOID IATBase;
03787     SIZE_T BigIATSize;
03788     ULONG  LittleIATSize;
03789     PVOID *ProcAddresses;
03790     ULONG NumberOfProcAddresses;
03791     ULONG OldProtect;
03792     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
03793     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
03794 
03795     <span class="comment">//</span>
03796     <span class="comment">// Determine the location and size of the IAT.  If found, scan the</span>
03797     <span class="comment">// IAT address to see if any are pointing to alloc/free functions</span>
03798     <span class="comment">// and replace those thunks.</span>
03799     <span class="comment">//</span>
03800 
03801     IATBase = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
03802         LdrDataTableEntry-&gt;DllBase,
03803         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03804         IMAGE_DIRECTORY_ENTRY_IAT,
03805         &amp;LittleIATSize);
03806 
03807     BigIATSize = LittleIATSize;
03808 
03809     <span class="keywordflow">if</span> (IATBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03810         st = <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>(
03811             NtCurrentProcess(),
03812             &amp;IATBase,
03813             &amp;BigIATSize,
03814             PAGE_READWRITE,
03815             &amp;OldProtect);
03816 
03817         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
03818             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Unable to unprotect IAT to enable per DLL page heap.\n"</span> );
03819             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03820         }
03821         <span class="keywordflow">else</span> {
03822             ProcAddresses = (PVOID *)IATBase;
03823             NumberOfProcAddresses = (ULONG)(BigIATSize / <span class="keyword">sizeof</span>(PVOID));
03824             <span class="keywordflow">while</span> (NumberOfProcAddresses--) {
03825 
03826                 <span class="keywordflow">if</span> (CallToDetectCrtHeap) {
03827                     <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a10">SNAP_ROUTINE_HEAPCREATE</a>]) {
03828                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a75">RtlpDphDllHeapCreate</a>;
03829                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) HeapCreate ... \n"</span>,
03830                             LdrDataTableEntry-&gt;BaseDllName.Buffer);
03831                     }
03832                 }
03833                 <span class="keywordflow">else</span> {
03834 
03835                     <span class="comment">//</span>
03836                     <span class="comment">// ntdll imports</span>
03837                     <span class="comment">//</span>
03838 
03839                     <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>) {
03840                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a58">RtlpDphDllHeapAlloc</a>;
03841                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) RtlAllocateHeap ... \n"</span>,
03842                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03843                     }
03844                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d5/d9/heapdll_8c.html#a24">RtlReAllocateHeap</a>) {
03845                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a59">RtlpDphDllHeapReAlloc</a>;
03846                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) RtlReAllocateHeap ... \n"</span>,
03847                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03848                     }
03849                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>) {
03850                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a60">RtlpDphDllHeapFree</a>;
03851                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) RtlFreeHeap ... \n"</span>,
03852                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03853                     }
03854 
03855                     <span class="comment">//</span>
03856                     <span class="comment">// kernel32 imports</span>
03857                     <span class="comment">//</span>
03858 
03859                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a7">SNAP_ROUTINE_HEAPALLOC</a>]) {
03860                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a58">RtlpDphDllHeapAlloc</a>;
03861                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) HeapAlloc ... \n"</span>,
03862                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03863                     }
03864                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a8">SNAP_ROUTINE_HEAPREALLOC</a>]) {
03865                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a59">RtlpDphDllHeapReAlloc</a>;
03866                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) HeapReAlloc ... \n"</span>,
03867                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03868                     }
03869                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a9">SNAP_ROUTINE_HEAPFREE</a>]) {
03870                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a60">RtlpDphDllHeapFree</a>;
03871                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) HeapFree ... \n"</span>,
03872                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03873                     }
03874 
03875                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a4">SNAP_ROUTINE_LOCALALLOC</a>]) {
03876                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a61">RtlpDphDllLocalAlloc</a>;
03877                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) LocalAlloc ... \n"</span>,
03878                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03879                     }
03880                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a5">SNAP_ROUTINE_LOCALREALLOC</a>]) {
03881                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a62">RtlpDphDllLocalReAlloc</a>;
03882                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) LocalReAlloc ... \n"</span>,
03883                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03884                     }
03885                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a6">SNAP_ROUTINE_LOCALFREE</a>]) {
03886                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a63">RtlpDphDllLocalFree</a>;
03887                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) LocalFree ... \n"</span>,
03888                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03889                     }
03890 
03891                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a1">SNAP_ROUTINE_GLOBALALLOC</a>]) {
03892                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a64">RtlpDphDllGlobalAlloc</a>;
03893                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) GlobalAlloc ... \n"</span>,
03894                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03895                     }
03896                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a2">SNAP_ROUTINE_GLOBALREALLOC</a>]) {
03897                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a65">RtlpDphDllGlobalReAlloc</a>;
03898                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) GlobalReAlloc ... \n"</span>,
03899                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03900                     }
03901                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a3">SNAP_ROUTINE_GLOBALFREE</a>]) {
03902                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a66">RtlpDphDllGlobalFree</a>;
03903                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) GlobalFree ... \n"</span>,
03904                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03905                     }
03906 
03907                     <span class="comment">//</span>
03908                     <span class="comment">// msvcrt imports</span>
03909                     <span class="comment">//</span>
03910 
03911                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a11">SNAP_ROUTINE_MALLOC</a>]) {
03912                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a67">RtlpDphDllmalloc</a>;
03913                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) malloc ... \n"</span>,
03914                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03915                     }
03916                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a13">SNAP_ROUTINE_REALLOC</a>]) {
03917                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a69">RtlpDphDllrealloc</a>;
03918                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) realloc ... \n"</span>,
03919                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03920                     }
03921                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a12">SNAP_ROUTINE_CALLOC</a>]) {
03922                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a68">RtlpDphDllcalloc</a>;
03923                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) calloc ... \n"</span>,
03924                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03925                     }
03926                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a14">SNAP_ROUTINE_FREE</a>]) {
03927                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a70">RtlpDphDllfree</a>;
03928                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) free ... \n"</span>,
03929                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03930                     }
03931 
03932                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a15">SNAP_ROUTINE_NEW</a>]) {
03933                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a71">RtlpDphDllNew</a>;
03934                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) operator new ... \n"</span>,
03935                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03936                     }
03937                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a16">SNAP_ROUTINE_DELETE</a>]) {
03938                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a72">RtlpDphDllDelete</a>;
03939                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) operator delete ... \n"</span>,
03940                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03941                     }
03942                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a17">SNAP_ROUTINE_NEW_ARRAY</a>]) {
03943                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a73">RtlpDphDllNewArray</a>;
03944                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) operator new[] ... \n"</span>,
03945                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03946                     }
03947                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a18">SNAP_ROUTINE_DELETE_ARRAY</a>]) {
03948                         *ProcAddresses = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a74">RtlpDphDllDeleteArray</a>;
03949                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Snapped (%ws) operator delete[] ... \n"</span>,
03950                                   LdrDataTableEntry-&gt;BaseDllName.Buffer);
03951                     }
03952                 }
03953                 
03954                 ProcAddresses += 1;
03955             }
03956 
03957             <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>(
03958                 NtCurrentProcess(),
03959                 &amp;IATBase,
03960                 &amp;BigIATSize,
03961                 OldProtect,
03962                 &amp;OldProtect);
03963         }
03964     }
03965 
03966     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03967 }
03968 
03969 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03970"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a40">03970</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a40">LdrpDphInitializeTargetDll</a> (
03971     PLDR_DATA_TABLE_ENTRY LoadedDllData
03972     )
03973 {
03974     BOOLEAN Kernel32JustSnapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03975     BOOLEAN MsvcrtJustSnapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03976 
03977     <span class="comment">//</span>
03978     <span class="comment">// If we do not have per dll page heap feature enabled</span>
03979     <span class="comment">// we return immediately.</span>
03980     <span class="comment">//</span>
03981 
03982     <span class="keywordflow">if</span> (! (<a class="code" href="../../d6/d9/heappage_8c.html#a43">RtlpDphGlobalFlags</a> &amp; PAGE_HEAP_USE_DLL_NAMES)) {
03983         <span class="keywordflow">return</span>;
03984     }
03985 
03986     <span class="keywordflow">if</span> (! <a class="code" href="../../d2/d3/ldrsnap_8c.html#a24">LdrpDphKernel32Snapped</a>) {
03987 
03988         Kernel32JustSnapped = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a76">LdrpDphDetectSnapRoutines</a> (
03989             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kernel32.dll"</span>,
03990             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a29">LdrpDphSnapNamesForKernel32</a>);
03991 
03992         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a24">LdrpDphKernel32Snapped</a> = Kernel32JustSnapped;
03993     }
03994 
03995     <span class="keywordflow">if</span> (! <a class="code" href="../../d2/d3/ldrsnap_8c.html#a25">LdrpDphMsvcrtSnapped</a>) {
03996 
03997         MsvcrtJustSnapped = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a76">LdrpDphDetectSnapRoutines</a> (
03998             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"msvcrt.dll"</span>,
03999             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a30">LdrpDphSnapNamesForMsvcrt</a>);
04000 
04001         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a25">LdrpDphMsvcrtSnapped</a> = MsvcrtJustSnapped;
04002     }
04003 
04004     <span class="comment">//</span>
04005     <span class="comment">// Snap everything already loaded if we just managed</span>
04006     <span class="comment">// to detect snap routines.</span>
04007     <span class="comment">//</span>
04008     
04009     <span class="keywordflow">if</span> (Kernel32JustSnapped || MsvcrtJustSnapped) {
04010         
04011         PWSTR Current;
04012         PWSTR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
04013         WCHAR SavedChar;
04014         PLDR_DATA_TABLE_ENTRY DllData;
04015         BOOLEAN Result;
04016         UNICODE_STRING DllName;
04017 
04018         Current = <a class="code" href="../../d6/d9/heappage_8c.html#a49">RtlpDphTargetDlls</a>;
04019         
04020         <span class="keywordflow">while</span> (*Current) {
04021 
04022             <span class="keywordflow">while</span> (*Current == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>) {
04023                 Current += 1;
04024             }
04025 
04026             <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = Current;
04027 
04028             <span class="keywordflow">while</span> (*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &amp;&amp; *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>) {
04029                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> += 1;
04030             }
04031 
04032             <span class="keywordflow">if</span> (*Current == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
04033                 <span class="keywordflow">break</span>;
04034             }
04035 
04036             SavedChar = *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
04037             *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04038 
04039             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (
04040                 &amp;DllName, 
04041                 Current);
04042 
04043             Result = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a> (
04044                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04045                 &amp;DllName,
04046                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04047                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04048                 &amp;DllData);
04049 
04050             <span class="keywordflow">if</span> (Result) {
04051 
04052                 <span class="keywordflow">if</span> (DllData-&gt;DllBase == LoadedDllData-&gt;DllBase) {
04053 <span class="preprocessor">#if DBG</span>
04054 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Page heap: oversnapping %ws \n"</span>, DllData-&gt;BaseDllName);
04055 <span class="preprocessor">#endif</span>
04056 <span class="preprocessor"></span>                }
04057 
04058                 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a77">LdrpDphSnapImports</a> (DllData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04059             }
04060 
04061             *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = SavedChar;
04062             Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
04063         }
04064     }
04065 
04066     <span class="comment">//</span>
04067     <span class="comment">// If we just loaded msvcrt.dll we need to redirect HeapCreate call</span>
04068     <span class="comment">// in order to detect when the CRT heap gets created.</span>
04069     <span class="comment">//</span>
04070 
04071     <span class="keywordflow">if</span> (_wcsicmp (LoadedDllData-&gt;BaseDllName.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"msvcrt.dll"</span>) == 0) {
04072 
04073         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a77">LdrpDphSnapImports</a> (LoadedDllData, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04074     }
04075 
04076     <span class="comment">//</span>
04077     <span class="comment">// Call back into page heap manager to figure out if the</span>
04078     <span class="comment">// currently loaded dll is a target for page heap.</span>
04079     <span class="comment">//</span>
04080     
04081     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/heappage_8c.html#a105">RtlpDphIsDllTargeted</a> (LoadedDllData-&gt;BaseDllName.Buffer)) {
04082         
04083         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a77">LdrpDphSnapImports</a> (LoadedDllData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04084     }
04085 }
04086 
04090 
04091 <span class="comment">//</span>
04092 <span class="comment">// A biased heap pointer signals to the page heap manager that</span>
04093 <span class="comment">// this allocation needs to get into page heap (not normal heap).</span>
04094 <span class="comment">// This needs to happen only for allocation function (not free, delete).</span>
04095 <span class="comment">//</span>
04096 
<a name="l04097"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">04097</a> <span class="preprocessor">#define BIAS_POINTER(p) ((PVOID)((ULONG_PTR)(p) | 0x01))</span>
04098 <span class="preprocessor"></span>
04099 PVOID
<a name="l04100"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a58">04100</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a58">RtlpDphDllHeapAlloc</a> (
04101     IN PVOID  HeapHandle,
04102     IN ULONG  Flags,
04103     IN SIZE_T Size
04104     )
04105 {
04106     <span class="keywordflow">return</span> <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (
04107         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>),
04108         Flags,
04109         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04110 }
04111 
04112 PVOID
<a name="l04113"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a59">04113</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a59">RtlpDphDllHeapReAlloc</a> (
04114     IN PVOID  HeapHandle,
04115     IN ULONG  Flags,
04116     IN PVOID Address,
04117     IN SIZE_T Size
04118     )
04119 {
04120     <span class="keywordflow">return</span> <a class="code" href="../../d7/d9/heappage_8h.html#a12">RtlpDebugPageHeapReAllocate</a> (
04121         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>),
04122         Flags,
04123         Address,
04124         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04125 }
04126 
04127 BOOLEAN
<a name="l04128"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a60">04128</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a60">RtlpDphDllHeapFree</a>(
04129     IN PVOID HeapHandle,
04130     IN ULONG Flags,
04131     IN PVOID Address
04132     )
04133 {
04134     <span class="keywordflow">return</span> <a class="code" href="../../d7/d9/heappage_8h.html#a11">RtlpDebugPageHeapFree</a> (
04135         <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
04136         Flags,
04137         Address);
04138 }
04139 
04140 <span class="comment">//</span>
04141 <span class="comment">// LocalAlloc, LocalReAlloc, LocalFree</span>
04142 <span class="comment">// GlobalAlloc, GlobalReAlloc, GlobalFree</span>
04143 <span class="comment">//</span>
04144 <span class="comment">// The following macros are copied from sdk\inc\winbase.h</span>
04145 <span class="comment">// There is very low probability that anybody will ever change</span>
04146 <span class="comment">// these values for application compatibility reasons.</span>
04147 <span class="comment">// </span>
04148 
<a name="l04149"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">04149</a> <span class="preprocessor">#define LMEM_MOVEABLE       0x0002</span>
<a name="l04150"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a22">04150</a> <span class="preprocessor"></span><span class="preprocessor">#define LMEM_ZEROINIT       0x0040</span>
04151 <span class="preprocessor"></span>
04152 <span class="preprocessor">#if defined(_IA64_) || defined(_AXP64_)</span>
04153 <span class="preprocessor"></span><span class="preprocessor">#define BASE_HANDLE_MARK_BIT 0x08</span>
04154 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l04155"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a23">04155</a> <span class="preprocessor"></span><span class="preprocessor">#define BASE_HANDLE_MARK_BIT 0x04</span>
04156 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
04157 <span class="preprocessor"></span>
04158 <span class="keyword">typedef</span> PVOID
<a name="l04159"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a32">04159</a> (* FUN_LOCAL_ALLOC) (
04160     IN ULONG  Flags,
04161     IN SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
04162     );
04163 
04164 <span class="keyword">typedef</span> PVOID
<a name="l04165"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a33">04165</a> (* FUN_LOCAL_REALLOC) (
04166     IN PVOID Address,
04167     IN SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
04168     IN ULONG  Flags
04169     );
04170 
04171 <span class="keyword">typedef</span> PVOID
<a name="l04172"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a34">04172</a> (* FUN_LOCAL_FREE)(
04173     IN PVOID Address
04174     );
04175 
04176 <span class="keyword">typedef</span> PVOID
<a name="l04177"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a35">04177</a> (* FUN_GLOBAL_ALLOC) (
04178     IN ULONG  Flags,
04179     IN SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
04180     );
04181 
04182 <span class="keyword">typedef</span> PVOID
<a name="l04183"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a36">04183</a> (* FUN_GLOBAL_REALLOC) (
04184     IN PVOID Address,
04185     IN SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
04186     IN ULONG  Flags
04187     );
04188 
04189 <span class="keyword">typedef</span> PVOID
<a name="l04190"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a37">04190</a> (* FUN_GLOBAL_FREE)(
04191     IN PVOID Address
04192     );
04193 
04194 PVOID
<a name="l04195"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a61">04195</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a61">RtlpDphDllLocalAlloc</a> (
04196     IN ULONG  Flags,
04197     IN SIZE_T Size
04198     )
04199 {
04200     PVOID Block;
04201     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a32">FUN_LOCAL_ALLOC</a> Original;
04202 
04203     <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">LMEM_MOVEABLE</a>)) {
04204         
04205         Block = <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (
04206             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(RtlProcessHeap()),
04207             0,
04208             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04209 
04210         <span class="keywordflow">if</span> ((Flags &amp; <a class="code" href="../../d2/d3/ldrsnap_8c.html#a22">LMEM_ZEROINIT</a>)) {
04211             RtlZeroMemory (Block, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04212         }
04213         
04214         <span class="keywordflow">return</span> Block;
04215     }
04216     <span class="keywordflow">else</span> {
04217 
04218         Original = (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a32">FUN_LOCAL_ALLOC</a>)(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a4">SNAP_ROUTINE_LOCALALLOC</a>]);
04219         <span class="keywordflow">return</span> (* Original) (Flags, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04220     }
04221 }
04222 
04223 PVOID
<a name="l04224"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a62">04224</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a62">RtlpDphDllLocalReAlloc</a> (
04225     IN PVOID Address,
04226     IN SIZE_T Size,
04227     IN ULONG  Flags
04228     )
04229 {
04230     PVOID Block;
04231     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a33">FUN_LOCAL_REALLOC</a> Original;
04232 
04233     <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">LMEM_MOVEABLE</a>)) {
04234         
04235         Block = <a class="code" href="../../d7/d9/heappage_8h.html#a12">RtlpDebugPageHeapReAllocate</a> (
04236             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(RtlProcessHeap()),
04237             0,
04238             Address,
04239             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04240 
04241         <span class="keywordflow">return</span> Block;
04242     }
04243     <span class="keywordflow">else</span> {
04244 
04245         Original = (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a33">FUN_LOCAL_REALLOC</a>)(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a5">SNAP_ROUTINE_LOCALREALLOC</a>]);
04246         <span class="keywordflow">return</span> (* Original) (Address, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, Flags);
04247     }
04248 }
04249 
04250 PVOID
<a name="l04251"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a63">04251</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a63">RtlpDphDllLocalFree</a>(
04252     IN PVOID Address
04253     )
04254 {
04255     BOOLEAN Result;
04256     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a34">FUN_LOCAL_FREE</a> Original;
04257 
04258     <span class="keywordflow">if</span> ((ULONG_PTR)Address &amp; <a class="code" href="../../d2/d3/ldrsnap_8c.html#a23">BASE_HANDLE_MARK_BIT</a>) {
04259         
04260         Original = (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a34">FUN_LOCAL_FREE</a>)(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a6">SNAP_ROUTINE_LOCALFREE</a>]);
04261         <span class="keywordflow">return</span> (* Original) (Address);
04262     }
04263     <span class="keywordflow">else</span> {
04264 
04265         Result = <a class="code" href="../../d7/d9/heappage_8h.html#a11">RtlpDebugPageHeapFree</a> (
04266             RtlProcessHeap(),
04267             0,
04268             Address);
04269 
04270         <span class="keywordflow">if</span> (Result) {
04271             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04272         }
04273         <span class="keywordflow">else</span> {
04274             <span class="keywordflow">return</span> Address;
04275         }
04276     }
04277 }
04278 
04279 PVOID
<a name="l04280"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a64">04280</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a64">RtlpDphDllGlobalAlloc</a> (
04281     IN ULONG  Flags,
04282     IN SIZE_T Size
04283     )
04284 {
04285     PVOID Block;
04286     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a35">FUN_GLOBAL_ALLOC</a> Original;
04287 
04288     <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">LMEM_MOVEABLE</a>)) {
04289         
04290         Block = <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (
04291             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(RtlProcessHeap()),
04292             0,
04293             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04294 
04295         <span class="keywordflow">if</span> ((Flags &amp; <a class="code" href="../../d2/d3/ldrsnap_8c.html#a22">LMEM_ZEROINIT</a>)) {
04296             RtlZeroMemory (Block, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04297         }
04298         
04299         <span class="keywordflow">return</span> Block;
04300     }
04301     <span class="keywordflow">else</span> {
04302 
04303         Original = (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a35">FUN_GLOBAL_ALLOC</a>)(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a1">SNAP_ROUTINE_GLOBALALLOC</a>]);
04304         <span class="keywordflow">return</span> (* Original) (Flags, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04305     }
04306 }
04307 
04308 PVOID
<a name="l04309"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a65">04309</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a65">RtlpDphDllGlobalReAlloc</a> (
04310     IN PVOID Address,
04311     IN SIZE_T Size,
04312     IN ULONG  Flags
04313     )
04314 {
04315     PVOID Block;
04316     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a36">FUN_GLOBAL_REALLOC</a> Original;
04317 
04318     <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">LMEM_MOVEABLE</a>)) {
04319         
04320         Block = <a class="code" href="../../d7/d9/heappage_8h.html#a12">RtlpDebugPageHeapReAllocate</a> (
04321             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(RtlProcessHeap()),
04322             0,
04323             Address,
04324             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04325 
04326         <span class="keywordflow">return</span> Block;
04327     }
04328     <span class="keywordflow">else</span> {
04329 
04330         Original = (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a36">FUN_GLOBAL_REALLOC</a>)(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a2">SNAP_ROUTINE_GLOBALREALLOC</a>]);
04331         <span class="keywordflow">return</span> (* Original) (Address, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, Flags);
04332     }
04333 }
04334 
04335 PVOID
<a name="l04336"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a66">04336</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a66">RtlpDphDllGlobalFree</a>(
04337     IN PVOID Address
04338     )
04339 {
04340     BOOLEAN Result;
04341     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a37">FUN_GLOBAL_FREE</a> Original;
04342 
04343     <span class="keywordflow">if</span> ((ULONG_PTR)Address &amp; <a class="code" href="../../d2/d3/ldrsnap_8c.html#a23">BASE_HANDLE_MARK_BIT</a>) {
04344         
04345         Original = (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a37">FUN_GLOBAL_FREE</a>)(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a3">SNAP_ROUTINE_GLOBALFREE</a>]);
04346         <span class="keywordflow">return</span> (* Original) (Address);
04347     }
04348     <span class="keywordflow">else</span> {
04349 
04350         Result = <a class="code" href="../../d7/d9/heappage_8h.html#a11">RtlpDebugPageHeapFree</a> (
04351             RtlProcessHeap(),
04352             0,
04353             Address);
04354 
04355         <span class="keywordflow">if</span> (Result) {
04356             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04357         }
04358         <span class="keywordflow">else</span> {
04359             <span class="keywordflow">return</span> Address;
04360         }
04361     }
04362 }
04363 
04364 <span class="comment">//</span>
04365 <span class="comment">// malloc, calloc, realloc, free</span>
04366 <span class="comment">//</span>
04367 
04368 PVOID __cdecl
<a name="l04369"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a67">04369</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a67">RtlpDphDllmalloc</a> (
04370     IN SIZE_T Size
04371     )
04372 {
04373     PVOID Block;
04374 
04375     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04376 
04377     Block = <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (
04378         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>),
04379         0,
04380         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04381 
04382     <span class="keywordflow">return</span> Block;
04383 }
04384 
04385 PVOID __cdecl
<a name="l04386"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a68">04386</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a68">RtlpDphDllcalloc</a> (
04387     IN SIZE_T Number,
04388     IN SIZE_T Size
04389     )
04390 {                    
04391     PVOID Block;
04392 
04393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04394 
04395     Block =  <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (
04396         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>),
04397         0,
04398         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> * Number);
04399 
04400     RtlZeroMemory (Block, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> * Number);
04401     <span class="keywordflow">return</span> Block;
04402 }
04403 
04404 PVOID __cdecl
<a name="l04405"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a69">04405</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a69">RtlpDphDllrealloc</a> (
04406     IN PVOID Address,
04407     IN SIZE_T Size
04408     )
04409 {
04410     PVOID Block;
04411 
04412     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04413 
04414     <span class="keywordflow">if</span> (Address == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04415         
04416         Block = <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (
04417             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>),
04418             0,
04419             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04420     }
04421     <span class="keywordflow">else</span> {
04422 
04423         Block = <a class="code" href="../../d7/d9/heappage_8h.html#a12">RtlpDebugPageHeapReAllocate</a> (
04424             <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>),
04425             0,
04426             Address,
04427             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04428     }
04429 
04430     <span class="keywordflow">return</span> Block;
04431 }
04432 
04433 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> __cdecl
<a name="l04434"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a70">04434</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a70">RtlpDphDllfree</a> (
04435     IN PVOID Address
04436     )
04437 {                                    
04438     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04439 
04440     <a class="code" href="../../d7/d9/heappage_8h.html#a11">RtlpDebugPageHeapFree</a> (
04441         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>,
04442         0,
04443         Address);
04444 }
04445 
04446 <span class="comment">//</span>
04447 <span class="comment">// operator new, delete</span>
04448 <span class="comment">// operator new[], delete[]</span>
04449 <span class="comment">//</span>
04450 
04451 PVOID __cdecl
<a name="l04452"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a71">04452</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a71">RtlpDphDllNew</a> (
04453     IN SIZE_T Size
04454     )
04455 {                              
04456     PVOID Block;
04457 
04458     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04459 
04460     Block = <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (
04461         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>),
04462         0,
04463         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04464 
04465     <span class="keywordflow">return</span> Block;
04466 }
04467 
04468 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> __cdecl
<a name="l04469"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a72">04469</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a72">RtlpDphDllDelete</a> (
04470     IN PVOID Address
04471     )
04472 {                                    
04473     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04474 
04475     <a class="code" href="../../d7/d9/heappage_8h.html#a11">RtlpDebugPageHeapFree</a> (
04476         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>,
04477         0,
04478         Address);
04479 }
04480 
04481 PVOID __cdecl
<a name="l04482"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a73">04482</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a73">RtlpDphDllNewArray</a> (
04483     IN SIZE_T Size
04484     )
04485 {                                    
04486     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04487 
04488     <span class="keywordflow">return</span> <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (
04489         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>),
04490         0,
04491         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
04492 }
04493 
04494 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> __cdecl
<a name="l04495"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a74">04495</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a74">RtlpDphDllDeleteArray</a> (
04496     IN PVOID Address
04497     )
04498 {                                    
04499     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04500 
04501     <a class="code" href="../../d7/d9/heappage_8h.html#a11">RtlpDebugPageHeapFree</a> (
04502         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>,
04503         0,
04504         Address);
04505 }
04506 
04507 <span class="comment">//</span>
04508 <span class="comment">// HeapCreate </span>
04509 <span class="comment">//</span>
04510 
04511 <span class="keyword">typedef</span> PVOID
<a name="l04512"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a38">04512</a> (* FUN_HEAP_CREATE) (
04513     ULONG Options,
04514     SIZE_T InitialSize,
04515     SIZE_T MaximumSize
04516     );
04517 
04518 PVOID
<a name="l04519"></a><a class="code" href="../../d2/d3/ldrsnap_8c.html#a75">04519</a> <a class="code" href="../../d2/d3/ldrsnap_8c.html#a75">RtlpDphDllHeapCreate</a> (
04520     ULONG Options,
04521     SIZE_T InitialSize,
04522     SIZE_T MaximumSize
04523     )
04524 {
04525     PVOID Heap;
04526     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a38">FUN_HEAP_CREATE</a> Original;
04527 
04528     Original = (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a38">FUN_HEAP_CREATE</a>)(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a26">LdrpDphSnapRoutines</a>[<a class="code" href="../../d2/d3/ldrsnap_8c.html#a10">SNAP_ROUTINE_HEAPCREATE</a>]);
04529     Heap = (* Original) (Options, InitialSize, MaximumSize);
04530 
04531     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a> = Heap;
04532     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Page heap: detected CRT heap @ %p \n"</span>, <a class="code" href="../../d2/d3/ldrsnap_8c.html#a31">RtlpDphMsvcrtHeap</a>);
04533 
04534     <span class="keywordflow">return</span> Heap;
04535 }
04536 
04537 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
