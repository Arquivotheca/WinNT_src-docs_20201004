<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmparse2.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmparse2.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d4/d1/cmparse2_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/cmparse2_8c.html#a1">CmpDoCreate</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/cmparse2_8c.html#a2">CmpDoCreateChild</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentCell, IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Flags, OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> KeyCell, OUT PVOID *Object)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/cmparse2_8c.html#a0">CmpKeyControlBlockRoot</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="cmparse2.c::CmpDoCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDoCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">33</a> of file <a class="el" href="../../d4/d1/cmparse2_8c-source.html">cmparse2.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">CmpCleanUpSubKeyInfo()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00284">_CM_KEY_CONTROL_BLOCK::Flags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00439">KEY_SYM_LINK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00539">_CELL_DATA::_u::KeySecurity</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>00045                    :
00046 
00047     Performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first step in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of a registry key.  This
00048     routine checks to make sure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper access to
00049     create a key here, and allocates space <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
00050     cell.  It then calls <a class="code" href="../../d1/d2/cmp_8h.html#a210">CmpDoCreateChild</a> to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key and
00051     create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key object.
00052 
00053     This two phase creation allows us to share <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child creation code
00054     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of link nodes.
00055 
00056 Arguments:
00057 
00058     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00059 
00060     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node to create child under.
00061 
00062     AccessState - <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a> security access state information <span class="keywordflow">for</span> operation.
00063 
00064     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - supplies pointer to a UNICODE string which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of
00065             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child to be created.
00066 
00067     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
00068 
00069     Context - pointer to <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> structure passed through
00070                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager
00071 
00072     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of object create <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to
00073 
00074     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Relative name (to BaseName)
00075 
00076     Object - The address of a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object, <span class="keywordflow">if</span>
00077              any.
00078 
00079 Return Value:
00080 
00081     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00082 
00083 --*/
00084 {
00085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00086     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pparent;
00087     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pdata;
00088     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> KeyCell;
00089     ULONG       ParentType;
00090     ACCESS_MASK AdditionalAccess;
00091     BOOLEAN CreateAccess;
00092     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
00093 
00094     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
00095         KdPrint((<span class="stringliteral">"CmpDoCreate:\n"</span>));
00096     }
00097 
00098     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Context)) {
00099 
00100         <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_BACKUP_RESTORE) {
00101 
00102             <span class="comment">//</span>
00103             <span class="comment">// we're supposed to be opening for a backup/restore</span>
00104             <span class="comment">// operation, but this is a new create, which makes</span>
00105             <span class="comment">// no sense, so fail.</span>
00106             <span class="comment">//</span>
00107             <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
00108         }
00109 
00110         <span class="comment">//</span>
00111         <span class="comment">// Operation is a create, so set Disposition</span>
00112         <span class="comment">//</span>
00113         Context-&gt;Disposition = REG_CREATED_NEW_KEY;
00114     }
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">// Check to make sure the caller can create a sub-key here.</span>
00118     <span class="comment">//</span>
00119     pparent = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00120     pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
00121     ParentType = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00122 
00123     <span class="keywordflow">if</span> ( (ParentType == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) &amp;&amp;
00124          ((Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) == 0) )
00125     {
00126         <span class="comment">//</span>
00127         <span class="comment">// Trying to create stable child under volatile parent, report error</span>
00128         <span class="comment">//</span>
00129         <span class="keywordflow">return</span> STATUS_CHILD_MUST_BE_VOLATILE;
00130     }
00131 
00132     <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp;   <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>)
00133     {
00134         <span class="comment">//</span>
00135         <span class="comment">// Disallow attempts to create anything under a symbolic link</span>
00136         <span class="comment">//</span>
00137         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00138     }
00139 
00140     AdditionalAccess = (Context-&gt;CreateOptions &amp; REG_OPTION_CREATE_LINK) ? KEY_CREATE_LINK : 0;
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// The FullName is not used in the routine CmpCheckCreateAccess,</span>
00144     <span class="comment">// </span>
00145     CreateAccess = <a class="code" href="../../d7/d2/cmse_8c.html#a11">CmpCheckCreateAccess</a>(NULL,
00146                                         &amp;(pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00147                                         AccessState,
00148                                         AccessMode,
00149                                         AdditionalAccess,
00150                                         &amp;status);
00151 
00152     <span class="keywordflow">if</span> (CreateAccess) {
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">// Security check passed, so we can go ahead and create</span>
00156         <span class="comment">// the sub-key.</span>
00157         <span class="comment">//</span>
00158         <span class="keywordflow">if</span> ( !(Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) &amp;&amp;
00159              !<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
00160 
00161             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00162         }
00163 
00164         <span class="comment">//</span>
00165         <span class="comment">// Create and initialize the new sub-key</span>
00166         <span class="comment">//</span>
00167         status = <a class="code" href="../../d3/d2/cmparse2_8c.html#a2">CmpDoCreateChild</a>( Hive,
00168                                    Cell,
00169                                    &amp;(pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00170                                    AccessState,
00171                                    Name,
00172                                    AccessMode,
00173                                    Context,
00174                                    ParentKcb,
00175                                    0,
00176                                    &amp;KeyCell,
00177                                    Object );
00178 
00179         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00180 
00181             <span class="comment">//</span>
00182             <span class="comment">// Child successfully created, add to parent's list.</span>
00183             <span class="comment">//</span>
00184             <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a>(Hive, Cell, KeyCell)) {
00185 
00186                 <span class="comment">//</span>
00187                 <span class="comment">// Unable to add child, so free it</span>
00188                 <span class="comment">//</span>
00189                 <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(Hive, KeyCell, FALSE);
00190                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00191             }
00192 
00193             <span class="comment">//</span>
00194             <span class="comment">// Update max keyname and class name length fields</span>
00195             <span class="comment">//</span>
00196             <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length) {
00197                 pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00198             }
00199 
00200             <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> &lt; Context-&gt;Class.Length) {
00201                 pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = Context-&gt;Class.Length;
00202             }
00203 
00204             KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
00205 
00206             <span class="comment">//</span>
00207             <span class="comment">// A new key is created, invalid the subkey info of the parent KCB.</span>
00208             <span class="comment">//</span>
00209             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00210 
00211             <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>);
00212 
00213             <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_CREATE_LINK) {
00214                 pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, KeyCell);
00215                 pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>;
00216                 KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o8">Flags</a> = pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00217 
00218             }
00219         }
00220     }
00221     <span class="keywordflow">return</span> status;
00222 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmparse2.c::CmpDoCreateChild" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDoCreateChild           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">226</a> of file <a class="el" href="../../d4/d1/cmparse2_8c-source.html">cmparse2.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00422">CM_KEY_NODE_SIGNATURE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00074">CmpCopyName()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00683">CmpHKeyNodeSize</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00526">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00486">KEY_BODY_TYPE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00442">KEY_PREDEF_HANDLE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00542">_CELL_DATA::_u::KeyString</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00493">_CM_KEY_BODY::NotifyBlock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00173">_OBJECT_TYPE_INITIALIZER::PoolType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00494">_CM_KEY_BODY::Process</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00766">REG_OPTION_PREDEF_HANDLE</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00089">SeAssignSecurity()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00373">SeDeassignSecurity()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00449">_CM_KEY_NODE::Signature</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00452">_CM_KEY_NODE::Spare</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00491">_CM_KEY_BODY::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, and <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>.
<p>
<pre class="fragment"><div>00242                    :
00243 
00244     Creates a <span class="keyword">new</span> sub-key.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d1/d2/cmp_8h.html#a209">CmpDoCreate</a> to create child
00245     sub-keys and <a class="code" href="../../d2/d2/cmparse_8c.html#a19">CmpCreateLinkNode</a> to create root sub-keys.
00246 
00247 Arguments:
00248 
00249     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00250 
00251     ParentCell - supplies cell index of parent cell
00252 
00253     ParentDescriptor - Supplies security descriptor of parent key, <span class="keywordflow">for</span> use
00254            in inheriting ACLs.
00255 
00256     AccessState - <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a> security access state information <span class="keywordflow">for</span> operation.
00257 
00258     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Supplies pointer to a UNICODE string which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00259            child to be created.
00260 
00261     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
00262 
00263     Context - Supplies pointer to <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> structure passed through
00264            <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager.
00265 
00266     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of object create <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to
00267 
00268     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Relative name (to BaseName)
00269 
00270     Flags - Supplies any flags to be set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created node
00271 
00272     KeyCell - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created sub-key, <span class="keywordflow">if</span> any.
00273 
00274     Object - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object, <span class="keywordflow">if</span> any.
00275 
00276 Return Value:
00277 
00278     STATUS_SUCCESS - sub-key successfully created.  New object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in
00279             Object, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> cell's cell index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in KeyCell.
00280 
00281     !STATUS_SUCCESS - appropriate error message.
00282 
00283 --*/
00284 
00285 {
00286     ULONG clean=0;
00287     ULONG alloc=0;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00289     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
00290     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ClassCell=<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00291     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> KeyNode;
00292     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
00293     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00294     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> fkcb;
00295     LONG found;
00296     ULONG StorageType;
00297     PSECURITY_DESCRIPTOR NewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00298     LARGE_INTEGER systemtime;
00299 
00300     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
00301         KdPrint((<span class="stringliteral">"CmpDoCreateChild:\n"</span>));
00302     }
00303     <span class="keywordflow">try</span> {
00304         <span class="comment">//</span>
00305         <span class="comment">// Get allocation type</span>
00306         <span class="comment">//</span>
00307         StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>;
00308         <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) {
00309             StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>;
00310         }
00311 
00312         <span class="comment">//</span>
00313         <span class="comment">// Allocate child cell</span>
00314         <span class="comment">//</span>
00315         *KeyCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
00316                         Hive,
00317                         <a class="code" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(Hive, Name),
00318                         StorageType
00319                         );
00320         <span class="keywordflow">if</span> (*KeyCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00321                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00322                         __leave;
00323         }
00324         alloc = 1;
00325         KeyNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, *KeyCell);
00326 
00327         <span class="comment">//</span>
00328         <span class="comment">// Allocate cell for class name</span>
00329         <span class="comment">//</span>
00330         <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00331             ClassCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive, Context-&gt;Class.Length, StorageType);
00332             <span class="keywordflow">if</span> (ClassCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00333                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00334                                 __leave;
00335             }
00336         }
00337         alloc = 2;
00338         <span class="comment">//</span>
00339         <span class="comment">// Allocate the object manager object</span>
00340         <span class="comment">//</span>
00341         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(AccessMode,
00342                                 CmpKeyObjectType,
00343                                 NULL,
00344                                 AccessMode,
00345                                 NULL,
00346                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>),
00347                                 0,
00348                                 0,
00349                                 Object);
00350 
00351         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00352 
00353             KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
00354 
00355             <span class="comment">//</span>
00356             <span class="comment">// We have managed to allocate all of the objects we need to,</span>
00357             <span class="comment">// so initialize them</span>
00358             <span class="comment">//</span>
00359 
00360             <span class="comment">//</span>
00361             <span class="comment">// Mark the object as uninitialized (in case we get an error too soon)</span>
00362             <span class="comment">//</span>
00363             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
00364             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00365 
00366             <span class="comment">//</span>
00367             <span class="comment">// Fill in the class name</span>
00368             <span class="comment">//</span>
00369             <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00370 
00371                 CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ClassCell);
00372 
00373                 <span class="keywordflow">try</span> {
00374 
00375                     RtlMoveMemory(
00376                         &amp;(CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o5">KeyString</a>[0]),
00377                         Context-&gt;Class.Buffer,
00378                         Context-&gt;Class.Length
00379                         );
00380 
00381                 } except(EXCEPTION_EXECUTE_HANDLER) {
00382                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00383                     <span class="keywordflow">return</span> GetExceptionCode();
00384                 }
00385             }
00386 
00387             <span class="comment">//</span>
00388             <span class="comment">// Fill in the new key itself</span>
00389             <span class="comment">//</span>
00390             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a25">CM_KEY_NODE_SIGNATURE</a>;
00391             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = Flags;
00392 
00393             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
00394             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
00395 
00396             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o3">Spare</a> = 0;
00397             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = ParentCell;
00398             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
00399             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
00400             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00401             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00402             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
00403             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00404             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00405             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = ClassCell;
00406             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = Context-&gt;Class.Length;
00407 
00408             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
00409             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 0;
00410             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
00411             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
00412 
00413             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(Hive,
00414                                               KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00415                                               Name);
00416             <span class="keywordflow">if</span> (KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length) {
00417                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00418             }
00419 
00420             <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a112">REG_OPTION_PREDEF_HANDLE</a>) {
00421                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = (ULONG)((ULONG_PTR)Context-&gt;PredefinedHandle);
00422                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>;
00423             }
00424 
00425             <span class="comment">//</span>
00426             <span class="comment">// Create kcb here so all data are filled in.</span>
00427             <span class="comment">//</span>
00428             <span class="comment">// Allocate a key control block</span>
00429             <span class="comment">//</span>
00430             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(Hive, *KeyCell, KeyNode, ParentKcb, FALSE, Name);
00431             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00433                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00434             }
00435             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount == 1);
00436             alloc = 3;
00437 
00438             <span class="comment">//</span>
00439             <span class="comment">// Fill in CM specific fields in the object</span>
00440             <span class="comment">//</span>
00441             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
00442             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00443             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00444             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00445             <a class="code" href="../../d1/d2/cmp_8h.html#a81">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>(KeyBody);
00446             <span class="comment">//</span>
00447             <span class="comment">// Assign a security descriptor to the object.  Note that since</span>
00448             <span class="comment">// registry keys are container objects, and ObAssignSecurity</span>
00449             <span class="comment">// assumes that the only container object in the world is</span>
00450             <span class="comment">// the ObpDirectoryObjectType, we have to call SeAssignSecurity</span>
00451             <span class="comment">// directly in order to get the right inheritance.</span>
00452             <span class="comment">//</span>
00453 
00454             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/seassign_8c.html#a1">SeAssignSecurity</a>(ParentDescriptor,
00455                                       AccessState-&gt;SecurityDescriptor,
00456                                       &amp;NewDescriptor,
00457                                       TRUE,             <span class="comment">// container object</span>
00458                                       &amp;AccessState-&gt;SubjectSecurityContext,
00459                                       &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00460                                       <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>);
00461             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00462                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a9">CmpSecurityMethod</a>(*Object,
00463                                            AssignSecurityDescriptor,
00464                                            NULL,
00465                                            NewDescriptor,
00466                                            NULL,
00467                                            NULL,
00468                                            <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
00469                                            &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>);
00470             }
00471 
00472             <span class="comment">//</span>
00473             <span class="comment">// Since the security descriptor now lives in the hive,</span>
00474             <span class="comment">// free the in-memory copy</span>
00475             <span class="comment">//</span>
00476             <a class="code" href="../../d1/d5/seassign_8c.html#a3">SeDeassignSecurity</a>( &amp;NewDescriptor );
00477 
00478             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00479 
00480                 <span class="comment">//</span>
00481                 <span class="comment">// Note that the dereference will clean up the kcb, so</span>
00482                 <span class="comment">// make sure and decrement the allocation count here.</span>
00483                 <span class="comment">//</span>
00484                 <span class="comment">// Also mark the kcb as deleted so it does not get </span>
00485                 <span class="comment">// inappropriately cached.</span>
00486                 <span class="comment">//</span>
00487                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00488                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
00490                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00491                 alloc = 2;
00492 
00493             } <span class="keywordflow">else</span> {
00494                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00495                         kcb,
00496                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00497                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00498                         REG_NOTIFY_CHANGE_NAME
00499                         );
00500             }
00501         }
00502 
00503     } finally {
00504 
00505         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00506 
00507             <span class="comment">//</span>
00508             <span class="comment">// Clean up allocations</span>
00509             <span class="comment">//</span>
00510             <span class="keywordflow">switch</span> (alloc) {
00511             <span class="keywordflow">case</span> 3:
00512                 <span class="comment">//</span>
00513                 <span class="comment">// Mark KCB as deleted so it does not get inadvertently added to </span>
00514                 <span class="comment">// the delayed close list. That would have fairly disastrous effects</span>
00515                 <span class="comment">// as the KCB points to storage we are about to free.</span>
00516                 <span class="comment">//</span>
00517                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00518                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00519                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
00520                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(kcb);
00521                 <span class="comment">// DELIBERATE FALL</span>
00522 
00523             <span class="keywordflow">case</span> 2:
00524                 <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00525                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, ClassCell);
00526                 }
00527                 <span class="comment">// DELIBERATE FALL</span>
00528 
00529             <span class="keywordflow">case</span> 1:
00530                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, *KeyCell);
00531                 <span class="comment">// DELIBERATE FALL</span>
00532             }
00533         }
00534     }
00535 
00536     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00537 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="cmparse2.c::CmpKeyControlBlockRoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="el" href="../../d3/d2/cmparse2_8c.html#a0">CmpKeyControlBlockRoot</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00029">29</a> of file <a class="el" href="../../d4/d1/cmparse2_8c-source.html">cmparse2.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
