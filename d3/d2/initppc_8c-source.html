<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: initppc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>initppc.c</h1><a href="../../d2/d3/initppc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1993  IBM Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    initppc.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains the machine dependent initialization for the</span>
00013 <span class="comment">    memory management component.  It is specifically tailored to the</span>
00014 <span class="comment">    PowerPC environment.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Lou Perazzoli (loup) 3-Apr-1990</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Modified for PowerPC by Mark Mergen (mergen@watson.ibm.com) 8-Oct-1993</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00027 
00028 <span class="comment">//</span>
00029 <span class="comment">// Local definitions</span>
00030 <span class="comment">//</span>
00031 
<a name="l00032"></a><a class="code" href="../../d2/d3/initppc_8c.html#a0">00032</a> <span class="preprocessor">#define _16MB ((16*1024*1024)/PAGE_SIZE)</span>
00033 <span class="preprocessor"></span>
00034 
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00036"></a><a class="code" href="../../d2/d3/initppc_8c.html#a1">00036</a> <a class="code" href="../../d2/d3/initppc_8c.html#a1">MiInitMachineDependent</a> (
00037     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00038     )
00039 
00040 <span class="comment">/*++</span>
00041 <span class="comment"></span>
00042 <span class="comment">Routine Description:</span>
00043 <span class="comment"></span>
00044 <span class="comment">    This routine performs the necessary operations to enable virtual</span>
00045 <span class="comment">    memory.  This includes building the page directory page, building</span>
00046 <span class="comment">    page table pages to map the code section, the data section, the'</span>
00047 <span class="comment">    stack section and the trap handler.</span>
00048 <span class="comment"></span>
00049 <span class="comment">    It also initializes the PFN database and populates the free list.</span>
00050 <span class="comment"></span>
00051 <span class="comment"></span>
00052 <span class="comment">Arguments:</span>
00053 <span class="comment"></span>
00054 <span class="comment">    None.</span>
00055 <span class="comment"></span>
00056 <span class="comment">Return Value:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    None.</span>
00059 <span class="comment"></span>
00060 <span class="comment">Environment:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    Kernel mode.</span>
00063 <span class="comment"></span>
00064 <span class="comment">--*/</span>
00065 
00066 {
00067 
00068     ULONG i, j;
00069     ULONG HighPage;
00070     ULONG PdePageNumber;
00071     ULONG PdePage;
00072     ULONG PageFrameIndex;
00073     ULONG NextPhysicalPage;
00074     ULONG PfnAllocation;
00075     ULONG NumberOfPages;
00076     ULONG MaxPool;
00077     KIRQL OldIrql;
00078     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00079     ULONG DirBase;
00080     ULONG MostFreePage = 0;
00081     ULONG MostFreeLowMem = 0;
00082     PLIST_ENTRY NextMd;
00083     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> FreeDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00084     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> FreeDescriptorLowMem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00085     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
00086     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00087     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00088     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00089     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00090     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde;
00091     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
00092     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
00093     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00094     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00095     ULONG va;
00096 
00097     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PDE_BASE);
00098 
00099 <span class="comment">// N.B. this will cause first HPT miss fault, DSI in real0.s should fix it!</span>
00100     PdePageNumber = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00101 
00102     DirBase = PdePageNumber &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00103 
00104     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.DirectoryTableBase[0] = DirBase;
00105 
00106     <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Get the lower bound of the free physical memory and the</span>
00110     <span class="comment">// number of physical pages by walking the memory descriptor lists.</span>
00111     <span class="comment">//</span>
00112 
00113     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
00114 
00115     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
00116 
00117         MemoryDescriptor = CONTAINING_RECORD(NextMd,
00118                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
00119                                              ListEntry);
00120 
00121         HighPage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> - 1;
00122         <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00123 
00124         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>) {
00125             <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a> = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00126         }
00127 
00128         <span class="keywordflow">if</span> (HighPage &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00129             <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> = HighPage;
00130         }
00131 
00132             <span class="comment">//</span>
00133         <span class="comment">// Locate the largest free block and the largest free block below 16MB.</span>
00134         <span class="comment">//</span>
00135 
00136         <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>) ||
00137             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a258">LoaderLoadedProgram</a>) ||
00138             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>) ||
00139             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a262">LoaderOsloaderStack</a>)) {
00140 
00141             <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; <a class="code" href="../../d2/d1/inialpha_8c.html#a1">_16MB</a>) &amp;&amp;
00142                 (MostFreeLowMem &lt; MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) &amp;&amp;
00143                 (MostFreeLowMem &lt; ((ULONG)<a class="code" href="../../d2/d1/inialpha_8c.html#a1">_16MB</a> - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>))) {
00144 
00145                 MostFreeLowMem = (ULONG)<a class="code" href="../../d2/d1/inialpha_8c.html#a1">_16MB</a> - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00146                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &lt; MostFreeLowMem) {
00147                     MostFreeLowMem = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00148                 }
00149                 FreeDescriptorLowMem = MemoryDescriptor;
00150 
00151             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt; MostFreePage) {
00152 
00153                 MostFreePage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00154                 FreeDescriptor = MemoryDescriptor;
00155             }
00156         }
00157 
00158         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
00159     }
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">// This printout must be updated when the HAL goes to unicode</span>
00163     <span class="comment">//</span>
00164 
00165     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt; 1024) {
00166         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
00167                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00168                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00169                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00170                       0);
00171     }
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">// Build non-paged pool using the physical pages following the</span>
00175     <span class="comment">// data page in which to build the pool from.  Non-page pool grows</span>
00176     <span class="comment">// from the high range of the virtual address space and expands</span>
00177     <span class="comment">// downward.</span>
00178     <span class="comment">//</span>
00179     <span class="comment">// At this time non-paged pool is constructed so virtual addresses</span>
00180     <span class="comment">// are also physically contiguous.</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &gt;
00184                         (7 * (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;&lt; 3))) {
00185 
00186         <span class="comment">//</span>
00187         <span class="comment">// More than 7/8 of memory allocated to nonpagedpool, reset to 0.</span>
00188         <span class="comment">//</span>
00189 
00190         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = 0;
00191     }
00192 
00193     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>) {
00194 
00195         <span class="comment">//</span>
00196         <span class="comment">// Calculate the size of nonpaged pool.</span>
00197         <span class="comment">// Use the minimum size, then for every MB about 4mb add extra</span>
00198         <span class="comment">// pages.</span>
00199         <span class="comment">//</span>
00200 
00201         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>;
00202 
00203         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> +=
00204                             ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - 1024)/256) *
00205                             <a class="code" href="../../d4/d8/mi_8h.html#a622">MmMinAdditionNonPagedPoolPerMb</a>;
00206     }
00207 
00208     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>) {
00209         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>;
00210     }
00211 
00212     <span class="comment">//</span>
00213     <span class="comment">// Align to page size boundary.</span>
00214     <span class="comment">//</span>
00215 
00216     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &amp;= ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// Calculate the maximum size of pool.</span>
00220     <span class="comment">//</span>
00221 
00222     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> == 0) {
00223 
00224         <span class="comment">//</span>
00225         <span class="comment">// Calculate the size of nonpaged pool.  If 4mb of less use</span>
00226         <span class="comment">// the minimum size, then for every MB about 4mb add extra</span>
00227         <span class="comment">// pages.</span>
00228         <span class="comment">//</span>
00229 
00230         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a621">MmDefaultMaximumNonPagedPool</a>;
00231 
00232         <span class="comment">//</span>
00233         <span class="comment">// Make sure enough expansion for pfn database exists.</span>
00234         <span class="comment">//</span>
00235 
00236         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> += (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (
00237                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>));
00238 
00239         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> +=
00240                         ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - 1024)/256) *
00241                         <a class="code" href="../../d4/d8/mi_8h.html#a623">MmMaxAdditionNonPagedPoolPerMb</a>;
00242     }
00243 
00244     MaxPool = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 16 +
00245                                    (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (
00246                                         <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>));
00247 
00248     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &lt; MaxPool) {
00249         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = MaxPool;
00250     }
00251 
00252     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>) {
00253         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>;
00254     }
00255 
00256     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>
00257                                       - (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> - 1));
00258 
00259     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
00260 
00261     <span class="comment">//</span>
00262     <span class="comment">// Calculate the starting PDE for the system PTE pool which is</span>
00263     <span class="comment">// right below the nonpaged pool.</span>
00264     <span class="comment">//</span>
00265 
00266     <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = (PVOID)(((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> -
00267                                 ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> + 1) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) &amp;
00268                                  (~<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a49">PAGE_DIRECTORY_MASK</a>));
00269 
00270     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a22">MM_LOWEST_NONPAGED_SYSTEM_START</a>) {
00271         <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a22">MM_LOWEST_NONPAGED_SYSTEM_START</a>;
00272         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = (((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> -
00273                                  (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)-1;
00274         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> &gt; 1000);
00275     }
00276 
00277     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
00278 
00279     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>((PVOID)((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a> - 1));
00280 
00281     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ULONG)(EndPde - StartPde) &lt; FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>);
00282 
00283     <span class="comment">//</span>
00284     <span class="comment">// Start building the nonpaged pool with the largest free chunk of memory</span>
00285     <span class="comment">// below 16MB.</span>
00286     <span class="comment">//</span>
00287 
00288     NextPhysicalPage = FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00289     NumberOfPages = FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00290     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00291 
00292     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00293         <span class="keywordflow">if</span> (StartPde-&gt;u.Hard.Valid == 0) {
00294 
00295             <span class="comment">//</span>
00296             <span class="comment">// Map in a page directory page.</span>
00297             <span class="comment">//</span>
00298 
00299             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00300             NextPhysicalPage += 1;
00301             NumberOfPages -= 1;
00302             *StartPde = TempPte;
00303 
00304         }
00305         StartPde += 1;
00306     }
00307 
00308     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NumberOfPages &gt; 0);
00309 
00310     <span class="comment">//</span>
00311     <span class="comment">// Zero the PTEs before nonpaged pool.</span>
00312     <span class="comment">//</span>
00313 
00314     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
00315     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
00316 
00317     RtlZeroMemory (StartPde, ((ULONG)PointerPte - (ULONG)StartPde));
00318 
00319     <span class="comment">//</span>
00320     <span class="comment">// Fill in the PTEs for non-paged pool.</span>
00321     <span class="comment">//</span>
00322 
00323     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> +
00324                                         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> - 1);
00325     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00326         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00327         NextPhysicalPage += 1;
00328         NumberOfPages -= 1;
00329         <span class="keywordflow">if</span> (NumberOfPages == 0) {
00330             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
00331                                          FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
00332             NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00333             NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00334         }
00335         *PointerPte = TempPte;
00336         PointerPte++;
00337     }
00338 
00339     <span class="comment">//</span>
00340     <span class="comment">// Zero the remaining PTEs (if any).</span>
00341     <span class="comment">//</span>
00342 
00343     <span class="keywordflow">while</span> (((ULONG)PointerPte &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) != 0) {
00344         *PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
00345         PointerPte++;
00346     }
00347 
00348     <a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// Non-paged pages now exist, build the pool structures.</span>
00352     <span class="comment">//</span>
00353 
00354     <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a> = (PVOID)((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> +
00355                     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>);
00356     <a class="code" href="../../d4/d8/mi_8h.html#a778">MiInitializeNonPagedPool</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">// Before Non-paged pool can be used, the PFN database must</span>
00360     <span class="comment">// be built.  This is due to the fact that the start and end of</span>
00361     <span class="comment">// allocation bits for nonpaged pool are maintained in the</span>
00362     <span class="comment">// PFN elements for the corresponding pages.</span>
00363     <span class="comment">//</span>
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">// Calculate the number of pages required from page zero to</span>
00367     <span class="comment">// the highest page.</span>
00368     <span class="comment">//</span>
00369     <span class="comment">// Get the number of secondary colors and add the arrary for tracking</span>
00370     <span class="comment">// secondary colors to the end of the PFN database.</span>
00371     <span class="comment">//</span>
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">// Get secondary color value from registry.</span>
00375     <span class="comment">//</span>
00376 
00377     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> == 0) {
00378         <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = PCR-&gt;SecondLevelDcacheSize;
00379     }
00380 
00381     <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00382 
00383     <span class="comment">//</span>
00384     <span class="comment">// Make sure value is power of two and within limits.</span>
00385     <span class="comment">//</span>
00386 
00387     <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> -1)) != 0) ||
00388         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a61">MM_SECONDARY_COLORS_MIN</a>) ||
00389         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a62">MM_SECONDARY_COLORS_MAX</a>)) {
00390         <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a60">MM_SECONDARY_COLORS_DEFAULT</a>;
00391     }
00392 
00393     <a class="code" href="../../d4/d2/datalpha_8c.html#a22">MmSecondaryColorMask</a> = (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> - 1) &amp; ~<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>;
00394 
00395     PfnAllocation = 1 + ((((<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>)) +
00396                         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)*2))
00397                             &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Calculate the start of the Pfn Database (it starts a physical</span>
00401     <span class="comment">// page zero, even if the Lowest physical page is not zero).</span>
00402     <span class="comment">//</span>
00403 
00404     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (PfnAllocation,
00405                                       <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>,
00406                                       0,
00407                                       0,
00408                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00409 
00410     <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
00411 
00412     <span class="comment">//</span>
00413     <span class="comment">// Go through the memory descriptors and for each physical page</span>
00414     <span class="comment">// make the PFN database has a valid PTE to map it.  This allows</span>
00415     <span class="comment">// machines with sparse physical memory to have a minimal PFN</span>
00416     <span class="comment">// database.</span>
00417     <span class="comment">//</span>
00418 
00419     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
00420 
00421     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
00422 
00423         MemoryDescriptor = CONTAINING_RECORD(NextMd,
00424                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
00425                                              ListEntry);
00426 
00427         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
00428                                         MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>));
00429 
00430         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (((PCHAR)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
00431                                         MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
00432                                         MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>))) - 1);
00433 
00434         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00435             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00436                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00437                 NextPhysicalPage += 1;
00438                 NumberOfPages -= 1;
00439                 <span class="keywordflow">if</span> (NumberOfPages == 0) {
00440                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
00441                                                  FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
00442                     NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00443                     NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00444                 }
00445                 *PointerPte = TempPte;
00446                 RtlZeroMemory (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
00447                                <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00448             }
00449             PointerPte++;
00450         }
00451         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
00452     }
00453 
00454     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] = (<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>)
00455                                 &amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> + 1];
00456 
00457     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1] = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>];
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">// Make sure the PTEs are mapped.</span>
00461     <span class="comment">//</span>
00462 
00463 
00464     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0])) {
00465         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][0]);
00466 
00467         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
00468                   (PVOID)((PCHAR)&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>] - 1));
00469 
00470         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00471             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00472                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00473                 NextPhysicalPage += 1;
00474                 *PointerPte = TempPte;
00475                 RtlZeroMemory (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
00476                                <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00477             }
00478             PointerPte++;
00479         }
00480     }
00481 
00482     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; i++) {
00483         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00484         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00485     }
00486 
00487 <span class="preprocessor">#if MM_MAXIMUM_NUMBER_OF_COLORS &gt; 1</span>
00488 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a55">MM_MAXIMUM_NUMBER_OF_COLORS</a>; i++) {
00489         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> = <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>;
00490         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> = <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>;
00491         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00492         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00493         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00494         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00495     }
00496 <span class="preprocessor">#endif</span>
00497 <span class="preprocessor"></span>
00498     <span class="comment">//</span>
00499     <span class="comment">// Go through the page table entries and for any page which is</span>
00500     <span class="comment">// valid, update the corresponding PFN database element.</span>
00501     <span class="comment">//</span>
00502 
00503     Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00504     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PTE_BASE);
00505     va = 0;
00506 
00507     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>; i++) {
00508         <span class="keywordflow">if</span> (Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00509 
00510             PdePage = Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00511             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PdePage);
00512             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00513             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = Pde;
00514             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00515             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00516             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00517             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
00518                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (Pde));
00519 
00520             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (va);
00521 
00522             <span class="keywordflow">for</span> (j = 0 ; j &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; j++) {
00523                 <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00524 
00525                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00526 
00527                     PageFrameIndex = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00528 
00529                     <span class="keywordflow">if</span> (PageFrameIndex &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00530 
00531                         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
00532 
00533                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(Pfn2) &amp;&amp;
00534                              <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>((PUCHAR)(Pfn2+1)-1)) {
00535 
00536                             Pfn2-&gt;PteFrame = PdePage;
00537                             Pfn2-&gt;PteAddress = PointerPte;
00538                             Pfn2-&gt;u2.ShareCount += 1;
00539                             Pfn2-&gt;u3.e2.ReferenceCount = 1;
00540                             Pfn2-&gt;u3.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00541                             Pfn2-&gt;u3.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
00542                                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (
00543                                                             PointerPte));
00544                         }
00545                     }
00546                 }
00547                 va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00548                 PointerPte++;
00549             }
00550         } <span class="keywordflow">else</span> {
00551             va += (ULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a> * (ULONG)<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00552         }
00553         Pde++;
00554     }
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// If page zero is still unused, mark it as in use. This is</span>
00558     <span class="comment">// temporary as we want to find bugs where a physical page</span>
00559     <span class="comment">// is specified as zero.</span>
00560     <span class="comment">//</span>
00561 
00562     Pfn1 = &amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>];
00563     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">// Make the reference count non-zero and point it into a</span>
00567         <span class="comment">// page directory.</span>
00568         <span class="comment">//</span>
00569 
00570         Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (0xb0000000);
00571         PdePage = Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00572         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePageNumber;
00573         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = Pde;
00574         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00575         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00576         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00577         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
00578                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (Pde));
00579     }
00580 
00581     <span class="comment">// end of temporary set to physical page zero.</span>
00582 
00583     <span class="comment">//</span>
00584     <span class="comment">//</span>
00585     <span class="comment">// Walk through the memory descriptors and add pages to the</span>
00586     <span class="comment">// free list in the PFN database.</span>
00587     <span class="comment">//</span>
00588 
00589     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
00590 
00591     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
00592 
00593         MemoryDescriptor = CONTAINING_RECORD(NextMd,
00594                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
00595                                              ListEntry);
00596 
00597         i = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00598         NextPhysicalPage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00599 
00600         <span class="keywordflow">switch</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>) {
00601             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>:
00602                 <span class="keywordflow">while</span> (i != 0) {
00603                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>],
00604                                         NextPhysicalPage);
00605                     i -= 1;
00606                     NextPhysicalPage += 1;
00607                 }
00608                 <span class="keywordflow">break</span>;
00609 
00610             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>:
00611             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a258">LoaderLoadedProgram</a>:
00612             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>:
00613             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a262">LoaderOsloaderStack</a>:
00614 
00615                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
00616                 <span class="keywordflow">while</span> (i != 0) {
00617                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00618 
00619                         <span class="comment">//</span>
00620                         <span class="comment">// Set the PTE address to the phyiscal page for</span>
00621                         <span class="comment">// virtual address alignment checking.</span>
00622                         <span class="comment">//</span>
00623 
00624                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> =
00625                                         (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(NextPhysicalPage &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00626 
00627                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
00628                                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (
00629                                                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
00630                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
00631                                             NextPhysicalPage);
00632                     }
00633                     Pfn1++;
00634                     i -= 1;
00635                     NextPhysicalPage += 1;
00636                 }
00637                 <span class="keywordflow">break</span>;
00638 
00639             <span class="keywordflow">default</span>:
00640 
00641                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> +
00642                                             (NextPhysicalPage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00643                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
00644                 <span class="keywordflow">while</span> (i != 0) {
00645 
00646                     <span class="comment">//</span>
00647                     <span class="comment">// Set page as in use.</span>
00648                     <span class="comment">//</span>
00649 
00650                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00651                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePageNumber;
00652                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
00653                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00654                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00655                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00656                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
00657                                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (
00658                                                         PointerPte));
00659                     }
00660                     Pfn1++;
00661                     i -= 1;
00662                     NextPhysicalPage += 1;
00663                     PointerPte += 1;
00664                 }
00665 
00666                 <span class="keywordflow">break</span>;
00667         }
00668 
00669         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
00670     }
00671 
00672     <span class="comment">//</span>
00673     <span class="comment">// Indicate that the PFN database is allocated in NonPaged pool.</span>
00674     <span class="comment">//</span>
00675 
00676     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>])-&gt;u.Hard.PageFrameNumber);
00677     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
00678     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>])-&gt;u.Hard.PageFrameNumber);
00679     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
00680 
00681     <span class="comment">//</span>
00682     <span class="comment">// Indicate that nonpaged pool must succeed is allocated in</span>
00683     <span class="comment">// nonpaged pool.</span>
00684     <span class="comment">//</span>
00685 
00686     i = <a class="code" href="../../d4/d8/mi_8h.html#a627">MmSizeOfNonPagedMustSucceed</a>;
00687     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a>)-&gt;u.Hard.PageFrameNumber);
00688 
00689     <span class="keywordflow">while</span> ((LONG)i &gt; 0) {
00690         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
00691         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
00692         i -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00693         Pfn1 += 1;
00694     }
00695 
00696     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a>);
00697     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d7/d2/alpha_2initkr_8c.html#a2">MmPfnLock</a>);
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// Initialize the nonpaged available PTEs for mapping I/O space</span>
00701     <span class="comment">// and kernel stacks.</span>
00702     <span class="comment">//</span>
00703 
00704     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
00705 
00706     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (PointerPte);
00707 
00708     <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>) - PointerPte - 1;
00709 
00710     <a class="code" href="../../d0/d9/sysptes_8c.html#a27">MiInitializeSystemPtes</a> (PointerPte, <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>, <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
00711 
00712     <span class="comment">//</span>
00713     <span class="comment">// Initialize the nonpaged pool.</span>
00714     <span class="comment">//</span>
00715 
00716     <a class="code" href="../../d5/d8/ex_8h.html#a215">InitializePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,0);
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Initialize memory management structures for this process.</span>
00720     <span class="comment">//</span>
00721 
00722     <span class="comment">//</span>
00723     <span class="comment">// Build working set list.  System initialization has created</span>
00724     <span class="comment">// a PTE for hyperspace.</span>
00725     <span class="comment">//</span>
00726     <span class="comment">// Note, we can't remove a zeroed page as hyper space does not</span>
00727     <span class="comment">// exist and we map non-zeroed pages into hyper space to zero.</span>
00728     <span class="comment">//</span>
00729 
00730     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
00731 
00732     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
00733     PointerPte-&gt;u.Hard.Write = 1;
00734     PageFrameIndex = PointerPte-&gt;u.Hard.PageFrameNumber;
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">// Point to the page table page we just created and zero it.</span>
00738     <span class="comment">//</span>
00739 
00740     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
00741     RtlZeroMemory ((PVOID)PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Hyper space now exists, set the necessary variables.</span>
00745     <span class="comment">//</span>
00746 
00747     <a class="code" href="../../d4/d8/mi_8h.html#a615">MmFirstReservedMappingPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a64">FIRST_MAPPING_PTE</a>);
00748     <a class="code" href="../../d4/d8/mi_8h.html#a616">MmLastReservedMappingPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a66">LAST_MAPPING_PTE</a>);
00749 
00750     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a>;
00751     <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a> = (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PUCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MMWSL.html">MMWSL</a>));
00752 
00753     <span class="comment">//</span>
00754     <span class="comment">// Initialize this process's memory management structures including</span>
00755     <span class="comment">// the working set list.</span>
00756     <span class="comment">//</span>
00757 
00758     <span class="comment">//</span>
00759     <span class="comment">// The pfn element for the page directory has already been initialized,</span>
00760     <span class="comment">// zero the reference count and the share count so they won't be</span>
00761     <span class="comment">// wrong.</span>
00762     <span class="comment">//</span>
00763 
00764     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePageNumber);
00765     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
00766     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
00767     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
00768 
00769     <span class="comment">//</span>
00770     <span class="comment">// The pfn element for the PDE which maps hyperspace has already</span>
00771     <span class="comment">// been initialized, zero the reference count and the share count</span>
00772     <span class="comment">// so they won't be wrong.</span>
00773     <span class="comment">//</span>
00774 
00775     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00776     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
00777     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
00778     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 1;
00779 
00780 
00781     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00782 
00783     <span class="comment">//</span>
00784     <span class="comment">// Get a page for the working set list and map it into the Page</span>
00785     <span class="comment">// directory at the page after hyperspace.</span>
00786     <span class="comment">//</span>
00787 
00788     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
00789     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a>(PointerPte));
00790     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a> = PageFrameIndex;
00791 
00792     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
00793     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>) + 1;
00794 
00795     *PointerPde = TempPte;
00796 
00797     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00798 
00799     RtlZeroMemory ((PVOID)PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00800 
00801     TempPte = *PointerPde;
00802     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid = 0;
00803 
00804     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
00805     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (PointerPte,
00806                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00807                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00808                      (PHARDWARE_PTE)PointerPde,
00809                      TempPte.u.Hard);
00810 
00811     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00812 
00813     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = <a class="code" href="../../d4/d8/mi_8h.html#a740">MmSystemProcessWorkingSetMax</a>;
00814     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = <a class="code" href="../../d4/d8/mi_8h.html#a739">MmSystemProcessWorkingSetMin</a>;
00815 
00816     <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a> (CurrentProcess,
00817                                 (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00818                                 (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00819 
00820     *PointerPde = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
00821 
00822     <span class="comment">//</span>
00823     <span class="comment">// Check to see if moving the secondary page structures to the end</span>
00824     <span class="comment">// of the PFN database is a waste of memory.  And if so, copy it</span>
00825     <span class="comment">// to paged pool.</span>
00826     <span class="comment">//</span>
00827     <span class="comment">// If the PFN datbase ends on a page aligned boundary and the</span>
00828     <span class="comment">// size of the two arrays is less than a page, free the page</span>
00829     <span class="comment">// and allocate nonpagedpool for this.</span>
00830     <span class="comment">//</span>
00831 
00832     <span class="keywordflow">if</span> ((((ULONG)<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0) &amp;&amp;
00833        ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)) &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00834 
00835         <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00836 
00837         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0];
00838 
00839         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
00840                                <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>),
00841                                '  mM');
00842 
00843         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1] = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>];
00844 
00845         RtlMoveMemory (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0],
00846                        <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>,
00847                        <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a202">MMCOLOR_TABLES</a>));
00848 
00849         <span class="comment">//</span>
00850         <span class="comment">// Free the page.</span>
00851         <span class="comment">//</span>
00852 
00853         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>)) {
00854             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
00855             PageFrameIndex = PointerPte-&gt;u.Hard.PageFrameNumber;
00856             *PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
00857         } <span class="keywordflow">else</span> {
00858             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
00859         }
00860 
00861         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00862         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &lt;= 1) &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &lt;= 1));
00863         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
00864         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
00865         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00866 <span class="preprocessor">#if DBG</span>
00867 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00868 <span class="preprocessor">#endif //DBG</span>
00869 <span class="preprocessor"></span>        <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>], PageFrameIndex);
00870     }
00871 
00872     <span class="keywordflow">return</span>;
00873 }
00874 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
