<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: procsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>procsup.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d5/d4/procsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a0">MM_PROCESS_COMMIT_CHARGE</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a1">MM_PROCESS_CREATE_CHARGE</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a2">HEADER_FILE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>&nbsp;&nbsp;&nbsp;(KERNEL_LARGE_STACK_SIZE / PAGE_SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a4">MI_INIT_PEB_FROM_IMAGE</a>(Hdrs, ImgConfig)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a18">MiGetSystemPteListCount</a> (IN ULONG ListSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a19">MiMakeOutswappedPageResident</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ActualPteAddress, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerTempPte, IN ULONG Global, IN PFN_NUMBER ContainingPage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a21">MiDeleteAddressesInWorkingSet</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a22">MiDeleteValidAddress</a> (IN PVOID Va, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a23">MiDeleteFreeVm</a> (IN PVOID StartingAddress, IN PVOID EndingAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a24">VadTreeWalk</a> (IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (IN ULONG_PTR StartingVirtualAddress, IN ULONG_PTR EndingVirtualAddress, IN LOGICAL Deletable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a26">MiPaeReplenishList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a27">MiAllocateLowMemory</a> (IN SIZE_T NumberOfBytes, IN PFN_NUMBER LowestAcceptablePfn, IN PFN_NUMBER HighestAcceptablePfn, IN PFN_NUMBER BoundaryPfn, IN PVOID CallingAddress, IN ULONG Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory</a> (IN PVOID BaseAddress, IN ULONG Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a29">MmCreateProcessAddressSpace</a> (IN ULONG MinimumWorkingSetSize, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess, OUT PULONG_PTR DirectoryTableBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToInitialize, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToClone OPTIONAL, IN PVOID SectionToMap OPTIONAL, OUT PUNICODE_STRING *AuditName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a31">MmDeleteProcessAddressSpace</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a32">MmCleanProcessAddressSpace</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a33">MmCreateKernelStack</a> (IN BOOLEAN LargeStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a> (IN PVOID PointerKernelStack, IN BOOLEAN LargeStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a35">MmGrowKernelStack</a> (IN PVOID CurrentStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a36">MmOutPageKernelStack</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a37">MmInPageKernelStack</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a38">MmOutSwapProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a39">MmInSwapProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PTEB&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a40">MmCreateTeb</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN PINITIAL_TEB <a class="el" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>, IN PCLIENT_ID ClientId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PPEB&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a41">MmCreatePeb</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN <a class="el" href="../../d2/d2/struct__INITIAL__PEB.html">PINITIAL_PEB</a> InitialPeb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a42">MmDeleteTeb</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN PVOID TebBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a43">MmAllowWorkingSetExpansion</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ActualPteAddress, IN OUT <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerTempPte, IN ULONG Global, IN PFN_NUMBER ContainingPage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a45">MmSetMemoryPriorityProcess</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN UCHAR MemoryPriority)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a5">MmProductType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a7">MmSystemSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a8">BBTBuffer</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a9">MmProcessCommit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a10">MmKernelStackPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a12">MmLargeStacks</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a13">MmSmallStacks</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a14">KernelDemandZeroPte</a> = {MM_KERNEL_DEMAND_ZERO_PTE}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a15">MmRotatingUniprocessorNumber</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a16">MiFaultRetries</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/procsup_8c.html#a17">MiNoLowMemory</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="procsup.c::HEADER_FILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEADER_FILE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00084">84</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="procsup.c::MAX_STACK_PAGES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_STACK_PAGES&nbsp;&nbsp;&nbsp;(KERNEL_LARGE_STACK_SIZE / PAGE_SIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l03180">MmOutPageKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="procsup.c::MI_INIT_PEB_FROM_IMAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MI_INIT_PEB_FROM_IMAGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Hdrs,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ImgConfig&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04418">4418</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="procsup.c::MM_PROCESS_COMMIT_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_PROCESS_COMMIT_CHARGE&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00042">42</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01398">MmDeleteProcessAddressSpace()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l03590">MmOutSwapProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="procsup.c::MM_PROCESS_CREATE_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_PROCESS_CREATE_CHARGE&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00043">43</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l01398">MmDeleteProcessAddressSpace()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a27" doxytag="procsup.c::MiAllocateLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiAllocateLowMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>LowestAcceptablePfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>HighestAcceptablePfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>BoundaryPfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="procsup.c::MiAllocateVad" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> MiAllocateVad           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingVirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingVirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>Deletable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l05659">5659</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02338">MM_MAX_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00134">MM_READONLY</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, and <a class="el" href="../../d6/d6/struct__MMVAD.html#o16">_MMVAD::u3</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>05667                    :
05668 
05669     Reserve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range of address space.
05670 
05671 Arguments:
05672 
05673     StartingVirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting <span class="keyword">virtual</span> address.
05674 
05675     EndingVirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending <span class="keyword">virtual</span> address.
05676 
05677     Deletable - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VAD <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be marked as deletable, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
05678                 <span class="keywordflow">if</span> deletions of <span class="keyword">this</span> VAD should be disallowed.
05679 
05680 Return Value:
05681 
05682     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> VAD pointer on success, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
05683 
05684 --*/
05685 
05686 {
05687     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
05688 
05689     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartingVirtualAddress &lt;= EndingVirtualAddress);
05690 
05691     Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), ' daV');
05692 
05693     <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05694        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05695     }
05696 
05697     <span class="comment">//</span>
05698     <span class="comment">// Set the starting and ending virtual page numbers of the VAD.</span>
05699     <span class="comment">//</span>
05700 
05701     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingVirtualAddress);
05702     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingVirtualAddress);
05703 
05704     <span class="comment">//</span>
05705     <span class="comment">// Mark VAD as no commitment, private, and readonly.</span>
05706     <span class="comment">//</span>
05707 
05708     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags = 0;
05709     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge = <a class="code" href="../../d4/d8/mi_8h.html#a227">MM_MAX_COMMIT</a>;
05710     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>;
05711     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory = 1;
05712 
05713     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2 = 0;
05714 
05715     <span class="keywordflow">if</span> (Deletable == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05716         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
05717         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 0;
05718         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 0;
05719         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ReadOnly = 0;
05720         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn = 0;
05721         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn = 0;
05722     }
05723     <span class="keywordflow">else</span> {
05724         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
05725         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 1;
05726         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 1;
05727         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ReadOnly = 1;
05728         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn = StartingVirtualAddress;
05729         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn = EndingVirtualAddress;
05730     }
05731 
05732     <span class="keywordflow">return</span> Vad;
05733 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="procsup.c::MiCreatePebOrTeb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiCreatePebOrTeb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l04314">MmCreateTeb()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="procsup.c::MiDeleteAddressesInWorkingSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDeleteAddressesInWorkingSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l05006">5006</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05142">MiDeleteValidAddress()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01016">MiReleaseWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>05012                    :
05013 
05014     This routine deletes all user mode addresses from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set
05015     list.
05016 
05017 Arguments:
05018 
05019     Process = Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
05020 
05021 Return Value:
05022 
05023     None.
05024 
05025 Environment:
05026 
05027     Kernel mode, Working Set <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> held.
05028 
05029 --*/
05030 
05031 {
05032     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
05033     ULONG index;
05034     ULONG Entry;
05035     PVOID Va;
05036     KIRQL OldIrql;
05037 <span class="preprocessor">#if DBG</span>
05038 <span class="preprocessor"></span>    PVOID SwapVa;
05039     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05040     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05041     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> LastWsle;
05042 <span class="preprocessor">#endif</span>
05043 <span class="preprocessor"></span>
05044     <span class="comment">//</span>
05045     <span class="comment">// Go through the working set and for any user-accessible page which is</span>
05046     <span class="comment">// in it, rip it out of the working set and free the page.</span>
05047     <span class="comment">//</span>
05048 
05049     index = 2;
05050     Wsle = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[index];
05051 
05052     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05053 
05054     <span class="comment">//</span>
05055     <span class="comment">// Go through the working set list and remove all pages for user</span>
05056     <span class="comment">// space addresses.</span>
05057     <span class="comment">//</span>
05058 
05059     <span class="keywordflow">while</span> (index &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
05060         <span class="keywordflow">if</span> (Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
05061 
05062 <span class="preprocessor">#if defined (_WIN64)</span>
05063 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.Valid == 1);
05064 <span class="preprocessor">#endif</span>
05065 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.Valid == 1);
05066             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.Valid == 1);
05067 
05068             <span class="keywordflow">if</span> (Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress &lt; (PVOID)MM_HIGHEST_USER_ADDRESS) {
05069 
05070                 <span class="comment">//</span>
05071                 <span class="comment">// This is a user mode address, for each one we remove we must</span>
05072                 <span class="comment">// maintain the NonDirectCount.  This is because we may fault</span>
05073                 <span class="comment">// later for page tables and need to grow the hash table when</span>
05074                 <span class="comment">// updating the working set.  NonDirectCount needs to be correct</span>
05075                 <span class="comment">// at that point.</span>
05076                 <span class="comment">//</span>
05077 
05078                 <span class="keywordflow">if</span> (Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct == 0) {
05079                     Process-&gt;Vm.VmWorkingSetList-&gt;NonDirectCount -= 1;
05080                 }
05081 
05082                 <span class="comment">//</span>
05083                 <span class="comment">// This entry is in the working set list.</span>
05084                 <span class="comment">//</span>
05085 
05086                 Va = Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress;
05087 
05088                 <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (index, &amp;Process-&gt;Vm);
05089                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05090                 <a class="code" href="../../d4/d5/procsup_8c.html#a22">MiDeleteValidAddress</a> (Va, Process);
05091                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05092 
05093                 <span class="keywordflow">if</span> (index &lt; <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
05094 
05095                     <span class="comment">//</span>
05096                     <span class="comment">// This entry is locked.</span>
05097                     <span class="comment">//</span>
05098 
05099                     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
05100 
05101                     <span class="keywordflow">if</span> (index != <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
05102 
05103                         Entry = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
05104 <span class="preprocessor">#if DBG</span>
05105 <span class="preprocessor"></span>                        MiDeleteLocked += 1;
05106                         SwapVa = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress;
05107                         SwapVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (SwapVa);
05108 
05109                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (SwapVa);
05110                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
05111 
05112                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Entry == MiLocateWsle (SwapVa, MmWorkingSetList, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex));
05113 <span class="preprocessor">#endif</span>
05114 <span class="preprocessor"></span>                        <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry, index, &amp;Process-&gt;Vm);
05115                     }
05116                 }
05117             }
05118         }
05119         index += 1;
05120         Wsle += 1;
05121     }
05122 
05123 <span class="preprocessor">#if DBG</span>
05124 <span class="preprocessor"></span>    Wsle = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[2];
05125     LastWsle = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>];
05126     <span class="keywordflow">while</span> (Wsle &lt;= LastWsle) {
05127         <span class="keywordflow">if</span> (Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
05128 <span class="preprocessor">#if defined (_WIN64)</span>
05129 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.Valid == 1);
05130 <span class="preprocessor">#endif</span>
05131 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.Valid == 1);
05132             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.Valid == 1);
05133         }
05134         Wsle += 1;
05135     }
05136 <span class="preprocessor">#endif</span>
05137 <span class="preprocessor"></span>
05138 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="procsup.c::MiDeleteFreeVm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDeleteFreeVm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="procsup.c::MiDeleteValidAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDeleteValidAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Va</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentProcess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l05142">5142</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01745">MiDecrementCloneBlockReference()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00715">MiLocateCloneAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02463">PMMCLONE_BLOCK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l05006">MiDeleteAddressesInWorkingSet()</a>.
<p>
<pre class="fragment"><div>05149                    :
05150 
05151     This routine deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address.
05152 
05153 Arguments:
05154 
05155     Va - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to <span class="keyword">delete</span>.
05156 
05157     CurrentProcess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
05158 
05159 Return Value:
05160 
05161     None.
05162 
05163 Environment:
05164 
05165     Kernel mode.  PFN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> HELD.
05166 
05167     Note since <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> called during process teardown, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write watch
05168     bits are not updated.  If <span class="keyword">this</span> ever called from other places, code
05169     will need to be added here to update those bits.
05170 
05171 --*/
05172 
05173 {
05174     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
05175     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05176     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05177     <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneBlock;
05178     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> CloneDescriptor;
05179     PFN_NUMBER PageFrameIndex;
05180 
05181     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
05182 
05183 <span class="preprocessor">#if defined (_WIN64)</span>
05184 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(Va)-&gt;u.Hard.Valid == 1);
05185 <span class="preprocessor">#endif</span>
05186 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(Va)-&gt;u.Hard.Valid == 1);
05187     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
05188 
05189     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
05190     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05191     CloneDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05192 
05193     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
05194 
05195         CloneBlock = (<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
05196 
05197         <span class="comment">//</span>
05198         <span class="comment">// Capture the state of the modified bit for this</span>
05199         <span class="comment">// pte.</span>
05200         <span class="comment">//</span>
05201 
05202         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (PointerPte, Pfn1);
05203 
05204         <span class="comment">//</span>
05205         <span class="comment">// Decrement the share and valid counts of the page table</span>
05206         <span class="comment">// page which maps this PTE.</span>
05207         <span class="comment">//</span>
05208 
05209         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
05210         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPde));
05211 
05212         <span class="comment">//</span>
05213         <span class="comment">// Decrement the share count for the physical page.</span>
05214         <span class="comment">//</span>
05215 
05216         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
05217 
05218         <span class="comment">//</span>
05219         <span class="comment">// Check to see if this is a fork prototype PTE and if so</span>
05220         <span class="comment">// update the clone descriptor address.</span>
05221         <span class="comment">//</span>
05222 
05223         <span class="keywordflow">if</span> (Va &lt;= MM_HIGHEST_USER_ADDRESS) {
05224 
05225             <span class="comment">//</span>
05226             <span class="comment">// Locate the clone descriptor within the clone tree.</span>
05227             <span class="comment">//</span>
05228 
05229             CloneDescriptor = <a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)CloneBlock);
05230         }
05231     } <span class="keywordflow">else</span> {
05232 
05233         <span class="comment">//</span>
05234         <span class="comment">// This PTE is a NOT a prototype PTE, delete the physical page.</span>
05235         <span class="comment">//</span>
05236 
05237         <span class="comment">//</span>
05238         <span class="comment">// Decrement the share and valid counts of the page table</span>
05239         <span class="comment">// page which maps this PTE.</span>
05240         <span class="comment">//</span>
05241 
05242         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
05243 
05244         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
05245 
05246         <span class="comment">//</span>
05247         <span class="comment">// Decrement the share count for the physical page.  As the page</span>
05248         <span class="comment">// is private it will be put on the free list.</span>
05249         <span class="comment">//</span>
05250 
05251         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
05252 
05253         <span class="comment">//</span>
05254         <span class="comment">// Decrement the count for the number of private pages.</span>
05255         <span class="comment">//</span>
05256 
05257         CurrentProcess-&gt;NumberOfPrivatePages -= 1;
05258     }
05259 
05260     <span class="comment">//</span>
05261     <span class="comment">// Set the pointer to PTE to be a demand zero PTE.  This allows</span>
05262     <span class="comment">// the page usage count to be kept properly and handles the case</span>
05263     <span class="comment">// when a page table page has only valid PTEs and needs to be</span>
05264     <span class="comment">// deleted later when the VADs are removed.</span>
05265     <span class="comment">//</span>
05266 
05267     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
05268 
05269     <span class="keywordflow">if</span> (CloneDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05270 
05271         <span class="comment">//</span>
05272         <span class="comment">// Decrement the reference count for the clone block,</span>
05273         <span class="comment">// note that this could release and reacquire</span>
05274         <span class="comment">// the mutexes hence cannot be done until after the</span>
05275         <span class="comment">// working set index has been removed.</span>
05276         <span class="comment">//</span>
05277 
05278         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> ( CloneDescriptor,
05279                                              CloneBlock,
05280                                              CurrentProcess )) {
05281 
05282         }
05283     }
05284 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="procsup.c::MiFreeLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiFreeLowMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l05372">MmFreeContiguousMemory()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l05414">MmFreeContiguousMemorySpecifyCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="procsup.c::MiGetSystemPteListCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiGetSystemPteListCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ListSize</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01987">1987</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00116">MM_PTE_TABLE_LIMIT</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00103">MmSysPteListBySizeCount</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00098">MmSysPteTables</a>.
<p>
<pre class="fragment"><div>01993                    :
01994 
01995     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of free entries of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list which
01996     covers <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified size.  The size must be less than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01997     largest list index.
01998 
01999 Arguments:
02000 
02001     ListSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs needed.
02002 
02003 Return Value:
02004 
02005     Number of free entries on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list which contains ListSize PTEs.
02006 
02007 Environment:
02008 
02009     Kernel mode.
02010 
02011 --*/
02012 
02013 {
02014 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
02015 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER (ListSize);
02016 
02017     <span class="keywordflow">return</span> 8;
02018 <span class="preprocessor">#else</span>
02019 <span class="preprocessor"></span>    ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02020 
02021     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListSize &lt;= MM_PTE_TABLE_LIMIT);
02022 
02023     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [ListSize];
02024     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02025 <span class="preprocessor">#endif</span>
02026 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="procsup.c::MiMakeOutswappedPageResident" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER MiMakeOutswappedPageResident           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ActualPteAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerTempPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Global</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>ContainingPage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">5287</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02003">GET_PAGING_FILE_NUMBER</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02026">GET_PAGING_FILE_OFFSET</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08509">IoPageRead()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00601">MI_MAKE_TRANSITION_PTE_VALID</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00808">MI_SET_GLOBAL_STATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03973">MiInitializePfnForOtherProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00245">MiIoRetryLevel</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00216">MmHalfSecond</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00250">MmIsRetryIoStatus</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a207">WrPageIn</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l03445">MmInPageKernelStack()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l03910">MmInSwapProcess()</a>.
<p>
<pre class="fragment"><div>05296                    :
05297 
05298     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PTE valid.
05299 
05300 Arguments:
05301 
05302     ActualPteAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual address that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE will
05303                        reside at.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> page coloring.
05304 
05305     PointerTempPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE to operate on, returns a valid
05306                      PTE.
05307 
05308     Global - Supplies 1 <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resulting PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> global.
05309 
05310     ContainingPage - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page which
05311                      contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resulting PTE.  If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 0, no
05312                      operations on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> containing page are performed.
05313 
05314 Return Value:
05315 
05316     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number that was allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE.
05317 
05318 Environment:
05319 
05320     Kernel mode, PFN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> HELD!
05321 
05322 --*/
05323 
05324 {
05325     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
05326     KIRQL OldIrql;
05327     PFN_NUMBER PageFrameIndex;
05328     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05329     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 2];
05330     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
05331     LARGE_INTEGER StartingOffset;
05332     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
05333     IO_STATUS_BLOCK IoStatus;
05334     PFN_NUMBER PageFileNumber;
05335     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05336     PPFN_NUMBER Page;
05337     ULONG RefaultCount;
05338     PVOID HyperVa;
05339 
05340     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
05341 
05342     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
05343 
05344     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerTempPte-&gt;u.Hard.Valid == 0);
05345 
05346     <span class="keywordflow">if</span> (PointerTempPte-&gt;u.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>) {
05347 
05348         <span class="comment">//</span>
05349         <span class="comment">// Any page will do.</span>
05350         <span class="comment">//</span>
05351 
05352         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
05353         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
05354                             MI_GET_PAGE_COLOR_FROM_PTE (ActualPteAddress));
05355 
05356         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
05357                            PageFrameIndex,
05358                            MM_READWRITE,
05359                            ActualPteAddress );
05360         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
05361         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, Global);
05362 
05363         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerTempPte, TempPte);
05364         <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
05365                                         ActualPteAddress,
05366                                         ContainingPage);
05367 
05368     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PointerTempPte-&gt;u.Soft.Transition == 1) {
05369 
05370         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (PointerTempPte);
05371         PointerTempPte-&gt;u.Trans.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>;
05372         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05373 
05374         <span class="comment">//</span>
05375         <span class="comment">// PTE refers to a transition PTE.</span>
05376         <span class="comment">//</span>
05377 
05378         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>) {
05379             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
05380 
05381             <span class="comment">//</span>
05382             <span class="comment">// Even though this routine is only used to bring in special</span>
05383             <span class="comment">// system pages that are separately charged, a modified write</span>
05384             <span class="comment">// may be in progress and if so, will have applied a systemwide</span>
05385             <span class="comment">// charge against the locked pages count.  This all works out nicely</span>
05386             <span class="comment">// (with no code needed here) as the write completion will see</span>
05387             <span class="comment">// the nonzero ShareCount and remove the charge.</span>
05388             <span class="comment">//</span>
05389 
05390             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) ||
05391                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LockCharged == 1));
05392 
05393             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
05394             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
05395         }
05396 
05397         <span class="comment">//</span>
05398         <span class="comment">// Update the PFN database, the share count is now 1 and</span>
05399         <span class="comment">// the reference count is incremented as the share count</span>
05400         <span class="comment">// just went from zero to 1.</span>
05401         <span class="comment">//</span>
05402 
05403         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
05404         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
05405         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0) {
05406 
05407             <span class="comment">//</span>
05408             <span class="comment">// Release the page file space for this page.</span>
05409             <span class="comment">//</span>
05410 
05411             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
05412             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
05413         }
05414 
05415         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a108">MI_MAKE_TRANSITION_PTE_VALID</a> (TempPte, PointerTempPte);
05416 
05417         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
05418         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, Global);
05419         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerTempPte, TempPte);
05420 
05421     } <span class="keywordflow">else</span> {
05422 
05423         <span class="comment">//</span>
05424         <span class="comment">// Page resides in a paging file.</span>
05425         <span class="comment">// Any page will do.</span>
05426         <span class="comment">//</span>
05427 
05428         PointerTempPte-&gt;u.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>;
05429         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
05430         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
05431                             MI_GET_PAGE_COLOR_FROM_PTE (ActualPteAddress));
05432 
05433         <span class="comment">//</span>
05434         <span class="comment">// Initialize the PFN database element, but don't</span>
05435         <span class="comment">// set read in progress as collided page faults cannot</span>
05436         <span class="comment">// occur here.</span>
05437         <span class="comment">//</span>
05438 
05439         <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
05440                                         ActualPteAddress,
05441                                         ContainingPage);
05442 
05443         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;Event, NotificationEvent, FALSE);
05444 
05445         <span class="comment">//</span>
05446         <span class="comment">// Calculate the VPN for the in-page operation.</span>
05447         <span class="comment">//</span>
05448 
05449         TempPte = *PointerTempPte;
05450         PageFileNumber = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a169">GET_PAGING_FILE_NUMBER</a> (TempPte);
05451 
05452         StartingOffset.QuadPart = (LONGLONG)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a170">GET_PAGING_FILE_OFFSET</a> (TempPte)) &lt;&lt;
05453                                     <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
05454 
05455         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05456 
05457         <span class="comment">//</span>
05458         <span class="comment">// Build MDL for request.</span>
05459         <span class="comment">//</span>
05460 
05461         Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack[0];
05462         <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(Mdl,
05463                         MiGetVirtualAddressMappedByPte (ActualPteAddress),
05464                         PAGE_SIZE);
05465         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
05466 
05467         Page = (PPFN_NUMBER)(Mdl + 1);
05468         *Page = PageFrameIndex;
05469 
05470         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05471 
05472 <span class="preprocessor">#if DBG</span>
05473 <span class="preprocessor"></span>        HyperVa = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql);
05474         RtlFillMemoryUlong (HyperVa,
05475                             PAGE_SIZE,
05476                             0x34785690);
05477         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
05478 <span class="preprocessor">#endif</span>
05479 <span class="preprocessor"></span>
05480         <span class="comment">//</span>
05481         <span class="comment">// Issue the read request.</span>
05482         <span class="comment">//</span>
05483 
05484         RefaultCount = <a class="code" href="../../d4/d8/mi_8h.html#a428">MiIoRetryLevel</a>;
05485 
05486 Refault:
05487         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a89">IoPageRead</a> ( MmPagingFile[PageFileNumber]-&gt;File,
05488                               Mdl,
05489                               &amp;StartingOffset,
05490                               &amp;Event,
05491                               &amp;IoStatus
05492                               );
05493 
05494         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
05495             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
05496                                    WrPageIn,
05497                                    KernelMode,
05498                                    FALSE,
05499                                    (PLARGE_INTEGER)NULL);
05500             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
05501         }
05502 
05503         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
05504             <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
05505         }
05506 
05507         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
05508             <span class="keywordflow">if</span> (IoStatus.Information != <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
05509                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_STACK_INPAGE_ERROR,
05510                               2,
05511                               IoStatus.Status,
05512                               PageFileNumber,
05513                               StartingOffset.LowPart);
05514             }
05515         }
05516 
05517         <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) || (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status))) {
05518             <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d8/mi_8h.html#a85">MmIsRetryIoStatus</a>(Status)) ||
05519                 (<a class="code" href="../../d4/d8/mi_8h.html#a85">MmIsRetryIoStatus</a>(IoStatus.Status))) &amp;&amp;
05520                 (RefaultCount != 0)) {
05521 
05522                 <span class="comment">//</span>
05523                 <span class="comment">// Insufficient resources, delay and reissue</span>
05524                 <span class="comment">// the in page operation.</span>
05525                 <span class="comment">//</span>
05526 
05527                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode,
05528                                         FALSE,
05529                                         &amp;MmHalfSecond);
05530                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;Event);
05531                 RefaultCount -= 1;
05532                 <span class="keywordflow">goto</span> Refault;
05533             }
05534             KdPrint((<span class="stringliteral">"MMINPAGE: status %lx io-status %lx\n"</span>,
05535                       Status, IoStatus.Status));
05536             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_STACK_INPAGE_ERROR,
05537                           Status,
05538                           IoStatus.Status,
05539                           PageFileNumber,
05540                           StartingOffset.LowPart);
05541         }
05542 
05543         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05544 
05545         <span class="comment">//</span>
05546         <span class="comment">// Release the page file space.</span>
05547         <span class="comment">//</span>
05548 
05549         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (TempPte);
05550         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
05551 
05552         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
05553                            PageFrameIndex,
05554                            MM_READWRITE,
05555                            ActualPteAddress );
05556         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
05557         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
05558         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, Global);
05559 
05560         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerTempPte, TempPte);
05561     }
05562     <span class="keywordflow">return</span> PageFrameIndex;
05563 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="procsup.c::MiMakeOutswappedPageResident" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER MiMakeOutswappedPageResident           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ActualPteAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerTempPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Global</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>ContainingPage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="procsup.c::MiPaeReplenishList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiPaeReplenishList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="procsup.c::MmAllowWorkingSetExpansion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmAllowWorkingSetExpansion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04948">4948</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01920">PspSystemThreadStartup()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">PspUserThreadStartup()</a>.
<p>
<pre class="fragment"><div>04954                    :
04955 
04956     This routine updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list head FLINK field to
04957     indicate that working set adjustment <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed.
04958 
04959     NOTE: This routine may be called more than once per process.
04960 
04961 Arguments:
04962 
04963     None.
04964 
04965 Return Value:
04966 
04967     None.
04968 
04969 Environment:
04970 
04971     Kernel mode.
04972 
04973 --*/
04974 
04975 {
04976 
04977     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
04978     KIRQL OldIrql;
04979 
04980     <span class="comment">//</span>
04981     <span class="comment">// Check the current state of the working set adjustment flag</span>
04982     <span class="comment">// in the process header.</span>
04983     <span class="comment">//</span>
04984 
04985     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04986 
04987     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
04988 
04989     <span class="keywordflow">if</span> (!CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a>) {
04990         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04991 
04992         InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
04993                         &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
04994     }
04995 
04996     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
04997     <span class="keywordflow">return</span>;
04998 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="procsup.c::MmCleanProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmCleanProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">1695</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00067">_MMSUPPORT::AddressSpaceBeingDeleted</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00215">_EPROCESS::AddressSpaceInitialized</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02669">_LOCK_TRACKER::CallersCaller</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02668">_LOCK_TRACKER::CallingAddress</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00229">_EPROCESS::CloneRoot</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00186">_EPROCESS::CommitCharge</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02680">_LOCK_HEADER::Count</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02655">_MMPTE_FLUSH_LIST::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02413">_MMVAD_SHORT::EndingVpn</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01608">_MMWSL::HashTableSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01611">_MMWSL::HighestPermittedHashAddress</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02679">_LOCK_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00982">LOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00288">_EPROCESS::LockedPagesList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02662">_LOCK_TRACKER::Mdl</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l02313">MiCleanPhysicalProcessPages()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05006">MiDeleteAddressesInWorkingSet()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a312">MiDeleteAlternateTable()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l02361">MiDeletePageTablesForPhysicalRange()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00026">MiDeleteVirtualAddresses()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01160">MiFlushPteList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02641">MiPhysicalViewRemover()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00265">MiRemoveMappedView()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l02110">MiRemoveUserPhysicalPagesVad()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d3/d7/session_8c.html#a6">MiSessionRemoveProcess()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00099">MiTrackingAborted</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04303">MM_DBG_COMMIT_RETURN_PROCESS_CLEAN_PAGETABLES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00183">MM_DBG_PRIVATE_PAGES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00364">MM_MAXIMUM_WORKING_SET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00099">MM_NO_WS_EXPANSION</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00043">MM_PROCESS_CREATE_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00100">MM_WS_EXPANSION_IN_PROGRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01604">_MMWSL::NumberOfCommittedPageTables</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00231">_EPROCESS::NumberOfLockedPages</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00230">_EPROCESS::NumberOfPrivatePages</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00267">_EPROCESS::PhysicalVadList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00318">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02823">PsChangeJobMemoryUsage()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02412">_MMVAD_SHORT::StartingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00965">UNLOCK_EXPANSION_AND_THEN_WAIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00991">UNLOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00227">_EPROCESS::VadRoot</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00220">_EPROCESS::VmOperation</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00223">_EPROCESS::VmOperationEvent</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00295">_EPROCESS::Wow64Process</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">PspExitProcess()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>01700                    :
01701 
01702     This routine cleans an address space by deleting all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01703     user and pagable portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space.  At <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01704     completion of <span class="keyword">this</span> routine, no page faults may occur within
01705     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
01706 
01707 Arguments:
01708 
01709     None.
01710 
01711 Return Value:
01712 
01713     None.
01714 
01715 Environment:
01716 
01717     Kernel mode, APCs disabled.
01718 
01719 --*/
01720 
01721 {
01722     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01723     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
01724     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01725     KIRQL OldIrql;
01726 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
01727 <span class="preprocessor"></span>    KIRQL OldIrql2;
01728 <span class="preprocessor">#endif</span>
01729 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01730     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01731     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01732     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01733     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01734     PVOID TempVa;
01735     LONG AboveWsMin;
01736     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
01737 
01738     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
01739     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01740     <span class="keywordflow">if</span> ((Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) ||
01741         (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o26">AddressSpaceInitialized</a> == 0)) {
01742 
01743         <span class="comment">//</span>
01744         <span class="comment">// This process's address space has already been deleted.  However,</span>
01745         <span class="comment">// this process can still have a session space.  Get rid of it now.</span>
01746         <span class="comment">//</span>
01747 
01748         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01749             <a class="code" href="../../d3/d7/session_8c.html#a6">MiSessionRemoveProcess</a> ();
01750         }
01751 
01752         <span class="keywordflow">return</span>;
01753     }
01754 
01755     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o26">AddressSpaceInitialized</a> == 1) {
01756 
01757         <span class="comment">//</span>
01758         <span class="comment">// The process has been created but not fully initialized.</span>
01759         <span class="comment">// Return partial resources now.</span>
01760         <span class="comment">//</span>
01761 
01762         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> -
01763                                                     <a class="code" href="../../d4/d5/procsup_8c.html#a1">MM_PROCESS_CREATE_CHARGE</a>);
01764 
01765         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(41, Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> -
01766                                                     MM_PROCESS_CREATE_CHARGE);
01767 
01768         <span class="comment">//</span>
01769         <span class="comment">// This process's address space has already been deleted.  However,</span>
01770         <span class="comment">// this process can still have a session space.  Get rid of it now.</span>
01771         <span class="comment">//</span>
01772 
01773         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01774             <a class="code" href="../../d3/d7/session_8c.html#a6">MiSessionRemoveProcess</a> ();
01775         }
01776 
01777         <span class="keywordflow">return</span>;
01778     }
01779 
01780     <span class="comment">//</span>
01781     <span class="comment">// If working set expansion for this process is allowed, disable</span>
01782     <span class="comment">// it and remove the process from expanded process list if it</span>
01783     <span class="comment">// is on it.</span>
01784     <span class="comment">//</span>
01785 
01786     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01787 
01788     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed) {
01789 
01790         <span class="comment">//</span>
01791         <span class="comment">// Initialize an event and put the event address</span>
01792         <span class="comment">// in the blink field.  When the trimming is complete,</span>
01793         <span class="comment">// this event will be set.</span>
01794         <span class="comment">//</span>
01795 
01796         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;Event, NotificationEvent, FALSE);
01797 
01798         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink = (PLIST_ENTRY)&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01799 
01800         <span class="comment">//</span>
01801         <span class="comment">// Release the mutex and wait for the event.</span>
01802         <span class="comment">//</span>
01803 
01804         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01805         <a class="code" href="../../d4/d8/mi_8h.html#a141">UNLOCK_EXPANSION_AND_THEN_WAIT</a> (OldIrql);
01806 
01807         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;Event,
01808                               WrVirtualMemory,
01809                               KernelMode,
01810                               FALSE,
01811                               (PLARGE_INTEGER)NULL);
01812         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01813     }
01814     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>) {
01815 
01816         <span class="comment">//</span>
01817         <span class="comment">// No trimming is in progress and no expansion allowed, so this cannot</span>
01818         <span class="comment">// be on any lists.</span>
01819         <span class="comment">//</span>
01820 
01821         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink != MM_WS_EXPANSION_IN_PROGRESS);
01822 
01823         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01824     } <span class="keywordflow">else</span> {
01825 
01826         RemoveEntryList (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
01827 
01828         <span class="comment">//</span>
01829         <span class="comment">// Disable expansion.</span>
01830         <span class="comment">//</span>
01831 
01832         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
01833 
01834         <span class="comment">//</span>
01835         <span class="comment">// Release the pfn mutex.</span>
01836         <span class="comment">//</span>
01837 
01838         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01839     }
01840 
01841     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01842         <a class="code" href="../../d3/d7/session_8c.html#a6">MiSessionRemoveProcess</a> ();
01843     }
01844 
01845     <span class="comment">//</span>
01846     <span class="comment">// Delete all the user owned pagable virtual addresses in the process.</span>
01847     <span class="comment">//</span>
01848 
01849     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01850 
01851     <span class="comment">//</span>
01852     <span class="comment">// Synchronize address space delete with NtReadVirtualMemory and</span>
01853     <span class="comment">// NtWriteVirtualMemory.</span>
01854     <span class="comment">//</span>
01855 
01856     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
01857     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> = 1;
01858     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> != 0) {
01859 
01860         <span class="comment">//</span>
01861         <span class="comment">// A Vm operation is in progress, set the event and</span>
01862         <span class="comment">// indicate this process is being deleted to stop other</span>
01863         <span class="comment">// Vm operations.</span>
01864         <span class="comment">//</span>
01865 
01866         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;Event, NotificationEvent, FALSE);
01867         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o34">VmOperationEvent</a> = &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01868 
01869         <span class="keywordflow">do</span> {
01870 
01871             <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01872 
01873             <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01874             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;Event,
01875                                   WrVirtualMemory,
01876                                   KernelMode,
01877                                   FALSE,
01878                                   (PLARGE_INTEGER)NULL);
01879 
01880             <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01881 
01882             <span class="comment">//</span>
01883             <span class="comment">// Synchronize address space delete with NtReadVirtualMemory and</span>
01884             <span class="comment">// NtWriteVirtualMemory.</span>
01885             <span class="comment">//</span>
01886 
01887             <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
01888 
01889         } <span class="keywordflow">while</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> != 0);
01890 
01891         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01892 
01893     } <span class="keywordflow">else</span> {
01894         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01895     }
01896 
01897     <span class="comment">//</span>
01898     <span class="comment">// Delete all the valid user mode addresses from the working set</span>
01899     <span class="comment">// list.  At this point NO page faults are allowed on user space</span>
01900     <span class="comment">// addresses.  Faults are allowed on page tables for user space, which</span>
01901     <span class="comment">// requires that we keep the working set structure consistent until we</span>
01902     <span class="comment">// finally take it all down.</span>
01903     <span class="comment">//</span>
01904 
01905     <a class="code" href="../../d4/d5/procsup_8c.html#a21">MiDeleteAddressesInWorkingSet</a> (Process);
01906 
01907     <span class="comment">//</span>
01908     <span class="comment">// Remove hash table pages, if any.  This is the first time we do this</span>
01909     <span class="comment">// during the deletion path, but we need to do it again before we finish</span>
01910     <span class="comment">// because we may fault in some page tables during the VAD clearing.  We</span>
01911     <span class="comment">// could have maintained the hash table validity during the WorkingSet</span>
01912     <span class="comment">// deletion above in order to avoid freeing the hash table twice, but since</span>
01913     <span class="comment">// we're just deleting it all anyway, it's faster to do it this way.  Note</span>
01914     <span class="comment">// that if we don't do this or maintain the validity, we can trap later</span>
01915     <span class="comment">// in MiGrowWsleHash.</span>
01916     <span class="comment">//</span>
01917 
01918     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;MmWsle[MM_MAXIMUM_WORKING_SET]) + 1;
01919     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>);
01920 
01921 <span class="preprocessor">#if defined (_WIN64)</span>
01922 <span class="preprocessor"></span>    PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
01923     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01924 
01925     <span class="keywordflow">if</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) &amp;&amp;
01926         (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) &amp;&amp;
01927         (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1)) {
01928 
01929         PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
01930         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01931         <span class="keywordflow">while</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid) {
01932             TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
01933             <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
01934                          TempVa,
01935                          FALSE,
01936                          Process,
01937                          NULL,
01938                          &amp;PteFlushList);
01939 
01940             PointerPte += 1;
01941             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
01942 
01943             <span class="comment">//</span>
01944             <span class="comment">// If all the entries have been removed from the previous page</span>
01945             <span class="comment">// table page, delete the page table page itself.  Likewise with</span>
01946             <span class="comment">// the page directory page.</span>
01947             <span class="comment">//</span>
01948 
01949             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) ||
01950                 ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte))-&gt;u.Hard.Valid == 0) ||
01951                 ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte))-&gt;u.Hard.Valid == 0) ||
01952                 (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
01953 
01954                 <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, FALSE, ZeroPte);
01955 
01956                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte - 1);
01957 
01958                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01959 
01960                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPde));
01961 
01962                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
01963                 {
01964                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
01965                                  PointerPte - 1,
01966                                  FALSE,
01967                                  Process,
01968                                  NULL,
01969                                  NULL);
01970                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
01971                 }
01972 
01973                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) {
01974 
01975                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01976 
01977                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01978 
01979                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPpe));
01980 
01981                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
01982                     {
01983                         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
01984                                      PointerPde,
01985                                      FALSE,
01986                                      Process,
01987                                      NULL,
01988                                      NULL);
01989                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
01990                     }
01991                 }
01992                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01993                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
01994                 <span class="keywordflow">if</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
01995                     (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
01996                         <span class="keywordflow">break</span>;
01997                 }
01998             }
01999         }
02000         <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, FALSE, ZeroPte);
02001         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02002     }
02003 <span class="preprocessor">#else</span>
02004 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid) {
02005         PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
02006         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02007         <span class="keywordflow">while</span> ((PointerPte &lt; LastPte) &amp;&amp; (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid)) {
02008             TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
02009             <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
02010                          TempVa,
02011                          FALSE,
02012                          Process,
02013                          NULL,
02014                          &amp;PteFlushList);
02015 
02016             PointerPte += 1;
02017             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
02018         }
02019         <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, FALSE, ZeroPte);
02020         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02021     }
02022 <span class="preprocessor">#endif</span>
02023 <span class="preprocessor"></span>
02024     <span class="comment">//</span>
02025     <span class="comment">// Clear the hash fields as a fault may occur below on the page table</span>
02026     <span class="comment">// pages during VAD clearing and resolution of the fault may result in</span>
02027     <span class="comment">// adding a hash table.  Thus these fields must be consistent with the</span>
02028     <span class="comment">// clearing just done above.</span>
02029     <span class="comment">//</span>
02030 
02031     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = 0;
02032     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02033 
02034     <span class="comment">//</span>
02035     <span class="comment">// Delete the virtual address descriptors and dereference any</span>
02036     <span class="comment">// section objects.</span>
02037     <span class="comment">//</span>
02038 
02039     Vad = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
02040 
02041     <span class="keywordflow">while</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02042 
02043         <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (Vad);
02044 
02045         <span class="comment">//</span>
02046         <span class="comment">// If the system has been biased to an alternate base address to</span>
02047         <span class="comment">// allow 3gb of user address space, then check if the current VAD</span>
02048         <span class="comment">// describes the shared memory page.</span>
02049         <span class="comment">//</span>
02050 
02051 <span class="preprocessor">#if defined(_X86_) &amp;&amp; defined(MM_SHARED_USER_DATA_VA)</span>
02052 <span class="preprocessor"></span>
02053         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
02054 
02055             <span class="comment">//</span>
02056             <span class="comment">// If the VAD describes the shared memory page, then free the</span>
02057             <span class="comment">// VAD and continue with the next entry.</span>
02058             <span class="comment">//</span>
02059 
02060             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> == <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (MM_SHARED_USER_DATA_VA)) {
02061                 <span class="keywordflow">goto</span> LoopEnd;
02062             }
02063         }
02064 <span class="preprocessor">#endif</span>
02065 <span class="preprocessor"></span>
02066         <span class="keywordflow">if</span> (((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0) &amp;&amp;
02067             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) ||
02068             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1)) {
02069 
02070             <span class="comment">//</span>
02071             <span class="comment">// This VAD represents a mapped view or a driver-mapped physical</span>
02072             <span class="comment">// view - delete the view and perform any section related cleanup</span>
02073             <span class="comment">// operations.</span>
02074             <span class="comment">//</span>
02075 
02076             <a class="code" href="../../d4/d9/umapview_8c.html#a2">MiRemoveMappedView</a> (Process, Vad);
02077 
02078         } <span class="keywordflow">else</span> {
02079 
02080             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
02081 
02082                 <span class="comment">//</span>
02083                 <span class="comment">// Free all the physical pages that this VAD might be mapping.</span>
02084                 <span class="comment">// Since only the AWE lock synchronizes the remap API, carefully</span>
02085                 <span class="comment">// remove this VAD from the list first.</span>
02086                 <span class="comment">//</span>
02087 
02088                 <a class="code" href="../../d4/d8/mi_8h.html#a893">MiPhysicalViewRemover</a> (Process, Vad);
02089 
02090                 <a class="code" href="../../d8/d5/physical_8c.html#a13">MiRemoveUserPhysicalPagesVad</a> ((<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a>)Vad);
02091   
02092                 <a class="code" href="../../d4/d8/mi_8h.html#a887">MiDeletePageTablesForPhysicalRange</a> (
02093                         MI_VPN_TO_VA (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
02094                         <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>));
02095             }
02096             <span class="keywordflow">else</span> {
02097 
02098                 <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.WriteWatch == 1) {
02099                     <a class="code" href="../../d4/d8/mi_8h.html#a893">MiPhysicalViewRemover</a> (Process, Vad);
02100                 }
02101 
02102                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02103     
02104                 <span class="comment">//</span>
02105                 <span class="comment">// Don't specify address space deletion as TRUE as</span>
02106                 <span class="comment">// the working set must be consistent as page faults may</span>
02107                 <span class="comment">// be taken during clone removal, protoPTE lookup, etc.</span>
02108                 <span class="comment">//</span>
02109     
02110                 <a class="code" href="../../d4/d8/mi_8h.html#a885">MiDeleteVirtualAddresses</a> (MI_VPN_TO_VA (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
02111                                           <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>),
02112                                           FALSE,
02113                                           Vad);
02114     
02115                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02116             }
02117         }
02118 
02119 <span class="preprocessor">#if defined(_X86_) &amp;&amp; defined(MM_SHARED_USER_DATA_VA)</span>
02120 <span class="preprocessor"></span>LoopEnd:
02121 <span class="preprocessor">#endif</span>
02122 <span class="preprocessor"></span>
02123         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
02124         Vad = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
02125     }
02126 
02127     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (IsListEmpty (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>) != 0);
02128     
02129     <a class="code" href="../../d8/d5/physical_8c.html#a15">MiCleanPhysicalProcessPages</a> (Process);
02130 
02131     <span class="comment">//</span>
02132     <span class="comment">// Delete the shared data page, if any.</span>
02133     <span class="comment">//</span>
02134 
02135     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02136 
02137 <span class="preprocessor">#if defined(MM_SHARED_USER_DATA_VA)</span>
02138 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a885">MiDeleteVirtualAddresses</a> ((PVOID) MM_SHARED_USER_DATA_VA,
02139                               (PVOID) MM_SHARED_USER_DATA_VA,
02140                               FALSE,
02141                               NULL);
02142 <span class="preprocessor">#endif</span>
02143 <span class="preprocessor"></span>
02144     <span class="comment">//</span>
02145     <span class="comment">// Delete the system portion of the address space.</span>
02146     <span class="comment">// Only now is it safe to specify TRUE to MiDelete because now that the</span>
02147     <span class="comment">// VADs have been deleted we can no longer fault on user space pages.</span>
02148     <span class="comment">//</span>
02149 
02150 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
02151 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql2);
02152 <span class="preprocessor">#endif</span>
02153 <span class="preprocessor"></span>    Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o10">AddressSpaceBeingDeleted</a> = 1;
02154 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
02155 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql2);
02156 <span class="preprocessor">#endif</span>
02157 <span class="preprocessor"></span>
02158     <span class="comment">//</span>
02159     <span class="comment">// Adjust the count of pages above working set maximum.  This</span>
02160     <span class="comment">// must be done here because the working set list is not</span>
02161     <span class="comment">// updated during this deletion.</span>
02162     <span class="comment">//</span>
02163 
02164     AboveWsMin = (LONG)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - (LONG)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02165     <span class="keywordflow">if</span> (AboveWsMin &gt; 0) {
02166         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= AboveWsMin;
02167     }
02168 
02169     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02170 
02171     <span class="comment">//</span>
02172     <span class="comment">// Return commitment for page table pages.</span>
02173     <span class="comment">//</span>
02174 
02175 <span class="preprocessor">#ifdef _WIN64</span>
02176 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> == 0);
02177 <span class="preprocessor">#else</span>
02178 <span class="preprocessor"></span>    <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a>);
02179 
02180     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_PROCESS_CLEAN_PAGETABLES,
02181                      <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a>);
02182 
02183     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
02184         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a>);
02185     }
02186     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a>;
02187 <span class="preprocessor">#endif</span>
02188 <span class="preprocessor"></span>
02189     <span class="comment">//</span>
02190     <span class="comment">// Check to make sure all the clone descriptors went away.</span>
02191     <span class="comment">//</span>
02192 
02193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o40">CloneRoot</a> == (<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>)NULL);
02194 
02195     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o42">NumberOfLockedPages</a> != 0) {
02196         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o76">LockedPagesList</a>) {
02197 
02198             PLIST_ENTRY NextEntry;
02199             <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a> Tracker;
02200             <a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">PLOCK_HEADER</a> LockedPagesHeader;
02201 
02202             LockedPagesHeader = (<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">PLOCK_HEADER</a>)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o76">LockedPagesList</a>;
02203             <span class="keywordflow">if</span> ((LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o1">Count</a> != 0) &amp;&amp; (<a class="code" href="../../d5/d6/iosup_8c.html#a14">MiTrackingAborted</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02204                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (IsListEmpty (&amp;LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>) == 0);
02205                 NextEntry = LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>.Flink;
02206 
02207                 Tracker = CONTAINING_RECORD (NextEntry,
02208                                              <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">LOCK_TRACKER</a>,
02209                                              ListEntry);
02210         
02211                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_LEFT_LOCKED_PAGES_IN_PROCESS,
02212                               (ULONG_PTR)Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o7">CallingAddress</a>,
02213                               (ULONG_PTR)Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o8">CallersCaller</a>,
02214                               (ULONG_PTR)Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o1">Mdl</a>,
02215                               Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o42">NumberOfLockedPages</a>);
02216             }
02217         }
02218 
02219         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PROCESS_HAS_LOCKED_PAGES,
02220                       0,
02221                       (ULONG_PTR)Process,
02222                       Process-&gt;NumberOfLockedPages,
02223                       (ULONG_PTR)Process-&gt;LockedPagesList);
02224         <span class="keywordflow">return</span>;
02225     }
02226 
02227     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o76">LockedPagesList</a>) {
02228         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTrackLockedPages == TRUE);
02229         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o76">LockedPagesList</a>);
02230         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o76">LockedPagesList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02231     }
02232 
02233 <span class="preprocessor">#if DBG</span>
02234 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> != 0) &amp;&amp; (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a75">MM_DBG_PRIVATE_PAGES</a>)) {
02235         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: Process contains private pages %ld\n"</span>,
02236                Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a>);
02237         DbgBreakPoint();
02238     }
02239 <span class="preprocessor">#endif //DBG</span>
02240 <span class="preprocessor"></span>
02241 
02242 <span class="preprocessor">#if defined(_WIN64)</span>
02243 <span class="preprocessor"></span>    <span class="comment">//</span>
02244     <span class="comment">// Delete the WowProcess structure</span>
02245     <span class="comment">//</span>
02246 
02247     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02248 <span class="preprocessor">#if defined(_MIALT4K_)</span>
02249 <span class="preprocessor"></span>        <a class="code" href="../../d2/d9/miia64_8h.html#a312">MiDeleteAlternateTable</a>(Process);
02250 <span class="preprocessor">#endif</span>
02251 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>);
02252         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02253     }
02254 <span class="preprocessor">#endif</span>
02255 <span class="preprocessor"></span>
02256     <span class="comment">//</span>
02257     <span class="comment">// Remove the working set list pages (except for the first one).</span>
02258     <span class="comment">// These pages are not removed because DPCs could still occur within</span>
02259     <span class="comment">// the address space.  In a DPC, nonpagedpool could be allocated</span>
02260     <span class="comment">// which could require removing a page from the standby list, requiring</span>
02261     <span class="comment">// hyperspace to map the previous PTE.</span>
02262     <span class="comment">//</span>
02263 
02264     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmWorkingSetList) + 1;
02265 
02266     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
02267 
02268     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02269     <span class="keywordflow">while</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid) {
02270         TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
02271         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
02272                      TempVa,
02273                      TRUE,
02274                      Process,
02275                      NULL,
02276                      &amp;PteFlushList);
02277 
02278         PointerPte += 1;
02279 <span class="preprocessor">#if defined (_WIN64)</span>
02280 <span class="preprocessor"></span>        <span class="comment">//</span>
02281         <span class="comment">// If all the entries have been removed from the previous page</span>
02282         <span class="comment">// table page, delete the page table page itself.  Likewise with</span>
02283         <span class="comment">// the page directory page.</span>
02284         <span class="comment">//</span>
02285 
02286         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) ||
02287             ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte))-&gt;u.Hard.Valid == 0) ||
02288             ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte))-&gt;u.Hard.Valid == 0) ||
02289             (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
02290 
02291             <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, FALSE, ZeroPte);
02292 
02293             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte - 1);
02294 
02295             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02296 
02297             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPde));
02298 
02299             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
02300             {
02301                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
02302                              PointerPte - 1,
02303                              TRUE,
02304                              Process,
02305                              NULL,
02306                              NULL);
02307             }
02308 
02309             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) {
02310 
02311                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
02312 
02313                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02314 
02315                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPpe));
02316 
02317                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
02318                 {
02319                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
02320                                  PointerPde,
02321                                  TRUE,
02322                                  Process,
02323                                  NULL,
02324                                  NULL);
02325                 }
02326             }
02327         }
02328 <span class="preprocessor">#endif</span>
02329 <span class="preprocessor"></span>    }
02330 
02331     <span class="comment">//</span>
02332     <span class="comment">// Remove hash table pages, if any.  Yes, we've already done this once</span>
02333     <span class="comment">// during the deletion path, but we need to do it again because we may</span>
02334     <span class="comment">// have faulted in some page tables during the VAD clearing.</span>
02335     <span class="comment">//</span>
02336 
02337     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;MmWsle[MM_MAXIMUM_WORKING_SET]) + 1;
02338 
02339 <span class="preprocessor">#if defined (_WIN64)</span>
02340 <span class="preprocessor"></span>    PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
02341     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
02342 
02343     <span class="keywordflow">if</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) &amp;&amp;
02344         (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) &amp;&amp;
02345         (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1)) {
02346 
02347         <span class="keywordflow">while</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid) {
02348             TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
02349             <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
02350                          TempVa,
02351                          TRUE,
02352                          Process,
02353                          NULL,
02354                          &amp;PteFlushList);
02355 
02356             PointerPte += 1;
02357 
02358             <span class="comment">//</span>
02359             <span class="comment">// If all the entries have been removed from the previous page</span>
02360             <span class="comment">// table page, delete the page table page itself.  Likewise with</span>
02361             <span class="comment">// the page directory page.</span>
02362             <span class="comment">//</span>
02363 
02364             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) ||
02365                 ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte))-&gt;u.Hard.Valid == 0) ||
02366                 ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte))-&gt;u.Hard.Valid == 0) ||
02367                 (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
02368 
02369                 <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, FALSE, ZeroPte);
02370 
02371                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte - 1);
02372 
02373                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02374 
02375                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPde));
02376 
02377                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
02378                 {
02379                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
02380                                  PointerPte - 1,
02381                                  TRUE,
02382                                  Process,
02383                                  NULL,
02384                                  NULL);
02385                 }
02386 
02387                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) {
02388 
02389                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
02390 
02391                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02392 
02393                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPpe));
02394 
02395                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
02396                     {
02397                         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
02398                                      PointerPde,
02399                                      TRUE,
02400                                      Process,
02401                                      NULL,
02402                                      NULL);
02403                     }
02404                 }
02405             }
02406         }
02407     }
02408 <span class="preprocessor">#else</span>
02409 <span class="preprocessor"></span>    <span class="keywordflow">while</span> ((PointerPte &lt; LastPte) &amp;&amp; (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid)) {
02410         TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
02411         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
02412                      TempVa,
02413                      TRUE,
02414                      Process,
02415                      NULL,
02416                      &amp;PteFlushList);
02417 
02418         PointerPte += 1;
02419     }
02420 <span class="preprocessor">#endif</span>
02421 <span class="preprocessor"></span>
02422     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, FALSE, ZeroPte);
02423 
02424     <span class="comment">//</span>
02425     <span class="comment">// Update the count of available resident pages.</span>
02426     <span class="comment">//</span>
02427 
02428     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> &gt;= MM_PROCESS_CREATE_CHARGE);
02429     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> -
02430                                                     <a class="code" href="../../d4/d5/procsup_8c.html#a1">MM_PROCESS_CREATE_CHARGE</a>;
02431     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(8, Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> -
02432                                                     MM_PROCESS_CREATE_CHARGE);
02433     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == MM_NO_WS_EXPANSION);
02434     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02435 
02436     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02437     <span class="keywordflow">return</span>;
02438 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="procsup.c::MmCreateKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmCreateKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LargeStack</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">2450</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d0/d9/sysptes_8c.html#a21">MiGetSystemPteListCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04264">MM_DBG_COMMIT_KERNEL_STACK_CREATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04304">MM_DBG_COMMIT_RETURN_KERNEL_STACK_FAILURE1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04305">MM_DBG_COMMIT_RETURN_KERNEL_STACK_FAILURE2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00151">MM_KSTACK_OUTSWAPPED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00446">MM_STACK_ALIGNMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00447">MM_STACK_OFFSET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04798">MmFirstDeadKernelStack</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00096">MmKernelStackPages</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00098">MmLargeStacks</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04796">MmNumberDeadKernelStacks</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00076">MmProcessCommit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00099">MmSmallStacks</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/i386_2allproc_8c-source.html#l00075">KeStartAllProcessors()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00246">KiInitializeKernel()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.
<p>
<pre class="fragment"><div>02456                    :
02457 
02458     This routine allocates a kernel stack and a no-access page within
02459     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-pagable portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
02460 
02461 Arguments:
02462 
02463     LargeStack - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a large stack should be
02464                  created.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> a small stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created.
02465 
02466 Return Value:
02467 
02468     Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack.  Note, that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02469     base address points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> guard page, so space must be allocated
02470     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack before accessing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack.
02471 
02472     If a kernel stack cannot be created, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02473 
02474 Environment:
02475 
02476     Kernel mode.  APCs Disabled.
02477 
02478 --*/
02479 
02480 {
02481     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02482     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02483     PFN_NUMBER NumberOfPages;
02484     ULONG NumberOfPtes;
02485     ULONG ChargedPtes;
02486     ULONG RequestedPtes;
02487 <span class="preprocessor">#if defined(_IA64_)</span>
02488 <span class="preprocessor"></span>    ULONG NumberOfBStorePtes;
02489 <span class="preprocessor">#endif</span>
02490 <span class="preprocessor"></span>    PFN_NUMBER PageFrameIndex;
02491     ULONG i;
02492     PVOID StackVa;
02493     KIRQL OldIrql;
02494 
02495     <span class="comment">//</span>
02496     <span class="comment">// Acquire the PFN mutex to synchronize access to the dead stack</span>
02497     <span class="comment">// list and to the pfn database.</span>
02498     <span class="comment">//</span>
02499 
02500     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02501 
02502     <span class="comment">//</span>
02503     <span class="comment">// Check to see if any "unused" stacks are available.</span>
02504     <span class="comment">//</span>
02505 
02506     <span class="keywordflow">if</span> ((!LargeStack) &amp;&amp; (<a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a> != 0)) {
02507 
02508 <span class="preprocessor">#if DBG</span>
02509 <span class="preprocessor"></span>        {
02510             ULONG i = <a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a>;
02511             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnList = <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a>;
02512 
02513             <span class="keywordflow">while</span> (i &gt; 0) {
02514                 i--;
02515                 <span class="keywordflow">if</span> ((PfnList != MmKstacks[i].Pfn) ||
02516                    (PfnList-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> != MmKstacks[i].Pte))  {
02517                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MMPROCSUP: kstacks %p %ld. %p\n"</span>,
02518                        PfnList, i, MmKstacks[i].Pfn);
02519                    DbgBreakPoint();
02520                 }
02521                 PfnList = PfnList-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.NextStackPfn;
02522             }
02523         }
02524 <span class="preprocessor">#if defined(_IA64_)</span>
02525 <span class="preprocessor"></span>        NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_STACK_SIZE + KERNEL_BSTORE_SIZE);
02526 <span class="preprocessor">#else</span>
02527 <span class="preprocessor"></span>        NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_STACK_SIZE);
02528 <span class="preprocessor">#endif</span>
02529 <span class="preprocessor"></span><span class="preprocessor">#endif //DBG</span>
02530 <span class="preprocessor"></span>
02531         <a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a> -= 1;
02532         PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a>-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
02533         <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a> = <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a>-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.NextStackPfn;
02534 
02535     } <span class="keywordflow">else</span> {
02536 
02537         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02538 
02539 <span class="preprocessor">#if defined(_IA64_)</span>
02540 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (LargeStack) {
02541             NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_SIZE);
02542             NumberOfBStorePtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_BSTORE_SIZE);
02543             NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_COMMIT
02544                                             + KERNEL_LARGE_BSTORE_COMMIT);
02545 
02546         } <span class="keywordflow">else</span> {
02547             NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_STACK_SIZE);
02548             NumberOfBStorePtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_BSTORE_SIZE);
02549             NumberOfPages = NumberOfPtes + NumberOfBStorePtes;
02550         }
02551         ChargedPtes = NumberOfPtes + NumberOfBStorePtes;
02552         RequestedPtes = ChargedPtes + 2 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a100">MM_STACK_ALIGNMENT</a> ? 1 : 0);
02553 <span class="preprocessor">#else</span>
02554 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (LargeStack) {
02555             NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_SIZE);
02556             NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_COMMIT);
02557         } <span class="keywordflow">else</span> {
02558             NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_STACK_SIZE);
02559             NumberOfPages = NumberOfPtes;
02560         }
02561         ChargedPtes = NumberOfPtes;
02562         RequestedPtes = ChargedPtes + 1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a100">MM_STACK_ALIGNMENT</a> ? 1 : 0);
02563 <span class="preprocessor">#endif // _IA64_</span>
02564 <span class="preprocessor"></span>
02565         <span class="comment">//</span>
02566         <span class="comment">// Make sure there are at least 8 of the appropriate system PTE pool.</span>
02567         <span class="comment">//</span>
02568 
02569         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/sysptes_8c.html#a21">MiGetSystemPteListCount</a> (RequestedPtes) &lt; 8) {
02570             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02571         }
02572 
02573         <span class="comment">//</span>
02574         <span class="comment">// Charge commitment for the page file space for the kernel stack.</span>
02575         <span class="comment">//</span>
02576 
02577         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (ChargedPtes, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02578 
02579             <span class="comment">//</span>
02580             <span class="comment">// Commitment exceeded, return NULL, indicating no kernel</span>
02581             <span class="comment">// stacks are available.</span>
02582             <span class="comment">//</span>
02583 
02584             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02585         }
02586         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_KERNEL_STACK_CREATE, ChargedPtes);
02587 
02588         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02589 
02590         <span class="comment">//</span>
02591         <span class="comment">// Check to make sure the physical pages are available.</span>
02592         <span class="comment">//</span>
02593 
02594         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt;= (SPFN_NUMBER)NumberOfPages) {
02595             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02596             <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (ChargedPtes);
02597             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_KERNEL_STACK_FAILURE1,
02598                              ChargedPtes);
02599             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02600         }
02601 
02602         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
02603         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(9, NumberOfPages);
02604 
02605         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02606 
02607         <span class="comment">//</span>
02608         <span class="comment">// Obtain enough pages to contain the stack plus a guard page from</span>
02609         <span class="comment">// the system PTE pool.  The system PTE pool contains non-paged PTEs</span>
02610         <span class="comment">// which are currently empty.</span>
02611         <span class="comment">//</span>
02612 
02613         <a class="code" href="../../d4/d5/procsup_8c.html#a10">MmKernelStackPages</a> += RequestedPtes;
02614 
02615         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (RequestedPtes,
02616                                           SystemPteSpace,
02617                                           MM_STACK_ALIGNMENT,
02618                                           MM_STACK_OFFSET,
02619                                           FALSE);
02620 
02621         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02622 
02623             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02624             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
02625             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(13, NumberOfPages);
02626             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02627 
02628             <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (ChargedPtes);
02629             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_KERNEL_STACK_FAILURE2,
02630                              ChargedPtes);
02631             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02632         }
02633 
02634 <span class="preprocessor">#if defined(_IA64_)</span>
02635 <span class="preprocessor"></span>
02636         <span class="comment">//</span>
02637         <span class="comment">// StackVa is calculated here</span>
02638         <span class="comment">//</span>
02639 
02640         StackVa = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte + NumberOfPtes + 1);
02641 
02642         <span class="comment">//</span>
02643         <span class="comment">// The PTEs are divided between kernel stack and RSE space.</span>
02644         <span class="comment">//</span>
02645         <span class="comment">// The kernel stack grows downward and the RSE grows upward.</span>
02646         <span class="comment">//</span>
02647         <span class="comment">// For large stacks, one chunk is allocated in the middle of the PTE</span>
02648         <span class="comment">// range and split here.</span>
02649         <span class="comment">//</span>
02650         <span class="comment">// need better algorithm for RSE</span>
02651 
02652         <span class="keywordflow">if</span> (LargeStack) {
02653             PointerPte += <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_SIZE - KERNEL_LARGE_STACK_COMMIT -1);
02654         }
02655 
02656 <span class="preprocessor">#else</span>
02657 <span class="preprocessor"></span>        PointerPte += (NumberOfPtes - NumberOfPages);
02658 <span class="preprocessor">#endif // _IA64_</span>
02659 <span class="preprocessor"></span>
02660         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02661 
02662         <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPages; i += 1) {
02663             PointerPte += 1;
02664             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02665             <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
02666             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
02667                                 MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
02668 
02669             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
02670 
02671 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
02672 <span class="preprocessor"></span>            PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
02673 <span class="preprocessor">#endif</span>
02674 <span class="preprocessor"></span>
02675             <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
02676 
02677             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
02678                                PageFrameIndex,
02679                                MM_READWRITE,
02680                                PointerPte );
02681             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
02682 
02683             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02684         }
02685         <a class="code" href="../../d8/d5/kddata_8c.html#a33">MmProcessCommit</a> += ChargedPtes;
02686         <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> += NumberOfPages;
02687         <a class="code" href="../../d4/d5/procsup_8c.html#a12">MmLargeStacks</a> += LargeStack;
02688         <a class="code" href="../../d4/d5/procsup_8c.html#a13">MmSmallStacks</a> += !LargeStack;
02689 
02690 <span class="preprocessor">#if defined(_IA64_)</span>
02691 <span class="preprocessor"></span>
02692         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02693 
02694         <span class="keywordflow">return</span> StackVa;
02695 <span class="preprocessor">#endif</span>
02696 <span class="preprocessor"></span>
02697     }
02698 
02699     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02700 
02701     PointerPte += 1;
02702     StackVa = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02703 <span class="preprocessor">#if !defined(_IA64_)</span>
02704 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
02705 <span class="preprocessor"></span>    {
02706         PULONG p;
02707         ULONG_PTR i;
02708 
02709         p = (PULONG)((ULONG_PTR)StackVa - ((ULONG_PTR)NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
02710         i = ((ULONG_PTR)NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &gt;&gt; 2;
02711         <span class="keywordflow">while</span>(i--) {
02712             *p++ = 0x12345678;
02713         }
02714 
02715     }
02716 <span class="preprocessor">#endif // DBG</span>
02717 <span class="preprocessor"></span><span class="preprocessor">#endif // _IA64_</span>
02718 <span class="preprocessor"></span>
02719     <span class="keywordflow">return</span> StackVa;
02720 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="procsup.c::MmCreatePeb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PPEB MmCreatePeb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d2/struct__INITIAL__PEB.html">PINITIAL_PEB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialPeb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">4631</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d9/d0/init_8h-source.html#l00032">CmNtCSDVersion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00039">InitAnsiCodePageDataOffset</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00042">InitNlsSectionPointer</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00040">InitOemCodePageDataOffset</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00041">InitUnicodeCaseTableDataOffset</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04418">MI_INIT_PEB_FROM_IMAGE</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00218">MmCriticalSectionTimeout</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00105">MmHeapDeCommitFreeBlockThreshold</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00104">MmHeapDeCommitTotalFreeThreshold</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00103">MmHeapSegmentCommit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00102">MmHeapSegmentReserve</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00103">MmRotatingUniprocessorNumber</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00042">NtBuildNumber</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00030">NtMajorVersion</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00031">NtMinorVersion</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>04638                    :
04639 
04640     This routine creates a PEB page within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process
04641     and copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial PEB values into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
04642 
04643 Arguments:
04644 
04645     TargetProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which to create
04646                     and initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PEB.
04647 
04648     InitialPeb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial PEB to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04649                  newly created PEB.
04650 
04651 Return Value:
04652 
04653     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created PEB.
04654 
04655     Can raise exceptions <span class="keywordflow">if</span> no address space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PEB or
04656     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user has exceeded quota (non-paged, pagefile, commit).
04657 
04658 Environment:
04659 
04660     Kernel mode.
04661 
04662 --*/
04663 
04664 {
04665     PPEB PebBase;
04666     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Magic;
04667     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Characteristics;
04668     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04669     PVOID ViewBase;
04670     LARGE_INTEGER SectionOffset;
04671     PIMAGE_NT_HEADERS NtHeaders;
04672     SIZE_T ViewSize;
04673     ULONG ReturnedSize;
04674     PIMAGE_LOAD_CONFIG_DIRECTORY ImageConfigData;
04675     ULONG ProcessAffinityMask;
04676 
04677     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04678     SectionOffset.LowPart = 0;
04679     SectionOffset.HighPart = 0;
04680     ViewSize = 0;
04681 
04682     <span class="comment">//</span>
04683     <span class="comment">// If the specified process is not the current process, attach</span>
04684     <span class="comment">// to the specified process.</span>
04685     <span class="comment">//</span>
04686 
04687     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;Pcb);
04688 
04689     <span class="comment">//</span>
04690     <span class="comment">// Map the NLS tables into the application's address space.</span>
04691     <span class="comment">//</span>
04692 
04693     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(
04694                 InitNlsSectionPointer,
04695                 TargetProcess,
04696                 &amp;ViewBase,
04697                 0L,
04698                 0L,
04699                 &amp;SectionOffset,
04700                 &amp;ViewSize,
04701                 ViewShare,
04702                 MEM_TOP_DOWN | SEC_NO_CHANGE,
04703                 PAGE_READONLY
04704                 );
04705 
04706     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04707         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04708         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(Status);
04709     }
04710 
04711     PebBase = (PPEB)<a class="code" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb</a> (TargetProcess,
04712                                       (ULONG)<span class="keyword">sizeof</span>( PEB ));
04713 
04714     <span class="comment">//</span>
04715     <span class="comment">// Initialize the Peb.</span>
04716     <span class="comment">//</span>
04717 
04718     PebBase-&gt;InheritedAddressSpace = InitialPeb-&gt;InheritedAddressSpace;
04719     PebBase-&gt;Mutant = InitialPeb-&gt;Mutant;
04720     PebBase-&gt;ImageBaseAddress = TargetProcess-&gt;SectionBaseAddress;
04721 
04722     PebBase-&gt;AnsiCodePageData = (PVOID)((PUCHAR)ViewBase+<a class="code" href="../../d8/d1/init_8h.html#a13">InitAnsiCodePageDataOffset</a>);
04723     PebBase-&gt;OemCodePageData = (PVOID)((PUCHAR)ViewBase+<a class="code" href="../../d8/d1/init_8h.html#a14">InitOemCodePageDataOffset</a>);
04724     PebBase-&gt;UnicodeCaseTableData = (PVOID)((PUCHAR)ViewBase+<a class="code" href="../../d8/d1/init_8h.html#a15">InitUnicodeCaseTableDataOffset</a>);
04725 
04726     PebBase-&gt;NumberOfProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
04727     PebBase-&gt;BeingDebugged = (BOOLEAN)(TargetProcess-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04728     PebBase-&gt;NtGlobalFlag = <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a>;
04729     PebBase-&gt;CriticalSectionTimeout = <a class="code" href="../../d4/d8/mi_8h.html#a423">MmCriticalSectionTimeout</a>;
04730     PebBase-&gt;HeapSegmentReserve = <a class="code" href="../../d8/d0/cmdat3_8c.html#a46">MmHeapSegmentReserve</a>;
04731     PebBase-&gt;HeapSegmentCommit = <a class="code" href="../../d8/d0/cmdat3_8c.html#a47">MmHeapSegmentCommit</a>;
04732     PebBase-&gt;HeapDeCommitTotalFreeThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a48">MmHeapDeCommitTotalFreeThreshold</a>;
04733     PebBase-&gt;HeapDeCommitFreeBlockThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a49">MmHeapDeCommitFreeBlockThreshold</a>;
04734     PebBase-&gt;NumberOfHeaps = 0;
04735     PebBase-&gt;MaximumNumberOfHeaps = (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>( PEB )) / <span class="keyword">sizeof</span>( PVOID );
04736     PebBase-&gt;ProcessHeaps = (PVOID *)(PebBase+1);
04737 
04738     PebBase-&gt;OSMajorVersion = <a class="code" href="../../d8/d1/init_8h.html#a5">NtMajorVersion</a>;
04739     PebBase-&gt;OSMinorVersion = <a class="code" href="../../d8/d1/init_8h.html#a6">NtMinorVersion</a>;
04740     PebBase-&gt;OSBuildNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &amp; 0x3FFF);
04741     PebBase-&gt;OSPlatformId = 2;      <span class="comment">// VER_PLATFORM_WIN32_NT from winbase.h</span>
04742     PebBase-&gt;OSCSDVersion = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d8/d1/init_8h.html#a7">CmNtCSDVersion</a>;
04743 
04744     <span class="comment">//</span>
04745     <span class="comment">// Every reference to NtHeaders (including the call to RtlImageNtHeader)</span>
04746     <span class="comment">// must be wrapped in try-except in case the inpage fails.  The inpage</span>
04747     <span class="comment">// can fail for any reason including network failures, low resources, etc.</span>
04748     <span class="comment">//</span>
04749 
04750     <span class="keywordflow">try</span> {
04751         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( PebBase-&gt;ImageBaseAddress );
04752         Magic = NtHeaders-&gt;OptionalHeader.Magic;
04753         Characteristics = NtHeaders-&gt;FileHeader.Characteristics;
04754     } except (EXCEPTION_EXECUTE_HANDLER) {
04755         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04756         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INVALID_IMAGE_PROTECT);
04757     }
04758 
04759     <span class="keywordflow">if</span> (NtHeaders != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04760     
04761         ProcessAffinityMask = 0;
04762 <span class="preprocessor">#if defined(_WIN64)</span>
04763 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
04764 
04765             <span class="comment">//</span>
04766             <span class="comment">// If this call fails, an exception will be thrown and the</span>
04767             <span class="comment">// detach performed so no need to handle errors here.</span>
04768             <span class="comment">//</span>
04769 
04770             MiInitializeWowPeb (NtHeaders, PebBase, TargetProcess);
04771 
04772         } <span class="keywordflow">else</span>      <span class="comment">// a PE32+ image</span>
04773 <span class="preprocessor">#endif</span>
04774 <span class="preprocessor"></span>        {
04775             <span class="keywordflow">try</span> {
04776                 ImageConfigData = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a> (
04777                                         PebBase-&gt;ImageBaseAddress,
04778                                         TRUE,
04779                                         IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG,
04780                                         &amp;ReturnedSize);
04781     
04782                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> ((PVOID)ImageConfigData,
04783                               <span class="keyword">sizeof</span> (*ImageConfigData),
04784                               <span class="keyword">sizeof</span> (ULONG));
04785 
04786                 <a class="code" href="../../d4/d5/procsup_8c.html#a4">MI_INIT_PEB_FROM_IMAGE</a>(NtHeaders, ImageConfigData);
04787 
04788                 <span class="keywordflow">if</span> (ImageConfigData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ImageConfigData-&gt;ProcessAffinityMask != 0) {
04789                     ProcessAffinityMask = ImageConfigData-&gt;ProcessAffinityMask;
04790                 }
04791 
04792             } except (EXCEPTION_EXECUTE_HANDLER) {
04793                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04794                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INVALID_IMAGE_PROTECT);
04795             }
04796 
04797         }
04798 
04799         <span class="comment">//</span>
04800         <span class="comment">// Note NT4 examined the NtHeaders-&gt;FileHeader.Characteristics</span>
04801         <span class="comment">// for the IMAGE_FILE_AGGRESIVE_WS_TRIM bit, but this is not needed</span>
04802         <span class="comment">// or used for NT5 and above.</span>
04803         <span class="comment">//</span>
04804 
04805         <span class="comment">//</span>
04806         <span class="comment">// See if image wants to override the default processor affinity mask.</span>
04807         <span class="comment">//</span>
04808 
04809         <span class="keywordflow">if</span> (Characteristics &amp; IMAGE_FILE_UP_SYSTEM_ONLY) {
04810 
04811             <span class="comment">//</span>
04812             <span class="comment">// Image is NOT MP safe.  Assign it a processor on a rotating</span>
04813             <span class="comment">// basis to spread these processes around on MP systems.</span>
04814             <span class="comment">//</span>
04815 
04816             <span class="keywordflow">do</span> {
04817                 PebBase-&gt;ImageProcessAffinityMask = (KAFFINITY)(0x1 &lt;&lt; <a class="code" href="../../d4/d5/procsup_8c.html#a15">MmRotatingUniprocessorNumber</a>);
04818                 <span class="keywordflow">if</span> (++<a class="code" href="../../d4/d5/procsup_8c.html#a15">MmRotatingUniprocessorNumber</a> &gt;= <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>) {
04819                     <a class="code" href="../../d4/d5/procsup_8c.html#a15">MmRotatingUniprocessorNumber</a> = 0;
04820                 }
04821             } <span class="keywordflow">while</span> ((PebBase-&gt;ImageProcessAffinityMask &amp; <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>) == 0);
04822         } <span class="keywordflow">else</span> {
04823 
04824             <span class="keywordflow">if</span> (ProcessAffinityMask != 0) {
04825 
04826                 <span class="comment">//</span>
04827                 <span class="comment">// Pass the affinity mask from the image header</span>
04828                 <span class="comment">// to LdrpInitializeProcess via the PEB.</span>
04829                 <span class="comment">//</span>
04830 
04831                 PebBase-&gt;ImageProcessAffinityMask = ProcessAffinityMask;
04832             }
04833         }
04834     }
04835 
04836     PebBase-&gt;SessionId = TargetProcess-&gt;SessionId;
04837 
04838     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04839     <span class="keywordflow">return</span> PebBase;
04840 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="procsup.c::MmCreateProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmCreateProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MinimumWorkingSetSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryTableBase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">190</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00207">CODE_END</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00205">CODE_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l00442">INITIALIZE_DIRECTORY_TABLE_BASE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00593">KSEG2_BASE</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00170">KSTACK_POOL_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00989">MI_INITIALIZE_HYPERSPACE_MAP</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01089">MI_PAGE_COLOR_PTE_PROCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01116">MI_PAGE_COLOR_VA_PROCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00808">MI_SET_GLOBAL_STATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01722">MiGetPdeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00171">MiNumberOfExtraSystemPdes</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02814">MiRemoveZeroPageIfAny</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00178">MiSessionAddProcess()</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00181">MiSystemCacheEndExtra</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00179">MiSystemCacheStartExtra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04263">MM_DBG_COMMIT_PROCESS_CREATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04301">MM_DBG_COMMIT_RETURN_PROCESS_CREATE_FAILURE1</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00116">MM_KSEG0_BASE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00042">MM_PROCESS_COMMIT_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00141">MM_SESSION_SPACE_DEFAULT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00146">MM_SYSTEM_CACHE_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00168">MM_SYSTEM_SPACE_END</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00135">MM_SYSTEM_SPACE_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00278">MM_VA_MAPPED_BY_PDE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00063">MmNonPagedSystemStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04921">MmProcessColorSeed</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00076">MmProcessCommit</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00050">MmSystemCacheEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00232">_EPROCESS::NextPageColor</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00166">NON_PAGED_SYSTEM_END</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00455">PTE_PER_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d7/d3/rtl_2random_8c-source.html#l00072">RtlRandom()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00056">ValidPdePde</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00198                    :
00199 
00200     This routine creates an address space which maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
00201     portion and contains a hyper space entry.
00202 
00203 Arguments:
00204 
00205     MinimumWorkingSetSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> working set size <span class="keywordflow">for</span>
00206                             <span class="keyword">this</span> address space.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used
00207                             to ensure that ample physical pages exist
00208                             to create <span class="keyword">this</span> process.
00209 
00210     NewProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object being created.
00211 
00212     DirectoryTableBase - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created
00213                          address space's Page <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> (PD) page and
00214                          hyper space page.
00215 
00216 Return Value:
00217 
00218     Returns TRUE if an address space was successfully created, FALSE
00219     if ample physical pages do not exist.
00220 
00221 Environment:
00222 
00223     Kernel mode.  APCs Disabled.
00224 
00225 --*/
00226 
00227 {
00228     PFN_NUMBER HyperDirectoryIndex;
00229     PFN_NUMBER PageDirectoryIndex;
00230     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00231     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00232     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00233     PFN_NUMBER HyperSpaceIndex;
00234     PFN_NUMBER PageContainingWorkingSet;
00235     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00236     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00237     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFillPte;
00238     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CurrentAddressSpacePde;
00239     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00240     KIRQL OldIrql;
00241     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00242     ULONG Color;
00243 <span class="preprocessor">#if defined (_X86PAE_)</span>
00244 <span class="preprocessor"></span>    ULONG TopQuad;
00245     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TopPte;
00246     PPAE_ENTRY PaeVa;
00247     PFN_NUMBER PageDirectoryIndex2;
00248     KIRQL OldIrql2;
00249     ULONG i;
00250     PFN_NUMBER HyperSpaceIndex2;
00251     PVOID PoolBlock;
00252 <span class="preprocessor">#endif</span>
00253 <span class="preprocessor"></span><span class="preprocessor">#if defined(_IA64_)</span>
00254 <span class="preprocessor"></span>    PFN_NUMBER SessionParentIndex;
00255 <span class="preprocessor">#endif</span>
00256 <span class="preprocessor"></span>
00257     <span class="comment">//</span>
00258     <span class="comment">// Get the PFN LOCK to prevent another thread in this</span>
00259     <span class="comment">// process from using hyper space and to get physical pages.</span>
00260     <span class="comment">//</span>
00261 
00262     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">// Charge commitment for the page directory pages, working set page table</span>
00266     <span class="comment">// page, and working set list.</span>
00267     <span class="comment">//</span>
00268 
00269     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (MM_PROCESS_COMMIT_CHARGE, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00270         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00271     }
00272 
00273     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_PROCESS_CREATE, MM_PROCESS_COMMIT_CHARGE);
00274 
00275     NewProcess-&gt;NextPageColor = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d8/d6/ttri_8c.html#a4">RtlRandom</a>(&amp;MmProcessColorSeed));
00276     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;NewProcess-&gt;HyperSpaceLock);
00277 
00278 <span class="preprocessor">#if defined (_X86PAE_)</span>
00279 <span class="preprocessor"></span>    TopQuad = MiPaeAllocate (&amp;PaeVa);
00280     <span class="keywordflow">if</span> (TopQuad == 0) {
00281         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (MM_PROCESS_COMMIT_CHARGE);
00282         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00283     }
00284 
00285     <span class="comment">//</span>
00286     <span class="comment">// This page must be in the first 4GB of RAM.</span>
00287     <span class="comment">//</span>
00288 
00289     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((TopQuad &gt;&gt; PAGE_SHIFT) &lt;= MM_HIGHEST_PAE_PAGE);
00290 <span class="preprocessor">#endif</span>
00291 <span class="preprocessor"></span>
00292     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00293 
00294     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// Check to make sure the physical pages are available.</span>
00298     <span class="comment">//</span>
00299 
00300     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt;= (SPFN_NUMBER)MinimumWorkingSetSize) {
00301 
00302 <span class="preprocessor">#if defined (_X86PAE_)</span>
00303 <span class="preprocessor"></span>        PoolBlock = MiPaeFree (PaeVa);
00304 <span class="preprocessor">#endif</span>
00305 <span class="preprocessor"></span>
00306         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00307         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00308         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (MM_PROCESS_COMMIT_CHARGE);
00309         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_PROCESS_CREATE_FAILURE1, MM_PROCESS_COMMIT_CHARGE);
00310 
00311 <span class="preprocessor">#if defined (_X86PAE_)</span>
00312 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PoolBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00313             MiPaeFreeEntirePage (PoolBlock);
00314         }
00315 <span class="preprocessor">#endif</span>
00316 <span class="preprocessor"></span>        <span class="comment">//</span>
00317         <span class="comment">// Indicate no directory base was allocated.</span>
00318         <span class="comment">//</span>
00319 
00320         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00321     }
00322 
00323     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= MinimumWorkingSetSize;
00324     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(6, MinimumWorkingSetSize);
00325     <a class="code" href="../../d8/d5/kddata_8c.html#a33">MmProcessCommit</a> += <a class="code" href="../../d4/d5/procsup_8c.html#a0">MM_PROCESS_COMMIT_CHARGE</a>;
00326 
00327     NewProcess-&gt;AddressSpaceInitialized = 1;
00328     NewProcess-&gt;Vm.MinimumWorkingSetSize = MinimumWorkingSetSize;
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">// Allocate a page directory (parent for 64-bit systems) page.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00335 
00336     Color =  <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (PDE_BASE,
00337                                         &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00338 
00339     PageDirectoryIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00340     <span class="keywordflow">if</span> (PageDirectoryIndex == 0) {
00341         PageDirectoryIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00342         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00343         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageDirectoryIndex, Color);
00344         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00345     }
00346 
00347 <span class="preprocessor">#if defined (_X86PAE_)</span>
00348 <span class="preprocessor"></span>    TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00349     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
00350 
00351     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
00352 
00353         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00354     
00355         Color =  <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (PDE_BASE,
00356                                             &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00357     
00358         PageDirectoryIndex2 = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00359         <span class="keywordflow">if</span> (PageDirectoryIndex2 == 0) {
00360             PageDirectoryIndex2 = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00361             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00362             <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageDirectoryIndex2, Color);
00363             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00364         }
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">// Recursively map each page directory page so it points to itself.</span>
00368         <span class="comment">//</span>
00369 
00370         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryIndex2;
00371         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageDirectoryIndex,
00372                                                     &amp;OldIrql2);
00373         PointerPte[i] = TempPte;
00374         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
00375         TopPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempPte.u.Long &amp; ~MM_PAE_PDPTE_MASK;
00376         PaeVa-&gt;PteEntry[i].u.Long = TopPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00377     }
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// Recursively map the topmost page directory page so it points to itself.</span>
00381     <span class="comment">//</span>
00382 
00383     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryIndex;
00384     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageDirectoryIndex, &amp;OldIrql2);
00385     PointerPte[PD_PER_SYSTEM - 1] = TempPte;
00386     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
00387     TopPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempPte.u.Long &amp; ~MM_PAE_PDPTE_MASK;
00388     PaeVa-&gt;PteEntry[PD_PER_SYSTEM - 1].u.Long = TopPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00389     NewProcess-&gt;PaePageDirectoryPage = PageDirectoryIndex;
00390     NewProcess-&gt;PaeTop = (PVOID)PaeVa;
00391     DirectoryTableBase[0] = TopQuad;
00392 <span class="preprocessor">#else</span>
00393 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a>(&amp;DirectoryTableBase[0], PageDirectoryIndex);
00394 <span class="preprocessor">#endif</span>
00395 <span class="preprocessor"></span>
00396 <span class="preprocessor">#if defined (_WIN64)</span>
00397 <span class="preprocessor"></span>
00398     PointerPpe = KSEG_ADDRESS (PageDirectoryIndex);
00399     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// Map the top level page directory parent page recursively onto itself.</span>
00403     <span class="comment">//</span>
00404 
00405     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryIndex;
00406 
00407 <span class="preprocessor">#if defined (_AXP64_)</span>
00408 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.Global == 0);
00409     PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(PDE_TBASE)] = TempPte;
00410 <span class="preprocessor">#endif</span>
00411 <span class="preprocessor"></span>
00412 <span class="preprocessor">#if defined(_IA64_)</span>
00413 <span class="preprocessor"></span>
00414     <span class="comment">//</span>
00415     <span class="comment">// For IA64, the self-mapped entry is forced to be the last entry of</span>
00416     <span class="comment">// PPE table.</span>
00417     <span class="comment">//</span>
00418 
00419     PointerPpe[(PDE_SELFMAP &amp;
00420                 ((<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)*<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>) - 1))/<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)] = TempPte;
00421 
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>
00424     <span class="comment">//</span>
00425     <span class="comment">// Allocate the page directory for hyper space and map this directory</span>
00426     <span class="comment">// page into the page directory parent page.</span>
00427     <span class="comment">//</span>
00428 
00429     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00430 
00431     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(HYPER_SPACE),
00432                                        &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00433 
00434     HyperDirectoryIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00435     <span class="keywordflow">if</span> (HyperDirectoryIndex == 0) {
00436         HyperDirectoryIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00437         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00438         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (HyperDirectoryIndex, Color);
00439         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00440     }
00441 
00442     TempPte.u.Hard.PageFrameNumber = HyperDirectoryIndex;
00443     PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(HYPER_SPACE)] = TempPte;
00444 
00445 <span class="preprocessor">#if defined (_IA64_)</span>
00446 <span class="preprocessor"></span>
00447     <span class="comment">//</span>
00448     <span class="comment">// Allocate the page directory parent for the session space</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00452 
00453     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(SESSION_SPACE_DEFAULT),
00454                                        &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00455 
00456     SessionParentIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00457     <span class="keywordflow">if</span> (SessionParentIndex == 0) {
00458         SessionParentIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00459         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00460         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (SessionParentIndex, Color);
00461         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00462     }
00463 
00464     <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a>(&amp;NewProcess-&gt;Pcb.SessionParentBase, SessionParentIndex);
00465 
00466     PointerPpe = KSEG_ADDRESS (SessionParentIndex);
00467 
00468     TempPte.u.Hard.PageFrameNumber = SessionParentIndex;
00469 
00470     PointerPpe[(PDE_SSELFMAP &amp;
00471                 ((<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)*<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>) - 1))/<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)] = TempPte;
00472 
00473 <span class="preprocessor">#endif // _IA64_</span>
00474 <span class="preprocessor"></span>
00475 <span class="preprocessor">#endif</span>
00476 <span class="preprocessor"></span>
00477     <span class="comment">//</span>
00478     <span class="comment">// Allocate the hyper space page table page.</span>
00479     <span class="comment">//</span>
00480 
00481     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00482 
00483     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(HYPER_SPACE),
00484                                        &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00485 
00486     HyperSpaceIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00487     <span class="keywordflow">if</span> (HyperSpaceIndex == 0) {
00488         HyperSpaceIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00489         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00490         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (HyperSpaceIndex, Color);
00491         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00492     }
00493 
00494 <span class="preprocessor">#if defined (_WIN64)</span>
00495 <span class="preprocessor"></span>    PointerPde = KSEG_ADDRESS (HyperDirectoryIndex);
00496     TempPte.u.Hard.PageFrameNumber = HyperSpaceIndex;
00497     PointerPde[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE)] = TempPte;
00498 <span class="preprocessor">#endif</span>
00499 <span class="preprocessor"></span>
00500 <span class="preprocessor">#if defined (_X86PAE_)</span>
00501 <span class="preprocessor"></span>
00502     <span class="comment">//</span>
00503     <span class="comment">// Allocate the second hyper space page table page.</span>
00504     <span class="comment">// Save it in the first PTE used by the first hyperspace PDE.</span>
00505     <span class="comment">//</span>
00506 
00507     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00508 
00509     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(HYPER_SPACE2),
00510                                        &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00511 
00512     HyperSpaceIndex2 = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00513     <span class="keywordflow">if</span> (HyperSpaceIndex2 == 0) {
00514         HyperSpaceIndex2 = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00515         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00516         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (HyperSpaceIndex2, Color);
00517         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00518     }
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">// Unlike DirectoryTableBase[0], the HyperSpaceIndex is stored as an</span>
00522     <span class="comment">// absolute PFN and does not need to be below 4GB.</span>
00523     <span class="comment">//</span>
00524 
00525     DirectoryTableBase[1] = HyperSpaceIndex;
00526 <span class="preprocessor">#else</span>
00527 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a>(&amp;DirectoryTableBase[1], HyperSpaceIndex);
00528 <span class="preprocessor">#endif</span>
00529 <span class="preprocessor"></span>
00530     <span class="comment">//</span>
00531     <span class="comment">// Remove page for the working set list.</span>
00532     <span class="comment">//</span>
00533 
00534     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00535 
00536     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a128">MI_PAGE_COLOR_VA_PROCESS</a> (MmWorkingSetList,
00537                                       &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00538 
00539     PageContainingWorkingSet = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00540     <span class="keywordflow">if</span> (PageContainingWorkingSet == 0) {
00541         PageContainingWorkingSet = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00542         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00543         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageContainingWorkingSet, Color);
00544         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00545     }
00546 
00547     <span class="comment">//</span>
00548     <span class="comment">// Release the PFN mutex as the needed pages have been allocated.</span>
00549     <span class="comment">//</span>
00550 
00551     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00552 
00553     NewProcess-&gt;WorkingSetPage = PageContainingWorkingSet;
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Initialize the page reserved for hyper space.</span>
00557     <span class="comment">//</span>
00558 
00559     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a123">MI_INITIALIZE_HYPERSPACE_MAP</a> (HyperSpaceIndex);
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Set the PTE address in the PFN for the top level page directory page.</span>
00563     <span class="comment">//</span>
00564 
00565 <span class="preprocessor">#if defined (_WIN64)</span>
00566 <span class="preprocessor"></span>
00567     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryIndex);
00568 
00569     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == 0);
00570 
00571     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
00572 
00573     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_TBASE);
00574 
00575     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
00576 
00577     <span class="comment">//</span>
00578     <span class="comment">// Set the PTE address in the PFN for the hyper space page directory page.</span>
00579     <span class="comment">//</span>
00580 
00581     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HyperDirectoryIndex);
00582 
00583     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == 0);
00584 
00585     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
00586 
00587     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(HYPER_SPACE);
00588 
00589     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
00590 
00591 <span class="preprocessor">#if defined (_AXP64_)</span>
00592 <span class="preprocessor"></span>
00593     <span class="comment">//</span>
00594     <span class="comment">// All of the system mappings are global.</span>
00595     <span class="comment">//</span>
00596 
00597     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 1);
00598 
00599     PointerFillPte = &amp;PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MM_SYSTEM_SPACE_START)];
00600     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SYSTEM_SPACE_START);
00601     RtlCopyMemory (PointerFillPte,
00602                    CurrentAddressSpacePde,
00603                    ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SYSTEM_SPACE_END) -
00604                       <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SYSTEM_SPACE_START))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)));
00605     <span class="comment">//</span>
00606     <span class="comment">// Session space and win32k.sys are local on Hydra configurations.</span>
00607     <span class="comment">// However, as an optimization, it can be made global on non-Hydra.</span>
00608     <span class="comment">//</span>
00609 
00610     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00611         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
00612     }
00613 
00614     PointerFillPte = &amp;PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MM_SESSION_SPACE_DEFAULT)];
00615     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SESSION_SPACE_DEFAULT);
00616     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00617 
00618 <span class="preprocessor">#endif</span>
00619 <span class="preprocessor"></span>
00620 <span class="preprocessor">#if defined(_IA64_)</span>
00621 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession != 0)) {
00622         PointerPpe = KSEG_ADDRESS(SessionParentIndex);
00623         PointerFillPte = &amp;PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MM_SESSION_SPACE_DEFAULT)];
00624         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SESSION_SPACE_DEFAULT);
00625         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00626     }
00627 <span class="preprocessor">#endif</span>
00628 <span class="preprocessor"></span>
00629 <span class="preprocessor">#else // the following is for !WIN64 only</span>
00630 <span class="preprocessor"></span>
00631 <span class="preprocessor">#if defined (_X86PAE_)</span>
00632 <span class="preprocessor"></span>
00633     <span class="comment">//</span>
00634     <span class="comment">// Stash the second hyperspace PDE in the first PTE for the initial</span>
00635     <span class="comment">// hyperspace entry.</span>
00636     <span class="comment">//</span>
00637 
00638     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00639     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = HyperSpaceIndex2;
00640     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
00641 
00642     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HyperSpaceIndex, &amp;OldIrql2);
00643     PointerPte[0] = TempPte;
00644     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
00645 
00646 <span class="preprocessor">#endif</span>
00647 <span class="preprocessor"></span>
00648     <span class="comment">//</span>
00649     <span class="comment">// Set the PTE address in the PFN for the page directory page.</span>
00650     <span class="comment">//</span>
00651 
00652     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryIndex);
00653 
00654     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == 0);
00655 
00656     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
00657 
00658     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)PDE_BASE;
00659 
00660     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
00661 
00662     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00663     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = HyperSpaceIndex;
00664     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
00665 
00666     <span class="comment">//</span>
00667     <span class="comment">// Map the page directory page in hyperspace.</span>
00668     <span class="comment">// Note for PAE, this is the high 1GB virtual only.</span>
00669     <span class="comment">//</span>
00670 
00671     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageDirectoryIndex, &amp;OldIrql);
00672     PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE)] = TempPte;
00673 
00674 <span class="preprocessor">#if defined (_X86PAE_)</span>
00675 <span class="preprocessor"></span>
00676     <span class="comment">//</span>
00677     <span class="comment">// Map in the second hyperspace page directory.</span>
00678     <span class="comment">// The page directory page is already recursively mapped.</span>
00679     <span class="comment">//</span>
00680 
00681     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = HyperSpaceIndex2;
00682     PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE2)] = TempPte;
00683 
00684 <span class="preprocessor">#else</span>
00685 <span class="preprocessor"></span>
00686     <span class="comment">//</span>
00687     <span class="comment">// Recursively map the page directory page so it points to itself.</span>
00688     <span class="comment">//</span>
00689 
00690     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryIndex;
00691     PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PTE_BASE)] = TempPte;
00692 
00693 <span class="preprocessor">#endif</span>
00694 <span class="preprocessor"></span>
00695     <span class="comment">//</span>
00696     <span class="comment">// Map in the non paged portion of the system.</span>
00697     <span class="comment">//</span>
00698 
00699 <span class="preprocessor">#if defined(_ALPHA_)</span>
00700 <span class="preprocessor"></span>
00701     PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MM_SYSTEM_SPACE_START)];
00702     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_SYSTEM_SPACE_START);
00703     RtlCopyMemory (PointerFillPte,
00704                    CurrentAddressSpacePde,
00705                    ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_SYSTEM_SPACE_END) -
00706                       <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_SYSTEM_SPACE_START))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)));
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// KSEG0 is identity-mapped on the Alpha.  Copy the PDEs for this region.</span>
00710     <span class="comment">//</span>
00711 
00712     PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MM_KSEG0_BASE)];
00713     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_KSEG0_BASE);
00714     RtlCopyMemory (PointerFillPte,
00715                    CurrentAddressSpacePde,
00716                    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(KSEG2_BASE-KSEG0_BASE) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00717 
00718 <span class="preprocessor">#else // the following is for x86 only</span>
00719 <span class="preprocessor"></span>
00720     <span class="comment">//</span>
00721     <span class="comment">// If the system has not been loaded at a biased address, then system PDEs</span>
00722     <span class="comment">// exist in the 2gb-&gt;3gb range which must be copied.</span>
00723     <span class="comment">//</span>
00724 
00725 <span class="preprocessor">#if defined (_X86PAE_)</span>
00726 <span class="preprocessor"></span>
00727     <span class="comment">//</span>
00728     <span class="comment">// For the PAE case, only the last page directory is currently mapped, so</span>
00729     <span class="comment">// only copy the system PDEs for the last 1GB - any that need copying in</span>
00730     <span class="comment">// the 2gb-&gt;3gb range will be done a little later.</span>
00731     <span class="comment">//</span>
00732 
00733     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
00734         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(CODE_START + MmVirtualBias)];
00735         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(CODE_START + MmVirtualBias);
00736     
00737         RtlCopyMemory (PointerFillPte,
00738                        CurrentAddressSpacePde,
00739                        (((1 + CODE_END) - CODE_START) / MM_VA_MAPPED_BY_PDE) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00740     }
00741 <span class="preprocessor">#else</span>
00742 <span class="preprocessor"></span>    PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(CODE_START + MmVirtualBias)];
00743     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(CODE_START + MmVirtualBias);
00744 
00745     RtlCopyMemory (PointerFillPte,
00746                    CurrentAddressSpacePde,
00747                    (((1 + CODE_END) - CODE_START) / MM_VA_MAPPED_BY_PDE) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00748 <span class="preprocessor">#endif</span>
00749 <span class="preprocessor"></span>
00750     LastPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(NON_PAGED_SYSTEM_END)];
00751     PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmNonPagedSystemStart)];
00752     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmNonPagedSystemStart);
00753 
00754     RtlCopyMemory (PointerFillPte,
00755                    CurrentAddressSpacePde,
00756                    ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(NON_PAGED_SYSTEM_END) -
00757                       CurrentAddressSpacePde))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Map in the system cache page table pages.</span>
00761     <span class="comment">//</span>
00762 
00763     LastPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmSystemCacheEnd)];
00764     PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MM_SYSTEM_CACHE_WORKING_SET)];
00765     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_SYSTEM_CACHE_WORKING_SET);
00766 
00767     RtlCopyMemory (PointerFillPte,
00768                    CurrentAddressSpacePde,
00769                    ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmSystemCacheEnd) -
00770                       CurrentAddressSpacePde))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00771 
00772 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00773 <span class="preprocessor"></span>    <span class="comment">//</span>
00774     <span class="comment">// Map in any additional system cache page table pages.</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> != <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>) {
00778         LastPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MiSystemCacheEndExtra)];
00779         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MiSystemCacheStartExtra)];
00780         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheStartExtra);
00781 
00782         RtlCopyMemory (PointerFillPte,
00783                        CurrentAddressSpacePde,
00784                        ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheEndExtra) -
00785                           CurrentAddressSpacePde))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00786     }
00787 <span class="preprocessor">#endif</span>
00788 <span class="preprocessor"></span>
00789 <span class="preprocessor">#endif      // end of x86 specific else</span>
00790 <span class="preprocessor"></span>
00791 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00792 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00793 
00794         <span class="comment">//</span>
00795         <span class="comment">// Copy the bootstrap entry for session space.</span>
00796         <span class="comment">// The rest is faulted in as needed.</span>
00797         <span class="comment">//</span>
00798 
00799         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmSessionSpace)];
00800         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmSessionSpace);
00801         <span class="keywordflow">if</span> (CurrentAddressSpacePde-&gt;u.Hard.Valid == 1) {
00802             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00803         }
00804         <span class="keywordflow">else</span> {
00805             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00806         }
00807     }
00808 <span class="preprocessor">#endif</span>
00809 <span class="preprocessor"></span>
00810 <span class="preprocessor">#if defined(_X86_)</span>
00811 <span class="preprocessor"></span>
00812     <span class="comment">//</span>
00813     <span class="comment">// Map in the additional system PTE range if present.</span>
00814     <span class="comment">//</span>
00815 
00816 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00817 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a>) {
00818 
00819         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(KSTACK_POOL_START)];
00820         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(KSTACK_POOL_START);
00821 
00822         RtlCopyMemory (PointerFillPte,
00823                        CurrentAddressSpacePde,
00824                        MiNumberOfExtraSystemPdes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00825     }
00826 <span class="preprocessor">#endif</span>
00827 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00828 <span class="preprocessor"></span>
00829     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
00830 
00831 <span class="preprocessor">#if defined (_X86PAE_)</span>
00832 <span class="preprocessor"></span>
00833     <span class="comment">//</span>
00834     <span class="comment">// Map all the virtual space in the 2GB-&gt;3GB range when it's not user space.</span>
00835     <span class="comment">//</span>
00836 
00837     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0) {
00838 
00839         PageDirectoryIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PaeVa-&gt;PteEntry[PD_PER_SYSTEM - 2]);
00840     
00841         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageDirectoryIndex, &amp;OldIrql);
00842     
00843         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(CODE_START)];
00844         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(CODE_START);
00845     
00846         RtlCopyMemory (PointerFillPte,
00847                        CurrentAddressSpacePde,
00848                        (((1 + CODE_END) - CODE_START) / MM_VA_MAPPED_BY_PDE) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00849     
00850         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> != <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>) {
00851             LastPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MiSystemCacheEndExtra)];
00852             PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MiSystemCacheStartExtra)];
00853             CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheStartExtra);
00854     
00855             RtlCopyMemory (PointerFillPte,
00856                            CurrentAddressSpacePde,
00857                            ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheEndExtra) -
00858                               CurrentAddressSpacePde))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00859         }
00860     
00861         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00862     
00863             <span class="comment">//</span>
00864             <span class="comment">// Copy the bootstrap entry for session space.</span>
00865             <span class="comment">// The rest is faulted in as needed.</span>
00866             <span class="comment">//</span>
00867     
00868             PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmSessionSpace)];
00869             CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmSessionSpace);
00870             <span class="keywordflow">if</span> (CurrentAddressSpacePde-&gt;u.Hard.Valid == 1) {
00871                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00872             }
00873             <span class="keywordflow">else</span> {
00874                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00875             }
00876         }
00877     
00878         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a>) {
00879     
00880             PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(KSTACK_POOL_START)];
00881             CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(KSTACK_POOL_START);
00882     
00883             RtlCopyMemory (PointerFillPte,
00884                            CurrentAddressSpacePde,
00885                            MiNumberOfExtraSystemPdes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00886         }
00887         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
00888     }
00889 <span class="preprocessor">#endif</span>
00890 <span class="preprocessor"></span>
00891 <span class="preprocessor">#endif  // end of !WIN64 specific else</span>
00892 <span class="preprocessor"></span>
00893     <span class="comment">//</span>
00894     <span class="comment">// Up the session space reference count.</span>
00895     <span class="comment">//</span>
00896 
00897     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00898         <a class="code" href="../../d3/d7/session_8c.html#a5">MiSessionAddProcess</a> (NewProcess);
00899     }
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">// Release working set mutex and lower IRQL.</span>
00903     <span class="comment">//</span>
00904 
00905     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00906 
00907     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00908 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="procsup.c::MmCreateTeb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PTEB MmCreateTeb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PINITIAL_TEB&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialTeb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCLIENT_ID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04314">4314</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d6/d0/mminit_8c-source.html#l00034">BBTBuffer</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00134">InitialTeb</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.
<p>
<pre class="fragment"><div>04322                    :
04323 
04324     This routine creates a TEB page within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process
04325     and copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial TEB values into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
04326 
04327 Arguments:
04328 
04329     TargetProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which to create
04330                     and initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TEB.
04331 
04332     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial TEB to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04333                  newly created TEB.
04334 
04335 Return Value:
04336 
04337     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created TEB.
04338 
04339     Can raise exceptions <span class="keywordflow">if</span> no address space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TEB or
04340     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user has exceeded quota (non-paged, pagefile, commit).
04341 
04342 Environment:
04343 
04344     Kernel mode.
04345 
04346 --*/
04347 
04348 {
04349     PTEB TebBase;
04350 
04351     <span class="comment">//</span>
04352     <span class="comment">// If the specified process is not the current process, attach</span>
04353     <span class="comment">// to the specified process.</span>
04354     <span class="comment">//</span>
04355 
04356     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;Pcb);
04357 
04358     TebBase = (PTEB)<a class="code" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb</a> (TargetProcess,
04359                                       (ULONG)<span class="keyword">sizeof</span>(TEB));
04360 
04361     <span class="comment">//</span>
04362     <span class="comment">// Initialize the TEB.</span>
04363     <span class="comment">//</span>
04364 
04365 <span class="preprocessor">#if defined(_WIN64)</span>
04366 <span class="preprocessor"></span>    TebBase-&gt;NtTib.ExceptionList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04367 <span class="preprocessor">#else</span>
04368 <span class="preprocessor"></span>    TebBase-&gt;NtTib.ExceptionList = EXCEPTION_CHAIN_END;
04369 <span class="preprocessor">#endif</span>
04370 <span class="preprocessor"></span>
04371     TebBase-&gt;NtTib.SubSystemTib = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04372     TebBase-&gt;NtTib.Version = OS2_VERSION;
04373     TebBase-&gt;NtTib.ArbitraryUserPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04374     TebBase-&gt;NtTib.Self = (PNT_TIB)TebBase;
04375     TebBase-&gt;EnvironmentPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04376     TebBase-&gt;ProcessEnvironmentBlock = TargetProcess-&gt;Peb;
04377     TebBase-&gt;ClientId = *ClientId;
04378     TebBase-&gt;RealClientId = *ClientId;
04379 
04380     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
04381         (<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackLimit == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04382 
04383         TebBase-&gt;NtTib.StackBase = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase;
04384         TebBase-&gt;NtTib.StackLimit = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit;
04385         TebBase-&gt;DeallocationStack = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackAllocationBase;
04386 
04387 <span class="preprocessor">#if defined(_IA64_)</span>
04388 <span class="preprocessor"></span>        TebBase-&gt;BStoreLimit = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit;
04389         TebBase-&gt;DeallocationBStore = (PCHAR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase
04390              + ((ULONG_PTR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase - (ULONG_PTR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackAllocationBase);
04391 <span class="preprocessor">#endif</span>
04392 <span class="preprocessor"></span>
04393     }
04394     <span class="keywordflow">else</span> {
04395         TebBase-&gt;NtTib.StackBase = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackBase;
04396         TebBase-&gt;NtTib.StackLimit = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackLimit;
04397     }
04398 
04399     TebBase-&gt;StaticUnicodeString.Buffer = TebBase-&gt;StaticUnicodeBuffer;
04400     TebBase-&gt;StaticUnicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( TebBase-&gt;StaticUnicodeBuffer );
04401     TebBase-&gt;StaticUnicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0;
04402 
04403     <span class="comment">//</span>
04404     <span class="comment">// Used for BBT of ntdll and kernel32.dll.</span>
04405     <span class="comment">//</span>
04406 
04407     TebBase-&gt;ReservedForPerf = <a class="code" href="../../d5/d1/mminit_8c.html#a12">BBTBuffer</a>;
04408 
04409     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04410     <span class="keywordflow">return</span> TebBase;
04411 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="procsup.c::MmDeleteKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmDeleteKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerKernelStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LargeStack</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">2723</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04306">MM_DBG_COMMIT_RETURN_KERNEL_STACK_DELETE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00446">MM_STACK_ALIGNMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04798">MmFirstDeadKernelStack</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00096">MmKernelStackPages</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00098">MmLargeStacks</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04797">MmMaximumDeadKernelStacks</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04796">MmNumberDeadKernelStacks</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00076">MmProcessCommit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00099">MmSmallStacks</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02162">PERFINFO_DELETE_STACK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/i386_2allproc_8c-source.html#l00075">KeStartAllProcessors()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00057">PspReaper()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01438">PspThreadDelete()</a>.
<p>
<pre class="fragment"><div>02730                    :
02731 
02732     This routine deletes a kernel stack and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> no-access page within
02733     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-pagable portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
02734 
02735 Arguments:
02736 
02737     PointerKernelStack - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack.
02738 
02739     LargeStack - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a large stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being deleted.
02740                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> a small stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be deleted.
02741 
02742 Return Value:
02743 
02744     None.
02745 
02746 Environment:
02747 
02748     Kernel mode.  APCs Disabled.
02749 
02750 --*/
02751 
02752 {
02753     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02754     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02755     PFN_NUMBER NumberOfPages;
02756     ULONG NumberOfPtes;
02757     PFN_NUMBER PageFrameIndex;
02758     ULONG i;
02759     KIRQL OldIrql;
02760     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02761 
02762     <span class="keywordflow">if</span> (LargeStack) {
02763 <span class="preprocessor">#if defined(_IA64_)</span>
02764 <span class="preprocessor"></span>        NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_SIZE + KERNEL_LARGE_BSTORE_SIZE);
02765 <span class="preprocessor">#else</span>
02766 <span class="preprocessor"></span>        NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_SIZE);
02767 <span class="preprocessor">#endif</span>
02768 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
02769 <span class="preprocessor">#if defined(_IA64_)</span>
02770 <span class="preprocessor"></span>        NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_STACK_SIZE + KERNEL_BSTORE_SIZE);
02771 <span class="preprocessor">#else</span>
02772 <span class="preprocessor"></span>        NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_STACK_SIZE);
02773 <span class="preprocessor">#endif</span>
02774 <span class="preprocessor"></span>    }
02775 
02776     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerKernelStack);
02777 
02778     <span class="comment">//</span>
02779     <span class="comment">// PointerPte points to the guard page, point to the previous</span>
02780     <span class="comment">// page before removing physical pages.</span>
02781     <span class="comment">//</span>
02782 
02783     PointerPte -= 1;
02784 
02785     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02786 
02787     <span class="comment">//</span>
02788     <span class="comment">// Check to see if the stack page should be placed on the dead</span>
02789     <span class="comment">// kernel stack page list.  The dead kernel stack list is a</span>
02790     <span class="comment">// singly linked list of kernel stacks from terminated threads.</span>
02791     <span class="comment">// The stacks are saved on a linked list up to a maximum number</span>
02792     <span class="comment">// to avoid the overhead of flushing the entire TB on all processors</span>
02793     <span class="comment">// everytime a thread terminates.  The TB on all processors must</span>
02794     <span class="comment">// be flushed as kernel stacks reside in the non paged system part</span>
02795     <span class="comment">// of the address space.</span>
02796     <span class="comment">//</span>
02797 
02798     <span class="keywordflow">if</span> ((!LargeStack) &amp;&amp;
02799         (<a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a>)) {
02800 
02801         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02802 
02803 <span class="preprocessor">#if DBG</span>
02804 <span class="preprocessor"></span>        {
02805             ULONG i = <a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a>;
02806             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnList = <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a>;
02807 
02808             <span class="keywordflow">while</span> (i &gt; 0) {
02809                 i--;
02810                 <span class="keywordflow">if</span> ((PfnList != MmKstacks[i].Pfn) ||
02811                    (PfnList-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> != MmKstacks[i].Pte))  {
02812                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MMPROCSUP: kstacks %p %ld. %p\n"</span>,
02813                        PfnList, i, MmKstacks[i].Pfn);
02814                    DbgBreakPoint();
02815                 }
02816                 PfnList = PfnList-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.NextStackPfn;
02817             }
02818             MmKstacks[<a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a>].Pte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
02819             MmKstacks[<a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a>].Pfn = Pfn1;
02820         }
02821 <span class="preprocessor">#endif //DBG</span>
02822 <span class="preprocessor"></span>
02823         <a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a> += 1;
02824         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.NextStackPfn = <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a>;
02825         <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a> = Pfn1;
02826 
02827         <a class="code" href="../../d2/d1/mm_8h.html#a41">PERFINFO_DELETE_STACK</a>(PointerPte, NumberOfPtes);
02828 
02829         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02830 
02831         <span class="keywordflow">return</span>;
02832     }
02833 
02834 <span class="preprocessor">#if defined(_IA64_)</span>
02835 <span class="preprocessor"></span>
02836     <span class="comment">//</span>
02837     <span class="comment">// Since PointerKernelStack points to the center of the stack space,</span>
02838     <span class="comment">// the size of kernel backing store needs to be added to get the</span>
02839     <span class="comment">// top of the stack space.</span>
02840     <span class="comment">//</span>
02841 
02842     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (LargeStack ?
02843                   (PCHAR)PointerKernelStack+KERNEL_LARGE_BSTORE_SIZE :
02844                   (PCHAR)PointerKernelStack+KERNEL_BSTORE_SIZE);
02845 
02846     <span class="comment">//</span>
02847     <span class="comment">// PointerPte points to the guard page, point to the previous</span>
02848     <span class="comment">// page before removing physical pages.</span>
02849     <span class="comment">//</span>
02850 
02851     PointerPte -= 1;
02852 
02853 <span class="preprocessor">#endif</span>
02854 <span class="preprocessor"></span>
02855     <span class="comment">//</span>
02856     <span class="comment">// We have exceeded the limit of dead kernel stacks or this is a large</span>
02857     <span class="comment">// stack, delete this kernel stack.</span>
02858     <span class="comment">//</span>
02859 
02860     NumberOfPages = 0;
02861     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
02862 
02863         PteContents = *PointerPte;
02864 
02865         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02866             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
02867             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02868             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
02869 
02870             <span class="comment">//</span>
02871             <span class="comment">// Set the pointer to PTE as empty so the page</span>
02872             <span class="comment">// is deleted when the reference count goes to zero.</span>
02873             <span class="comment">//</span>
02874 
02875             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02876             <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (MI_GET_PAGE_FRAME_FROM_PTE (&amp;PteContents));
02877             NumberOfPages += 1;
02878         }
02879         PointerPte -= 1;
02880     }
02881 
02882 <span class="preprocessor">#if defined(_IA64_)</span>
02883 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/procsup_8c.html#a10">MmKernelStackPages</a>  -= NumberOfPtes + 2 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a100">MM_STACK_ALIGNMENT</a>?1:0);
02884 
02885     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
02886                          NumberOfPtes + 2 + (MM_STACK_ALIGNMENT?1:0),
02887                          SystemPteSpace);
02888 <span class="preprocessor">#else</span>
02889 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/procsup_8c.html#a10">MmKernelStackPages</a>  -= NumberOfPtes + 1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a100">MM_STACK_ALIGNMENT</a>?1:0);
02890 
02891     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
02892                          NumberOfPtes + 1 + (MM_STACK_ALIGNMENT?1:0),
02893                          SystemPteSpace);
02894 <span class="preprocessor">#endif</span>
02895 <span class="preprocessor"></span>
02896     <span class="comment">//</span>
02897     <span class="comment">// Update the count of available resident pages.</span>
02898     <span class="comment">//</span>
02899 
02900     <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> -= NumberOfPages;
02901     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
02902     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(10, NumberOfPages);
02903     <a class="code" href="../../d8/d5/kddata_8c.html#a33">MmProcessCommit</a> -= NumberOfPtes;
02904 
02905     <a class="code" href="../../d4/d5/procsup_8c.html#a12">MmLargeStacks</a> -= LargeStack;
02906     <a class="code" href="../../d4/d5/procsup_8c.html#a13">MmSmallStacks</a> -= !LargeStack;
02907     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02908 
02909     <span class="comment">//</span>
02910     <span class="comment">// Return commitment.</span>
02911     <span class="comment">//</span>
02912 
02913     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPtes);
02914     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_KERNEL_STACK_DELETE, NumberOfPtes);
02915 
02916     <span class="keywordflow">return</span>;
02917 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="procsup.c::MmDeleteProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmDeleteProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l01398">1398</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05898">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01864">MiContractPagingFiles()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04302">MM_DBG_COMMIT_RETURN_PROCESS_DELETE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00042">MM_PROCESS_COMMIT_CHARGE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00043">MM_PROCESS_CREATE_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00076">MmProcessCommit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>01404                    :
01405 
01406     This routine deletes a process's Page <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> and working set page.
01407 
01408 Arguments:
01409 
01410     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> deleted process.
01411 
01412 Return Value:
01413 
01414     None.
01415 
01416 Environment:
01417 
01418     Kernel mode.  APCs Disabled.
01419 
01420 --*/
01421 
01422 {
01423     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01424     KIRQL OldIrql;
01425     PFN_NUMBER PageFrameIndex;
01426     PFN_NUMBER PageFrameIndex2;
01427 <span class="preprocessor">#if defined (_WIN64)</span>
01428 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryParent;
01429     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Ppe;
01430 <span class="preprocessor">#endif</span>
01431 <span class="preprocessor"></span><span class="preprocessor">#if defined (_X86PAE_)</span>
01432 <span class="preprocessor"></span>    ULONG i;
01433     KIRQL OldIrql2;
01434     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01435     PVOID PoolBlock;
01436     PFN_NUMBER PageDirectories[PD_PER_SYSTEM];
01437 
01438     PoolBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01439 <span class="preprocessor">#endif</span>
01440 <span class="preprocessor"></span>
01441     <span class="comment">//</span>
01442     <span class="comment">// Return commitment.</span>
01443     <span class="comment">//</span>
01444 
01445     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (MM_PROCESS_COMMIT_CHARGE);
01446     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_PROCESS_DELETE, MM_PROCESS_COMMIT_CHARGE);
01447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;CommitCharge == 0);
01448 
01449     <span class="comment">//</span>
01450     <span class="comment">// Remove the working set list page from the deleted process.</span>
01451     <span class="comment">//</span>
01452 
01453     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Process-&gt;WorkingSetPage);
01454 
01455     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01456     <a class="code" href="../../d8/d5/kddata_8c.html#a33">MmProcessCommit</a> -= <a class="code" href="../../d4/d5/procsup_8c.html#a0">MM_PROCESS_COMMIT_CHARGE</a>;
01457 
01458     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceInitialized == 2) {
01459 
01460         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01461 
01462         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01463         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (Process-&gt;WorkingSetPage);
01464 
01465         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01466 
01467         <span class="comment">//</span>
01468         <span class="comment">// Remove the hyper space page table page from the deleted process.</span>
01469         <span class="comment">//</span>
01470 
01471 <span class="preprocessor">#if defined (_X86PAE_)</span>
01472 <span class="preprocessor"></span>
01473         PageFrameIndex = (PFN_NUMBER)Process-&gt;Pcb.DirectoryTableBase[1];
01474         <span class="comment">//</span>
01475         <span class="comment">// Remove the second hyper space page table page.</span>
01476         <span class="comment">//</span>
01477 
01478         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01479         PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
01480         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01481 
01482         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex2);
01483 
01484         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01485 
01486         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01487         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex2);
01488 
01489         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01490 <span class="preprocessor">#else</span>
01491 <span class="preprocessor"></span>        PageFrameIndex =
01492             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.DirectoryTableBase[1])));
01493 <span class="preprocessor">#endif</span>
01494 <span class="preprocessor"></span>
01495         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01496 
01497         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01498 
01499         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01500         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01501         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01502 
01503         <span class="comment">//</span>
01504         <span class="comment">// Remove the page directory page.</span>
01505         <span class="comment">//</span>
01506 
01507         PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process);
01508 
01509 <span class="preprocessor">#if defined (_X86PAE_)</span>
01510 <span class="preprocessor"></span>
01511         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01512         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01513             PageDirectories[i] = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(&amp;PointerPte[i]);
01514         }
01515         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01516 
01517         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01518             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectories[i]);
01519     
01520             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01521     
01522             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (PageDirectories[i]);
01523             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01524     
01525             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01526         }
01527 <span class="preprocessor">#endif</span>
01528 <span class="preprocessor"></span>
01529 <span class="preprocessor">#if defined (_WIN64)</span>
01530 <span class="preprocessor"></span>
01531         <span class="comment">//</span>
01532         <span class="comment">// Get a pointer to the top-level page directory parent page via</span>
01533         <span class="comment">// its KSEG0 address.</span>
01534         <span class="comment">//</span>
01535 
01536         PageDirectoryParent = KSEG_ADDRESS (PageFrameIndex);
01537 
01538         <span class="comment">//</span>
01539         <span class="comment">// Remove the hyper space page directory page from the deleted process.</span>
01540         <span class="comment">//</span>
01541 
01542         Ppe = &amp;PageDirectoryParent[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(HYPER_SPACE)];
01543         PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(Ppe);
01544         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex2);
01545 
01546         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01547         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01548         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex2);
01549         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01550 <span class="preprocessor">#endif</span>
01551 <span class="preprocessor"></span>
01552         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01553 
01554         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01555 
01556         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (PageFrameIndex);
01557 
01558         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01559 
01560         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01561 
01562 <span class="preprocessor">#if defined (_X86PAE_)</span>
01563 <span class="preprocessor"></span>
01564         <span class="comment">//</span>
01565         <span class="comment">// Free the page directory page pointers.</span>
01566         <span class="comment">//</span>
01567 
01568         PoolBlock = MiPaeFree ((PPAE_ENTRY)Process-&gt;PaeTop);
01569 <span class="preprocessor">#endif</span>
01570 <span class="preprocessor"></span>
01571 <span class="preprocessor">#if defined(_IA64_)</span>
01572 <span class="preprocessor"></span>
01573         <span class="comment">//</span>
01574         <span class="comment">// Free the session space page directory parent page </span>
01575         <span class="comment">//</span>
01576 
01577         PageFrameIndex = 
01578             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.SessionParentBase)));
01579 
01580         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01581         
01582         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01583 
01584         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01585 
01586         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01587 
01588         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01589 
01590 <span class="preprocessor">#endif</span>
01591 <span class="preprocessor"></span>
01592     } <span class="keywordflow">else</span> {
01593 
01594         <span class="comment">//</span>
01595         <span class="comment">// Process initialization never completed, just return the pages</span>
01596         <span class="comment">// to the free list.</span>
01597         <span class="comment">//</span>
01598 
01599         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01600                             Process-&gt;WorkingSetPage);
01601 
01602 <span class="preprocessor">#if defined (_WIN64)</span>
01603 <span class="preprocessor"></span>
01604         <span class="comment">//</span>
01605         <span class="comment">// Get a pointer to the top-level page directory parent page via</span>
01606         <span class="comment">// its KSEG0 address.</span>
01607         <span class="comment">//</span>
01608 
01609         PageFrameIndex =
01610             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.DirectoryTableBase[0])));
01611 
01612         PageDirectoryParent = KSEG_ADDRESS (PageFrameIndex);
01613 
01614         Ppe = &amp;PageDirectoryParent[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(HYPER_SPACE)];
01615         PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(Ppe);
01616 
01617         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01618                             PageFrameIndex2);
01619 <span class="preprocessor">#endif</span>
01620 <span class="preprocessor"></span>
01621 <span class="preprocessor">#if defined (_X86PAE_)</span>
01622 <span class="preprocessor"></span>        PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process);
01623 
01624         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01625         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01626             PageDirectories[i] = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(&amp;PointerPte[i]);
01627         }
01628         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01629 
01630         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01631             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01632                                 PageDirectories[i]);
01633         }
01634 
01635         <span class="comment">//</span>
01636         <span class="comment">// Free the second hyper space page table page.</span>
01637         <span class="comment">//</span>
01638 
01639         PageFrameIndex = (PFN_NUMBER)Process-&gt;Pcb.DirectoryTableBase[1];
01640 
01641         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01642         PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
01643         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01644         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList], PageFrameIndex2);
01645 
01646         <span class="comment">//</span>
01647         <span class="comment">// Free the first hyper space page table page.</span>
01648         <span class="comment">//</span>
01649 
01650         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01651                             (PFN_NUMBER)Process-&gt;Pcb.DirectoryTableBase[1]);
01652 
01653         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01654             <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process));
01655 
01656         <span class="comment">//</span>
01657         <span class="comment">// Free the page directory page pointers.</span>
01658         <span class="comment">//</span>
01659 
01660         PoolBlock = MiPaeFree ((PPAE_ENTRY)Process-&gt;PaeTop);
01661 <span class="preprocessor">#else</span>
01662 <span class="preprocessor"></span>
01663         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01664             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.DirectoryTableBase[1]))));
01665 
01666         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01667             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.DirectoryTableBase[0]))));
01668 <span class="preprocessor">#endif</span>
01669 <span class="preprocessor"></span><span class="preprocessor">#if defined(_IA64_)</span>
01670 <span class="preprocessor"></span>        <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList], Process-&gt;Pcb.SessionParentBase);
01671 <span class="preprocessor">#endif</span>
01672 <span class="preprocessor"></span>    }
01673 
01674     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += <a class="code" href="../../d4/d5/procsup_8c.html#a1">MM_PROCESS_CREATE_CHARGE</a>;
01675     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(7, MM_PROCESS_CREATE_CHARGE);
01676 
01677     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01678 
01679 <span class="preprocessor">#if defined (_X86PAE_)</span>
01680 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PoolBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01681         MiPaeFreeEntirePage (PoolBlock);
01682     }
01683 <span class="preprocessor">#endif</span>
01684 <span class="preprocessor"></span>
01685     <span class="comment">//</span>
01686     <span class="comment">// Check to see if the paging files should be contracted.</span>
01687     <span class="comment">//</span>
01688 
01689     <a class="code" href="../../d6/d3/modwrite_8c.html#a47">MiContractPagingFiles</a> ();
01690 
01691     <span class="keywordflow">return</span>;
01692 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="procsup.c::MmDeleteTeb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmDeleteTeb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TebBase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">4843</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02380">_MMSECURE_ENTRY::List</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a23">MiDeleteFreeVm()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o16">_MMVAD::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>04850                    :
04851 
04852     This routine deletes a TEB page within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process.
04853 
04854 Arguments:
04855 
04856     TargetProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which to <span class="keyword">delete</span>
04857         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TEB.
04858 
04859     TebBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TEB to <span class="keyword">delete</span>.
04860 
04861 Return Value:
04862 
04863     None.
04864 
04865 Environment:
04866 
04867     Kernel mode.
04868 
04869 --*/
04870 
04871 {
04872     PVOID EndingAddress;
04873     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
04874     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04875     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Secure;
04876 
04877     EndingAddress = ((PCHAR)TebBase +
04878                                 <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (<span class="keyword">sizeof</span>(TEB)) - 1);
04879 
04880     <span class="comment">//</span>
04881     <span class="comment">// Attach to the specified process.</span>
04882     <span class="comment">//</span>
04883 
04884     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;Pcb);
04885 
04886     <span class="comment">//</span>
04887     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
04888     <span class="comment">// creating or deleting address space at the same time and</span>
04889     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
04890     <span class="comment">// be inserted and walked.</span>
04891     <span class="comment">//</span>
04892 
04893     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
04894 
04895     Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (TebBase);
04896 
04897     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)NULL);
04898 
04899     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> == <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (TebBase)) &amp;&amp;
04900             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> == <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress)));
04901 
04902     <span class="comment">//</span>
04903     <span class="comment">// If someone has secured the TEB (in addition to the standard securing</span>
04904     <span class="comment">// that was done by memory management on creation, then don't delete it</span>
04905     <span class="comment">// now - just leave it around until the entire process is deleted.</span>
04906     <span class="comment">//</span>
04907 
04908     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1);
04909     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) {
04910         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04911     }
04912     <span class="keywordflow">else</span> {
04913         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured);
04914         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (IsListEmpty (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List) == 0);
04915 
04916         <span class="comment">//</span>
04917         <span class="comment">// If there's only one entry, then that's the one we defined when we</span>
04918         <span class="comment">// initially created the TEB.  So TEB deletion can take place right</span>
04919         <span class="comment">// now.  If there's more than one entry, let the TEB sit around until</span>
04920         <span class="comment">// the process goes away.</span>
04921         <span class="comment">//</span>
04922 
04923         Secure = CONTAINING_RECORD (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List.Flink,
04924                                     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
04925                                     List);
04926 
04927         <span class="keywordflow">if</span> (Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>.Flink == &amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List) {
04928             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04929         }
04930         <span class="keywordflow">else</span> {
04931             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
04932         }
04933     }
04934 
04935     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04936 
04937         <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (Vad);
04938         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
04939 
04940         <a class="code" href="../../d4/d5/procsup_8c.html#a23">MiDeleteFreeVm</a> (TebBase, EndingAddress);
04941     }
04942 
04943     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
04944     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04945 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="procsup.c::MmGrowKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGrowKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CurrentStack</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l02921">2921</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00151">MM_KSTACK_OUTSWAPPED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02177">PERFINFO_GROW_STACK</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00667">_KTHREAD::StackBase</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00557">_KTHREAD::StackLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>02927                    :
02928 
02929     This function attempts to grows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread's kernel stack
02930     such that there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always KERNEL_LARGE_STACK_COMMIT bytes below
02931     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current stack pointer.
02932 
02933 Arguments:
02934 
02935     CurrentStack - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current stack pointer.
02936 
02937 Return Value:
02938 
02939     STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack was grown.
02940 
02941     STATUS_STACK_OVERFLOW <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> there was not enough space reserved
02942     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> commitment.
02943 
02944     STATUS_NO_MEMORY <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> there was not enough physical memory
02945     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
02946 
02947 --*/
02948 
02949 {
02950     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NewLimit;
02951     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StackLimit;
02952     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndStack;
02953     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
02954     PFN_NUMBER NumberOfPages;
02955     KIRQL OldIrql;
02956     PFN_NUMBER PageFrameIndex;
02957     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02958 
02959     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
02960     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((PCHAR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o61">StackBase</a> - (PCHAR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o3">StackLimit</a>) &lt;=
02961             (KERNEL_LARGE_STACK_SIZE + PAGE_SIZE));
02962     NewLimit = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)CurrentStack -
02963                                                     KERNEL_LARGE_STACK_COMMIT));
02964 
02965     StackLimit = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o3">StackLimit</a>);
02966 
02967     <span class="comment">//</span>
02968     <span class="comment">// If the new stack limit exceeds the reserved region for the kernel</span>
02969     <span class="comment">// stack, then return an error.</span>
02970     <span class="comment">//</span>
02971 
02972     EndStack = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o61">StackBase</a> -
02973                                                     KERNEL_LARGE_STACK_SIZE));
02974 
02975     <span class="keywordflow">if</span> (NewLimit &lt; EndStack) {
02976 
02977         <span class="comment">//</span>
02978         <span class="comment">// Don't go into guard page.</span>
02979         <span class="comment">//</span>
02980 
02981         <span class="keywordflow">return</span> STATUS_STACK_OVERFLOW;
02982 
02983     }
02984 
02985     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StackLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02986 
02987     <span class="comment">//</span>
02988     <span class="comment">// Lock the PFN database and attempt to expand the kernel stack.</span>
02989     <span class="comment">//</span>
02990 
02991     StackLimit -= 1;
02992 
02993     NumberOfPages = (PFN_NUMBER) (StackLimit - NewLimit + 1);
02994 
02995     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02996 
02997     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt;= (SPFN_NUMBER)NumberOfPages) {
02998         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02999         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03000     }
03001 
03002     <span class="comment">//</span>
03003     <span class="comment">// Note MmResidentAvailablePages must be charged before calling</span>
03004     <span class="comment">// MiEnsureAvailablePageOrWait as it may let go of the PFN lock.</span>
03005     <span class="comment">//</span>
03006 
03007     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
03008     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(11, NumberOfPages);
03009 
03010     <span class="keywordflow">while</span> (StackLimit &gt;= NewLimit) {
03011 
03012         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StackLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03013 
03014         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
03015         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (StackLimit));
03016         StackLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
03017 
03018 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03019 <span class="preprocessor"></span>        StackLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03020 <span class="preprocessor">#endif</span>
03021 <span class="preprocessor"></span>
03022         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, StackLimit, 1);
03023 
03024         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
03025                            PageFrameIndex,
03026                            MM_READWRITE,
03027                            StackLimit );
03028 
03029         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
03030         *StackLimit = TempPte;
03031         StackLimit -= 1;
03032     }
03033 
03034     <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> += NumberOfPages;
03035     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03036 
03037 <span class="preprocessor">#if DBG</span>
03038 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NewLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03039     <span class="keywordflow">if</span> (NewLimit != EndStack) {
03040         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((NewLimit - 1)-&gt;u.Hard.Valid == 0);
03041     }
03042 <span class="preprocessor">#endif</span>
03043 <span class="preprocessor"></span>
03044     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o3">StackLimit</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (NewLimit);
03045 
03046     <a class="code" href="../../d2/d1/mm_8h.html#a56">PERFINFO_GROW_STACK</a>(Thread);
03047 
03048     <span class="keywordflow">return</span> STATUS_SUCCESS;
03049 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="procsup.c::MmInitializeProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmInitializeProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessToInitialize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToClone&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID SectionToMap&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING *AuditName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">911</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00071">_2gb</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02679">_LOCK_HEADER::ListHead</a>, <a class="el" href="../../d4/d8/mi_8h.html#a528">LOCK_HEADER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05659">MiAllocateVad()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a311">MiInitializeAlternateTable()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01481">MiInitializeWorkingSetList()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00165">MM_DBG_PTE_UPDATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d1/d9/ps_8h.html#a36">PWOW64_PROCESS</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk()</a>, <a class="el" href="../../d1/d9/ps_8h.html#a35">WOW64_PROCESS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01128">ZERO_LARGE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00920                    :
00921 
00922     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set and mutexes within an
00923     newly created address space to support paging.
00924 
00925     No page faults may occur in a <span class="keyword">new</span> process until <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00926     completed.
00927 
00928 Arguments:
00929 
00930     ProcessToInitialize - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to initialize.
00931 
00932     ProcessToClone - Optionally supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose
00933                      address space should be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00934                      ProcessToInitialize address space.
00935 
00936     SectionToMap - Optionally supplies a section to map into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
00937                    initialized address space.
00938 
00939         Only one of ProcessToClone and SectionToMap may be specified.
00940 
00941 
00942 Return Value:
00943 
00944     None.
00945 
00946 
00947 Environment:
00948 
00949     Kernel mode.  APCs Disabled.
00950 
00951 --*/
00952 
00953 
00954 {
00955     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00956     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00957     PVOID BaseAddress;
00958     SIZE_T ViewSize;
00959     KIRQL OldIrql;
00960     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00961     PFN_NUMBER PpePhysicalPage;
00962     PFN_NUMBER PdePhysicalPage;
00963     PFN_NUMBER PageContainingWorkingSet;
00964     LARGE_INTEGER SectionOffset;
00965     PSECTION_IMAGE_INFORMATION ImageInfo;
00966     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> VadShare;
00967     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> VadReserve;
00968     <a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">PLOCK_HEADER</a> LockedPagesHeader;
00969 <span class="preprocessor">#if defined (_X86PAE_)</span>
00970 <span class="preprocessor"></span>    ULONG i;
00971     PFN_NUMBER PdePhysicalPage2;
00972 <span class="preprocessor">#endif</span>
00973 <span class="preprocessor"></span><span class="preprocessor">#if defined (_WIN64)</span>
00974 <span class="preprocessor"></span>    <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process;
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>
00977     <span class="comment">//</span>
00978     <span class="comment">// Initialize Working Set Mutex in process header.</span>
00979     <span class="comment">//</span>
00980 
00981     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ProcessToInitialize-&gt;Pcb);
00982     ProcessToInitialize-&gt;AddressSpaceInitialized = 2;
00983 
00984     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;ProcessToInitialize-&gt;AddressCreationLock);
00985 
00986     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;ProcessToInitialize-&gt;WorkingSetLock);
00987 
00988     <span class="comment">//</span>
00989     <span class="comment">// NOTE:  The process block has been zeroed when allocated, so</span>
00990     <span class="comment">// there is no need to zero fields and set pointers to NULL.</span>
00991     <span class="comment">//</span>
00992 
00993     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToInitialize-&gt;VadRoot == NULL);
00994 
00995     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;ProcessToInitialize-&gt;Vm.LastTrimTime);
00996     ProcessToInitialize-&gt;Vm.VmWorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">// Obtain a page to map the working set and initialize the</span>
01000     <span class="comment">// working set.  Get PFN mutex to allocate physical pages.</span>
01001     <span class="comment">//</span>
01002 
01003     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01004 
01005     <span class="comment">//</span>
01006     <span class="comment">// Initialize the PFN database for the Page Directory and the</span>
01007     <span class="comment">// PDE which maps hyper space.</span>
01008     <span class="comment">//</span>
01009 
01010 <span class="preprocessor">#if defined (_WIN64)</span>
01011 <span class="preprocessor"></span>
01012     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_TBASE);
01013     PpePhysicalPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01014 
01015     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PpePhysicalPage, PointerPte, 1);
01016 
01017     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (HYPER_SPACE);
01018     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte), PointerPte, 1);
01019 
01020 <span class="preprocessor">#if defined(_IA64_)</span>
01021 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_STBASE);
01022     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte), PointerPte, 1);
01023 <span class="preprocessor">#endif</span>
01024 <span class="preprocessor"></span>
01025 <span class="preprocessor">#else</span>
01026 <span class="preprocessor"></span>
01027 <span class="preprocessor">#if defined (_X86PAE_)</span>
01028 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PDE_BASE);
01029 <span class="preprocessor">#else</span>
01030 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_BASE);
01031 <span class="preprocessor">#endif</span>
01032 <span class="preprocessor"></span>    PdePhysicalPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01033 
01034     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PdePhysicalPage, PointerPte, 1);
01035 
01036 <span class="preprocessor">#endif</span>
01037 <span class="preprocessor"></span>
01038     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (HYPER_SPACE);
01039     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte), PointerPte, 1);
01040 
01041 <span class="preprocessor">#if defined (_X86PAE_)</span>
01042 <span class="preprocessor"></span>
01043     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01044         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_BASE + (i &lt;&lt; PAGE_SHIFT));
01045         PdePhysicalPage2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01046         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PdePhysicalPage2, PointerPte, 1);
01047     }
01048 
01049     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (HYPER_SPACE2);
01050     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte), PointerPte, 1);
01051 <span class="preprocessor">#endif</span>
01052 <span class="preprocessor"></span>
01053     PageContainingWorkingSet = ProcessToInitialize-&gt;WorkingSetPage;
01054 
01055     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmWorkingSetList);
01056     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01057 
01058     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageContainingWorkingSet, PointerPte, 1);
01059 
01060     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01061 
01062     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01063                        PageContainingWorkingSet,
01064                        MM_READWRITE,
01065                        PointerPte );
01066 
01067     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01068     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01069 
01070     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToInitialize-&gt;LockedPagesList == NULL);
01071 
01072     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01073         LockedPagesHeader = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01074                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">LOCK_HEADER</a>),
01075                                                    'xTmM');
01076 
01077         <span class="keywordflow">if</span> (LockedPagesHeader) {
01078             RtlZeroMemory (LockedPagesHeader, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">LOCK_HEADER</a>));
01079             ProcessToInitialize-&gt;LockedPagesList = (PVOID)LockedPagesHeader;
01080             InitializeListHead (&amp;LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>);
01081         }
01082     }
01083 
01084     <a class="code" href="../../d4/d0/wslist_8c.html#a27">MiInitializeWorkingSetList</a> (ProcessToInitialize);
01085 
01086     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;ProcessToInitialize-&gt;AweLock);
01087     InitializeListHead (&amp;ProcessToInitialize-&gt;PhysicalVadList);
01088 
01089     <span class="comment">//</span>
01090     <span class="comment">// Page faults may be taken now.</span>
01091     <span class="comment">//</span>
01092     <span class="comment">// If the system has been biased to an alternate base address to allow</span>
01093     <span class="comment">// 3gb of user address space and a process is not being cloned, then</span>
01094     <span class="comment">// create a VAD for the shared memory page.</span>
01095     <span class="comment">//</span>
01096 
01097 <span class="preprocessor">#if defined(_X86_) &amp;&amp; defined(MM_SHARED_USER_DATA_VA)</span>
01098 <span class="preprocessor"></span>
01099     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) &amp;&amp; (ProcessToClone == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01100 
01101         <span class="comment">//</span>
01102         <span class="comment">// Allocate a VAD to map the shared memory page. If a VAD cannot be</span>
01103         <span class="comment">// allocated, then detach from the target process and return a failure</span>
01104         <span class="comment">// status.  This VAD is marked as not deletable.</span>
01105         <span class="comment">//</span>
01106 
01107         VadShare = <a class="code" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (MM_SHARED_USER_DATA_VA,
01108                                   MM_SHARED_USER_DATA_VA,
01109                                   FALSE);
01110 
01111         <span class="keywordflow">if</span> (VadShare == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01112             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01113             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01114         }
01115 
01116         <span class="comment">//</span>
01117         <span class="comment">// If a section is being mapped and the executable is not large</span>
01118         <span class="comment">// address space aware, then create a VAD that reserves the address</span>
01119         <span class="comment">// space between 2gb and the highest user address.</span>
01120         <span class="comment">//</span>
01121 
01122         <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01123             <span class="keywordflow">if</span> (!((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;u.Flags.Image) {
01124                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01125                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (VadShare);
01126                 <span class="keywordflow">return</span> STATUS_SECTION_NOT_IMAGE;
01127             }
01128             ImageInfo = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ImageInformation;
01129             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite</a>(Enterprise) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
01130                 ((ImageInfo-&gt;ImageCharacteristics &amp; IMAGE_FILE_LARGE_ADDRESS_AWARE) == 0)) {
01131 
01132                 <span class="comment">//</span>
01133                 <span class="comment">// Allocate a VAD to map the address space between 2gb and</span>
01134                 <span class="comment">// the highest user address. If a VAD can not be allocated,</span>
01135                 <span class="comment">// then deallocate the shared address space VAD, detach from</span>
01136                 <span class="comment">// the target process, and return a failure status.</span>
01137                 <span class="comment">// This VAD is marked as not deletable.</span>
01138                 <span class="comment">//</span>
01139 
01140                 VadReserve = <a class="code" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (_2gb,
01141                                             (ULONG_PTR)MM_HIGHEST_USER_ADDRESS,
01142                                             FALSE);
01143 
01144                 <span class="keywordflow">if</span> (VadReserve == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01145                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01146                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (VadShare);
01147                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01148                 }
01149 
01150                 <span class="comment">//</span>
01151                 <span class="comment">// Insert the VAD.</span>
01152                 <span class="comment">//</span>
01153                 <span class="comment">// N.B. No exception can occur since there is no commit charge.</span>
01154                 <span class="comment">//</span>
01155 
01156                 <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (VadReserve);
01157             }
01158         }
01159 
01160         <span class="comment">//</span>
01161         <span class="comment">// Insert the VAD.</span>
01162         <span class="comment">//</span>
01163         <span class="comment">// N.B. No exception can occur since there is no commit charge.</span>
01164         <span class="comment">//</span>
01165 
01166         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (VadShare);
01167     }
01168 
01169 <span class="preprocessor">#endif</span>
01170 <span class="preprocessor"></span>
01171 <span class="preprocessor">#if defined(_WIN64)</span>
01172 <span class="preprocessor"></span>
01173     <span class="keywordflow">if</span> (ProcessToClone == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01174 
01175         <span class="comment">//</span>
01176         <span class="comment">// Reserve the address space just below KUSER_SHARED_DATA as the</span>
01177         <span class="comment">// compatibility area.  This range can be unreserved by user mode</span>
01178         <span class="comment">// code such as WOW64 or csrss.</span>
01179         <span class="comment">//</span>
01180 
01181         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a>(WOW64_COMPATIBILITY_AREA_ADDRESS, MM_SHARED_USER_DATA_VA) == NULL);
01182 
01183         VadShare = <a class="code" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (WOW64_COMPATIBILITY_AREA_ADDRESS,
01184                                   MM_SHARED_USER_DATA_VA,
01185                                   TRUE);
01186 
01187         <span class="keywordflow">if</span> (VadShare == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01188            <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01189            <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01190         }
01191 
01192         <span class="comment">//</span>
01193         <span class="comment">// Reserve the memory above 2GB to prevent 32 bit (WOW64) process</span>
01194         <span class="comment">// access.</span>
01195         <span class="comment">//</span>
01196 
01197         <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01198             <span class="keywordflow">if</span> (!((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;u.Flags.Image) {
01199                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01200                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (VadShare);
01201                 <span class="keywordflow">return</span> STATUS_SECTION_NOT_IMAGE;
01202             }
01203             ImageInfo = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ImageInformation;
01204 
01205             <span class="keywordflow">if</span> ((ImageInfo-&gt;ImageCharacteristics &amp; IMAGE_FILE_LARGE_ADDRESS_AWARE) == 0 ||
01206 <span class="preprocessor">#if defined(_AXP64_)</span>
01207 <span class="preprocessor"></span>                ImageInfo-&gt;Machine == IMAGE_FILE_MACHINE_ALPHA ||
01208 <span class="preprocessor">#endif</span>
01209 <span class="preprocessor"></span>                ImageInfo-&gt;Machine == IMAGE_FILE_MACHINE_I386) {
01210 
01211                 <span class="comment">//</span>
01212                 <span class="comment">// Allocate a VAD to reserve the address space between 2gb and</span>
01213                 <span class="comment">// the highest user address.  If a VAD cannot be allocated,</span>
01214                 <span class="comment">// then deallocate the compatibility VAD, detach from the target</span>
01215                 <span class="comment">// process and return a failure status.</span>
01216                 <span class="comment">//</span>
01217 
01218                 VadReserve = <a class="code" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (_2gb,
01219                                             (ULONG_PTR)MM_HIGHEST_USER_ADDRESS,
01220                                             TRUE);
01221 
01222                 <span class="keywordflow">if</span> (VadReserve == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01223                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01224                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (VadShare);
01225                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01226                 }
01227 
01228                 <span class="comment">//</span>
01229                 <span class="comment">// Insert the VAD.</span>
01230                 <span class="comment">//</span>
01231                 <span class="comment">// N.B. No exception can occur since there is no commit charge.</span>
01232                 <span class="comment">//</span>
01233 
01234                 <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (VadReserve);
01235 
01236                 <span class="comment">//</span>
01237                 <span class="comment">// Initialize Wow64 Process structure</span>
01238                 <span class="comment">//</span>
01239 
01240                 Wow64Process = 
01241                     (<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01242                                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">WOW64_PROCESS</a>),
01243                                                             'WowM');
01244 
01245                 <span class="keywordflow">if</span> (Wow64Process == (<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01246                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01247                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01248                 }
01249 
01250                 RtlZeroMemory(Wow64Process, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">WOW64_PROCESS</a>));
01251 
01252                 ProcessToInitialize-&gt;Wow64Process = Wow64Process;
01253                  
01254 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01255 <span class="preprocessor"></span>
01256                 <span class="comment">//</span>
01257                 <span class="comment">// Initialize the alternate page table for the 4kb page function</span>
01258                 <span class="comment">//</span>
01259 
01260                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/miia64_8h.html#a311">MiInitializeAlternateTable</a> (ProcessToInitialize);
01261                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
01262                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01263                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01264                 }
01265 
01266 <span class="preprocessor">#endif</span>
01267 <span class="preprocessor"></span>            }
01268         }
01269 
01270         <span class="comment">//</span>
01271         <span class="comment">// Insert the VAD.</span>
01272         <span class="comment">//</span>
01273         <span class="comment">// N.B. No exception can occur since there is no commit charge.</span>
01274         <span class="comment">//</span>
01275 
01276         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (VadShare);
01277     }
01278 
01279 <span class="preprocessor">#endif</span>
01280 <span class="preprocessor"></span>
01281     <span class="keywordflow">if</span> (SectionToMap != (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01282 
01283         <span class="comment">//</span>
01284         <span class="comment">// Map the specified section into the address space of the</span>
01285         <span class="comment">// process but only if it is an image section.</span>
01286         <span class="comment">//</span>
01287 
01288         <span class="keywordflow">if</span> (!((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;u.Flags.Image) {
01289             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_NOT_IMAGE;
01290         } <span class="keywordflow">else</span> {
01291             UNICODE_STRING UnicodeString;
01292             ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
01293             PWSTR Src;
01294             PCHAR Dst;
01295 
01296             UnicodeString = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ControlArea-&gt;FilePointer-&gt;FileName;
01297             Src = (PWSTR)((PCHAR)UnicodeString.Buffer + UnicodeString.Length);
01298             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 0;
01299             <span class="keywordflow">if</span> (UnicodeString.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01300                 <span class="keywordflow">while</span> (Src &gt; UnicodeString.Buffer) {
01301                     <span class="keywordflow">if</span> (*--Src == OBJ_NAME_PATH_SEPARATOR) {
01302                         Src += 1;
01303                         <span class="keywordflow">break</span>;
01304                     }
01305                     <span class="keywordflow">else</span> {
01306                         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> += 1;
01307                     }
01308                 }
01309             }
01310             Dst = ProcessToInitialize-&gt;ImageFileName;
01311             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &gt;= <span class="keyword">sizeof</span>( ProcessToInitialize-&gt;ImageFileName )) {
01312                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = <span class="keyword">sizeof</span>( ProcessToInitialize-&gt;ImageFileName ) - 1;
01313             }
01314 
01315             <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>--) {
01316                 *Dst++ = (UCHAR)*Src++;
01317             }
01318             *Dst = <span class="charliteral">'\0'</span>;
01319 
01320             <span class="keywordflow">if</span> (AuditName) {
01321                 *AuditName = &amp;((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ControlArea-&gt;FilePointer-&gt;FileName ;
01322             }
01323 
01324             ProcessToInitialize-&gt;SubSystemMajorVersion =
01325                 (UCHAR)((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ImageInformation-&gt;SubSystemMajorVersion;
01326             ProcessToInitialize-&gt;SubSystemMinorVersion =
01327                 (UCHAR)((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ImageInformation-&gt;SubSystemMinorVersion;
01328 
01329             BaseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01330             ViewSize = 0;
01331             <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (SectionOffset);
01332 
01333             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> ( (PSECTION)SectionToMap,
01334                                           ProcessToInitialize,
01335                                           &amp;BaseAddress,
01336                                           0,                <span class="comment">// ZeroBits,</span>
01337                                           0,                <span class="comment">// CommitSize,</span>
01338                                           &amp;SectionOffset,   <span class="comment">//SectionOffset,</span>
01339                                           &amp;ViewSize,
01340                                           ViewShare,        <span class="comment">//InheritDisposition,</span>
01341                                           0,                <span class="comment">//allocation type</span>
01342                                           PAGE_READWRITE    <span class="comment">// Protect</span>
01343                                           );
01344 
01345             ProcessToInitialize-&gt;SectionBaseAddress = BaseAddress;
01346 
01347 <span class="preprocessor">#if DBG</span>
01348 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
01349                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"mapped image section vads\n"</span>);
01350                 <a class="code" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk</a>(ProcessToInitialize-&gt;VadRoot);
01351             }
01352 <span class="preprocessor">#endif //DBG</span>
01353 <span class="preprocessor"></span>        }
01354 
01355         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01356         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01357     }
01358 
01359     <span class="keywordflow">if</span> (ProcessToClone != (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01360 <span class="preprocessor">#if DEVL</span>
01361 <span class="preprocessor"></span>        strcpy( ProcessToInitialize-&gt;ImageFileName, ProcessToClone-&gt;ImageFileName );
01362 <span class="preprocessor">#endif // DEVL</span>
01363 <span class="preprocessor"></span>
01364         <span class="comment">//</span>
01365         <span class="comment">// Clone the address space of the specified process.</span>
01366         <span class="comment">//</span>
01367 
01368         <span class="comment">//</span>
01369         <span class="comment">// As the page directory and page tables are private to each</span>
01370         <span class="comment">// process, the physical pages which map the directory page</span>
01371         <span class="comment">// and the page table usage must be mapped into system space</span>
01372         <span class="comment">// so they can be updated while in the context of the process</span>
01373         <span class="comment">// we are cloning.</span>
01374         <span class="comment">//</span>
01375 
01376         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01377         <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a853">MiCloneProcessAddressSpace</a> (ProcessToClone,
01378                                            ProcessToInitialize,
01379 #<span class="keywordflow">if</span> defined (_WIN64)
01380                                            PpePhysicalPage,
01381 #<span class="keywordflow">else</span>
01382                                            PdePhysicalPage,
01383 #endif
01384                                            PageContainingWorkingSet
01385                                            );
01386 
01387     }
01388 
01389     <span class="comment">//</span>
01390     <span class="comment">// System Process.</span>
01391     <span class="comment">//</span>
01392 
01393     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01394     <span class="keywordflow">return</span> STATUS_SUCCESS;
01395 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="procsup.c::MmInPageKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmInPageKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l03445">3445</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00101">KernelDemandZeroPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00151">MM_KSTACK_OUTSWAPPED</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00431">KiInSwapKernelStacks()</a>.
<p>
<pre class="fragment"><div>03451                    :
03452 
03453     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified kernel stack resident.
03454 
03455 Arguments:
03456 
03457     Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack.
03458 
03459 Return Value:
03460 
03461     Thread - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread whose stack should be
03462              <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> resident.
03463 
03464 Environment:
03465 
03466     Kernel mode.
03467 
03468 --*/
03469 
03470 {
03471     PVOID BaseOfKernelStack;
03472     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03473     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndOfStackPte;
03474     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> SignaturePte;
03475     ULONG DiskRead;
03476     PFN_NUMBER ContainingPage;
03477     KIRQL OldIrql;
03478 
03479     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((PCHAR)Thread-&gt;StackBase - (PCHAR)Thread-&gt;StackLimit) &lt;=
03480             (KERNEL_LARGE_STACK_SIZE + PAGE_SIZE));
03481 
03482     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_DISABLE_PAGE_KERNEL_STACKS) {
03483         <span class="keywordflow">return</span>;
03484     }
03485 
03486     <span class="comment">//</span>
03487     <span class="comment">// The first page of the stack is the page before the base</span>
03488     <span class="comment">// of the stack.</span>
03489     <span class="comment">//</span>
03490 
03491     <span class="keywordflow">if</span> (Thread-&gt;LargeStack) {
03492         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)Thread-&gt;StackLimit));
03493 
03494         EndOfStackPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)Thread-&gt;InitialStack -
03495                                             KERNEL_LARGE_STACK_COMMIT));
03496         <span class="comment">//</span>
03497         <span class="comment">// Trim back the stack.  Make sure that the stack does not grow, i.e.</span>
03498         <span class="comment">// StackLimit remains the limit.</span>
03499         <span class="comment">//</span>
03500 
03501         <span class="keywordflow">if</span> (EndOfStackPte &lt; PointerPte) {
03502             EndOfStackPte = PointerPte;
03503         }
03504         Thread-&gt;StackLimit = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (EndOfStackPte);
03505     } <span class="keywordflow">else</span> {
03506         EndOfStackPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Thread-&gt;StackLimit);
03507     }
03508 
03509 <span class="preprocessor">#if defined(_IA64_)</span>
03510 <span class="preprocessor"></span>
03511     <span class="keywordflow">if</span> (Thread-&gt;LargeStack) {
03512        
03513         PVOID TempAddress = (PVOID)((PUCHAR)Thread-&gt;BStoreLimit);
03514 
03515         BaseOfKernelStack = (PVOID)(((ULONG_PTR)Thread-&gt;InitialBStore + 
03516                                KERNEL_LARGE_BSTORE_COMMIT) &amp;
03517                                ~(ULONG_PTR)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
03518 
03519         <span class="comment">//</span>
03520         <span class="comment">// Make sure the guard page is not set to valid.</span>
03521         <span class="comment">//</span>
03522 
03523         <span class="keywordflow">if</span> (BaseOfKernelStack &gt; TempAddress) {
03524             BaseOfKernelStack = TempAddress;
03525         }
03526         Thread-&gt;BStoreLimit = BaseOfKernelStack;
03527     }
03528     BaseOfKernelStack = ((PCHAR)Thread-&gt;BStoreLimit - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03529 <span class="preprocessor">#else</span>
03530 <span class="preprocessor"></span>    BaseOfKernelStack = ((PCHAR)Thread-&gt;StackBase - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03531 <span class="preprocessor">#endif // _IA64_</span>
03532 <span class="preprocessor"></span>
03533     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseOfKernelStack);
03534 
03535     DiskRead = 0;
03536     SignaturePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PULONG_PTR)Thread-&gt;KernelStack - 1);
03537     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SignaturePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03538     <span class="keywordflow">if</span> ((SignaturePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>) &amp;&amp;
03539         (SignaturePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0)) {
03540             DiskRead = 1;
03541     }
03542 
03543     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03544 
03545     <span class="keywordflow">while</span> (PointerPte &gt;= EndOfStackPte) {
03546 
03547 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03548 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d5/procsup_8c.html#a14">KernelDemandZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) ||
03549                 (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>))) {
03550             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03551                           0x3451,
03552                           (ULONG_PTR)PointerPte,
03553                           (ULONG_PTR)Thread,
03554                           0);
03555         }
03556         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03557         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>) {
03558             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = PAGE_READWRITE;
03559         }
03560 <span class="preprocessor">#endif</span>
03561 <span class="preprocessor"></span>
03562         ContainingPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (MiGetPteAddress (PointerPte));
03563         <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (PointerPte,
03564                                       PointerPte,
03565                                       1,
03566                                       ContainingPage);
03567 
03568         PointerPte -= 1;
03569         <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> += 1;
03570     }
03571 
03572     <span class="comment">//</span>
03573     <span class="comment">// Check the signature at the current stack location - 4.</span>
03574     <span class="comment">//</span>
03575 
03576     <span class="keywordflow">if</span> (*((PULONG_PTR)Thread-&gt;KernelStack - 1) != (ULONG_PTR)Thread) {
03577         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_STACK_INPAGE_ERROR,
03578                       DiskRead,
03579                       *((PULONG_PTR)Thread-&gt;KernelStack - 1),
03580                       0,
03581                       (ULONG_PTR)Thread-&gt;KernelStack);
03582     }
03583 
03584     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03585     <span class="keywordflow">return</span>;
03586 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="procsup.c::MmInSwapProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmInSwapProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l03910">3910</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l00442">INITIALIZE_DIRECTORY_TABLE_BASE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01722">MiGetPdeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01769">MiGetPteOffset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02737">MiSessionInSwapProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00101">MM_WS_SWAPPED_OUT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00272">_EPROCESS::PaePageDirectoryPage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00224">_EPROCESS::PaeTop</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00269">_EPROCESS::PageDirectoryPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00213">_EPROCESS::ProcessOutswapEnabled</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00214">_EPROCESS::ProcessOutswapped</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00212">_EPROCESS::WorkingSetPage</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00483">KiInSwapProcesses()</a>.
<p>
<pre class="fragment"><div>03916                    :
03917 
03918     This routine in swaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
03919 
03920 Arguments:
03921 
03922     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be swapped
03923               into memory.
03924 
03925 Return Value:
03926 
03927     None.
03928 
03929 --*/
03930 
03931 {
03932     KIRQL OldIrql;
03933     KIRQL OldIrql2;
03934     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> OutProcess;
03935     PFN_NUMBER PdePage;
03936     PFN_NUMBER PageDirectoryPage;
03937     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryMap;
03938     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryParentMap;
03939     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03940     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte2;
03941     PFN_NUMBER HyperSpacePageTable;
03942     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> HyperSpacePageTableMap;
03943     PFN_NUMBER WorkingSetPage;
03944     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03945     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03946     PFN_NUMBER ProcessPage;
03947 <span class="preprocessor">#if defined (_X86PAE_)</span>
03948 <span class="preprocessor"></span>    ULONG i;
03949     PPAE_ENTRY PaeVa;
03950     PFN_NUMBER PdePage2;
03951 <span class="preprocessor">#endif</span>
03952 <span class="preprocessor"></span>
03953     OutProcess = CONTAINING_RECORD (Process, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, Pcb);
03954 
03955     <span class="keywordflow">if</span> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03956 
03957         <span class="comment">//</span>
03958         <span class="comment">// The process is out of memory, rebuild the initialized page</span>
03959         <span class="comment">// structure.</span>
03960         <span class="comment">//</span>
03961 
03962         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(OutProcess)) {
03963             ProcessPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (OutProcess);
03964         } <span class="keywordflow">else</span> {
03965             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (OutProcess);
03966             ProcessPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03967         }
03968 
03969         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03970 
03971 <span class="preprocessor">#if defined (_WIN64)</span>
03972 <span class="preprocessor"></span>        PdePage = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (MiGetPteAddress (PDE_TBASE),
03973                                         (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>,
03974                                         0,
03975                                         ProcessPage);
03976 <span class="preprocessor">#else</span>
03977 <span class="preprocessor"></span>        PdePage = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (MiGetPteAddress (PDE_BASE),
03978                                         (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>,
03979                                         0,
03980                                         ProcessPage);
03981 <span class="preprocessor">#endif</span>
03982 <span class="preprocessor"></span>
03983         <span class="comment">//</span>
03984         <span class="comment">// Adjust the counts for the process page.</span>
03985         <span class="comment">//</span>
03986 
03987         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ProcessPage);
03988         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
03989 
03990         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 1);
03991 
03992         <span class="comment">//</span>
03993         <span class="comment">// Adjust the counts properly for the page directory page.</span>
03994         <span class="comment">//</span>
03995 
03996         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage);
03997         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03998 <span class="preprocessor">#if !defined (_WIN64)</span>
03999 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)OutProcess;
04000 <span class="preprocessor">#endif</span>
04001 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePage;
04002         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_BASE);
04003 
04004 <span class="preprocessor">#if defined (_WIN64)</span>
04005 <span class="preprocessor"></span>
04006         <span class="comment">//</span>
04007         <span class="comment">// Only the page directory parent page has really been read in above.</span>
04008         <span class="comment">// Get the page directory page now also.</span>
04009         <span class="comment">//</span>
04010 
04011         PageDirectoryParentMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04012 
04013         TempPte = PageDirectoryParentMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmWorkingSetList)];
04014 
04015         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04016 
04017         PageDirectoryPage = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04018                                  MiGetPpeAddress (MmWorkingSetList),
04019                                  &amp;TempPte,
04020                                  0,
04021                                  PdePage);
04022 
04023         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageDirectoryPage == TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
04024         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 3);
04025 
04026         PageDirectoryParentMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04027 
04028         PageDirectoryParentMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(PDE_TBASE)].u.Flush =
04029                                               OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>;
04030         PageDirectoryParentMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmWorkingSetList)] = TempPte;
04031 
04032         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04033 
04034         PdePage = PageDirectoryPage;
04035 <span class="preprocessor">#endif</span>
04036 <span class="preprocessor"></span>
04037 <span class="preprocessor">#if defined (_X86PAE_)</span>
04038 <span class="preprocessor"></span>
04039         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o64">PaePageDirectoryPage</a> = PdePage;
04040 
04041         <span class="comment">//</span>
04042         <span class="comment">// Locate the additional page directory pages and make them resident.</span>
04043         <span class="comment">//</span>
04044 
04045         PaeVa = (PPAE_ENTRY)OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o35">PaeTop</a>;
04046         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
04047             PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04048     
04049             TempPte = PageDirectoryMap[i];
04050     
04051             <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04052     
04053             PdePage2 = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04054                                      MiGetPteAddress (PDE_BASE + (i &lt;&lt; PAGE_SHIFT)),
04055                                      &amp;TempPte,
04056                                      0,
04057                                      PdePage);
04058     
04059             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 1);
04060     
04061             PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04062             PageDirectoryMap[i] = TempPte;
04063             <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04064             PaeVa-&gt;PteEntry[i].u.Long = (TempPte.u.Long &amp; ~MM_PAE_PDPTE_MASK);
04065         }
04066 
04067         TempPte.u.Flush = OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>;
04068         TempPte.u.Long &amp;= ~MM_PAE_PDPTE_MASK;
04069         PaeVa-&gt;PteEntry[i].u.Flush = TempPte.u.Flush;
04070 
04071         <span class="comment">//</span>
04072         <span class="comment">// Locate the second page table page for hyperspace &amp; make it resident.</span>
04073         <span class="comment">//</span>
04074 
04075         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04076 
04077         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE2)];
04078 
04079         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04080 
04081         HyperSpacePageTable = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04082                                  MiGetPdeAddress (HYPER_SPACE2),
04083                                  &amp;TempPte,
04084                                  0,
04085                                  PdePage);
04086 
04087         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 1);
04088 
04089         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04090         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE2)] = TempPte;
04091         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04092         TempPte2 = TempPte;
04093 <span class="preprocessor">#endif</span>
04094 <span class="preprocessor"></span>
04095         <span class="comment">//</span>
04096         <span class="comment">// Locate the page table page for hyperspace and make it resident.</span>
04097         <span class="comment">//</span>
04098 
04099         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04100 
04101         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmWorkingSetList)];
04102 
04103         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04104 
04105         HyperSpacePageTable = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04106                                  MiGetPdeAddress (HYPER_SPACE),
04107                                  &amp;TempPte,
04108                                  0,
04109                                  PdePage);
04110 
04111         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 3);
04112 
04113         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04114 
04115 <span class="preprocessor">#if !defined (_WIN64)</span>
04116 <span class="preprocessor"></span>        PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PDE_BASE)].u.Flush =
04117                                               OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>;
04118 <span class="preprocessor">#endif</span>
04119 <span class="preprocessor"></span>
04120         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmWorkingSetList)] = TempPte;
04121 
04122         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04123 
04124         <span class="comment">//</span>
04125         <span class="comment">// Map in the hyper space page table page and retrieve the</span>
04126         <span class="comment">// PTE that maps the working set list.</span>
04127         <span class="comment">//</span>
04128 
04129         HyperSpacePageTableMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HyperSpacePageTable, &amp;OldIrql2);
04130         TempPte = HyperSpacePageTableMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmWorkingSetList)];
04131         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04132         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HyperSpacePageTable);
04133 
04134         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = 1;
04135 
04136         WorkingSetPage = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04137                                  MiGetPteAddress (MmWorkingSetList),
04138                                  &amp;TempPte,
04139                                  0,
04140                                  HyperSpacePageTable);
04141 
04142         HyperSpacePageTableMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HyperSpacePageTable, &amp;OldIrql2);
04143         HyperSpacePageTableMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmWorkingSetList)] = TempPte;
04144 <span class="preprocessor">#if defined (_X86PAE_)</span>
04145 <span class="preprocessor"></span>        HyperSpacePageTableMap[0] = TempPte2;
04146 <span class="preprocessor">#endif</span>
04147 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04148 
04149         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (WorkingSetPage);
04150 
04151         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = 2;
04152 
04153         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04154 
04155         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
04156 
04157         <span class="comment">//</span>
04158         <span class="comment">// Allow working set trimming on this process.</span>
04159         <span class="comment">//</span>
04160 
04161         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04162         <span class="keywordflow">if</span> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a22">MM_WS_SWAPPED_OUT</a>) {
04163             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
04164                             &amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
04165         }
04166         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
04167 
04168         <span class="comment">//</span>
04169         <span class="comment">// Set up process structures.</span>
04170         <span class="comment">//</span>
04171 
04172         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a> = WorkingSetPage;
04173 
04174 <span class="preprocessor">#if !defined (_X86PAE_)</span>
04175 <span class="preprocessor"></span>        OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = 3;
04176 
04177         <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a> (&amp;Process-&gt;DirectoryTableBase[0],
04178                                          PdePage);
04179         <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a> (&amp;Process-&gt;DirectoryTableBase[1],
04180                                          HyperSpacePageTable);
04181 <span class="preprocessor">#else</span>
04182 <span class="preprocessor"></span>        <span class="comment">//</span>
04183         <span class="comment">// The DirectoryTableBase[0] never changes for PAE processes.</span>
04184         <span class="comment">//</span>
04185 
04186         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = 7;
04187         Process-&gt;DirectoryTableBase[1] = HyperSpacePageTable;
04188 <span class="preprocessor">#endif</span>
04189 <span class="preprocessor"></span>
04190         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04191     }
04192 
04193     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1) {
04194         <a class="code" href="../../d3/d7/session_8c.html#a20">MiSessionInSwapProcess</a> (OutProcess);
04195     }
04196 
04197     OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04198     <span class="keywordflow">return</span>;
04199 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="procsup.c::MmOutPageKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmOutPageKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l03180">3180</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00104">KeFlushMultipleTb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00101">KernelDemandZeroPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00535">MI_MAKE_VALID_PTE_TRANSITION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00151">MM_KSTACK_OUTSWAPPED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00544">KiOutSwapKernelStacks()</a>.
<p>
<pre class="fragment"><div>03186                    :
03187 
03188     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified kernel stack non-resident and
03189     puts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transition list.  Note, that <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03190     CurrentStackPointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first page of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03191     contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second page of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not useful and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03192     page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
03193 
03194 Arguments:
03195 
03196     Thread - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread whose stack should be
03197              removed.
03198 
03199 Return Value:
03200 
03201     None.
03202 
03203 Environment:
03204 
03205     Kernel mode.
03206 
03207 --*/
03208 
03209 <span class="preprocessor">#if defined(_IA64_)</span>
03210 <span class="preprocessor"></span><span class="preprocessor">#define MAX_STACK_PAGES ((KERNEL_LARGE_STACK_SIZE + KERNEL_LARGE_BSTORE_SIZE) / PAGE_SIZE)</span>
03211 <span class="preprocessor"></span><span class="preprocessor">#else</span>
03212 <span class="preprocessor"></span><span class="preprocessor">#define MAX_STACK_PAGES (KERNEL_LARGE_STACK_SIZE / PAGE_SIZE)</span>
03213 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03214 <span class="preprocessor"></span>
03215 {
03216     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03217     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
03218     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndOfStackPte;
03219     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03220     PFN_NUMBER PageFrameIndex;
03221     KIRQL OldIrql;
03222     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03223     PVOID BaseOfKernelStack;
03224     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FlushPte[<a class="code" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>];
03225     PVOID FlushVa[<a class="code" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>];
03226     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> FlushPteSave[<a class="code" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>];
03227     ULONG StackSize;
03228     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03229     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LimitPte;
03230     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LowestLivePte;
03231 
03232     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((PCHAR)Thread-&gt;StackBase - (PCHAR)Thread-&gt;StackLimit) &lt;=
03233             (KERNEL_LARGE_STACK_SIZE + PAGE_SIZE));
03234 
03235     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_DISABLE_PAGE_KERNEL_STACKS) {
03236         <span class="keywordflow">return</span>;
03237     }
03238 
03239     <span class="comment">//</span>
03240     <span class="comment">// The first page of the stack is the page before the base</span>
03241     <span class="comment">// of the stack.</span>
03242     <span class="comment">//</span>
03243 
03244     BaseOfKernelStack = ((PCHAR)Thread-&gt;StackBase - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03245     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseOfKernelStack);
03246     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PULONG)Thread-&gt;KernelStack - 1);
03247     <span class="keywordflow">if</span> (Thread-&gt;LargeStack) {
03248         StackSize = KERNEL_LARGE_STACK_SIZE &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03249 
03250         <span class="comment">//</span>
03251         <span class="comment">// The stack pagein won't necessarily bring back all the pages.</span>
03252         <span class="comment">// Make sure that we account now for the ones that will disappear.</span>
03253         <span class="comment">//</span>
03254 
03255         LimitPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Thread-&gt;StackLimit);
03256 
03257         LowestLivePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)Thread-&gt;InitialStack -
03258                                             KERNEL_LARGE_STACK_COMMIT));
03259 
03260         <span class="keywordflow">if</span> (LowestLivePte &lt; LimitPte) {
03261             LowestLivePte = LimitPte;
03262         }
03263     } <span class="keywordflow">else</span> {
03264         StackSize = KERNEL_STACK_SIZE &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03265         LowestLivePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Thread-&gt;StackLimit);
03266     }
03267     EndOfStackPte = PointerPte - StackSize;
03268 
03269     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LowestLivePte &lt;= LastPte);
03270 
03271     <span class="comment">//</span>
03272     <span class="comment">// Put a signature at the current stack location - 4.</span>
03273     <span class="comment">//</span>
03274 
03275     *((PULONG_PTR)Thread-&gt;KernelStack - 1) = (ULONG_PTR)Thread;
03276 
03277     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
03278 
03279     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03280 
03281     <span class="keywordflow">do</span> {
03282         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03283         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03284         TempPte = *PointerPte;
03285         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte, 0);
03286 
03287 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03288 <span class="preprocessor"></span>        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03289         {
03290             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> x;
03291             x = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
03292             x-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03293         }
03294 <span class="preprocessor">#endif</span>
03295 <span class="preprocessor"></span>
03296         FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = TempPte;
03297         FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = PointerPte;
03298         FlushVa[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = BaseOfKernelStack;
03299 
03300         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
03301         PointerPte -= 1;
03302         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
03303         BaseOfKernelStack = ((PCHAR)BaseOfKernelStack - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03304     } <span class="keywordflow">while</span> (PointerPte &gt;= LastPte);
03305 
03306     <span class="keywordflow">while</span> (PointerPte != EndOfStackPte) {
03307         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03308             <span class="keywordflow">break</span>;
03309         }
03310 
03311         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03312         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03313         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
03314         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
03315         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte));
03316 
03317         FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = <a class="code" href="../../d4/d5/procsup_8c.html#a14">KernelDemandZeroPte</a>;
03318 
03319 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03320 <span class="preprocessor"></span>        FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03321 <span class="preprocessor">#endif</span>
03322 <span class="preprocessor"></span>
03323         FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = PointerPte;
03324 
03325         FlushVa[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = BaseOfKernelStack;
03326         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
03327 
03328         <span class="comment">//</span>
03329         <span class="comment">// Account for any pages that won't ever come back in.</span>
03330         <span class="comment">//</span>
03331 
03332         <span class="keywordflow">if</span> (PointerPte &lt; LowestLivePte) {
03333             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread-&gt;LargeStack);
03334             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += 1;
03335             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(12, 1);
03336         }
03337 
03338         PointerPte -= 1;
03339         BaseOfKernelStack = ((PCHAR)BaseOfKernelStack - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03340     }
03341 
03342 <span class="preprocessor">#if defined(_IA64_)</span>
03343 <span class="preprocessor"></span>    <span class="comment">//</span>
03344     <span class="comment">// do for RSE stack space too.</span>
03345     <span class="comment">//</span>
03346 
03347     BaseOfKernelStack = Thread-&gt;StackBase;
03348     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseOfKernelStack);
03349     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PULONG)Thread-&gt;KernelBStore);
03350 
03351     <span class="keywordflow">if</span> (Thread-&gt;LargeStack) {
03352         StackSize = KERNEL_LARGE_BSTORE_SIZE &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03353     } <span class="keywordflow">else</span> {
03354         StackSize = KERNEL_BSTORE_SIZE &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03355     }
03356     EndOfStackPte = PointerPte + StackSize;
03357 
03358     <span class="keywordflow">do</span> {
03359         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03360         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03361         TempPte = *PointerPte;
03362         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte, 0);
03363 
03364 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03365 <span class="preprocessor"></span>        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03366         {
03367             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> x;
03368             x = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
03369             x-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03370         }
03371 <span class="preprocessor">#endif</span>
03372 <span class="preprocessor"></span>
03373         FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = TempPte;
03374         FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = PointerPte;
03375         FlushVa[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = BaseOfKernelStack;
03376 
03377         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
03378         PointerPte += 1;
03379         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
03380         BaseOfKernelStack = ((PCHAR)BaseOfKernelStack + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03381     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
03382 
03383     <span class="keywordflow">while</span> (PointerPte != EndOfStackPte) {
03384         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03385             <span class="keywordflow">break</span>;
03386         }
03387 
03388         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03389         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03390         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
03391         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
03392         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte));
03393 
03394         FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = <a class="code" href="../../d4/d5/procsup_8c.html#a14">KernelDemandZeroPte</a>;
03395 
03396 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03397 <span class="preprocessor"></span>        FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03398 <span class="preprocessor">#endif</span>
03399 <span class="preprocessor"></span>
03400         FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = PointerPte;
03401         FlushVa[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = BaseOfKernelStack;
03402         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
03403 
03404         PointerPte += 1;
03405         BaseOfKernelStack = ((PCHAR)BaseOfKernelStack + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03406     }
03407 
03408 <span class="preprocessor">#endif // _IA64_</span>
03409 <span class="preprocessor"></span>
03410     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Count &lt;= MAX_STACK_PAGES);
03411 
03412     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
03413         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (Count,
03414                            &amp;FlushVa[0],
03415                            TRUE,
03416                            TRUE,
03417                            &amp;((PHARDWARE_PTE)FlushPte[0]),
03418                            <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
03419     } <span class="keywordflow">else</span> {
03420         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
03421     }
03422 
03423     <span class="comment">//</span>
03424     <span class="comment">// Increase the available pages by the number of pages that where</span>
03425     <span class="comment">// deleted and turned into demand zero.</span>
03426     <span class="comment">//</span>
03427 
03428     <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> -= <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03429 
03430     <span class="comment">//</span>
03431     <span class="comment">// Put the right contents back into the PTEs</span>
03432     <span class="comment">//</span>
03433 
03434     <span class="keywordflow">do</span> {
03435         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> -= 1;
03436         *FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>];
03437     } <span class="keywordflow">while</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0);
03438 
03439 
03440     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03441     <span class="keywordflow">return</span>;
03442 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="procsup.c::MmOutSwapProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmOutSwapProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l03590">3590</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00705">_KPROCESS::DirectoryTableBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00535">MI_MAKE_VALID_PTE_TRANSITION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01722">MiGetPdeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01769">MiGetPteOffset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02551">MiSessionOutSwapProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00185">MM_DBG_SWAP_PROCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00102">MM_IO_IN_PROGRESS</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00042">MM_PROCESS_COMMIT_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00101">MM_WS_SWAPPED_OUT</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00224">_EPROCESS::PaeTop</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00269">_EPROCESS::PageDirectoryPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02433">PMMPTE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00213">_EPROCESS::ProcessOutswapEnabled</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00214">_EPROCESS::ProcessOutswapped</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00212">_EPROCESS::WorkingSetPage</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00644">KiOutSwapProcesses()</a>.
<p>
<pre class="fragment"><div>03596                    :
03597 
03598     This routine <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> swaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
03599 
03600 Arguments:
03601 
03602     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> swapped <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of memory.
03603 
03604 Return Value:
03605 
03606     None.
03607 
03608 --*/
03609 
03610 {
03611     KIRQL OldIrql;
03612     KIRQL OldIrql2;
03613     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> OutProcess;
03614     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03615     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03616     PFN_NUMBER HyperSpacePageTable;
03617     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> HyperSpacePageTableMap;
03618     PFN_NUMBER PpePage;
03619     PFN_NUMBER PdePage;
03620     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryMap;
03621     PFN_NUMBER ProcessPage;
03622     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03623 <span class="preprocessor">#if defined (_X86PAE_)</span>
03624 <span class="preprocessor"></span>    ULONG i;
03625     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte2;
03626     PFN_NUMBER PdePage2;
03627     PFN_NUMBER HyperPage2;
03628     PPAE_ENTRY PaeVa;
03629 <span class="preprocessor">#endif</span>
03630 <span class="preprocessor"></span>
03631     OutProcess = CONTAINING_RECORD (Process, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, Pcb);
03632 
03633     OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03634 
03635 <span class="preprocessor">#if DBG</span>
03636 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a77">MM_DBG_SWAP_PROCESS</a>) != 0) {
03637         <span class="keywordflow">return</span>;
03638     }
03639 <span class="preprocessor">#endif //DBG</span>
03640 <span class="preprocessor"></span>
03641     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1) {
03642         <a class="code" href="../../d3/d7/session_8c.html#a19">MiSessionOutSwapProcess</a> (OutProcess);
03643     }
03644 
03645     <span class="keywordflow">if</span> ((OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> == <a class="code" href="../../d4/d5/procsup_8c.html#a0">MM_PROCESS_COMMIT_CHARGE</a>) &amp;&amp;
03646         (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a>)) {
03647 
03648         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
03649 
03650         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> == FALSE);
03651 
03652         <span class="keywordflow">if</span> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03653 
03654             <span class="comment">//</span>
03655             <span class="comment">// An outswap is not allowed at this point because the process</span>
03656             <span class="comment">// has been attached to and is being trimmed.</span>
03657             <span class="comment">//</span>
03658 
03659             <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03660             <span class="keywordflow">return</span>;
03661         }
03662 
03663         <span class="comment">//</span>
03664         <span class="comment">// Swap the process working set info and page parent/directory/table</span>
03665         <span class="comment">// pages from memory.</span>
03666         <span class="comment">//</span>
03667 
03668         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03669 
03670         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03671 
03672         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03673 
03674         <span class="comment">//</span>
03675         <span class="comment">// Remove the working set list page from the process.</span>
03676         <span class="comment">//</span>
03677 
03678 <span class="preprocessor">#if !defined (_X86PAE_)</span>
03679 <span class="preprocessor"></span>        HyperSpacePageTable =
03680              <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[1])));
03681 <span class="preprocessor">#else</span>
03682 <span class="preprocessor"></span>        HyperSpacePageTable = (PFN_NUMBER)OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[1];
03683 <span class="preprocessor">#endif</span>
03684 <span class="preprocessor"></span>
03685         HyperSpacePageTableMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HyperSpacePageTable, &amp;OldIrql2);
03686 
03687         TempPte = HyperSpacePageTableMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmWorkingSetList)];
03688 
03689         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03690                                       MM_READWRITE);
03691 
03692         HyperSpacePageTableMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmWorkingSetList)] = TempPte;
03693 
03694 <span class="preprocessor">#if defined (_X86PAE_)</span>
03695 <span class="preprocessor"></span>        TempPte2 = HyperSpacePageTableMap[0];
03696 
03697         HyperPage2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;TempPte2);
03698 
03699         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte2,
03700                                       MM_READWRITE);
03701 
03702         HyperSpacePageTableMap[0] = TempPte2;
03703 <span class="preprocessor">#endif</span>
03704 <span class="preprocessor"></span>
03705         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
03706 
03707 <span class="preprocessor">#if DBG</span>
03708 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a>);
03709         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03710 <span class="preprocessor">#endif</span>
03711 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a>);
03712 
03713         <span class="comment">//</span>
03714         <span class="comment">// Remove the hyper space page from the process.</span>
03715         <span class="comment">//</span>
03716 
03717         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HyperSpacePageTable);
03718         PdePage = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
03719         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PdePage);
03720 
03721         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
03722 
03723         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmWorkingSetList)];
03724 
03725         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.Valid == 1);
03726         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.PageFrameNumber == HyperSpacePageTable);
03727 
03728         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03729                                       MM_READWRITE);
03730 
03731         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmWorkingSetList)] = TempPte;
03732 
03733         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03734 
03735         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (HyperSpacePageTable);
03736 
03737 <span class="preprocessor">#if defined (_X86PAE_)</span>
03738 <span class="preprocessor"></span>
03739         <span class="comment">//</span>
03740         <span class="comment">// Remove the second hyper space page from the process.</span>
03741         <span class="comment">//</span>
03742 
03743         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HyperPage2);
03744 
03745         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03746 
03747         PdePage = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
03748         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PdePage);
03749 
03750         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE2)] = TempPte2;
03751 
03752         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (HyperPage2);
03753 
03754         <span class="comment">//</span>
03755         <span class="comment">// Remove the additional page directory pages.</span>
03756         <span class="comment">//</span>
03757 
03758         PaeVa = (PPAE_ENTRY)OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o35">PaeTop</a>;
03759         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
03760     
03761             TempPte = PageDirectoryMap[i];
03762             PdePage2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;TempPte);
03763     
03764             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03765                                           MM_READWRITE);
03766     
03767             PageDirectoryMap[i] = TempPte;
03768             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage2);
03769             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03770 
03771             <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PdePage2);
03772             PaeVa-&gt;PteEntry[i].u.Long = TempPte.u.Long;
03773         }
03774 
03775 <span class="preprocessor">#if DBG</span>
03776 <span class="preprocessor"></span>        TempPte = PageDirectoryMap[i];
03777         PdePage2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;TempPte);
03778         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage2);
03779         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03780 <span class="preprocessor">#endif</span>
03781 <span class="preprocessor"></span>
03782 <span class="preprocessor">#endif</span>
03783 <span class="preprocessor"></span>
03784 <span class="preprocessor">#if defined (_WIN64)</span>
03785 <span class="preprocessor"></span>
03786         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
03787 
03788         <span class="comment">//</span>
03789         <span class="comment">// Remove the page directory page (64-bit version).</span>
03790         <span class="comment">//</span>
03791 
03792         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage);
03793         PpePage = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
03794         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PpePage);
03795         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PpePage == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[0]))));
03796 
03797         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PpePage, &amp;OldIrql2);
03798 
03799         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmWorkingSetList)];
03800 
03801         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.Valid == 1);
03802         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.PageFrameNumber == PdePage);
03803 
03804         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03805                                       MM_READWRITE);
03806 
03807         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmWorkingSetList)] = TempPte;
03808 
03809         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03810 
03811         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (HyperSpacePageTable);
03812 
03813         <span class="comment">//</span>
03814         <span class="comment">// Remove the top level page directory parent page.</span>
03815         <span class="comment">//</span>
03816 
03817         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(PDE_TBASE)];
03818 
03819         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03820                                       MM_READWRITE);
03821 
03822         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(PDE_TBASE)] = TempPte;
03823 
03824         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PpePage);
03825 
03826 <span class="preprocessor">#else</span>
03827 <span class="preprocessor"></span>
03828         <span class="comment">//</span>
03829         <span class="comment">// Remove the top level page directory page.</span>
03830         <span class="comment">//</span>
03831 
03832         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PDE_BASE)];
03833 
03834         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03835                                       MM_READWRITE);
03836 
03837         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PDE_BASE)] = TempPte;
03838 
03839         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage);
03840 
03841 <span class="preprocessor">#endif</span>
03842 <span class="preprocessor"></span>
03843         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
03844 
03845         <span class="comment">//</span>
03846         <span class="comment">// Decrement share count so the top level page directory page gets</span>
03847         <span class="comment">// removed.  This can cause the PteCount to equal the sharecount as the</span>
03848         <span class="comment">// page directory page no longer contains itself, yet can have</span>
03849         <span class="comment">// itself as a transition page.</span>
03850         <span class="comment">//</span>
03851 
03852         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 2;
03853         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>)&amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>;
03854 
03855         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a> = TempPte.u.Flush;
03856 
03857 <span class="preprocessor">#if defined (_X86PAE_)</span>
03858 <span class="preprocessor"></span>        PaeVa-&gt;PteEntry[i].u.Long = TempPte.u.Long;
03859 <span class="preprocessor">#endif</span>
03860 <span class="preprocessor"></span>
03861         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(OutProcess)) {
03862             ProcessPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (OutProcess);
03863         } <span class="keywordflow">else</span> {
03864             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (OutProcess);
03865             ProcessPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03866         }
03867 
03868         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = ProcessPage;
03869         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ProcessPage);
03870 
03871         <span class="comment">//</span>
03872         <span class="comment">// Increment the share count for the process page.</span>
03873         <span class="comment">//</span>
03874 
03875         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03876         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03877 
03878         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
03879         <span class="keywordflow">if</span> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink &gt;
03880                                                        <a class="code" href="../../d4/d8/mi_8h.html#a23">MM_IO_IN_PROGRESS</a>) {
03881 
03882             <span class="comment">//</span>
03883             <span class="comment">// The entry must be on the list.</span>
03884             <span class="comment">//</span>
03885             RemoveEntryList (&amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
03886             OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a22">MM_WS_SWAPPED_OUT</a>;
03887         }
03888         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03889 
03890         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a> = 0;
03891         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = 0;
03892 <span class="preprocessor">#if defined(_IA64_)</span>
03893 <span class="preprocessor"></span>
03894         <span class="comment">//</span>
03895         <span class="comment">// Force assignment of new PID as we have removed</span>
03896         <span class="comment">// the page directory page.</span>
03897         <span class="comment">// Note that a TB flush would not work here as we</span>
03898         <span class="comment">// are in the wrong process context.</span>
03899         <span class="comment">//</span>
03900 
03901         Process-&gt;ProcessRegion.SequenceNumber = 0;
03902 <span class="preprocessor">#endif _IA64_</span>
03903 <span class="preprocessor"></span>
03904     }
03905 
03906     <span class="keywordflow">return</span>;
03907 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="procsup.c::MmSetMemoryPriorityProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmSetMemoryPriorityProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryPriority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">5567</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00063">_MMSUPPORT::MaximumWorkingSetSize</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00041">MEMORY_PRIORITY_BACKGROUND</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04486">MmMoreThanEnoughFreePages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00172">MmSystemSize</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00088">MmWorkingSetReductionMax</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>.
<p>
<pre class="fragment"><div>05574                    :
05575 
05576     Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory priority of a process.
05577 
05578 Arguments:
05579 
05580     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to update
05581 
05582     MemoryPriority - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> memory priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
05583 
05584 Return Value:
05585 
05586     None.
05587 
05588 --*/
05589 
05590 {
05591     KIRQL OldIrql;
05592     UCHAR OldPriority;
05593 
05594     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> == <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a> &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt; ((15*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
05595 
05596         <span class="comment">//</span>
05597         <span class="comment">// If this is a small system, make every process BACKGROUND.</span>
05598         <span class="comment">//</span>
05599 
05600         MemoryPriority = <a class="code" href="../../d1/d9/ps_8h.html#a1">MEMORY_PRIORITY_BACKGROUND</a>;
05601     }
05602 
05603     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
05604 
05605     OldPriority = Process-&gt;Vm.MemoryPriority;
05606     Process-&gt;Vm.MemoryPriority = MemoryPriority;
05607 
05608     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
05609 
05610 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
05611 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (OldPriority &gt; MemoryPriority &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>) {
05612         <span class="comment">//</span>
05613         <span class="comment">// The priority is being lowered, see if the working set</span>
05614         <span class="comment">// should be trimmed.</span>
05615         <span class="comment">//</span>
05616 
05617         <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
05618         ULONG i;
05619         ULONG Trim;
05620         LOGICAL Attached;
05621 
05622         VmSupport = &amp;Process-&gt;Vm;
05623         i = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>;
05624         <span class="keywordflow">if</span> ((LONG)i &gt; 0) {
05625             Trim = i;
05626             <span class="keywordflow">if</span> (Trim &gt; <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a>) {
05627                 Trim = <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a>;
05628             }
05629             <span class="keywordflow">if</span> (Process != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
05630                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
05631                 Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05632             }
05633             <span class="keywordflow">else</span> {
05634                 Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05635             }
05636             <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
05637 
05638             Trim = <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (Trim,
05639                                      VmSupport,
05640                                      FALSE);
05641 
05642             <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
05643             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &lt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
05644                 <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
05645             }
05646 
05647             <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
05648             <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05649                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
05650             }
05651         }
05652     }
05653 <span class="preprocessor">#endif</span>
05654 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
05655 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="procsup.c::VadTreeWalk" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VadTreeWalk           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Start</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a8" doxytag="procsup.c::BBTBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d4/d5/procsup_8c.html#a8">BBTBuffer</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00092">92</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="procsup.c::KernelDemandZeroPte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="el" href="../../d4/d5/procsup_8c.html#a14">KernelDemandZeroPte</a> = {MM_KERNEL_DEMAND_ZERO_PTE}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00101">101</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l03445">MmInPageKernelStack()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l03180">MmOutPageKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="procsup.c::MiFaultRetries" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d5/procsup_8c.html#a16">MiFaultRetries</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00105">105</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="procsup.c::MiNoLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d8/d8/sysload_8c.html#a24">MiNoLowMemory</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00160">160</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="procsup.c::MmKernelStackPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d5/procsup_8c.html#a10">MmKernelStackPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00096">96</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="procsup.c::MmKernelStackResident" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">97</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02921">MmGrowKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03445">MmInPageKernelStack()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l03180">MmOutPageKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="procsup.c::MmLargeStacks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d5/procsup_8c.html#a12">MmLargeStacks</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00098">98</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="procsup.c::MmProcessCommit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d4/d5/procsup_8c.html#a9">MmProcessCommit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00094">94</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="procsup.c::MmProductType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d5/procsup_8c.html#a5">MmProductType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00086">86</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="procsup.c::MmRotatingUniprocessorNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CCHAR <a class="el" href="../../d4/d5/procsup_8c.html#a15">MmRotatingUniprocessorNumber</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00103">103</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="procsup.c::MmSmallStacks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d5/procsup_8c.html#a13">MmSmallStacks</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00099">99</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="procsup.c::MmSystemSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> <a class="el" href="../../d4/d5/procsup_8c.html#a7">MmSystemSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00090">90</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l03073">MmQuerySystemSize()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="procsup.c::MmWorkingSetReductionMax" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a13">MmWorkingSetReductionMax</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00088">88</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
