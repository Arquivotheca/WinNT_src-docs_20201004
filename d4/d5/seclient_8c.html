<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: seclient.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>seclient.c File Reference</h1><code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "seopaque.h"</code><br>

<p>
<a href="../../d5/d4/seclient_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/seclient_8c.html#a0">SepCreateClientSecurity</a> (IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PSECURITY_QUALITY_OF_SERVICE ClientSecurityQos, IN BOOLEAN ServerIsRemote, TOKEN_TYPE TokenType, BOOLEAN ThreadEffectiveOnly, SECURITY_IMPERSONATION_LEVEL ImpersonationLevel, OUT <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/seclient_8c.html#a1">SeCreateClientSecurity</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ClientThread, IN PSECURITY_QUALITY_OF_SERVICE ClientSecurityQos, IN BOOLEAN ServerIsRemote, OUT <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/seclient_8c.html#a2">SeImpersonateClient</a> (IN <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext, IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ServerThread OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/seclient_8c.html#a3">SeImpersonateClientEx</a> (IN <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext, IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ServerThread OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/seclient_8c.html#a4">SeCreateClientSecurityFromSubjectContext</a> (IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext, IN PSECURITY_QUALITY_OF_SERVICE ClientSecurityQos, IN BOOLEAN ServerIsRemote, OUT <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a> ClientContext)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="seclient.c::SeCreateClientSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeCreateClientSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientThread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientSecurityQos</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerIsRemote</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/seclient_8c-source.html#l00209">209</a> of file <a class="el" href="../../d5/d4/seclient_8c-source.html">seclient.c</a>.
<p>
References <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00208">PsReferenceEffectiveToken()</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00062">SepCreateClientSecurity()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l10107">MESSAGECALL()</a>, <a class="el" href="../../d0/d0/psimpers_8c-source.html#l00026">NtImpersonateThread()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.
<p>
<pre class="fragment"><div>00218                    :
00219 
00220     This service initializes a context block to represent a client's
00221     security context.  This may simply result in a reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00222     client's token, or may cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's token to be duplicated,
00223     depending upon <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security quality of service information specified.
00224 
00225                                NOTE
00226 
00227         The code in <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> optimized <span class="keywordflow">for</span> DYNAMIC context
00228         tracking.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> mode in which direct access to a
00229         caller's token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode expected to be used
00230         most often.  <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> context tracking always requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00231         caller's token to be copied.
00232 
00233 
00234 Arguments:
00235 
00236     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's thread.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to
00237         locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's security context (token).
00238 
00239     ClientSecurityQos - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security quality of service
00240         parameters specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client <span class="keywordflow">for</span> <span class="keyword">this</span> communication
00241         session.
00242 
00243     ServerIsRemote - Provides an indication as to whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session
00244         <span class="keyword">this</span> context block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being used <span class="keywordflow">for</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an inter-system
00245         session or intra-system session.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reconciled with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00246         impersonation level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client thread's token (in <span class="keywordflow">case</span> the
00247         client has a client of his own that didn't specify delegation).
00248 
00249     ClientContext - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client security context block to be
00250         initialized.
00251 
00252 
00253 Return Value:
00254 
00255     STATUS_SUCCESS - The service completed successfully.
00256 
00257     STATUS_BAD_IMPERSONATION_LEVEL - The client <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently
00258         impersonating either an Anonymous or Identification level
00259         token, which can not be passed on <span class="keywordflow">for</span> use by another server.
00260         This status may also be returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security context
00261         block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> an inter-system communication session and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00262         client thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> impersonating a client of its own <span class="keyword">using</span>
00263         other than delegation impersonation level.
00264 
00265 
00266 --*/
00267 
00268 {
00269     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00270     PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00271     TOKEN_TYPE TokenType;
00272     BOOLEAN ThreadEffectiveOnly;
00273     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel;
00274     PACCESS_TOKEN DuplicateToken;
00275 
00276     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00277 
00278     <span class="comment">//</span>
00279     <span class="comment">// Gain access to the client thread's effective token</span>
00280     <span class="comment">//</span>
00281 
00282     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a2">PsReferenceEffectiveToken</a>(
00283                 ClientThread,
00284                 &amp;TokenType,
00285                 &amp;ThreadEffectiveOnly,
00286                 &amp;ImpersonationLevel
00287                 );
00288 
00289 
00290     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a0">SepCreateClientSecurity</a>(
00291                 Token,
00292                 ClientSecurityQos,
00293                 ServerIsRemote,
00294                 TokenType,
00295                 ThreadEffectiveOnly,
00296                 ImpersonationLevel,
00297                 ClientContext );
00298 
00299     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00300 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="seclient.c::SeCreateClientSecurityFromSubjectContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeCreateClientSecurityFromSubjectContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientSecurityQos</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerIsRemote</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/seclient_8c-source.html#l00712">712</a> of file <a class="el" href="../../d5/d4/seclient_8c-source.html">seclient.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00062">SepCreateClientSecurity()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00732">SeQuerySubjectContextToken</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
<pre class="fragment"><div>00720                    :
00721 
00722     This service initializes a context block to represent a client's
00723     security context.  This may simply result in a reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00724     client's token, or may cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's token to be duplicated,
00725     depending upon <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security quality of service information specified.
00726 
00727                                NOTE
00728 
00729         The code in <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> optimized <span class="keywordflow">for</span> DYNAMIC context
00730         tracking.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> mode in which direct access to a
00731         caller's token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode expected to be used
00732         most often.  <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> context tracking always requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00733         caller's token to be copied.
00734 
00735 
00736 Arguments:
00737 
00738     SubjectContext - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SubjectContext that should serve
00739         as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basis <span class="keywordflow">for</span> <span class="keyword">this</span> client context.
00740 
00741     ClientSecurityQos - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security quality of service
00742         parameters specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client <span class="keywordflow">for</span> <span class="keyword">this</span> communication
00743         session.
00744 
00745     ServerIsRemote - Provides an indication as to whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session
00746         <span class="keyword">this</span> context block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being used <span class="keywordflow">for</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an inter-system
00747         session or intra-system session.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reconciled with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00748         impersonation level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client thread's token (in <span class="keywordflow">case</span> the
00749         client has a client of his own that didn't specify delegation).
00750 
00751     ClientContext - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client security context block to be
00752         initialized.
00753 
00754 
00755 Return Value:
00756 
00757     STATUS_SUCCESS - The service completed successfully.
00758 
00759     STATUS_BAD_IMPERSONATION_LEVEL - The client <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently
00760         impersonating either an Anonymous or Identification level
00761         token, which can not be passed on <span class="keywordflow">for</span> use by another server.
00762         This status may also be returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security context
00763         block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> an inter-system communication session and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00764         client thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> impersonating a client of its own <span class="keyword">using</span>
00765         other than delegation impersonation level.
00766 
00767 
00768 --*/
00769 
00770 {
00771     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00772     PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00773     TOKEN_TYPE Type;
00774     BOOLEAN ThreadEffectiveOnly;
00775     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel;
00776     PACCESS_TOKEN DuplicateToken;
00777 
00778     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00779 
00780     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d0/d5/se_8h.html#a16">SeQuerySubjectContextToken</a>(
00781                 SubjectContext
00782                 );
00783 
00784     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( Token );
00785 
00786     <span class="keywordflow">if</span> ( SubjectContext-&gt;ClientToken )
00787     {
00788         Type = TokenImpersonation ;
00789     }
00790     <span class="keywordflow">else</span> 
00791     {
00792         Type = TokenPrimary ;
00793     }
00794 
00795     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a0">SepCreateClientSecurity</a>(
00796                 Token,
00797                 ClientSecurityQos,
00798                 ServerIsRemote,
00799                 Type,
00800                 FALSE,
00801                 SubjectContext-&gt;ImpersonationLevel,
00802                 ClientContext
00803                 );
00804 
00805     
00806     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00807 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="seclient.c::SeImpersonateClient" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeImpersonateClient           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ServerThread&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/seclient_8c-source.html#l00593">593</a> of file <a class="el" href="../../d5/d4/seclient_8c-source.html">seclient.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00636">SeImpersonateClientEx()</a>, <a class="el" href="../../d9/d0/userver_8c-source.html#l00173">ServerThread()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>00599                    :
00600 
00601     This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread to impersonate a
00602     client.  The client security context in ClientContext <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to
00603     be up to date.
00604 
00605 
00606 Arguments:
00607 
00608     ClientContext - Points to client security context block.
00609 
00610     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> - (Optional) Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to
00611         impersonate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client.  If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00612         used.
00613 
00614 
00615 Return Value:
00616 
00617     None.
00618 
00619 
00620 --*/
00621 
00622 
00623 {
00624 
00625     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00626 
00627 <span class="preprocessor">#if DBG</span>
00628 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE:  Obsolete call:  SeImpersonateClient\n"</span>);
00629 <span class="preprocessor">#endif</span>
00630 <span class="preprocessor"></span>
00631     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d4/d5/seclient_8c.html#a3">SeImpersonateClientEx</a>( ClientContext, ServerThread );
00632 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="seclient.c::SeImpersonateClientEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeImpersonateClientEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ServerThread&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/seclient_8c-source.html#l00636">636</a> of file <a class="el" href="../../d5/d4/seclient_8c-source.html">seclient.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>, <a class="el" href="../../d9/d0/userver_8c-source.html#l00173">ServerThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02256">_ImpersonateDdeClientWindow()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00032">NtImpersonateClientOfPort()</a>, <a class="el" href="../../d0/d0/psimpers_8c-source.html#l00026">NtImpersonateThread()</a>, and <a class="el" href="../../d5/d4/seclient_8c-source.html#l00593">SeImpersonateClient()</a>.
<p>
<pre class="fragment"><div>00642                    :
00643 
00644     This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread to impersonate a
00645     client.  The client security context in ClientContext <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to
00646     be up to date.
00647 
00648 
00649 Arguments:
00650 
00651     ClientContext - Points to client security context block.
00652 
00653     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> - (Optional) Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to
00654         impersonate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client.  If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00655         used.
00656 
00657 
00658 Return Value:
00659 
00660     None.
00661 
00662 
00663 --*/
00664 
00665 
00666 {
00667 
00668     BOOLEAN EffectiveValueToUse;
00669     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00670     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00671 
00672     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00673 
00674     <span class="keywordflow">if</span> (ClientContext-&gt;DirectlyAccessClientToken) {
00675         EffectiveValueToUse = ClientContext-&gt;DirectAccessEffectiveOnly;
00676     } <span class="keywordflow">else</span> {
00677         EffectiveValueToUse = ClientContext-&gt;SecurityQos.EffectiveOnly;
00678     }
00679 
00680 
00681 
00682     <span class="comment">//</span>
00683     <span class="comment">// if a ServerThread wasn't specified, then default to the current</span>
00684     <span class="comment">// thread.</span>
00685     <span class="comment">//</span>
00686 
00687     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServerThread)) {
00688         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00689     } <span class="keywordflow">else</span> {
00690         Thread = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
00691     }
00692 
00693 
00694 
00695     <span class="comment">//</span>
00696     <span class="comment">// Assign the context to the calling thread</span>
00697     <span class="comment">//</span>
00698 
00699     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>( Thread,
00700                          ClientContext-&gt;ClientToken,
00701                          TRUE,
00702                          EffectiveValueToUse,
00703                          ClientContext-&gt;SecurityQos.ImpersonationLevel
00704                          );
00705 
00706     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00707 
00708 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="seclient.c::SepCreateClientSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepCreateClientSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientSecurityQos</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerIsRemote</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>TOKEN_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadEffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SECURITY_IMPERSONATION_LEVEL&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationLevel</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">PSECURITY_CLIENT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/seclient_8c-source.html#l00062">62</a> of file <a class="el" href="../../d5/d4/seclient_8c-source.html">seclient.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00713">ObDeleteCapturedInsertInfo()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00840">PsDereferenceImpersonationToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01227">SeCopyClientToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00475">SeGetTokenControlInformation()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00225">SepBadImpersonationLevel</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/seclient_8c-source.html#l00209">SeCreateClientSecurity()</a>, and <a class="el" href="../../d5/d4/seclient_8c-source.html#l00712">SeCreateClientSecurityFromSubjectContext()</a>.
<p>
<pre class="fragment"><div>00071 {
00072     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00073     PACCESS_TOKEN DuplicateToken;
00074 
00075     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00076 
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">// Make sure the client is not trying to abuse use of a</span>
00080     <span class="comment">// client of its own by attempting an invalid impersonation.</span>
00081     <span class="comment">// Also set the ClientContext-&gt;DirectAccessEffectiveOnly flag</span>
00082     <span class="comment">// appropriately if the impersonation is legitimate.  The</span>
00083     <span class="comment">// DirectAccessEffectiveOnly flag value will end up being ignored</span>
00084     <span class="comment">// if STATIC mode is requested, but this is the most efficient</span>
00085     <span class="comment">// place to calculate it, and we are optimizing for DYNAMIC mode.</span>
00086     <span class="comment">//</span>
00087 
00088     <span class="keywordflow">if</span> (TokenType == TokenImpersonation) {
00089 
00090         <span class="keywordflow">if</span> ( ClientSecurityQos-&gt;ImpersonationLevel &gt; ImpersonationLevel) {
00091 
00092             <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( Token );
00093             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00094 
00095         }
00096 
00097 
00098         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a10">SepBadImpersonationLevel</a>(ImpersonationLevel,ServerIsRemote)) {
00099 
00100             <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( Token );
00101             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00102 
00103         } <span class="keywordflow">else</span> {
00104 
00105             <span class="comment">//</span>
00106             <span class="comment">// TokenType is TokenImpersonation and the impersonation is legit.</span>
00107             <span class="comment">// Set the DirectAccessEffectiveOnly flag to be the minimum of</span>
00108             <span class="comment">// the current thread value and the caller specified value.</span>
00109             <span class="comment">//</span>
00110 
00111             ClientContext-&gt;DirectAccessEffectiveOnly =
00112                 ( (ThreadEffectiveOnly || (ClientSecurityQos-&gt;EffectiveOnly)) ?
00113                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00114         }
00115 
00116     } <span class="keywordflow">else</span> {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">// TokenType is TokenPrimary.  In this case, the client specified</span>
00120         <span class="comment">// EffectiveOnly value is always used.</span>
00121         <span class="comment">//</span>
00122 
00123         ClientContext-&gt;DirectAccessEffectiveOnly =
00124             ClientSecurityQos-&gt;EffectiveOnly;
00125     }
00126 
00127 
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// Copy the token if necessary (i.e., static tracking requested)</span>
00131     <span class="comment">//</span>
00132 
00133     <span class="keywordflow">if</span> (ClientSecurityQos-&gt;ContextTrackingMode == SECURITY_STATIC_TRACKING) {
00134 
00135         ClientContext-&gt;DirectlyAccessClientToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00136 
00137         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a6">SeCopyClientToken</a>(
00138                      Token,
00139                      ClientSecurityQos-&gt;ImpersonationLevel,
00140                      KernelMode,
00141                      &amp;DuplicateToken
00142                      );
00143 
00144 
00145         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00146             <a class="code" href="../../d6/d0/obcreate_8c.html#a10">ObDeleteCapturedInsertInfo</a>(DuplicateToken);
00147             }
00148         <span class="comment">//</span>
00149         <span class="comment">// No longer need the pointer to the client's token</span>
00150         <span class="comment">//</span>
00151 
00152         <span class="keywordflow">if</span> (TokenType == TokenPrimary) {
00153             <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( Token );
00154         } <span class="keywordflow">else</span> {
00155             <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( Token );
00156         }
00157 
00158         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = DuplicateToken;
00159 
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">// If there was an error, we're done.</span>
00163         <span class="comment">//</span>
00164         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00165             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00166         }
00167 
00168     } <span class="keywordflow">else</span> {
00169 
00170         ClientContext-&gt;DirectlyAccessClientToken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00171 
00172         <span class="keywordflow">if</span> (ServerIsRemote) {
00173             <span class="comment">//</span>
00174             <span class="comment">// Get a copy of the client token's control information</span>
00175             <span class="comment">// so that we can tell if it changes in the future.</span>
00176             <span class="comment">//</span>
00177 
00178             <a class="code" href="../../d4/d3/token_8c.html#a10">SeGetTokenControlInformation</a>( Token,
00179                                           &amp;ClientContext-&gt;ClientTokenControl
00180                                           );
00181 
00182         }
00183 
00184     }
00185 
00186 
00187 
00188     ClientContext-&gt;SecurityQos.Length =
00189         (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
00190 
00191     ClientContext-&gt;SecurityQos.ImpersonationLevel =
00192         ClientSecurityQos-&gt;ImpersonationLevel;
00193 
00194     ClientContext-&gt;SecurityQos.ContextTrackingMode =
00195         ClientSecurityQos-&gt;ContextTrackingMode;
00196 
00197     ClientContext-&gt;SecurityQos.EffectiveOnly =
00198         ClientSecurityQos-&gt;EffectiveOnly;
00199 
00200     ClientContext-&gt;ServerIsRemote = ServerIsRemote;
00201 
00202     ClientContext-&gt;ClientToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00203 
00204     <span class="keywordflow">return</span> STATUS_SUCCESS;
00205 
00206 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
