<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flush2.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flush2.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d5/d4/flush2_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/flush2_8c.html#a0">KeFlushIoBuffers</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl, IN BOOLEAN ReadOperation, IN BOOLEAN DmaOperation)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="flush2.c::KeFlushIoBuffers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeFlushIoBuffers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReadOperation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DmaOperation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/flush2_8c-source.html#l00029">29</a> of file <a class="el" href="../../d5/d4/flush2_8c-source.html">flush2.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00430">MDL_IO_PAGE_READ</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
<pre class="fragment"><div>00036                    :
00037 
00038    This function flushes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O buffer specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory descriptor
00039    list from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data cache on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor which executes.
00040 
00041 Arugements:
00042 
00043    Mdl - Supplies a pointer to a memory descriptor list that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00044        I/O buffer location.
00045 
00046    ReadOperation - Supplies a <span class="keywordtype">boolean</span> value that determines whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O
00047        operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a read into memory.
00048 
00049    DmaOperation - Supplies a <span class="keywordtype">boolean</span> value that deternines whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O
00050        operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a DMA operation.
00051 
00052 Return Value:
00053 
00054    None.
00055 
00056 --*/
00057 {
00058     KIRQL  OldIrql;
00059     ULONG  Length, PartialLength, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00060     PFN_NUMBER  PageFrameIndex;
00061     PPFN_NUMBER Page;
00062     PVOID CurrentVAddress = 0;
00063 
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;=  KiSynchIrql);
00065 
00066     <span class="comment">//</span>
00067     <span class="comment">// If the operation is a DMA operation, then check if the flush</span>
00068     <span class="comment">// can be avoided because the host system supports the right set</span>
00069     <span class="comment">// of cache coherency attributes. Otherwise, the flush can also</span>
00070     <span class="comment">// be avoided if the operation is a programmed I/O and not a page</span>
00071     <span class="comment">// read.</span>
00072     <span class="comment">//</span>
00073 
00074     <span class="keywordflow">if</span> (DmaOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00075         <span class="keywordflow">if</span> (ReadOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00076 
00077         <span class="comment">//</span>
00078         <span class="comment">// Yes, it is a DMA operation, and yes, it is a read. IA64</span>
00079         <span class="comment">// I-Caches DO snoop for DMA cycles.</span>
00080         <span class="comment">//</span>
00081             <span class="keywordflow">return</span>;
00082         } <span class="keywordflow">else</span> {
00083              <span class="comment">//</span>
00084              <span class="comment">// It is a DMA Write operation</span>
00085              <span class="comment">//</span>
00086              __mf();
00087              <span class="keywordflow">return</span>;
00088         }
00089 
00090     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Mdl-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a18">MDL_IO_PAGE_READ</a>) == 0) {
00091         <span class="comment">//</span>
00092         <span class="comment">// It is a PIO operation and it is not Page in operation</span>
00093         <span class="comment">//</span>
00094         <span class="keywordflow">return</span>;
00095     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReadOperation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00096 
00097         <span class="comment">//</span>
00098         <span class="comment">// It is a PIO operation, it is Read operation and is Page in</span>
00099         <span class="comment">// operation.</span>
00100         <span class="comment">// We need to sweep the cache.</span>
00101         <span class="comment">// Sweeping the range covered by the mdl will be broadcast to the</span>
00102         <span class="comment">// other processors by the h/w coherency mechanism.</span>
00103         <span class="comment">//</span>
00104         <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00105         <span class="comment">//</span>
00106 
00107         OldIrql = KeRaiseIrqlToSynchLevel();
00108 
00109         <span class="comment">//</span>
00110         <span class="comment">// Compute the number of pages to flush and the starting MDL page</span>
00111         <span class="comment">// frame address.</span>
00112         <span class="comment">//</span>
00113 
00114         Length = Mdl-&gt;ByteCount;
00115 
00116         <span class="keywordflow">if</span> ( !Length ) {
00117             <span class="keywordflow">return</span>;
00118         }
00119         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = Mdl-&gt;ByteOffset;
00120         PartialLength = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00121         <span class="keywordflow">if</span> (PartialLength &gt; Length) {
00122             PartialLength = Length;
00123         }
00124 
00125         Page = (PPFN_NUMBER)(Mdl + 1);
00126         PageFrameIndex = *Page;
00127         CurrentVAddress = ((PVOID)(KSEG3_BASE
00128                           | ((ULONG_PTR)(PageFrameIndex) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)
00129                           | <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>));
00130 
00131         <span class="comment">//</span>
00132         <span class="comment">// Region 4 maps 1:1 Virtual address to physical address</span>
00133         <span class="comment">//</span>
00134 
00135         HalSweepIcacheRange (
00136             CurrentVAddress,
00137             PartialLength
00138             );
00139 
00140         Page++;
00141         Length -= PartialLength;
00142 
00143         <span class="keywordflow">if</span> (Length) {
00144             PartialLength = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00145             <span class="keywordflow">do</span> {
00146                 PageFrameIndex = *Page;
00147                 CurrentVAddress = ((PVOID)(KSEG3_BASE
00148                     | ((ULONG_PTR)(PageFrameIndex) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)
00149                     | <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>));
00150 
00151                 <span class="keywordflow">if</span> (PartialLength &gt; Length) {
00152                     PartialLength = Length;
00153                 }
00154 
00155                 HalSweepIcacheRange (
00156                     CurrentVAddress,
00157                     PartialLength
00158                     );
00159 
00160                 Page++;
00161 
00162                 Length -= PartialLength;
00163             } <span class="keywordflow">while</span> (Length != 0);
00164         }
00165 
00166     <span class="comment">//</span>
00167     <span class="comment">// Synchronize the Instruction Prefetch pipe in the local processor.</span>
00168     <span class="comment">//</span>
00169 
00170     __synci();
00171     __isrlz();
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">// Lower IRQL to its previous level and return.</span>
00175     <span class="comment">//</span>
00176    
00177     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00178     <span class="keywordflow">return</span>;
00179     }
00180 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:43 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
