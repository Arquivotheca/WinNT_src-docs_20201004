<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: visrgn.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>visrgn.c</h1><a href="../../d3/d6/visrgn_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: visrgn.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains User's visible region ('visrgn') manipulation</span>
00007 <span class="comment">* functions.</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">* 23-Oct-1990 DarrinM   Created.</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/*</span>
00017 <span class="comment"> * Globals used to keep track of pwnds which</span>
00018 <span class="comment"> * need to be excluded from the visrgns.</span>
00019 <span class="comment"> */</span>
<a name="l00020"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a0">00020</a> <span class="preprocessor">#define CEXCLUDERECTSMAX 30</span>
<a name="l00021"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a1">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define CEXCLUDEPWNDSMAX 30</span>
00022 <span class="preprocessor"></span>
00023 
<a name="l00024"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a4">00024</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d3/d6/visrgn_8c.html#a4">gfVisAlloc</a>;
<a name="l00025"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a5">00025</a> <span class="keywordtype">int</span>   <a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a>;
<a name="l00026"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a6">00026</a> <span class="keywordtype">int</span>   <a class="code" href="../../d3/d6/visrgn_8c.html#a6">gcrcVisExcludeMax</a>;
<a name="l00027"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a7">00027</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> *<a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>;
<a name="l00028"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a8">00028</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> *<a class="code" href="../../d3/d6/visrgn_8c.html#a8">gapwndVisDefault</a>;
00029 
00030 <span class="comment">/***************************************************************************\</span>
00031 <span class="comment">* SetRectRgnIndirect</span>
00032 <span class="comment">*</span>
00033 <span class="comment">* Sets a rect region from a rectangle.</span>
00034 <span class="comment">*</span>
00035 <span class="comment">* History:</span>
00036 <span class="comment">* 26-Sep-1996 adams     Created.</span>
00037 <span class="comment">\***************************************************************************/</span>
00038 
00039 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00040"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a9">00040</a> <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(HRGN hrgn, LPCRECT lprc)
00041 {
00042     <span class="keywordflow">return</span> GreSetRectRgn(hrgn, lprc-&gt;left, lprc-&gt;top, lprc-&gt;right, lprc-&gt;bottom);
00043 }
00044 
00045 
00046 
00047 <span class="comment">/***************************************************************************\</span>
00048 <span class="comment">* CreateEmptyRgn</span>
00049 <span class="comment">*</span>
00050 <span class="comment">* Creates an empty region.</span>
00051 <span class="comment">*</span>
00052 <span class="comment">* History:</span>
00053 <span class="comment">* 24-Sep-1996 adams     Created.</span>
00054 <span class="comment">\***************************************************************************/</span>
00055 
00056 HRGN
<a name="l00057"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a10">00057</a> <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>(<span class="keywordtype">void</span>)
00058 {
00059     <span class="keywordflow">return</span> GreCreateRectRgnIndirect(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a6">PZERO</a>(RECT));
00060 }
00061 
00062 
00063 
00064 <span class="comment">/***************************************************************************\</span>
00065 <span class="comment">* CreateEmptyRgnPublic</span>
00066 <span class="comment">*</span>
00067 <span class="comment">* Creates an empty region and make it public.</span>
00068 <span class="comment">*</span>
00069 <span class="comment">* History:</span>
00070 <span class="comment">* 24-Sep-1996 adams     Created.</span>
00071 <span class="comment">\***************************************************************************/</span>
00072 
00073 HRGN
<a name="l00074"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a11">00074</a> <a class="code" href="../../d4/d1/userk_8h.html#a1163">CreateEmptyRgnPublic</a>(<span class="keywordtype">void</span>)
00075 {
00076     HRGN hrgn;
00077 
00078     <span class="keywordflow">if</span> (hrgn = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>()) {
00079         UserVerify(GreSetRegionOwner(hrgn, OBJECT_OWNER_PUBLIC));
00080     }
00081 
00082     <span class="keywordflow">return</span> hrgn;
00083 }
00084 
00085 
00086 
00087 <span class="comment">/***************************************************************************\</span>
00088 <span class="comment">* SetEmptyRgn</span>
00089 <span class="comment">*</span>
00090 <span class="comment">* Sets an empty region.</span>
00091 <span class="comment">*</span>
00092 <span class="comment">* History:</span>
00093 <span class="comment">* 26-Sep-1996 adams     Created.</span>
00094 <span class="comment">\***************************************************************************/</span>
00095 
00096 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00097"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a12">00097</a> <a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(HRGN hrgn)
00098 {
00099     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(hrgn, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a6">PZERO</a>(RECT));
00100 }
00101 
00102 
00103 
00104 <span class="comment">/***************************************************************************\</span>
00105 <span class="comment">* SetOrCreateRectRgnIndirectPublic</span>
00106 <span class="comment">*</span>
00107 <span class="comment">* Sets a region to a rectangle, creating it and making it public</span>
00108 <span class="comment">* if it is not already there.</span>
00109 <span class="comment">*</span>
00110 <span class="comment">* History:</span>
00111 <span class="comment">* 01-Oct-1996 adams     Created.</span>
00112 <span class="comment">\***************************************************************************/</span>
00113 
00114 HRGN
<a name="l00115"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a13">00115</a> <a class="code" href="../../d3/d6/visrgn_8c.html#a13">SetOrCreateRectRgnIndirectPublic</a>(HRGN * phrgn, LPCRECT lprc)
00116 {
00117     <span class="keywordflow">if</span> (*phrgn) {
00118         UserVerify(<a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(*phrgn, lprc));
00119     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*phrgn = GreCreateRectRgnIndirect((LPRECT) lprc)) {
00120         UserVerify(GreSetRegionOwner(*phrgn, OBJECT_OWNER_PUBLIC));
00121     }
00122 
00123     <span class="keywordflow">return</span> *phrgn;
00124 }
00125 
00126 
00127 <span class="comment">/***************************************************************************\</span>
00128 <span class="comment">* ResizeVisExcludeMemory</span>
00129 <span class="comment">*</span>
00130 <span class="comment">*   This routine is used to resize the vis-rgn memory buffer if the count</span>
00131 <span class="comment">*   is exceeded.</span>
00132 <span class="comment">*</span>
00133 <span class="comment">*</span>
00134 <span class="comment">* History:</span>
00135 <span class="comment">* 22-Oct-1994 ChrisWil  Created</span>
00136 <span class="comment">* 27-Feb-1997 adams     Removed call to UserReallocPool, since the pool</span>
00137 <span class="comment">*                       allocator doesn't support realloc.</span>
00138 <span class="comment">\***************************************************************************/</span>
00139 
<a name="l00140"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a14">00140</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d6/visrgn_8c.html#a14">ResizeVisExcludeMemory</a>(VOID)
00141 {
00142     <span class="keywordtype">int</span>     crcNew;
00143     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    apwndNew;
00144 
00145     <span class="comment">/*</span>
00146 <span class="comment">     * Note (adams): a previous version of the code called UserReallocPool</span>
00147 <span class="comment">     * if memory had already been allocated. Unfortunately, UserReallocPool</span>
00148 <span class="comment">     * just has to allocate more memory and copy the contents, since Rtl</span>
00149 <span class="comment">     * doesn't have a realloc function. If Rtl later gains a Realloc function,</span>
00150 <span class="comment">     * this code should be changed to the previous version.</span>
00151 <span class="comment">     */</span>
00152 
00153     crcNew = <a class="code" href="../../d3/d6/visrgn_8c.html#a6">gcrcVisExcludeMax</a> + <a class="code" href="../../d3/d6/visrgn_8c.html#a1">CEXCLUDEPWNDSMAX</a>;
00154     apwndNew = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)UserAllocPool(
00155             crcNew * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>), TAG_VISRGN);
00156 
00157     <span class="keywordflow">if</span> (!apwndNew)
00158         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00159 
00160     UserAssert(<a class="code" href="../../d3/d6/visrgn_8c.html#a6">gcrcVisExcludeMax</a> == <a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a>);
00161     RtlCopyMemory(apwndNew, <a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>, <a class="code" href="../../d3/d6/visrgn_8c.html#a6">gcrcVisExcludeMax</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a943">PWND</a>));
00162     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/visrgn_8c.html#a4">gfVisAlloc</a>) {
00163         UserFreePool(<a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>);
00164     } <span class="keywordflow">else</span> {
00165         <a class="code" href="../../d3/d6/visrgn_8c.html#a4">gfVisAlloc</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00166     }
00167 
00168     <a class="code" href="../../d3/d6/visrgn_8c.html#a6">gcrcVisExcludeMax</a> = crcNew;
00169     <a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a943">PWND</a> *)apwndNew;
00170     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00171 }
00172 
00173 
00174 
00175 <span class="comment">/***************************************************************************\</span>
00176 <span class="comment">* ExcludeWindowRects</span>
00177 <span class="comment">*   This routine checks to see if the pwnd needs to be added to the list</span>
00178 <span class="comment">*   of excluded-clip-rects.  If so, it appends the pwnd to the array.  They</span>
00179 <span class="comment">*   do not need to be sorted, since GreSubtractRgnRectList() sorts them</span>
00180 <span class="comment">*   internally.</span>
00181 <span class="comment">*</span>
00182 <span class="comment">*</span>
00183 <span class="comment">* History:</span>
00184 <span class="comment">* 05-Nov-1992 DavidPe   Created.</span>
00185 <span class="comment">* 21-Oct-1994 ChrisWil  Removed pwnd-&gt;pwndNextYX.  No longer sorts pwnds.</span>
00186 <span class="comment">\***************************************************************************/</span>
00187 
<a name="l00188"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a2">00188</a> <span class="preprocessor">#define CheckIntersectRect(prc1, prc2)        \</span>
00189 <span class="preprocessor">    (   prc1-&gt;left &lt; prc2-&gt;right              \</span>
00190 <span class="preprocessor">     &amp;&amp; prc2-&gt;left &lt; prc1-&gt;right              \</span>
00191 <span class="preprocessor">     &amp;&amp; prc1-&gt;top &lt; prc2-&gt;bottom              \</span>
00192 <span class="preprocessor">     &amp;&amp; prc2-&gt;top &lt; prc1-&gt;bottom)</span>
00193 <span class="preprocessor"></span>
<a name="l00194"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a3">00194</a> <span class="preprocessor">#define EmptyRect(prc)                        \</span>
00195 <span class="preprocessor">    (   prc-&gt;left &gt;= prc-&gt;right               \</span>
00196 <span class="preprocessor">     || prc-&gt;top &gt;= prc-&gt;bottom)</span>
00197 <span class="preprocessor"></span>
<a name="l00198"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a15">00198</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d6/visrgn_8c.html#a15">ExcludeWindowRects</a>(
00199     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd    ,
00200     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwndStop,
00201     LPRECT lprcIntersect)
00202 {
00203     PRECT prc;
00204 
00205 <span class="preprocessor">#if DBG</span>
00206 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwndStop != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00207             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != pwndStop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00208         RIPMSG0(RIP_ERROR, <span class="stringliteral">"ExcludeWindowRects: bad windows passed in"</span>);
00209     }
00210 <span class="preprocessor">#endif</span>
00211 <span class="preprocessor"></span>
00212     <span class="keywordflow">while</span> ((pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwnd != pwndStop)) {
00213         UserAssert(pwnd);
00214         prc = &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00215         <span class="keywordflow">if</span> (       <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)
00216                 &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd)
00217                 &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a617">WEFTRANSPARENT</a>) == 0)
00218                 &amp;&amp; <a class="code" href="../../d3/d6/visrgn_8c.html#a2">CheckIntersectRect</a>(lprcIntersect, prc)
00219                 &amp;&amp; !<a class="code" href="../../d3/d6/visrgn_8c.html#a3">EmptyRect</a>(prc)) {
00220 
00221             UserAssert(<a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a> &lt;= <a class="code" href="../../d3/d6/visrgn_8c.html#a6">gcrcVisExcludeMax</a>);
00222             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a> == <a class="code" href="../../d3/d6/visrgn_8c.html#a6">gcrcVisExcludeMax</a>) {
00223                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/visrgn_8c.html#a14">ResizeVisExcludeMemory</a>()) {
00224                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00225                 }
00226             }
00227 
00228             <a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>[<a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a>++] = pwnd;
00229         }
00230 
00231         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00232     }
00233 
00234     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00235 }
00236 
00237 
00238 
00239 <span class="comment">/***************************************************************************\</span>
00240 <span class="comment">* CalcWindowVisRgn</span>
00241 <span class="comment">*</span>
00242 <span class="comment">*   This routine performs the work of calculating the VisRgn for a window.</span>
00243 <span class="comment">*</span>
00244 <span class="comment">*</span>
00245 <span class="comment">* History:</span>
00246 <span class="comment">* 02-Nov-1992 DavidPe   Created.</span>
00247 <span class="comment">* 21-Oct-1992 ChrisWil  Removed pwnd-&gt;pwndNextYX.  No longer sorts pwnds.</span>
00248 <span class="comment">\***************************************************************************/</span>
00249 
<a name="l00250"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a16">00250</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d6/visrgn_8c.html#a16">CalcWindowVisRgn</a>(
00251     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00252     HRGN  *phrgn,
00253     DWORD flags)
00254 {
00255     RECT rcWindow;
00256     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
00257     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndRoot;
00258     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndLoop;
00259     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClipSiblings;
00260     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRgnParent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00261     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult;
00262     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> apwndVisDefault[<a class="code" href="../../d3/d6/visrgn_8c.html#a1">CEXCLUDEPWNDSMAX</a>];
00263 
00264 
00265     <span class="comment">/*</span>
00266 <span class="comment">     * First get the initial window rectangle which will be used for</span>
00267 <span class="comment">     * the basis of exclusion calculations.</span>
00268 <span class="comment">     */</span>
00269     rcWindow = (flags &amp; DCX_WINDOW ? pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a> : pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>);
00270 
00271     <span class="comment">/*</span>
00272 <span class="comment">     * Get the parent of this window.  We start at the parent and backtrack</span>
00273 <span class="comment">     * through the window-parent-list until we reach the end of the parent-</span>
00274 <span class="comment">     * list.  This will give us the intersect-rectangle which is used as</span>
00275 <span class="comment">     * the basis for checking intersection of the exclusion rects.</span>
00276 <span class="comment">     */</span>
00277     pwndRoot   = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwnd-&gt;spwndParent;
00278     pwndParent = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00279 
00280     <span class="comment">/*</span>
00281 <span class="comment">     * The parent can be NULL in the case when pwnd == pwndRoot. In other</span>
00282 <span class="comment">     * cases we should figure why the hell the parent is NULL.</span>
00283 <span class="comment">     */</span>
00284     <span class="keywordflow">if</span> (pwndParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00285 <span class="preprocessor">#if DBG</span>
00286 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pwnd != pwndRoot) {
00287             RIPMSG0(RIP_ERROR, <span class="stringliteral">"CalcWindowVisRgn: pwndParent is NULL"</span>);
00288         }
00289 <span class="preprocessor">#endif</span>
00290 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> NullRegion;
00291     }
00292 
00293     <span class="keywordflow">while</span> (pwndParent != pwndRoot) {
00294 
00295         <span class="comment">/*</span>
00296 <span class="comment">         * Don't clip layered DCs to the desktop. The surface of the layered</span>
00297 <span class="comment">         * DC is the size of the window and we always want to have the image</span>
00298 <span class="comment">         * of the entire window in that surface.</span>
00299 <span class="comment">         */</span>
00300         <span class="keywordflow">if</span> ((flags &amp; DCX_LAYERED) &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndParent) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>))
00301             <span class="keywordflow">break</span>;
00302 
00303         <span class="comment">/*</span>
00304 <span class="comment">         * Remember if any of the parents have a window region.</span>
00305 <span class="comment">         */</span>
00306         <span class="keywordflow">if</span> (pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00307             fRgnParent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00308 
00309         <span class="comment">/*</span>
00310 <span class="comment">         * Intersect the parent's client rectangle with the window rectangle.</span>
00311 <span class="comment">         */</span>
00312         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcWindow, &amp;rcWindow, &amp;pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>))
00313             <span class="keywordflow">goto</span> NullRegion;
00314 
00315         pwndParent = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00316     }
00317 
00318     <span class="comment">/*</span>
00319 <span class="comment">     * Initialize the VisRgn memory-buffer.  This is</span>
00320 <span class="comment">     * used to hold the pwnd's.</span>
00321 <span class="comment">     */</span>
00322     <a class="code" href="../../d3/d6/visrgn_8c.html#a8">gapwndVisDefault</a>  = apwndVisDefault;
00323     <a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>  = <a class="code" href="../../d3/d6/visrgn_8c.html#a8">gapwndVisDefault</a>;
00324     <a class="code" href="../../d3/d6/visrgn_8c.html#a6">gcrcVisExcludeMax</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(apwndVisDefault);
00325     <a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a>    = 0;
00326 
00327     <span class="comment">/*</span>
00328 <span class="comment">     * Build the list of exclude-rects.</span>
00329 <span class="comment">     */</span>
00330     fClipSiblings = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(flags &amp; DCX_CLIPSIBLINGS);
00331     pwndParent    = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00332     pwndLoop      = pwnd;
00333 
00334     <span class="keywordflow">while</span> (pwndParent != pwndRoot) {
00335 
00336         <span class="comment">/*</span>
00337 <span class="comment">         * Don't exclude siblings of a layered window when calculating</span>
00338 <span class="comment">         * the virgn of a layered redirection DC.  We must always have</span>
00339 <span class="comment">         * a complete image of this window in the redirection bitmap.</span>
00340 <span class="comment">         */</span>
00341         <span class="keywordflow">if</span> ((flags &amp; DCX_LAYERED) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwndLoop)) {
00342             fClipSiblings = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00343         }
00344 
00345         <span class="comment">/*</span>
00346 <span class="comment">         * Exclude any siblings if necessary.</span>
00347 <span class="comment">         */</span>
00348         <span class="keywordflow">if</span> (fClipSiblings &amp;&amp; (pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> != pwndLoop)) {
00349 
00350             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/visrgn_8c.html#a15">ExcludeWindowRects</a>(pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>,
00351                                     pwndLoop,
00352                                     &amp;rcWindow)) {
00353 
00354                 <span class="keywordflow">goto</span> NullRegion;
00355             }
00356         }
00357 
00358 
00359         <span class="comment">/*</span>
00360 <span class="comment">         * Set this flag for next time through the loop...</span>
00361 <span class="comment">         */</span>
00362         fClipSiblings = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>);
00363 
00364         pwndLoop      = pwndParent;
00365         pwndParent    = pwndLoop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00366     }
00367 
00368     <span class="keywordflow">if</span> ((flags &amp; DCX_CLIPCHILDREN) &amp;&amp; (pwnd-&gt;spwndChild != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00369 
00370         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/visrgn_8c.html#a15">ExcludeWindowRects</a>(pwnd-&gt;spwndChild, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;rcWindow)) {
00371             <span class="keywordflow">goto</span> NullRegion;
00372         }
00373     }
00374 
00375     <span class="comment">/*</span>
00376 <span class="comment">     * If there are rectangles to exclude call GDI to create</span>
00377 <span class="comment">     * a region excluding them from the window rectangle.  If</span>
00378 <span class="comment">     * not simply call GreSetRectRgn().</span>
00379 <span class="comment">     */</span>
00380     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a> &gt; 0) {
00381 
00382         RECT  arcVisRects[<a class="code" href="../../d3/d6/visrgn_8c.html#a0">CEXCLUDERECTSMAX</a>];
00383         PRECT arcExclude;
00384         <span class="keywordtype">int</span>   i;
00385         <span class="keywordtype">int</span>   ircVisExclude  = 0;
00386         <span class="keywordtype">int</span>   irgnVisExclude = 0;
00387 
00388         <span class="comment">/*</span>
00389 <span class="comment">         * If we need to exclude more rectangles than fit in</span>
00390 <span class="comment">         * the pre-allocated buffer, obviously we have to</span>
00391 <span class="comment">         * allocate one that's big enough.</span>
00392 <span class="comment">         */</span>
00393 
00394         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a> &lt;= <a class="code" href="../../d3/d6/visrgn_8c.html#a0">CEXCLUDERECTSMAX</a>) {
00395             arcExclude = arcVisRects;
00396         } <span class="keywordflow">else</span> {
00397             arcExclude = (PRECT)UserAllocPoolWithQuota(
00398                     <span class="keyword">sizeof</span>(RECT) * <a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a>, TAG_VISRGN);
00399 
00400             <span class="keywordflow">if</span> (!arcExclude)
00401                 <span class="keywordflow">goto</span> NullRegion;
00402         }
00403 
00404         <span class="comment">/*</span>
00405 <span class="comment">         * Now run through the list and put the</span>
00406 <span class="comment">         * window rectangles into the array for the call</span>
00407 <span class="comment">         * to CombineRgnRectList().</span>
00408 <span class="comment">         */</span>
00409         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d3/d6/visrgn_8c.html#a5">gcrcVisExclude</a>; i++) {
00410 
00411             <span class="comment">/*</span>
00412 <span class="comment">             * If the window has a clip-rgn associated with</span>
00413 <span class="comment">             * it, then re-use gpwneExcludeList[] entries for</span>
00414 <span class="comment">             * storing them.</span>
00415 <span class="comment">             */</span>
00416             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>[i]-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00417 
00418                 <a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>[irgnVisExclude++] = <a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>[i];
00419                 <span class="keywordflow">continue</span>;
00420             }
00421 
00422             <span class="comment">/*</span>
00423 <span class="comment">             * This window doesn't have a clipping region; remember its</span>
00424 <span class="comment">             * rect for clipping purposes.</span>
00425 <span class="comment">             */</span>
00426             arcExclude[ircVisExclude++] = <a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>[i]-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00427         }
00428 
00429         <span class="keywordflow">if</span> (*phrgn == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00430             *phrgn = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
00431 
00432         <span class="keywordflow">if</span> (ircVisExclude != 0) {
00433             GreSubtractRgnRectList(*phrgn,
00434                                    &amp;rcWindow,
00435                                    arcExclude,
00436                                    ircVisExclude);
00437         } <span class="keywordflow">else</span> {
00438             <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(*phrgn, &amp;rcWindow);
00439         }
00440 
00441         <span class="keywordflow">for</span> (i = 0; i &lt; irgnVisExclude; i++) {
00442 
00443             <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, &amp;<a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>[i]-&gt;rcWindow);
00444             <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>[i]-&gt;hrgnClip);
00445 
00446             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(*phrgn, *phrgn, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>) == NULLREGION)
00447                 <span class="keywordflow">break</span>;
00448         }
00449 
00450         <span class="keywordflow">if</span> (arcExclude != arcVisRects) {
00451             UserFreePool((HLOCAL)arcExclude);
00452         }
00453 
00454     } <span class="keywordflow">else</span> {
00455 
00456         <span class="comment">/*</span>
00457 <span class="comment">         * If the window was somehow destroyed, then we will return</span>
00458 <span class="comment">         * a null-region.  Emptying the rect will accomplish this.</span>
00459 <span class="comment">         */</span>
00460         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>)) {
00461             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;rcWindow);
00462         }
00463 
00464         <span class="comment">/*</span>
00465 <span class="comment">         * If there weren't any rectangles to exclude, simply call</span>
00466 <span class="comment">         * GreSetRectRgn() with the window rectangle.</span>
00467 <span class="comment">         */</span>
00468         <a class="code" href="../../d3/d6/visrgn_8c.html#a13">SetOrCreateRectRgnIndirectPublic</a>(phrgn, &amp;rcWindow);
00469     }
00470 
00471     <span class="comment">/*</span>
00472 <span class="comment">     * Clip out this window's window region</span>
00473 <span class="comment">     */</span>
00474     <span class="keywordflow">if</span> (pwnd-&gt;hrgnClip != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00475         <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(*phrgn, *phrgn, pwnd-&gt;hrgnClip);
00476     }
00477 
00478     <span class="comment">/*</span>
00479 <span class="comment">     * Clip out parent's window regions, if there are any.</span>
00480 <span class="comment">     */</span>
00481     <span class="keywordflow">if</span> (fRgnParent) {
00482 
00483         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00484 
00485         <span class="keywordflow">for</span> (pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00486                 pwndT != pwndRoot;
00487                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00488 
00489             <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00490 
00491                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(*phrgn, *phrgn, pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>) == NULLREGION)
00492                     <span class="keywordflow">break</span>;
00493             }
00494         }
00495     }
00496 
00497     fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00498     <span class="comment">// fall-through</span>
00499 
00500 Cleanup:
00501     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/visrgn_8c.html#a4">gfVisAlloc</a>) {
00502         UserFreePool((HLOCAL)<a class="code" href="../../d3/d6/visrgn_8c.html#a7">gapwndVisExclude</a>);
00503         <a class="code" href="../../d3/d6/visrgn_8c.html#a4">gfVisAlloc</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00504     }
00505 
00506     <span class="keywordflow">return</span> fResult;
00507 
00508 NullRegion:
00509     <a class="code" href="../../d3/d6/visrgn_8c.html#a13">SetOrCreateRectRgnIndirectPublic</a>(phrgn, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a6">PZERO</a>(RECT));
00510     fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00511     <span class="keywordflow">goto</span> Cleanup;
00512 }
00513 
00514 <span class="comment">/***************************************************************************\</span>
00515 <span class="comment">* CalcVisRgn</span>
00516 <span class="comment">*</span>
00517 <span class="comment">* Will return FALSE if the pwndOrg is not visible, TRUE otherwise.</span>
00518 <span class="comment">*</span>
00519 <span class="comment">* History:</span>
00520 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00521 <span class="comment">\***************************************************************************/</span>
00522 
<a name="l00523"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a17">00523</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(
00524     HRGN  *phrgn,
00525     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndOrg,
00526     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndClip,
00527     DWORD flags)
00528 {
00529     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>    pdesk;
00530 
00531     UserAssert(pwndOrg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00532 
00533     <span class="comment">/*</span>
00534 <span class="comment">     * If the window's not visible or is not an active desktop,</span>
00535 <span class="comment">     * or if the clip window is in the process of being destroyed,</span>
00536 <span class="comment">     * the visrgn is empty.</span>
00537 <span class="comment">     */</span>
00538     pdesk = pwndOrg-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk;
00539     
00540     UserAssert(pdesk);
00541     
00542     <span class="comment">/*</span>
00543 <span class="comment">     * Make sure this happens in the IO windowstation</span>
00544 <span class="comment">     */</span>
00545 <span class="preprocessor">#if DBG</span>
00546 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00547         UserAssert(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a> ||
00548                    !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1222">IsVisible</a>(pwndOrg));
00549     }
00550 <span class="preprocessor">#endif // DBG</span>
00551 <span class="preprocessor"></span>
00552     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwndOrg) || pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
00553         <span class="keywordflow">goto</span> EmptyRgn;
00554     }
00555 
00556     <span class="comment">/*</span>
00557 <span class="comment">     * If LockWindowUpdate() has been called, and this window is a child</span>
00558 <span class="comment">     * of the lock window, always return an empty visrgn.</span>
00559 <span class="comment">     */</span>
00560     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a89">gspwndLockUpdate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)     &amp;&amp;
00561         !(flags &amp; DCX_LOCKWINDOWUPDATE)         &amp;&amp;
00562         <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a5">_IsDescendant</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a89">gspwndLockUpdate</a>, pwndOrg)) {
00563 
00564         <span class="keywordflow">goto</span> EmptyRgn;
00565     }
00566 
00567     <span class="comment">/*</span>
00568 <span class="comment">     * Now go compute the visrgn for pwndClip.</span>
00569 <span class="comment">     */</span>
00570     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/visrgn_8c.html#a16">CalcWindowVisRgn</a>(pwndClip, phrgn, flags);
00571 
00572 EmptyRgn:
00573     <a class="code" href="../../d3/d6/visrgn_8c.html#a13">SetOrCreateRectRgnIndirectPublic</a>(phrgn, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a6">PZERO</a>(RECT));
00574     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00575 }
00576 
00577 <span class="comment">/***************************************************************************\</span>
00578 <span class="comment">* CalcWindowRgn</span>
00579 <span class="comment">*</span>
00580 <span class="comment">*</span>
00581 <span class="comment">* History:</span>
00582 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00583 <span class="comment">\***************************************************************************/</span>
00584 
<a name="l00585"></a><a class="code" href="../../d3/d6/visrgn_8c.html#a18">00585</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6/visrgn_8c.html#a18">CalcWindowRgn</a>(
00586     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00587     HRGN hrgn,
00588     BOOL fClient)
00589 {
00590     <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(hrgn, (fClient) ? &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a> : &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00591 
00592     <span class="comment">/*</span>
00593 <span class="comment">     * If the window has a region, then intersect the rectangle region with</span>
00594 <span class="comment">     * that. If this is low on memory, it'll propagate ERROR back.</span>
00595 <span class="comment">     */</span>
00596     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00597         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgn, hrgn, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>);
00598     }
00599 
00600     <span class="keywordflow">return</span> SIMPLEREGION;
00601 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
