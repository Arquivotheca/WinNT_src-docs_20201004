<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ia64/trapc.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>trapc.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>
<code>#include "<a class="el" href="../../d2/d8/ps_8h-source.html">ps.h</a>"</code><br>
<code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">..\..\mm\mi.h</a>"</code><br>
<code>#include &lt;<a class="el" href="../../d1/d0/inbv_8h-source.html">inbv.h</a>&gt;</code><br>

<p>
<a href="../../d5/d4/ia64_2trapc_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/struct__BREAK__INST.html">_BREAK_INST</a></td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d5/struct__BREAK__INST.html">_BREAK_INST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a1">BREAK_INST</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a2">ExpInterlockedPopEntrySListResume</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a3">KiMemoryFault</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a4">KiExtractImmediate</a> (IN ULONGLONG Iip, IN ULONG SlotNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a5">KiOtherBreakException</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a6">KiGeneralExceptions</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a7">KiNatExceptions</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a8">KiSingleStep</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a9">KiFloatFault</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a10">KiFloatTrap</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>EXCEPTION_DISPOSITION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a11">KiSystemServiceHandler</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN FRAME_POINTERS EstablisherFrame, IN OUT PCONTEXT ContextRecord, IN OUT PDISPATCHER_CONTEXT DispatcherContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a12">KiUnalignedFault</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a13">KiAdvanceInstPointer</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a0">PsWatchEnabled</a></td></tr>

</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a1" doxytag="ia64/trapc.c::BREAK_INST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d5/struct__BREAK__INST.html">_BREAK_INST</a>  <a class="el" href="../../d0/d5/struct__BREAK__INST.html">BREAK_INST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="ia64/trapc.c::ExpInterlockedPopEntrySListResume" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpInterlockedPopEntrySListResume           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00056">KiMemoryFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ia64/trapc.c::KiAdvanceInstPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiAdvanceInstPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l01130">1130</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/ia64_2exceptn_8c-source.html#l00098">KiEmulateFloat()</a>, and <a class="el" href="../../d6/d4/ia64_2alignem_8c-source.html#l00166">KiEmulateReference()</a>.
<p>
<pre class="fragment"><div>01136                    :
01137 
01138     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to advance <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instruction pointer in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame. 
01139 
01140 Arguments:
01141 
01142     TrapFrame - Supplies a pointer to a trap frame.
01143 
01144 Return Value:
01145 
01146     The intruction pointer in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame has been advanced. 
01147 
01148 --*/
01149 
01150 {
01151 
01152     ULONGLONG PsrRi;
01153  
01154     PsrRi = ((TrapFrame-&gt;StIPSR &gt;&gt; PSR_RI) &amp; 3i64) + 1;
01155     
01156     <span class="keywordflow">if</span> (PsrRi == 3) {
01157         
01158         PsrRi = 0;
01159         TrapFrame-&gt;StIIP += 16;
01160             
01161     }
01162         
01163     TrapFrame-&gt;StIPSR &amp;= ~(3i64 &lt;&lt; PSR_RI); 
01164     TrapFrame-&gt;StIPSR |= (PsrRi &lt;&lt; PSR_RI);
01165 
01166     <span class="keywordflow">return</span>;
01167 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ia64/trapc.c::KiExtractImmediate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KiExtractImmediate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Iip</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00286">286</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d0/d5/struct__BREAK__INST.html#o10">_BREAK_INST::u</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00349">KiOtherBreakException()</a>.
<p>
<pre class="fragment"><div>00293                    :
00294 
00295     Extract immediate operand from <span class="keywordflow">break</span> instruction.
00296 
00297 Arguments:
00298 
00299     Iip - Bundle address of instruction
00300     
00301     SlotNumber - Slot of <span class="keywordflow">break</span> instruction within bundle
00302 
00303 Return Value:
00304 
00305     Value of immediate operand.
00306 
00307 --*/
00308 
00309 {
00310     PULONGLONG BundleAddress;
00311     ULONGLONG BundleLow;
00312     ULONGLONG BundleHigh;
00313     <a class="code" href="../../d0/d5/struct__BREAK__INST.html">BREAK_INST</a> BreakInst;
00314     ULONG Imm21;
00315 
00316     BundleAddress = (PULONGLONG)Iip;
00317 
00318     BundleLow = *BundleAddress;
00319     BundleHigh = *(BundleAddress+1);
00320     
00321     <span class="comment">//</span>
00322     <span class="comment">// Align instruction</span>
00323     <span class="comment">//</span>
00324     
00325     <span class="keywordflow">switch</span> (SlotNumber) {
00326         <span class="keywordflow">case</span> 0:
00327             BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.Ulong64 = BundleLow &gt;&gt; 5;
00328             <span class="keywordflow">break</span>;
00329 
00330         <span class="keywordflow">case</span> 1:
00331             BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.Ulong64 = (BundleLow &gt;&gt; 46) | (BundleHigh &lt;&lt; 18);
00332             <span class="keywordflow">break</span>;
00333 
00334         <span class="keywordflow">case</span> 2:
00335             BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.Ulong64 = (BundleHigh &gt;&gt; 23);
00336             <span class="keywordflow">break</span>;
00337     }
00338     
00339     <span class="comment">//</span>
00340     <span class="comment">// Extract immediate value</span>
00341     <span class="comment">//</span>
00342 
00343     Imm21 = (ULONG)(BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.i_field.i&lt;&lt;20) | (ULONG)(BreakInst.<a class="code" href="../../d0/d5/struct__BREAK__INST.html#o10">u</a>.i_field.imm20);
00344 
00345     <span class="keywordflow">return</span> Imm21;
00346 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ia64/trapc.c::KiFloatFault" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiFloatFault           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00766">766</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00772                    :
00773 
00774     Handler <span class="keywordflow">for</span> EM floating point fault.
00775 
00776 Arguments:
00777 
00778     TrapFrame - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
00779 
00780 Return Value:
00781 
00782     None.
00783 
00784 Notes:
00785 
00786     IIP contains address of bundle causing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fault.
00787     
00788     ISR.ei bits indicate which instruction caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00789 
00790     ISR.code{7:0} =
00791     
00792       ISR.code{0} = 1: IEEE V (invalid) exception (Normal or SIMD-HI)
00793       ISR.code{1} = 1: Denormal/Unnormal operand exception (Normal or SIMD-HI)
00794       ISR.code{2} = 1: IEEE Z (divide by zero) exception (Normal or SIMD-HI)
00795       ISR.code{3} = 1: Software assist (Normal or SIMD-HI)
00796       ISR.code{4} = 1: IEEE V (invalid) exception (SIMD-LO)
00797       ISR.code{5} = 1: Denormal/Unnormal operand exception (SIMD-LO)
00798       ISR.code{6} = 1: IEEE Z (divide by zero) exception (SIMD-LO)
00799       ISR.code{7} = 1: Software assist (SIMD-LO)
00800 
00801 --*/
00802 
00803 {
00804     PEXCEPTION_RECORD ExceptionRecord;
00805 
00806     <span class="comment">//</span>
00807     <span class="comment">// Initialize the exception record</span>
00808     <span class="comment">//</span>
00809 
00810     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00811     ExceptionRecord-&gt;ExceptionAddress = 
00812            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00813                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00814 
00815     ExceptionRecord-&gt;ExceptionFlags = 0;
00816     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00817 
00818     ExceptionRecord-&gt;NumberParameters = 5;
00819     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00820     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00821     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00822     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00823     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00824 
00825     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_MULTIPLE_FAULTS;
00826 
00827     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00828 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ia64/trapc.c::KiFloatTrap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiFloatTrap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00831">831</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00705">KiSingleStep()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00837                    :
00838 
00839     Handler <span class="keywordflow">for</span> EM floating point trap.
00840 
00841 Arguments:
00842 
00843     TrapFrame - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
00844 
00845 Return Value:
00846 
00847     None.
00848 
00849 Notes:
00850 
00851     IIP contains address of bundle with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instruction to be 
00852     executed next.
00853 
00854     ISR.ei bits indicate which instruction caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00855 
00856     The fp trap may occur simultaneously with single-step traps. The
00857     fp trap <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reported by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hardware. The singel step trap must
00858     be detected by software.
00859     
00860     ISR.code{3:0} = ss 0 0 1 (ss = single step)
00861 
00862     ISR{15:7} = fp trap code.
00863     
00864 --*/
00865 
00866 {
00867     PEXCEPTION_RECORD ExceptionRecord;
00868     ULONGLONG SavedISR = TrapFrame-&gt;StISR;
00869 
00870     <span class="comment">//</span>
00871     <span class="comment">// Initialize the exception record</span>
00872     <span class="comment">//</span>
00873 
00874     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00875     ExceptionRecord-&gt;ExceptionAddress = 
00876            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00877                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00878 
00879     ExceptionRecord-&gt;ExceptionFlags = 0;
00880     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00881 
00882     ExceptionRecord-&gt;NumberParameters = 5;
00883     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00884     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00885     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00886     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00887     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00888 
00889     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_MULTIPLE_TRAPS;
00890 
00891     <span class="comment">//</span>
00892     <span class="comment">// check for single-step trap</span>
00893     <span class="comment">//</span>
00894     
00895     <span class="keywordflow">if</span> (SavedISR &amp; (1i64 &lt;&lt; ISR_SS_TRAP)) {
00896         <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a8">KiSingleStep</a>(TrapFrame);
00897     }
00898 
00899     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00900 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ia64/trapc.c::KiGeneralExceptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiGeneralExceptions           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00438">438</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00444                    :
00445 
00446     Handler <span class="keywordflow">for</span> general exception faults: attempt to execute an illegal
00447     operation, privileged instruction, access a privileged <span class="keyword">register</span>,
00448     unimplemented field, unimplemented <span class="keyword">register</span>, or take an inter-ISA
00449     branch when disabled.
00450 
00451 Arguments:
00452 
00453     TrapFrame - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
00454 
00455 Return Value:
00456 
00457     None.
00458 
00459 Notes:
00460 
00461     ISR.ei bits indicate which instruction caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00462 
00463     ISR.code{3:0} Non-access instruction (ISR.na = 1)
00464                   = 0 tpa
00465                   = 1 fc
00466                   = 2 probe
00467                   = 3 tak
00468                   = 4 lfetch
00469 
00470     ISR.code{7:4} = 0: Illegal operation fault: All reported as STATUS_ILLEGAL_INSTRUCTION.
00471 
00472             ISR.rs = 0: An attempt to execute an illegal operation:
00473                  -- unassigned major opcodes
00474                  -- unassigned sub-opcodes
00475                  -- reserved instruction fields
00476                  -- writing a read-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keyword">register</span>
00477                  -- accessing a reserved <span class="keyword">register</span>
00478 
00479             ISR.rs = 1:
00480                  -- attempt to write outside <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <span class="keyword">register</span> stack frame
00481                  -- INVALRS operation with RCS.en = 1
00482                  -- write to BSP with RCS.en = 1
00483                  -- write to RNATRC with RCS.en = 1
00484                  -- read from RNATRC with RCS.en = 1
00485 
00486     ISR.code{7:4} = 1: Privileged operation fault: Reported as STATUS_PRIVILEGED_INSTRUCTION.
00487     ISR.code{7:4} = 2: Privileged <span class="keyword">register</span> fault: Reported as STATUS_PRIVILEGED_INSTRUCTION.
00488     ISR.code{7:4} = 3: Reserved <span class="keyword">register</span> fault: Reported as STATUS_ILLEGAL_INSTRUCTION.
00489     ISR.code{7:4} = 4: Illegal ISA transition fault: Reported as STATUS_ILLEGAL_INSTRUCTION.
00490 
00491 --*/
00492 
00493 {
00494     BOOLEAN StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00495     ULONG IsrCode;
00496     PEXCEPTION_RECORD ExceptionRecord;
00497 
00498     <span class="comment">//</span>
00499     <span class="comment">// Initialize the exception record</span>
00500     <span class="comment">//</span>
00501 
00502     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00503     ExceptionRecord-&gt;ExceptionAddress = 
00504            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00505                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00506 
00507     ExceptionRecord-&gt;ExceptionFlags = 0;
00508     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00509 
00510     ExceptionRecord-&gt;NumberParameters = 5;
00511     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00512     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00513     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00514     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00515     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00516 
00517     IsrCode = (LONG)((TrapFrame-&gt;StISR &gt;&gt; ISR_CODE) &amp; ISR_CODE_MASK);
00518 
00519     <span class="comment">//</span>
00520     <span class="comment">// Look at ISR code bits {7:4}</span>
00521     <span class="comment">//</span>
00522 
00523     <span class="keywordflow">switch</span> (IsrCode &gt;&gt; 4) {
00524 
00525     <span class="keywordflow">case</span> ISR_PRIV_OP:
00526     <span class="keywordflow">case</span> ISR_PRIV_REG:
00527 
00528         ExceptionRecord-&gt;ExceptionCode = STATUS_PRIVILEGED_INSTRUCTION;
00529         <span class="keywordflow">break</span>;
00530 
00531     <span class="keywordflow">case</span> ISR_RESVD_REG:
00532 
00533         <span class="comment">//</span>
00534         <span class="comment">// Indicate store or not</span>
00535         <span class="comment">//</span>
00536 
00537         <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_W)) {
00538 
00539             StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00540 
00541         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_X)) {
00542 
00543             <span class="comment">//</span>
00544             <span class="comment">// Indicate execution fault or not</span>
00545             <span class="comment">//</span>
00546 
00547             StoreInstruction = 2;
00548         }
00549 
00550         ExceptionRecord-&gt;ExceptionCode = STATUS_ACCESS_VIOLATION;
00551         ExceptionRecord-&gt;ExceptionInformation[0] = (ULONG_PTR)StoreInstruction;
00552         ExceptionRecord-&gt;ExceptionInformation[1] = (ULONG_PTR)TrapFrame-&gt;StIFA;
00553         ExceptionRecord-&gt;ExceptionInformation[2] = (ULONG_PTR)STATUS_ACCESS_VIOLATION;
00554         <span class="keywordflow">break</span>;
00555 
00556     <span class="keywordflow">case</span> ISR_ILLEGAL_OP:
00557     <span class="keywordflow">case</span> ISR_ILLEGAL_ISA:
00558 
00559         ExceptionRecord-&gt;ExceptionCode = STATUS_ILLEGAL_INSTRUCTION;
00560         <span class="keywordflow">break</span>;
00561 
00562     <span class="keywordflow">case</span> ISR_ILLEGAL_HAZARD:
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">// a new status code will be introduced for hazard faults.</span>
00566         <span class="comment">//</span>
00567 
00568         ExceptionRecord-&gt;ExceptionCode = STATUS_ILLEGAL_INSTRUCTION;
00569         <span class="keywordflow">break</span>;
00570 
00571     <span class="keywordflow">default</span>:
00572 
00573         <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00574             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(0xFFFFFFFF,
00575                         (ULONG_PTR)TrapFrame-&gt;StISR,
00576                         (ULONG_PTR)TrapFrame-&gt;StIIP,
00577                         (ULONG_PTR)TrapFrame,
00578                         0
00579                         );
00580         }
00581 
00582         <span class="keywordflow">break</span>;
00583     }
00584 
00585     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00586 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ia64/trapc.c::KiMemoryFault" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiMemoryFault           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00056">56</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d3/d8/miia64_8h-source.html#l03274">_MAX_WOW64_ADDRESS</a>, <a class="el" href="../../d4/d5/ia64_2trapc_8c.html#a2">ExpInterlockedPopEntrySListResume()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00024">IRQL_NOT_LESS_OR_EQUAL</a>, <a class="el" href="../../d1/d4/4_2kdbreak_8c.html#a0">KdSetOwedBreakpoints()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a302">MmX86Fault()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00031">PsWatchEnabled</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03788">PsWatchWorkingSet()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00062                    :
00063 
00064 Arguments:
00065 
00066     TrapFrame - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
00067 
00068 Return Value:
00069 
00070     None
00071 
00072 --*/
00073 
00074 {
00075     PEXCEPTION_RECORD ExceptionRecord;
00076     BOOLEAN StoreInstruction;
00077     PVOID VirtualAddress;
00078     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">// Indicate store or not</span>
00082     <span class="comment">//</span>
00083 
00084     <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_W)) {
00085         StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00086     } <span class="keywordflow">else</span> {
00087         StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00088     }    
00089 
00090     VirtualAddress = (PVOID)TrapFrame-&gt;StIFA;
00091 
00092     <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_X))  {
00093 
00094 <span class="preprocessor">#if _MERCED_A0_</span>
00095 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((TrapFrame-&gt;StIPSR &amp; (1i64 &lt;&lt; PSR_IS)) == 0) {
00096             VirtualAddress = (PVOID)TrapFrame-&gt;StIIP;
00097         }
00098 <span class="preprocessor">#endif</span>
00099 <span class="preprocessor"></span>        <span class="comment">//</span>
00100         <span class="comment">// Indicate execution fault or not</span>
00101         <span class="comment">//</span>
00102 
00103         StoreInstruction = 2;
00104     }
00105 
00106 
00107 <span class="preprocessor">#if DBG</span>
00108 <span class="preprocessor"></span>    
00109     _disable();
00110 
00111     <span class="keywordflow">if</span> (MmHistoryIndx &lt; 8) {
00112         MmFaultHistory[MmHistoryIndx].Iip = TrapFrame-&gt;StIIP;
00113         MmFaultHistory[MmHistoryIndx].Ifa = TrapFrame-&gt;StIFA;
00114         MmFaultHistory[MmHistoryIndx].Iipa = TrapFrame-&gt;StIIPA;
00115         MmFaultHistory[MmHistoryIndx].TrapFrame = (ULONGLONG)TrapFrame;
00116         MmHistoryIndx += 1;
00117     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MmHistoryIndx == 8) {
00118         MmHistoryIndx = 0;
00119     } <span class="keywordflow">else</span> {
00120         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(MmHistoryIndx);
00121     }
00122     
00123     <span class="keywordflow">if</span> (VirtualAddress &lt; MM_SYSTEM_RANGE_START) {
00124 
00125         <span class="keywordflow">if</span> (StoreInstruction == 2) {
00126             MmUserInstMemoryFaultCount += 1;
00127         } <span class="keywordflow">else</span> {
00128             MmUserDataMemoryFaultCount += 1;
00129         }
00130 
00131     } <span class="keywordflow">else</span> {
00132         
00133         <span class="keywordflow">if</span> (StoreInstruction == 2) {
00134             MmKernInstMemoryFaultCount += 1;
00135         } <span class="keywordflow">else</span> {
00136             MmKernDataMemoryFaultCount += 1;
00137         }
00138     }
00139     
00140     _enable();
00141 
00142 <span class="preprocessor">#endif</span>
00143 <span class="preprocessor"></span>
00144 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00145 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((ULONG_PTR)VirtualAddress &lt;= <a class="code" href="../../d2/d9/miia64_8h.html#a257">_MAX_WOW64_ADDRESS</a>) &amp;&amp; 
00146         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00147 
00148         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/miia64_8h.html#a302">MmX86Fault</a>(StoreInstruction, VirtualAddress,
00149                            (KPROCESSOR_MODE)TrapFrame-&gt;PreviousMode, TrapFrame);
00150 
00151     } <span class="keywordflow">else</span> 
00152 <span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>    {    
00154 
00155         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a>(StoreInstruction, VirtualAddress, 
00156                            (KPROCESSOR_MODE)TrapFrame-&gt;PreviousMode, TrapFrame);
00157     }
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// MmAccessFault() returns positive numbers if it is successful; returns</span>
00161     <span class="comment">// negative numbers if it fails.</span>
00162     <span class="comment">//</span>
00163     <span class="comment">// Check if working set watch is enabled.</span>
00164     <span class="comment">//</span>
00165 
00166     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &gt;= 0) {
00167 
00168         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a0">PsWatchEnabled</a>) {
00169             <a class="code" href="../../d9/d1/psquery_8c.html#a22">PsWatchWorkingSet</a>(Status, 
00170                               (PVOID)TrapFrame-&gt;StIIP, 
00171                               (PVOID)VirtualAddress);
00172         }
00173         
00174         <span class="comment">//</span>
00175         <span class="comment">// Check if debugger has any breakpoints that should be inserted</span>
00176         <span class="comment">//</span>
00177 
00178         <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a0">KdSetOwedBreakpoints</a>();
00179         
00180         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00181 
00182     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapFrame)) {
00183 
00184         TrapFrame-&gt;StIIP = ((PPLABEL_DESCRIPTOR)<a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a2">ExpInterlockedPopEntrySListResume</a>)-&gt;EntryPoint;
00185 
00186     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TrapFrame-&gt;StISR &amp; (1i64 &lt;&lt; ISR_SP)) {
00187 
00188         <span class="comment">//</span>
00189         <span class="comment">// Set IPSR.ed bit if it was a fault on a speculative load. </span>
00190         <span class="comment">//</span>
00191 
00192         TrapFrame-&gt;StIPSR |= (1i64 &lt;&lt; PSR_ED);
00193 
00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195 
00196     }
00197 
00198     <span class="comment">//</span>
00199     <span class="comment">// Failure returned from MmAccessFault.</span>
00200     <span class="comment">// Initialize Exception record.</span>
00201     <span class="comment">//</span>
00202     
00203     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00204     ExceptionRecord-&gt;ExceptionCode = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205     ExceptionRecord-&gt;ExceptionAddress =
00206         (PVOID)RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00207                    ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00208     
00209     ExceptionRecord-&gt;ExceptionFlags = 0;
00210     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00211     
00212     ExceptionRecord-&gt;NumberParameters = 5;
00213     ExceptionRecord-&gt;ExceptionInformation[0] = (ULONG_PTR)StoreInstruction;
00214     ExceptionRecord-&gt;ExceptionInformation[1] = (ULONG_PTR)VirtualAddress;
00215     ExceptionRecord-&gt;ExceptionInformation[2] = (ULONG_PTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00216     ExceptionRecord-&gt;ExceptionInformation[3] = (ULONG_PTR)TrapFrame-&gt;StIIPA;
00217     ExceptionRecord-&gt;ExceptionInformation[4] = (ULONG_PTR)TrapFrame-&gt;StISR;
00218         
00219     <span class="comment">//</span>
00220     <span class="comment">// Status = STATUS_IN_PAGE_ERROR | 0x10000000</span>
00221     <span class="comment">//      is a special status that indicates a page fault at Irql &gt; APC</span>
00222     <span class="comment">//</span>
00223     <span class="comment">// The following statuses can be forwarded:</span>
00224     <span class="comment">//      STATUS_ACCESS_VIOLATION</span>
00225     <span class="comment">//      STATUS_GUARD_PAGE_VIOLATION</span>
00226     <span class="comment">//      STATUS_STACK_OVERFLOW</span>
00227     <span class="comment">//</span>
00228     <span class="comment">// All other status will be set to:</span>
00229     <span class="comment">//      STATUS_IN_PAGE_ERROR</span>
00230     <span class="comment">//</span>
00231     
00232     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00233         
00234     <span class="keywordflow">case</span> STATUS_ACCESS_VIOLATION:
00235     <span class="keywordflow">case</span> STATUS_GUARD_PAGE_VIOLATION:
00236     <span class="keywordflow">case</span> STATUS_STACK_OVERFLOW:
00237     <span class="keywordflow">case</span> STATUS_IN_PAGE_ERROR:
00238         
00239         <span class="keywordflow">break</span>;
00240 
00241     <span class="keywordflow">default</span>:
00242 
00243         ExceptionRecord-&gt;ExceptionCode = STATUS_IN_PAGE_ERROR;
00244         <span class="keywordflow">break</span>;
00245         
00246     <span class="keywordflow">case</span> STATUS_IN_PAGE_ERROR | 0x10000000:
00247         
00248         <span class="comment">//</span>
00249         <span class="comment">// Handle the special case status returned from MmAccessFault,</span>
00250         <span class="comment">// we have taken a page fault at Irql &gt; APC_LEVEL.</span>
00251         <span class="comment">//</span>
00252         
00253         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(IRQL_NOT_LESS_OR_EQUAL,
00254                      (ULONG_PTR)VirtualAddress,
00255                      (ULONG_PTR)KeGetCurrentIrql(),
00256                      (ULONG_PTR)StoreInstruction,
00257                      (ULONG_PTR)TrapFrame-&gt;StIIP);
00258         <span class="comment">//</span>
00259         <span class="comment">// should not get here</span>
00260         <span class="comment">//</span>
00261         
00262         <span class="keywordflow">break</span>;
00263     }
00264     
00265     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00266 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ia64/trapc.c::KiNatExceptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiNatExceptions           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00590">590</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00596                    :
00597 
00598     Handler <span class="keywordflow">for</span> NaT consumption exception faults
00599 
00600 Arguments:
00601 
00602     TrapFrame - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
00603 
00604 Return Value:
00605 
00606     None.
00607 
00608 Notes:
00609 
00610     ISR.ei bits indicate which instruction caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00611 
00612     ISR.code{3:0} Non-access instruction (ISR.na = 1)
00613                   = 0 tpa
00614                   = 1 fc
00615                   = 2 probe
00616                   = 3 tak
00617                   = 4 lfetch
00618 
00619     ISR.code{7:4} = 1: Register NaT consumption fault
00620     ISR.code{7:4} = 2: NaT page consumption fault
00621 
00622 --*/
00623 
00624 {
00625     BOOLEAN StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00626     ULONG IsrCode;
00627     PEXCEPTION_RECORD ExceptionRecord;
00628 
00629     <span class="comment">//</span>
00630     <span class="comment">// Initialize the exception record</span>
00631     <span class="comment">//</span>
00632 
00633     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00634     ExceptionRecord-&gt;ExceptionAddress = 
00635            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00636                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00637 
00638     ExceptionRecord-&gt;ExceptionFlags = 0;
00639     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00640 
00641     ExceptionRecord-&gt;NumberParameters = 5;
00642     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00643     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00644     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00645     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00646     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00647 
00648     IsrCode = (LONG)((TrapFrame-&gt;StISR &gt;&gt; ISR_CODE) &amp; ISR_CODE_MASK);
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Look at ISR code bits {7:4}</span>
00652     <span class="comment">//</span>
00653 
00654     <span class="keywordflow">switch</span> (IsrCode &gt;&gt; 4) {
00655 
00656     <span class="keywordflow">case</span> ISR_NAT_REG:
00657 
00658 <span class="preprocessor">#if 0</span>
00659 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00660 
00661             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"FATAL ERROR: Kernel hit a Nat Consumpation Fault!\n"</span>);
00662             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(0xFFFFFFFF,
00663                         (ULONG_PTR)TrapFrame-&gt;StISR,
00664                         (ULONG_PTR)TrapFrame-&gt;StIIP,
00665                         (ULONG_PTR)TrapFrame,
00666                         0
00667                         );
00668 
00669             <span class="comment">// Do not return from KeBugCheckEx</span>
00670         }
00671 <span class="preprocessor">#endif // 0</span>
00672 <span class="preprocessor"></span>
00673         ExceptionRecord-&gt;ExceptionCode = STATUS_REG_NAT_CONSUMPTION;
00674         <span class="keywordflow">break</span>;
00675 
00676     <span class="keywordflow">case</span> ISR_NAT_PAGE:
00677 
00678         <span class="comment">//</span>
00679         <span class="comment">// If we start using a NaT page, we should treat this as a page fault and </span>
00680         <span class="comment">// should call KiMemoryFault().</span>
00681         <span class="comment">//</span>
00682 
00683         ExceptionRecord-&gt;ExceptionCode = STATUS_ACCESS_VIOLATION;
00684         <span class="keywordflow">break</span>;
00685 
00686     <span class="keywordflow">default</span>:
00687 
00688         <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00689             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(0xFFFFFFFF,
00690                         (ULONG_PTR)TrapFrame-&gt;StISR,
00691                         (ULONG_PTR)TrapFrame-&gt;StIIP,
00692                         (ULONG_PTR)TrapFrame,
00693                         0
00694                         );
00695         }
00696 
00697         <span class="keywordflow">break</span>;
00698     }
00699 
00700     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00701 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ia64/trapc.c::KiOtherBreakException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiOtherBreakException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00349">349</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00617">BREAKIN_BREAKPOINT</a>, <a class="el" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00616">KERNEL_BREAKPOINT</a>, <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00286">KiExtractImmediate()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00615">USER_BREAKPOINT</a>.
<p>
<pre class="fragment"><div>00355                    :
00356 
00357     Handler <span class="keywordflow">for</span> <span class="keywordflow">break</span> exception other than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ones <span class="keywordflow">for</span> fast and
00358     normal system calls. This includes debug <span class="keywordflow">break</span> points.
00359 
00360 Arguments:
00361 
00362     TrapFrame - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
00363 
00364 Return Value:
00365 
00366     NT status code.
00367 
00368 --*/
00369 
00370 {
00371     PEXCEPTION_RECORD ExceptionRecord;
00372     ULONG BreakImmediate;
00373     ISR Isr;
00374 
00375     BreakImmediate = (ULONG)(TrapFrame-&gt;StIIM);
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// Handle break.b case</span>
00379     <span class="comment">//</span>
00380     <span class="keywordflow">if</span> (BreakImmediate == 0) {
00381        Isr.ull = TrapFrame-&gt;StISR;
00382        BreakImmediate = <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a4">KiExtractImmediate</a>(TrapFrame-&gt;StIIP,
00383                                            (ULONG)Isr.sb.isr_ei);
00384        TrapFrame-&gt;StIIM = BreakImmediate;
00385     }
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Initialize exception record</span>
00389     <span class="comment">//</span>
00390 
00391     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00392     ExceptionRecord-&gt;ExceptionAddress = 
00393         (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
00394                                  ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
00395  
00396     ExceptionRecord-&gt;ExceptionFlags = 0;
00397     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00398  
00399     ExceptionRecord-&gt;NumberParameters = 5;
00400     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00401     ExceptionRecord-&gt;ExceptionInformation[1] = 0;
00402     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00403     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00404     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00405  
00406     <span class="keywordflow">switch</span> (BreakImmediate) {
00407 
00408     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a453">KERNEL_BREAKPOINT</a>:
00409     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a452">USER_BREAKPOINT</a>:
00410     <span class="keywordflow">case</span> INTEGER_OVERFLOW_BREAKPOINT:
00411     <span class="keywordflow">case</span> DIVIDE_OVERFLOW_BREAKPOINT:
00412     <span class="keywordflow">case</span> DIVIDE_BY_ZERO_BREAKPOINT:
00413     <span class="keywordflow">case</span> RANGE_CHECK_BREAKPOINT:
00414     <span class="keywordflow">case</span> STACK_OVERFLOW_BREAKPOINT:
00415     <span class="keywordflow">case</span> MULTIPLY_OVERFLOW_BREAKPOINT:
00416     <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
00417     <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
00418     <span class="keywordflow">case</span> DEBUG_STOP_BREAKPOINT:
00419     <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
00420     <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
00421     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a454">BREAKIN_BREAKPOINT</a>:
00422         ExceptionRecord-&gt;ExceptionCode = STATUS_BREAKPOINT;
00423         ExceptionRecord-&gt;ExceptionInformation[0] = BreakImmediate;
00424         <span class="keywordflow">break</span>;
00425 
00426     <span class="keywordflow">default</span>:
00427 <span class="preprocessor">#if DBG</span>
00428 <span class="preprocessor"></span>        <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a> (<span class="stringliteral">"KiOtherBreakException: Unknown break code.\n"</span>);
00429 <span class="preprocessor">#endif // DBG</span>
00430 <span class="preprocessor"></span>        ExceptionRecord-&gt;ExceptionCode = STATUS_ILLEGAL_INSTRUCTION;
00431         <span class="keywordflow">break</span>;
00432     }
00433 
00434     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00435 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ia64/trapc.c::KiSingleStep" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiSingleStep           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00705">705</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00831">KiFloatTrap()</a>.
<p>
<pre class="fragment"><div>00711                    :
00712 
00713     Handler <span class="keywordflow">for</span> single step trap. An instruction was successfully
00714     executed and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a>.ss bit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 1.
00715 
00716 Arguments:
00717 
00718     TrapFrame - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
00719 
00720 Return Value:
00721 
00722     None.
00723 
00724 Notes:
00725 
00726     ISR.ei bits indicate which instruction caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00727 
00728     ISR.code{3:0} = 1000
00729 
00730 --*/
00731 
00732 {
00733     PEXCEPTION_RECORD ExceptionRecord;
00734     ULONG IpsrRi;
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">// Initialize the exception record</span>
00738     <span class="comment">//</span>
00739 
00740     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
00741 
00742     <span class="comment">//</span>
00743     <span class="comment">// We only want the low order 2 bits so typecast to ULONG</span>
00744     <span class="comment">//</span>
00745     IpsrRi = (ULONG)(TrapFrame-&gt;StIPSR &gt;&gt; PSR_RI) &amp; 0x3;
00746 
00747     ExceptionRecord-&gt;ExceptionAddress =
00748            (PVOID) RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP, IpsrRi);
00749 
00750     ExceptionRecord-&gt;ExceptionFlags = 0;
00751     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00752 
00753     ExceptionRecord-&gt;NumberParameters = 5;
00754     ExceptionRecord-&gt;ExceptionInformation[0] = 0;
00755     ExceptionRecord-&gt;ExceptionInformation[1] = 0; <span class="comment">// 0 for traps</span>
00756     ExceptionRecord-&gt;ExceptionInformation[2] = 0;
00757     ExceptionRecord-&gt;ExceptionInformation[3] = TrapFrame-&gt;StIIPA;
00758     ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00759 
00760     ExceptionRecord-&gt;ExceptionCode = STATUS_SINGLE_STEP;
00761 
00762     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00763 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ia64/trapc.c::KiSystemServiceHandler" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> EXCEPTION_DISPOSITION KiSystemServiceHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FRAME_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>EstablisherFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PDISPATCHER_CONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>DispatcherContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00906">906</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00052">EXCEPTION_TARGET_UNWIND</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00060">ExceptionContinueSearch</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00639">_KTHREAD::PreviousMode</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00737">RtlUnwind2()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00032">SYSTEM_SERVICE_EXCEPTION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00033">SYSTEM_UNWIND_PREVIOUS_USER</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>00915                    :
00916 
00917     Control reaches here when a exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised in a system service
00918     or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service dispatcher, and <span class="keywordflow">for</span> an unwind during a kernel
00919     exception.
00920 
00921     If an unwind <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being performed and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service dispatcher <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00922     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind, then an exception occured <span class="keywordflow">while</span> attempting
00923     to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's in-memory argument list. Control <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> transfered to
00924     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> by <span class="keywordflow">return</span> a <span class="keywordflow">continue</span> execution disposition
00925     value.
00926 
00927     If an unwind <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being performed and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> user, then
00928     bug check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to crash <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not valid to unwind
00929     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of a system service into user mode.
00930 
00931     If an unwind <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being performed, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> kernel, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00932     system service dispatcher <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00933     thread does not own any mutexes, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode field from
00934     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> restored to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread object. Otherwise, bug
00935     check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to crash <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid to unwind <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of
00936     a system service <span class="keywordflow">while</span> owning a mutex.
00937 
00938     If an exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being raised and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception PC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00939     range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service dispatcher in-memory argument copy code,
00940     then an unwind to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> code <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initiated.
00941 
00942     If an exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being raised and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception PC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not within
00943     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service dispatcher, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00944     not user, then a <span class="keywordflow">continue</span> searh disposition value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise,
00945     a system service has failed to handle an exception and bug check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00946     called. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid <span class="keywordflow">for</span> a system service not to handle all exceptions
00947     that can be raised in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service.
00948 
00949 Arguments:
00950 
00951     ExceptionRecord - Supplies a pointer to an exception record.
00952 
00953     EstablisherFrame - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frame pointer of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> establisher
00954         of <span class="keyword">this</span> exception handler.
00955 
00956         N.B. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not actually <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frame pointer of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> establisher of
00957              <span class="keyword">this</span> handler. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack pointer of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00958              of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service. Therefore, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> establisher frame pointer
00959              <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by
00960              examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> saved s8 <span class="keyword">register</span> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00961 
00962     ContextRecord - Supplies a pointer to a context record.
00963 
00964     DispatcherContext - Supplies a pointer to  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatcher context
00965         record.
00966 
00967 Return Value:
00968 
00969     If bug check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called, there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no <span class="keywordflow">return</span> from <span class="keyword">this</span> routine and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00970     system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> crashed. If an exception occured <span class="keywordflow">while</span> attempting to copy
00971     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user in-memory argument list, then there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no <span class="keywordflow">return</span> from <span class="keyword">this</span>
00972     routine, and unwind <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called. Otherwise, <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00973     returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
00974 
00975 --*/
00976 {
00977     CONTEXT Context;
00978     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00979     PKTRAP_FRAME TrapFrame;
00980     ULONG_PTR ExceptionAddress;
00981 
00982     <span class="keyword">extern</span> ULONG KiSystemServiceStartOffset;
00983     <span class="keyword">extern</span> ULONG KiSystemServiceEndOffset;
00984     <span class="keyword">extern</span> ULONG KiSystemServiceExitOffset;
00985 
00986     <span class="keywordflow">if</span> (IS_UNWINDING(ExceptionRecord-&gt;ExceptionFlags)) {
00987 
00988         <span class="comment">//</span>
00989         <span class="comment">// An unwind is in progress.</span>
00990         <span class="comment">// If a target unwind is being performed, then continue execution</span>
00991         <span class="comment">// is returned to transfer control to the system service exit</span>
00992         <span class="comment">// code.  Otherwise, restore the previous mode if the previous</span>
00993         <span class="comment">// mode is not user and there is no mutex owned by the current</span>
00994         <span class="comment">// thread.</span>
00995         <span class="comment">//</span>
00996 
00997         <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a30">EXCEPTION_TARGET_UNWIND</a>) {
00998             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a>;
00999         } <span class="keywordflow">else</span> {
01000 
01001             Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01002             <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o50">PreviousMode</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01003 
01004                 <span class="comment">//</span>
01005                 <span class="comment">// Previous mode is kernel and no mutex owned.</span>
01006                 <span class="comment">//</span>
01007                 <span class="comment">// N.B. System convention: unwinder puts the trap frame</span>
01008                 <span class="comment">//                         address in IntT0 field of</span>
01009                 <span class="comment">//                         context record when it </span>
01010                 <span class="comment">//                         encounters an interrupt region.</span>
01011                 <span class="comment">//</span>
01012 
01013                 TrapFrame = (PKTRAP_FRAME) ContextRecord-&gt;IntT0;
01014                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o50">PreviousMode</a> = (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)TrapFrame-&gt;PreviousMode;
01015                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a>;
01016 
01017             } <span class="keywordflow">else</span> {
01018 
01019                 <span class="comment">//</span>
01020                 <span class="comment">// Previous mode is user, call bug check.</span>
01021                 <span class="comment">//</span>
01022 
01023                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(SYSTEM_UNWIND_PREVIOUS_USER);
01024             }
01025         }
01026     } <span class="keywordflow">else</span> {
01027 
01028         ULONG IsrCode;
01029 
01030         <span class="comment">//</span>
01031         <span class="comment">// An exception dispatching is in progress.</span>
01032         <span class="comment">// If the exception PC is within the in-memory argument copy code</span>
01033         <span class="comment">// of the system service dispatcher, then call unwind to transfer</span>
01034         <span class="comment">// control to the system service exit code.  Otherwise, check if</span>
01035         <span class="comment">// the previous mode is user or kernel mode.</span>
01036         <span class="comment">//</span>
01037 
01038         ExceptionAddress = (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress;
01039         <span class="keywordflow">if</span> ((ExceptionAddress &lt; MM_EPC_VA+KiSystemServiceStartOffset) ||
01040             (ExceptionAddress &gt;= MM_EPC_VA+KiSystemServiceEndOffset))
01041         {
01042             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
01043 
01044                 <span class="comment">//</span>
01045                 <span class="comment">// Previous mode is user, call bug check.</span>
01046                 <span class="comment">//</span>
01047 
01048                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(SYSTEM_SERVICE_EXCEPTION);
01049 
01050             } <span class="keywordflow">else</span> {
01051 
01052                 <span class="comment">//</span>
01053                 <span class="comment">// Previous mode is kernel, continue to search</span>
01054                 <span class="comment">//</span>
01055 
01056                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a>;
01057             }
01058         } <span class="keywordflow">else</span> {
01059             IsrCode = (ULONG)((ExceptionRecord-&gt;ExceptionInformation[4] &gt;&gt; ISR_CODE) &amp; ISR_CODE_MASK) &gt;&gt; 4;
01060             <span class="keywordflow">if</span> ( (IsrCode == ISR_NAT_REG) || (IsrCode == ISR_NAT_PAGE) ) {
01061                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING: Kernel hit a Nat Consumpation Fault\n"</span>);
01062                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING: At %p\n"</span>, ExceptionRecord-&gt;ExceptionAddress);
01063             }
01064 <span class="preprocessor">#pragma warning( disable : 4312 ) // disabling warning on PVOID casting for the ExceptionCode</span>
01065 <span class="preprocessor"></span>            <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a12">RtlUnwind2</a>(EstablisherFrame, 
01066                        (PVOID)(MM_EPC_VA+KiSystemServiceExitOffset),
01067                        NULL, (PVOID)ExceptionRecord-&gt;ExceptionCode, &amp;Context);
01068 <span class="preprocessor">#pragma warning ( default: 4312 )</span>
01069 <span class="preprocessor"></span>        }
01070     }
01071 
01072 
01073 } <span class="comment">// KiSystemServiceHandler( )</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ia64/trapc.c::KiUnalignedFault" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiUnalignedFault           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l01079">1079</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/ia32trap_8c-source.html#l00755">KiIA32ExceptionAlignmentFault()</a>.
<p>
<pre class="fragment"><div>01084                    :
01085 
01086     Handler <span class="keywordflow">for</span> unaligned data reference. 
01087 
01088 Arguments:
01089 
01090     TrapFrame - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
01091 
01092 Return Value:
01093 
01094     None.
01095 
01096 Notes:
01097 
01098     ISR.ei bits indicate which instruction caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
01099 
01100 --*/
01101 
01102 {
01103     PEXCEPTION_RECORD ExceptionRecord;
01104     PVOID VirtualAddress;
01105 
01106     VirtualAddress = (PVOID)TrapFrame-&gt;StIFA;
01107     
01108     ExceptionRecord = (PEXCEPTION_RECORD)&amp;TrapFrame-&gt;ExceptionRecord;
01109     ExceptionRecord-&gt;ExceptionAddress =
01110         (PVOID)RtlIa64InsertIPSlotNumber(TrapFrame-&gt;StIIP,
01111                    ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI));
01112     
01113     ExceptionRecord-&gt;ExceptionFlags = 0;
01114     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01115     
01116     ExceptionRecord-&gt;NumberParameters = 5;
01117     ExceptionRecord-&gt;ExceptionInformation[0] = (ULONG_PTR)0;
01118     ExceptionRecord-&gt;ExceptionInformation[1] = (ULONG_PTR)VirtualAddress;
01119     ExceptionRecord-&gt;ExceptionInformation[2] = (ULONG_PTR)0;
01120     ExceptionRecord-&gt;ExceptionInformation[3] = (ULONG_PTR)TrapFrame-&gt;StIIPA;
01121     ExceptionRecord-&gt;ExceptionInformation[4] = (ULONG_PTR)TrapFrame-&gt;StISR;
01122 
01123     ExceptionRecord-&gt;ExceptionCode = STATUS_DATATYPE_MISALIGNMENT;
01124 
01125     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01126 }       

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="ia64/trapc.c::PsWatchEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d1/psquery_8c.html#a5">PsWatchEnabled</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00031">31</a> of file <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html">ia64/trapc.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00056">KiMemoryFault()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
