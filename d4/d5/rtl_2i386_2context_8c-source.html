<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: context.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c</h1><a href="../../d3/d6/rtl_2i386_2context_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    context.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements user-mode callable context manipulation routines.</span>
00012 <span class="comment">    The interfaces exported from this module are portable, but they must</span>
00013 <span class="comment">    be re-implemented for each architecture.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Mark Lucovsky (markl) 20-Jun-1989</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Bryan Willman (bryanwi) 8-Mar-90</span>
00022 <span class="comment"></span>
00023 <span class="comment">        Ported to the 80386</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00028 
00029 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlInitializeContext)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlRemoteCall)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00036"></a><a class="code" href="../../d3/d6/rtl_2i386_2context_8c.html#a0">00036</a> <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a1">RtlInitializeContext</a>(
00037     IN HANDLE Process,
00038     OUT PCONTEXT Context,
00039     IN PVOID Parameter OPTIONAL,
00040     IN PVOID InitialPc OPTIONAL,
00041     IN PVOID InitialSp OPTIONAL
00042     )
00043 
00044 <span class="comment">/*++</span>
00045 <span class="comment"></span>
00046 <span class="comment">Routine Description:</span>
00047 <span class="comment"></span>
00048 <span class="comment">    This function initializes a context structure so that it can</span>
00049 <span class="comment">    be used in a subsequent call to NtCreateThread.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Arguments:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    Context - Supplies a context buffer to be initialized by this routine.</span>
00054 <span class="comment"></span>
00055 <span class="comment">    InitialPc - Supplies an initial program counter value.</span>
00056 <span class="comment"></span>
00057 <span class="comment">    InitialSp - Supplies an initial stack pointer value.</span>
00058 <span class="comment"></span>
00059 <span class="comment">Return Value:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    Raises STATUS_BAD_INITIAL_STACK if the value of InitialSp is not properly</span>
00062 <span class="comment">           aligned.</span>
00063 <span class="comment"></span>
00064 <span class="comment">    Raises STATUS_BAD_INITIAL_PC if the value of InitialPc is not properly</span>
00065 <span class="comment">           aligned.</span>
00066 <span class="comment"></span>
00067 <span class="comment">--*/</span>
00068 
00069 {
00070     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00071 
00072     Context-&gt;Eax = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00073     Context-&gt;Ebx = 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00074     Context-&gt;Ecx = 2<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00075     Context-&gt;Edx = 3<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00076     Context-&gt;Esi = 4<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00077     Context-&gt;Edi = 5<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00078     Context-&gt;Ebp = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00079 
00080     Context-&gt;SegGs = 0;
00081     Context-&gt;SegFs = KGDT_R3_TEB;
00082     Context-&gt;SegEs = KGDT_R3_DATA;
00083     Context-&gt;SegDs = KGDT_R3_DATA;
00084     Context-&gt;SegSs = KGDT_R3_DATA;
00085     Context-&gt;SegCs = KGDT_R3_CODE;
00086 
00087     Context-&gt;EFlags = 0x200<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;       <span class="comment">// force interrupts on, clear all else.</span>
00088 
00089     <span class="comment">//</span>
00090     <span class="comment">// Even though these are optional, they are used as is, since NULL</span>
00091     <span class="comment">// is what these would have been initialized to anyway</span>
00092     <span class="comment">//</span>
00093 
00094     Context-&gt;Esp = (ULONG) InitialSp;
00095     Context-&gt;Eip = (ULONG) InitialPc;
00096 
00097     <span class="comment">//</span>
00098     <span class="comment">// add code to check alignment and raise exception...</span>
00099     <span class="comment">//</span>
00100 
00101     Context-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>|<a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>|CONTEXT_SEGMENTS;
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Set the initial context of the thread in a machine specific way.</span>
00105     <span class="comment">// ie, pass the initial parameter to the start address</span>
00106     <span class="comment">//</span>
00107 
00108     Context-&gt;Esp -= <span class="keyword">sizeof</span>(Parameter);
00109     ZwWriteVirtualMemory(Process,
00110                          (PVOID)Context-&gt;Esp,
00111                          (PVOID)&amp;Parameter,
00112                          <span class="keyword">sizeof</span>(Parameter),
00113                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00114     Context-&gt;Esp -= <span class="keyword">sizeof</span>(Parameter); <span class="comment">// Reserve room for ret address</span>
00115 
00116 
00117 }
00118 
00119 
00120 
00121 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00122"></a><a class="code" href="../../d3/d6/rtl_2i386_2context_8c.html#a1">00122</a> <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a2">RtlRemoteCall</a>(
00123     HANDLE Process,
00124     HANDLE Thread,
00125     PVOID CallSite,
00126     ULONG ArgumentCount,
00127     PULONG Arguments,
00128     BOOLEAN PassContext,
00129     BOOLEAN AlreadySuspended
00130     )
00131 
00132 <span class="comment">/*++</span>
00133 <span class="comment"></span>
00134 <span class="comment">Routine Description:</span>
00135 <span class="comment"></span>
00136 <span class="comment">    This function calls a procedure in another thread/process, using</span>
00137 <span class="comment">    NtGetContext and NtSetContext.  Parameters are passed to the</span>
00138 <span class="comment">    target procedure via its stack.</span>
00139 <span class="comment"></span>
00140 <span class="comment">Arguments:</span>
00141 <span class="comment"></span>
00142 <span class="comment">    Process - Handle of the target process</span>
00143 <span class="comment"></span>
00144 <span class="comment">    Thread - Handle of the target thread within that process</span>
00145 <span class="comment"></span>
00146 <span class="comment">    CallSite - Address of the procedure to call in the target process.</span>
00147 <span class="comment"></span>
00148 <span class="comment">    ArgumentCount - Number of 32 bit parameters to pass to the target</span>
00149 <span class="comment">                    procedure.</span>
00150 <span class="comment"></span>
00151 <span class="comment">    Arguments - Pointer to the array of 32 bit parameters to pass.</span>
00152 <span class="comment"></span>
00153 <span class="comment">    PassContext - TRUE if an additional parameter is to be passed that</span>
00154 <span class="comment">        points to a context record.</span>
00155 <span class="comment"></span>
00156 <span class="comment">    AlreadySuspended - TRUE if the target thread is already in a suspended</span>
00157 <span class="comment">                       or waiting state.</span>
00158 <span class="comment"></span>
00159 <span class="comment">Return Value:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    Status - Status value</span>
00162 <span class="comment"></span>
00163 <span class="comment">--*/</span>
00164 
00165 {
00166     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00167     CONTEXT Context;
00168     ULONG NewSp;
00169     ULONG ArgumentsCopy[5];
00170 
00171     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00172 
00173     <span class="keywordflow">if</span> (ArgumentCount &gt; 4)
00174         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00175 
00176     <span class="comment">//</span>
00177     <span class="comment">// If necessary, suspend the guy before with we mess with his stack.</span>
00178     <span class="comment">//</span>
00179     <span class="keywordflow">if</span> (!AlreadySuspended) {
00180         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>( Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00181         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00182             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00183             }
00184         }
00185 
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Get the context record for the target thread.</span>
00189     <span class="comment">//</span>
00190 
00191     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00192     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>( Thread, &amp;Context );
00193     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00194         <span class="keywordflow">if</span> (!AlreadySuspended) {
00195             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00196             }
00197         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00198         }
00199 
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">//  Pass all parameters on the stack, regardless of whether a</span>
00203     <span class="comment">//  a context record is passed.</span>
00204     <span class="comment">//</span>
00205 
00206     <span class="comment">//</span>
00207     <span class="comment">//  Put Context Record on stack first, so it is above other args.</span>
00208     <span class="comment">//</span>
00209     NewSp = Context.Esp;
00210     <span class="keywordflow">if</span> (PassContext) {
00211         NewSp -= <span class="keyword">sizeof</span>( CONTEXT );
00212         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>( Process,
00213                                        (PVOID)NewSp,
00214                                        &amp;Context,
00215                                        <span class="keyword">sizeof</span>( CONTEXT ),
00216                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00217                                     );
00218         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00219             <span class="keywordflow">if</span> (!AlreadySuspended) {
00220                 <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00221                 }
00222             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00223             }
00224         ArgumentsCopy[0] = NewSp;   <span class="comment">// pass pointer to context</span>
00225         RtlMoveMemory(&amp;(ArgumentsCopy[1]),Arguments,ArgumentCount*<span class="keyword">sizeof</span>( ULONG ));
00226         ArgumentCount++;
00227         }
00228     <span class="keywordflow">else</span> {
00229         RtlMoveMemory(ArgumentsCopy,Arguments,ArgumentCount*<span class="keyword">sizeof</span>( ULONG ));
00230         }
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">//  Copy the arguments onto the target stack</span>
00234     <span class="comment">//</span>
00235     <span class="keywordflow">if</span> (ArgumentCount) {
00236         NewSp -= ArgumentCount * <span class="keyword">sizeof</span>( ULONG );
00237         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>( Process,
00238                                        (PVOID)NewSp,
00239                                        ArgumentsCopy,
00240                                        ArgumentCount * <span class="keyword">sizeof</span>( ULONG ),
00241                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00242                                      );
00243         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00244             <span class="keywordflow">if</span> (!AlreadySuspended) {
00245                 <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00246                 }
00247             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00248             }
00249         }
00250 
00251     <span class="comment">//</span>
00252     <span class="comment">// Set the address of the target code into Eip, the new target stack</span>
00253     <span class="comment">// into Esp, and reload context to make it happen.</span>
00254     <span class="comment">//</span>
00255     Context.Esp = NewSp;
00256     Context.Eip = (ULONG)CallSite;
00257     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>( Thread, &amp;Context );
00258     <span class="keywordflow">if</span> (!AlreadySuspended) {
00259         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00260         }
00261 
00262     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00263 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
