<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: channel.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>channel.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d5/d5/channel_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a3">KiCloseChannel</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID Object, IN ACCESS_MASK GrantedAccess, IN ULONG ProcessHandleCount, IN ULONG SystemHandleCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a4">KiDeleteChannel</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a5">KiListenChannel</a> (IN <a class="el" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> WaitMode, OUT PCHANNEL_MESSAGE *Message)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread</a> (IN <a class="el" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> WaitChannel, IN ULONG WaitMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a7">NtCreateChannel</a> (OUT PHANDLE ChannelHandle, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a8">NtListenChannel</a> (IN HANDLE ChannelHandle, OUT PCHANNEL_MESSAGE *Message)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a9">NtOpenChannel</a> (OUT PHANDLE ChannelHandle, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a10">NtReplyWaitSendChannel</a> (IN PVOID Text, IN ULONG Length, OUT PCHANNEL_MESSAGE *Message)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a11">NtSendWaitReplyChannel</a> (IN HANDLE ChannelHandle, IN PVOID Text, IN ULONG Length, OUT PCHANNEL_MESSAGE *Message)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a12">NtSetContextChannel</a> (IN PVOID Context)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a0">KeChannelType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/channel_8c.html#a1">KiChannelMapping</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="channel.c::KiAllocateReceiveBufferChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiAllocateReceiveBufferChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d5/channel_8c-source.html#l00236">NtListenChannel()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00525">NtReplyWaitSendChannel()</a>, and <a class="el" href="../../d5/d5/channel_8c-source.html#l00807">NtSendWaitReplyChannel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="channel.c::KiCloseChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiCloseChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandleCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemHandleCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="channel.c::KiDeleteChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiDeleteChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="channel.c::KiListenChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KiListenChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerChannel</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCHANNEL_MESSAGE *&nbsp;</td>
          <td class="mdname" nowrap> <em>Message</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d5/channel_8c-source.html#l00236">NtListenChannel()</a>, and <a class="el" href="../../d5/d5/channel_8c-source.html#l00525">NtReplyWaitSendChannel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="channel.c::KiRendezvousWithThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> KiRendezvousWithThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitChannel</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d5/channel_8c-source.html#l00525">NtReplyWaitSendChannel()</a>, and <a class="el" href="../../d5/d5/channel_8c-source.html#l00807">NtSendWaitReplyChannel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="channel.c::NtCreateChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ChannelHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/channel_8c-source.html#l00101">101</a> of file <a class="el" href="../../d5/d5/channel_8c-source.html">channel.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00823">_ECHANNEL::ClearToSendEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00818">_ECHANNEL::ClientThread</a>, <a class="el" href="../../d4/d9/ke_8h.html#a109">ECHANNEL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00068">KeChannelType</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00802">LISTEN_CHANNEL</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00817">_ECHANNEL::OwnerProcess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01581">ProbeAndZeroHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00822">_ECHANNEL::ReceiveEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00821">_ECHANNEL::ServerChannel</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00820">_ECHANNEL::ServerContext</a>, <a class="el" href="../../d4/d9/ke_8h.html#a409a233">ServerIdle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00819">_ECHANNEL::ServerThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00816">_ECHANNEL::State</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00815">_ECHANNEL::Type</a>.
<p>
<pre class="fragment"><div>00108                    :
00109 
00110     This function creates a server listen channel object and opens a handle
00111     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified desired access.
00112 
00113 Arguments:
00114 
00115     ChannelHandle - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00116         channel object handle.
00117 
00118     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies a pointer to an object attributes structure.
00119 
00120 Return Value:
00121 
00122     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> channel object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created, then a success status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00123     Otherwise, a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00124 
00125 --*/
00126 
00127 {
00128 
00129 <span class="preprocessor">#if 0</span>
00130 <span class="preprocessor"></span>
00131     PVOID ChannelObject;
00132     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00133     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel;
00134     HANDLE ServerHandle;
00135     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Establish an exception handler, probe and zero the output handle</span>
00139     <span class="comment">// address, and attempt to create a channel object. If the probe fails</span>
00140     <span class="comment">// or access to the object attributes fails, then return the exception</span>
00141     <span class="comment">// code as the service status.</span>
00142     <span class="comment">//</span>
00143 
00144     PreviousMode = KeGetPreviousMode();
00145     <span class="keywordflow">try</span> {
00146 
00147         <span class="comment">//</span>
00148         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00149         <span class="comment">// necessary.</span>
00150         <span class="comment">//</span>
00151 
00152         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00153             <a class="code" href="../../d5/d8/ex_8h.html#a36">ProbeAndZeroHandle</a>(ChannelHandle);
00154         }
00155 
00156         <span class="comment">//</span>
00157         <span class="comment">// Allocate channel object.</span>
00158         <span class="comment">//</span>
00159 
00160         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(PreviousMode,
00161                                 KeChannelType,
00162                                 ObjectAttributes,
00163                                 PreviousMode,
00164                                 NULL,
00165                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__ECHANNEL.html">ECHANNEL</a>),
00166                                 0,
00167                                 0,
00168                                 &amp;ChannelObject);
00169 
00170     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00171         <span class="keywordflow">return</span> GetExceptionCode();
00172     }
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// If the channel object was successfully created, then initialize the</span>
00176     <span class="comment">// channel object and insert the channel object in the process handle</span>
00177     <span class="comment">// table.</span>
00178     <span class="comment">//</span>
00179 
00180     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00181         ServerChannel = (<a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a>)ChannelObject;
00182         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o0">Type</a> = <a class="code" href="../../d4/d9/ke_8h.html#a18">LISTEN_CHANNEL</a>;
00183         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a409a233">ServerIdle</a>;
00184         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o2">OwnerProcess</a> = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb;
00185         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o3">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00186         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o5">ServerContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00188         ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00189         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o7">ReceiveEvent</a>,
00190                           SynchronizationEvent,
00191                           FALSE);
00192 
00193         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o8">ClearToSendEvent</a>,
00194                           SynchronizationEvent,
00195                           FALSE);
00196 
00197         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(ServerChannel,
00198                                 NULL,
00199                                 CHANNEL_ALL_ACCESS,
00200                                 0,
00201                                 NULL,
00202                                 &amp;ServerHandle);
00203 
00204         <span class="comment">//</span>
00205         <span class="comment">// If the channel object was successfully inserted in the process</span>
00206         <span class="comment">// handle table, then attempt to write the channel object handle</span>
00207         <span class="comment">// value. If the write attempt fails, then do not report an error.</span>
00208         <span class="comment">// When the caller attempts to access the handle value, an access</span>
00209         <span class="comment">// violation will occur.</span>
00210         <span class="comment">//</span>
00211 
00212         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00213             <span class="keywordflow">try</span> {
00214                 *ChannelHandle = ServerHandle;
00215 
00216             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00217             }
00218         }
00219     }
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// Return service status.</span>
00223     <span class="comment">//</span>
00224 
00225     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00226 
00227 <span class="preprocessor">#else</span>
00228 <span class="preprocessor"></span>
00229     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00230 
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>
00233 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="channel.c::NtListenChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtListenChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ChannelHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCHANNEL_MESSAGE *&nbsp;</td>
          <td class="mdname" nowrap> <em>Message</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/channel_8c-source.html#l00236">236</a> of file <a class="el" href="../../d5/d5/channel_8c-source.html">channel.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00068">KeChannelType</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel()</a>, <a class="el" href="../../d4/d6/channel_8c.html#a5">KiListenChannel()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01615">ProbeAndNullPointer</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00821">_ECHANNEL::ServerChannel</a>, <a class="el" href="../../d9/d0/userver_8c-source.html#l00173">ServerThread()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00243                    :
00244 
00245     This function listens <span class="keywordflow">for</span> a client message.
00246 
00247     N.B. This function can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be executed from a server thread.
00248 
00249 Arguments:
00250 
00251     ChannelHandle - Supplies a handle to a listen channel on which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00252         server thread listens.
00253 
00254     Message - Supplies a pointer to a variable that receives a pointer
00255         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client message header.
00256 
00257 Return Value:
00258 
00259     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully completed, then a success status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00260     returned. Otherwise, a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00261 
00262 --*/
00263 
00264 {
00265 
00266 <span class="preprocessor">#if 0</span>
00267 <span class="preprocessor"></span>
00268     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00269     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel;
00270     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
00271     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// Establish an exception handler, probe the output message address,</span>
00275     <span class="comment">// and allocate a receive buffer if necessary. If the probe fails or</span>
00276     <span class="comment">// the receive buffer allocation is not successful, then return the</span>
00277     <span class="comment">// exception code as the service status.</span>
00278     <span class="comment">//</span>
00279 
00280     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00281     <span class="keywordflow">try</span> {
00282 
00283         <span class="comment">//</span>
00284         <span class="comment">// Get previous processor mode and probe output message address.</span>
00285         <span class="comment">//</span>
00286 
00287         PreviousMode = KeGetPreviousMode();
00288         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00289             <a class="code" href="../../d5/d8/ex_8h.html#a38">ProbeAndNullPointer</a>(Message);
00290         }
00291 
00292         <span class="comment">//</span>
00293         <span class="comment">// If the current thread does not have an associated receive buffer,</span>
00294         <span class="comment">// then attempt to allocate one now. If the allocation fails, then</span>
00295         <span class="comment">// an exception is raised.</span>
00296         <span class="comment">//</span>
00297 
00298         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Section == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00299             <a class="code" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a>();
00300         }
00301 
00302     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00303         <span class="keywordflow">return</span> GetExceptionCode();
00304     }
00305 
00306     <span class="comment">//</span>
00307     <span class="comment">// Reference channel object by handle.</span>
00308     <span class="comment">//</span>
00309 
00310     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ChannelHandle,
00311                                        CHANNEL_ALL_ACCESS,
00312                                        KeChannelType,
00313                                        PreviousMode,
00314                                        &amp;ServerChannel,
00315                                        NULL);
00316 
00317     <span class="comment">//</span>
00318     <span class="comment">// If the reference was successful and the channel is a listen channel,</span>
00319     <span class="comment">// then wait for a client message to arrive.</span>
00320     <span class="comment">//</span>
00321 
00322     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00323         <span class="keywordflow">if</span> (ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00324             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// **** fix ****</span>
00325 
00326         } <span class="keywordflow">else</span> {
00327             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/channel_8c.html#a5">KiListenChannel</a>(ServerChannel, PreviousMode, Message);
00328         }
00329 
00330         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ServerChannel);
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// Return service status.</span>
00335     <span class="comment">//</span>
00336 
00337     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00338 
00339 <span class="preprocessor">#else</span>
00340 <span class="preprocessor"></span>
00341     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00342 
00343 <span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>
00345 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="channel.c::NtOpenChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ChannelHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/channel_8c-source.html#l00348">348</a> of file <a class="el" href="../../d5/d5/channel_8c-source.html">channel.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00068">KeChannelType</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00803">MESSAGE_CHANNEL</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00817">_ECHANNEL::OwnerProcess</a>, <a class="el" href="../../d4/d9/ke_8h.html#a110">PECHANNEL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01581">ProbeAndZeroHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00355                    :
00356 
00357     This function opens a handle to a server channel by creating a message
00358     channel that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> connected to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified server channel.
00359 
00360 Arguments:
00361 
00362     ChannelHandle - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00363         channel object handle.
00364 
00365     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies a pointer to an object attributes structure.
00366 
00367 Return Value:
00368 
00369     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> channel object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened, then a success status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00370     Otherwise, a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00371 
00372 --*/
00373 
00374 {
00375 
00376 <span class="preprocessor">#if 0</span>
00377 <span class="preprocessor"></span>
00378     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ClientChannel;
00379     HANDLE ClientHandle;
00380     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00381     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00382     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel;
00383     PVOID ServerObject;
00384     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Establish an exception handler, probe and zero the output handle</span>
00388     <span class="comment">// address, and attempt to open the server channel object. If the</span>
00389     <span class="comment">// probe fails, then return the exception code as the service status.</span>
00390     <span class="comment">//</span>
00391 
00392     <span class="keywordflow">try</span> {
00393 
00394         <span class="comment">//</span>
00395         <span class="comment">// Get previous processor mode and probe output handle address</span>
00396         <span class="comment">// if necessary.</span>
00397         <span class="comment">//</span>
00398 
00399         PreviousMode = KeGetPreviousMode();
00400         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00401             <a class="code" href="../../d5/d8/ex_8h.html#a36">ProbeAndZeroHandle</a>(ChannelHandle);
00402         }
00403 
00404         <span class="comment">//</span>
00405         <span class="comment">// Reference the server channel object with the specified desired</span>
00406         <span class="comment">// access.</span>
00407         <span class="comment">//</span>
00408 
00409         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName,
00410                                         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;Attributes,
00411                                         NULL,
00412                                         CHANNEL_ALL_ACCESS,
00413                                         KeChannelType,
00414                                         PreviousMode,
00415                                         NULL,
00416                                         (PVOID *)&amp;ServerObject);
00417 
00418     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00419         <span class="keywordflow">return</span> GetExceptionCode();
00420     }
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// If the reference was successful, then attempt to create a client</span>
00424     <span class="comment">// channel object.</span>
00425     <span class="comment">//</span>
00426 
00427     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">// If the owner process of the server channel is the same as</span>
00431         <span class="comment">// the current process, then a server thread is attempting to</span>
00432         <span class="comment">// open a client handle. This is not allowed since it would</span>
00433         <span class="comment">// not be possible to distinguish the server from the cient.</span>
00434         <span class="comment">//</span>
00435 
00436         <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00437         ServerChannel = (<a class="code" href="../../d9/d1/struct__ECHANNEL.html">PECHANNEL</a>)ServerObject;
00438         <span class="keywordflow">if</span> (ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o2">OwnerProcess</a> == <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;ApcState.Process) {
00439             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// **** fix ***</span>
00440 
00441         } <span class="keywordflow">else</span> {
00442             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(PreviousMode,
00443                                     KeChannelType,
00444                                     NULL,
00445                                     PreviousMode,
00446                                     NULL,
00447                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__ECHANNEL.html">ECHANNEL</a>),
00448                                     0,
00449                                     0,
00450                                     (PVOID *)&amp;ClientChannel);
00451 
00452             <span class="comment">//</span>
00453             <span class="comment">// If the channel object was successfully created, then</span>
00454             <span class="comment">// initialize the channel object and attempt to insert the</span>
00455             <span class="comment">// channel object in the server process channel table.</span>
00456             <span class="comment">//</span>
00457 
00458             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00459                 ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o0">Type</a> = <a class="code" href="../../d4/d9/ke_8h.html#a19">MESSAGE_CHANNEL</a>;
00460                 ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>;
00461                 ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o2">OwnerProcess</a> = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb;
00462                 ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o3">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00463                 ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00464                 ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o5">ServerContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00465                 ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a> = ServerChannel;
00466                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o7">ReceiveEvent</a>,
00467                                   SynchronizationEvent,
00468                                   FALSE);
00469 
00470                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ClientChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o8">ClearToSendEvent</a>,
00471                                   SynchronizationEvent,
00472                                   FALSE);
00473 
00474                 <span class="comment">//</span>
00475                 <span class="comment">// Create a handle to the message channel object.</span>
00476                 <span class="comment">//</span>
00477 
00478                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(ClientChannel,
00479                                         NULL,
00480                                         CHANNEL_ALL_ACCESS,
00481                                         0,
00482                                         NULL,
00483                                         &amp;ClientHandle);
00484 
00485                 <span class="comment">//</span>
00486                 <span class="comment">// If the channel object was successfully inserted in the</span>
00487                 <span class="comment">// client process handle table, then attempt to write the</span>
00488                 <span class="comment">// client channel object handle value. If the write attempt</span>
00489                 <span class="comment">// fails, then do not report an error. When the caller</span>
00490                 <span class="comment">// attempts to access the handle value, an access violation</span>
00491                 <span class="comment">// will occur.</span>
00492                 <span class="comment">//</span>
00493 
00494                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00495                     <span class="keywordflow">try</span> {
00496                         *ChannelHandle = ClientHandle;
00497 
00498                     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00499                     }
00500 
00501                 }
00502 
00503                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00504             }
00505         }
00506 
00507         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ServerChannel);
00508     }
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// Return service status.</span>
00512     <span class="comment">//</span>
00513 
00514     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00515 
00516 <span class="preprocessor">#else</span>
00517 <span class="preprocessor"></span>
00518     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00519 
00520 <span class="preprocessor">#endif</span>
00521 <span class="preprocessor"></span>
00522 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="channel.c::NtReplyWaitSendChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtReplyWaitSendChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Text</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCHANNEL_MESSAGE *&nbsp;</td>
          <td class="mdname" nowrap> <em>Message</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/channel_8c-source.html#l00525">525</a> of file <a class="el" href="../../d5/d5/channel_8c-source.html">channel.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00823">_ECHANNEL::ClearToSendEvent</a>, <a class="el" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00818">_ECHANNEL::ClientThread</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00413">_KEVENT::Header</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel()</a>, <a class="el" href="../../d4/d6/channel_8c.html#a5">KiListenChannel()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01615">ProbeAndNullPointer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00822">_ECHANNEL::ReceiveEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00821">_ECHANNEL::ServerChannel</a>, <a class="el" href="../../d4/d9/ke_8h.html#a409a234">ServerReceiveMessage</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00819">_ECHANNEL::ServerThread</a>, <a class="el" href="../../d9/d0/userver_8c-source.html#l00173">ServerThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00816">_ECHANNEL::State</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a218">WrRendezvous</a>.
<p>
<pre class="fragment"><div>00533                    :
00534 
00535     This function sends a reply message to a client and waits <span class="keywordflow">for</span> a send.
00536 
00537     N.B. This function can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be executed from a server thread that
00538         has an assoicated message channel.
00539 
00540 Arguments:
00541 
00542     Text - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a>.
00543 
00544     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a>.
00545 
00546     Message - Supplies a pointer to a variable that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> send
00547         message header.
00548 
00549 Return Value:
00550 
00551     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully completed, then a succes status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00552     returned. Otherwise, a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00553 
00554 --*/
00555 
00556 {
00557 
00558 <span class="preprocessor">#if 0</span>
00559 <span class="preprocessor"></span>
00560     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00561     PCHANNEL_MESSAGE ClientView;
00562     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> MessageChannel;
00563     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00564     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PECHANNEL</a> ServerChannel;
00565     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
00566     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00567 
00568     <span class="comment">//</span>
00569     <span class="comment">// Establish an exception handler, probe the output message address,</span>
00570     <span class="comment">// probe the message text, and allocate a receive buffer if necessary.</span>
00571     <span class="comment">// If either of the probes fail or the receive buffer allocation is</span>
00572     <span class="comment">// not successful, then return the exception code as the service</span>
00573     <span class="comment">// status.</span>
00574     <span class="comment">//</span>
00575 
00576     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00577     <span class="keywordflow">try</span> {
00578 
00579         <span class="comment">//</span>
00580         <span class="comment">// Get previous processor mode and probe output message address and</span>
00581         <span class="comment">// the message text if necessary.</span>
00582         <span class="comment">//</span>
00583 
00584         PreviousMode = KeGetPreviousMode();
00585         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00586             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Text, Length, <span class="keyword">sizeof</span>(CHAR));
00587             <a class="code" href="../../d5/d8/ex_8h.html#a38">ProbeAndNullPointer</a>(Message);
00588         }
00589 
00590         <span class="comment">//</span>
00591         <span class="comment">// If the current thread does not have an associated receive buffer,</span>
00592         <span class="comment">// then attempt to allocate one now. If the allocation fails, then</span>
00593         <span class="comment">// an exception is raised.</span>
00594         <span class="comment">//</span>
00595 
00596         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Section == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00597             <a class="code" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a>();
00598         }
00599 
00600     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00601         <span class="keywordflow">return</span> GetExceptionCode();
00602     }
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// If the message length is greater than the host page size minus</span>
00606     <span class="comment">// the message header length, then return an error.</span>
00607     <span class="comment">//</span>
00608 
00609     <span class="keywordflow">if</span> (Length &gt;= (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(CHANNEL_MESSAGE))) {
00610         <span class="keywordflow">return</span>  STATUS_BUFFER_OVERFLOW;
00611     }
00612 
00613     <span class="comment">//</span>
00614     <span class="comment">// If the server thread has an associated message channel, the channel</span>
00615     <span class="comment">// is in server receive message state, and the channel server thread</span>
00616     <span class="comment">// matches the current thread.</span>
00617     <span class="comment">//</span>
00618     <span class="comment">// This implies that:</span>
00619     <span class="comment">//</span>
00620     <span class="comment">// 1. The channel is a message channel.</span>
00621     <span class="comment">//</span>
00622     <span class="comment">// 2. The channel is being accessed by the server thread.</span>
00623     <span class="comment">//</span>
00624     <span class="comment">// 3. The channel is associated with a listen channel.</span>
00625     <span class="comment">//</span>
00626     <span class="comment">// 4. There is currently a server channel owner.</span>
00627     <span class="comment">//</span>
00628     <span class="comment">// 5. There is currently a client channel owner.</span>
00629     <span class="comment">//</span>
00630 
00631     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00632     MessageChannel = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Channel;
00633     <span class="keywordflow">if</span> ((MessageChannel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00634         (MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> != <a class="code" href="../../d4/d9/ke_8h.html#a409a234">ServerReceiveMessage</a>) ||
00635         (MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a> != <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>)) {
00636 
00637         <span class="comment">//</span>
00638         <span class="comment">// A message is not associated with the current thread,</span>
00639         <span class="comment">// the message channel is in the wrong state, or the</span>
00640         <span class="comment">// current thread is not the owner of the channel.</span>
00641         <span class="comment">//</span>
00642 
00643         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00644         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// **** fix ****</span>
00645 
00646     } <span class="keywordflow">else</span> {
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">// Rendezvous with the client thread so a transfer of the</span>
00650         <span class="comment">// reply text to the client thread can occur.</span>
00651         <span class="comment">//</span>
00652 
00653         <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = <a class="code" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread</a>(MessageChannel, PreviousMode);
00654 
00655         <span class="comment">//</span>
00656         <span class="comment">// Control is returned when:</span>
00657         <span class="comment">//</span>
00658         <span class="comment">// 1. The server thread is being terminated (USER_APC).</span>
00659         <span class="comment">//</span>
00660         <span class="comment">// 2. A rendezvous with a client thread has occured.</span>
00661         <span class="comment">//</span>
00662         <span class="comment">// N.B. If the status value is less than zero, then it</span>
00663         <span class="comment">//      is the address of the client thread.</span>
00664         <span class="comment">//</span>
00665 
00666         <span class="keywordflow">if</span> ((LONG)<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> &lt; 0) {
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// The client thread is returned as the rendezvous status</span>
00670             <span class="comment">// with the thread in the transition state. Get the address</span>
00671             <span class="comment">// of the client thread system view, establish an exception</span>
00672             <span class="comment">// handler, and transfer the  message text from the server's</span>
00673             <span class="comment">// buffer to the client's receive buffer. If an exception</span>
00674             <span class="comment">// occurs during the copy, then return the exception code</span>
00675             <span class="comment">// as the service status.</span>
00676             <span class="comment">//</span>
00677 
00678             ClientView = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;SystemView;
00679             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00680             <span class="keywordflow">if</span> (Length != 0) {
00681                 <span class="keywordflow">try</span> {
00682                     RtlCopyMemory(ClientView + 1, Text, Length);
00683 
00684                 } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00685                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00686                 }
00687             }
00688 
00689             <span class="comment">//</span>
00690             <span class="comment">// Set the channel message parameters.</span>
00691             <span class="comment">//</span>
00692 
00693             ClientView-&gt;Text = (PVOID)(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;ThreadView + 1);
00694             ClientView-&gt;Length = Length;
00695             ClientView-&gt;Context = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00696             ClientView-&gt;Base = Text;
00697             ClientView-&gt;Close = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00698 
00699             <span class="comment">//</span>
00700             <span class="comment">// Raise IRQL to dispatch level, lock the dispatcher</span>
00701             <span class="comment">// database, and check if the message was successfully</span>
00702             <span class="comment">// transfered to the client's receive buffer. If the</span>
00703             <span class="comment">// message was successfully transfered to the client's</span>
00704             <span class="comment">// receive buffer. then reset the channel state, fill</span>
00705             <span class="comment">// in the message parameters, ready the client thread,</span>
00706             <span class="comment">// and listen for the next message. Otherwise, set the</span>
00707             <span class="comment">// client wait status and ready the client thread for</span>
00708             <span class="comment">// execution.</span>
00709             <span class="comment">//</span>
00710 
00711             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00712             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00713                 MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>;
00714                 MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o3">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00715                 MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00716                 <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitStatus = STATUS_SUCCESS;
00717 
00718                 <span class="comment">//</span>
00719                 <span class="comment">// Reference the server channel and dereference the</span>
00720                 <span class="comment">// message channel.</span>
00721                 <span class="comment">//</span>
00722 
00723                 ServerChannel = MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a>;
00724                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(ServerChannel);
00725                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MessageChannel);
00726 
00727                 <span class="comment">//</span>
00728                 <span class="comment">// If there are no clients waiting to send to the server,</span>
00729                 <span class="comment">// then switch directly to the client thread. Otherwise,</span>
00730                 <span class="comment">// ready the client thread, then listen for the next</span>
00731                 <span class="comment">// message.</span>
00732                 <span class="comment">//</span>
00733 
00734                 <span class="keywordflow">if</span> (IsListEmpty(&amp;ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o8">ClearToSendEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00735                     <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(ClientThread);
00736                     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00737                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/channel_8c.html#a5">KiListenChannel</a>(ServerChannel,
00738                                              PreviousMode,
00739                                              Message);
00740 
00741                 } <span class="keywordflow">else</span> {
00742                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = KiSwitchToThread(ClientThread,
00743                                               WrRendezvous,
00744                                               PreviousMode,
00745                                               &amp;ServerChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o7">ReceiveEvent</a>);
00746 
00747                     <span class="comment">//</span>
00748                     <span class="comment">// If a client message was successfully received, then</span>
00749                     <span class="comment">// attempt to write the address of the send message</span>
00750                     <span class="comment">// address. If the write attempt fails, then do not</span>
00751                     <span class="comment">// report an error. When the caller attempts to access</span>
00752                     <span class="comment">// the message address, an access violation will occur.</span>
00753                     <span class="comment">//</span>
00754 
00755                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00756                         <span class="keywordflow">try</span> {
00757                             *Message = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;ThreadView;
00758 
00759                         } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00760                         }
00761                     }
00762                 }
00763 
00764                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ServerChannel);
00765 
00766             } <span class="keywordflow">else</span> {
00767 
00768                 <span class="comment">//</span>
00769                 <span class="comment">// The reply message was not successfully transfered</span>
00770                 <span class="comment">// to the client receive buffer because of an access</span>
00771                 <span class="comment">// violation encountered durring the access to the</span>
00772                 <span class="comment">// server buffer.</span>
00773                 <span class="comment">//</span>
00774 
00775                 <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitStatus = STATUS_KERNEL_APC;
00776                 <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(ClientThread);
00777                 <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitIrql);
00778             }
00779 
00780         } <span class="keywordflow">else</span> {
00781 
00782             <span class="comment">//</span>
00783             <span class="comment">// The server thread is terminating and the channel</span>
00784             <span class="comment">// structures will be cleaned up by the termiantion</span>
00785             <span class="comment">// code.</span>
00786             <span class="comment">//</span>
00787 
00788             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00789         }
00790     }
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// Return service status.</span>
00794     <span class="comment">//</span>
00795 
00796     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00797 
00798 <span class="preprocessor">#else</span>
00799 <span class="preprocessor"></span>
00800     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00801 
00802 <span class="preprocessor">#endif</span>
00803 <span class="preprocessor"></span>
00804 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="channel.c::NtSendWaitReplyChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSendWaitReplyChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ChannelHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Text</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCHANNEL_MESSAGE *&nbsp;</td>
          <td class="mdname" nowrap> <em>Message</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/channel_8c-source.html#l00807">807</a> of file <a class="el" href="../../d5/d5/channel_8c-source.html">channel.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>, <a class="el" href="../../d4/d9/ke_8h.html#a409a231">ClientSendWaitReply</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00068">KeChannelType</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01615">ProbeAndNullPointer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00821">_ECHANNEL::ServerChannel</a>, <a class="el" href="../../d4/d9/ke_8h.html#a409a234">ServerReceiveMessage</a>, <a class="el" href="../../d9/d0/userver_8c-source.html#l00173">ServerThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a218">WrRendezvous</a>.
<p>
<pre class="fragment"><div>00816                    :
00817 
00818     This function sends a message to a server and waits <span class="keywordflow">for</span> a reply.
00819 
00820     N.B. This function can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be executed from a client thread.
00821 
00822 Arguments:
00823 
00824     ChannelHandle - Supplies a handle to a message channel over which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00825         specified message <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent.
00826 
00827     Text - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a>.
00828 
00829     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a>.
00830 
00831     Message - Supplies a pointer to a variable that receives a pointer
00832         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reply message header.
00833 
00834 Return Value:
00835 
00836     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully completed, then a success status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00837     returned. Otherwise, a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00838 
00839 --*/
00840 
00841 {
00842 
00843 <span class="preprocessor">#if 0</span>
00844 <span class="preprocessor"></span>
00845     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00846     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> MessageChannel;
00847     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00848     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> ServerChannel;
00849     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
00850     PCHANNEL_MESSAGE ServerView;
00851     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00852 
00853     <span class="comment">//</span>
00854     <span class="comment">// Establish an exception handler, probe the output message address,</span>
00855     <span class="comment">// probe the message text, and allocate a receive buffer if necessary.</span>
00856     <span class="comment">// If either of the probes fail or the receive buffer allocation is</span>
00857     <span class="comment">// not successful, then return the exception code as the service</span>
00858     <span class="comment">// status.</span>
00859     <span class="comment">//</span>
00860 
00861     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00862     <span class="keywordflow">try</span> {
00863 
00864         <span class="comment">//</span>
00865         <span class="comment">// Get previous processor mode and probe output message address</span>
00866         <span class="comment">// and the message text.</span>
00867         <span class="comment">//</span>
00868 
00869         PreviousMode = KeGetPreviousMode();
00870         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00871             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Text, Length, <span class="keyword">sizeof</span>(UCHAR));
00872             <a class="code" href="../../d5/d8/ex_8h.html#a38">ProbeAndNullPointer</a>(Message);
00873         }
00874 
00875         <span class="comment">//</span>
00876         <span class="comment">// If the current thread does not have an associated receive buffer,</span>
00877         <span class="comment">// then attempt to allocate one now. If the allocation fails, then</span>
00878         <span class="comment">// an exception is raised.</span>
00879         <span class="comment">//</span>
00880 
00881         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;Section == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00882             <a class="code" href="../../d4/d6/channel_8c.html#a2">KiAllocateReceiveBufferChannel</a>();
00883         }
00884 
00885     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00886         <span class="keywordflow">return</span> GetExceptionCode();
00887     }
00888 
00889     <span class="comment">//</span>
00890     <span class="comment">// If the message length is greater than the host page size minus</span>
00891     <span class="comment">// the message header length, then return an error.</span>
00892     <span class="comment">//</span>
00893 
00894     <span class="keywordflow">if</span> (Length &gt;= (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(CHANNEL_MESSAGE))) {
00895         <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00896     }
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">// Reference channel object by handle.</span>
00900     <span class="comment">//</span>
00901 
00902     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ChannelHandle,
00903                                        CHANNEL_ALL_ACCESS,
00904                                        KeChannelType,
00905                                        PreviousMode,
00906                                        (PVOID *)&amp;MessageChannel,
00907                                        NULL);
00908 
00909     <span class="comment">//</span>
00910     <span class="comment">// If the reference was successful, then check if the channel is in</span>
00911     <span class="comment">// the client idle state.</span>
00912     <span class="comment">//</span>
00913     <span class="comment">// This implies that:</span>
00914     <span class="comment">//</span>
00915     <span class="comment">// 1. The channel is a message channel.</span>
00916     <span class="comment">//</span>
00917     <span class="comment">// 2. The channel is being accessed by a client thread.</span>
00918     <span class="comment">//</span>
00919     <span class="comment">// 3. The channel is connected to a listen channel.</span>
00920     <span class="comment">//</span>
00921     <span class="comment">// 4. There is currently no client thread channel owner.</span>
00922     <span class="comment">//</span>
00923     <span class="comment">// 5. There is currently no server thread channel owner.</span>
00924     <span class="comment">//</span>
00925 
00926     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00927         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitIrql);
00928         <span class="keywordflow">if</span> (MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> != <a class="code" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>) {
00929 
00930             <span class="comment">//</span>
00931             <span class="comment">// The message channel is in the wrong state.</span>
00932             <span class="comment">//</span>
00933 
00934             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitIrql);
00935             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// **** fix ****</span>
00936 
00937         } <span class="keywordflow">else</span> {
00938 
00939             <span class="comment">//</span>
00940             <span class="comment">// Set the channel state, set the client owner thread, and</span>
00941             <span class="comment">// rendezvous with a server thread.</span>
00942             <span class="comment">//</span>
00943 
00944             MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a409a231">ClientSendWaitReply</a>;
00945             MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o3">ClientThread</a> = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00946             <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;Channel = MessageChannel;
00947             ServerChannel = MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o6">ServerChannel</a>;
00948             <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> = <a class="code" href="../../d4/d6/channel_8c.html#a6">KiRendezvousWithThread</a>(ServerChannel, PreviousMode);
00949 
00950             <span class="comment">//</span>
00951             <span class="comment">// Control is returned when:</span>
00952             <span class="comment">//</span>
00953             <span class="comment">// 1. The client thread is being terminated (USER_APC).</span>
00954             <span class="comment">//</span>
00955             <span class="comment">// 2. A rendezvous with a server thread has occured.</span>
00956             <span class="comment">//</span>
00957             <span class="comment">// N.B. If the status value is less than zero, then it</span>
00958             <span class="comment">//      is the address of the server thread.</span>
00959             <span class="comment">//</span>
00960 
00961             <span class="keywordflow">if</span> ((LONG)<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a> &lt; 0) {
00962 
00963                 <span class="comment">//</span>
00964                 <span class="comment">// The server thread is returned as the rendezvous status</span>
00965                 <span class="comment">// with the thread in the transition state. Get the address</span>
00966                 <span class="comment">// of the server thread system view, establish an exception</span>
00967                 <span class="comment">// handler, and transfer the message text from the client's</span>
00968                 <span class="comment">// buffer to the server's receive buffer. If an exception</span>
00969                 <span class="comment">// occurs during the copy, then return the exception code</span>
00970                 <span class="comment">// as the service status.</span>
00971                 <span class="comment">//</span>
00972 
00973                 ServerView = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;SystemView;
00974                 <span class="keywordflow">if</span> (Length != 0) {
00975                     <span class="keywordflow">try</span> {
00976                         RtlCopyMemory(ServerView + 1, Text, Length);
00977 
00978                     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00979                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00980                     }
00981                 }
00982 
00983                 <span class="comment">//</span>
00984                 <span class="comment">// Set the channel message parameters.</span>
00985                 <span class="comment">//</span>
00986 
00987                 ServerView-&gt;Text = (PVOID)(<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;ThreadView + 1);
00988                 ServerView-&gt;Length = Length;
00989                 ServerView-&gt;Context = MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o5">ServerContext</a>;
00990                 ServerView-&gt;Base = Text;
00991                 ServerView-&gt;Close = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00992 
00993                 <span class="comment">//</span>
00994                 <span class="comment">// Raise IRQL to dispatch level, lock the dispatcher</span>
00995                 <span class="comment">// database and check if the message was successfully</span>
00996                 <span class="comment">// transfered to the server's receive buffer. If the</span>
00997                 <span class="comment">// message was successfully transfered, then set the</span>
00998                 <span class="comment">// channel state, set the server thread address, set</span>
00999                 <span class="comment">// the address of the message channel in the server</span>
01000                 <span class="comment">// thread, increment the message channel reference</span>
01001                 <span class="comment">// count, fill in the message parameters, and switch</span>
01002                 <span class="comment">// directly to the server thread. Otherwise, set the</span>
01003                 <span class="comment">// channel state, and reready the server thread for</span>
01004                 <span class="comment">// execution.</span>
01005                 <span class="comment">//</span>
01006 
01007                 <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitIrql);
01008                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01009                     MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a409a234">ServerReceiveMessage</a>;
01010                     MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a> = <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
01011                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(MessageChannel);
01012                     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;Channel = MessageChannel;
01013                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = KiSwitchToThread(ServerThread,
01014                                               WrRendezvous,
01015                                               PreviousMode,
01016                                               &amp;MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o7">ReceiveEvent</a>);
01017 
01018                     <span class="comment">//</span>
01019                     <span class="comment">// If the send and subsequent reply from the server</span>
01020                     <span class="comment">// thread is successful, then attempt to write the</span>
01021                     <span class="comment">// address of the reply message address. If the write</span>
01022                     <span class="comment">// attempt fails, then do not report an error. When</span>
01023                     <span class="comment">// the caller attempts to access the message address,</span>
01024                     <span class="comment">// an access violation will occur.</span>
01025                     <span class="comment">//</span>
01026 
01027                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01028                         <span class="keywordflow">try</span> {
01029                             *Message = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;ThreadView;
01030 
01031                         } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
01032                         }
01033                     }
01034 
01035                 } <span class="keywordflow">else</span> {
01036 
01037                     <span class="comment">//</span>
01038                     <span class="comment">// The send message was not successfully transfered</span>
01039                     <span class="comment">// to the server receive buffer because of an access</span>
01040                     <span class="comment">// violation encountered durring the access to the</span>
01041                     <span class="comment">// client buffer.</span>
01042                     <span class="comment">//</span>
01043 
01044                     MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o1">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a409a230">ClientIdle</a>;
01045                     MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o3">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01046                     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;Channel = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01047                     <a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>-&gt;WaitStatus = STATUS_KERNEL_APC;
01048                     <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(ServerThread);
01049                     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;WaitIrql);
01050                 }
01051 
01052             } <span class="keywordflow">else</span> {
01053 
01054                 <span class="comment">//</span>
01055                 <span class="comment">// The client thread is terminating and the channel</span>
01056                 <span class="comment">// structures will be cleaned up by the termination</span>
01057                 <span class="comment">// code.</span>
01058                 <span class="comment">//</span>
01059 
01060                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d8/d1/userver_8c.html#a10">ServerThread</a>;
01061             }
01062         }
01063 
01064         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MessageChannel);
01065     }
01066 
01067     <span class="comment">//</span>
01068     <span class="comment">// Return service status.</span>
01069     <span class="comment">//</span>
01070 
01071     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01072 
01073 <span class="preprocessor">#else</span>
01074 <span class="preprocessor"></span>
01075     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
01076 
01077 <span class="preprocessor">#endif</span>
01078 <span class="preprocessor"></span>
01079 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="channel.c::NtSetContextChannel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetContextChannel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/channel_8c-source.html#l01082">1082</a> of file <a class="el" href="../../d5/d5/channel_8c-source.html">channel.c</a>.
<p>
References <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00820">_ECHANNEL::ServerContext</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00819">_ECHANNEL::ServerThread</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>01088                    :
01089 
01090     This function stores a context value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current associated
01091     message channel.
01092 
01093     N.B. This function can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be executed from a server thread that
01094         has an associated message channel.
01095 
01096 Arguments:
01097 
01098     Context - Supplies a context value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01099         associated message channel.
01100 
01101 Return Value:
01102 
01103     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> channel information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, then a success status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01104     Otherwise, a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01105 
01106 --*/
01107 
01108 {
01109 
01110 <span class="preprocessor">#if 0</span>
01111 <span class="preprocessor"></span>
01112     <a class="code" href="../../d9/d1/struct__ECHANNEL.html">PRECHANNEL</a> MessageChannel;
01113     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> CurrentThread;
01114     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01115 
01116     <span class="comment">//</span>
01117     <span class="comment">// If the thread has an assoicated channel and the server thread for</span>
01118     <span class="comment">// the channel is the current thread, then store the channel context.</span>
01119     <span class="comment">//</span>
01120 
01121     CurrentThread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
01122     MessageChannel = CurrentThread-&gt;Channel;
01123     <span class="keywordflow">if</span> ((MessageChannel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01124         (CurrentThread != MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o4">ServerThread</a>)) {
01125         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="comment">// ****** FIX *****</span>
01126 
01127     } <span class="keywordflow">else</span> {
01128         MessageChannel-&gt;<a class="code" href="../../d9/d1/struct__ECHANNEL.html#o5">ServerContext</a> = Context;
01129         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01130     }
01131 
01132     <span class="comment">//</span>
01133     <span class="comment">// Return service status.</span>
01134     <span class="comment">//</span>
01135 
01136     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01137 
01138 <span class="preprocessor">#else</span>
01139 <span class="preprocessor"></span>
01140     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
01141 
01142 <span class="preprocessor">#endif</span>
01143 <span class="preprocessor"></span>
01144 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="channel.c::KeChannelType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d4/d6/channel_8c.html#a0">KeChannelType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/channel_8c-source.html#l00068">68</a> of file <a class="el" href="../../d5/d5/channel_8c-source.html">channel.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/channel_8c-source.html#l00101">NtCreateChannel()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00236">NtListenChannel()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00348">NtOpenChannel()</a>, and <a class="el" href="../../d5/d5/channel_8c-source.html#l00807">NtSendWaitReplyChannel()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="channel.c::KiChannelMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d4/d6/channel_8c.html#a1">KiChannelMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ |
        CHANNEL_READ_MESSAGE,
    STANDARD_RIGHTS_WRITE |
        CHANNEL_WRITE_MESSAGE,
    STANDARD_RIGHTS_EXECUTE |
        SYNCHRONIZE,
    CHANNEL_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d5/d5/channel_8c-source.html#l00075">75</a> of file <a class="el" href="../../d5/d5/channel_8c-source.html">channel.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
