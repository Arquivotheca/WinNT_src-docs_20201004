<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtl/ia64/context.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c File Reference</h1><code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>
<code>#include "kxia64.h"</code><br>

<p>
<a href="../../d5/d5/rtl_2ia64_2context_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/rtl_2ia64_2context_8c.html#a0">RtlInitializeContext</a> (IN HANDLE Process, OUT PCONTEXT Context, IN PVOID Parameter OPTIONAL, IN PVOID InitialPc OPTIONAL, IN PVOID InitialSp OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/rtl_2ia64_2context_8c.html#a1">RtlRemoteCall</a> (HANDLE Process, HANDLE Thread, PVOID CallSite, ULONG ArgumentCount, PULONG_PTR Arguments, BOOLEAN PassContext, BOOLEAN AlreadySuspended)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a> (IN ULONG Dr7_RW, IN ULONG Dr7_Len, IN ULONG Addr, IN OUT ULONGLONG *DbrAddr1, IN OUT ULONGLONG *DbrAddr2, IN OUT ULONGLONG *IbrAddr1, IN OUT ULONGLONG *IbrAddr2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/rtl_2ia64_2context_8c.html#a3">RtlIaToEmDebugContext</a> (IN PCONTEXT86 ContextX86, IN OUT PCONTEXT ContextEM)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/rtl_2ia64_2context_8c.html#a4">RtlEmToIaDebugContext</a> (IN PCONTEXT ContextEM, IN OUT PCONTEXT86 ContextX86)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/rtl_2ia64_2context_8c.html#a5">RtlEmToX86Context</a> (IN PCONTEXT ContextEm, IN OUT PCONTEXT86 ContextX86)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/rtl_2ia64_2context_8c.html#a6">RtlX86ToEmContext</a> (IN PCONTEXT86 ContextX86, IN OUT PCONTEXT ContextEm)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="rtl/ia64/context.c::RtlEmToIaDebugContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlEmToIaDebugContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextEM</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT86&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextX86</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00525">525</a> of file <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html">rtl/ia64/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00597">RtlEmToX86Context()</a>.
<p>
<pre class="fragment"><div>00532                    :
00533 
00534     This function constructs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> iA mode <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> Register Context
00535     given EM mode debug Context as input.
00536 
00537 Arguments:
00538 
00539     ContextEM  - Supplies EM mode context buffer including EM mode debug registers.
00540 
00541     ContextX86 - Supplies a iA mode context buffer to be initialized by <span class="keyword">this</span> routine.
00542 
00543 Return Value:
00544 
00545 
00546     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>   - No context returned, based on input debugging <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not active.
00547     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>    - EM <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> Context returned.
00548 
00549     N.B. Assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's <span class="keyword">virtual</span> iA mode <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> Registers reflects
00550          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current debug context. The kernel must keep <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> field DebugIaDr6 and
00551          DebugIaDr7 up to date.
00552 
00553     TBD How <span class="keywordflow">do</span> we set DR6? From <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, what status? Probably should be set by exception
00554         handler.
00555 
00556 --*/
00557 
00558 {
00559     <span class="comment">//</span>
00560     <span class="comment">// Check to see if Debugging is enabled or disabled.</span>
00561     <span class="comment">//</span>
00562 
00563     <span class="comment">// Translate Dr0 from either DbD0-1 or DbI0-1</span>
00564     SET_DR7_L0(ContextX86-&gt;Dr7);
00565 
00566     SET_DR7_DB0_RW(ContextX86-&gt;Dr7, DBG_EM_ENABLE_TO_IA_RW(ContextEM-&gt;DbD1, ContextEM-&gt;DbI1));
00567     SET_DR7_DB0_LEN(ContextX86-&gt;Dr7, DBG_EM_MASK_TO_IA_LEN(ContextEM-&gt;DbD1, ContextEM-&gt;DbI1));
00568     ContextX86-&gt;Dr0 = DBG_EM_ADDR_TO_IA_ADDR(ContextEM-&gt;DbD0, ContextEM-&gt;DbI0);
00569 
00570     <span class="comment">// Translate Dr1 from either DbD2-3 or DbI2-3</span>
00571     SET_DR7_L1(ContextX86-&gt;Dr7);
00572     SET_DR7_DB1_RW(ContextX86-&gt;Dr7, DBG_EM_ENABLE_TO_IA_RW(ContextEM-&gt;DbD3, ContextEM-&gt;DbI3));
00573     SET_DR7_DB1_LEN(ContextX86-&gt;Dr7, DBG_EM_MASK_TO_IA_LEN(ContextEM-&gt;DbD3, ContextEM-&gt;DbI3));
00574     ContextX86-&gt;Dr1 = DBG_EM_ADDR_TO_IA_ADDR(ContextEM-&gt;DbD2, ContextEM-&gt;DbI2);
00575 
00576     <span class="comment">// Translate Dr2 from either DbD4-5 or DbI4-5</span>
00577     SET_DR7_L2(ContextX86-&gt;Dr7);
00578     SET_DR7_DB2_RW(ContextX86-&gt;Dr7, DBG_EM_ENABLE_TO_IA_RW(ContextEM-&gt;DbD5, ContextEM-&gt;DbI5));
00579     SET_DR7_DB2_LEN(ContextX86-&gt;Dr7, DBG_EM_MASK_TO_IA_LEN(ContextEM-&gt;DbD5, ContextEM-&gt;DbI5));
00580     ContextX86-&gt;Dr2 = DBG_EM_ADDR_TO_IA_ADDR(ContextEM-&gt;DbD4, ContextEM-&gt;DbI4);
00581 
00582     <span class="comment">// Translate Dr3 from either DbD6-7 or DbI6-7</span>
00583     SET_DR7_L3(ContextX86-&gt;Dr7);
00584     SET_DR7_DB3_RW(ContextX86-&gt;Dr7, DBG_EM_ENABLE_TO_IA_RW(ContextEM-&gt;DbD7, ContextEM-&gt;DbI7));
00585     SET_DR7_DB3_LEN(ContextX86-&gt;Dr7, DBG_EM_MASK_TO_IA_LEN(ContextEM-&gt;DbD7, ContextEM-&gt;DbI7));
00586     ContextX86-&gt;Dr3 = DBG_EM_ADDR_TO_IA_ADDR(ContextEM-&gt;DbD6, ContextEM-&gt;DbI6);
00587 
00588     <span class="keywordflow">if</span> (!(DR7_L0(ContextX86-&gt;Dr7) || DR7_L1(ContextX86-&gt;Dr7) 
00589             || DR7_L2(ContextX86-&gt;Dr7) || DR7_L3(ContextX86-&gt;Dr7)))
00590         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00591     <span class="keywordflow">else</span>
00592         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00593 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="rtl/ia64/context.c::RtlEmToX86Context" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlEmToX86Context           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextEm</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT86&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextX86</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00597">597</a> of file <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html">rtl/ia64/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, and <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00525">RtlEmToIaDebugContext()</a>.
<p>
<pre class="fragment"><div>00601 {
00602     ContextX86-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a> | CONTEXT_X86;
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// TBD: How to transfer the remaining floating point states from EM</span>
00606     <span class="comment">//      context record to the floating save area in iA context record.</span>
00607     <span class="comment">//</span>
00608 
00609     RtlEmFpToIaFpContext(&amp;ContextEm-&gt;FltT2, &amp;ContextX86-&gt;FloatSave);
00610     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a4">RtlEmToIaDebugContext</a>(ContextEm, ContextX86);
00611 
00612     ContextX86-&gt;SegGs = (ULONG)ContextEm-&gt;IntT20;
00613     ContextX86-&gt;SegFs = (ULONG)ContextEm-&gt;IntT19;
00614     ContextX86-&gt;SegEs = (ULONG)ContextEm-&gt;IntT15;
00615     ContextX86-&gt;SegDs = (ULONG)ContextEm-&gt;IntT18;
00616     ContextX86-&gt;Edi = (ULONG)ContextEm-&gt;IntT6;
00617     ContextX86-&gt;Esi = (ULONG)ContextEm-&gt;IntT5;
00618     ContextX86-&gt;Ebx = (ULONG)ContextEm-&gt;IntT4;
00619     ContextX86-&gt;Edx = (ULONG)ContextEm-&gt;IntT3;
00620     ContextX86-&gt;Ecx = (ULONG)ContextEm-&gt;IntT2;
00621     ContextX86-&gt;Eax = (ULONG)ContextEm-&gt;IntV0;
00622     ContextX86-&gt;Ebp = (ULONG)ContextEm-&gt;IntTeb;
00623     ContextX86-&gt;Eip = (ULONG)ContextEm-&gt;StIIP;
00624     ContextX86-&gt;SegCs = (ULONG)ContextEm-&gt;SegCSD;      <span class="comment">// ContextEm-&gt;IntT16;</span>
00625     ContextX86-&gt;EFlags = (ULONG)ContextEm-&gt;Eflag;
00626     ContextX86-&gt;Esp = (ULONG)ContextEm-&gt;IntSp;
00627     ContextX86-&gt;SegSs = (ULONG)ContextEm-&gt;SegSSD;      <span class="comment">// ContextEm-&gt;IntT17;</span>
00628 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="rtl/ia64/context.c::RtlIaToEmDebugContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlIaToEmDebugContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT86&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextX86</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextEM</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00443">443</a> of file <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html">rtl/ia64/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00357">RtlSetIaToEmDebugReg()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00632">RtlX86ToEmContext()</a>.
<p>
<pre class="fragment"><div>00450                    :
00451 
00452     This function constructs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EM mode <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> Register Context given iA mode
00453     debug Context as input. The EM debug <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> bits in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a> are set based
00454     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> iA mode context.
00455 
00456 Arguments:
00457 
00458     ContextX86 - Supplies iA mode context buffer including iA mode debug registers.
00459 
00460     ContextEM  - Supplies a EM mode context buffer to be initialized by <span class="keyword">this</span> routine.
00461 
00462 Return Value:
00463 
00464     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>   - No context returned, based on input debugging <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not active.
00465     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>    - EM <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> Context returned.
00466 
00467     N.B. Currently EM <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> Registers are <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> stored on a thread <span class="keywordflow">switch</span>. Activating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00468          EM debug context generated by <span class="keyword">this</span> routine requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EM debug registers to
00469          be loaded in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread.
00470 
00471 --*/
00472 
00473 {
00474     ULONG Dr7 = ContextX86-&gt;Dr7;
00475 
00476     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(DR7_DB0_RW(Dr7), 
00477                          DR7_DB0_LEN(Dr7), 
00478                          DR_ADDR_L0(ContextX86-&gt;Dr0),
00479                          &amp;ContextEM-&gt;DbD0, 
00480                          &amp;ContextEM-&gt;DbD1, 
00481                          &amp;ContextEM-&gt;DbI0, 
00482                          &amp;ContextEM-&gt;DbI1);
00483 
00484     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(DR7_DB1_RW(Dr7), 
00485                          DR7_DB1_LEN(Dr7), 
00486                          DR_ADDR_L1(ContextX86-&gt;Dr1),
00487                          &amp;ContextEM-&gt;DbD2, 
00488                          &amp;ContextEM-&gt;DbD3, 
00489                          &amp;ContextEM-&gt;DbI2, 
00490                          &amp;ContextEM-&gt;DbI3);
00491 
00492     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(DR7_DB2_RW(Dr7), 
00493                          DR7_DB2_LEN(Dr7), 
00494                          DR_ADDR_L2(ContextX86-&gt;Dr2),
00495                          &amp;ContextEM-&gt;DbD4, 
00496                          &amp;ContextEM-&gt;DbD5, 
00497                          &amp;ContextEM-&gt;DbI4, 
00498                          &amp;ContextEM-&gt;DbI5);
00499 
00500     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a2">RtlSetIaToEmDebugReg</a>(DR7_DB3_RW(Dr7), 
00501                          DR7_DB3_LEN(Dr7), 
00502                          DR_ADDR_L3(ContextX86-&gt;Dr3),
00503                          &amp;ContextEM-&gt;DbD6, 
00504                          &amp;ContextEM-&gt;DbD7, 
00505                          &amp;ContextEM-&gt;DbI6, 
00506                          &amp;ContextEM-&gt;DbI7);
00507 
00508     <span class="comment">//</span>
00509     <span class="comment">// Check to see if Debugging is enabled or disabled.</span>
00510     <span class="comment">//</span>
00511     <span class="keywordflow">if</span> (DR7_L0(Dr7) || DR7_L1(Dr7) || DR7_L2(Dr7) || DR7_L3(Dr7))
00512     {
00513         ContextEM-&gt;StIPSR &amp;= ~(PSR_DEBUG_SET);
00514         ContextEM-&gt;StIPSR |=  (1 &lt;&lt; PSR_DB);
00515     } <span class="keywordflow">else</span> {
00516         ContextEM-&gt;StIPSR &amp;= ~(PSR_DEBUG_SET);
00517         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00518     }
00519 
00520     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00521 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="rtl/ia64/context.c::RtlInitializeContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlInitializeContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Parameter&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InitialPc&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InitialSp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00038">38</a> of file <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html">rtl/ia64/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>.
<p>
<pre class="fragment"><div>00048                    :
00049 
00050     This function initializes a context structure so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can
00051     be used in a subsequent call to <a class="code" href="../../d2/d8/ps_2create_8c.html#a10">NtCreateThread</a>.
00052 
00053 Arguments:
00054 
00055     Context - Supplies a context buffer to be initialized by <span class="keyword">this</span> routine.
00056 
00057     InitialPc - Supplies an initial program counter value.
00058 
00059     InitialSp - Supplies an initial stack pointer value.
00060 
00061 Return Value:
00062 
00063     Raises STATUS_BAD_INITIAL_STACK <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of InitialSp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly
00064            aligned.
00065 
00066     Raises STATUS_BAD_INITIAL_PC <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of InitialPc <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly
00067            aligned.
00068 
00069 --*/
00070 
00071 {
00072     ULONGLONG Argument;
00073 
00074     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00075 
00076     <span class="comment">//</span>
00077     <span class="comment">// Check for proper initial stack (0 mod 16).</span>
00078     <span class="comment">//</span>
00079 
00080     <span class="keywordflow">if</span> (((ULONG_PTR)InitialSp &amp; 0xf) != 0) {
00081         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_STACK);
00082     }
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">// Check for proper plabel address alignment.</span>
00086     <span class="comment">// Assumes InitialPc points to a plabel that must be 8-byte aligned.</span>
00087     <span class="comment">//</span>
00088 
00089     <span class="keywordflow">if</span> (((ULONG_PTR)InitialPc &amp; 0x7) != 0) {
00090         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_PC);
00091     }
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Initialize the integer and floating registers to contain zeroes.</span>
00095     <span class="comment">//</span>
00096 
00097     RtlZeroMemory(Context, <span class="keyword">sizeof</span>(CONTEXT));
00098 
00099     <span class="comment">//</span>
00100     <span class="comment">// Setup integer and control context.</span>
00101     <span class="comment">//</span>
00102 
00103     Context-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a> | <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>;
00104 
00105     Context-&gt;RsBSPSTORE = Context-&gt;IntSp = (ULONG_PTR)InitialSp;
00106     Context-&gt;IntSp -= STACK_SCRATCH_AREA;
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// InitialPc is the module entry point which is a function pointer</span>
00110     <span class="comment">// in IA64. StIIP and IntGp are initiailized with actual IP and GP</span>
00111     <span class="comment">// from the plabel in LdrInitializeThunk after the loader runs.</span>
00112     <span class="comment">//</span>
00113 
00114     Context-&gt;IntS0 = Context-&gt;StIIP = (ULONG_PTR)InitialPc;
00115     Context-&gt;IntGp = 0;
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">// Setup FPSR, PSR, and DCR</span>
00119     <span class="comment">// N.B. Values to be determined.</span>
00120     <span class="comment">//</span>
00121 
00122     Context-&gt;StFPSR = USER_FPSR_INITIAL;
00123     Context-&gt;StIPSR = USER_PSR_INITIAL;
00124     Context-&gt;ApDCR = USER_DCR_INITIAL;
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">// Set the initial context of the thread in a machine specific way.</span>
00128     <span class="comment">// ie, pass the initial parameter to the RSE by saving it at the</span>
00129     <span class="comment">// bottom of the backing store.</span>
00130     <span class="comment">//</span>
00131     <span class="comment">//  Setup Frame Marker after RFI</span>
00132     <span class="comment">//  And other RSE states.</span>
00133     <span class="comment">//</span>
00134 
00135     Argument = (ULONGLONG)Parameter;
00136     ZwWriteVirtualMemory(Process,
00137              (PVOID)((ULONG_PTR)Context-&gt;RsBSPSTORE),
00138              (PVOID)&amp;Argument,
00139              <span class="keyword">sizeof</span>(Argument),
00140              NULL);
00141 <span class="comment">//</span>
00142 <span class="comment">// N.b. The IFS must be reinitialized in LdrInitializeThunk</span>
00143 <span class="comment">//</span>
00144 
00145     Context-&gt;StIFS = 0x8000000000000081ULL;            <span class="comment">// Valid, 1 local register, 0 output register</span>
00146     Context-&gt;RsBSP = Context-&gt;RsBSPSTORE;
00147     Context-&gt;RsRSC = USER_RSC_INITIAL;
00148     Context-&gt;ApUNAT = 0xFFFFFFFFFFFFFFFF;
00149 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="rtl/ia64/context.c::RtlRemoteCall" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlRemoteCall           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallSite</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ArgumentCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Arguments</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PassContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadySuspended</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00153">153</a> of file <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html">rtl/ia64/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00033">NtSuspendThread()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>00165                    :
00166 
00167     This function calls a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> in another thread/process, <span class="keyword">using</span>
00168     NtGetContext and NtSetContext.  Parameters are passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00169     target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> via its stack.
00170 
00171 Arguments:
00172 
00173     Process - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process
00174 
00175     Thread - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread within that process
00176 
00177     CallSite - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to call in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process.
00178 
00179     ArgumentCount - Number of parameters to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00180                     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>.
00181 
00182     Arguments - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array of parameters to pass.
00183 
00184     PassContext - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> an additional parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be passed that
00185         points to a context record.
00186 
00187     AlreadySuspended - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in a suspended
00188                        or waiting state.
00189 
00190 Return Value:
00191 
00192     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value
00193 
00194 --*/
00195 
00196 {
00197     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198     CONTEXT Context;
00199     ULONG_PTR ContextAddress;
00200     ULONG_PTR NewSp;
00201     ULONG_PTR NewBspStore;
00202     ULONGLONG ArgumentsCopy[10];
00203     PVOID ptr;
00204     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00205     ULONG ShiftCount;
00206     BOOLEAN RnatSaved = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00207 
00208 
00209     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00210 
00211     <span class="keywordflow">if</span> (ArgumentCount &gt; 8)
00212         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// If necessary, suspend the guy before with we mess with his stack.</span>
00216     <span class="comment">//</span>
00217 
00218     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00219         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>(Thread, NULL);
00220         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00221             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00222         }
00223     }
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">// Get the context record of the target thread.</span>
00227     <span class="comment">//</span>
00228 
00229     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00230     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>(Thread, &amp;Context);
00231     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00232         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00233             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00234         }
00235         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00236     }
00237 
00238     <span class="keywordflow">if</span> (AlreadySuspended) {
00239         Context.IntV0 = STATUS_ALERTED;
00240     }
00241 
00242     <span class="comment">//</span>
00243     <span class="comment">// Pass the parameters to the other thread via the backing store (r32-r39).</span>
00244     <span class="comment">// The context record is passed on the stack of the target thread.</span>
00245     <span class="comment">// N.B. Align the context record address, stack pointer, and allocate</span>
00246     <span class="comment">//      stack scratch area.</span>
00247     <span class="comment">//</span>
00248 
00249     ContextAddress = (((ULONG_PTR)Context.IntSp + 0xf) &amp; 0xf) - <span class="keyword">sizeof</span>(CONTEXT);
00250     NewSp = ContextAddress - STACK_SCRATCH_AREA;
00251     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process, (PVOID)ContextAddress, &amp;Context,
00252                   <span class="keyword">sizeof</span>(CONTEXT), NULL);
00253 
00254     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00255         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00256             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00257         }
00258         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00259     }
00260 
00261     RtlZeroMemory((PVOID)ArgumentsCopy, <span class="keyword">sizeof</span>(ArgumentsCopy));
00262     NewBspStore = (ULONG_PTR) Context.RsBSPSTORE;
00263 
00264     <span class="keywordflow">if</span> (PassContext) {
00265         <span class="keywordflow">if</span> ( (NewBspStore &amp; 0x1F8) == 0x1F8 ) {
00266             ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = Context.RsRNAT;
00267             NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00268             RnatSaved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00269         }
00270         ShiftCount = (ULONG) (NewBspStore &amp; 0x1F8) &gt;&gt; 3;
00271         Context.RsRNAT &amp;= ~(0x1 &lt;&lt; ShiftCount);
00272         ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = ContextAddress;
00273         NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00274     }
00275 
00276     <span class="keywordflow">for</span> (; ArgumentCount != 0 ; ArgumentCount--) {
00277         <span class="keywordflow">if</span> ( (RnatSaved == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; ((NewBspStore &amp; 0x1F8) == 0x1F8) ) {
00278             ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = Context.RsRNAT;
00279             NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00280             RnatSaved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00281         }
00282         ShiftCount = (ULONG)(NewBspStore &amp; 0x1F8) &gt;&gt; 3;
00283         Context.RsRNAT &amp;= ~(0x1 &lt;&lt; ShiftCount);
00284         ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = (ULONGLONG)(*Arguments++);
00285         NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00286     }
00287 
00288     <span class="keywordflow">if</span> ( (RnatSaved == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; ((NewBspStore &amp; 0x1F8) == 0x1F8) ) {
00289         ArgumentsCopy[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++] = Context.RsRNAT;
00290         NewBspStore += <span class="keyword">sizeof</span>(ULONGLONG);
00291     }
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">//  Copy the arguments onto the target backing store.</span>
00295     <span class="comment">//</span>
00296 
00297     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>) {
00298         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process,
00299                                       (PVOID)Context.RsBSPSTORE,
00300                                       ArgumentsCopy,
00301                                       Count * <span class="keyword">sizeof</span>(ULONGLONG),
00302                                       NULL
00303                                       );
00304 
00305         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00306             <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00307                 <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00308             }
00309             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00310         }
00311     }
00312 
00313     <span class="comment">//</span>
00314     <span class="comment">// zero out loadrs, adjust RseStack</span>
00315     <span class="comment">//</span>
00316 
00317     Context.RsRSC = (RSC_MODE_LY&lt;&lt;RSC_MODE)
00318                    | (RSC_BE_LITTLE&lt;&lt;RSC_BE)
00319                    | (0x3&lt;&lt;RSC_PL);
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">//  Setup argument numbers</span>
00323     <span class="comment">//</span>
00324 
00325     Context.StIFS = (ULONGLONG)<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;       <span class="comment">// # of arguments/size of frame</span>
00326     Context.RsBSP = Context.RsBSPSTORE;
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Set the address of the target code into IIP, the new target stack</span>
00330     <span class="comment">// into sp, setup ap, and reload context to make it happen.</span>
00331     <span class="comment">//</span>
00332 
00333     Context.IntSp = (ULONG_PTR)NewSp;
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">// We expect NtSetContext to get the real IP and GP for us</span>
00337     <span class="comment">//</span>
00338 
00339     Context.StIIP = (ULONG_PTR)CallSite;
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">// sanitize the floating pointer status register</span>
00343     <span class="comment">//</span>
00344 
00345     SANITIZE_FSR(Context.StFPSR, UserMode);
00346 
00347     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>(Thread, &amp;Context);
00348     <span class="keywordflow">if</span> (!AlreadySuspended) {
00349         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00350     }
00351 
00352     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00353 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="rtl/ia64/context.c::RtlSetIaToEmDebugReg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlSetIaToEmDebugReg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Dr7_RW</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Dr7_Len</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Addr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>DbrAddr1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>DbrAddr2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>IbrAddr1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONGLONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>IbrAddr2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00357">357</a> of file <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html">rtl/ia64/context.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00443">RtlIaToEmDebugContext()</a>.
<p>
<pre class="fragment"><div>00369                    :
00370 
00371     This function constructs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EM mode <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> Register Context
00372     given iA mode debug Context as input.
00373 
00374 Arguments:
00375 
00376     Dr7_RW     - Supplies iA mode context buffer including iA mode debug registers.
00377 
00378     Dr7_Len    - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> iA mode CR4.
00379 
00380     Addr       - Supplies a context buffer to be initialized by <span class="keyword">this</span> routine.
00381 
00382     DbrAddr1   - Address of first associated data        breakpoint <span class="keyword">register</span> in set.
00383 
00384     IbrAddr1   - Address of first associated instruction breakpoint <span class="keyword">register</span> in set.
00385 
00386 Return Value:
00387 
00388     None.
00389 
00390     N.B. Currently EM <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> Registers are <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> stored on a thread <span class="keywordflow">switch</span>. Activating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00391          EM debug context generated by <span class="keyword">this</span> routine requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EM debug registers to
00392          be loaded in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread.
00393 
00394 --*/
00395 
00396 {
00397     ULONGLONG  mask;
00398 
00399     <span class="comment">// If length is undefined value, set it to zero.</span>
00400     <span class="keywordflow">if</span> (Dr7_Len == 2)
00401         Dr7_Len = 0;
00402 
00403     mask = (ULONGLONG) DBG_REG_MASK(Dr7_Len);
00404 
00405     <span class="keywordflow">switch</span>(Dr7_RW) {
00406         <span class="keywordflow">case</span> DR7_RW_IX:
00407             *DbrAddr1 = 0;
00408             *IbrAddr1 = (ULONGLONG)Addr;
00409             *DbrAddr2 = 0;
00410             *IbrAddr2 = (IBR_EX | DBG_REG_PLM_USER | DBG_REG_MASK(0));
00411             <span class="keywordflow">break</span>;
00412         <span class="keywordflow">case</span> DR7_RW_DW:
00413             *DbrAddr1 = (ULONGLONG)Addr;
00414             *IbrAddr1 = 0;
00415             *DbrAddr2 = (DBR_WR | DBG_REG_PLM_USER | mask);
00416             *IbrAddr2 = 0;
00417             <span class="keywordflow">break</span>;
00418         <span class="keywordflow">case</span> DR7_RW_IORW:
00419             *DbrAddr1 = (ULONGLONG)Addr;
00420             *IbrAddr1 = 0;
00421             *DbrAddr2 = (DBR_RDWR | DBG_REG_PLM_USER | mask);
00422             *IbrAddr2 = 0;
00423             <span class="keywordflow">break</span>;
00424         <span class="keywordflow">case</span> DR7_RW_DWR:
00425             *DbrAddr1 = (ULONGLONG)Addr;
00426             *IbrAddr1 = 0;
00427             *DbrAddr2 = (DBR_RDWR | DBG_REG_PLM_USER | mask);
00428             *IbrAddr2 = 0;
00429             <span class="keywordflow">break</span>;
00430         <span class="keywordflow">case</span> DR7_RW_DISABLE:
00431         <span class="keywordflow">default</span>:
00432             *DbrAddr1 = 0;
00433             *IbrAddr1 = 0;
00434             *DbrAddr2 = 0;
00435             *IbrAddr2 = 0;
00436     }
00437 
00438     <span class="keywordflow">return</span>;
00439 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="rtl/ia64/context.c::RtlX86ToEmContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlX86ToEmContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT86&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextX86</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextEm</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00632">632</a> of file <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html">rtl/ia64/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, and <a class="el" href="../../d5/d5/rtl_2ia64_2context_8c-source.html#l00443">RtlIaToEmDebugContext()</a>.
<p>
<pre class="fragment"><div>00636 {
00637     FLOAT128 FpWorkArea;
00638 
00639     ContextEm-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a> | CONTEXT_IA64;
00640 
00641     RtlIaFpToEmFpContext((PVOID)&amp;ContextX86-&gt;FloatSave,
00642                          &amp;ContextEm-&gt;FltT2,
00643                          &amp;FpWorkArea);
00644     <a class="code" href="../../d4/d6/rtl_2ia64_2context_8c.html#a3">RtlIaToEmDebugContext</a>(ContextX86, ContextEm);
00645 
00646     ContextEm-&gt;IntT20 = ContextX86-&gt;SegGs;
00647     ContextEm-&gt;IntT19 = ContextX86-&gt;SegFs;
00648     ContextEm-&gt;IntT15 = ContextX86-&gt;SegEs;
00649     ContextEm-&gt;IntT18 = ContextX86-&gt;SegDs;
00650     ContextEm-&gt;IntT6 = ContextX86-&gt;Edi;
00651     ContextEm-&gt;IntT5 = ContextX86-&gt;Esi;
00652     ContextEm-&gt;IntT4 = ContextX86-&gt;Ebx;
00653     ContextEm-&gt;IntT3 = ContextX86-&gt;Edx;
00654     ContextEm-&gt;IntT2 = ContextX86-&gt;Ecx;
00655     ContextEm-&gt;IntV0 = ContextX86-&gt;Eax;
00656     ContextEm-&gt;IntTeb = ContextX86-&gt;Ebp;
00657     ContextEm-&gt;StIIP = ContextX86-&gt;Eip;
00658     ContextEm-&gt;SegCSD = ContextX86-&gt;SegCs;
00659     ContextEm-&gt;Eflag = ContextX86-&gt;EFlags;
00660     ContextEm-&gt;IntSp = ContextX86-&gt;Esp;
00661     ContextEm-&gt;SegSSD = ContextX86-&gt;SegSs;
00662 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
