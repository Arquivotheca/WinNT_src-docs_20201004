<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: netboot.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>netboot.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>
<code>#include &lt;ntddip.h&gt;</code><br>
<code>#include &lt;nbtioctl.h&gt;</code><br>
<code>#include &lt;ntddnfs.h&gt;</code><br>
<code>#include &lt;ntddbrow.h&gt;</code><br>
<code>#include &lt;ntddtcp.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d4/d7/setupblk_8h-source.html">setupblk.h</a>&gt;</code><br>
<code>#include &lt;remboot.h&gt;</code><br>
<code>#include &lt;oscpkt.h&gt;</code><br>
<code>#include &lt;windef.h&gt;</code><br>
<code>#include &lt;tdiinfo.h&gt;</code><br>
<code>#include &lt;ipinfo.h&gt;</code><br>

<p>
<a href="../../d5/d5/netboot_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a0">DEFAULT_DEST</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a1">DEFAULT_DEST_MASK</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a2">DEFAULT_METRIC</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a> (HANDLE handle, PWCHAR regkey, PUCHAR value)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a5">IopTCPQueryInformationEx</a> (IN HANDLE TCPHandle, IN TDIObjectID FAR *ID, OUT void FAR *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN OUT <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> FAR *<a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN OUT <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> FAR *Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a6">IopTCPSetInformationEx</a> (IN HANDLE TCPHandle, IN TDIObjectID FAR *ID, IN void FAR *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> FAR <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a7">IopSetDefaultGateway</a> (IN ULONG GatewayAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a8">IopCacheNetbiosNameForIpAddress</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a9">IopAssignNetworkDriveLetter</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a10">IopAddRemoteBootValuesToRegistry</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a11">IopStartNetworkForRemoteBoot</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a12">IopAssignNetworkDriveLetter</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a13">IopStartTcpIpForRemoteBoot</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a14">IopIsRemoteBootCard</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN PWCHAR HwIds)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a15">IopSetupRemoteBootCard</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN HANDLE UniqueIdHandle, IN PUNICODE_STRING UnicodeDeviceInstance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>__inline long&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a16">htonl</a> (long x)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/netboot_8c.html#a3">ExpInTextModeSetup</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="netboot.c::DEFAULT_DEST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_DEST&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l00059">59</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="netboot.c::DEFAULT_DEST_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_DEST_MASK&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l00060">60</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="netboot.c::DEFAULT_METRIC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_METRIC&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l00061">61</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="netboot.c::htonl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> __inline long htonl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">long&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>x</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l04238">4238</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l04247">IopCacheNetbiosNameForIpAddress()</a>.
<p>
<pre class="fragment"><div>04239 {
04240         <span class="keywordflow">return</span>((((x) &gt;&gt; 24) &amp; 0x000000FF<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) |
04241            (((x) &gt;&gt;  8) &amp; 0x0000FF00<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) |
04242            (((x) &lt;&lt;  8) &amp; 0x00FF0000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) |
04243            (((x) &lt;&lt; 24) &amp; 0xFF000000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
04244 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="netboot.c::IopAddRemoteBootValuesToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAddRemoteBootValuesToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">314</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d2/d8/arc_8h-source.html#l01854">_LOADER_PARAMETER_BLOCK::ArcBootDeviceName</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00449">_SETUP_LOADER_BLOCK::ComputerName</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00453">_SETUP_LOADER_BLOCK::DefaultRouter</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00511">_SETUP_LOADER_BLOCK::Flags</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l03974">IopWriteIpAddressToRegistry()</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00450">_SETUP_LOADER_BLOCK::IpAddress</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00543">_SETUP_LOADER_BLOCK::MachineDirectoryPath</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00471">_SETUP_LOADER_BLOCK::NetbootCardDriverName</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00477">_SETUP_LOADER_BLOCK::NetbootCardServiceName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01856">_LOADER_PARAMETER_BLOCK::NtBootPathName</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l02519">RtlDnsHostNameToComputerName()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00514">SETUPBLK_FLAGS_IS_TEXTMODE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01862">_LOADER_PARAMETER_BLOCK::SetupLoaderBlock</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00451">_SETUP_LOADER_BLOCK::SubnetMask</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00317 {
00318     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00319     HANDLE handle;
00320     HANDLE serviceHandle;
00321     OBJECT_ATTRIBUTES objectAttributes;
00322     UNICODE_STRING string;
00323     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> addressA[16];
00324     WCHAR addressW[16];
00325     STRING addressStringA;
00326     UNICODE_STRING addressStringW;
00327     PUCHAR addressPointer;
00328     PUCHAR p;
00329     PUCHAR q;
00330     UCHAR ntName[128];
00331     WCHAR imagePath[128];
00332     STRING ansiString;
00333     UNICODE_STRING unicodeString;
00334     UNICODE_STRING dnsNameString;
00335     UNICODE_STRING netbiosNameString;
00336     ULONG tmpValue;
00337 
00338     <span class="keywordflow">if</span> (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>[0] != 0) {
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// Convert the name to a Netbios name.</span>
00342         <span class="comment">//</span>
00343 
00344         _wcsupr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00345 
00346         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;dnsNameString, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00347 
00348         status = <a class="code" href="../../d6/d6/nls_8c.html#a51">RtlDnsHostNameToComputerName</a>(
00349                      &amp;netbiosNameString,
00350                      &amp;dnsNameString,
00351                      TRUE);            <span class="comment">// allocate netbiosNameString</span>
00352 
00353         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00354             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Failed RtlDnsHostNameToComputerName: %x\n"</span>, status ));
00355             <span class="keywordflow">goto</span> cleanup;
00356         }
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// Add a value for the computername.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\ComputerName"</span> );
00363 
00364         InitializeObjectAttributes(
00365             &amp;objectAttributes,
00366             &amp;string,
00367             OBJ_CASE_INSENSITIVE,
00368             NULL,
00369             NULL
00370             );
00371 
00372         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00373         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00374             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open ComputerName key: %x\n"</span>, status ));
00375             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;netbiosNameString );
00376             <span class="keywordflow">goto</span> cleanup;
00377         }
00378 
00379         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"ComputerName"</span> );
00380 
00381         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00382                     handle,
00383                     &amp;string,
00384                     0,
00385                     REG_SZ,
00386                     netbiosNameString.Buffer,
00387                     netbiosNameString.Length + <span class="keyword">sizeof</span>(WCHAR)
00388                     );
00389         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00390         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;netbiosNameString );
00391 
00392         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00393             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set ComputerName value: %x\n"</span>, status ));
00394             <span class="keywordflow">goto</span> cleanup;
00395         }
00396 
00397         <span class="comment">//</span>
00398         <span class="comment">// Add a value for the host name.</span>
00399         <span class="comment">//</span>
00400 
00401         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters"</span> );
00402 
00403         InitializeObjectAttributes(
00404             &amp;objectAttributes,
00405             &amp;string,
00406             OBJ_CASE_INSENSITIVE,
00407             NULL,
00408             NULL
00409             );
00410 
00411         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00412         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00413             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Tcpip\\Parameters key: %x\n"</span>, status ));
00414             <span class="keywordflow">goto</span> cleanup;
00415         }
00416 
00417         _wcslwr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a> );
00418 
00419         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"Hostname"</span> );
00420 
00421         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00422                     handle,
00423                     &amp;string,
00424                     0,
00425                     REG_SZ,
00426                     LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>,
00427                     (wcslen(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o20">ComputerName</a>) + 1) * <span class="keyword">sizeof</span>(WCHAR)
00428                     );
00429         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00430         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00431             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set Hostname value: %x\n"</span>, status ));
00432             <span class="keywordflow">goto</span> cleanup;
00433         }
00434     }
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">//  If the UNC path to the system files is supplied then store it in the registry.</span>
00438     <span class="comment">//</span>
00439 
00440     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( _stricmp(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o10">ArcBootDeviceName</a>,<span class="stringliteral">"net(0)"</span>) == 0 );
00441 
00442     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control"</span> );
00443 
00444     InitializeObjectAttributes(
00445         &amp;objectAttributes,
00446         &amp;string,
00447         OBJ_CASE_INSENSITIVE,
00448         NULL,
00449         NULL
00450         );
00451 
00452     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00453     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00454         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Control key: %x\n"</span>, status ));
00455         <span class="keywordflow">goto</span> skiproot;
00456     }
00457 
00458     p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
00459     <span class="keywordflow">if</span> ( (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (*(p+1) == 0) ) {
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// NtBootPathName ends with a backslash, so we need to back up</span>
00463         <span class="comment">// to the previous backslash.</span>
00464         <span class="comment">//</span>
00465 
00466         q = p;
00467         *q = 0;
00468         p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
00469         *q = <span class="charliteral">'\\'</span>;
00470     }
00471     <span class="keywordflow">if</span> ( p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00472         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: malformed NtBootPathName: %s\n"</span>, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> ));
00473         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00474         <span class="keywordflow">goto</span> skiproot;
00475     }
00476     *p = 0;                                 <span class="comment">// terminate \server\share\images\machine</span>
00477 
00478 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00479 <span class="preprocessor"></span>    <span class="comment">//</span>
00480     <span class="comment">// Store the server path in the shared user data area. Note that we need</span>
00481     <span class="comment">// to add an extra \ at the beginning of this path to make it a UNC name.</span>
00482     <span class="comment">//</span>
00483 
00484     SharedUserData-&gt;RemoteBootServerPath[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
00485     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> );
00486     unicodeString.MaximumLength = <span class="keyword">sizeof</span>(SharedUserData-&gt;RemoteBootServerPath) - (2 * <span class="keyword">sizeof</span>(WCHAR));
00487     unicodeString.Buffer = &amp;SharedUserData-&gt;RemoteBootServerPath[1];
00488     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, FALSE );
00489     SharedUserData-&gt;RemoteBootServerPath[1 + (unicodeString.Length/<span class="keyword">sizeof</span>(WCHAR))] = 0;
00490 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00491 <span class="preprocessor"></span>
00492     strcpy( ntName, <span class="stringliteral">"\\Device\\LanmanRedirector"</span>);
00493     strcat( ntName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> );  <span class="comment">// append \server\share\images\machine</span>
00494     *p = <span class="charliteral">'\\'</span>;
00495 
00496     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, ntName );
00497     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, TRUE );
00498 
00499     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"RemoteBootRoot"</span> );
00500 
00501     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00502                 handle,
00503                 &amp;string,
00504                 0,
00505                 REG_SZ,
00506                 unicodeString.Buffer,
00507                 unicodeString.Length + <span class="keyword">sizeof</span>(WCHAR)
00508                 );
00509 
00510     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;unicodeString );
00511     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00512         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set RemoteBootRoot value: %x\n"</span>, status ));
00513     }
00514 
00515     <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) != 0) {
00516 
00517         strcpy( ntName, <span class="stringliteral">"\\Device\\LanmanRedirector"</span>);
00518         strcat( ntName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o34">MachineDirectoryPath</a> );
00519         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, ntName );
00520         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, TRUE );
00521 
00522         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"RemoteBootMachineDirectory"</span> );
00523 
00524         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00525                     handle,
00526                     &amp;string,
00527                     0,
00528                     REG_SZ,
00529                     unicodeString.Buffer,
00530                     unicodeString.Length + <span class="keyword">sizeof</span>(WCHAR)
00531                     );
00532 
00533         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;unicodeString );
00534         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00535             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set RemoteBootMachineDirectory value: %x\n"</span>, status ));
00536         }
00537     }
00538 
00539     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00540 
00541 skiproot:
00542 
00543 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00544 <span class="preprocessor"></span>    StartCsc = INIT_CSC;
00545     IopSetFlushCSC(READ_CSC);
00546 
00547     <span class="keywordflow">if</span> ( (StartCsc != FLUSH_CSC) &amp;&amp;
00548          ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_REPIN) != 0) ) {
00549         StartCsc = FLUSH_CSC;
00550         IopSetFlushCSC(SET_FLUSH_CSC);
00551     }
00552 
00553 <span class="preprocessor">#if 0</span>
00554 <span class="preprocessor"></span>    <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows\\CSCSettings"</span> );
00555 
00556     InitializeObjectAttributes(
00557         &amp;objectAttributes,
00558         &amp;string,
00559         OBJ_CASE_INSENSITIVE,
00560         NULL,
00561         NULL
00562         );
00563 
00564     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00565 
00566     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00567 
00568         PKEY_VALUE_PARTIAL_INFORMATION keyValue;
00569         UCHAR buffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)];
00570         ULONG length;
00571         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> disabled;
00572 
00573 <span class="preprocessor">#define ONE_BOOT 2</span>
00574 <span class="preprocessor"></span>
00575         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"DisableAgent"</span> );
00576 
00577         <span class="keywordflow">if</span> ( (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISABLE_CSC) == 0 ) {
00578 
00579             <span class="comment">//</span>
00580             <span class="comment">// Disable CSC for this boot.</span>
00581             <span class="comment">//</span>
00582 
00583             disabled = ONE_BOOT;
00584             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00585                         handle,
00586                         &amp;string,
00587                         0,
00588                         REG_DWORD,
00589                         &amp;disabled,
00590                         <span class="keyword">sizeof</span>(DWORD));
00591 
00592         } <span class="keywordflow">else</span> {
00593 
00594             keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
00595             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00596                          handle,
00597                          &amp;string,
00598                          KeyValuePartialInformation,
00599                          keyValue,
00600                          <span class="keyword">sizeof</span>(buffer),
00601                          &amp;length);
00602             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00603                 disabled = *((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(&amp;keyValue-&gt;Data[0]));
00604 
00605                 <span class="keywordflow">if</span> (disabled == ONE_BOOT) {
00606                     <span class="comment">//  Only disabled for last boot so re-enable now.</span>
00607                     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>( handle, &amp;string);
00608                     <span class="comment">//  BUGBUG should we repin?</span>
00609                 }
00610             }
00611         }
00612 
00613         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
00614         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00615             KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to set CSCSettings: %x\n"</span>, status ));
00616             <span class="keywordflow">goto</span> cleanup;
00617         }
00618     }
00619 <span class="preprocessor">#endif</span>
00620 <span class="preprocessor"></span><span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00621 <span class="preprocessor"></span>
00622     <span class="comment">//</span>
00623     <span class="comment">// Add registry values for the IP address and subnet mask received</span>
00624     <span class="comment">// from DHCP. These are stored under the Tcpip service key and are</span>
00625     <span class="comment">// read by both Tcpip and Netbt. The adapter name used is the known</span>
00626     <span class="comment">// GUID for the NetbootCard.</span>
00627     <span class="comment">//</span>
00628 
00629     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\Interfaces\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E}"</span> );
00630 
00631     InitializeObjectAttributes(
00632         &amp;objectAttributes,
00633         &amp;string,
00634         OBJ_CASE_INSENSITIVE,
00635         NULL,
00636         NULL
00637         );
00638 
00639     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;handle, KEY_ALL_ACCESS, &amp;objectAttributes );
00640     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00641         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open Tcpip\\Parameters\\Interfaces\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E} key: %x\n"</span>, status ));
00642         <span class="keywordflow">goto</span> cleanup;
00643     }
00644 
00645     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00646                                          L<span class="stringliteral">"DhcpIPAddress"</span>,
00647                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o21">IpAddress</a>)
00648                                         );
00649 
00650     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00651         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00652         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpIPAddress: %x\n"</span>, status ));
00653         <span class="keywordflow">goto</span> cleanup;
00654     }
00655 
00656     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00657                                          L<span class="stringliteral">"DhcpSubnetMask"</span>,
00658                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o22">SubnetMask</a>)
00659                                         );
00660 
00661     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00662         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00663         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpSubnetMask: %x\n"</span>, status ));
00664         <span class="keywordflow">goto</span> cleanup;
00665     }
00666 
00667     status = <a class="code" href="../../d4/d6/netboot_8c.html#a4">IopWriteIpAddressToRegistry</a>(handle,
00668                                          L<span class="stringliteral">"DhcpDefaultGateway"</span>,
00669                                          (PUCHAR)&amp;(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o24">DefaultRouter</a>)
00670                                         );
00671 
00672     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00673 
00674     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00675         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write DhcpDefaultGateway: %x\n"</span>, status ));
00676         <span class="keywordflow">goto</span> cleanup;
00677     }
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Create the service key for the netboot card. We need to have</span>
00681     <span class="comment">// the Type value there or the card won't be initialized.</span>
00682     <span class="comment">//</span>
00683 
00684     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
00685                                 NULL,
00686                                 &amp;CmRegistryMachineSystemCurrentControlSetServices,
00687                                 KEY_ALL_ACCESS,
00688                                 FALSE
00689                                 );
00690 
00691     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00692         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open CurrentControlSet\\Services: %x\n"</span>, status ));
00693         <span class="keywordflow">goto</span> cleanup;
00694     }
00695 
00696     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;string, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o28">NetbootCardServiceName</a>);
00697 
00698     InitializeObjectAttributes(&amp;objectAttributes,
00699                                &amp;string,
00700                                OBJ_CASE_INSENSITIVE,
00701                                handle,
00702                                (PSECURITY_DESCRIPTOR)NULL
00703                                );
00704 
00705     status = ZwCreateKey(&amp;serviceHandle,
00706                          KEY_ALL_ACCESS,
00707                          &amp;objectAttributes,
00708                          0,
00709                          (PUNICODE_STRING)NULL,
00710                          0,
00711                          &amp;tmpValue     <span class="comment">// disposition</span>
00712                          );
00713 
00714     ZwClose(handle);
00715 
00716     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00717         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to open/create netboot card service key: %x\n"</span>, status ));
00718         <span class="keywordflow">goto</span> cleanup;
00719     }
00720 
00721     <span class="comment">//</span>
00722     <span class="comment">// Store the image path.</span>
00723     <span class="comment">//</span>
00724 
00725     PiWstrToUnicodeString(&amp;string, L<span class="stringliteral">"ImagePath"</span>);
00726     wcscpy(imagePath, L<span class="stringliteral">"system32\\drivers\\"</span>);
00727     wcscat(imagePath, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>);
00728 
00729     status = ZwSetValueKey(serviceHandle,
00730                            &amp;string,
00731                            TITLE_INDEX_VALUE,
00732                            REG_SZ,
00733                            imagePath,
00734                            (wcslen(imagePath) + 1) * <span class="keyword">sizeof</span>(WCHAR)
00735                            );
00736 
00737     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00738         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceHandle);
00739         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write ImagePath: %x\n"</span>, status ));
00740         <span class="keywordflow">goto</span> cleanup;
00741     }
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Store the type.</span>
00745     <span class="comment">//</span>
00746 
00747     PiWstrToUnicodeString(&amp;string, L<span class="stringliteral">"Type"</span>);
00748     tmpValue = 1;
00749 
00750     ZwSetValueKey(serviceHandle,
00751                   &amp;string,
00752                   TITLE_INDEX_VALUE,
00753                   REG_DWORD,
00754                   &amp;tmpValue,
00755                   <span class="keyword">sizeof</span>(tmpValue)
00756                   );
00757 
00758     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(serviceHandle);
00759 
00760     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00761         KdPrint(( <span class="stringliteral">"IopAddRemoteBootValuesToRegistry: Unable to write Type: %x\n"</span>, status ));
00762     }
00763 
00764 cleanup:
00765 
00766     <span class="keywordflow">return</span> status;
00767 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="netboot.c::IopAssignNetworkDriveLetter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopAssignNetworkDriveLetter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l01546">1546</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00511">_SETUP_LOADER_BLOCK::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05675">IoCreateSymbolicLink()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01856">_LOADER_PARAMETER_BLOCK::NtBootPathName</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00526">SETUPBLK_FLAGS_REMOTE_INSTALL</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00527">SETUPBLK_FLAGS_SYSPREP_INSTALL</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01862">_LOADER_PARAMETER_BLOCK::SetupLoaderBlock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>.
<p>
<pre class="fragment"><div>01549 {
01550     PUCHAR p;
01551     PUCHAR q;
01552     UCHAR ntName[128];
01553     STRING ansiString;
01554     UNICODE_STRING unicodeString;
01555     UNICODE_STRING unicodeString2;
01556     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01557 
01558     <span class="comment">//</span>
01559     <span class="comment">// Create the symbolic link of X: to the redirector. We do this</span>
01560     <span class="comment">// after the redirector has loaded, but before AssignDriveLetters</span>
01561     <span class="comment">// is called the first time in textmode setup (once that has</span>
01562     <span class="comment">// happened, the drive letters will stick).</span>
01563     <span class="comment">//</span>
01564     <span class="comment">// Note that we use X: for the textmode setup phase of a remote</span>
01565     <span class="comment">// installation. But for a true remote boot, we use C:.</span>
01566     <span class="comment">//</span>
01567 
01568     <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; (<a class="code" href="../../d3/d8/setupblk_8h.html#a28">SETUPBLK_FLAGS_REMOTE_INSTALL</a> |
01569                                                  <a class="code" href="../../d3/d8/setupblk_8h.html#a29">SETUPBLK_FLAGS_SYSPREP_INSTALL</a>)) != 0) {
01570         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString2, L<span class="stringliteral">"\\DosDevices\\X:"</span>);
01571     } <span class="keywordflow">else</span> {
01572         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString2, L<span class="stringliteral">"\\DosDevices\\C:"</span>);
01573     }
01574 
01575     <span class="comment">//</span>
01576     <span class="comment">// If this is a remote boot setup boot, NtBootPathName is of the</span>
01577     <span class="comment">// form &lt;server&gt;&lt;share&gt;\setup&lt;install-directory&gt;&lt;platform&gt;.</span>
01578     <span class="comment">// We want the root of the X: drive to be the root of the install</span>
01579     <span class="comment">// directory.</span>
01580     <span class="comment">//</span>
01581     <span class="comment">// If this is a normal remote boot, NtBootPathName is of the form</span>
01582     <span class="comment">// &lt;server&gt;&lt;share&gt;\images&lt;machine&gt;\winnt. We want the root of</span>
01583     <span class="comment">// the X: drive to be the root of the machine directory.</span>
01584     <span class="comment">//</span>
01585     <span class="comment">// Thus in either case, we need to remove the last element of the</span>
01586     <span class="comment">// path.</span>
01587     <span class="comment">//</span>
01588 
01589     p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
01590     <span class="keywordflow">if</span> ( (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (*(p+1) == 0) ) {
01591 
01592         <span class="comment">//</span>
01593         <span class="comment">// NtBootPathName ends with a backslash, so we need to back up</span>
01594         <span class="comment">// to the previous backslash.</span>
01595         <span class="comment">//</span>
01596 
01597         q = p;
01598         *q = 0;
01599         p = strrchr( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a>, <span class="charliteral">'\\'</span> );   <span class="comment">// find last separator</span>
01600         *q = <span class="charliteral">'\\'</span>;
01601     }
01602     <span class="keywordflow">if</span> ( p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01603         KdPrint(( <span class="stringliteral">"IopAssignNetworkDriveLetter: malformed NtBootPathName: %s\n"</span>, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> ));
01604         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( ASSIGN_DRIVE_LETTERS_FAILED );
01605     }
01606     *p = 0;                                 <span class="comment">// terminate \server\share\images\machine</span>
01607 
01608     strcpy( ntName, <span class="stringliteral">"\\Device\\LanmanRedirector"</span>);
01609     strcat( ntName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o12">NtBootPathName</a> );  <span class="comment">// append \server\share\images\machine</span>
01610 
01611     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ansiString, ntName );
01612     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;unicodeString, &amp;ansiString, TRUE );
01613 
01614     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>(&amp;unicodeString2, &amp;unicodeString);
01615     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01616         KdPrint(( <span class="stringliteral">"IopAssignNetworkDriveLetter: unable to create DOS link for redirected boot drive: %x\n"</span>, status ));
01617         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( ASSIGN_DRIVE_LETTERS_FAILED );
01618     }
01619     <span class="comment">// DbgPrint("IopAssignNetworkDriveLetter: assigned %wZ to %wZ\n", &amp;unicodeString2, &amp;unicodeString);</span>
01620 
01621     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;unicodeString );
01622 
01623     *p = <span class="charliteral">'\\'</span>;                              <span class="comment">// restore string</span>
01624 
01625     <span class="keywordflow">return</span>;
01626 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="netboot.c::IopAssignNetworkDriveLetter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopAssignNetworkDriveLetter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="netboot.c::IopCacheNetbiosNameForIpAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCacheNetbiosNameForIpAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l04247">4247</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04238">htonl()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d2/d7/io_2create_8c-source.html#l00037">NtCreateFile()</a>, <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>.
<p>
<pre class="fragment"><div>04252                    :
04253 
04254     This function takes an <a class="code" href="../../d9/d2/festate_8h.html#a3">IP</a> address, and submits <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to NetBt <span class="keywordflow">for</span> name resolution.
04255 
04256 Arguments:
04257 
04258     IpAddress - Address to resolve
04259 
04260 Return Value:
04261 
04262     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> Code.
04263 
04264 --*/
04265 {
04266     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04267     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04268     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Context[CONTEXT_SIZE];
04269     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04270     OBJECT_ATTRIBUTES objectAttributes;
04271     UNICODE_STRING NameString;
04272     IO_STATUS_BLOCK ioStatusBlock;
04273     tREMOTE_CACHE cacheInfo;
04274     PCHAR serverName;
04275     PCHAR endOfServerName;
04276 
04277     <span class="comment">//</span>
04278     <span class="comment">// Open NetBT.</span>
04279     <span class="comment">//</span>
04280 
04281     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
04282         &amp;NameString,
04283         L<span class="stringliteral">"\\Device\\NetBT_Tcpip_{54C7D140-09EF-11D1-B25A-F5FE627ED95E}"</span>
04284         );
04285 
04286     InitializeObjectAttributes(
04287         &amp;objectAttributes,
04288         &amp;NameString,
04289         OBJ_CASE_INSENSITIVE,
04290         NULL,
04291         NULL
04292         );
04293 
04294     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
04295                 &amp;Handle,
04296                 GENERIC_READ | GENERIC_WRITE,
04297                 &amp;objectAttributes,
04298                 &amp;ioStatusBlock,
04299                 NULL,
04300                 0,
04301                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
04302                 FILE_OPEN,
04303                 FILE_SYNCHRONOUS_IO_NONALERT,
04304                 NULL,
04305                 0
04306                 );
04307     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04308         KdPrint(( <span class="stringliteral">"IopCacheNetbiosNameForIpAddress: Unable to open NETBT: %x\n"</span>, Status ));
04309         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04310     }
04311 
04312     <span class="comment">//</span>
04313     <span class="comment">// Get the server's name.</span>
04314     <span class="comment">//</span>
04315     <span class="comment">// If this is a remote boot setup boot, NtBootPathName is of the</span>
04316     <span class="comment">// form &lt;server&gt;&lt;share&gt;\setup&lt;install-directory&gt;&lt;platform&gt;.</span>
04317     <span class="comment">// If this is a normal remote boot, NtBootPathName is of the form</span>
04318     <span class="comment">// &lt;server&gt;&lt;share&gt;\images&lt;machine&gt;\winnt.</span>
04319     <span class="comment">//</span>
04320     <span class="comment">// Thus in either case, we need to isolate the first element of the</span>
04321     <span class="comment">// path.</span>
04322     <span class="comment">//</span>
04323 
04324     serverName = LoaderBlock-&gt;NtBootPathName;
04325     <span class="keywordflow">if</span> ( *serverName == <span class="charliteral">'\\'</span> ) {
04326         serverName++;
04327     }
04328     endOfServerName = strchr( serverName, <span class="charliteral">'\\'</span> );
04329     <span class="keywordflow">if</span> ( endOfServerName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04330         endOfServerName = strchr( serverName, <span class="charliteral">'\0'</span> );
04331     }
04332 
04333     <span class="comment">//</span>
04334     <span class="comment">// Fill in the tREMOTE_CACHE structure.</span>
04335     <span class="comment">//</span>
04336 
04337     memset(&amp;cacheInfo, 0x0, <span class="keyword">sizeof</span>(cacheInfo));
04338 
04339     memset(cacheInfo.name, <span class="charliteral">' '</span>, NETBIOS_NAMESIZE);
04340     memcpy(cacheInfo.name, serverName, (ULONG)(endOfServerName - serverName));
04341     cacheInfo.IpAddress = <a class="code" href="../../d4/d6/netboot_8c.html#a16">htonl</a>(LoaderBlock-&gt;SetupLoaderBlock-&gt;ServerIpAddress);
04342     cacheInfo.Ttl = MAXULONG;
04343 
04344     <span class="comment">//</span>
04345     <span class="comment">// Submit the IOCTL.</span>
04346     <span class="comment">//</span>
04347 
04348     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
04349                Handle,
04350                NULL,
04351                NULL,
04352                NULL,
04353                &amp;ioStatusBlock,
04354                IOCTL_NETBT_ADD_TO_REMOTE_TABLE,
04355                &amp;cacheInfo,
04356                <span class="keyword">sizeof</span>(cacheInfo),
04357                Context,
04358                <span class="keyword">sizeof</span>(Context)
04359                );
04360 
04361     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Status != STATUS_PENDING );
04362     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04363         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ioStatusBlock.Status;
04364     }
04365 
04366     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04367         KdPrint(( <span class="stringliteral">"IopCacheNetbiosNameForIpAddress: Adapter status failed: %x\n"</span>, Status ));
04368     }
04369 
04370     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Handle);
04371 
04372     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04373 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="netboot.c::IopIsRemoteBootCard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsRemoteBootCard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>HwIds</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l01903">1903</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00465">_SETUP_LOADER_BLOCK::NetbootCardHardwareId</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00504">_SETUP_LOADER_BLOCK::NetbootCardInfo</a>, <a class="el" href="../../d3/d8/setupblk_8h.html#a42">PSETUP_LOADER_BLOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01911                    :
01912 
01913     This function determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> card described by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hwIds <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01914     remote boot network card. It checks against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hardware <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01915     card that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> setup loader block.
01916 
01917     THIS ASSUMES THAT IOREMOTEBOOTCLIENT IS <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> AND THAT LOADERBLOCK
01918     IS VALID.
01919 
01920 Arguments:
01921 
01922     DeviceNode - Device node <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> card in question.
01923 
01924     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block that was
01925         created by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
01926 
01927     HwIds - The hardware IDs <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device in question.
01928 
01929 Return Value:
01930 
01931     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
01932 
01933 --*/
01934 
01935 {
01936     <a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html">PSETUP_LOADER_BLOCK</a> setupLoaderBlock;
01937     PWCHAR curHwId;
01938 
01939     <span class="comment">//</span>
01940     <span class="comment">// setupLoaderBlock will always be non-NULL if we are</span>
01941     <span class="comment">// remote booting, even if we are not in setup.</span>
01942     <span class="comment">//</span>
01943 
01944     setupLoaderBlock = LoaderBlock-&gt;SetupLoaderBlock;
01945 
01946     <span class="comment">//</span>
01947     <span class="comment">// Scan through the HwIds for a match.</span>
01948     <span class="comment">//</span>
01949 
01950     curHwId = HwIds;
01951 
01952     <span class="keywordflow">while</span> (*curHwId != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
01953         <span class="keywordflow">if</span> (wcscmp(curHwId, setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o26">NetbootCardHardwareId</a>) == 0) {
01954 
01955             ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, SlotNumber;
01956 
01957             <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = (ULONG)((((PNET_CARD_INFO)setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o31">NetbootCardInfo</a>)-&gt;pci.BusDevFunc) &gt;&gt; 8);
01958             SlotNumber = (ULONG)(((((PNET_CARD_INFO)setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o31">NetbootCardInfo</a>)-&gt;pci.BusDevFunc) &amp; 0xf8) &gt;&gt; 3);
01959             
01960             KdPrint((<span class="stringliteral">"IopIsRemoteBootCard: FOUND %ws\n"</span>, setupLoaderBlock-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o26">NetbootCardHardwareId</a>));
01961             <span class="keywordflow">if</span> ((DeviceNode-&gt;ResourceRequirements-&gt;BusNumber != <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) ||
01962                 (DeviceNode-&gt;ResourceRequirements-&gt;SlotNumber != SlotNumber)) {
01963                 KdPrint((<span class="stringliteral">"IopIsRemoteBootCard: ignoring non-matching card:\n"</span>));
01964                 KdPrint((<span class="stringliteral">"  devnode bus %d, busdevfunc bus %d\n"</span>,
01965                     DeviceNode-&gt;ResourceRequirements-&gt;BusNumber,
01966                     BusNumber));
01967                 KdPrint((<span class="stringliteral">"  devnode slot %d, busdevfunc slot %d\n"</span>,
01968                     DeviceNode-&gt;ResourceRequirements-&gt;SlotNumber,
01969                     SlotNumber));
01970                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01971             } <span class="keywordflow">else</span> {
01972                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01973             }
01974         }
01975         curHwId += (wcslen(curHwId) + 1);
01976     }
01977 
01978     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01979 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="netboot.c::IopSetDefaultGateway" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetDefaultGateway           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>GatewayAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">4017</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00059">DEFAULT_DEST</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00060">DEFAULT_DEST_MASK</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00061">DEFAULT_METRIC</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04377">IopTCPQueryInformationEx()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04458">IopTCPSetInformationEx()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d2/d7/io_2create_8c-source.html#l00037">NtCreateFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>.
<p>
<pre class="fragment"><div>04022                    :
04023 
04024     This function adds a <span class="keywordflow">default</span> gateway entry from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> router table.
04025 
04026 Arguments:
04027 
04028     GatewayAddress - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> gateway.
04029 
04030 Return Value:
04031 
04032     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> Code.
04033 
04034 --*/
04035 {
04036     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04037 
04038     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04039     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Context[CONTEXT_SIZE];
04040     TDIObjectID <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>;
04041     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04042     IPSNMPInfo IPStats;
04043     IPAddrEntry *AddrTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04044     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumReturned;
04045     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Type;
04046     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
04047     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> MatchIndex;
04048     IPRouteEntry RouteEntry;
04049     OBJECT_ATTRIBUTES objectAttributes;
04050     UNICODE_STRING NameString;
04051     IO_STATUS_BLOCK ioStatusBlock;
04052 
04053     <span class="keywordflow">if</span> (GatewayAddress == 0) {
04054         <span class="keywordflow">return</span> STATUS_SUCCESS;
04055     }
04056 
04057     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;NameString, DD_TCP_DEVICE_NAME );
04058 
04059     InitializeObjectAttributes(
04060         &amp;objectAttributes,
04061         &amp;NameString,
04062         OBJ_CASE_INSENSITIVE,
04063         NULL,
04064         NULL
04065         );
04066 
04067     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
04068                 &amp;Handle,
04069                 GENERIC_READ | GENERIC_WRITE,
04070                 &amp;objectAttributes,
04071                 &amp;ioStatusBlock,
04072                 NULL,
04073                 0,
04074                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
04075                 FILE_OPEN,
04076                 FILE_SYNCHRONOUS_IO_NONALERT,
04077                 NULL,
04078                 0
04079                 );
04080     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04081         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to open TCPIP: %x\n"</span>, Status ));
04082         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04083     }
04084 
04085     <span class="comment">//</span>
04086     <span class="comment">// Get the NetAddr info, to find an interface index for the gateway.</span>
04087     <span class="comment">//</span>
04088 
04089     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_entity.tei_entity   = CL_NL_ENTITY;
04090     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_entity.tei_instance = 0;
04091     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_class               = INFO_CLASS_PROTOCOL;
04092     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_type                = INFO_TYPE_PROVIDER;
04093     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_id                  = IP_MIB_STATS_ID;
04094 
04095     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(IPStats);
04096     memset(&amp;IPStats, 0x0, Size);
04097     memset(Context, 0x0, CONTEXT_SIZE);
04098 
04099     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/netboot_8c.html#a5">IopTCPQueryInformationEx</a>(
04100                 Handle,
04101                 &amp;ID,
04102                 &amp;IPStats,
04103                 &amp;Size,
04104                 Context);
04105 
04106     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04107         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to query TCPIP(1): %x\n"</span>, Status ));
04108         <span class="keywordflow">goto</span> Cleanup;
04109     }
04110 
04111     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = IPStats.ipsi_numaddr * <span class="keyword">sizeof</span>(IPAddrEntry);
04112     AddrTable = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, Size, 'bRoI');
04113 
04114     <span class="keywordflow">if</span> (AddrTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04115         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
04116         <span class="keywordflow">goto</span> Cleanup;
04117     }
04118 
04119     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_id = IP_MIB_ADDRTABLE_ENTRY_ID;
04120     memset(Context, 0x0, CONTEXT_SIZE);
04121 
04122     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/netboot_8c.html#a5">IopTCPQueryInformationEx</a>(
04123                 Handle,
04124                 &amp;ID,
04125                 AddrTable,
04126                 &amp;Size,
04127                 Context);
04128 
04129     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04130         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to query TCPIP(2): %x\n"</span>, Status ));
04131         <span class="keywordflow">goto</span> Cleanup;
04132     }
04133 
04134     NumReturned = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>/<span class="keyword">sizeof</span>(IPAddrEntry);
04135 
04136     <span class="comment">//</span>
04137     <span class="comment">// We've got the address table. Loop through it. If we find an exact</span>
04138     <span class="comment">// match for the gateway, then we're adding or deleting a direct route</span>
04139     <span class="comment">// and we're done. Otherwise try to find a match on the subnet mask,</span>
04140     <span class="comment">// and remember the first one we find.</span>
04141     <span class="comment">//</span>
04142 
04143     Type = IRE_TYPE_INDIRECT;
04144     <span class="keywordflow">for</span> (i = 0, MatchIndex = 0xffff; i &lt; NumReturned; i++) {
04145 
04146         <span class="keywordflow">if</span>( AddrTable[i].iae_addr == GatewayAddress ) {
04147 
04148             <span class="comment">//</span>
04149             <span class="comment">// Found an exact match.</span>
04150             <span class="comment">//</span>
04151 
04152             MatchIndex = i;
04153             Type = IRE_TYPE_DIRECT;
04154             <span class="keywordflow">break</span>;
04155         }
04156 
04157         <span class="comment">//</span>
04158         <span class="comment">// The next hop is on the same subnet as this address. If</span>
04159         <span class="comment">// we haven't already found a match, remember this one.</span>
04160         <span class="comment">//</span>
04161 
04162         <span class="keywordflow">if</span> ( (MatchIndex == 0xffff) &amp;&amp;
04163              (AddrTable[i].iae_addr != 0) &amp;&amp;
04164              (AddrTable[i].iae_mask != 0) &amp;&amp;
04165              ((AddrTable[i].iae_addr &amp; AddrTable[i].iae_mask) ==
04166                 (GatewayAddress  &amp; AddrTable[i].iae_mask)) ) {
04167 
04168             MatchIndex = i;
04169         }
04170     }
04171 
04172     <span class="comment">//</span>
04173     <span class="comment">// We've looked at all of the entries. See if we found a match.</span>
04174     <span class="comment">//</span>
04175 
04176     <span class="keywordflow">if</span> (MatchIndex == 0xffff) {
04177         <span class="comment">//</span>
04178         <span class="comment">// Didn't find a match.</span>
04179         <span class="comment">//</span>
04180 
04181         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
04182         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to find match for gateway\n"</span> ));
04183         <span class="keywordflow">goto</span> Cleanup;
04184     }
04185 
04186     <span class="comment">//</span>
04187     <span class="comment">// We've found a match. Fill in the route entry, and call the</span>
04188     <span class="comment">// Set API.</span>
04189     <span class="comment">//</span>
04190 
04191     RouteEntry.ire_dest = <a class="code" href="../../d4/d6/netboot_8c.html#a0">DEFAULT_DEST</a>;
04192     RouteEntry.ire_index = AddrTable[MatchIndex].iae_index;
04193     RouteEntry.ire_metric1 = <a class="code" href="../../d4/d6/netboot_8c.html#a2">DEFAULT_METRIC</a>;
04194     RouteEntry.ire_metric2 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
04195     RouteEntry.ire_metric3 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
04196     RouteEntry.ire_metric4 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
04197     RouteEntry.ire_nexthop = GatewayAddress;
04198     RouteEntry.ire_type = Type;
04199     RouteEntry.ire_proto = IRE_PROTO_LOCAL;
04200     RouteEntry.ire_age = 0;
04201     RouteEntry.ire_mask = <a class="code" href="../../d4/d6/netboot_8c.html#a1">DEFAULT_DEST_MASK</a>;
04202     RouteEntry.ire_metric5 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
04203     RouteEntry.ire_context = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04204 
04205     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(RouteEntry);
04206 
04207     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.toi_id = IP_MIB_RTTABLE_ENTRY_ID;
04208 
04209     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/netboot_8c.html#a6">IopTCPSetInformationEx</a>(
04210                 Handle,
04211                 &amp;ID,
04212                 &amp;RouteEntry,
04213                 Size );
04214 
04215     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04216         KdPrint(( <span class="stringliteral">"IopSetDefaultGateway: Unable to set default gateway: %x\n"</span>, Status ));
04217     }
04218 
04219     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Handle);
04220 
04221     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04222 
04223 Cleanup:
04224 
04225     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04226         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Handle);
04227     }
04228 
04229     <span class="keywordflow">if</span>( AddrTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04230         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AddrTable );
04231     }
04232 
04233     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04234 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="netboot.c::IopSetupRemoteBootCard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetupRemoteBootCard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>UniqueIdHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeDeviceInstance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l01982">1982</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00175">CmRegistryMachineSystemCurrentControlSet</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00180">CmRegistryMachineSystemCurrentControlSetControlClass</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00721">IopRemoteBootCardInitialized</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00471">_SETUP_LOADER_BLOCK::NetbootCardDriverName</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00465">_SETUP_LOADER_BLOCK::NetbootCardHardwareId</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00504">_SETUP_LOADER_BLOCK::NetbootCardInfo</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00496">_SETUP_LOADER_BLOCK::NetbootCardRegistry</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00477">_SETUP_LOADER_BLOCK::NetbootCardServiceName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00056">RtlInitString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>.
<p>
<pre class="fragment"><div>01990                    :
01991 
01992     This function modifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry to set up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> netboot card.
01993     We must <span class="keywordflow">do</span> <span class="keyword">this</span> here since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> card <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to boot, we can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>
01994     wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>installer to run.
01995 
01996     THIS ASSUMES THAT IOREMOTEBOOTCLIENT IS <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
01997 
01998 Arguments:
01999 
02000     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block that was
02001         created by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
02002 
02003     UniqueIdHandle - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's unique node under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02004         Enum key.
02005 
02006     UnicodeDeviceInstance - The device instance assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.
02007 
02008 Return Value:
02009 
02010     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
02011 
02012 --*/
02013 
02014 {
02015     <a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html">PSETUP_LOADER_BLOCK</a> setupLoaderBlock;
02016     UNICODE_STRING unicodeName, pnpInstanceId, keyName;
02017     HANDLE tmpHandle;
02018     HANDLE parametersHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02019     HANDLE currentControlSetHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02020     HANDLE remoteBootHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02021     HANDLE instanceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02022     PWCHAR componentIdBuffer, curComponentIdLoc;
02023     PCHAR registryList;
02024     ULONG componentIdLength;
02025     WCHAR tempNameBuffer[32];
02026     WCHAR tempValueBuffer[128];
02027     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02028     ULONG tmpValue, length;
02029     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
02030     PKEY_VALUE_BASIC_INFORMATION keyValueBasic;
02031     UCHAR dataBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + 128];
02032     ULONG enumerateIndex;
02033     OBJECT_ATTRIBUTES objectAttributes;
02034     ULONG disposition;
02035 
02036     <span class="comment">//</span>
02037     <span class="comment">// If we already think we have initialized a remote boot card, then</span>
02038     <span class="comment">// exit (should not really happen once we identify cards using the</span>
02039     <span class="comment">// bus/slot.</span>
02040     <span class="comment">//</span>
02041 
02042     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a74">IopRemoteBootCardInitialized</a>) {
02043         <span class="keywordflow">return</span> STATUS_SUCCESS;
02044     }
02045 
02046     <span class="comment">//</span>
02047     <span class="comment">// setupLoaderBlock will always be non-NULL if we are</span>
02048     <span class="comment">// remote booting, even if we are not in setup.</span>
02049     <span class="comment">//</span>
02050 
02051     setupLoaderBlock = LoaderBlock-&gt;SetupLoaderBlock;
02052 
02053     <span class="comment">//</span>
02054     <span class="comment">// Open the current control set.</span>
02055     <span class="comment">//</span>
02056 
02057     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;currentControlSetHandle,
02058                                 NULL,
02059                                 &amp;CmRegistryMachineSystemCurrentControlSet,
02060                                 KEY_ALL_ACCESS,
02061                                 FALSE
02062                                 );
02063 
02064     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02065         <span class="keywordflow">goto</span> cleanup;
02066     }
02067 
02068     <span class="comment">//</span>
02069     <span class="comment">// Open the Control\RemoteBoot key, which may not exist.</span>
02070     <span class="comment">//</span>
02071 
02072     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"Control\\RemoteBoot"</span>);
02073 
02074     InitializeObjectAttributes(&amp;objectAttributes,
02075                                &amp;unicodeName,
02076                                OBJ_CASE_INSENSITIVE,
02077                                currentControlSetHandle,
02078                                (PSECURITY_DESCRIPTOR)NULL
02079                                );
02080 
02081     status = ZwCreateKey(&amp;remoteBootHandle,
02082                          KEY_ALL_ACCESS,
02083                          &amp;objectAttributes,
02084                          0,
02085                          (PUNICODE_STRING)NULL,
02086                          0,
02087                          &amp;disposition
02088                          );
02089 
02090     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02091         <span class="keywordflow">goto</span> cleanup;
02092     }
02093 
02094     <span class="comment">//</span>
02095     <span class="comment">// Open the key where the netui code stores information about the cards.</span>
02096     <span class="comment">// During textmode setup this will fail because the Control\Network</span>
02097     <span class="comment">// key is not there. After that it should work, although we may need</span>
02098     <span class="comment">// to create the last node in the path.</span>
02099     <span class="comment">//</span>
02100 
02101     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"Control\\Network\\{4D36E972-E325-11CE-BFC1-08002BE10318}\\{54C7D140-09EF-11D1-B25A-F5FE627ED95E}"</span>);
02102 
02103     InitializeObjectAttributes(&amp;objectAttributes,
02104                                &amp;unicodeName,
02105                                OBJ_CASE_INSENSITIVE,
02106                                currentControlSetHandle,
02107                                (PSECURITY_DESCRIPTOR)NULL
02108                                );
02109 
02110     status = ZwCreateKey(&amp;instanceHandle,
02111                          KEY_ALL_ACCESS,
02112                          &amp;objectAttributes,
02113                          0,
02114                          (PUNICODE_STRING)NULL,
02115                          0,
02116                          &amp;disposition
02117                          );
02118 
02119     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02120 
02121         <span class="comment">//</span>
02122         <span class="comment">// If the PnpInstanceID of the first netboot card matches the one</span>
02123         <span class="comment">// for this device node, and the NET_CARD_INFO that the loader</span>
02124         <span class="comment">// found is the same as the one we saved, then this is the same</span>
02125         <span class="comment">// card with the same instance ID as before, so we don't need to</span>
02126         <span class="comment">// do anything.</span>
02127         <span class="comment">//</span>
02128 
02129         PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"PnPInstanceID"</span>);
02130         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)dataBuffer;
02131         RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02132 
02133         status = ZwQueryValueKey(
02134                      instanceHandle,
02135                      &amp;unicodeName,
02136                      KeyValuePartialInformation,
02137                      keyValue,
02138                      <span class="keyword">sizeof</span>(dataBuffer),
02139                      &amp;length);
02140 
02141         <span class="comment">//</span>
02142         <span class="comment">// Check that it matches. We can init the string because we zeroed</span>
02143         <span class="comment">// the dataBuffer before reading the key, so even if the</span>
02144         <span class="comment">// registry value had no NULL at the end that is OK.</span>
02145         <span class="comment">//</span>
02146 
02147         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02148             (keyValue-&gt;Type == REG_SZ)) {
02149 
02150             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;pnpInstanceId, (PWSTR)(keyValue-&gt;Data));
02151 
02152             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(UnicodeDeviceInstance, &amp;pnpInstanceId, TRUE)) {
02153 
02154                 <span class="comment">//</span>
02155                 <span class="comment">// Instance ID matched, see if the NET_CARD_INFO matches.</span>
02156                 <span class="comment">//</span>
02157 
02158                 PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"NetCardInfo"</span>);
02159                 RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02160 
02161                 status = ZwQueryValueKey(
02162                              remoteBootHandle,
02163                              &amp;unicodeName,
02164                              KeyValuePartialInformation,
02165                              keyValue,
02166                              <span class="keyword">sizeof</span>(dataBuffer),
02167                              &amp;length);
02168 
02169                 <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02170                     (keyValue-&gt;Type == REG_BINARY) &amp;&amp;
02171                     (keyValue-&gt;DataLength == <span class="keyword">sizeof</span>(NET_CARD_INFO)) &amp;&amp;
02172                     (memcmp(keyValue-&gt;Data, setupLoaderBlock-&gt;NetbootCardInfo, <span class="keyword">sizeof</span>(NET_CARD_INFO)) == 0)) {
02173 
02174                     <span class="comment">//</span>
02175                     <span class="comment">// Everything matched, so no need to do any setup.</span>
02176                     <span class="comment">//</span>
02177 
02178                     status = STATUS_SUCCESS;
02179                     <span class="keywordflow">goto</span> cleanup;
02180 
02181                 }
02182             }
02183         }
02184     }
02185 
02186 
02187     <span class="comment">//</span>
02188     <span class="comment">// We come through here if the saved registry data was missing or</span>
02189     <span class="comment">// not correct. Write all the relevant values to the registry.</span>
02190     <span class="comment">//</span>
02191 
02192 
02193     <span class="comment">//</span>
02194     <span class="comment">// Service name is in the loader block.</span>
02195     <span class="comment">//</span>
02196 
02197     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_SERVICE);
02198     ZwSetValueKey(UniqueIdHandle,
02199                   &amp;unicodeName,
02200                   TITLE_INDEX_VALUE,
02201                   REG_SZ,
02202                   setupLoaderBlock-&gt;NetbootCardServiceName,
02203                   (wcslen(setupLoaderBlock-&gt;NetbootCardServiceName) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02204                   );
02205 
02206     <span class="comment">//</span>
02207     <span class="comment">// ClassGUID is the known net card GUID.</span>
02208     <span class="comment">//</span>
02209 
02210     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_CLASSGUID);
02211     ZwSetValueKey(UniqueIdHandle,
02212                   &amp;unicodeName,
02213                   TITLE_INDEX_VALUE,
02214                   REG_SZ,
02215                   L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}"</span>,
02216                   <span class="keyword">sizeof</span>(L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}"</span>)
02217                   );
02218 
02219     <span class="comment">//</span>
02220     <span class="comment">// Driver is the first net card.</span>
02221     <span class="comment">//</span>
02222 
02223     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DRIVER);
02224     ZwSetValueKey(UniqueIdHandle,
02225                   &amp;unicodeName,
02226                   TITLE_INDEX_VALUE,
02227                   REG_SZ,
02228                   L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>,
02229                   <span class="keyword">sizeof</span>(L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>)
02230                   );
02231 
02232 <span class="preprocessor">#ifdef REMOTE_BOOT</span>
02233 <span class="preprocessor"></span>    <span class="comment">//</span>
02234     <span class="comment">// Identify this as the netboot card so the network class</span>
02235     <span class="comment">// installer knows to assign the reserved GUID.</span>
02236     <span class="comment">//</span>
02237 
02238     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_CONFIG_FLAGS);
02239 
02240     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)dataBuffer;
02241     RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02242 
02243     status = ZwQueryValueKey(UniqueIdHandle,
02244                              &amp;unicodeName,
02245                              KeyValuePartialInformation,
02246                              keyValue,
02247                              <span class="keyword">sizeof</span>(dataBuffer),
02248                              &amp;length);
02249 
02250     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
02251         (keyValue-&gt;Type == REG_DWORD)) {
02252         <span class="comment">//</span>
02253         <span class="comment">// The ConfigFlags value exists in the registry</span>
02254         <span class="comment">//</span>
02255         tmpValue = (*(PULONG)keyValue-&gt;Data) | CONFIGFLAG_NETBOOT_CARD;
02256     } <span class="keywordflow">else</span> {
02257         tmpValue = CONFIGFLAG_NETBOOT_CARD;
02258     }
02259 
02260     ZwSetValueKey(UniqueIdHandle,
02261                   &amp;unicodeName,
02262                   TITLE_INDEX_VALUE,
02263                   REG_DWORD,
02264                   &amp;tmpValue,
02265                   <span class="keyword">sizeof</span>(tmpValue)
02266                   );
02267 <span class="preprocessor">#endif</span>
02268 <span class="preprocessor"></span>
02269 
02270     <span class="comment">//</span>
02271     <span class="comment">// Open a handle for card parameters. We write RemoteBootCard plus</span>
02272     <span class="comment">// whatever the BINL server told us to write.</span>
02273     <span class="comment">//</span>
02274 
02275     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;tmpHandle,
02276                                 NULL,
02277                                 &amp;CmRegistryMachineSystemCurrentControlSetControlClass,
02278                                 KEY_ALL_ACCESS,
02279                                 FALSE
02280                                 );
02281 
02282     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02283         <span class="keywordflow">goto</span> cleanup;
02284     }
02285 
02286     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"{4D36E972-E325-11CE-BFC1-08002BE10318}\\0000"</span>);
02287 
02288     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;parametersHandle,
02289                                 tmpHandle,
02290                                 &amp;unicodeName,
02291                                 KEY_ALL_ACCESS,
02292                                 FALSE
02293                                 );
02294 
02295     ZwClose(tmpHandle);
02296 
02297     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02298         <span class="keywordflow">goto</span> cleanup;
02299     }
02300 
02301     <span class="comment">//</span>
02302     <span class="comment">// We know that this is a different NIC, so remove all the old parameters.</span>
02303     <span class="comment">//</span>
02304 
02305     keyValueBasic = (PKEY_VALUE_BASIC_INFORMATION)dataBuffer;
02306     enumerateIndex = 0;
02307 
02308     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02309 
02310         RtlZeroMemory(dataBuffer, <span class="keyword">sizeof</span>(dataBuffer));
02311 
02312         status = ZwEnumerateValueKey(
02313                     parametersHandle,
02314                     enumerateIndex,
02315                     KeyValueBasicInformation,
02316                     keyValueBasic,
02317                     <span class="keyword">sizeof</span>(dataBuffer),
02318                     &amp;length
02319                     );
02320         <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
02321             status = STATUS_SUCCESS;
02322             <span class="keywordflow">break</span>;
02323         }
02324 
02325         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02326             <span class="keywordflow">goto</span> cleanup;
02327         }
02328 
02329         <span class="comment">//</span>
02330         <span class="comment">// We don't delete "NetCfgInstanceID", it won't change and</span>
02331         <span class="comment">// its presence signifies to the net class installer that</span>
02332         <span class="comment">// this is a replacement not a clean install.</span>
02333         <span class="comment">//</span>
02334 
02335         <span class="keywordflow">if</span> (_wcsicmp(keyValueBasic-&gt;Name, L<span class="stringliteral">"NetCfgInstanceID"</span>) != 0) {
02336 
02337             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;keyName, keyValueBasic-&gt;Name);
02338             status = ZwDeleteValueKey(
02339                         parametersHandle,
02340                         &amp;keyName
02341                         );
02342 
02343             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02344                 <span class="keywordflow">goto</span> cleanup;
02345             }
02346 
02347         } <span class="keywordflow">else</span> {
02348 
02349             enumerateIndex = 1;   <span class="comment">// leave NetCfgInstanceID at index 0</span>
02350         }
02351 
02352     }
02353 
02354     <span class="comment">//</span>
02355     <span class="comment">// Write a parameter called RemoteBootCard set to TRUE, this</span>
02356     <span class="comment">// is primarily so NDIS can recognize this as such.</span>
02357     <span class="comment">//</span>
02358 
02359     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"RemoteBootCard"</span>);
02360     tmpValue = 1;
02361     ZwSetValueKey(parametersHandle,
02362                   &amp;unicodeName,
02363                   TITLE_INDEX_VALUE,
02364                   REG_DWORD,
02365                   &amp;tmpValue,
02366                   <span class="keyword">sizeof</span>(tmpValue)
02367                   );
02368 
02369 
02370     <span class="comment">//</span>
02371     <span class="comment">// Store any other parameters sent from the server.</span>
02372     <span class="comment">//</span>
02373 
02374     registryList = setupLoaderBlock-&gt;NetbootCardRegistry;
02375 
02376     <span class="keywordflow">if</span> (registryList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02377 
02378         STRING aString;
02379         UNICODE_STRING uString, uString2;
02380 
02381         <span class="comment">//</span>
02382         <span class="comment">// The registry list is a series of name\0type\0value\0, with</span>
02383         <span class="comment">// a final \0 at the end. It is in ANSI, not UNICODE.</span>
02384         <span class="comment">//</span>
02385         <span class="comment">// All values are stored under parametersHandle. Type is 1 for</span>
02386         <span class="comment">// DWORD and 2 for SZ.</span>
02387         <span class="comment">//</span>
02388 
02389         uString.Buffer = tempNameBuffer;
02390         uString.MaximumLength = <span class="keyword">sizeof</span>(tempNameBuffer);
02391 
02392         <span class="keywordflow">while</span> (*registryList != <span class="charliteral">'\0'</span>) {
02393 
02394             <span class="comment">//</span>
02395             <span class="comment">// First the name.</span>
02396             <span class="comment">//</span>
02397 
02398             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;aString, registryList);
02399             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;uString, &amp;aString, FALSE);
02400 
02401             <span class="comment">//</span>
02402             <span class="comment">// Now the type.</span>
02403             <span class="comment">//</span>
02404 
02405             registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02406 
02407             <span class="keywordflow">if</span> (*registryList == <span class="charliteral">'1'</span>) {
02408 
02409                 <span class="comment">//</span>
02410                 <span class="comment">// A DWORD, parse it.</span>
02411                 <span class="comment">//</span>
02412 
02413                 registryList += 2;   <span class="comment">// skip "1\0"</span>
02414                 tmpValue = 0;
02415 
02416                 <span class="keywordflow">while</span> (*registryList != <span class="charliteral">'\0'</span>) {
02417                     tmpValue = (tmpValue * 10) + (*registryList - <span class="charliteral">'0'</span>);
02418                     ++registryList;
02419                 }
02420 
02421                 ZwSetValueKey(parametersHandle,
02422                               &amp;uString,
02423                               TITLE_INDEX_VALUE,
02424                               REG_DWORD,
02425                               &amp;tmpValue,
02426                               <span class="keyword">sizeof</span>(tmpValue)
02427                               );
02428 
02429                 registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02430 
02431             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*registryList == <span class="charliteral">'2'</span>) {
02432 
02433                 <span class="comment">//</span>
02434                 <span class="comment">// An SZ, convert to Unicode.</span>
02435                 <span class="comment">//</span>
02436 
02437                 registryList += 2;   <span class="comment">// skip "2\0"</span>
02438 
02439                 uString2.Buffer = tempValueBuffer;
02440                 uString2.MaximumLength = <span class="keyword">sizeof</span>(tempValueBuffer);
02441                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;aString, registryList);
02442                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;uString2, &amp;aString, FALSE);
02443 
02444                 ZwSetValueKey(parametersHandle,
02445                               &amp;uString,
02446                               TITLE_INDEX_VALUE,
02447                               REG_SZ,
02448                               uString2.Buffer,
02449                               uString2.Length + <span class="keyword">sizeof</span>(WCHAR)
02450                               );
02451 
02452                 registryList += (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(registryList) + 1);
02453 
02454             } <span class="keywordflow">else</span> {
02455 
02456                 <span class="comment">//</span>
02457                 <span class="comment">// Not "1" or "2", so stop processing registryList.</span>
02458                 <span class="comment">//</span>
02459 
02460                 <span class="keywordflow">break</span>;
02461 
02462             }
02463 
02464         }
02465 
02466     }
02467 
02468     <span class="comment">//</span>
02469     <span class="comment">// Save the NET_CARD_INFO so we can check it next time.</span>
02470     <span class="comment">//</span>
02471 
02472     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"NetCardInfo"</span>);
02473 
02474     ZwSetValueKey(remoteBootHandle,
02475                   &amp;unicodeName,
02476                   TITLE_INDEX_VALUE,
02477                   REG_BINARY,
02478                   setupLoaderBlock-&gt;NetbootCardInfo,
02479                   <span class="keyword">sizeof</span>(NET_CARD_INFO)
02480                   );
02481 
02482 
02483     <span class="comment">//</span>
02484     <span class="comment">// Save the hardware ID, driver name, and service name,</span>
02485     <span class="comment">// so the loader can read  those if the server is down</span>
02486     <span class="comment">// on subsequent boots.</span>
02487     <span class="comment">//</span>
02488 
02489     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"HardwareId"</span>);
02490 
02491     ZwSetValueKey(remoteBootHandle,
02492                   &amp;unicodeName,
02493                   TITLE_INDEX_VALUE,
02494                   REG_SZ,
02495                   setupLoaderBlock-&gt;NetbootCardHardwareId,
02496                   (wcslen(setupLoaderBlock-&gt;NetbootCardHardwareId) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02497                   );
02498 
02499     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"DriverName"</span>);
02500 
02501     ZwSetValueKey(remoteBootHandle,
02502                   &amp;unicodeName,
02503                   TITLE_INDEX_VALUE,
02504                   REG_SZ,
02505                   setupLoaderBlock-&gt;NetbootCardDriverName,
02506                   (wcslen(setupLoaderBlock-&gt;NetbootCardDriverName) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02507                   );
02508 
02509     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"ServiceName"</span>);
02510 
02511     ZwSetValueKey(remoteBootHandle,
02512                   &amp;unicodeName,
02513                   TITLE_INDEX_VALUE,
02514                   REG_SZ,
02515                   setupLoaderBlock-&gt;NetbootCardServiceName,
02516                   (wcslen(setupLoaderBlock-&gt;NetbootCardServiceName) + 1) * <span class="keyword">sizeof</span>(WCHAR)
02517                   );
02518 
02519     <span class="comment">//</span>
02520     <span class="comment">// Save the device instance, in case we need to ID the card later.</span>
02521     <span class="comment">//</span>
02522 
02523     PiWstrToUnicodeString(&amp;unicodeName, L<span class="stringliteral">"DeviceInstance"</span>);
02524 
02525     ZwSetValueKey(remoteBootHandle,
02526                   &amp;unicodeName,
02527                   TITLE_INDEX_VALUE,
02528                   REG_SZ,
02529                   UnicodeDeviceInstance-&gt;Buffer,
02530                   UnicodeDeviceInstance-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)
02531                   );
02532 
02533     <span class="comment">//</span>
02534     <span class="comment">// Make sure we only pick one card to setup this way!</span>
02535     <span class="comment">//</span>
02536 
02537     <a class="code" href="../../d3/d5/iodata_8c.html#a74">IopRemoteBootCardInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02538 
02539 
02540 cleanup:
02541     <span class="keywordflow">if</span> (instanceHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02542         ZwClose(instanceHandle);
02543     }
02544     <span class="keywordflow">if</span> (remoteBootHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02545         ZwClose(remoteBootHandle);
02546     }
02547     <span class="keywordflow">if</span> (parametersHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02548         ZwClose(parametersHandle);
02549     }
02550     <span class="keywordflow">if</span> (currentControlSetHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02551         ZwClose(currentControlSetHandle);
02552     }
02553 
02554     <span class="keywordflow">return</span> status;
02555 
02556 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="netboot.c::IopStartNetworkForRemoteBoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopStartNetworkForRemoteBoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">770</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00453">_SETUP_LOADER_BLOCK::DefaultRouter</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00511">_SETUP_LOADER_BLOCK::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06960">IoGetCurrentProcess()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01546">IopAssignNetworkDriveLetter()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04247">IopCacheNetbiosNameForIpAddress()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00471">_SETUP_LOADER_BLOCK::NetbootCardDriverName</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00557">_SETUP_LOADER_BLOCK::NetBootSecret</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d2/d7/io_2create_8c-source.html#l00037">NtCreateFile()</a>, <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, <a class="el" href="../../d9/d6/io_2fsctrl_8c-source.html#l00034">NtFsControlFile()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00514">SETUPBLK_FLAGS_IS_TEXTMODE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01862">_LOADER_PARAMETER_BLOCK::SetupLoaderBlock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00773 {
00774     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00775     HANDLE dgHandle;
00776     HANDLE keyHandle;
00777     OBJECT_ATTRIBUTES objectAttributes;
00778     IO_STATUS_BLOCK ioStatusBlock;
00779     UNICODE_STRING string;
00780     UNICODE_STRING computerName;
00781     UNICODE_STRING domainName;
00782     PUCHAR buffer;
00783     ULONG bufferLength;
00784     PLMR_REQUEST_PACKET rrp;
00785     PLMDR_REQUEST_PACKET drrp;
00786     WKSTA_INFO_502 wkstaConfig;
00787     WKSTA_TRANSPORT_INFO_0 wkstaTransportInfo;
00788     LARGE_INTEGER interval;
00789     ULONG length;
00790     PKEY_VALUE_PARTIAL_INFORMATION keyValue;
00791     BOOLEAN startDatagramReceiver;
00792     ULONG enumerateAttempts;
00793 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00794 <span class="preprocessor"></span>    PWSTR NetHDCSCPartition;
00795     BOOLEAN leaveRdrHandleOpen;
00796     BOOLEAN pinNetDriver;
00797 <span class="preprocessor">#else</span>
00798 <span class="preprocessor"></span>    HANDLE RdrHandle;
00799 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00800 <span class="preprocessor"></span>
00801     <span class="comment">//</span>
00802     <span class="comment">// Initialize for cleanup.</span>
00803     <span class="comment">//</span>
00804 
00805     buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00806     computerName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00807     domainName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00808     dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00809     RdrHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00810 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00811 <span class="preprocessor"></span>    NetHDCSCPartition = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00812     leaveRdrHandleOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00813     pinNetDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00814 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00815 <span class="preprocessor"></span>
00816     <span class="comment">//</span>
00817     <span class="comment">// Allocate a temporary buffer. It has to be big enough for all the</span>
00818     <span class="comment">// various FSCTLs we send down.</span>
00819     <span class="comment">//</span>
00820 
00821     bufferLength = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<span class="keyword">sizeof</span>(LMR_REQUEST_PACKET) + (MAX_PATH + 1) * <span class="keyword">sizeof</span>(WCHAR) +
00822                                                  (DNLEN + 1) * <span class="keyword">sizeof</span>(WCHAR),
00823                        <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<span class="keyword">sizeof</span>(LMDR_REQUEST_PACKET),
00824                            FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + MAX_PATH));
00825     bufferLength = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(bufferLength, <span class="keyword">sizeof</span>(LMMR_RI_INITIALIZE_SECRET));
00826 
00827 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00828 <span class="preprocessor"></span>    NetHDCSCPartition = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00829                             NonPagedPool,
00830                             (80 * <span class="keyword">sizeof</span>(WCHAR)) + bufferLength,
00831                             'bRoI'
00832                             );
00833     <span class="keywordflow">if</span> (NetHDCSCPartition == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00834         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer\n"</span>));
00835         status = STATUS_INSUFFICIENT_RESOURCES;
00836         <span class="keywordflow">goto</span> cleanup;
00837     }
00838     buffer = (PUCHAR)(NetHDCSCPartition + 80);
00839 <span class="preprocessor">#else</span>
00840 <span class="preprocessor"></span>    buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, bufferLength, 'bRoI' );
00841     <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00842         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer\n"</span>));
00843         status = STATUS_INSUFFICIENT_RESOURCES;
00844         <span class="keywordflow">goto</span> cleanup;
00845     }
00846 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00847 <span class="preprocessor"></span>
00848     rrp = (PLMR_REQUEST_PACKET)buffer;
00849     drrp = (PLMDR_REQUEST_PACKET)buffer;
00850 
00851     <span class="comment">//</span>
00852     <span class="comment">// Open the redirector and the datagram receiver.</span>
00853     <span class="comment">//</span>
00854 
00855     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Device\\LanmanRedirector"</span> );
00856 
00857     InitializeObjectAttributes(
00858         &amp;objectAttributes,
00859         &amp;string,
00860         OBJ_CASE_INSENSITIVE,
00861         NULL,
00862         NULL
00863         );
00864 
00865     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00866                 &amp;RdrHandle,
00867                 GENERIC_READ | GENERIC_WRITE,
00868                 &amp;objectAttributes,
00869                 &amp;ioStatusBlock,
00870                 NULL,
00871                 0,
00872                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
00873                 FILE_OPEN,
00874                 FILE_SYNCHRONOUS_IO_NONALERT,
00875                 NULL,
00876                 0
00877                 );
00878     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00879         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open redirector: %x\n"</span>, status ));
00880         <span class="keywordflow">goto</span> cleanup;
00881     }
00882 
00883 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00884 <span class="preprocessor"></span>    RdrHandleProcess = &amp;<a class="code" href="../../d4/d6/iosubs_8c.html#a70">IoGetCurrentProcess</a>()-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>;
00885 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00886 <span class="preprocessor"></span>
00887     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, DD_BROWSER_DEVICE_NAME_U );
00888 
00889     InitializeObjectAttributes(
00890         &amp;objectAttributes,
00891         &amp;string,
00892         OBJ_CASE_INSENSITIVE,
00893         NULL,
00894         NULL
00895         );
00896 
00897     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00898                 &amp;dgHandle,
00899                 GENERIC_READ | GENERIC_WRITE,
00900                 &amp;objectAttributes,
00901                 &amp;ioStatusBlock,
00902                 NULL,
00903                 0,
00904                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
00905                 FILE_OPEN,
00906                 FILE_SYNCHRONOUS_IO_NONALERT,
00907                 NULL,
00908                 0
00909                 );
00910     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00911         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open datagram receiver: %x\n"</span>, status ));
00912         <span class="keywordflow">goto</span> cleanup;
00913     }
00914 
00915     <span class="comment">//</span>
00916     <span class="comment">// If the setup loader block has a disk secret in it provided by the</span>
00917     <span class="comment">// loader, pass this down to the redirector (do this before sending</span>
00918     <span class="comment">// the LMR_START, since that uses this information).</span>
00919     <span class="comment">//</span>
00920 
00921 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00922 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a>)
00923 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00924 <span class="preprocessor"></span>    {
00925         PLMMR_RI_INITIALIZE_SECRET RbInit = (PLMMR_RI_INITIALIZE_SECRET)buffer;
00926 
00927         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a> != NULL);
00928         RtlCopyMemory(
00929             &amp;RbInit-&gt;Secret,
00930             LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o36">NetBootSecret</a>,
00931             <span class="keyword">sizeof</span>(RI_SECRET));
00932 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00933 <span class="preprocessor"></span>        RbInit-&gt;UsePassword2 = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;NetBootUsePassword2;
00934 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00935 <span class="preprocessor"></span>
00936         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
00937                     RdrHandle,
00938                     NULL,
00939                     NULL,
00940                     NULL,
00941                     &amp;ioStatusBlock,
00942                     FSCTL_LMMR_RI_INITIALIZE_SECRET,
00943                     buffer,
00944                     <span class="keyword">sizeof</span>(LMMR_RI_INITIALIZE_SECRET),
00945                     NULL,
00946                     0
00947                     );
00948 
00949         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00950             status = ioStatusBlock.Status;
00951         }
00952         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00953             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(RB initialize) redirector: %x\n"</span>, status ));
00954             <span class="keywordflow">goto</span> cleanup;
00955         }
00956     }
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">// Read the computer name and domain name from the registry so we</span>
00960     <span class="comment">// can give them to the datagram receiver. During textmode setup</span>
00961     <span class="comment">// the domain name will not be there, so we won't start the datagram</span>
00962     <span class="comment">// receiver, which is fine.</span>
00963     <span class="comment">//</span>
00964     <span class="comment">// BUGBUG: Figure out the correct location to read the domain name</span>
00965     <span class="comment">// from -- this one is a special hack in winnt.sif just for this.</span>
00966     <span class="comment">//</span>
00967 
00968     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\ComputerName"</span> );
00969 
00970     InitializeObjectAttributes(
00971         &amp;objectAttributes,
00972         &amp;string,
00973         OBJ_CASE_INSENSITIVE,
00974         NULL,
00975         NULL
00976         );
00977 
00978     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;keyHandle, KEY_ALL_ACCESS, &amp;objectAttributes );
00979     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00980         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open ComputerName key: %x\n"</span>, status ));
00981         <span class="keywordflow">goto</span> cleanup;
00982     }
00983 
00984     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"ComputerName"</span> );
00985 
00986     keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
00987     RtlZeroMemory(buffer, bufferLength);
00988 
00989     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00990                  keyHandle,
00991                  &amp;string,
00992                  KeyValuePartialInformation,
00993                  keyValue,
00994                  bufferLength,
00995                  &amp;length);
00996 
00997     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
00998     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00999         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to query ComputerName value: %x\n"</span>, status ));
01000         <span class="keywordflow">goto</span> cleanup;
01001     }
01002 
01003     <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;computerName, (PWSTR)keyValue-&gt;Data) ) {
01004         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to create ComputerName string\n"</span> ));
01005         status = STATUS_INSUFFICIENT_RESOURCES;
01006         <span class="keywordflow">goto</span> cleanup;
01007     }
01008 
01009     domainName.Length = 0;
01010 
01011     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ComputerName\\DomainName"</span> );
01012 
01013     InitializeObjectAttributes(
01014         &amp;objectAttributes,
01015         &amp;string,
01016         OBJ_CASE_INSENSITIVE,
01017         NULL,
01018         NULL
01019         );
01020 
01021     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;keyHandle, KEY_ALL_ACCESS, &amp;objectAttributes );
01022     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01023         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open DomainName key: %x\n"</span>, status ));
01024         startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01025     } <span class="keywordflow">else</span> {
01026 
01027         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"DomainName"</span> );
01028 
01029         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;
01030         RtlZeroMemory(buffer, bufferLength);
01031 
01032         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
01033                      keyHandle,
01034                      &amp;string,
01035                      KeyValuePartialInformation,
01036                      keyValue,
01037                      bufferLength,
01038                      &amp;length);
01039 
01040         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
01041         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01042             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to query Domain value: %x\n"</span>, status ));
01043             startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01044         } <span class="keywordflow">else</span> {
01045             <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;domainName, (PWSTR)keyValue-&gt;Data) ) {
01046                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to create DomainName string\n"</span> ));
01047                 status = STATUS_INSUFFICIENT_RESOURCES;
01048                 <span class="keywordflow">goto</span> cleanup;
01049             }
01050             startDatagramReceiver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01051         }
01052     }
01053 
01054     <span class="comment">//</span>
01055     <span class="comment">// Tell the redir to start.</span>
01056     <span class="comment">//</span>
01057 
01058     rrp-&gt;Type = ConfigInformation;
01059     rrp-&gt;Version = REQUEST_PACKET_VERSION;
01060 
01061     rrp-&gt;Parameters.Start.RedirectorNameLength = computerName.Length;
01062     RtlCopyMemory(rrp-&gt;Parameters.Start.RedirectorName,
01063                   computerName.Buffer,
01064                   computerName.Length);
01065 
01066     rrp-&gt;Parameters.Start.DomainNameLength = domainName.Length;
01067     RtlCopyMemory(((PUCHAR)rrp-&gt;Parameters.Start.RedirectorName) + computerName.Length,
01068                   domainName.Buffer,
01069                   domainName.Length);
01070 
01071     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;computerName);
01072     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;domainName);
01073 
01074     wkstaConfig.wki502_char_wait = 3600;
01075     wkstaConfig.wki502_maximum_collection_count = 16;
01076     wkstaConfig.wki502_collection_time = 250;
01077     wkstaConfig.wki502_keep_conn = 600;
01078     wkstaConfig.wki502_max_cmds = 5;
01079     wkstaConfig.wki502_sess_timeout = 45;
01080     wkstaConfig.wki502_siz_char_buf = 512;
01081     wkstaConfig.wki502_max_threads = 17;
01082     wkstaConfig.wki502_lock_quota = 6144;
01083     wkstaConfig.wki502_lock_increment = 10;
01084     wkstaConfig.wki502_lock_maximum = 500;
01085     wkstaConfig.wki502_pipe_increment = 10;
01086     wkstaConfig.wki502_pipe_maximum = 500;
01087     wkstaConfig.wki502_cache_file_timeout = 40;
01088     wkstaConfig.wki502_dormant_file_limit = 45;
01089     wkstaConfig.wki502_read_ahead_throughput = MAXULONG;
01090     wkstaConfig.wki502_num_mailslot_buffers = 3;
01091     wkstaConfig.wki502_num_srv_announce_buffers = 20;
01092     wkstaConfig.wki502_max_illegal_datagram_events = 5;
01093     wkstaConfig.wki502_illegal_datagram_event_reset_frequency = 60;
01094     wkstaConfig.wki502_log_election_packets = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01095     wkstaConfig.wki502_use_opportunistic_locking = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01096     wkstaConfig.wki502_use_unlock_behind = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01097     wkstaConfig.wki502_use_close_behind = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01098     wkstaConfig.wki502_buf_named_pipes = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01099     wkstaConfig.wki502_use_lock_read_unlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01100     wkstaConfig.wki502_utilize_nt_caching = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01101     wkstaConfig.wki502_use_raw_read = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01102     wkstaConfig.wki502_use_raw_write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01103     wkstaConfig.wki502_use_write_raw_data = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01104     wkstaConfig.wki502_use_encryption = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01105     wkstaConfig.wki502_buf_files_deny_write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01106     wkstaConfig.wki502_buf_read_only_files = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01107     wkstaConfig.wki502_force_core_create_mode = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01108     wkstaConfig.wki502_use_512_byte_max_transfer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01109 
01110     status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01111                 RdrHandle,
01112                 NULL,
01113                 NULL,
01114                 NULL,
01115                 &amp;ioStatusBlock,
01116                 FSCTL_LMR_START | 0x80000000,
01117                 rrp,
01118                 <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET) +
01119                     rrp-&gt;Parameters.Start.RedirectorNameLength +
01120                     rrp-&gt;Parameters.Start.DomainNameLength,
01121                 &amp;wkstaConfig,
01122                 <span class="keyword">sizeof</span>(wkstaConfig)
01123                 );
01124 
01125     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01126         status = ioStatusBlock.Status;
01127     }
01128     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01129         KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(start) redirector: %x\n"</span>, status ));
01130         <span class="keywordflow">goto</span> cleanup;
01131     }
01132 
01133     <span class="keywordflow">if</span> (startDatagramReceiver) {
01134 
01135         <span class="comment">//</span>
01136         <span class="comment">// Tell the datagram receiver to start.</span>
01137         <span class="comment">//</span>
01138 
01139         drrp-&gt;Version = LMDR_REQUEST_PACKET_VERSION;
01140 
01141         drrp-&gt;Parameters.Start.NumberOfMailslotBuffers = 16;
01142         drrp-&gt;Parameters.Start.NumberOfServerAnnounceBuffers = 20;
01143         drrp-&gt;Parameters.Start.IllegalDatagramThreshold = 5;
01144         drrp-&gt;Parameters.Start.EventLogResetFrequency = 60;
01145         drrp-&gt;Parameters.Start.LogElectionPackets = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01146 
01147         drrp-&gt;Parameters.Start.IsLanManNt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01148 
01149         status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01150                     dgHandle,
01151                     NULL,
01152                     NULL,
01153                     NULL,
01154                     &amp;ioStatusBlock,
01155                     IOCTL_LMDR_START,
01156                     drrp,
01157                     <span class="keyword">sizeof</span>(LMDR_REQUEST_PACKET),
01158                     NULL,
01159                     0
01160                     );
01161 
01162         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01163             status = ioStatusBlock.Status;
01164         }
01165 
01166         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01167         dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168 
01169         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01170             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to IOCTL(start) datagram receiver: %x\n"</span>, status ));
01171             <span class="keywordflow">goto</span> cleanup;
01172         }
01173 
01174     } <span class="keywordflow">else</span> {
01175 
01176         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01177         dgHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01178 
01179         <span class="comment">//</span>
01180         <span class="comment">// Tell the redir to bind to the transports.</span>
01181         <span class="comment">//</span>
01182         <span class="comment">// Note: In the current redirector implementation, this call just</span>
01183         <span class="comment">// tells the redirector to register for TDI PnP notifications.</span>
01184         <span class="comment">// Starting the datagram receiver also does this, so we only issue</span>
01185         <span class="comment">// this FSCTL if we're not starting the datagram receiver.</span>
01186         <span class="comment">//</span>
01187 
01188         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01189                     RdrHandle,
01190                     NULL,
01191                     NULL,
01192                     NULL,
01193                     &amp;ioStatusBlock,
01194                     FSCTL_LMR_BIND_TO_TRANSPORT | 0x80000000,
01195                     NULL,
01196                     0,
01197                     NULL,
01198                     0
01199                     );
01200 
01201         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01202             status = ioStatusBlock.Status;
01203         }
01204 
01205         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01206             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(bind) redirector: %x\n"</span>, status ));
01207             <span class="keywordflow">goto</span> cleanup;
01208         }
01209     }
01210 
01211 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01212 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) == 0) &amp;&amp;
01213         ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_FORMAT_NEEDED) == 0)) {
01214 
01215         <span class="comment">//</span>
01216         <span class="comment">// Get the path to the boot partition on the disk for CSC and redirection</span>
01217         <span class="comment">// Note: On failure, this defaults to \Device\Harddisk0\Partition1</span>
01218         <span class="comment">//</span>
01219 
01220         IopGetHarddiskInfo(NetHDCSCPartition);
01221 
01222         <span class="comment">//</span>
01223         <span class="comment">// Tell the redirector to initialize remote boot redirection (back</span>
01224         <span class="comment">// to the local disk). Note that we only do this if we're NOT doing</span>
01225         <span class="comment">// textmode setup. During textmode, we let Setup do this so that it</span>
01226         <span class="comment">// can do so AFTER it has reformatted the local disk.</span>
01227         <span class="comment">//</span>
01228 
01229         status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01230                     RdrHandle,
01231                     NULL,
01232                     NULL,
01233                     NULL,
01234                     &amp;ioStatusBlock,
01235                     FSCTL_LMR_START_RBR,
01236                     NetHDCSCPartition,
01237                     wcslen(NetHDCSCPartition) * <span class="keyword">sizeof</span>(WCHAR),
01238                     NULL,
01239                     0
01240                     );
01241 
01242         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01243             status = ioStatusBlock.Status;
01244         }
01245 
01246         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01247             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to FSCTL(RBR) redirector: %x\n"</span>, status ));
01248         }
01249     }
01250 
01251     <span class="keywordflow">if</span> ( (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISCONNECTED) == 0 )
01252 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01253 <span class="preprocessor"></span>    {
01254 
01255         <span class="comment">//</span>
01256         <span class="comment">// Loop until the redirector is bound to the transport. It may take a</span>
01257         <span class="comment">// while because TDI defers notification of binding to a worker thread.</span>
01258         <span class="comment">// We start with a half a second wait and double it each time, trying</span>
01259         <span class="comment">// five times total.</span>
01260         <span class="comment">//</span>
01261 
01262         interval.QuadPart = -500 * 1000 * 10;    <span class="comment">// 1/2 second, relative</span>
01263         enumerateAttempts = 0;
01264 
01265         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01266 
01267             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>(KernelMode, FALSE, &amp;interval);
01268 
01269             RtlZeroMemory(rrp, <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET));
01270 
01271             rrp-&gt;Type = EnumerateTransports;
01272             rrp-&gt;Version = REQUEST_PACKET_VERSION;
01273 
01274             status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01275                         RdrHandle,
01276                         NULL,
01277                         NULL,
01278                         NULL,
01279                         &amp;ioStatusBlock,
01280                         FSCTL_LMR_ENUMERATE_TRANSPORTS,
01281                         rrp,
01282                         <span class="keyword">sizeof</span>(LMR_REQUEST_PACKET),
01283                         &amp;wkstaTransportInfo,
01284                         <span class="keyword">sizeof</span>(wkstaTransportInfo)
01285                         );
01286 
01287             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01288                 status = ioStatusBlock.Status;
01289             }
01290             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01291                 <span class="comment">//KdPrint(( "IopStartNetworkForRemoteBoot: Unable to FSCTL(enumerate) redirector: %x\n", status ));</span>
01292             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rrp-&gt;Parameters.Get.TotalBytesNeeded == 0) {
01293                 <span class="comment">//KdPrint(( "IopStartNetworkForRemoteBoot: FSCTL(enumerate) returned 0 entries\n" ));</span>
01294             } <span class="keywordflow">else</span> {
01295                 <span class="keywordflow">break</span>;
01296             }
01297 
01298             ++enumerateAttempts;
01299 
01300             <span class="keywordflow">if</span> (enumerateAttempts == 5) {
01301                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Redirector didn't start\n"</span> ));
01302                 status = STATUS_REDIRECTOR_NOT_STARTED;
01303                 <span class="keywordflow">goto</span> cleanup;
01304             }
01305 
01306             interval.QuadPart *= 2;
01307 
01308         }
01309     }
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// Prime the transport.</span>
01313     <span class="comment">//</span>
01314 
01315 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01316 <span class="preprocessor"></span>    IopEnableRemoteBootSecurity(LoaderBlock);
01317 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01318 <span class="preprocessor"></span>    <a class="code" href="../../d4/d6/netboot_8c.html#a7">IopSetDefaultGateway</a>(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o24">DefaultRouter</a>);
01319     <a class="code" href="../../d4/d6/netboot_8c.html#a8">IopCacheNetbiosNameForIpAddress</a>(LoaderBlock);
01320 
01321 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01322 <span class="preprocessor"></span>    <span class="comment">//</span>
01323     <span class="comment">// CSC needs to be initialized after binding to the transport because ResetCSC</span>
01324     <span class="comment">// (if needed) will try to enumerate the files and directories on the server.</span>
01325     <span class="comment">//</span>
01326 
01327     <span class="keywordflow">if</span> (((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; <a class="code" href="../../d3/d8/setupblk_8h.html#a26">SETUPBLK_FLAGS_IS_TEXTMODE</a>) == 0) &amp;&amp;
01328         ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_FORMAT_NEEDED) == 0)
01329 <span class="preprocessor">#if 0</span>
01330 <span class="preprocessor"></span>        &amp;&amp; ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISABLE_CSC) != 0)
01331 <span class="preprocessor">#endif</span>
01332 <span class="preprocessor"></span>        ) {
01333 
01334         wcstombs(buffer, NetHDCSCPartition, wcslen(NetHDCSCPartition) + 1);
01335         strcat(buffer, REMOTE_BOOT_IMIRROR_PATH_A REMOTE_BOOT_CSC_SUBDIR_A);
01336 
01337         status = IopInitCsc( buffer );
01338 
01339         <span class="comment">//</span>
01340         <span class="comment">//  If we are connected and either we are part way through a reset of</span>
01341         <span class="comment">//  the csc or the init failed then reset the csc.</span>
01342         <span class="comment">//</span>
01343 
01344         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01345 
01346             <span class="keywordflow">if</span> (StartCsc == FLUSH_CSC ) {
01347 
01348                 <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_DISCONNECTED) == 0) {
01349 
01350                     <span class="comment">//</span>
01351                     <span class="comment">// CSC may have lost the pin information.</span>
01352                     <span class="comment">//</span>
01353 
01354                     status = IopResetCsc( buffer );
01355 
01356                     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01357                         KdPrint((<span class="stringliteral">"IopStartNetworkForRemoteBoot: reset of Csc failed %x\n"</span>, status));
01358                     }
01359                 } <span class="keywordflow">else</span> {
01360                     IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01361                 }
01362             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o33">Flags</a> &amp; SETUPBLK_FLAGS_PIN_NET_DRIVER) &amp;&amp;
01363                        (LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)) {
01364 
01365                 <span class="comment">//</span>
01366                 <span class="comment">// if we are connected and we're not repinning all files and</span>
01367                 <span class="comment">// we have a new net card driver to pin, then pin it below</span>
01368                 <span class="comment">// after we've created called IopAssignNetworkDriveLetter</span>
01369                 <span class="comment">//</span>
01370 
01371                 pinNetDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01372             }
01373         }
01374 
01375         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01376             KdPrint((<span class="stringliteral">"IopStartNetworkForRemoteBoot: initialization of Csc failed %x\n"</span>, status));
01377             IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01378             SharedUserData-&gt;SystemFlags |= SYSTEM_FLAG_DISKLESS_CLIENT;
01379         }
01380 
01381     } <span class="keywordflow">else</span> {
01382         IoCscInitializationFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01383         SharedUserData-&gt;SystemFlags |= SYSTEM_FLAG_DISKLESS_CLIENT;
01384     }
01385 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01386 <span class="preprocessor"></span>
01387     <a class="code" href="../../d4/d6/netboot_8c.html#a12">IopAssignNetworkDriveLetter</a>(LoaderBlock);
01388 
01389 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01390 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pinNetDriver) {
01391 
01392         <span class="comment">//</span>
01393         <span class="comment">//  Pin the new net card driver simply by opening it.  if it</span>
01394         <span class="comment">//  fails, it's not fatal, as we'll eventually pin it since</span>
01395         <span class="comment">//  the directory it's in is marked as system/inherit.</span>
01396         <span class="comment">//</span>
01397 
01398         HANDLE driverHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01399         PWCHAR fullDriverName;
01400 
01401         fullDriverName = (PWCHAR) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01402                             NonPagedPool,
01403                             <span class="keyword">sizeof</span>( L<span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\"</span> ) +
01404                             <span class="keyword">sizeof</span>( LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a> ),
01405                             'bRoI'
01406                             );
01407 
01408         <span class="keywordflow">if</span> (fullDriverName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01409 
01410             wcscpy(fullDriverName, L<span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\"</span>);
01411             wcscat(fullDriverName, LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o27">NetbootCardDriverName</a>);
01412 
01413             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, fullDriverName );
01414 
01415             InitializeObjectAttributes(
01416                 &amp;objectAttributes,
01417                 &amp;string,
01418                 OBJ_CASE_INSENSITIVE,
01419                 NULL,
01420                 NULL
01421                 );
01422 
01423             status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
01424                         &amp;driverHandle,
01425                         GENERIC_READ,
01426                         &amp;objectAttributes,
01427                         &amp;ioStatusBlock,
01428                         NULL,
01429                         FILE_ATTRIBUTE_NORMAL,
01430                         FILE_SHARE_READ,
01431                         FILE_OPEN,
01432                         FILE_SYNCHRONOUS_IO_NONALERT,
01433                         NULL,
01434                         0
01435                         );
01436             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01437 
01438                 <span class="comment">//</span>
01439                 <span class="comment">//  this is not a fatal error, the redir should pin it eventually</span>
01440                 <span class="comment">//</span>
01441 
01442                 KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to open new net driver: 0x%x\n"</span>, status ));
01443             }
01444             <span class="keywordflow">if</span> (driverHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( driverHandle );
01446             }
01447 
01448             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( fullDriverName );
01449 
01450         } <span class="keywordflow">else</span> {
01451 
01452             <span class="comment">//</span>
01453             <span class="comment">//  this is not a fatal error, the redir should pin it eventually</span>
01454             <span class="comment">//</span>
01455 
01456             KdPrint(( <span class="stringliteral">"IopStartNetworkForRemoteBoot: Unable to allocate buffer to pin netcard driver\n"</span> ));
01457         }
01458     }
01459 
01460     leaveRdrHandleOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01461 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01462 <span class="preprocessor"></span>
01463 cleanup:
01464 
01465     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;computerName );
01466     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;domainName );
01467 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01468 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( NetHDCSCPartition != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01469         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NetHDCSCPartition );
01470     }
01471 <span class="preprocessor">#else</span>
01472 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01473         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
01474     }
01475 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01476 <span class="preprocessor"></span>
01477     <span class="keywordflow">if</span> ( dgHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01478         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( dgHandle );
01479     }
01480 
01481 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01482 <span class="preprocessor"></span>    <span class="comment">//</span>
01483     <span class="comment">// If requested, exit with RdrHandle still set so that we can close CSC quickly.</span>
01484     <span class="comment">//</span>
01485 
01486     <span class="keywordflow">if</span> ( !leaveRdrHandleOpen &amp;&amp; (RdrHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01487         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RdrHandle );
01488         RdrHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01489     }
01490 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01491 <span class="preprocessor"></span>
01492     <span class="keywordflow">return</span> status;
01493 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="netboot.c::IopStartTcpIpForRemoteBoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopStartTcpIpForRemoteBoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l01834">1834</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00450">_SETUP_LOADER_BLOCK::IpAddress</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d2/d7/io_2create_8c-source.html#l00037">NtCreateFile()</a>, <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01862">_LOADER_PARAMETER_BLOCK::SetupLoaderBlock</a>, <a class="el" href="../../d4/d7/setupblk_8h-source.html#l00451">_SETUP_LOADER_BLOCK::SubnetMask</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>01837 {
01838     UNICODE_STRING IpString;
01839     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01840     HANDLE handle;
01841     OBJECT_ATTRIBUTES objectAttributes;
01842     IO_STATUS_BLOCK ioStatusBlock;
01843     IP_SET_ADDRESS_REQUEST IpRequest;
01844 
01845     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;IpString, DD_IP_DEVICE_NAME );
01846 
01847     InitializeObjectAttributes(
01848         &amp;objectAttributes,
01849         &amp;IpString,
01850         OBJ_CASE_INSENSITIVE,
01851         NULL,
01852         NULL
01853         );
01854 
01855     IpRequest.Context = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)2;
01856     IpRequest.Address = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o21">IpAddress</a>;
01857     IpRequest.SubnetMask = LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o18">SetupLoaderBlock</a>-&gt;<a class="code" href="../../d5/d2/struct__SETUP__LOADER__BLOCK.html#o22">SubnetMask</a>;
01858 
01859     status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
01860                 &amp;handle,
01861                 GENERIC_READ | GENERIC_WRITE,
01862                 &amp;objectAttributes,
01863                 &amp;ioStatusBlock,
01864                 NULL,
01865                 0,
01866                 FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
01867                 FILE_OPEN,
01868                 FILE_SYNCHRONOUS_IO_NONALERT,
01869                 NULL,
01870                 0
01871                 );
01872     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01873         KdPrint(( <span class="stringliteral">"IopStartTcpIpForRemoteBoot: Unable to open IP: %x\n"</span>, status ));
01874         <span class="keywordflow">goto</span> cleanup;
01875     }
01876 
01877     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
01878                 handle,
01879                 NULL,
01880                 NULL,
01881                 NULL,
01882                 &amp;ioStatusBlock,
01883                 IOCTL_IP_SET_ADDRESS_DUP,
01884                 &amp;IpRequest,
01885                 <span class="keyword">sizeof</span>(IP_SET_ADDRESS_REQUEST),
01886                 NULL,
01887                 0
01888                 );
01889 
01890     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
01891 
01892     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
01893         KdPrint(( <span class="stringliteral">"IopStartTcpIpForRemoteBoot: Unable to IOCTL IP: %x\n"</span>, status ));
01894         <span class="keywordflow">goto</span> cleanup;
01895     }
01896 
01897 cleanup:
01898 
01899     <span class="keywordflow">return</span> status;
01900 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="netboot.c::IopTCPQueryInformationEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopTCPQueryInformationEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TCPHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TDIObjectID FAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT void FAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> FAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> FAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l04377">4377</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>.
<p>
<pre class="fragment"><div>04386                    :
04387 
04388     This routine provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TDI QueryInformationEx
04389     facility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TCP/<a class="code" href="../../d9/d2/festate_8h.html#a3">IP</a> stack on NT. Someday, <span class="keyword">this</span> facility will be
04390     part of TDI.
04391 
04392 Arguments:
04393 
04394     TCPHandle     - Open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TCP driver
04395     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>            - The TDI Object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> to query
04396     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>        - Data buffer to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query results
04397     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>    - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results buffer. Filled in
04398                     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of results data on <span class="keywordflow">return</span>.
04399     Context       - Context value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query. Should be zeroed <span class="keywordflow">for</span> a
04400                     <span class="keyword">new</span> query. It will be filled with context
04401                     information <span class="keywordflow">for</span> linked enumeration queries.
04402 
04403 Return Value:
04404 
04405     An <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value.
04406 
04407 --*/
04408 
04409 {
04410     TCP_REQUEST_QUERY_INFORMATION_EX   queryBuffer;
04411     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                              queryBufferSize;
04412     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                           status;
04413     IO_STATUS_BLOCK                    ioStatusBlock;
04414 
04415 
04416     <span class="keywordflow">if</span> (TCPHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04417         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
04418     }
04419 
04420     queryBufferSize = <span class="keyword">sizeof</span>(TCP_REQUEST_QUERY_INFORMATION_EX);
04421     memcpy(&amp;(queryBuffer.ID), ID, <span class="keyword">sizeof</span>(TDIObjectID));
04422     memcpy(&amp;(queryBuffer.Context), Context, CONTEXT_SIZE);
04423 
04424     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
04425                  TCPHandle,                       <span class="comment">// Driver handle</span>
04426                  NULL,                            <span class="comment">// Event</span>
04427                  NULL,                            <span class="comment">// APC Routine</span>
04428                  NULL,                            <span class="comment">// APC context</span>
04429                  &amp;ioStatusBlock,                  <span class="comment">// Status block</span>
04430                  IOCTL_TCP_QUERY_INFORMATION_EX,  <span class="comment">// Control code</span>
04431                  &amp;queryBuffer,                    <span class="comment">// Input buffer</span>
04432                  queryBufferSize,                 <span class="comment">// Input buffer size</span>
04433                  Buffer,                          <span class="comment">// Output buffer</span>
04434                  *BufferSize                      <span class="comment">// Output buffer size</span>
04435                  );
04436 
04437     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
04438     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04439         status = ioStatusBlock.Status;
04440     }
04441 
04442     <span class="keywordflow">if</span> (status == STATUS_SUCCESS) {
04443         <span class="comment">//</span>
04444         <span class="comment">// Copy the return context to the caller's context buffer</span>
04445         <span class="comment">//</span>
04446         memcpy(Context, &amp;(queryBuffer.Context), CONTEXT_SIZE);
04447         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = (ULONG)ioStatusBlock.Information;
04448         status = ioStatusBlock.Status;
04449     } <span class="keywordflow">else</span> {
04450         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = 0;
04451     }
04452 
04453     <span class="keywordflow">return</span>(status);
04454 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="netboot.c::IopTCPSetInformationEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopTCPSetInformationEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TCPHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TDIObjectID FAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN void FAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> FAR&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l04458">4458</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>.
<p>
<pre class="fragment"><div>04466                    :
04467 
04468     This routine provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TDI SetInformationEx
04469     facility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TCP/<a class="code" href="../../d9/d2/festate_8h.html#a3">IP</a> stack on NT. Someday, <span class="keyword">this</span> facility will be
04470     part of TDI.
04471 
04472 Arguments:
04473 
04474     TCPHandle     - Open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TCP driver
04475     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>            - The TDI Object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> to set
04476     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>        - Data buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information to be set
04477     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>    - The size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set data buffer.
04478 
04479 Return Value:
04480 
04481     An <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value.
04482 
04483 --*/
04484 
04485 {
04486     PTCP_REQUEST_SET_INFORMATION_EX    setBuffer;
04487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                           status;
04488     IO_STATUS_BLOCK                    ioStatusBlock;
04489     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                              setBufferSize;
04490 
04491 
04492     <span class="keywordflow">if</span> (TCPHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04493         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
04494     }
04495 
04496     setBufferSize = FIELD_OFFSET(TCP_REQUEST_SET_INFORMATION_EX, Buffer) + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
04497 
04498     setBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, setBufferSize, 'bRoI');
04499 
04500     <span class="keywordflow">if</span> (setBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04501         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
04502     }
04503 
04504     setBuffer-&gt;BufferSize = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
04505 
04506     memcpy(&amp;(setBuffer-&gt;ID), ID, <span class="keyword">sizeof</span>(TDIObjectID));
04507 
04508     memcpy(&amp;(setBuffer-&gt;Buffer[0]), Buffer, BufferSize);
04509 
04510     status = <a class="code" href="../../d1/d7/io_2devctrl_8c.html#a0">NtDeviceIoControlFile</a>(
04511                  TCPHandle,                       <span class="comment">// Driver handle</span>
04512                  NULL,                            <span class="comment">// Event</span>
04513                  NULL,                            <span class="comment">// APC Routine</span>
04514                  NULL,                            <span class="comment">// APC context</span>
04515                  &amp;ioStatusBlock,                  <span class="comment">// Status block</span>
04516                  IOCTL_TCP_SET_INFORMATION_EX,    <span class="comment">// Control code</span>
04517                  setBuffer,                       <span class="comment">// Input buffer</span>
04518                  setBufferSize,                   <span class="comment">// Input buffer size</span>
04519                  NULL,                            <span class="comment">// Output buffer</span>
04520                  0                                <span class="comment">// Output buffer size</span>
04521                  );
04522 
04523     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( status != STATUS_PENDING );
04524     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04525         status = ioStatusBlock.Status;
04526     }
04527 
04528     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(setBuffer);
04529 
04530     <span class="keywordflow">return</span>(status);
04531 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="netboot.c::IopWriteIpAddressToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteIpAddressToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>regkey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>value</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l03974">3974</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>.
<p>
<pre class="fragment"><div>03979 {
03980     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03981     UNICODE_STRING string;
03982     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> addressA[16];
03983     WCHAR addressW[16];
03984     STRING addressStringA;
03985     UNICODE_STRING addressStringW;
03986 
03987     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, regkey );
03988 
03989     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(addressA, <span class="stringliteral">"%d.%d.%d.%d"</span>,
03990              value[0],
03991              value[1],
03992              value[2],
03993              value[3]);
03994 
03995     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;addressStringA, addressA);
03996     addressStringW.Buffer = addressW;
03997     addressStringW.MaximumLength = <span class="keyword">sizeof</span>(addressW);
03998 
03999     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;addressStringW, &amp;addressStringA, FALSE);
04000 
04001     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
04002                 handle,
04003                 &amp;string,
04004                 0,
04005                 REG_MULTI_SZ,
04006                 addressW,
04007                 addressStringW.Length + <span class="keyword">sizeof</span>(WCHAR)
04008                 );
04009     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
04010         KdPrint(( <span class="stringliteral">"IopWriteIpAddressToRegistry: Unable to set %ws value: %x\n"</span>, regkey, status ));
04011     }
04012     <span class="keywordflow">return</span> status;
04013 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a3" doxytag="netboot.c::ExpInTextModeSetup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d4/d6/netboot_8c.html#a3">ExpInTextModeSetup</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/netboot_8c-source.html#l00053">53</a> of file <a class="el" href="../../d5/d5/netboot_8c-source.html">netboot.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
