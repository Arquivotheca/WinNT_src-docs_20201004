<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: session.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>session.c</h1><a href="../../d3/d7/session_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   session.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the creation and</span>
00012 <span class="comment">    deletion of session spaces along with associated support routines.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Landy Wang (landyw) 05-Dec-1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00023 
<a name="l00024"></a><a class="code" href="../../d3/d7/session_8c.html#a2">00024</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a754">MiSessionCount</a>;
00025 
<a name="l00026"></a><a class="code" href="../../d3/d7/session_8c.html#a0">00026</a> <span class="preprocessor">#define MM_MAXIMUM_CONCURRENT_SESSIONS  16384</span>
00027 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="../../d3/d7/session_8c.html#a3">00028</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>  <a class="code" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>;
00029 
<a name="l00030"></a><a class="code" href="../../d3/d7/session_8c.html#a4">00030</a> PRTL_BITMAP <a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>;
00031 
00032 <span class="preprocessor">#if defined (_WIN64)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#define MI_SESSION_COMMIT_CHARGE 3</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00035"></a><a class="code" href="../../d3/d7/session_8c.html#a1">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_SESSION_COMMIT_CHARGE 2</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00039 <a class="code" href="../../d3/d7/session_8c.html#a5">MiSessionAddProcess</a>(
00040     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess
00041     );
00042 
00043 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00044 <a class="code" href="../../d3/d7/session_8c.html#a6">MiSessionRemoveProcess</a> (
00045     VOID
00046     );
00047 
00048 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00049 <a class="code" href="../../d3/d7/session_8c.html#a7">MiInitializeSessionIds</a> (
00050     VOID
00051     );
00052 
00053 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00054 <a class="code" href="../../d3/d7/session_8c.html#a8">MiSessionCreateInternal</a>(
00055     OUT PULONG SessionId
00056     );
00057 
00058 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00059 <a class="code" href="../../d3/d7/session_8c.html#a9">MiSessionCommitPageTables</a>(
00060     IN PVOID StartVa,
00061     IN PVOID EndVa
00062     );
00063 
00064 BOOLEAN
00065 <a class="code" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a>(
00066     VOID
00067     );
00068 
00069 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00070 <a class="code" href="../../d3/d7/session_8c.html#a11">MiSessionDeletePde</a>(
00071     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde,
00072     IN BOOLEAN WorkingSetInitialized,
00073     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> SelfMapPde
00074     );
00075 
00076 <span class="preprocessor">#if DBG</span>
00077 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00078 MiCheckSessionVirtualSpace(
00079     IN PVOID VirtualAddress,
00080     IN ULONG NumberOfBytes
00081     );
00082 <span class="preprocessor">#endif</span>
00083 <span class="preprocessor"></span>
00084 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiInitializeSessionIds)</span>
00086 <span class="preprocessor"></span>
00087 <span class="preprocessor">#pragma alloc_text(PAGE, MmSessionLeader)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, MmSessionSetUnloadAddress)</span>
00089 <span class="preprocessor"></span>
00090 <span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionAddProcess)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionRemoveProcess)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionCreateInternal)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MmSessionCreate)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MmSessionDelete)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiAttachSession)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiDetachSession)</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionCommitImagePages)</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionCommitPageTables)</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionOutSwapProcess)</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionInSwapProcess)</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionDeletePde)</span>
00102 <span class="preprocessor"></span>
00103 <span class="preprocessor">#if DBG</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiCheckSessionVirtualSpace)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00107 <span class="preprocessor"></span>
00108 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00109"></a><a class="code" href="../../d3/d7/session_8c.html#a12">00109</a> <a class="code" href="../../d3/d7/session_8c.html#a12">MmSessionLeader</a>(
00110     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00111     )
00112 
00113 <span class="comment">/*++</span>
00114 <span class="comment"></span>
00115 <span class="comment">Routine Description:</span>
00116 <span class="comment"></span>
00117 <span class="comment">    Mark the argument process as having the ability to create or delete session</span>
00118 <span class="comment">    spaces.  This is only granted to the session manager process.</span>
00119 <span class="comment"></span>
00120 <span class="comment">Arguments:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    Process - Supplies a pointer to the privileged process.</span>
00123 <span class="comment"></span>
00124 <span class="comment">Return Value:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    None.</span>
00127 <span class="comment"></span>
00128 <span class="comment">Environment:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    Kernel mode.</span>
00131 <span class="comment"></span>
00132 <span class="comment">--*/</span>
00133 
00134 {
00135     Process-&gt;Vm.u.Flags.SessionLeader = 1;
00136 }
00137 
00138 
00139 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00140"></a><a class="code" href="../../d3/d7/session_8c.html#a13">00140</a> <a class="code" href="../../d3/d7/session_8c.html#a13">MmSessionSetUnloadAddress</a> (
00141     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> pWin32KDevice
00142     )
00143 
00144 <span class="comment">/*++</span>
00145 <span class="comment"></span>
00146 <span class="comment">Routine Description:</span>
00147 <span class="comment"></span>
00148 <span class="comment">    Copy the win32k.sys driver object to the session structure for use during</span>
00149 <span class="comment">    unload.</span>
00150 <span class="comment"></span>
00151 <span class="comment">Arguments:</span>
00152 <span class="comment"></span>
00153 <span class="comment">    NewProcess - Supplies a pointer to the win32k driver object.</span>
00154 <span class="comment"></span>
00155 <span class="comment">Return Value:</span>
00156 <span class="comment"></span>
00157 <span class="comment">    None.</span>
00158 <span class="comment"></span>
00159 <span class="comment">Environment:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    Kernel mode.</span>
00162 <span class="comment"></span>
00163 <span class="comment">--*/</span>
00164 
00165 {
00166     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 1) {
00167 
00168         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00169 
00170         RtlMoveMemory (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>,
00171                        pWin32KDevice,
00172                        <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a>));
00173         }
00174 }
00175 
00176 
00177 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00178"></a><a class="code" href="../../d3/d7/session_8c.html#a5">00178</a> <a class="code" href="../../d3/d7/session_8c.html#a5">MiSessionAddProcess</a>(
00179     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess
00180     )
00181 
00182 <span class="comment">/*++</span>
00183 <span class="comment"></span>
00184 <span class="comment">Routine Description:</span>
00185 <span class="comment"></span>
00186 <span class="comment">    Add the new process to the current session space.</span>
00187 <span class="comment"></span>
00188 <span class="comment">Arguments:</span>
00189 <span class="comment"></span>
00190 <span class="comment">    NewProcess - Supplies a pointer to the process being created.</span>
00191 <span class="comment"></span>
00192 <span class="comment">Return Value:</span>
00193 <span class="comment"></span>
00194 <span class="comment">    None.</span>
00195 <span class="comment"></span>
00196 <span class="comment">Environment:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    Kernel mode, APCs disabled.</span>
00199 <span class="comment"></span>
00200 <span class="comment">--*/</span>
00201 
00202 {
00203     KIRQL OldIrql;
00204     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
00205 
00206     <span class="comment">//</span>
00207     <span class="comment">// If the calling process has no session, then the new process won't get</span>
00208     <span class="comment">// one either.</span>
00209     <span class="comment">//</span>
00210 
00211     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
00212         <span class="keywordflow">return</span>;
00213     }
00214 
00215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a302">MmIsAddressValid</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00216 
00217     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
00218 
00219     <a class="code" href="../../d4/d8/mi_8h.html#a400">LOCK_SESSION</a> (OldIrql);
00220 
00221     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> += 1;
00222 
00223     <a class="code" href="../../d4/d8/mi_8h.html#a401">UNLOCK_SESSION</a> (OldIrql);
00224 
00225 <span class="preprocessor">#if defined(_IA64_)</span>
00226 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a10">KeAddSessionSpace</a>(&amp;NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;SessionGlobal-&gt;SessionMapInfo);
00227 <span class="preprocessor">#endif</span>
00228 <span class="preprocessor"></span>
00229     <span class="comment">//</span>
00230     <span class="comment">// Link the process entry into the session space and WSL structures.</span>
00231     <span class="comment">//</span>
00232 
00233     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00234 
00235     <span class="keywordflow">if</span> (IsListEmpty(&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>)) {
00236 
00237         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00238 
00239             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.WorkingSetInserted == 0);
00240 
00241             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00242 
00243             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00244                             &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00245 
00246             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.WorkingSetInserted = 1;
00247         }
00248     }
00249 
00250     InsertTailList (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>, &amp;NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o17">SessionProcessLinks</a>);
00251 
00252     NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession = 1;
00253 
00254     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00255 }
00256 
00257 
00258 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00259"></a><a class="code" href="../../d4/d8/mi_8h.html#a986">00259</a> <a class="code" href="../../d3/d7/session_8c.html#a6">MiSessionRemoveProcess</a> (
00260     VOID
00261     )
00262 
00263 <span class="comment">/*++</span>
00264 <span class="comment"></span>
00265 <span class="comment">Routine Description:</span>
00266 <span class="comment"></span>
00267 <span class="comment">    This routine removes the current process from the current session space.</span>
00268 <span class="comment">    This may trigger a substantial round of dereferencing and resource freeing</span>
00269 <span class="comment">    if it is also the last process in the session, (holding the last image</span>
00270 <span class="comment">    in the group, etc).</span>
00271 <span class="comment"></span>
00272 <span class="comment">Arguments:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    None.</span>
00275 <span class="comment"></span>
00276 <span class="comment">Return Value:</span>
00277 <span class="comment"></span>
00278 <span class="comment">    None.</span>
00279 <span class="comment"></span>
00280 <span class="comment">Environment:</span>
00281 <span class="comment"></span>
00282 <span class="comment">    Kernel mode, APC_LEVEL and below, but queueing of APCs to this thread has</span>
00283 <span class="comment">    been permanently disabled.  This is the last thread in the process</span>
00284 <span class="comment">    being deleted.  The caller has ensured that this process is not</span>
00285 <span class="comment">    on the expansion list and therefore there can be no races in regards to</span>
00286 <span class="comment">    trimming.</span>
00287 <span class="comment"></span>
00288 <span class="comment">--*/</span>
00289 
00290 {
00291     KIRQL OldIrql;
00292     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00293 <span class="preprocessor">#if DBG</span>
00294 <span class="preprocessor"></span>    ULONG Found;
00295     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00296     PLIST_ENTRY NextEntry;
00297     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
00298 <span class="preprocessor">#endif</span>
00299 <span class="preprocessor"></span>
00300     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00301 
00302     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 0) {
00303         <span class="keywordflow">return</span>;
00304     }
00305 
00306     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a302">MmIsAddressValid</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Remove this process from the list of processes in the current session.</span>
00310     <span class="comment">//</span>
00311 
00312     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00313 
00314 <span class="preprocessor">#if DBG</span>
00315 <span class="preprocessor"></span>
00316     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
00317 
00318     Found = 0;
00319     NextEntry = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>.Flink;
00320 
00321     <span class="keywordflow">while</span> (NextEntry != &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>) {
00322         Process = CONTAINING_RECORD (NextEntry, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, SessionProcessLinks);
00323 
00324         <span class="keywordflow">if</span> (Process == CurrentProcess) {
00325             Found = 1;
00326         }
00327 
00328         NextEntry = NextEntry-&gt;Flink;
00329     }
00330 
00331     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Found == 1);
00332 
00333 <span class="preprocessor">#endif</span>
00334 <span class="preprocessor"></span>
00335     RemoveEntryList (&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o17">SessionProcessLinks</a>);
00336 
00337     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00338 
00339     <span class="comment">//</span>
00340     <span class="comment">// Decrement this process' reference count to the session.  If this</span>
00341     <span class="comment">// is the last reference, then the entire session will be destroyed</span>
00342     <span class="comment">// upon return.  This includes unloading drivers, unmapping pools,</span>
00343     <span class="comment">// freeing page tables, etc.</span>
00344     <span class="comment">//</span>
00345 
00346     <a class="code" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a> ();
00347 }
00348 
00349 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00350"></a><a class="code" href="../../d4/d8/mi_8h.html#a983">00350</a> <a class="code" href="../../d3/d7/session_8c.html#a7">MiInitializeSessionIds</a> (
00351     VOID
00352     )
00353 
00354 <span class="comment">/*++</span>
00355 <span class="comment"></span>
00356 <span class="comment">Routine Description:</span>
00357 <span class="comment"></span>
00358 <span class="comment">    This routine creates and initializes session ID allocation/deallocation.</span>
00359 <span class="comment"></span>
00360 <span class="comment">Arguments:</span>
00361 <span class="comment"></span>
00362 <span class="comment">    None.</span>
00363 <span class="comment"></span>
00364 <span class="comment">Return Value:</span>
00365 <span class="comment"></span>
00366 <span class="comment">    None.</span>
00367 <span class="comment"></span>
00368 <span class="comment">--*/</span>
00369 
00370 {
00371     <span class="comment">//</span>
00372     <span class="comment">// If this ever grows beyond the size of a page, both the allocation and</span>
00373     <span class="comment">// deletion code will need to be updated.</span>
00374     <span class="comment">//</span>
00375 
00376     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>) &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00377 
00378     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;<a class="code" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>);
00379 
00380     <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>,
00381                     <a class="code" href="../../d3/d7/session_8c.html#a0">MM_MAXIMUM_CONCURRENT_SESSIONS</a>,
00382                     <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>);
00383 
00384     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00385         <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>,
00386                         <a class="code" href="../../d3/d7/session_8c.html#a0">MM_MAXIMUM_CONCURRENT_SESSIONS</a>,
00387                         <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>);
00388     }
00389 
00390     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>);
00391 }
00392 
00393 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00394"></a><a class="code" href="../../d3/d7/session_8c.html#a8">00394</a> <a class="code" href="../../d3/d7/session_8c.html#a8">MiSessionCreateInternal</a>(
00395     OUT PULONG SessionId
00396     )
00397 
00398 <span class="comment">/*++</span>
00399 <span class="comment"></span>
00400 <span class="comment">Routine Description:</span>
00401 <span class="comment"></span>
00402 <span class="comment">    This routine creates the data structure that describes and maintains</span>
00403 <span class="comment">    the session space.  It resides at the beginning of the session space.</span>
00404 <span class="comment">    Carefully construct the first page mapping to bootstrap the fault</span>
00405 <span class="comment">    handler which relies on the session space data structure being</span>
00406 <span class="comment">    present and valid.</span>
00407 <span class="comment"></span>
00408 <span class="comment">    In 32-bit NT, this initial mapping for the portion of session space</span>
00409 <span class="comment">    mapped by the first PDE will automatically be inherited by all child</span>
00410 <span class="comment">    processes when the system copies the system portion of the page</span>
00411 <span class="comment">    directory for new address spaces.  Additional entries are faulted</span>
00412 <span class="comment">    in by the session space fault handler, which references this structure.</span>
00413 <span class="comment">    For 64-bit NT, everything is automatically inherited.</span>
00414 <span class="comment"></span>
00415 <span class="comment">    This routine commits virtual memory within the current session space with</span>
00416 <span class="comment">    backing pages.  The virtual addresses within session space are</span>
00417 <span class="comment">    allocated with a separate facility in the image management facility.</span>
00418 <span class="comment">    This is because images must be at a unique system wide virtual address.</span>
00419 <span class="comment"></span>
00420 <span class="comment">Arguments:</span>
00421 <span class="comment"></span>
00422 <span class="comment">    SessionId - Supplies a pointer to place the new session ID into.</span>
00423 <span class="comment"></span>
00424 <span class="comment">Return Value:</span>
00425 <span class="comment"></span>
00426 <span class="comment">    STATUS_SUCCESS if all went well, various failure status codes</span>
00427 <span class="comment">    if the session was not created.</span>
00428 <span class="comment"></span>
00429 <span class="comment">Environment:</span>
00430 <span class="comment"></span>
00431 <span class="comment">    Kernel mode, no mutexes held.</span>
00432 <span class="comment"></span>
00433 <span class="comment">--*/</span>
00434 
00435 {
00436     KIRQL  OldIrql;
00437     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00438     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00439     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00440     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00441     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
00442     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
00443     PFN_NUMBER ResidentPages;
00444     BOOLEAN GotCommit;
00445     BOOLEAN GotPages;
00446     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00447     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00448     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> AliasPte;
00449     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
00450     ULONG_PTR Va;
00451     PFN_NUMBER DataPage;
00452     PFN_NUMBER PageTablePage;
00453     PFN_NUMBER PageDirectoryPage;
00454     ULONG PageColor;
00455 
00456     SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00457     GotCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00458     GotPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00459 
00460     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(SessionSpace) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00461 
00462     ExAcquireFastMutex (&amp;<a class="code" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>);
00463 
00464     *SessionId = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>, 1, 0);
00465 
00466     ExReleaseFastMutex (&amp;<a class="code" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>);
00467 
00468     <span class="keywordflow">if</span> (*SessionId == 0xFFFFFFFF) {
00469 <span class="preprocessor">#if DBG</span>
00470 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No session IDs available\n"</span>);
00471 <span class="preprocessor">#endif</span>
00472 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a386">MM_SESSION_FAILURE_NO_IDS</a>);
00473         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00474     }
00475 
00476     ResidentPages = <a class="code" href="../../d3/d7/session_8c.html#a1">MI_SESSION_COMMIT_CHARGE</a>;
00477 
00478     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (ResidentPages, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00479 <span class="preprocessor">#if DBG</span>
00480 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00481             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No commit for %d pages\n"</span>,
00482                 ResidentPages);
00483         }
00484 <span class="preprocessor">#endif</span>
00485 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a387">MM_SESSION_FAILURE_NO_COMMIT</a>);
00486         <span class="keywordflow">goto</span> Failure;
00487     }
00488 
00489     GotCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00490 
00491     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a277">MM_DBG_COMMIT_SESSION_CREATE</a>, ResidentPages);
00492 
00493     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Check to make sure the physical pages are available.</span>
00497     <span class="comment">//</span>
00498 
00499     <span class="keywordflow">if</span> ((SPFN_NUMBER)(ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>) &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>()) {
00500 <span class="preprocessor">#if DBG</span>
00501 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00502             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No Resident Pages %d, Need %d\n"</span>,
00503                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a>,
00504                 ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00505         }
00506 <span class="preprocessor">#endif</span>
00507 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00508 
00509         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a388">MM_SESSION_FAILURE_NO_RESIDENT</a>);
00510         <span class="keywordflow">goto</span> Failure;
00511     }
00512 
00513     GotPages = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514 
00515     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= (ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00516 
00517     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(40, ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00518 
00519 <span class="preprocessor">#if defined (_WIN64)</span>
00520 <span class="preprocessor"></span>
00521     <span class="comment">//</span>
00522     <span class="comment">// Initialize the page directory page.</span>
00523     <span class="comment">//</span>
00524 
00525     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00526 
00527     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00528 
00529     PageDirectoryPage = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
00530     <span class="keywordflow">if</span> (PageDirectoryPage == 0) {
00531         PageDirectoryPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
00532         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00533         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageDirectoryPage, PageColor);
00534         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00535     }
00536 
00537     <span class="comment">//</span>
00538     <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
00539     <span class="comment">// is flushed when we switch to a process in a different session space.</span>
00540     <span class="comment">//</span>
00541 
00542     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00543     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryPage;
00544 
00545     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> ((PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
00546 
00547     <span class="comment">//</span>
00548     <span class="comment">// Another thread may have gotten here before us, check for that now.</span>
00549     <span class="comment">//</span>
00550 
00551     <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00552 
00553 <span class="preprocessor">#if DBG</span>
00554 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00555         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: Detected PPE %p race\n"</span>,
00556             PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00557         DbgBreakPoint ();
00558 <span class="preprocessor">#endif //DBG</span>
00559 <span class="preprocessor"></span>
00560         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryPage);
00561         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
00562         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00563         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00564         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
00565         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00566 <span class="preprocessor">#if DBG</span>
00567 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00568 <span class="preprocessor">#endif</span>
00569 <span class="preprocessor"></span>
00570         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageDirectoryPage);
00571 
00572         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += (ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00573         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(46, ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00574 
00575         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a358">MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_RACE</a>, 1);
00576 
00577         GotPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00578         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00579 
00580         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a389">MM_SESSION_FAILURE_RACE_DETECTED</a>);
00581 
00582         <span class="keywordflow">goto</span> Failure;
00583     }
00584 
00585     *PointerPpe = TempPte;
00586 
00587     <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageDirectoryPage, PointerPpe, 0);
00588     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryPage);
00589     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = 0;
00590 
00591     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageDirectoryPage)-&gt;u1.WsIndex == 0);
00592 
00593     KeFillEntryTb ((PHARDWARE_PTE) PointerPpe,
00594                    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe),
00595                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00596 <span class="preprocessor">#endif</span>
00597 <span class="preprocessor"></span>
00598     <span class="comment">//</span>
00599     <span class="comment">// Initialize the page table page.</span>
00600     <span class="comment">//</span>
00601 
00602     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00603 
00604     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00605 
00606     PageTablePage = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
00607     <span class="keywordflow">if</span> (PageTablePage == 0) {
00608         PageTablePage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
00609         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00610         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageTablePage, PageColor);
00611         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00612     }
00613 
00614     <span class="comment">//</span>
00615     <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
00616     <span class="comment">// is flushed when we switch to a process in a different session space.</span>
00617     <span class="comment">//</span>
00618 
00619     TempPte.u.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00620     TempPte.u.Hard.PageFrameNumber = PageTablePage;
00621 
00622     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
00623 
00624 <span class="preprocessor">#if !defined (_WIN64)</span>
00625 <span class="preprocessor"></span>
00626     <span class="comment">//</span>
00627     <span class="comment">// Another thread may have gotten here before us, check for that now.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00631 <span class="preprocessor">#if DBG</span>
00632 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00633         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: Detected PDE %p race\n"</span>,
00634             PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00635         DbgBreakPoint ();
00636 <span class="preprocessor">#endif //DBG</span>
00637 <span class="preprocessor"></span>
00638         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageTablePage);
00639         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
00640         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00641         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00642         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
00643         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00644 <span class="preprocessor">#if DBG</span>
00645 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00646 <span class="preprocessor">#endif</span>
00647 <span class="preprocessor"></span>
00648         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageTablePage);
00649 
00650         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += (ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00651         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(46, ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00652 
00653         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a358">MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_RACE</a>, 1);
00654 
00655         GotPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00656         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00657 
00658         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a389">MM_SESSION_FAILURE_RACE_DETECTED</a>);
00659 
00660         <span class="keywordflow">goto</span> Failure;
00661     }
00662 
00663 <span class="preprocessor">#endif</span>
00664 <span class="preprocessor"></span>
00665     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
00666 
00667     <span class="comment">//</span>
00668     <span class="comment">// This page frame references itself instead of the current (SMSS.EXE)</span>
00669     <span class="comment">// page directory as its PteFrame.  This allows the current process to</span>
00670     <span class="comment">// appear more normal (at least on 32-bit NT).  It just means we have</span>
00671     <span class="comment">// to treat this page specially during teardown.</span>
00672     <span class="comment">//</span>
00673 
00674     <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageTablePage, PointerPde, PageTablePage);
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// This page is never paged, ensure that its WsIndex stays clear so the</span>
00678     <span class="comment">// release of the page is handled correctly.</span>
00679     <span class="comment">//</span>
00680 
00681     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageTablePage)-&gt;u1.WsIndex == 0);
00682 
00683     Va = (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
00684 
00685     KeFillEntryTb ((PHARDWARE_PTE) PointerPde, (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)Va, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00686 
00687     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00688 
00689     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00690 
00691     DataPage = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
00692     <span class="keywordflow">if</span> (DataPage == 0) {
00693         DataPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
00694         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00695         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (DataPage, PageColor);
00696         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00697     }
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
00701     <span class="comment">// is flushed when we switch to a process in a different session space.</span>
00702     <span class="comment">//</span>
00703 
00704     TempPte.u.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a3">ValidKernelPteLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00705     TempPte.u.Hard.PageFrameNumber = DataPage;
00706 
00707     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
00708 
00709     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
00710 
00711     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (DataPage, PointerPte, 1);
00712 
00713     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(DataPage)-&gt;u1.WsIndex == 0);
00714 
00715     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00716 
00717     KeFillEntryTb ((PHARDWARE_PTE) PointerPte, (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00718 
00719     AliasPte = *PointerPte;
00720 
00721     <span class="comment">//</span>
00722     <span class="comment">// Initialize the new session space data structure.</span>
00723     <span class="comment">//</span>
00724 
00725     SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>;
00726 
00727     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a357">MM_DBG_SESSION_INITIAL_PAGETABLE_ALLOC</a>, 1);
00728     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a359">MM_DBG_SESSION_INITIAL_PAGE_ALLOC</a>, 1);
00729 
00730     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> = 1;
00731     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.LongFlags = 0;
00732     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a> = *SessionId;
00733     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a> = PageTablePage;
00734 
00735     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o22">Color</a> = PageColor;
00736 
00737     <span class="comment">//</span>
00738     <span class="comment">// Track the page table page and the data page.</span>
00739     <span class="comment">//</span>
00740 
00741     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> = ResidentPages;
00742     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> = ResidentPages;
00743 
00744 <span class="preprocessor">#if defined (_WIN64)</span>
00745 <span class="preprocessor"></span>
00746     <span class="comment">//</span>
00747     <span class="comment">// Initialize the session data page directory entry so trimmers can attach.</span>
00748     <span class="comment">//</span>
00749 
00750     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> ((PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
00751     SessionSpace-&gt;PageDirectory = *PointerPpe;
00752 
00753 <span class="preprocessor">#else</span>
00754 <span class="preprocessor"></span>
00755     <span class="comment">//</span>
00756     <span class="comment">// Load the session data page table entry so that other processes</span>
00757     <span class="comment">// can fault in the mapping.</span>
00758     <span class="comment">//</span>
00759 
00760     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[PointerPde - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>)] = *PointerPde;
00761 
00762 <span class="preprocessor">#endif</span>
00763 <span class="preprocessor"></span>
00764     <span class="comment">//</span>
00765     <span class="comment">// Reserve a global system PTE and map the data page into it.</span>
00766     <span class="comment">//</span>
00767 
00768     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (1,
00769                                                         <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
00770                                                         0,
00771                                                         0,
00772                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00773                                                         );
00774 
00775     <span class="keywordflow">if</span> (SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00776 <span class="preprocessor">#if DBG</span>
00777 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00778             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No memory for session self-map\n"</span>);
00779         }
00780 <span class="preprocessor">#endif</span>
00781 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a390">MM_SESSION_FAILURE_NO_SYSPTES</a>);
00782         <span class="keywordflow">goto</span> Failure;
00783     }
00784 
00785     *(SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>) = AliasPte;
00786 
00787     SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>);
00788 
00789     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a>(SessionSpace);
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">// This list entry is only referenced while within the</span>
00793     <span class="comment">// session space and has session space (not global) addresses.</span>
00794     <span class="comment">//</span>
00795 
00796     InitializeListHead (&amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>);
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">// Initialize the session space pool.</span>
00800     <span class="comment">//</span>
00801 
00802     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a973">MiInitializeSessionPool</a> ();
00803 
00804     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00805 <span class="preprocessor">#if DBG</span>
00806 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00807             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No memory for session pool\n"</span>);
00808         }
00809 <span class="preprocessor">#endif</span>
00810 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> Failure;
00811     }
00812 
00813     <span class="comment">//</span>
00814     <span class="comment">// Initialize the view mapping support - note this must happen after</span>
00815     <span class="comment">// initializing session pool.</span>
00816     <span class="comment">//</span>
00817 
00818     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a779">MiInitializeSystemSpaceMap</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00819 <span class="preprocessor">#if DBG</span>
00820 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
00821             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCreateInternal: No memory for view mapping\n"</span>);
00822         }
00823 <span class="preprocessor">#endif</span>
00824 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> Failure;
00825     }
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Use the global virtual address rather than the session space virtual</span>
00829     <span class="comment">// address to set up fields that need to be globally accessible.</span>
00830     <span class="comment">//</span>
00831 
00832     InitializeListHead (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o33">WsListEntry</a>);
00833 
00834     InitializeListHead (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>);
00835 
00836     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o7">SpinLock</a>);
00837 
00838 <span class="preprocessor">#if defined(_IA64_)</span>
00839 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a5">KeEnableSessionSharing</a>(&amp;SessionGlobal-&gt;SessionMapInfo);
00840 <span class="preprocessor">#endif</span>
00841 <span class="preprocessor"></span>
00842     <span class="keywordflow">return</span> STATUS_SUCCESS;
00843 
00844 Failure:
00845 
00846     <span class="keywordflow">if</span> (GotCommit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00847         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (ResidentPages);
00848         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a305">MM_DBG_COMMIT_RETURN_SESSION_CREATE_FAILURE1</a>,
00849                          ResidentPages);
00850     }
00851 
00852     <span class="keywordflow">if</span> (GotPages == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00853 
00854 <span class="preprocessor">#if defined (_WIN64)</span>
00855 <span class="preprocessor"></span>
00856         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a350">MI_SESSION_POOL</a>);
00857 
00858         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;u.Hard.Valid != 0);
00859 
00860 <span class="preprocessor">#endif</span>
00861 <span class="preprocessor"></span>
00862         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a350">MI_SESSION_POOL</a>);
00863 
00864         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;u.Hard.Valid != 0);
00865 
00866         <span class="comment">//</span>
00867         <span class="comment">// Note that this call will acquire the session space lock, so the</span>
00868         <span class="comment">// data page better be mapped.</span>
00869         <span class="comment">//</span>
00870 
00871         <a class="code" href="../../d4/d8/mi_8h.html#a995">MiFreeSessionSpaceMap</a> ();
00872 
00873         <span class="comment">//</span>
00874         <span class="comment">// Free the initial page table page that was allocated for the</span>
00875         <span class="comment">// paged pool range (if it has been allocated at this point).</span>
00876         <span class="comment">//</span>
00877 
00878         <a class="code" href="../../d4/d8/mi_8h.html#a975">MiFreeSessionPoolBitMaps</a> ();
00879 
00880         <span class="keywordflow">if</span> (SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>) {
00881             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>,
00882                                  1,
00883                                  <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
00884             SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)0;
00885         }
00886 
00887         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00888 
00889         <span class="comment">//</span>
00890         <span class="comment">// Free the session data structure page.</span>
00891         <span class="comment">//</span>
00892 
00893         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (DataPage);
00894         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00895         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00896         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (DataPage);
00897 
00898         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>,
00899                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00900                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00901                                     (PHARDWARE_PTE)PointerPte,
00902                                     <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
00903                                     PreviousPte);
00904 
00905         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a360">MM_DBG_SESSION_INITIAL_PAGE_FREE_FAIL1</a>, 1);
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// Free the page table page.</span>
00909         <span class="comment">//</span>
00910 
00911         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageTablePage);
00912         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageTablePage == Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00913         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 2);
00914         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
00915         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00916         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageTablePage);
00917 
00918         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde),
00919                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00920                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00921                                     (PHARDWARE_PTE)PointerPde,
00922                                     <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
00923                                     PreviousPte);
00924 
00925 <span class="preprocessor">#if defined (_WIN64)</span>
00926 <span class="preprocessor"></span>
00927         <span class="comment">//</span>
00928         <span class="comment">// Free the page directory page.</span>
00929         <span class="comment">//</span>
00930 
00931         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryPage);
00932         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageDirectoryPage == Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00933         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
00934         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
00935         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00936         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageDirectoryPage);
00937 
00938         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe),
00939                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00940                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00941                                     (PHARDWARE_PTE)PointerPpe,
00942                                     <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
00943                                     PreviousPte);
00944 
00945 <span class="preprocessor">#endif</span>
00946 <span class="preprocessor"></span>
00947         <span class="comment">//</span>
00948         <span class="comment">// Now that the PDE has been zeroed, another thread in this process</span>
00949         <span class="comment">// could attempt a session create so be careful not to count on any</span>
00950         <span class="comment">// anything in this particular session.</span>
00951         <span class="comment">//</span>
00952 
00953         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += (ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00954 
00955         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a> (49, ResidentPages + <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
00956 
00957         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a361">MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_FAIL1</a>, 1);
00958 
00959         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00960     }
00961 
00962     ExAcquireFastMutex (&amp;<a class="code" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>);
00963 
00964     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>, *SessionId));
00965     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>, *SessionId, 1);
00966 
00967     ExReleaseFastMutex (&amp;<a class="code" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>);
00968 
00969     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00970 }
00971 
00972 
00973 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00974"></a><a class="code" href="../../d3/d7/session_8c.html#a14">00974</a> <a class="code" href="../../d3/d7/session_8c.html#a14">MmSessionCreate</a>(
00975     OUT PULONG SessionId
00976     )
00977 
00978 <span class="comment">/*++</span>
00979 <span class="comment"></span>
00980 <span class="comment">Routine Description:</span>
00981 <span class="comment"></span>
00982 <span class="comment">    Called from NtSetSystemInformation() to create a session space</span>
00983 <span class="comment">    in the calling process with the specified SessionId.  An error is returned</span>
00984 <span class="comment">    if the calling process already has a session Space.</span>
00985 <span class="comment"></span>
00986 <span class="comment">Arguments:</span>
00987 <span class="comment"></span>
00988 <span class="comment">    SessionId - Supplies a pointer to place the resulting session id in.</span>
00989 <span class="comment"></span>
00990 <span class="comment">Return Value:</span>
00991 <span class="comment"></span>
00992 <span class="comment">    Various NTSTATUS error codes.</span>
00993 <span class="comment"></span>
00994 <span class="comment">Environment:</span>
00995 <span class="comment"></span>
00996 <span class="comment">    Kernel mode, no mutexes held.</span>
00997 <span class="comment"></span>
00998 <span class="comment">--*/</span>
00999 
01000 {
01001     KIRQL OldIrql;
01002     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01003     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
01004 <span class="preprocessor">#if DBG</span>
01005 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
01006     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01007 <span class="preprocessor">#endif</span>
01008 <span class="preprocessor"></span>
01009     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01010         <span class="keywordflow">return</span> STATUS_INVALID_SYSTEM_SERVICE;
01011     }
01012 
01013     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01014 
01015     <span class="comment">//</span>
01016     <span class="comment">// A simple check to see if the calling process already has a session space.</span>
01017     <span class="comment">// No need to go through all this if it does.  Creation races are caught</span>
01018     <span class="comment">// below and recovered from regardless.</span>
01019     <span class="comment">//</span>
01020 
01021     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1) {
01022         <span class="keywordflow">return</span> STATUS_ALREADY_COMMITTED;
01023     }
01024 
01025     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
01026 
01027         <span class="comment">//</span>
01028         <span class="comment">// Only the session manager can create a session.</span>
01029         <span class="comment">//</span>
01030 
01031         <span class="keywordflow">return</span> STATUS_INVALID_SYSTEM_SERVICE;
01032     }
01033 
01034 <span class="preprocessor">#if DBG</span>
01035 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01036 
01037 <span class="preprocessor">#if defined (_WIN64)</span>
01038 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>))-&gt;u.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01039 <span class="preprocessor">#else</span>
01040 <span class="preprocessor"></span>    StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01041     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a351">MI_SESSION_SPACE_END</a>);
01042 
01043     <span class="keywordflow">while</span> (StartPde &lt; EndPde) {
01044         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01045         StartPde += 1;
01046     }
01047 <span class="preprocessor">#endif</span>
01048 <span class="preprocessor"></span>
01049 <span class="preprocessor">#endif</span>
01050 <span class="preprocessor"></span>
01051     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01052 
01053     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a8">MiSessionCreateInternal</a> (SessionId);
01054 
01055     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01056         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01057         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01058     }
01059 
01060     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01061 
01062     <a class="code" href="../../d4/d8/mi_8h.html#a754">MiSessionCount</a> += 1;
01063 
01064     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01065 
01066     <span class="comment">//</span>
01067     <span class="comment">// Add the session space to the working set list.</span>
01068     <span class="comment">//</span>
01069 
01070     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/wslist_8c.html#a29">MiSessionInitializeWorkingSetList</a> ();
01071 
01072     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01073         <a class="code" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a> ();
01074         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01075         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01076     }
01077 
01078     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01079 
01080     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.Initialized = 1;
01081 
01082     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01083 
01084     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession = 1;
01085 
01086     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01087 
01088     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01089 }
01090 
01091 
01092 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01093"></a><a class="code" href="../../d3/d7/session_8c.html#a15">01093</a> <a class="code" href="../../d3/d7/session_8c.html#a15">MmSessionDelete</a>(
01094     ULONG SessionId
01095     )
01096 
01097 <span class="comment">/*++</span>
01098 <span class="comment"></span>
01099 <span class="comment">Routine Description:</span>
01100 <span class="comment"></span>
01101 <span class="comment">    Called from NtSetSystemInformation() to detach from an existing</span>
01102 <span class="comment">    session space in the calling process.  An error is returned</span>
01103 <span class="comment">    if the calling process has no session Space.</span>
01104 <span class="comment"></span>
01105 <span class="comment">Arguments:</span>
01106 <span class="comment"></span>
01107 <span class="comment">    SessionId - Supplies the session id to delete.</span>
01108 <span class="comment"></span>
01109 <span class="comment">Return Value:</span>
01110 <span class="comment"></span>
01111 <span class="comment">    STATUS_SUCCESS on success, STATUS_UNABLE_TO_FREE_VM on failure.</span>
01112 <span class="comment"></span>
01113 <span class="comment">    This process will not be able to access session space anymore upon</span>
01114 <span class="comment">    a successful return.  If this is the last process in the session then</span>
01115 <span class="comment">    the entire session is torn down.</span>
01116 <span class="comment"></span>
01117 <span class="comment">Environment:</span>
01118 <span class="comment"></span>
01119 <span class="comment">    Kernel mode, no mutexes held.</span>
01120 <span class="comment"></span>
01121 <span class="comment">--*/</span>
01122 
01123 {
01124     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
01125 
01126     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01127         <span class="keywordflow">return</span> STATUS_INVALID_SYSTEM_SERVICE;
01128     }
01129 
01130     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01131 
01132     <span class="comment">//</span>
01133     <span class="comment">// See if the calling process has a session space - this must be</span>
01134     <span class="comment">// checked since we can be called via a system service.</span>
01135     <span class="comment">//</span>
01136 
01137     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 0) {
01138 <span class="preprocessor">#if DBG</span>
01139 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MmSessionDelete: Process %p not in a session\n"</span>,
01140             <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
01141         DbgBreakPoint();
01142 <span class="preprocessor">#endif</span>
01143 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_UNABLE_TO_FREE_VM;
01144     }
01145 
01146     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
01147 
01148         <span class="comment">//</span>
01149         <span class="comment">// Only the session manager can delete a session.  This is because</span>
01150         <span class="comment">// it affects the virtual mappings for all threads within the process</span>
01151         <span class="comment">// when this address space is deleted.  This is different from normal</span>
01152         <span class="comment">// VAD clearing because win32k and other drivers rely on this space.</span>
01153         <span class="comment">//</span>
01154 
01155         <span class="keywordflow">return</span> STATUS_UNABLE_TO_FREE_VM;
01156     }
01157 
01158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01159 
01160     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a> != SessionId) {
01161 <span class="preprocessor">#if DBG</span>
01162 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MmSessionDelete: Wrong SessionId! Own %d, Ask %d\n"</span>,
01163             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
01164             SessionId);
01165         DbgBreakPoint();
01166 <span class="preprocessor">#endif</span>
01167 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_UNABLE_TO_FREE_VM;
01168     }
01169 
01170     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a> ();
01171 
01172     <a class="code" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a> ();
01173 
01174     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
01175 
01176     <span class="keywordflow">return</span> STATUS_SUCCESS;
01177 }
01178 
01179 
01180 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01181"></a><a class="code" href="../../d3/d7/session_8c.html#a16">01181</a> <a class="code" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a>(
01182     IN <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal
01183     )
01184 
01185 <span class="comment">/*++</span>
01186 <span class="comment"></span>
01187 <span class="comment">Routine Description:</span>
01188 <span class="comment"></span>
01189 <span class="comment">    Attaches to the specified session space.</span>
01190 <span class="comment"></span>
01191 <span class="comment">Arguments:</span>
01192 <span class="comment"></span>
01193 <span class="comment">    SessionGlobal - Supplies a pointer to the session to attach to.</span>
01194 <span class="comment"></span>
01195 <span class="comment">Return Value:</span>
01196 <span class="comment"></span>
01197 <span class="comment">    None.</span>
01198 <span class="comment"></span>
01199 <span class="comment">Environment:</span>
01200 <span class="comment"></span>
01201 <span class="comment">    Kernel mode.  No locks held.  Current process must not have a session</span>
01202 <span class="comment">    space - ie: the caller should be the system process or smss.exe.</span>
01203 <span class="comment"></span>
01204 <span class="comment">--*/</span>
01205 
01206 {
01207     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01208 <span class="preprocessor">#if DBG</span>
01209 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01210 
01211     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01212 
01213     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0);
01214 
01215 <span class="preprocessor">#if defined (_WIN64)</span>
01216 <span class="preprocessor"></span>
01217     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01218     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01219 
01220 <span class="preprocessor">#else</span>
01221 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01222     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a351">MI_SESSION_SPACE_END</a>);
01223 
01224     <span class="keywordflow">while</span> (PointerPde &lt; EndPde) {
01225         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01226         PointerPde += 1;
01227     }
01228 <span class="preprocessor">#endif</span>
01229 <span class="preprocessor"></span>
01230 <span class="preprocessor">#endif</span>
01231 <span class="preprocessor"></span>
01232 <span class="preprocessor">#if defined (_WIN64)</span>
01233 <span class="preprocessor"></span>
01234     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01235     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, SessionGlobal-&gt;PageDirectory);
01236 
01237 <span class="preprocessor">#else</span>
01238 <span class="preprocessor"></span>
01239     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01240 
01241     RtlCopyMemory (PointerPde,
01242                    &amp;SessionGlobal-&gt;PageTables[0],
01243                    <a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a> * sizeof (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01244 <span class="preprocessor">#endif</span>
01245 <span class="preprocessor"></span>
01246 <span class="preprocessor">#if defined(_IA64_)</span>
01247 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a7">KeAttachSessionSpace</a>(&amp;SessionGlobal-&gt;SessionMapInfo);
01248 <span class="preprocessor">#endif</span>
01249 <span class="preprocessor"></span>}
01250 
01251 
01252 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01253"></a><a class="code" href="../../d3/d7/session_8c.html#a17">01253</a> <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a>(
01254     VOID
01255     )
01256 
01257 <span class="comment">/*++</span>
01258 <span class="comment"></span>
01259 <span class="comment">Routine Description:</span>
01260 <span class="comment"></span>
01261 <span class="comment">    Detaches from the specified session space.</span>
01262 <span class="comment"></span>
01263 <span class="comment">Arguments:</span>
01264 <span class="comment"></span>
01265 <span class="comment">    None.</span>
01266 <span class="comment"></span>
01267 <span class="comment">Return Value:</span>
01268 <span class="comment"></span>
01269 <span class="comment">    None.</span>
01270 <span class="comment"></span>
01271 <span class="comment">Environment:</span>
01272 <span class="comment"></span>
01273 <span class="comment">    Kernel mode.  No locks held.  Current process must not have a session</span>
01274 <span class="comment">    space to return to - ie: this should be the system process.</span>
01275 <span class="comment"></span>
01276 <span class="comment">--*/</span>
01277 
01278 {
01279     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01280     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01281     KIRQL OldIrql;
01282 
01283     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01284 
01285     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0);
01286     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01287 
01288 <span class="preprocessor">#if defined (_WIN64)</span>
01289 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01290     PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01291 <span class="preprocessor">#else</span>
01292 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01293 
01294     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a351">MI_SESSION_SPACE_END</a>);
01295 
01296     RtlZeroMemory (PointerPde, <a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a> * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01297 <span class="preprocessor">#endif</span>
01298 <span class="preprocessor"></span>
01299     <a class="code" href="../../d4/d8/mi_8h.html#a397">MI_FLUSH_SESSION_TB</a> (OldIrql);
01300 
01301 <span class="preprocessor">#if defined(_IA64_)</span>
01302 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a9">KeDetachSessionSpace</a>();
01303 <span class="preprocessor">#endif</span>
01304 <span class="preprocessor"></span>}
01305 
01306 <span class="preprocessor">#if DBG</span>
01307 <span class="preprocessor"></span>
01308 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01309 MiCheckSessionVirtualSpace(
01310     IN PVOID VirtualAddress,
01311     IN ULONG NumberOfBytes
01312     )
01313 
01314 <span class="comment">/*++</span>
01315 <span class="comment"></span>
01316 <span class="comment">Routine Description:</span>
01317 <span class="comment"></span>
01318 <span class="comment">    Used to verify that no drivers fail to clean up their session allocations.</span>
01319 <span class="comment"></span>
01320 <span class="comment">Arguments:</span>
01321 <span class="comment"></span>
01322 <span class="comment">    VirtualAddress - Supplies the starting virtual address to check.</span>
01323 <span class="comment"></span>
01324 <span class="comment">    NumberOfBytes - Supplies the number of bytes to check.</span>
01325 <span class="comment"></span>
01326 <span class="comment">Return Value:</span>
01327 <span class="comment"></span>
01328 <span class="comment">    TRUE if all the PTEs have been freed, FALSE if not.</span>
01329 <span class="comment"></span>
01330 <span class="comment">Environment:</span>
01331 <span class="comment"></span>
01332 <span class="comment">    Kernel mode.  APCs disabled.</span>
01333 <span class="comment"></span>
01334 <span class="comment">--*/</span>
01335 
01336 {
01337     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
01338     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01339     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
01340     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
01341     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01342 
01343     <span class="comment">//</span>
01344     <span class="comment">// Check the specified region.  Everything should have been cleaned up</span>
01345     <span class="comment">// already.</span>
01346     <span class="comment">//</span>
01347 
01348 <span class="preprocessor">#if defined (_WIN64)</span>
01349 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiGetPpeAddress (VirtualAddress)-&gt;u.Hard.Valid == 1);
01350 <span class="preprocessor">#endif</span>
01351 <span class="preprocessor"></span>
01352     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (VirtualAddress);
01353     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)((PCHAR)VirtualAddress + NumberOfBytes - 1));
01354 
01355     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
01356     EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PCHAR)VirtualAddress + NumberOfBytes - 1));
01357 
01358     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG)(StartPde - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase));
01359 
01360 <span class="preprocessor">#if defined (_WIN64)</span>
01361 <span class="preprocessor"></span>    <span class="keywordflow">while</span> (StartPde &lt;= EndPde &amp;&amp; StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0)
01362 <span class="preprocessor">#else</span>
01363 <span class="preprocessor"></span>    <span class="keywordflow">while</span> (StartPde &lt;= EndPde &amp;&amp; <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0)
01364 <span class="preprocessor">#endif</span>
01365 <span class="preprocessor"></span>    {
01366         StartPde += 1;
01367         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01368         StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
01369     }
01370 
01371     <span class="keywordflow">while</span> (StartPte &lt;= EndPte) {
01372 
01373         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPte)) {
01374 
01375             StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartPte);
01376             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG)(StartPde - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase));
01377 
01378 <span class="preprocessor">#if defined (_WIN64)</span>
01379 <span class="preprocessor"></span>            <span class="keywordflow">while</span> (StartPde &lt;= EndPde &amp;&amp; StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0)
01380 <span class="preprocessor">#else</span>
01381 <span class="preprocessor"></span>            <span class="keywordflow">while</span> (StartPde &lt;= EndPde &amp;&amp; <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0)
01382 <span class="preprocessor">#endif</span>
01383 <span class="preprocessor"></span>            {
01384                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01385                 StartPde += 1;
01386                 StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
01387             }
01388             <span class="keywordflow">if</span> (StartPde &gt; EndPde) {
01389                 <span class="keywordflow">break</span>;
01390             }
01391         }
01392 
01393         <span class="keywordflow">if</span> (StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0 &amp;&amp; StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>) {
01394             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiCheckSessionVirtualSpace: StartPte 0x%p is still valid! 0x%p, VA 0x%p\n"</span>,
01395                 StartPte,
01396                 StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
01397                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(StartPte));
01398 
01399             DbgBreakPoint();
01400         }
01401         StartPte += 1;
01402     }
01403 }
01404 <span class="preprocessor">#endif</span>
01405 <span class="preprocessor"></span>
01406 
01407 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01408"></a><a class="code" href="../../d3/d7/session_8c.html#a11">01408</a> <a class="code" href="../../d3/d7/session_8c.html#a11">MiSessionDeletePde</a>(
01409     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde,
01410     IN BOOLEAN WorkingSetInitialized,
01411     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> SelfMapPde
01412     )
01413 
01414 <span class="comment">/*++</span>
01415 <span class="comment"></span>
01416 <span class="comment">Routine Description:</span>
01417 <span class="comment"></span>
01418 <span class="comment">    Used to delete a page directory entry from a session space.</span>
01419 <span class="comment"></span>
01420 <span class="comment">Arguments:</span>
01421 <span class="comment"></span>
01422 <span class="comment">    Pde - Supplies the page directory entry to delete.</span>
01423 <span class="comment"></span>
01424 <span class="comment">    WorkingSetInitialized - Supplies TRUE if the working set has been</span>
01425 <span class="comment">                            initialized.</span>
01426 <span class="comment"></span>
01427 <span class="comment">    SelfMapPde - Supplies the page directory entry that contains the self map</span>
01428 <span class="comment">                 session page.</span>
01429 <span class="comment"></span>
01430 <span class="comment"></span>
01431 <span class="comment">Return Value:</span>
01432 <span class="comment"></span>
01433 <span class="comment">    None.</span>
01434 <span class="comment"></span>
01435 <span class="comment">Environment:</span>
01436 <span class="comment"></span>
01437 <span class="comment">    Kernel mode.  PFN lock held.</span>
01438 <span class="comment"></span>
01439 <span class="comment">--*/</span>
01440 
01441 {
01442     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01443     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01444     KIRQL OldIrql2;
01445     PFN_NUMBER PageFrameIndex;
01446     BOOLEAN SelfMapPage;
01447 <span class="preprocessor">#if DBG</span>
01448 <span class="preprocessor"></span>    ULONG i;
01449     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01450 <span class="preprocessor">#endif</span>
01451 <span class="preprocessor"></span>
01452     <span class="keywordflow">if</span> (Pde-&gt;u.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01453         <span class="keywordflow">return</span>;
01454     }
01455 
01456     SelfMapPage = (Pde == SelfMapPde ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01457 
01458     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pde-&gt;u.Hard.Valid == 1);
01459 
01460     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (Pde);
01461     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01462 
01463 <span class="preprocessor">#if DBG</span>
01464 <span class="preprocessor"></span>
01465     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageFrameIndex &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>);
01466 
01467     <span class="keywordflow">if</span> (WorkingSetInitialized == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01468         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
01469     }
01470 
01471     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0);
01472     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
01473     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>);
01474 
01475     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01476 
01477     <span class="comment">//</span>
01478     <span class="comment">// Verify the containing page table is still the page</span>
01479     <span class="comment">// table page mapping the session data structure.</span>
01480     <span class="comment">//</span>
01481 
01482     <span class="keywordflow">if</span> (SelfMapPage == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01483 
01484         <span class="comment">//</span>
01485         <span class="comment">// Note these ASSERTs will fail if win32k leaks pool.</span>
01486         <span class="comment">//</span>
01487 
01488         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
01489 <span class="preprocessor">#if !defined (_WIN64)</span>
01490 <span class="preprocessor"></span>
01491         <span class="comment">//</span>
01492         <span class="comment">// 32-bit NT points the additional page tables at the master.</span>
01493         <span class="comment">// 64-bit NT doesn't need to use this trick as there is always</span>
01494         <span class="comment">// an additional hierarchy level.</span>
01495         <span class="comment">//</span>
01496 
01497         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (SelfMapPde));
01498 <span class="preprocessor">#endif</span>
01499 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt; 2);
01500     }
01501     <span class="keywordflow">else</span> {
01502         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1 == Pfn2);
01503         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 2);
01504     }
01505 
01506     <span class="comment">//</span>
01507     <span class="comment">// Make sure the page table page is zeroed.  It should always be zero</span>
01508     <span class="comment">// unless win32k leaks pool or random bits get set.</span>
01509     <span class="comment">//</span>
01510 
01511     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01512 
01513     i = 0;
01514     <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>) {
01515         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0 &amp;&amp; PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>) {
01516             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: Deleting session page table: Index %d PTE %p is not zero! %p\n"</span>,
01517                 i,
01518                 PointerPte,
01519                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01520             DbgBreakPoint();
01521         }
01522         PointerPte += 1;
01523         i += 1;
01524     }
01525 
01526     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01527 
01528 <span class="preprocessor">#endif // DBG</span>
01529 <span class="preprocessor"></span>
01530     <span class="keywordflow">if</span> (SelfMapPage == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01531         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01532     }
01533     <span class="keywordflow">else</span> {
01534         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1 == Pfn2);
01535         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 2);
01536         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
01537     }
01538 
01539     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01540     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01541 }
01542 
01543 BOOLEAN
<a name="l01544"></a><a class="code" href="../../d3/d7/session_8c.html#a10">01544</a> <a class="code" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a>(
01545     VOID
01546     )
01547 
01548 <span class="comment">/*++</span>
01549 <span class="comment"></span>
01550 <span class="comment">Routine Description:</span>
01551 <span class="comment"></span>
01552 <span class="comment">    Decrement this process' reference count to the session, unmapping access</span>
01553 <span class="comment">    to the session for the current process.  If this is the last process</span>
01554 <span class="comment">    reference to this session, then the entire session will be destroyed upon</span>
01555 <span class="comment">    return.  This includes unloading drivers, unmapping pools, freeing</span>
01556 <span class="comment">    page tables, etc.</span>
01557 <span class="comment"></span>
01558 <span class="comment">Arguments:</span>
01559 <span class="comment"></span>
01560 <span class="comment">    None.</span>
01561 <span class="comment"></span>
01562 <span class="comment">Return Value:</span>
01563 <span class="comment"></span>
01564 <span class="comment">    TRUE if the session was deleted, FALSE if only this process' access to</span>
01565 <span class="comment">    the session was deleted.</span>
01566 <span class="comment"></span>
01567 <span class="comment">Environment:</span>
01568 <span class="comment"></span>
01569 <span class="comment">    Kernel mode, no mutexes held, APCs disabled.</span>
01570 <span class="comment"></span>
01571 <span class="comment">--*/</span>
01572 
01573 {
01574     KIRQL OldIrql;
01575     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01576     ULONG CountReleased;
01577     ULONG SessionId;
01578     PFN_NUMBER PageFrameIndex;
01579     ULONG SessionDataPdeIndex;
01580     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01581     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
01582     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01583     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01584     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01585     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
01586     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> GlobalPteEntrySave;
01587     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
01588     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01589     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
01590     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> SavePageTables[<a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>];
01591     BOOLEAN WorkingSetWasInitialized;
01592     ULONG AttachCount;
01593     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01594 
01595     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 1) ||
01596             ((<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.Initialized == 0) &amp;&amp; (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.SessionLeader == 1) &amp;&amp; (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1)));
01597 
01598     SessionId = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>;
01599 
01600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>, SessionId));
01601 
01602     <a class="code" href="../../d4/d8/mi_8h.html#a400">LOCK_SESSION</a> (OldIrql);
01603 
01604     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> &gt; 1) {
01605 
01606         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> -= 1;
01607 
01608         <a class="code" href="../../d4/d8/mi_8h.html#a401">UNLOCK_SESSION</a> (OldIrql);
01609 
01610         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01611 
01612         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01613 
01614         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession = 0;
01615 
01616         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01617 
01618         <span class="comment">//</span>
01619         <span class="comment">// Don't delete any non-smss session space mappings here.  Let them</span>
01620         <span class="comment">// live on through process death.  This handles the case where</span>
01621         <span class="comment">// MmDispatchWin32Callout picks csrss - csrss has exited as it's not</span>
01622         <span class="comment">// the last process (smss is).  smss is simultaneously detaching from</span>
01623         <span class="comment">// the session and since it is the last process, it's waiting on</span>
01624         <span class="comment">// the AttachCount below.  The dispatch callout ends up in csrss but</span>
01625         <span class="comment">// has no way to synchronize against csrss exiting through this path</span>
01626         <span class="comment">// as the object reference count doesn't stop it.  So leave the</span>
01627         <span class="comment">// session space mappings alive so the callout can execute through</span>
01628         <span class="comment">// the remains of csrss.</span>
01629         <span class="comment">//</span>
01630         <span class="comment">// Note that when smss detaches, the address space must get cleared</span>
01631         <span class="comment">// here so that subsequent session creations by smss will succeed.</span>
01632         <span class="comment">//</span>
01633 
01634         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 1) {
01635 
01636 <span class="preprocessor">#if defined (_WIN64)</span>
01637 <span class="preprocessor"></span>            StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01638             StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01639 <span class="preprocessor">#else</span>
01640 <span class="preprocessor"></span>            StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
01641             EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a351">MI_SESSION_SPACE_END</a>);
01642             RtlZeroMemory (StartPde, (EndPde - StartPde) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01643 <span class="preprocessor">#endif</span>
01644 <span class="preprocessor"></span>
01645             <span class="comment">//</span>
01646             <span class="comment">// Flush the session space TB entries.</span>
01647             <span class="comment">//</span>
01648     
01649             <a class="code" href="../../d4/d8/mi_8h.html#a397">MI_FLUSH_SESSION_TB</a> (OldIrql);
01650         }
01651 
01652 <span class="preprocessor">#if defined(_IA64_)</span>
01653 <span class="preprocessor"></span>        <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a9">KeDetachSessionSpace</a>();
01654 <span class="preprocessor">#endif</span>
01655 <span class="preprocessor"></span>
01656         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01657     }
01658 
01659     <span class="comment">//</span>
01660     <span class="comment">// Mark it as being deleted.</span>
01661     <span class="comment">//</span>
01662 
01663     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.BeingDeleted = 1;
01664 
01665     <span class="comment">//</span>
01666     <span class="comment">// This is the final dereference.  We could be any process</span>
01667     <span class="comment">// including SMSS when a session space load fails.  Note also that</span>
01668     <span class="comment">// processes can terminate in any order as well.</span>
01669     <span class="comment">//</span>
01670 
01671     <a class="code" href="../../d4/d8/mi_8h.html#a401">UNLOCK_SESSION</a> (OldIrql);
01672 
01673     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
01674 
01675     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01676 
01677     <span class="comment">//</span>
01678     <span class="comment">// Wait for any cross-session process attaches to detach.  Refuse</span>
01679     <span class="comment">// subsequent attempts to cross-session attach so the address invalidation</span>
01680     <span class="comment">// code doesn't surprise an ongoing or subsequent attachee.</span>
01681     <span class="comment">//</span>
01682 
01683     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.DeletePending == 0);
01684 
01685     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.DeletePending = 1;
01686 
01687     AttachCount = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o27">AttachCount</a>;
01688 
01689     <span class="keywordflow">if</span> (AttachCount) {
01690 
01691         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o28">AttachEvent</a>,
01692                            NotificationEvent,
01693                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01694 
01695         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01696 
01697         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o28">AttachEvent</a>,
01698                                <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
01699                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01700                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01701                                (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01702 
01703         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01704 
01705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.DeletePending == 1);
01706         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o27">AttachCount</a> == 0);
01707     }
01708 
01709     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed) {
01710 
01711         <span class="comment">//</span>
01712         <span class="comment">// Initialize an event and put the event address</span>
01713         <span class="comment">// in the VmSupport.  When the trimming is complete,</span>
01714         <span class="comment">// this event will be set.</span>
01715         <span class="comment">//</span>
01716 
01717         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01718 
01719         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink = (PLIST_ENTRY)&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01720 
01721         <span class="comment">//</span>
01722         <span class="comment">// Release the mutex and wait for the event.</span>
01723         <span class="comment">//</span>
01724 
01725         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01726         <a class="code" href="../../d4/d8/mi_8h.html#a141">UNLOCK_EXPANSION_AND_THEN_WAIT</a> (OldIrql);
01727 
01728         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
01729                               <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
01730                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01731                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01732                               (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01733         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01734 
01735         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01736     }
01737     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.WorkingSetInserted == 1) {
01738 
01739         <span class="comment">//</span>
01740         <span class="comment">// Remove this session from the session list and the working</span>
01741         <span class="comment">// set list.</span>
01742         <span class="comment">//</span>
01743 
01744         RemoveEntryList (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
01745 
01746         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.WorkingSetInserted = 0;
01747     }
01748 
01749     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.SessionListInserted == 1) {
01750 
01751         RemoveEntryList (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o33">WsListEntry</a>);
01752 
01753         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.SessionListInserted = 0;
01754     }
01755 
01756     <a class="code" href="../../d4/d8/mi_8h.html#a754">MiSessionCount</a> -= 1;
01757 
01758     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01759 
01760 <span class="preprocessor">#if DBG</span>
01761 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.SessionLeader == 0) {
01762         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> == 0);
01763         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1);
01764     }
01765 <span class="preprocessor">#endif</span>
01766 <span class="preprocessor"></span>
01767     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(0);
01768 
01769     <span class="comment">//</span>
01770     <span class="comment">// If an unload function has been registered for WIN32K.SYS,</span>
01771     <span class="comment">// call it now before we force an unload on any modules.  WIN32K.SYS</span>
01772     <span class="comment">// is responsible for calling any other loaded modules that have</span>
01773     <span class="comment">// unload routines to be run.  Another option is to have the other</span>
01774     <span class="comment">// session drivers register a DLL initialize/uninitialize pair on load.</span>
01775     <span class="comment">//</span>
01776 
01777     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>.<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a> ) {
01778         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>.<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>);
01779     }
01780 
01781     <span class="comment">//</span>
01782     <span class="comment">// Now that all modules have had their unload routine(s)</span>
01783     <span class="comment">// called, check for pool leaks before unloading the images.</span>
01784     <span class="comment">//</span>
01785 
01786     <a class="code" href="../../d4/d8/mi_8h.html#a974">MiCheckSessionPoolAllocations</a> ();
01787 
01788     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1);
01789 
01790     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(1);
01791 
01792     <span class="comment">//</span>
01793     <span class="comment">// Destroy the view mapping structures.</span>
01794     <span class="comment">//</span>
01795 
01796     <a class="code" href="../../d4/d8/mi_8h.html#a995">MiFreeSessionSpaceMap</a> ();
01797 
01798     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(2);
01799 
01800     <span class="comment">//</span>
01801     <span class="comment">// Walk down the list of modules we have loaded dereferencing them.</span>
01802     <span class="comment">//</span>
01803     <span class="comment">// This allows us to force an unload of any kernel images loaded by</span>
01804     <span class="comment">// the session so we do not have any virtual space and paging</span>
01805     <span class="comment">// file leaks.</span>
01806     <span class="comment">//</span>
01807 
01808     <a class="code" href="../../d4/d7/sessload_8c.html#a14">MiSessionUnloadAllImages</a> ();
01809 
01810     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(3);
01811 
01812     <span class="comment">//</span>
01813     <span class="comment">// Destroy the session space bitmap structure</span>
01814     <span class="comment">//</span>
01815 
01816     <a class="code" href="../../d4/d8/mi_8h.html#a975">MiFreeSessionPoolBitMaps</a> ();
01817 
01818     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(4);
01819 
01820     <span class="comment">//</span>
01821     <span class="comment">// Reference the session space structure using its global</span>
01822     <span class="comment">// kernel PTE based address. This is to avoid deleting it out</span>
01823     <span class="comment">// from underneath ourselves.</span>
01824     <span class="comment">//</span>
01825 
01826     GlobalPteEntrySave = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>;
01827 
01828     <span class="comment">//</span>
01829     <span class="comment">// Sweep the individual regions in their proper order.</span>
01830     <span class="comment">//</span>
01831 
01832 <span class="preprocessor">#if DBG</span>
01833 <span class="preprocessor"></span>
01834     <span class="comment">//</span>
01835     <span class="comment">// Check the executable image region. All images</span>
01836     <span class="comment">// should have been unloaded by the image handler.</span>
01837     <span class="comment">//</span>
01838 
01839     MiCheckSessionVirtualSpace ((PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a347">MI_SESSION_IMAGE_START</a>,
01840                                 <a class="code" href="../../d4/d8/mi_8h.html#a335">MI_SESSION_IMAGE_SIZE</a>);
01841 <span class="preprocessor">#endif</span>
01842 <span class="preprocessor"></span>
01843     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(5);
01844 
01845 <span class="preprocessor">#if DBG</span>
01846 <span class="preprocessor"></span>
01847     <span class="comment">//</span>
01848     <span class="comment">// Check the view region. All views should have been cleaned up already.</span>
01849     <span class="comment">//</span>
01850 
01851     MiCheckSessionVirtualSpace ((PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a349">MI_SESSION_VIEW_START</a>,
01852                                 <a class="code" href="../../d4/d8/mi_8h.html#a336">MI_SESSION_VIEW_SIZE</a>);
01853 <span class="preprocessor">#endif</span>
01854 <span class="preprocessor"></span>
01855     <span class="comment">//</span>
01856     <span class="comment">// Save the page tables in the session space structure since</span>
01857     <span class="comment">// we are going to tear it down.</span>
01858     <span class="comment">//</span>
01859 
01860 <span class="preprocessor">#if defined (_WIN64)</span>
01861 <span class="preprocessor"></span>    RtlCopyMemory (SavePageTables,
01862                    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>),
01863                    <a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a> * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
01864 <span class="preprocessor">#else</span>
01865 <span class="preprocessor"></span>    RtlCopyMemory (SavePageTables,
01866                    <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>,
01867                    <a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a> * sizeof (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>));
01868 <span class="preprocessor">#endif</span>
01869 <span class="preprocessor"></span>
01870     <a class="code" href="../../d4/d8/mi_8h.html#a385">MM_SNAP_SESS_MEMORY_COUNTERS</a>(6);
01871 
01872 <span class="preprocessor">#if DBG</span>
01873 <span class="preprocessor"></span>    <span class="comment">//</span>
01874     <span class="comment">// Check everything possible before the remaining virtual address space</span>
01875     <span class="comment">// is torn down.  In this way if anything is amiss, the data can be</span>
01876     <span class="comment">// more easily examined.</span>
01877     <span class="comment">//</span>
01878 
01879     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
01880 
01881     <span class="comment">//</span>
01882     <span class="comment">// This should be greater than 1 because working set page tables are</span>
01883     <span class="comment">// using this as their parent as well.</span>
01884     <span class="comment">//</span>
01885 
01886     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt; 1);
01887 <span class="preprocessor">#endif</span>
01888 <span class="preprocessor"></span>
01889     CountReleased = 0;
01890 
01891     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.HasWsLock == 1) {
01892 
01893         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a348">MI_SESSION_SPACE_WS</a>);
01894         EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>);
01895 
01896         <span class="keywordflow">for</span> ( ; PointerPte &lt; EndPte; PointerPte += 1) {
01897 
01898             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01899 
01900                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01901                 <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a362">MM_DBG_SESSION_WS_PAGE_FREE</a>, 1);
01902 
01903                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= 1;
01904                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= 1;
01905                 CountReleased += 1;
01906             }
01907         }
01908         WorkingSetWasInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01909         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.HasWsLock = 0;
01910     }
01911     <span class="keywordflow">else</span> {
01912         WorkingSetWasInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01913     }
01914 
01915     <span class="comment">//</span>
01916     <span class="comment">// Account for the session data structure data page.  For NT64, the page</span>
01917     <span class="comment">// directory page is also accounted for here.</span>
01918     <span class="comment">//</span>
01919 
01920 <span class="preprocessor">#if defined (_WIN64)</span>
01921 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a370">MM_DBG_SESSION_INITIAL_PAGE_FREE</a>, 2);
01922     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= 2;
01923     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= 2;
01924     CountReleased += 2;
01925 <span class="preprocessor">#else</span>
01926 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a370">MM_DBG_SESSION_INITIAL_PAGE_FREE</a>, 1);
01927     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= 1;
01928     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= 1;
01929     CountReleased += 1;
01930 <span class="preprocessor">#endif</span>
01931 <span class="preprocessor"></span>
01932     <span class="comment">//</span>
01933     <span class="comment">// Account for any needed session space page tables.</span>
01934     <span class="comment">//</span>
01935 
01936     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
01937 
01938         StartPde = &amp;SavePageTables[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01939 
01940         <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01941             <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a371">MM_DBG_SESSION_PAGETABLE_FREE</a>, 1);
01942             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= 1;
01943             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= 1;
01944             CountReleased += 1;
01945         }
01946     }
01947 
01948     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> == 0);
01949 
01950     <span class="comment">//</span>
01951     <span class="comment">// Note that whenever win32k or drivers loaded by it leak pool, the</span>
01952     <span class="comment">// ASSERT below will be triggered.</span>
01953     <span class="comment">//</span>
01954 
01955     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> == 0);
01956 
01957     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CountReleased);
01958 
01959     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a306">MM_DBG_COMMIT_RETURN_SESSION_DEREFERENCE</a>, CountReleased);
01960 
01961     <span class="comment">//</span>
01962     <span class="comment">// Sweep the working set entries.</span>
01963     <span class="comment">// No more accesses to the working set or its lock are allowed.</span>
01964     <span class="comment">//</span>
01965 
01966     <span class="keywordflow">if</span> (WorkingSetWasInitialized == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01967         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>);
01968 
01969         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a348">MI_SESSION_SPACE_WS</a>);
01970         EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>);
01971 
01972         <span class="keywordflow">for</span> ( ; PointerPte &lt; EndPte; PointerPte += 1) {
01973 
01974             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01975 
01976                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01977 
01978                 <span class="comment">//</span>
01979                 <span class="comment">// Delete the page.</span>
01980                 <span class="comment">//</span>
01981 
01982                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01983 
01984                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01985 
01986                 <span class="comment">//</span>
01987                 <span class="comment">// Each page should still be locked in the session working set.</span>
01988                 <span class="comment">//</span>
01989 
01990                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01991 
01992                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
01993 
01994                 <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01995                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01996                 <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01997                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
01998 
01999                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += 1;
02000                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(52, 1);
02001 
02002                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02003             }
02004         }
02005     }
02006 
02007 <span class="preprocessor">#if defined(_IA64_)</span>
02008 <span class="preprocessor"></span>    <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a6">KeDisableSessionSharing</a>(&amp;SessionGlobal-&gt;SessionMapInfo);
02009 <span class="preprocessor">#endif</span>
02010 <span class="preprocessor"></span>
02011     <span class="comment">//</span>
02012     <span class="comment">// Now delete the session space structure itself.</span>
02013     <span class="comment">// No more accesses to MmSessionSpace after this.</span>
02014     <span class="comment">//</span>
02015 
02016     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// Delete the page.</span>
02020     <span class="comment">//</span>
02021 
02022     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
02023 
02024     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02025 
02026     <span class="comment">//</span>
02027     <span class="comment">// Make sure this page is still locked.</span>
02028     <span class="comment">//</span>
02029 
02030     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02031 
02032     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02033 
02034     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
02035 
02036     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
02037 
02038     <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
02039     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02040     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
02041     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
02042 
02043     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += CountReleased;
02044 
02045     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(53, CountReleased);
02046 
02047     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>;
02048 
02049     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(56, <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>);
02050 
02051     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02052 
02053     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
02054 
02055     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a351">MI_SESSION_SPACE_END</a>);
02056 
02057     RtlZeroMemory (StartPde, (EndPde - StartPde) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>));
02058 
02059     <span class="comment">//</span>
02060     <span class="comment">// Flush the session space TB entries.</span>
02061     <span class="comment">//</span>
02062 
02063     <a class="code" href="../../d4/d8/mi_8h.html#a397">MI_FLUSH_SESSION_TB</a> (OldIrql);
02064 
02065     <span class="comment">//</span>
02066     <span class="comment">// Free the self-map PTE.</span>
02067     <span class="comment">//</span>
02068 
02069     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (GlobalPteEntrySave, 1, <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
02070 
02071     <span class="comment">//</span>
02072     <span class="comment">// Delete page table pages.  Note that the page table page mapping the</span>
02073     <span class="comment">// session space data structure is done last so that we can apply</span>
02074     <span class="comment">// various ASSERTs in the DeletePde routine.</span>
02075     <span class="comment">//</span>
02076 
02077     SessionDataPdeIndex = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
02078 
02079     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02080 
02081     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
02082 
02083         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == SessionDataPdeIndex) {
02084 
02085             <span class="comment">//</span>
02086             <span class="comment">// The self map entry must be done last.</span>
02087             <span class="comment">//</span>
02088 
02089             <span class="keywordflow">continue</span>;
02090         }
02091 
02092         <a class="code" href="../../d3/d7/session_8c.html#a11">MiSessionDeletePde</a> (&amp;SavePageTables[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],
02093                             WorkingSetWasInitialized,
02094                             &amp;SavePageTables[SessionDataPdeIndex]);
02095     }
02096 
02097     <a class="code" href="../../d3/d7/session_8c.html#a11">MiSessionDeletePde</a> (&amp;SavePageTables[SessionDataPdeIndex],
02098                         WorkingSetWasInitialized,
02099                         &amp;SavePageTables[SessionDataPdeIndex]);
02100 
02101 <span class="preprocessor">#if defined (_WIN64)</span>
02102 <span class="preprocessor"></span>
02103     <span class="comment">//</span>
02104     <span class="comment">// Delete the session page directory page.</span>
02105     <span class="comment">//</span>
02106 
02107     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
02108     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPpe);
02109     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02110     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02111     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
02112 
02113     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>),
02114                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02115                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02116                                 (PHARDWARE_PTE)PointerPpe,
02117                                 <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
02118                                 PreviousPte);
02119 <span class="preprocessor">#endif</span>
02120 <span class="preprocessor"></span>
02121     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02122 
02123     ExAcquireFastMutex (&amp;<a class="code" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>);
02124 
02125     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>, SessionId));
02126     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (<a class="code" href="../../d3/d7/session_8c.html#a4">MiSessionIdBitmap</a>, SessionId, 1);
02127 
02128     ExReleaseFastMutex (&amp;<a class="code" href="../../d3/d7/session_8c.html#a3">MiSessionIdMutex</a>);
02129 
02130     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02131 
02132     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession = 0;
02133 
02134     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02135 
02136     <span class="comment">//</span>
02137     <span class="comment">// The session space has been deleted and all TB flushing is complete.</span>
02138     <span class="comment">//</span>
02139 
02140     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02141 }
02142 
02143 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02144"></a><a class="code" href="../../d3/d7/session_8c.html#a18">02144</a> <a class="code" href="../../d3/d7/session_8c.html#a18">MiSessionCommitImagePages</a>(
02145     IN PVOID VirtualAddress,
02146     IN SIZE_T NumberOfBytes
02147     )
02148 
02149 <span class="comment">/*++</span>
02150 <span class="comment"></span>
02151 <span class="comment">Routine Description:</span>
02152 <span class="comment"></span>
02153 <span class="comment">    This routine commits virtual memory within the current session space with</span>
02154 <span class="comment">    backing pages.  The virtual addresses within session space are</span>
02155 <span class="comment">    allocated with a separate facility in the image management facility.</span>
02156 <span class="comment">    This is because images must be at a unique system wide virtual address.</span>
02157 <span class="comment"></span>
02158 <span class="comment">Arguments:</span>
02159 <span class="comment"></span>
02160 <span class="comment">    VirtualAddress - Supplies the first virtual address to commit.</span>
02161 <span class="comment"></span>
02162 <span class="comment">    NumberOfBytes - Supplies the number of bytes to commit.</span>
02163 <span class="comment"></span>
02164 <span class="comment">Return Value:</span>
02165 <span class="comment"></span>
02166 <span class="comment">    STATUS_SUCCESS if all went well, STATUS_NO_MEMORY if the current process</span>
02167 <span class="comment">    has no session.</span>
02168 <span class="comment"></span>
02169 <span class="comment">Environment:</span>
02170 <span class="comment"></span>
02171 <span class="comment">    Kernel mode, MmSystemLoadLock held.</span>
02172 <span class="comment"></span>
02173 <span class="comment">--*/</span>
02174 
02175 {
02176     KIRQL WsIrql;
02177     KIRQL OldIrql;
02178     ULONG Color;
02179     PFN_NUMBER SizeInPages;
02180     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02181     ULONG_PTR AllocationStart;
02182     PFN_NUMBER PageFrameIndex;
02183     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02184     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte, EndPte;
02185     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02186 
02187     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
02188 
02189     <span class="keywordflow">if</span> (NumberOfBytes == 0) {
02190         <span class="keywordflow">return</span> STATUS_SUCCESS;
02191     }
02192 
02193     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02194 <span class="preprocessor">#if DBG</span>
02195 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionCommitImagePages: No session space!\n"</span>);
02196 <span class="preprocessor">#endif</span>
02197 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02198     }
02199 
02200     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)VirtualAddress % <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) == 0);
02201     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((NumberOfBytes % <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) == 0);
02202 
02203     SizeInPages = (PFN_NUMBER)(NumberOfBytes &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02204 
02205     <span class="comment">//</span>
02206     <span class="comment">// Calculate pages needed.</span>
02207     <span class="comment">//</span>
02208 
02209     AllocationStart = (ULONG_PTR)VirtualAddress;
02210 
02211     <span class="comment">//</span>
02212     <span class="comment">// Lock the session space working set.</span>
02213     <span class="comment">//</span>
02214 
02215     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a>(WsIrql);
02216 
02217     <span class="comment">//</span>
02218     <span class="comment">// Make sure we have page tables for the PTE</span>
02219     <span class="comment">// entries we must fill in the session space structure.</span>
02220     <span class="comment">//</span>
02221 
02222     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a9">MiSessionCommitPageTables</a> ((PVOID)AllocationStart,
02223                                         (PVOID)(AllocationStart + NumberOfBytes));
02224 
02225     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02226 <span class="preprocessor">#if DBG</span>
02227 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
02228             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionCommitImagePages: Could not commit pagetables, Not enough memory! MmResidentAvailablePages %d, SizeInPages %d\n"</span>,
02229                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a>,
02230                 SizeInPages);
02231         }
02232 <span class="preprocessor">#endif</span>
02233 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
02234         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02235     }
02236 
02237     <span class="comment">//</span>
02238     <span class="comment">// go into loop allocating them and placing them into the page</span>
02239     <span class="comment">// tables.</span>
02240     <span class="comment">//</span>
02241 
02242     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AllocationStart);
02243     EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AllocationStart + NumberOfBytes);
02244 
02245     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (SizeInPages, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02246         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a387">MM_SESSION_FAILURE_NO_COMMIT</a>);
02247         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
02248         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02249     }
02250 
02251     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a278">MM_DBG_COMMIT_SESSION_IMAGE_PAGES</a>, SizeInPages);
02252 
02253     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a3">ValidKernelPteLocal</a>;
02254 
02255     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02256 
02257     <span class="comment">//</span>
02258     <span class="comment">// Check to make sure the physical pages are available.</span>
02259     <span class="comment">//</span>
02260 
02261     <span class="keywordflow">if</span> ((SPFN_NUMBER)SizeInPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 20) {
02262         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02263         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (SizeInPages);
02264         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a307">MM_DBG_COMMIT_RETURN_SESSION_IMAGE_FAILURE1</a>, SizeInPages);
02265         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a388">MM_SESSION_FAILURE_NO_RESIDENT</a>);
02266         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
02267         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02268     }
02269 
02270     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= SizeInPages;
02271 
02272     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(45, SizeInPages);
02273 
02274     <span class="keywordflow">while</span> (StartPte &lt; EndPte) {
02275 
02276         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
02277 
02278         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02279 
02280         Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a126">MI_GET_PAGE_COLOR_FROM_SESSION</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
02281 
02282         PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
02283         <span class="keywordflow">if</span> (PageFrameIndex == 0) {
02284             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
02285             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02286             <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, Color);
02287             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02288         }
02289 
02290         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02291         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPte, TempPte);
02292 
02293         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02294 
02295         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02296 
02297         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, StartPte, 1);
02298 
02299         KeFillEntryTb ((PHARDWARE_PTE) StartPte, (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)AllocationStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02300 
02301         StartPte += 1;
02302         AllocationStart += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02303     }
02304 
02305     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02306 
02307     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += SizeInPages;
02308     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += SizeInPages;
02309 
02310     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a373">MM_DBG_SESSION_DRIVER_PAGES_LOCKED</a>, SizeInPages);
02311 
02312     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
02313 
02314     <span class="keywordflow">return</span> STATUS_SUCCESS;
02315 }
02316 
02317 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02318"></a><a class="code" href="../../d3/d7/session_8c.html#a9">02318</a> <a class="code" href="../../d3/d7/session_8c.html#a9">MiSessionCommitPageTables</a>(
02319     IN PVOID StartVa,
02320     IN PVOID EndVa
02321     )
02322 
02323 <span class="comment">/*++</span>
02324 <span class="comment"></span>
02325 <span class="comment">Routine Description:</span>
02326 <span class="comment"></span>
02327 <span class="comment">    Fill in page tables covering the specified virtual address range.</span>
02328 <span class="comment"></span>
02329 <span class="comment">Arguments:</span>
02330 <span class="comment"></span>
02331 <span class="comment">    StartVa - Supplies a starting virtual address.</span>
02332 <span class="comment"></span>
02333 <span class="comment">    EndVa - Supplies an ending virtual address.</span>
02334 <span class="comment"></span>
02335 <span class="comment">Return Value:</span>
02336 <span class="comment"></span>
02337 <span class="comment">    STATUS_SUCCESS on success, STATUS_NO_MEMORY on failure.</span>
02338 <span class="comment"></span>
02339 <span class="comment">Environment:</span>
02340 <span class="comment"></span>
02341 <span class="comment">    Kernel mode.  Session space working set mutex held.</span>
02342 <span class="comment"></span>
02343 <span class="comment">--*/</span>
02344 
02345 {
02346     KIRQL OldIrql;
02347     ULONG Color;
02348     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02349     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde, EndPde;
02350     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02351     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02352     ULONG Entry;
02353     ULONG SwapEntry;
02354     PFN_NUMBER SizeInPages;
02355     PFN_NUMBER PageTablePage;
02356     PVOID SessionPte;
02357     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
02358     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> SavePageTables[<a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>];
02359 
02360     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02361 
02362     <a class="code" href="../../d4/d8/mi_8h.html#a406">MM_SESSION_SPACE_WS_LOCK_ASSERT</a>();
02363 
02364     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartVa &gt;= (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>);
02365     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (EndVa &lt; (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a351">MI_SESSION_SPACE_END</a>);
02366 
02367     <span class="comment">//</span>
02368     <span class="comment">// Allocate the page table pages, loading them</span>
02369     <span class="comment">// into the current process's page directory.</span>
02370     <span class="comment">//</span>
02371 
02372     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartVa);
02373     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (EndVa);
02374     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (StartVa);
02375 
02376     SizeInPages = 0;
02377 
02378     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
02379 <span class="preprocessor">#if defined (_WIN64)</span>
02380 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)
02381 <span class="preprocessor">#else</span>
02382 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)
02383 <span class="preprocessor">#endif</span>
02384 <span class="preprocessor"></span>        {
02385             SizeInPages += 1;
02386         }
02387         StartPde += 1;
02388         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
02389     }
02390 
02391     <span class="keywordflow">if</span> (SizeInPages == 0) {
02392         <span class="keywordflow">return</span> STATUS_SUCCESS;
02393     }
02394 
02395     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (SizeInPages, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02396         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a387">MM_SESSION_FAILURE_NO_COMMIT</a>);
02397         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02398     }
02399 
02400     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a279">MM_DBG_COMMIT_SESSION_PAGETABLE_PAGES</a>, SizeInPages);
02401 
02402     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartVa);
02403     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (StartVa);
02404 
02405     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>;
02406 
02407     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02408 
02409     <span class="comment">//</span>
02410     <span class="comment">// Check to make sure the physical pages are available.</span>
02411     <span class="comment">//</span>
02412 
02413     <span class="keywordflow">if</span> ((SPFN_NUMBER)SizeInPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 20) {
02414         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02415         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (SizeInPages);
02416         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a308">MM_DBG_COMMIT_RETURN_SESSION_PAGETABLE_PAGES</a>, SizeInPages);
02417         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a388">MM_SESSION_FAILURE_NO_RESIDENT</a>);
02418         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02419     }
02420 
02421     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= SizeInPages;
02422 
02423     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a363">MM_DBG_SESSION_PAGETABLE_ALLOC</a>, SizeInPages);
02424 
02425     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(44, SizeInPages);
02426 
02427     WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
02428 
02429     RtlZeroMemory (SavePageTables, <span class="keyword">sizeof</span> (SavePageTables));
02430 
02431     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
02432 
02433 <span class="preprocessor">#if defined (_WIN64)</span>
02434 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)
02435 <span class="preprocessor">#else</span>
02436 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)
02437 <span class="preprocessor">#endif</span>
02438 <span class="preprocessor"></span>        {
02439 
02440             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02441 
02442             SavePageTables[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = 1;
02443 
02444             <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02445 
02446             Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a126">MI_GET_PAGE_COLOR_FROM_SESSION</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
02447 
02448             PageTablePage = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
02449             <span class="keywordflow">if</span> (PageTablePage == 0) {
02450                 PageTablePage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
02451                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02452                 <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageTablePage, Color);
02453                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02454             }
02455 
02456             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageTablePage;
02457             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPde, TempPte);
02458 
02459 <span class="preprocessor">#if !defined (_WIN64)</span>
02460 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = TempPte;
02461 <span class="preprocessor">#endif</span>
02462 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += 1;
02463             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += 1;
02464 
02465             <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageTablePage,
02466                                             StartPde,
02467                                             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
02468         }
02469 
02470         StartPde += 1;
02471         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
02472     }
02473 
02474     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02475 
02476     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartVa);
02477     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (StartVa);
02478 
02479     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
02480 
02481         <span class="keywordflow">if</span> (SavePageTables[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] == 1) {
02482 
02483             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02484 
02485             PageTablePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (StartPde);
02486 
02487             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageTablePage);
02488 
02489             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02490             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
02491 
02492             SessionPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
02493 
02494             <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (SessionPte,
02495                                         StartPde,
02496                                         Pfn1,
02497                                         0);
02498 
02499             Entry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (SessionPte,
02500                                   <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>,
02501                                   Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
02502 
02503             <span class="keywordflow">if</span> (Entry &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
02504 
02505                 SwapEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02506 
02507                 <span class="keywordflow">if</span> (Entry != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
02508 
02509                     <span class="comment">//</span>
02510                     <span class="comment">// Swap this entry with the one at first dynamic.</span>
02511                     <span class="comment">//</span>
02512 
02513                     <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry, SwapEntry, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
02514                 }
02515 
02516                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
02517             }
02518             <span class="keywordflow">else</span> {
02519                 SwapEntry = Entry;
02520             }
02521 
02522             <span class="comment">//</span>
02523             <span class="comment">// Indicate that the page is locked.</span>
02524             <span class="comment">//</span>
02525 
02526             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[SwapEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02527         }
02528 
02529         StartPde += 1;
02530         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
02531     }
02532 
02533     <span class="keywordflow">return</span> STATUS_SUCCESS;
02534 }
02535 
02536 <span class="preprocessor">#if DBG</span>
02537 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>_MISWAP {
02538     ULONG Flag;
02539     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02540     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> Session;
02541     ULONG OutSwapCount;
02542 } MISWAP, *PMISWAP;
02543 
02544 ULONG MiSessionInfo[4];
02545 MISWAP MiSessionSwap[0x100];
02546 ULONG  MiSwapIndex;
02547 <span class="preprocessor">#endif</span>
02548 <span class="preprocessor"></span>
02549 
02550 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02551"></a><a class="code" href="../../d3/d7/session_8c.html#a19">02551</a> <a class="code" href="../../d3/d7/session_8c.html#a19">MiSessionOutSwapProcess</a> (
02552     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02553     )
02554 
02555 <span class="comment">/*++</span>
02556 <span class="comment"></span>
02557 <span class="comment">Routine Description:</span>
02558 <span class="comment"></span>
02559 <span class="comment">    This routine notifies the containing session that the specified process is</span>
02560 <span class="comment">    being outswapped.  When all the processes within a session have been</span>
02561 <span class="comment">    outswapped, the containing session undergoes a heavy trim.</span>
02562 <span class="comment"></span>
02563 <span class="comment">Arguments:</span>
02564 <span class="comment"></span>
02565 <span class="comment">    Process - Supplies a pointer to the process that is swapped out of memory.</span>
02566 <span class="comment"></span>
02567 <span class="comment">Return Value:</span>
02568 <span class="comment"></span>
02569 <span class="comment">    None.</span>
02570 <span class="comment"></span>
02571 <span class="comment">Environment:</span>
02572 <span class="comment"></span>
02573 <span class="comment">    Kernel mode.  This routine must not enter a wait state for memory resources</span>
02574 <span class="comment">    or the system will deadlock.</span>
02575 <span class="comment"></span>
02576 <span class="comment">--*/</span>
02577 
02578 {
02579     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02580     PFN_NUMBER PdePage;
02581     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryMap;
02582     KIRQL OldIrql;
02583     PFN_NUMBER SessionPage;
02584     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
02585 <span class="preprocessor">#if DBG</span>
02586 <span class="preprocessor"></span>    ULONG InCount;
02587     ULONG OutCount;
02588     PLIST_ENTRY NextEntry;
02589 <span class="preprocessor">#endif</span>
02590 <span class="preprocessor"></span><span class="preprocessor">#if defined (_X86PAE_)</span>
02591 <span class="preprocessor"></span>    ULONG i;
02592     PPAE_ENTRY PaeVa;
02593 <span class="preprocessor">#endif</span>
02594 <span class="preprocessor"></span>
02595     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Process-&gt;Vm.u.Flags.ProcessInSession == 1);
02596 
02597     <span class="comment">//</span>
02598     <span class="comment">// smss doesn't count when we swap it before it has detached from the</span>
02599     <span class="comment">// session it is currently creating.</span>
02600     <span class="comment">//</span>
02601 
02602     <span class="keywordflow">if</span> (Process-&gt;Vm.u.Flags.SessionLeader == 1) {
02603         <span class="keywordflow">return</span>;
02604     }
02605 
02606 <span class="preprocessor">#if defined (_X86PAE_)</span>
02607 <span class="preprocessor"></span>    PaeVa = Process-&gt;PaeTop;
02608 
02609 <span class="preprocessor">#if DBG</span>
02610 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
02611         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PaeVa-&gt;PteEntry[i].u.Hard.Valid == 1);
02612     }
02613 <span class="preprocessor">#endif</span>
02614 <span class="preprocessor"></span>
02615     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PaeVa-&gt;PteEntry[MiGetPdPteOffset(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>)]);
02616 
02617 <span class="preprocessor">#else</span>
02618 <span class="preprocessor"></span>
02619     PdePage = <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process);
02620 
02621 <span class="preprocessor">#endif</span>
02622 <span class="preprocessor"></span>
02623     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02624 
02625 <span class="preprocessor">#if defined (_WIN64)</span>
02626 <span class="preprocessor"></span>    TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>)];
02627 
02628     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02629 
02630     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02631 
02632     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02633 <span class="preprocessor">#endif</span>
02634 <span class="preprocessor"></span>
02635     TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>)];
02636 
02637     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02638 
02639     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02640 
02641     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02642 
02643     TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>)];
02644 
02645     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02646 
02647     SessionPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02648 
02649     SessionGlobal = (<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>) <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> ( SessionPage,
02650                                                                 &amp;OldIrql);
02651 
02652     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>)) == SessionPage);
02653 
02654     SessionGlobal = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>;
02655 
02656     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02657 
02658     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02659 
02660     SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> += 1;
02661 
02662 <span class="preprocessor">#if DBG</span>
02663 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt; 0);
02664 
02665     InCount = 0;
02666     OutCount = 0;
02667     NextEntry = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>.Flink;
02668 
02669     <span class="keywordflow">while</span> (NextEntry != &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>) {
02670         Process = CONTAINING_RECORD (NextEntry, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, SessionProcessLinks);
02671 
02672         <span class="keywordflow">if</span> (Process-&gt;ProcessOutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02673             OutCount += 1;
02674         }
02675         <span class="keywordflow">else</span> {
02676             InCount += 1;
02677         }
02678 
02679         NextEntry = NextEntry-&gt;Flink;
02680     }
02681 
02682     <span class="keywordflow">if</span> (InCount + OutCount &gt; SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>) {
02683         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionOutSwapProcess : process count mismatch %p %x %x %x\n"</span>,
02684             SessionGlobal,
02685             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02686             InCount,
02687             OutCount);
02688         DbgBreakPoint ();
02689     }
02690 
02691     <span class="keywordflow">if</span> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> != OutCount) {
02692         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionOutSwapProcess : out count mismatch %p %x %x %x %x\n"</span>,
02693             SessionGlobal,
02694             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02695             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>,
02696             InCount,
02697             OutCount);
02698         DbgBreakPoint ();
02699     }
02700 
02701     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &lt;= SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>);
02702 
02703     MiSessionSwap[MiSwapIndex].Flag = 1;
02704     MiSessionSwap[MiSwapIndex].Process = Process;
02705     MiSessionSwap[MiSwapIndex].Session = SessionGlobal;
02706     MiSessionSwap[MiSwapIndex].OutSwapCount = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>;
02707     MiSwapIndex += 1;
02708     <span class="keywordflow">if</span> (MiSwapIndex == 0x100) {
02709         MiSwapIndex = 0;
02710     }
02711 <span class="preprocessor">#endif</span>
02712 <span class="preprocessor"></span>
02713     <span class="keywordflow">if</span> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> == SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>) {
02714         SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard = 1;
02715 <span class="preprocessor">#if DBG</span>
02716 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
02717             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Mm: Last process (%d total) just swapped out for session %d, %d pages\n"</span>,
02718                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>,
02719                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
02720                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>);
02721         }
02722         MiSessionInfo[0] += 1;
02723 <span class="preprocessor">#endif</span>
02724 <span class="preprocessor"></span>        <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o15">LastProcessSwappedOutTime</a>);
02725     }
02726 <span class="preprocessor">#if DBG</span>
02727 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
02728         MiSessionInfo[1] += 1;
02729     }
02730 <span class="preprocessor">#endif</span>
02731 <span class="preprocessor"></span>
02732     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02733 }
02734 
02735 
02736 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02737"></a><a class="code" href="../../d3/d7/session_8c.html#a20">02737</a> <a class="code" href="../../d3/d7/session_8c.html#a20">MiSessionInSwapProcess</a> (
02738     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02739     )
02740 
02741 <span class="comment">/*++</span>
02742 <span class="comment"></span>
02743 <span class="comment">Routine Description:</span>
02744 <span class="comment"></span>
02745 <span class="comment">    This routine in swaps the specified process.</span>
02746 <span class="comment"></span>
02747 <span class="comment">Arguments:</span>
02748 <span class="comment"></span>
02749 <span class="comment">    Process - Supplies a pointer to the process that is to be swapped</span>
02750 <span class="comment">        into memory.</span>
02751 <span class="comment"></span>
02752 <span class="comment">Return Value:</span>
02753 <span class="comment"></span>
02754 <span class="comment">    None.</span>
02755 <span class="comment"></span>
02756 <span class="comment">Environment:</span>
02757 <span class="comment"></span>
02758 <span class="comment">    Kernel mode.  This routine must not enter a wait state for memory resources</span>
02759 <span class="comment">    or the system will deadlock.</span>
02760 <span class="comment"></span>
02761 <span class="comment">--*/</span>
02762 
02763 {
02764     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02765     PFN_NUMBER PdePage;
02766     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryMap;
02767     KIRQL OldIrql;
02768     PFN_NUMBER SessionPage;
02769     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
02770 <span class="preprocessor">#if DBG</span>
02771 <span class="preprocessor"></span>    ULONG InCount;
02772     ULONG OutCount;
02773     PLIST_ENTRY NextEntry;
02774 <span class="preprocessor">#endif</span>
02775 <span class="preprocessor"></span><span class="preprocessor">#if defined (_X86PAE_)</span>
02776 <span class="preprocessor"></span>    ULONG i;
02777     PPAE_ENTRY PaeVa;
02778 <span class="preprocessor">#endif</span>
02779 <span class="preprocessor"></span>
02780     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Process-&gt;Vm.u.Flags.ProcessInSession == 1);
02781 
02782     <span class="comment">//</span>
02783     <span class="comment">// smss doesn't count when we catch it before it has detached from the</span>
02784     <span class="comment">// session it is currently creating.</span>
02785     <span class="comment">//</span>
02786 
02787     <span class="keywordflow">if</span> (Process-&gt;Vm.u.Flags.SessionLeader == 1) {
02788         <span class="keywordflow">return</span>;
02789     }
02790 
02791     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Process-&gt;Vm.u.Flags.ProcessInSession == 1);
02792 
02793     <span class="comment">//</span>
02794     <span class="comment">// smss doesn't count when we swap it before it has detached from the</span>
02795     <span class="comment">// session it is currently creating.</span>
02796     <span class="comment">//</span>
02797 
02798     <span class="keywordflow">if</span> (Process-&gt;Vm.u.Flags.SessionLeader == 1) {
02799         <span class="keywordflow">return</span>;
02800     }
02801 
02802 <span class="preprocessor">#if defined (_X86PAE_)</span>
02803 <span class="preprocessor"></span>    PaeVa = Process-&gt;PaeTop;
02804 
02805 <span class="preprocessor">#if DBG</span>
02806 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
02807         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PaeVa-&gt;PteEntry[i].u.Hard.Valid == 1);
02808     }
02809 <span class="preprocessor">#endif</span>
02810 <span class="preprocessor"></span>
02811     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PaeVa-&gt;PteEntry[MiGetPdPteOffset(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>)]);
02812 
02813 <span class="preprocessor">#else</span>
02814 <span class="preprocessor"></span>    PdePage = <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process);
02815 <span class="preprocessor">#endif</span>
02816 <span class="preprocessor"></span>
02817     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02818 
02819 <span class="preprocessor">#if defined (_WIN64)</span>
02820 <span class="preprocessor"></span>    TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>)];
02821 
02822     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02823 
02824     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02825 
02826     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02827 <span class="preprocessor">#endif</span>
02828 <span class="preprocessor"></span>
02829     TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>)];
02830 
02831     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02832 
02833     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02834 
02835     PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql);
02836 
02837     TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>)];
02838 
02839     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02840 
02841     SessionPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
02842 
02843     SessionGlobal = (<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>) <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (SessionPage,
02844                                                                &amp;OldIrql);
02845 
02846     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>)) == SessionPage);
02847 
02848     SessionGlobal = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>;
02849 
02850     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
02851 
02852     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02853 
02854 <span class="preprocessor">#if DBG</span>
02855 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt; 0);
02856 
02857     InCount = 0;
02858     OutCount = 0;
02859     NextEntry = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>.Flink;
02860 
02861     <span class="keywordflow">while</span> (NextEntry != &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>) {
02862         Process = CONTAINING_RECORD (NextEntry, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, SessionProcessLinks);
02863 
02864         <span class="keywordflow">if</span> (Process-&gt;ProcessOutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02865             OutCount += 1;
02866         }
02867         <span class="keywordflow">else</span> {
02868             InCount += 1;
02869         }
02870 
02871         NextEntry = NextEntry-&gt;Flink;
02872     }
02873 
02874     <span class="keywordflow">if</span> (InCount + OutCount &gt; SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>) {
02875         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionInSwapProcess : count mismatch %p %x %x %x\n"</span>,
02876             SessionGlobal,
02877             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02878             InCount,
02879             OutCount);
02880         DbgBreakPoint ();
02881     }
02882 
02883     <span class="keywordflow">if</span> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> != OutCount) {
02884         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionInSwapProcess : out count mismatch %p %x %x %x %x\n"</span>,
02885             SessionGlobal,
02886             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02887             SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>,
02888             InCount,
02889             OutCount);
02890         DbgBreakPoint ();
02891     }
02892 
02893     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &lt;= SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>);
02894 
02895     MiSessionSwap[MiSwapIndex].Flag = 2;
02896     MiSessionSwap[MiSwapIndex].Process = Process;
02897     MiSessionSwap[MiSwapIndex].Session = SessionGlobal;
02898     MiSessionSwap[MiSwapIndex].OutSwapCount = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>;
02899     MiSwapIndex += 1;
02900     <span class="keywordflow">if</span> (MiSwapIndex == 0x100) {
02901         MiSwapIndex = 0;
02902     }
02903 <span class="preprocessor">#endif</span>
02904 <span class="preprocessor"></span>
02905     <span class="keywordflow">if</span> (SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> == SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>) {
02906 <span class="preprocessor">#if DBG</span>
02907 <span class="preprocessor"></span>        MiSessionInfo[2] += 1;
02908         <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
02909             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Mm: First process (%d total) just swapped back in for session %d, %d pages\n"</span>,
02910                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>,
02911                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
02912                 SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>);
02913         }
02914 <span class="preprocessor">#endif</span>
02915 <span class="preprocessor"></span>        SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard = 0;
02916     }
02917 <span class="preprocessor">#if DBG</span>
02918 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
02919         MiSessionInfo[3] += 1;
02920     }
02921 <span class="preprocessor">#endif</span>
02922 <span class="preprocessor"></span>
02923     SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
02924 
02925     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 0);
02926 
02927     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02928 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
