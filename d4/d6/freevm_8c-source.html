<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: freevm.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>freevm.c</h1><a href="../../d3/d7/freevm_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   freevm.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the</span>
00012 <span class="comment">    NtFreeVirtualMemory service.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 22-May-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d3/d7/freevm_8c.html#a0">00025</a> <span class="preprocessor">#define MEM_CHECK_COMMIT_STATE 0x400000</span>
00026 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="../../d3/d7/freevm_8c.html#a1">00027</a> <span class="preprocessor">#define MM_VALID_PTE_SIZE (256)</span>
00028 <span class="preprocessor"></span>
00029 
<a name="l00030"></a><a class="code" href="../../d3/d7/freevm_8c.html#a2">00030</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a> = {<a class="code" href="../../d4/d8/mi_8h.html#a45">MM_DECOMMIT</a> &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a91">MM_PROTECT_FIELD_SHIFT</a>};
00031 
00032 <span class="preprocessor">#if DBG</span>
00033 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> MmWatchProcess;
00034 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> MmFooBar(VOID);
00035 <span class="preprocessor">#endif // DBG</span>
00036 <span class="preprocessor"></span><span class="comment">// #include "ntos.h"</span>
00037 
00038 
00039 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtFreeVirtualMemory)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiIsEntireRangeCommitted)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00045 <a class="code" href="../../d3/d7/freevm_8c.html#a3">MiProcessValidPteList</a> (
00046     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> *PteList,
00047     IN ULONG Count
00048     );
00049 
00050 ULONG
00051 <a class="code" href="../../d3/d7/freevm_8c.html#a4">MiDecommitPages</a> (
00052     IN PVOID StartingAddress,
00053     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndingPte,
00054     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00055     IN <a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a> Vad
00056     );
00057 
00058 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00059 <a class="code" href="../../d4/d5/procsup_8c.html#a23">MiDeleteFreeVm</a> (
00060     IN PVOID StartingAddress,
00061     IN PVOID EndingAddress
00062     );
00063 
00064 
00065 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00066"></a><a class="code" href="../../d3/d7/freevm_8c.html#a6">00066</a> <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>(
00067     IN HANDLE ProcessHandle,
00068     IN OUT PVOID *BaseAddress,
00069     IN OUT PSIZE_T RegionSize,
00070     IN ULONG FreeType
00071      )
00072 
00073 <span class="comment">/*++</span>
00074 <span class="comment"></span>
00075 <span class="comment">Routine Description:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    This function deletes a region of pages within the virtual address</span>
00078 <span class="comment">    space of a subject process.</span>
00079 <span class="comment"></span>
00080 <span class="comment">Arguments:</span>
00081 <span class="comment"></span>
00082 <span class="comment">   ProcessHandle - An open handle to a process object.</span>
00083 <span class="comment"></span>
00084 <span class="comment">   BaseAddress - The base address of the region of pages</span>
00085 <span class="comment">                 to be freed. This value is rounded down to the</span>
00086 <span class="comment">                 next host page address boundary.</span>
00087 <span class="comment"></span>
00088 <span class="comment">   RegionSize - A pointer to a variable that will receive</span>
00089 <span class="comment">                the actual size in bytes of the freed region of</span>
00090 <span class="comment">                pages. The initial value of this argument is</span>
00091 <span class="comment">                rounded up to the next host page size boundary.</span>
00092 <span class="comment"></span>
00093 <span class="comment">   FreeType - A set of flags that describe the type of</span>
00094 <span class="comment">              free that is to be performed for the specified</span>
00095 <span class="comment">              region of pages.</span>
00096 <span class="comment">        </span>
00097 <span class="comment"></span>
00098 <span class="comment">       FreeType Flags</span>
00099 <span class="comment"></span>
00100 <span class="comment"></span>
00101 <span class="comment">        MEM_DECOMMIT - The specified region of pages is to</span>
00102 <span class="comment">             be decommitted.</span>
00103 <span class="comment"></span>
00104 <span class="comment">        MEM_RELEASE - The specified region of pages is to</span>
00105 <span class="comment">             be released.</span>
00106 <span class="comment"></span>
00107 <span class="comment"></span>
00108 <span class="comment">Return Value:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    Returns the status</span>
00111 <span class="comment"></span>
00112 <span class="comment">--*/</span>
00113 
00114 {
00115     <a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a> Vad;
00116     <a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a> NewVad;
00117     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> PreviousVad;
00118     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad;
00119     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00120     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00121     PVOID StartingAddress;
00122     PVOID EndingAddress;
00123     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00124     ULONG Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00125     SIZE_T CapturedRegionSize;
00126     PVOID CapturedBase;
00127     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte;
00128     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndingPte;
00129     SIZE_T OldQuota;
00130     SIZE_T QuotaCharge;
00131     SIZE_T CommitReduction;
00132     ULONG_PTR OldEnd;
00133     LOGICAL UserPhysicalPages;
00134 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00135 <span class="preprocessor"></span>    PVOID OriginalStartingAddress;
00136     PVOID OriginalEndingAddress;
00137     BOOLEAN EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00138 <span class="preprocessor">#endif</span>
00139 <span class="preprocessor"></span>
00140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// Check to make sure FreeType is good.</span>
00144     <span class="comment">//</span>
00145 
00146     <span class="keywordflow">if</span> ((FreeType &amp; ~(MEM_DECOMMIT | MEM_RELEASE)) != 0) {
00147         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00148     }
00149 
00150     <span class="comment">//</span>
00151     <span class="comment">// One of MEM_DECOMMIT or MEM_RELEASE must be specified, but not both.</span>
00152     <span class="comment">//</span>
00153 
00154     <span class="keywordflow">if</span> (((FreeType &amp; (MEM_DECOMMIT | MEM_RELEASE)) == 0) ||
00155         ((FreeType &amp; (MEM_DECOMMIT | MEM_RELEASE)) ==
00156                             (MEM_DECOMMIT | MEM_RELEASE))) {
00157         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00158     }
00159 
00160     PreviousMode = KeGetPreviousMode();
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Establish an exception handler, probe the specified addresses</span>
00164     <span class="comment">// for write access and capture the initial values.</span>
00165     <span class="comment">//</span>
00166 
00167     <span class="keywordflow">try</span> {
00168 
00169         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00170 
00171             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> (BaseAddress);
00172             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00173         }
00174 
00175         <span class="comment">//</span>
00176         <span class="comment">// Capture the base address.</span>
00177         <span class="comment">//</span>
00178 
00179         CapturedBase = *BaseAddress;
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">// Capture the region size.</span>
00183         <span class="comment">//</span>
00184 
00185         CapturedRegionSize = *RegionSize;
00186 
00187     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00188 
00189         <span class="comment">//</span>
00190         <span class="comment">// If an exception occurs during the probe or capture</span>
00191         <span class="comment">// of the initial values, then handle the exception and</span>
00192         <span class="comment">// return the exception code as the status value.</span>
00193         <span class="comment">//</span>
00194 
00195         <span class="keywordflow">return</span> GetExceptionCode();
00196     }
00197 
00198 <span class="preprocessor">#if DBG</span>
00199 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00200         <span class="keywordflow">if</span> ( !MmWatchProcess ) {
00201             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"freevm processhandle %lx base %lx size %lx type %lx\n"</span>,
00202                     ProcessHandle, CapturedBase, CapturedRegionSize, FreeType);
00203         }
00204     }
00205 <span class="preprocessor">#endif</span>
00206 <span class="preprocessor"></span>
00207     <span class="comment">//</span>
00208     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00209     <span class="comment">// within the user part of the virtual address space.</span>
00210     <span class="comment">//</span>
00211 
00212     <span class="keywordflow">if</span> (CapturedBase &gt; MM_HIGHEST_USER_ADDRESS) {
00213 
00214         <span class="comment">//</span>
00215         <span class="comment">// Invalid base address.</span>
00216         <span class="comment">//</span>
00217 
00218         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00219     }
00220 
00221     <span class="keywordflow">if</span> ((ULONG_PTR)MM_HIGHEST_USER_ADDRESS - (ULONG_PTR)CapturedBase &lt;
00222                                                         CapturedRegionSize) {
00223 
00224         <span class="comment">//</span>
00225         <span class="comment">// Invalid region size;</span>
00226         <span class="comment">//</span>
00227 
00228         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00229 
00230     }
00231 
00232     EndingAddress = (PVOID)(((LONG_PTR)CapturedBase + CapturedRegionSize - 1) |
00233                         (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00234 
00235     StartingAddress = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(CapturedBase);
00236 
00237     <span class="keywordflow">if</span> ( ProcessHandle == NtCurrentProcess() ) {
00238         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00239     } <span class="keywordflow">else</span> {
00240         <span class="comment">//</span>
00241         <span class="comment">// Reference the specified process handle for VM_OPERATION access.</span>
00242         <span class="comment">//</span>
00243 
00244         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00245                                              PROCESS_VM_OPERATION,
00246                                              <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00247                                              PreviousMode,
00248                                              (PVOID *)&amp;Process,
00249                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00250 
00251         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00252             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00253         }
00254     }
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// If the specified process is not the current process, attach</span>
00258     <span class="comment">// to the specified process.</span>
00259     <span class="comment">//</span>
00260 
00261     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00262         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00263         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00264     }
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
00268     <span class="comment">// creating or deleting address space at the same time and</span>
00269     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
00270     <span class="comment">// be inserted and walked.  Block APCs to prevent page faults while</span>
00271     <span class="comment">// we own the working set mutex.</span>
00272     <span class="comment">//</span>
00273 
00274     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00275 
00276     <span class="comment">//</span>
00277     <span class="comment">// Make sure the address space was not deleted.</span>
00278     <span class="comment">//</span>
00279 
00280     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
00281         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00282         <span class="keywordflow">goto</span> ErrorReturn;
00283     }
00284 
00285 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00286 <span class="preprocessor"></span>
00287     <span class="keywordflow">if</span> (CapturedRegionSize != 0) {
00288         
00289         OriginalStartingAddress = (PVOID)<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a> (CapturedBase);
00290 
00291         OriginalEndingAddress = (PVOID)(((LONG_PTR)CapturedBase + CapturedRegionSize - 1) |
00292                                         (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1));
00293 
00294         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00295 
00296             EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297 
00298             <span class="comment">//</span>
00299             <span class="comment">// adjust Starting/EndingAddress for the native page size </span>
00300             <span class="comment">//</span>
00301 
00302             StartingAddress = <a class="code" href="../../d2/d9/miia64_8h.html#a232">PAGE_NEXT_ALIGN</a>(OriginalStartingAddress);
00303 
00304             EndingAddress = 
00305                 (PVOID)((ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> ((ULONG_PTR)OriginalEndingAddress + <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>) - 1);
00306 
00307             <span class="keywordflow">if</span> (StartingAddress &gt; EndingAddress) {
00308 
00309                 <span class="comment">//</span>
00310                 <span class="comment">// There is no need to free native pages</span>
00311                 <span class="comment">//</span>
00312 
00313                 <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00314         
00315                 <span class="keywordflow">goto</span> perform_free4kpages;
00316 
00317             }
00318         }
00319     }
00320         
00321 <span class="preprocessor">#endif</span>
00322 <span class="preprocessor"></span>
00323     Vad = (<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a>)<a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (StartingAddress);
00324 
00325     <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00326 
00327         <span class="comment">//</span>
00328         <span class="comment">// No Virtual Address Descriptor located for Base Address.</span>
00329         <span class="comment">//</span>
00330 
00331         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MEMORY_NOT_ALLOCATED;
00332         <span class="keywordflow">goto</span> ErrorReturn;
00333     }
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">// Found the associated Virtual Address Descriptor.</span>
00337     <span class="comment">//</span>
00338 
00339     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o1">EndingVpn</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress)) {
00340 
00341         <span class="comment">//</span>
00342         <span class="comment">// The entire range to delete is not contained within a single</span>
00343         <span class="comment">// virtual address descriptor.  Return an error.</span>
00344         <span class="comment">//</span>
00345 
00346         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_FREE_VM;
00347         <span class="keywordflow">goto</span> ErrorReturn;
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// Check to ensure this Vad is deletable.  Delete is required</span>
00352     <span class="comment">// for both decommit and release.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.PrivateMemory == 0) ||
00356         (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.PhysicalMapping == 1)) {
00357         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00358         <span class="keywordflow">goto</span> ErrorReturn;
00359     }
00360 
00361     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.NoChange == 1) {
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">// An attempt is being made to delete a secured VAD, check</span>
00365         <span class="comment">// to see if this deletion is allowed.</span>
00366         <span class="comment">//</span>
00367 
00368         <span class="keywordflow">if</span> (FreeType &amp; MEM_RELEASE) {
00369 
00370             <span class="comment">//</span>
00371             <span class="comment">// Specify the whole range, this solves the problem with</span>
00372             <span class="comment">// splitting the VAD and trying to decide where the various</span>
00373             <span class="comment">// secure ranges need to go.</span>
00374             <span class="comment">//</span>
00375 
00376             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> ((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00377                                         <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00378                         ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) +
00379                                 (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1),
00380                                         <a class="code" href="../../d4/d8/mi_8h.html#a55">MM_SECURE_DELETE_CHECK</a>);
00381 
00382         } <span class="keywordflow">else</span> {
00383             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> ((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00384                                         CapturedBase,
00385                                         CapturedRegionSize,
00386                                         <a class="code" href="../../d4/d8/mi_8h.html#a55">MM_SECURE_DELETE_CHECK</a>);
00387         }
00388         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00389             <span class="keywordflow">goto</span> ErrorReturn;
00390         }
00391     }
00392 
00393     UserPhysicalPages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00394 
00395     PreviousVad = <a class="code" href="../../d4/d8/mi_8h.html#a95">MiGetPreviousVad</a> (Vad);
00396     NextVad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (Vad);
00397     <span class="keywordflow">if</span> (FreeType &amp; MEM_RELEASE) {
00398 
00399         <span class="comment">//</span>
00400         <span class="comment">// *****************************************************************</span>
00401         <span class="comment">// MEM_RELEASE was specified.</span>
00402         <span class="comment">// *****************************************************************</span>
00403         <span class="comment">//</span>
00404 
00405         <span class="comment">//</span>
00406         <span class="comment">// The descriptor for the address range is deletable.  Remove or split</span>
00407         <span class="comment">// the descriptor.</span>
00408         <span class="comment">//</span>
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// If the region size is zero, remove the whole VAD.</span>
00412         <span class="comment">//</span>
00413 
00414         <span class="keywordflow">if</span> (CapturedRegionSize == 0) {
00415 
00416             <span class="comment">//</span>
00417             <span class="comment">// If the region size is specified as 0, the base address</span>
00418             <span class="comment">// must be the starting address for the region.</span>
00419             <span class="comment">//</span>
00420 
00421             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (CapturedBase) != Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o0">StartingVpn</a>) {
00422                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FREE_VM_NOT_AT_BASE;
00423                 <span class="keywordflow">goto</span> ErrorReturn;
00424             }
00425 
00426             <span class="comment">//</span>
00427             <span class="comment">// This Virtual Address Descriptor has been deleted.</span>
00428             <span class="comment">//</span>
00429 
00430             StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o0">StartingVpn</a>);
00431             EndingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o1">EndingVpn</a>);
00432 
00433             <span class="comment">//</span>
00434             <span class="comment">// Free all the physical pages that this VAD might be mapping.</span>
00435             <span class="comment">// Since only the AWE lock synchronizes the remap API, carefully</span>
00436             <span class="comment">// remove this VAD from the list first.</span>
00437             <span class="comment">//</span>
00438 
00439             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00440                 <a class="code" href="../../d4/d8/mi_8h.html#a893">MiPhysicalViewRemover</a> (Process, (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad);
00441                 <a class="code" href="../../d8/d5/physical_8c.html#a13">MiRemoveUserPhysicalPagesVad</a> (Vad);
00442                 UserPhysicalPages = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00443             }
00444             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.WriteWatch == 1) {
00445                 <a class="code" href="../../d4/d8/mi_8h.html#a893">MiPhysicalViewRemover</a> (Process, (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad);
00446             }
00447 
00448             <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> ((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad);
00449             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00450 
00451 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00452 <span class="preprocessor"></span>
00453             OriginalStartingAddress = StartingAddress;
00454             OriginalEndingAddress  = EndingAddress;
00455 
00456             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00457 
00458                 EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00459 
00460             } <span class="keywordflow">else</span> {
00461 
00462                 EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00463 
00464             }
00465 
00466 <span class="preprocessor">#endif</span>
00467 <span class="preprocessor"></span>
00468         } <span class="keywordflow">else</span> {
00469 
00470             <span class="comment">//</span>
00471             <span class="comment">// Region's size was not specified as zero, delete the</span>
00472             <span class="comment">// whole VAD or split the VAD.</span>
00473             <span class="comment">//</span>
00474 
00475             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress) == Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o0">StartingVpn</a>) {
00476                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress) == Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o1">EndingVpn</a>) {
00477 
00478                     <span class="comment">//</span>
00479                     <span class="comment">// This Virtual Address Descriptor has been deleted.</span>
00480                     <span class="comment">//</span>
00481 
00482                     <span class="comment">//</span>
00483                     <span class="comment">// Free all the physical pages that this VAD might be</span>
00484                     <span class="comment">// mapping.  Since only the AWE lock synchronizes the</span>
00485                     <span class="comment">// remap API, carefully remove this VAD from the list first.</span>
00486                     <span class="comment">//</span>
00487         
00488                     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00489                         <a class="code" href="../../d4/d8/mi_8h.html#a893">MiPhysicalViewRemover</a> (Process, (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad);
00490                         <a class="code" href="../../d8/d5/physical_8c.html#a13">MiRemoveUserPhysicalPagesVad</a> (Vad);
00491                         UserPhysicalPages = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00492                     }
00493                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.WriteWatch == 1) {
00494                         <a class="code" href="../../d4/d8/mi_8h.html#a893">MiPhysicalViewRemover</a> (Process, (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad);
00495                     }
00496 
00497                     <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> ((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad);
00498                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00499 
00500                 } <span class="keywordflow">else</span> {
00501 
00502                     <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) ||
00503                         (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.WriteWatch == 1)) {
00504 
00505                         <span class="comment">//</span>
00506                         <span class="comment">// Splitting or chopping a physical VAD or a write-watch</span>
00507                         <span class="comment">// VAD is not allowed.</span>
00508                         <span class="comment">//</span>
00509 
00510                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FREE_VM_NOT_AT_BASE;
00511                         <span class="keywordflow">goto</span> ErrorReturn;
00512                     }
00513 
00514                     <span class="comment">//</span>
00515                     <span class="comment">// This Virtual Address Descriptor has a new starting</span>
00516                     <span class="comment">// address.</span>
00517                     <span class="comment">//</span>
00518 
00519                     CommitReduction = <a class="code" href="../../d6/d1/mmquota_8c.html#a20">MiCalculatePageCommitment</a> (
00520                                                             StartingAddress,
00521                                                             EndingAddress,
00522                                                             (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00523                                                             Process );
00524 
00525                     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> ((PCHAR)EndingAddress + 1);
00526                     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge -= CommitReduction;
00527                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SSIZE_T)Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge &gt;= 0);
00528                     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (CommitReduction, Process);
00529                     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommitReduction);
00530                     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00531                         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (-(SSIZE_T)CommitReduction);
00532                     }
00533                     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a294">MM_DBG_COMMIT_RETURN_NTFREEVM1</a>,
00534                                      CommitReduction);
00535                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= CommitReduction;
00536                     NextVad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad;
00537                 }
00538 
00539             } <span class="keywordflow">else</span> {
00540 
00541                 <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) ||
00542                     (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.WriteWatch == 1)) {
00543 
00544                     <span class="comment">//</span>
00545                     <span class="comment">// Splitting or chopping a physical VAD or a write-watch</span>
00546                     <span class="comment">// VAD is not allowed.</span>
00547                     <span class="comment">//</span>
00548 
00549                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FREE_VM_NOT_AT_BASE;
00550                     <span class="keywordflow">goto</span> ErrorReturn;
00551                 }
00552 
00553                 <span class="comment">//</span>
00554                 <span class="comment">// Starting address is greater than start of VAD.</span>
00555                 <span class="comment">//</span>
00556 
00557                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress) == Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o1">EndingVpn</a>) {
00558 
00559                     <span class="comment">//</span>
00560                     <span class="comment">// Change the ending address of the VAD.</span>
00561                     <span class="comment">//</span>
00562 
00563                     CommitReduction = <a class="code" href="../../d6/d1/mmquota_8c.html#a20">MiCalculatePageCommitment</a> (
00564                                                             StartingAddress,
00565                                                             EndingAddress,
00566                                                             (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00567                                                             Process );
00568 
00569                     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge -= CommitReduction;
00570                     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (CommitReduction, Process);
00571                     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommitReduction);
00572                     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00573                         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (-(SSIZE_T)CommitReduction);
00574                     }
00575                     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a295">MM_DBG_COMMIT_RETURN_NTFREEVM2</a>,
00576                                      CommitReduction);
00577                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= CommitReduction;
00578 
00579                     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> ((PCHAR)StartingAddress - 1);
00580                     PreviousVad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad;
00581 
00582                 } <span class="keywordflow">else</span> {
00583 
00584                     <span class="comment">//</span>
00585                     <span class="comment">// Split this VAD as the address range is within the VAD.</span>
00586                     <span class="comment">//</span>
00587 
00588                     <span class="comment">//</span>
00589                     <span class="comment">// Allocate an new VAD under an exception handler</span>
00590                     <span class="comment">// as there may not be enough quota.</span>
00591                     <span class="comment">//</span>
00592 
00593                     NewVad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00594                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">MMVAD_SHORT</a>),
00595                                                     'SdaV');
00596                     <span class="keywordflow">if</span> ( NewVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00597                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00598                         <span class="keywordflow">goto</span> ErrorReturn;
00599                     }
00600 
00601                     CommitReduction = <a class="code" href="../../d6/d1/mmquota_8c.html#a20">MiCalculatePageCommitment</a> (
00602                                                             StartingAddress,
00603                                                             EndingAddress,
00604                                                             (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00605                                                             Process );
00606 
00607                     OldQuota = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge - CommitReduction;
00608                     OldEnd = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>;
00609 
00610                     *NewVad = *Vad;
00611 
00612                     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> ((PCHAR)StartingAddress - 1);
00613                     NewVad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> ((PCHAR)EndingAddress + 1);
00614 
00615                     <span class="comment">//</span>
00616                     <span class="comment">// Set the commit charge to zero so MiInsertVad will</span>
00617                     <span class="comment">// not charge commitment for splitting the VAD.</span>
00618                     <span class="comment">//</span>
00619 
00620                     NewVad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.CommitCharge = 0;
00621 
00622                     <span class="keywordflow">try</span> {
00623 
00624                         <span class="comment">//</span>
00625                         <span class="comment">// Insert the VAD, this could get an exception</span>
00626                         <span class="comment">// on charging quota.</span>
00627                         <span class="comment">//</span>
00628 
00629                         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> ((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)NewVad);
00630 
00631                     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00632 
00633                         <span class="comment">//</span>
00634                         <span class="comment">// Inserting the Vad failed, reset the original</span>
00635                         <span class="comment">// VAD, free new vad and return an error.</span>
00636                         <span class="comment">//</span>
00637 
00638                         Vad-&gt;EndingVpn = OldEnd;
00639 
00640                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewVad);
00641                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00642                         <span class="keywordflow">goto</span> ErrorReturn;
00643                     }
00644 
00645                     Vad-&gt;u.VadFlags.CommitCharge -= CommitReduction;
00646                     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (CommitReduction, Process);
00647                     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommitReduction);
00648                     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00649                         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (-(SSIZE_T)CommitReduction);
00650                     }
00651                     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a296">MM_DBG_COMMIT_RETURN_NTFREEVM3</a>,
00652                                      CommitReduction);
00653                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= CommitReduction;
00654 
00655                     <span class="comment">//</span>
00656                     <span class="comment">// As we have split the original VAD into 2 separate VADs</span>
00657                     <span class="comment">// there is know way of knowing what the commit charge</span>
00658                     <span class="comment">// is for each VAD.  Calculate the charge and reset</span>
00659                     <span class="comment">// each VAD.  Note that we also use the previous value</span>
00660                     <span class="comment">// to make sure the books stay balanced.</span>
00661                     <span class="comment">//</span>
00662 
00663                     QuotaCharge = <a class="code" href="../../d6/d1/mmquota_8c.html#a20">MiCalculatePageCommitment</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn),
00664                                                              (PCHAR)StartingAddress - 1,
00665                                                              (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00666                                                              Process );
00667 
00668                     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge = QuotaCharge;
00669 
00670                     <span class="comment">//</span>
00671                     <span class="comment">// Give the remaining charge to the new VAD.</span>
00672                     <span class="comment">//</span>
00673 
00674                     NewVad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.CommitCharge = OldQuota - QuotaCharge;
00675                     PreviousVad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad;
00676                     NextVad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)NewVad;
00677                 }
00678             }
00679         }
00680 
00681         <span class="comment">//</span>
00682         <span class="comment">// Return commitment for page table pages if possible.</span>
00683         <span class="comment">//</span>
00684 
00685         <a class="code" href="../../d6/d1/mmquota_8c.html#a21">MiReturnPageTablePageCommitment</a> (StartingAddress,
00686                                          EndingAddress,
00687                                          Process,
00688                                          PreviousVad,
00689                                          NextVad);
00690 
00691         <span class="keywordflow">if</span> (UserPhysicalPages == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00692             <a class="code" href="../../d4/d8/mi_8h.html#a887">MiDeletePageTablesForPhysicalRange</a> (StartingAddress, EndingAddress);
00693         }
00694         <span class="keywordflow">else</span> {
00695 
00696             <span class="comment">//</span>
00697             <span class="comment">// Get the PFN mutex so the MiDeleteVirtualAddresses can be called.</span>
00698             <span class="comment">//</span>
00699 
00700             <a class="code" href="../../d4/d5/procsup_8c.html#a23">MiDeleteFreeVm</a> (StartingAddress, EndingAddress);
00701         }
00702 
00703         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00704 
00705         CapturedRegionSize = 1 + (PCHAR)EndingAddress - (PCHAR)StartingAddress;
00706 
00707         <span class="comment">//</span>
00708         <span class="comment">// Update the virtual size in the process header.</span>
00709         <span class="comment">//</span>
00710 
00711         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o15">VirtualSize</a> -= CapturedRegionSize;
00712 
00713 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00714 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00715 
00716             <span class="keywordflow">goto</span> perform_free4kpages;
00717 
00718         }
00719 <span class="preprocessor">#endif</span>
00720 <span class="preprocessor"></span>
00721         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
00722 
00723         <span class="keywordflow">if</span> (Attached) {
00724             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00725         }
00726 
00727         <span class="keywordflow">if</span> ( ProcessHandle != NtCurrentProcess() ) {
00728             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00729         }
00730         <span class="comment">//</span>
00731         <span class="comment">// Establish an exception handler and write the size and base</span>
00732         <span class="comment">// address.</span>
00733         <span class="comment">//</span>
00734 
00735         <span class="keywordflow">try</span> {
00736 
00737             *RegionSize = CapturedRegionSize;
00738             *BaseAddress = StartingAddress;
00739 
00740         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">// An exception occurred, don't take any action (just handle</span>
00744             <span class="comment">// the exception and return success.</span>
00745 
00746         }
00747 
00748 <span class="preprocessor">#if DBG</span>
00749 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00750         <span class="keywordflow">if</span> ( MmWatchProcess ) {
00751             <span class="keywordflow">if</span> ( MmWatchProcess == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00752                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n--- FREE Type 0x%lx Base %lx Size %lx\n"</span>,
00753                         FreeType, StartingAddress, CapturedRegionSize);
00754                 MmFooBar();
00755             }
00756         }
00757     }
00758 <span class="preprocessor">#endif</span>
00759 <span class="preprocessor"></span>
00760         <span class="keywordflow">return</span> STATUS_SUCCESS;
00761     }
00762 
00763     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00764 
00765         <span class="comment">//</span>
00766         <span class="comment">// Pages from a physical VAD must be released via</span>
00767         <span class="comment">// NtFreeUserPhysicalPages, not this routine.</span>
00768         <span class="comment">//</span>
00769 
00770         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MEMORY_NOT_ALLOCATED;
00771         <span class="keywordflow">goto</span> ErrorReturn;
00772     }
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">// **************************************************************</span>
00776     <span class="comment">//</span>
00777     <span class="comment">// MEM_DECOMMIT was specified.</span>
00778     <span class="comment">//</span>
00779     <span class="comment">// **************************************************************</span>
00780     <span class="comment">//</span>
00781 
00782     <span class="comment">//</span>
00783     <span class="comment">// Check to ensure the complete range of pages is already committed.</span>
00784     <span class="comment">//</span>
00785 
00786     <span class="keywordflow">if</span> (CapturedRegionSize == 0) {
00787 
00788         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (CapturedBase) != Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o0">StartingVpn</a>) {
00789             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FREE_VM_NOT_AT_BASE;
00790             <span class="keywordflow">goto</span> ErrorReturn;
00791         }
00792         EndingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o1">EndingVpn</a>);
00793     }
00794 
00795 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00796 <span class="preprocessor"></span>
00797         OriginalStartingAddress = StartingAddress;
00798         OriginalEndingAddress  = EndingAddress;
00799 
00800         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00801 
00802             EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00803 
00804         } <span class="keywordflow">else</span> {
00805 
00806             EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00807 
00808         }
00809 
00810 <span class="preprocessor">#endif</span>
00811 <span class="preprocessor"></span>
00812 <span class="preprocessor">#if 0</span>
00813 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (FreeType &amp; <a class="code" href="../../d3/d7/freevm_8c.html#a0">MEM_CHECK_COMMIT_STATE</a>) {
00814         <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d8/mi_8h.html#a906">MiIsEntireRangeCommitted</a>(StartingAddress,
00815                                        EndingAddress,
00816                                        Vad,
00817                                        Process)) {
00818 
00819             <span class="comment">//</span>
00820             <span class="comment">// The entire range to be decommitted is not committed,</span>
00821             <span class="comment">// return an error.</span>
00822             <span class="comment">//</span>
00823 
00824             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DECOMMIT_VM;
00825             <span class="keywordflow">goto</span> ErrorReturn;
00826         }
00827     }
00828 <span class="preprocessor">#endif //0</span>
00829 <span class="preprocessor"></span>
00830     <span class="comment">//</span>
00831     <span class="comment">// The address range is entirely committed, decommit it now.</span>
00832     <span class="comment">//</span>
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">// Calculate the initial quotas and commit charges for this VAD.</span>
00836     <span class="comment">//</span>
00837 
00838     StartingPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00839     EndingPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00840 
00841     CommitReduction = 1 + EndingPte - StartingPte;
00842 
00843     <span class="comment">//</span>
00844     <span class="comment">// Check to see if the entire range can be decommitted by</span>
00845     <span class="comment">// just updating the virtual address descriptor.</span>
00846     <span class="comment">//</span>
00847 
00848     CommitReduction -= <a class="code" href="../../d3/d7/freevm_8c.html#a4">MiDecommitPages</a> (StartingAddress,
00849                                         EndingPte,
00850                                         Process,
00851                                         Vad);
00852 
00853     <span class="comment">//</span>
00854     <span class="comment">// Adjust the quota charges.</span>
00855     <span class="comment">//</span>
00856 
00857     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)CommitReduction &gt;= 0);
00858     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (CommitReduction, Process);
00859     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommitReduction);
00860     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a297">MM_DBG_COMMIT_RETURN_NTFREEVM4</a>, CommitReduction);
00861     Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.CommitCharge -= CommitReduction;
00862     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00863         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (-(SSIZE_T)CommitReduction);
00864     }
00865     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= CommitReduction;
00866     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)Vad-&gt;<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o7">u</a>.VadFlags.CommitCharge &gt;= 0);
00867 
00868 
00869 <span class="preprocessor">#if !(defined(_MIALT4K_))</span>
00870 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00871 <span class="preprocessor">#else</span>
00872 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a>(Process);
00873 
00874   perform_free4kpages:
00875 
00876     <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00877 
00878         <span class="keywordflow">if</span> (FreeType &amp; MEM_RELEASE) {
00879 
00880             <a class="code" href="../../d2/d9/miia64_8h.html#a306">MiReleaseFor4kPage</a>(OriginalStartingAddress, 
00881                                OriginalEndingAddress, 
00882                                Process);
00883 
00884         } <span class="keywordflow">else</span> {
00885 
00886             <a class="code" href="../../d2/d9/miia64_8h.html#a307">MiDecommitFor4kPage</a>(OriginalStartingAddress, 
00887                                 OriginalEndingAddress, 
00888                                 Process);
00889 
00890         }
00891 
00892         StartingAddress = OriginalStartingAddress;
00893         EndingAddress = OriginalEndingAddress;
00894     }
00895 
00896     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
00897 
00898 <span class="preprocessor">#endif</span>
00899 <span class="preprocessor"></span>
00900     <span class="keywordflow">if</span> (Attached) {
00901         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00902     }
00903     <span class="keywordflow">if</span> ( ProcessHandle != NtCurrentProcess() ) {
00904         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00905     }
00906 
00907     <span class="comment">//</span>
00908     <span class="comment">// Establish an exception handler and write the size and base</span>
00909     <span class="comment">// address.</span>
00910     <span class="comment">//</span>
00911 
00912     <span class="keywordflow">try</span> {
00913 
00914         *RegionSize = 1 + (PCHAR)EndingAddress - (PCHAR)StartingAddress;
00915         *BaseAddress = StartingAddress;
00916 
00917     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00918         NOTHING;
00919     }
00920 
00921     <span class="keywordflow">return</span> STATUS_SUCCESS;
00922 
00923 ErrorReturn:
00924        <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00925 
00926        <span class="keywordflow">if</span> (Attached) {
00927            <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00928        }
00929 
00930        <span class="keywordflow">if</span> ( ProcessHandle != NtCurrentProcess() ) {
00931            <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00932        }
00933        <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00934 }
00935 
00936 ULONG
<a name="l00937"></a><a class="code" href="../../d4/d8/mi_8h.html#a906">00937</a> <a class="code" href="../../d4/d8/mi_8h.html#a906">MiIsEntireRangeCommitted</a> (
00938     IN PVOID StartingAddress,
00939     IN PVOID EndingAddress,
00940     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad,
00941     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00942     )
00943 
00944 <span class="comment">/*++</span>
00945 <span class="comment"></span>
00946 <span class="comment">Routine Description:</span>
00947 <span class="comment"></span>
00948 <span class="comment">    This routine examines the range of pages from the starting address</span>
00949 <span class="comment">    up to and including the ending address and returns TRUE if every</span>
00950 <span class="comment">    page in the range is committed, FALSE otherwise.</span>
00951 <span class="comment"></span>
00952 <span class="comment">Arguments:</span>
00953 <span class="comment"></span>
00954 <span class="comment">    StartingAddress - Supplies the starting address of the range.</span>
00955 <span class="comment"></span>
00956 <span class="comment">    EndingAddress - Supplies the ending address of the range.</span>
00957 <span class="comment"></span>
00958 <span class="comment">    Vad - Supplies the virtual address descriptor which describes the range.</span>
00959 <span class="comment"></span>
00960 <span class="comment">    Process - Supplies the current process.</span>
00961 <span class="comment"></span>
00962 <span class="comment">Return Value:</span>
00963 <span class="comment"></span>
00964 <span class="comment">    TRUE if the entire range is committed.</span>
00965 <span class="comment">    FALSE if any page within the range is not committed.</span>
00966 <span class="comment"></span>
00967 <span class="comment">Environment:</span>
00968 <span class="comment"></span>
00969 <span class="comment">    Kernel mode, APCs disable, WorkingSetMutex and AddressCreation mutexes</span>
00970 <span class="comment">    held.</span>
00971 <span class="comment"></span>
00972 <span class="comment">--*/</span>
00973 
00974 {
00975     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00976     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00977     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00978     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00979     ULONG FirstTime;
00980     ULONG Waited;
00981     PVOID Va;
00982 
00983     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00984 
00985     FirstTime = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00986 
00987     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00988     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00989     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// Set the Va to the starting address + 8, this solves problems</span>
00993     <span class="comment">// associated with address 0 (NULL) being used as a valid virtual</span>
00994     <span class="comment">// address and NULL in the VAD commitment field indicating no pages</span>
00995     <span class="comment">// are committed.</span>
00996     <span class="comment">//</span>
00997 
00998     Va = (PVOID)((PCHAR)StartingAddress + 8);
00999 
01000     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01001 
01002         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte) || (FirstTime)) {
01003 
01004             <span class="comment">//</span>
01005             <span class="comment">// This may be a PPE/PDE boundary, check to see if both</span>
01006             <span class="comment">// PPE/PDE pages exist.</span>
01007             <span class="comment">//</span>
01008 
01009             FirstTime = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01010             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01011             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01012 
01013             <span class="keywordflow">do</span> {
01014 
01015                 <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a>(PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited)) {
01016 
01017                     <span class="comment">//</span>
01018                     <span class="comment">// No PDE exists for the starting address, check the VAD</span>
01019                     <span class="comment">// to see if the pages are committed.</span>
01020                     <span class="comment">//</span>
01021 
01022                     PointerPpe += 1;
01023 
01024                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
01025                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
01026                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01027 
01028                     <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
01029 
01030                         <span class="comment">//</span>
01031                         <span class="comment">// Make sure the entire range is committed.</span>
01032                         <span class="comment">//</span>
01033 
01034                         <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit == 0) {
01035 
01036                             <span class="comment">//</span>
01037                             <span class="comment">// The entire range to be decommitted is not committed,</span>
01038                             <span class="comment">// return an error.</span>
01039                             <span class="comment">//</span>
01040 
01041                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01042                         } <span class="keywordflow">else</span> {
01043                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01044                         }
01045                     }
01046 
01047                     <span class="comment">//</span>
01048                     <span class="comment">// Make sure the range thus far is committed.</span>
01049                     <span class="comment">//</span>
01050 
01051                     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit == 0) {
01052 
01053                         <span class="comment">//</span>
01054                         <span class="comment">// The entire range to be decommitted is not committed,</span>
01055                         <span class="comment">// return an error.</span>
01056                         <span class="comment">//</span>
01057 
01058                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01059                     }
01060                 }
01061 
01062                 Waited = 0;
01063 
01064                 <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited)) {
01065 
01066                     <span class="comment">//</span>
01067                     <span class="comment">// No PDE exists for the starting address, check the VAD</span>
01068                     <span class="comment">// to see if the pages are committed.</span>
01069                     <span class="comment">//</span>
01070 
01071                     PointerPde += 1;
01072 
01073                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01074                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
01075                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01076 
01077                     <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
01078 
01079                         <span class="comment">//</span>
01080                         <span class="comment">// Make sure the entire range is committed.</span>
01081                         <span class="comment">//</span>
01082 
01083                         <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit == 0) {
01084 
01085                             <span class="comment">//</span>
01086                             <span class="comment">// The entire range to be decommitted is not committed,</span>
01087                             <span class="comment">// return an error.</span>
01088                             <span class="comment">//</span>
01089 
01090                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01091                         } <span class="keywordflow">else</span> {
01092                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01093                         }
01094                     }
01095 
01096                     <span class="comment">//</span>
01097                     <span class="comment">// Make sure the range thus far is committed.</span>
01098                     <span class="comment">//</span>
01099 
01100                     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit == 0) {
01101 
01102                         <span class="comment">//</span>
01103                         <span class="comment">// The entire range to be decommitted is not committed,</span>
01104                         <span class="comment">// return an error.</span>
01105                         <span class="comment">//</span>
01106 
01107                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01108                     }
01109 <span class="preprocessor">#if defined (_WIN64)</span>
01110 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
01111                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01112                         Waited = 1;
01113                         <span class="keywordflow">break</span>;
01114                     }
01115 <span class="preprocessor">#endif</span>
01116 <span class="preprocessor"></span>                }
01117             } <span class="keywordflow">while</span> (Waited != 0);
01118         }
01119 
01120         <span class="comment">//</span>
01121         <span class="comment">// The page table page exists, check each PTE for commitment.</span>
01122         <span class="comment">//</span>
01123 
01124         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01125 
01126             <span class="comment">//</span>
01127             <span class="comment">// This page has not been committed, check the VAD.</span>
01128             <span class="comment">//</span>
01129 
01130             <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit == 0) {
01131 
01132                 <span class="comment">//</span>
01133                 <span class="comment">// The entire range to be decommitted is not committed,</span>
01134                 <span class="comment">// return an error.</span>
01135                 <span class="comment">//</span>
01136 
01137                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01138             }
01139         } <span class="keywordflow">else</span> {
01140 
01141             <span class="comment">//</span>
01142             <span class="comment">// Has this page been explicitly decommitted?</span>
01143             <span class="comment">//</span>
01144 
01145             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (PointerPte)) {
01146 
01147                 <span class="comment">//</span>
01148                 <span class="comment">// This page has been explicitly decommitted, return an error.</span>
01149                 <span class="comment">//</span>
01150 
01151                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01152             }
01153         }
01154         PointerPte += 1;
01155         Va = (PVOID)((PCHAR)(Va) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01156     }
01157     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01158 }
01159 
01160 ULONG
<a name="l01161"></a><a class="code" href="../../d3/d7/freevm_8c.html#a4">01161</a> <a class="code" href="../../d3/d7/freevm_8c.html#a4">MiDecommitPages</a> (
01162     IN PVOID StartingAddress,
01163     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndingPte,
01164     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01165     IN <a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a> Vad
01166     )
01167 
01168 <span class="comment">/*++</span>
01169 <span class="comment"></span>
01170 <span class="comment">Routine Description:</span>
01171 <span class="comment"></span>
01172 <span class="comment">    This routine decommits the specified range of pages.</span>
01173 <span class="comment"></span>
01174 <span class="comment">Arguments:</span>
01175 <span class="comment"></span>
01176 <span class="comment">    StartingAddress - Supplies the starting address of the range.</span>
01177 <span class="comment"></span>
01178 <span class="comment">    EndingPte - Supplies the ending PTE of the range.</span>
01179 <span class="comment"></span>
01180 <span class="comment">    Process - Supplies the current process.</span>
01181 <span class="comment"></span>
01182 <span class="comment">    Vad - Supplies the virtual address descriptor which describes the range.</span>
01183 <span class="comment"></span>
01184 <span class="comment">Return Value:</span>
01185 <span class="comment"></span>
01186 <span class="comment">    Value to reduce commitment by for the VAD.</span>
01187 <span class="comment"></span>
01188 <span class="comment">Environment:</span>
01189 <span class="comment"></span>
01190 <span class="comment">    Kernel mode, APCs disabled, WorkingSetMutex and AddressCreation mutexes</span>
01191 <span class="comment">    held.</span>
01192 <span class="comment"></span>
01193 <span class="comment">--*/</span>
01194 
01195 {
01196     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01197     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01198     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01199     PVOID Va;
01200     ULONG CommitReduction;
01201     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CommitLimitPte;
01202     KIRQL OldIrql;
01203     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ValidPteList[<a class="code" href="../../d3/d7/freevm_8c.html#a1">MM_VALID_PTE_SIZE</a>];
01204     ULONG count;
01205     ULONG WorkingSetIndex;
01206     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01207     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01208     PVOID SwapVa;
01209     ULONG Entry;
01210     <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a> Locked;
01211     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01212     PVOID UsedPageTableHandle;
01213     PVOID UsedPageDirectoryHandle;
01214 
01215     count = 0;
01216     CommitReduction = 0;
01217 
01218     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit) {
01219         CommitLimitPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;EndingVpn));
01220     } <span class="keywordflow">else</span> {
01221         CommitLimitPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01222     }
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// Decommit each page by setting the PTE to be explicitly</span>
01226     <span class="comment">// decommitted.  The PTEs cannot be deleted all at once as</span>
01227     <span class="comment">// this would set the PTEs to zero which would auto-evaluate</span>
01228     <span class="comment">// as committed if referenced by another thread when a page</span>
01229     <span class="comment">// table page is being in-paged.</span>
01230     <span class="comment">//</span>
01231 
01232     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
01233     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
01234     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
01235     Va = StartingAddress;
01236 
01237     <span class="comment">//</span>
01238     <span class="comment">// Loop through all the PDEs which map this region and ensure that</span>
01239     <span class="comment">// they exist.  If they don't exist create them by touching a</span>
01240     <span class="comment">// PTE mapped by the PDE.</span>
01241     <span class="comment">//</span>
01242 
01243 <span class="preprocessor">#if defined (_WIN64)</span>
01244 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01245     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01246         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01247         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01248     }
01249 <span class="preprocessor">#endif</span>
01250 <span class="preprocessor"></span>
01251     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01252 
01253     <span class="keywordflow">while</span> (PointerPte &lt;= EndingPte) {
01254 
01255         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01256 
01257             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
01258             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Va);
01259             <span class="keywordflow">if</span> (count != 0) {
01260                 <a class="code" href="../../d3/d7/freevm_8c.html#a3">MiProcessValidPteList</a> (&amp;ValidPteList[0], count);
01261                 count = 0;
01262             }
01263 
01264 <span class="preprocessor">#if defined (_WIN64)</span>
01265 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01266             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01267                 UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01268                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01269             }
01270 <span class="preprocessor">#endif</span>
01271 <span class="preprocessor"></span>
01272             <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01273         }
01274 
01275         <span class="comment">//</span>
01276         <span class="comment">// The working set lock is held.  No PTEs can go from</span>
01277         <span class="comment">// invalid to valid or valid to invalid.  Transition</span>
01278         <span class="comment">// PTEs can go from transition to pagefile.</span>
01279         <span class="comment">//</span>
01280 
01281         PteContents = *PointerPte;
01282 
01283         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
01284 
01285             <span class="keywordflow">if</span> (PointerPte-&gt;u.Long == <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
01286 
01287                 <span class="comment">//</span>
01288                 <span class="comment">// This PTE is already decommitted.</span>
01289                 <span class="comment">//</span>
01290 
01291                 CommitReduction += 1;
01292 
01293             } <span class="keywordflow">else</span> {
01294 
01295                 Process-&gt;NumberOfPrivatePages -= 1;
01296 
01297                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01298 
01299                     <span class="comment">//</span>
01300                     <span class="comment">// Make sure this is not a forked PTE.</span>
01301                     <span class="comment">//</span>
01302 
01303                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01304 
01305                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte) {
01306 
01307                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01308                         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
01309                                      Va,
01310                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01311                                      Process,
01312                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01313                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01314                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01315                         Process-&gt;NumberOfPrivatePages += 1;
01316                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a>);
01317                     } <span class="keywordflow">else</span> {
01318 
01319                         <span class="comment">//</span>
01320                         <span class="comment">// Pte is valid, process later when PFN lock is held.</span>
01321                         <span class="comment">//</span>
01322 
01323                         <span class="keywordflow">if</span> (count == <a class="code" href="../../d3/d7/freevm_8c.html#a1">MM_VALID_PTE_SIZE</a>) {
01324                             <a class="code" href="../../d3/d7/freevm_8c.html#a3">MiProcessValidPteList</a> (&amp;ValidPteList[0], count);
01325                             count = 0;
01326                         }
01327                         ValidPteList[count] = PointerPte;
01328                         count += 1;
01329 
01330                         <span class="comment">//</span>
01331                         <span class="comment">// Remove address from working set list.</span>
01332                         <span class="comment">//</span>
01333 
01334 
01335                         WorkingSetIndex = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex;
01336 
01337                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o1">Long</a>) ==
01338                                                                            Va);
01339                         <span class="comment">//</span>
01340                         <span class="comment">// Check to see if this entry is locked in the working set</span>
01341                         <span class="comment">// or locked in memory.</span>
01342                         <span class="comment">//</span>
01343 
01344                         Locked = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1;
01345 
01346                         <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex, <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>);
01347 
01348                         <span class="comment">//</span>
01349                         <span class="comment">// Add this entry to the list of free working set entries</span>
01350                         <span class="comment">// and adjust the working set count.</span>
01351                         <span class="comment">//</span>
01352 
01353                         <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (WorkingSetIndex, &amp;Process-&gt;Vm);
01354 
01355                         <span class="keywordflow">if</span> ((Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o1">LockedInWs</a> == 1) || (Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o2">LockedInMemory</a> == 1)) {
01356 
01357                             <span class="comment">//</span>
01358                             <span class="comment">// This entry is locked.</span>
01359                             <span class="comment">//</span>
01360 
01361                             <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
01362 
01363                             <span class="keywordflow">if</span> (WorkingSetIndex != <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
01364 
01365                                 SwapVa = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress;
01366                                 SwapVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (SwapVa);
01367                                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (
01368                                           <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (SwapVa)-&gt;u.Hard.PageFrameNumber);
01369 
01370                                 Entry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (SwapVa,
01371                                                       <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>,
01372                                                       Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
01373 
01374                                 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry,
01375                                                   WorkingSetIndex,
01376                                                   &amp;Process-&gt;Vm);
01377                             }
01378                         }
01379                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, 0);
01380                     }
01381                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype) {
01382 
01383                     <span class="comment">//</span>
01384                     <span class="comment">// This is a forked PTE, just delete it.</span>
01385                     <span class="comment">//</span>
01386 
01387                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01388                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
01389                                  Va,
01390                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01391                                  Process,
01392                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01393                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01394                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01395                     Process-&gt;NumberOfPrivatePages += 1;
01396                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a>);
01397 
01398                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01399 
01400                     <span class="comment">//</span>
01401                     <span class="comment">// Transition PTE, get the PFN database lock</span>
01402                     <span class="comment">// and reprocess this one.</span>
01403                     <span class="comment">//</span>
01404 
01405                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01406                     PteContents = *PointerPte;
01407 
01408                     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01409 
01410                         <span class="comment">//</span>
01411                         <span class="comment">// PTE is still in transition, delete it.</span>
01412                         <span class="comment">//</span>
01413 
01414                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
01415 
01416                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01417 
01418                         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01419 
01420                         <span class="comment">//</span>
01421                         <span class="comment">// Check the reference count for the page, if the</span>
01422                         <span class="comment">// reference count is zero, move the page to the</span>
01423                         <span class="comment">// free list, if the reference count is not zero,</span>
01424                         <span class="comment">// ignore this page.  When the reference count</span>
01425                         <span class="comment">// goes to zero, it will be placed on the free list.</span>
01426                         <span class="comment">//</span>
01427 
01428                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
01429                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01430                             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01431                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
01432                                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;PteContents));
01433                         }
01434 
01435                     } <span class="keywordflow">else</span> {
01436 
01437                         <span class="comment">//</span>
01438                         <span class="comment">// Page MUST be in page file format!</span>
01439                         <span class="comment">//</span>
01440 
01441                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Valid == 0);
01442                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0);
01443                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != 0);
01444                         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
01445                     }
01446                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a>);
01447                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01448                 } <span class="keywordflow">else</span> {
01449 
01450                     <span class="comment">//</span>
01451                     <span class="comment">// Must be demand zero or paging file format.</span>
01452                     <span class="comment">//</span>
01453 
01454                     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != 0) {
01455                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01456                         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
01457                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01458                     } <span class="keywordflow">else</span> {
01459 
01460                         <span class="comment">//</span>
01461                         <span class="comment">// Don't subtract out the private page count for</span>
01462                         <span class="comment">// a demand zero page.</span>
01463                         <span class="comment">//</span>
01464 
01465                         Process-&gt;NumberOfPrivatePages += 1;
01466                     }
01467 
01468                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a>);
01469                 }
01470             }
01471 
01472         } <span class="keywordflow">else</span> {
01473 
01474             <span class="comment">//</span>
01475             <span class="comment">// The PTE is already zero.</span>
01476             <span class="comment">//</span>
01477 
01478             <span class="comment">//</span>
01479             <span class="comment">// Increment the count of non-zero page table entries for this</span>
01480             <span class="comment">// page table and the number of private pages for the process.</span>
01481             <span class="comment">//</span>
01482 
01483             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (Va);
01484 
01485             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01486 
01487             <span class="keywordflow">if</span> (PointerPte &gt; CommitLimitPte) {
01488 
01489                 <span class="comment">//</span>
01490                 <span class="comment">// Pte is not committed.</span>
01491                 <span class="comment">//</span>
01492 
01493                 CommitReduction += 1;
01494             }
01495             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a>);
01496         }
01497 
01498         PointerPte += 1;
01499         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01500     }
01501     <span class="keywordflow">if</span> (count != 0) {
01502         <a class="code" href="../../d3/d7/freevm_8c.html#a3">MiProcessValidPteList</a> (&amp;ValidPteList[0], count);
01503     }
01504 
01505     <span class="keywordflow">return</span> CommitReduction;
01506 }
01507 
01508 
01509 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01510"></a><a class="code" href="../../d3/d7/freevm_8c.html#a3">01510</a> <a class="code" href="../../d3/d7/freevm_8c.html#a3">MiProcessValidPteList</a> (
01511     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> *ValidPteList,
01512     IN ULONG Count
01513     )
01514 
01515 <span class="comment">/*++</span>
01516 <span class="comment"></span>
01517 <span class="comment">Routine Description:</span>
01518 <span class="comment"></span>
01519 <span class="comment">    This routine flushes the specified range of valid PTEs.</span>
01520 <span class="comment"></span>
01521 <span class="comment">Arguments:</span>
01522 <span class="comment"></span>
01523 <span class="comment">    ValidPteList - Supplies a pointer to an array of PTEs to flush.</span>
01524 <span class="comment"></span>
01525 <span class="comment">    Count - Supplies the count of the number of elements in the array.</span>
01526 <span class="comment"></span>
01527 <span class="comment">Return Value:</span>
01528 <span class="comment"></span>
01529 <span class="comment">    none.</span>
01530 <span class="comment"></span>
01531 <span class="comment">Environment:</span>
01532 <span class="comment"></span>
01533 <span class="comment">    Kernel mode, APCs disabled, WorkingSetMutex and AddressCreation mutexes</span>
01534 <span class="comment">    held.</span>
01535 <span class="comment"></span>
01536 <span class="comment">--*/</span>
01537 
01538 {
01539     ULONG i = 0;
01540     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
01541     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01542     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01543     KIRQL OldIrql;
01544 
01545     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
01546 
01547     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01548 
01549     <span class="keywordflow">do</span> {
01550         PteContents = *ValidPteList[i];
01551         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01552         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01553 
01554         <span class="comment">//</span>
01555         <span class="comment">// Decrement the share and valid counts of the page table</span>
01556         <span class="comment">// page which maps this PTE.</span>
01557         <span class="comment">//</span>
01558 
01559         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01560 
01561         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01562 
01563         <span class="comment">//</span>
01564         <span class="comment">// Decrement the share count for the physical page.  As the page</span>
01565         <span class="comment">// is private it will be put on the free list.</span>
01566         <span class="comment">//</span>
01567 
01568         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents));
01569 
01570         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01571             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o1">FlushPte</a>[i] = ValidPteList[i];
01572             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o2">FlushVa</a>[i] =
01573                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (ValidPteList[i]);
01574         }
01575         *ValidPteList[i] = <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a>;
01576         i += 1;
01577     } <span class="keywordflow">while</span> (i != <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
01578 
01579     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d3/d7/freevm_8c.html#a2">MmDecommittedPte</a>);
01580     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01581     <span class="keywordflow">return</span>;
01582 }
01583 
01584 
01585 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01586"></a><a class="code" href="../../d3/d7/freevm_8c.html#a5">01586</a> <a class="code" href="../../d4/d5/procsup_8c.html#a23">MiDeleteFreeVm</a> (
01587     IN PVOID StartingAddress,
01588     IN PVOID EndingAddress
01589     )
01590 
01591 <span class="comment">/*++</span>
01592 <span class="comment"></span>
01593 <span class="comment">Routine Description:</span>
01594 <span class="comment"></span>
01595 <span class="comment">    Nonpagable routine to call acquire PFN lock and call</span>
01596 <span class="comment">    MiDeleteVirtualAddresses.</span>
01597 <span class="comment"></span>
01598 <span class="comment">Arguments:</span>
01599 <span class="comment"></span>
01600 <span class="comment"></span>
01601 <span class="comment">Return Value:</span>
01602 <span class="comment"></span>
01603 <span class="comment">    none.</span>
01604 <span class="comment"></span>
01605 <span class="comment">Environment:</span>
01606 <span class="comment"></span>
01607 <span class="comment">    Kernel mode, APCs disabled, WorkingSetMutex and AddressCreation mutexes</span>
01608 <span class="comment">    held.</span>
01609 <span class="comment"></span>
01610 <span class="comment">--*/</span>
01611 
01612 {
01613     KIRQL OldIrql;
01614 
01615     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01616 
01617     <span class="comment">//</span>
01618     <span class="comment">// Delete the address range.</span>
01619     <span class="comment">//</span>
01620 
01621     <a class="code" href="../../d4/d8/mi_8h.html#a885">MiDeleteVirtualAddresses</a> (StartingAddress,
01622                               EndingAddress,
01623                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01624                               (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01625 
01626     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01627 
01628 }
01629 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
