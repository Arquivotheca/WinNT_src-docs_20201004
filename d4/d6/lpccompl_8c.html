<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpccompl.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpccompl.c File Reference</h1><code>#include "<a class="el" href="../../d1/d6/lpcp_8h-source.html">lpcp.h</a>"</code><br>

<p>
<a href="../../d5/d5/lpccompl_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/lpccompl_8c.html#a0">LpcpPrepareToWakeClient</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ClientThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/lpccompl_8c.html#a1">NtAcceptConnectPort</a> (OUT PHANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, IN PVOID PortContext OPTIONAL, IN PPORT_MESSAGE ConnectionRequest, IN BOOLEAN AcceptConnection, IN OUT PPORT_VIEW ServerView OPTIONAL, OUT PREMOTE_PORT_VIEW ClientView OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a> (IN HANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="lpccompl.c::LpcpPrepareToWakeClient" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LpcpPrepareToWakeClient           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ClientThread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l01001">1001</a> of file <a class="el" href="../../d5/d5/lpccompl_8c-source.html">lpccompl.c</a>.
<p>
References <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, and <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00836">NtCompleteConnectPort()</a>.
<p>
<pre class="fragment"><div>01007                    :
01008 
01009     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to prepare <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client thread to receive a reply to
01010     its connection request
01011 
01012 Arguments:
01013 
01014     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread we are preparing to wake up
01015 
01016 Return Value:
01017 
01018     None.
01019 
01020 --*/
01021 
01022 {
01023     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01024 
01025     <span class="comment">//</span>
01026     <span class="comment">//  Remove the thread from the rundown list the connection port as we are</span>
01027     <span class="comment">//  sending a reply.  The operation only needs to take place if the</span>
01028     <span class="comment">//  thread isn't exiting and it's in the lpc reply chain for a connection</span>
01029     <span class="comment">//  port</span>
01030     <span class="comment">//</span>
01031 
01032     <span class="keywordflow">if</span> ((!<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcExitThreadCalled) &amp;&amp;
01033         (!IsListEmpty( &amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyChain ))) {
01034 
01035         RemoveEntryList( &amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyChain );
01036         InitializeListHead( &amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyChain );
01037     }
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">//  And return to our caller</span>
01041     <span class="comment">//</span>
01042 
01043     <span class="keywordflow">return</span>;
01044 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lpccompl.c::NtAcceptConnectPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtAcceptConnectPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID PortContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPORT_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>ConnectionRequest</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AcceptConnection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PPORT_VIEW ServerView&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PREMOTE_PORT_VIEW ClientView&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">40</a> of file <a class="el" href="../../d5/d5/lpccompl_8c-source.html">lpccompl.c</a>.
<p>
References <a class="el" href="../../d3/d5/lpc_8h-source.html#l00172">_LPCP_CONNECTION_MESSAGE::ClientPort</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00171">_LPCP_CONNECTION_MESSAGE::ClientView</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00108">_LPCP_PORT_OBJECT::ConnectedPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00107">_LPCP_PORT_OBJECT::ConnectionPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00110">_LPCP_PORT_OBJECT::Creator</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l01001">LpcpPrepareToWakeClient()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00319">LpcpPrint</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00115">_LPCP_PORT_OBJECT::MaxConnectionInfoLength</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00114">_LPCP_PORT_OBJECT::MaxMessageLength</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">MmSectionObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01431">ProbeAndReadStructure</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01339">ProbeAndReadUlong</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00154">_LPCP_MESSAGE::Request</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00173">_LPCP_CONNECTION_MESSAGE::SectionToMap</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00133">SERVER_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00121">_LPCP_PORT_OBJECT::ServerProcess</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00112">_LPCP_PORT_OBJECT::ServerSectionBase</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00174">_LPCP_CONNECTION_MESSAGE::ServerView</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00260">RtlpLpcServerCallback()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00134">RtlpLpcWorkerThread()</a>, and <a class="el" href="../../d9/d0/userver_8c-source.html#l00037">ServerHandleConnectionRequest()</a>.
<p>
<pre class="fragment"><div>00051                    :
00052 
00053     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> server process can accept or reject a client connection request
00054     <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/lpccompl_8c.html#a1">NtAcceptConnectPort</a> service.
00055 
00056     The ConnectionRequest parameter must specify a connection request
00057     returned by a previous call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d6/lpclistn_8c.html#a0">NtListenPort</a> service.  This
00058     service will either complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AcceptConnection
00059     parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, or reject <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection request <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00060     AcceptConnection parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00061 
00062     In either <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection
00063     request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data to <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of <a class="code" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a>.
00064 
00065     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accepted, then two communication port
00066     objects will be created and connected together.  One will be
00067     inserted in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client process' handle table and returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00068     client via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> parameter <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> specified on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00069     <a class="code" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a> service.  The other will be inserted in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server
00070     process' handle table and returned via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> parameter
00071     specified on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a> service.  In addition <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00072     two communication ports (client and server) will be linked together.
00073 
00074     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accepted, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ServerView parameter
00075     was specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> examined.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid,
00076     then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section described by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SectionOffset and
00077     ViewSize fields will be mapped into both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client and server
00078     process address spaces.  The address in server's address space will
00079     be returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ViewBase field.  The address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's
00080     address space will be returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ViewRemoteBase field.  The
00081     actual offset and size used to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section will be returned in
00082     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SectionOffset and ViewSize fields.
00083 
00084     Communication port objects are temporary objects that have no names
00085     and cannot be inherited.  When either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client or server process
00086     calls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> !f <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> service <span class="keywordflow">for</span> a communication port, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port will
00087     be deleted since there can never be more than one outstanding handle
00088     <span class="keywordflow">for</span> each communication port.  The port object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> specific <span class="keyword">delete</span>
00089     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> will then be invoked.  This <span class="keyword">delete</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> will examine
00090     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> communication port, and <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> connected to another
00091     communication port, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will queue an LPC_PORT_CLOSED datagram to
00092     that port's message queue.  This will allow both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client and
00093     server processes to notice when a port becomes disconnected, either
00094     because of an <span class="keyword">explicit</span> call to <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> or an implicit call due to
00095     process termination.  In addition, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> will scan
00096     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message queue of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port being closed and <span class="keywordflow">for</span> each message
00097     still in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will <span class="keywordflow">return</span> an ERROR_PORT_CLOSED status to
00098     any thread that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> waiting <span class="keywordflow">for</span> a reply to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.
00099 
00100 Arguments:
00101 
00102     <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server
00103         communication port object handle value.
00104 
00105     PortContext - An uninterpreted pointer that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00106         server communication port.  This pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned whenever
00107         a message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> received <span class="keywordflow">for</span> <span class="keyword">this</span> port.
00108 
00109     ConnectionRequest - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a structure that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00110         connection request being accepted or rejected:
00111 
00112         The ConnectionRequest structure
00113 
00114         ULONG Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <span class="keyword">this</span> data structure in
00115             bytes.
00116 
00117         CLIENT_ID ClientId - Specifies a structure that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00118             client identifier (CLIENT_ID) of the thread that sent the
00119             request.
00120 
00121         The ClientId Structure
00122 
00123             ULONG UniqueProcessId - A unique value for each process
00124                 in the system.
00125 
00126             ULONG UniqueThreadId - A unique value for each thread in the
00127                 system.
00128 
00129         ULONG MessageId - A unique value that identifies the connection
00130             request being completed.
00131 
00132         ULONG PortAttributes - This field has no meaning for this service.
00133 
00134         ULONG ClientViewSize - This field has no meaning for this service.
00135 
00136     AcceptConnection - Specifies a <span class="keywordtype">boolean</span> value which indicates where
00137         the connection request is being accepted or rejected.  A value
00138         of TRUE means that the connection request is accepted and a
00139         server communication port handle will be created and connected
00140         to the client's communication port handle.  A value of FALSE
00141         means that the connection request is not accepted.
00142 
00143     ServerView - A pointer to a structure that specifies the section that
00144         the server process will use to send messages back to the client
00145         process connected to this port.
00146 
00147         The ServerView Structure
00148 
00149         ULONG Length - Specifies the size of this data structure in
00150             bytes.
00151 
00152         HANDLE SectionHandle - Specifies an open handle to a section
00153             object.
00154 
00155         ULONG SectionOffset - Specifies a field that will receive the
00156             actual offset, in bytes, from the start of the section.  The
00157             initial value of this parameter specifies the byte offset
00158             within the section that the client's view is based.  The
00159             value is rounded down to the next host page size boundary.
00160 
00161         ULONG ViewSize - Specifies the size of the view, in bytes.
00162 
00163         PVOID ViewBase - Specifies a field that will receive the base
00164             address of the port memory in the server's address space.
00165 
00166         PVOID ViewRemoteBase - Specifies a field that will receive
00167             the base address of the server port's memory in the client's
00168             address space.  Used to generate pointers that are
00169             meaningful to the client.
00170 
00171     ClientView - An optional pointer to a structure that will receive
00172         information about the client process' view in the server's
00173         address space.  The server process can use this information
00174         to validate pointers it receives from the client process.
00175 
00176         The ClientView Structure
00177 
00178         ULONG Length - Specifies the size of this data structure in
00179             bytes.
00180 
00181         PVOID ViewBase - Specifies a field that will receive the base
00182             address of the client port's memory in the server's address
00183             space.
00184 
00185         ULONG ViewSize - Specifies a field that will receive the
00186             size, in bytes, of the client's view in the server's address
00187             space.  If this field is zero, then client has no view in
00188             the server's address space.
00189 
00190 Return Value:
00191 
00192     NTSTATUS - An appropriate status value.
00193 
00194 --*/
00195 
00196 {
00197     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ConnectionPort;
00198     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ServerPort;
00199     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ClientPort;
00200     PVOID ClientSectionToMap;
00201     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00202     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00203     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00204     ULONG ConnectionInfoLength;
00205     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00206     <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> ConnectMsg;
00207     PORT_MESSAGE CapturedReplyMessage;
00208     PVOID SectionToMap;
00209     LARGE_INTEGER SectionOffset;
00210     SIZE_T ViewSize;
00211     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ClientProcess;
00212     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00213     PORT_VIEW CapturedServerView;
00214 
00215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00219     <span class="comment">//</span>
00220 
00221     PreviousMode = KeGetPreviousMode();
00222 
00223     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00224 
00225         <span class="keywordflow">try</span> {
00226 
00227             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( PortHandle );
00228 
00229             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ConnectionRequest,
00230                           <span class="keyword">sizeof</span>( *ConnectionRequest ),
00231                           <span class="keyword">sizeof</span>( ULONG ));
00232 
00233             CapturedReplyMessage = *ConnectionRequest;
00234 
00235             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
00236 
00237                 CapturedServerView = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>( ServerView, PORT_VIEW );
00238 
00239                 <span class="keywordflow">if</span> (CapturedServerView.Length != <span class="keyword">sizeof</span>( *ServerView )) {
00240 
00241                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00242                 }
00243 
00244                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ServerView,
00245                                <span class="keyword">sizeof</span>( *ServerView ),
00246                                <span class="keyword">sizeof</span>( ULONG ));
00247             }
00248 
00249             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00250 
00251                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>( &amp;ClientView-&gt;Length ) != <span class="keyword">sizeof</span>( *ClientView )) {
00252 
00253                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00254                 }
00255 
00256                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ClientView,
00257                                <span class="keyword">sizeof</span>( *ClientView ),
00258                                <span class="keyword">sizeof</span>( ULONG ));
00259             }
00260 
00261         } except( EXCEPTION_EXECUTE_HANDLER ) {
00262 
00263             <span class="keywordflow">return</span> GetExceptionCode();
00264         }
00265 
00266     } <span class="keywordflow">else</span> {
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">//  Otherwise the previous mode is kernel mode</span>
00270         <span class="comment">//</span>
00271 
00272         CapturedReplyMessage = *ConnectionRequest;
00273 
00274         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
00275 
00276             <span class="keywordflow">if</span> (ServerView-&gt;Length != <span class="keyword">sizeof</span>( *ServerView )) {
00277 
00278                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00279             }
00280 
00281             CapturedServerView = *ServerView;
00282         }
00283 
00284         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00285 
00286             <span class="keywordflow">if</span> (ClientView-&gt;Length != <span class="keyword">sizeof</span>( *ClientView )) {
00287 
00288                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00289             }
00290         }
00291     }
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">//  Translate the ClientId from the connection request into a</span>
00295     <span class="comment">//  thread pointer.  This is a referenced pointer to keep the thread</span>
00296     <span class="comment">//  from evaporating out from under us.</span>
00297     <span class="comment">//</span>
00298 
00299     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>( &amp;CapturedReplyMessage.ClientId,
00300                                          &amp;ClientProcess,
00301                                          &amp;ClientThread );
00302 
00303     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00304 
00305         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00306     }
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">//  Acquire the mutex that guards the LpcReplyMessage field of</span>
00310     <span class="comment">//  the thread and get the pointer to the message that the thread</span>
00311     <span class="comment">//  is waiting for a reply to.</span>
00312     <span class="comment">//</span>
00313 
00314     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">//  See if the thread is waiting for a reply to the connection request</span>
00318     <span class="comment">//  specified on this call.  If not then a bogus connection request</span>
00319     <span class="comment">//  has been specified, so release the mutex, dereference the thread</span>
00320     <span class="comment">//  and return failure.</span>
00321     <span class="comment">//</span>
00322     <span class="comment">//  The check is that the client is waiting for a reply to a connection</span>
00323     <span class="comment">//  request and that the message id is both valid and lines up correctly</span>
00324     <span class="comment">//</span>
00325 
00326     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00327         (CapturedReplyMessage.MessageId == 0) ||
00328         (<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessageId != CapturedReplyMessage.MessageId) ||
00329         ((((<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessage)-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != LPC_CONNECTION_REQUEST)) {
00330 
00331         Msg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00332 
00333     } <span class="keywordflow">else</span> {
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">//  Remember the LPCP message from the thread</span>
00337         <span class="comment">//</span>
00338 
00339         Msg = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessage;
00340 
00341         <span class="comment">//</span>
00342         <span class="comment">//  Get connection message immediately following the LPCP message</span>
00343         <span class="comment">//</span>
00344 
00345         ConnectMsg = (<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a>)(Msg + 1);
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">//  Remember the client port from the connection message</span>
00349         <span class="comment">//</span>
00350 
00351         ClientPort = ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o1">ClientPort</a>;
00352         
00353         <span class="comment">//</span>
00354         <span class="comment">//  Get a pointer to the connection port from the client port.</span>
00355         <span class="comment">//</span>
00356 
00357         ConnectionPort = ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
00358         
00359         <span class="comment">//</span>
00360         <span class="comment">//  Check if the server process accept the connection</span>
00361         <span class="comment">//</span>
00362         
00363         <span class="keywordflow">if</span> ( ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o16">ServerProcess</a> != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00364             
00365             <span class="comment">//</span>
00366             <span class="comment">//  Release the LPC mutex</span>
00367             <span class="comment">//</span>
00368             
00369             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00370             
00371             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientProcess );
00372             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00373 
00374             <span class="keywordflow">return</span> (STATUS_REPLY_MESSAGE_MISMATCH);
00375         }
00376         
00377         <span class="comment">//</span>
00378         <span class="comment">//  Remove the LPC message from the thread</span>
00379         <span class="comment">//</span>
00380                 
00381         <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00382         
00383         <span class="comment">//</span>
00384         <span class="comment">//  Remove the client port from the connection message</span>
00385         <span class="comment">//</span>
00386 
00387         ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o1">ClientPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00388 
00389         <span class="comment">//</span>
00390         <span class="comment">//  Clean up the rest of the client thread.  This cleanup use to be</span>
00391         <span class="comment">//  done unconditionally right before releasing the mutex however</span>
00392         <span class="comment">//  this causes trouble if our caller supplied a bad reply message</span>
00393         <span class="comment">//  and we clobber an arbitrary threads state</span>
00394         <span class="comment">//</span>
00395 
00396         <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessageId = 0;
00397     }
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  Release the mutex that guards the field.</span>
00401     <span class="comment">//</span>
00402 
00403     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">//  Now if we did not get an LPCP message from a client thread then this</span>
00407     <span class="comment">//  isn't a good call and we'll dereference what we thought was the</span>
00408     <span class="comment">//  client thread/process and tell our caller their mistake</span>
00409     <span class="comment">//</span>
00410 
00411     <span class="keywordflow">if</span> ( !Msg ) {
00412 
00413         <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"%s Attempted AcceptConnectPort to Thread %lx (%s)\n"</span>,
00414                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00415                     ClientThread,
00416                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( ClientThread )-&gt;ImageFileName ));
00417         <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"failed.  MessageId == %u\n"</span>, CapturedReplyMessage.MessageId ));
00418         <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"         Thread MessageId == %u\n"</span>, <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessageId ));
00419         <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"         Thread Msg == %x\n"</span>, <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessage ));
00420 
00421         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientProcess );
00422         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00423 
00424         <span class="keywordflow">return</span> (STATUS_REPLY_MESSAGE_MISMATCH);
00425     }
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">//  At this point we have a good matching client for this accept connect</span>
00429     <span class="comment">//  call.</span>
00430     <span class="comment">//</span>
00431     
00432     <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>((<span class="stringliteral">"Replying to Connect Msg %lx to Port %lx\n"</span>,
00433                Msg, ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a> ));
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">//  Regardless of whether we are accepting or rejecting the connection,</span>
00437     <span class="comment">//  return the connection information to the waiting thread.</span>
00438     <span class="comment">//</span>
00439 
00440     ConnectionInfoLength = CapturedReplyMessage.u1.s1.DataLength;
00441 
00442     <span class="keywordflow">if</span> (ConnectionInfoLength &gt; ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o10">MaxConnectionInfoLength</a>) {
00443 
00444         ConnectionInfoLength = ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o10">MaxConnectionInfoLength</a>;
00445     }
00446 
00447     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u1.s1.DataLength = (CSHORT)(<span class="keyword">sizeof</span>( *ConnectMsg ) +
00448                                              ConnectionInfoLength);
00449 
00450     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u1.s1.TotalLength = (CSHORT)(<span class="keyword">sizeof</span>( *Msg ) +
00451                                               Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u1.s1.DataLength);
00452 
00453     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type = LPC_REPLY;
00454     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.DataInfoOffset = 0;
00455     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.ClientId = CapturedReplyMessage.ClientId;
00456     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId = CapturedReplyMessage.MessageId;
00457     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.ClientViewSize = 0;
00458 
00459     <span class="keywordflow">try</span> {
00460 
00461         RtlMoveMemory( ConnectMsg + 1,
00462                        (PCHAR)(ConnectionRequest + 1),
00463                        ConnectionInfoLength );
00464 
00465     } except( EXCEPTION_EXECUTE_HANDLER ) {
00466 
00467         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00468     }
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">//  Now it is time to process a positive accept request</span>
00472     <span class="comment">//</span>
00473 
00474     ClientSectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00475 
00476     <span class="keywordflow">if</span> (AcceptConnection) {
00477 
00478         <span class="comment">//</span>
00479         <span class="comment">//  Allocate and initialize a server communication port object.</span>
00480         <span class="comment">//  Communication ports have no names, can not be inherited and</span>
00481         <span class="comment">//  are process private handles.</span>
00482         <span class="comment">//</span>
00483 
00484         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( PreviousMode,
00485                                  LpcPortObjectType,
00486                                  NULL,
00487                                  PreviousMode,
00488                                  NULL,
00489                                  <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">LPCP_PORT_OBJECT</a> ),
00490                                  0,
00491                                  0,
00492                                  (PVOID *)&amp;ServerPort );
00493 
00494         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00495 
00496             <span class="keywordflow">goto</span> bailout;
00497         }
00498 
00499         RtlZeroMemory( ServerPort, <span class="keyword">sizeof</span>( LPCP_PORT_OBJECT ));
00500 
00501         ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o0">Length</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a> );
00502         ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o8">PortContext</a> = PortContext;
00503         ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> = <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>;
00504 
00505         InitializeListHead( &amp;ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a> );
00506         InitializeListHead( &amp;ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o15">LpcDataInfoChainHead</a> );
00507 
00508         <span class="comment">//</span>
00509         <span class="comment">//  Connect the newly created server communication port to the</span>
00510         <span class="comment">//  connection port with a referenced pointer.  Prevents the</span>
00511         <span class="comment">//  connection port from going away until all of the communication</span>
00512         <span class="comment">//  ports have been closed.</span>
00513         <span class="comment">//</span>
00514 
00515         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( ConnectionPort );
00516 
00517         ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a> = ConnectionPort;
00518         ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a> = ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>;
00519 
00520         <span class="comment">//</span>
00521         <span class="comment">//  Connect the client and server communication ports together</span>
00522         <span class="comment">//  with unreferenced pointers.  They are unreferenced so that</span>
00523         <span class="comment">//  the PortObjectType delete procedure will get called when a</span>
00524         <span class="comment">//  communication port is closed.  If this were not the case then</span>
00525         <span class="comment">//  we would need a special NtClosePort system service in order</span>
00526         <span class="comment">//  to tear down a pair of connected communication ports.</span>
00527         <span class="comment">//</span>
00528 
00529         ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a> = ClientPort;
00530         ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a> = ServerPort;
00531 
00532         ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o5">Creator</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid;
00533         ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o5">Creator</a> = Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.ClientId;
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">//  If the client has allocated a port memory section that is mapped</span>
00537         <span class="comment">//  into the client's address space, then map a view of the same</span>
00538         <span class="comment">//  section for the server process to see.</span>
00539         <span class="comment">//</span>
00540 
00541         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00542 
00543         ClientSectionToMap = ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o2">SectionToMap</a>;
00544         ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o2">SectionToMap</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 
00546         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00547 
00548         <span class="keywordflow">if</span> (ClientSectionToMap) {
00549 
00550             LARGE_INTEGER LargeSectionOffset;
00551 
00552             LargeSectionOffset.LowPart = ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o0">ClientView</a>.SectionOffset;
00553             LargeSectionOffset.HighPart = 0;
00554 
00555             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>( ClientSectionToMap,
00556                                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00557                                          &amp;ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o6">ClientSectionBase</a>,
00558                                          0,
00559                                          0,
00560                                          &amp;LargeSectionOffset,
00561                                          &amp;ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o0">ClientView</a>.ViewSize,
00562                                          ViewUnmap,
00563                                          0,
00564                                          PAGE_READWRITE );
00565 
00566             ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o0">ClientView</a>.SectionOffset = LargeSectionOffset.LowPart;
00567 
00568             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00569 
00570                 ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o0">ClientView</a>.ViewRemoteBase = ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o6">ClientSectionBase</a>;
00571 
00572             } <span class="keywordflow">else</span> {
00573 
00574                 <span class="comment">//</span>
00575                 <span class="comment">//  At this point we're really going to drop all the way</span>
00576                 <span class="comment">//  out to the label bailout: because everything else is</span>
00577                 <span class="comment">//  protected with a test against Status.  But first we have</span>
00578                 <span class="comment">//  to release the server port that we've just created</span>
00579                 <span class="comment">//</span>
00580 
00581                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ServerPort );
00582             }
00583         }
00584 
00585         <span class="comment">//</span>
00586         <span class="comment">//  If the server process has allocated a port memory section for</span>
00587         <span class="comment">//  send data to the client on call back requests, map two views</span>
00588         <span class="comment">//  of that section, the first for the server process and the</span>
00589         <span class="comment">//  second view for the client process.  Return the location of the</span>
00590         <span class="comment">//  server's view to the caller of this function.  Return the</span>
00591         <span class="comment">//  client's view to the client process via the reply to the</span>
00592         <span class="comment">//  connection request.</span>
00593         <span class="comment">//</span>
00594 
00595         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; ARGUMENT_PRESENT( ServerView )) {
00596 
00597             LARGE_INTEGER LargeSectionOffset;
00598 
00599             LargeSectionOffset.LowPart = CapturedServerView.SectionOffset;
00600             LargeSectionOffset.HighPart = 0;
00601 
00602             <span class="comment">//</span>
00603             <span class="comment">//  Map in the section into the servers address space</span>
00604             <span class="comment">//</span>
00605 
00606             <span class="comment">//</span>
00607             <span class="comment">//  **** Does this call need to verify that the section handle</span>
00608             <span class="comment">//       is still valid.</span>
00609             <span class="comment">//</span>
00610 
00611             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( CapturedServerView.SectionHandle,
00612                                                 SECTION_MAP_READ |
00613                                                 SECTION_MAP_WRITE,
00614                                                 MmSectionObjectType,
00615                                                 PreviousMode,
00616                                                 (PVOID *)&amp;SectionToMap,
00617                                                 NULL );
00618 
00619             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00620 
00621                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>( SectionToMap,
00622                                              <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00623                                              &amp;ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o7">ServerSectionBase</a>,
00624                                              0,
00625                                              0,
00626                                              &amp;LargeSectionOffset,
00627                                              &amp;CapturedServerView.ViewSize,
00628                                              ViewUnmap,
00629                                              0,
00630                                              PAGE_READWRITE );
00631 
00632                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00633 
00634                     CapturedServerView.SectionOffset = LargeSectionOffset.LowPart;
00635 
00636                     CapturedServerView.ViewBase = ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o7">ServerSectionBase</a>;
00637 
00638 
00639                     SectionOffset.LowPart = CapturedServerView.SectionOffset;
00640                     SectionOffset.HighPart = 0;
00641 
00642                     ViewSize = CapturedServerView.ViewSize;
00643 
00644                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>( SectionToMap,
00645                                                  ClientProcess,
00646                                                  &amp;ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o7">ServerSectionBase</a>,
00647                                                  0,
00648                                                  0,
00649                                                  &amp;SectionOffset,
00650                                                  &amp;ViewSize,
00651                                                  ViewUnmap,
00652                                                  0,
00653                                                  PAGE_READWRITE );
00654 
00655                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00656 
00657                         <span class="comment">//</span>
00658                         <span class="comment">//  Let the server know where the client's view of the</span>
00659                         <span class="comment">//  section got mapped</span>
00660                         <span class="comment">//</span>
00661 
00662                         CapturedServerView.ViewRemoteBase = ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o7">ServerSectionBase</a>;
00663 
00664                         <span class="comment">//</span>
00665                         <span class="comment">//  Let the client know where the server's view of the</span>
00666                         <span class="comment">//  section got mapped</span>
00667                         <span class="comment">//</span>
00668 
00669                         ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o3">ServerView</a>.ViewBase = ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o7">ServerSectionBase</a>;
00670                         ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o3">ServerView</a>.ViewSize = ViewSize;
00671 
00672                     } <span class="keywordflow">else</span> {
00673 
00674                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ServerPort );
00675                     }
00676 
00677                 } <span class="keywordflow">else</span> {
00678 
00679                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ServerPort );
00680                 }
00681 
00682                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
00683 
00684             } <span class="keywordflow">else</span> {
00685 
00686                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ServerPort );
00687             }
00688         }
00689 
00690         <span class="comment">//</span>
00691         <span class="comment">//  Insert the server communication port object in specified object</span>
00692         <span class="comment">//  table.  Set port handle value if successful.  If not</span>
00693         <span class="comment">//  successful, then the port will have been dereferenced, which</span>
00694         <span class="comment">//  will cause it to be freed, after our delete procedure is</span>
00695         <span class="comment">//  called.  The delete procedure will undo the work done to</span>
00696         <span class="comment">//  initialize the port.</span>
00697         <span class="comment">//</span>
00698 
00699         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00700 
00701             <span class="comment">//</span>
00702             <span class="comment">//  Add an extra reference to the object otherwise right when we</span>
00703             <span class="comment">//  create the handle a rouge caller might close and destroy the</span>
00704             <span class="comment">//  port.</span>
00705             <span class="comment">//</span>
00706 
00707             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( ServerPort );
00708 
00709             <span class="comment">//</span>
00710             <span class="comment">//  Now add the handle</span>
00711             <span class="comment">//</span>
00712 
00713             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( ServerPort,
00714                                      NULL,
00715                                      PORT_ALL_ACCESS,
00716                                      0,
00717                                      (PVOID *)NULL,
00718                                      &amp;Handle );
00719 
00720             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00721 
00722                 <span class="keywordflow">try</span> {
00723 
00724                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
00725 
00726                         *ServerView = CapturedServerView;
00727                     }
00728 
00729                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00730 
00731                         ClientView-&gt;ViewBase = ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o0">ClientView</a>.ViewRemoteBase;
00732                         ClientView-&gt;ViewSize = ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o0">ClientView</a>.ViewSize;
00733                     }
00734 
00735                     *<a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00736 
00737                     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( PortContext )) {
00738 
00739                         ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o8">PortContext</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00740                     }
00741 
00742                     ServerPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o11">ClientThread</a> = <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00743 
00744                     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00745                     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessage = Msg;
00746                     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00747 
00748                     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00749 
00750                 } except( EXCEPTION_EXECUTE_HANDLER ) {
00751 
00752                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Handle );
00753                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00754                 }
00755             }
00756 
00757             <span class="comment">//</span>
00758             <span class="comment">//  Now we can remove the extra object reference</span>
00759             <span class="comment">//</span>
00760 
00761             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ServerPort );
00762         }
00763 
00764     } <span class="keywordflow">else</span> {
00765 
00766         <span class="comment">//</span>
00767         <span class="comment">//  Otherwise the server has not accepted the connection request</span>
00768         <span class="comment">//</span>
00769 
00770         <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"Refusing connection from %x.%x\n"</span>,
00771                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.ClientId.UniqueProcess,
00772                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.ClientId.UniqueThread ));
00773     }
00774 
00775 bailout:
00776 
00777     <span class="keywordflow">if</span> ( ClientSectionToMap ) {
00778 
00779         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientSectionToMap );
00780     }
00781 
00782     <span class="comment">//</span>
00783     <span class="comment">//  If the client is not null then this is an error condition and we need</span>
00784     <span class="comment">//  to cleanup and wake the client thread.  In success cases the client</span>
00785     <span class="comment">//  thread is woken up with a call to Complete Connect Request</span>
00786     <span class="comment">//</span>
00787 
00788     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00789 
00790         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00791 
00792         <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessage = Msg;
00793 
00794         <span class="keywordflow">if</span> (AcceptConnection) {
00795 
00796             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"LPC: Failing AcceptConnection with Status == %x\n"</span>, Status ));
00797         }
00798 
00799         <a class="code" href="../../d4/d6/lpccompl_8c.html#a0">LpcpPrepareToWakeClient</a>( ClientThread );
00800 
00801         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00802 
00803         <span class="comment">//</span>
00804         <span class="comment">//  Wake up the thread that is waiting for an answer to its connection</span>
00805         <span class="comment">//  request inside of NtConnectPort.</span>
00806         <span class="comment">//</span>
00807 
00808         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplySemaphore,
00809                             0,
00810                             1L,
00811                             FALSE );
00812 
00813         <span class="comment">//</span>
00814         <span class="comment">//  Dereference client thread and return the system service status.</span>
00815         <span class="comment">//</span>
00816 
00817         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00818     }
00819 
00820     <span class="keywordflow">if</span> (ClientPort) {
00821 
00822         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00823     }
00824 
00825     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientProcess );
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">//  And return to our caller</span>
00829     <span class="comment">//</span>
00830 
00831     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00832 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lpccompl.c::NtCompleteConnectPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCompleteConnectPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PortHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00836">836</a> of file <a class="el" href="../../d5/d5/lpccompl_8c-source.html">lpccompl.c</a>.
<p>
References <a class="el" href="../../d3/d5/lpc_8h-source.html#l00116">_LPCP_PORT_OBJECT::ClientThread</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00107">_LPCP_PORT_OBJECT::ConnectionPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l01001">LpcpPrepareToWakeClient()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00278">LpcpReferencePortObject</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00119">_LPCP_PORT_OBJECT::LpcReplyChainHead</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00133">SERVER_COMMUNICATION_PORT</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00134">RtlpLpcWorkerThread()</a>, and <a class="el" href="../../d9/d0/userver_8c-source.html#l00037">ServerHandleConnectionRequest()</a>.
<p>
<pre class="fragment"><div>00842                    :
00843 
00844     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server after <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> calls <a class="code" href="../../d4/d6/lpccompl_8c.html#a1">NtAcceptConnectPort</a> to
00845     wake up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client thread.  Between calling <a class="code" href="../../d4/d6/lpccompl_8c.html#a1">NtAcceptConnectPort</a> and
00846     <a class="code" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server can <span class="keywordflow">do</span> whatever work <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary before
00847     waking up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
00848 
00849 Arguments:
00850 
00851     <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server communcation port
00852 
00853 Return Value:
00854 
00855     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - An appropriate status value.
00856 
00857 --*/
00858 
00859 {
00860     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject;
00861     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00862     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00863     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00864 
00865     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00866 
00867     <span class="comment">//</span>
00868     <span class="comment">//  Get previous processor mode</span>
00869     <span class="comment">//</span>
00870 
00871     PreviousMode = KeGetPreviousMode();
00872 
00873     <span class="comment">//</span>
00874     <span class="comment">//  Reference the port object by handle</span>
00875     <span class="comment">//</span>
00876 
00877     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/lpcp_8h.html#a10">LpcpReferencePortObject</a>( PortHandle,
00878                                       0,
00879                                       PreviousMode,
00880                                       &amp;PortObject );
00881 
00882     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00883 
00884         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00885     }
00886 
00887     <span class="comment">//</span>
00888     <span class="comment">//  Error if a port type is invalid.</span>
00889     <span class="comment">//</span>
00890 
00891     <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
00892 
00893         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00894 
00895         <span class="keywordflow">return</span> STATUS_INVALID_PORT_HANDLE;
00896     }
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">//  Under the LPC lock we need to check for a client thread and if there</span>
00900     <span class="comment">//  is one we'll remember and remove the client thread, and then prepare</span>
00901     <span class="comment">//  to wake the client</span>
00902     <span class="comment">//</span>
00903 
00904     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00905 
00906     <span class="keywordflow">if</span> (PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o11">ClientThread</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00907 
00908         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00909 
00910         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00911 
00912         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00913     }
00914 
00915     <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a> = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o11">ClientThread</a>;
00916 
00917     <span class="comment">//</span>
00918     <span class="comment">//  Double check that the thread is still waiting for a reply message</span>
00919     <span class="comment">//</span>
00920 
00921     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00922 
00923         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00924 
00925         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00926 
00927         <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
00928     }
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">//  The check needs to ensure that the client thread is really on the</span>
00932     <span class="comment">//  reply chain for the sever's connection port.  This is a quick and</span>
00933     <span class="comment">//  dirty fix for NT 5.0.  We zoom down the connection port lpc reply</span>
00934     <span class="comment">//  chain looking for an entry that contains the client threads.  If</span>
00935     <span class="comment">//  we find a match it's okay if we don't it's bad.</span>
00936     <span class="comment">//</span>
00937 
00938     {
00939         PLIST_ENTRY Entry;
00940 
00941         <span class="keywordflow">for</span> (Entry = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>.Flink;
00942              Entry != (PLIST_ENTRY)(&amp;PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>.Flink);
00943              Entry = Entry-&gt;Flink) {
00944 
00945             <span class="keywordflow">if</span> (Entry == ((PLIST_ENTRY)(&amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyChain.Flink))) {
00946 
00947                 <span class="keywordflow">break</span>;
00948             }
00949         }
00950 
00951         <span class="keywordflow">if</span> (Entry != ((PLIST_ENTRY)(&amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyChain.Flink))) {
00952 
00953             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00954 
00955             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00956 
00957             <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
00958         }
00959     }
00960 
00961     <span class="comment">//</span>
00962     <span class="comment">//  Now do the wakeup</span>
00963     <span class="comment">//</span>
00964 
00965     PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o11">ClientThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00966 
00967     <a class="code" href="../../d4/d6/lpccompl_8c.html#a0">LpcpPrepareToWakeClient</a>( ClientThread );
00968 
00969     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00970 
00971     <span class="comment">//</span>
00972     <span class="comment">//  Wake up the thread that is waiting for an answer to its connection</span>
00973     <span class="comment">//  request inside of NtConnectPort.</span>
00974     <span class="comment">//</span>
00975 
00976     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplySemaphore,
00977                         0,
00978                         1L,
00979                         FALSE );
00980 
00981     <span class="comment">//</span>
00982     <span class="comment">//  Dereference client thread</span>
00983     <span class="comment">//</span>
00984 
00985     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00986     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00987 
00988     <span class="comment">//</span>
00989     <span class="comment">//  And return to our caller</span>
00990     <span class="comment">//</span>
00991 
00992     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00993 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
