<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: layout.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>layout.c File Reference</h1><code>#include "<a class="el" href="../../d9/d2/w32_2ntuser_2imm_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d5/d0/layout_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a0">szLZOpenFileW</a>&nbsp;&nbsp;&nbsp;"LZOpenFileW"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a1">szLZCopy</a>&nbsp;&nbsp;&nbsp;"LZCopy"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a2">szLZClose</a>&nbsp;&nbsp;&nbsp;"LZClose"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a3">GET_PROC</a>(x)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef HFILE(WINAPI *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a4">LPFNLZOPENFILEW</a> )(LPTSTR, LPOFSTRUCT, WORD)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef LONG(WINAPI *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a5">LPFNLZCOPY</a> )(<a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>, <a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(WINAPI *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a6">LPFNLZCLOSE</a> )(<a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a7">StrToUInt</a> (LPWSTR)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a> (UINT, ULONG, LPWSTR, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a9">CopyImeFile</a> (LPWSTR, LPCWSTR)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a10">GetImeLayout</a> (<a class="el" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a>, <a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a11">WriteImeLayout</a> (HKL, LPCWSTR, LPCWSTR)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HKL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a12">AssignNewLayout</a> (<a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>, <a class="el" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a>, HKL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a13">ImmGetDescriptionW</a> (HKL hKL, LPWSTR lpwszDescription, UINT uBufLen)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a14">ImmGetDescriptionA</a> (HKL hKL, LPSTR lpszDescription, UINT uBufLen)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a15">ImmGetIMEFileNameW</a> (HKL hKL, LPWSTR lpwszFile, UINT uBufLen)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a16">ImmGetIMEFileNameA</a> (HKL hKL, LPSTR lpszFile, UINT uBufLen)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a17">ImmGetProperty</a> (HKL hKL, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HKL WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a18">ImmInstallIMEW</a> (LPCWSTR lpszIMEFileName, LPCWSTR lpszLayoutText)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HKL WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a19">ImmInstallIMEA</a> (LPCSTR lpszIMEFileName, LPCSTR lpszLayoutText)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/layout_8c.html#a20">ImmIsIME</a> (HKL hKL)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a3" doxytag="layout.c::GET_PROC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GET_PROC          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (!(lpfn##x = (PVOID) GetProcAddress(hLzExpandDll, sz##x))) { \
        <span class="keywordflow">goto</span> CopyImeFileFailed; }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="layout.c::szLZClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define szLZClose&nbsp;&nbsp;&nbsp;"LZClose"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00020">20</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="layout.c::szLZCopy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define szLZCopy&nbsp;&nbsp;&nbsp;"LZCopy"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00019">19</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="layout.c::szLZOpenFileW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define szLZOpenFileW&nbsp;&nbsp;&nbsp;"LZOpenFileW"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00018">18</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a6" doxytag="layout.c::LPFNLZCLOSE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(WINAPI * <a class="el" href="../../d4/d1/layout_8c.html#a6">LPFNLZCLOSE</a>)(<a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00024">24</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00516">CopyImeFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="layout.c::LPFNLZCOPY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef LONG(WINAPI * <a class="el" href="../../d4/d1/layout_8c.html#a5">LPFNLZCOPY</a>)(<a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>, <a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00023">23</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00516">CopyImeFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="layout.c::LPFNLZOPENFILEW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef HFILE(WINAPI * <a class="el" href="../../d4/d1/layout_8c.html#a4">LPFNLZOPENFILEW</a>)(LPTSTR, LPOFSTRUCT, WORD)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00022">22</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00516">CopyImeFile()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="layout.c::AssignNewLayout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HKL AssignNewLayout           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a>&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HKL&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00793">793</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, and <a class="el" href="../../d5/d9/immcli_8h-source.html#l00054">tagIMELAYOUT::hImeKL</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00266">ImmInstallIMEW()</a>.
<p>
<pre class="fragment"><div>00797 {
00798     <span class="keywordtype">int</span>   i;
00799     HKL   hHighKL, hLowKL;
00800     HKL   hImeNewKL;
00801 
00802     <span class="comment">/*</span>
00803 <span class="comment">     * We prefer the value higher than E01F for ISVs, we will use</span>
00804 <span class="comment">     * E001 ~ E01F in Microsoft .INF file</span>
00805 <span class="comment">     */</span>
00806     hHighKL = (HKL)((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0xE01F0000 + (ULONG_PTR)hLangKL);
00807     hLowKL  = (HKL)((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0xE0FF0000 + (ULONG_PTR)hLangKL);
00808 
00809     <span class="comment">/*</span>
00810 <span class="comment">     * Find out the high and low one</span>
00811 <span class="comment">     */</span>
00812     <span class="keywordflow">for</span> (i = 0; i &lt; nIMEs; i++) {
00813         <span class="keywordflow">if</span> (pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a> &gt; hHighKL) {
00814             hHighKL = pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a>;
00815         }
00816 
00817         <span class="keywordflow">if</span> (pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a> &lt; hLowKL) {
00818             hLowKL = pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a>;
00819         }
00820     }
00821 
00822     <span class="comment">/*</span>
00823 <span class="comment">     * This way is more preferable for app consideration</span>
00824 <span class="comment">     * we don't want app think this is a old keyboard layout</span>
00825 <span class="comment">     * some apps will put hKL into their documents.</span>
00826 <span class="comment">     */</span>
00827     <span class="keywordflow">if</span> (hHighKL &lt; (HKL)UIntToPtr( 0xE0FF0000 )) {
00828         hImeNewKL = (HKL)((ULONG_PTR)hHighKL + (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0x10000);
00829     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hLowKL  &gt; (HKL)UIntToPtr( 0xE0010000 )) {
00830         hImeNewKL = (HKL)((ULONG_PTR)hLowKL  - (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0x10000);
00831     } <span class="keywordflow">else</span> {
00832         <span class="comment">/*</span>
00833 <span class="comment">         * find out a hKL using search, find it one by one</span>
00834 <span class="comment">         */</span>
00835         <span class="keywordflow">for</span> (hLowKL = (HKL)((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0xE0200000 + (ULONG_PTR)hLangKL);
00836              hLowKL &lt; (HKL)UIntToPtr( 0xE1000000 );
00837              hLowKL = (HKL)((ULONG_PTR)hLowKL + (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0x10000)) {
00838 
00839             <span class="keywordflow">for</span> (i = 0; i &lt; nIMEs; i++) {
00840                  <span class="keywordflow">if</span> (HIWORD(HandleToUlong(pImeLayout[i].hImeKL)) == HIWORD(HandleToUlong(hLowKL))) {
00841                      <span class="comment">// conflict with existing IME, try next hLowKL</span>
00842                      <span class="keywordflow">break</span>;
00843                  }
00844             }
00845 
00846             <span class="keywordflow">if</span> (i &gt;= nIMEs) {
00847                 <span class="keywordflow">break</span>;
00848             }
00849         }
00850 
00851         <span class="keywordflow">if</span> (hLowKL &gt;= (HKL)UIntToPtr( 0xE1000000 )) {
00852             hImeNewKL = (HKL)0;
00853         }
00854         <span class="keywordflow">else</span> {
00855             hImeNewKL = hLowKL;
00856         }
00857     }
00858 
00859     <span class="keywordflow">return</span> hImeNewKL;
00860 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="layout.c::CopyImeFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL CopyImeFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPWSTR&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCWSTR&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00516">516</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>, <a class="el" href="../../d4/d0/layime_8c-source.html#l00095">GetSystemPathName()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00557">ImmLocalAlloc()</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00137">ImmLocalFree</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00024">LPFNLZCLOSE</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00023">LPFNLZCOPY</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00022">LPFNLZOPENFILEW</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00266">ImmInstallIMEW()</a>.
<p>
<pre class="fragment"><div>00519 {
00520     HMODULE         hLzExpandDll;
00521     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fUnloadExpandDll;
00522     <a class="code" href="../../d4/d1/layout_8c.html#a4">LPFNLZOPENFILEW</a> lpfnLZOpenFileW;
00523     <a class="code" href="../../d4/d1/layout_8c.html#a5">LPFNLZCOPY</a>      lpfnLZCopy;
00524     <a class="code" href="../../d4/d1/layout_8c.html#a6">LPFNLZCLOSE</a>     lpfnLZClose;
00525     OFSTRUCT        ofStruc;
00526     HFILE           hfSource, hfDest;
00527     LPSTR           lpszImeCopiedPath;
00528     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             i, cbBuffer;
00529     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00530 
00531     hLzExpandDll = GetModuleHandle(L<span class="stringliteral">"LZ32"</span>);
00532     <span class="keywordflow">if</span> (hLzExpandDll) {
00533         fUnloadExpandDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00534     } <span class="keywordflow">else</span> {
00535         WCHAR szLzExpand[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00536 
00537         <a class="code" href="../../d3/d1/layime_8c.html#a17">GetSystemPathName</a>(szLzExpand, L<span class="stringliteral">"LZ32"</span>, MAX_PATH);
00538         hLzExpandDll = LoadLibrary(szLzExpand);
00539         <span class="keywordflow">if</span> (!hLzExpandDll) {
00540             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541         }
00542 
00543         fUnloadExpandDll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00544     }
00545 
00546 <span class="preprocessor">#define GET_PROC(x) \</span>
00547 <span class="preprocessor">    if (!(lpfn##x = (PVOID) GetProcAddress(hLzExpandDll, sz##x))) { \</span>
00548 <span class="preprocessor">        goto CopyImeFileFailed; }</span>
00549 <span class="preprocessor"></span>
00550     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(LZOpenFileW);
00551     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(LZCopy);
00552     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(LZClose);
00553 
00554 <span class="preprocessor">#undef GET_PROC</span>
00555 <span class="preprocessor"></span>
00556     cbBuffer = (wcslen(lpwszImeCopiedPath) + 1) * <span class="keyword">sizeof</span>(WCHAR);
00557 
00558     <span class="keywordflow">if</span> ((lpszImeCopiedPath = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cbBuffer)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00559         <span class="keywordflow">goto</span> CopyImeFileFailed;
00560 
00561     i = WideCharToMultiByte(CP_ACP,
00562                             (DWORD)0,
00563                             lpwszImeCopiedPath,          <span class="comment">// src</span>
00564                             wcslen(lpwszImeCopiedPath),
00565                             lpszImeCopiedPath,           <span class="comment">// dest</span>
00566                             cbBuffer,
00567                             (LPSTR)NULL,
00568                             (LPBOOL)NULL);
00569     <span class="keywordflow">if</span> (i == 0) {
00570         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpszImeCopiedPath);
00571         <span class="keywordflow">goto</span> CopyImeFileFailed;
00572     }
00573 
00574     lpszImeCopiedPath[i] = <span class="charliteral">'\0'</span>;
00575 
00576     hfSource = (*lpfnLZOpenFileW)(lpwszImeFileName, &amp;ofStruc, OF_READ);
00577     <span class="keywordflow">if</span> (hfSource &lt; 0) {
00578         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpszImeCopiedPath);
00579         <span class="keywordflow">goto</span> CopyImeFileFailed;
00580     }
00581 
00582     hfDest = OpenFile(lpszImeCopiedPath, &amp;ofStruc, OF_CREATE);
00583     <span class="keywordflow">if</span> (hfDest != HFILE_ERROR) {
00584         <span class="keywordflow">if</span> ((*lpfnLZCopy)(hfSource, hfDest) &gt;= 0) {
00585             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00586         }
00587         _lclose(hfDest);
00588     }
00589 
00590     (*lpfnLZClose)(hfSource);
00591 
00592     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpszImeCopiedPath);
00593 
00594 CopyImeFileFailed:
00595     <span class="keywordflow">if</span> (fUnloadExpandDll)
00596         FreeLibrary(hLzExpandDll);
00597 
00598     <span class="keywordflow">return</span> fRet;
00599 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="layout.c::GetImeLayout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a> GetImeLayout           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a>&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d1/bench_8h.html#a7">INT</a>&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00602">602</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d5/ntuser_2imm_2globals_8c-source.html#l00045">gszRegKbdLayout</a>, <a class="el" href="../../d3/d5/ntuser_2imm_2globals_8c-source.html#l00051">gszValImeFile</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00051">HEX_ASCII_SIZE</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00054">tagIMELAYOUT::hImeKL</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00065">IM_FILE_SIZE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d0/layout_8c-source.html#l00480">StrToUInt()</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00266">ImmInstallIMEW()</a>.
<p>
<pre class="fragment"><div>00605 {
00606     <span class="keywordtype">int</span>      i, nIMEs;
00607     HKEY     hKeyKbdLayout;
00608     HKEY     hKeyOneIME;
00609     WCHAR    szKeyName[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00610     WCHAR    szImeFileName[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>];
00611     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwKeyNameSize;
00612     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwTmp;
00613 
00614     RegOpenKey(HKEY_LOCAL_MACHINE, gszRegKbdLayout, &amp;hKeyKbdLayout);
00615 
00616     dwKeyNameSize = <span class="keyword">sizeof</span>(szKeyName);
00617 
00618     <span class="keywordflow">for</span> (i = 0, nIMEs = 0;
00619          RegEnumKey(hKeyKbdLayout, i, szKeyName, dwKeyNameSize) == ERROR_SUCCESS;
00620          i++)
00621     {
00622         <span class="keywordflow">if</span> (szKeyName[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'E'</span> &amp;&amp; szKeyName[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>)
00623             <span class="keywordflow">continue</span>;   <span class="comment">// this is not an IME based keyboard layout.</span>
00624 
00625         <span class="keywordflow">if</span> (pImeLayout != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00626 
00627             <span class="keywordflow">if</span> (nIMEs &gt;= cEntery)
00628                 <span class="keywordflow">break</span>;
00629 
00630             RegOpenKey(hKeyKbdLayout, szKeyName, &amp;hKeyOneIME);
00631 
00632             dwTmp = <a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>;
00633 
00634             RegQueryValueEx(hKeyOneIME,
00635                     gszValImeFile,
00636                     NULL,
00637                     NULL,
00638                     (LPBYTE)szImeFileName,
00639                     &amp;dwTmp);
00640 
00641             <span class="comment">// avoid length problem</span>
00642             szImeFileName[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00643 
00644             RegCloseKey(hKeyOneIME);
00645 
00646             CharUpper(szImeFileName);
00647 
00648             pImeLayout[nIMEs].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a> = (HKL)IntToPtr( <a class="code" href="../../d4/d1/layout_8c.html#a7">StrToUInt</a>(szKeyName) );
00649             wcscpy(pImeLayout[nIMEs].szKeyName, szKeyName);
00650             wcscpy(pImeLayout[nIMEs].szImeName, szImeFileName);
00651         }
00652 
00653         nIMEs++;
00654     }
00655 
00656     RegCloseKey(hKeyKbdLayout);
00657 
00658     <span class="keywordflow">return</span> nIMEs;
00659 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="layout.c::ImmGetDescriptionA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT WINAPI ImmGetDescriptionA           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpszDescription</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>uBufLen</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00087">87</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00876">ImmGetImeInfoEx()</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00108">tagIMEINFOEX::wszImeDescription</a>.
<p>
<pre class="fragment"><div>00091 {
00092     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00093     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>       i;
00094     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      bUDC;
00095 
00096     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, ImeInfoExKeyboardLayout, &amp;hKL))
00097         <span class="keywordflow">return</span> 0;
00098 
00099     i = WideCharToMultiByte(CP_ACP,
00100                             (DWORD)0,
00101                             (LPWSTR)iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>,       <span class="comment">// src</span>
00102                             wcslen(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>),
00103                             lpszDescription,                      <span class="comment">// dest</span>
00104                             uBufLen,
00105                             (LPSTR)NULL,
00106                             (LPBOOL)&amp;bUDC);
00107 
00108     <span class="keywordflow">if</span> (uBufLen != 0)
00109         lpszDescription[i] = <span class="charliteral">'\0'</span>;
00110 
00111     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i;
00112 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="layout.c::ImmGetDescriptionW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT WINAPI ImmGetDescriptionW           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpwszDescription</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>uBufLen</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00046">46</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00876">ImmGetImeInfoEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00108">tagIMEINFOEX::wszImeDescription</a>.
<p>
<pre class="fragment"><div>00050 {
00051     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00052     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uRet;
00053 
00054     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, ImeInfoExKeyboardLayout, &amp;hKL))
00055         <span class="keywordflow">return</span> 0;
00056 
00057     uRet = wcslen(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>);
00058 
00059     <span class="comment">/*</span>
00060 <span class="comment">     * ask buffer length</span>
00061 <span class="comment">     */</span>
00062     <span class="keywordflow">if</span> (uBufLen == 0)
00063         <span class="keywordflow">return</span> uRet;
00064 
00065     <span class="keywordflow">if</span> (uBufLen &gt; uRet) {
00066         wcscpy(lpwszDescription, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>);
00067     }
00068     <span class="keywordflow">else</span> {
00069         uRet = uBufLen - 1;
00070         wcsncpy(lpwszDescription, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>, uRet);
00071         lpwszDescription[uRet] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00072     }
00073 
00074     <span class="keywordflow">return</span> uRet;
00075 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="layout.c::ImmGetIMEFileNameA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT WINAPI ImmGetIMEFileNameA           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpszFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>uBufLen</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00165">165</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00876">ImmGetImeInfoEx()</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00109">tagIMEINFOEX::wszImeFile</a>.
<p>
<pre class="fragment"><div>00169 {
00170     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00171     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>       i;
00172     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      bUDC;
00173 
00174     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, ImeInfoExKeyboardLayout, &amp;hKL))
00175         <span class="keywordflow">return</span> 0;
00176 
00177     i = WideCharToMultiByte(CP_ACP,
00178                             (DWORD)0,
00179                             (LPWSTR)iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>,       <span class="comment">// src</span>
00180                             wcslen(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>),
00181                             lpszFile,                      <span class="comment">// dest</span>
00182                             uBufLen,
00183                             (LPSTR)NULL,
00184                             (LPBOOL)&amp;bUDC);
00185 
00186     <span class="keywordflow">if</span> (uBufLen != 0)
00187         lpszFile[i] = <span class="charliteral">'\0'</span>;
00188 
00189     <span class="keywordflow">return</span> i;
00190 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="layout.c::ImmGetIMEFileNameW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT WINAPI ImmGetIMEFileNameW           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpwszFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>uBufLen</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00124">124</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00876">ImmGetImeInfoEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00109">tagIMEINFOEX::wszImeFile</a>.
<p>
<pre class="fragment"><div>00128 {
00129     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00130     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uRet;
00131 
00132     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, ImeInfoExKeyboardLayout, &amp;hKL))
00133         <span class="keywordflow">return</span> 0;
00134 
00135     uRet = wcslen(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>);
00136 
00137     <span class="comment">/*</span>
00138 <span class="comment">     * ask buffer length</span>
00139 <span class="comment">     */</span>
00140     <span class="keywordflow">if</span> (uBufLen == 0)
00141         <span class="keywordflow">return</span> uRet;
00142 
00143     <span class="keywordflow">if</span> (uBufLen &gt; uRet) {
00144         wcscpy(lpwszFile, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>);
00145     }
00146     <span class="keywordflow">else</span> {
00147         uRet = uBufLen - 1;
00148         wcsncpy(lpwszFile, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, uRet);
00149         lpwszFile[uRet] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00150     }
00151 
00152     <span class="keywordflow">return</span> uRet;
00153 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="layout.c::ImmGetProperty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI ImmGetProperty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00202">202</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00107">tagIMEINFOEX::dwImeWinVersion</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d9/immime_8c-source.html#l00327">FindOrLoadImeDpi()</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00105">tagIMEINFOEX::fLoadFlag</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00062">IMEF_LOADED</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00101">tagIMEINFOEX::ImeInfo</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00070">tagIMEDPI::ImeInfo</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00876">ImmGetImeInfoEx()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00824">ImmUnlockImeDpi()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/fareast_8c-source.html#l00238">_InitializeImmEntryTable()</a>, <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l01094">ConImeInputLangchange()</a>, and <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00903">ConsoleSetFocus()</a>.
<p>
<pre class="fragment"><div>00205 {
00206     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00207     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>   pImeDpi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00208     PIMEINFO  pImeInfo;
00209     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>     dwRet;
00210 
00211     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, ImeInfoExKeyboardLayout, &amp;hKL))
00212         <span class="keywordflow">return</span> 0;
00213 
00214     <span class="keywordflow">if</span> (dwIndex == IGP_GETIMEVERSION)
00215         <span class="keywordflow">return</span> iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o7">dwImeWinVersion</a>;
00216 
00217     <span class="keywordflow">if</span> (iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o5">fLoadFlag</a> != <a class="code" href="../../d8/d0/immstruc_8h.html#a20">IMEF_LOADED</a>) {
00218         pImeDpi = <a class="code" href="../../d6/d0/immime_8c.html#a11">FindOrLoadImeDpi</a>(hKL);
00219         <span class="keywordflow">if</span> (pImeDpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00220             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetProperty: load IME failure."</span>);
00221             <span class="keywordflow">return</span> 0;
00222         }
00223         pImeInfo = &amp;pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>;
00224     }
00225     <span class="keywordflow">else</span> {
00226         pImeInfo = &amp;iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o1">ImeInfo</a>;
00227     }
00228 
00229     <span class="keywordflow">switch</span> (dwIndex) {
00230     <span class="keywordflow">case</span> IGP_PROPERTY:
00231         dwRet = pImeInfo-&gt;fdwProperty;
00232         <span class="keywordflow">break</span>;
00233 
00234     <span class="keywordflow">case</span> IGP_CONVERSION:
00235         dwRet = pImeInfo-&gt;fdwConversionCaps;
00236         <span class="keywordflow">break</span>;
00237 
00238     <span class="keywordflow">case</span> IGP_SENTENCE:
00239         dwRet = pImeInfo-&gt;fdwSentenceCaps;
00240         <span class="keywordflow">break</span>;
00241 
00242     <span class="keywordflow">case</span> IGP_UI:
00243         dwRet = pImeInfo-&gt;fdwUICaps;
00244         <span class="keywordflow">break</span>;
00245 
00246     <span class="keywordflow">case</span> IGP_SETCOMPSTR:
00247         dwRet = pImeInfo-&gt;fdwSCSCaps;
00248         <span class="keywordflow">break</span>;
00249 
00250     <span class="keywordflow">case</span> IGP_SELECT:
00251         dwRet = pImeInfo-&gt;fdwSelectCaps;
00252         <span class="keywordflow">break</span>;
00253 
00254     <span class="keywordflow">default</span>:
00255         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetProperty: wrong index %lx."</span>, dwIndex);
00256         dwRet = 0;
00257         <span class="keywordflow">break</span>;
00258     }
00259 
00260     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00261 
00262     <span class="keywordflow">return</span> dwRet;
00263 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="layout.c::ImmInstallIMEA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HKL WINAPI ImmInstallIMEA           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPCSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpszIMEFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpszLayoutText</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00407">407</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00266">ImmInstallIMEW()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00557">ImmLocalAlloc()</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00137">ImmLocalFree</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>.
<p>
<pre class="fragment"><div>00410 {
00411     HKL    hKL;
00412     LPWSTR lpwszIMEFileName;
00413     LPWSTR lpwszLayoutText;
00414     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  cbIMEFileName;
00415     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  cbLayoutText;
00416     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>    i;
00417 
00418     cbIMEFileName = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszIMEFileName) + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
00419     cbLayoutText  = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszLayoutText)  + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
00420 
00421     lpwszIMEFileName = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cbIMEFileName * <span class="keyword">sizeof</span>(WCHAR));
00422     <span class="keywordflow">if</span> (lpwszIMEFileName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmInstallIMEA: memory failure!"</span>);
00424         <span class="keywordflow">return</span> (HKL)0;
00425     }
00426 
00427     lpwszLayoutText = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cbLayoutText * <span class="keyword">sizeof</span>(WCHAR));
00428     <span class="keywordflow">if</span> (lpwszLayoutText == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmInstallIMEA: memory failure!"</span>);
00430         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszIMEFileName);
00431         <span class="keywordflow">return</span> (HKL)0;
00432     }
00433 
00434     i = MultiByteToWideChar(CP_ACP,
00435                             (DWORD)MB_PRECOMPOSED,
00436                             (LPSTR)lpszIMEFileName,              <span class="comment">// src</span>
00437                             (INT)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszIMEFileName),
00438                             (LPWSTR)lpwszIMEFileName,            <span class="comment">// dest</span>
00439                             (INT)cbIMEFileName);
00440     lpwszIMEFileName[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00441 
00442     i = MultiByteToWideChar(CP_ACP,
00443                             (DWORD)MB_PRECOMPOSED,
00444                             (LPSTR)lpszLayoutText,              <span class="comment">// src</span>
00445                             (INT)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszLayoutText),
00446                             (LPWSTR)lpwszLayoutText,            <span class="comment">// dest</span>
00447                             (INT)cbLayoutText);
00448     lpwszLayoutText[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00449 
00450     hKL = <a class="code" href="../../d4/d1/layout_8c.html#a18">ImmInstallIMEW</a>(lpwszIMEFileName, lpwszLayoutText);
00451 
00452     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszLayoutText);
00453     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszIMEFileName);
00454 
00455     <span class="keywordflow">return</span> hKL;
00456 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="layout.c::ImmInstallIMEW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HKL WINAPI ImmInstallIMEW           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPCWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpszIMEFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpszLayoutText</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00266">266</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d5/d0/layout_8c-source.html#l00793">AssignNewLayout()</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00516">CopyImeFile()</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00602">GetImeLayout()</a>, <a class="el" href="../../d4/d0/layime_8c-source.html#l00095">GetSystemPathName()</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00051">HEX_ASCII_SIZE</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00054">tagIMELAYOUT::hImeKL</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00100">tagIMEINFOEX::hkl</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00065">IM_FILE_SIZE</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a75a54">ImeInfoExImeFileName</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00876">ImmGetImeInfoEx()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00557">ImmLocalAlloc()</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00137">ImmLocalFree</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d0/layime_8c-source.html#l00305">LoadVersionInfo()</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00497">UIntToStr()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04483">UnloadKeyboardLayout()</a>, <a class="el" href="../../d5/d0/layout_8c-source.html#l00662">WriteImeLayout()</a>, and <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00109">tagIMEINFOEX::wszImeFile</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00407">ImmInstallIMEA()</a>.
<p>
<pre class="fragment"><div>00269 {
00270     LPWSTR     lpwszImeFileName;
00271     LPWSTR     lpwszImeFilePart;
00272     LPWSTR     lpwszImeCopiedPath;
00273     <span class="keywordtype">int</span>        i, nIMEs;
00274     <a class="code" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a> pImeLayout = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00275     HKL        hImeKL, hLangKL;
00276     WCHAR      szKeyName[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00277     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>  iiex;
00278 
00279     lpwszImeFileName = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, (MAX_PATH+1) * <span class="keyword">sizeof</span>(WCHAR));
00280     <span class="keywordflow">if</span> (lpwszImeFileName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00281         <span class="keywordflow">return</span> (HKL)0;
00282 
00283     lpwszImeCopiedPath = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, (MAX_PATH+1) * <span class="keyword">sizeof</span>(WCHAR));
00284     <span class="keywordflow">if</span> (lpwszImeCopiedPath == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00285         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00286         <span class="keywordflow">return</span> (HKL)0;
00287     }
00288 
00289     <span class="comment">/*</span>
00290 <span class="comment">     * Get the file name only into lpwszImeFilePart</span>
00291 <span class="comment">     */</span>
00292     GetFullPathNameW(lpszIMEFileName, MAX_PATH,
00293                 lpwszImeFileName, &amp;lpwszImeFilePart);
00294 
00295     CharUpper(lpwszImeFileName);
00296 
00297     <span class="keywordflow">if</span> (lpwszImeFilePart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00298         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00299         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeCopiedPath);
00300         <span class="keywordflow">return</span> (HKL)0;
00301     }
00302 
00303     hImeKL = hLangKL = iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> = (HKL)0;
00304 
00305     wcsncpy(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, lpwszImeFilePart, IM_FILE_SIZE-1);
00306     iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00307 
00308     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/layime_8c.html#a22">LoadVersionInfo</a>(&amp;iiex) &amp;&amp; iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> != (HKL)0) {
00309         hLangKL = iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>;
00310     }
00311     <span class="keywordflow">else</span> {
00312         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00313         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeCopiedPath);
00314         <span class="keywordflow">return</span> (HKL)0;
00315     }
00316 
00317     nIMEs = <a class="code" href="../../d4/d1/layout_8c.html#a10">GetImeLayout</a>(NULL, 0);
00318     <span class="keywordflow">if</span> (nIMEs != 0) {
00319         pImeLayout = (<a class="code" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a>)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, nIMEs * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/structtagIMELAYOUT.html">IMELAYOUT</a>));
00320         <span class="keywordflow">if</span> (pImeLayout == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00321             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00322             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeCopiedPath);
00323             <span class="keywordflow">return</span> (HKL)0;
00324         }
00325 
00326         <a class="code" href="../../d4/d1/layout_8c.html#a10">GetImeLayout</a>(pImeLayout, nIMEs);
00327 
00328         <span class="keywordflow">for</span> (i=0; i &lt; nIMEs; i++) {
00329             <span class="keywordflow">if</span> (_wcsicmp(pImeLayout[i].szImeName, lpwszImeFilePart) == 0) {
00330                 <span class="comment">/*</span>
00331 <span class="comment">                 * We got the same IME name, ISV wants to upgrade.</span>
00332 <span class="comment">                 */</span>
00333                 <span class="keywordflow">if</span> (LOWORD(HandleToUlong(hLangKL)) != LOWORD(HandleToUlong(pImeLayout[i].hImeKL))) {
00334                     <span class="comment">/*</span>
00335 <span class="comment">                     * IME name conflict, blow out!</span>
00336 <span class="comment">                     */</span>
00337                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmInstallIME: different language!"</span>);
00338                     <span class="keywordflow">goto</span> ImmInstallIMEWFailed;
00339                 }
00340 
00341                 hImeKL = pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a>;
00342                 <span class="keywordflow">break</span>;
00343             }
00344         }
00345     }
00346 
00347     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, ImeInfoExImeFileName, lpwszImeFilePart)) {
00348         <span class="comment">/*</span>
00349 <span class="comment">         * The specified IME has been activated. Unload it first.</span>
00350 <span class="comment">         */</span>
00351         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/client_8c.html#a153">UnloadKeyboardLayout</a>(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>)) {
00352             hImeKL = (HKL)0;
00353             <span class="keywordflow">goto</span> ImmInstallIMEWFailed;
00354         }
00355     }
00356 
00357     <span class="comment">/*</span>
00358 <span class="comment">     * We will copy to system directory</span>
00359 <span class="comment">     */</span>
00360 <span class="preprocessor">#if 0</span>
00361 <span class="preprocessor"></span>    i = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)GetSystemDirectory(lpwszImeCopiedPath, MAX_PATH);
00362     lpwszImeCopiedPath[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00363     AddBackslash(lpwszImeCopiedPath);
00364     wcscat(lpwszImeCopiedPath, lpwszImeFilePart);
00365 <span class="preprocessor">#else</span>
00366 <span class="preprocessor"></span>    <a class="code" href="../../d3/d1/layime_8c.html#a17">GetSystemPathName</a>(lpwszImeCopiedPath, lpwszImeFilePart, MAX_PATH);
00367 <span class="preprocessor">#endif</span>
00368 <span class="preprocessor"></span>    CharUpper(lpwszImeCopiedPath);
00369 
00370     <span class="keywordflow">if</span> (_wcsicmp(lpwszImeFileName, lpwszImeCopiedPath) != 0) {
00371         <span class="comment">/*</span>
00372 <span class="comment">         * path is different, need to copy into system directory</span>
00373 <span class="comment">         */</span>
00374         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/layout_8c.html#a9">CopyImeFile</a>(lpwszImeFileName, lpwszImeCopiedPath)) {
00375             hImeKL = (HKL)0;
00376             <span class="keywordflow">goto</span> ImmInstallIMEWFailed;
00377         }
00378     }
00379 
00380     <span class="keywordflow">if</span> (hImeKL == 0) {
00381         hImeKL = <a class="code" href="../../d4/d1/layout_8c.html#a12">AssignNewLayout</a>(nIMEs, pImeLayout, hLangKL);
00382     }
00383 
00384     <span class="keywordflow">if</span> (hImeKL != 0) {
00385         <span class="comment">/*</span>
00386 <span class="comment">         * Write HKL under "keyboard layouts"</span>
00387 <span class="comment">         */</span>
00388         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/layout_8c.html#a11">WriteImeLayout</a>(hImeKL, lpwszImeFilePart, lpszLayoutText)) {
00389             <a class="code" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a>(HandleToUlong(hImeKL), 16, szKeyName, <span class="keyword">sizeof</span>(szKeyName));
00390             hImeKL = LoadKeyboardLayout(szKeyName, KLF_REPLACELANG);
00391         }
00392         <span class="keywordflow">else</span> {
00393             hImeKL = (HKL)0;
00394         }
00395     }
00396 
00397 ImmInstallIMEWFailed:
00398     <span class="keywordflow">if</span> (pImeLayout != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00399         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pImeLayout);
00400     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00401     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeCopiedPath);
00402 
00403     <span class="keywordflow">return</span> (HKL)hImeKL;
00404 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="layout.c::ImmIsIME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL WINAPI ImmIsIME           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>hKL</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00468">468</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00876">ImmGetImeInfoEx()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/fareast_8c-source.html#l00238">_InitializeImmEntryTable()</a>, <a class="el" href="../../d3/d1/hotkey_8c-source.html#l00245">CIMENonIMEToggle()</a>, <a class="el" href="../../d3/d1/hotkey_8c-source.html#l00365">CSymbolToggle()</a>, <a class="el" href="../../d7/d6/country_8c-source.html#l00159">GetOpenStatusByCodepage()</a>, <a class="el" href="../../d3/d1/hotkey_8c-source.html#l00292">IMENonIMEToggle()</a>, <a class="el" href="../../d7/d8/clwinnls_8c-source.html#l00374">ImmIMPSetIMEW()</a>, <a class="el" href="../../d3/d1/hotkey_8c-source.html#l00155">JCloseOpen()</a>, <a class="el" href="../../d7/d6/country_8c-source.html#l00525">MakeInfoStringPRC()</a>, <a class="el" href="../../d7/d6/country_8c-source.html#l00298">MakeInfoStringTaiwan()</a>, <a class="el" href="../../d7/d8/clwinnls_8c-source.html#l00081">SendIMEMessageAll()</a>, <a class="el" href="../../d3/d4/transsub_8c-source.html#l00932">TransEnterWordRegisterMode()</a>, and <a class="el" href="../../d3/d1/hotkey_8c-source.html#l00415">TShapeToggle()</a>.
<p>
<pre class="fragment"><div>00470 {
00471     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00472 
00473     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, ImeInfoExKeyboardLayout, &amp;hKL))
00474         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00475 
00476     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00477 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="layout.c::StrToUInt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT StrToUInt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPWSTR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00480">480</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00225">RtlUnicodeStringToInteger()</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00602">GetImeLayout()</a>.
<p>
<pre class="fragment"><div>00482 {
00483     UNICODE_STRING Value;
00484     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> ReturnValue;
00485 
00486     Value.Length = wcslen(lpsz) * <span class="keyword">sizeof</span>(WCHAR);
00487     Value.Buffer = lpsz;
00488 
00489     <span class="comment">/*</span>
00490 <span class="comment">     * Convert string to int.</span>
00491 <span class="comment">     */</span>
00492     <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;Value, 16, &amp;ReturnValue);
00493     <span class="keywordflow">return</span>(ReturnValue);
00494 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="layout.c::UIntToStr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UIntToStr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UINT&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00497">497</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00433">RtlIntegerToUnicodeString()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00266">ImmInstallIMEW()</a>, and <a class="el" href="../../d5/d0/layout_8c-source.html#l00662">WriteImeLayout()</a>.
<p>
<pre class="fragment"><div>00502 {
00503     UNICODE_STRING <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00504 
00505     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length = dwBufLen;
00506     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.MaximumLength = dwBufLen;
00507     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer = lpsz;
00508 
00509     <span class="comment">/*</span>
00510 <span class="comment">     * Convert int to string.</span>
00511 <span class="comment">     */</span>
00512     <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>(Value, Base, &amp;String);
00513 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="layout.c::WriteImeLayout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL WriteImeLayout           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCWSTR&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCWSTR&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/layout_8c-source.html#l00662">662</a> of file <a class="el" href="../../d5/d0/layout_8c-source.html">layout.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/ntuser_2imm_2globals_8c-source.html#l00045">gszRegKbdLayout</a>, <a class="el" href="../../d3/d5/ntuser_2imm_2globals_8c-source.html#l00048">gszRegKbdOrder</a>, <a class="el" href="../../d3/d5/ntuser_2imm_2globals_8c-source.html#l00051">gszValImeFile</a>, <a class="el" href="../../d3/d5/ntuser_2imm_2globals_8c-source.html#l00050">gszValLayoutFile</a>, <a class="el" href="../../d3/d5/ntuser_2imm_2globals_8c-source.html#l00049">gszValLayoutText</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00051">HEX_ASCII_SIZE</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00065">IM_FILE_SIZE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00176">LANGIDFROMHKL</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d0/layout_8c-source.html#l00497">UIntToStr()</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/layout_8c-source.html#l00266">ImmInstallIMEW()</a>.
<p>
<pre class="fragment"><div>00666 {
00667     <span class="keywordtype">int</span>      i;
00668     HKEY     hKeyKbdLayout;
00669     HKEY     hKeyOneIME;
00670     HKEY     hKeyKbdOrder;
00671     WCHAR    szKeyName[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00672     WCHAR    szImeFileName[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>];
00673     WCHAR    szOrderNum[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00674     WCHAR    szOrderKeyName[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00675     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwTmp;
00676 
00677     <span class="keywordflow">if</span> (RegOpenKey(HKEY_LOCAL_MACHINE,
00678                    gszRegKbdLayout,
00679                    &amp;hKeyKbdLayout) != ERROR_SUCCESS) {
00680         RIPMSG0(RIP_WARNING, <span class="stringliteral">"WriteImeLayout: RegOpenKey() failed!"</span>);
00681         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00682     }
00683 
00684     <a class="code" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a>(HandleToUlong(hImeKL), 16, szKeyName, <span class="keyword">sizeof</span>(szKeyName));
00685 
00686     <span class="keywordflow">if</span> (RegCreateKey(hKeyKbdLayout,
00687                 szKeyName,
00688                 &amp;hKeyOneIME) != ERROR_SUCCESS) {
00689         RIPMSG0(RIP_WARNING, <span class="stringliteral">"WriteImeLayout: RegCreateKey() failed!"</span>);
00690         RegCloseKey(hKeyKbdLayout);
00691         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00692     }
00693 
00694     <span class="keywordflow">if</span> (RegSetValueExW(hKeyOneIME,
00695                 gszValImeFile,
00696                 0,
00697                 REG_SZ,
00698                 (CONST BYTE*)lpwszImeFilePart,
00699                 (wcslen(lpwszImeFilePart) + 1) * <span class="keyword">sizeof</span>(WCHAR)) != ERROR_SUCCESS) {
00700         <span class="keywordflow">goto</span> WriteImeLayoutFail;
00701     }
00702 
00703     <span class="keywordflow">if</span> (RegSetValueExW(hKeyOneIME,
00704                 gszValLayoutText,
00705                 0,
00706                 REG_SZ,
00707                 (CONST BYTE*)lpszLayoutText,
00708                 (wcslen(lpszLayoutText) + 1) * <span class="keyword">sizeof</span>(WCHAR)) != ERROR_SUCCESS) {
00709         <span class="keywordflow">goto</span> WriteImeLayoutFail;
00710     }
00711 
00712     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a24">LANGIDFROMHKL</a>(hImeKL)) {
00713         <span class="keywordflow">case</span> LANG_JAPANESE:
00714             wcscpy(szImeFileName, L<span class="stringliteral">"kbdjpn.dll"</span>);
00715             <span class="keywordflow">break</span>;
00716         <span class="keywordflow">case</span> LANG_KOREAN:
00717             wcscpy(szImeFileName, L<span class="stringliteral">"kbdkor.dll"</span>);
00718             <span class="keywordflow">break</span>;
00719         <span class="keywordflow">case</span> LANG_CHINESE:
00720         <span class="keywordflow">default</span>:
00721             wcscpy(szImeFileName, L<span class="stringliteral">"kbdus.dll"</span>);
00722             <span class="keywordflow">break</span>;
00723     }
00724 
00725     <span class="keywordflow">if</span> (RegSetValueExW(hKeyOneIME,
00726                 gszValLayoutFile,
00727                 0,
00728                 REG_SZ,
00729                 (CONST BYTE*)szImeFileName,
00730                 (wcslen(szImeFileName) + 1) * <span class="keyword">sizeof</span>(WCHAR)) != ERROR_SUCCESS) {
00731         <span class="keywordflow">goto</span> WriteImeLayoutFail;
00732     }
00733 
00734     RegCloseKey(hKeyOneIME);
00735     RegCloseKey(hKeyKbdLayout);
00736 
00737     <span class="comment">/*</span>
00738 <span class="comment">     * Update CurrentUser's preload keyboard layout setting</span>
00739 <span class="comment">     */</span>
00740     RegCreateKey(HKEY_CURRENT_USER, gszRegKbdOrder, &amp;hKeyKbdOrder);
00741 
00742     <span class="keywordflow">for</span> (i = 1; i &lt; 1024; i++) {
00743         <a class="code" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a>(i, 10, szOrderNum, <span class="keyword">sizeof</span>(szOrderNum));
00744 
00745         dwTmp = <span class="keyword">sizeof</span>(szOrderKeyName);
00746         <span class="keywordflow">if</span> (RegQueryValueEx(hKeyKbdOrder,
00747                     szOrderNum,
00748                     NULL,
00749                     NULL,
00750                     (LPBYTE)szOrderKeyName,
00751                     &amp;dwTmp) != ERROR_SUCCESS) {
00752             <span class="keywordflow">break</span>;
00753         }
00754 
00755         <span class="keywordflow">if</span> (_wcsicmp(szKeyName, szOrderKeyName) == 0) {
00756             <span class="comment">/*</span>
00757 <span class="comment">             * We have the same value in the preload!</span>
00758 <span class="comment">             * OK, ISV is developing their IMEs</span>
00759 <span class="comment">             * so even it is in preload, but it can not be loaded</span>
00760 <span class="comment">             */</span>
00761             <span class="keywordflow">break</span>;
00762         }
00763     }
00764 
00765     <span class="keywordflow">if</span> (i &lt; 1024) {
00766         <span class="comment">/*</span>
00767 <span class="comment">         * Write a subkey under "preload"</span>
00768 <span class="comment">         */</span>
00769         RegSetValueExW(hKeyKbdOrder,
00770                        szOrderNum,
00771                        0,
00772                        REG_SZ,
00773                        (CONST BYTE*)szKeyName,
00774                        (lstrlen(szKeyName) + 1) * <span class="keyword">sizeof</span>(WCHAR));
00775         RegCloseKey(hKeyKbdOrder);
00776     }
00777     <span class="keywordflow">else</span> {
00778         RegCloseKey(hKeyKbdOrder);
00779         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00780     }
00781 
00782     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00783 
00784 WriteImeLayoutFail:
00785     RegCloseKey(hKeyOneIME);
00786     RegDeleteKey(hKeyKbdLayout, szKeyName);
00787     RegCloseKey(hKeyKbdLayout);
00788 
00789     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00790 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
