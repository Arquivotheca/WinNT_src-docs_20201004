<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmparse2.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmparse2.c</h1><a href="../../d3/d2/cmparse2_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmparse2.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains parse routines for the configuration manager, particularly</span>
00012 <span class="comment">    the registry.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bryan M. Willman (bryanwi) 10-Sep-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00023 
00024 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDoCreate)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDoCreateChild)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d3/d2/cmparse2_8c.html#a0">00029</a> <span class="keyword">extern</span>  <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a14">CmpKeyControlBlockRoot</a>;
00030 
00031 
00032 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00033"></a><a class="code" href="../../d3/d2/cmparse2_8c.html#a1">00033</a> <a class="code" href="../../d3/d2/cmparse2_8c.html#a1">CmpDoCreate</a>(
00034     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00035     IN HCELL_INDEX Cell,
00036     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00037     IN PUNICODE_STRING Name,
00038     IN KPROCESSOR_MODE AccessMode,
00039     IN <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context,
00040     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb,
00041     OUT PVOID *Object
00042     )
00043 <span class="comment">/*++</span>
00044 <span class="comment"></span>
00045 <span class="comment">Routine Description:</span>
00046 <span class="comment"></span>
00047 <span class="comment">    Performs the first step in the creation of a registry key.  This</span>
00048 <span class="comment">    routine checks to make sure the caller has the proper access to</span>
00049 <span class="comment">    create a key here, and allocates space for the child in the parent</span>
00050 <span class="comment">    cell.  It then calls CmpDoCreateChild to initialize the key and</span>
00051 <span class="comment">    create the key object.</span>
00052 <span class="comment"></span>
00053 <span class="comment">    This two phase creation allows us to share the child creation code</span>
00054 <span class="comment">    with the creation of link nodes.</span>
00055 <span class="comment"></span>
00056 <span class="comment">Arguments:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00059 <span class="comment"></span>
00060 <span class="comment">    Cell - supplies index of node to create child under.</span>
00061 <span class="comment"></span>
00062 <span class="comment">    AccessState - Running security access state information for operation.</span>
00063 <span class="comment"></span>
00064 <span class="comment">    Name - supplies pointer to a UNICODE string which is the name of</span>
00065 <span class="comment">            the child to be created.</span>
00066 <span class="comment"></span>
00067 <span class="comment">    AccessMode - Access mode of the original caller.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    Context - pointer to CM_PARSE_CONTEXT structure passed through</span>
00070 <span class="comment">                the object manager</span>
00071 <span class="comment"></span>
00072 <span class="comment">    BaseName - Name of object create is relative to</span>
00073 <span class="comment"></span>
00074 <span class="comment">    KeyName - Relative name (to BaseName)</span>
00075 <span class="comment"></span>
00076 <span class="comment">    Object - The address of a variable to receive the created key object, if</span>
00077 <span class="comment">             any.</span>
00078 <span class="comment"></span>
00079 <span class="comment">Return Value:</span>
00080 <span class="comment"></span>
00081 <span class="comment">    NTSTATUS</span>
00082 <span class="comment"></span>
00083 <span class="comment">--*/</span>
00084 {
00085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00086     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pparent;
00087     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pdata;
00088     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> KeyCell;
00089     ULONG       ParentType;
00090     ACCESS_MASK AdditionalAccess;
00091     BOOLEAN CreateAccess;
00092     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
00093 
00094     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
00095         KdPrint((<span class="stringliteral">"CmpDoCreate:\n"</span>));
00096     }
00097 
00098     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Context)) {
00099 
00100         <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_BACKUP_RESTORE) {
00101 
00102             <span class="comment">//</span>
00103             <span class="comment">// we're supposed to be opening for a backup/restore</span>
00104             <span class="comment">// operation, but this is a new create, which makes</span>
00105             <span class="comment">// no sense, so fail.</span>
00106             <span class="comment">//</span>
00107             <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
00108         }
00109 
00110         <span class="comment">//</span>
00111         <span class="comment">// Operation is a create, so set Disposition</span>
00112         <span class="comment">//</span>
00113         Context-&gt;Disposition = REG_CREATED_NEW_KEY;
00114     }
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">// Check to make sure the caller can create a sub-key here.</span>
00118     <span class="comment">//</span>
00119     pparent = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00120     pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
00121     ParentType = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00122 
00123     <span class="keywordflow">if</span> ( (ParentType == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) &amp;&amp;
00124          ((Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) == 0) )
00125     {
00126         <span class="comment">//</span>
00127         <span class="comment">// Trying to create stable child under volatile parent, report error</span>
00128         <span class="comment">//</span>
00129         <span class="keywordflow">return</span> STATUS_CHILD_MUST_BE_VOLATILE;
00130     }
00131 
00132     <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp;   <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>)
00133     {
00134         <span class="comment">//</span>
00135         <span class="comment">// Disallow attempts to create anything under a symbolic link</span>
00136         <span class="comment">//</span>
00137         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00138     }
00139 
00140     AdditionalAccess = (Context-&gt;CreateOptions &amp; REG_OPTION_CREATE_LINK) ? KEY_CREATE_LINK : 0;
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// The FullName is not used in the routine CmpCheckCreateAccess,</span>
00144     <span class="comment">// </span>
00145     CreateAccess = <a class="code" href="../../d7/d2/cmse_8c.html#a11">CmpCheckCreateAccess</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00146                                         &amp;(pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00147                                         AccessState,
00148                                         AccessMode,
00149                                         AdditionalAccess,
00150                                         &amp;status);
00151 
00152     <span class="keywordflow">if</span> (CreateAccess) {
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">// Security check passed, so we can go ahead and create</span>
00156         <span class="comment">// the sub-key.</span>
00157         <span class="comment">//</span>
00158         <span class="keywordflow">if</span> ( !(Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) &amp;&amp;
00159              !<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>)) {
00160 
00161             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00162         }
00163 
00164         <span class="comment">//</span>
00165         <span class="comment">// Create and initialize the new sub-key</span>
00166         <span class="comment">//</span>
00167         status = <a class="code" href="../../d3/d2/cmparse2_8c.html#a2">CmpDoCreateChild</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00168                                    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
00169                                    &amp;(pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00170                                    AccessState,
00171                                    <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
00172                                    AccessMode,
00173                                    Context,
00174                                    ParentKcb,
00175                                    0,
00176                                    &amp;KeyCell,
00177                                    Object );
00178 
00179         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00180 
00181             <span class="comment">//</span>
00182             <span class="comment">// Child successfully created, add to parent's list.</span>
00183             <span class="comment">//</span>
00184             <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, KeyCell)) {
00185 
00186                 <span class="comment">//</span>
00187                 <span class="comment">// Unable to add child, so free it</span>
00188                 <span class="comment">//</span>
00189                 <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, KeyCell, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00190                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00191             }
00192 
00193             <span class="comment">//</span>
00194             <span class="comment">// Update max keyname and class name length fields</span>
00195             <span class="comment">//</span>
00196             <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length) {
00197                 pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00198             }
00199 
00200             <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> &lt; Context-&gt;Class.Length) {
00201                 pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = Context-&gt;Class.Length;
00202             }
00203 
00204             KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
00205 
00206             <span class="comment">//</span>
00207             <span class="comment">// A new key is created, invalid the subkey info of the parent KCB.</span>
00208             <span class="comment">//</span>
00209             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00210 
00211             <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>);
00212 
00213             <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_CREATE_LINK) {
00214                 pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, KeyCell);
00215                 pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>;
00216                 KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o8">Flags</a> = pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00217 
00218             }
00219         }
00220     }
00221     <span class="keywordflow">return</span> status;
00222 }
00223 
00224 
00225 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00226"></a><a class="code" href="../../d3/d2/cmparse2_8c.html#a2">00226</a> <a class="code" href="../../d3/d2/cmparse2_8c.html#a2">CmpDoCreateChild</a>(
00227     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00228     IN HCELL_INDEX ParentCell,
00229     IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL,
00230     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00231     IN PUNICODE_STRING Name,
00232     IN KPROCESSOR_MODE AccessMode,
00233     IN <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context,
00234     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb,
00235     IN USHORT Flags,
00236     OUT PHCELL_INDEX KeyCell,
00237     OUT PVOID *Object
00238     )
00239 
00240 <span class="comment">/*++</span>
00241 <span class="comment"></span>
00242 <span class="comment">Routine Description:</span>
00243 <span class="comment"></span>
00244 <span class="comment">    Creates a new sub-key.  This is called by CmpDoCreate to create child</span>
00245 <span class="comment">    sub-keys and CmpCreateLinkNode to create root sub-keys.</span>
00246 <span class="comment"></span>
00247 <span class="comment">Arguments:</span>
00248 <span class="comment"></span>
00249 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00250 <span class="comment"></span>
00251 <span class="comment">    ParentCell - supplies cell index of parent cell</span>
00252 <span class="comment"></span>
00253 <span class="comment">    ParentDescriptor - Supplies security descriptor of parent key, for use</span>
00254 <span class="comment">           in inheriting ACLs.</span>
00255 <span class="comment"></span>
00256 <span class="comment">    AccessState - Running security access state information for operation.</span>
00257 <span class="comment"></span>
00258 <span class="comment">    Name - Supplies pointer to a UNICODE string which is the name of the</span>
00259 <span class="comment">           child to be created.</span>
00260 <span class="comment"></span>
00261 <span class="comment">    AccessMode - Access mode of the original caller.</span>
00262 <span class="comment"></span>
00263 <span class="comment">    Context - Supplies pointer to CM_PARSE_CONTEXT structure passed through</span>
00264 <span class="comment">           the object manager.</span>
00265 <span class="comment"></span>
00266 <span class="comment">    BaseName - Name of object create is relative to</span>
00267 <span class="comment"></span>
00268 <span class="comment">    KeyName - Relative name (to BaseName)</span>
00269 <span class="comment"></span>
00270 <span class="comment">    Flags - Supplies any flags to be set in the newly created node</span>
00271 <span class="comment"></span>
00272 <span class="comment">    KeyCell - Receives the cell index of the newly created sub-key, if any.</span>
00273 <span class="comment"></span>
00274 <span class="comment">    Object - Receives a pointer to the created key object, if any.</span>
00275 <span class="comment"></span>
00276 <span class="comment">Return Value:</span>
00277 <span class="comment"></span>
00278 <span class="comment">    STATUS_SUCCESS - sub-key successfully created.  New object is returned in</span>
00279 <span class="comment">            Object, and the new cell's cell index is returned in KeyCell.</span>
00280 <span class="comment"></span>
00281 <span class="comment">    !STATUS_SUCCESS - appropriate error message.</span>
00282 <span class="comment"></span>
00283 <span class="comment">--*/</span>
00284 
00285 {
00286     ULONG clean=0;
00287     ULONG alloc=0;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00289     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
00290     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ClassCell=<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00291     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> KeyNode;
00292     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
00293     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00294     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> fkcb;
00295     LONG found;
00296     ULONG StorageType;
00297     PSECURITY_DESCRIPTOR NewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00298     LARGE_INTEGER systemtime;
00299 
00300     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
00301         KdPrint((<span class="stringliteral">"CmpDoCreateChild:\n"</span>));
00302     }
00303     <span class="keywordflow">try</span> {
00304         <span class="comment">//</span>
00305         <span class="comment">// Get allocation type</span>
00306         <span class="comment">//</span>
00307         StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>;
00308         <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) {
00309             StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>;
00310         }
00311 
00312         <span class="comment">//</span>
00313         <span class="comment">// Allocate child cell</span>
00314         <span class="comment">//</span>
00315         *KeyCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
00316                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00317                         <a class="code" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>),
00318                         StorageType
00319                         );
00320         <span class="keywordflow">if</span> (*KeyCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00321                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00322                         __leave;
00323         }
00324         alloc = 1;
00325         KeyNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, *KeyCell);
00326 
00327         <span class="comment">//</span>
00328         <span class="comment">// Allocate cell for class name</span>
00329         <span class="comment">//</span>
00330         <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00331             ClassCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Context-&gt;Class.Length, StorageType);
00332             <span class="keywordflow">if</span> (ClassCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00333                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00334                                 __leave;
00335             }
00336         }
00337         alloc = 2;
00338         <span class="comment">//</span>
00339         <span class="comment">// Allocate the object manager object</span>
00340         <span class="comment">//</span>
00341         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(AccessMode,
00342                                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
00343                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00344                                 AccessMode,
00345                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00346                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>),
00347                                 0,
00348                                 0,
00349                                 Object);
00350 
00351         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00352 
00353             KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
00354 
00355             <span class="comment">//</span>
00356             <span class="comment">// We have managed to allocate all of the objects we need to,</span>
00357             <span class="comment">// so initialize them</span>
00358             <span class="comment">//</span>
00359 
00360             <span class="comment">//</span>
00361             <span class="comment">// Mark the object as uninitialized (in case we get an error too soon)</span>
00362             <span class="comment">//</span>
00363             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
00364             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00365 
00366             <span class="comment">//</span>
00367             <span class="comment">// Fill in the class name</span>
00368             <span class="comment">//</span>
00369             <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00370 
00371                 CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ClassCell);
00372 
00373                 <span class="keywordflow">try</span> {
00374 
00375                     RtlMoveMemory(
00376                         &amp;(CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o5">KeyString</a>[0]),
00377                         Context-&gt;Class.Buffer,
00378                         Context-&gt;Class.Length
00379                         );
00380 
00381                 } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00382                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00383                     <span class="keywordflow">return</span> GetExceptionCode();
00384                 }
00385             }
00386 
00387             <span class="comment">//</span>
00388             <span class="comment">// Fill in the new key itself</span>
00389             <span class="comment">//</span>
00390             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a25">CM_KEY_NODE_SIGNATURE</a>;
00391             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = Flags;
00392 
00393             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
00394             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
00395 
00396             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o3">Spare</a> = 0;
00397             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = ParentCell;
00398             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
00399             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
00400             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00401             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00402             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
00403             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00404             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00405             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = ClassCell;
00406             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = Context-&gt;Class.Length;
00407 
00408             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
00409             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 0;
00410             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
00411             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
00412 
00413             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00414                                               KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00415                                               <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00416             <span class="keywordflow">if</span> (KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length) {
00417                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00418             }
00419 
00420             <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a112">REG_OPTION_PREDEF_HANDLE</a>) {
00421                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = (ULONG)((ULONG_PTR)Context-&gt;PredefinedHandle);
00422                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>;
00423             }
00424 
00425             <span class="comment">//</span>
00426             <span class="comment">// Create kcb here so all data are filled in.</span>
00427             <span class="comment">//</span>
00428             <span class="comment">// Allocate a key control block</span>
00429             <span class="comment">//</span>
00430             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, *KeyCell, KeyNode, ParentKcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00431             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00433                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00434             }
00435             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount == 1);
00436             alloc = 3;
00437 
00438             <span class="comment">//</span>
00439             <span class="comment">// Fill in CM specific fields in the object</span>
00440             <span class="comment">//</span>
00441             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
00442             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00443             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00444             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00445             <a class="code" href="../../d1/d2/cmp_8h.html#a81">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>(KeyBody);
00446             <span class="comment">//</span>
00447             <span class="comment">// Assign a security descriptor to the object.  Note that since</span>
00448             <span class="comment">// registry keys are container objects, and ObAssignSecurity</span>
00449             <span class="comment">// assumes that the only container object in the world is</span>
00450             <span class="comment">// the ObpDirectoryObjectType, we have to call SeAssignSecurity</span>
00451             <span class="comment">// directly in order to get the right inheritance.</span>
00452             <span class="comment">//</span>
00453 
00454             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/seassign_8c.html#a1">SeAssignSecurity</a>(ParentDescriptor,
00455                                       AccessState-&gt;SecurityDescriptor,
00456                                       &amp;NewDescriptor,
00457                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,             <span class="comment">// container object</span>
00458                                       &amp;AccessState-&gt;SubjectSecurityContext,
00459                                       &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00460                                       <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>);
00461             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00462                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a9">CmpSecurityMethod</a>(*Object,
00463                                            <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>,
00464                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00465                                            NewDescriptor,
00466                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00467                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00468                                            <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
00469                                            &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>);
00470             }
00471 
00472             <span class="comment">//</span>
00473             <span class="comment">// Since the security descriptor now lives in the hive,</span>
00474             <span class="comment">// free the in-memory copy</span>
00475             <span class="comment">//</span>
00476             <a class="code" href="../../d1/d5/seassign_8c.html#a3">SeDeassignSecurity</a>( &amp;NewDescriptor );
00477 
00478             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00479 
00480                 <span class="comment">//</span>
00481                 <span class="comment">// Note that the dereference will clean up the kcb, so</span>
00482                 <span class="comment">// make sure and decrement the allocation count here.</span>
00483                 <span class="comment">//</span>
00484                 <span class="comment">// Also mark the kcb as deleted so it does not get </span>
00485                 <span class="comment">// inappropriately cached.</span>
00486                 <span class="comment">//</span>
00487                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00488                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00490                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00491                 alloc = 2;
00492 
00493             } <span class="keywordflow">else</span> {
00494                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00495                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00496                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00497                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00498                         REG_NOTIFY_CHANGE_NAME
00499                         );
00500             }
00501         }
00502 
00503     } finally {
00504 
00505         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00506 
00507             <span class="comment">//</span>
00508             <span class="comment">// Clean up allocations</span>
00509             <span class="comment">//</span>
00510             <span class="keywordflow">switch</span> (alloc) {
00511             <span class="keywordflow">case</span> 3:
00512                 <span class="comment">//</span>
00513                 <span class="comment">// Mark KCB as deleted so it does not get inadvertently added to </span>
00514                 <span class="comment">// the delayed close list. That would have fairly disastrous effects</span>
00515                 <span class="comment">// as the KCB points to storage we are about to free.</span>
00516                 <span class="comment">//</span>
00517                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00518                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00519                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00520                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00521                 <span class="comment">// DELIBERATE FALL</span>
00522 
00523             <span class="keywordflow">case</span> 2:
00524                 <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00525                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ClassCell);
00526                 }
00527                 <span class="comment">// DELIBERATE FALL</span>
00528 
00529             <span class="keywordflow">case</span> 1:
00530                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, *KeyCell);
00531                 <span class="comment">// DELIBERATE FALL</span>
00532             }
00533         }
00534     }
00535 
00536     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00537 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
