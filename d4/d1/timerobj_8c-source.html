<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: timerobj.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>timerobj.c</h1><a href="../../d3/d2/timerobj_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    timerobj.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the kernel timer object. Functions are</span>
00012 <span class="comment">    provided to initialize, read, set, and cancel timer objects.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 2-Mar-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 
00028 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, KeQueryTimerDueTime)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">//</span>
00033 <span class="comment">// The following assert macro is used to check that an input timer is</span>
00034 <span class="comment">// really a ktimer and not something else, like deallocated pool.</span>
00035 <span class="comment">//</span>
00036 
<a name="l00037"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a0">00037</a> <span class="preprocessor">#define ASSERT_TIMER(E) {                                     \</span>
00038 <span class="preprocessor">    ASSERT(((E)-&gt;Header.Type == TimerNotificationObject) ||   \</span>
00039 <span class="preprocessor">           ((E)-&gt;Header.Type == TimerSynchronizationObject)); \</span>
00040 <span class="preprocessor">}</span>
00041 <span class="preprocessor"></span>
00042 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00043"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a1">00043</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a> (
00044     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer
00045     )
00046 
00047 <span class="comment">/*++</span>
00048 <span class="comment"></span>
00049 <span class="comment">Routine Description:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    This function initializes a kernel timer object.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Arguments:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    Timer - Supplies a pointer to a dispatcher object of type timer.</span>
00056 <span class="comment"></span>
00057 <span class="comment">Return Value:</span>
00058 <span class="comment"></span>
00059 <span class="comment">    None.</span>
00060 <span class="comment"></span>
00061 <span class="comment">--*/</span>
00062 
00063 {
00064 
00065     <span class="comment">//</span>
00066     <span class="comment">// Initialize extended timer object with a type of notification and a</span>
00067     <span class="comment">// period of zero.</span>
00068     <span class="comment">//</span>
00069 
00070     <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>(Timer, NotificationTimer);
00071     <span class="keywordflow">return</span>;
00072 }
00073 
00074 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00075"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a2">00075</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a> (
00076     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer,
00077     IN TIMER_TYPE Type
00078     )
00079 
00080 <span class="comment">/*++</span>
00081 <span class="comment"></span>
00082 <span class="comment">Routine Description:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    This function initializes an extended kernel timer object.</span>
00085 <span class="comment"></span>
00086 <span class="comment">Arguments:</span>
00087 <span class="comment"></span>
00088 <span class="comment">    Timer - Supplies a pointer to a dispatcher object of type timer.</span>
00089 <span class="comment"></span>
00090 <span class="comment">    Type - Supplies the type of timer object; NotificationTimer or</span>
00091 <span class="comment">        SynchronizationTimer;</span>
00092 <span class="comment"></span>
00093 <span class="comment">Return Value:</span>
00094 <span class="comment"></span>
00095 <span class="comment">    None.</span>
00096 <span class="comment"></span>
00097 <span class="comment">--*/</span>
00098 
00099 {
00100     <span class="comment">//</span>
00101     <span class="comment">// Initialize standard dispatcher object header and set initial</span>
00102     <span class="comment">// state of timer.</span>
00103     <span class="comment">//</span>
00104 
00105     Timer-&gt;Header.Type = <a class="code" href="../../d4/d9/ke_8h.html#a402a165">TimerNotificationObject</a> + Type;
00106     Timer-&gt;Header.Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00107     Timer-&gt;Header.Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>) / <span class="keyword">sizeof</span>(LONG);
00108     Timer-&gt;Header.SignalState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00109 
00110 <span class="preprocessor">#if DBG</span>
00111 <span class="preprocessor"></span>
00112     Timer-&gt;TimerListEntry.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00113     Timer-&gt;TimerListEntry.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00114 
00115 <span class="preprocessor">#endif</span>
00116 <span class="preprocessor"></span>
00117     InitializeListHead(&amp;Timer-&gt;Header.WaitListHead);
00118     Timer-&gt;DueTime.QuadPart = 0;
00119     Timer-&gt;Period = 0;
00120     <span class="keywordflow">return</span>;
00121 }
00122 
00123 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00124"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a3">00124</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a3">KeClearTimer</a> (
00125     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer
00126     )
00127 
00128 <span class="comment">/*++</span>
00129 <span class="comment"></span>
00130 <span class="comment">Routine Description:</span>
00131 <span class="comment"></span>
00132 <span class="comment">    This function clears the signal state of an timer object.</span>
00133 <span class="comment"></span>
00134 <span class="comment">Arguments:</span>
00135 <span class="comment"></span>
00136 <span class="comment">    Event - Supplies a pointer to a dispatcher object of type timer.</span>
00137 <span class="comment"></span>
00138 <span class="comment">Return Value:</span>
00139 <span class="comment"></span>
00140 <span class="comment">    None.</span>
00141 <span class="comment"></span>
00142 <span class="comment">--*/</span>
00143 
00144 {
00145 
00146     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Clear signal state of timer object.</span>
00150     <span class="comment">//</span>
00151 
00152     Timer-&gt;Header.SignalState = 0;
00153     <span class="keywordflow">return</span>;
00154 }
00155 
00156 BOOLEAN
<a name="l00157"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a4">00157</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a> (
00158     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer
00159     )
00160 
00161 <span class="comment">/*++</span>
00162 <span class="comment"></span>
00163 <span class="comment">Routine Description:</span>
00164 <span class="comment"></span>
00165 <span class="comment">    This function cancels a timer that was previously set to expire at</span>
00166 <span class="comment">    a specified time. If the timer is not currently set, then no operation</span>
00167 <span class="comment">    is performed. Canceling a timer does not set the state of the timer to</span>
00168 <span class="comment">    Signaled.</span>
00169 <span class="comment"></span>
00170 <span class="comment">Arguments:</span>
00171 <span class="comment"></span>
00172 <span class="comment">    Timer - Supplies a pointer to a dispatcher object of type timer.</span>
00173 <span class="comment"></span>
00174 <span class="comment">Return Value:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    A boolean value of TRUE is returned if the the specified timer was</span>
00177 <span class="comment">    currently set. Else a value of FALSE is returned.</span>
00178 <span class="comment"></span>
00179 <span class="comment">--*/</span>
00180 
00181 {
00182 
00183     BOOLEAN Inserted;
00184     KIRQL OldIrql;
00185 
00186     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00187     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// Raise IRQL to dispatcher level, lock the dispatcher database, and</span>
00191     <span class="comment">// capture the timer inserted status. If the timer is currently set,</span>
00192     <span class="comment">// then remove it from the timer list.</span>
00193     <span class="comment">//</span>
00194 
00195     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00196     Inserted = Timer-&gt;Header.Inserted;
00197     <span class="keywordflow">if</span> (Inserted != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00198         <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00199     }
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">// Unlock the dispatcher database, lower IRQL to its previous value, and</span>
00203     <span class="comment">// return boolean value that signifies whether the timer was set of not.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00207     <span class="keywordflow">return</span> Inserted;
00208 }
00209 
00210 BOOLEAN
<a name="l00211"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a5">00211</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a5">KeReadStateTimer</a> (
00212     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer
00213     )
00214 
00215 <span class="comment">/*++</span>
00216 <span class="comment"></span>
00217 <span class="comment">Routine Description:</span>
00218 <span class="comment"></span>
00219 <span class="comment">    This function reads the current signal state of a timer object.</span>
00220 <span class="comment"></span>
00221 <span class="comment">Arguments:</span>
00222 <span class="comment"></span>
00223 <span class="comment">    Timer - Supplies a pointer to a dispatcher object of type timer.</span>
00224 <span class="comment"></span>
00225 <span class="comment">Return Value:</span>
00226 <span class="comment"></span>
00227 <span class="comment">    The current signal state of the timer object.</span>
00228 <span class="comment"></span>
00229 <span class="comment">--*/</span>
00230 
00231 {
00232 
00233     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">// Return current signal state of timer object.</span>
00237     <span class="comment">//</span>
00238 
00239     <span class="keywordflow">return</span> (BOOLEAN)Timer-&gt;Header.SignalState;
00240 }
00241 
00242 BOOLEAN
<a name="l00243"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a6">00243</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a> (
00244     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer,
00245     IN LARGE_INTEGER DueTime,
00246     IN <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc OPTIONAL
00247     )
00248 
00249 <span class="comment">/*++</span>
00250 <span class="comment"></span>
00251 <span class="comment">Routine Description:</span>
00252 <span class="comment"></span>
00253 <span class="comment">    This function sets a timer to expire at a specified time. If the timer is</span>
00254 <span class="comment">    already set, then it is implicitly canceled before it is set to expire at</span>
00255 <span class="comment">    the specified time. Setting a timer causes its due time to be computed,</span>
00256 <span class="comment">    its state to be set to Not-Signaled, and the timer object itself to be</span>
00257 <span class="comment">    inserted in the timer list.</span>
00258 <span class="comment"></span>
00259 <span class="comment">Arguments:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    Timer - Supplies a pointer to a dispatcher object of type timer.</span>
00262 <span class="comment"></span>
00263 <span class="comment">    DueTime - Supplies an absolute or relative time at which the timer</span>
00264 <span class="comment">        is to expire.</span>
00265 <span class="comment"></span>
00266 <span class="comment">    Dpc - Supplies an optional pointer to a control object of type DPC.</span>
00267 <span class="comment"></span>
00268 <span class="comment">Return Value:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    A boolean value of TRUE is returned if the the specified timer was</span>
00271 <span class="comment">    currently set. Else a value of FALSE is returned.</span>
00272 <span class="comment"></span>
00273 <span class="comment">--*/</span>
00274 
00275 {
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">// Set the timer with a period of zero.</span>
00279     <span class="comment">//</span>
00280 
00281     <span class="keywordflow">return</span> <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>(Timer, DueTime, 0, Dpc);
00282 }
00283 
00284 BOOLEAN
<a name="l00285"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a7">00285</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a> (
00286     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer,
00287     IN LARGE_INTEGER DueTime,
00288     IN LONG Period OPTIONAL,
00289     IN <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc OPTIONAL
00290     )
00291 
00292 <span class="comment">/*++</span>
00293 <span class="comment"></span>
00294 <span class="comment">Routine Description:</span>
00295 <span class="comment"></span>
00296 <span class="comment">    This function sets a timer to expire at a specified time. If the timer is</span>
00297 <span class="comment">    already set, then it is implicitly canceled before it is set to expire at</span>
00298 <span class="comment">    the specified time. Setting a timer causes its due time to be computed,</span>
00299 <span class="comment">    its state to be set to Not-Signaled, and the timer object itself to be</span>
00300 <span class="comment">    inserted in the timer list.</span>
00301 <span class="comment"></span>
00302 <span class="comment">Arguments:</span>
00303 <span class="comment"></span>
00304 <span class="comment">    Timer - Supplies a pointer to a dispatcher object of type timer.</span>
00305 <span class="comment"></span>
00306 <span class="comment">    DueTime - Supplies an absolute or relative time at which the timer</span>
00307 <span class="comment">        is to expire.</span>
00308 <span class="comment"></span>
00309 <span class="comment">    Period - Supplies an optional period for the timer in milliseconds.</span>
00310 <span class="comment"></span>
00311 <span class="comment">    Dpc - Supplies an optional pointer to a control object of type DPC.</span>
00312 <span class="comment"></span>
00313 <span class="comment">Return Value:</span>
00314 <span class="comment"></span>
00315 <span class="comment">    A boolean value of TRUE is returned if the the specified timer was</span>
00316 <span class="comment">    currently set. Else a value of FALSE is returned.</span>
00317 <span class="comment"></span>
00318 <span class="comment">--*/</span>
00319 
00320 {
00321 
00322     BOOLEAN Inserted;
00323     LARGE_INTEGER Interval;
00324     KIRQL OldIrql;
00325     LARGE_INTEGER SystemTime;
00326 
00327     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00328     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Capture the timer inserted status and if the timer is currently</span>
00338     <span class="comment">// set, then remove it from the timer list.</span>
00339     <span class="comment">//</span>
00340 
00341     Inserted = Timer-&gt;Header.Inserted;
00342     <span class="keywordflow">if</span> (Inserted != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00343         <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00344     }
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// Clear the signal state, set the period, set the DPC address, and</span>
00348     <span class="comment">// insert the timer in the timer tree. If the timer is not inserted</span>
00349     <span class="comment">// in the timer tree, then it has already expired and as many waiters</span>
00350     <span class="comment">// as possible should be continued, and a DPC, if specified should be</span>
00351     <span class="comment">// queued.</span>
00352     <span class="comment">//</span>
00353     <span class="comment">// N.B. The signal state must be cleared in case the period is not</span>
00354     <span class="comment">//      zero.</span>
00355     <span class="comment">//</span>
00356 
00357     Timer-&gt;Header.SignalState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00358     Timer-&gt;Dpc = Dpc;
00359     Timer-&gt;Period = Period;
00360     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>((<a class="code" href="../../d3/d8/struct__KTIMER.html">PRKTIMER</a>)Timer, DueTime) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00361         <span class="keywordflow">if</span> (IsListEmpty(&amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00362             <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(Timer, <a class="code" href="../../d0/d0/ki_8h.html#a3">TIMER_EXPIRE_INCREMENT</a>);
00363         }
00364 
00365         <span class="comment">//</span>
00366         <span class="comment">// If a DPC is specfied, then call the DPC routine.</span>
00367         <span class="comment">//</span>
00368 
00369         <span class="keywordflow">if</span> (Dpc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370             KiQuerySystemTime(&amp;SystemTime);
00371             <a class="code" href="../../d4/d1/dpcobj_8c.html#a2">KeInsertQueueDpc</a>(Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>,
00372                              ULongToPtr(SystemTime.LowPart),
00373                              ULongToPtr(SystemTime.HighPart));
00374         }
00375 
00376         <span class="comment">//</span>
00377         <span class="comment">// If the timer is periodic, then compute the next interval time</span>
00378         <span class="comment">// and reinsert the timer in the timer tree.</span>
00379         <span class="comment">//</span>
00380         <span class="comment">// N.B. Even though the timer insertion is relative, it can still</span>
00381         <span class="comment">//      fail if the period of the timer elapses in between computing</span>
00382         <span class="comment">//      the time and inserting the timer in the table. If this happens,</span>
00383         <span class="comment">//      try again.</span>
00384         <span class="comment">//</span>
00385 
00386         <span class="keywordflow">if</span> (Period != 0) {
00387             Interval.QuadPart = Int32x32To64(Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o4">Period</a>, - 10 * 1000);
00388             <span class="keywordflow">while</span> (!<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>(Timer, Interval)) {
00389                 ; 
00390             }
00391         }
00392     }
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00396     <span class="comment">// value.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// Return boolean value that signifies whether the timer was set of</span>
00403     <span class="comment">// not.</span>
00404     <span class="comment">//</span>
00405 
00406     <span class="keywordflow">return</span> Inserted;
00407 }
00408 
00409 ULONGLONG
<a name="l00410"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a8">00410</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a8">KeQueryTimerDueTime</a> (
00411     IN <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer
00412     )
00413 
00414 <span class="comment">/*++</span>
00415 <span class="comment"></span>
00416 <span class="comment">Routine Description:</span>
00417 <span class="comment"></span>
00418 <span class="comment">    This function returns the InterruptTime at which the timer is</span>
00419 <span class="comment">    pending.   0 is returned if the timer is not pending.</span>
00420 <span class="comment"></span>
00421 <span class="comment">    N.B. This function may only be called by the system sleep code.</span>
00422 <span class="comment"></span>
00423 <span class="comment">Arguments:</span>
00424 <span class="comment"></span>
00425 <span class="comment">    Timer - Supplies a pointer to a dispatcher object of type timer.</span>
00426 <span class="comment"></span>
00427 <span class="comment">Return Value:</span>
00428 <span class="comment"></span>
00429 <span class="comment">    Returns the amount of time remaining on the timer, or 0 if the</span>
00430 <span class="comment">    timer is not pending.</span>
00431 <span class="comment"></span>
00432 <span class="comment">--*/</span>
00433 
00434 {
00435 
00436     KIRQL OldIrql;
00437     LARGE_INTEGER InterruptTime;
00438     ULONGLONG DueTime;
00439 
00440     <a class="code" href="../../d3/d2/timerobj_8c.html#a0">ASSERT_TIMER</a>(Timer);
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00444     <span class="comment">//</span>
00445 
00446     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// If the timer is currently pending, compute its due time</span>
00450     <span class="comment">//</span>
00451 
00452     DueTime = 0;
00453     <span class="keywordflow">if</span> (Timer-&gt;Header.Inserted) {
00454         DueTime = Timer-&gt;DueTime.QuadPart;
00455     }
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00459     <span class="comment">// value, and return the due time</span>
00460     <span class="comment">//</span>
00461 
00462     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00463     <span class="keywordflow">return</span> DueTime;
00464 }
00465 
00466 PVOID
<a name="l00467"></a><a class="code" href="../../d3/d2/timerobj_8c.html#a9">00467</a> <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a>(
00468     IN PVOID BlockStart,
00469     IN ULONG BlockSize
00470     )
00471 <span class="comment">/*++</span>
00472 <span class="comment"></span>
00473 <span class="comment">Routine Description:</span>
00474 <span class="comment"></span>
00475 <span class="comment">    This function is used for debugging by checking all timers</span>
00476 <span class="comment">    to see if any is in the memory block passed.  If so, the</span>
00477 <span class="comment">    system stops at a debug breakpoint.</span>
00478 <span class="comment"></span>
00479 <span class="comment">Arguments:</span>
00480 <span class="comment"></span>
00481 <span class="comment">    MemoryBlock - Base address to check for timer</span>
00482 <span class="comment"></span>
00483 <span class="comment">    BlockSize - Size (in bytes) to check in memory block</span>
00484 <span class="comment"></span>
00485 <span class="comment">Return Value:</span>
00486 <span class="comment"></span>
00487 <span class="comment">    The address of the currently active timer.</span>
00488 <span class="comment"></span>
00489 <span class="comment">--*/</span>
00490 {
00491     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00492     PLIST_ENTRY ListHead;
00493     PLIST_ENTRY NextEntry;
00494     KIRQL OldIrql;
00495     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00496     PUCHAR Address;
00497     PUCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00498     PUCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">// Compute the ending memory location.</span>
00502     <span class="comment">//</span>
00503 
00504     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = (PUCHAR)BlockStart;
00505     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00509     <span class="comment">//</span>
00510 
00511     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">// Run the entire timer database and check for any timers in</span>
00515     <span class="comment">// the memory block</span>
00516     <span class="comment">//</span>
00517 
00518     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00519     <span class="keywordflow">do</span> {
00520         ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00521         NextEntry = ListHead-&gt;Flink;
00522         <span class="keywordflow">while</span> (NextEntry != ListHead) {
00523             Timer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00524             Address = (PUCHAR)Timer;
00525             NextEntry = NextEntry-&gt;Flink;
00526 
00527             <span class="comment">//</span>
00528             <span class="comment">// Check this timer object is not in the range.</span>
00529             <span class="comment">// In each of the following, we check that the object</span>
00530             <span class="comment">// does not overlap the range, for example, if the timer</span>
00531             <span class="comment">// object (in this first check), starts one dword before</span>
00532             <span class="comment">// the range being checked, we have an overlap and should</span>
00533             <span class="comment">// stop.</span>
00534             <span class="comment">//</span>
00535 
00536             <span class="keywordflow">if</span> ((Address &gt; (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>))) &amp;&amp;
00537                 (Address &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>)) {
00538                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(TIMER_OR_DPC_INVALID,
00539                              0x0,
00540                              (ULONG_PTR)Address,
00541                              (ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
00542                              (ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>);
00543             }
00544 
00545             <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>) {
00546 
00547                 <span class="comment">//</span>
00548                 <span class="comment">// Check the timer's DPC object isn't in the range.</span>
00549                 <span class="comment">//</span>
00550 
00551                 Address = (PUCHAR)Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>;
00552                 <span class="keywordflow">if</span> ((Address &gt; (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/struct__KDPC.html">KDPC</a>))) &amp;&amp;
00553                     (Address &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>)) {
00554                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(TIMER_OR_DPC_INVALID,
00555                                  0x1,
00556                                  (ULONG_PTR)Address,
00557                                  (ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
00558                                  (ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>);
00559                 }
00560 
00561                 <span class="comment">//</span>
00562                 <span class="comment">// Check the timer's DPC routine is not in the range.</span>
00563                 <span class="comment">//</span>
00564 
00565                 Address = (PUCHAR)Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o4">DeferredRoutine</a>;
00566                 <span class="keywordflow">if</span> (Address &gt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &amp;&amp; Address &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00567                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(TIMER_OR_DPC_INVALID,
00568                                  0x2,
00569                                  (ULONG_PTR)Address,
00570                                  (ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
00571                                  (ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>);
00572                 }
00573             }
00574         }
00575 
00576         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00577     } <span class="keywordflow">while</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>);
00578 
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous value</span>
00582     <span class="comment">//</span>
00583 
00584     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00585     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00586 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
