<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: drawtext.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>drawtext.c</h1><a href="../../d3/d2/client_2drawtext_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: drawtext.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains common text drawing functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 02-12-92 mikeke   Moved Drawtext to the client side</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a0">00015</a> <span class="preprocessor">#define CR 13</span>
<a name="l00016"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a1">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define LF 10</span>
00017 <span class="preprocessor"></span>
<a name="l00018"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a2">00018</a> <span class="preprocessor">#define DT_HFMTMASK 0x03</span>
00019 <span class="preprocessor"></span>
00020 <span class="comment">/***************************************************************************\</span>
00021 <span class="comment">* IsMetaFile</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* History:</span>
00024 <span class="comment">* 30-Nov-1992 mikeke    Created</span>
00025 <span class="comment">\***************************************************************************/</span>
00026 
<a name="l00027"></a><a class="code" href="../../d6/d0/usercli_8h.html#a547">00027</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a547">IsMetaFile</a>(
00028     HDC hdc)
00029 {
00030     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwType = GetObjectType(hdc);
00031     <span class="keywordflow">return</span> (dwType == OBJ_METAFILE ||
00032             dwType == OBJ_METADC ||
00033             dwType == OBJ_ENHMETAFILE ||
00034             dwType == OBJ_ENHMETADC);
00035 }
00036 
00037 <span class="comment">/***************************************************************************\</span>
00038 <span class="comment">* DrawTextA (API)</span>
00039 <span class="comment">*</span>
00040 <span class="comment">* History:</span>
00041 <span class="comment">* 30-11-92 mikeke      Created</span>
00042 <span class="comment">\***************************************************************************/</span>
00043 
00044 
<a name="l00045"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a3">00045</a> CONST WCHAR <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a3">gwszNullStr</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00046 
<a name="l00047"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a5">00047</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a5">DrawTextExA</a>(
00048     HDC hdc,
00049     LPSTR lpchText,
00050     <span class="keywordtype">int</span> cchText,
00051     LPRECT lprc,
00052     UINT format,
00053     LPDRAWTEXTPARAMS lpdtp)
00054 {
00055     LPWSTR lpwstr;
00056     <span class="keywordtype">int</span> iRet;
00057     <span class="keywordtype">int</span> iUniString;
00058     WORD wCodePage = (WORD)GdiGetCodePage(hdc);
00059 
00060     <span class="keywordflow">if</span> (cchText == -1) {
00061         <span class="comment">// USER_AWCONV_COUNTSTRINGSZ does not count/convert trailing \0.</span>
00062         cchText = USER_AWCONV_COUNTSTRINGSZ;
00063     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cchText &lt; -1) {
00064         <span class="keywordflow">return</span> 0;
00065     }
00066 
00067     <span class="keywordflow">if</span> ((iUniString = <a class="code" href="../../d5/d6/chartran_8c.html#a3">MBToWCSEx</a>(wCodePage, lpchText, cchText, &amp;lpwstr, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == 0) {
00068         <span class="keywordflow">if</span> (cchText == USER_AWCONV_COUNTSTRINGSZ) {
00069             lpwstr = (LPWSTR)<a class="code" href="../../d3/d2/client_2drawtext_8c.html#a3">gwszNullStr</a>;
00070             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> &amp;= ~DT_MODIFYSTRING;
00071         } <span class="keywordflow">else</span> {
00072             <span class="keywordflow">return</span> 0;
00073         }
00074     }
00075 
00076     <span class="comment">/*</span>
00077 <span class="comment">     * Grow the buffer to accomodate the ellipsis (see AddEllipsisAndDrawLine)</span>
00078 <span class="comment">     */</span>
00079     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> &amp; DT_MODIFYSTRING) {
00080         <span class="keywordtype">int</span> iNewLen = (iUniString + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a901">CCHELLIPSIS</a> + 1) * <span class="keyword">sizeof</span>(*lpwstr);
00081         LPWSTR lpwstrNew = <a class="code" href="../../d6/d0/usercli_8h.html#a137">UserLocalReAlloc</a>(lpwstr, iNewLen, HEAP_ZERO_MEMORY);
00082         <span class="keywordflow">if</span> (lpwstrNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00083             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)lpwstr);
00084             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00085         }
00086         lpwstr = lpwstrNew;
00087     }
00088 
00089     iRet = <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a52">DrawTextExWorker</a>(hdc, lpwstr, iUniString, lprc, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, lpdtp, GetTextCharset(hdc));
00090 
00091     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> &amp; DT_MODIFYSTRING) {
00092         <span class="comment">/*</span>
00093 <span class="comment">         * Note that if the buffer grew and the caller provided the string size,</span>
00094 <span class="comment">         *  then we won't return the additional characters... fixing this</span>
00095 <span class="comment">         *  might break some apps so let's leave it alone until some one complains</span>
00096 <span class="comment">         */</span>
00097         <span class="keywordflow">if</span> (cchText &lt; 0) {
00098             UserAssert(cchText == USER_AWCONV_COUNTSTRINGSZ);
00099             <span class="comment">// Guess how many bytes we can put in the buffer...</span>
00100             <span class="comment">// We can safely assume the maximum bytes available.</span>
00101             <span class="comment">// At worst, even for DBCS, the buffer size required</span>
00102             <span class="comment">// will be smaller than or equal to the orignal size,</span>
00103             <span class="comment">// because some DBCS characters would be substituted</span>
00104             <span class="comment">// to SBC ".", which is one byte each.</span>
00105             <span class="comment">// On the other hand, the number of characters converted</span>
00106             <span class="comment">// is limited by both iUniString and cchText.</span>
00107             <span class="comment">//</span>
00108             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
00109                 cchText = iUniString * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a123">DBCS_CHARSIZE</a>;
00110             } <span class="keywordflow">else</span> {
00111                 cchText = iUniString * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
00112             }
00113         }
00114         WCSToMBEx(wCodePage, lpwstr, iUniString, &amp;lpchText, cchText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00115     }
00116 
00117     <span class="keywordflow">if</span> (lpwstr != <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a3">gwszNullStr</a>) {
00118         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)lpwstr);
00119     }
00120 
00121     <span class="keywordflow">return</span> iRet;
00122 }
00123 
00124 <span class="comment">/***************************************************************************\</span>
00125 <span class="comment">* DrawTextW (API)</span>
00126 <span class="comment">*</span>
00127 <span class="comment">* History:</span>
00128 <span class="comment">* 30-11-92 mikeke      Created</span>
00129 <span class="comment">\***************************************************************************/</span>
00130 
<a name="l00131"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a6">00131</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a6">DrawTextW</a>(
00132     HDC hdc,
00133     LPCWSTR lpchText,
00134     <span class="keywordtype">int</span> cchText,
00135     LPRECT lprc,
00136     UINT format)
00137 {
00138     DRAWTEXTPARAMS      DTparams;
00139     LPDRAWTEXTPARAMS    lpDTparams = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00140 
00141     <span class="comment">/* v-ronaar: fix bug #24985</span>
00142 <span class="comment">     * Disallow negative string lengths, except -1 (which has special meaning).</span>
00143 <span class="comment">     */</span>
00144     <span class="keywordflow">if</span> (cchText &lt; -1)
00145         <span class="keywordflow">return</span>(0);
00146 
00147     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> &amp; DT_TABSTOP)
00148     {
00149         DTparams.cbSize      = <span class="keyword">sizeof</span>(DRAWTEXTPARAMS);
00150         DTparams.iLeftMargin = DTparams.iRightMargin = 0;
00151         DTparams.iTabLength  = (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> &amp; 0xff00) &gt;&gt; 8;
00152         lpDTparams           = &amp;DTparams;
00153         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>              &amp;= 0xffff00ff;
00154     }
00155 
00156     <span class="keywordflow">return</span> <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a51">DrawTextExW</a>(hdc, (LPWSTR)lpchText, cchText, lprc, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, lpDTparams);
00157 }
00158 
00159 <span class="comment">/***************************************************************************\</span>
00160 <span class="comment">* DrawTextA (API)</span>
00161 <span class="comment">*</span>
00162 <span class="comment">* History:</span>
00163 <span class="comment">* 30-11-92 mikeke      Created</span>
00164 <span class="comment">\***************************************************************************/</span>
00165 
<a name="l00166"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a7">00166</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a7">DrawTextA</a>(
00167     HDC hdc,
00168     LPCSTR lpchText,
00169     <span class="keywordtype">int</span> cchText,
00170     LPRECT lprc,
00171     UINT format)
00172 {
00173     DRAWTEXTPARAMS   DTparams;
00174     LPDRAWTEXTPARAMS lpDTparams = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00175 
00176     <span class="comment">/* v-ronaar: fix bug #24985</span>
00177 <span class="comment">     * Disallow negative string lengths, except -1 (which has special meaning).</span>
00178 <span class="comment">     */</span>
00179     <span class="keywordflow">if</span> (cchText &lt; -1)
00180         <span class="keywordflow">return</span>(0);
00181 
00182     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> &amp; DT_TABSTOP) {
00183         DTparams.cbSize      = <span class="keyword">sizeof</span>(DRAWTEXTPARAMS);
00184         DTparams.iLeftMargin = DTparams.iRightMargin = 0;
00185         DTparams.iTabLength  = (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> &amp; 0xff00) &gt;&gt; 8;
00186         lpDTparams           = &amp;DTparams;
00187         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>              &amp;= 0xffff00ff;
00188     }
00189 
00190     <span class="keywordflow">return</span> <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a5">DrawTextExA</a>(hdc, (LPSTR)lpchText, cchText, lprc, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, lpDTparams);
00191 }
00192 
00193 <span class="comment">/***************************************************************************\</span>
00194 <span class="comment">* ClientTabTheTextOutForWimps</span>
00195 <span class="comment">*</span>
00196 <span class="comment">* effects: Outputs the tabbed text if fDrawTheText is TRUE and returns the</span>
00197 <span class="comment">* textextent of the tabbed text.</span>
00198 <span class="comment">*</span>
00199 <span class="comment">* nCount                    Count of bytes in string</span>
00200 <span class="comment">* nTabPositions             Count of tabstops in tabstop array</span>
00201 <span class="comment">* lpintTabStopPositions     Tab stop positions in pixels</span>
00202 <span class="comment">* iTabOrigin                Tab stops are with respect to this</span>
00203 <span class="comment">*</span>
00204 <span class="comment">* History:</span>
00205 <span class="comment">* 19-Jan-1993 mikeke   Client side</span>
00206 <span class="comment">* 13-Sep-1996 GregoryW This routine now calls the LPK(s) to handle text out.</span>
00207 <span class="comment">*                      If no LPKs are installed, this defaults to calling</span>
00208 <span class="comment">*                      UserLpkTabbedTextOut (identical behavior to what we</span>
00209 <span class="comment">*                      had before supporting LPKs).</span>
00210 <span class="comment">\***************************************************************************/</span>
00211 
<a name="l00212"></a><a class="code" href="../../d6/d0/usercli_8h.html#a422">00212</a> LONG <a class="code" href="../../d6/d0/usercli_8h.html#a422">TabTextOut</a>(
00213     HDC hdc,
00214     <span class="keywordtype">int</span> x,
00215     <span class="keywordtype">int</span> y,
00216     LPCWSTR lpstring,
00217     <span class="keywordtype">int</span> nCount,
00218     <span class="keywordtype">int</span> nTabPositions,
00219     CONST INT *lpTabPositions,
00220     <span class="keywordtype">int</span> iTabOrigin,
00221     BOOL fDrawTheText,
00222     <span class="keywordtype">int</span> iCharset)
00223 {
00224     <span class="keywordtype">int</span>     cxCharWidth;
00225     <span class="keywordtype">int</span>     cyCharHeight = 0;
00226 
00227     <span class="keywordflow">if</span> (nCount == -1 &amp;&amp; lpstring) {
00228         nCount = wcslen(lpstring);
00229     }
00230     <span class="keywordflow">if</span> (!lpstring || nCount &lt; 0 || nTabPositions &lt; 0)
00231         <span class="keywordflow">return</span> 0;
00232 
00233 
00234     <span class="comment">// Check if it is SysFont AND the mapping mode is MM_TEXT;</span>
00235     <span class="comment">// Fix made in connection with Bug #8717 --02-01-90  --SANKAR--</span>
00236     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a53">IsSysFontAndDefaultMode</a>(hdc))
00237     {
00238         cxCharWidth  = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxSysFontChar;
00239         cyCharHeight = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cySysFontChar;
00240     } <span class="keywordflow">else</span> {
00241         cxCharWidth  = GdiGetCharDimensions(hdc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;cyCharHeight);
00242         <span class="keywordflow">if</span> (cxCharWidth == 0) {
00243             RIPMSG0(RIP_WARNING, <span class="stringliteral">"TabTextOut: GdiGetCharDimensions failed"</span>);
00244             <span class="keywordflow">return</span> 0;
00245         }
00246     }
00247 
00248     <span class="keywordflow">return</span> (*fpLpkTabbedTextOut)(hdc, x, y, lpstring, nCount, nTabPositions,
00249                                  lpTabPositions, iTabOrigin, fDrawTheText,
00250                                  cxCharWidth, cyCharHeight, iCharset);
00251 }
00252 
<a name="l00253"></a><a class="code" href="../../d6/d0/usercli_8h.html#a423">00253</a> LONG <a class="code" href="../../d6/d0/usercli_8h.html#a423">UserLpkTabbedTextOut</a>(
00254     HDC hdc,
00255     <span class="keywordtype">int</span> x,
00256     <span class="keywordtype">int</span> y,
00257     LPCWSTR lpstring,
00258     <span class="keywordtype">int</span> nCount,
00259     <span class="keywordtype">int</span> nTabPositions,
00260     CONST INT *lpTabPositions,
00261     <span class="keywordtype">int</span> iTabOrigin,
00262     BOOL fDrawTheText,
00263     <span class="keywordtype">int</span> cxCharWidth,
00264     <span class="keywordtype">int</span> cyCharHeight,
00265     <span class="keywordtype">int</span> iCharset)
00266 {
00267     SIZE textextent, viewextent, windowextent;
00268     <span class="keywordtype">int</span>     initialx = x;
00269     <span class="keywordtype">int</span>     cch;
00270     LPCWSTR  lp;
00271     <span class="keywordtype">int</span>     iOneTab = 0;
00272     RECT rc;
00273     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uOpaque = (GetBkMode(hdc) == OPAQUE) ? ETO_OPAQUE : 0;
00274     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fStrStart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00275     <span class="keywordtype">int</span>     ySign = 1; <span class="comment">//Assume y increases in down direction.</span>
00276 
00277     UNREFERENCED_PARAMETER(iCharset);   <span class="comment">//Needed by lpk, but not us</span>
00278     <span class="comment">/*</span>
00279 <span class="comment">     * If no tabstop positions are specified, then use a default of 8 system</span>
00280 <span class="comment">     * font ave char widths or use the single fixed tab stop.</span>
00281 <span class="comment">     */</span>
00282     <span class="keywordflow">if</span> (!lpTabPositions) {
00283        <span class="comment">// no tab stops specified -- default to a tab stop every 8 characters</span>
00284         iOneTab = 8 * cxCharWidth;
00285     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nTabPositions == 1) {
00286         <span class="comment">// one tab stop specified -- treat value as the tab increment, one</span>
00287         <span class="comment">// tab stop every increment</span>
00288             iOneTab = lpTabPositions[0];
00289 
00290         <span class="keywordflow">if</span> (!iOneTab)
00291              iOneTab = 1;
00292     }
00293 
00294     <span class="comment">// Calculate if the y increases or decreases in the down direction using</span>
00295     <span class="comment">// the ViewPortExtent and WindowExtents.</span>
00296     <span class="comment">// If this call fails, hdc must be invalid</span>
00297     <span class="keywordflow">if</span> (!GetViewportExtEx(hdc, &amp;viewextent))
00298         <span class="keywordflow">return</span> 0;
00299     GetWindowExtEx(hdc, &amp;windowextent);
00300     <span class="keywordflow">if</span> ((viewextent.cy ^ windowextent.cy) &amp; 0x80000000)
00301          ySign = -1;
00302 
00303     rc.left = initialx;
00304     rc.top = y;
00305     rc.bottom = rc.top + (ySign * cyCharHeight);
00306 
00307     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00308         <span class="comment">// count the number of characters until the next tab character</span>
00309         <span class="comment">// this set of characters (substring) will be the working set for</span>
00310         <span class="comment">// each iteration of this loop</span>
00311         <span class="keywordflow">for</span> (cch = nCount, lp = lpstring; cch &amp;&amp; (*lp != TEXT(<span class="charliteral">'\t'</span>)); lp++, cch--)
00312         {
00313         }
00314 
00315         <span class="comment">// Compute the number of characters to be drawn with textout.</span>
00316         cch = nCount - cch;
00317 
00318         <span class="comment">// Compute the number of characters remaining.</span>
00319         nCount -= cch + 1;
00320 
00321         <span class="comment">// get height and width of substring</span>
00322         <span class="keywordflow">if</span> (cch == 0) {
00323             textextent.cx = 0;
00324             textextent.cy = cyCharHeight;
00325         } <span class="keywordflow">else</span>
00326             GetTextExtentPointW(hdc, lpstring, cch, &amp;textextent);
00327 
00328         <span class="keywordflow">if</span> (fStrStart)
00329             <span class="comment">// first iteration should just spit out the first substring</span>
00330             <span class="comment">// no tabbing occurs until the first tab character is encountered</span>
00331             fStrStart = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00332         <span class="keywordflow">else</span>
00333         {
00334            <span class="comment">// not the first iteration -- tab accordingly</span>
00335 
00336             <span class="keywordtype">int</span> xTab;
00337             <span class="keywordtype">int</span> i;
00338 
00339             <span class="keywordflow">if</span> (!iOneTab)
00340             {
00341                 <span class="comment">// look thru tab stop array for next tab stop after existing</span>
00342                 <span class="comment">// text to put this substring</span>
00343                 <span class="keywordflow">for</span> (i = 0; i &lt; nTabPositions; i++)
00344                 {
00345                     xTab = lpTabPositions[i];
00346 
00347                     <span class="keywordflow">if</span> (xTab &lt; 0)
00348                         <span class="comment">// calc length needed to use this right justified tab</span>
00349                         xTab = (iTabOrigin - xTab) - textextent.cx;
00350                     <span class="keywordflow">else</span>
00351                         <span class="comment">// calc length needed to use this left  justified tab</span>
00352                         xTab = iTabOrigin + xTab;
00353 
00354                     <span class="keywordflow">if</span> (x &lt; xTab)
00355                     {
00356                         <span class="comment">// we found a tab with enough room -- let's use it</span>
00357                         x = xTab;
00358                         <span class="keywordflow">break</span>;
00359                     }
00360                 }
00361 
00362                 <span class="keywordflow">if</span> (i == nTabPositions)
00363                     <span class="comment">// we've exhausted all of the given tab positions</span>
00364                     <span class="comment">// go back to default of a tab stop every 8 characters</span>
00365                     iOneTab = 8 * cxCharWidth;
00366             }
00367 
00368             <span class="comment">// we have to recheck iOneTab here (instead of just saying "else")</span>
00369             <span class="comment">// because iOneTab will be set if we've run out of tab stops</span>
00370             <span class="keywordflow">if</span> (iOneTab)
00371             {
00372                 <span class="keywordflow">if</span> (iOneTab &lt; 0)
00373                 {
00374                     <span class="comment">// calc next available right justified tab stop</span>
00375                     xTab = x + textextent.cx - iTabOrigin;
00376                     xTab = ((xTab / iOneTab) * iOneTab) - iOneTab - textextent.cx + iTabOrigin;
00377                 }
00378                 <span class="keywordflow">else</span>
00379                 {
00380                     <span class="comment">// calc next available left justified tab stop</span>
00381                     xTab = x - iTabOrigin;
00382                     xTab = ((xTab / iOneTab) * iOneTab) + iOneTab + iTabOrigin;
00383                 }
00384                 x = xTab;
00385             }
00386         }
00387 
00388         <span class="keywordflow">if</span> (fDrawTheText) {
00389 
00390             <span class="comment">/*</span>
00391 <span class="comment">             * Output all text up to the tab (or end of string) and get its</span>
00392 <span class="comment">             * extent.</span>
00393 <span class="comment">             */</span>
00394             rc.right = x + textextent.cx;
00395             ExtTextOutW(
00396                     hdc, x, y, uOpaque, &amp;rc, (LPWSTR)lpstring,
00397                     cch, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00398             rc.left = rc.right;
00399         }
00400 
00401         <span class="comment">// Skip over the tab and the characters we just drew.</span>
00402         x += textextent.cx;
00403 
00404         <span class="comment">// Skip over the characters we just drew.</span>
00405         lpstring += cch;
00406 
00407         <span class="comment">// See if we have more to draw OR see if this string ends in</span>
00408         <span class="comment">// a tab character that needs to be drawn.</span>
00409         <span class="keywordflow">if</span>((nCount &gt; 0) || ((nCount == 0) &amp;&amp; (*lpstring == TEXT(<span class="charliteral">'\t'</span>))))
00410         {
00411 
00412             lpstring++;  <span class="comment">// Skip over the tab</span>
00413             <span class="keywordflow">continue</span>;
00414         }
00415         <span class="keywordflow">else</span>
00416             <span class="keywordflow">break</span>;        <span class="comment">// Break from the loop.</span>
00417     }
00418     <span class="keywordflow">return</span> MAKELONG((x - initialx), (<span class="keywordtype">short</span>)textextent.cy);
00419 }
00420 
00421 
00422 
00423 <span class="comment">/***************************************************************************\</span>
00424 <span class="comment">*  TabbedTextOutW</span>
00425 <span class="comment">*</span>
00426 <span class="comment">* effects: Outputs the tabbed text and returns the</span>
00427 <span class="comment">* textextent of the tabbed text.</span>
00428 <span class="comment">*</span>
00429 <span class="comment">* nCount                    Count of bytes in string</span>
00430 <span class="comment">* nTabPositions             Count of tabstops in tabstop array</span>
00431 <span class="comment">* lpintTabStopPositions     Tab stop positions in pixels</span>
00432 <span class="comment">* iTabOrigin                Tab stops are with respect to this</span>
00433 <span class="comment">*</span>
00434 <span class="comment">* History:</span>
00435 <span class="comment">* 19-Jan-1993 mikeke   Client side</span>
00436 <span class="comment">\***************************************************************************/</span>
00437 
<a name="l00438"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a10">00438</a> LONG <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a10">TabbedTextOutW</a>(
00439     HDC hdc,
00440     <span class="keywordtype">int</span> x,
00441     <span class="keywordtype">int</span> y,
00442     LPCWSTR lpstring,
00443     <span class="keywordtype">int</span> cchChars,
00444     <span class="keywordtype">int</span> nTabPositions,
00445     CONST INT *lpintTabStopPositions,
00446     <span class="keywordtype">int</span> iTabOrigin)
00447 {
00448     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a422">TabTextOut</a>(hdc, x, y, lpstring, cchChars,
00449         nTabPositions, lpintTabStopPositions, iTabOrigin, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, -1);
00450 }
00451 
00452 <span class="comment">/***************************************************************************\</span>
00453 <span class="comment">* TabbedTextOutA (API)</span>
00454 <span class="comment">*</span>
00455 <span class="comment">* History:</span>
00456 <span class="comment">* 30-11-92 mikeke      Created</span>
00457 <span class="comment">\***************************************************************************/</span>
00458 
<a name="l00459"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a11">00459</a> LONG <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a11">TabbedTextOutA</a>(
00460     HDC hdc,
00461     <span class="keywordtype">int</span> x,
00462     <span class="keywordtype">int</span> y,
00463     LPCSTR pString,
00464     <span class="keywordtype">int</span> chCount,
00465     <span class="keywordtype">int</span> nTabPositions,
00466     CONST INT *pnTabStopPositions,
00467     <span class="keywordtype">int</span> nTabOrigin)
00468 {
00469     LPWSTR lpwstr;
00470     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet;
00471     WORD wCodePage = (WORD)GdiGetCodePage(hdc);
00472     <span class="keywordtype">int</span>  iUniString;
00473 
00474     <span class="keywordflow">if</span> (chCount == -1) {
00475         chCount = USER_AWCONV_COUNTSTRINGSZ;
00476     }
00477 
00478     <span class="keywordflow">if</span> ((iUniString = <a class="code" href="../../d5/d6/chartran_8c.html#a3">MBToWCSEx</a>(wCodePage, pString, chCount, &amp;lpwstr, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == 0) {
00479         <span class="keywordflow">if</span> (chCount == USER_AWCONV_COUNTSTRINGSZ) {
00480             lpwstr = (LPWSTR)<a class="code" href="../../d3/d2/client_2drawtext_8c.html#a3">gwszNullStr</a>;
00481         } <span class="keywordflow">else</span> {
00482             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00483         }
00484     }
00485 
00486     bRet = <a class="code" href="../../d6/d0/usercli_8h.html#a422">TabTextOut</a>(
00487             hdc, x, y, lpwstr, iUniString, nTabPositions,
00488             pnTabStopPositions, nTabOrigin, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, GetTextCharset(hdc));
00489 
00490     <span class="keywordflow">if</span> (lpwstr != <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a3">gwszNullStr</a>) {
00491         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)lpwstr);
00492     }
00493 
00494     <span class="keywordflow">return</span> bRet;
00495 }
00496 
<a name="l00497"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a12">00497</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a12">GetTabbedTextExtentW</a>(
00498     HDC hdc,
00499     LPCWSTR pString,
00500     <span class="keywordtype">int</span> chCount,
00501     <span class="keywordtype">int</span> nTabPositions,
00502     CONST INT *pnTabStopPositions)
00503 {
00504     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a422">TabTextOut</a>(hdc, 0, 0, pString, chCount,
00505         nTabPositions, pnTabStopPositions, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, -1);
00506 }
00507 
<a name="l00508"></a><a class="code" href="../../d3/d2/client_2drawtext_8c.html#a13">00508</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a13">GetTabbedTextExtentA</a>(
00509     HDC hdc,
00510     LPCSTR pString,
00511     <span class="keywordtype">int</span> chCount,
00512     <span class="keywordtype">int</span> nTabPositions,
00513     CONST INT *pnTabStopPositions)
00514 {
00515     LPWSTR lpwstr;
00516     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet;
00517     WORD wCodePage = (WORD)GdiGetCodePage(hdc);
00518     <span class="keywordtype">int</span> iUniString;
00519 
00520     <span class="keywordflow">if</span> (chCount == -1) {
00521         chCount = USER_AWCONV_COUNTSTRINGSZ;
00522     }
00523     <span class="keywordflow">if</span> ((iUniString = <a class="code" href="../../d5/d6/chartran_8c.html#a3">MBToWCSEx</a>(wCodePage, pString, chCount, &amp;lpwstr, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == 0) {
00524         <span class="keywordflow">if</span> (chCount == USER_AWCONV_COUNTSTRINGSZ) {
00525             lpwstr = (LPWSTR)<a class="code" href="../../d3/d2/client_2drawtext_8c.html#a3">gwszNullStr</a>;
00526         } <span class="keywordflow">else</span> {
00527             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00528         }
00529     }
00530 
00531     bRet = <a class="code" href="../../d6/d0/usercli_8h.html#a422">TabTextOut</a>(hdc, 0, 0, lpwstr, iUniString,
00532         nTabPositions, pnTabStopPositions, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, GetTextCharset(hdc));
00533 
00534     <span class="keywordflow">if</span> (lpwstr != <a class="code" href="../../d3/d2/client_2drawtext_8c.html#a3">gwszNullStr</a>) {
00535         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)lpwstr);
00536     }
00537 
00538     <span class="keywordflow">return</span> bRet;
00539 }
00540 
00541 
00542 <span class="comment">/***************************************************************************\</span>
00543 <span class="comment">* PSMTextOut</span>
00544 <span class="comment">*</span>
00545 <span class="comment">* Outputs the text and puts and _ below the character with an &amp;</span>
00546 <span class="comment">* before it. Note that this routine isn't used for menus since menus</span>
00547 <span class="comment">* have their own special one so that it is specialized and faster...</span>
00548 <span class="comment">*</span>
00549 <span class="comment">* History:</span>
00550 <span class="comment">* 11-13-90 JimA         Ported to NT.</span>
00551 <span class="comment">* 30-Nov-1992 mikeke    Client side version</span>
00552 <span class="comment">* 7-Apr-1998 MCostea    Added dwFlags</span>
00553 <span class="comment">\***************************************************************************/</span>
00554 
<a name="l00555"></a><a class="code" href="../../d6/d0/usercli_8h.html#a425">00555</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a425">PSMTextOut</a>(
00556     HDC hdc,
00557     <span class="keywordtype">int</span> xLeft,
00558     <span class="keywordtype">int</span> yTop,
00559     LPWSTR lpsz,
00560     <span class="keywordtype">int</span> cch,
00561     DWORD dwFlags)
00562 {
00563     <span class="comment">/*</span>
00564 <span class="comment">     * By default this is just a call to UserLpkPSMTextOut.  If an</span>
00565 <span class="comment">     * LPK is installed, this calls out to the LPK.  The LPK calls</span>
00566 <span class="comment">     * UserLpkPSMTextOut, if necessary.</span>
00567 <span class="comment">     */</span>
00568     (*fpLpkPSMTextOut)(hdc, xLeft, yTop, lpsz, cch, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00569     <span class="keywordflow">return</span>;
00570 }
00571 
00572 <span class="comment">/***************************************************************************\</span>
00573 <span class="comment">* UserLpkPSMTextOut</span>
00574 <span class="comment">*</span>
00575 <span class="comment">* NOTE: A very similar routine (xxxPSMTextOut) exists on the kernel</span>
00576 <span class="comment">*       side in text.c.  Any changes to this routine most likely need</span>
00577 <span class="comment">*       to be made in xxxPSMTextOut as well.</span>
00578 <span class="comment">*</span>
00579 <span class="comment">\***************************************************************************/</span>
<a name="l00580"></a><a class="code" href="../../d6/d0/usercli_8h.html#a424">00580</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a424">UserLpkPSMTextOut</a>(
00581     HDC hdc,
00582     <span class="keywordtype">int</span> xLeft,
00583     <span class="keywordtype">int</span> yTop,
00584     LPWSTR lpsz,
00585     <span class="keywordtype">int</span> cch,
00586     DWORD dwFlags)
00587 {
00588    <span class="keywordtype">int</span> cx;
00589    LONG textsize, result;
00590    WCHAR achWorkBuffer[255];
00591    WCHAR *pchOut = achWorkBuffer;
00592    TEXTMETRICW textMetric;
00593    SIZE size;
00594    RECT rc;
00595    COLORREF color;
00596 
00597    <span class="keywordflow">if</span> (cch &gt; <span class="keyword">sizeof</span>(achWorkBuffer)/<span class="keyword">sizeof</span>(WCHAR)) {
00598        pchOut = (WCHAR*)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, (cch+1) * <span class="keyword">sizeof</span>(WCHAR));
00599        <span class="keywordflow">if</span> (pchOut == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00600            <span class="keywordflow">return</span>;
00601    }
00602 
00603    result = <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a39">GetPrefixCount</a>(lpsz, cch, pchOut, cch);
00604    <span class="comment">/*</span>
00605 <span class="comment">    * DT_PREFIXONLY is a new 5.0 option used when switching from keyboard cues off</span>
00606 <span class="comment">    *  to on.</span>
00607 <span class="comment">    */</span>
00608    <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; DT_PREFIXONLY)) {
00609        TextOutW(hdc, xLeft, yTop, pchOut, cch - HIWORD(result));
00610    }
00611 
00612    <span class="comment">/*</span>
00613 <span class="comment">    * Any true prefix characters to underline?</span>
00614 <span class="comment">    */</span>
00615    <span class="keywordflow">if</span> (LOWORD(result) == 0xFFFF || <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; DT_HIDEPREFIX) {
00616        <span class="keywordflow">if</span> (pchOut != achWorkBuffer)
00617            <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pchOut);
00618        <span class="keywordflow">return</span>;
00619    }
00620 
00621    <span class="keywordflow">if</span> (!GetTextMetricsW(hdc, &amp;textMetric)) {
00622        textMetric.tmOverhang = 0;
00623        textMetric.tmAscent = 0;
00624    }
00625 
00626    <span class="comment">/*</span>
00627 <span class="comment">    * For proportional fonts, find starting point of underline.</span>
00628 <span class="comment">    */</span>
00629    <span class="keywordflow">if</span> (LOWORD(result) != 0) {
00630 
00631        <span class="comment">/*</span>
00632 <span class="comment">        * How far in does underline start (if not at 0th byte.).</span>
00633 <span class="comment">        */</span>
00634        GetTextExtentPointW(hdc, pchOut, LOWORD(result), &amp;size);
00635        xLeft += size.cx;
00636 
00637        <span class="comment">/*</span>
00638 <span class="comment">        * Adjust starting point of underline if not at first char and there is</span>
00639 <span class="comment">        * an overhang.  (Italics or bold fonts.)</span>
00640 <span class="comment">        */</span>
00641        xLeft = xLeft - textMetric.tmOverhang;
00642    }
00643 
00644    <span class="comment">/*</span>
00645 <span class="comment">    * Adjust for proportional font when setting the length of the underline and</span>
00646 <span class="comment">    * height of text.</span>
00647 <span class="comment">    */</span>
00648    GetTextExtentPointW(hdc, pchOut + LOWORD(result), 1, &amp;size);
00649    textsize = size.cx;
00650 
00651    <span class="comment">/*</span>
00652 <span class="comment">    * Find the width of the underline character.  Just subtract out the overhang</span>
00653 <span class="comment">    * divided by two so that we look better with italic fonts.  This is not</span>
00654 <span class="comment">    * going to effect embolded fonts since their overhang is 1.</span>
00655 <span class="comment">    */</span>
00656    cx = LOWORD(textsize) - textMetric.tmOverhang / 2;
00657 
00658    <span class="comment">/*</span>
00659 <span class="comment">    * Get height of text so that underline is at bottom.</span>
00660 <span class="comment">    */</span>
00661    yTop += textMetric.tmAscent + 1;
00662 
00663    <span class="comment">/*</span>
00664 <span class="comment">    * Draw the underline using the foreground color.</span>
00665 <span class="comment">    */</span>
00666    <a class="code" href="../../d3/d6/rect_8c.html#a1">SetRect</a>(&amp;rc, xLeft, yTop, xLeft+cx, yTop+1);
00667    color = SetBkColor(hdc, GetTextColor(hdc));
00668    ExtTextOutW(hdc, xLeft, yTop, ETO_OPAQUE, &amp;rc, TEXT(<span class="stringliteral">""</span>), 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00669    SetBkColor(hdc, color);
00670 
00671    <span class="keywordflow">if</span> (pchOut != achWorkBuffer) {
00672        <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pchOut);
00673    }
00674 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
