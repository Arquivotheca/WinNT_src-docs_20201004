<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psvdm.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psvdm.c</h1><a href="../../d3/d2/i386_2psvdm_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    psldt.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains code for the io port handler support</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Dave Hastings (daveh) 26 Jan 1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00022 
00023 
00024 <span class="preprocessor">#if DBG</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#define ASSERTEQUAL(value1, value2, string)     \</span>
00026 <span class="preprocessor">        if ((ULONG)value1 != (ULONG)value2) {   \</span>
00027 <span class="preprocessor">            DbgPrint string ;                   \</span>
00028 <span class="preprocessor">        }</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#define ASSERTEQUALBREAK(value1, value2, string)\</span>
00031 <span class="preprocessor">        if ((ULONG)value1 != (ULONG)value2) {   \</span>
00032 <span class="preprocessor">            DbgPrint string ;                   \</span>
00033 <span class="preprocessor">            DbgBreakPoint();                    \</span>
00034 <span class="preprocessor">        }</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">00037</a> <span class="preprocessor">#define ASSERTEQUAL(value1, value2, string)</span>
<a name="l00038"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define ASSERTEQUALBREAK(value1, value2, string)</span>
00039 <span class="preprocessor"></span>
00040 <span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 
00043 <span class="comment">//</span>
00044 <span class="comment">// Internal functions</span>
00045 <span class="comment">//</span>
00046 
00047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00048 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a3">Psp386InstallIoHandler</a>(
00049     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00050     IN <a class="code" href="../../d2/d3/struct__EMULATOR__ACCESS__ENTRY.html">PEMULATOR_ACCESS_ENTRY</a> EmulatorAccessEntry,
00051     IN ULONG PortNumber,
00052     IN ULONG Context
00053     );
00054 
00055 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00056 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a4">Psp386RemoveIoHandler</a>(
00057     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00058     IN <a class="code" href="../../d2/d3/struct__EMULATOR__ACCESS__ENTRY.html">PEMULATOR_ACCESS_ENTRY</a> EmulatorAccessEntry,
00059     IN ULONG PortNumber
00060     );
00061 
00062 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00063 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a5">Psp386InsertVdmIoHandlerBlock</a>(
00064     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00065     IN PVDM_IO_HANDLER VdmIoHandler
00066     );
00067 
00068 PVDM_IO_HANDLER
00069 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a6">Psp386GetVdmIoHandler</a>(
00070     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00071     IN ULONG PortNumber
00072     );
00073 
00074 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00075 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a7">Psp386CreateVdmIoListHead</a>(
00076     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00077     );
00078 
00079 
00080 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,PspVdmInitialize)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,PspSetProcessIoHandlers)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,Ps386GetVdmIoHandler)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,Psp386RemoveIoHandler)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,Psp386InstallIoHandler)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,Psp386CreateVdmIoListHead)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,Psp386InsertVdmIoHandlerBlock)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,Psp386GetVdmIoHandler)</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00090 <span class="preprocessor"></span>
00091 
00092 <span class="comment">//</span>
00093 <span class="comment">//  Resource to synchronize access to IoHandler list</span>
00094 <span class="comment">//</span>
<a name="l00095"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a2">00095</a> <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a2">VdmIoListCreationResource</a>;
00096 
00097 
00098 
00099 
00100 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00101"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a8">00101</a> <a class="code" href="../../d5/d5/vdmprint_8h.html#a15">PspSetProcessIoHandlers</a>(
00102     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00103     IN PVOID IoHandlerInformation,
00104     IN ULONG IoHandlerLength
00105     )
00106 <span class="comment">/*++</span>
00107 <span class="comment"></span>
00108 <span class="comment">Routine Description:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    This routine installs a device driver IO handling routine for the</span>
00111 <span class="comment">    specified process.  If an io operation is detected in a vdm on a port</span>
00112 <span class="comment">    that has a device driver IO handling routine, that routine will be called.</span>
00113 <span class="comment"></span>
00114 <span class="comment">Arguments:</span>
00115 <span class="comment"></span>
00116 <span class="comment">    Process -- Supplies a pointer to the process for which Io port handlers</span>
00117 <span class="comment">        are to be installed</span>
00118 <span class="comment">    IoHandlerInformation -- Supplies a pointer to the information about the</span>
00119 <span class="comment">        io port handlers</span>
00120 <span class="comment">    IoHandlerLength -- Supplies the length of the IoHandlerInformation</span>
00121 <span class="comment">        structure.</span>
00122 <span class="comment"></span>
00123 <span class="comment">Return Value:</span>
00124 <span class="comment"></span>
00125 <span class="comment"></span>
00126 <span class="comment"></span>
00127 <span class="comment">--*/</span>
00128 {
00129     PPROCESS_IO_PORT_HANDLER_INFORMATION IoHandlerInfo;
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00131     <a class="code" href="../../d2/d3/struct__EMULATOR__ACCESS__ENTRY.html">PEMULATOR_ACCESS_ENTRY</a> EmulatorAccess;
00132     ULONG EmulatorEntryNumber, NumberPorts;
00133     ULONG PortSize;
00134     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00135 
00136     <span class="comment">//</span>
00137     <span class="comment">// Insure that this call was made from KernelMode</span>
00138     <span class="comment">//</span>
00139     <span class="keywordflow">if</span> (KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00140         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;    <span class="comment">// this info type invalid in usermode</span>
00141     }
00142     <span class="comment">//</span>
00143     <span class="comment">// Insure that the data passed is long enough</span>
00144     <span class="comment">//</span>
00145     <span class="keywordflow">if</span> (IoHandlerLength &lt; (ULONG)<span class="keyword">sizeof</span>( PROCESS_IO_PORT_HANDLER_INFORMATION)) {
00146         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00147     }
00148     IoHandlerInfo = IoHandlerInformation;
00149 
00150     <span class="comment">//</span>
00151     <span class="comment">// For each of the entries in the array that describes the handlers,</span>
00152     <span class="comment">// determine what size of port the specified handler is being installed</span>
00153     <span class="comment">// for, and then iterate over each individual port.</span>
00154     <span class="comment">//</span>
00155     <span class="keywordflow">for</span> (EmulatorEntryNumber = 0, EmulatorAccess =
00156             IoHandlerInfo-&gt;EmulatorAccessEntries;
00157         EmulatorEntryNumber &lt; IoHandlerInfo-&gt;NumEntries;
00158         EmulatorEntryNumber++, EmulatorAccess++) {
00159 
00160             <span class="keywordflow">switch</span> (EmulatorAccess-&gt;AccessType) {
00161             <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a12">Uchar</a>:
00162                 PortSize = 1;
00163                 <span class="keywordflow">break</span>;
00164             <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a13">Ushort</a>:
00165                 PortSize = 2;
00166                 <span class="keywordflow">break</span>;
00167             <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a14">Ulong</a>:
00168                 PortSize = 4;
00169             }
00170 
00171             <span class="keywordflow">for</span> (NumberPorts = 0;
00172                 NumberPorts &lt; EmulatorAccess-&gt;NumConsecutivePorts;
00173                 NumberPorts++) {
00174                     <span class="keywordflow">if</span> (IoHandlerInfo-&gt;Install) {
00175                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a3">Psp386InstallIoHandler</a>(
00176                             Process,
00177                             EmulatorAccess,
00178                             EmulatorAccess-&gt;BasePort + NumberPorts * PortSize,
00179                             IoHandlerInfo-&gt;Context
00180                             );
00181                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00182                         }
00183                     } <span class="keywordflow">else</span> {
00184                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a4">Psp386RemoveIoHandler</a>(
00185                             Process,
00186                             EmulatorAccess,
00187                             EmulatorAccess-&gt;BasePort + NumberPorts * PortSize
00188                             );
00189                     }
00190                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00191                         <span class="keywordflow">goto</span> exitloop;
00192                     }
00193             }
00194     }
00195     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00196 exitloop:
00197     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198 
00199 }
00200 
00201 
00202 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00203"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a9">00203</a> <a class="code" href="../../d8/d1/psp_8h.html#a87">PspDeleteVdmObjects</a>(
00204     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00205     )
00206 <span class="comment">/*++</span>
00207 <span class="comment"></span>
00208 <span class="comment">Routine Description:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    Frees the VdmObjects structure and the Frees the IoHandler list</span>
00211 <span class="comment"></span>
00212 <span class="comment">Arguments:</span>
00213 <span class="comment"></span>
00214 <span class="comment">    Process -- Supplies a pointer to the process</span>
00215 <span class="comment"></span>
00216 <span class="comment">Return Value:</span>
00217 <span class="comment"></span>
00218 <span class="comment">    None</span>
00219 <span class="comment">--*/</span>
00220 {
00221 
00222     PVDM_PROCESS_OBJECTS pVdmObjects = Process-&gt;VdmObjects;
00223     PVDM_IO_HANDLER p1, p2;
00224     PVDM_IO_LISTHEAD p3;
00225     PLIST_ENTRY  Next;
00226     PDELAYINTIRQ pDelayIntIrq;
00227     KIRQL OldIrql;
00228 
00229     <span class="keywordflow">if</span> (pVdmObjects == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00230         <span class="keywordflow">return</span>;
00231     }
00232 
00233     <span class="comment">//</span>
00234     <span class="comment">// First Free any port handler entries for this process,</span>
00235     <span class="comment">//</span>
00236     p1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237     p3 = pVdmObjects-&gt;VdmIoListHead;
00238 
00239     <span class="keywordflow">if</span> (p3) {
00240         p2 = p3-&gt;VdmIoHandlerList;
00241 
00242         <span class="keywordflow">while</span> (p2) {
00243             p1 = p2;
00244             p2 = p1-&gt;Next;
00245             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( p1 );
00246         }
00247 
00248         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>(&amp;p3-&gt;VdmIoResource);
00249 
00250         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( p3 );
00251         pVdmObjects-&gt;VdmIoListHead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00252     }
00253 
00254     <span class="keywordflow">if</span> (pVdmObjects-&gt;pIcaUserData) {
00255         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pVdmObjects-&gt;pIcaUserData);
00256         }
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// Free up the DelayedIntList, canceling pending timers.</span>
00260     <span class="comment">//</span>
00261     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, &amp;OldIrql);
00262 
00263     Next = pVdmObjects-&gt;DelayIntListHead.Flink;
00264     <span class="keywordflow">while</span> (Next != &amp;pVdmObjects-&gt;DelayIntListHead) {
00265         pDelayIntIrq = CONTAINING_RECORD(Next, DELAYINTIRQ, DelayIntListEntry);
00266         Next = Next-&gt;Flink;
00267         RemoveEntryList(&amp;pDelayIntIrq-&gt;DelayIntListEntry);
00268         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDelayIntIrq);
00269         }
00270 
00271     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, OldIrql);
00272 
00273     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Process-&gt;VdmObjects);
00274     Process-&gt;VdmObjects = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00275 }
00276 
00277 
00278 
00279 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00280"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a4">00280</a> <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a4">Psp386RemoveIoHandler</a>(
00281     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00282     IN <a class="code" href="../../d2/d3/struct__EMULATOR__ACCESS__ENTRY.html">PEMULATOR_ACCESS_ENTRY</a> EmulatorAccessEntry,
00283     IN ULONG PortNumber
00284     )
00285 <span class="comment">/*++</span>
00286 <span class="comment"></span>
00287 <span class="comment">Routine Description:</span>
00288 <span class="comment"></span>
00289 <span class="comment">    This routine remove a handler for a port.  On debug version, it will</span>
00290 <span class="comment">    print a message if there is no handler.</span>
00291 <span class="comment"></span>
00292 <span class="comment">Arguments:</span>
00293 <span class="comment"></span>
00294 <span class="comment">    Process -- Supplies a pointer to the process</span>
00295 <span class="comment">    EmulatorAccess -- Supplies a pointer to the information about the</span>
00296 <span class="comment">        io port handler</span>
00297 <span class="comment">    PortNumber -- Supplies the port number to remove the handler from.</span>
00298 <span class="comment"></span>
00299 <span class="comment">Return Value:</span>
00300 <span class="comment"></span>
00301 <span class="comment">--*/</span>
00302 {
00303     PVDM_PROCESS_OBJECTS pVdmObjects = Process-&gt;VdmObjects;
00304     PVDM_IO_HANDLER VdmIoHandler;
00305     KIRQL OldIrql;
00306     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Ensure we have a vdm process which is initialized</span>
00310     <span class="comment">// correctly for VdmIoHandlers</span>
00311     <span class="comment">//</span>
00312     <span class="keywordflow">if</span> (!pVdmObjects) {
00313 <span class="preprocessor">#if DBG</span>
00314 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Psp386RemoveIoHandler: uninitialized VdmObjects\n"</span>);
00315 <span class="preprocessor">#endif</span>
00316 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00317     }
00318 
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">// If the list does not have a head, then there are no handlers to</span>
00322     <span class="comment">// remove.</span>
00323     <span class="comment">//</span>
00324     <span class="keywordflow">if</span> (!pVdmObjects-&gt;VdmIoListHead) {
00325 <span class="preprocessor">#if DBG</span>
00326 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Psp386RemoveIoHandler : attempt to remove non-existent hdlr\n"</span>);
00327 <span class="preprocessor">#endif</span>
00328 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_SUCCESS;
00329     }
00330 
00331     <span class="comment">//</span>
00332     <span class="comment">// Lock the list, so we can insure a correct update.</span>
00333     <span class="comment">//</span>
00334     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00335     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00336 
00337     VdmIoHandler = <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a6">Psp386GetVdmIoHandler</a>(
00338         Process,
00339         PortNumber &amp; ~0x3
00340         );
00341 
00342     <span class="keywordflow">if</span> (!VdmIoHandler) {
00343 <span class="preprocessor">#if DBG</span>
00344 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Psp386RemoveIoHandler : attempt to remove non-existent hdlr\n"</span>);
00345 <span class="preprocessor">#endif</span>
00346 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource);
00347         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00348         <span class="keywordflow">return</span> STATUS_SUCCESS;
00349     }
00350 
00351     <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00352         VdmIoHandler-&gt;PortNumber,
00353         PortNumber &amp; ~0x3,
00354         (<span class="stringliteral">"Psp386RemoveIoHandler : Bad pointer returned from GetVdmIoHandler\n"</span>)
00355         );
00356 
00357     <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;AccessMode &amp; <a class="code" href="../../d4/d3/v86emul_8h.html#a0">EMULATOR_READ_ACCESS</a>) {
00358         <span class="keywordflow">switch</span> (EmulatorAccessEntry-&gt;AccessType) {
00359         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a12">Uchar</a>:
00360             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00361                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00362                     EmulatorAccessEntry-&gt;Routine,
00363                     VdmIoHandler-&gt;IoFunctions[0].UcharStringIo[PortNumber % 4],
00364                     (<span class="stringliteral">"Psp386RemoveIoHandler : UcharString fns don't match\n"</span>)
00365                     );
00366                 VdmIoHandler-&gt;IoFunctions[0].UcharStringIo[PortNumber % 4] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00367             } <span class="keywordflow">else</span> {
00368                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00369                     EmulatorAccessEntry-&gt;Routine,
00370                     VdmIoHandler-&gt;IoFunctions[0].UcharIo[PortNumber % 4],
00371                     (<span class="stringliteral">"Psp386RemoveIoHandler : Uchar fns don't match\n"</span>)
00372                     );
00373                 VdmIoHandler-&gt;IoFunctions[0].UcharIo[PortNumber % 4] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00374             }
00375             <span class="keywordflow">break</span>;
00376         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a13">Ushort</a>:
00377             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00378                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00379                     EmulatorAccessEntry-&gt;Routine,
00380                     VdmIoHandler-&gt;IoFunctions[0].UshortStringIo[(PortNumber &amp; 2) &gt;&gt; 1],
00381                     (<span class="stringliteral">"Psp386RemoveIoHandler : UshortString fns don't match\n"</span>)
00382                     );
00383                 VdmIoHandler-&gt;IoFunctions[0].UshortStringIo[(PortNumber &amp; 2) &gt;&gt; 1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00384             } <span class="keywordflow">else</span> {
00385                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00386                     EmulatorAccessEntry-&gt;Routine,
00387                     VdmIoHandler-&gt;IoFunctions[0].UshortIo[(PortNumber &amp; 2) &gt;&gt; 1],
00388                     (<span class="stringliteral">"Psp386RemoveIoHandler : Ushort fns don't match\n"</span>)
00389                     );
00390                 VdmIoHandler-&gt;IoFunctions[0].UshortIo[(PortNumber &amp; 2) &gt;&gt; 1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00391             }
00392             <span class="keywordflow">break</span>;
00393         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a14">Ulong</a>:
00394             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00395                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00396                     EmulatorAccessEntry-&gt;Routine,
00397                     VdmIoHandler-&gt;IoFunctions[0].UlongStringIo,
00398                     (<span class="stringliteral">"Psp386RemoveIoHandler : UlongString fns don't match\n"</span>)
00399                     );
00400                 VdmIoHandler-&gt;IoFunctions[0].UlongStringIo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00401             } <span class="keywordflow">else</span> {
00402                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00403                     EmulatorAccessEntry-&gt;Routine,
00404                     VdmIoHandler-&gt;IoFunctions[0].UlongIo,
00405                     (<span class="stringliteral">"Psp386RemoveIoHandler : Ulong fns don't match\n"</span>)
00406                     );
00407                 VdmIoHandler-&gt;IoFunctions[0].UlongIo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00408             }
00409             <span class="keywordflow">break</span>;
00410         }
00411     }
00412 
00413     <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;AccessMode &amp; <a class="code" href="../../d4/d3/v86emul_8h.html#a1">EMULATOR_WRITE_ACCESS</a>) {
00414         <span class="keywordflow">switch</span> (EmulatorAccessEntry-&gt;AccessType) {
00415         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a12">Uchar</a>:
00416             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00417                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00418                     EmulatorAccessEntry-&gt;Routine,
00419                     VdmIoHandler-&gt;IoFunctions[1].UcharStringIo[PortNumber % 4],
00420                     (<span class="stringliteral">"Psp386RemoveIoHandler : UcharString fns don't match\n"</span>)
00421                     );
00422                 VdmIoHandler-&gt;IoFunctions[1].UcharStringIo[PortNumber % 4] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00423             } <span class="keywordflow">else</span> {
00424                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00425                     EmulatorAccessEntry-&gt;Routine,
00426                     VdmIoHandler-&gt;IoFunctions[1].UcharIo[PortNumber % 4],
00427                     (<span class="stringliteral">"Psp386RemoveIoHandler : Uchar fns don't match\n"</span>)
00428                     );
00429                 VdmIoHandler-&gt;IoFunctions[1].UcharIo[PortNumber % 4] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00430             }
00431             <span class="keywordflow">break</span>;
00432         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a13">Ushort</a>:
00433             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00434                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00435                     EmulatorAccessEntry-&gt;Routine,
00436                     VdmIoHandler-&gt;IoFunctions[1].UshortStringIo[(PortNumber &amp; 2) &gt;&gt; 1],
00437                     (<span class="stringliteral">"Psp386RemoveIoHandler : UshortString fns don't match\n"</span>)
00438                     );
00439                 VdmIoHandler-&gt;IoFunctions[1].UshortStringIo[(PortNumber &amp; 2) &gt;&gt; 1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00440             } <span class="keywordflow">else</span> {
00441                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00442                     EmulatorAccessEntry-&gt;Routine,
00443                     VdmIoHandler-&gt;IoFunctions[1].UshortIo[(PortNumber &amp; 2) &gt;&gt; 1],
00444                     (<span class="stringliteral">"Psp386RemoveIoHandler : Ushort fns don't match\n"</span>)
00445                     );
00446                 VdmIoHandler-&gt;IoFunctions[1].UshortIo[(PortNumber &amp; 2) &gt;&gt; 1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00447             }
00448             <span class="keywordflow">break</span>;
00449         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a14">Ulong</a>:
00450             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00451                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00452                     EmulatorAccessEntry-&gt;Routine,
00453                     VdmIoHandler-&gt;IoFunctions[1].UlongStringIo,
00454                     (<span class="stringliteral">"Psp386RemoveIoHandler : UlongString fns don't match\n"</span>)
00455                     );
00456                 VdmIoHandler-&gt;IoFunctions[1].UlongStringIo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00457             } <span class="keywordflow">else</span> {
00458                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a0">ASSERTEQUAL</a>(
00459                     EmulatorAccessEntry-&gt;Routine,
00460                     VdmIoHandler-&gt;IoFunctions[1].UlongIo,
00461                     (<span class="stringliteral">"Psp386RemoveIoHandler : Ulong fns don't match\n"</span>)
00462                     );
00463                 VdmIoHandler-&gt;IoFunctions[1].UlongIo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00464             }
00465             <span class="keywordflow">break</span>;
00466         }
00467     }
00468 
00469     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource);
00470     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00471 
00472     <span class="keywordflow">return</span> STATUS_SUCCESS;
00473 
00474 }
00475 
00476 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00477"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a3">00477</a> <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a3">Psp386InstallIoHandler</a>(
00478     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00479     IN <a class="code" href="../../d2/d3/struct__EMULATOR__ACCESS__ENTRY.html">PEMULATOR_ACCESS_ENTRY</a> EmulatorAccessEntry,
00480     IN ULONG PortNumber,
00481     IN ULONG Context
00482     )
00483 <span class="comment">/*++</span>
00484 <span class="comment"></span>
00485 <span class="comment">Routine Description:</span>
00486 <span class="comment"></span>
00487 <span class="comment">    This routine install a handler for a port.  On debug version, it will</span>
00488 <span class="comment">    print a message if there is already a handler.</span>
00489 <span class="comment"></span>
00490 <span class="comment">Arguments:</span>
00491 <span class="comment"></span>
00492 <span class="comment">    Process -- Supplies a pointer to the process</span>
00493 <span class="comment">    EmulatorAccess -- Supplies a pointer to the information about the</span>
00494 <span class="comment">        io port handler</span>
00495 <span class="comment">    PortNumber -- Supplies the port number to install the handler for.</span>
00496 <span class="comment"></span>
00497 <span class="comment">Return Value:</span>
00498 <span class="comment"></span>
00499 <span class="comment">--*/</span>
00500 {
00501     PVDM_PROCESS_OBJECTS pVdmObjects = Process-&gt;VdmObjects;
00502     PVDM_IO_HANDLER VdmIoHandler;
00503     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00504     KIRQL    OldIrql;
00505     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00506 
00507 
00508     <span class="comment">//</span>
00509     <span class="comment">// Ensure we have a vdm process which is initialized</span>
00510     <span class="comment">// correctly for VdmIoHandlers</span>
00511     <span class="comment">//</span>
00512     <span class="keywordflow">if</span> (!pVdmObjects) {
00513 <span class="preprocessor">#if DBG</span>
00514 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Psp386InstallIoHandler: uninitialized VdmObjects\n"</span>);
00515 <span class="preprocessor">#endif</span>
00516 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00517     }
00518 
00519 
00520     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00521 
00522     <span class="comment">//</span>
00523     <span class="comment">// If this is the first handler to be installed, create the list head,</span>
00524     <span class="comment">// and initialize the resource lock.</span>
00525     <span class="comment">//</span>
00526     <span class="keywordflow">if</span> (!pVdmObjects-&gt;VdmIoListHead) {
00527         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a7">Psp386CreateVdmIoListHead</a>(
00528             Process
00529             );
00530 
00531         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00532             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00533         }
00534     }
00535 
00536     <span class="comment">//</span>
00537     <span class="comment">// Lock the list to insure correct update.</span>
00538     <span class="comment">//</span>
00539     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00540     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Update Context</span>
00544     <span class="comment">//</span>
00545 
00546     pVdmObjects-&gt;VdmIoListHead-&gt;Context = Context;
00547 
00548     VdmIoHandler = <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a6">Psp386GetVdmIoHandler</a>(
00549         Process,
00550         PortNumber &amp; ~0x3
00551         );
00552 
00553     <span class="comment">// If there isn't already a node for this block of ports,</span>
00554     <span class="comment">// attempt to allocate a new one.</span>
00555     <span class="comment">//</span>
00556     <span class="keywordflow">if</span> (!VdmIoHandler) {
00557         <span class="keywordflow">try</span> {
00558 
00559             VdmIoHandler = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>(
00560                                 <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00561                                 <span class="keyword">sizeof</span>(VDM_IO_HANDLER)
00562                                 );
00563 
00564         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00565             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00566             <span class="keywordflow">if</span> (VdmIoHandler) {
00567                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(VdmIoHandler);
00568             }
00569         }
00570 
00571         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00572             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource);
00573             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00574             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00575         }
00576 
00577         RtlZeroMemory(VdmIoHandler, <span class="keyword">sizeof</span>(VDM_IO_HANDLER));
00578         VdmIoHandler-&gt;PortNumber = PortNumber &amp; ~0x3;
00579 
00580         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a5">Psp386InsertVdmIoHandlerBlock</a>(
00581             Process,
00582             VdmIoHandler
00583             );
00584 
00585         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00586             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource);
00587             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00588             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00589         }
00590     }
00591 
00592     <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00593         VdmIoHandler-&gt;PortNumber,
00594         PortNumber &amp; ~0x3,
00595         (<span class="stringliteral">"Psp386InstallIoHandler : Bad pointer returned from GetVdmIoHandler\n"</span>)
00596         );
00597 
00598     <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;AccessMode &amp; <a class="code" href="../../d4/d3/v86emul_8h.html#a0">EMULATOR_READ_ACCESS</a>) {
00599         <span class="keywordflow">switch</span> (EmulatorAccessEntry-&gt;AccessType) {
00600         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a12">Uchar</a>:
00601             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00602                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00603                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00604                     VdmIoHandler-&gt;IoFunctions[0].UcharStringIo[PortNumber % 4],
00605                     (<span class="stringliteral">"Psp386InstallIoHandler : UcharString fns don't match\n"</span>)
00606                     );
00607                 VdmIoHandler-&gt;IoFunctions[0].UcharStringIo[PortNumber % 4] =
00608                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a7">PDRIVER_IO_PORT_UCHAR_STRING</a>)EmulatorAccessEntry-&gt;Routine;
00609             } <span class="keywordflow">else</span> {
00610                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00611                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00612                     VdmIoHandler-&gt;IoFunctions[0].UcharIo[PortNumber % 4],
00613                     (<span class="stringliteral">"Psp386InstallIoHandler : Uchar fns don't match\n"</span>)
00614                     );
00615                 VdmIoHandler-&gt;IoFunctions[0].UcharIo[PortNumber % 4] =
00616                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a6">PDRIVER_IO_PORT_UCHAR</a>)EmulatorAccessEntry-&gt;Routine;
00617             }
00618             <span class="keywordflow">break</span>;
00619         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a13">Ushort</a>:
00620             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00621                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00622                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00623                     VdmIoHandler-&gt;IoFunctions[0].UshortStringIo[(PortNumber &amp; 2) &gt;&gt; 1],
00624                     (<span class="stringliteral">"Psp386InstallIoHandler : UshortString fns don't match\n"</span>)
00625                     );
00626                 VdmIoHandler-&gt;IoFunctions[0].UshortStringIo[(PortNumber &amp; 2) &gt;&gt; 1] =
00627                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a9">PDRIVER_IO_PORT_USHORT_STRING</a>)EmulatorAccessEntry-&gt;Routine;
00628             } <span class="keywordflow">else</span> {
00629                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00630                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00631                     VdmIoHandler-&gt;IoFunctions[0].UshortIo[(PortNumber &amp; 2) &gt;&gt; 1],
00632                     (<span class="stringliteral">"Psp386InstallIoHandler : Ushort fns don't match\n"</span>)
00633                     );
00634                 VdmIoHandler-&gt;IoFunctions[0].UshortIo[(PortNumber &amp; 2) &gt;&gt; 1] =
00635                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a8">PDRIVER_IO_PORT_USHORT</a>)EmulatorAccessEntry-&gt;Routine;
00636             }
00637             <span class="keywordflow">break</span>;
00638         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a14">Ulong</a>:
00639             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00640                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00641                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00642                     VdmIoHandler-&gt;IoFunctions[0].UlongStringIo,
00643                     (<span class="stringliteral">"Psp386InstallIoHandler : UlongString fns don't match\n"</span>)
00644                     );
00645                 VdmIoHandler-&gt;IoFunctions[0].UlongStringIo =
00646                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a11">PDRIVER_IO_PORT_ULONG_STRING</a>)EmulatorAccessEntry-&gt;Routine;
00647             } <span class="keywordflow">else</span> {
00648                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00649                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00650                     VdmIoHandler-&gt;IoFunctions[0].UlongIo,
00651                     (<span class="stringliteral">"Psp386InstallIoHandler : Ulong fns don't match\n"</span>)
00652                     );
00653                 VdmIoHandler-&gt;IoFunctions[0].UlongIo =
00654                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a10">PDRIVER_IO_PORT_ULONG</a>)EmulatorAccessEntry-&gt;Routine;
00655             }
00656             <span class="keywordflow">break</span>;
00657         }
00658     }
00659 
00660     <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;AccessMode &amp; <a class="code" href="../../d4/d3/v86emul_8h.html#a1">EMULATOR_WRITE_ACCESS</a>) {
00661         <span class="keywordflow">switch</span> (EmulatorAccessEntry-&gt;AccessType) {
00662         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a12">Uchar</a>:
00663             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00664                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00665                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00666                     VdmIoHandler-&gt;IoFunctions[1].UcharStringIo[PortNumber % 4],
00667                     (<span class="stringliteral">"Psp386InstallIoHandler : UcharString fns don't match\n"</span>)
00668                     );
00669                 VdmIoHandler-&gt;IoFunctions[1].UcharStringIo[PortNumber % 4] =
00670                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a7">PDRIVER_IO_PORT_UCHAR_STRING</a>)EmulatorAccessEntry-&gt;Routine;
00671             } <span class="keywordflow">else</span> {
00672                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00673                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00674                     VdmIoHandler-&gt;IoFunctions[1].UcharIo[PortNumber % 4],
00675                     (<span class="stringliteral">"Psp386InstallIoHandler : Uchar fns don't match\n"</span>)
00676                     );
00677                 VdmIoHandler-&gt;IoFunctions[1].UcharIo[PortNumber % 4] =
00678                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a6">PDRIVER_IO_PORT_UCHAR</a>)EmulatorAccessEntry-&gt;Routine;
00679             }
00680             <span class="keywordflow">break</span>;
00681         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a13">Ushort</a>:
00682             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00683                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00684                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00685                     VdmIoHandler-&gt;IoFunctions[1].UshortStringIo[(PortNumber &amp; 2) &gt;&gt; 1],
00686                     (<span class="stringliteral">"Psp386InstallIoHandler : UshortString fns don't match\n"</span>)
00687                     );
00688                 VdmIoHandler-&gt;IoFunctions[1].UshortStringIo[(PortNumber &amp; 2) &gt;&gt; 1] =
00689                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a9">PDRIVER_IO_PORT_USHORT_STRING</a>)EmulatorAccessEntry-&gt;Routine;
00690             } <span class="keywordflow">else</span> {
00691                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00692                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00693                     VdmIoHandler-&gt;IoFunctions[1].UshortIo[(PortNumber &amp; 2) &gt;&gt; 1],
00694                     (<span class="stringliteral">"Psp386InstallIoHandler : Ushort fns don't match\n"</span>)
00695                     );
00696                 VdmIoHandler-&gt;IoFunctions[1].UshortIo[(PortNumber &amp; 2) &gt;&gt; 1] =
00697                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a8">PDRIVER_IO_PORT_USHORT</a>)EmulatorAccessEntry-&gt;Routine;
00698             }
00699             <span class="keywordflow">break</span>;
00700         <span class="keywordflow">case</span> <a class="code" href="../../d4/d3/v86emul_8h.html#a15a14">Ulong</a>:
00701             <span class="keywordflow">if</span> (EmulatorAccessEntry-&gt;StringSupport) {
00702                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00703                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00704                     VdmIoHandler-&gt;IoFunctions[1].UlongStringIo,
00705                     (<span class="stringliteral">"Psp386InstallIoHandler : UlongString fns don't match\n"</span>)
00706                     );
00707                 VdmIoHandler-&gt;IoFunctions[1].UlongStringIo =
00708                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a11">PDRIVER_IO_PORT_ULONG_STRING</a>)EmulatorAccessEntry-&gt;Routine;
00709             } <span class="keywordflow">else</span> {
00710                 <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a1">ASSERTEQUALBREAK</a>(
00711                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00712                     VdmIoHandler-&gt;IoFunctions[1].UlongIo,
00713                     (<span class="stringliteral">"Psp386InstallIoHandler : Ulong fns don't match\n"</span>)
00714                     );
00715                 VdmIoHandler-&gt;IoFunctions[1].UlongIo =
00716                     (<a class="code" href="../../d4/d3/v86emul_8h.html#a10">PDRIVER_IO_PORT_ULONG</a>)EmulatorAccessEntry-&gt;Routine;
00717             }
00718         }
00719     }
00720 
00721     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource);
00722     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00723     <span class="keywordflow">return</span> STATUS_SUCCESS;
00724 
00725 }
00726 
00727 
00728 
00729 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00730"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a7">00730</a> <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a7">Psp386CreateVdmIoListHead</a>(
00731     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00732     )
00733 <span class="comment">/*++</span>
00734 <span class="comment"></span>
00735 <span class="comment">Routine Description:</span>
00736 <span class="comment"></span>
00737 <span class="comment">    This routine creates the head node of the Io handler list.  This node</span>
00738 <span class="comment">    contains the spin lock that protects the list.  This routine also</span>
00739 <span class="comment">    initializes the spin lock.</span>
00740 <span class="comment"></span>
00741 <span class="comment">Arguments:</span>
00742 <span class="comment"></span>
00743 <span class="comment">    Process -- Supplies a pointer to the process</span>
00744 <span class="comment"></span>
00745 <span class="comment">Return Value:</span>
00746 <span class="comment"></span>
00747 <span class="comment">Notes:</span>
00748 <span class="comment"></span>
00749 <span class="comment">--*/</span>
00750 {
00751     PVDM_PROCESS_OBJECTS pVdmObjects = Process-&gt;VdmObjects;
00752     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00753     PVDM_IO_LISTHEAD HandlerListHead;
00754     KIRQL    OldIrql;
00755     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00756 
00757     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00758 
00759     <span class="comment">// if there isn't yet a head, grab the resource lock and create one</span>
00760     <span class="keywordflow">if</span> (pVdmObjects-&gt;VdmIoListHead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00761         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00762         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a2">VdmIoListCreationResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00763 
00764         <span class="comment">// if no head was created while we grabbed the spin lock</span>
00765         <span class="keywordflow">if</span> (pVdmObjects-&gt;VdmIoListHead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00766 
00767             <span class="keywordflow">try</span> {
00768                 <span class="comment">// allocate space for the list head</span>
00769                 <span class="comment">// and charge the quota for it</span>
00770 
00771                 HandlerListHead = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>(
00772                                        <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00773                                        <span class="keyword">sizeof</span>(VDM_IO_LISTHEAD)
00774                                        );
00775 
00776                 } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00777                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00778                     <span class="keywordflow">if</span> (HandlerListHead) {
00779                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(HandlerListHead);
00780                     }
00781                 }
00782 
00783             <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || !HandlerListHead)) {
00784                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a2">VdmIoListCreationResource</a>);
00785                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00786 
00787                 <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ?
00788                     STATUS_INSUFFICIENT_RESOURCES :
00789                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00790 
00791             }
00792 
00793             <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;HandlerListHead-&gt;VdmIoResource);
00794 
00795             HandlerListHead-&gt;VdmIoHandlerList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00796 
00797             <span class="comment">//</span>
00798             <span class="comment">// Attach the list head to the process</span>
00799             <span class="comment">// and attach the handler to the list.</span>
00800             <span class="comment">// Since this was a new list</span>
00801 
00802             pVdmObjects-&gt;VdmIoListHead = HandlerListHead;
00803 
00804             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a2">VdmIoListCreationResource</a>);
00805             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00806 
00807 
00808         }
00809     }
00810     <span class="keywordflow">return</span> STATUS_SUCCESS;
00811 }
00812 
00813 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00814"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a5">00814</a> <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a5">Psp386InsertVdmIoHandlerBlock</a>(
00815     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00816     IN PVDM_IO_HANDLER VdmIoHandler
00817     )
00818 <span class="comment">/*++</span>
00819 <span class="comment"></span>
00820 <span class="comment">Routine Description:</span>
00821 <span class="comment"></span>
00822 <span class="comment">    This routine inserts a new VdmIoHandler block into the process's io</span>
00823 <span class="comment">    handler list.</span>
00824 <span class="comment"></span>
00825 <span class="comment">Arguments:</span>
00826 <span class="comment"></span>
00827 <span class="comment">    Process -- Supplies a pointer to the process</span>
00828 <span class="comment">    VdmIoHandler -- Supplies a pointer to the block to insert.</span>
00829 <span class="comment"></span>
00830 <span class="comment">Return Value:</span>
00831 <span class="comment"></span>
00832 <span class="comment">--*/</span>
00833 {
00834     PVDM_PROCESS_OBJECTS pVdmObjects = Process-&gt;VdmObjects;
00835     PVDM_IO_HANDLER <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>, p;
00836     PVDM_IO_LISTHEAD HandlerListHead;
00837     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00838 
00839 
00840     HandlerListHead = pVdmObjects-&gt;VdmIoListHead;
00841     <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a> = HandlerListHead-&gt;VdmIoHandlerList;
00842     p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00843     <span class="keywordflow">while</span> ((<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00844         (<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>-&gt;PortNumber &lt; VdmIoHandler-&gt;PortNumber)) {
00845 <span class="preprocessor">#if DBG</span>
00846 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>-&gt;PortNumber == VdmIoHandler-&gt;PortNumber) {
00847                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Ps386InsertVdmIoHandlerBlock : handler list corrupt\n"</span>);
00848             }
00849 <span class="preprocessor">#endif</span>
00850 <span class="preprocessor"></span>            p = <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>;
00851             <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a> = <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>-&gt;Next;
00852     }
00853 
00854     <span class="keywordflow">if</span> (p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <span class="comment">// Beginning of list</span>
00855         VdmIoHandler-&gt;Next = HandlerListHead-&gt;VdmIoHandlerList;
00856         HandlerListHead-&gt;VdmIoHandlerList = VdmIoHandler;
00857     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <span class="comment">// End of list</span>
00858         p-&gt;Next = VdmIoHandler;
00859         VdmIoHandler-&gt;Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00860     } <span class="keywordflow">else</span> { <span class="comment">// Middle of list</span>
00861         VdmIoHandler-&gt;Next = <a class="code" href="../../d9/d0/ctrlc_8c.html#a8">HandlerList</a>;
00862         p-&gt;Next = VdmIoHandler;
00863     }
00864 
00865     <span class="keywordflow">return</span> STATUS_SUCCESS;
00866 }
00867 
00868 BOOLEAN
<a name="l00869"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a10">00869</a> <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a10">Ps386GetVdmIoHandler</a>(
00870     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00871     IN ULONG PortNumber,
00872     OUT PVDM_IO_HANDLER VdmIoHandler,
00873     OUT PULONG Context
00874     )
00875 <span class="comment">/*++</span>
00876 <span class="comment"></span>
00877 <span class="comment">Routine Description:</span>
00878 <span class="comment"></span>
00879 <span class="comment">    This routine finds the VdmIoHandler block for the specified port.</span>
00880 <span class="comment"></span>
00881 <span class="comment">Arguments:</span>
00882 <span class="comment"></span>
00883 <span class="comment">    Process -- Supplies a pointer to the process</span>
00884 <span class="comment">    PortNumber -- Supplies the port number</span>
00885 <span class="comment">    VdmIoHandler -- Supplies a pointer to the destination for the lookup</span>
00886 <span class="comment"></span>
00887 <span class="comment">Returns:</span>
00888 <span class="comment"></span>
00889 <span class="comment">    True -- A handler structure was found and copied</span>
00890 <span class="comment">    False -- A handler structure was not found</span>
00891 <span class="comment"></span>
00892 <span class="comment"></span>
00893 <span class="comment">--*/</span>
00894 {
00895     PVDM_PROCESS_OBJECTS pVdmObjects = Process-&gt;VdmObjects;
00896     PVDM_IO_HANDLER p;
00897     BOOLEAN Success;
00898     KIRQL   OldIrql;
00899     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00900 
00901     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (pVdmObjects != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00902 
00903     <span class="keywordflow">if</span> (PortNumber % 4) {
00904 <span class="preprocessor">#if DBG</span>
00905 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
00906             <span class="stringliteral">"Ps386GetVdmIoHandler : Invalid Port Number %lx\n"</span>,
00907             PortNumber
00908             );
00909 <span class="preprocessor">#endif</span>
00910 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00911     }
00912 
00913     <span class="keywordflow">if</span> (!pVdmObjects-&gt;VdmIoListHead) {
00914         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00915     }
00916 
00917 
00918     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00919     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00920 
00921     p = <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a6">Psp386GetVdmIoHandler</a>(
00922         Process,
00923         PortNumber
00924         );
00925 
00926     <span class="keywordflow">if</span> (p) {
00927         *VdmIoHandler = *p;
00928         *Context = pVdmObjects-&gt;VdmIoListHead-&gt;Context;
00929         Success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00930     } <span class="keywordflow">else</span> {
00931         Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00932     }
00933     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoResource);
00934     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00935 
00936     <span class="keywordflow">return</span> Success;
00937 }
00938 
00939 
00940 PVDM_IO_HANDLER
<a name="l00941"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a6">00941</a> <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a6">Psp386GetVdmIoHandler</a>(
00942     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00943     IN ULONG PortNumber
00944     )
00945 <span class="comment">/*++</span>
00946 <span class="comment"></span>
00947 <span class="comment">Routine Description:</span>
00948 <span class="comment"></span>
00949 <span class="comment">    This routine finds the VdmIoHandler block for the specified port.</span>
00950 <span class="comment"></span>
00951 <span class="comment">Arguments:</span>
00952 <span class="comment"></span>
00953 <span class="comment">    Process -- Supplies a pointer to the process</span>
00954 <span class="comment">    PortNumber -- Supplies the port number</span>
00955 <span class="comment"></span>
00956 <span class="comment">Returns:</span>
00957 <span class="comment"></span>
00958 <span class="comment">    NULL  if no handler found</span>
00959 <span class="comment">    non-NULL if handler found</span>
00960 <span class="comment"></span>
00961 <span class="comment">--*/</span>
00962 {
00963     PVDM_PROCESS_OBJECTS pVdmObjects = Process-&gt;VdmObjects;
00964     PVDM_IO_HANDLER p;
00965     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00966 
00967     <span class="keywordflow">if</span> (PortNumber % 4) {
00968 <span class="preprocessor">#if DBG</span>
00969 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
00970             <span class="stringliteral">"Ps386GetVdmIoHandler : Invalid Port Number %lx\n"</span>,
00971             PortNumber
00972             );
00973 <span class="preprocessor">#endif</span>
00974 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00975     }
00976 
00977     p = pVdmObjects-&gt;VdmIoListHead-&gt;VdmIoHandlerList;
00978     <span class="keywordflow">while</span> ((p) &amp;&amp; (p-&gt;PortNumber != PortNumber)) {
00979         p = p-&gt;Next;
00980     }
00981 
00982     <span class="keywordflow">return</span> p;
00983 
00984 }
00985 
00986 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00987"></a><a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a11">00987</a> <a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a11">PspVdmInitialize</a>(
00988     )
00989 
00990 <span class="comment">/*++</span>
00991 <span class="comment"></span>
00992 <span class="comment">Routine Description:</span>
00993 <span class="comment"></span>
00994 <span class="comment">    This routine initializes the process based Vdm support for x86.</span>
00995 <span class="comment"></span>
00996 <span class="comment">Arguments:</span>
00997 <span class="comment"></span>
00998 <span class="comment">    None</span>
00999 <span class="comment"></span>
01000 <span class="comment">Return Value:</span>
01001 <span class="comment"></span>
01002 <span class="comment">    TBS</span>
01003 <span class="comment">--*/</span>
01004 {
01005     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;<a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a2">VdmIoListCreationResource</a>);
01006 }
01007 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
