<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mnchange.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mnchange.c</h1><a href="../../d3/d2/mnchange_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: mnchange.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Change Menu Routine</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-10-90 JimA       Cleanup.</span>
00010 <span class="comment">* 03-18-91 IanJa      Window revalidation added (none required)</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/*</span>
00017 <span class="comment"> * Allocation/deallocation increments.  Make them</span>
00018 <span class="comment"> * different to avoid possible thrashing when an item</span>
00019 <span class="comment"> * is repeatedly added and removed.</span>
00020 <span class="comment"> */</span>
<a name="l00021"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a0">00021</a> <span class="preprocessor">#define CMENUITEMALLOC 8</span>
<a name="l00022"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a1">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define CMENUITEMDEALLOC 10</span>
00023 <span class="preprocessor"></span>
00024 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d2/mnchange_8c.html#a4">xxxSetLPITEMInfo</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem, LPMENUITEMINFOW lpmii, PUNICODE_STRING pstr);
<a name="l00025"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a3">00025</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (*<a class="code" href="../../d3/d2/mnchange_8c.html#a3">MENUAPIFN</a>)(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>, <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>, <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>, LPMENUITEMINFOW);
00026 
00027 
00028 <span class="preprocessor">#if DBG</span>
00029 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> RelocateMenuLockRecords(
00030     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem,
00031     <span class="keywordtype">int</span> cItem,
00032     LONG_PTR cbMove)
00033 {
00034     <span class="keywordflow">while</span> (cItem &gt; 0) {
00035         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00036             HMRelocateLockRecord(&amp;(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>), cbMove);
00037         }
00038         pItem++;
00039         cItem--;
00040     }
00041 }
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 <span class="comment">/***************************************************************************\</span>
00045 <span class="comment">* UnlockSubMenu</span>
00046 <span class="comment">*</span>
00047 <span class="comment">* Unlocks the pSubMenu and removes the MENULIST element corresponding to pMenu</span>
00048 <span class="comment">*</span>
00049 <span class="comment">* History:</span>
00050 <span class="comment">*  Nov-20-98    MCostea</span>
00051 <span class="comment">\***************************************************************************/</span>
<a name="l00052"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a5">00052</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d3/d2/mnchange_8c.html#a5">UnlockSubMenu</a>(
00053     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00054     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>* ppSubMenu)
00055 {
00056     <a class="code" href="../../d3/d1/structtagMENULIST.html">PMENULIST</a>* pp;
00057     <a class="code" href="../../d3/d1/structtagMENULIST.html">PMENULIST</a> pMLFound;
00058 
00059     <span class="keywordflow">if</span> (*ppSubMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00060         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00061     }
00062     <span class="comment">/*</span>
00063 <span class="comment">     * Remove the item from pMenu's pParentsList</span>
00064 <span class="comment">     */</span>
00065     <span class="keywordflow">for</span> (pp = &amp;(*ppSubMenu)-&gt;pParentMenus; *pp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pp = &amp;(*pp)-&gt;<a class="code" href="../../d3/d1/structtagMENULIST.html#o0">pNext</a>) {
00066         <span class="keywordflow">if</span> ((*pp)-&gt;pMenu == pMenu) {
00067             pMLFound = *pp;
00068             *pp = (*pp)-&gt;<a class="code" href="../../d3/d1/structtagMENULIST.html#o0">pNext</a>;
00069             <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk, pMLFound);
00070             <span class="keywordflow">break</span>;
00071         }
00072     }
00073     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(ppSubMenu);
00074 }
00075 
<a name="l00076"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a2">00076</a> <span class="preprocessor">#define NESTED_MENU_LIMIT 25</span>
00077 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
00078 <span class="comment">* GetMenuDepth</span>
00079 <span class="comment">*</span>
00080 <span class="comment">* Returns the menu depth (how many nested submenus this menu has).</span>
00081 <span class="comment">* This helps catch loops in the menu hierarchy or deep evil apps.</span>
00082 <span class="comment">*</span>
00083 <span class="comment">* History:</span>
00084 <span class="comment">*  Sept-22-98    MCostea</span>
00085 <span class="comment">\***************************************************************************/</span>
<a name="l00086"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a6">00086</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d3/d2/mnchange_8c.html#a6">GetMenuDepth</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, UINT uMaxAllowedDepth)
00087 {
00088     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uItems, uMaxDepth = 0, uSubMenuDepth;
00089     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00090 
00091     <span class="comment">/*</span>
00092 <span class="comment">     * This will prevent us from getting trapped in loops</span>
00093 <span class="comment">     */</span>
00094     <span class="keywordflow">if</span> (uMaxAllowedDepth == 0) {
00095         <span class="keywordflow">return</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a2">NESTED_MENU_LIMIT</a>;
00096     }
00097     pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>;
00098     <span class="keywordflow">for</span> (uItems = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; uItems--; pItem++) {
00099         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00100             uSubMenuDepth = <a class="code" href="../../d3/d2/mnchange_8c.html#a6">GetMenuDepth</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, uMaxAllowedDepth-1);
00101             <span class="keywordflow">if</span> (uSubMenuDepth &gt; uMaxDepth) {
00102                 <span class="comment">/*</span>
00103 <span class="comment">                 * Don't walk the other submenus if a deep branch was found</span>
00104 <span class="comment">                 */</span>
00105                 <span class="keywordflow">if</span> (uSubMenuDepth &gt;= <a class="code" href="../../d3/d2/mnchange_8c.html#a2">NESTED_MENU_LIMIT</a>) {
00106                     <span class="keywordflow">return</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a2">NESTED_MENU_LIMIT</a>;
00107                 }
00108                 uMaxDepth = uSubMenuDepth;
00109             }
00110         }
00111     }
00112     <span class="keywordflow">return</span> uMaxDepth + 1;
00113 }
00114 
00115 <span class="comment">/***************************************************************************\</span>
00116 <span class="comment">* GetMenuAncestors</span>
00117 <span class="comment">*</span>
00118 <span class="comment">* Returns the maximum number of levels above pMenu in the menu hierarchy.</span>
00119 <span class="comment">* Walking the "parent" tree should not be expensive as it is pretty unusual</span>
00120 <span class="comment">* for menus to appear in different places in the hierarchy.  The tree is</span>
00121 <span class="comment">* usualy a simple linked list.</span>
00122 <span class="comment">*</span>
00123 <span class="comment">* History:</span>
00124 <span class="comment">*  Nov-10-98    MCostea</span>
00125 <span class="comment">\***************************************************************************/</span>
<a name="l00126"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a7">00126</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d3/d2/mnchange_8c.html#a7">GetMenuAncestors</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu)
00127 {
00128     <a class="code" href="../../d3/d1/structtagMENULIST.html">PMENULIST</a> pParentMenu;
00129     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> uParentAncestors;
00130     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> retVal = 0;
00131 
00132     <span class="keywordflow">for</span> (pParentMenu = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o18">pParentMenus</a>; pParentMenu; pParentMenu = pParentMenu-&gt;<a class="code" href="../../d3/d1/structtagMENULIST.html#o0">pNext</a>) {
00133         uParentAncestors = <a class="code" href="../../d3/d2/mnchange_8c.html#a7">GetMenuAncestors</a>(pParentMenu-&gt;<a class="code" href="../../d3/d1/structtagMENULIST.html#o1">pMenu</a>);
00134         <span class="keywordflow">if</span> (uParentAncestors &gt; retVal) {
00135             retVal = uParentAncestors;
00136         }
00137     }
00138     <span class="keywordflow">return</span> retVal+1;
00139 }
00140 
00141 <span class="comment">/**********************************************</span>
00142 <span class="comment">*   Global Insert/Append/Set client/server interface</span>
00143 <span class="comment">*</span>
00144 <span class="comment">*   01-13-94  FritzS  Created</span>
00145 <span class="comment">***********************************************/</span>
<a name="l00146"></a><a class="code" href="../../d4/d1/userk_8h.html#a1590">00146</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1590">xxxSetMenuItemInfo</a>(
00147     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00148     UINT wIndex,
00149     BOOL fByPosition,
00150     LPMENUITEMINFOW lpmii,
00151     PUNICODE_STRING pstrItem)
00152 {
00153 
00154     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00155 
00156     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00157 
00158     pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, wIndex, fByPosition,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00159     <span class="keywordflow">if</span> (pItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00160         <span class="comment">/*</span>
00161 <span class="comment">         * Word doesn't like not finding SC_TASKLIST -- so it that's what</span>
00162 <span class="comment">         * they're looking for, let's pretend we changed it.</span>
00163 <span class="comment">         */</span>
00164         <span class="keywordflow">if</span> (!fByPosition &amp;&amp; (wIndex == SC_TASKLIST))
00165             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00166 
00167         <span class="comment">/*</span>
00168 <span class="comment">         * Item not found.  Return false.</span>
00169 <span class="comment">         */</span>
00170         RIPERR0(ERROR_MENU_ITEM_NOT_FOUND, RIP_WARNING, <span class="stringliteral">"ModifyMenu: Menu item not found"</span>);
00171         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00172     }
00173     <span class="comment">/*</span>
00174 <span class="comment">     * we need to treat MFT_RIGHTORDER separately as this is propogated down</span>
00175 <span class="comment">     * to the entire menu not just to this item so that we stay in ssync. This</span>
00176 <span class="comment">     * is pretty similar to the use of MFT_RIGHTJUST, we actually do the</span>
00177 <span class="comment">     * propogation because we need the flag in all sorts of places, not just</span>
00178 <span class="comment">     * in MBC_RightJustifyMenu()</span>
00179 <span class="comment">     */</span>
00180 
00181     <span class="comment">/*</span>
00182 <span class="comment">     * See ValidateMENUITEMINFO in client\clmenu.c will add more flags to fMask if it use to be MIIM_TYPE</span>
00183 <span class="comment">     * Then fMask will not be any more == MIIM_TYPE.</span>
00184 <span class="comment">     */</span>
00185 
00186     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_TYPE) {
00187         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRtoL = (lpmii-&gt;fType &amp; MFT_RIGHTORDER) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00188 
00189         <span class="keywordflow">if</span> (bRtoL || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>)) {
00190             <a class="code" href="../../d4/d1/userk_8h.html#a1405">MakeMenuRtoL</a>(pMenu, bRtoL);
00191         }
00192     }
00193     <span class="keywordflow">return</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a4">xxxSetLPITEMInfo</a>(pMenu, pItem, lpmii, pstrItem);
00194 }
00195 
00196 <span class="comment">/***************************************************************************\</span>
00197 <span class="comment">* xxxSetMenuInfo (API)</span>
00198 <span class="comment">*</span>
00199 <span class="comment">*</span>
00200 <span class="comment">* History:</span>
00201 <span class="comment">* 12-Feb-1996 JudeJ     Ported from Memphis</span>
00202 <span class="comment">* 23-Jun-1996 GerardoB  Fixed up for 5.0</span>
00203 <span class="comment">\***************************************************************************/</span>
<a name="l00204"></a><a class="code" href="../../d4/d1/userk_8h.html#a1596">00204</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1596">xxxSetMenuInfo</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, LPCMENUINFO lpmi)
00205 {
00206     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>  ppopup;
00207     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fRecompute = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00208     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fRedraw    = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00209     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        uFlags     = <a class="code" href="../../d4/d1/userk_8h.html#a530">MNUS_DEFAULT</a>;
00210     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>       pItem;
00211     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        uItems;
00212     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlSubMenu;
00213 
00214     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00215 
00216     <span class="keywordflow">if</span> (lpmi-&gt;fMask &amp; MIM_STYLE) {
00217         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o1">fFlags</a> ^= (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o1">fFlags</a> ^ lpmi-&gt;dwStyle) &amp; MNS_VALID;
00218         fRecompute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00219     }
00220 
00221     <span class="keywordflow">if</span> (lpmi-&gt;fMask &amp; MIM_MAXHEIGHT) {
00222         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o11">cyMax</a> = lpmi-&gt;cyMax;
00223         fRecompute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00224     }
00225 
00226     <span class="keywordflow">if</span> (lpmi-&gt;fMask &amp; MIM_BACKGROUND) {
00227         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o13">hbrBack</a> = lpmi-&gt;hbrBack;
00228         fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00229         <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a759">MSA_OFF</a>) {
00230             uFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a532">MNUS_DRAWFRAME</a>;
00231         }
00232     }
00233 
00234     <span class="keywordflow">if</span> (lpmi-&gt;fMask &amp; MIM_HELPID) {
00235         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o10">dwContextHelpId</a> = lpmi-&gt;dwContextHelpID;
00236     }
00237 
00238     <span class="keywordflow">if</span> (lpmi-&gt;fMask &amp; MIM_MENUDATA) {
00239         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o12">dwMenuData</a> = lpmi-&gt;dwMenuData;
00240     }
00241 
00242     <span class="comment">/*</span>
00243 <span class="comment">     * Do we need to set this for all submenus?</span>
00244 <span class="comment">     */</span>
00245     <span class="keywordflow">if</span> (lpmi-&gt;fMask &amp; MIM_APPLYTOSUBMENUS) {
00246         pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>;
00247         <span class="keywordflow">for</span> (uItems = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; uItems--; pItem++) {
00248             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00249                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, &amp;tlSubMenu);
00250                 <a class="code" href="../../d4/d1/userk_8h.html#a1596">xxxSetMenuInfo</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, lpmi);
00251                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlSubMenu);
00252             }
00253         }
00254     }
00255 
00256 
00257     <span class="keywordflow">if</span> (fRecompute) {
00258         <span class="comment">// Set the size of this menu to be 0 so that it gets recomputed with this</span>
00259         <span class="comment">// new item...</span>
00260         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a> = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> = 0;
00261     }
00262 
00263     <span class="keywordflow">if</span> (fRecompute || fRedraw) {
00264         <span class="keywordflow">if</span> (ppopup = <a class="code" href="../../d4/d1/userk_8h.html#a1602">MNGetPopupFromMenu</a>(pMenu, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00265             <span class="comment">// this menu is currently being displayed -- redisplay the menu,</span>
00266             <span class="comment">// recomputing if necessary</span>
00267             <a class="code" href="../../d4/d1/userk_8h.html#a1336">xxxMNUpdateShownMenu</a>(ppopup, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, uFlags);
00268         }
00269     }
00270 
00271     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00272 }
00273 <span class="comment">/***************************************************************************\</span>
00274 <span class="comment">* MNDeleteAdjustIndex</span>
00275 <span class="comment">*</span>
00276 <span class="comment">* History:</span>
00277 <span class="comment">* 11/19/96 GerardoB  Created</span>
00278 <span class="comment">\***************************************************************************/</span>
<a name="l00279"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a10">00279</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a10">NNDeleteAdjustIndex</a> (UINT * puAdjustIndex, UINT uDelIndex)
00280 {
00281     <span class="keywordflow">if</span> (*puAdjustIndex == uDelIndex) {
00282         *puAdjustIndex = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
00283     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)*puAdjustIndex &gt; (<span class="keywordtype">int</span>)uDelIndex) {
00284         (*puAdjustIndex)--;
00285     }
00286 }
00287 <span class="comment">/***************************************************************************\</span>
00288 <span class="comment">* MNDeleteAdjustIndexes</span>
00289 <span class="comment">*</span>
00290 <span class="comment">* This function is called when an item on an active menu is about</span>
00291 <span class="comment">*  to be deleted. It makes sure that other indexes like posSelectedItem,</span>
00292 <span class="comment">*  uButtonDownIndex and uDraggingIndex are adjusted to reflect the change</span>
00293 <span class="comment">* It "clears" the index if it is AT the point of deletion or</span>
00294 <span class="comment">*  decrements it if it is after the point of deletion</span>
00295 <span class="comment">*</span>
00296 <span class="comment">* History:</span>
00297 <span class="comment">* 01/16/97 GerardoB  Created</span>
00298 <span class="comment">\***************************************************************************/</span>
<a name="l00299"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a11">00299</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a11">MNDeleteAdjustIndexes</a> (<a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup, UINT uiPos)
00300 {
00301     <span class="comment">/*</span>
00302 <span class="comment">     * Adjust the index of the selected item and the dropped popup, if needed.</span>
00303 <span class="comment">     */</span>
00304     <a class="code" href="../../d3/d2/mnchange_8c.html#a10">NNDeleteAdjustIndex</a>(&amp;ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>, uiPos);
00305     <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a>) {
00306         <a class="code" href="../../d3/d2/mnchange_8c.html#a10">NNDeleteAdjustIndex</a>(&amp;ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a>, uiPos);
00307     }
00308 
00309     <span class="comment">/*</span>
00310 <span class="comment">     * Adjust uButtonDownIndex and uDraggingIndex if needed</span>
00311 <span class="comment">     */</span>
00312     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a> == (ULONG_PTR)ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>) {
00313         <a class="code" href="../../d3/d2/mnchange_8c.html#a10">NNDeleteAdjustIndex</a>(&amp;pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o29">uButtonDownIndex</a>, uiPos);
00314     }
00315     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o31">uDraggingHitArea</a> == (ULONG_PTR)ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>) {
00316         <a class="code" href="../../d3/d2/mnchange_8c.html#a10">NNDeleteAdjustIndex</a>(&amp;pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o32">uDraggingIndex</a>, uiPos);
00317     }
00318 }
00319 <span class="comment">/***************************************************************************\</span>
00320 <span class="comment">* xxxInsertMenuItem</span>
00321 <span class="comment">*</span>
00322 <span class="comment">\***************************************************************************/</span>
<a name="l00323"></a><a class="code" href="../../d4/d1/userk_8h.html#a1593">00323</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1593">xxxInsertMenuItem</a>(
00324     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00325     UINT wIndex,
00326     BOOL fByPosition,
00327     LPMENUITEMINFOW lpmii,
00328     PUNICODE_STRING pstrItem)
00329 {
00330     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00331     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>           pItem;
00332     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>           pMenuItemIsOn;
00333     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a>      pMenuState;
00334     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>           pNewItems;
00335     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>      ppopup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00336     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlMenu;
00337     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>            uiPos;
00338 
00339     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00340 
00341 <span class="comment">// Find out where the item we are inserting should go.</span>
00342     <span class="keywordflow">if</span> (wIndex != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
00343         pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, wIndex, fByPosition, &amp;pMenuItemIsOn);
00344 
00345         <span class="keywordflow">if</span> (pItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00346             pMenu = pMenuItemIsOn;
00347         } <span class="keywordflow">else</span> {
00348             wIndex = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
00349         }
00350     } <span class="keywordflow">else</span> {
00351         pItem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00352     }
00353     <span class="comment">/*</span>
00354 <span class="comment">     * keep normal menu items between the MDI system bitmap items</span>
00355 <span class="comment">     */</span>
00356     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>)
00357             &amp;&amp; (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> != 0)
00358             &amp;&amp; (!(lpmii-&gt;fMask &amp; MIIM_BITMAP)
00359                 || (lpmii-&gt;hbmpItem &gt; HBMMENU_MBARLAST)
00360                 || (lpmii-&gt;hbmpItem == 0)
00361                     )) {
00362 
00363         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wSave, w;
00364         <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItemWalk;
00365         wSave = w = wIndex;
00366 
00367         <span class="keywordflow">if</span> (pItem &amp;&amp; !fByPosition) {
00368             w = <a class="code" href="../../d4/d1/userk_8h.html#a550">MNGetpItemIndex</a>(pMenu, pItem);
00369             w = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pItem - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d9/structtagITEM.html">ITEM</a>);
00370         }
00371 
00372         <span class="keywordflow">if</span> (!w) {
00373             pItemWalk = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>;
00374             <span class="keywordflow">if</span> ((pItemWalk-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> == HBMMENU_SYSTEM)) {
00375                 wIndex = 1;
00376             }
00377         } <span class="keywordflow">else</span> {
00378             <span class="keywordflow">if</span> (w == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
00379                 w = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>;
00380             }
00381 
00382             w--;
00383             pItemWalk = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + w;
00384             <span class="keywordflow">while</span> (w &amp;&amp; (pItemWalk-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a>) &amp;&amp; (pItemWalk-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> &lt; HBMMENU_MBARLAST)) {
00385                 wIndex = w--;
00386                 pItemWalk--;
00387             }
00388         }
00389 
00390         <span class="keywordflow">if</span> (wIndex != wSave) {
00391             pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + wIndex;
00392         }
00393     }
00394 
00395     <span class="comment">// LATER -- we currently realloc every 10 items.  investigate the</span>
00396     <span class="comment">// performance hit/gain we get from this and adjust accordingly.</span>
00397     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> &gt;= pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o3">cAlloced</a>) {
00398         <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>) {
00399             pNewItems = (<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk,
00400                     (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o3">cAlloced</a> + <a class="code" href="../../d3/d2/mnchange_8c.html#a0">CMENUITEMALLOC</a>) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d9/structtagITEM.html">ITEM</a>),
00401                                             <a class="code" href="../../d4/d1/userk_8h.html#a308">DTAG_MENUITEM</a>);
00402             <span class="keywordflow">if</span> (pNewItems) {
00403                 RtlCopyMemory(pNewItems, pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>,
00404                         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o3">cAlloced</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1074">ITEM</a>));
00405 <span class="preprocessor">#if DEBUGTAGS</span>
00406 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
00407                     RelocateMenuLockRecords(pNewItems, pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>,
00408                         ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pNewItems) - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>));
00409                 }
00410 <span class="preprocessor">#endif</span>
00411 <span class="preprocessor"></span>                <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk, pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>);
00412             }
00413         } <span class="keywordflow">else</span> {
00414             pNewItems = (<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk,
00415                     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d9/structtagITEM.html">ITEM</a>) * <a class="code" href="../../d3/d2/mnchange_8c.html#a0">CMENUITEMALLOC</a>, <a class="code" href="../../d4/d1/userk_8h.html#a308">DTAG_MENUITEM</a>);
00416         }
00417 
00418         <span class="keywordflow">if</span> (pNewItems == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00419             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00420 
00421         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o3">cAlloced</a> += <a class="code" href="../../d3/d2/mnchange_8c.html#a0">CMENUITEMALLOC</a>;
00422         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> = pNewItems;
00423 
00424         <span class="comment">/*</span>
00425 <span class="comment">         * Now look up the item again since it probably moved when we realloced the</span>
00426 <span class="comment">         * memory.</span>
00427 <span class="comment">         */</span>
00428         <span class="keywordflow">if</span> (wIndex != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>)
00429             pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, wIndex, fByPosition, &amp;pMenuItemIsOn);
00430 
00431     }
00432 
00433 
00434     <span class="comment">/*</span>
00435 <span class="comment">     * If this menu is being displayed right now and we're not appending</span>
00436 <span class="comment">     *  an item, then we need to adjust the positions we keep track of.</span>
00437 <span class="comment">     * We want to do this before moving the items to accomodate the</span>
00438 <span class="comment">     *  new one, in case we need to clear the insertion bar</span>
00439 <span class="comment">     */</span>
00440     <span class="keywordflow">if</span> ((pItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00441         &amp;&amp; (ppopup = <a class="code" href="../../d4/d1/userk_8h.html#a1602">MNGetPopupFromMenu</a>(pMenu, &amp;pMenuState))) {
00442         <span class="comment">/*</span>
00443 <span class="comment">         * This menu is active. Adjust the index the selected</span>
00444 <span class="comment">         *  item and the dropped popup, if needed</span>
00445 <span class="comment">         */</span>
00446         uiPos = <a class="code" href="../../d4/d1/userk_8h.html#a550">MNGetpItemIndex</a>(pMenu, pItem);
00447         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a> &gt;= (<span class="keywordtype">int</span>)uiPos) {
00448             ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>++;
00449         }
00450         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o5">fHierarchyDropped</a> &amp;&amp; (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a> &gt;= (<span class="keywordtype">int</span>)uiPos)) {
00451             ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o35">posDropped</a>++;
00452         }
00453 
00454         <span class="comment">/*</span>
00455 <span class="comment">         * Adjust uButtonDownIndex and uDraggingIndex if needed</span>
00456 <span class="comment">         */</span>
00457         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a> == (ULONG_PTR)ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>) {
00458             <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o29">uButtonDownIndex</a> &gt;= (<span class="keywordtype">int</span>)uiPos) {
00459                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o29">uButtonDownIndex</a>++;
00460             }
00461         }
00462         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o31">uDraggingHitArea</a> == (ULONG_PTR)ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>) {
00463             <span class="comment">/*</span>
00464 <span class="comment">             * Check to see if an item is inserted right on the insertion</span>
00465 <span class="comment">             *  bar. If so, clean up any present insertion bar state</span>
00466 <span class="comment">             */</span>
00467             <span class="keywordflow">if</span> (((<span class="keywordtype">int</span>)pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o32">uDraggingIndex</a> == (<span class="keywordtype">int</span>)uiPos)
00468                     &amp;&amp; (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o33">uDraggingFlags</a> &amp; MNGOF_TOPGAP)) {
00469 
00470                 <a class="code" href="../../d4/d1/userk_8h.html#a1416">xxxMNSetGapState</a>(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o31">uDraggingHitArea</a>,
00471                               pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o32">uDraggingIndex</a>,
00472                               pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o33">uDraggingFlags</a>,
00473                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00474             }
00475 
00476             <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o32">uDraggingIndex</a> &gt;= (<span class="keywordtype">int</span>)uiPos) {
00477                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o32">uDraggingIndex</a>++;
00478             }
00479         }
00480     }
00481 
00482     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>++;
00483     <span class="keywordflow">if</span> (pItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00484         <span class="comment">// Move this item up to make room for the one we want to insert.</span>
00485         RtlMoveMemory(pItem + 1, pItem, (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1) *
00486                 <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d9/structtagITEM.html">ITEM</a>) - ((<span class="keywordtype">char</span> *)pItem - (<span class="keywordtype">char</span> *)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>));
00487 <span class="preprocessor">#if DEBUGTAGS</span>
00488 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
00489             RelocateMenuLockRecords(pItem + 1,
00490                     (<span class="keywordtype">int</span>)(&amp;(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>]) - (pItem + 1)),
00491                     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1074">ITEM</a>));
00492         }
00493 <span class="preprocessor">#endif</span>
00494 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00495 
00496         <span class="comment">// If lpItem is null, we will be inserting the item at the end of the</span>
00497         <span class="comment">// menu.</span>
00498         pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1;
00499     }
00500 
00501     <span class="comment">// Need to zero these fields in case we are inserting this item in the</span>
00502     <span class="comment">// middle of the item list.</span>
00503     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a>           = 0;
00504     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a>          = 0;
00505     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o2">wID</a>             = 0;
00506     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00507     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o4">hbmpChecked</a>     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00508     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o5">hbmpUnchecked</a>   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00509     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o7">cch</a>             = 0;
00510     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o8">dwItemData</a>      = 0;
00511     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a>           = 0;
00512     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>           = 0;
00513     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>          = 0;
00514     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>          = 0;
00515     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a>            = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00516     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a>           = <a class="code" href="../../d4/d1/userk_8h.html#a533">MNIS_MEASUREBMP</a>;
00517     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a>           = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00518 
00519     <span class="comment">/*</span>
00520 <span class="comment">     * We might have reassigned pMenu above, so lock it</span>
00521 <span class="comment">     */</span>
00522     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pMenu, &amp;tlMenu);
00523     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d2/mnchange_8c.html#a4">xxxSetLPITEMInfo</a>(pMenu, pItem, lpmii, pstrItem)) {
00524 
00525         <span class="comment">/*</span>
00526 <span class="comment">         * Reset any of the indexes we might have adjusted above</span>
00527 <span class="comment">         */</span>
00528         <span class="keywordflow">if</span> (ppopup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00529             <a class="code" href="../../d3/d2/mnchange_8c.html#a11">MNDeleteAdjustIndexes</a>(pMenuState, ppopup, uiPos);
00530         }
00531 
00532         <a class="code" href="../../d4/d1/userk_8h.html#a1385">MNFreeItem</a>(pMenu, pItem, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00533 
00534 
00535         <span class="comment">// Move things up since we removed/deleted the item</span>
00536         RtlMoveMemory(pItem, pItem + 1, pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> * (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d9/structtagITEM.html">ITEM</a>) +
00537             (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<span class="keywordtype">char</span> *)&amp;pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[0] - (<span class="keywordtype">char</span> *)(pItem + 1)));
00538 <span class="preprocessor">#if DEBUGTAGS</span>
00539 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
00540             RelocateMenuLockRecords(pItem,
00541                     (<span class="keywordtype">int</span>)(&amp;(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1]) - pItem),
00542                     -(<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1074">ITEM</a>));
00543         }
00544 <span class="preprocessor">#endif</span>
00545 <span class="preprocessor"></span>        pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>--;
00546         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00547     } <span class="keywordflow">else</span> {
00548        <span class="comment">/*</span>
00549 <span class="comment">        * Like MFT_RIGHTJUSTIFY, this staggers down the menu,</span>
00550 <span class="comment">        *    (but we inherit, to make localisation etc MUCH easier).</span>
00551 <span class="comment">        *</span>
00552 <span class="comment">        * MFT_RIGHTORDER is the same value as MFT_SYSMENU.  We distinguish</span>
00553 <span class="comment">        * between the two by also looking for MFT_BITMAP.</span>
00554 <span class="comment">        */</span>
00555         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>) ||
00556             (pItem &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_RIGHTORDER) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_BITMAP))) {
00557             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a> |= (MFT_RIGHTORDER | MFT_RIGHTJUSTIFY);
00558             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>) {
00559                 <a class="code" href="../../d4/d1/userk_8h.html#a1405">MakeMenuRtoL</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00560             }
00561         }
00562     }
00563 
00564     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlMenu);
00565     <span class="keywordflow">return</span> fRet;
00566 
00567 }
00568 
00569 <span class="comment">/***************************************************************************\</span>
00570 <span class="comment">* FreeItemBitmap</span>
00571 <span class="comment">*</span>
00572 <span class="comment">* History:</span>
00573 <span class="comment">*  07-23-96 GerardoB - Added header and Fixed up for 5.0</span>
00574 <span class="comment">\***************************************************************************/</span>
<a name="l00575"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a13">00575</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a13">FreeItemBitmap</a>(<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem)
00576 {
00577     <span class="comment">// Free up hItem unless it's a bitmap handle or nonexistent.</span>
00578     <span class="comment">// Apps are responsible for freeing their bitmaps.</span>
00579      <span class="keywordflow">if</span> ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem, MFS_CACHEDBMP)) {
00580             <span class="comment">/*</span>
00581 <span class="comment">             * Assign ownership of the bitmap to the process that is</span>
00582 <span class="comment">             * destroying the menu to ensure that bitmap will</span>
00583 <span class="comment">             * eventually be destroyed.</span>
00584 <span class="comment">             */</span>
00585         GreSetBitmapOwner((HBITMAP)(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a>), OBJECT_OWNER_CURRENT);
00586     }
00587 
00588     <span class="comment">// Zap this pointer in case we try to free or reference it again</span>
00589     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a>  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00590 }
00591 <span class="comment">/***************************************************************************\</span>
00592 <span class="comment">* FreeItemString</span>
00593 <span class="comment">*</span>
00594 <span class="comment">* History:</span>
00595 <span class="comment">*  07-23-96 GerardoB - Added header and Fixed up for 5.0</span>
00596 <span class="comment">\***************************************************************************/</span>
00597 
<a name="l00598"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a14">00598</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a14">FreeItemString</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem)
00599 {
00600     <span class="comment">// Free up Item's string</span>
00601     <span class="keywordflow">if</span> ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00602         <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a>);
00603     }
00604     <span class="comment">// Zap this pointer in case we try to free or reference it again</span>
00605     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a>  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00606 }
00607 
00608 <span class="comment">/***************************************************************************\</span>
00609 <span class="comment">* FreeItem</span>
00610 <span class="comment">*</span>
00611 <span class="comment">* Free a menu item and its associated resources.</span>
00612 <span class="comment">*</span>
00613 <span class="comment">* History:</span>
00614 <span class="comment">* 10-11-90 JimA       Translated from ASM</span>
00615 <span class="comment">\***************************************************************************/</span>
00616 
<a name="l00617"></a><a class="code" href="../../d4/d1/userk_8h.html#a1385">00617</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1385">MNFreeItem</a>(
00618     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00619     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem,
00620     BOOL fFreeItemPopup)
00621 {
00622     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pSubMenu;
00623 
00624     <a class="code" href="../../d3/d2/mnchange_8c.html#a13">FreeItemBitmap</a>(pItem);
00625     <a class="code" href="../../d3/d2/mnchange_8c.html#a14">FreeItemString</a>(pMenu, pItem);
00626 
00627     pSubMenu = <a class="code" href="../../d3/d2/mnchange_8c.html#a5">UnlockSubMenu</a>(pMenu, &amp;(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>));
00628     <span class="keywordflow">if</span> (pSubMenu) {
00629         <span class="keywordflow">if</span> (fFreeItemPopup) {
00630             <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pSubMenu);
00631         }
00632     }
00633 }
00634 <span class="comment">/***************************************************************************\</span>
00635 <span class="comment">* RemoveDeleteMenuHelper</span>
00636 <span class="comment">*</span>
00637 <span class="comment">* This removes the menu item from the given menu.  If</span>
00638 <span class="comment">* fDeleteMenuItem, the memory associted with the popup menu associated with</span>
00639 <span class="comment">* the item being removed is freed and recovered.</span>
00640 <span class="comment">*</span>
00641 <span class="comment">* History:</span>
00642 <span class="comment">\***************************************************************************/</span>
00643 
<a name="l00644"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a16">00644</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d2/mnchange_8c.html#a16">xxxRemoveDeleteMenuHelper</a>(
00645     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00646     UINT nPosition,
00647     DWORD wFlags,
00648     BOOL fDeleteMenu)
00649 {
00650     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
00651     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pNewItems;
00652     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>  pMenuSave;
00653     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
00654     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup;
00655     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>       uiPos;
00656 
00657     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00658 
00659     pMenuSave = pMenu;
00660 
00661     pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, nPosition, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) (wFlags &amp; MF_BYPOSITION), &amp;pMenu);
00662     <span class="keywordflow">if</span> (pItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00663 
00664         <span class="comment">/*</span>
00665 <span class="comment">         * Hack for apps written for Win95. In Win95 the prototype for</span>
00666 <span class="comment">         * this function was with 'WORD nPosition' and because of this</span>
00667 <span class="comment">         * the HIWORD(nPosition) got set to 0.</span>
00668 <span class="comment">         * We are doing this just for system menu commands.</span>
00669 <span class="comment">         */</span>
00670         <span class="keywordflow">if</span> (nPosition &gt;= 0xFFFFF000 &amp;&amp; !(wFlags &amp; MF_BYPOSITION)) {
00671             nPosition &amp;= 0x0000FFFF;
00672             pMenu = pMenuSave;
00673             pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, nPosition, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pMenu);
00674 
00675             <span class="keywordflow">if</span> (pItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00676                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00677         } <span class="keywordflow">else</span>
00678             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00679     }
00680 
00681     <span class="keywordflow">if</span> (ppopup = <a class="code" href="../../d4/d1/userk_8h.html#a1602">MNGetPopupFromMenu</a>(pMenu, &amp;pMenuState)) {
00682         <span class="comment">/*</span>
00683 <span class="comment">         * This menu is active; since we're about to insert an item,</span>
00684 <span class="comment">         *  make sure that any of the positions we've stored are</span>
00685 <span class="comment">         *  adjusted properly</span>
00686 <span class="comment">         */</span>
00687         uiPos = <a class="code" href="../../d4/d1/userk_8h.html#a550">MNGetpItemIndex</a>(pMenu, pItem);
00688         <a class="code" href="../../d3/d2/mnchange_8c.html#a11">MNDeleteAdjustIndexes</a>(pMenuState, ppopup, uiPos);
00689     }
00690     <a class="code" href="../../d4/d1/userk_8h.html#a1385">MNFreeItem</a>(pMenu, pItem, fDeleteMenu);
00691 
00692     <span class="comment">/*</span>
00693 <span class="comment">     * Reset the menu size so that it gets recomputed next time.</span>
00694 <span class="comment">     */</span>
00695     pMenu-&gt;cyMenu = pMenu-&gt;cxMenu = 0;
00696 
00697     <span class="keywordflow">if</span> (pMenu-&gt;cItems == 1) {
00698         <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pMenu-&gt;head.rpdesk, pMenu-&gt;rgItems);
00699         pMenu-&gt;cAlloced = 0;
00700         pNewItems = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00701     } <span class="keywordflow">else</span> {
00702 
00703         <span class="comment">/*</span>
00704 <span class="comment">         * Move things up since we removed/deleted the item</span>
00705 <span class="comment">         */</span>
00706 
00707         RtlMoveMemory(pItem, pItem + 1, pMenu-&gt;cItems * (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d9/structtagITEM.html">ITEM</a>) +
00708                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<span class="keywordtype">char</span> *)&amp;pMenu-&gt;rgItems[0] - (<span class="keywordtype">char</span> *)(pItem + 1)));
00709 <span class="preprocessor">#if DEBUGTAGS</span>
00710 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
00711             RelocateMenuLockRecords(pItem,
00712                     (<span class="keywordtype">int</span>)(&amp;(pMenu-&gt;rgItems[pMenu-&gt;cItems - 1]) - pItem),
00713                     -(<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1074">ITEM</a>));
00714         }
00715 <span class="preprocessor">#endif</span>
00716 <span class="preprocessor"></span>
00717         <span class="comment">/*</span>
00718 <span class="comment">         * We're shrinking so if localalloc fails, just leave the mem as is.</span>
00719 <span class="comment">         */</span>
00720         UserAssert(pMenu-&gt;cAlloced &gt;= pMenu-&gt;cItems);
00721         <span class="keywordflow">if</span> ((pMenu-&gt;cAlloced - pMenu-&gt;cItems) &gt;= <a class="code" href="../../d3/d2/mnchange_8c.html#a1">CMENUITEMDEALLOC</a> - 1) {
00722             pNewItems = (<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(pMenu-&gt;head.rpdesk,
00723                     (pMenu-&gt;cAlloced - <a class="code" href="../../d3/d2/mnchange_8c.html#a1">CMENUITEMDEALLOC</a>) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1074">ITEM</a>),
00724                                             <a class="code" href="../../d4/d1/userk_8h.html#a308">DTAG_MENUITEM</a>);
00725             <span class="keywordflow">if</span> (pNewItems != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00726 
00727                 RtlCopyMemory(pNewItems, pMenu-&gt;rgItems,
00728                         (pMenu-&gt;cAlloced - <a class="code" href="../../d3/d2/mnchange_8c.html#a1">CMENUITEMDEALLOC</a>) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1074">ITEM</a>));
00729 <span class="preprocessor">#if DEBUGTAGS</span>
00730 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
00731                     RelocateMenuLockRecords(pNewItems, pMenu-&gt;cItems - 1,
00732                         ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pNewItems) - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pMenu-&gt;rgItems));
00733                 }
00734 <span class="preprocessor">#endif</span>
00735 <span class="preprocessor"></span>                <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pMenu-&gt;head.rpdesk, pMenu-&gt;rgItems);
00736                 pMenu-&gt;cAlloced -= <a class="code" href="../../d3/d2/mnchange_8c.html#a1">CMENUITEMDEALLOC</a>;
00737             } <span class="keywordflow">else</span>
00738                 pNewItems = pMenu-&gt;rgItems;
00739         } <span class="keywordflow">else</span>
00740             pNewItems = pMenu-&gt;rgItems;
00741     }
00742 
00743     pMenu-&gt;rgItems = pNewItems;
00744     pMenu-&gt;cItems--;
00745 
00746     <span class="keywordflow">if</span> (ppopup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00747         <span class="comment">/*</span>
00748 <span class="comment">         * this menu is currently being displayed -- redisplay the menu with</span>
00749 <span class="comment">         * this item removed</span>
00750 <span class="comment">         */</span>
00751         <a class="code" href="../../d4/d1/userk_8h.html#a1336">xxxMNUpdateShownMenu</a>(ppopup, pMenu-&gt;rgItems + uiPos, <a class="code" href="../../d4/d1/userk_8h.html#a531">MNUS_DELETE</a>);
00752     }
00753     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00754 }
00755 
00756 <span class="comment">/***************************************************************************\</span>
00757 <span class="comment">* RemoveMenu</span>
00758 <span class="comment">*</span>
00759 <span class="comment">* Removes and item but doesn't delete it. Only useful for items with</span>
00760 <span class="comment">* an associated popup since this will remove the item from the menu with</span>
00761 <span class="comment">* destroying the popup menu handle.</span>
00762 <span class="comment">*</span>
00763 <span class="comment">* History:</span>
00764 <span class="comment">\***************************************************************************/</span>
00765 
<a name="l00766"></a><a class="code" href="../../d4/d1/userk_8h.html#a1594">00766</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1594">xxxRemoveMenu</a>(
00767     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00768     UINT nPosition,
00769     UINT wFlags)
00770 {
00771     <span class="keywordflow">return</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a16">xxxRemoveDeleteMenuHelper</a>(pMenu, nPosition, wFlags, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00772 }
00773 
00774 <span class="comment">/***************************************************************************\</span>
00775 <span class="comment">* DeleteMenu</span>
00776 <span class="comment">*</span>
00777 <span class="comment">* Deletes an item. ie. Removes it and recovers the memory used by it.</span>
00778 <span class="comment">*</span>
00779 <span class="comment">* History:</span>
00780 <span class="comment">\***************************************************************************/</span>
00781 
<a name="l00782"></a><a class="code" href="../../d4/d1/userk_8h.html#a1595">00782</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1595">xxxDeleteMenu</a>(
00783     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00784     UINT nPosition,
00785     UINT wFlags)
00786 {
00787     <span class="keywordflow">return</span> <a class="code" href="../../d3/d2/mnchange_8c.html#a16">xxxRemoveDeleteMenuHelper</a>(pMenu, nPosition, wFlags, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00788 }
00789 
00790 <span class="comment">/***************************************************************************\</span>
00791 <span class="comment">* xxxSetLPITEMInfo</span>
00792 <span class="comment">*</span>
00793 <span class="comment">* History:</span>
00794 <span class="comment">*  07-23-96 GerardoB - Added header and Fixed up for 5.0</span>
00795 <span class="comment">\***************************************************************************/</span>
<a name="l00796"></a><a class="code" href="../../d3/d2/mnchange_8c.html#a4">00796</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> NEAR <a class="code" href="../../d3/d2/mnchange_8c.html#a4">xxxSetLPITEMInfo</a>(
00797     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00798     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem,
00799     LPMENUITEMINFOW lpmii,
00800     PUNICODE_STRING pstrItem)
00801 {
00802 
00803     HANDLE hstr;
00804     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cch;
00805     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRecompute = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00806     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00807     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup;
00808 
00809     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00810 
00811     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_FTYPE) {
00812         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a> &amp;= ~MFT_MASK;
00813         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a> |= lpmii-&gt;fType;
00814         <span class="keywordflow">if</span> (lpmii-&gt;fType &amp; MFT_SEPARATOR ) {
00815             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> |= MFS_DISABLED ;
00816         }
00817         fRecompute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00818         fRedraw = (lpmii-&gt;fType &amp; MFT_OWNERDRAW);
00819     }
00820 
00821     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_STRING) {
00822         <span class="keywordflow">if</span> (pstrItem-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00823             hstr = (HANDLE)<a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk,
00824                     pstrItem-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL), <a class="code" href="../../d4/d1/userk_8h.html#a309">DTAG_MENUTEXT</a>);
00825 
00826             <span class="keywordflow">if</span> (hstr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00827                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00828             }
00829 
00830             <span class="keywordflow">try</span> {
00831                 RtlCopyMemory(hstr, pstrItem-&gt;Buffer, pstrItem-&gt;Length);
00832             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00833                 <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk, hstr);
00834                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00835             }
00836             cch = pstrItem-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00837             <span class="comment">/*</span>
00838 <span class="comment">             * We don't need to null terminate the string, since DesktopAlloc</span>
00839 <span class="comment">             * zero-fills for us.</span>
00840 <span class="comment">             */</span>
00841         } <span class="keywordflow">else</span> {
00842             cch = 0;
00843             hstr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00844         }
00845         <a class="code" href="../../d3/d2/mnchange_8c.html#a14">FreeItemString</a>(pMenu,pItem);
00846         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o7">cch</a> = cch;
00847         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> = hstr;
00848         fRecompute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00849         fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00850     }
00851 
00852     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_BITMAP) {
00853         <a class="code" href="../../d3/d2/mnchange_8c.html#a13">FreeItemBitmap</a>(pItem);
00854         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> = lpmii-&gt;hbmpItem;
00855         fRecompute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00856         fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00857         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a> = <a class="code" href="../../d4/d1/userk_8h.html#a533">MNIS_MEASUREBMP</a>;
00858         <span class="comment">/*</span>
00859 <span class="comment">         * If this is one of the special bitmaps, mark it as such</span>
00860 <span class="comment">         */</span>
00861         <span class="keywordflow">if</span> ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> &gt; HBMMENU_MIN) &amp;&amp; (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> &lt; HBMMENU_MAX)) {
00862             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a787">SetMFS</a>(pItem, MFS_CACHEDBMP);
00863         } <span class="keywordflow">else</span> {
00864             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a789">ClearMFS</a>(pItem, MFS_CACHEDBMP);
00865         }
00866     }
00867 
00868     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_ID) {
00869         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o2">wID</a> = lpmii-&gt;wID;
00870     }
00871 
00872     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_DATA) {
00873         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o8">dwItemData</a> = lpmii-&gt;dwItemData;
00874     }
00875 
00876     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_STATE) {
00877         <span class="comment">/*</span>
00878 <span class="comment">         * Preserve private bits (~MFS_MASK).</span>
00879 <span class="comment">         * Also preserve MFS_HILITE | MFS_DEFAULT if already set; if not set,</span>
00880 <span class="comment">         *  let the caller turn them on.</span>
00881 <span class="comment">         */</span>
00882         UserAssert(!(lpmii-&gt;fState &amp; ~MFS_MASK));
00883         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp;= ~MFS_MASK | MFS_HILITE | MFS_DEFAULT;
00884         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> |= lpmii-&gt;fState;
00885         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a> &amp; MFT_SEPARATOR)
00886             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> |= MFS_DISABLED;
00887         fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00888     }
00889 
00890     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_CHECKMARKS) {
00891         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o4">hbmpChecked</a>     = lpmii-&gt;hbmpChecked;
00892         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o5">hbmpUnchecked</a>   = lpmii-&gt;hbmpUnchecked;
00893         fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00894     }
00895 
00896     <span class="keywordflow">if</span> (lpmii-&gt;fMask &amp; MIIM_SUBMENU) {
00897         <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pSubMenu = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00898 
00899         <span class="keywordflow">if</span> (lpmii-&gt;hSubMenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900             pSubMenu = <a class="code" href="../../d7/d3/validate_8c.html#a9">ValidateHmenu</a>(lpmii-&gt;hSubMenu);
00901         }
00902 
00903         <span class="comment">// Free the popup associated with this item, if any and if needed.</span>
00904         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != pSubMenu) {
00905             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00906                 <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>);
00907             }
00908             <span class="keywordflow">if</span> (pSubMenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00909 
00910                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bMenuCreated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00911                 <span class="comment">/*</span>
00912 <span class="comment">                 * Fix MSTest that sets a submenu to itself by giving it a different handle.</span>
00913 <span class="comment">                 * So the loop is broken and we won't fail their call later</span>
00914 <span class="comment">                 * MCostea #243374</span>
00915 <span class="comment">                 */</span>
00916                 <span class="keywordflow">if</span> (pSubMenu == pMenu) {
00917                     pSubMenu = <a class="code" href="../../d5/d2/mncreate_8c.html#a1">_CreateMenu</a>();
00918                     <span class="keywordflow">if</span> (!pSubMenu) {
00919                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00920                     }
00921                     bMenuCreated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00922                 }
00923                 <span class="comment">/*</span>
00924 <span class="comment">                 * Link the submenu and then check for loops</span>
00925 <span class="comment">                 */</span>
00926                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>), pSubMenu);
00927                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>);
00928                 <span class="comment">/*</span>
00929 <span class="comment">                 * We just added a submenu.  Check to see if the menu tree is not</span>
00930 <span class="comment">                 * unreasonable deep and there is no loop forming.</span>
00931 <span class="comment">                 * This will prevent us from running out of stack</span>
00932 <span class="comment">                 * MCostea #226460</span>
00933 <span class="comment">                 */</span>
00934                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d2/mnchange_8c.html#a6">GetMenuDepth</a>(pSubMenu, <a class="code" href="../../d3/d2/mnchange_8c.html#a2">NESTED_MENU_LIMIT</a>) + <a class="code" href="../../d3/d2/mnchange_8c.html#a7">GetMenuAncestors</a>(pMenu) &gt;= <a class="code" href="../../d3/d2/mnchange_8c.html#a2">NESTED_MENU_LIMIT</a>) {
00935 FailInsertion:
00936                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"The menu hierarchy is very deep or has a loop %#p"</span>, pMenu);
00937                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a785">ClearMF</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>);
00938                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>));
00939                     <span class="keywordflow">if</span> (bMenuCreated) {
00940                         <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pSubMenu);
00941                     }
00942                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00943                 }
00944                 <span class="comment">/*</span>
00945 <span class="comment">                 * Add pMenu to the pSubMenu-&gt;pParentMenus list</span>
00946 <span class="comment">                 */</span>
00947                 {
00948                     <a class="code" href="../../d3/d1/structtagMENULIST.html">PMENULIST</a> pMenuList = <a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk,
00949                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d1/structtagMENULIST.html">MENULIST</a>),
00950                                             <a class="code" href="../../d4/d1/userk_8h.html#a308">DTAG_MENUITEM</a>);
00951                     <span class="keywordflow">if</span> (!pMenuList) {
00952                         <span class="keywordflow">goto</span> FailInsertion;
00953                     }
00954                     pMenuList-&gt;<a class="code" href="../../d3/d1/structtagMENULIST.html#o1">pMenu</a> = pMenu;
00955                     pMenuList-&gt;<a class="code" href="../../d3/d1/structtagMENULIST.html#o0">pNext</a> = pSubMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o18">pParentMenus</a>;
00956                     pSubMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o18">pParentMenus</a> = pMenuList;
00957                 }
00958             } <span class="keywordflow">else</span> {
00959                 <a class="code" href="../../d3/d2/mnchange_8c.html#a5">UnlockSubMenu</a>(pMenu, &amp;(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>));
00960             }
00961             fRedraw = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00962         }
00963     }
00964 
00965     <span class="comment">// For support of the old way of defining a separator i.e. if it is not a string</span>
00966     <span class="comment">// or a bitmap or a ownerdraw, then it must be a separator.</span>
00967     <span class="comment">// This should prpbably be moved to MIIOneWayConvert -jjk</span>
00968     <span class="keywordflow">if</span> (!(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a> &amp; (MFT_OWNERDRAW | MFT_SEPARATOR))
00969          &amp;&amp; (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00970          &amp;&amp; (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00971 
00972         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a> = MFT_SEPARATOR;
00973         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a>|=MFS_DISABLED;
00974     }
00975 
00976     <span class="keywordflow">if</span> (fRecompute) {
00977         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o13">dxTab</a>   = 0;
00978         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o14">ulX</a>     = <a class="code" href="../../d4/d1/userk_8h.html#a570">UNDERLINE_RECALC</a>;
00979         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o15">ulWidth</a> = 0;
00980 
00981         <span class="comment">// Set the size of this menu to be 0 so that it gets recomputed with this</span>
00982         <span class="comment">// new item...</span>
00983         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a> = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> = 0;
00984 
00985 
00986         <span class="keywordflow">if</span> (fRedraw) {
00987             <span class="keywordflow">if</span> (ppopup = <a class="code" href="../../d4/d1/userk_8h.html#a1602">MNGetPopupFromMenu</a>(pMenu, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00988                 <span class="comment">// this menu is currently being displayed -- redisplay the menu,</span>
00989                 <span class="comment">// recomputing if necessary</span>
00990                 <a class="code" href="../../d4/d1/userk_8h.html#a1336">xxxMNUpdateShownMenu</a>(ppopup, pItem, <a class="code" href="../../d4/d1/userk_8h.html#a530">MNUS_DEFAULT</a>);
00991             }
00992         }
00993 
00994     }
00995 
00996     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00997 }
00998 
<a name="l00999"></a><a class="code" href="../../d4/d1/userk_8h.html#a1591">00999</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1591">_SetMenuContextHelpId</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, DWORD dwContextHelpId)
01000 {
01001 
01002     <span class="comment">// Set the new context help Id;</span>
01003     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o10">dwContextHelpId</a> = dwContextHelpId;
01004 
01005     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01006 }
01007 
<a name="l01008"></a><a class="code" href="../../d4/d1/userk_8h.html#a1592">01008</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1592">_SetMenuFlagRtoL</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu)
01009 {
01010 
01011     <span class="comment">// This is a right-to-left menu being created;</span>
01012     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>);
01013 
01014     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01015 }
01016 
01017 <span class="comment">/***************************************************************************\</span>
01018 <span class="comment">* MNGetPopupFromMenu</span>
01019 <span class="comment">*</span>
01020 <span class="comment">*  checks to see if the given hMenu is currently being shown in a popup.</span>
01021 <span class="comment">*  returns the PPOPUPMENU associated with this hMenu if it is being shown;</span>
01022 <span class="comment">*  NULL if the hMenu is not currently being shown</span>
01023 <span class="comment">*</span>
01024 <span class="comment">* History:</span>
01025 <span class="comment">*  07-23-96 GerardoB - Added header &amp; fixed up for 5.0</span>
01026 <span class="comment">\***************************************************************************/</span>
<a name="l01027"></a><a class="code" href="../../d4/d1/userk_8h.html#a1602">01027</a> <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> <a class="code" href="../../d4/d1/userk_8h.html#a1602">MNGetPopupFromMenu</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> *ppMenuState)
01028 {
01029     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>  ppopup;
01030     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
01031 
01032     <span class="comment">/*</span>
01033 <span class="comment">     * If this menu doesn't have a notification window, then</span>
01034 <span class="comment">     *  it cannot be in menu mode</span>
01035 <span class="comment">     */</span>
01036    <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01037        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01038    }
01039 
01040    <span class="comment">/*</span>
01041 <span class="comment">    * If no pMenuState, no menu mode</span>
01042 <span class="comment">    */</span>
01043    pMenuState = <a class="code" href="../../d4/d1/userk_8h.html#a1320">GetpMenuState</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>);
01044    <span class="keywordflow">if</span> (pMenuState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01045        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01046    }
01047 
01048    <span class="comment">/*</span>
01049 <span class="comment">    * If not in the menu loop, not yet or no longer in menu mode</span>
01050 <span class="comment">    */</span>
01051   <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a>) {
01052       <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01053   }
01054 
01055   <span class="comment">/*</span>
01056 <span class="comment">   * return pMenuState if requested</span>
01057 <span class="comment">   */</span>
01058   <span class="keywordflow">if</span> (ppMenuState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01059       *ppMenuState = pMenuState;
01060   }
01061 
01062 
01063     <span class="comment">/*</span>
01064 <span class="comment">     * Starting from the root popup, find the popup associated to this menu</span>
01065 <span class="comment">     */</span>
01066     ppopup = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>;
01067     <span class="keywordflow">while</span> (ppopup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01068         <span class="comment">/*</span>
01069 <span class="comment">         * found?</span>
01070 <span class="comment">         */</span>
01071         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a> == pMenu) {
01072             <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>) {
01073                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01074             }
01075             <span class="comment">/*</span>
01076 <span class="comment">             * Since the menu is being modified, let's kill any animation.</span>
01077 <span class="comment">             */</span>
01078             <a class="code" href="../../d4/d1/userk_8h.html#a1339">MNAnimate</a>(pMenuState, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01079             <span class="keywordflow">return</span> ppopup;
01080         }
01081         <span class="comment">/*</span>
01082 <span class="comment">         * If no more popups, bail</span>
01083 <span class="comment">         */</span>
01084         <span class="keywordflow">if</span> (ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01085             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01086         }
01087 
01088         <span class="comment">/*</span>
01089 <span class="comment">         * Next popup</span>
01090 <span class="comment">         */</span>
01091         ppopup = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o27">spwndNextPopup</a>)-&gt;ppopupmenu;
01092     }
01093 
01094     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01095 }
01096 
01097 <span class="comment">/***************************************************************************\</span>
01098 <span class="comment">* xxxMNUpdateShownMenu</span>
01099 <span class="comment">*</span>
01100 <span class="comment">*  updates a given ppopup menu window to reflect the inserting, deleting,</span>
01101 <span class="comment">*  or altering of the given lpItem.</span>
01102 <span class="comment">*</span>
01103 <span class="comment">* History:</span>
01104 <span class="comment">*  07-23-96 GerardoB - Added header &amp; fixed up for 5.0</span>
01105 <span class="comment">\***************************************************************************/</span>
<a name="l01106"></a><a class="code" href="../../d4/d1/userk_8h.html#a1336">01106</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1336">xxxMNUpdateShownMenu</a>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup, <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem, UINT uFlags)
01107 {
01108     RECT rc;
01109     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>;
01110     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>;
01111     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01112     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
01113 
01114     <span class="comment">/*</span>
01115 <span class="comment">     * The popup might get destroyed while we callback, so lock this pwnd.</span>
01116 <span class="comment">     */</span>
01117     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
01118     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, &amp;tlpmenu);
01119 
01120     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(pwnd, &amp;rc);
01121 
01122     <span class="comment">/*</span>
01123 <span class="comment">     * If we need to resize menu window</span>
01124 <span class="comment">     */</span>
01125     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> == 0) {
01126         RECT rcScroll = rc;
01127         <span class="keywordtype">int</span> cySave = rc.bottom;
01128         <span class="keywordtype">int</span> cxSave = rc.right;
01129         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;
01130         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwArrowsOnBefore;
01131 
01132         dwArrowsOnBefore = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a>;
01133         UserAssert(uFlags != 0);
01134         dwSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, MN_SIZEWINDOW, uFlags, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01135         uFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a532">MNUS_DRAWFRAME</a>;
01136         <span class="comment">/*</span>
01137 <span class="comment">         * If scroll arrows appeared or disappeared,  redraw entire client</span>
01138 <span class="comment">         */</span>
01139         <span class="keywordflow">if</span> (dwArrowsOnBefore ^ pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a>) {
01140             <span class="keywordflow">goto</span> InvalidateAll;
01141         }
01142 
01143         rc.right = LOWORD(dwSize);
01144         <span class="keywordflow">if</span> (pItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01145             <span class="keywordflow">if</span> (rc.right != cxSave) {
01146                 <span class="comment">// width changed, redraw everything</span>
01147                 <span class="comment">// BUGBUG -- this could be tuned to just redraw items with</span>
01148                 <span class="comment">// submenus and/or accelerator fields</span>
01149                 <span class="keywordflow">goto</span> InvalidateAll;
01150             } <span class="keywordflow">else</span> {
01151                 rc.bottom = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>;
01152                 <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o16">dwArrowsOn</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a759">MSA_OFF</a>) {
01153                     <span class="keywordflow">if</span> (rc.bottom &lt;= cySave) {
01154                         rc.top = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> - <a class="code" href="../../d4/d1/userk_8h.html#a1324">MNGetToppItem</a>(pMenu)-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
01155                         <span class="keywordflow">goto</span> InvalidateRest;
01156                     }
01157 
01158                     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(pwnd, &amp;rcScroll);
01159                 }
01160 
01161                 rc.top = rcScroll.top = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> - <a class="code" href="../../d4/d1/userk_8h.html#a1324">MNGetToppItem</a>(pMenu)-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
01162                 <span class="keywordflow">if</span> ((rc.top &gt;= 0) &amp;&amp; (rc.top &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>)) {
01163                     <a class="code" href="../../d4/d1/userk_8h.html#a1426">xxxScrollWindowEx</a>(pwnd, 0, rc.bottom - cySave, &amp;rcScroll, &amp;rc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, SW_INVALIDATE | SW_ERASE);
01164                 }
01165             } <span class="comment">/* else of if (rc.right != cxSave) */</span>
01166         } <span class="comment">/* if (pItem != NULL) */</span>
01167     } <span class="comment">/* if (pMenu-&gt;cxMenu == 0) */</span>
01168 
01169     <span class="keywordflow">if</span> (!(uFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a531">MNUS_DELETE</a>)) {
01170         <span class="keywordflow">if</span> (pItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01171             rc.top = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> - <a class="code" href="../../d4/d1/userk_8h.html#a1324">MNGetToppItem</a>(pMenu)-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
01172             rc.bottom = rc.top + pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
01173 InvalidateRest:
01174             <span class="keywordflow">if</span> ((rc.top &gt;= 0) &amp;&amp; (rc.top &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>)) {
01175                 <a class="code" href="../../d4/d1/userk_8h.html#a1669">xxxInvalidateRect</a>(pwnd, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01176             }
01177         } <span class="keywordflow">else</span> {
01178 InvalidateAll:
01179             <a class="code" href="../../d4/d1/userk_8h.html#a1669">xxxInvalidateRect</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01180         }
01181         <span class="keywordflow">if</span> (uFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a532">MNUS_DRAWFRAME</a>) {
01182             <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0,
01183              SWP_DRAWFRAME | SWP_NOSIZE | SWP_NOZORDER | SWP_NOMOVE
01184              | SWP_NOACTIVATE | SWP_NOOWNERZORDER);
01185         }
01186     }
01187 
01188     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
01189     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01190 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
