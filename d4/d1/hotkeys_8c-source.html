<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hotkeys.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hotkeys.c</h1><a href="../../d3/d2/hotkeys_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: hotkeys.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the core functions of hotkey processing.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 12-04-90 DavidPe      Created.</span>
00010 <span class="comment">* 02-12-91 JimA         Added access checks</span>
00011 <span class="comment">* 13-Feb-1991 mikeke    Added Revalidation code (None)</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">/***************************************************************************\</span>
00018 <span class="comment">* InitSystemHotKeys</span>
00019 <span class="comment">*</span>
00020 <span class="comment">* Called from InitWindows(), this routine registers the default system</span>
00021 <span class="comment">* hotkeys.</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* History:</span>
00024 <span class="comment">* 12-04-90 DavidPe      Created.</span>
00025 <span class="comment">\***************************************************************************/</span>
<a name="l00026"></a><a class="code" href="../../d4/d1/userk_8h.html#a1181">00026</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d2/hotkeys_8c.html#a0">SetDebugHotKeys</a>()
00027 {
00028     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> VkDebug;
00029 
00030     VkDebug = <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a716">PMAP_AEDEBUG</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"UserDebuggerHotkey"</span>, 0);
00031     <span class="keywordflow">if</span> (VkDebug == 0) {
00032         <span class="keywordflow">if</span> (ENHANCED_KEYBOARD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyboardIdentifier)) {
00033             VkDebug = VK_F12;
00034         } <span class="keywordflow">else</span> {
00035             VkDebug = VK_SUBTRACT;
00036         }
00037     } <span class="keywordflow">else</span> {
00038         UserAssert((0xFFFFFF00 &amp; VkDebug) == 0);
00039     }
00040 
00041     <a class="code" href="../../d4/d1/userk_8h.html#a1661">_UnregisterHotKey</a>(<a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>, <a class="code" href="../../d4/d1/userk_8h.html#a458">IDHOT_DEBUG</a>);
00042     <a class="code" href="../../d4/d1/userk_8h.html#a1661">_UnregisterHotKey</a>(<a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>, <a class="code" href="../../d4/d1/userk_8h.html#a459">IDHOT_DEBUGSERVER</a>);
00043 
00044     <a class="code" href="../../d4/d1/userk_8h.html#a1660">_RegisterHotKey</a>(<a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>, <a class="code" href="../../d4/d1/userk_8h.html#a458">IDHOT_DEBUG</a>, 0, VkDebug);
00045     <a class="code" href="../../d4/d1/userk_8h.html#a1660">_RegisterHotKey</a>(<a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>, <a class="code" href="../../d4/d1/userk_8h.html#a459">IDHOT_DEBUGSERVER</a>, MOD_SHIFT, VkDebug);
00046 }
00047 
00048 
00049 <span class="comment">/***************************************************************************\</span>
00050 <span class="comment">* DestroyThreadsHotKeys</span>
00051 <span class="comment">*</span>
00052 <span class="comment">* History:</span>
00053 <span class="comment">* 26-Feb-1991 mikeke    Created.</span>
00054 <span class="comment">\***************************************************************************/</span>
00055 
<a name="l00056"></a><a class="code" href="../../d3/d2/hotkeys_8c.html#a1">00056</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d2/hotkeys_8c.html#a1">DestroyThreadsHotKeys</a>()
00057 {
00058     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> *pphk;
00059     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> phk;
00060     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00061     pphk = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a115">gphkFirst</a>;
00062     <span class="keywordflow">while</span> (*pphk) {
00063         <span class="keywordflow">if</span> ((*pphk)-&gt;pti == ptiCurrent) {
00064             phk = *pphk;
00065             *pphk = (*pphk)-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o6">phkNext</a>;
00066 
00067             <span class="comment">/*</span>
00068 <span class="comment">             * Unlock the object stored here.</span>
00069 <span class="comment">             */</span>
00070             <span class="keywordflow">if</span> ((phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a> != <a class="code" href="../../d4/d1/userk_8h.html#a450">PWND_FOCUS</a>) &amp;&amp; (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a> != <a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>)) {
00071                 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a>);
00072             }
00073 
00074             UserFreePool(phk);
00075         } <span class="keywordflow">else</span> {
00076             pphk = &amp;((*pphk)-&gt;phkNext);
00077         }
00078     }
00079 }
00080 
00081 
00082 <span class="comment">/***************************************************************************\</span>
00083 <span class="comment">* DestroyWindowsHotKeys</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* Called from xxxFreeWindow.</span>
00086 <span class="comment">* Hotkeys not unregistered properly by the app must be destroyed when the</span>
00087 <span class="comment">* window is destroyed.  Keeps things clean (problems with bad apps #5553)</span>
00088 <span class="comment">*</span>
00089 <span class="comment">* History:</span>
00090 <span class="comment">* 23-Sep-1992 IanJa     Created.</span>
00091 <span class="comment">\***************************************************************************/</span>
00092 
<a name="l00093"></a><a class="code" href="../../d4/d1/userk_8h.html#a1550">00093</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1550">DestroyWindowsHotKeys</a>(
00094     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00095 {
00096     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> *pphk;
00097     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> phk;
00098     pphk = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a115">gphkFirst</a>;
00099     <span class="keywordflow">while</span> (*pphk) {
00100         <span class="keywordflow">if</span> ((*pphk)-&gt;spwnd == pwnd) {
00101             phk = *pphk;
00102             *pphk = (*pphk)-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o6">phkNext</a>;
00103 
00104             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a>);
00105             UserFreePool(phk);
00106         } <span class="keywordflow">else</span> {
00107             pphk = &amp;((*pphk)-&gt;phkNext);
00108         }
00109     }
00110 }
00111 
00112 
00113 <span class="comment">/***************************************************************************\</span>
00114 <span class="comment">* _RegisterHotKey (API)</span>
00115 <span class="comment">*</span>
00116 <span class="comment">* This API registers the hotkey specified.  If the specified key sequence</span>
00117 <span class="comment">* has already been registered we return FALSE.  If the specified hwnd</span>
00118 <span class="comment">* and id have already been registered, fsModifiers and vk are reset for</span>
00119 <span class="comment">* the HOTKEY structure.</span>
00120 <span class="comment">*</span>
00121 <span class="comment">* History:</span>
00122 <span class="comment">* 12-04-90 DavidPe      Created.</span>
00123 <span class="comment">* 02-12-91 JimA         Added access check</span>
00124 <span class="comment">\***************************************************************************/</span>
<a name="l00125"></a><a class="code" href="../../d4/d1/userk_8h.html#a1660">00125</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1660">_RegisterHotKey</a>(
00126     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00127     <span class="keywordtype">int</span> <span class="keywordtype">id</span>,
00128     UINT fsModifiers,
00129     UINT vk)
00130 {
00131     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a>         phk;
00132     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fKeysExist;
00133     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent;
00134     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            bSAS = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00135     WORD            wFlags;
00136 
00137     wFlags = fsModifiers &amp; MOD_SAS;
00138     fsModifiers &amp;= ~MOD_SAS;
00139 
00140     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00141 
00142     <span class="comment">/*</span>
00143 <span class="comment">     * Blow it off if the caller is not the windowstation init thread</span>
00144 <span class="comment">     * and doesn't have the proper access rights</span>
00145 <span class="comment">     */</span>
00146     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
00147         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> &amp;&amp; !<a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a9">CheckWinstaWriteAttributesAccess</a>()) {
00148             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149         }
00150     }
00151 
00152     <span class="comment">/*</span>
00153 <span class="comment">     * If VK_PACKET is specified, just bail out, since VK_PACKET is</span>
00154 <span class="comment">     * not a real keyboard input.</span>
00155 <span class="comment">     */</span>
00156     <span class="keywordflow">if</span> (vk == VK_PACKET) {
00157         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00158     }
00159 
00160     <span class="comment">/*</span>
00161 <span class="comment">     * If this is the SAS check that winlogon is the one registering it.</span>
00162 <span class="comment">     */</span>
00163     <span class="keywordflow">if</span> (wFlags &amp; MOD_SAS) {
00164         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00165             bSAS = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00166         }
00167     }
00168 
00169     <span class="comment">/*</span>
00170 <span class="comment">     * Can't register hotkey for a window of another queue.</span>
00171 <span class="comment">     * Return FALSE in this case.</span>
00172 <span class="comment">     */</span>
00173     <span class="keywordflow">if</span> ((pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a450">PWND_FOCUS</a>) &amp;&amp; (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>)) {
00174         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != ptiCurrent) {
00175             RIPERR0(ERROR_WINDOW_OF_OTHER_THREAD, RIP_VERBOSE, <span class="stringliteral">""</span>);
00176             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00177         }
00178     }
00179 
00180     phk = <a class="code" href="../../d4/d1/userk_8h.html#a1463">FindHotKey</a>(ptiCurrent, pwnd, <span class="keywordtype">id</span>, fsModifiers, vk, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;fKeysExist);
00181 
00182     <span class="comment">/*</span>
00183 <span class="comment">     * If the keys have already been registered, return FALSE.</span>
00184 <span class="comment">     */</span>
00185     <span class="keywordflow">if</span> (fKeysExist) {
00186         RIPERR0(ERROR_HOTKEY_ALREADY_REGISTERED, RIP_WARNING, <span class="stringliteral">"Hotkey already exists"</span>);
00187         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00188     }
00189 
00190     <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00191         <span class="comment">/*</span>
00192 <span class="comment">         * This hotkey doesn't exist yet.</span>
00193 <span class="comment">         */</span>
00194         phk = (<a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/structtagHOTKEY.html">HOTKEY</a>), TAG_HOTKEY);
00195 
00196         <span class="comment">/*</span>
00197 <span class="comment">         * If the allocation failed, bail out.</span>
00198 <span class="comment">         */</span>
00199         <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00201         }
00202 
00203         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o0">pti</a> = ptiCurrent;
00204 
00205         <span class="keywordflow">if</span> ((pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a450">PWND_FOCUS</a>) &amp;&amp; (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>)) {
00206             phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00207             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a>, pwnd);
00208         } <span class="keywordflow">else</span> {
00209             phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a> = pwnd;
00210         }
00211         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o2">fsModifiers</a> = (WORD)fsModifiers;
00212         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o3">wFlags</a> = wFlags;
00213 
00214         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o4">vk</a> = vk;
00215         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o5">id</a> = <span class="keywordtype">id</span>;
00216 
00217         <span class="comment">/*</span>
00218 <span class="comment">         * Link the new hotkey to the front of the list.</span>
00219 <span class="comment">         */</span>
00220         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o6">phkNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a115">gphkFirst</a>;
00221         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a115">gphkFirst</a> = phk;
00222 
00223     } <span class="keywordflow">else</span> {
00224 
00225         <span class="comment">/*</span>
00226 <span class="comment">         * Hotkey already exists, reset the keys.</span>
00227 <span class="comment">         */</span>
00228         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o2">fsModifiers</a> = (WORD)fsModifiers;
00229         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o3">wFlags</a> = wFlags;
00230         phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o4">vk</a> = vk;
00231     }
00232 
00233     <span class="keywordflow">if</span> (bSAS) {
00234         <span class="comment">/*</span>
00235 <span class="comment">         * store the SAS on the terminal.</span>
00236 <span class="comment">         */</span>
00237         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a230">gvkSAS</a> = vk;
00238         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a228">gfsSASModifiers</a> = fsModifiers;
00239     }
00240 
00241     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00242 }
00243 
00244 
00245 <span class="comment">/***************************************************************************\</span>
00246 <span class="comment">* _UnregisterHotKey (API)</span>
00247 <span class="comment">*</span>
00248 <span class="comment">* This API will 'unregister' the specified hwnd/id hotkey so that the</span>
00249 <span class="comment">* WM_HOTKEY message will not be generated for it.</span>
00250 <span class="comment">*</span>
00251 <span class="comment">* History:</span>
00252 <span class="comment">* 12-04-90 DavidPe      Created.</span>
00253 <span class="comment">\***************************************************************************/</span>
00254 
<a name="l00255"></a><a class="code" href="../../d4/d1/userk_8h.html#a1661">00255</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1661">_UnregisterHotKey</a>(
00256     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00257     <span class="keywordtype">int</span> <span class="keywordtype">id</span>)
00258 {
00259     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> phk;
00260     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fKeysExist;
00261     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00262     phk = <a class="code" href="../../d4/d1/userk_8h.html#a1463">FindHotKey</a>(ptiCurrent, pwnd, <span class="keywordtype">id</span>, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;fKeysExist);
00263 
00264     <span class="comment">/*</span>
00265 <span class="comment">     * No hotkey to unregister, return FALSE.</span>
00266 <span class="comment">     */</span>
00267     <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00268         RIPERR0(ERROR_HOTKEY_NOT_REGISTERED, RIP_VERBOSE, <span class="stringliteral">""</span>);
00269         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00270     }
00271 
00272     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00273 }
00274 
00275 
00276 <span class="comment">/***************************************************************************\</span>
00277 <span class="comment">* FindHotKey</span>
00278 <span class="comment">*</span>
00279 <span class="comment">* Both RegisterHotKey() and UnregisterHotKey() call this function to search</span>
00280 <span class="comment">* for hotkeys that already exist.  If a HOTKEY is found that matches</span>
00281 <span class="comment">* fsModifiers and vk, *pfKeysExist is set to TRUE.  If a HOTKEY is found that</span>
00282 <span class="comment">* matches pwnd and id, a pointer to it is returned.</span>
00283 <span class="comment">*</span>
00284 <span class="comment">* If fUnregister is TRUE, we remove the HOTKEY from the list if we find</span>
00285 <span class="comment">* one that matches pwnd and id and return (PHOTKEY)1.</span>
00286 <span class="comment">*</span>
00287 <span class="comment">* History:</span>
00288 <span class="comment">* 12-04-90 DavidPe      Created.</span>
00289 <span class="comment">\***************************************************************************/</span>
<a name="l00290"></a><a class="code" href="../../d4/d1/userk_8h.html#a1463">00290</a> <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> <a class="code" href="../../d4/d1/userk_8h.html#a1463">FindHotKey</a>(
00291     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent,
00292     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00293     <span class="keywordtype">int</span> <span class="keywordtype">id</span>,
00294     UINT fsModifiers,
00295     UINT vk,
00296     BOOL fUnregister,
00297     PBOOL pfKeysExist)
00298 {
00299     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> phk, phkRet, phkPrev;
00300 
00301     <span class="comment">/*</span>
00302 <span class="comment">     * Initialize out 'return' values.</span>
00303 <span class="comment">     */</span>
00304     *pfKeysExist = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00305     phkRet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00306 
00307     phk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a115">gphkFirst</a>;
00308 
00309     <span class="keywordflow">while</span> (phk) {
00310 
00311         <span class="comment">/*</span>
00312 <span class="comment">         * If all this matches up then we've found it.</span>
00313 <span class="comment">         */</span>
00314         <span class="keywordflow">if</span> ((phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o0">pti</a> == ptiCurrent) &amp;&amp; (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a> == pwnd) &amp;&amp; (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o5">id</a> == <span class="keywordtype">id</span>)) {
00315             <span class="keywordflow">if</span> (fUnregister) {
00316 
00317                 <span class="comment">/*</span>
00318 <span class="comment">                 * Unlink the HOTKEY from the list.</span>
00319 <span class="comment">                 */</span>
00320                 <span class="keywordflow">if</span> (phk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a115">gphkFirst</a>) {
00321                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a115">gphkFirst</a> = phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o6">phkNext</a>;
00322                 } <span class="keywordflow">else</span> {
00323                     phkPrev-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o6">phkNext</a> = phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o6">phkNext</a>;
00324                 }
00325 
00326                 <span class="keywordflow">if</span> ((pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a450">PWND_FOCUS</a>) &amp;&amp; (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>)) {
00327                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a>);
00328                 }
00329                 UserFreePool((PVOID)phk);
00330 
00331                 <span class="keywordflow">return</span>((<a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a>)1);
00332             }
00333             phkRet = phk;
00334         }
00335 
00336         <span class="comment">/*</span>
00337 <span class="comment">         * If the key is already registered, set the exists flag so</span>
00338 <span class="comment">         * the app knows it can't use this hotkey sequence.</span>
00339 <span class="comment">         */</span>
00340         <span class="keywordflow">if</span> ((phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o2">fsModifiers</a> == (WORD)fsModifiers) &amp;&amp; (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o4">vk</a> == vk)) {
00341 
00342             <span class="comment">/*</span>
00343 <span class="comment">             * In the case of PWND_FOCUS, we need to check that the queues</span>
00344 <span class="comment">             * are the same since PWND_FOCUS is local to the queue it was</span>
00345 <span class="comment">             * registered under.</span>
00346 <span class="comment">             */</span>
00347             <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a> == <a class="code" href="../../d4/d1/userk_8h.html#a450">PWND_FOCUS</a>) {
00348                 <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o0">pti</a> == ptiCurrent) {
00349                     *pfKeysExist = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00350                 }
00351             } <span class="keywordflow">else</span> {
00352                 *pfKeysExist = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00353             }
00354         }
00355 
00356         phkPrev = phk;
00357         phk = phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o6">phkNext</a>;
00358     }
00359 
00360     <span class="keywordflow">return</span> phkRet;
00361 }
00362 
00363 
00364 <span class="comment">/***************************************************************************\</span>
00365 <span class="comment">* IsSAS</span>
00366 <span class="comment">*</span>
00367 <span class="comment">* Checks the physical state of keyboard modifiers that would effect SAS</span>
00368 <span class="comment">*</span>
00369 <span class="comment">*</span>
00370 <span class="comment">\***************************************************************************/</span>
00371 
<a name="l00372"></a><a class="code" href="../../d4/d1/userk_8h.html#a1260">00372</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1260">IsSAS</a>(
00373     BYTE  vk,
00374     UINT* pfsModifiers)
00375 {
00376     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsDown = 0;
00377 
00378     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00379 
00380     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a230">gvkSAS</a> != vk) {
00381         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382     }
00383 
00384     <span class="comment">/*</span>
00385 <span class="comment">     * Special case for SAS - examine real physical modifier-key state!</span>
00386 <span class="comment">     *</span>
00387 <span class="comment">     * An evil daemon process can fool convincingly pretend to be winlogon</span>
00388 <span class="comment">     * by registering Alt+Del as a hotkey, and spinning another thread that</span>
00389 <span class="comment">     * continually calls keybd_event() to send the Ctrl key up: when the</span>
00390 <span class="comment">     * user types Ctrl+Alt+Del, only Alt+Del will be seen by the system,</span>
00391 <span class="comment">     * the evil daemon will get woken by WM_HOTKEY and can pretend to be</span>
00392 <span class="comment">     * winlogon.  So look at gfsSASModifiersDown in this case, to see what keys</span>
00393 <span class="comment">     * were physically pressed.</span>
00394 <span class="comment">     * NOTE: If hotkeys are ever made to work under journal playback, make</span>
00395 <span class="comment">     * sure they don't affect the gfsSASModifiersDown!  - IanJa.</span>
00396 <span class="comment">     */</span>
00397     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a229">gfsSASModifiersDown</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a228">gfsSASModifiers</a>) {
00398         *pfsModifiers = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a229">gfsSASModifiersDown</a>;
00399         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00400     }
00401 
00402     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00403 }
00404 
00405 
00406 <span class="comment">/***************************************************************************\</span>
00407 <span class="comment">* xxxDoHotKeyStuff</span>
00408 <span class="comment">*</span>
00409 <span class="comment">* This function gets called for every key event from low-level input</span>
00410 <span class="comment">* processing.  It keeps track of the current state of modifier keys</span>
00411 <span class="comment">* and when fsModifiers and vk match up with one of the registered</span>
00412 <span class="comment">* hotkeys, a WM_HOTKEY message is generated. DoHotKeyStuff() will</span>
00413 <span class="comment">* tell the input system to eat both the make and break for the 'vk'</span>
00414 <span class="comment">* event.  This prevents apps from getting input that wasn't really</span>
00415 <span class="comment">* intended for them.  DoHotKeyStuff() returns TRUE if it wants to 'eat'</span>
00416 <span class="comment">* the event, FALSE if the system can pass on the event like it normally</span>
00417 <span class="comment">* would.</span>
00418 <span class="comment">*</span>
00419 <span class="comment">* A Note on Modifier-Only Hotkeys</span>
00420 <span class="comment">* Some hotkeys involve VK_SHIFT, VK_CONTROL, VK_MENU and/or VK_WINDOWS only.</span>
00421 <span class="comment">* These are called Modifier-Only hotkeys.</span>
00422 <span class="comment">* In order to distinguish hotkeys such as Alt-Shift-S and and Alt-Shift alone,</span>
00423 <span class="comment">* modifier-only hotkeys must operate on a break, not a make.</span>
00424 <span class="comment">* In order to prevent Alt-Shift-S from activating the Alt-Shift hotkey when</span>
00425 <span class="comment">* the keys are released, modifier-only hotkeys are only activated when a</span>
00426 <span class="comment">* modifier keyup (break) was immediately preceded by a modifier keydown (break)</span>
00427 <span class="comment">* This also lets Alt-Shift,Shift,Shift activate the Alt-Shift hotkey 3 times.</span>
00428 <span class="comment">*</span>
00429 <span class="comment">* History:</span>
00430 <span class="comment">* 12-05-90 DavidPe      Created.</span>
00431 <span class="comment">*  4-15-93 Sanfords  Added code to return TRUE for Ctrl-Alt-Del events.</span>
00432 <span class="comment">\***************************************************************************/</span>
00433 
<a name="l00434"></a><a class="code" href="../../d4/d1/userk_8h.html#a1261">00434</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1261">xxxDoHotKeyStuff</a>(
00435     UINT vk,
00436     BOOL fBreak,
00437     DWORD fsReserveKeys)
00438 {
00439     <span class="keyword">static</span> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsModifiers = 0;
00440     <span class="keyword">static</span> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsModOnlyCandidate = 0;
00441     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsModOnlyHotkey;
00442     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fs;
00443     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> phk;
00444     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCancel;
00445     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fEatDebugKeyBreak = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00446     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00447     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bSAS;
00448 
00449     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00450     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00451 
00452     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>) {
00453         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"xxxDoHotKeyStuff: Since we're in gfInNumpadHexInput, just bail out."</span>);
00454         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00455     }
00456 
00457     <span class="comment">/*</span>
00458 <span class="comment">     * Update fsModifiers.</span>
00459 <span class="comment">     */</span>
00460     fs = 0;
00461     fsModOnlyHotkey = 0;
00462 
00463     <span class="keywordflow">switch</span> (vk) {
00464     <span class="keywordflow">case</span> VK_SHIFT:
00465         fs = MOD_SHIFT;
00466         <span class="keywordflow">break</span>;
00467 
00468     <span class="keywordflow">case</span> VK_CONTROL:
00469         fs = MOD_CONTROL;
00470         <span class="keywordflow">break</span>;
00471 
00472     <span class="keywordflow">case</span> VK_MENU:
00473         fs = MOD_ALT;
00474         <span class="keywordflow">break</span>;
00475 
00476     <span class="keywordflow">case</span> VK_LWIN:
00477     <span class="keywordflow">case</span> VK_RWIN:
00478         fs = MOD_WIN;
00479         <span class="keywordflow">break</span>;
00480 
00481     <span class="keywordflow">default</span>:
00482         <span class="comment">/*</span>
00483 <span class="comment">         * A non-modifier key rules out Modifier-Only hotkeys</span>
00484 <span class="comment">         */</span>
00485         fsModOnlyCandidate = 0;
00486         <span class="keywordflow">break</span>;
00487     }
00488 
00489     <span class="keywordflow">if</span> (fBreak) {
00490         fsModifiers &amp;= ~fs;
00491         <span class="comment">/*</span>
00492 <span class="comment">         * If a modifier key is coming up, the current modifier only hotkey</span>
00493 <span class="comment">         * candidate must be tested to see if it is a hotkey.  Store this</span>
00494 <span class="comment">         * in fsModOnlyHotkey, and prevent the next key release from</span>
00495 <span class="comment">         * being a candidate by clearing fsModOnlyCandidate.</span>
00496 <span class="comment">         */</span>
00497         <span class="keywordflow">if</span> (fs != 0) {
00498             fsModOnlyHotkey = fsModOnlyCandidate;
00499             fsModOnlyCandidate = 0;
00500         }
00501     } <span class="keywordflow">else</span> {
00502         fsModifiers |= fs;
00503         <span class="comment">/*</span>
00504 <span class="comment">         * If a modifier key is going down, we have a modifier-only hotkey</span>
00505 <span class="comment">         * candidate.  Save current modifier state until the following break.</span>
00506 <span class="comment">         */</span>
00507         <span class="keywordflow">if</span> (fs != 0) {
00508             fsModOnlyCandidate = fsModifiers;
00509         }
00510     }
00511 
00512     <span class="comment">/*</span>
00513 <span class="comment">     * We look at the physical state for the modifiers because they can not be</span>
00514 <span class="comment">     * manipulated and this prevents someone from writing a trojan winlogon look alike.</span>
00515 <span class="comment">     * (See comment in AreModifiersIndicatingSAS)</span>
00516 <span class="comment">     */</span>
00517     bSAS = <a class="code" href="../../d4/d1/userk_8h.html#a1260">IsSAS</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)vk, &amp;fsModifiers);
00518 
00519     <span class="comment">/*</span>
00520 <span class="comment">     * If the key is not a hotkey then we're done but first check if the</span>
00521 <span class="comment">     * key is an Alt-Escape if so we need to cancel journalling.</span>
00522 <span class="comment">     *</span>
00523 <span class="comment">     * NOTE: Support for Alt+Esc to cancel journalling dropped in NT 4.0</span>
00524 <span class="comment">     */</span>
00525     <span class="keywordflow">if</span> (fsModOnlyHotkey &amp;&amp; fBreak) {
00526         <span class="comment">/*</span>
00527 <span class="comment">         * A hotkey involving only VK_SHIFT, VK_CONTROL, VK_MENU or VK_WINDOWS</span>
00528 <span class="comment">         * must only operate on a key release.</span>
00529 <span class="comment">         */</span>
00530         <span class="keywordflow">if</span> ((phk = <a class="code" href="../../d4/d1/userk_8h.html#a1262">IsHotKey</a>(fsModOnlyHotkey, VK_NONE)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00531             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00532         }
00533     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((phk = <a class="code" href="../../d4/d1/userk_8h.html#a1262">IsHotKey</a>(fsModifiers, vk)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00534         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00535     }
00536 
00537     <span class="comment">/*</span>
00538 <span class="comment">     * If we tripped a SAS hotkey, but it's not really the SAS, don't do it.</span>
00539 <span class="comment">     */</span>
00540     <span class="keywordflow">if</span> ((phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o3">wFlags</a> &amp; MOD_SAS) &amp;&amp; !bSAS) {
00541         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00542 
00543     }
00544     <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o5">id</a> == <a class="code" href="../../d4/d1/userk_8h.html#a460">IDHOT_WINDOWS</a>) {
00545         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a256">GETDESKINFO</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())-&gt;spwndShell;
00546         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00547             fsModOnlyCandidate = 0; <span class="comment">/* Make it return TRUE */</span>
00548             <span class="keywordflow">goto</span> PostTaskListSysCmd;
00549         }
00550     }
00551 
00552     <span class="keywordflow">if</span> ((phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o5">id</a> == <a class="code" href="../../d4/d1/userk_8h.html#a458">IDHOT_DEBUG</a>) || (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o5">id</a> == <a class="code" href="../../d4/d1/userk_8h.html#a459">IDHOT_DEBUGSERVER</a>)) {
00553 
00554         <span class="keywordflow">if</span> (!fBreak) {
00555             <span class="comment">/*</span>
00556 <span class="comment">             * The DEBUG key has been pressed.  Break the appropriate</span>
00557 <span class="comment">             * thread into the debugger.  Won't need phk after this callback</span>
00558 <span class="comment">             * because we return immediately.</span>
00559 <span class="comment">             */</span>
00560             fEatDebugKeyBreak = <a class="code" href="../../d4/d1/userk_8h.html#a1146">xxxActivateDebugger</a>(phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o2">fsModifiers</a>);
00561         }
00562 
00563         <span class="comment">/*</span>
00564 <span class="comment">         * This'll eat the debug key down and break if we broke into</span>
00565 <span class="comment">         * the debugger on the server only on the down.</span>
00566 <span class="comment">         */</span>
00567         <span class="keywordflow">return</span> fEatDebugKeyBreak;
00568     }
00569 
00570     <span class="comment">/*</span>
00571 <span class="comment">     * don't allow hotkeys(except for ones owned by the logon process)</span>
00572 <span class="comment">     * if the window station is locked.</span>
00573 <span class="comment">     */</span>
00574 
00575     <span class="keywordflow">if</span> (((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a314">WSF_SWITCHLOCK</a>) != 0) &amp;&amp;
00576             (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o0">pti</a>-&gt;pEThread-&gt;Cid.UniqueProcess != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>)) {
00577         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Ignoring hotkey because Workstation locked"</span>);
00578         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00579     }
00580 
00581     <span class="keywordflow">if</span> ((fsModOnlyHotkey == 0) &amp;&amp; fBreak) {
00582         <span class="comment">/*</span>
00583 <span class="comment">         * Do Modifier-Only hotkeys on break events, else return here.</span>
00584 <span class="comment">         */</span>
00585         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00586     }
00587 
00588     <span class="comment">/*</span>
00589 <span class="comment">     * Unhook hooks if a control-escape, alt-escape, or control-alt-del</span>
00590 <span class="comment">     * comes through, so the user can cancel if the system seems hung.</span>
00591 <span class="comment">     *</span>
00592 <span class="comment">     * Note the hook may be locked so even if the unhook succeeds it</span>
00593 <span class="comment">     * won't remove the hook from the global asphkStart array.  So</span>
00594 <span class="comment">     * we have to walk the list manually.  This code works because</span>
00595 <span class="comment">     * we are in the critical section and we know other hooks won't</span>
00596 <span class="comment">     * be deleted.</span>
00597 <span class="comment">     *</span>
00598 <span class="comment">     * Once we've unhooked, post a WM_CANCELJOURNAL message to the app</span>
00599 <span class="comment">     * that set the hook so it knows we did this.</span>
00600 <span class="comment">     *</span>
00601 <span class="comment">     * NOTE: Support for Alt+Esc to cancel journalling dropped in NT 4.0</span>
00602 <span class="comment">     */</span>
00603     fCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00604     <span class="keywordflow">if</span> (vk == VK_ESCAPE &amp;&amp; (fsModifiers == MOD_CONTROL)) {
00605         fCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00606     }
00607 
00608     <span class="keywordflow">if</span> (bSAS) {
00609         fCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00610     }
00611 
00612     <span class="keywordflow">if</span> (fCancel)
00613         <a class="code" href="../../d1/d2/hooks_8c.html#a13">zzzCancelJournalling</a>(); <span class="comment">// BUG BUG phk might go away IANJA</span>
00614 
00615     <span class="comment">/*</span>
00616 <span class="comment">     * See if the key is reserved by a console window.  If it is,</span>
00617 <span class="comment">     * return FALSE so the key will be passed to the console.</span>
00618 <span class="comment">     */</span>
00619     <span class="keywordflow">if</span> (fsReserveKeys != 0) {
00620         <span class="keywordflow">switch</span> (vk) {
00621         <span class="keywordflow">case</span> VK_TAB:
00622             <span class="keywordflow">if</span> ((fsReserveKeys &amp; CONSOLE_ALTTAB) &amp;&amp;
00623                     ((fsModifiers &amp; (MOD_CONTROL | MOD_ALT)) == MOD_ALT)) {
00624                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00625             }
00626             <span class="keywordflow">break</span>;
00627         <span class="keywordflow">case</span> VK_ESCAPE:
00628             <span class="keywordflow">if</span> ((fsReserveKeys &amp; CONSOLE_ALTESC) &amp;&amp;
00629                     ((fsModifiers &amp; (MOD_CONTROL | MOD_ALT)) == MOD_ALT)) {
00630                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00631             }
00632             <span class="keywordflow">if</span> ((fsReserveKeys &amp; CONSOLE_CTRLESC) &amp;&amp;
00633                     ((fsModifiers &amp; (MOD_CONTROL | MOD_ALT)) == MOD_CONTROL)) {
00634                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00635             }
00636             <span class="keywordflow">break</span>;
00637         <span class="keywordflow">case</span> VK_RETURN:
00638             <span class="keywordflow">if</span> ((fsReserveKeys &amp; CONSOLE_ALTENTER) &amp;&amp;
00639                     ((fsModifiers &amp; (MOD_CONTROL | MOD_ALT)) == MOD_ALT)) {
00640                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00641             }
00642             <span class="keywordflow">break</span>;
00643         <span class="keywordflow">case</span> VK_SNAPSHOT:
00644             <span class="keywordflow">if</span> ((fsReserveKeys &amp; CONSOLE_PRTSC) &amp;&amp;
00645                     ((fsModifiers &amp; (MOD_CONTROL | MOD_ALT)) == 0)) {
00646                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00647             }
00648             <span class="keywordflow">if</span> ((fsReserveKeys &amp; CONSOLE_ALTPRTSC) &amp;&amp;
00649                     ((fsModifiers &amp; (MOD_CONTROL | MOD_ALT)) == MOD_ALT)) {
00650                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00651             }
00652             <span class="keywordflow">break</span>;
00653         <span class="keywordflow">case</span> VK_SPACE:
00654             <span class="keywordflow">if</span> ((fsReserveKeys &amp; CONSOLE_ALTSPACE) &amp;&amp;
00655                     ((fsModifiers &amp; (MOD_CONTROL | MOD_ALT)) == MOD_ALT)) {
00656                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00657             }
00658             <span class="keywordflow">break</span>;
00659         }
00660     }
00661 
00662     <span class="comment">/*</span>
00663 <span class="comment">     * If this is the task-list hotkey, go ahead and set foreground</span>
00664 <span class="comment">     * status to the task-list queue right now.  This prevents problems</span>
00665 <span class="comment">     * where the user hits ctrl-esc and types-ahead before the task-list</span>
00666 <span class="comment">     * processes the hotkey and brings up the task-list window.</span>
00667 <span class="comment">     */</span>
00668     <span class="keywordflow">if</span> ((fsModifiers == MOD_CONTROL) &amp;&amp; (vk == VK_ESCAPE) &amp;&amp; !fBreak) {
00669         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSwitch;
00670         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndSwitch;
00671 
00672         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a91">ghwndSwitch</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00673             pwndSwitch = <a class="code" href="../../d4/d1/userk_8h.html#a104">PW</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a91">ghwndSwitch</a>);
00674             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndSwitch, &amp;tlpwndSwitch);
00675             <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwndSwitch, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);  <span class="comment">// BUG BUG phk might go away IANJA</span>
00676             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndSwitch);
00677         }
00678     }
00679 
00680     <span class="comment">/*</span>
00681 <span class="comment">     * Get the hot key contents.</span>
00682 <span class="comment">     */</span>
00683     <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00684         <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(
00685                 phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o0">pti</a>, WM_HOTKEY, phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o5">id</a>,
00686                 MAKELONG(fsModifiers, vk));
00687         <span class="comment">/*</span>
00688 <span class="comment">         * Since this hotkey is for this guy, he owns the last input.</span>
00689 <span class="comment">         */</span>
00690         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o0">pti</a>;
00691 
00692     } <span class="keywordflow">else</span> {
00693         <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a> == <a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>) {
00694             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00695                 pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
00696             } <span class="keywordflow">else</span> {
00697                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00698             }
00699         } <span class="keywordflow">else</span> {
00700             pwnd = phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o1">spwnd</a>;
00701         }
00702 
00703         <span class="keywordflow">if</span> (pwnd) {
00704             <span class="keywordflow">if</span> (pwnd == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwndShell &amp;&amp; phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o5">id</a> == SC_TASKLIST) {
00705 PostTaskListSysCmd:
00706                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_SYSCOMMAND, SC_TASKLIST, 0);
00707             } <span class="keywordflow">else</span> {
00708                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_HOTKEY, phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o5">id</a>, MAKELONG(fsModifiers, vk));
00709             }
00710 
00711             <span class="comment">/*</span>
00712 <span class="comment">             * Since this hotkey is for this guy, he owns the last input.</span>
00713 <span class="comment">             */</span>
00714             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00715         }
00716     }
00717 
00718     <span class="comment">/*</span>
00719 <span class="comment">     * If this is a Modifier-Only hotkey, let the modifier break through</span>
00720 <span class="comment">     * by returning FALSE, otherwise we will have modifier keys stuck down.</span>
00721 <span class="comment">     */</span>
00722     <span class="keywordflow">return</span> (fsModOnlyHotkey == 0);
00723 
00724 }
00725 
00726 
00727 <span class="comment">/***************************************************************************\</span>
00728 <span class="comment">* IsHotKey</span>
00729 <span class="comment">*</span>
00730 <span class="comment">*</span>
00731 <span class="comment">* History:</span>
00732 <span class="comment">* 03-10-91 DavidPe      Created.</span>
00733 <span class="comment">\***************************************************************************/</span>
00734 
<a name="l00735"></a><a class="code" href="../../d4/d1/userk_8h.html#a1262">00735</a> <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> <a class="code" href="../../d4/d1/userk_8h.html#a1262">IsHotKey</a>(
00736     UINT fsModifiers,
00737     UINT vk)
00738 {
00739     <a class="code" href="../../d8/d6/structtagHOTKEY.html">PHOTKEY</a> phk;
00740 
00741     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00742 
00743     phk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a115">gphkFirst</a>;
00744 
00745     <span class="keywordflow">while</span> (phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00746 
00747         <span class="comment">/*</span>
00748 <span class="comment">         * Do the modifiers and vk for this hotkey match the current state?</span>
00749 <span class="comment">         */</span>
00750         <span class="keywordflow">if</span> ((phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o2">fsModifiers</a> == fsModifiers) &amp;&amp; (phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o4">vk</a> == vk)) {
00751             <span class="keywordflow">return</span> phk;
00752         }
00753 
00754         phk = phk-&gt;<a class="code" href="../../d8/d6/structtagHOTKEY.html#o6">phkNext</a>;
00755     }
00756 
00757     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00758 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
