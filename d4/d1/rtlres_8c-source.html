<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtlres.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtlres.c</h1><a href="../../d3/d2/rtlres_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">*</span>
00003 <span class="comment">* Module Name: rtlres.c</span>
00004 <span class="comment">*</span>
00005 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* Resource Loading Routines</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">* 05-Apr-1991 ScottLu   Fixed up, resource code is now shared between client</span>
00011 <span class="comment">*                       and server, added a few new resource loading routines.</span>
00012 <span class="comment">* 24-Sep-1990 MikeKe    From win30</span>
00013 <span class="comment">\***************************************************************************/</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00016 <span class="preprocessor">#pragma hdrstop</span>
00017 <span class="preprocessor"></span>
00018 HICON <a class="code" href="../../d3/d2/rtlres_8c.html#a2">IconFromBestImage</a>(
00019     ICONFILEHEADER *pifh,
00020     LPNEWHEADER     lpnhSrc,
00021     <span class="keywordtype">int</span>             cxDesired,
00022     <span class="keywordtype">int</span>             cyDesired,
00023     UINT            LR_flags);
00024 
00025 <span class="comment">/***************************************************************************\</span>
00026 <span class="comment">* LoadStringOrError</span>
00027 <span class="comment">*</span>
00028 <span class="comment">* NOTE: Passing a NULL value for lpch returns the string length. (WRONG!)</span>
00029 <span class="comment">*</span>
00030 <span class="comment">* Warning: The return count does not include the terminating NULL WCHAR;</span>
00031 <span class="comment">*</span>
00032 <span class="comment">* History:</span>
00033 <span class="comment">* 05-Apr-1991 ScottLu   Fixed - code is now shared between client and server</span>
00034 <span class="comment">* 24-Sep-1990 MikeKe    From Win30</span>
00035 <span class="comment">\***************************************************************************/</span>
00036 
<a name="l00037"></a><a class="code" href="../../d3/d2/rtlres_8c.html#a3">00037</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a427">LoadStringOrError</a>(
00038     HANDLE    hModule,
00039     UINT      wID,
00040     LPWSTR    lpBuffer,            <span class="comment">// Unicode buffer</span>
00041     <span class="keywordtype">int</span>       cchBufferMax,        <span class="comment">// cch in Unicode buffer</span>
00042     WORD      wLangId)
00043 {
00044     HANDLE hResInfo;
00045     HANDLE hStringSeg;
00046     LPTSTR lpsz;
00047     <span class="keywordtype">int</span>    cch;
00048 
00049     <span class="comment">/*</span>
00050 <span class="comment">     * Make sure the parms are valid.</span>
00051 <span class="comment">     */</span>
00052     <span class="keywordflow">if</span> (lpBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00053         RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadStringOrError: lpBuffer == NULL"</span>);
00054         <span class="keywordflow">return</span> 0;
00055     }
00056 
00057 
00058     cch = 0;
00059 
00060     <span class="comment">/*</span>
00061 <span class="comment">     * String Tables are broken up into 16 string segments.  Find the segment</span>
00062 <span class="comment">     * containing the string we are interested in.</span>
00063 <span class="comment">     */</span>
00064     <span class="keywordflow">if</span> (hResInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a128">FINDRESOURCEEXW</a>(hModule, (LPTSTR)ULongToPtr( ((LONG)(((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)wID &gt;&gt; 4) + 1)) ), RT_STRING, wLangId)) {
00065 
00066         <span class="comment">/*</span>
00067 <span class="comment">         * Load that segment.</span>
00068 <span class="comment">         */</span>
00069         hStringSeg = <a class="code" href="../../d6/d0/usercli_8h.html#a129">LOADRESOURCE</a>(hModule, hResInfo);
00070 
00071         <span class="comment">/*</span>
00072 <span class="comment">         * Lock the resource.</span>
00073 <span class="comment">         */</span>
00074         <span class="keywordflow">if</span> (lpsz = (LPTSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a130">LOCKRESOURCE</a>(hStringSeg, hModule)) {
00075 
00076             <span class="comment">/*</span>
00077 <span class="comment">             * Move past the other strings in this segment.</span>
00078 <span class="comment">             * (16 strings in a segment -&gt; &amp; 0x0F)</span>
00079 <span class="comment">             */</span>
00080             wID &amp;= 0x0F;
00081             <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00082                 cch = *((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1">UTCHAR</a> *)lpsz++);      <span class="comment">// PASCAL like string count</span>
00083                                                 <span class="comment">// first UTCHAR is count if TCHARs</span>
00084                 <span class="keywordflow">if</span> (wID-- == 0) <span class="keywordflow">break</span>;
00085                 lpsz += cch;                    <span class="comment">// Step to start if next string</span>
00086             }
00087 
00088             <span class="comment">/*</span>
00089 <span class="comment">             * chhBufferMax == 0 means return a pointer to the read-only resource buffer.</span>
00090 <span class="comment">             */</span>
00091             <span class="keywordflow">if</span> (cchBufferMax == 0) {
00092                 *(LPTSTR *)lpBuffer = lpsz;
00093             } <span class="keywordflow">else</span> {
00094 
00095                 <span class="comment">/*</span>
00096 <span class="comment">                 * Account for the NULL</span>
00097 <span class="comment">                 */</span>
00098                 cchBufferMax--;
00099 
00100                 <span class="comment">/*</span>
00101 <span class="comment">                 * Don't copy more than the max allowed.</span>
00102 <span class="comment">                 */</span>
00103                 <span class="keywordflow">if</span> (cch &gt; cchBufferMax)
00104                     cch = cchBufferMax;
00105 
00106                 <span class="comment">/*</span>
00107 <span class="comment">                 * Copy the string into the buffer.</span>
00108 <span class="comment">                 */</span>
00109                 RtlCopyMemory(lpBuffer, lpsz, cch*<span class="keyword">sizeof</span>(WCHAR));
00110             }
00111 
00112             <span class="comment">/*</span>
00113 <span class="comment">             * Unlock resource, but don't free it - better performance this</span>
00114 <span class="comment">             * way.</span>
00115 <span class="comment">             */</span>
00116             <a class="code" href="../../d6/d0/usercli_8h.html#a131">UNLOCKRESOURCE</a>(hStringSeg, hModule);
00117         }
00118     }
00119 
00120     <span class="comment">/*</span>
00121 <span class="comment">     * Append a NULL.</span>
00122 <span class="comment">     */</span>
00123     <span class="keywordflow">if</span> (cchBufferMax != 0) {
00124         lpBuffer[cch] = 0;
00125     }
00126 
00127     <span class="keywordflow">return</span> cch;
00128 }
00129 
00130 
00131 <span class="comment">/***************************************************************************\</span>
00132 <span class="comment">* RtlLoadObjectFromDIBFile</span>
00133 <span class="comment">*</span>
00134 <span class="comment">* Loads a resource object from file.</span>
00135 <span class="comment">*</span>
00136 <span class="comment">* 05-Sep-1995 ChrisWil      Created.</span>
00137 <span class="comment">\***************************************************************************/</span>
00138 
<a name="l00139"></a><a class="code" href="../../d3/d2/rtlres_8c.html#a0">00139</a> <span class="preprocessor">#define BITMAPFILEHEADER_SIZE 14</span>
<a name="l00140"></a><a class="code" href="../../d3/d2/rtlres_8c.html#a1">00140</a> <span class="preprocessor"></span><span class="preprocessor">#define MINHEADERS_SIZE       (BITMAPFILEHEADER_SIZE + sizeof(BITMAPCOREHEADER))</span>
00141 <span class="preprocessor"></span>
<a name="l00142"></a><a class="code" href="../../d6/d0/usercli_8h.html#a657">00142</a> HANDLE <a class="code" href="../../d6/d0/usercli_8h.html#a657">RtlLoadObjectFromDIBFile</a>(
00143     LPCWSTR lpszName,
00144     LPWSTR  type,
00145     DWORD   cxDesired,
00146     DWORD   cyDesired,
00147     UINT    LR_flags)
00148 {
00149     <a class="code" href="../../d1/d2/struct__FILEINFO.html">FILEINFO</a> fi = { <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> };
00150     HANDLE   hFile;
00151     HANDLE   hFileMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00152     HANDLE   hObj     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00153     TCHAR    <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a3">szFile</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00154     TCHAR    szFile2[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00155     LPWSTR   pszFileDummy;
00156 
00157     <span class="keywordflow">if</span> (LR_flags &amp; LR_ENVSUBST) {
00158 
00159         <span class="comment">/*</span>
00160 <span class="comment">         * Do any %% string substitutions.  We need this feature to handle</span>
00161 <span class="comment">         * loading custom cursors and icons from the registry which uses</span>
00162 <span class="comment">         * %SystemRoot% in the paths.  It also makes the shell's job</span>
00163 <span class="comment">         * easier.</span>
00164 <span class="comment">         */</span>
00165         ExpandEnvironmentStrings(lpszName, szFile2, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00166 
00167     } <span class="keywordflow">else</span> {
00168 
00169         lstrcpy(szFile2, lpszName);
00170     }
00171 
00172     <span class="keywordflow">if</span> (SearchPath(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,         <span class="comment">// use default search locations</span>
00173                    szFile2,      <span class="comment">// file name to search for</span>
00174                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,         <span class="comment">// already have file name extension</span>
00175                    <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>,     <span class="comment">// how big is that buffer, anyway?</span>
00176                    <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a3">szFile</a>,       <span class="comment">// stick fully qualified path name here</span>
00177                    &amp;pszFileDummy) == 0) {
00178         RIPERR0(ERROR_FILE_NOT_FOUND, RIP_VERBOSE, <span class="stringliteral">""</span>);
00179         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00180     }
00181 
00182     <span class="comment">/*</span>
00183 <span class="comment">     * Open File for reading.</span>
00184 <span class="comment">     */</span>
00185     hFile = CreateFileW(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a3">szFile</a>,
00186                         GENERIC_READ,
00187                         FILE_SHARE_READ,
00188                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00189                         <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>,
00190                         0,
00191                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00192 
00193     <span class="keywordflow">if</span> (hFile == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
00194         <span class="keywordflow">goto</span> Done;
00195 
00196     <span class="comment">/*</span>
00197 <span class="comment">     * Create file-mapping for the file in question.</span>
00198 <span class="comment">     */</span>
00199     hFileMap = CreateFileMapping(hFile, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, PAGE_READONLY, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00200 
00201     <span class="keywordflow">if</span> (hFileMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00202         <span class="keywordflow">goto</span> CloseDone;
00203 
00204     <span class="comment">/*</span>
00205 <span class="comment">     * Map the file into view.</span>
00206 <span class="comment">     */</span>
00207     fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a> = MapViewOfFile(hFileMap, FILE_MAP_READ, 0, 0, 0);
00208 
00209     <span class="keywordflow">if</span> (fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00210         <span class="keywordflow">goto</span> CloseDone;
00211 
00212     fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o2">pFileEnd</a> = fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a> + GetFileSize(hFile, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00213     fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o1">pFilePtr</a> = fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a>;
00214     fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o3">pszName</a>  = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a3">szFile</a>;
00215 
00216     <span class="keywordflow">try</span> {
00217         <span class="keywordflow">switch</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>)) {
00218         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_BITMAP): {
00219 
00220             LPBITMAPFILEHEADER pBFH;
00221             <a class="code" href="../../d6/d0/usercli_8h.html#a378">UPBITMAPINFOHEADER</a> upBIH;
00222             LPBYTE             lpBits;
00223             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cx;
00224             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00225             WORD               planes;
00226             WORD               bpp;
00227             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbSizeImage = 0;
00228             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbSizeFile;
00229             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbSizeBits;
00230 
00231             <span class="comment">/*</span>
00232 <span class="comment">             * Set the BitmapFileHeader and BitmapInfoHeader pointers.</span>
00233 <span class="comment">             */</span>
00234             pBFH  = (LPBITMAPFILEHEADER)fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a>;
00235             upBIH = (<a class="code" href="../../d6/d0/usercli_8h.html#a378">UPBITMAPINFOHEADER</a>)(fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a> + <a class="code" href="../../d3/d2/rtlres_8c.html#a0">BITMAPFILEHEADER_SIZE</a>);
00236 
00237             <span class="comment">/*</span>
00238 <span class="comment">             * Are we dealing with a bitmap file.</span>
00239 <span class="comment">             */</span>
00240             <span class="keywordflow">if</span> (pBFH-&gt;bfType != <a class="code" href="../../d6/d0/usercli_8h.html#a241">BFT_BITMAP</a>)
00241                 <span class="keywordflow">break</span>;
00242 
00243             <span class="comment">/*</span>
00244 <span class="comment">             * We need to check the filesize against the potential size of</span>
00245 <span class="comment">             * the image.  Bad-Bitmaps would otherwise be able to slam us</span>
00246 <span class="comment">             * if they lied about the size (and/or) the file is truncated.</span>
00247 <span class="comment">             */</span>
00248             <span class="keywordflow">if</span> (upBIH-&gt;biSize == <span class="keyword">sizeof</span>(BITMAPCOREHEADER)) {
00249 
00250                 cx     = ((<a class="code" href="../../d6/d0/usercli_8h.html#a379">UPBITMAPCOREHEADER</a>)upBIH)-&gt;bcWidth;
00251                 <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>     = ((<a class="code" href="../../d6/d0/usercli_8h.html#a379">UPBITMAPCOREHEADER</a>)upBIH)-&gt;bcHeight;
00252                 bpp    = ((<a class="code" href="../../d6/d0/usercli_8h.html#a379">UPBITMAPCOREHEADER</a>)upBIH)-&gt;bcBitCount;
00253                 planes = ((<a class="code" href="../../d6/d0/usercli_8h.html#a379">UPBITMAPCOREHEADER</a>)upBIH)-&gt;bcPlanes;
00254 
00255             } <span class="keywordflow">else</span> {
00256 
00257                 cx     = upBIH-&gt;biWidth;
00258                 <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>     = upBIH-&gt;biHeight;
00259                 bpp    = upBIH-&gt;biBitCount;
00260                 planes = upBIH-&gt;biPlanes;
00261 
00262                 <span class="keywordflow">if</span>(upBIH-&gt;biSizeImage &gt;= <span class="keyword">sizeof</span>(BITMAPINFOHEADER))
00263                 cbSizeImage = upBIH-&gt;biSizeImage;
00264             }
00265 
00266             cbSizeFile = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o2">pFileEnd</a> - fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a>);
00267             cbSizeBits = <a class="code" href="../../d6/d0/usercli_8h.html#a32">BitmapSize</a>(cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, planes, bpp);
00268 
00269             <span class="keywordflow">if</span> ((!cbSizeImage &amp;&amp; ((cbSizeFile - <a class="code" href="../../d3/d2/rtlres_8c.html#a1">MINHEADERS_SIZE</a>) &lt; cbSizeBits)) ||
00270             (cbSizeImage &amp;&amp; ((cbSizeFile - <a class="code" href="../../d3/d2/rtlres_8c.html#a1">MINHEADERS_SIZE</a>) &lt; cbSizeImage))) {
00271 
00272                 <span class="keywordflow">break</span>;
00273             }
00274 
00275             <span class="comment">/*</span>
00276 <span class="comment">             * Get the bits-offset in the file.</span>
00277 <span class="comment">             */</span>
00278             <span class="keywordflow">if</span> ((pBFH-&gt;bfOffBits &gt;= (<span class="keyword">sizeof</span>(BITMAPFILEHEADER) + <span class="keyword">sizeof</span>(BITMAPCOREHEADER))) &amp;&amp;
00279                 (pBFH-&gt;bfOffBits &lt;= (cbSizeFile - cbSizeImage))) {
00280 
00281                 lpBits = ((LPBYTE)upBIH) + pBFH-&gt;bfOffBits - <span class="keyword">sizeof</span>(BITMAPFILEHEADER);
00282 
00283             } <span class="keywordflow">else</span> {
00284 
00285                 lpBits = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00286             }
00287 
00288             <span class="comment">/*</span>
00289 <span class="comment">             * Convert the dib-on-file to a bitmap-handle.  This can</span>
00290 <span class="comment">             * convert both CORE and INFO formats.</span>
00291 <span class="comment">             */</span>
00292             hObj = <a class="code" href="../../d6/d0/usercli_8h.html#a659">ConvertDIBBitmap</a>(upBIH,
00293                                     cxDesired,
00294                                     cyDesired,
00295                                     LR_flags,
00296                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00297                                     &amp;lpBits);  <span class="comment">// use these bits!</span>
00298         }
00299         <span class="keywordflow">break</span>;
00300 
00301         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_CURSOR):
00302         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ICON):
00303         {
00304             RTAG           *prtag;
00305             ICONFILEHEADER *pifh;
00306 
00307             <span class="comment">/*</span>
00308 <span class="comment">             * Is this a RIFF file?</span>
00309 <span class="comment">             */</span>
00310             prtag = (RTAG *)fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a>;
00311 
00312             <span class="keywordflow">if</span> (prtag-&gt;ckID != FOURCC_RIFF) {
00313 
00314                 NEWHEADER nh;
00315 
00316                 pifh = (ICONFILEHEADER *)fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a>;
00317 
00318                 <span class="comment">/*</span>
00319 <span class="comment">                 * BUG?: looks like we can load icons as cursors and cursors</span>
00320 <span class="comment">                 * as icons.  Does this work?  Is this desired? (SAS)</span>
00321 <span class="comment">                 */</span>
00322                 <span class="keywordflow">if</span> ((pifh-&gt;iReserved != 0) ||
00323                     ((pifh-&gt;iResourceType != IMAGE_ICON) &amp;&amp;
00324                         (pifh-&gt;iResourceType != IMAGE_CURSOR)) ||
00325                     (pifh-&gt;cresIcons &lt; 1))
00326 
00327                     <span class="keywordflow">break</span>;
00328 
00329                 nh.ResType  = ((<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> == RT_ICON) ? IMAGE_ICON : IMAGE_CURSOR);
00330                 nh.ResCount = pifh-&gt;cresIcons;
00331                 nh.Reserved = 0;
00332 
00333                 <span class="comment">/*</span>
00334 <span class="comment">                 * Get the size of the sucker and meanwhile seek the file pointer</span>
00335 <span class="comment">                 * to point at the DIB we want.  Files that have more than one</span>
00336 <span class="comment">                 * icon/cursor are treated like a group.  In other words,</span>
00337 <span class="comment">                 * each image is treated like an individual element in the res</span>
00338 <span class="comment">                 * dir.  So we need to pick the best fit one...</span>
00339 <span class="comment">                 */</span>
00340                 hObj = <a class="code" href="../../d3/d2/rtlres_8c.html#a2">IconFromBestImage</a>(pifh,
00341                                      &amp;nh,
00342                                      cxDesired,
00343                                      cyDesired,
00344                                      LR_flags);
00345             } <span class="keywordflow">else</span> {
00346 
00347                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAni;
00348 
00349                 hObj = <a class="code" href="../../d6/d0/usercli_8h.html#a651">LoadCursorIconFromFileMap</a>(&amp;fi,
00350                                                  &amp;<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
00351                                                  cxDesired,
00352                                                  cyDesired,
00353                                                  LR_flags,
00354                                                  &amp;fAni);
00355                 }
00356             }
00357         <span class="keywordflow">break</span>;
00358 
00359         <span class="keywordflow">default</span>:
00360             UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00361             <span class="keywordflow">break</span>;
00362         } <span class="comment">// switch</span>
00363     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00364         hObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00365     }
00366 CloseDone:
00367 
00368     <span class="keywordflow">if</span> (fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00369         UnmapViewOfFile(fi.<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a>);
00370 
00371     <span class="keywordflow">if</span> (hFileMap)
00372         CloseHandle(hFileMap);
00373 
00374     <span class="keywordflow">if</span> (hFile &amp;&amp; (hFile != <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>))
00375         CloseHandle(hFile);
00376 
00377 Done:
00378 <span class="preprocessor">#if DBG</span>
00379 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (hObj == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00380         RIPMSG1(RIP_WARNING,
00381                 <span class="stringliteral">"RtlLoadObjectFromDIBFile: Couldn't read resource from %ws"</span>,
00382                 lpszName);
00383     }
00384 <span class="preprocessor">#endif</span>
00385 <span class="preprocessor"></span>
00386     <span class="keywordflow">return</span> hObj;
00387 }
00388 
00389 <span class="comment">/***************************************************************************\</span>
00390 <span class="comment">* IconFromBestImage</span>
00391 <span class="comment">*</span>
00392 <span class="comment">* Creates HICON from best fitting image in the given file.</span>
00393 <span class="comment">*</span>
00394 <span class="comment">\***************************************************************************/</span>
00395 
<a name="l00396"></a><a class="code" href="../../d3/d2/rtlres_8c.html#a2">00396</a> HICON <a class="code" href="../../d3/d2/rtlres_8c.html#a2">IconFromBestImage</a>(
00397     ICONFILEHEADER  *pifh,
00398     LPNEWHEADER      lpnhSrc,
00399     <span class="keywordtype">int</span>              cxDesired,
00400     <span class="keywordtype">int</span>              cyDesired,
00401     UINT             LR_flags)
00402 {
00403     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>             iImage;
00404     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>             iImageBest;
00405     LPNEWHEADER      lpnhDst;
00406     LPRESDIR         lprd;
00407     LPBYTE           lpRes;
00408     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            cbDIB;
00409     HICON            hIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00410     IMAGEFILEHEADER *pimh;
00411 
00412     <span class="keywordflow">if</span> (lpnhSrc-&gt;ResCount &gt; 1) {
00413 
00414         <span class="comment">/*</span>
00415 <span class="comment">         * First, alloc dummy group resource.</span>
00416 <span class="comment">         */</span>
00417         lpnhDst = (LPNEWHEADER)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0,
00418                 <span class="keyword">sizeof</span>(NEWHEADER) + (lpnhSrc-&gt;ResCount * <span class="keyword">sizeof</span>(RESDIR)));
00419 
00420         <span class="keywordflow">if</span> (lpnhDst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00421             <span class="keywordflow">goto</span> Done;
00422 
00423         *lpnhDst = *lpnhSrc;
00424         lprd = (LPRESDIR)(lpnhDst + 1);
00425 
00426         <span class="comment">/*</span>
00427 <span class="comment">         * Build up an image directory from the file's image header info.</span>
00428 <span class="comment">         */</span>
00429 
00430         <span class="keywordflow">for</span> (pimh = pifh-&gt;imh, iImage=0;
00431              iImage &lt; lpnhDst-&gt;ResCount;
00432              iImage++, lprd++, pimh++) {
00433 
00434             <span class="comment">/*</span>
00435 <span class="comment">             * Fill in RESDIR</span>
00436 <span class="comment">             */</span>
00437             lprd-&gt;Icon.Width  = pimh-&gt;cx;
00438             lprd-&gt;Icon.Height = pimh-&gt;cy;
00439 
00440             <span class="keywordflow">if</span> (lpnhDst-&gt;ResType == IMAGE_ICON)
00441                 lprd-&gt;Icon.ColorCount = pimh-&gt;nColors;
00442 
00443             <span class="comment">/*</span>
00444 <span class="comment">             * NOTE:  These aren't used in the "GetBestImage" process.  So</span>
00445 <span class="comment">             * stick in random stuff.</span>
00446 <span class="comment">             */</span>
00447             lprd-&gt;Planes     = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;Planes;
00448             lprd-&gt;BitCount   = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount;
00449             lprd-&gt;BytesInRes = pimh-&gt;cbDIB;
00450 
00451             <span class="comment">/*</span>
00452 <span class="comment">             * Make fake ID:  the index of the image.</span>
00453 <span class="comment">             */</span>
00454             lprd-&gt;idIcon = (WORD)iImage;
00455         }
00456 
00457         <span class="comment">/*</span>
00458 <span class="comment">         * Find the best image in the group</span>
00459 <span class="comment">         */</span>
00460         iImageBest = <a class="code" href="../../d4/d9/clres_8c.html#a67">LookupIconIdFromDirectoryEx</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpnhDst,
00461                                                  (lpnhDst-&gt;ResType == IMAGE_ICON),
00462                                                  cxDesired,
00463                                                  cyDesired,
00464                                                  LR_flags);
00465         <span class="comment">/*</span>
00466 <span class="comment">         * Get rid of fake group resource</span>
00467 <span class="comment">         */</span>
00468         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpnhDst);
00469 
00470     } <span class="keywordflow">else</span> {
00471         iImageBest = 0;
00472     }
00473 
00474     <span class="comment">/*</span>
00475 <span class="comment">     * Point to selected image.</span>
00476 <span class="comment">     */</span>
00477     pimh  = &amp;pifh-&gt;imh[iImageBest];
00478     cbDIB = pimh-&gt;cbDIB;
00479 
00480     <span class="comment">/*</span>
00481 <span class="comment">     * If we're creating a cursor, we have to whack in HOTSPOT in front</span>
00482 <span class="comment">     * Regardless of which type we are making, we need to make sure</span>
00483 <span class="comment">     * the resource is aligned.  Thus we always copy.</span>
00484 <span class="comment">     */</span>
00485     <span class="keywordflow">if</span> (lpnhSrc-&gt;ResType == IMAGE_CURSOR)
00486         cbDIB += <span class="keyword">sizeof</span>(POINTS);
00487 
00488     lpRes = (LPBYTE)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, cbDIB);
00489     <span class="keywordflow">if</span> (lpRes == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00490         <span class="keywordflow">goto</span> Done;
00491 
00492     <span class="keywordflow">if</span> (lpnhSrc-&gt;ResType == IMAGE_CURSOR)
00493         lpRes += <span class="keyword">sizeof</span>(POINTS);
00494 
00495     RtlCopyMemory(lpRes,
00496                   ((LPBYTE)pifh) + pimh-&gt;offsetDIB,
00497                   pimh-&gt;cbDIB);
00498 
00499     <span class="keywordflow">if</span> (lpnhSrc-&gt;ResType == IMAGE_CURSOR) {
00500 
00501         lpRes -= <span class="keyword">sizeof</span>(POINTS);
00502         ((LPPOINTS)lpRes)-&gt;x = pimh-&gt;xHotSpot;
00503         ((LPPOINTS)lpRes)-&gt;y = pimh-&gt;yHotSpot;
00504     }
00505 
00506     hIcon = <a class="code" href="../../d4/d9/clres_8c.html#a70">CreateIconFromResourceEx</a>(lpRes,
00507                                      cbDIB,
00508                                      (lpnhSrc-&gt;ResType == IMAGE_ICON),
00509                                      0x00030000, <span class="comment">// was WIN32VER40</span>
00510                                      cxDesired,
00511                                      cyDesired,
00512                                      LR_flags);
00513 
00514     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpRes);
00515 
00516 Done:
00517 
00518     <span class="keywordflow">return</span> hIcon;
00519 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:41 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
